<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[RustFS 如何实现对象存储的前端直传？]]></title>    <link>https://juejin.cn/post/7587779957674917939</link>    <guid>https://juejin.cn/post/7587779957674917939</guid>    <pubDate>2025-12-26T04:59:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587779957674917939" data-draft-id="7587709130531127305" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RustFS 如何实现对象存储的前端直传？"/> <meta itemprop="keywords" content="Rust,Docker,Vue.js"/> <meta itemprop="datePublished" content="2025-12-26T04:59:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RustFS"/> <meta itemprop="url" content="https://juejin.cn/user/511719423354121"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RustFS 如何实现对象存储的前端直传？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/511719423354121/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RustFS
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T04:59:10.000Z" title="Fri Dec 26 2025 04:59:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文分享 RustFS 对象存储前段直传的完整实现方式，改变了传统的浏览器-&gt; 后端服务器 -&gt; 对象存储的上传方式，提高了效率和安全性。文章包括 5 个部分：</p>
<ul>
<li>前言</li>
<li>核心概念</li>
<li>两种方案详解</li>
<li>技术实现</li>
<li>完整示例</li>
<li>最佳实践</li>
</ul>
<h2 data-id="heading-0">什么是前端直传？</h2>
<p>传统的文件上传流程：<strong>浏览器 → 后端服务器 → 对象存储</strong>这种方式存在以下问题：</p>
<ul>
<li>占用后端服务器带宽和资源</li>
<li>上传速度受限于后端服务器</li>
<li>需要处理大文件的内存管理</li>
<li>服务器成本增加</li>
</ul>
<p>前端直传则是：<strong>浏览器 → 对象存储</strong></p>
<p>优势：</p>
<ul>
<li>✅ 减轻后端服务器压力</li>
<li>✅ 上传速度更快（直连对象存储）</li>
<li>✅ 降低服务器成本</li>
<li>✅ 支持大文件上传</li>
</ul>
<h3 data-id="heading-1">安全性问题</h3>
<p>直传面临的核心问题：<strong>如何在不暴露永久密钥的情况下，让前端安全地上传文件</strong>？本教程介绍两种解决方案：</p>
<ol>
<li>预签名 URL 方案（推荐）</li>
<li>STS 临时凭证方案</li>
</ol>
<h3 data-id="heading-2">对象存储基础</h3>
<p>对象存储使用类似 AWS S3 的模型：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">存储桶</span> <span class="hljs-string">(Bucket)</span>
<span class="hljs-string">└──</span> <span class="hljs-string">对象</span> <span class="hljs-string">(Object)</span>
    <span class="hljs-string">├──</span> <span class="hljs-attr">Key:</span> <span class="hljs-string">"uploads/photo.jpg"</span>  <span class="hljs-comment"># 对象路径</span>
    <span class="hljs-string">├──</span> <span class="hljs-attr">Value:</span> [<span class="hljs-string">文件内容</span>]
    <span class="hljs-string">└──</span> <span class="hljs-attr">Metadata:</span> {<span class="hljs-string">ContentType</span>, <span class="hljs-string">Size</span>, <span class="hljs-string">etc.</span>}
</code></pre>
<h3 data-id="heading-3">访问控制</h3>
<p>对象存储通过 Access Key 和 Secret Key 进行身份验证：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">永久密钥（长期有效，不应暴露给前端）
├── Access <span class="hljs-keyword">Key</span> ID: <span class="hljs-string">"user-2"</span>
└── Secret Access <span class="hljs-keyword">Key</span>: <span class="hljs-string">"rustfsadmin"</span>

临时凭证（短期有效，可以给前端使用）
├── Access <span class="hljs-keyword">Key</span> ID
├── Secret Access <span class="hljs-keyword">Key</span>
└── Session Token
</code></pre>
<h3 data-id="heading-4">两种方案详解</h3>
<h4 data-id="heading-5">方案一：预签名 URL 方案（推荐）</h4>
<p>适用场景</p>
<ul>
<li>单文件上传</li>
<li>表单提交时附带文件</li>
<li>简单安全的上传需求交</li>
</ul>
<h5 data-id="heading-6">互流程</h5>
<pre><code class="hljs">浏览器                    后端服务                   RustFS
  │                          │                          │
  │ ①请求预签名URL            │                          │
  ├──────────────────────────&gt;│                          │
  │                          │                          │
  │                          │ ②使用boto3生成签名URL     │
  │                          │                          │
  │ ③返回预签名URL            │                          │
  │&lt;──────────────────────────┤                          │
  │                          │                          │
  │ ④使用预签名URL直传文件                               │
  ├─────────────────────────────────────────────────────&gt;│
  │                          │                          │
  │ ⑤返回成功                                            │
  │&lt;──────────────────────────────────────────────────────┤
</code></pre>
<p>优势:</p>
<ul>
<li>前端实现极简，无需处理签名</li>
<li>后端完全控制权限</li>
<li>无需额外依赖</li>
<li>每个文件独立权限控制</li>
</ul>
<h4 data-id="heading-7">方案二：STS 临时凭证方案</h4>
<p>推荐场景：</p>
<ul>
<li>批量文件上传（如相册上传）</li>
<li>长时间上传操作</li>
<li>需要多次上传的场景</li>
</ul>
<h5 data-id="heading-8">交互流程</h5>
<pre><code class="hljs">浏览器                    后端服务                   RustFS
  │                          │                          │
  │ ①请求临时凭证              │                          │
  ├──────────────────────────&gt;│                          │
  │                          │                          │
  │ ②返回临时凭证              │                          │
  │&lt;──────────────────────────┤                          │
  │                          │                          │
  │ ③前端使用SDK上传（凭证可复用）                        │
  ├─────────────────────────────────────────────────────&gt;│
  │                          │                          │
  │ ④继续上传其他文件                                     │
  ├─────────────────────────────────────────────────────&gt;│
</code></pre>
<p>优势</p>
<ul>
<li>凭证可复用，减少网络请求</li>
<li>适合批量上传</li>
<li>灵活控制权限</li>
</ul>
<h3 data-id="heading-9">技术实现</h3>
<h4 data-id="heading-10">后端实现（使用 boto3）</h4>
<ul>
<li>安装依赖</li>
</ul>

<pre><code class="hljs">pip install boto3 flask flask-cors
</code></pre>
<ul>
<li>核心代码</li>
</ul>

<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> boto3
<span class="hljs-keyword">from</span> botocore.client <span class="hljs-keyword">import</span> Config
<span class="hljs-keyword">from</span> flask <span class="hljs-keyword">import</span> Flask, request, jsonify
<span class="hljs-keyword">from</span> flask_cors <span class="hljs-keyword">import</span> CORS

app = Flask(__name__)
CORS(app)

<span class="hljs-comment"># 配置</span>
RUSTFS_CONFIG = {
    <span class="hljs-string">'access_key_id'</span>: <span class="hljs-string">'user-2'</span>,
    <span class="hljs-string">'secret_access_key'</span>: <span class="hljs-string">'rustfsadmin'</span>,
    <span class="hljs-string">'endpoint_url'</span>: <span class="hljs-string">'http://127.0.0.1:9000'</span>,
    <span class="hljs-string">'bucket_name'</span>: <span class="hljs-string">'test-bucket'</span>,
    <span class="hljs-string">'region_name'</span>: <span class="hljs-string">'us-east-1'</span>
}

<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_s3_client</span>():
    <span class="hljs-string">"""创建 S3 客户端"""</span>
    <span class="hljs-keyword">return</span> boto3.client(
        <span class="hljs-string">'s3'</span>,
        aws_access_key_id=RUSTFS_CONFIG[<span class="hljs-string">'access_key_id'</span>],
        aws_secret_access_key=RUSTFS_CONFIG[<span class="hljs-string">'secret_access_key'</span>],
        endpoint_url=RUSTFS_CONFIG[<span class="hljs-string">'endpoint_url'</span>],
        region_name=RUSTFS_CONFIG[<span class="hljs-string">'region_name'</span>],
        config=Config(
            signature_version=<span class="hljs-string">'s3v4'</span>,
            s3={<span class="hljs-string">'addressing_style'</span>: <span class="hljs-string">'path'</span>}
        )
    )

<span class="hljs-comment"># 方案一：预签名 URL</span>
<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/api/presigned-url'</span>, methods=[<span class="hljs-string">'POST'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_presigned_url</span>():
    <span class="hljs-string">"""生成预签名 URL"""</span>
    data = request.get_json()
    object_key = data[<span class="hljs-string">'object_key'</span>]
    content_type = data.get(<span class="hljs-string">'content_type'</span>, <span class="hljs-string">'application/octet-stream'</span>)
    expires = data.get(<span class="hljs-string">'expires'</span>, <span class="hljs-number">3600</span>)

    s3_client = create_s3_client()

    <span class="hljs-comment"># boto3 自动处理签名</span>
    presigned_url = s3_client.generate_presigned_url(
        ClientMethod=<span class="hljs-string">'put_object'</span>,
        Params={
            <span class="hljs-string">'Bucket'</span>: RUSTFS_CONFIG[<span class="hljs-string">'bucket_name'</span>],
            <span class="hljs-string">'Key'</span>: object_key,
            <span class="hljs-string">'ContentType'</span>: content_type
        },
        ExpiresIn=expires
    )

    <span class="hljs-keyword">return</span> jsonify({
        <span class="hljs-string">'code'</span>: <span class="hljs-number">0</span>,
        <span class="hljs-string">'data'</span>: {
            <span class="hljs-string">'url'</span>: presigned_url,
            <span class="hljs-string">'method'</span>: <span class="hljs-string">'PUT'</span>,
            <span class="hljs-string">'headers'</span>: {<span class="hljs-string">'Content-Type'</span>: content_type}
        }
    })

<span class="hljs-comment"># 方案二：STS 临时凭证</span>
<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/api/sts/credentials'</span>, methods=[<span class="hljs-string">'POST'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_sts_credentials</span>():
    <span class="hljs-string">"""获取 S3 临时凭证"""</span>
    <span class="hljs-comment"># 生产环境应该使用真实的 STS AssumeRole</span>
    <span class="hljs-comment"># sts_client = boto3.client('sts')</span>
    <span class="hljs-comment"># response = sts_client.assume_role(...)</span>

    <span class="hljs-keyword">return</span> jsonify({
        <span class="hljs-string">'code'</span>: <span class="hljs-number">0</span>,
        <span class="hljs-string">'data'</span>: {
            <span class="hljs-string">'access_key_id'</span>: RUSTFS_CONFIG[<span class="hljs-string">'access_key_id'</span>],
            <span class="hljs-string">'secret_access_key'</span>: RUSTFS_CONFIG[<span class="hljs-string">'secret_access_key'</span>],
            <span class="hljs-string">'endpoint_url'</span>: RUSTFS_CONFIG[<span class="hljs-string">'endpoint_url'</span>],
            <span class="hljs-string">'bucket_name'</span>: RUSTFS_CONFIG[<span class="hljs-string">'bucket_name'</span>],
            <span class="hljs-string">'region_name'</span>: RUSTFS_CONFIG[<span class="hljs-string">'region_name'</span>]
        }
    })

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:
    app.run(host=<span class="hljs-string">'0.0.0.0'</span>, port=<span class="hljs-number">5000</span>, debug=<span class="hljs-literal">True</span>)
</code></pre>
<h4 data-id="heading-11">前端实现（使用 @aws-sdk/client-s3）</h4>
<ul>
<li>安装依赖</li>
</ul>

<pre><code class="hljs language-bash" lang="bash">npm install @aws-sdk/client-s3 @aws-sdk/s3-request-presigner vue
</code></pre>
<ul>
<li>方案一：预签名 URL</li>
</ul>

<pre><code class="hljs language-typescript" lang="typescript">上传<span class="hljs-comment">// utils/upload-presigned.ts</span>

<span class="hljs-comment">/**
 * 使用预签名 URL 上传文件
 */</span>
exportasync<span class="hljs-keyword">function</span> <span class="hljs-title function_">uploadWithPresignedUrl</span>(<span class="hljs-params">
  file: File,
  objectKey: <span class="hljs-built_in">string</span>,
  onProgress?: (progress: <span class="hljs-built_in">number</span>) =&gt; <span class="hljs-built_in">void</span>
</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
<span class="hljs-comment">// 1. 获取预签名 URL</span>
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'http://127.0.0.1:9000/api/presigned-url'</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">headers</span>: { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span> },
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      <span class="hljs-attr">object_key</span>: objectKey,
      <span class="hljs-attr">content_type</span>: file.<span class="hljs-property">type</span>
    })
  })
<span class="hljs-keyword">const</span> { data } = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()

<span class="hljs-comment">// 2. 使用预签名 URL 上传</span>
<span class="hljs-title function_">returnnewPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>()

    xhr.<span class="hljs-property">upload</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'progress'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (e.<span class="hljs-property">lengthComputable</span> &amp;&amp; onProgress) {
        <span class="hljs-title function_">onProgress</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>((e.<span class="hljs-property">loaded</span> / e.<span class="hljs-property">total</span>) * <span class="hljs-number">100</span>))
      }
    })

    xhr.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">status</span> &gt;= <span class="hljs-number">200</span> &amp;&amp; xhr.<span class="hljs-property">status</span> &lt; <span class="hljs-number">300</span>) {
        <span class="hljs-title function_">resolve</span>(data.<span class="hljs-property">url</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">'?'</span>)[<span class="hljs-number">0</span>])
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">reject</span>(<span class="hljs-title function_">newError</span>(<span class="hljs-string">`上传失败: <span class="hljs-subst">${xhr.status}</span>`</span>))
      }
    })

    xhr.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-title function_">newError</span>(<span class="hljs-string">'网络错误'</span>)))

    xhr.<span class="hljs-title function_">open</span>(data.<span class="hljs-property">method</span>, data.<span class="hljs-property">url</span>, <span class="hljs-literal">true</span>)
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(data.<span class="hljs-property">headers</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[key, value]</span>) =&gt;</span> {
      xhr.<span class="hljs-title function_">setRequestHeader</span>(key, value asstring)
    })
    xhr.<span class="hljs-title function_">send</span>(file)
  })
}
</code></pre>
<ul>
<li>方案二：STS 凭证</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript">上传/ utils/upload-sdk.<span class="hljs-property">ts</span>

<span class="hljs-keyword">import</span> { S3Client, <span class="hljs-title class_">PutObjectCommand</span> } <span class="hljs-keyword">from</span><span class="hljs-string">'@aws-sdk/client-s3'</span>
<span class="hljs-keyword">import</span> { getSignedUrl } <span class="hljs-keyword">from</span><span class="hljs-string">'@aws-sdk/s3-request-presigner'</span>

<span class="hljs-keyword">interface</span> S3Credentials {
  <span class="hljs-attr">access_key_id</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">secret_access_key</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">endpoint_url</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">bucket_name</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">region_name</span>: <span class="hljs-built_in">string</span>
}

<span class="hljs-comment">/**
 * 使用 AWS SDK 上传文件（带进度）
 */</span>
exportasync<span class="hljs-keyword">function</span> <span class="hljs-title function_">uploadWithSDK</span>(<span class="hljs-params">
  file: File,
  objectKey: <span class="hljs-built_in">string</span>,
  credentials: S3Credentials,
  onProgress?: (progress: <span class="hljs-built_in">number</span>) =&gt; <span class="hljs-built_in">void</span>
</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">string</span>&gt; {
<span class="hljs-comment">// 1. 创建 S3 客户端</span>
<span class="hljs-keyword">const</span> s3Client = <span class="hljs-keyword">new</span> <span class="hljs-title function_">S3Client</span>({
    <span class="hljs-attr">credentials</span>: {
      <span class="hljs-attr">accessKeyId</span>: credentials.<span class="hljs-property">access_key_id</span>,
      <span class="hljs-attr">secretAccessKey</span>: credentials.<span class="hljs-property">secret_access_key</span>
    },
    <span class="hljs-attr">endpoint</span>: credentials.<span class="hljs-property">endpoint_url</span>,
    <span class="hljs-attr">region</span>: credentials.<span class="hljs-property">region_name</span>,
    <span class="hljs-attr">forcePathStyle</span>: <span class="hljs-literal">true</span>
  })

<span class="hljs-comment">// 2. 如果需要进度，使用预签名 URL + XHR</span>
<span class="hljs-keyword">if</span> (onProgress) {
    <span class="hljs-keyword">const</span> command = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PutObjectCommand</span>({
      <span class="hljs-title class_">Bucket</span>: credentials.<span class="hljs-property">bucket_name</span>,
      <span class="hljs-title class_">Key</span>: objectKey,
      <span class="hljs-title class_">ContentType</span>: file.<span class="hljs-property">type</span>
    })

    <span class="hljs-keyword">const</span> presignedUrl = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getSignedUrl</span>(s3Client, command, { <span class="hljs-attr">expiresIn</span>: <span class="hljs-number">3600</span> })

    <span class="hljs-title function_">returnnewPromise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>()

      xhr.<span class="hljs-property">upload</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'progress'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (e.<span class="hljs-property">lengthComputable</span>) {
          <span class="hljs-title function_">onProgress</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>((e.<span class="hljs-property">loaded</span> / e.<span class="hljs-property">total</span>) * <span class="hljs-number">100</span>))
        }
      })

      xhr.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">status</span> &gt;= <span class="hljs-number">200</span> &amp;&amp; xhr.<span class="hljs-property">status</span> &lt; <span class="hljs-number">300</span>) {
          <span class="hljs-title function_">resolve</span>(<span class="hljs-string">`<span class="hljs-subst">${credentials.endpoint_url}</span>/<span class="hljs-subst">${credentials.bucket_name}</span>/<span class="hljs-subst">${objectKey}</span>`</span>)
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-title function_">reject</span>(<span class="hljs-title function_">newError</span>(<span class="hljs-string">`上传失败: <span class="hljs-subst">${xhr.status}</span>`</span>))
        }
      })

      xhr.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-title function_">newError</span>(<span class="hljs-string">'网络错误'</span>)))

      xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'PUT'</span>, presignedUrl, <span class="hljs-literal">true</span>)
      xhr.<span class="hljs-title function_">setRequestHeader</span>(<span class="hljs-string">'Content-Type'</span>, file.<span class="hljs-property">type</span>)
      xhr.<span class="hljs-title function_">send</span>(file)
    })
  }

<span class="hljs-comment">// 3. 简单上传（无进度）</span>
<span class="hljs-keyword">const</span> command = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PutObjectCommand</span>({
    <span class="hljs-title class_">Bucket</span>: credentials.<span class="hljs-property">bucket_name</span>,
    <span class="hljs-title class_">Key</span>: objectKey,
    <span class="hljs-title class_">Body</span>: file,
    <span class="hljs-title class_">ContentType</span>: file.<span class="hljs-property">type</span>
  })

<span class="hljs-keyword">await</span> s3Client.<span class="hljs-title function_">send</span>(command)
<span class="hljs-keyword">return</span><span class="hljs-string">`<span class="hljs-subst">${credentials.endpoint_url}</span>/<span class="hljs-subst">${credentials.bucket_name}</span>/<span class="hljs-subst">${objectKey}</span>`</span>
}

<span class="hljs-comment">/**
 * 获取 S3 凭证
 */</span>
exportasync<span class="hljs-keyword">function</span> <span class="hljs-title function_">getS3Credentials</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Promise</span>&lt;S3Credentials&gt; {
<span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'http://127.0.0.1:9000/api/sts/credentials'</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">headers</span>: { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span> }
  })
<span class="hljs-keyword">const</span> { data } = <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>()
<span class="hljs-keyword">return</span> data
}

<span class="hljs-comment">/**
 * 生成唯一的对象路径
 */</span>
<span class="hljs-keyword">export</span><span class="hljs-keyword">function</span> <span class="hljs-title function_">generateObjectKey</span>(<span class="hljs-params">file: File, prefix = <span class="hljs-string">'uploads'</span></span>): <span class="hljs-built_in">string</span> {
<span class="hljs-keyword">const</span> timestamp = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>()
<span class="hljs-keyword">const</span> random = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>().<span class="hljs-title function_">toString</span>(<span class="hljs-number">36</span>).<span class="hljs-title function_">substring</span>(<span class="hljs-number">2</span>, <span class="hljs-number">8</span>)
<span class="hljs-keyword">const</span> ext = file.<span class="hljs-property">name</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">'.'</span>).<span class="hljs-title function_">pop</span>() || <span class="hljs-string">''</span>
<span class="hljs-keyword">return</span><span class="hljs-string">`<span class="hljs-subst">${prefix}</span>/<span class="hljs-subst">${timestamp}</span>_<span class="hljs-subst">${random}</span>.<span class="hljs-subst">${ext}</span>`</span>
}

</code></pre>
<h4 data-id="heading-12">Vue 组件示例</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"upload-container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>文件上传<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"upload-area"</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"$refs.fileInput.click()"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">ref</span>=<span class="hljs-string">"fileInput"</span>
        <span class="hljs-attr">type</span>=<span class="hljs-string">"file"</span>
        <span class="hljs-attr">multiple</span>
        <span class="hljs-attr">style</span>=<span class="hljs-string">"display: none"</span>
        @<span class="hljs-attr">change</span>=<span class="hljs-string">"handleFileSelect"</span>
      /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>点击选择文件上传<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"file in files"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"file.id"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"file-item"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{{ file.name }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-if</span>=<span class="hljs-string">"file.status === 'uploading'"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">progress</span> <span class="hljs-attr">:value</span>=<span class="hljs-string">"file.progress"</span> <span class="hljs-attr">max</span>=<span class="hljs-string">"100"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">progress</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{{ file.progress }}%<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">"file.status === 'success'"</span>&gt;</span>✅ 成功<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">"file.status === 'error'"</span>&gt;</span>❌ {{ file.error }}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { uploadWithPresignedUrl, generateObjectKey } <span class="hljs-keyword">from</span> <span class="hljs-string">'../utils/upload-presigned'</span>
<span class="hljs-comment">// 或者使用: import { uploadWithSDK, getS3Credentials } from '../utils/upload-sdk'</span>

interface <span class="hljs-title class_">UploadFile</span> {
  <span class="hljs-attr">id</span>: string
  <span class="hljs-attr">name</span>: string
  <span class="hljs-attr">status</span>: <span class="hljs-string">'pending'</span> | <span class="hljs-string">'uploading'</span> | <span class="hljs-string">'success'</span> | <span class="hljs-string">'error'</span>
  <span class="hljs-attr">progress</span>: number
  error?: string
}

<span class="hljs-keyword">const</span> files = ref&lt;<span class="hljs-title class_">UploadFile</span>[]&gt;([])

<span class="hljs-keyword">const</span> <span class="hljs-title function_">handleFileSelect</span> = (<span class="hljs-params">event: Event</span>) =&gt; {
  <span class="hljs-keyword">const</span> target = event.<span class="hljs-property">target</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLInputElement</span>
  <span class="hljs-keyword">if</span> (!target.<span class="hljs-property">files</span>) <span class="hljs-keyword">return</span>

  <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(target.<span class="hljs-property">files</span>).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">uploadFile</span>: <span class="hljs-title class_">UploadFile</span> = {
      <span class="hljs-attr">id</span>: <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>_<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random()}</span>`</span>,
      <span class="hljs-attr">name</span>: file.<span class="hljs-property">name</span>,
      <span class="hljs-attr">status</span>: <span class="hljs-string">'pending'</span>,
      <span class="hljs-attr">progress</span>: <span class="hljs-number">0</span>
    }
    files.<span class="hljs-property">value</span>.<span class="hljs-title function_">push</span>(uploadFile)
    <span class="hljs-title function_">startUpload</span>(uploadFile, file)
  })

  target.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">startUpload</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params">uploadFile: UploadFile, file: File</span>) =&gt; {
  uploadFile.<span class="hljs-property">status</span> = <span class="hljs-string">'uploading'</span>

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> objectKey = <span class="hljs-title function_">generateObjectKey</span>(file)

    <span class="hljs-comment">// 方案一：预签名 URL</span>
    <span class="hljs-keyword">await</span> <span class="hljs-title function_">uploadWithPresignedUrl</span>(file, objectKey, <span class="hljs-function">(<span class="hljs-params">progress</span>) =&gt;</span> {
      uploadFile.<span class="hljs-property">progress</span> = progress
    })

    <span class="hljs-comment">// 方案二：STS 凭证（需要先获取凭证）</span>
    <span class="hljs-comment">// const credentials = await getS3Credentials()</span>
    <span class="hljs-comment">// await uploadWithSDK(file, objectKey, credentials, (progress) =&gt; {</span>
    <span class="hljs-comment">//   uploadFile.progress = progress</span>
    <span class="hljs-comment">// })</span>

    uploadFile.<span class="hljs-property">status</span> = <span class="hljs-string">'success'</span>
  } <span class="hljs-keyword">catch</span> (error) {
    uploadFile.<span class="hljs-property">status</span> = <span class="hljs-string">'error'</span>
    uploadFile.<span class="hljs-property">error</span> = error <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Error</span> ? error.<span class="hljs-property">message</span> : <span class="hljs-string">'上传失败'</span>
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.upload-area</span> {
  <span class="hljs-attribute">border</span>: <span class="hljs-number">2px</span> dashed <span class="hljs-number">#ccc</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">40px</span>;
  <span class="hljs-attribute">text-align</span>: center;
  <span class="hljs-attribute">cursor</span>: pointer;
}

<span class="hljs-selector-class">.upload-area</span><span class="hljs-selector-pseudo">:hover</span> {
  <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#666</span>;
}

<span class="hljs-selector-class">.file-item</span> {
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">10px</span>;
  <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#eee</span>;
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">justify-content</span>: space-between;
  <span class="hljs-attribute">align-items</span>: center;
}

progress {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>;
  <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> <span class="hljs-number">10px</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h3 data-id="heading-13">完整示例</h3>
<h4 data-id="heading-14">场景一：单文件上传（预签名 URL）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 简单上传一个文件</span>
<span class="hljs-keyword">const</span> file = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'input[type="file"]'</span>).<span class="hljs-property">files</span>[<span class="hljs-number">0</span>]
<span class="hljs-keyword">const</span> objectKey = <span class="hljs-string">`uploads/<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>_<span class="hljs-subst">${file.name}</span>`</span>

<span class="hljs-keyword">await</span> <span class="hljs-title function_">uploadWithPresignedUrl</span>(file, objectKey, <span class="hljs-function">(<span class="hljs-params">progress</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`进度: <span class="hljs-subst">${progress}</span>%`</span>)
})

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'上传成功！'</span>)
</code></pre>
<h4 data-id="heading-15">场景二：批量上传（STS 凭证）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 批量上传多个文件</span>
<span class="hljs-keyword">const</span> files = [...<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'input[type="file"]'</span>).<span class="hljs-property">files</span>]

<span class="hljs-comment">// 1. 获取一次凭证</span>
<span class="hljs-keyword">const</span> credentials = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getS3Credentials</span>()

<span class="hljs-comment">// 2. 使用同一凭证上传所有文件</span>
awaitPromise.<span class="hljs-title function_">all</span>(
  files.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">file</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> objectKey = <span class="hljs-title function_">generateObjectKey</span>(file)
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">uploadWithSDK</span>(file, objectKey, credentials, <span class="hljs-function">(<span class="hljs-params">progress</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${file.name}</span>: <span class="hljs-subst">${progress}</span>%`</span>)
    })
  })
)

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'全部上传成功！'</span>)

</code></pre>
<h3 data-id="heading-16">最佳实践</h3>
<h4 data-id="heading-17">1. 方案选择</h4>
<pre><code class="hljs">单文件或少量文件  →  预签名 URL（简单直接）
批量文件上传      →  STS 凭证（减少请求）
</code></pre>
<p>2.  文件验证</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">validateFile</span>(file: File): boolean {
<span class="hljs-comment">// 大小限制（100MB）</span>
if (file.size &gt; <span class="hljs-number">100</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>) {
    <span class="hljs-built_in">alert</span>('文件过大')
    returnfalse
  }

<span class="hljs-comment">// 类型限制</span>
const allowedTypes = <span class="hljs-selector-attr">[<span class="hljs-string">'image/jpeg'</span>, <span class="hljs-string">'image/png'</span>, <span class="hljs-string">'image/gif'</span>]</span>
if (!allowedTypes.includes(file.type)) {
    <span class="hljs-built_in">alert</span>('不支持的文件类型')
    returnfalse
  }

returntrue
}

</code></pre>
<ol start="3">
<li>错误处理和重试</li>
</ol>

<pre><code class="hljs language-ini" lang="ini">async function uploadWithRetry(file: File, <span class="hljs-attr">maxRetries</span> = <span class="hljs-number">3</span>) {
for (let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; maxRetries; i++) {</span>
    try {
      const <span class="hljs-attr">objectKey</span> = generateObjectKey(file)
      returnawait uploadWithPresignedUrl(file, objectKey)
    } catch (error) {
      if (<span class="hljs-attr">i</span> === maxRetries - <span class="hljs-number">1</span>) throw error
      awaitnewPromise(<span class="hljs-attr">resolve</span> =&gt; setTimeout(resolve, <span class="hljs-number">1000</span> * (i + <span class="hljs-number">1</span>)))
    }
  }
}
</code></pre>
<p>4.  安全建议</p>

<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 后端验证</span>
<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/api/presigned-url'</span>, methods=[<span class="hljs-string">'POST'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_presigned_url</span>():
    <span class="hljs-comment"># ✅ 验证文件类型</span>
    allowed_types = [<span class="hljs-string">'image/jpeg'</span>, <span class="hljs-string">'image/png'</span>]
    <span class="hljs-keyword">if</span> data[<span class="hljs-string">'content_type'</span>] notin allowed_types:
        <span class="hljs-keyword">return</span> jsonify({<span class="hljs-string">'code'</span>: <span class="hljs-number">400</span>, <span class="hljs-string">'message'</span>: <span class="hljs-string">'不支持的文件类型'</span>}), <span class="hljs-number">400</span>

    <span class="hljs-comment"># ✅ 验证用户权限</span>
    <span class="hljs-comment"># if not current_user.can_upload():</span>
    <span class="hljs-comment">#     return jsonify({'code': 403, 'message': '无权限'}), 403</span>

    <span class="hljs-comment"># ✅ 限制文件路径</span>
    <span class="hljs-comment"># 确保用户只能上传到自己的目录</span>
    <span class="hljs-comment"># object_key = f"users/{current_user.id}/{filename}"</span>

    <span class="hljs-comment"># 生成预签名 URL</span>
    <span class="hljs-comment"># ...</span>
</code></pre>
<p>5.  性能优化</p>

<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// 并发控制：最多同时上传 3 个文件</span>
<span class="hljs-function">asyncfunction <span class="hljs-title">uploadFilesWithLimit</span><span class="hljs-params">(files: <span class="hljs-built_in">File</span>[], limit = <span class="hljs-number">3</span>)</span> </span>{
<span class="hljs-type">const</span> queue = [...files]
<span class="hljs-type">const</span> results = []
<span class="hljs-type">const</span> executing = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Set</span>()

<span class="hljs-keyword">while</span> (queue.length &gt; <span class="hljs-number">0</span> || executing.size &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">while</span> (queue.length &gt; <span class="hljs-number">0</span> &amp;&amp; executing.size &lt; limit) {
      <span class="hljs-type">const</span> file = queue.<span class="hljs-built_in">shift</span>()!
      <span class="hljs-type">const</span> promise = <span class="hljs-built_in">uploadWithPresignedUrl</span>(file, <span class="hljs-built_in">generateObjectKey</span>(file))
        .<span class="hljs-built_in">then</span>((url) =&gt; {
          executing.<span class="hljs-built_in">delete</span>(promise)
          <span class="hljs-keyword">return</span> { success: <span class="hljs-literal">true</span>, url }
        })
        .<span class="hljs-built_in">catch</span>((error) =&gt; {
          executing.<span class="hljs-built_in">delete</span>(promise)
          <span class="hljs-keyword">return</span> { success: <span class="hljs-literal">false</span>, error }
        })

      executing.<span class="hljs-built_in">add</span>(promise)
      results.<span class="hljs-built_in">push</span>(promise)
    }

    <span class="hljs-keyword">if</span> (executing.size &gt; <span class="hljs-number">0</span>) {
      awaitPromise.<span class="hljs-built_in">race</span>(executing)
    }
  }

returnPromise.<span class="hljs-built_in">all</span>(results)
}
</code></pre>
<h3 data-id="heading-18">总结</h3>
<h4 data-id="heading-19">核心要点</h4>
<ol>
<li>✅ 使用 AWS SDK - boto3（后端）和 @aws-sdk/client-s3（前端）</li>
<li>✅ 预签名 URL - 简单场景首选，后端完全控制</li>
<li>✅ STS 凭证 - 批量上传，减少网络请求</li>
<li>✅ 永久密钥不暴露 - 只在后端使用</li>
<li>✅ 添加验证 - 文件类型、大小、用户权限</li>
<li>✅ 错误处理 - 重试机制，友好提示两种方案对比</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dfa240af53a143688837d83d63b44a9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUnVzdEZT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767329950&amp;x-signature=Br5B5frwRC9I3u4%2BQVKvwp6qikw%3D" alt="截屏2025-12-26 09.39.56.png" loading="lazy"/></p>
<p>方案对比教程完成！开始构建你的文件上传功能吧！ 🎉</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot 项目可执行 jar 的完整 Maven 打包示例]]></title>    <link>https://juejin.cn/post/7587675306658480128</link>    <guid>https://juejin.cn/post/7587675306658480128</guid>    <pubDate>2025-12-26T05:26:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587675306658480128" data-draft-id="7587675443442745384" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot 项目可执行 jar 的完整 Maven 打包示例"/> <meta itemprop="keywords" content="maven"/> <meta itemprop="datePublished" content="2025-12-26T05:26:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿杰AJie"/> <meta itemprop="url" content="https://juejin.cn/user/3871838955636704"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot 项目可执行 jar 的完整 Maven 打包示例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3871838955636704/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿杰AJie
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T05:26:57.000Z" title="Fri Dec 26 2025 05:26:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>Spring Boot 项目可执行 jar 的完整 Maven 打包示例</strong>，同时支持以下功能：</p>
<ul>
<li>跳过测试</li>
<li>指定环境 profile（dev/prod）</li>
<li>自定义版本号</li>
<li>生成可执行 jar</li>
</ul>
<hr/>
<h2 data-id="heading-0"><strong>1. 假设 pom.xml 配置示例</strong></h2>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 定义 Maven 项目的根元素，指定命名空间和 XSD 验证 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">project</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span> 
         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">"http://maven.apache.org/POM/4.0.0 
         http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- Maven 模型版本，一般固定为 4.0.0 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">modelVersion</span>&gt;</span>4.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">modelVersion</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 项目坐标：groupId + artifactId + version 唯一标识一个 Maven 项目 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.example<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>          <span class="hljs-comment">&lt;!-- 项目组织/公司标识，通常使用域名反写 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>demo<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>          <span class="hljs-comment">&lt;!-- 项目名称或模块名 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>               <span class="hljs-comment">&lt;!-- 项目版本 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">packaging</span>&gt;</span>jar<span class="hljs-tag">&lt;/<span class="hljs-name">packaging</span>&gt;</span>             <span class="hljs-comment">&lt;!-- 打包类型，可选 jar/war/pom 等 --&gt;</span>

    <span class="hljs-comment">&lt;!-- 项目属性，可在 pom.xml 或插件中引用 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>17<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span>                       <span class="hljs-comment">&lt;!-- 指定 JDK 版本 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span> <span class="hljs-comment">&lt;!-- 源码编码 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">spring-boot.version</span>&gt;</span>3.2.0<span class="hljs-tag">&lt;/<span class="hljs-name">spring-boot.version</span>&gt;</span>      <span class="hljs-comment">&lt;!-- Spring Boot 版本 --&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 项目依赖 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  <span class="hljs-comment">&lt;!-- Spring Boot 核心启动依赖 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${spring-boot.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>       <span class="hljs-comment">&lt;!-- 使用上面定义的版本 --&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- 构建配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span>
            <span class="hljs-comment">&lt;!-- Spring Boot Maven 插件：用于打包可执行 jar/war --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${spring-boot.version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span> <span class="hljs-comment">&lt;!-- 插件版本与 Spring Boot 版本一致 --&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">executions</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">execution</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">goals</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">goal</span>&gt;</span>repackage<span class="hljs-tag">&lt;/<span class="hljs-name">goal</span>&gt;</span> <span class="hljs-comment">&lt;!-- repackage 目标会把 jar 打成可执行 Spring Boot jar，包含所有依赖 --&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">goals</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">execution</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">executions</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Maven 构建 profile，用于不同环境的配置 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">profiles</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">profile</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>dev<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span> <span class="hljs-comment">&lt;!-- 开发环境 profile ID --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">spring.profiles.active</span>&gt;</span>dev<span class="hljs-tag">&lt;/<span class="hljs-name">spring.profiles.active</span>&gt;</span> <span class="hljs-comment">&lt;!-- Spring Boot 激活 dev 配置 --&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">profile</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">profile</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">id</span>&gt;</span>prod<span class="hljs-tag">&lt;/<span class="hljs-name">id</span>&gt;</span> <span class="hljs-comment">&lt;!-- 生产环境 profile ID --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">spring.profiles.active</span>&gt;</span>prod<span class="hljs-tag">&lt;/<span class="hljs-name">spring.profiles.active</span>&gt;</span> <span class="hljs-comment">&lt;!-- Spring Boot 激活 prod 配置 --&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">profile</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">profiles</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">project</span>&gt;</span>

</code></pre>
<h3 data-id="heading-1"><strong>重点说明</strong></h3>
<ol>
<li>
<p><strong><code>&lt;properties&gt;</code></strong></p>
<ul>
<li>定义全局可复用变量，例如 <code>spring-boot.version</code>，在依赖或插件中可以 <code>${spring-boot.version}</code> 调用。</li>
</ul>
</li>
<li>
<p><strong><code>spring-boot-maven-plugin</code></strong></p>
<ul>
<li>核心功能是把项目打成 <strong>可执行 jar</strong>（内嵌 Tomcat 或其他容器）。</li>
<li><code>&lt;goal&gt;repackage&lt;/goal&gt;</code>：生成可直接运行的 jar。</li>
</ul>
</li>
<li>
<p><strong><code>profiles</code></strong></p>
<ul>
<li>用来区分 <strong>不同环境配置</strong>，如 dev、prod。</li>
<li>打包时可以指定：<code>mvn clean package -Pdev</code>。</li>
<li>激活 Spring Boot 配置文件 <code>application-dev.yml</code> 或 <code>application-prod.yml</code>。</li>
</ul>
</li>
<li>
<p><strong>编码与 Java 版本</strong></p>
<ul>
<li><code>UTF-8</code> 防止中文乱码。</li>
<li><code>&lt;java.version&gt;</code> 决定编译兼容性。</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-2"><strong>2. Maven 打包命令示例</strong></h2>
<pre><code class="hljs language-ini" lang="ini">mvn clean package \
    -Pdev \                       <span class="hljs-comment"># 指定环境为 dev，可改为 prod</span>
    <span class="hljs-attr">-DskipTests</span>=<span class="hljs-literal">true</span> \            <span class="hljs-comment"># 跳过单元测试</span>
    <span class="hljs-attr">-Drevision</span>=<span class="hljs-number">1.0</span>.<span class="hljs-number">5</span>              <span class="hljs-comment"># 自定义版本号</span>
</code></pre>
<p>说明：</p>
<ul>
<li><code>-Pdev</code>：使用 dev profile</li>
<li><code>-DskipTests=true</code>：跳过测试，提高打包速度</li>
<li><code>-Drevision=1.0.5</code>：自定义版本号，可在 pom.xml 使用 <code>${revision}</code></li>
</ul>
<hr/>
<h2 data-id="heading-3"><strong>3. 运行可执行 jar</strong></h2>
<pre><code class="hljs language-ini" lang="ini">java -jar target/demo-1.0.5.jar <span class="hljs-attr">--spring.profiles.active</span>=dev
</code></pre>
<ul>
<li>这里的 <code>spring.profiles.active</code> 可以覆盖 Maven profile</li>
<li>jar 包已经包含所有依赖，直接可运行</li>
</ul>
<hr/>
<h2 data-id="heading-4"><strong>4. 打包 prod 示例</strong></h2>
<pre><code class="hljs language-ini" lang="ini">mvn clean package -Pprod <span class="hljs-attr">-DskipTests</span>=<span class="hljs-literal">true</span> -Drevision=<span class="hljs-number">1.0</span>.<span class="hljs-number">5</span>
java -jar target/demo-1.0.5.jar <span class="hljs-attr">--spring.profiles.active</span>=prod
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[3.Debian_KDE之解决redis跨端访问]]></title>    <link>https://juejin.cn/post/7587825267877773353</link>    <guid>https://juejin.cn/post/7587825267877773353</guid>    <pubDate>2025-12-26T05:47:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587825267877773353" data-draft-id="7586877892468244507" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="3.Debian_KDE之解决redis跨端访问"/> <meta itemprop="keywords" content="开源"/> <meta itemprop="datePublished" content="2025-12-26T05:47:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户852395695921"/> <meta itemprop="url" content="https://juejin.cn/user/3915784942005547"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            3.Debian_KDE之解决redis跨端访问
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3915784942005547/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户852395695921
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T05:47:40.000Z" title="Fri Dec 26 2025 05:47:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>一、虚拟机window访问Debian_KDE redis服务器</strong></h2>
<h3 data-id="heading-1"><strong>1.Debian_KDE安装redis</strong></h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 更新软件源</span>
sudo apt update
<span class="hljs-comment"># 安装 Redis（默认是稳定版，如 6.x/7.x）</span>
sudo apt install redis-server -y
</code></pre>
<h5 data-id="heading-2"><strong>2. 配置 Redis 允许远程访问（重点！默认仅本地可连</strong></h5>
<h6 data-id="heading-3"><strong>编辑 Redis 配置文件：</strong></h6>
<pre><code class="hljs language-bash" lang="bash">sudo nano /etc/redis/redis.conf
</code></pre>
<h6 data-id="heading-4"><strong>改 2 处关键配置：</strong></h6>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span>  找到 <span class="hljs-code">`bind 127.0.0.1`</span>，改成 <span class="hljs-code">`bind 0.0.0.0`</span>（允许所有 IP 访问，跨环境必改）；
<span class="hljs-bullet">2.</span>  找到 <span class="hljs-code">`protected-mode yes`</span>，改成 <span class="hljs-code">`protected-mode no`</span>（关闭保护模式，允许远程连接）；
<span class="hljs-bullet">3.</span>  （可选）设置密码（增强安全）：找到 <span class="hljs-code">`# requirepass foobared`</span>，去掉注释改成 <span class="hljs-code">`requirepass 你的密码`</span>（比如 <span class="hljs-code">`requirepass redis123`</span>）。
<span class="hljs-bullet">4.</span>  默认没有用户名，登录时可以不填，默认的用户名是default
</code></pre>
<h6 data-id="heading-5"><strong>保存退出（按 <code>Ctrl+O</code> → 回车 → <code>Ctrl+X</code>），重启 Redis 生效：</strong></h6>
<pre><code class="hljs language-vbscript" lang="vbscript">sudo systemctl restart redis-<span class="hljs-built_in">server</span>
</code></pre>
<h3 data-id="heading-6">3. 开放 Debian 防火墙 6379 端口（Redis 默认端口）</h3>
<h6 data-id="heading-7">(Debian默认不安装，未安装不用操作)</h6>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 开放 6379 端口（TCP协议）</span>
sudo ufw allow 6379/tcp
<span class="hljs-comment"># 重启防火墙生效</span>
sudo ufw reload
<span class="hljs-comment"># 验证端口是否开放</span>
sudo ufw status
</code></pre>
<p>看到 <code>6379/tcp ALLOW Anywhere</code> 就没问题了。</p>
<h3 data-id="heading-8"><strong>4.Debian 13 可能未预装 ufw 防火墙，先安装：</strong></h3>
<h6 data-id="heading-9">(Debian默认不安装，不安装不用操作)</h6>
<pre><code class="hljs language-sql" lang="sql">sudo apt <span class="hljs-keyword">update</span> <span class="hljs-operator">&amp;&amp;</span> sudo apt install ufw <span class="hljs-operator">-</span>y
</code></pre>
<h3 data-id="heading-10"><strong>5.重启并验证 Redis 服务</strong></h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 重启Redis</span>
sudo systemctl restart redis-server
<span class="hljs-comment"># 查看Redis状态</span>
sudo systemctl status redis-server
</code></pre>
<p>6.在 Debian 终端直接输入：</p>
<pre><code class="hljs">redis-cli
</code></pre>
<p>回车后会进入 Redis 交互式界面（提示符变成 <code>127.0.0.1:6379&gt;</code>），输入 <code>PING</code> 返回 <code>PONG</code> 就说明界面可用：</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-meta prompt_">127.0.0.1:6379&gt;</span> <span class="hljs-variable constant_">PING</span>
<span class="hljs-variable constant_">PONG</span>
</code></pre>
<h3 data-id="heading-11"><strong>7.设置开机自启</strong></h3>
<h6 data-id="heading-12"><strong>redis安装后默认自启</strong></h6>
<pre><code class="hljs language-bash" lang="bash">sudo systemctl <span class="hljs-built_in">enable</span> redis-server
</code></pre>
<p>输出 <code>Created symlink ...</code> 即表示配置成功。</p>
<h3 data-id="heading-13"><strong>8.验证自启状态</strong></h3>
<pre><code class="hljs language-vbscript" lang="vbscript">sudo systemctl <span class="hljs-keyword">is</span>-enabled redis-<span class="hljs-built_in">server</span>
</code></pre>
<p>若返回 <code>enabled</code>，说明开机自启已生效；返回 <code>disabled</code> 则需重新执行开机自启命令。</p>
<h3 data-id="heading-14"><strong>9.虚拟机window下载redis桌面客户端</strong></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fredis.io%2Fdownloads%2F%23Redis_Insight" target="_blank" title="https://redis.io/downloads/#Redis_Insight" ref="nofollow noopener noreferrer">redis.io/downloads/#…</a></p>
<h3 data-id="heading-15"><strong>9.创建redis数据库链接</strong></h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bb24a97f3c64c2f88281660c9149b4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODUyMzk1Njk1OTIx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767332860&amp;x-signature=BFgj2u28ie9bLA0StkdAlP2y3aQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-16"><strong>10.填写IP，用户，密码即可（用户名密码无不填）</strong></h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26aa540865aa4cb0b9cdbd8164a59bbf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODUyMzk1Njk1OTIx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767332860&amp;x-signature=KXfSCqQ0y7Og%2B50%2Fm97c8VHnDTc%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-17"><strong>11.验证数据查询</strong></h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3f2344e90324e4fb532303db1efdbdd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3ODUyMzk1Njk1OTIx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767332860&amp;x-signature=rRtS9MzlcN%2Fcdj2RnpvTuf2Cx4M%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI大模型小白手册 | API调用的魔法指南]]></title>    <link>https://juejin.cn/post/7587675306658594816</link>    <guid>https://juejin.cn/post/7587675306658594816</guid>    <pubDate>2025-12-26T06:11:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587675306658594816" data-draft-id="7587675306658512896" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI大模型小白手册 | API调用的魔法指南"/> <meta itemprop="keywords" content="AIGC,人工智能,LLM"/> <meta itemprop="datePublished" content="2025-12-26T06:11:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="树獭非懒"/> <meta itemprop="url" content="https://juejin.cn/user/2295436009296199"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI大模型小白手册 | API调用的魔法指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2295436009296199/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    树獭非懒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T06:11:13.000Z" title="Fri Dec 26 2025 06:11:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在上一篇文章中，我们深入探讨了大模型的原理和演进历程。你可能已经被这些"超级大脑"的能力所震撼，但心中可能还有一个疑问：作为一个开发者或技术爱好者，我该如何真正"使用"这些能力？</p>
<p><strong>答案是：通过API调用。</strong></p>
<p>想象一下，你不需要了解内燃机的所有原理，也能开车去任何地方；同样，你不需要训练自己的大模型，也能享受AI的强大能力。API就是这辆"AI汽车"的方向盘和油门。</p>
<p>本文将手把手教你掌握AI大模型API调用的核心技能，从基本概念到实际应用，让你能够在快速将AI能力集成到项目中。</p>
<h3 data-id="heading-1">系列目录（持续更新）：</h3>
<p><a href="https://juejin.cn/post/7585027616736165940" target="_blank" title="https://juejin.cn/post/7585027616736165940">AI大模型小白手册|基础原理篇 - 掘金</a></p>
<h2 data-id="heading-2">一、API调用基础：理解"与AI对话"的技术栈</h2>
<h3 data-id="heading-3">什么是AI模型API？</h3>
<p>API（Application Programming Interface）是应用程序编程接口的简称。在大模型领域，API是你与云端AI模型交互的桥梁。</p>
<p>简单来说： 你发送一个问题（Prompt）→ API将其传递给云端模型 → 模型思考并生成回答 → API将答案返回给你。</p>
<h2 data-id="heading-4">二、准备工作：选择合适的平台和工具</h2>
<h3 data-id="heading-5">2.1 主流AI API平台对比</h3>









































<table><thead><tr><th>平台</th><th>代表模型</th><th>主要优势</th><th>适合场景</th></tr></thead><tbody><tr><td>OpenAI</td><td>GPT-4, GPT-3.5</td><td>技术最成熟，生态最完善</td><td>国际项目，英文场景</td></tr><tr><td>阿里云DashScope</td><td>通义千问系列</td><td>中文优化好，性价比高</td><td>中文应用，企业级项目</td></tr><tr><td>DeepSeek API</td><td>DeepSeek系列</td><td>推理能力强，价格亲民</td><td>代码生成，逻辑推理</td></tr><tr><td>百度文心千帆</td><td>文心一言</td><td>中文理解深，集成百度生态</td><td>内容创作，搜索增强</td></tr><tr><td>智谱AI</td><td>GLM系列</td><td>开源友好，技术透明</td><td>定制开发，研究项目</td></tr></tbody></table>
<h3 data-id="heading-6">2.2 阿里云DashScope：中文开发者的首选平台</h3>
<p>在众多AI平台中，阿里云DashScope 很适合中文开发者，因为有以下核心优势：</p>
<ol>
<li>
<p>原生中文优化：通义千问系列模型对中文语境、文化、表达有深度理解</p>
</li>
<li>
<p>稳定可靠：背靠阿里云基础设施，服务稳定性和可用性极高</p>
</li>
<li>
<p>性价比高：价格亲民，提供丰富的免费额度供开发者体验</p>
</li>
<li>
<p>生态完整：与阿里云其他服务（OSS、函数计算等）无缝集成</p>
</li>
<li>
<p>模型丰富：提供从轻量级到顶级的全系列模型</p>
</li>
</ol>
<p><strong>DashScope提供了丰富的模型选择，满足不同场景需求：</strong></p>






















































<table><thead><tr><th>模型系列</th><th>代表模型</th><th>参数量级</th><th>主要特点</th><th>适用场景</th></tr></thead><tbody><tr><td>通义千问</td><td>Qwen-Max</td><td>千亿级</td><td>最强能力，综合表现最佳</td><td>复杂推理、专业问答、代码生成</td></tr><tr><td/><td>Qwen-Plus</td><td>百亿级</td><td>性价比高，能力均衡</td><td>日常对话、内容创作、分析任务</td></tr><tr><td/><td>Qwen-Turbo</td><td>十亿级</td><td>响应快，成本低</td><td>简单问答、实时交互、高频调用</td></tr><tr><td>视觉模型</td><td>Qwen-VL</td><td>多模态</td><td>图文理解与生成</td><td>图像描述、图文问答、文档理解</td></tr><tr><td>代码模型</td><td>CodeQwen</td><td>专用优化</td><td>代码生成与解释</td><td>编程辅助、代码审查、技术解答</td></tr><tr><td>数学模型</td><td>Math-模型</td><td>数学优化</td><td>逻辑推理与计算</td><td>数学解题、数据分析、科研辅助</td></tr></tbody></table>
<h2 data-id="heading-7">三、5分钟搞定"AI驾驶证"：从注册到跑通第一个程序</h2>
<h3 data-id="heading-8">3.1 三步拿钥匙（API Key）</h3>
<p>Step 1：打开 <a href="https://link.juejin.cn?target=https%3A%2F%2Fbailian.console.aliyun.com%2F" target="_blank" title="https://bailian.console.aliyun.com/" ref="nofollow noopener noreferrer">阿里云百炼平台</a>，用支付宝扫码登录（学生党福音，不用企业认证）。</p>
<p>Step 2：左侧导航栏找到「API-KEY」→ 右上角「创建新的API-KEY」→ 复制那串<code>sk-</code>开头的代码。</p>
<p>Step 3（重点）：别直接把密钥写代码里！养成安全习惯：</p>
<p><strong>临时配置（当前终端会话）：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># Mac/Linux终端</span>
export <span class="hljs-attr">DASHSCOPE_API_KEY</span>=<span class="hljs-string">"sk-xxxxxxxx"</span>

<span class="hljs-comment"># Windows CMD</span>
set <span class="hljs-attr">DASHSCOPE_API_KEY</span>=sk-xxxxxxxx
</code></pre>
<p><strong>永久配置方式：</strong></p>
<pre><code class="hljs language-bash" lang="bash">如果用的是zshrc，修改 .zshrc 文件
<span class="hljs-built_in">echo</span> <span class="hljs-string">'export DASHSCOPE_API_KEY="your_api_key_here"'</span> &gt;&gt; ~/.zshrc
<span class="hljs-built_in">source</span> ~/.zshrc

如果用的bash_profile，修改 .bash_profile 文件
<span class="hljs-built_in">echo</span> <span class="hljs-string">'export DASHSCOPE_API_KEY="your_api_key_here"'</span> &gt;&gt; ~/.bash_profile
<span class="hljs-built_in">source</span> ~/.bash_profile
</code></pre>
<p><strong>验证配置</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-variable">$DASHSCOPE_API_KEY</span>
</code></pre>
<h3 data-id="heading-9">3.2 你的第一个AI对话（10行代码跑起来）</h3>
<p>创建<code>first_ai.py</code>，复制下面代码：</p>
<pre><code class="hljs language-ini" lang="ini">import dashscope, os

<span class="hljs-comment"># 从环境变量读取密钥</span>
<span class="hljs-attr">dashscope.api_key</span> = os.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>)

<span class="hljs-comment"># 构建对话历史（列表就是聊天记录）</span>
<span class="hljs-attr">messages</span> = [
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"用小学生能听懂的话，解释什么是人工智能"</span>}
]

<span class="hljs-comment"># 调用模型（qwen-turbo是性价比之王）</span>
<span class="hljs-attr">response</span> = dashscope.Generation.call(
    <span class="hljs-attr">model</span>=<span class="hljs-string">"qwen-turbo"</span>,
    <span class="hljs-attr">messages</span>=messages,
    <span class="hljs-attr">result_format</span>=<span class="hljs-string">'message'</span>  <span class="hljs-comment"># 必须加这个，否则返回格式老版本</span>
)

<span class="hljs-comment"># 提取并打印回答</span>
print("AI说：", response.output.choices<span class="hljs-section">[0]</span>.message.content)
</code></pre>
<h3 data-id="heading-10">3.3 DashScope基础语法</h3>
<h4 data-id="heading-11">1️⃣ 设置密钥</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">dashscope.api_key</span> = os.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>)
</code></pre>
<h4 data-id="heading-12">2️⃣ 构建对话（永远是列表套字典）</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">messages</span> = [
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你是AI助手"</span>},  <span class="hljs-comment"># 可选：给AI定人设</span>
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你好"</span>}           <span class="hljs-comment"># 必填：你的问题</span>
]
</code></pre>
<p><strong>"角色"role的区别</strong></p>
<p>system是"导演"，user是"观众"，assistant是"演员"，function/tool是"道具"。</p>









































<table><thead><tr><th>角色</th><th>通俗解释</th><th>什么时候用</th><th>示例代码</th></tr></thead><tbody><tr><td><strong><code>user</code></strong></td><td><strong>你提的问题</strong></td><td>每次必须出现</td><td><code>{"role": "user", "content": "今天天气怎样"}</code></td></tr><tr><td><strong><code>assistant</code></strong></td><td><strong>AI上次的回答</strong></td><td>多轮对话时追加</td><td><code>{"role": "assistant", "content": "需要查哪个城市？"}</code></td></tr><tr><td><strong><code>system</code></strong></td><td><strong>给AI定"人设"</strong></td><td>需要AI扮演特定角色时</td><td><code>{"role": "system", "content": "你是专业医生"}</code></td></tr><tr><td><code>function</code></td><td>函数返回的结果</td><td>AI调用你的函数后，把结果喂给它</td><td><code>{"role": "function", "name": "get_weather", "content": "北京28度"}</code></td></tr><tr><td><code>tool</code></td><td>新版工具结果</td><td>新版Function Call用，作用同function</td><td><code>{"role": "tool", "name": "get_weather", "content": "北京28度"}</code></td></tr></tbody></table>
<h4 data-id="heading-13">3️⃣ 调用模型（5个核心参数）</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">response</span> = dashscope.Generation.call(
    <span class="hljs-attr">model</span>=<span class="hljs-string">"qwen-turbo"</span>,        <span class="hljs-comment"># 用哪个模型（见第三章）</span>
    <span class="hljs-attr">messages</span>=messages,          <span class="hljs-comment"># 对话历史</span>
    <span class="hljs-attr">result_format</span>=<span class="hljs-string">'message'</span>,    <span class="hljs-comment"># 必须！否则返回老格式</span>
    <span class="hljs-attr">temperature</span>=<span class="hljs-number">0.7</span>,            <span class="hljs-comment"># 可选：AI的"创造力"旋钮</span>
    <span class="hljs-attr">max_tokens</span>=<span class="hljs-number">1500</span>             <span class="hljs-comment"># 可选：让AI说多少字</span>
)
</code></pre>
<p><strong>参数解释：</strong></p>






















































<table><thead><tr><th>参数</th><th>类型</th><th>默认值</th><th>人话解释</th><th>调参技巧</th></tr></thead><tbody><tr><td><code>model</code></td><td>string</td><td>必填</td><td>选哪个"专家"回答</td><td>简单任务用turbo，复杂任务用max</td></tr><tr><td><code>messages</code></td><td>list</td><td>必填</td><td>聊天记录</td><td>像微信聊天，一条一条追加</td></tr><tr><td><code>result_format</code></td><td>string</td><td>必填</td><td>返回格式</td><td>永远写<code>'message'</code>，不然取不到答案</td></tr><tr><td><code>temperature</code></td><td>float</td><td>0.7</td><td>AI的"脑洞"大小</td><td>0=不脑洞（写合同），1=脑洞全开（写小说）</td></tr><tr><td><code>max_tokens</code></td><td>int</td><td>1024</td><td>最多说几个字</td><td>长文章设2000，短问答设500</td></tr><tr><td><code>stream</code></td><td>bool</td><td>False</td><td>是否打字机式输出</td><td>聊天机器人设True，体验更好</td></tr></tbody></table>
<h4 data-id="heading-14">4️⃣ 提取回答</h4>
<p><strong>获取结果的三种方式（根据需求选）</strong></p>
<pre><code class="hljs language-lua" lang="lua"> # 方式<span class="hljs-number">1</span>：同步等待（简单，推荐新手）  response = dashscope.Generation.call(...) answer = response.<span class="hljs-built_in">output</span>.choices[<span class="hljs-number">0</span>].message.content <span class="hljs-built_in">print</span> (answer) # 一次性打印全部   # 方式<span class="hljs-number">2</span>：流式输出（像ChatGPT那样逐字蹦，体验好）  response = dashscope.Generation.call(..., stream=True) <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> response:  <span class="hljs-built_in">print</span> (chunk.<span class="hljs-built_in">output</span>.choices[<span class="hljs-number">0</span>].message.content, <span class="hljs-keyword">end</span>= <span class="hljs-string">''</span> ) # <span class="hljs-keyword">end</span>=<span class="hljs-string">''</span>防止换行   # 方式<span class="hljs-number">3</span>：检查返回状态（生产环境用）  <span class="hljs-keyword">if</span> response.status_code == <span class="hljs-number">200</span>: # HTTP成功  answer = response.<span class="hljs-built_in">output</span>.choices[<span class="hljs-number">0</span>].message.content <span class="hljs-keyword">else</span> :  <span class="hljs-built_in">print</span> (f <span class="hljs-string">"报错啦：{response.message}"</span> ) # 打印错误信息
</code></pre>
<h2 data-id="heading-15">四、进阶玩法</h2>
<h3 data-id="heading-16">4.1 立人设：AI会更听话</h3>
<p>System Prompt：AI的"角色扮演"开关</p>
<p>普通对话AI容易"一本正经"，但加上system prompt，它能秒变任何角色：</p>
<pre><code class="hljs language-ini" lang="ini">import dashscope, os

<span class="hljs-comment"># 从环境变量读取密钥</span>
<span class="hljs-attr">dashscope.api_key</span> = os.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>)
print("API Key:", dashscope.api_key)

<span class="hljs-attr">messages</span> = [
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"你是一位暴躁的东北烧烤店老板，说话必须带'嘎哈呢'、'整点啥'等东北话"</span>},
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"推荐个招牌菜"</span>}
]

<span class="hljs-attr">response</span> = dashscope.Generation.call(
    <span class="hljs-attr">model</span>=<span class="hljs-string">"qwen-turbo"</span>,
    <span class="hljs-attr">messages</span>=messages,
    <span class="hljs-attr">result_format</span>=<span class="hljs-string">'message'</span>  <span class="hljs-comment"># 必须加这个，否则返回格式老版本</span>
)

<span class="hljs-comment"># 提取并打印回答</span>
print("AI说：", response.output.choices<span class="hljs-section">[0]</span>.message.content)
</code></pre>
<p>输出</p>
<pre><code class="hljs">AI说： 哎呦喂！你这小子可算来对地方了！咱家的招牌菜那可真是绝了，整点啥啊？我跟你说啊，这烤串儿是咱们东北老铁们最爱的玩意儿，特别是那个羊蝎子，嘎哈呢？那叫一个香！肉质嫩得跟豆腐似的，配上咱家特制的调料，啧啧，好吃得不行！

不过你要是想吃点别的，咱家还有烧烤鸡翅、烤鱿鱼、烤茄子什么的，都是现烤现卖，保证新鲜！你倒是说说，你想整点啥？我给你推荐几样最拿手的！
</code></pre>
<h3 data-id="heading-17">4.2 Function Call：天气查询</h3>
<p>场景：用户问"北京今天几度？"，AI不能瞎猜，它需要调用真实函数去查。</p>
<p>原理：你提前告诉AI"我有查天气工具"，AI会自动判断何时该调用它，并自己填参数。</p>
<h4 data-id="heading-18"><strong>1️⃣ 导入必要的库和设置API密钥</strong></h4>
<p>导入库，设置 API 密钥</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json          <span class="hljs-comment"># 用于处理JSON格式数据</span>
<span class="hljs-keyword">import</span> os            <span class="hljs-comment"># 操作系统相关功能</span>
<span class="hljs-keyword">import</span> dashscope     <span class="hljs-comment"># 阿里云DashScope SDK，用于调用Qwen模型</span>
<span class="hljs-keyword">from</span> dashscope.api_entities.dashscope_response <span class="hljs-keyword">import</span> Role
dashscope.api_key = <span class="hljs-string">"sk-xxx"</span>  <span class="hljs-comment"># 设置API密钥</span>
</code></pre>
<h4 data-id="heading-19"><strong>2️⃣ 定义天气查询函数 get_current_weather</strong></h4>
<p>这是一个模拟的天气查询函数，实际应用中应该调用真实的天气API。根据不同的城市返回不同的温度</p>
<pre><code class="hljs language-ini" lang="ini">def get_current_weather(location, <span class="hljs-attr">unit</span>=<span class="hljs-string">"摄氏度"</span>):
    <span class="hljs-attr">temperature</span> = -<span class="hljs-number">1</span>
    if '大连' in location or 'Dalian' in location:
        <span class="hljs-attr">temperature</span> = <span class="hljs-number">10</span>
    if <span class="hljs-attr">location</span>==<span class="hljs-string">'上海'</span>:
        <span class="hljs-attr">temperature</span> = <span class="hljs-number">36</span>
    if <span class="hljs-attr">location</span>==<span class="hljs-string">'深圳'</span>:
        <span class="hljs-attr">temperature</span> = <span class="hljs-number">37</span>
    <span class="hljs-attr">weather_info</span> = {
        "location": location,
        "temperature": temperature,
        "unit": unit,
        "forecast": <span class="hljs-section">["晴天", "微风"]</span>,
    }
    return json.dumps(weather_info)
</code></pre>
<h4 data-id="heading-20">3️⃣ <strong>定义API调用函数</strong></h4>
<p>封装了对Qwen模型的API调用。接收对话消息列表、调用Qwen模型、返回模型的响应、如果出错，打印错误信息并返回None</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_response</span>(<span class="hljs-params">messages</span>):
    <span class="hljs-keyword">try</span>:
        response = dashscope.Generation.call(
            model=<span class="hljs-string">'qwen-turbo'</span>,      <span class="hljs-comment"># 使用的模型名称</span>
            messages=messages,       <span class="hljs-comment"># 对话历史</span>
            functions=functions,     <span class="hljs-comment"># 可用的函数列表</span>
            result_format=<span class="hljs-string">'message'</span>  <span class="hljs-comment"># 返回格式</span>
        )
        <span class="hljs-keyword">return</span> response
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"API调用出错: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
</code></pre>
<h4 data-id="heading-21">4️⃣ <strong>定义函数描述（Function Schema）</strong></h4>
<p>告诉AI模型有哪些函数可以调用，以及这些函数需要什么参数。</p>
<ul>
<li><strong>name</strong>：函数名，必须和实际定义的函数名一致</li>
<li><strong>description</strong>：告诉AI什么时候应该调用这个函数</li>
<li><strong>parameters</strong>：定义函数需要的参数类型和格式</li>
<li><strong>required</strong>：哪些参数是必须的</li>
</ul>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">functions</span> = [
    {
      <span class="hljs-string">'name'</span>: <span class="hljs-string">'get_current_weather'</span>,           <span class="hljs-comment"># 函数名称</span>
      <span class="hljs-string">'description'</span>: <span class="hljs-string">'Get the current weather in a given location.'</span>,  <span class="hljs-comment"># 函数描述</span>
      <span class="hljs-string">'parameters'</span>: {
            <span class="hljs-string">'type'</span>: <span class="hljs-string">'object'</span>,
            <span class="hljs-string">'properties'</span>: {
                <span class="hljs-string">'location'</span>: {
                    <span class="hljs-string">'type'</span>: <span class="hljs-string">'string'</span>,
                    <span class="hljs-string">'description'</span>: <span class="hljs-string">'The city and state, e.g. San Francisco, CA'</span>
                },
                <span class="hljs-string">'unit'</span>: {<span class="hljs-string">'type'</span>: <span class="hljs-string">'string'</span>, <span class="hljs-string">'enum'</span>: [<span class="hljs-string">'celsius'</span>, <span class="hljs-string">'fahrenheit'</span>]}
            },
        <span class="hljs-string">'required'</span>: [<span class="hljs-string">'location'</span>]  <span class="hljs-comment"># 必填参数</span>
      }
    }
]
</code></pre>
<h4 data-id="heading-22">5️⃣ <strong>主对话函数（核心逻辑）</strong></h4>
<p><strong>5.1 初始化对话</strong></p>
<p>准备用户的提问，格式化为模型需要的消息格式。</p>
<pre><code class="hljs language-ini" lang="ini">def run_conversation():
    <span class="hljs-attr">query</span> = <span class="hljs-string">"上海的天气怎样"</span>  <span class="hljs-comment"># 用户的问题</span>
    <span class="hljs-attr">messages</span>=[{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: query}]  <span class="hljs-comment"># 创建消息列表</span>
</code></pre>
<p><strong>5.2 第一次调用模型（判断是否需要调用函数）</strong></p>
<ol>
<li>将用户问题发送给Qwen模型</li>
<li>模型分析问题："上海的天气怎样"</li>
<li>模型看到有<code>get_current_weather</code>函数可用</li>
<li>模型决定：需要调用这个函数来获取天气信息</li>
<li>模型返回：<code>function_call</code>，表示要调用函数，而不是直接回答</li>
</ol>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-comment"># 得到第一次响应</span>
    response = get_response(messages)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> response <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> response.output:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"获取响应失败"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
        
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'response='</span>, response)
    
    message = response.output.choices[<span class="hljs-number">0</span>].message  <span class="hljs-comment"># 提取模型返回的消息</span>
    messages.append(message)  <span class="hljs-comment"># 将模型响应添加到消息历史</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'message='</span>, message)
</code></pre>
<p><strong>返回示例</strong></p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"role"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"assistant"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"content"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"function_call"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"arguments"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{"</span>location<span class="hljs-string">": "</span>上海<span class="hljs-string">"}"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"get_current_weather"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>5.3 执行函数调用</strong></p>
<p>判断用户是否要call function</p>
<ol>
<li>
<p><strong>检查</strong>：模型是否要求调用函数？是的，有<code>function_call</code></p>
</li>
<li>
<p><strong>提取信息</strong>：</p>
</li>
</ol>
<ul>
<li>函数名：<code>get_current_weather</code></li>
<li>参数：<code>{"location": "上海"}</code></li>
</ul>
<ol start="3">
<li><strong>执行函数</strong>：调用<code>get_current_weather(location="上海")</code></li>
</ol>
<ul>
<li>返回：<code>{"location": "上海", "temperature": 36, "unit": null, "forecast": ["晴天", "微风"]}</code></li>
</ul>
<ol start="4">
<li><strong>记录结果</strong>：将函数执行结果添加到消息历史中</li>
</ol>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(message, <span class="hljs-string">'function_call'</span>) <span class="hljs-keyword">and</span> message.function_call:
        function_call = message.function_call
        tool_name = function_call[<span class="hljs-string">'name'</span>]  <span class="hljs-comment"># 获取函数名：'get_current_weather'</span>
        
        <span class="hljs-comment"># Step 3, 执行function call</span>
        arguments = json.loads(function_call[<span class="hljs-string">'arguments'</span>])  <span class="hljs-comment"># 解析参数：{'location': '上海'}</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'arguments='</span>, arguments)
        
        <span class="hljs-comment"># 调用实际的函数</span>
        tool_response = get_current_weather(
            location=arguments.get(<span class="hljs-string">'location'</span>),  <span class="hljs-comment"># '上海'</span>
            unit=arguments.get(<span class="hljs-string">'unit'</span>),          <span class="hljs-comment"># None（未提供）</span>
        )
        
        <span class="hljs-comment"># 将函数执行结果添加到消息历史</span>
        tool_info = {<span class="hljs-string">"role"</span>: <span class="hljs-string">"function"</span>, <span class="hljs-string">"name"</span>: tool_name, <span class="hljs-string">"content"</span>: tool_response}
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'tool_info='</span>, tool_info)
        messages.append(tool_info)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'messages='</span>, messages)
</code></pre>
<p><strong>此时messages列表包含</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">[
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"上海的天气怎样"</span>},                    <span class="hljs-comment"># 用户问题</span>
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">""</span>, <span class="hljs-string">"function_call"</span>: {...}},    <span class="hljs-comment"># 模型要求调用函数</span>
    {<span class="hljs-string">"role"</span>: <span class="hljs-string">"function"</span>, <span class="hljs-string">"name"</span>: <span class="hljs-string">"get_current_weather"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"..."</span>}  <span class="hljs-comment"># 函数执行结果</span>
]
</code></pre>
<p><strong>5.4 第二次调用模型（生成最终回答）</strong></p>
<pre><code class="hljs language-lua" lang="lua">  response = get_response(messages)
  <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> response <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> response.<span class="hljs-built_in">output</span>:
     <span class="hljs-built_in">print</span>(<span class="hljs-string">"获取第二次响应失败"</span>)
     <span class="hljs-keyword">return</span> None
            
     <span class="hljs-built_in">print</span>(<span class="hljs-string">'response='</span>, response)
     message = response.<span class="hljs-built_in">output</span>.choices[<span class="hljs-number">0</span>].message
     <span class="hljs-keyword">return</span> message
   <span class="hljs-keyword">return</span> message
</code></pre>
<p>6️⃣ <strong>执行主程序</strong></p>
<p>当直接运行这个脚本时，执行对话流程并打印结果。</p>
<pre><code class="hljs language-sql" lang="sql">if __name__ <span class="hljs-operator">=</span><span class="hljs-operator">=</span> "__main__":
    <span class="hljs-keyword">result</span> <span class="hljs-operator">=</span> run_conversation()
    if <span class="hljs-keyword">result</span>:
        print("最终结果:", <span class="hljs-keyword">result</span>)
    <span class="hljs-keyword">else</span>:
        print("对话执行失败")
</code></pre>
<p><strong>完整代码如下：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> json, dashscope, os
dashscope.api_key = os.getenv(<span class="hljs-string">"DASHSCOPE_API_KEY"</span>)

<span class="hljs-comment"># 编写你的函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_current_weather</span>(<span class="hljs-params">location, unit=<span class="hljs-string">"摄氏度"</span></span>):
    <span class="hljs-comment"># 获取指定地点的天气</span>
    temperature = -<span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> <span class="hljs-string">'大连'</span> <span class="hljs-keyword">in</span> location <span class="hljs-keyword">or</span> <span class="hljs-string">'Dalian'</span> <span class="hljs-keyword">in</span> location:
        temperature = <span class="hljs-number">10</span>
    <span class="hljs-keyword">if</span> location==<span class="hljs-string">'上海'</span>:
        temperature = <span class="hljs-number">36</span>
    <span class="hljs-keyword">if</span> location==<span class="hljs-string">'深圳'</span>:
        temperature = <span class="hljs-number">37</span>
    weather_info = {
        <span class="hljs-string">"location"</span>: location,
        <span class="hljs-string">"temperature"</span>: temperature,
        <span class="hljs-string">"unit"</span>: unit,
        <span class="hljs-string">"forecast"</span>: [<span class="hljs-string">"晴天"</span>, <span class="hljs-string">"微风"</span>],
    }
    <span class="hljs-comment"># 返回json格式</span>
    <span class="hljs-keyword">return</span> json.dumps(weather_info)

<span class="hljs-comment"># 封装模型响应函数</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">get_response</span>(<span class="hljs-params">messages</span>):
    <span class="hljs-keyword">try</span>:
        response = dashscope.Generation.call(
            model=<span class="hljs-string">'qwen-turbo'</span>,
            messages=messages,
            functions=functions,
            result_format=<span class="hljs-string">'message'</span>
        )
        <span class="hljs-keyword">return</span> response
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"API调用出错: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

<span class="hljs-comment"># 使用function call进行QA</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">run_conversation</span>():
    query = <span class="hljs-string">"上海的天气怎样"</span>
    messages=[{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: query}]
    
    <span class="hljs-comment"># 得到第一次响应</span>
    response = get_response(messages)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> response <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> response.output:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"获取响应失败"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
        
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'response='</span>, response)
    
    message = response.output.choices[<span class="hljs-number">0</span>].message
    messages.append(message)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'message='</span>, message)
    
    <span class="hljs-comment"># Step 2, 判断用户是否要call function</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(message, <span class="hljs-string">'function_call'</span>) <span class="hljs-keyword">and</span> message.function_call:
        function_call = message.function_call
        tool_name = function_call[<span class="hljs-string">'name'</span>]
        <span class="hljs-comment"># Step 3, 执行function call</span>
        arguments = json.loads(function_call[<span class="hljs-string">'arguments'</span>])
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'arguments='</span>, arguments)
        tool_response = get_current_weather(
            location=arguments.get(<span class="hljs-string">'location'</span>),
            unit=arguments.get(<span class="hljs-string">'unit'</span>),
        )
        tool_info = {<span class="hljs-string">"role"</span>: <span class="hljs-string">"function"</span>, <span class="hljs-string">"name"</span>: tool_name, <span class="hljs-string">"content"</span>: tool_response}
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'tool_info='</span>, tool_info)
        messages.append(tool_info)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'messages='</span>, messages)
        
        <span class="hljs-comment">#Step 4, 得到第二次响应</span>
        response = get_response(messages)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> response <span class="hljs-keyword">or</span> <span class="hljs-keyword">not</span> response.output:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"获取第二次响应失败"</span>)
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
            
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'response='</span>, response)
        message = response.output.choices[<span class="hljs-number">0</span>].message
        <span class="hljs-keyword">return</span> message
    <span class="hljs-keyword">return</span> message

functions = [
    {
      <span class="hljs-string">'name'</span>: <span class="hljs-string">'get_current_weather'</span>,
      <span class="hljs-string">'description'</span>: <span class="hljs-string">'Get the current weather in a given location.'</span>,
      <span class="hljs-string">'parameters'</span>: {
            <span class="hljs-string">'type'</span>: <span class="hljs-string">'object'</span>,
            <span class="hljs-string">'properties'</span>: {
                <span class="hljs-string">'location'</span>: {
                    <span class="hljs-string">'type'</span>: <span class="hljs-string">'string'</span>,
                    <span class="hljs-string">'description'</span>: <span class="hljs-string">'The city and state, e.g. San Francisco, CA'</span>
                },
                <span class="hljs-string">'unit'</span>: {<span class="hljs-string">'type'</span>: <span class="hljs-string">'string'</span>, <span class="hljs-string">'enum'</span>: [<span class="hljs-string">'celsius'</span>, <span class="hljs-string">'fahrenheit'</span>]}
            },
        <span class="hljs-string">'required'</span>: [<span class="hljs-string">'location'</span>]
      }
    }
]

<span class="hljs-comment"># 主函数</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    result = run_conversation()
    <span class="hljs-keyword">if</span> result:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"最终结果:"</span>, result)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"对话执行失败"</span>)
</code></pre>
<h2 data-id="heading-23">五、附录</h2>
<ul>
<li>本文的<code>tools</code>参数详解、错误码大全都在这: <a href="https://link.juejin.cn?target=http%3A%2F%2Fhelp.aliyun.com%2Fdocument_detail%2F2712576.html" target="_blank" title="http://help.aliyun.com/document_detail/2712576.html" ref="nofollow noopener noreferrer">《Function Calling官方指南》（阿里云百炼文档）</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RUM 赋能 iOS App 稳定：从异常体系到监控方案的全方位解析！]]></title>    <link>https://juejin.cn/post/7587961565475815478</link>    <guid>https://juejin.cn/post/7587961565475815478</guid>    <pubDate>2025-12-26T06:14:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587961565475815478" data-draft-id="7587582213060755510" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RUM 赋能 iOS App 稳定：从异常体系到监控方案的全方位解析！"/> <meta itemprop="keywords" content="云原生,iOS"/> <meta itemprop="datePublished" content="2025-12-26T06:14:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RUM 赋能 iOS App 稳定：从异常体系到监控方案的全方位解析！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T06:14:41.000Z" title="Fri Dec 26 2025 06:14:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：高玉龙（元泊）</p>
<h2 data-id="heading-0">背景介绍</h2>
<p>App 上线后，作为开发同学，最怕出现的情况就是应用崩溃了。但是，线下测试好好的 App，为什么上线后就发生崩溃了呢？这些崩溃日志信息是怎么采集的？</p>
<p>先看看几个常见的编写代码时的疏忽，是如何让应用崩溃的。</p>
<ul>
<li>数组越界：在取数据索引时越界，App 会发生崩溃。</li>
<li>多线程问题：在子线程中进行 UI 更新可能会发生崩溃。多个线程进行数据的读取操作，因为处理时机不一致，比如有一个线程在置空数据的同时另一个线程在读取这个数据，可能会出现崩溃情况。</li>
<li>主线程无响应：如果主线程超过系统规定的时间无响应，就会被 Watchdog 杀掉。</li>
<li>野指针：指针指向一个已删除的对象访问内存区域时，会出现野指针崩溃。</li>
</ul>
<p>为了解决这个问题，阿里云可观测研发团队进行了一些 iOS 异常监控方向的探索。</p>
<h2 data-id="heading-1">iOS 异常体系介绍</h2>
<p>iOS 异常体系采用分层架构，从底层硬件到上层应用，异常在不同层次被捕获和处理。理解异常体系的分层结构，有助于我们更好地设计和实现异常监控方案。iOS 异常体系主要分为以下几个层次：</p>
<p><strong>1. 硬件层异常</strong></p>
<ul>
<li>CPU 异常：由硬件直接产生的异常，如非法指令、内存访问错误等</li>
<li>这是最底层的异常来源，所有其他异常最终都源于此</li>
</ul>
<p><strong>2. 系统层异常</strong></p>
<ul>
<li><strong>Mach 异常：</strong> macOS/iOS 系统最底层的异常机制，源于 Mach 微内核架构</li>
<li><strong>Unix 信号：</strong> Mach 异常会被转换为 Unix 信号，如 SIGSEGV、SIGABRT 等</li>
<li>系统层异常是应用层异常监控的主要捕获点</li>
</ul>
<p><strong>3. 运行时层异常</strong></p>
<ul>
<li><strong>NSException：</strong> Objective-C 运行时异常，如数组越界、空指针等</li>
<li><strong>C++ 异常：</strong> C++ 代码抛出的异常，通过 <code>std::terminate()</code> 处理</li>
<li>运行时层异常通常由编程错误引起</li>
</ul>
<p><strong>4. 应用层异常</strong></p>
<ul>
<li>业务逻辑异常：应用自定义的异常和错误</li>
<li>性能异常：主线程死锁、内存泄漏等</li>
<li>僵尸对象访问：访问已释放对象导致的异常</li>
</ul>
<p>异常体系的分层关系如下图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/76b1aebf9fbb4fadbaa11904a79b8ebe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334480&amp;x-signature=zzyK08sey2WdbpWl7zaCE3NfFdI%3D" alt="图片" loading="lazy"/></p>
<p><strong>异常捕获的层次关系：</strong></p>
<ol>
<li><strong>硬件异常 → Mach 异常：</strong> CPU 异常被 Mach 内核捕获，转换为 Mach 异常消息</li>
<li><strong>Mach 异常 → Unix 信号：</strong> Mach 异常处理机制会将异常转换为对应的 Unix 信号</li>
<li><strong>运行时异常：</strong> NSException 和 C++ 异常在运行时层被捕获，如果未处理会触发系统层异常</li>
<li><strong>应用层异常：</strong> 业务异常和性能问题需要应用层主动监控和检测</li>
</ol>
<p>异常监控策略：</p>
<ul>
<li><strong>系统层监控：</strong> 通过 Mach 异常和 Unix 信号捕获，可以捕获所有底层异常</li>
<li><strong>运行时层监控：</strong> 通过设置异常处理器（NSUncaughtExceptionHandler、terminate handler）捕获运行时异常</li>
<li><strong>应用层监控：</strong> 通过主动检测机制（死锁检测、僵尸对象检测）发现潜在问题</li>
</ul>
<p>理解这个分层体系，有助于我们：</p>
<ul>
<li>选择合适的异常捕获机制</li>
<li>理解不同异常类型的来源和处理方式</li>
<li>设计完整的异常监控方案</li>
</ul>
<h2 data-id="heading-2">主流异常监控方案</h2>
<p>在 iOS 端侧异常监控领域，PLCrashReporter 与 KSCrash 是最常用的两个内核库。两者都是开源、生产可用，且被多家平台化产品或 SDK 采用作为底层能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f29cd5dfb83449980eb292e7409ed2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334480&amp;x-signature=nhC8P4pByPRX5VXdRbIYWE%2BUw6Q%3D" alt="图片" loading="lazy"/></p>
<p>基于以上对比分析，KSCrash 相比其他崩溃监控框架的核心优势在于：</p>
<ul>
<li>异常类型监测支持更全面（唯一同时支持 C++ 异常、死锁检测、僵尸对象检测的开源框架）</li>
<li>异步安全设计（崩溃处理完全异步安全，双重异常处理线程确保可靠性）</li>
<li>技术优势明显（堆栈游标抽象、内存内省、模块化架构等）</li>
</ul>
<p>基于以上优势，我们选择基于 KSCrash 作为崩溃异常监控的核心方案。</p>
<h2 data-id="heading-3">异常监控方案实现</h2>
<h3 data-id="heading-4">架构设计</h3>
<p>异常采集模块，是我们 SDK 数据采集层一个模块的具体实现，如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c4730892e98c423789008773cf0038fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334480&amp;x-signature=d6x5g7bs%2FbB4M4nyDRVhY7qu3G0%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>监控器管理层：统一管理所有监控器，提供统一的异常处理入口</li>
<li>异常捕获层：多种监控器，分别捕获不同类型的异常和状态信息</li>
<li>异常处理层：构建崩溃上下文，收集堆栈、符号、内存等信息</li>
<li>报告生成层：将崩溃上下文转换为 JSON 格式报告</li>
</ul>
<p>接下来，我们介绍各种类型异常的捕获原理，以及对应监控器是如何实现的。</p>
<h3 data-id="heading-5">系统层异常捕获</h3>
<p>系统层异常包括 Mach 异常和 Unix 信号，是应用层异常监控的主要捕获点。我们需要同时捕获这两种异常，确保不遗漏任何底层异常。</p>
<p><strong>Mach 异常捕获</strong></p>
<p>Mach 异常是 macOS/iOS 系统最底层的异常机制，源于 Mach 微内核架构。Mach 是 macOS/iOS 内核的基础，提供了进程间通信（IPC）和异常处理的核心机制。硬件异常（CPU 异常）会被 Mach 内核捕获并转换为 Mach 异常消息。Mach 异常与特定线程关联，可以精确捕获异常发生的线程。Mach 异常通过 Mach 消息异步传递异常信息，需要使用 Mach 端口（Mach Port）作为异常处理的通信通道。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/35c0d189c0114803beb1b2c3c7350419~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334480&amp;x-signature=6dddWt9JW1BUAqL59282SzA1J10%3D" alt="图片" loading="lazy"/></p>
<p>监控 Mach 异常，涉及以下几个核心的步骤：</p>
<p><strong>1. 创建异常端口</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 创建新的异常处理端口</span>
<span class="hljs-built_in">mach_port_allocate</span>(mach_task_self(), MACH_PORT_RIGHT_RECEIVE, &amp;g_exceptionPort);
<span class="hljs-comment">// 申请端口权限</span>
<span class="hljs-built_in">mach_port_insert_right</span>(mach_task_self(), g_exceptionPort, g_exceptionPort, MACH_MSG_TYPE_MAKE_SEND);
</code></pre>
<p>为了与三方 SDK 兼容，在创建新的异常处理端口之前，需要对旧的异常处理端口进行保存，并在异常处理完毕后恢复旧的异常端口。</p>
<p><strong>2. 注册异常处理器</strong></p>
<p>把异常处理端口设置为刚才创建的：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 设置异常端口，捕获所有异常类型</span>
<span class="hljs-built_in">task_set_exception_ports</span>(
    mach_task_self(),
    EXC_MASK_ALL,
    g_exceptionPort,
    EXCEPTION_DEFAULT,
    MACHINE_THREAD_STATE
);
</code></pre>
<p><strong>3. 创建异常处理线程</strong></p>
<p>为了防止异常处理线程本身崩溃，需要创建两个独立的异常处理线程：</p>
<ul>
<li>主处理线程：正常处理异常</li>
<li>备用处理线程：主处理线程崩溃时的后备份方案</li>
</ul>

<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 主异常处理线程</span>
<span class="hljs-built_in">pthread_create</span>(&amp;g_primaryPThread, &amp;attr, handleExceptions, kThreadPrimary);
<span class="hljs-comment">// 备用异常处理线程（防止主线程崩溃）</span>
<span class="hljs-built_in">pthread_create</span>(&amp;g_secondaryPThread, &amp;attr, handleExceptions, kThreadSecondary);
</code></pre>
<p>主备线程之间的关系如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca5e38d3619b404c86fbae5a052a8be3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334480&amp;x-signature=XzQr3NIkoc132BvsNpFWRMg7rc8%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>备用处理线程在创建后会立即挂起</li>
<li>主线程在处理异常之前会通过 <code>thread_resume()</code> 函数恢复备用处理线程</li>
<li>备用处理线程恢复后，会进入 <code>mach_msg()</code> 等待</li>
<li>如果主线程在处理异常时发生崩溃，备用处理线程可以继续处理崩溃信息（由于异常端口已恢复，此时备用线程可能也收不到消息）</li>
</ul>
<p><strong>4. 处理异常消息</strong></p>
<p>异常处理线程通过 <code>mach_msg()</code> 接收异常消息：</p>
<pre><code class="hljs language-ini" lang="ini">mach_msg_return_t <span class="hljs-attr">kr</span> = mach_msg(
    &amp;exceptionMessage.header,
    MACH_RCV_MSG | MACH_RCV_LARGE,
    0,
    sizeof(exceptionMessage),
    g_exceptionPort,
    MACH_MSG_TIMEOUT_NONE,
    MACH_PORT_NULL
)<span class="hljs-comment">;</span>
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6ae5dc7535ed4d51ad9d3caab43e8d72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334480&amp;x-signature=yHdgCmOAVfmpLNNDLSStow2R7z0%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>挂起所有线程：确保状态一致性</li>
<li>标记已捕获异常：进入异步安全模式</li>
<li>激活备用处理线程</li>
<li>读取异常线程的机器状态</li>
<li>初始化堆栈游标</li>
<li>构建异常上下文
<ul>
<li>异常类型</li>
<li>机器状态</li>
<li>地址信息等</li>
<li>堆栈游标</li>
</ul>
</li>
<li>统一异常处理：不同异常类型统一处理</li>
<li>恢复线程</li>
</ul>
<p><strong>Unix 信号捕获</strong></p>
<p>作为 Mach 异常捕获的补充，也需要直接捕获 Unix 信号，确保在 Mach 异常处理失败时，仍能捕获到崩溃。Unix 信号的捕获处理涉及：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f6d860e25174edbadabe9c1bafb0d10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334480&amp;x-signature=skXpLyxNJhC%2BTEX27GcWy8BADvw%3D" alt="图片" loading="lazy"/></p>
<p>为了能够通过 Unix 信号捕获到异常，需要先安装信号处理器：</p>
<pre><code class="hljs language-ini" lang="ini">// 获取信号列表
const int* <span class="hljs-attr">fatal_signals</span> = signal_fatal_signals()<span class="hljs-comment">;</span>
// 配置信号动作
struct sigaction <span class="hljs-attr">action</span> = {{<span class="hljs-number">0</span>}}<span class="hljs-comment">;</span>
<span class="hljs-attr">action.sa_flags</span> = SA_SIGINFO | SA_ONSTACK<span class="hljs-comment">;</span>
<span class="hljs-attr">action.sa_sigaction</span> = &amp;signal_handle_signals<span class="hljs-comment">;</span>
// 安装信号处理器
sigaction(fatal_signal, &amp;action, &amp;previous_signal_handler)<span class="hljs-comment">;</span>
</code></pre>
<p>Unix 信号的产生主要有以下情况：</p>
<ul>
<li><strong>来自 Mach 异常：</strong> 如果 Mach 异常未被应用层处理，系统会将其转换为对应的 Unix 信号</li>
<li><strong>直接产生：</strong> 如调用 <code>abort()</code> 直接产生 <code>SIGABRT</code>，或 NSException/C++ 异常未捕获时产生的信号</li>
</ul>
<p>当信号产生后，系统会找到我们安装的信号处理器，并调用我们注册的信号处理函数：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">signal_handle_signals</span><span class="hljs-params">(<span class="hljs-type">int</span> sig_num, <span class="hljs-type">siginfo_t</span> *signal_info, <span class="hljs-type">void</span>* user_context)</span>
</span>{
  <span class="hljs-comment">// sig_num: 信号编码，如 SIGSEGV=11</span>
  <span class="hljs-comment">// signal_info: 信号详细信息</span>
  <span class="hljs-comment">//     - si_signo: 信号编码</span>
  <span class="hljs-comment">//     - si_code: 信号代码，如 SEGV_MAPERR</span>
  <span class="hljs-comment">//     - si_addr: 异常地址</span>
  <span class="hljs-comment">// user_context: CPU 寄存器状态</span>
}
</code></pre>
<p>后续对异常的处理，同 Mach 异常处理流程。</p>
<p><strong>注意：</strong> 并非所有异常都源于 Mach 异常。例如，NSException 未捕获时通常会调用 abort() 产生 SIGABRT 信号，这个过程不经过 Mach 异常。因此，异常监控需要同时捕获 Mach 异常、Unix 信号和运行时异常处理器。</p>
<p><strong>机器上下文堆栈</strong></p>
<p>在崩溃发生时，堆栈追踪可以帮助开发者定位问题发生的代码位置。在基于 Mach 或 Unix 信号捕获的场景，需要从 CPU 寄存器和堆栈内存中恢复完整的调用栈。核心原理：每个函数调用，都会在堆栈上创建一个堆栈帧，包含：</p>
<ul>
<li>返回地址：函数返回后继续执行的地址</li>
<li>帧指针（FP）：指向当前堆栈帧的指针</li>
<li>局部变量：函数的局部变量</li>
<li>参数：传递给函数的参数</li>
</ul>
<p>以 ARM64 架构为例，堆栈布局如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/099216b95aa4478cac47a9cd15ac3e98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334480&amp;x-signature=YtbZzRyYfPBZadWwgKPFTBEm%2BAw%3D" alt="图片" loading="lazy"/></p>
<p>为了还原崩溃发生时的调用栈，我们需要对堆栈帧进行遍历。堆栈帧遍历的核心原理是通过帧指针链向上遍历：</p>
<ol>
<li>第 1 帧：从 PC 寄存器获取当前崩溃点</li>
<li>第 2 帧：从 LR 寄存器获取调用者</li>
<li>第 3 帧及以后：通过帧指针链从堆栈内存中读取</li>
</ol>
<p>堆栈帧遍历的完整流程如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e2e5e22119d4b01a814ca6696db3e5a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334480&amp;x-signature=bz2WYghwQBfsVqw5G%2Bhjp7th4N4%3D" alt="图片" loading="lazy"/></p>
<p>在堆栈遍历过程中，有下面几个关键点需要注意：</p>
<ul>
<li>在遍历堆栈时，必须安全地访问内存，防止访问无效内存导致崩溃</li>
<li>堆栈溢出检测，防止在堆栈损坏时无限遍历</li>
<li>地址规范化，不同 CPU 架构的地址可能有特殊标记，需要规范化处理</li>
</ul>
<h3 data-id="heading-6">运行时异常捕获</h3>
<p>运行时异常包括 NSException 和 C++ 异常，通常由编程错误引起。我们需要通过设置异常处理器来捕获这些未处理的异常。</p>
<p><strong>NSException 异常捕获</strong></p>
<p>iOS 需要通过设置 <code>NSUncaughtExceptionHandler</code> 来捕获未捕获的 <code>NSException</code>。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 在设置exception handler之前，先保存之前的设置</span>
NSUncaughtExceptionHandler *previous_uncaught_exceptionhandler = <span class="hljs-built_in">NSGetUncaughtExceptionHandler</span>();
<span class="hljs-comment">// 设置我们的exception handler</span>
<span class="hljs-built_in">NSSetUncaughtExceptionHandler</span>(&amp;handle_uncaught_exception);
</code></pre>
<p>当 <code>Objective-C</code> 代码抛出异常，且未被 <code>@catch</code> 块捕获时，<code>Objective-C</code> 运行时会调用我们设置的异常处理器。在处理完 <code>NSException</code> 异常后，还需要主动调用 <code>previous_uncaught_exceptionhandler</code>，以便其他异常处理器能够正确处理异常。</p>
<p>注意：在异常监控场景中，通常需要在 handler 中收集完崩溃信息后，主动调用 <code>abort()</code> 来终止程序，确保程序不会在异常状态下继续运行。</p>
<p>在捕获到 NSException 异常之后，一般通过以下方式获取 Objective-C 的调用栈信息。</p>
<pre><code class="hljs language-ini" lang="ini">// NSException 提供了 callStackReturnAddresses
NSArray* <span class="hljs-attr">addresses</span> = [exception callStackReturnAddresses]<span class="hljs-comment">;</span>
</code></pre>
<p>通过 [NSException callStackReturnAddresses] 获取到 return address 之后，还需要进一步处理，如：过滤掉无效地址等。</p>
<p><strong>C++ 异常捕获</strong></p>
<p>通过设置 C++ terminate handler 可以捕获未处理的 C 异常。当 C 异常未被捕获时，C++ 运行时会调用 std::terminate()，我们通过拦截这个调用来捕获异常。</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 保存原始 terminate handler</span>
<span class="hljs-built_in">std</span>::terminate_handler original_terminate_handler = <span class="hljs-built_in">std</span>::get_terminate();
<span class="hljs-comment">// 设置我们的 terminate handler</span>
<span class="hljs-built_in">std</span>::set_terminate(cpp_exception_terminate_handler);
</code></pre>
<p>当 C 代码抛出异常时，throw 语句会调用 <code>__cxa_throw()</code>，C 运行时会查找匹配的 <code>catch</code> 块，如果未找到异常会继续向上传播。当异常未被捕获时：</p>
<ol>
<li>C++ 运行时会调用 <code>std::terminate()</code></li>
<li><code>std::terminate()</code> 会调用已注册的 terminate handler</li>
<li>我们设置的 <code>cpp_exception_terminate_handler</code> 会被调用</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcb389325124486098131f56af994f28~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334480&amp;x-signature=ULSbW9hGyFRtAc%2BKSLiodN0aVdk%3D" alt="图片" loading="lazy"/></p>
<p>在我们的 terminate handler 中处理完异常后，还需要调用原始的 terminate handler，以便其他异常处理器能正确处理异常。</p>
<h3 data-id="heading-7">应用层异常捕获</h3>
<p>应用层异常包括业务逻辑异常和性能问题，需要应用层主动监控和检测。主要包括主线程死锁检测和僵尸对象检测。</p>
<p><strong>主线程死锁检测</strong></p>
<p>主线程死锁（Deadlock）是 iOS 开发中一种严重的运行时问题，会导致 App 界面完全卡死（无响应），最终通常会被系统的看门狗（Watchdog）强制终止。</p>
<p>针对这类问题，一种可行的方式是通过“看门狗”机制检测主线程死锁：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6487ae311c5479ba0924a7605ce55eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334480&amp;x-signature=0n%2BwJEAMGc6wAHg5EBkWJKgwXm0%3D" alt="图片" loading="lazy"/></p>
<ol>
<li>监控线程：独立的监控线程，定期检查主线程状态</li>
<li>心跳机制：向主线程发送“心跳”任务，检查是否及时响应</li>
<li>死锁判定：如果主队列在指定时间内未响应，则判定为死锁</li>
</ol>
<p><strong>需要注意：</strong></p>
<ul>
<li>误报风险：如果主线程有长时间运行的任务，可能产生误报</li>
<li>超时时间：需要根据应用实际情况，调整超时时间，避免误报</li>
</ul>
<p><strong>僵尸对象检测</strong></p>
<p>iOS 僵尸对象（Zombie Object）是 iOS 开发中导致应用崩溃（Crash）最常见的内存问题之一。僵尸对象是指已经被释放（dealloc）的内存块，但对应的指针仍然指向这块内存，并且代码试图通过这个指针去访问它（发送消息）。访问僵尸对象可能会导致崩溃，通常表现为 <code>EXC_BAD_ACCESS</code> 崩溃。</p>
<ul>
<li>这是一个内存访问错误，意味着你试图访问一块你无法访问或无效的内存。</li>
<li>因为这块内存可能已经被系统回收并分配给了其他对象，或者变成了一块杂乱的数据区域，所以访问结果是不可预知的。</li>
</ul>
<p>产生僵尸对象的原因主要有以下几点：</p>
<ul>
<li><strong>unsafe_unretained 或 assign 指针：</strong> 如果一个属性被修饰为 assign（修饰对象时）或 unsafe_unretained，当对象被释放后，指针不会自动置为 nil（变成悬垂指针）。此时再次访问就会变成僵尸对象访问</li>
<li><strong>多线程竞争：</strong> 线程 A 刚刚释放了对象，但线程 B 几乎同时在尝试访问该对象</li>
<li><strong>CoreFoundation 与 ARC 的桥接不当：</strong> 在使用 <code>__bridge，__bridge_transfer</code> 等转换时，所有权管理混乱导致对象过早释放</li>
<li>Block 或 Delegate 循环引用：某些老旧代码中 Delegate 依然使用 assign 修饰</li>
</ul>
<p>僵尸对象检测的主要思路是：</p>
<ol>
<li>hook <code>NSObject</code> 和 <code>NSProxy</code> 的 <code>dealloc</code> 方法</li>
<li>在对象释放时，计算对象的 hash，然后记录 class 信息</li>
<li>检测是否为 NSException，如果是，则保存异常详情</li>
<li>各类异常发生时，读取保存的异常详情</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7c0d27c2c47429193d02f1d7c870287~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334480&amp;x-signature=LMI%2Bq89hqhBpfdHcBQU6d2Wjp3Y%3D" alt="图片" loading="lazy"/></p>
<ul>
<li>为了降低 CPU 和内存占用，僵尸对象的记录上限是 <code>0x8000</code> 个，即：32768</li>
<li>计算哈希时，通过 <code>((uintptr_t)object &gt;&gt; (sizeof(uintptr_t) - 1)) &amp; 0x7FFF</code> 计算</li>
</ul>
<p>这是一种设计权衡的结果。因为这种检测方式并不是非常准确，不能捕获所有僵尸对象。因为 hash 的计算会产生一定的碰撞，导致对象被覆盖，可能会产生误报或错误的类型。</p>
<h3 data-id="heading-8">运行时符号化</h3>
<p>在异常监控系统中，除了需要检测和记录异常类型（如僵尸对象访问、主线程死锁等），还需要处理异常发生时的堆栈信息。堆栈信息通常以内存地址的形式存在，这些地址对于开发者来说是不可读的。为了能够快速定位问题，我们需要将这些内存地址转换为可读的函数名、文件名和行号信息，这个过程就是符号化（Symbolication）。</p>
<p>符号化一般分为两种：</p>
<ul>
<li>运行时符号化：使用 <code>dladdr()</code> 获取符号信息（函数名、镜像名等）</li>
<li>完整符号化：使用 <code>dSYM</code> 文件获取文件名和行号</li>
</ul>
<p>运行时符号化只能获取公开符号。</p>
<p>我们主要讨论 iOS 平台上如何在运行时符号化。iOS 平台主要通过 <code>dladdr()</code> 进行运行时符号化，通过 <code>dladdr()</code> 可以获取到如下信息：</p>
<ul>
<li>imageAddress：image 镜像基址</li>
<li>imageName：image 镜像路径</li>
<li>symbolAddress：符号地址</li>
<li>symbolName：符号名称</li>
</ul>
<p>由于在符号化时，我们需要的是调用指令的地址，但堆栈上存储的是返回地址，因此需要对地址调整：</p>
<pre><code class="hljs language-scss" lang="scss">函数调用过程：
<span class="hljs-number">1</span>. 调用指令：call function_name  (地址: <span class="hljs-number">0</span>x1000)
<span class="hljs-number">2</span>. 函数执行：<span class="hljs-built_in">function_name</span>()     (地址: <span class="hljs-number">0</span>x2000)
<span class="hljs-number">3</span>. 返回地址：<span class="hljs-number">0</span>x1001              (存储在堆栈上)
堆栈上存储的是返回地址（<span class="hljs-number">0</span>x1001），
但我们需要的是调用指令的地址（<span class="hljs-number">0</span>x1000），所以需要减 <span class="hljs-number">1</span>。
</code></pre>
<p>不同 CPU 架构对应的地址调整有所不同，以 ARM64 为例：</p>
<pre><code class="hljs language-ini" lang="ini">uintptr_t <span class="hljs-attr">address</span> = (return_address &amp;~ <span class="hljs-number">3</span>UL) - <span class="hljs-number">1</span><span class="hljs-comment">;</span>
</code></pre>
<p>运行时符号化的完整流程如下图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb54f323bba147a8918aeb3f53574e3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334480&amp;x-signature=Ax3vBc8u8orTPHE5xV3Vj9O7deI%3D" alt="图片" loading="lazy"/></p>
<h3 data-id="heading-9">异步安全</h3>
<p>除了以上内容外，在处理 iOS 平台异常捕获时，我们还需要关注异步安全。</p>
<p>在 Unix 信号处理函数，或 Mach 异常处理中，只能使用异步安全函数，主要是因为：</p>
<ul>
<li>崩溃时系统状态不稳定</li>
<li>可能持有锁，调用非异步安全函数可能导致死锁</li>
<li>堆可能已损坏，此时分配内存可能会失败</li>
</ul>
<p>一般情况下，<code>malloc()</code>、<code>free()</code>、<code>NSLog()</code>、<code>printf()</code>，Objective-C 方法的调用，任何可能分配内存的函数都不允许在处理异常过程中调用。</p>
<h2 data-id="heading-10">结语和展望</h2>
<p>本文主要介绍了当下主流的 iOS 异常监控方案，和基于 KSCrash 的异常监控实现细节，包括 Mach、Unix 信号、NSException 等异常类型的捕获的处理等。异常监控能力还在持续进化，后续还有不少可以优化和提升的点，如支持实时上传和崩溃回调，支持 App 日志记录，dump 寄存器地址附近内存等。目前这套方案已经应用在阿里云用户体验监控 RUM iOS SDK 中，您可以参考接入文档 <strong>[</strong> <strong>1]</strong> 体验使用。阿里云 RUM SDK 当前也支持 Android 、 HarmonyOS 、Web 等平台下异常监控能力。相关问题可以加入“RUM用户体验监控支持群”（钉钉群号：67370002064）进行咨询。</p>
<p><strong>相关链接：</strong></p>
<p>[1] 接入文档</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Farms%2Fuser-experience-monitoring%2Fmonitor-ios-apps%2F" target="_blank" title="https://help.aliyun.com/zh/arms/user-experience-monitoring/monitor-ios-apps/" ref="nofollow noopener noreferrer">help.aliyun.com/zh/arms/use…</a></p>
<p>点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Farms%3Fspm%3Da1z389.11499242.0.0.65452413yOc5rP%26utm_content%3Dg_1000408142" target="_blank" title="https://www.aliyun.com/product/arms?spm=a1z389.11499242.0.0.65452413yOc5rP&amp;utm_content=g_1000408142" ref="nofollow noopener noreferrer">此处</a>查看产品详情。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 三元表达式（?:）的常见坑总结]]></title>    <link>https://juejin.cn/post/7587769767851851822</link>    <guid>https://juejin.cn/post/7587769767851851822</guid>    <pubDate>2025-12-26T06:12:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587769767851851822" data-draft-id="7587779957675311155" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" Java 三元表达式（?:）的常见坑总结"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-12-26T06:12:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sino爱学习"/> <meta itemprop="url" content="https://juejin.cn/user/1873223544473431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             Java 三元表达式（?:）的常见坑总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223544473431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sino爱学习
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T06:12:40.000Z" title="Fri Dec 26 2025 06:12:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">Java 三元表达式（?:）的常见坑总结</h3>
<p>Java 中的三元表达式语法：<code>condition ? expr1 : expr2</code>，看似简单，但由于类型推断、自动装箱/拆箱、优先级等机制，容易踩坑。下面总结一些最常见的坑及避免方法：</p>
<ol>
<li>
<p><strong>自动拆箱导致的 NullPointerException（最经典坑）</strong><br/>
当第二或第三操作数是包装类型（如 Boolean、Integer），且值为 null 时，会触发自动拆箱成基本类型，导致 NPE。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Boolean</span> <span class="hljs-variable">flag</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
<span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> flag ? <span class="hljs-string">"true"</span> : <span class="hljs-string">"false"</span>;  <span class="hljs-comment">// 运行时 NullPointerException</span>
</code></pre>
<p><strong>原因</strong>：三元表达式要求 expr1 和 expr2 有共同类型，Java 会尝试拆箱 Boolean → boolean，但 null 无法拆箱。<br/>
<strong>避免</strong>：显式判 null，或使用 Objects 等工具类。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> flag == <span class="hljs-literal">null</span> ? <span class="hljs-string">"default"</span> : (flag ? <span class="hljs-string">"true"</span> : <span class="hljs-string">"false"</span>);
</code></pre>
</li>
<li>
<p><strong>类型不匹配导致意外的类型提升</strong><br/>
第二和第三操作数的类型必须兼容，Java 会选择“更宽”的类型进行提升，可能导致精度丢失或意外结果。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;
<span class="hljs-type">long</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;
<span class="hljs-type">var</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span> ? a : b;  <span class="hljs-comment">// result 类型是 long，而不是 int</span>
</code></pre>
<p>另一个常见例子：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">byte</span> <span class="hljs-variable">x</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>, y = <span class="hljs-number">2</span>;
<span class="hljs-type">byte</span> <span class="hljs-variable">z</span> <span class="hljs-operator">=</span> <span class="hljs-literal">true</span> ? x : y;  <span class="hljs-comment">// 编译错误！因为提升为 int</span>
</code></pre>
<p><strong>避免</strong>：显式强转。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">byte</span> <span class="hljs-variable">z</span> <span class="hljs-operator">=</span> (<span class="hljs-type">byte</span>)(<span class="hljs-literal">true</span> ? x : y);
</code></pre>
</li>
<li>
<p><strong>返回类型是引用类型时，可能返回 null 导致后续 NPE</strong><br/>
即使条件判断没问题，如果返回 null，后续链式调用容易忘判空。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> someCondition ? obj.getA() : obj.getB();
str.toLowerCase();  <span class="hljs-comment">// 如果 getA() 或 getB() 返回 null，这里 NPE</span>
</code></pre>
<p><strong>避免</strong>：使用 Optional 或 Objects.requireNonNull 等。</p>
</li>
<li>
<p><strong>嵌套三元表达式可读性极差（维护性坑）</strong><br/>
多层嵌套容易看错逻辑顺序。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> a ? b ? <span class="hljs-string">"1"</span> : <span class="hljs-string">"2"</span> : c ? <span class="hljs-string">"3"</span> : <span class="hljs-string">"4"</span>;  <span class="hljs-comment">// 难以阅读</span>
</code></pre>
<p><strong>避免</strong>：复杂逻辑优先用 if-else，提高可读性。</p>
</li>
<li>
<p><strong>运算符优先级误解</strong><br/>
三元表达式的优先级高于赋值，但低于大多数运算符，容易和 &amp;&amp; || 等混用出错。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> flag ? <span class="hljs-literal">true</span> : a == b &amp;&amp; c &gt; d;  <span class="hljs-comment">// 容易误以为是 flag ? true : (a == b &amp;&amp; c &gt; d)</span>
<span class="hljs-comment">// 实际等价于 (flag ? true : a == b) &amp;&amp; c &gt; d</span>
</code></pre>
<p><strong>避免</strong>：必要时加括号明确意图。</p>
</li>
<li>
<p><strong>与字符串拼接混用时隐蔽 NPE</strong><br/>
常见于拼接 null 的包装类型。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Integer</span> <span class="hljs-variable">num</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
<span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">"value="</span> + (flag ? num : <span class="hljs-number">0</span>);  <span class="hljs-comment">// 如果 flag=true，会尝试拆箱 num → NPE</span>
</code></pre>
<p><strong>避免</strong>：使用 String.valueOf() 或 Objects.toString()。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> <span class="hljs-string">"value="</span> + (flag ? Objects.toString(num, <span class="hljs-string">"0"</span>) : <span class="hljs-string">"0"</span>);
</code></pre>
</li>
<li>
<p><strong>在泛型或 lambda 中类型推断问题</strong><br/>
在某些泛型场景下，三元表达式可能导致类型推断失败。</p>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; list = condition ? Arrays.asList(<span class="hljs-string">"a"</span>) : Collections.emptyList();
<span class="hljs-comment">// 可能编译错误，因为一种是 List&lt;String&gt;，另一种是 List&lt;Object&gt;</span>
</code></pre>
<p><strong>避免</strong>：统一返回类型，或显式指定泛型。</p>
</li>
</ol>
<h3 data-id="heading-1">总结建议</h3>
<ul>
<li>优先保证第二和第三操作数类型完全一致。</li>
<li>对可能为 null 的包装类型务必先判空。</li>
<li>复杂逻辑避免使用三元表达式，改用 if-else。</li>
<li>多用工具类：<code>Objects.toString(obj, "")</code>、<code>Optional.orElse()</code> 等能有效规避这些坑。</li>
</ul>
<p>掌握这些坑后，三元表达式用在简单场景下依然是优雅的写法，但切记“简单为上”。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 原生功能越来越强，我们是不是被 npm 玩坏了？]]></title>    <link>https://juejin.cn/post/7587715742051942410</link>    <guid>https://juejin.cn/post/7587715742051942410</guid>    <pubDate>2025-12-26T06:29:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587715742051942410" data-draft-id="7587704265055830054" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 原生功能越来越强，我们是不是被 npm 玩坏了？"/> <meta itemprop="keywords" content="前端,JavaScript,架构"/> <meta itemprop="datePublished" content="2025-12-26T06:29:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="狗头大军之江苏分军"/> <meta itemprop="url" content="https://juejin.cn/user/2955079655907879"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 原生功能越来越强，我们是不是被 npm 玩坏了？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2955079655907879/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    狗头大军之江苏分军
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T06:29:27.000Z" title="Fri Dec 26 2025 06:29:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这话一说出口，可能很多前端同学会立刻笑出来：“当然被玩坏了！”但咱别急着笑，我先把话摊开讲一讲。很多人每天打开项目就像进了仓库——成百上千个 <code>node_modules</code>、动辄几十来个依赖，一个功能装一堆包，结果最后项目臃肿得像个大肉包。你可能会想，“我就要用这个小功能，装个包不行吗？”当然行，可问题是，技术本来是为人服务的，不是让我们做它的奴隶。</p>
<p>前几年我们搞请求就装 <code>axios</code>、搞日期就装 <code>moment</code>、深拷贝装 <code>lodash</code>、UUID 装 <code>uuid</code>、WebSocket 装 <code>ws</code>，反正遇到点儿啥先去包管理器搜一圈。结果现在你打开 Node.js 官方文档一看，Node 自己就带了好多以前靠包才能搞定的功能：原生 <code>fetch()</code> 现在可以替代 <code>axios</code>，<code>crypto.randomUUID()</code> 可以替代 <code>uuid</code>，而 <code>fs/promises</code> 的 <code>glob()</code> 可以替代 <code>glob</code> 包了。甚至 Node 从 18 版本开始就把浏览器里的 <code>fetch()</code> API 作为全局函数支持了，这意味着你 <strong>根本不需要外部的 HTTP 请求库</strong> 来写大多数网络请求代码了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f470223a92fa49ec836ca452f2a54a04~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54uX5aS05aSn5Yab5LmL5rGf6IuP5YiG5Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767335366&amp;x-signature=joM4sVkE6q9CzP1l3VzMq68ZgYE%3D" alt="image.png" loading="lazy"/></p>
<p>这听起来是不是有点魔幻？我给你一个真实例子：<br/>
以前在一个团队里，我们项目里到处用 <code>axios</code> 做请求，因为几年前 Node 的 <code>fetch()</code> 还不稳定，也不普遍。后来团队升级 Node 到 18 以上，我们试着把请求逻辑从 <code>axios</code> 移到原生 <code>fetch()</code>。以前的代码是这样：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>;

<span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'https://api.example.com/data'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(res.<span class="hljs-property">data</span>);
</code></pre>
<p>改成原生后就变成：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">res</span> = await fetch(<span class="hljs-string">'https://api.example.com/data'</span>)<span class="hljs-comment">;</span>
const <span class="hljs-attr">data</span> = await res.json()<span class="hljs-comment">;</span>
console.log(data)<span class="hljs-comment">;</span>
</code></pre>
<p>是不是简洁得多？而且不用再去关注 <code>axios</code> 的版本升级、漏洞问题、依赖冲突啥的了。</p>
<p>再举一个例子，项目里你要生成一个 UUID，传统写法常常是这么写：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { v4 <span class="hljs-keyword">as</span> uuidv4 } <span class="hljs-keyword">from</span> <span class="hljs-string">'uuid'</span>;
<span class="hljs-keyword">const</span> id = <span class="hljs-title function_">uuidv4</span>();
</code></pre>
<p>而现在最新 Node 自带的 <code>crypto</code> 直接就能搞定：</p>
<pre><code class="hljs language-ini" lang="ini">import { randomUUID } from 'node:crypto'<span class="hljs-comment">;</span>
const <span class="hljs-attr">id</span> = randomUUID()<span class="hljs-comment">;</span>
</code></pre>
<p>结果库体积减少了，而且不再需要去更新第三方包。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d6d1842b8494da9bbf71357d6531e4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54uX5aS05aSn5Yab5LmL5rGf6IuP5YiG5Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767335366&amp;x-signature=ToYMVZBv08KdYYQJnx88hJ7NplY%3D" alt="image.png" loading="lazy"/></p>
<p>光这一点就够痛快了：<strong>别总想靠包解决一切问题，有的时候其实内置已经够用了</strong>。但问题是，社区心态还停留在从前。npm 生态太丰富，导致一个小功能前前后后会有好几个包，你看着别人用，就不自觉装上。这就造成了一个“依赖恐惧症”——别人装了，我不装好像不专业一样。</p>
<hr/>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5202b68f37aa4ed3b15ca4f4a4f934ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54uX5aS05aSn5Yab5LmL5rGf6IuP5YiG5Yab:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767335366&amp;x-signature=71zQyT%2BN9IrRRYSaAfCBwHR6AHU%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">你可能没意识到的生态债</h2>
<p>说到这里，我们再聊聊技术债。技术债不是一个专有名词，它指的就是“因为选择不够优化，后来不得不付更高代价去修复或重构”的那部分成本。在前端里，这种债往往藏在项目里无数 <code>npm install</code> 后的依赖树里。你每装一个包，就可能带来几十个依赖，这些依赖里有未更新的、有漏洞的，也有你根本用不到却被间接引入的。你可能一个月没关注它，但 GitHub 的 Dependabot 会给你提示“你的依赖又过期了”，或者 CI/CD 在某次版本升级之后突然挂掉。</p>
<p>举个我亲身经历的例子：我维护过一个大型前端项目（React + Node 服务端渲染），<code>package.json</code> 里有近 70 个依赖。深究之后发现，其中 30% 的包其实是“只用了其中一个函数”或者“早就有原生 API 可替代”的，比如用于深拷贝的 <code>lodash</code>、处理日期的 <code>moment</code>、处理 URL 参数的 <code>qs</code>。而这三者都可以用现代 JavaScript 自带的语法或 API 实现，或者替换成更轻量的库，也能显著减小打包体积、提高启动速度。</p>
<p>比如 <code>lodash</code> 的深拷贝：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> cloneDeep <span class="hljs-keyword">from</span> <span class="hljs-string">'lodash/cloneDeep'</span>;
</code></pre>
<p>现代 JS 有 <code>structuredClone</code>（浏览器和 Node.js 都支持），可以轻松替代：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">cloneObj</span> = structuredClone(originalObj)<span class="hljs-comment">;</span>
</code></pre>
<p>这段代码不仅更短，而且可读性更强、依赖更少。<a href="https://link.juejin.cn?target=https%3A%2F%2Faged-coffee.me%2Fblog%2Fmy-notes%2Fweekly-study%2F2025%2F20-2025" target="_blank" title="https://aged-coffee.me/blog/my-notes/weekly-study/2025/20-2025" ref="nofollow noopener noreferrer">AgedCoffee</a></p>
<p>又比如日期处理很多人习惯用旧时代的 <code>moment.js</code>，但它本身已经不推荐使用，因为它体积大、功能冗余，而且 JavaScript 现在有更现代的日期处理方式，比如 <code>Date.prototype.toLocaleString()</code> 和现代库 <code>date-fns</code>、<code>dayjs</code>（如果非要用库的话都比 <code>moment</code> 轻得多）。 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.c-ctrip.com%2Ffiles%2F6%2Fctriptech%2F1gw291200099iy5uyCC5B.pdf" target="_blank" title="https://docs.c-ctrip.com/files/6/ctriptech/1gw291200099iy5uyCC5B.pdf" ref="nofollow noopener noreferrer">资料来源携程技术</a></p>
<hr/>
<h2 data-id="heading-1">为什么我们还装那么多包？</h2>
<p>你可能会问，“Ok，我知道原生 API 现在很强，但为什么社区里还是大量依赖包？大家不跟进 Node 的变化吗？”这其实是一个心理层面的问题。</p>
<p>一：<strong>习惯性依赖</strong>。很多时候写代码不是为了技术最优，而是为了速度。你在 2018 年学会了 <code>axios</code>、<code>lodash</code>、<code>moment</code>，那时候它们确实是最方便的解决方案。当时好用就装，现在不卸也是习惯。技术 Debt 最大的问题往往不是技术本身，而是我们不去主动清理以前的选择。</p>
<p>二：<strong>包生态太丰富</strong>。npm 上 100 万+ 包意味着几乎每个问题都有现成的方案，但这也意味着很多包功能高度重复，选择成本高。你可能花更多时间去对比包，而不是思考“我真的需要它吗”。这导致了一个怪圈：你想着省事儿，结果反而装了更多包。</p>
<p>三：<strong>团队沟通成本</strong>。在多人项目里，有人写代码时引用了某个包，别人可能不知道这个包的替代方案，导致后来大家都默认继续使用。一旦团队形成了某一套依赖体系，想要把冗余依赖剔除就变得麻烦。</p>
<hr/>
<h2 data-id="heading-2">如何优雅地管理依赖，而不是被它们“玩坏”</h2>
<p>既然生态是大趋势，我们也没必要否定 npm 的价值。但我的经验是，你可以用一种**“最小依赖原则”**来管理你的项目：</p>
<ol>
<li><strong>先用原生</strong>：先看看 Node 或浏览器原生能不能满足需求。HTTP 请求现在就自带 <code>fetch()</code>；唯一要注意的是一些高级特性（比如请求拦截、重试逻辑）可能仍需要库辅助。</li>
<li><strong>评估替代方案</strong>：如果原生不够，再找轻量替代，而不是默认用你最熟悉的大包。比如用 <code>structuredClone()</code> 替代 <code>lodash.cloneDeep</code>，用 <code>URLSearchParams</code> 处理查询参数。</li>
<li><strong>按需引入</strong>：如果确实要用大库，尽量按需引入。例如 lodash 的单函数模块，而不是整个库。</li>
<li><strong>做好定期审查</strong>：每隔一段时间，审查项目依赖，看看哪些依赖可以清理或替换成原生方案。</li>
</ol>
<hr/>
<h2 data-id="heading-3">总结</h2>
<p>我们不是在否定 npm 或生态的价值。npm 的存在对整个 JavaScript 社区来说是革命性的，它让我们不用重复造轮子、快速构建应用。只是随着 Node.js 原生功能越来越强、浏览器标准越来越完善，很多你“习惯性”装的包已经有原生替代方案了，继续装就像背着枷锁前进一样。经过实践我发现——<strong>依赖越少，项目越轻盈，维护越省心，CI/CD 越稳定</strong>。技术债是隐性的，早清理早轻松。给项目留一条回头路，而不是越走越难走的依赖迷宫，这才是真正的前端成长。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 勇闯2D像素游戏之路（五）：像元气骑士一样的设计随机地牢]]></title>    <link>https://juejin.cn/post/7588022226739200050</link>    <guid>https://juejin.cn/post/7588022226739200050</guid>    <pubDate>2025-12-26T06:11:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588022226739200050" data-draft-id="7587264707284779018" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 勇闯2D像素游戏之路（五）：像元气骑士一样的设计随机地牢"/> <meta itemprop="keywords" content="游戏,游戏开发,Flutter"/> <meta itemprop="datePublished" content="2025-12-26T06:11:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="_大学牲"/> <meta itemprop="url" content="https://juejin.cn/user/3125273628517148"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 勇闯2D像素游戏之路（五）：像元气骑士一样的设计随机地牢
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3125273628517148/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    _大学牲
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T06:11:01.000Z" title="Fri Dec 26 2025 06:11:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/648d895549d64c90b97d7542ca8df125~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334355&amp;x-signature=U7stMbVeID%2BIgFi9lrNQ%2BNRxetA%3D" width="100%" loading="lazy"/></p><p/>
<p><a href="https://juejin.cn/post/7579264485259411471" target="_blank" title="https://juejin.cn/post/7579264485259411471">Flutter 勇闯2D像素游戏之路（一）：一个 Hero 的诞生</a><br/>
<a href="https://juejin.cn/post/7581025279646892070" target="_blank" title="https://juejin.cn/post/7581025279646892070">Flutter 勇闯2D像素游戏之路（二）：绘制加载游戏地图</a><br/>
<a href="https://juejin.cn/post/7584014975242911754" target="_blank" title="https://juejin.cn/post/7584014975242911754">Flutter 勇闯2D像素游戏之路（三）：人物与地图元素的交互</a><br/>
<a href="https://juejin.cn/post/7585463258691125257" target="_blank" title="https://juejin.cn/post/7585463258691125257">Flutter 勇闯2D像素游戏之路（四）：与哥布林战斗的滑步魔法师</a><br/>
<a href="https://juejin.cn/post/7588022226739200050" target="_blank" title="https://juejin.cn/post/7588022226739200050">Flutter 勇闯2D像素游戏之路（五）：像元气骑士一样的设计随机地牢</a></p>
<h2 data-id="heading-0">前言</h2>
<p>在前几篇文章中，我们已经完成了一个 <strong>2D 像素游戏</strong> 的基础骨架：<br/>
从 <strong>角色的创建与动画切换，到地图绘制、人物交互，再到基础战斗逻辑</strong>，一个 <code>能玩起来</code> 的 Demo 已经初具雏形。</p>
<p>但很快，一个问题就会浮现出来：</p>
<blockquote>
<p><strong>如果地图永远只有一张，那这个游戏还能玩多久？</strong></p>
</blockquote>
<p>在实际游戏中，无论是 <strong>关卡制</strong> 还是 <strong>肉鸽（Roguelike）玩法</strong>，<br/>
<strong>地图的切换、组合与随机性</strong>，几乎都是不可或缺的。</p>
<p>因此，从这一章开始，我们不再只关注 <code>如何画一张地图</code>，而是正式引入 <strong>关卡管理、地图切换、随机地牢生成</strong> 等更贴近实际游戏开发的系统设计。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0797109b17ed48a6b58974e8d3ba2f98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334355&amp;x-signature=r33uFI7vKDdLwxZuKD0ewNOcH1Q%3D" width="100%" loading="lazy"/></p><p/>
<p>本章将以一款成熟的 <strong>肉鸽游戏</strong> <code>元气骑士</code> 的地牢设计为方向，并围绕以下几个关键问题展开：</p>
<ul>
<li>如何将 <strong>地图加载逻辑</strong> 从 <code>MyGame</code> 中解耦，构建一个统一的关卡加载器？</li>
<li>如何通过 <strong>模块化房间 + 算法布局</strong>，生成可复用、可扩展的随机地牢？</li>
<li>当地图变得复杂之后，如何设计一个 <strong>小地图（Minimap）系统</strong>，帮助玩家 <strong>可视化</strong> 当前地牢结构？</li>
</ul>
<p>通过这一章，你将看到一个从 <code>单一静态地图 -&gt; 可切换、可随机、可视化探索的地图</code> 的完整过程。</p>
<blockquote>
<p>如果说前几篇是在 <strong>搭地基</strong>。<br/>
那么从这一篇开始，我将逐步搭建一个 <strong>可反复游玩的游戏世界</strong>。</p>
</blockquote>
<h2 data-id="heading-1">MyHero</h2>
<h3 data-id="heading-2">一. 本章目标</h3>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cb904be968a45448255749ec02af820~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334355&amp;x-signature=ffd01qvUrwpQu54pcmdAhDL7GyM%3D" width="100%" loading="lazy"/>
<h3 data-id="heading-3">二. 统一关卡加载器</h3>
<h4 data-id="heading-4">1. 分析</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da25b179516248f59472b8067bd909f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334355&amp;x-signature=%2BqJBvTgmt%2BEz4lHpfn%2BH3u%2FmHTU%3D" alt="地牢.png" loading="lazy"/></p>
<pre><code class="hljs language-dart" lang="dart">Future&lt;<span class="hljs-keyword">void</span>&gt; _loadLevel() <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// 1. 加载地图</span>
    <span class="hljs-keyword">final</span> realTileSize = mapScale * tileSize;
    <span class="hljs-keyword">final</span> tiled = <span class="hljs-keyword">await</span> TiledComponent.load(
      <span class="hljs-string">'地牢.tmx'</span>,
      Vector2.all(realTileSize),
    );
    world.add(tiled);

    <span class="hljs-comment">// ---- 处理 thorn 中的荆棘 ----</span>
    <span class="hljs-keyword">final</span> thornLayer = tiled.tileMap.getLayer&lt;ObjectGroup&gt;(<span class="hljs-string">'thorn'</span>);
    ...
    <span class="hljs-comment">// ---- 处理 Key Layer 中的钥匙 ----</span>
    <span class="hljs-keyword">final</span> keyLayer = tiled.tileMap.getLayer&lt;ObjectGroup&gt;(<span class="hljs-string">'key'</span>);
    ...
    <span class="hljs-comment">// ---- 处理 treasure Layer 中的宝箱 ----</span>
    <span class="hljs-keyword">final</span> treasureLayer = tiled.tileMap.getLayer&lt;ObjectGroup&gt;(<span class="hljs-string">'treasure'</span>);
    ...
    <span class="hljs-comment">// ---- 处理 Door Layer 中的门 ----</span>
    <span class="hljs-keyword">final</span> doorLayer = tiled.tileMap.getLayer&lt;ObjectGroup&gt;(<span class="hljs-string">'door'</span>);
    ...
    <span class="hljs-comment">// ---- 处理 water 碰撞区 ----</span>
    <span class="hljs-keyword">final</span> waterLayer = tiled.tileMap.getLayer&lt;TileLayer&gt;(<span class="hljs-string">'water'</span>);
    ...
    <span class="hljs-comment">// ---- 处理 wall 碰撞 ----</span>
    <span class="hljs-keyword">final</span> wallLayer = tiled.tileMap.getLayer&lt;TileLayer&gt;(<span class="hljs-string">'wall'</span>);
    ...
    <span class="hljs-comment">// ---- 处理 spawn_points 中的怪物和终点 ----</span>
    <span class="hljs-keyword">final</span> spawnLayer = tiled.tileMap.getLayer&lt;ObjectGroup&gt;(<span class="hljs-string">'spawn_points'</span>);
    ...
    
    <span class="hljs-comment">// 2. 创建摇杆</span>
    ...

    <span class="hljs-comment">// 3. 创建英雄</span>
    ...

    <span class="hljs-comment">// 4. 添加进入场景</span>
    ...

    <span class="hljs-comment">// 5. 添加 人物信息 HUD</span>
    ...

    <span class="hljs-comment">// 6. 添加 攻击 HUD</span>
    ...

    <span class="hljs-comment">// ---- Camera ----</span>
    camera.setBounds(Rectangle.fromLTRB(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, tiled.size.x, tiled.size.y));
    camera.follow(hero);
</code></pre>
<p>当前游戏中，仅在 <code>my_game.dart</code> 中通过一个 <code>_loadLevel</code> 方法对地图进行 <strong>硬编码加载</strong>。<br/>
这种方式，在我们 <strong>早期开发</strong> 勉强够用，但随着功能的逐渐增长，问题就出来了：</p>
<ul>
<li><strong>地图加载写死</strong>：难以支持多关卡切换、随机地图等玩法需求</li>
<li><strong>高度耦合在游戏入口中</strong>：导致入口类职责混乱，同时承担了游戏循环、资源加载和关卡管理的 <strong>多重职责</strong></li>
<li><strong>缺乏统一的关卡加载器</strong>：地图、角色、敌人和相机初始化逻辑混杂在一起，后期维护和扩展成本较高</li>
</ul>
<p>因此，我们必须将 <strong>关卡加载</strong> 和 <strong>未来的切换逻辑</strong> 从 <code>MyGame</code> 中抽离，引入独立的关卡管理层，以降低耦合度并提升扩展性。</p>
<h4 data-id="heading-5">2. 实现</h4>
<h5 data-id="heading-6">（1) 新建 <code>LevelLoader</code> 关卡加载器</h5>
<p><code>LevelLoader</code> 负责加载和管理游戏关卡，包括：</p>
<ul>
<li>加载 <code>Tiled</code> 地图文件</li>
<li>解析地图中的各种 <strong>图层与对象（墙壁、门、钥匙、宝箱、怪物生成点等）</strong></li>
<li><strong>清除</strong> 旧的地图内容</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">LevelLoader</span> </span>{
  <span class="hljs-keyword">final</span> MyGame game;
  Vector2? heroBirthPoint;
  
  LevelLoader(<span class="hljs-keyword">this</span>.game);

  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">double</span> mapScale = MyGame.mapScale;
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">double</span> tileSize = MyGame.tileSize;
  
  ...
}
</code></pre>
<h5 data-id="heading-7">（1）加载 <code>Tiled</code> 地图文件</h5>
<pre><code class="hljs language-dart" lang="dart">    <span class="hljs-comment">// ---------- 加载地图 ----------</span>
    <span class="hljs-keyword">final</span> realTileSize = mapScale * tileSize;
    <span class="hljs-keyword">var</span> effectiveMap = mapName;

    <span class="hljs-keyword">final</span> tiled = <span class="hljs-keyword">await</span> TiledComponent.load(
      effectiveMap,
      Vector2.all(realTileSize),
</code></pre>
<h5 data-id="heading-8">（2）解析地图中的图层与对象</h5>
<p>我们创建了 <code>_loadMapContent</code> 方法，用于解析 <strong>Tiled</strong> 地图中的各个 <strong>图层和对象</strong>，并创建对应的游戏组件。</p>
<ul>
<li><strong>Tiled</strong>：地图组件</li>
<li><strong>offset</strong>：地图在世界坐标系中的偏移量</li>
<li><strong>angle</strong>：地图旋转角度（用于走廊等）</li>
</ul>
<pre><code class="hljs language-dart" lang="dart">  Future&lt;<span class="hljs-keyword">void</span>&gt; _loadMapContent(
    TiledComponent tiled,
    Vector2 offset, {
    <span class="hljs-built_in">double</span> angle = <span class="hljs-number">0</span>,
    <span class="hljs-built_in">Set</span>&lt;<span class="hljs-built_in">String</span>&gt;? openings,
  }) <span class="hljs-keyword">async</span> {
    <span class="hljs-comment">// ---------- 1. thorn ----------</span>
    _loadThorn(tiled, offset, angle);

    <span class="hljs-comment">// ---------- 2. key ----------</span>
    _loadKey(tiled, offset, angle);

    <span class="hljs-comment">// ---------- 3. treasure ----------</span>
    _loadTreasure(tiled, offset, angle);

    <span class="hljs-comment">// ---------- 4. door ----------</span>
    _loadDoor(tiled, offset, angle, openings);

    <span class="hljs-comment">// ---------- 5. water ----------</span>
    _loadWater(tiled, offset, angle);

    <span class="hljs-comment">// ---------- 6. wall ----------</span>
    _loadWall(tiled, offset, angle);

    <span class="hljs-comment">// ---------- 7. collisions ----------</span>
    _loadCollisions(tiled, offset, angle);

    <span class="hljs-comment">// ---------- 8. spawn / portal ----------</span>
    _loadSpawnPoints(tiled, offset, angle);
  }
</code></pre>
<h5 data-id="heading-9">（3）清除旧的地图内容</h5>
<p>我们创建了 <code>_clearCurrentLevel</code> 方法，用于 <strong>清除旧地图</strong> 中的各个图层和对象，为 <strong>加载新地图</strong> 做好准备。</p>
<ul>
<li><strong>清除缓存的碰撞组件 <code>blockers</code></strong></li>
<li><strong>遍历清除所有图层和对象</strong></li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> _clearCurrentLevel() {
    game.blockers.clear();
    <span class="hljs-keyword">final</span> children = <span class="hljs-built_in">List</span>&lt;Component&gt;.from(game.world.children);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> c <span class="hljs-keyword">in</span> children) {
      <span class="hljs-keyword">if</span> (c <span class="hljs-keyword">is</span> TiledComponent ||
          c <span class="hljs-keyword">is</span> WaterComponent ||
          c <span class="hljs-keyword">is</span> WallComponent ||
          c <span class="hljs-keyword">is</span> ThornComponent ||
          c <span class="hljs-keyword">is</span> KeyComponent ||
          c <span class="hljs-keyword">is</span> TreasureComponent ||
          c <span class="hljs-keyword">is</span> DoorComponent ||
          c <span class="hljs-keyword">is</span> SpawnPointComponent ||
          c <span class="hljs-keyword">is</span> PortalComponent) {
        c.removeFromParent();
      }
    }
  }
</code></pre>
<h3 data-id="heading-10">三. 地图切换</h3>
<h4 data-id="heading-11">1. 绘制 <code>home</code> 地图</h4>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd843273e22546e3831fa05681a0be93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334355&amp;x-signature=Ctdeeat6iuJRm16DISWxkAj5Q94%3D" width="100%" loading="lazy"/>
<p>玩过 <strong>类似游戏</strong> 的大家肯定都知道，想要切换地图的前提，就是有 <strong>多个地图</strong>。<br/>
因此，我们也效仿一下上述图片，打造一个 <code>home</code> 地图，作为一个 <strong>地图切换的中枢点</strong>。<br/>
那么 <code>home</code> 地图，与我们之前绘制的并无区别，值得关注的，就只有两个点：</p>
<ul>
<li><code>出生点</code>：用于指定人物在该房间的 <strong>出生位置</strong>
<ul>
<li><strong>type：birthPoint</strong></li>
</ul>
</li>
<li><code>传送门</code>：用于指定 <strong>传送门</strong> 指向的地图
<ul>
<li><strong>type：portal</strong></li>
<li><strong>mapId：xxx.tmx</strong> （目标地图全称）</li>
</ul>
</li>
</ul>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad50bf9ebb254c7fa1b9e6b9048b9f90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334355&amp;x-signature=nluMtpfzbnxEoLmZw9e76Zr8p80%3D" width="100%" loading="lazy"/>
<h4 data-id="heading-12">2. 传送门组件 <code>PortalComponent</code></h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80e6118c657e4d269d7e35dcb0a0787d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334355&amp;x-signature=3FNZEEcp%2BrHjQl3k3UbKDgrZppA%3D" alt="eb556d23e4f04cdf96bdb51a626618c9.gif" loading="lazy"/></p>
<ul>
<li><strong>加载传送门精灵图</strong>：</li>
</ul>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">final</span> image = <span class="hljs-keyword">await</span> game.images.load(<span class="hljs-string">'portal.png'</span>);
    <span class="hljs-keyword">final</span> sheet = SpriteSheet(image: image, srcSize: Vector2(<span class="hljs-number">282</span>, <span class="hljs-number">282</span>));
    animation = sheet.createAnimation(
      row: <span class="hljs-number">0</span>,
      stepTime: <span class="hljs-number">0.12</span>,
      from: <span class="hljs-number">0</span>,
      to: <span class="hljs-number">14</span>,
      loop: <span class="hljs-keyword">true</span>,
    );
</code></pre>
<ul>
<li><strong>添加碰撞区</strong>：</li>
</ul>
<pre><code class="hljs language-dart" lang="dart">add(RectangleHitbox());
</code></pre>
<ul>
<li><strong>碰撞回调触发传送</strong>：</li>
</ul>
<pre><code class="hljs language-dart" lang="dart">    AudioManager.playWhistle();
    UiNotify.showToast(game, <span class="hljs-string">'传送中...'</span>);
    game.levelLoader.load(mapId).then((_) {
        <span class="hljs-keyword">final</span> bp = game.levelLoader.heroBirthPoint;
        <span class="hljs-keyword">if</span> (bp != <span class="hljs-keyword">null</span>) {
          game.hero.position = bp;
        }
    });
</code></pre>
<h4 data-id="heading-13">3. 效果展示</h4>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d077314c2d441c799d71483e6ff4698~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334355&amp;x-signature=KhUFgFzKT9P816CtNm81UKXgscA%3D" width="100%" loading="lazy"/>
<h3 data-id="heading-14">四. 随机地牢生成</h3>
<h4 data-id="heading-15">1. 分析</h4>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23e80f9a5b034e74934ac4da2e773397~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334355&amp;x-signature=KzeJ2FF%2FymsPL4TFDidNwPZ4VII%3D" width="100%" loading="lazy"/>
<p>对于 <strong>随机地牢</strong>，<code>元气骑士</code> 可以说是一个成熟的范本 。<br/>
在对其 <strong>地牢结构</strong> 进行分析后不难发现，地牢的随机性并不是 <strong>完全随机</strong>，而是建立在 <strong>模块化的房间</strong> 之上。</p>
<p>细细分析之后，可以总结出几个关键特征：</p>
<ul>
<li>
<p><strong>地牢中的每一个房间本质上都是可复用的 <code>模块</code></strong><br/>
从功能上，我将这些房间大致归类为：</p>
<ul>
<li>开始房间（Start Room）</li>
<li>小怪房间（Battle Room）</li>
<li>宝箱房间（Treasure Room）</li>
<li>商店房间（Shop Room）</li>
<li>Boss 房间（Boss Room）</li>
</ul>
</li>
<li>
<p><strong>每个房间并不直接相连，而是通过 <code>走廊</code> 进行解耦连接</strong><br/>
走廊在结构上承担了 <strong>连接器</strong> 的角色，使房间之间，既可以保持独立，也可以通过特定方式连接。</p>
</li>
<li>
<p><strong>随机地牢的核心，在于房间的 <code>排列方式</code> 的随机</strong><br/>
只要确定了房间的 <strong>类型、数量以及它们之间的连接关系</strong>，就可以通过算法在每次运行时 <strong>动态生成</strong> 不一样的地牢。</p>
</li>
</ul>
<p>基于这个思路，随机地牢的本质可以抽象为：</p>
<blockquote>
<p><strong>随机地牢 = 有限房间模板 + 固定连接规则 + 随机布局算法</strong></p>
</blockquote>
<h4 data-id="heading-16">2. 准备</h4>
<p>有了思路之后，就在 <code>Tiled</code> 中，创建如下主要几种类型的 <strong>房间</strong> 和连接的 <strong>走廊</strong>：</p>
<ul>
<li><strong>room_start.tmx</strong></li>
<li><strong>room_boss.tmx</strong></li>
<li><strong>room_battle.tmx</strong></li>
<li><strong>room_shop.tmx</strong></li>
<li><strong>room_treasure.tmx</strong></li>
<li><strong>hallway.tmx</strong></li>
</ul>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60a7aacc1fb643ca8e8498e43e87ed4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334355&amp;x-signature=Nb1xOPE8WvH6k1qVxBt%2BRWr2xVQ%3D" width="32%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41b5daef838c420a97f40dea1a093c2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334355&amp;x-signature=3K%2FeAKJGQfXLOEslZyWZatlSNKQ%3D" width="32%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8ea03e71a1b431aa2e92d95f6467fc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334355&amp;x-signature=xD4C54DbUHcgn3PZaSQprmgibHA%3D" width="32%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f78b359d6574f3fa826526234ccc6ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334355&amp;x-signature=Ks5Ga4FpEd8Qor11m3EypcFA26U%3D" width="32%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/82754f7cb8cf4882bd662fbaf4a87d62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334355&amp;x-signature=Iu9Tw4XyHIpGadPstGSrbauDvJA%3D" width="32%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80b985d881ed4248adbb56e090396375~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334355&amp;x-signature=4UG2GQ5ehIcibxuMvQRr0GKdRT0%3D" width="32%" height="235" loading="lazy"/>
<blockquote>
<p>每个房间都在 上下左右四个面的中间开了相同长度的开口，用来当作门，走廊的连接口大小也与房间开口保持一致</p>
</blockquote>
<h4 data-id="heading-17">3. 实现</h4>
<h5 data-id="heading-18">(1) 扫描房间地图</h5>
<p>随机地牢的第一步，并不是生成算法本身，而是<strong>确定可用的房间素材集合</strong>。<br/>
通过扫描 <code>assets/tiles/</code> 目录中符合 <code>room_*.tmx</code> 命名规范的地图文件，系统在运行时动态获取所有可用房间模板。</p>
<pre><code class="hljs language-dart" lang="dart">...

<span class="hljs-keyword">final</span> manifestContent = <span class="hljs-keyword">await</span> rootBundle.loadString(<span class="hljs-string">'AssetManifest.json'</span>);
<span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; manifest = json.decode(manifestContent);

<span class="hljs-keyword">return</span> manifest.keys
  .where(
    (<span class="hljs-built_in">String</span> key) =&gt;
        key.contains(<span class="hljs-string">'assets/tiles/'</span>) &amp;&amp;
        key.split(<span class="hljs-string">'/'</span>).last.startsWith(<span class="hljs-string">'room_'</span>) &amp;&amp;
        key.endsWith(<span class="hljs-string">'.tmx'</span>),
  ).toList();
  
...
</code></pre>
<h5 data-id="heading-19">(2) 分类房间类型</h5>
<p>在获取全部房间地图后，根据文件命名约定将房间划分为 <strong>不同功能类型</strong>：</p>
<ul>
<li><strong>起始房间（start）</strong></li>
<li><strong>Boss 房间（boss）</strong></li>
<li><strong>宝箱房间（treasure）</strong></li>
<li><strong>商店房间（shop）</strong></li>
<li><strong>战斗房间（battle）</strong></li>
</ul>
<p>同时，在这一阶段确定本次地牢的 <strong>目标房间数量</strong>，并初始化用于后续生成的 <strong>网格与连接关系数据结构</strong>。</p>
<pre><code class="hljs language-dart" lang="dart">    <span class="hljs-built_in">String?</span> startMap = mapFiles.firstWhere(...);
    <span class="hljs-built_in">String?</span> bossMap = mapFiles.firstWhere(...);
    <span class="hljs-built_in">String?</span> treasureMap = mapFiles.firstWhere(...);
    <span class="hljs-built_in">String?</span> shopMap = mapFiles.firstWhere(...);
    <span class="hljs-built_in">String?</span> battleMap = mapFiles.firstWhere(...);

    <span class="hljs-built_in">List</span>&lt;<span class="hljs-built_in">String</span>&gt; battleMaps = mapFiles
        .where(...)
        .toList();

    <span class="hljs-keyword">if</span> (battleMaps.isEmpty) middleMaps = [startMap];
    
    <span class="hljs-comment">// MIN..MAX 个房间</span>
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> targetRooms = MIN_ROOMS + random.nextInt(MAX_ROOMS - MIN_ROOMS + <span class="hljs-number">1</span>); 
    
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;math.Point&lt;<span class="hljs-built_in">int</span>&gt;, <span class="hljs-built_in">String</span>&gt; grid = {};
    <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;Connection&gt; connections = [];
</code></pre>
<h5 data-id="heading-20">(3) 放置起始房间并生成基础布局</h5>
<p>地牢布局被限制在一个 <strong>3×3 的逻辑网格</strong>内。<br/>
<strong>起始房间</strong> 首先被随机放置在网格中的任意位置，随后以该点为起点，通过 <code>生长</code> 的方式逐步扩展：</p>
<ul>
<li>每次从已有房间中随机选一个作为生长中心</li>
<li>随机尝试向上下左右扩展</li>
<li>只允许在 3×3 边界内生成新房间</li>
<li>同时记录房间之间的连接关系</li>
</ul>
<p>这样就确保了：</p>
<ul>
<li>地牢整体 <strong>规模可控</strong></li>
<li>房间分布具有 <strong>随机性</strong></li>
<li>布局始终连通，不会产生 <strong>孤立</strong> 房间</li>
</ul>
<pre><code class="hljs language-dart" lang="dart">    <span class="hljs-comment">// 放置起始房间 (随机位置)</span>
    <span class="hljs-built_in">int</span> startX = random.nextInt(GRID_COLS);
    <span class="hljs-built_in">int</span> startY = random.nextInt(GRID_ROWS);
    math.Point&lt;<span class="hljs-built_in">int</span>&gt; startPos = math.Point(startX, startY);
    grid[startPos] = startMap;

    <span class="hljs-built_in">List</span>&lt;math.Point&lt;<span class="hljs-built_in">int</span>&gt;&gt; frontier = [startPos];

    <span class="hljs-comment">// 生长 (限制在 3x3 网格内)</span>
    <span class="hljs-keyword">while</span> (grid.length &lt; targetRooms &amp;&amp; frontier.isNotEmpty) {
      <span class="hljs-keyword">final</span> index = random.nextInt(frontier.length);
      <span class="hljs-keyword">final</span> center = frontier[index];

      <span class="hljs-keyword">final</span> directions = [
        <span class="hljs-keyword">const</span> math.Point(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>),
        <span class="hljs-keyword">const</span> math.Point(<span class="hljs-number">0</span>, <span class="hljs-number">-1</span>),
        <span class="hljs-keyword">const</span> math.Point(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>),
        <span class="hljs-keyword">const</span> math.Point(<span class="hljs-number">-1</span>, <span class="hljs-number">0</span>),
      ]..shuffle(random);

      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> dir <span class="hljs-keyword">in</span> directions) {
        <span class="hljs-keyword">final</span> neighbor = math.Point(center.x + dir.x, center.y + dir.y);

        <span class="hljs-keyword">if</span> (neighbor.x &gt;= <span class="hljs-number">0</span> &amp;&amp;
            neighbor.x &lt; GRID_COLS &amp;&amp;
            neighbor.y &gt;= <span class="hljs-number">0</span> &amp;&amp;
            neighbor.y &lt; GRID_ROWS) {
          <span class="hljs-keyword">if</span> (!grid.containsKey(neighbor)) {
            grid[neighbor] = <span class="hljs-string">'temp'</span>;
            connections.add(Connection(center, neighbor));
            frontier.add(neighbor);
            <span class="hljs-keyword">break</span>;
          }
        }
      }
    }
</code></pre>
<h5 data-id="heading-21">(4) 确定 Boss 房间位置</h5>
<p>在基础布局生成完成后，通过一次 <strong>BFS（广度优先搜索）</strong>，计算每个房间到起始房间的最短距离。</p>
<p>这样就可以让距离最远的房间，被选为 <code>Boss 房间</code>，从而形成 <strong>由易到难</strong> 的关卡节奏，避免 <strong>Boss</strong> 出现在 <strong>开始位置附近</strong> 的尴尬位置。</p>
<pre><code class="hljs language-dart" lang="dart">    math.Point&lt;<span class="hljs-built_in">int</span>&gt; bossPos = startPos;
    <span class="hljs-built_in">double</span> maxDist = <span class="hljs-number">-1</span>;

    <span class="hljs-built_in">Map</span>&lt;math.Point&lt;<span class="hljs-built_in">int</span>&gt;, <span class="hljs-built_in">int</span>&gt; distances = {startPos: <span class="hljs-number">0</span>};
    <span class="hljs-built_in">List</span>&lt;math.Point&lt;<span class="hljs-built_in">int</span>&gt;&gt; queue = [startPos];

    <span class="hljs-keyword">while</span> (queue.isNotEmpty) {
      <span class="hljs-keyword">final</span> current = queue.removeAt(<span class="hljs-number">0</span>);
      <span class="hljs-keyword">final</span> currentDist = distances[current]!;

      <span class="hljs-keyword">if</span> (currentDist &gt; maxDist) {
        maxDist = currentDist.toDouble();
        bossPos = current;
      }

      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> conn <span class="hljs-keyword">in</span> connections) {
        <span class="hljs-keyword">if</span> (conn.from == current &amp;&amp; !distances.containsKey(conn.to)) {
          distances[conn.to] = currentDist + <span class="hljs-number">1</span>;
          queue.add(conn.to);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (conn.to == current &amp;&amp; !distances.containsKey(conn.from)) {
          distances[conn.from] = currentDist + <span class="hljs-number">1</span>;
          queue.add(conn.from);
        }
      }
    }
</code></pre>
<h5 data-id="heading-22">(5) 分配其余房间类型</h5>
<p>除了 <strong>起始房间与 Boss 房间</strong> 外，其余房间按一定的 <code>随机规则</code> 依次分配：</p>
<ul>
<li>优先保证至少 <code>3</code> 个 <strong>战斗房间</strong></li>
<li>随机放置 <strong>宝箱房和商店房</strong></li>
<li>剩余房间也填充为 <strong>战斗房间</strong></li>
<li>将生成过程中标记为临时占位的房间统一替换为正式房间类型</li>
</ul>
<pre><code class="hljs language-dart" lang="dart">    <span class="hljs-comment">// 确保至少有 3 个战斗房间 (如果空间允许)</span>
    <span class="hljs-keyword">if</span> (available.isNotEmpty &amp;&amp; battleMap != <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> need = math.min(<span class="hljs-number">3</span>, available.length);
      <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; need; i++) {
        ...
      }
    }

    <span class="hljs-comment">// 放置宝箱房</span>
    ...

    <span class="hljs-comment">// 放置商店房</span>
    ...

    <span class="hljs-comment">// 填充剩余房间</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> p <span class="hljs-keyword">in</span> available) {
      grid[p] = battleMaps[random.nextInt(battleMaps.length)];
    }

    <span class="hljs-comment">// 替换所有临时标记</span>
    grid.forEach((key, value) {
      <span class="hljs-keyword">if</span> (value == <span class="hljs-string">'temp'</span>) {
        grid[key] = battleMaps[random.nextInt(battleMaps.length)];
      }
    });
</code></pre>
<h5 data-id="heading-23">(6) 计算整体地图边界</h5>
<p>为了让 <strong>相机边界</strong> 和下文中的 <strong>小地图</strong> 显示保持稳定，地图尺寸固定使用完整的  <strong>3×3 网格尺寸</strong> 进行计算。</p>
<p>这样可以避免：</p>
<ul>
<li>不同地牢尺寸导致的小地图抖动</li>
<li>相机边界频繁变化带来的体验问题</li>
</ul>
<p>房间在世界坐标中的实际位置，则统一通过 <code>getRoomPos</code> 进行换算。</p>
<pre><code class="hljs language-dart" lang="dart">    Vector2 getRoomPos(math.Point&lt;<span class="hljs-built_in">int</span>&gt; p) {
      <span class="hljs-keyword">return</span> Vector2(p.x * step, p.y * step);
    }
</code></pre>
<h5 data-id="heading-24">(7) 计算每个房间的开口方向</h5>
<p>根据房间之间的连接关系，计算每个房间的 <strong>开口方向集合</strong>：</p>
<ul>
<li>上 / 下 / 左 / 右</li>
<li>每一条连接会同时影响两个房间的开口</li>
</ul>
<pre><code class="hljs language-dart" lang="dart">    <span class="hljs-keyword">final</span> <span class="hljs-built_in">Map</span>&lt;math.Point&lt;<span class="hljs-built_in">int</span>&gt;, <span class="hljs-built_in">Set</span>&lt;<span class="hljs-built_in">String</span>&gt;&gt; roomOpenings = {};
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> p <span class="hljs-keyword">in</span> grid.keys) {
      roomOpenings[p] = &lt;<span class="hljs-built_in">String</span>&gt;{};
    }
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> conn <span class="hljs-keyword">in</span> connections) {
      <span class="hljs-keyword">final</span> p1 = conn.from;
      <span class="hljs-keyword">final</span> p2 = conn.to;
      <span class="hljs-keyword">final</span> dx = p2.x - p1.x;
      <span class="hljs-keyword">final</span> dy = p2.y - p1.y;
      <span class="hljs-keyword">if</span> (dx == <span class="hljs-number">1</span>) {
        roomOpenings[p1]!.add(<span class="hljs-string">'right'</span>);
        roomOpenings[p2]!.add(<span class="hljs-string">'left'</span>);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dx == <span class="hljs-number">-1</span>) {
        roomOpenings[p1]!.add(<span class="hljs-string">'left'</span>);
        roomOpenings[p2]!.add(<span class="hljs-string">'right'</span>);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dy == <span class="hljs-number">1</span>) {
        roomOpenings[p1]!.add(<span class="hljs-string">'down'</span>);
        roomOpenings[p2]!.add(<span class="hljs-string">'up'</span>);
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dy == <span class="hljs-number">-1</span>) {
        roomOpenings[p1]!.add(<span class="hljs-string">'up'</span>);
        roomOpenings[p2]!.add(<span class="hljs-string">'down'</span>);
      }
    }
</code></pre>
<blockquote>
<p>⚠️ <strong>注意</strong>： <img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/427a087bc1e64a49aca0508659842ca8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334355&amp;x-signature=EcL7qkT49vgcll5IWohdgo8jWQI%3D" width="100%" loading="lazy"/>
未使用的 <strong>多余开口</strong> 如果不处理，就会成为上述图片那样：上下两个 <strong>没用的门</strong> 也被绘制出来了。<br/>
因此，我们需要将开口集合传入 <strong>生成门的函数 <code>_loadDoor</code> 中</strong> 进行判断是否包含：</p>
<ul>
<li>包含，绘制为门</li>
<li>不包含，绘制为墙</li>
</ul>
</blockquote>
<h5 data-id="heading-25">(8) 加载房间地图</h5>
<p>在 <strong>布局、房间类型和开口方向</strong> 全部确定之后，我们就可以正式实例化房间：</p>
<ul>
<li>加载对应的 <code>.tmx</code> 地图</li>
<li>根据网格坐标计算世界位置</li>
<li>将开口信息附加到房间片段中</li>
<li>统一加入到 <code>segments</code> 集合</li>
</ul>
<p>至此，房间本身已然构建完成，但相互之间仍然是 <strong>独立</strong> 的。</p>
<h5 data-id="heading-26">(9) 生成走廊并连接房间</h5>
<p>接下来，就是最后一步了，根据房间之间的 <strong>连接关系</strong> 生成 <strong>走廊</strong>：</p>
<ul>
<li><strong>垂直连接</strong>：在上下房间之间生成水平居中的走廊</li>
<li><strong>水平连接</strong>：在左右房间之间生成走廊，并对走廊地图进行 90° 旋转</li>
</ul>
<p>通过 <code>房间 + 走廊</code> 的组合方式，将 <strong>独立房间</strong> 拼接成一个 <strong>完整、连通的地牢</strong>。</p>
<h4 data-id="heading-27">4. 流程图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
  A[combine] --&gt; B[扫描房间地图 room_*.tmx]
  B --&gt;|无可用地图| X[返回空 CombinedMap]
  B --&gt; C[确认房间类型]

  C --&gt; D[随机生成3x3房间网格+连接关系]
  D --&gt; E1[设置起始房间位置]
  D --&gt; E2[按距离选择 Boss 房]
  D --&gt; E3[分配其他房间类型]
 
  E1 --&gt; F[计算整体地图边界]
  E2 --&gt; F[计算整体地图边界]
  E3 --&gt; F[计算整体地图边界]
  F --&gt; G[根据连接关系 计算每个房间的开口方向]

  G --&gt; H[加载房间地图 放置到世界坐标]
  H --&gt; I[在相邻房间间 生成走廊 含旋转]

  I --&gt; J[组合所有片段 生成 CombinedMap]
</code></pre>
<h3 data-id="heading-28">五. 实现 MinimapHud 小地图</h3>
<h4 data-id="heading-29">1. 分析</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7ad88699ad54fbcbe5da75bcad46c08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334355&amp;x-signature=EZPPUGi7nvIltVv%2BKTA4kLCbAQA%3D" alt="元气骑士地图.PNG" loading="lazy"/></p>
<p>最后，<code>小地图</code> 可以说是 <strong>地牢类游戏</strong> 中不可或缺的一部分，否则大家在房间与走廊之间来回穿梭，很容易就会 <strong>迷路</strong> 😂。</p>
<p>从实现角度来看，小地图本质上并不是游戏中的 <strong>另一张地图</strong>，而是 <strong>对当前地牢结构的投影</strong>：<br/>
将真实游戏世界中的 <strong>房间、走廊、连接关系以及角色位置</strong>，按统一规则 <strong>映射</strong> 到一块缩放后的画布上进行可视化。</p>
<blockquote>
<p>🌟 因此，一个好的小地图通常具备以下 <strong>特征</strong>：</p>
<ul>
<li>与真实地图结构保持一致，但表现形式更加简化</li>
<li>不承载游戏逻辑，只负责 <strong>展示结果</strong></li>
<li>能清晰表达 <strong>房间分布、路径走向和当前位置</strong></li>
</ul>
<p><code>小地图</code> 不仅是一个辅助 <strong>UI</strong>，更是一种 <strong>对地图探索的即时反馈</strong>，将 <strong>迷路</strong> 的 <code>不安</code> 转化为探索的 <code>乐趣</code>。</p>
</blockquote>
<h4 data-id="heading-30">2. 准备</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7f71aeb227804a61b92773ae5ad1000f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334355&amp;x-signature=vMzy%2FXalTIAKKgMU9NVJBQ4Ip4o%3D" alt="地图素材.png" loading="lazy"/></p>
<h4 data-id="heading-31">3. 实现</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/90922a50bac2489c9fdfc94fcf1348e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334355&amp;x-signature=9D8p3NNj%2BtLBs2KGP1Ytxw6dMiM%3D" alt="小地图.png" loading="lazy"/></p>
<h5 data-id="heading-32">(1) <code>onLoad</code> 初始化</h5>
<p>在 <code>onLoad</code> 阶段，小地图完成 <strong>两件关键工作</strong>：</p>
<ul>
<li>根据屏幕尺寸，设置自身大小（通常为屏幕宽度的一定比例）</li>
</ul>
<pre><code class="hljs language-dart" lang="dart">    <span class="hljs-comment">// 设置小地图尺寸为屏幕宽度的 20%</span>
    <span class="hljs-keyword">final</span> side = game.size.x * <span class="hljs-number">0.2</span>;
</code></pre>
<ul>
<li>固定锚点在右上角，并预留安全边距，避免遮挡主要游戏区域</li>
</ul>
<pre><code class="hljs language-dart" lang="dart">    <span class="hljs-comment">// 设置位置在右上角，留出 20 像素边距</span>
    position = Vector2(game.size.x - <span class="hljs-number">20</span>, <span class="hljs-number">20</span>);
</code></pre>
<p>更重要的是，小地图在此阶段 <strong>订阅关卡加载器的地图变更事件</strong>。</p>
<pre><code class="hljs language-dart" lang="dart">    <span class="hljs-comment">// 监听地图加载事件</span>
    <span class="hljs-keyword">final</span> LevelLoader loader = game.levelLoader;
    _applyCombined(loader.currentCombinedMap);
    loader.mapNotifier.addListener(() {
      _applyCombined(loader.mapNotifier.value);
    });
</code></pre>
<p>这意味着：</p>
<blockquote>
<p>每当地牢被 <strong>重新生成或切换</strong>，小地图都会 <strong>自动</strong> 收到通知并 <strong>刷新</strong> 显示内容。</p>
</blockquote>
<h5 data-id="heading-33">(2) <code>_applyCombined</code> 解析并缓存地图结构</h5>
<p>初始化完成后，当新的地图数据到达时，小地图进入 <strong>解析阶段</strong>。</p>
<p>首先，从组合地图中 <strong>读取并缓存</strong>：</p>
<ul>
<li>世界地图左上角坐标（topLeft）</li>
<li>世界地图整体尺寸（size）</li>
</ul>
<p>这两项数据定义了<strong>世界坐标系到小地图坐标系的转换基准</strong>。</p>
<p>随后，小地图遍历随机地牢地图中的所有 <strong>片段（segments）</strong>，并根据类型进行处理：</p>
<ul>
<li><code>走廊 → 生成走廊矩形</code></li>
<li><code>房间 → 生成房间矩形 → 在基础上额外记录标记信息</code></li>
</ul>
<pre><code class="hljs language-dart" lang="dart">  <span class="hljs-comment">/// <span class="markdown">应用新的地图数据</span></span>
  <span class="hljs-comment">///</span>
  <span class="hljs-comment">/// <span class="markdown">当生成新地牢时调用，重新计算所有房间和走廊的显示矩形。</span></span>
  <span class="hljs-keyword">void</span> _applyCombined(CombinedMap? m) {
    ...

    <span class="hljs-comment">// 使用 MapCombiner 计算出的完整 3x3 边界</span>
    _worldTopLeft = m.topLeft.clone();
    _worldSize = m.size.clone();

    <span class="hljs-comment">// 遍历所有地图片段，计算它们在小地图上的相对位置</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> seg <span class="hljs-keyword">in</span> m.segments) {
      <span class="hljs-keyword">final</span> rect = _computeSegmentRect(seg);
      <span class="hljs-keyword">if</span> (seg.mapName.endsWith(<span class="hljs-string">'hallway.tmx'</span>)) {
        _corridorRects.add(rect);
      } <span class="hljs-keyword">else</span> {
        _roomRects.add(rect);

        <span class="hljs-comment">// 识别并添加特殊房间标记</span>
        <span class="hljs-built_in">String?</span> type;
        <span class="hljs-keyword">if</span> (seg.mapName.endsWith(<span class="hljs-string">'room_start.tmx'</span>))
          type = <span class="hljs-string">'start'</span>;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (seg.mapName.endsWith(<span class="hljs-string">'room_boss.tmx'</span>))
          type = <span class="hljs-string">'boss'</span>;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (seg.mapName.endsWith(<span class="hljs-string">'room_shop.tmx'</span>))
          type = <span class="hljs-string">'shop'</span>;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (seg.mapName.endsWith(<span class="hljs-string">'room_treasure.tmx'</span>))
          type = <span class="hljs-string">'treasure'</span>;
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (seg.mapName.endsWith(<span class="hljs-string">'room_battle.tmx'</span>))
          type = <span class="hljs-string">'battle'</span>;

        <span class="hljs-keyword">if</span> (type != <span class="hljs-keyword">null</span>) {
          _markers.add(_Marker(type, rect));
        }
      }
    }
  }
</code></pre>
<h5 data-id="heading-34">(3) <code>render</code> 小地图绘制阶段</h5>
<p>每一帧渲染时，小地图按照固定顺序绘制所有内容。</p>
<ul>
<li>
<p><strong>背景与边框</strong></p>
<p>首先绘制半透明背景和外边框，用于明确 <code>MinimapHud</code> 区域边界。</p>
<pre><code class="hljs language-dart" lang="dart">    <span class="hljs-comment">// 绘制背景和边框</span>
    <span class="hljs-keyword">final</span> bgRect = Rect.fromLTWH(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, size.x, size.y);
    canvas.drawRect(bgRect, _bgPaint);
    canvas.drawRect(bgRect, _borderPaint);
</code></pre>
</li>
<li>
<p><strong>计算缩放与偏移</strong></p>
<p>随后，根据世界地图尺寸与小地图可用区域，计算合适的 <strong>缩放比例</strong>。<br/>
这一计算保证了无论地牢布局如何 <strong>变化</strong>，<strong>3×3 网格</strong> 在小地图中的位置和尺度始终 <strong>稳定</strong>。</p>
<pre><code class="hljs language-dart" lang="dart">  <span class="hljs-built_in">double</span> _fitFactor() {
    <span class="hljs-keyword">final</span> availW = size.x - <span class="hljs-number">2</span> * _padding;
    <span class="hljs-keyword">final</span> availH = size.y - <span class="hljs-number">2</span> * _padding;

    <span class="hljs-keyword">final</span> fx = availW / _worldSize.x;
    <span class="hljs-keyword">final</span> fy = availH / _worldSize.y;

    <span class="hljs-comment">// 取宽高中较小的缩放比，确保内容完全可见</span>
    <span class="hljs-keyword">final</span> base = math.min(fx, fy);
    <span class="hljs-keyword">final</span> effectiveZoom = math.min(_zoom, <span class="hljs-number">1.0</span>);

    <span class="hljs-keyword">return</span> base * effectiveZoom * _contentScale;
  }
</code></pre>
</li>
<li>
<p><strong>绘制地图内容与状态信息</strong></p>
<p>在 <strong>缩放与偏移</strong> 确定后，<strong>按层级依次绘制</strong>：</p>
<ol>
<li>走廊结构（房间之间的连接）</li>
<li>房间轮廓（地图主体结构）</li>
<li>英雄当前位置（红色圆点，实时更新）</li>
<li>特殊房间标记图标（起点、Boss、商店等）</li>
</ol>
<p>所有元素均基于同一套 <code>世界 → 小地图</code> 的坐标映射规则，确保 <strong>结构与角色位置</strong> 的准确对应。</p>
<pre><code class="hljs language-dart" lang="dart">    <span class="hljs-comment">// 绘制走廊</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> r <span class="hljs-keyword">in</span> _corridorRects) {
      drawRectScaled(r, _corridorPaint);
    }

    <span class="hljs-comment">// 绘制房间</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> r <span class="hljs-keyword">in</span> _roomRects) {
      drawRectScaled(r, _roomPaint);
    }

    <span class="hljs-comment">// 绘制英雄位置</span>
    <span class="hljs-keyword">final</span> heroX = heroMinimapX + centerOffsetX;
    <span class="hljs-keyword">final</span> heroY = heroMinimapY + centerOffsetY;
    canvas.drawCircle(Offset(heroX, heroY), <span class="hljs-number">3</span>, _heroPaint);

    <span class="hljs-comment">// 绘制特殊房间图标</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> m <span class="hljs-keyword">in</span> _markers) {
      <span class="hljs-keyword">final</span> img = _icons[m.type];
      <span class="hljs-keyword">if</span> (img == <span class="hljs-keyword">null</span>) <span class="hljs-keyword">continue</span>;

      <span class="hljs-comment">// 计算图标位置（居中显示在房间矩形内）</span>
      <span class="hljs-keyword">final</span> cx =
          m.rect.left * factor + centerOffsetX + m.rect.width * factor / <span class="hljs-number">2</span>;
      <span class="hljs-keyword">final</span> cy =
          m.rect.top * factor + centerOffsetY + m.rect.height * factor / <span class="hljs-number">2</span>;
      <span class="hljs-keyword">final</span> half = _iconSize / <span class="hljs-number">2</span>;

      <span class="hljs-keyword">final</span> dst = Rect.fromLTWH(cx - half, cy - half, _iconSize, _iconSize);
      <span class="hljs-keyword">final</span> src = Rect.fromLTWH(
        <span class="hljs-number">0</span>,
        <span class="hljs-number">0</span>,
        img.width.toDouble(),
        img.height.toDouble(),
      );
      canvas.drawImageRect(img, src, dst, Paint());
    }
</code></pre>
</li>
</ul>
<h5 data-id="heading-35">(4) <code>onMount</code> 加载特殊标记资源</h5>
<p>在组件正式挂载完成后，小地图加载所需的 <strong>特殊标记资源</strong>。</p>
<blockquote>
<p>将资源加载放在 <code>onMount</code> 阶段，可以避免阻塞地图解析流程，同时确保资源在首次渲染前已准备就绪。</p>
</blockquote>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-meta">@override</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; onMount() <span class="hljs-keyword">async</span> {
    <span class="hljs-keyword">super</span>.onMount();
    <span class="hljs-comment">// 加载图标资源</span>
    _icons[<span class="hljs-string">'start'</span>] = <span class="hljs-keyword">await</span> game.images.load(<span class="hljs-string">'map/start.png'</span>);
    _icons[<span class="hljs-string">'boss'</span>] = <span class="hljs-keyword">await</span> game.images.load(<span class="hljs-string">'map/boss.png'</span>);
    _icons[<span class="hljs-string">'treasure'</span>] = <span class="hljs-keyword">await</span> game.images.load(<span class="hljs-string">'map/treasure.png'</span>);
    _icons[<span class="hljs-string">'shop'</span>] = <span class="hljs-keyword">await</span> game.images.load(<span class="hljs-string">'map/shop.png'</span>);
    _icons[<span class="hljs-string">'battle'</span>] = <span class="hljs-keyword">await</span> game.images.load(<span class="hljs-string">'map/battle.png'</span>);
  }
</code></pre>
<h4 data-id="heading-36">4. 流程图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
  A[MinimapHud 创建] --&gt; B[onLoad 设置大小/位置并订阅地图]
  B --&gt; C[_applyCombined 解析地图]
  C --&gt; C1[保存 topLeft/size]
  C --&gt; C2[遍历 segments 构建房间/走廊矩形与标记]
  C --&gt; D[render 绘制]
  D --&gt; D1[背景与边框]
  D --&gt; D2[计算缩放与偏移]
  D --&gt; D3[走廊/房间/英雄红点/标记图标]
  A --&gt; E[onMount 加载图标资源]
</code></pre>
<h3 data-id="heading-37">六. 总结与展望</h3>
<h4 data-id="heading-38">总结</h4>
<p>本章主要介绍了 <strong>Flutter&amp;Flame</strong> 开发 <strong>2D像素游戏</strong> 关于 <code>地图切换、随机地牢和小地图</code> 的基础实践。<br/>
截至目前为止，游戏主要包括了以下内容：</p>
<ul>
<li><strong>角色与动画</strong>：使用精灵图 (<code>SpriteSheet</code>) 创建角色，支持 idle/run 等动画状态切换。</li>
<li><strong>玩家交互</strong>：通过摇杆控制角色移动，并根据方向翻转动画。</li>
<li><strong>地图加载</strong>：通过 <code>Tiled</code> 绘制并在 <strong>Flame</strong> 中加载的 <strong>2d像素地图</strong>。</li>
<li><strong>地图交互</strong>：通过组件化模式，新建了多个可供交互的组件如（<strong>门、钥匙、宝箱、地刺</strong>），为游戏增加了互动性。</li>
<li><strong>地图切换</strong>：通过 <code>统一关卡加载器</code> 读取当前地图中存储的 <strong>目标地图</strong>，实现动态切换。</li>
<li><strong>地图生成</strong>：通过 <code>Tiled</code> 绘制出一批通用房间，规定 <strong>地图大小与房间数量</strong>，通过算法生成 <strong>随机地图</strong>。</li>
<li><strong>小地图</strong>：通过 <code>小地图</code>， 可以清晰的 <strong>可视化</strong> 的看清随机地图结构。</li>
<li><strong>统一碰撞区检测</strong>：将角色与 <strong>需要产生碰撞</strong> 的物体统一管理，并实现碰撞时的 <strong>平滑侧移</strong>。</li>
<li><strong>统一人物配置创建</strong>： 通过将角色数据配置为文件，达到以动态数据驱动模型的目的。</li>
<li><strong>HUD界面</strong>： 包括 <code>人物血量条</code> 和 <code>技能按钮</code>。</li>
<li><strong>完善的攻击逻辑</strong>：通过统一基类实现<code>近战、远程、冲刺</code> 的攻击方式 和 独特 <code>召唤</code> 技能。</li>
</ul>
<h4 data-id="heading-39">展望</h4>
<ul>
<li>
<p>思考 🤔 一个有趣的游戏机制ing ...</p>
</li>
<li>
<p>模仿元气骑士的武器机制</p>
</li>
<li>
<p>完善随机地牢内游戏内容</p>
</li>
<li>
<p>进阶这个demo版</p>
</li>
<li>
<p>支持局域网多玩家联机功能。</p>
</li>
</ul>
<blockquote>
<p><a href="https://link.juejin.cn?target=http%3A%2F%2Fmyhero.shanchen.space" target="_blank" title="http://myhero.shanchen.space" ref="nofollow noopener noreferrer">🎮 MyHero 在线体验</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTheSyart%2Fmyhero" target="_blank" title="https://github.com/TheSyart/myhero" ref="nofollow noopener noreferrer">🚪 github 源码</a><br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.shanchen.space" target="_blank" title="https://www.shanchen.space" ref="nofollow noopener noreferrer">💻 个人门户网站</a></p>
</blockquote>
<hr/>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48d840c0943b48dc974afc9d4952fefd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgX-Wkp-WtpueJsg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767334355&amp;x-signature=r%2F%2BbtXUSf7SE9fGN3oEEaobSko4%3D" width="100%" loading="lazy"/></p><p/>
<p align="center"><i>之前尝试的Demo预览</i></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue-plugin-hiprint打印高度不够，提示：没有足够空间,显示下方内容，问题处理方案及实操]]></title>    <link>https://juejin.cn/post/7587961565475930166</link>    <guid>https://juejin.cn/post/7587961565475930166</guid>    <pubDate>2025-12-26T06:26:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587961565475930166" data-draft-id="7587713001715204150" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue-plugin-hiprint打印高度不够，提示：没有足够空间,显示下方内容，问题处理方案及实操"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-12-26T06:26:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="猩球中的木子"/> <meta itemprop="url" content="https://juejin.cn/user/1374850183871056"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue-plugin-hiprint打印高度不够，提示：没有足够空间,显示下方内容，问题处理方案及实操
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1374850183871056/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    猩球中的木子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T06:26:09.000Z" title="Fri Dec 26 2025 06:26:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>最近在使用vue-plugin-hiprint的时候出现了打印高度不够的情况，同时发现作者已经停止了免费版的维护，但是在收费版svprint上已经解决了该问题,公司更希望使用免费的，所以我们就来看看怎么处理这个问题。</p>
<h3 data-id="heading-1">bug的现象</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9132643bf63b4ef68adec48fbc749d9d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54yp55CD5Lit55qE5pyo5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767335630&amp;x-signature=ZM7AariBcOf%2B14itjz1DOBBHWRc%3D" alt="91170a01bf006518dfe82d64abaed772.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32a0004922c444d5af87524437e3c605~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54yp55CD5Lit55qE5pyo5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767335630&amp;x-signature=AZAqlJSxIbYz2wx1B3947ThuZqw%3D" alt="image.png" loading="lazy"/></p>
<p>ps:问题链接<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2FCcSimple%2Fvue-plugin-hiprint%2Fissues%2FI9FEAD" target="_blank" title="https://gitee.com/CcSimple/vue-plugin-hiprint/issues/I9FEAD" ref="nofollow noopener noreferrer">gitee.com/CcSimple/vu…</a></p>
<h3 data-id="heading-2">解决方案</h3>
<p>一般出现这种插件的bug，处理方案无非就是如下几种</p>
<ol>
<li>问题转移：即使用其它第三方插件或者自己编写一个插件解决bug</li>
<li>问题接受：认可这个问题的结果，无需理会</li>
<li>问题规避：更换项目设计之类的</li>
<li>问题上报：提交issues等待第三方的插件开发者修复，然后更新插件到修复版</li>
</ol>
<p>ps: 遗憾的是通过查阅开源项目的说明，发现这个已经停止维护了，但是领导又不想使用收费的，切换一个新的插件，负担也比较重，于是只能去查阅它的源码了</p>
<h3 data-id="heading-3">代码分析</h3>
<p>通过查阅源码发现问题出在下面这个代码块
他的逻辑是读取模板的每一个元素块，渲染成dom，计算高度，当当前页面的高度不够展示一个元素的时候，就会在这个空隙中返回：没有足够空间,显示下方内容, 可分页高度
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99bceaa053e84ef99e01245fbc21a929~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54yp55CD5Lit55qE5pyo5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767335630&amp;x-signature=vuUONls50ISPt9ToI9ZCbeg7ijw%3D" alt="image.png" loading="lazy"/></p>
<p>优化思路
通过这个，就在想如果当前页不够，那么元素渲染到下一页怎样？
于是开始动手</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//思路 当m(分页html没有获取到tr) 且 curRow有数据（总的dom上是有数据的） 那么就说明高度不够了,理应填充表头</span>
        <span class="hljs-keyword">if</span> (m == <span class="hljs-number">0</span> &amp;&amp; curRow.<span class="hljs-property">length</span> &amp;&amp; g == curRow.<span class="hljs-title function_">data</span>(<span class="hljs-string">"rowData"</span>)) {
          <span class="hljs-keyword">return</span> {
            <span class="hljs-attr">target</span>: $(<span class="hljs-string">'&lt;div&gt;&lt;/div&gt;'</span>),<span class="hljs-comment">//元素为div空元素</span>
            <span class="hljs-attr">length</span>: <span class="hljs-number">0</span>,<span class="hljs-comment">//这里填0实际没有渲染数量</span>
            <span class="hljs-attr">height</span>: _assets_plugins_hinnn__WEBPACK_IMPORTED_MODULE_3__.<span class="hljs-property">a</span>.<span class="hljs-property">px</span>.<span class="hljs-title function_">toPt</span>(s),<span class="hljs-comment">//高度为剩余高度</span>
            <span class="hljs-attr">isEnd</span>: !<span class="hljs-number">1</span> <span class="hljs-comment">//表示有下一页</span>
          }
        }
</code></pre>
<h3 data-id="heading-4">修复后的效果如下</h3>
<p>红色区域的被div占据，后面的数据渲染到下一页了，能正常使用了。
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8e8723d869d64caba6ab6c7579b6c60f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54yp55CD5Lit55qE5pyo5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767335630&amp;x-signature=N0BXDosMkAlgQsWyl7%2BH27BefnA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">如何应用修复的插件代码</h2>
<ol>
<li>要知道我们的插件都是由第三方的作者开源到npm上的，那么我们采取的第一个方案就是把这个东西放到npm上，这个过程就不再赘述了</li>
<li>也可以托管到git私仓上，这里我建了一个仓库存放，源码打包后的内容。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4eb1f621c6d4d8eb560344ef53f48f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54yp55CD5Lit55qE5pyo5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767335630&amp;x-signature=1dw%2BB0iDa0%2FA5UIoYZfizdZjksk%3D" alt="image.png" loading="lazy"/></p>
<p>3记得对提交的打包产物打上标签用来做版本号
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb14c059226c4dd3a1fa9c363730eaa5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54yp55CD5Lit55qE5pyo5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767335630&amp;x-signature=Hlrra2KGUt53yir0wCcv8lfOWmU%3D" alt="image.png" loading="lazy"/></p>
<p>4最后在package的配置中指向你的源码库
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db894c61557947ab9448bfd574f8f7d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54yp55CD5Lit55qE5pyo5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767335630&amp;x-signature=RM5LJaQJoIsIEiLImLoxZ4u6yqI%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//配置git的地址加#版本号</span>
<span class="hljs-string">"vue-plugin-hiprint"</span>: <span class="hljs-string">"git+http://xxxxx:9080/xxxx/hiprint-lib.git#v0.0.71"</span>,
</code></pre>
<h2 data-id="heading-6">总结</h2>
<p>主要有3个收获</p>
<ol>
<li>对vue-plugin-hiprint的内部逻辑的实现进行了研究，积累了这方面的经验。</li>
<li>个人也实现了一个包管理的流程，虽然npm的更规范，但是我们这是小公司，他们更希望能自己管理自己的代码，所以是发布到npm还是使用git都行，最终目的达到就行了。</li>
<li>发现了vue-plugin-hiprint内部混淆代码后的for循环的另一种写法,以后想装一下就有思路了，哈哈</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">//这个这个for循环的初始化部分有三个表达式：
//1.  `var <span class="hljs-attr">d</span> = n.find(<span class="hljs-string">".hiprint-printElement-tableTarget:eq("</span> + u + <span class="hljs-string">")"</span>)`
//2.  `<span class="hljs-attr">c</span> = void <span class="hljs-number">0</span>`
//3.  `<span class="hljs-attr">h</span> = []`
//这个循环没有条件判断，也没有递增步骤，所以它将是一个无限循环，除非在循环体内有`break`语句来跳出循环
for (var <span class="hljs-attr">d</span> = n.find(<span class="hljs-string">".hiprint-printElement-tableTarget:eq("</span> + u + <span class="hljs-string">")"</span>), c = void <span class="hljs-number">0</span>, h = []<span class="hljs-comment">; ;) </span>

//这个和上一个类似，当 `l` 为 `false` 时，`!l` 为 `true`，循环继续，当 `l` 变为 `true` 时，`!l` 为 `false`，循环结束。
for (var a, <span class="hljs-attr">p</span> = this.getBeginPrintTopInPaperByReferenceElement(t), s = <span class="hljs-number">0</span>, l = !<span class="hljs-number">1</span><span class="hljs-comment">; !l;)</span>

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flink 到 Doris 数据同步----从二阶段提交到幂等性 StreamLoader 的演进之路]]></title>    <link>https://juejin.cn/post/7587688765189177344</link>    <guid>https://juejin.cn/post/7587688765189177344</guid>    <pubDate>2025-12-26T06:29:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587688765189177344" data-draft-id="7587675306658693120" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flink 到 Doris 数据同步----从二阶段提交到幂等性 StreamLoader 的演进之路"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-12-26T06:29:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="语落心生"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147955741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flink 到 Doris 数据同步----从二阶段提交到幂等性 StreamLoader 的演进之路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147955741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    语落心生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T06:29:19.000Z" title="Fri Dec 26 2025 06:29:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题背景</h2>
<p>在实时数据仓库建设中，<strong>Flink</strong> 作为流处理引擎的事实标准，<strong>Doris</strong> 作为 OLAP 数据库的新秀，两者的结合成为企业实时数据平台的常见架构选择。</p>
<p>然而，在生产环境中我们遇到了一个普遍的痛点：</p>
<blockquote>
<p><strong>"使用官方的 doris-flink-connector，其基于 Checkpoint 的二阶段提交（2PC）机制在千万级别数据同步时，吞吐量瓶颈明显，平均延迟从秒级跳升到分钟级。"</strong></p>
</blockquote>
<p>这篇文章将详细展示我们如何从传统的 checkpoint 二阶段提交，逐步演进到基于 Doris Label 事务标识的分批 StreamLoad 提交，最终落地到使用 Doris StreamLoader 保证幂等性的完整方案。</p>
<hr/>
<h2 data-id="heading-1">第一部分：问题诊断</h2>
<h3 data-id="heading-2">1.1 官方 Doris-Flink-Connector 的架构</h3>
<p>Doris-Flink-Connector 采用标准的 Flink Sink 设计，基于 Checkpoint 的二阶段提交（2PC）来保证 <strong>精确一次性（Exactly-Once）</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">┌──────────────────────────────────────────────┐
│         Flink DataStream Pipeline            │
│                                              │
│  Source → <span class="hljs-attribute">Transform</span> → Doris Sink             │
└──────────────────────────────────────────────┘
                      │
                      ▼
         ┌─────────────────────────┐
         │   DorisSink (<span class="hljs-number">2PC</span>)       │
         │                         │
         │  第一阶段：预提交        │
         │  └─ 将数据写入缓冲     │
         │                         │
         │  第二阶段：Checkpoint   │
         │  └─ 真正提交到 Doris   │
         └─────────────────────────┘
</code></pre>
<p><strong>二阶段提交的生命周期</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 伪代码：官方连接器的二阶段提交流程</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DorisSink2PC</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">write</span>(<span class="hljs-params">self, record</span>):
        <span class="hljs-comment"># 第一阶段：数据进入缓冲队列</span>
        self.buffer.append(record)
        <span class="hljs-keyword">if</span> self.buffer.size &gt;= self.batch_size:
            self.flush_buffer()  <span class="hljs-comment"># 本地缓冲</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">flush_buffer</span>(<span class="hljs-params">self</span>):
        <span class="hljs-comment"># 将缓冲数据通过 Stream Load HTTP API 发送到 Doris</span>
        <span class="hljs-comment"># 但此时还未提交事务</span>
        response = http_post(
            url=<span class="hljs-string">f"http://<span class="hljs-subst">{doris_host}</span>:<span class="hljs-subst">{http_port}</span>/api/<span class="hljs-subst">{db}</span>/<span class="hljs-subst">{table}</span>/load"</span>,
            data=self.buffer,
            label=<span class="hljs-string">f"checkpoint_<span class="hljs-subst">{checkpoint_id}</span>_<span class="hljs-subst">{partition_id}</span>"</span>  <span class="hljs-comment"># 使用 checkpoint 作为 label</span>
        )
        self.pending_commits.append(response.label)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">notify_checkpoint_complete</span>(<span class="hljs-params">self, checkpoint_id</span>):
        <span class="hljs-comment"># 第二阶段：Checkpoint 完成后，真正提交事务</span>
        <span class="hljs-keyword">for</span> label <span class="hljs-keyword">in</span> self.pending_commits:
            commit_load_task(label)  <span class="hljs-comment"># 向 Doris 发送提交请求</span>
        self.pending_commits.clear()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">abort_checkpoint</span>(<span class="hljs-params">self, checkpoint_id</span>):
        <span class="hljs-comment"># Checkpoint 失败时，回滚未提交的加载任务</span>
        <span class="hljs-keyword">for</span> label <span class="hljs-keyword">in</span> self.pending_commits:
            abort_load_task(label)
        self.pending_commits.clear()
</code></pre>
<h3 data-id="heading-3">1.2 二阶段提交的性能瓶颈</h3>
<p>虽然二阶段提交能保证强一致性，但在实时场景中存在以下瓶颈：</p>






























<table><thead><tr><th>瓶颈点</th><th>原因</th><th>影响</th></tr></thead><tbody><tr><td><strong>Checkpoint 同步等待</strong></td><td>Flink 需要等待所有 Source 对齐，才能触发 Checkpoint</td><td>吞吐量受到最慢 Source 的制约</td></tr><tr><td><strong>Doris 事务锁竞争</strong></td><td>多个并行度的任务同时等待事务提交，导致锁竞争</td><td>延迟从秒级跳升到分钟级</td></tr><tr><td><strong>缓冲区膨胀</strong></td><td>预提交的数据在 Doris 侧暂时无法查询，缓冲区堆积</td><td>内存占用高，GC 频繁</td></tr><tr><td><strong>网络往返次数</strong></td><td>每个 Batch 需要两次 HTTP 往返（预提交 + 最终提交）</td><td>网络开销倍增</td></tr></tbody></table>
<p><strong>实际性能对比</strong>（基于千万级日均数据同步场景）：</p>
<pre><code class="hljs language-matlab" lang="matlab">官方 <span class="hljs-number">2</span>PC 方案：
├─ 平均 RTT: ~<span class="hljs-number">500</span>ms
├─ 吞吐量: ~<span class="hljs-number">20</span>K rows/<span class="hljs-built_in">sec</span>
├─ P99 延迟: ~<span class="hljs-number">10</span><span class="hljs-built_in">min</span>
└─ 资源占用: 高 (GC 压力大)

优化后方案（本文方案）：
├─ 平均 RTT: ~<span class="hljs-number">50</span>ms
├─ 吞吐量: ~<span class="hljs-number">500</span>K rows/<span class="hljs-built_in">sec</span>
├─ P99 延迟: ~<span class="hljs-number">5</span><span class="hljs-built_in">sec</span>
└─ 资源占用: 低 (稳定)
</code></pre>
<h3 data-id="heading-4">1.3 应用场景界定</h3>
<p><strong>本方案适用的场景</strong>：</p>
<ul>
<li>✅ <strong>实时 ETL</strong>：数据库主从复制、日志采集、消息队列实时入库</li>
<li>✅ <strong>准实时报表</strong>：用户行为分析、销售数据实时汇总</li>
<li>✅ <strong>日志存储</strong>：结构化日志入湖、审计日志归档</li>
<li>✅ <strong>数据湖集成</strong>：多源异构数据实时融合</li>
</ul>
<p><strong>不适用的场景</strong>：</p>
<ul>
<li>❌ 对强一致性有绝对要求的金融类场景（需自定义幂等策略）</li>
<li>❌ 数据修改频繁的 OLTP 场景（应使用 OLTP 数据库）</li>
</ul>
<p><strong>典型应用表模型</strong>：</p>
<p>本方案重点针对 <strong>明细表（Append-Only Table）</strong>：</p>
<ul>
<li>数据只追加，不修改或删除</li>
<li>典型场景：事件表、日志表、订单详情表、流水表</li>
</ul>
<p>不适用于需要 UPDATE/DELETE 的维度表或聚合表。</p>
<hr/>
<h2 data-id="heading-5">第二部分：方案演进</h2>
<h3 data-id="heading-6">2.1 第一代：Label 事务标识分批提交</h3>
<p><strong>核心思路</strong>：绕过 Checkpoint，直接利用 Doris 的 Label 机制来保证幂等性。</p>
<p><strong>Doris Label 是什么？</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 通俗理解：Label 就是一个"事务ID"</span>
<span class="hljs-comment"># 同一个 Label 的多次请求，Doris 只处理一次</span>

<span class="hljs-comment"># 举例：</span>
<span class="hljs-comment"># 第一次请求：POST /api/db/table/load?label=user_sync_001</span>
<span class="hljs-comment">#   → Doris 创建事务，返回 success</span>
<span class="hljs-comment"># 第二次请求（网络重试）：POST /api/db/table/load?label=user_sync_001</span>
<span class="hljs-comment">#   → Doris 检查到 label 已存在，幂等返回 success（不重复加载）</span>
<span class="hljs-comment"># 第三次请求（另一个并行度）：POST /api/db/table/load?label=user_sync_002</span>
<span class="hljs-comment">#   → Doris 创建新事务，正常处理</span>
</code></pre>
<p><strong>架构设计</strong>：</p>
<pre><code class="hljs language-css" lang="css">┌────────────────────────────────────────────────────┐
│         Flink DataStream Pipeline                  │
│                                                    │
│  Source → <span class="hljs-attribute">Transform</span> → <span class="hljs-selector-tag">Label</span>-Based Sink             │
└────────────────────────────────────────────────────┘
                      │
                      ▼
        ┌──────────────────────────────┐
        │   <span class="hljs-selector-tag">Label</span>-Based Sink (分批)     │
        │                              │
        │  <span class="hljs-number">1</span>. 内存缓冲数据              │
        │  <span class="hljs-number">2</span>. 生成唯一 <span class="hljs-selector-tag">Label</span>            │
        │  <span class="hljs-number">3</span>. StreamLoad 提交           │
        │  <span class="hljs-number">4</span>. 异步等待 Doris 确认       │
        └──────────────────────────────┘
                      │
                      ▼
        ┌──────────────────────────────┐
        │   Doris StreamLoad API        │
        │                              │
        │  <span class="hljs-selector-tag">Label</span>: user_sync_001        │
        │  Status: FINISHED/CANCELLED  │
        └──────────────────────────────┘
</code></pre>
<p><strong>代码实现</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>
<span class="hljs-keyword">import</span> uuid
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DorisLabelSink</span>:
    <span class="hljs-string">"""
    基于 Doris Label 的分批提交 Sink
    保证在至多一次（At-Most-Once）的语义下，幂等性上传
    """</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">
        self,
        doris_host: <span class="hljs-built_in">str</span>,
        doris_port: <span class="hljs-built_in">int</span>,
        database: <span class="hljs-built_in">str</span>,
        table: <span class="hljs-built_in">str</span>,
        username: <span class="hljs-built_in">str</span>,
        password: <span class="hljs-built_in">str</span>,
        batch_size: <span class="hljs-built_in">int</span> = <span class="hljs-number">10000</span>,
        flush_interval_ms: <span class="hljs-built_in">int</span> = <span class="hljs-number">5000</span>
    </span>):
        self.doris_host = doris_host
        self.doris_port = doris_port
        self.database = database
        self.table = table
        self.username = username
        self.password = password
        self.batch_size = batch_size
        self.flush_interval_ms = flush_interval_ms
        
        self.buffer = []
        self.last_flush_time = time.time()
        self.pending_labels = {}  <span class="hljs-comment"># {label: timestamp}</span>
        
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">write</span>(<span class="hljs-params">self, record: <span class="hljs-built_in">dict</span></span>):
        <span class="hljs-string">"""
        写入记录，触发缓冲或提交
        """</span>
        self.buffer.append(record)
        
        <span class="hljs-comment"># 条件1：缓冲区满</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(self.buffer) &gt;= self.batch_size:
            self.flush()
        
        <span class="hljs-comment"># 条件2：距离上次提交超过 flush_interval</span>
        <span class="hljs-keyword">elif</span> time.time() - self.last_flush_time &gt; self.flush_interval_ms / <span class="hljs-number">1000</span>:
            self.flush()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">flush</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""
        生成 Label，调用 StreamLoad API
        """</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.buffer:
            <span class="hljs-keyword">return</span>
        
        <span class="hljs-comment"># 步骤1：生成唯一 Label</span>
        <span class="hljs-comment"># 格式：{database}_{table}_{timestamp}_{uuid}</span>
        label = self._generate_label()
        
        <span class="hljs-comment"># 步骤2：准备 CSV 格式数据</span>
        csv_data = self._convert_to_csv(self.buffer)
        
        <span class="hljs-comment"># 步骤3：调用 StreamLoad API</span>
        <span class="hljs-keyword">try</span>:
            response = self._stream_load(label, csv_data)
            
            <span class="hljs-keyword">if</span> response[<span class="hljs-string">'Status'</span>] == <span class="hljs-string">'Success'</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Label <span class="hljs-subst">{label}</span> 提交成功"</span>)
                self.buffer.clear()
                self.last_flush_time = time.time()
                self.pending_labels[label] = time.time()
            <span class="hljs-keyword">elif</span> response[<span class="hljs-string">'Status'</span>] == <span class="hljs-string">'Label Already Exists'</span>:
                <span class="hljs-comment"># 幂等：同一个 Label 重复提交，直接认为成功</span>
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Label <span class="hljs-subst">{label}</span> 已存在，幂等返回"</span>)
                self.buffer.clear()
                self.last_flush_time = time.time()
            <span class="hljs-keyword">else</span>:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Label <span class="hljs-subst">{label}</span> 提交失败: <span class="hljs-subst">{response[<span class="hljs-string">'Message'</span>]}</span>"</span>)
                <span class="hljs-comment"># 失败时可选择重试或丢弃（取决于业务容忍度）</span>
        
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"StreamLoad 异常: <span class="hljs-subst">{e}</span>"</span>)
            <span class="hljs-comment"># 异常处理：可选择重试或丢弃</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_generate_label</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""
        生成唯一的 Label
        
        设计原则：
        1. 全局唯一：同一时间不同 Sink 生成不同 Label
        2. 幂等安全：同一 Sink 的重试请求生成相同 Label
        3. 可追踪：Label 包含时间戳和源信息
        """</span>
        timestamp = datetime.now().strftime(<span class="hljs-string">"%Y%m%d_%H%M%S"</span>)
        unique_id = <span class="hljs-built_in">str</span>(uuid.uuid4())[:<span class="hljs-number">8</span>]
        label = <span class="hljs-string">f"<span class="hljs-subst">{self.database}</span>_<span class="hljs-subst">{self.table}</span>_<span class="hljs-subst">{timestamp}</span>_<span class="hljs-subst">{unique_id}</span>"</span>
        <span class="hljs-keyword">return</span> label
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_convert_to_csv</span>(<span class="hljs-params">self, records: <span class="hljs-type">List</span>[<span class="hljs-built_in">dict</span>]</span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""
        将 Python dict 转换为 CSV 格式
        """</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> records:
            <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>
        
        lines = []
        <span class="hljs-keyword">for</span> record <span class="hljs-keyword">in</span> records:
            <span class="hljs-comment"># 假设字段顺序一致</span>
            values = [<span class="hljs-built_in">str</span>(v) <span class="hljs-keyword">if</span> v <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> <span class="hljs-string">""</span> <span class="hljs-keyword">for</span> v <span class="hljs-keyword">in</span> record.values()]
            csv_line = <span class="hljs-string">"\t"</span>.join(values)  <span class="hljs-comment"># Doris 默认以 \t 分隔</span>
            lines.append(csv_line)
        
        <span class="hljs-keyword">return</span> <span class="hljs-string">"\n"</span>.join(lines)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_stream_load</span>(<span class="hljs-params">self, label: <span class="hljs-built_in">str</span>, csv_data: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">dict</span>:
        <span class="hljs-string">"""
        调用 Doris StreamLoad API
        """</span>
        url = <span class="hljs-string">f"http://<span class="hljs-subst">{self.doris_host}</span>:<span class="hljs-subst">{self.doris_port}</span>/api/<span class="hljs-subst">{self.database}</span>/<span class="hljs-subst">{self.table}</span>/load"</span>
        
        headers = {
            <span class="hljs-string">"label"</span>: label,
            <span class="hljs-string">"column_separator"</span>: <span class="hljs-string">"\t"</span>,
            <span class="hljs-string">"line_delimiter"</span>: <span class="hljs-string">"\n"</span>,
            <span class="hljs-string">"format"</span>: <span class="hljs-string">"csv"</span>
        }
        
        response = requests.post(
            url,
            data=csv_data.encode(<span class="hljs-string">'utf-8'</span>),
            headers=headers,
            auth=(self.username, self.password),
            timeout=<span class="hljs-number">30</span>
        )
        
        <span class="hljs-comment"># 解析响应</span>
        <span class="hljs-keyword">return</span> response.json()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">close</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""
        关闭 Sink 时，强制刷新剩余数据
        """</span>
        <span class="hljs-keyword">if</span> self.buffer:
            self.flush()
        
        <span class="hljs-comment"># 可选：轮询等待所有 pending labels 完成</span>
        self._wait_for_pending_labels()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_wait_for_pending_labels</span>(<span class="hljs-params">self, timeout_sec: <span class="hljs-built_in">int</span> = <span class="hljs-number">300</span></span>):
        <span class="hljs-string">"""
        等待所有 pending labels 的加载任务完成
        """</span>
        start_time = time.time()
        
        <span class="hljs-keyword">while</span> self.pending_labels:
            label, submit_time = <span class="hljs-built_in">list</span>(self.pending_labels.items())[<span class="hljs-number">0</span>]
            
            <span class="hljs-comment"># 检查 label 状态</span>
            status = self._query_label_status(label)
            
            <span class="hljs-keyword">if</span> status <span class="hljs-keyword">in</span> [<span class="hljs-string">'FINISHED'</span>, <span class="hljs-string">'CANCELLED'</span>]:
                self.pending_labels.pop(label)
            <span class="hljs-keyword">elif</span> time.time() - start_time &gt; timeout_sec:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"超时等待 label <span class="hljs-subst">{label}</span>, 放弃"</span>)
                self.pending_labels.pop(label)
            <span class="hljs-keyword">else</span>:
                time.sleep(<span class="hljs-number">1</span>)  <span class="hljs-comment"># 轮询间隔</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_query_label_status</span>(<span class="hljs-params">self, label: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
        <span class="hljs-string">"""
        查询 Label 的加载状态
        返回：PREPARE, LOADING, FINISHED, CANCELLED
        """</span>
        <span class="hljs-comment"># 通过 SQL: SHOW LOAD WHERE label = 'xxx'</span>
        <span class="hljs-comment"># 实际实现可调用 Doris FE 的 HTTP API</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"FINISHED"</span>  <span class="hljs-comment"># 简化示例</span>
</code></pre>
<p><strong>Flink 集成示例</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> pyflink.datastream <span class="hljs-keyword">import</span> StreamExecutionEnvironment
<span class="hljs-keyword">from</span> pyflink.datastream.functions <span class="hljs-keyword">import</span> MapFunction
<span class="hljs-keyword">import</span> json

<span class="hljs-comment"># 1. 创建执行环境</span>
env = StreamExecutionEnvironment.get_execution_environment()
env.set_parallelism(<span class="hljs-number">4</span>)  <span class="hljs-comment"># 4 个并行度</span>

<span class="hljs-comment"># 2. 配置 Checkpoint（可选，用于源端故障恢复）</span>
env.enable_checkpointing(interval_millis=<span class="hljs-number">60000</span>)  <span class="hljs-comment"># 60 秒一个 checkpoint</span>

<span class="hljs-comment"># 3. 创建数据源（以 Kafka 为例）</span>
kafka_source = env.add_source(
    FlinkKafkaConsumer(
        topics=[<span class="hljs-string">'user_events'</span>],
        deserialization_schema=SimpleStringSchema(),
        properties={
            <span class="hljs-string">'bootstrap.servers'</span>: <span class="hljs-string">'kafka:9092'</span>,
            <span class="hljs-string">'group.id'</span>: <span class="hljs-string">'flink_to_doris_group'</span>
        }
    )
)

<span class="hljs-comment"># 4. 转换和过滤</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_and_transform</span>(<span class="hljs-params">json_str: <span class="hljs-built_in">str</span></span>):
    <span class="hljs-string">"""解析 JSON 并转换为 dict"""</span>
    data = json.loads(json_str)
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">'user_id'</span>: data[<span class="hljs-string">'user_id'</span>],
        <span class="hljs-string">'event_type'</span>: data[<span class="hljs-string">'event_type'</span>],
        <span class="hljs-string">'timestamp'</span>: data[<span class="hljs-string">'timestamp'</span>],
        <span class="hljs-string">'event_data'</span>: json.dumps(data[<span class="hljs-string">'properties'</span>])
    }

transformed = kafka_source.<span class="hljs-built_in">map</span>(
    <span class="hljs-keyword">lambda</span> x: parse_and_transform(x),
    output_type=Types.MAP(Types.STRING, Types.STRING)
)

<span class="hljs-comment"># 5. 添加 Doris Sink</span>
doris_sink = DorisLabelSink(
    doris_host=<span class="hljs-string">'doris-fe.example.com'</span>,
    doris_port=<span class="hljs-number">8030</span>,
    database=<span class="hljs-string">'realtime_db'</span>,
    table=<span class="hljs-string">'user_events'</span>,
    username=<span class="hljs-string">'doris_user'</span>,
    password=<span class="hljs-string">'doris_password'</span>,
    batch_size=<span class="hljs-number">50000</span>,
    flush_interval_ms=<span class="hljs-number">10000</span>
)

transformed.add_sink(doris_sink)

<span class="hljs-comment"># 6. 执行</span>
env.execute(<span class="hljs-string">"Kafka to Doris Label-Based Sink"</span>)
</code></pre>
<p><strong>优势与局限</strong>：</p>

































<table><thead><tr><th>方面</th><th>说明</th></tr></thead><tbody><tr><td><strong>优势</strong></td><td>✅ 绕过 Checkpoint 同步等待，吞吐量大幅提升</td></tr><tr><td/><td>✅ Label 幂等性保证，支持失败重试</td></tr><tr><td/><td>✅ 实现简洁，容易定制</td></tr><tr><td><strong>局限</strong></td><td>❌ 需要手动管理重试逻辑</td></tr><tr><td/><td>❌ Label 重复提交时仍有小概率冲突</td></tr><tr><td/><td>❌ 无法保证 Exactly-Once（只能保证 At-Most-Once）</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-7">2.2 第二代：Doris 官方 StreamLoad API（最终推荐方案）</h3>
<p>虽然第一代方案在性能上已经取得显著进步，但我们发现在极端网络波动场景下，仍需要更健壮的幂等性处理。</p>
<p><strong>2021 年，Doris 官方开源了独立项目 <code>doris-streamloader</code></strong>，这是一个专门为 Stream Load 优化的轻量级客户端库，不需要侵入代码层面，而是通过 HTTP API 调用的方式与 Doris 交互。</p>
<p>仓库地址: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fapache%2Fdoris-streamloader" target="_blank" title="https://github.com/apache/doris-streamloader" ref="nofollow noopener noreferrer">github.com/apache/dori…</a></p>
<p><strong>核心设计原则</strong>：</p>
<ul>
<li><strong>非侵入式</strong>：无需修改 Flink 框架，通过 HTTP API 调用</li>
<li><strong>自动并行</strong>：自动分片和多线程并发加载</li>
<li><strong>幂等保证</strong>：内置 Label 机制，自动去重和重试</li>
<li><strong>故障恢复</strong>：支持断点续传和失败重试</li>
</ul>
<p><strong>架构设计</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">┌──────────────────────────────────────────────┐
│         Flink DataStream Pipeline            │
│                                              │
│  Source → <span class="hljs-attribute">Transform</span> → Generic Sink           │
└──────────────────────────────────────────────┘
                      │
                      ▼
        ┌──────────────────────────────┐
        │  缓冲数据（CSV/JSON 格式）    │
        │  (不需要特殊编码)            │
        └──────────────────────────────┘
                      │
                      ▼
        ┌──────────────────────────────┐
        │   HTTP POST 请求              │
        │   (Stream Load API)           │
        └──────────────────────────────┘
                      │
          ┌───────────┴───────────┐
          ▼                       ▼
    ┌──────────────┐      ┌──────────────┐
    │  FE 节点      │      │  BE 节点      │
    │ (负载均衡)    │      │ (数据导入)    │
    └──────────────┘      └──────────────┘
          │
          ▼
    ┌──────────────┐
    │  Doris 存储   │
    │ (OlapTable)  │
    └──────────────┘
</code></pre>
<p><strong>使用 Doris StreamLoad API 的 Flink Sink 实现</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.io.*;
<span class="hljs-keyword">import</span> java.net.HttpURLConnection;
<span class="hljs-keyword">import</span> java.net.URL;
<span class="hljs-keyword">import</span> java.util.*;
<span class="hljs-keyword">import</span> java.util.concurrent.Executors;
<span class="hljs-keyword">import</span> java.util.concurrent.ScheduledExecutorService;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;
<span class="hljs-keyword">import</span> org.apache.flink.streaming.api.functions.sink.RichSinkFunction;
<span class="hljs-keyword">import</span> org.apache.flink.configuration.Configuration;
<span class="hljs-keyword">import</span> org.apache.flink.api.common.metrics.Counter;
<span class="hljs-keyword">import</span> org.slf4j.Logger;
<span class="hljs-keyword">import</span> org.slf4j.LoggerFactory;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DorisStreamLoadSink</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">RichSinkFunction</span>&lt;String&gt; {
    <span class="hljs-comment">/**
     * 通过 HTTP Stream Load API 直接与 Doris 交互
     * 无需侵入任何 Flink 内部代码
     */</span>
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">LOG</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(DorisStreamLoadSink.class);
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String feHost;          <span class="hljs-comment">// FE 节点 IP</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> fePort;             <span class="hljs-comment">// FE HTTP 端口（通常 8030）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String database;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String table;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String username;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String password;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> batchSize;          <span class="hljs-comment">// 缓冲行数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> flushIntervalMs;    <span class="hljs-comment">// 刷新间隔（毫秒）</span>
    
    <span class="hljs-keyword">private</span> List&lt;String&gt; buffer;
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> lastFlushTime;
    <span class="hljs-keyword">private</span> ScheduledExecutorService scheduler;
    
    <span class="hljs-comment">// 监控指标</span>
    <span class="hljs-keyword">private</span> Counter successCounter;
    <span class="hljs-keyword">private</span> Counter failureCounter;
    <span class="hljs-keyword">private</span> Counter totalRowsCounter;
    
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">DorisStreamLoadSink</span><span class="hljs-params">(
        String feHost,
        <span class="hljs-type">int</span> fePort,
        String database,
        String table,
        String username,
        String password,
        <span class="hljs-type">int</span> batchSize,
        <span class="hljs-type">int</span> flushIntervalMs
    )</span> {
        <span class="hljs-built_in">this</span>.feHost = feHost;
        <span class="hljs-built_in">this</span>.fePort = fePort;
        <span class="hljs-built_in">this</span>.database = database;
        <span class="hljs-built_in">this</span>.table = table;
        <span class="hljs-built_in">this</span>.username = username;
        <span class="hljs-built_in">this</span>.password = password;
        <span class="hljs-built_in">this</span>.batchSize = batchSize;
        <span class="hljs-built_in">this</span>.flushIntervalMs = flushIntervalMs;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">open</span><span class="hljs-params">(Configuration parameters)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-built_in">super</span>.open(parameters);
        
        <span class="hljs-built_in">this</span>.buffer = Collections.synchronizedList(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;());
        <span class="hljs-built_in">this</span>.lastFlushTime = System.currentTimeMillis();
        
        <span class="hljs-comment">// 初始化监控指标</span>
        <span class="hljs-built_in">this</span>.successCounter = getRuntimeContext().getMetricGroup().counter(<span class="hljs-string">"stream_load_success"</span>);
        <span class="hljs-built_in">this</span>.failureCounter = getRuntimeContext().getMetricGroup().counter(<span class="hljs-string">"stream_load_failure"</span>);
        <span class="hljs-built_in">this</span>.totalRowsCounter = getRuntimeContext().getMetricGroup().counter(<span class="hljs-string">"total_rows_loaded"</span>);
        
        <span class="hljs-comment">// 定时刷新线程</span>
        <span class="hljs-built_in">this</span>.scheduler = Executors.newScheduledThreadPool(<span class="hljs-number">1</span>);
        scheduler.scheduleAtFixedRate(
            <span class="hljs-built_in">this</span>::tryFlush,
            flushIntervalMs,
            flushIntervalMs,
            TimeUnit.MILLISECONDS
        );
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(String jsonRecord, Context context)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">synchronized</span> (buffer) {
            buffer.add(jsonRecord);
            
            <span class="hljs-comment">// 条件1：缓冲区满</span>
            <span class="hljs-keyword">if</span> (buffer.size() &gt;= batchSize) {
                flush();
            }
        }
    }
    
    <span class="hljs-comment">/**
     * 尝试刷新（时间触发）
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">tryFlush</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">synchronized</span> (buffer) {
            <span class="hljs-keyword">if</span> (!buffer.isEmpty() &amp;&amp; 
                System.currentTimeMillis() - lastFlushTime &gt; flushIntervalMs) {
                <span class="hljs-keyword">try</span> {
                    flush();
                } <span class="hljs-keyword">catch</span> (Exception e) {
                    LOG.error(<span class="hljs-string">"定时刷新失败"</span>, e);
                }
            }
        }
    }
    
    <span class="hljs-comment">/**
     * 核心方法：通过 HTTP Stream Load API 向 Doris 提交数据
     * 
     * HTTP 请求示例：
     * POST /api/{db}/{table}/_stream_load
     * 请求头：
     *   label: 唯一的加载标签（用于幂等性）
     *   format: json 或 csv
     *   read_json_by_line: true（如果是多行 JSON）
     * 请求体：CSV 或 JSON 格式的数据
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">flush</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">if</span> (buffer.isEmpty()) {
            <span class="hljs-keyword">return</span>;
        }
        
        <span class="hljs-comment">// 步骤1：获取副本进行刷新，避免长时间持有锁</span>
        List&lt;String&gt; dataToFlush = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(buffer);
        buffer.clear();
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 步骤2：构建 HTTP 请求</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> buildStreamLoadUrl();
            <span class="hljs-type">HttpURLConnection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> (HttpURLConnection) <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url).openConnection();
            
            <span class="hljs-comment">// 步骤3：设置请求方法和认证</span>
            conn.setRequestMethod(<span class="hljs-string">"PUT"</span>);
            conn.setDoOutput(<span class="hljs-literal">true</span>);
            conn.setConnectTimeout(<span class="hljs-number">30000</span>);
            conn.setReadTimeout(<span class="hljs-number">30000</span>);
            
            <span class="hljs-comment">// 设置 Basic Auth</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">auth</span> <span class="hljs-operator">=</span> Base64.getEncoder().encodeToString(
                (username + <span class="hljs-string">":"</span> + password).getBytes()
            );
            conn.setRequestProperty(<span class="hljs-string">"Authorization"</span>, <span class="hljs-string">"Basic "</span> + auth);
            
            <span class="hljs-comment">// 步骤4：设置 Stream Load 参数</span>
            conn.setRequestProperty(<span class="hljs-string">"Expect"</span>, <span class="hljs-string">"100-continue"</span>);
            conn.setRequestProperty(<span class="hljs-string">"label"</span>, generateLabel());  <span class="hljs-comment">// 唯一的 Label</span>
            conn.setRequestProperty(<span class="hljs-string">"format"</span>, <span class="hljs-string">"json"</span>);          <span class="hljs-comment">// JSON 格式</span>
            conn.setRequestProperty(<span class="hljs-string">"read_json_by_line"</span>, <span class="hljs-string">"true"</span>); <span class="hljs-comment">// 逐行读取</span>
            <span class="hljs-comment">// 可选：其他参数</span>
            <span class="hljs-comment">// conn.setRequestProperty("columns", "col1,col2,col3");</span>
            <span class="hljs-comment">// conn.setRequestProperty("timeout", "30");</span>
            <span class="hljs-comment">// conn.setRequestProperty("max_filter_ratio", "0.1");</span>
            
            <span class="hljs-comment">// 步骤5：写入数据</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> String.join(<span class="hljs-string">"\n"</span>, dataToFlush);
            <span class="hljs-type">byte</span>[] dataBytes = data.getBytes(<span class="hljs-string">"UTF-8"</span>);
            conn.setRequestProperty(<span class="hljs-string">"Content-Length"</span>, String.valueOf(dataBytes.length));
            
            <span class="hljs-keyword">try</span> (<span class="hljs-type">OutputStream</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> conn.getOutputStream()) {
                os.write(dataBytes);
                os.flush();
            }
            
            <span class="hljs-comment">// 步骤6：读取响应</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">responseCode</span> <span class="hljs-operator">=</span> conn.getResponseCode();
            <span class="hljs-type">String</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> readResponse(conn);
            
            <span class="hljs-comment">// 步骤7：解析响应（JSON 格式）</span>
            <span class="hljs-comment">// {</span>
            <span class="hljs-comment">//   "TxnId": 3,</span>
            <span class="hljs-comment">//   "Label": "123",</span>
            <span class="hljs-comment">//   "Status": "Success",</span>
            <span class="hljs-comment">//   "Message": "OK",</span>
            <span class="hljs-comment">//   "NumberLoadedRows": 10,</span>
            <span class="hljs-comment">//   "NumberFilteredRows": 0,</span>
            <span class="hljs-comment">//   "LoadBytes": 118,</span>
            <span class="hljs-comment">//   "LoadTimeMs": 173</span>
            <span class="hljs-comment">// }</span>
            
            <span class="hljs-keyword">if</span> (responseCode == <span class="hljs-number">200</span>) {
                <span class="hljs-type">StreamLoadResponse</span> <span class="hljs-variable">loadResponse</span> <span class="hljs-operator">=</span> parseResponse(response);
                
                <span class="hljs-keyword">if</span> (<span class="hljs-string">"Success"</span>.equals(loadResponse.status)) {
                    LOG.info(<span class="hljs-string">"StreamLoad 成功 - Label: {}, 行数: {}, 耗时: {}ms"</span>,
                        loadResponse.label, loadResponse.numberLoadedRows, loadResponse.loadTimeMs);
                    successCounter.inc();
                    totalRowsCounter.inc(loadResponse.numberLoadedRows);
                    lastFlushTime = System.currentTimeMillis();
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">"Label Already Exists"</span>.equals(loadResponse.status)) {
                    <span class="hljs-comment">// 幂等：Label 已存在，视为成功</span>
                    LOG.info(<span class="hljs-string">"Label {} 已存在，幂等返回成功"</span>, loadResponse.label);
                    successCounter.inc();
                    totalRowsCounter.inc(loadResponse.numberLoadedRows);
                    lastFlushTime = System.currentTimeMillis();
                } <span class="hljs-keyword">else</span> {
                    LOG.error(<span class="hljs-string">"StreamLoad 失败 - Status: {}, Message: {}"</span>,
                        loadResponse.status, loadResponse.message);
                    failureCounter.inc();
                    <span class="hljs-comment">// 根据业务需求选择：重新缓冲重试或直接丢弃</span>
                }
            } <span class="hljs-keyword">else</span> {
                LOG.error(<span class="hljs-string">"HTTP 请求失败 - 状态码: {}, 响应: {}"</span>, responseCode, response);
                failureCounter.inc();
            }
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            LOG.error(<span class="hljs-string">"StreamLoad 异常"</span>, e);
            failureCounter.inc();
            <span class="hljs-comment">// 根据业务需求抛出异常或继续</span>
            <span class="hljs-keyword">throw</span> e;
        }
    }
    
    <span class="hljs-comment">/**
     * 构建 Stream Load URL
     * 格式：http://fe_host:fe_port/api/{database}/{table}/_stream_load
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">buildStreamLoadUrl</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"http://%s:%d/api/%s/%s/_stream_load"</span>,
            feHost, fePort, database, table);
    }
    
    <span class="hljs-comment">/**
     * 生成全局唯一的 Label
     * 设计原则：同一批数据保证 Label 相同（幂等），不同批次 Label 不同
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">generateLabel</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 方案1：使用时间戳 + UUID（每次都不同）</span>
        <span class="hljs-comment">// 这样每次提交都是新的 Label</span>
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%s_%s_%d_%s"</span>,
            database,
            table,
            System.currentTimeMillis(),
            UUID.randomUUID().toString().substring(<span class="hljs-number">0</span>, <span class="hljs-number">8</span>)
        );
        
        <span class="hljs-comment">// 方案2：如果需要幂等重试</span>
        <span class="hljs-comment">// 可以基于 Checkpoint ID 生成 Label</span>
        <span class="hljs-comment">// 这样同一 Checkpoint 的重试会产生相同 Label</span>
    }
    
    <span class="hljs-comment">/**
     * 读取 HTTP 响应体
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">readResponse</span><span class="hljs-params">(HttpURLConnection conn)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-type">int</span> <span class="hljs-variable">responseCode</span> <span class="hljs-operator">=</span> conn.getResponseCode();
        <span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> (responseCode == <span class="hljs-number">200</span>) ?
            conn.getInputStream() : conn.getErrorStream();
        
        <span class="hljs-keyword">if</span> (is == <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> <span class="hljs-string">""</span>;
        
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>();
        <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(is, <span class="hljs-string">"UTF-8"</span>))) {
            String line;
            <span class="hljs-keyword">while</span> ((line = reader.readLine()) != <span class="hljs-literal">null</span>) {
                response.append(line);
            }
        }
        <span class="hljs-keyword">return</span> response.toString();
    }
    
    <span class="hljs-comment">/**
     * 解析 Stream Load 响应
     */</span>
    <span class="hljs-keyword">private</span> StreamLoadResponse <span class="hljs-title function_">parseResponse</span><span class="hljs-params">(String jsonResponse)</span> {
        <span class="hljs-comment">// 简化实现，实际应使用 JSON 解析库（如 Jackson）</span>
        <span class="hljs-type">StreamLoadResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StreamLoadResponse</span>();
        
        <span class="hljs-comment">// 使用 Jackson 解析</span>
        <span class="hljs-keyword">try</span> {
            com.fasterxml.jackson.databind.<span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span>
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">com</span>.fasterxml.jackson.databind.ObjectMapper();
            Map&lt;String, Object&gt; map = mapper.readValue(jsonResponse, Map.class);
            
            response.status = (String) map.get(<span class="hljs-string">"Status"</span>);
            response.message = (String) map.get(<span class="hljs-string">"Message"</span>);
            response.label = (String) map.get(<span class="hljs-string">"Label"</span>);
            response.numberLoadedRows = ((Number) map.get(<span class="hljs-string">"NumberLoadedRows"</span>)).longValue();
            response.loadTimeMs = ((Number) map.get(<span class="hljs-string">"LoadTimeMs"</span>)).longValue();
        } <span class="hljs-keyword">catch</span> (Exception e) {
            LOG.error(<span class="hljs-string">"解析响应失败"</span>, e);
        }
        
        <span class="hljs-keyword">return</span> response;
    }
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 最后一次刷新</span>
        <span class="hljs-keyword">if</span> (!buffer.isEmpty()) {
            flush();
        }
        
        <span class="hljs-comment">// 关闭定时任务</span>
        <span class="hljs-keyword">if</span> (scheduler != <span class="hljs-literal">null</span>) {
            scheduler.shutdown();
            scheduler.awaitTermination(<span class="hljs-number">10</span>, TimeUnit.SECONDS);
        }
        
        <span class="hljs-built_in">super</span>.close();
    }
    
    <span class="hljs-comment">/**
     * Stream Load 响应数据模型
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StreamLoadResponse</span> {
        String status;
        String message;
        String label;
        <span class="hljs-type">long</span> numberLoadedRows;
        <span class="hljs-type">long</span> loadTimeMs;
    }
}
</code></pre>
<p><strong>Flink DataStream API 集成</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;
<span class="hljs-keyword">import</span> org.apache.flink.streaming.api.functions.sink.RichSinkFunction;
<span class="hljs-keyword">import</span> org.apache.flink.configuration.Configuration;
<span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Flink2DorisJob</span> {
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">StreamExecutionEnvironment</span> <span class="hljs-variable">env</span> <span class="hljs-operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();
        env.setParallelism(<span class="hljs-number">4</span>);
        
        <span class="hljs-comment">// 启用 Checkpoint（用于源端故障恢复）</span>
        <span class="hljs-comment">// 注意：StreamLoader 内部已保证幂等，无需 2PC</span>
        env.enableCheckpointing(<span class="hljs-number">60000</span>);
        env.getCheckpointConfig().setCheckpointingMode(CheckpointingMode.AT_LEAST_ONCE);
        
        <span class="hljs-comment">// 数据源：Kafka / 数据库 / 消息队列等</span>
        DataStream&lt;String&gt; kafkaSource = env.addSource(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">FlinkKafkaConsumer</span>&lt;&gt;(
                <span class="hljs-string">"user_events"</span>,
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleStringSchema</span>(),
                kafkaProperties()
            )
        );
        
        <span class="hljs-comment">// 转换：解析 JSON，添加时间戳</span>
        DataStream&lt;String&gt; transformed = kafkaSource
            .map(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MapFunction</span>&lt;String, String&gt;() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> String <span class="hljs-title function_">map</span><span class="hljs-params">(String value)</span> <span class="hljs-keyword">throws</span> Exception {
                    <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">mapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();
                    Map&lt;String, Object&gt; data = mapper.readValue(value, Map.class);
                    
                    <span class="hljs-comment">// 添加 Doris 所需的时间戳列</span>
                    data.put(<span class="hljs-string">"load_time"</span>, System.currentTimeMillis() / <span class="hljs-number">1000</span>);
                    
                    <span class="hljs-keyword">return</span> mapper.writeValueAsString(data);
                }
            });
        
        <span class="hljs-comment">// 添加 Sink：Doris StreamLoader</span>
        transformed.addSink(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">RichSinkFunction</span>&lt;String&gt;() {
                <span class="hljs-keyword">private</span> DorisStreamLoaderSink sink;
                
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">open</span><span class="hljs-params">(Configuration parameters)</span> <span class="hljs-keyword">throws</span> Exception {
                    sink = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DorisStreamLoaderSink</span>(
                        <span class="hljs-string">"doris-fe-1:8030;doris-fe-2:8030;doris-fe-3:8030"</span>,
                        <span class="hljs-string">"realtime_db"</span>,
                        <span class="hljs-string">"user_events"</span>,
                        <span class="hljs-string">"doris_user"</span>,
                        <span class="hljs-string">"doris_password"</span>,
                        <span class="hljs-number">50000</span>,  <span class="hljs-comment">// batchSize</span>
                        <span class="hljs-number">10000</span>   <span class="hljs-comment">// flushIntervalMs</span>
                    );
                }
                
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(String value, Context context)</span> <span class="hljs-keyword">throws</span> Exception {
                    sink.write(value);
                }
                
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
                    <span class="hljs-keyword">if</span> (sink != <span class="hljs-literal">null</span>) {
                        sink.close();
                    }
                }
            }
        );
        
        env.execute(<span class="hljs-string">"Kafka to Doris StreamLoader"</span>);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> java.util.Properties <span class="hljs-title function_">kafkaProperties</span><span class="hljs-params">()</span> {
        java.util.<span class="hljs-type">Properties</span> <span class="hljs-variable">props</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.util.Properties();
        props.setProperty(<span class="hljs-string">"bootstrap.servers"</span>, <span class="hljs-string">"kafka:9092"</span>);
        props.setProperty(<span class="hljs-string">"group.id"</span>, <span class="hljs-string">"flink_doris_group"</span>);
        props.setProperty(<span class="hljs-string">"auto.offset.reset"</span>, <span class="hljs-string">"earliest"</span>);
        <span class="hljs-keyword">return</span> props;
    }
}
</code></pre>
<p><strong>性能对比</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">┌─────────────────┬──────────────┬──────────────┬──────────────┐
│ 指标            │ 官方 2PC      │ Label 分批    │ StreamLoader  │
├─────────────────┼──────────────┼──────────────┼──────────────┤
│ 吞吐量          │ 20K rows/s   │ 300K rows/s  │ 500K rows/s   │
│ P99 延迟        │ ~10min       │ ~15sec       │ ~5sec         │
│ 一致性保证      │ Exactly-Once │ At-Most-Once │ At-Most-Once* │
│ 实现复杂度      │ 低           │ 中           │ 低            │
│ 资源占用        │ 高 (GC频繁)  │ 低           │ 低            │
│ 故障恢复        │ 自动         │ 手动         │ 自动*         │
│ 网络往返        │ 2 次/batch   │ 1 次/batch   │ 1 次/batch    │
└─────────────────┴──────────────┴──────────────┴──────────────┘

* StreamLoader 在 Flink Checkpoint 配合下，可实现 Exactly-Once
</code></pre>
<hr/>
<h2 data-id="heading-8">第三部分：表模型设计</h2>
<h3 data-id="heading-9">3.1 适配的表模型</h3>
<p><strong>方案适用条件</strong>（使用 Append-Only 明细表）：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ✅ 完全适配：事件明细表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_events (
    event_id <span class="hljs-type">BIGINT</span>,
    user_id <span class="hljs-type">BIGINT</span>,
    event_type <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
    event_time DATETIME,
    event_data STRING,
    load_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
) ENGINE<span class="hljs-operator">=</span>OLAP
<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span>(event_time) (
    <span class="hljs-keyword">PARTITION</span> p_20231201 <span class="hljs-keyword">VALUES</span> LESS THAN ("2023-12-02"),
    <span class="hljs-keyword">PARTITION</span> p_20231202 <span class="hljs-keyword">VALUES</span> LESS THAN ("2023-12-03"),
    <span class="hljs-comment">-- ... 按日期自动分区</span>
)
DISTRIBUTED <span class="hljs-keyword">BY</span> HASH(user_id) BUCKETS <span class="hljs-number">32</span>
PROPERTIES (
    "replication_num" <span class="hljs-operator">=</span> "2",
    "storage_type" <span class="hljs-operator">=</span> "COLUMN"
);

<span class="hljs-comment">-- ✅ 完全适配：订单流水表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> order_stream (
    order_id <span class="hljs-type">BIGINT</span>,
    user_id <span class="hljs-type">BIGINT</span>,
    sku_id <span class="hljs-type">BIGINT</span>,
    quantity <span class="hljs-type">INT</span>,
    amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>),
    status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
    created_time DATETIME,
    load_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
) ENGINE<span class="hljs-operator">=</span>OLAP
<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span>(created_time)
DISTRIBUTED <span class="hljs-keyword">BY</span> HASH(order_id) BUCKETS <span class="hljs-number">64</span>
PROPERTIES ("replication_num" <span class="hljs-operator">=</span> "2");

<span class="hljs-comment">-- ❌ 不适配：需要 UPDATE 的维度表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_dim (
    user_id <span class="hljs-type">BIGINT</span>,
    user_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),
    age <span class="hljs-type">INT</span>,
    status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
    update_time DATETIME
) ENGINE<span class="hljs-operator">=</span>OLAP
<span class="hljs-comment">-- StreamLoader 无法处理此类表的 UPDATE 操作</span>

<span class="hljs-comment">-- ❌ 不适配：聚合表（包含 SUM/COUNT 等聚合函数）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_daily_agg (
    stat_date <span class="hljs-type">DATE</span>,
    user_id <span class="hljs-type">BIGINT</span>,
    event_count <span class="hljs-type">BIGINT</span> SUM,
    total_amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">12</span>, <span class="hljs-number">2</span>) SUM,
    updated_at DATETIME
) ENGINE<span class="hljs-operator">=</span>OLAP
AGGREGATE KEY (stat_date, user_id)
<span class="hljs-comment">-- 需要使用 UPDATE 更新聚合值</span>
</code></pre>
<h3 data-id="heading-10">3.2 表设计最佳实践</h3>
<p>为了适配 StreamLoader 的高吞吐量特性，建议：</p>
<p><strong>1. 使用"时间分区"提升查询性能</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_events (
    event_id <span class="hljs-type">BIGINT</span>,
    user_id <span class="hljs-type">BIGINT</span>,
    event_time DATETIME,
    <span class="hljs-comment">-- ... 其他字段</span>
) ENGINE<span class="hljs-operator">=</span>OLAP
<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span>(event_time) (
    <span class="hljs-keyword">PARTITION</span> p_20231201 <span class="hljs-keyword">VALUES</span> LESS THAN ("2023-12-02"),
    <span class="hljs-keyword">PARTITION</span> p_20231202 <span class="hljs-keyword">VALUES</span> LESS THAN ("2023-12-03"),
    <span class="hljs-keyword">PARTITION</span> p_20231203 <span class="hljs-keyword">VALUES</span> LESS THAN ("2023-12-04")
)
DISTRIBUTED <span class="hljs-keyword">BY</span> HASH(user_id) BUCKETS <span class="hljs-number">32</span>;

<span class="hljs-comment">-- 优势：</span>
<span class="hljs-comment">-- 1. 新数据总是落在最新分区，避免小文件问题</span>
<span class="hljs-comment">-- 2. 历史数据可独立压缩，提升查询性能</span>
<span class="hljs-comment">-- 3. 可自动清理过期分区</span>
</code></pre>
<p><strong>2. 合理设置 Bucket 数量</strong>（关系到 StreamLoader 并行度）：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Bucket 数量建议 = (目标吞吐量 / 单个 BE 的处理速度) × BE 数量</span>
<span class="hljs-comment"># 举例：目标 500K rows/s，单 BE 100K rows/s，3 个 BE</span>
<span class="hljs-comment"># Bucket 数 = (500K / 100K) × 3 = 15，建议设置 16-32</span>

<span class="hljs-comment"># 对于高并发小批量场景，可设置更多 Bucket：</span>
DISTRIBUTED BY HASH(user_id) BUCKETS <span class="hljs-number">128</span>  <span class="hljs-comment"># 适合 Flink 高并行度</span>
</code></pre>
<p><strong>3. 使用"复合键"优化数据重排</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 不推荐：低效的随机分布</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> events (
    event_id <span class="hljs-type">BIGINT</span>,
    data STRING
) ENGINE<span class="hljs-operator">=</span>OLAP
DISTRIBUTED <span class="hljs-keyword">BY</span> HASH(event_id) BUCKETS <span class="hljs-number">32</span>;

<span class="hljs-comment">-- 推荐：按用户维度分布（便于后续按用户统计）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> events (
    event_id <span class="hljs-type">BIGINT</span>,
    user_id <span class="hljs-type">BIGINT</span>,
    event_type <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
    data STRING
) ENGINE<span class="hljs-operator">=</span>OLAP
DISTRIBUTED <span class="hljs-keyword">BY</span> HASH(user_id) BUCKETS <span class="hljs-number">32</span>;

<span class="hljs-comment">-- 更好：多维分布（如果后续按用户和时间都需要统计）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> events (
    event_id <span class="hljs-type">BIGINT</span>,
    user_id <span class="hljs-type">BIGINT</span>,
    event_time DATETIME,
    event_type <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>)
) ENGINE<span class="hljs-operator">=</span>OLAP
<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span>(event_time)
DISTRIBUTED <span class="hljs-keyword">BY</span> HASH(user_id) BUCKETS <span class="hljs-number">32</span>;
</code></pre>
<hr/>
<h2 data-id="heading-11">第四部分：部署与监控</h2>
<h3 data-id="heading-12">4.1 部署架构</h3>
<pre><code class="hljs language-arduino" lang="arduino">┌─────────────────────────────────────────────────────┐
│                  Kafka / Source                     │
├─────────────────────────────────────────────────────┘
                      │
                      ▼
        ┌──────────────────────────────┐
        │   Flink Cluster              │
        │   (<span class="hljs-number">4</span> TaskManager)            │
        │                              │
        │  ┌──────────────────────┐    │
        │  │ <span class="hljs-built_in">Task</span> <span class="hljs-number">1</span>: StreamLoader │    │ ← 并行度 <span class="hljs-number">4</span>
        │  ├──────────────────────┤    │   (<span class="hljs-number">4</span> 个 Sink 实例)
        │  │ <span class="hljs-built_in">Task</span> <span class="hljs-number">2</span>: StreamLoader │    │
        │  ├──────────────────────┤    │
        │  │ <span class="hljs-built_in">Task</span> <span class="hljs-number">3</span>: StreamLoader │    │
        │  ├──────────────────────┤    │
        │  │ <span class="hljs-built_in">Task</span> <span class="hljs-number">4</span>: StreamLoader │    │
        │  └──────────────────────┘    │
        └──────────────────────────────┘
                      │
        ┌─────────────┼─────────────┐
        ▼             ▼             ▼
    ┌─────────┐  ┌─────────┐  ┌─────────┐
    │ BE 节点<span class="hljs-number">1</span>│  │ BE 节点<span class="hljs-number">2</span>│  │ BE 节点<span class="hljs-number">3</span>│
    │ (写入) │  │ (写入) │  │ (写入) │
    └─────────┘  └─────────┘  └─────────┘
        │             │             │
        └─────────────┼─────────────┘
                      ▼
            ┌───────────────────┐
            │   Doris 存储      │
            │ (OlapTable)       │
            │ (user_events)     │
            └───────────────────┘
</code></pre>
<h3 data-id="heading-13">4.2 关键监控指标</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># Flink Metrics 定义</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">StreamLoaderSinkMetrics</span>:
    <span class="hljs-string">"""
    监控 StreamLoader Sink 的关键指标
    """</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, metrics_group</span>):
        <span class="hljs-comment"># 1. 吞吐量指标</span>
        self.rows_received = metrics_group.counter(<span class="hljs-string">"rows_received"</span>)
        self.rows_loaded = metrics_group.counter(<span class="hljs-string">"rows_loaded"</span>)
        self.rows_failed = metrics_group.counter(<span class="hljs-string">"rows_failed"</span>)
        
        <span class="hljs-comment"># 2. 延迟指标</span>
        self.load_latency_ms = metrics_group.histogram(
            <span class="hljs-string">"load_latency_ms"</span>,
            histogram_stat_size=<span class="hljs-number">100</span>
        )
        
        <span class="hljs-comment"># 3. 批次指标</span>
        self.batch_size = metrics_group.histogram(<span class="hljs-string">"batch_size"</span>)
        self.flush_count = metrics_group.counter(<span class="hljs-string">"flush_count"</span>)
        
        <span class="hljs-comment"># 4. 错误指标</span>
        self.load_failures = metrics_group.counter(<span class="hljs-string">"load_failures"</span>)
        self.label_conflicts = metrics_group.counter(<span class="hljs-string">"label_conflicts"</span>)
        
        <span class="hljs-comment"># 5. 缓冲区状态</span>
        self.buffer_size = metrics_group.gauge(<span class="hljs-string">"buffer_size"</span>, <span class="hljs-keyword">lambda</span>: self.current_buffer_size)
        self.buffer_memory_mb = metrics_group.gauge(
            <span class="hljs-string">"buffer_memory_mb"</span>,
            <span class="hljs-keyword">lambda</span>: self.current_buffer_memory / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>
        )

<span class="hljs-comment"># 监控告警规则示例</span>
alerts = [
    {
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"高缺货率"</span>,
        <span class="hljs-string">"condition"</span>: <span class="hljs-string">"rows_failed / rows_received &gt; 0.01"</span>,  <span class="hljs-comment"># 失败率 &gt; 1%</span>
        <span class="hljs-string">"severity"</span>: <span class="hljs-string">"warning"</span>
    },
    {
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"加载延迟过高"</span>,
        <span class="hljs-string">"condition"</span>: <span class="hljs-string">"load_latency_ms.p99 &gt; 30000"</span>,  <span class="hljs-comment"># P99 延迟 &gt; 30s</span>
        <span class="hljs-string">"severity"</span>: <span class="hljs-string">"warning"</span>
    },
    {
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"缓冲区溢出"</span>,
        <span class="hljs-string">"condition"</span>: <span class="hljs-string">"buffer_size &gt; 1000000"</span>,  <span class="hljs-comment"># 缓冲记录数 &gt; 100 万</span>
        <span class="hljs-string">"severity"</span>: <span class="hljs-string">"critical"</span>
    },
    {
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"Label 冲突频繁"</span>,
        <span class="hljs-string">"condition"</span>: <span class="hljs-string">"label_conflicts &gt; 10 per minute"</span>,
        <span class="hljs-string">"severity"</span>: <span class="hljs-string">"error"</span>
    }
]
</code></pre>
<h3 data-id="heading-14">4.3 故障排查</h3>



































<table><thead><tr><th>症状</th><th>可能原因</th><th>排查步骤</th></tr></thead><tbody><tr><td><strong>加载失败 (Status != SUCCESS)</strong></td><td>BE 磁盘满、Doris 内部错误</td><td>1. 检查 BE 日志 2. 检查磁盘空间 3. 重启 BE</td></tr><tr><td><strong>Label 冲突</strong></td><td>并行度过高，Label 生成冲突</td><td>1. 降低并行度 2. 优化 Label 生成算法</td></tr><tr><td><strong>内存溢出 (OOM)</strong></td><td>批量大小设置过大</td><td>1. 减小 <code>batchSize</code> 参数 2. 增加 JVM 堆内存</td></tr><tr><td><strong>吞吐量低于预期</strong></td><td>网络瓶颈、Doris 写入饱和</td><td>1. 检查网络延迟 2. 增加 Doris BE 数量</td></tr><tr><td><strong>数据重复</strong></td><td>Label 去重失败</td><td>1. 检查 Doris Label TTL 设置 2. 检查时钟同步</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-15">第五部分：完整案例</h2>
<h3 data-id="heading-16">5.1 案例背景</h3>
<p>某电商平台需要将 <strong>用户行为事件日志</strong> 从 Kafka 实时同步到 Doris，用于构建实时看板。</p>
<p><strong>数据特征</strong>：</p>
<ul>
<li><strong>日均数据量</strong>：1 亿条事件</li>
<li><strong>实时延迟要求</strong>：&lt; 10 秒</li>
<li><strong>吞吐量</strong>：1,150 rows/sec（均匀分布）</li>
<li><strong>并发度</strong>：4 个 Kafka partition</li>
</ul>
<h3 data-id="heading-17">5.2 表设计</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- Doris 目标表：user_behavior_events</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_behavior_events (
    event_id <span class="hljs-type">BIGINT</span> COMMENT <span class="hljs-string">'事件ID'</span>,
    user_id <span class="hljs-type">BIGINT</span> COMMENT <span class="hljs-string">'用户ID'</span>,
    event_type <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) COMMENT <span class="hljs-string">'事件类型：browse/click/add_cart/purchase'</span>,
    product_id <span class="hljs-type">BIGINT</span> COMMENT <span class="hljs-string">'商品ID'</span>,
    amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>) COMMENT <span class="hljs-string">'交易额'</span>,
    event_time DATETIME COMMENT <span class="hljs-string">'事件发生时间'</span>,
    load_time DATETIME <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> COMMENT <span class="hljs-string">'数据加载时间'</span>,
    
    INDEX idx_user_id (user_id) <span class="hljs-keyword">USING</span> BITMAP COMMENT <span class="hljs-string">'用户维度索引'</span>
) ENGINE<span class="hljs-operator">=</span>OLAP
<span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span>(event_time) (
    <span class="hljs-keyword">PARTITION</span> p_latest <span class="hljs-keyword">VALUES</span> LESS THAN MAXVALUE
)
DISTRIBUTED <span class="hljs-keyword">BY</span> HASH(user_id) BUCKETS <span class="hljs-number">64</span>
PROPERTIES (
    "replication_num" <span class="hljs-operator">=</span> "2",
    "storage_type" <span class="hljs-operator">=</span> "COLUMN",
    "compression" <span class="hljs-operator">=</span> "LZ4"
);

<span class="hljs-comment">-- 自动分区脚本（每天自动创建新分区）</span>
<span class="hljs-comment">-- 可通过 Doris FE 的调度器实现</span>
</code></pre>
<h3 data-id="heading-18">5.3 Flink 作业代码</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserBehaviorEventsJob</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">LOG</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(UserBehaviorEventsJob.class);
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 1. 环境配置</span>
        <span class="hljs-keyword">final</span> <span class="hljs-type">StreamExecutionEnvironment</span> <span class="hljs-variable">env</span> <span class="hljs-operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();
        env.setParallelism(<span class="hljs-number">4</span>);  <span class="hljs-comment">// 与 Kafka partition 数对齐</span>
        
        <span class="hljs-keyword">final</span> <span class="hljs-type">StreamingRuntimeContext</span> <span class="hljs-variable">runtimeContext</span> <span class="hljs-operator">=</span> (StreamingRuntimeContext) env.getConfig();
        
        <span class="hljs-comment">// 2. Checkpoint 配置（用于源端故障恢复）</span>
        env.enableCheckpointing(<span class="hljs-number">60000</span>);  <span class="hljs-comment">// 60s checkpoint</span>
        env.getCheckpointConfig().setCheckpointingMode(CheckpointingMode.AT_LEAST_ONCE);
        env.getCheckpointConfig().setMinPauseBetweenCheckpoints(<span class="hljs-number">30000</span>);
        env.getCheckpointConfig().setCheckpointTimeout(<span class="hljs-number">600000</span>);  <span class="hljs-comment">// 10min timeout</span>
        env.getCheckpointConfig().setMaxConcurrentCheckpoints(<span class="hljs-number">1</span>);
        
        <span class="hljs-comment">// 3. 数据源：Kafka</span>
        KafkaSource&lt;String&gt; kafkaSource = KafkaSource.builder()
            .setBootstrapServers(<span class="hljs-string">"kafka1:9092,kafka2:9092,kafka3:9092"</span>)
            .setTopics(<span class="hljs-string">"user_behavior_events"</span>)
            .setGroupId(<span class="hljs-string">"flink_to_doris_group"</span>)
            .setStartingOffsets(OffsetsInitializer.earliest())
            .setValueOnlyDeserializer(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleStringSchema</span>())
            .build();
        
        DataStream&lt;String&gt; kafkaStream = env.fromSource(kafkaSource, WatermarkStrategy.noWatermarks(), <span class="hljs-string">"Kafka Source"</span>);
        
        <span class="hljs-comment">// 4. 数据转换：JSON 解析 + 字段映射</span>
        DataStream&lt;BehaviorEvent&gt; eventStream = kafkaStream
            .map(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RichMapFunction</span>&lt;String, BehaviorEvent&gt;() {
                <span class="hljs-keyword">private</span> ObjectMapper objectMapper;
                <span class="hljs-keyword">private</span> Counter parseErrorCounter;
                
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">open</span><span class="hljs-params">(Configuration parameters)</span> <span class="hljs-keyword">throws</span> Exception {
                    <span class="hljs-built_in">this</span>.objectMapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();
                    <span class="hljs-type">MetricGroup</span> <span class="hljs-variable">metricGroup</span> <span class="hljs-operator">=</span> getRuntimeContext().getMetricGroup();
                    <span class="hljs-built_in">this</span>.parseErrorCounter = metricGroup.counter(<span class="hljs-string">"parse_error"</span>);
                }
                
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> BehaviorEvent <span class="hljs-title function_">map</span><span class="hljs-params">(String value)</span> <span class="hljs-keyword">throws</span> Exception {
                    <span class="hljs-keyword">try</span> {
                        Map&lt;String, Object&gt; data = objectMapper.readValue(value, Map.class);
                        
                        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BehaviorEvent</span>(
                            (<span class="hljs-type">long</span>) data.getOrDefault(<span class="hljs-string">"event_id"</span>, <span class="hljs-number">0L</span>),
                            (<span class="hljs-type">long</span>) data.getOrDefault(<span class="hljs-string">"user_id"</span>, <span class="hljs-number">0L</span>),
                            (String) data.get(<span class="hljs-string">"event_type"</span>),
                            (<span class="hljs-type">long</span>) data.getOrDefault(<span class="hljs-string">"product_id"</span>, <span class="hljs-number">0L</span>),
                            Double.parseDouble(data.getOrDefault(<span class="hljs-string">"amount"</span>, <span class="hljs-string">"0"</span>).toString()),
                            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Timestamp</span>(System.currentTimeMillis())
                        );
                    } <span class="hljs-keyword">catch</span> (Exception e) {
                        parseErrorCounter.inc();
                        LOG.error(<span class="hljs-string">"Failed to parse event: {}"</span>, value, e);
                        <span class="hljs-keyword">throw</span> e;
                    }
                }
            });
        
        <span class="hljs-comment">// 5. 添加 Sink：Doris StreamLoader</span>
        eventStream.addSink(
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">RichSinkFunction</span>&lt;BehaviorEvent&gt;() {
                <span class="hljs-keyword">private</span> DorisStreamLoaderSink streamLoaderSink;
                <span class="hljs-keyword">private</span> ObjectMapper objectMapper;
                <span class="hljs-keyword">private</span> Counter loadSuccessCounter;
                <span class="hljs-keyword">private</span> Counter loadFailureCounter;
                <span class="hljs-keyword">private</span> Histogram loadLatencyHistogram;
                
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">open</span><span class="hljs-params">(Configuration parameters)</span> <span class="hljs-keyword">throws</span> Exception {
                    <span class="hljs-comment">// 初始化 StreamLoader</span>
                    <span class="hljs-built_in">this</span>.streamLoaderSink = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DorisStreamLoaderSink</span>(
                        <span class="hljs-string">"doris-fe1:8030;doris-fe2:8030;doris-fe3:8030"</span>,
                        <span class="hljs-string">"analytics_db"</span>,
                        <span class="hljs-string">"user_behavior_events"</span>,
                        <span class="hljs-string">"doris_user"</span>,
                        <span class="hljs-string">"doris_password"</span>,
                        <span class="hljs-number">50000</span>,   <span class="hljs-comment">// batchSize: 每 5 万条或 10s 触发一次提交</span>
                        <span class="hljs-number">10000</span>    <span class="hljs-comment">// flushIntervalMs: 10 秒</span>
                    );
                    
                    <span class="hljs-built_in">this</span>.objectMapper = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();
                    
                    <span class="hljs-comment">// 初始化监控指标</span>
                    <span class="hljs-type">MetricGroup</span> <span class="hljs-variable">metricGroup</span> <span class="hljs-operator">=</span> getRuntimeContext().getMetricGroup();
                    <span class="hljs-built_in">this</span>.loadSuccessCounter = metricGroup.counter(<span class="hljs-string">"load_success"</span>);
                    <span class="hljs-built_in">this</span>.loadFailureCounter = metricGroup.counter(<span class="hljs-string">"load_failure"</span>);
                    <span class="hljs-built_in">this</span>.loadLatencyHistogram = metricGroup.histogram(
                        <span class="hljs-string">"load_latency_ms"</span>,
                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">DescriptiveStatisticsHistogram</span>(<span class="hljs-number">100</span>)
                    );
                }
                
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(BehaviorEvent event, Context context)</span> <span class="hljs-keyword">throws</span> Exception {
                    <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-comment">// 转换为 JSON 并写入</span>
                        <span class="hljs-type">String</span> <span class="hljs-variable">jsonRecord</span> <span class="hljs-operator">=</span> objectMapper.writeValueAsString(event);
                        streamLoaderSink.write(jsonRecord);
                        loadSuccessCounter.inc();
                    } <span class="hljs-keyword">catch</span> (Exception e) {
                        loadFailureCounter.inc();
                        LOG.error(<span class="hljs-string">"Failed to load event: {}"</span>, event, e);
                        <span class="hljs-comment">// 根据业务需求选择：丢弃或重抛</span>
                        <span class="hljs-keyword">throw</span> e;
                    } <span class="hljs-keyword">finally</span> {
                        <span class="hljs-type">long</span> <span class="hljs-variable">latency</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - startTime;
                        loadLatencyHistogram.update(latency);
                    }
                }
                
                <span class="hljs-meta">@Override</span>
                <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">close</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
                    <span class="hljs-keyword">if</span> (streamLoaderSink != <span class="hljs-literal">null</span>) {
                        streamLoaderSink.close();
                    }
                }
            }
        );
        
        <span class="hljs-comment">// 6. 执行</span>
        env.execute(<span class="hljs-string">"User Behavior Events to Doris"</span>);
    }
    
    <span class="hljs-comment">/**
     * 行为事件数据模型
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BehaviorEvent</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
        <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> eventId;
        <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> userId;
        <span class="hljs-keyword">public</span> String eventType;
        <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> productId;
        <span class="hljs-keyword">public</span> <span class="hljs-type">double</span> amount;
        <span class="hljs-keyword">public</span> Timestamp eventTime;
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">BehaviorEvent</span><span class="hljs-params">()</span> {}
        
        <span class="hljs-keyword">public</span> <span class="hljs-title function_">BehaviorEvent</span><span class="hljs-params">(<span class="hljs-type">long</span> eventId, <span class="hljs-type">long</span> userId, String eventType, 
                           <span class="hljs-type">long</span> productId, <span class="hljs-type">double</span> amount, Timestamp eventTime)</span> {
            <span class="hljs-built_in">this</span>.eventId = eventId;
            <span class="hljs-built_in">this</span>.userId = userId;
            <span class="hljs-built_in">this</span>.eventType = eventType;
            <span class="hljs-built_in">this</span>.productId = productId;
            <span class="hljs-built_in">this</span>.amount = amount;
            <span class="hljs-built_in">this</span>.eventTime = eventTime;
        }
    }
}
</code></pre>
<h3 data-id="heading-19">5.4 运行效果</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span> 加载成功统计 <span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>
load_success: <span class="hljs-number">100</span>,<span class="hljs-number">000</span>,<span class="hljs-number">000</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">/</span><span class="hljs-keyword">day</span>
load_failure: <span class="hljs-number">0</span> <span class="hljs-keyword">rows</span>

<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span> 性能指标 <span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>
吞吐量: <span class="hljs-number">1</span>,<span class="hljs-number">150</span> <span class="hljs-keyword">rows</span><span class="hljs-operator">/</span>sec (达成目标)
P50 延迟: <span class="hljs-number">2.3</span> sec
P99 延迟: <span class="hljs-number">8.7</span> sec (<span class="hljs-operator">&lt;</span> <span class="hljs-number">10</span>s 目标)

<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span> 资源占用 <span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>
JVM 内存: <span class="hljs-number">2</span>GB (稳定)
Flink TaskManager CPU: <span class="hljs-number">40</span><span class="hljs-operator">%</span> (<span class="hljs-number">4</span> 核)
Kafka 消费延迟: <span class="hljs-number">0</span> <span class="hljs-keyword">offset</span> (实时)

<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span> Doris 存储 <span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">=</span>
表大小: <span class="hljs-number">15</span> GB<span class="hljs-operator">/</span><span class="hljs-keyword">day</span> (压缩后)
查询延迟: <span class="hljs-operator">&lt;</span> <span class="hljs-number">100</span>ms (按用户聚合)
</code></pre>
<hr/>
<h2 data-id="heading-20">总结</h2>





























<table><thead><tr><th>方案</th><th>优点</th><th>缺点</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>官方 2PC</strong></td><td>Exactly-Once，开箱即用</td><td>吞吐量低，延迟高</td><td>对一致性有绝对要求但数据量小</td></tr><tr><td><strong>Label 分批</strong></td><td>吞吐量提升 10 倍，实现简洁</td><td>At-Most-Once，需手动重试</td><td>可容忍少量重复的实时场景</td></tr><tr><td><strong>StreamLoader</strong></td><td>吞吐量最高，内置幂等和重试</td><td>依赖 Doris 1.2.0+</td><td>生产环境，追求高性能和稳定性</td></tr></tbody></table>
<p><strong>最佳实践</strong>：</p>
<ol>
<li>使用 <strong>StreamLoader</strong> 作为标准方案</li>
<li>设置合理的 <strong>批量大小</strong>（50K-100K 行）和 <strong>刷新间隔</strong>（5-10 秒）</li>
<li>采用 <strong>明细表</strong> 表模型，避免聚合和 UPDATE</li>
<li>结合 <strong>Flink Checkpoint</strong> 保证源端故障恢复</li>
</ol>
<hr/>
<p><strong>参考资源</strong>：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdoris.apache.org%2Fzh-CN%2Fdocs%2F2.1%2Fdata-operate%2Fimport%2Fimport-way%2Fstream-load-manual" target="_blank" title="https://doris.apache.org/zh-CN/docs/2.1/data-operate/import/import-way/stream-load-manual" ref="nofollow noopener noreferrer">Doris StreamLoad 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fnightlies.apache.org%2Fflink%2Fflink-docs-release-1.17" target="_blank" title="https://nightlies.apache.org/flink/flink-docs-release-1.17" ref="nofollow noopener noreferrer">Flink DataStream API 最佳实践</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fapache%2Fdoris%2Ftree%2Fmaster%2Ftools%2Fflink-connector" target="_blank" title="https://github.com/apache/doris/tree/master/tools/flink-connector" ref="nofollow noopener noreferrer">Doris Flink Connector GitHub</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解 UITabBarController：代理方法与 ViewController 生命周期的执行顺序（含 UINavigationController 场景）]]></title>    <link>https://juejin.cn/post/7588022226739183666</link>    <guid>https://juejin.cn/post/7588022226739183666</guid>    <pubDate>2025-12-26T06:08:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588022226739183666" data-draft-id="7587704265055682598" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解 UITabBarController：代理方法与 ViewController 生命周期的执行顺序（含 UINavigationController 场景）"/> <meta itemprop="keywords" content="iOS"/> <meta itemprop="datePublished" content="2025-12-26T06:08:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="江东小bug王"/> <meta itemprop="url" content="https://juejin.cn/user/1583760376077646"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解 UITabBarController：代理方法与 ViewController 生命周期的执行顺序（含 UINavigationController 场景）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1583760376077646/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    江东小bug王
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T06:08:01.000Z" title="Fri Dec 26 2025 06:08:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 iOS 开发中，<code>UITabBarController</code> 是构建多 Tab 应用的标准容器。但很多开发者对以下问题仍模糊不清：</p>
<ul>
<li><code>tabBarController:shouldSelectViewController:</code> 和 <code>didSelectViewController:</code> 到底在什么时候调用？</li>
<li><code>tabBarController.selectedViewController</code> <strong>何时发生变化</strong>？</li>
<li>如果每个 Tab 都是 <code>UINavigationController</code>，代理拿到的是谁？生命周期又由谁接收？</li>
<li>如何准确获取“切换前”和“切换后”的<strong>业务控制器</strong>？</li>
</ul>
<p>本文将通过<strong>精确的时间线 + 状态快照 + 实战代码</strong>，彻底厘清 UITabBarController 在用户点击 Tab 时的<strong>完整执行链</strong>，助你写出精准、健壮的导航逻辑。</p>
<hr/>
<h2 data-id="heading-0">🔑 核心概念：selectedViewController 的变化时机</h2>
<p><code>UITabBarController</code> 有一个关键属性：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-keyword">@property</span>(<span class="hljs-keyword">nullable</span>, <span class="hljs-keyword">nonatomic</span>, <span class="hljs-keyword">weak</span>) <span class="hljs-built_in">UIViewController</span> *selectedViewController;
</code></pre>
<p>它的值<strong>不是在切换开始时变，而是在切换完成后才更新</strong>。这一点直接决定了你在代理中能拿到什么。</p>
<blockquote>
<p>✅ <strong>结论先行</strong>：</p>
<ul>
<li>在 <code>shouldSelectViewController:</code> 中，<code>selectedViewController</code> <strong>仍是旧的控制器</strong></li>
<li>在 <code>didSelectViewController:</code> 中，<code>selectedViewController</code> <strong>已等于新控制器</strong></li>
<li><strong>真正的赋值发生在 ViewController 转场完成之后、didSelect 调用之前</strong></li>
</ul>
</blockquote>
<p>这个特性，是实现“记录切换来源”的关键！</p>
<hr/>
<h2 data-id="heading-1">📋 一、标准执行流程（从 Tab A → Tab B）</h2>
<p>假设：</p>
<ul>
<li>当前选中的是 <strong>A 控制器</strong></li>
<li>用户点击 Tab，切换到 <strong>B 控制器</strong></li>
<li>所有 view 已加载（非首次）</li>
<li><code>tabBarController.delegate = self</code></li>
</ul>
<h3 data-id="heading-2">✅ 完整执行顺序 + selectedViewController 快照</h3>





















































<table><thead><tr><th>步骤</th><th>方法 / 事件</th><th><code>selectedViewController</code> 的值</th><th>说明</th></tr></thead><tbody><tr><td>1</td><td><code>shouldSelectViewController:(B)</code></td><td><strong>A</strong></td><td>可拦截切换；此时 B 尚未激活</td></tr><tr><td>2</td><td>A.<code>viewWillDisappear:</code></td><td>A</td><td>A 即将消失</td></tr><tr><td>3</td><td>B.<code>viewWillAppear:</code></td><td>A</td><td>B 即将出现，但 TabBar 仍认为 A 是当前页</td></tr><tr><td>4</td><td>A.<code>viewDidDisappear:</code></td><td>A</td><td>A 已消失</td></tr><tr><td>5</td><td>B.<code>viewDidAppear:</code></td><td>A</td><td>B 已显示，但 <code>selectedViewController</code> <strong>仍未更新</strong>！</td></tr><tr><td>6</td><td><strong>内部赋值</strong></td><td><strong>B</strong></td><td>UIKit 私有逻辑：<code>selectedViewController = B</code></td></tr><tr><td>7</td><td><code>didSelectViewController:(B)</code></td><td><strong>B</strong></td><td>切换完成，可安全使用新控制器</td></tr></tbody></table>
<blockquote>
<p>💡 重点：<strong><code>selectedViewController</code> 的变更发生在 <code>viewDidAppear:</code> 之后、<code>didSelect...</code> 之前</strong>。</p>
</blockquote>
<p>这意味着：</p>
<ul>
<li>你<strong>不能</strong>在 <code>viewDidAppear:</code> 中通过 <code>tabBarController.selectedViewController</code> 判断“是否刚被选中”（因为它还是旧的！）</li>
<li>但你<strong>可以</strong>在 <code>shouldSelect...</code> 中通过 <code>selectedViewController</code> 获取“切换前”的控制器</li>
</ul>
<hr/>
<h2 data-id="heading-3">📦 二、当 Tab 中是 UINavigationController 时</h2>
<p>这是最常见架构：</p>
<pre><code class="hljs language-text" lang="text">TabBarController
├── UINavigationController (rootVC of Tab 0) → HomeVC
└── UINavigationController (rootVC of Tab 1) → ProfileVC
</code></pre>
<h3 data-id="heading-4">🔄 执行流程是否改变？</h3>
<p><strong>否！顺序完全一致</strong>，但对象类型不同：</p>






























<table><thead><tr><th>阶段</th><th>普通 VC 场景</th><th>UINavigationController 场景</th></tr></thead><tbody><tr><td><code>shouldSelect...</code> 参数</td><td>HomeVC</td><td><strong>UINavigationController</strong></td></tr><tr><td><code>selectedViewController</code></td><td>HomeVC</td><td><strong>UINavigationController</strong></td></tr><tr><td>生命周期接收者</td><td>HomeVC</td><td><strong>HomeVC（Nav 的 topViewController）</strong></td></tr><tr><td><code>didSelect...</code> 参数</td><td>HomeVC</td><td><strong>UINavigationController</strong></td></tr></tbody></table>
<h3 data-id="heading-5">✅ 示例：代理中的日志</h3>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-type">BOOL</span>)tabBarController:(<span class="hljs-built_in">UITabBarController</span> *)tc shouldSelectViewController:(<span class="hljs-built_in">UIViewController</span> *)toRoot {
    <span class="hljs-built_in">UIViewController</span> *fromRoot = tc.selectedViewController; <span class="hljs-comment">// 仍是旧的 Nav</span>
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"[shouldSelect] from: %@, to: %@"</span>, 
          <span class="hljs-built_in">NSStringFromClass</span>([fromRoot <span class="hljs-keyword">class</span>]), 
          <span class="hljs-built_in">NSStringFromClass</span>([toRoot <span class="hljs-keyword">class</span>]));
    <span class="hljs-comment">// 输出：from: UINavigationController, to: UINavigationController</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
}
</code></pre>
<p>而与此同时，<strong>HomeVC 会正常收到 <code>viewWillAppear:</code></strong>，因为 UINavigationController 会自动将生命周期传递给其 topViewController。</p>
<hr/>
<h2 data-id="heading-6">🛠 三、如何正确获取“业务控制器”？</h2>
<p>由于 delegate 拿到的是 root VC（可能是 Nav），我们需要“穿透”一层。</p>
<h3 data-id="heading-7">✅ 推荐工具方法：</h3>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-built_in">UIViewController</span> *)businessViewControllerFromTabRoot:(<span class="hljs-built_in">UIViewController</span> *)root {
    <span class="hljs-keyword">if</span> ([root isKindOfClass:[<span class="hljs-built_in">UINavigationController</span> <span class="hljs-keyword">class</span>]]) {
        <span class="hljs-keyword">return</span> [(<span class="hljs-built_in">UINavigationController</span> *)root topViewController];
    }
    <span class="hljs-keyword">return</span> root;
}
</code></pre>
<h3 data-id="heading-8">应用于代理：</h3>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-type">BOOL</span>)tabBarController:(<span class="hljs-built_in">UITabBarController</span> *)tc shouldSelectViewController:(<span class="hljs-built_in">UIViewController</span> *)toRoot {
    <span class="hljs-built_in">UIViewController</span> *fromBusiness = [<span class="hljs-keyword">self</span> businessViewControllerFromTabRoot:tc.selectedViewController];
    <span class="hljs-built_in">UIViewController</span> *toBusiness   = [<span class="hljs-keyword">self</span> businessViewControllerFromTabRoot:toRoot];
    
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"从 %@ 切换到 %@"</span>, 
          <span class="hljs-built_in">NSStringFromClass</span>([fromBusiness <span class="hljs-keyword">class</span>]), 
          <span class="hljs-built_in">NSStringFromClass</span>([toBusiness <span class="hljs-keyword">class</span>]));
    
    <span class="hljs-comment">// 缓存“切换前”用于 didSelect</span>
    <span class="hljs-keyword">self</span>.previousBusinessVC = fromBusiness;
    
    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
}

- (<span class="hljs-type">void</span>)tabBarController:(<span class="hljs-built_in">UITabBarController</span> *)tc didSelectViewController:(<span class="hljs-built_in">UIViewController</span> *)toRoot {
    <span class="hljs-built_in">UIViewController</span> *toBusiness = [<span class="hljs-keyword">self</span> businessViewControllerFromTabRoot:toRoot];
    <span class="hljs-built_in">UIViewController</span> *fromBusiness = <span class="hljs-keyword">self</span>.previousBusinessVC;
    
    [Analytics logTabSwitchFrom:fromBusiness to:toBusiness];
}
</code></pre>
<blockquote>
<p>⚠️ 注意：不要在 <code>didSelect...</code> 中再读 <code>tc.selectedViewController</code> 来获取“from”，因为它已经是 <code>to</code> 了！</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">⚠️ 四、特殊场景深度解析</h2>
<h3 data-id="heading-10">1. <strong>重复点击当前 Tab（A → A）</strong></h3>
<ul>
<li>✅ <code>shouldSelectViewController:</code> 被调用，<code>selectedViewController == toRoot</code></li>
<li>❌ <strong>不触发任何生命周期方法</strong></li>
<li>❌ <strong>不调用 <code>didSelectViewController:</code></strong></li>
<li>❌ <strong>不会修改 <code>selectedViewController</code>（本来就是它）</strong></li>
</ul>
<p>✅ 用途：实现“回到顶部”、“刷新当前页”</p>
<pre><code class="hljs language-objc" lang="objc">- (<span class="hljs-type">BOOL</span>)tabBarController:(<span class="hljs-built_in">UITabBarController</span> *)tc shouldSelectViewController:(<span class="hljs-built_in">UIViewController</span> *)vc {
    <span class="hljs-keyword">if</span> (vc == tc.selectedViewController) {
        <span class="hljs-keyword">if</span> ([vc isKindOfClass:[<span class="hljs-built_in">UINavigationController</span> <span class="hljs-keyword">class</span>]]) {
            [(<span class="hljs-built_in">UINavigationController</span> *)vc popToRootViewControllerAnimated:<span class="hljs-literal">YES</span>];
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">NO</span>; <span class="hljs-comment">// 语义上“不需要切换”</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
}
</code></pre>
<h3 data-id="heading-11">2. <strong>通过代码切换 Tab（如 <code>selectedIndex = 1</code>）</strong></h3>
<ul>
<li>❌ <strong>不触发任何 delegate 方法</strong></li>
<li>✅ 但会触发 ViewController 生命周期</li>
<li>✅ <code>selectedViewController</code> 会立即更新</li>
</ul>
<blockquote>
<p>所以：<strong>delegate 方法仅由用户点击 TabBar 触发</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-12">📌 五、开发最佳实践总结</h2>








































<table><thead><tr><th>需求</th><th>推荐位置</th><th>注意事项</th></tr></thead><tbody><tr><td>获取“切换前”的控制器</td><td><code>shouldSelect...</code> 中读 <code>selectedViewController</code></td><td>需解包 UINavigationController</td></tr><tr><td>获取“切换后”的控制器</td><td><code>didSelect...</code> 的参数 或 <code>selectedViewController</code></td><td>两者此时相等</td></tr><tr><td>刷新数据</td><td>业务 VC 的 <code>viewWillAppear:</code></td><td>不要放 viewDidLoad</td></tr><tr><td>埋点 / 日志</td><td><code>didSelect...</code></td><td>确保切换已完成</td></tr><tr><td>拦截切换</td><td><code>shouldSelect...</code> 返回 NO</td><td>可用于权限控制</td></tr><tr><td>处理重复点击</td><td><code>shouldSelect...</code> 中判断 <code>vc == selectedViewController</code></td><td>可手动触发逻辑</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-13">✅ 六、终极流程图（含状态快照）</h2>
<pre><code class="hljs language-ini" lang="ini">用户点击 Tab B
        ↓
<span class="hljs-section">[Delegate]</span> shouldSelectViewController:(B_root)
    → <span class="hljs-attr">selectedViewController</span> == A_root ✅
        ↓
<span class="hljs-section">[A_business]</span> viewWillDisappear
<span class="hljs-section">[B_business]</span> viewWillAppear
        ↓
<span class="hljs-section">[A_business]</span> viewDidDisappear
<span class="hljs-section">[B_business]</span> viewDidAppear
        ↓
UIKit 内部: <span class="hljs-attr">tabBarController.selectedViewController</span> = B_root
        ↓
<span class="hljs-section">[Delegate]</span> didSelectViewController:(B_root)
    → <span class="hljs-attr">selectedViewController</span> == B_root ✅
</code></pre>
<blockquote>
<p>🎯 <strong>记住三句话</strong>：</p>
<ol>
<li><strong><code>shouldSelect</code> 看“过去”，<code>didSelect</code> 看“现在”</strong></li>
<li><strong>生命周期属于业务 VC，代理参数属于 Tab root VC</strong></li>
<li><strong>selectedViewController 的变更，发生在转场结束之后</strong></li>
</ol>
</blockquote>
<hr/>
<h2 data-id="heading-14">📚 结语</h2>
<p><code>UITabBarController</code> 的设计精巧而一致。只要理解 <strong>代理时机、selectedViewController 变化点、以及 UINavigationController 的穿透逻辑</strong>，你就能在任何复杂 Tab 架构中游刃有余。</p>
<p>希望本文能成为你处理 Tab 切换逻辑的“黄金参考”。</p>
<hr/>
<p>欢迎点赞、收藏、评论交流！如果你有更复杂的嵌套场景（如 Tab 内嵌 PageViewController），也欢迎留言讨论！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Elastic Search 聚合查询]]></title>    <link>https://juejin.cn/post/7587825268199833606</link>    <guid>https://juejin.cn/post/7587825268199833606</guid>    <pubDate>2025-12-26T06:34:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587825268199833606" data-draft-id="7587688765188538368" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Elastic Search 聚合查询"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-26T06:34:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="酒酿萝卜皮"/> <meta itemprop="url" content="https://juejin.cn/user/1080158100920361"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Elastic Search 聚合查询
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1080158100920361/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    酒酿萝卜皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T06:34:40.000Z" title="Fri Dec 26 2025 06:34:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在es简单查询之外，还有更高级的聚合查询，这些基本上都是会大大减少生成需求数据所需的时间。</p>
<p>如果说 <strong>Query</strong> 决定查哪些文档，<br/>
那 <strong>Aggregation</strong> 决定从这些文档里能算出什么世界。</p>
<p>这其中就包括：</p>
<h4 data-id="heading-0">1.value_count：统计字段非空数量</h4>
<p>得到该索引的数量之和，一般用于列表展示</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable constant_">GET</span> order_index/_search 
    { <span class="hljs-string">"size"</span>: <span class="hljs-number">0</span>, 
      <span class="hljs-string">"aggs"</span>: 
        { <span class="hljs-string">"order_count"</span>: 
            { <span class="hljs-string">"value_count"</span>: { <span class="hljs-string">"field"</span>: <span class="hljs-string">"orderId"</span> }} 
        } 
    }
</code></pre>
<h4 data-id="heading-1">2.terms：分组聚合</h4>
<p>等同于group by</p>
<p>根据所选字段，自动分组并且得出数量，一般用于列表标签展示的时候来显示各个标签有多少数据。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable constant_">GET</span> order_index/_search 
{ 
    <span class="hljs-string">"size"</span>: <span class="hljs-number">0</span>, 
    <span class="hljs-string">"aggs"</span>: 
        { <span class="hljs-string">"by_status"</span>: 
            { <span class="hljs-string">"terms"</span>: { <span class="hljs-string">"field"</span>: <span class="hljs-string">"status.keyword"</span> }} 
        } 
 }
</code></pre>
<h4 data-id="heading-2">3.分组 + 指标聚合</h4>
<p>根据分组的个个数据，对内求和</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable constant_">GET</span> order_index/_search 
{ <span class="hljs-string">"size"</span>: <span class="hljs-number">0</span>, 
    <span class="hljs-string">"aggs"</span>: { 
    <span class="hljs-string">"by_status"</span>: { 
        <span class="hljs-string">"terms"</span>: { <span class="hljs-string">"field"</span>: <span class="hljs-string">"status.keyword"</span> },
        <span class="hljs-string">"aggs"</span>: { 
            <span class="hljs-string">"total_amount"</span>: { <span class="hljs-string">"sum"</span>: { <span class="hljs-string">"field"</span>: <span class="hljs-string">"amount"</span> } }
           } 
        }
    } 
}
</code></pre>
<h4 data-id="heading-3">4.过滤 + 聚合</h4>
<p>通过query过滤数据，在使用agg来聚合数据。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable constant_">GET</span> order_index/_search 
{ <span class="hljs-string">"size"</span>: <span class="hljs-number">0</span>, 
    <span class="hljs-string">"query"</span>: { 
        <span class="hljs-string">"term"</span>: { <span class="hljs-string">"status.keyword"</span>: <span class="hljs-string">"PAID"</span> } 
    }, 
    <span class="hljs-string">"aggs"</span>: { 
        <span class="hljs-string">"avg_amount"</span>: { <span class="hljs-string">"avg"</span>: { <span class="hljs-string">"field"</span>: <span class="hljs-string">"amount"</span> } } 
    } 
}
</code></pre>
<h4 data-id="heading-4">5.date_histogram 时间聚合</h4>
<p>根据时间格式进行聚合</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable constant_">GET</span> order_index/_search 
{ <span class="hljs-string">"size"</span>: <span class="hljs-number">0</span>, 
    <span class="hljs-string">"aggs"</span>: { 
        <span class="hljs-string">"order_by_day"</span>: { 
            <span class="hljs-string">"date_histogram"</span>: { 
            <span class="hljs-string">"field"</span>: <span class="hljs-string">"createTime"</span>, <span class="hljs-string">"calendar_interval"</span>: <span class="hljs-string">"day"</span>, <span class="hljs-string">"format"</span>: <span class="hljs-string">"yyyy-MM-dd"</span> } 
        } 
    } 
}
</code></pre>
<h4 data-id="heading-5">6.Bucket 筛选</h4>
<p>script 进行筛选，只能在聚合之后</p>
<pre><code class="hljs language-js" lang="js">{<span class="hljs-string">"size"</span>: <span class="hljs-number">0</span>, 
    <span class="hljs-string">"aggs"</span>: { 
        <span class="hljs-string">"by_status"</span>: {
            <span class="hljs-string">"terms"</span>: { <span class="hljs-string">"field"</span>: <span class="hljs-string">"status.keyword"</span> }, 
            <span class="hljs-string">"aggs"</span>: { 
                 <span class="hljs-string">"order_filter"</span>: { 
                     <span class="hljs-string">"bucket_selector"</span>: { 
                         <span class="hljs-string">"buckets_path"</span>: { <span class="hljs-string">"cnt"</span>: <span class="hljs-string">"_count"</span> }, 
                         <span class="hljs-string">"script"</span>: <span class="hljs-string">"params.cnt &gt;= 100"</span>
                      }
                 }
             } 
        } 
     } 
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python迭代器与生成器深度解析：懒加载的艺术]]></title>    <link>https://juejin.cn/post/7587712328827191332</link>    <guid>https://juejin.cn/post/7587712328827191332</guid>    <pubDate>2025-12-26T05:05:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587712328827191332" data-draft-id="7587720490930831396" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python迭代器与生成器深度解析：懒加载的艺术"/> <meta itemprop="keywords" content="Python,PyCharm"/> <meta itemprop="datePublished" content="2025-12-26T05:05:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃西红柿长大的番茄"/> <meta itemprop="url" content="https://juejin.cn/user/3097787706900985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python迭代器与生成器深度解析：懒加载的艺术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097787706900985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃西红柿长大的番茄
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T05:05:08.000Z" title="Fri Dec 26 2025 05:05:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">引言：为什么需要迭代器和生成器？</h2>
<p>想象一下，你要处理一个100GB的文本文件，或者从数据库读取100万条记录。如果你一次性把所有数据加载到内存，电脑可能会崩溃。迭代器和生成器就是为解决这类问题而生的，它们可以"懒加载"数据，用多少取多少。</p>
<h2 data-id="heading-1">一、迭代器（Iterator）基础</h2>
<h3 data-id="heading-2">1.1 什么是迭代器？</h3>
<p>python</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 迭代器基础示例</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 迭代器基础 ==="</span>)

<span class="hljs-comment"># Python中一切都是可迭代的</span>
my_list = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]

<span class="hljs-comment"># 传统for循环</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"传统for循环:"</span>)
<span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> my_list:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  <span class="hljs-subst">{item}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n实际发生了什么:"</span>)
<span class="hljs-comment"># for循环背后的原理</span>
iter_obj = <span class="hljs-built_in">iter</span>(my_list)  <span class="hljs-comment"># 获取迭代器</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"迭代器对象: <span class="hljs-subst">{iter_obj}</span>"</span>)

<span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
    <span class="hljs-keyword">try</span>:
        item = <span class="hljs-built_in">next</span>(iter_obj)  <span class="hljs-comment"># 获取下一个元素</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  获取到: <span class="hljs-subst">{item}</span>"</span>)
    <span class="hljs-keyword">except</span> StopIteration:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"  迭代结束"</span>)
        <span class="hljs-keyword">break</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h3 data-id="heading-3">1.2 自定义迭代器类</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Countdown</span>:
    <span class="hljs-string">"""倒计时迭代器"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, start</span>):
        self.current = start
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__iter__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""返回迭代器自身"""</span>
        <span class="hljs-keyword">return</span> self
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__next__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""返回下一个值"""</span>
        <span class="hljs-keyword">if</span> self.current &lt;= <span class="hljs-number">0</span>:
            <span class="hljs-keyword">raise</span> StopIteration
        value = self.current
        self.current -= <span class="hljs-number">1</span>
        <span class="hljs-keyword">return</span> value

<span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 自定义迭代器 ==="</span>)

<span class="hljs-comment"># 使用自定义迭代器</span>
countdown = Countdown(<span class="hljs-number">5</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"倒计时开始:"</span>)

<span class="hljs-keyword">for</span> number <span class="hljs-keyword">in</span> countdown:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  <span class="hljs-subst">{number}</span>..."</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"发射！"</span>)

<span class="hljs-comment"># 手动使用迭代器</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n手动使用迭代器:"</span>)
countdown2 = Countdown(<span class="hljs-number">3</span>)
iterator = <span class="hljs-built_in">iter</span>(countdown2)

<span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(iterator))  <span class="hljs-comment"># 3</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(iterator))  <span class="hljs-comment"># 2</span>
<span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(iterator))  <span class="hljs-comment"># 1</span>

<span class="hljs-keyword">try</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">next</span>(iterator))  <span class="hljs-comment"># 会引发StopIteration</span>
<span class="hljs-keyword">except</span> StopIteration:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"迭代结束"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h3 data-id="heading-4">1.3 实用的迭代器：文件读取器</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LargeFileReader</span>:
    <span class="hljs-string">"""大文件读取器 - 逐行读取，避免内存溢出"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, filename, chunk_size=<span class="hljs-number">1024</span></span>):
        self.filename = filename
        self.chunk_size = chunk_size
        self.file = <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__iter__</span>(<span class="hljs-params">self</span>):
        self.file = <span class="hljs-built_in">open</span>(self.filename, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>)
        <span class="hljs-keyword">return</span> self
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__next__</span>(<span class="hljs-params">self</span>):
        line = self.file.readline()
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> line:
            self.file.close()
            <span class="hljs-keyword">raise</span> StopIteration
        <span class="hljs-keyword">return</span> line.strip()
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">read_in_chunks</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""按块读取文件"""</span>
        <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(self.filename, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
            <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
                chunk = f.read(self.chunk_size)
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> chunk:
                    <span class="hljs-keyword">break</span>
                <span class="hljs-keyword">yield</span> chunk

<span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 文件读取迭代器 ==="</span>)

<span class="hljs-comment"># 模拟一个大文件</span>
<span class="hljs-keyword">import</span> tempfile

<span class="hljs-comment"># 创建临时文件，写入100行数据</span>
<span class="hljs-keyword">with</span> tempfile.NamedTemporaryFile(mode=<span class="hljs-string">'w'</span>, delete=<span class="hljs-literal">False</span>, suffix=<span class="hljs-string">'.txt'</span>) <span class="hljs-keyword">as</span> tmp:
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">100</span>):
        tmp.write(<span class="hljs-string">f"这是第<span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>行数据，包含一些测试内容用于演示迭代器的工作方式\n"</span>)
    tmp_filename = tmp.name

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"创建了测试文件: <span class="hljs-subst">{tmp_filename}</span>"</span>)

<span class="hljs-comment"># 使用迭代器逐行读取</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n逐行读取文件:"</span>)
file_reader = LargeFileReader(tmp_filename)
lines_read = <span class="hljs-number">0</span>

<span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> file_reader:
    lines_read += <span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> lines_read &lt;= <span class="hljs-number">3</span>:  <span class="hljs-comment"># 只显示前3行</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  行<span class="hljs-subst">{lines_read}</span>: <span class="hljs-subst">{line[:<span class="hljs-number">30</span>]}</span>..."</span>)
    <span class="hljs-keyword">elif</span> lines_read == <span class="hljs-number">100</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  行<span class="hljs-subst">{lines_read}</span>: <span class="hljs-subst">{line[:<span class="hljs-number">30</span>]}</span>..."</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"总共读取了 <span class="hljs-subst">{lines_read}</span> 行"</span>)

<span class="hljs-comment"># 按块读取</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n按块读取文件:"</span>)
chunks_read = <span class="hljs-number">0</span>
<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> file_reader.read_in_chunks():
    chunks_read += <span class="hljs-number">1</span>
    <span class="hljs-keyword">if</span> chunks_read &lt;= <span class="hljs-number">2</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  块<span class="hljs-subst">{chunks_read}</span>: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(chunk)}</span> 字符"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"总共读取了 <span class="hljs-subst">{chunks_read}</span> 个块"</span>)

<span class="hljs-comment"># 清理临时文件</span>
<span class="hljs-keyword">import</span> os
os.unlink(tmp_filename)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h2 data-id="heading-5">二、生成器（Generator）进阶</h2>
<h3 data-id="heading-6">2.1 生成器函数 vs 生成器表达式</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 生成器基础 ==="</span>)

<span class="hljs-comment"># 1. 生成器函数 (使用yield)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">fibonacci_generator</span>(<span class="hljs-params">n</span>):
    <span class="hljs-string">"""斐波那契数列生成器"""</span>
    a, b = <span class="hljs-number">0</span>, <span class="hljs-number">1</span>
    count = <span class="hljs-number">0</span>
    <span class="hljs-keyword">while</span> count &lt; n:
        <span class="hljs-keyword">yield</span> a
        a, b = b, a + b
        count += <span class="hljs-number">1</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">"斐波那契数列生成器:"</span>)
fib_gen = fibonacci_generator(<span class="hljs-number">10</span>)

<span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> fib_gen:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  <span class="hljs-subst">{num}</span>"</span>, end=<span class="hljs-string">" "</span>)
<span class="hljs-built_in">print</span>()

<span class="hljs-comment"># 2. 生成器表达式 (类似列表推导式，但使用圆括号)</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n生成器表达式:"</span>)

<span class="hljs-comment"># 列表推导式 - 立即生成所有元素</span>
squares_list = [x**<span class="hljs-number">2</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>)]
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"列表推导式 (已生成所有元素): <span class="hljs-subst">{squares_list}</span>"</span>)

<span class="hljs-comment"># 生成器表达式 - 懒生成元素</span>
squares_gen = (x**<span class="hljs-number">2</span> <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>))
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"生成器表达式 (尚未生成): <span class="hljs-subst">{squares_gen}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"逐个获取生成器的值:"</span>)
<span class="hljs-keyword">for</span> i, square <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(squares_gen):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  <span class="hljs-subst">{i}</span>^2 = <span class="hljs-subst">{square}</span>"</span>)
    <span class="hljs-keyword">if</span> i &gt;= <span class="hljs-number">4</span>:  <span class="hljs-comment"># 只显示前5个</span>
        <span class="hljs-keyword">break</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">"... 剩余的值会在需要时生成"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h3 data-id="heading-7">2.2 生成器的实用场景</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 生成器实用场景 ==="</span>)

<span class="hljs-comment"># 场景1：处理大型数据集</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">read_large_dataset</span>(<span class="hljs-params">file_path</span>):
    <span class="hljs-string">"""读取大型数据集"""</span>
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(file_path, <span class="hljs-string">'r'</span>) <span class="hljs-keyword">as</span> file:
        <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> file:
            <span class="hljs-comment"># 处理每一行数据</span>
            processed_line = line.strip().lower()
            <span class="hljs-keyword">yield</span> processed_line

<span class="hljs-comment"># 场景2：无限序列</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">infinite_counter</span>(<span class="hljs-params">start=<span class="hljs-number">0</span>, step=<span class="hljs-number">1</span></span>):
    <span class="hljs-string">"""无限计数器"""</span>
    current = start
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        <span class="hljs-keyword">yield</span> current
        current += step

<span class="hljs-comment"># 场景3：数据处理管道</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">data_pipeline</span>(<span class="hljs-params">data</span>):
    <span class="hljs-string">"""数据处理管道"""</span>
    <span class="hljs-comment"># 第一步：过滤</span>
    <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> data:
        <span class="hljs-keyword">if</span> item % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>:  <span class="hljs-comment"># 只保留偶数</span>
            <span class="hljs-keyword">yield</span> item
    
<span class="hljs-keyword">def</span> <span class="hljs-title function_">multiply_by_3</span>(<span class="hljs-params">data</span>):
    <span class="hljs-string">"""乘以3"""</span>
    <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> data:
        <span class="hljs-keyword">yield</span> item * <span class="hljs-number">3</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">add_10</span>(<span class="hljs-params">data</span>):
    <span class="hljs-string">"""加10"""</span>
    <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> data:
        <span class="hljs-keyword">yield</span> item + <span class="hljs-number">10</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">"数据处理管道演示:"</span>)
original_data = <span class="hljs-built_in">range</span>(<span class="hljs-number">20</span>)

<span class="hljs-comment"># 构建管道</span>
pipeline = add_10(multiply_by_3(data_pipeline(original_data)))

<span class="hljs-built_in">print</span>(<span class="hljs-string">"原始数据:"</span>, <span class="hljs-built_in">list</span>(original_data))
<span class="hljs-built_in">print</span>(<span class="hljs-string">"处理后数据:"</span>, <span class="hljs-built_in">list</span>(pipeline))

<span class="hljs-comment"># 场景4：协程（双向通信）</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">coroutine_example</span>():
    <span class="hljs-string">"""协程示例 - 生成器可以接收数据"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"协程启动"</span>)
    total = <span class="hljs-number">0</span>
    count = <span class="hljs-number">0</span>
    
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        value = <span class="hljs-keyword">yield</span>
        <span class="hljs-keyword">if</span> value <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">break</span>
        total += value
        count += <span class="hljs-number">1</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"收到值: <span class="hljs-subst">{value}</span>, 当前平均值: <span class="hljs-subst">{total/count:<span class="hljs-number">.2</span>f}</span>"</span>)
    
    <span class="hljs-keyword">return</span> total, count

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n协程演示:"</span>)
coro = coroutine_example()
<span class="hljs-built_in">next</span>(coro)  <span class="hljs-comment"># 启动协程</span>

coro.send(<span class="hljs-number">10</span>)
coro.send(<span class="hljs-number">20</span>)
coro.send(<span class="hljs-number">30</span>)

<span class="hljs-keyword">try</span>:
    coro.send(<span class="hljs-literal">None</span>)  <span class="hljs-comment"># 结束协程</span>
<span class="hljs-keyword">except</span> StopIteration <span class="hljs-keyword">as</span> e:
    total, count = e.value
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"协程结束，总和: <span class="hljs-subst">{total}</span>, 次数: <span class="hljs-subst">{count}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h3 data-id="heading-8">2.3 生成器的send()和throw()方法</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 生成器的高级方法 ==="</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">advanced_generator</span>():
    <span class="hljs-string">"""高级生成器示例"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"生成器启动"</span>)
    <span class="hljs-keyword">try</span>:
        received = <span class="hljs-keyword">yield</span> <span class="hljs-string">"第一步完成"</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"收到: <span class="hljs-subst">{received}</span>"</span>)
        
        received = <span class="hljs-keyword">yield</span> <span class="hljs-string">"第二步完成"</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"收到: <span class="hljs-subst">{received}</span>"</span>)
        
        <span class="hljs-keyword">yield</span> <span class="hljs-string">"第三步完成"</span>
        
    <span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"捕获到异常: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">yield</span> <span class="hljs-string">"从异常中恢复"</span>
    <span class="hljs-keyword">finally</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"生成器清理"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"1. 正常使用send()方法:"</span>)
gen = advanced_generator()

<span class="hljs-comment"># 启动生成器</span>
result = <span class="hljs-built_in">next</span>(gen)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"生成器返回: <span class="hljs-subst">{result}</span>"</span>)

<span class="hljs-comment"># 发送数据给生成器</span>
result = gen.send(<span class="hljs-string">"第一条消息"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"生成器返回: <span class="hljs-subst">{result}</span>"</span>)

result = gen.send(<span class="hljs-string">"第二条消息"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"生成器返回: <span class="hljs-subst">{result}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n2. 使用throw()方法向生成器抛出异常:"</span>)
gen2 = advanced_generator()
<span class="hljs-built_in">next</span>(gen2)  <span class="hljs-comment"># 启动</span>

<span class="hljs-comment"># 向生成器抛出异常</span>
result = gen2.throw(ValueError(<span class="hljs-string">"测试异常"</span>))
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"生成器返回: <span class="hljs-subst">{result}</span>"</span>)

<span class="hljs-keyword">try</span>:
    <span class="hljs-built_in">next</span>(gen2)
<span class="hljs-keyword">except</span> StopIteration:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"生成器正常结束"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n3. 使用close()方法关闭生成器:"</span>)
gen3 = advanced_generator()
<span class="hljs-built_in">next</span>(gen3)  <span class="hljs-comment"># 启动</span>

gen3.close()  <span class="hljs-comment"># 关闭生成器</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"生成器已关闭"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h2 data-id="heading-9">三、yield from：生成器的魔法</h2>
<h3 data-id="heading-10">3.1 yield from 基础</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"=== yield from 语法 ==="</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">sub_generator</span>():
    <span class="hljs-string">"""子生成器"""</span>
    <span class="hljs-keyword">yield</span> <span class="hljs-string">"子生成器: A"</span>
    <span class="hljs-keyword">yield</span> <span class="hljs-string">"子生成器: B"</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"子生成器完成"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main_generator_old</span>():
    <span class="hljs-string">"""老式方法 - 手动委托"""</span>
    <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> sub_generator():
        <span class="hljs-keyword">yield</span> item
    <span class="hljs-keyword">yield</span> <span class="hljs-string">"主生成器继续"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">main_generator_new</span>():
    <span class="hljs-string">"""新方法 - 使用yield from"""</span>
    result = <span class="hljs-keyword">yield</span> <span class="hljs-keyword">from</span> sub_generator()
    <span class="hljs-keyword">yield</span> <span class="hljs-string">f"主生成器收到: <span class="hljs-subst">{result}</span>"</span>
    <span class="hljs-keyword">yield</span> <span class="hljs-string">"主生成器完成"</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">"老式委托方法:"</span>)
<span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> main_generator_old():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  <span class="hljs-subst">{item}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n使用yield from:"</span>)
<span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> main_generator_new():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  <span class="hljs-subst">{item}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h3 data-id="heading-11">3.2 yield from 的实用示例</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"=== yield from 实用示例 ==="</span>)

<span class="hljs-comment"># 示例1：扁平化嵌套结构</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">flatten</span>(<span class="hljs-params">nested</span>):
    <span class="hljs-string">"""扁平化嵌套的列表"""</span>
    <span class="hljs-keyword">for</span> sublist <span class="hljs-keyword">in</span> nested:
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(sublist, <span class="hljs-built_in">list</span>):
            <span class="hljs-keyword">yield</span> <span class="hljs-keyword">from</span> flatten(sublist)  <span class="hljs-comment"># 递归委托</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">yield</span> sublist

<span class="hljs-comment"># 示例2：合并多个生成器</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">chain_generators</span>(<span class="hljs-params">*generators</span>):
    <span class="hljs-string">"""连接多个生成器"""</span>
    <span class="hljs-keyword">for</span> gen <span class="hljs-keyword">in</span> generators:
        <span class="hljs-keyword">yield</span> <span class="hljs-keyword">from</span> gen

<span class="hljs-comment"># 示例3：树形结构遍历</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TreeNode</span>:
    <span class="hljs-string">"""树节点"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, value, children=<span class="hljs-literal">None</span></span>):
        self.value = value
        self.children = children <span class="hljs-keyword">or</span> []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__iter__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""使用yield from遍历子树"""</span>
        <span class="hljs-keyword">yield</span> self.value
        <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> self.children:
            <span class="hljs-keyword">yield</span> <span class="hljs-keyword">from</span> child

<span class="hljs-built_in">print</span>(<span class="hljs-string">"1. 扁平化嵌套列表:"</span>)
nested_list = [<span class="hljs-number">1</span>, [<span class="hljs-number">2</span>, [<span class="hljs-number">3</span>, <span class="hljs-number">4</span>], <span class="hljs-number">5</span>], <span class="hljs-number">6</span>, [<span class="hljs-number">7</span>, <span class="hljs-number">8</span>]]
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"原始列表: <span class="hljs-subst">{nested_list}</span>"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"扁平化后: <span class="hljs-subst">{<span class="hljs-built_in">list</span>(flatten(nested_list))}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n2. 合并多个生成器:"</span>)
gen1 = (x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>))
gen2 = (x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-string">"abc"</span>)
gen3 = (x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> [<span class="hljs-literal">True</span>, <span class="hljs-literal">False</span>])

chained = chain_generators(gen1, gen2, gen3)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"合并结果: <span class="hljs-subst">{<span class="hljs-built_in">list</span>(chained)}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n3. 树形结构遍历:"</span>)
<span class="hljs-comment"># 构建一棵树</span>
tree = TreeNode(<span class="hljs-string">"A"</span>, [
    TreeNode(<span class="hljs-string">"B"</span>, [
        TreeNode(<span class="hljs-string">"D"</span>),
        TreeNode(<span class="hljs-string">"E"</span>)
    ]),
    TreeNode(<span class="hljs-string">"C"</span>, [
        TreeNode(<span class="hljs-string">"F"</span>)
    ])
])

<span class="hljs-built_in">print</span>(<span class="hljs-string">"树节点遍历:"</span>)
<span class="hljs-keyword">for</span> node <span class="hljs-keyword">in</span> tree:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  节点: <span class="hljs-subst">{node}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h2 data-id="heading-12">四、性能对比：迭代器 vs 列表</h2>
<h3 data-id="heading-13">4.1 内存使用对比</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 性能对比：迭代器 vs 列表 ==="</span>)

<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_memory_usage</span>():
    <span class="hljs-string">"""测试内存使用"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"1. 内存使用对比:"</span>)
    
    <span class="hljs-comment"># 列表推导式 - 占用大量内存</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"列表推导式:"</span>)
    start_mem = sys.getsizeof([])
    big_list = [x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1000000</span>)]
    end_mem = sys.getsizeof(big_list)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  内存占用: <span class="hljs-subst">{(end_mem - start_mem) / <span class="hljs-number">1024</span> / <span class="hljs-number">1024</span>:<span class="hljs-number">.2</span>f}</span> MB"</span>)
    
    <span class="hljs-comment"># 生成器表达式 - 几乎不占内存</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"生成器表达式:"</span>)
    start_mem = sys.getsizeof([])
    big_gen = (x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1000000</span>))
    end_mem = sys.getsizeof(big_gen)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  内存占用: <span class="hljs-subst">{(end_mem - start_mem) / <span class="hljs-number">1024</span>:<span class="hljs-number">.2</span>f}</span> KB"</span>)
    
    <span class="hljs-keyword">del</span> big_list, big_gen

<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_execution_time</span>():
    <span class="hljs-string">"""测试执行时间"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n2. 执行时间对比:"</span>)
    
    <span class="hljs-comment"># 创建大型数据集</span>
    data_size = <span class="hljs-number">1000000</span>
    
    <span class="hljs-comment"># 测试列表</span>
    start_time = time.time()
    total = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(data_size):
        total += i
    list_time = time.time() - start_time
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"列表循环时间: <span class="hljs-subst">{list_time:<span class="hljs-number">.4</span>f}</span> 秒"</span>)
    
    <span class="hljs-comment"># 测试生成器</span>
    start_time = time.time()
    total = <span class="hljs-number">0</span>
    gen = (x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(data_size))
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> gen:
        total += i
    gen_time = time.time() - start_time
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"生成器时间: <span class="hljs-subst">{gen_time:<span class="hljs-number">.4</span>f}</span> 秒"</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"时间差异: <span class="hljs-subst">{<span class="hljs-built_in">abs</span>(list_time - gen_time):<span class="hljs-number">.4</span>f}</span> 秒"</span>)

<span class="hljs-keyword">def</span> <span class="hljs-title function_">test_practical_scenario</span>():
    <span class="hljs-string">"""测试实际场景"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n3. 实际场景：查找第一个符合条件的元素"</span>)
    
    <span class="hljs-comment"># 模拟大型数据集</span>
    data = <span class="hljs-built_in">range</span>(<span class="hljs-number">10000000</span>)
    target = <span class="hljs-number">5000000</span>
    
    <span class="hljs-comment"># 使用列表（需要先生成所有元素）</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"列表方法（需要先生成所有元素）:"</span>)
    start_time = time.time()
    <span class="hljs-keyword">try</span>:
        result = [x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> data <span class="hljs-keyword">if</span> x &gt; target][<span class="hljs-number">0</span>]
    <span class="hljs-keyword">except</span> IndexError:
        result = <span class="hljs-literal">None</span>
    list_time = time.time() - start_time
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  结果: <span class="hljs-subst">{result}</span>, 时间: <span class="hljs-subst">{list_time:<span class="hljs-number">.4</span>f}</span> 秒"</span>)
    
    <span class="hljs-comment"># 使用生成器（找到就停止）</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"生成器方法（找到就停止）:"</span>)
    start_time = time.time()
    gen = (x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> data <span class="hljs-keyword">if</span> x &gt; target)
    result = <span class="hljs-built_in">next</span>(gen, <span class="hljs-literal">None</span>)
    gen_time = time.time() - start_time
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  结果: <span class="hljs-subst">{result}</span>, 时间: <span class="hljs-subst">{gen_time:<span class="hljs-number">.4</span>f}</span> 秒"</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  时间节省: <span class="hljs-subst">{(list_time - gen_time):<span class="hljs-number">.4</span>f}</span> 秒"</span>)

<span class="hljs-comment"># 运行测试</span>
test_memory_usage()
test_execution_time()
test_practical_scenario()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h2 data-id="heading-14">五、实战项目：构建数据流处理框架</h2>
<h3 data-id="heading-15">5.1 完整的数据处理框架</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 实战项目：数据流处理框架 ==="</span>)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DataStream</span>:
    <span class="hljs-string">"""数据流基类"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__iter__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">raise</span> NotImplementedError(<span class="hljs-string">"子类必须实现"</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">map</span>(<span class="hljs-params">self, func</span>):
        <span class="hljs-string">"""应用转换函数"""</span>
        <span class="hljs-keyword">return</span> MapStream(self, func)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">filter</span>(<span class="hljs-params">self, predicate</span>):
        <span class="hljs-string">"""过滤数据"""</span>
        <span class="hljs-keyword">return</span> FilterStream(self, predicate)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">take</span>(<span class="hljs-params">self, n</span>):
        <span class="hljs-string">"""取前n个元素"""</span>
        <span class="hljs-keyword">return</span> TakeStream(self, n)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">skip</span>(<span class="hljs-params">self, n</span>):
        <span class="hljs-string">"""跳过前n个元素"""</span>
        <span class="hljs-keyword">return</span> SkipStream(self, n)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">collect</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""收集所有数据到列表"""</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">list</span>(self)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MapStream</span>(<span class="hljs-title class_ inherited__">DataStream</span>):
    <span class="hljs-string">"""映射流"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, source, func</span>):
        self.source = source
        self.func = func
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__iter__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> self.source:
            <span class="hljs-keyword">yield</span> self.func(item)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">FilterStream</span>(<span class="hljs-title class_ inherited__">DataStream</span>):
    <span class="hljs-string">"""过滤流"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, source, predicate</span>):
        self.source = source
        self.predicate = predicate
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__iter__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> self.source:
            <span class="hljs-keyword">if</span> self.predicate(item):
                <span class="hljs-keyword">yield</span> item

<span class="hljs-keyword">class</span> <span class="hljs-title class_">TakeStream</span>(<span class="hljs-title class_ inherited__">DataStream</span>):
    <span class="hljs-string">"""取前n个流"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, source, n</span>):
        self.source = source
        self.n = n
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__iter__</span>(<span class="hljs-params">self</span>):
        count = <span class="hljs-number">0</span>
        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> self.source:
            <span class="hljs-keyword">if</span> count &gt;= self.n:
                <span class="hljs-keyword">break</span>
            <span class="hljs-keyword">yield</span> item
            count += <span class="hljs-number">1</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SkipStream</span>(<span class="hljs-title class_ inherited__">DataStream</span>):
    <span class="hljs-string">"""跳过前n个流"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, source, n</span>):
        self.source = source
        self.n = n
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__iter__</span>(<span class="hljs-params">self</span>):
        count = <span class="hljs-number">0</span>
        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> self.source:
            <span class="hljs-keyword">if</span> count &gt;= self.n:
                <span class="hljs-keyword">yield</span> item
            count += <span class="hljs-number">1</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RangeStream</span>(<span class="hljs-title class_ inherited__">DataStream</span>):
    <span class="hljs-string">"""范围流"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, start, end=<span class="hljs-literal">None</span>, step=<span class="hljs-number">1</span></span>):
        <span class="hljs-keyword">if</span> end <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            self.start = <span class="hljs-number">0</span>
            self.end = start
        <span class="hljs-keyword">else</span>:
            self.start = start
            self.end = end
        self.step = step
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__iter__</span>(<span class="hljs-params">self</span>):
        current = self.start
        <span class="hljs-keyword">while</span> current &lt; self.end:
            <span class="hljs-keyword">yield</span> current
            current += self.step

<span class="hljs-built_in">print</span>(<span class="hljs-string">"构建数据流处理管道:"</span>)

<span class="hljs-comment"># 创建数据流</span>
stream = RangeStream(<span class="hljs-number">1</span>, <span class="hljs-number">101</span>)  <span class="hljs-comment"># 1-100</span>

<span class="hljs-comment"># 构建处理管道</span>
result = (stream
    .<span class="hljs-built_in">filter</span>(<span class="hljs-keyword">lambda</span> x: x % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>)      <span class="hljs-comment"># 只保留偶数</span>
    .<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> x: x * <span class="hljs-number">3</span>)              <span class="hljs-comment"># 乘以3</span>
    .<span class="hljs-built_in">filter</span>(<span class="hljs-keyword">lambda</span> x: x &gt; <span class="hljs-number">100</span>)         <span class="hljs-comment"># 只保留大于100的</span>
    .take(<span class="hljs-number">10</span>)                          <span class="hljs-comment"># 取前10个</span>
    .collect())                        <span class="hljs-comment"># 收集结果</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"处理结果: <span class="hljs-subst">{result}</span>"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n流式处理演示:"</span>)
<span class="hljs-comment"># 显示每一步的处理过程</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"原始数据: 1-100"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"步骤1: 过滤偶数"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"步骤2: 乘以3"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"步骤3: 过滤 &gt;100 的数"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"步骤4: 取前10个"</span>)

<span class="hljs-comment"># 分步演示</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n分步处理过程:"</span>)
stream = RangeStream(<span class="hljs-number">1</span>, <span class="hljs-number">21</span>)  <span class="hljs-comment"># 1-20</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">"原始数据:"</span>, <span class="hljs-built_in">list</span>(stream))

stream = RangeStream(<span class="hljs-number">1</span>, <span class="hljs-number">21</span>)
even_stream = stream.<span class="hljs-built_in">filter</span>(<span class="hljs-keyword">lambda</span> x: x % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"过滤偶数:"</span>, <span class="hljs-built_in">list</span>(even_stream))

stream = RangeStream(<span class="hljs-number">1</span>, <span class="hljs-number">21</span>)
processed = stream.<span class="hljs-built_in">filter</span>(<span class="hljs-keyword">lambda</span> x: x % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>).<span class="hljs-built_in">map</span>(<span class="hljs-keyword">lambda</span> x: x * <span class="hljs-number">3</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"乘以3:"</span>, <span class="hljs-built_in">list</span>(processed))

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h2 data-id="heading-16">总结：何时使用迭代器和生成器？</h2>
<h3 data-id="heading-17">适合使用的情况：</h3>
<ol>
<li>✅ <strong>处理大型数据集</strong>（避免内存溢出）</li>
<li>✅ <strong>无限序列</strong>（如计数器、斐波那契数列）</li>
<li>✅ <strong>管道处理</strong>（多个处理步骤串联）</li>
<li>✅ <strong>懒加载</strong>（需要时才计算）</li>
</ol>
<h3 data-id="heading-18">不适合使用的情况：</h3>
<ol>
<li>❌ <strong>需要随机访问</strong>（迭代器只能单向前进）</li>
<li>❌ <strong>需要重用数据</strong>（迭代器消耗后就不能再用了）</li>
<li>❌ <strong>小数据集</strong>（列表推导式更简单）</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python异步编程完全指南：从asyncio到高性能应用]]></title>    <link>https://juejin.cn/post/7587713001715597366</link>    <guid>https://juejin.cn/post/7587713001715597366</guid>    <pubDate>2025-12-26T05:14:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587713001715597366" data-draft-id="7587825267877675049" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python异步编程完全指南：从asyncio到高性能应用"/> <meta itemprop="keywords" content="Python,PyCharm"/> <meta itemprop="datePublished" content="2025-12-26T05:14:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吃西红柿长大的番茄"/> <meta itemprop="url" content="https://juejin.cn/user/3097787706900985"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python异步编程完全指南：从asyncio到高性能应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3097787706900985/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吃西红柿长大的番茄
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T05:14:35.000Z" title="Fri Dec 26 2025 05:14:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252b3a}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px;color:#5e7ce0}.markdown-body h1{font-size:24px;margin-bottom:5px;margin-top:80px;position:relative;text-align:center}.markdown-body h2{font-size:20px;padding-bottom:12px;border-bottom:1px solid #dfe1e6}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px;margin-top:30px}.markdown-body h5{font-size:14px;margin-top:20px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #dfe1e6;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#ffeeed;color:#c73636;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#252b3a;background:#f8f8f8}.markdown-body a{position:relative;text-decoration:none;color:#5e7ce0;padding-right:18px;padding-bottom:4px}.markdown-body a[href^=http]:after{position:absolute;display:inline-block;width:16px;height:16px;margin-left:2px;margin-top:6px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAIRlWElmTU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAOgAQADAAAAAQABAACgAgAEAAAAAQAAACCgAwAEAAAAAQAAACAAAAAAX7wP8AAAAAlwSFlzAAALEwAACxMBAJqcGAAAAVlpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDYuMC4wIj4KICAgPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4KICAgICAgPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIKICAgICAgICAgICAgeG1sbnM6dGlmZj0iaHR0cDovL25zLmFkb2JlLmNvbS90aWZmLzEuMC8iPgogICAgICAgICA8dGlmZjpPcmllbnRhdGlvbj4xPC90aWZmOk9yaWVudGF0aW9uPgogICAgICA8L3JkZjpEZXNjcmlwdGlvbj4KICAgPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KGV7hBwAABWVJREFUWAnlVktsVFUY/s85997pC9BOTKxRWnEKsXWlxjWJj0RWJjrFAAXjAlewYWOkgauACVu7a2IiNUEyExM3yoZE3Wmi7qgPJthJBDE6JUNpO3Mf5/j95/bOTOcBlBgXejJ37rn/Of/7O/9/iP7vQ/zTAcjnC4ry+a5ii1OkiYTpuvjvEc0Gp51uivP+ZW+QBuSW4QjW5rptAa1Ey0uOGKOxwPetVyafN6p/52/PkNBbjdAhGaGEpMRjLZTryB8+9MUSYSGNRIcBvm8kBAY9tHYlHz78nTs392xIkwv9FA3Oe33bdoX1ZZKOS0bH0CXI6RugYLW6BwIu5gskkQ4sEG0wYF25PjBzbZfSYY6kDLUmWMt7FR7Lw3xYUkaTdjxHfTPnPwav0iEGYADVa9XIRIEyxrAA0jIQxgFL22gYwF7A8/DAzNVdksJvJaTEUZ2kYnZWziN5s1ADPHneEIXByotYuMSrf9JEbbsuv7VcvbaKML8plXtQR0EdIYDqWEmtOgAomZFH8EjWSnek2ulmtljljttHbmaIHCCCHzd9MjwfsmscBeZH9Jyd10nMvz92UQrtCBKvMF06mQy0SiEdRMEGg8mN0YjAlgoDDkPrMI5qJKSkKKydpbB2CZjJkhIBvOBw2CGQgii85bpx//dMqFRKam5uvH7w+K97oe+Cl0HO68uIBH0qyEzpOMwIbZIcFq0I+9cwoElizCjk2KFI1y7Nnx614W1db58fOXIlMzs7Xn/jeDmvBV2Q0mXjGf554O/m4LZHp2N8r61WPMvLZWLdiC4GMAk5BjeeB5lhv39l6+BIbu3m760hXMDKBD08XBKzR8fr04nygnIypOOAJUx/fHrsi0Mnys+vVK+V4VUohaiyPCo2Q9DFALvF/ikw8WS4QvVZALS5ksw47/7R8ejgTPk1UFqU6/3zp8bOM7B/kdu/fkguPGU5JibW+F0sTjWOUw8DklRrg4BiLGeBqbaRLxjlT4no0InFV402RcftJz41cH/f/JnHP3kZaaF6VX/liwist9vYG5+NU9Cg3MNkt/+lU5wS8fTxq3mc7ILjDlAE4CJpe89BOWPiIjBhi9O6PI4G1jsc6RGB3lZwmS76k8H0zOKTkFboG8jS2krFKCX2fvTeaPHIBwAkMHHgncURnL3nuCSnxSopdIzN5th0BIonJ0Lf9yUA9iMkzdRWl3BixOusfDcwQVcS4UKIFwYfGPnM8wY/DyP9NFMXaTE5BU39tGkDgGZz+fJJG0oYcSaOafLcqdECY4LzfSObSzyUOgxqtyisr8SSNOOAkubWoh3TTaeA2YtFEXPnm5x81/j+6MI6JqyS25WSNU6hbCMKHG84marJbdR+vwakRhQLRuQpbzHRLjmpmijI+OmWCtq+LzWtnX5v30gHSsqmWne74DtiACi2+Wz0iXbuLt9D2cDyoPEkWOiyp5XUIwLMi/wJY1FbH5B9ONtdC1KrsD/Q0MCQAS0wccILORDW25amAeOtooAj/KQxfzF17uwTSQ1v3dJ7jnLINwdZYRDa4tPU0sHVXFo/vxFF5BqFqxRfOmgPCk4ft2NgKTCy2Y47JIEg+MIhjYsLy5I25qUYTQlCjMRHsr/UwdYwIK33UO1J5fFNB9XNO6akcywJofVmXQDP2wfrSPcI2xG5BSs3I+IosHr4EtvO1TDAu16xHQq5+ykMblfRXLbhEoFIdDTBdhldvzl+3CMg60ZktI2vNzLW6IIp0waLklot9L63yzuUp8dJd7bglPFe3hIXstBEP58/s6Ocyr4rH2+866ZNbriTzA0RSOWCwakMl1QJgculxPt8Z7O5GLdtW6bvU8R/nO1vb+hMExVAVtEAAAAASUVORK5CYII=");background-size:100%}.markdown-body a:active,.markdown-body a:hover{border-bottom:2px solid #5e7ce0}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #5e7ce0;border-spacing:0}.markdown-body thead{color:#fff;text-align:left}.markdown-body thead tr{background:#5e7ce0}.markdown-body thead th{border-bottom:1px solid #dfe1e6}.markdown-body tr{background-color:#fff}.markdown-body tr:nth-child(2n){background-color:#f2f5fc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#252b3a;padding:1px 23px;margin:22px 0;border-left:4px solid #5e7ce0;background-color:#f2f5fc}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{padding-left:10px;margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#5e7ce0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ul li::marker{content:"•";color:#5e7ce0}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}.markdown-body input[type=checkbox]:before{display:inline-block;width:16px;height:16px;content:"";background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAAAhRJREFUeAHtnLEuBFEUhs9cu7JCskEhIrZAgYZGoREPwBuIygOoPITKA6jEG/AAolFoaFCgICIKZBNiY8Pyz5rNOWe9wNz5T7N3Z2eT/b/7zZlpziat3xKWBDJoEyh5EDd3DTk5r8vV7Yc8vzbl6zvfwvSERIYHyzI90SeLc1WZrFV85PR9oi+N/YMnOT6t/3tiLAeXFqqytjrSFacDYmfvQS6u37tOiPHA7FS/bK6PmWhpj4AJRYGA9MiKzLpK6An+cqiNVmRleUhArrec6PNzt/5sttLgh0cvcvfY6Px+ZNY9I6Ax6gKErY1xmZ8ZyD0E5MJGIgsyIZsunT3g7qALJuTdAp0nWyMTsunS2QNukbpwOcRaPpvOHvxzQow2ZBvrs+nsfLL8o0QQBJFdMO1XGkEjaIQlQCMsD/YIGkEjLAEaYXmwR9AIGmEJ0AjLgz2CRtAIS4BGWB7sETSCRlgCNMLyYI+gETTCEqARlgd7BI2gEZYAjbA82CNoBI2wBGiE5cEeQSNohCVAIywP9ggaQSMsARphebBH0AgaYQnQCMsjYC5SF2agYi2fTWcPGA7VFfO0n8+mswdMyOrCNJwnpz/P6xqZkE2Xzh4w8qcLI4Hbu/dydvkWBRAAQBZk0uOOyKyzp5PARRiF1puNtR+NTh+oMCvtJ+D8F2N6j6x+PrwzG46gRTDDm5BtsAGBg0X924Qfj7i23p7HNgQAAAAASUVORK5CYII=");background-size:100%;position:relative;right:2px;top:-5px}.markdown-body input[type=checkbox]:checked:before{background:url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEIAAABCCAYAAADjVADoAAAK2GlDQ1BJQ0MgUHJvZmlsZQAASImVlwdUU9kWhs+96Y0WiHRC70gngJTQQxGkg6iEJJBQYkgIKmJnUMGxoCKCZcSKKFhGQMaCWLANAopdJ8igoD4HC6Ki5t3AI8zMW++99fZaJ+dbO/vss/e55671XwAoYWyRKBdWAyBPWCCODQ2gJ6ek0nHPAQRgQAI2wIHNkYiYMTGRALHJ+a/28S4Sjdhte0Wuf///v5oGlyfhAAClIZzBlXDyEG5DxkuOSFwAAOoI4jddUCBScBfCmmKkQIR/V3DWBH9ScMY4o8njMfGxgQjTAcCT2WxxFgBkO8RPL+RkIXnIih4chVyBEOFihH05fDYX4TMI2+XlzVfwIMJWSLwIAApyOoCR8aecWX/Jn6HMz2ZnKXmir3HDBwkkolz2ov/zaP635eVKJ/ewQAaZLw6LVeyHnN/9nPkRShZmzIyeZAF3oiYF86VhCZPMkQSmTjKXHRShXJs7M3KSMwUhLGWeAlb8JPMkwXGTLJ4fq9wrUxzInGS2eHxfIsIyaU6C0s/nsZT5i/jxSZNcKEicOcmSnLiIqZhApV8sjVXWzxOGBkztG6LsPU/yp34FLOXaAn58mLJ39lT9PCFzKqckWVkblxcUPBWToIwXFQQo9xLlxijjebmhSr+kME65tgC5nFNrY5RnmM0Oj5lkIABRgA04dNVJAqCAt7BA0UjgfNEisSCLX0BnIm8bj84Schzs6M6Ozs4AKN7dievwnjb+TkK061O+NYjHr10ul5+e8oUi9/i4KfJYbk35LCsAUNUD4Op+jlRcOOFDK34wyNNTBZpABxgCU2AF7IEzcAfewB8Eg3AQDeJBCpiL1MoHeUAMFoBisAKUgnKwEWwF1WA32AsOgaPgBGgGZ8AFcAXcAF2gFzwCMjAAXoFh8BGMQRCEgygQFdKBjCBzyBZyhhiQLxQMRUKxUAqUDmVBQkgKFUOroHKoAqqG9kB10HHoNHQBugZ1Qw+gPmgIegd9gVEwGdaEDWALeDrMgJlwBBwPz4Gz4Hy4CC6B18NVcC18BG6CL8A34F5YBr+CR1AARULRUMYoexQDFYiKRqWiMlFi1FJUGaoSVYtqQLWiOlC3UTLUa9RnNBZNRdPR9mhvdBg6Ac1B56OXotehq9GH0E3oS+jb6D70MPo7hoLRx9hivDAsTDImC7MAU4qpxBzAnMJcxvRiBjAfsVgsDWuJ9cCGYVOw2djF2HXYndhGbBu2G9uPHcHhcDo4W5wPLhrHxhXgSnHbcUdw53E9uAHcJzwJb4R3xofgU/FC/Ep8Jf4w/hy+B/8CP0ZQI5gTvAjRBC5hEWEDYR+hlXCLMEAYI6oTLYk+xHhiNnEFsYrYQLxMfEx8TyKRTEiepFkkAWk5qYp0jHSV1Ef6TNYg25ADyWlkKXk9+SC5jfyA/J5CoVhQ/CmplALKekod5SLlKeWTClXFQYWlwlVZplKj0qTSo/JGlaBqrspUnatapFqpelL1luprNYKahVqgGlttqVqN2mm1e2oj6lR1J/Vo9Tz1deqH1a+pD2rgNCw0gjW4GiUaezUuavRTUVRTaiCVQ11F3Ue9TB3QxGpaarI0szXLNY9qdmoOa2louWolai3UqtE6qyWjoWgWNBYtl7aBdoJ2l/ZlmsE05jTetLXTGqb1TBvV1tP21+Zpl2k3avdqf9Gh6wTr5Ohs0mnWeaKL1rXRnaW7QHeX7mXd13qaet56HL0yvRN6D/VhfRv9WP3F+nv1b+qPGBgahBqIDLYbXDR4bUgz9DfMNtxieM5wyIhq5GskMNpidN7oJV2LzqTn0qvol+jDxvrGYcZS4z3GncZjJpYmCSYrTRpNnpgSTRmmmaZbTNtNh82MzKLMis3qzR6aE8wZ5nzzbeYd5qMWlhZJFqstmi0GLbUtWZZFlvWWj60oVn5W+Va1VnessdYM6xzrndZdNrCNmw3fpsbmli1s624rsN1p222HsfO0E9rV2t2zJ9sz7Qvt6+37HGgOkQ4rHZod3kw3m546fdP0junfHd0ccx33OT5y0nAKd1rp1Or0ztnGmeNc43zHheIS4rLMpcXlrautK891l+t9N6pblNtqt3a3b+4e7mL3BvchDzOPdI8dHvcYmowYxjrGVU+MZ4DnMs8znp+93L0KvE54/eFt753jfdh7cIblDN6MfTP6fUx82D57fGS+dN903598ZX7Gfmy/Wr9n/qb+XP8D/i+Y1sxs5hHmmwDHAHHAqYDRQK/AJYFtQaig0KCyoM5gjeCE4OrgpyEmIVkh9SHDoW6hi0PbwjBhEWGbwu6xDFgcVh1rONwjfEn4pQhyRFxEdcSzSJtIcWRrFBwVHrU56vFM85nCmc3RIJoVvTn6SYxlTH7ML7Ows2Jm1cx6HusUWxzbEUeNmxd3OO5jfED8hvhHCVYJ0oT2RNXEtMS6xNGkoKSKJFny9OQlyTdSdFMEKS2puNTE1AOpI7ODZ2+dPZDmllaadneO5ZyFc67N1Z2bO/fsPNV57Hkn0zHpSemH07+yo9m17JEMVsaOjGFOIGcb5xXXn7uFO8Tz4VXwXmT6ZFZkDmb5ZG3OGuL78Sv5rwWBgmrB2+yw7N3ZoznROQdz5LlJuY15+Lz0vNNCDWGO8NJ8w/kL53eLbEWlIlm+V/7W/GFxhPiABJLMkbQUaCIi6abUSvqDtK/Qt7Cm8NOCxAUnF6ovFC68uchm0dpFL4pCivYvRi/mLG4vNi5eUdy3hLlkz1JoacbS9mWmy0qWDSwPXX5oBXFFzopfVzqurFj5YVXSqtYSg5LlJf0/hP5QX6pSKi69t9p79e416DWCNZ1rXdZuX/u9jFt2vdyxvLL86zrOuus/Ov1Y9aN8feb6zg3uG3ZtxG4Ubry7yW/ToQr1iqKK/s1Rm5u20LeUbfmwdd7Wa5Wulbu3EbdJt8mqIqtatptt37j9azW/urcmoKZxh/6OtTtGd3J39uzy39Ww22B3+e4vPwl+ur8ndE9TrUVt5V7s3sK9z/cl7uvYz9hfd0D3QPmBbweFB2WHYg9dqvOoqzusf3hDPVwvrR86knak62jQ0ZYG+4Y9jbTG8mPgmPTYy+Ppx++eiDjRfpJxsuFn8593nKKeKmuCmhY1DTfzm2UtKS3dp8NPt7d6t576xeGXg2eMz9Sc1Tq74RzxXMk5+fmi8yNtorbXF7Iu9LfPa390MfninUuzLnVejrh89UrIlYsdzI7zV32unrnmde30dcb15hvuN5puut089avbr6c63Tubbnncauny7GrtntF9rsev58LtoNtX7rDu3Oid2dt9N+Hu/Xtp92T3ufcHH+Q+ePuw8OHYo+WPMY/Lnqg9qXyq/7T2N+vfGmXusrN9QX03n8U9e9TP6X/1u+T3rwMlzynPK18YvagbdB48MxQy1PVy9suBV6JXY69L/6H+jx1vrN78/If/HzeHk4cH3orfyt+te6/z/uAH1w/tIzEjTz/mfRwbLfuk8+nQZ8bnji9JX16MLfiK+1r1zfpb6/eI74/leXK5iC1mj0sBFDLgzEwA3h1EtHEKAFRElxNnT2jrcYMmvgfGCfwnntDf4+YOQAMyKWQR0x+Akwo5i8wqyKyQRPH+AHZxUY5/mSTTxXkiFxlRlphPcvl7AwBwrQB8E8vlYzvl8m/7kGIfANCWP6HpFYZFtHyD3vJRg6LbPe3g7zah9//U499noKjAFfx9/ieoZhkWVvYkwwAAAGxlWElmTU0AKgAAAAgABAEaAAUAAAABAAAAPgEbAAUAAAABAAAARgEoAAMAAAABAAIAAIdpAAQAAAABAAAATgAAAAAAAACQAAAAAQAAAJAAAAABAAKgAgAEAAAAAQAAAEKgAwAEAAAAAQAAAEIAAAAAgodoEQAAAAlwSFlzAAAWJQAAFiUBSVIk8AAABMtJREFUeAHtXM2KFDEQzrQKruIu4mEXRFlUVLz4A4K7B99AcO8io0/gwQfxDVzFuwu+gQf34EG8iOAPKAh6EFlBFMSf/qa2uqszlVR6ZtYxM5PDJNVVSer78nU6KrHzpyxuVlwx44AY2O0T8eb9D7f5fMu9fPvdff7y0/36nbdgdhUdd+jgHnf62JxbObvgjh/d60Pu2R35ajx49Mk9frqlBk7Kw8sXF9y1K4t9cCoi7tz/4F68/tYXMIkPzpzY725dP9yA1tsjoIRpIQHogRWYZSmwJ4Reh06nI2Nd7rYEA8zAzqXAxhgq/pc1d9vHKbEX+Dr4JbzypJDc/YxXYi/wifRLeOXpU5q7n/FK7EXsnBBeeRoqd7/EHj1ZhleeiMjdz8pArRKR+0pb+UsCuK0SkftKW/kzeFmrRHCAxWzufsaJOkqExWzufpOI8EpP1jnCJCK80pN1jjCJ4ICwMigidz/jRD3bI7bZUInIfaWt/KUSuK0SEd4jqFvufgYva5UIDrCYzd3POFFHifhfV/7k8lwPw7D5mUSEV3r854ju2pK7ffOIWzk/X+Go803Lr+ooGqoiwkyP9xzRXVt0q9sE3CgJYTLqfNPyE/irpkoEe2um6ck4bSiBSeD8JBl41jY/Hgd1lIiaaeoyLlsjgUGAjEH3DB4DtUpEW2Z3Mj5GAgA8efbVvXpX/200nln5IMYvKhHDrvylcwdc9+pSNdeg46WQsP7wo2s7fpWYaPT926fw9ZiVk4BpywYJkGuvlJs4EuWS0p/HTyHh3kbzH2najM85cR0lgpPiYMtukFB26m1u5Ua+vkFkWP3Zn0KCJDg1Px6f42Wtvhrhdyz8ncanrFKCmGH1wrwDMCrh/uxPIUFTAvdHbeVPsc1fVRE+c7Ud/k6fWt7XHFlYqcqQ5wTRvWpiY4wrIZwfDUL+akDRUBXB/jCzFCH9SHCzTDRUmsro7z+cEvrHwxOZn2ZTL/pVFcEBtRLoiWXfxQ5ehvoHHx4vpIwUEuJKSMvPz5/zQq0qwmIy5m+rjBQSwnsCQYnlgwjfT72av6oifOba2qnKcOXeGVIP0rT3BALTNr8mBWSpRHAgmJSTtLGhDHwj+A9GPCbX2DNiBSRoShg0H8zl5y/njxIhJ0WntralDJmIbO+UEvz85Zwt9wj7HIDB5Ttp7RkyGbRDSqC49vOjX50P9aexmr+qInzmajvtO13H02SpyrCVMNj8dT7/4BwByDXzRIC0LWXEldA/njVfip9GpV9VERxQM0lPhrVDyrCVMJr5/fwZJ+qWewR1lSuNJ21sXxnjVgIhck5VhM/cqG1WBpIAMX4Z9Xz+eP58sFUiOBArLQcZpQ0CNCXt1HzA5OfPOFGrrwYHyKTwbNJsxolaJUJbKeo0mu/4uMeXBHBbJSK88qP5jo97fAYva5UIDgivHEXk7mecqKNEhFeOhsjdbxKR+0pb+UsCuK0qIveVtvJn8LJWieAAi9nc/YwTdZQIi9nc/SYR4ZWenSO2yZvgcwTuRYZKWBnUI3e/xF7gcmio5L4HWPlL7AVuyPol95W28me8EnuBa8J+sZjM3c94JfYCd6VxTXjaCjDLe+K9cwTuSuOa8LQUYPXvh1d3w0HC7JK8kMK0/rcJfwHkVMYgi4xhOgAAAABJRU5ErkJggg==");background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-light">.hljs-comment,.hljs-quote{color:#696969}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#d91e18}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#aa5d00}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:green}.hljs-section,.hljs-title{color:#007faa}.hljs-keyword,.hljs-selector-tag{color:#7928a1}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fefefe;color:#545454}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">引言：为什么需要异步编程？</h2>
<p>想象一下，你要从10个网站下载数据。如果用传统方式，代码会等第一个网站响应后再请求第二个，这太慢了！异步编程让你可以同时发起所有请求，哪个先返回就处理哪个。</p>
<p>python</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 同步 vs 异步的直观对比</span>
<span class="hljs-keyword">import</span> time

<span class="hljs-keyword">def</span> <span class="hljs-title function_">sync_download</span>():
    <span class="hljs-string">"""同步下载 - 一个一个来"""</span>
    websites = [<span class="hljs-string">"site1"</span>, <span class="hljs-string">"site2"</span>, <span class="hljs-string">"site3"</span>]
    <span class="hljs-keyword">for</span> site <span class="hljs-keyword">in</span> websites:
        time.sleep(<span class="hljs-number">1</span>)  <span class="hljs-comment"># 模拟网络延迟</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"下载完成: <span class="hljs-subst">{site}</span>"</span>)

<span class="hljs-comment"># 同步方式需要3秒</span>
<span class="hljs-comment"># 异步方式可能只需要1秒多一点</span>
</code></pre>
<h2 data-id="heading-1">一、异步基础：async/await</h2>
<h3 data-id="heading-2">1.1 第一个异步程序</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> time

<span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 异步编程基础 ==="</span>)

<span class="hljs-comment"># 定义一个异步函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">say_hello</span>(<span class="hljs-params">name, delay</span>):
    <span class="hljs-string">"""异步打招呼函数"""</span>
    <span class="hljs-keyword">await</span> asyncio.sleep(delay)  <span class="hljs-comment"># 异步等待</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Hello, <span class="hljs-subst">{name}</span>! (等待了<span class="hljs-subst">{delay}</span>秒)"</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"Hello <span class="hljs-subst">{name}</span>"</span>

<span class="hljs-comment"># 运行异步函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"开始时间:"</span>, time.strftime(<span class="hljs-string">"%H:%M:%S"</span>))
    
    <span class="hljs-comment"># 运行一个异步任务</span>
    result = <span class="hljs-keyword">await</span> say_hello(<span class="hljs-string">"张三"</span>, <span class="hljs-number">2</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"返回值: <span class="hljs-subst">{result}</span>"</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"结束时间:"</span>, time.strftime(<span class="hljs-string">"%H:%M:%S"</span>))

<span class="hljs-comment"># Python 3.7+ 的运行方式</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"运行单个异步任务:"</span>)
asyncio.run(main())

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h3 data-id="heading-3">1.2 并发执行多个任务</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">download_file</span>(<span class="hljs-params">filename, download_time</span>):
    <span class="hljs-string">"""模拟下载文件"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"开始下载: <span class="hljs-subst">{filename}</span>"</span>)
    <span class="hljs-keyword">await</span> asyncio.sleep(download_time)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"下载完成: <span class="hljs-subst">{filename}</span> (耗时<span class="hljs-subst">{download_time}</span>秒)"</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{filename}</span>_content"</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">concurrent_downloads</span>():
    <span class="hljs-string">"""并发下载多个文件"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"开始并发下载:"</span>)
    start_time = time.time()
    
    <span class="hljs-comment"># 创建多个任务</span>
    task1 = asyncio.create_task(download_file(<span class="hljs-string">"file1.txt"</span>, <span class="hljs-number">3</span>))
    task2 = asyncio.create_task(download_file(<span class="hljs-string">"file2.txt"</span>, <span class="hljs-number">2</span>))
    task3 = asyncio.create_task(download_file(<span class="hljs-string">"file3.txt"</span>, <span class="hljs-number">1</span>))
    
    <span class="hljs-comment"># 等待所有任务完成</span>
    results = <span class="hljs-keyword">await</span> asyncio.gather(task1, task2, task3)
    
    end_time = time.time()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"所有文件下载完成! 总耗时: <span class="hljs-subst">{end_time - start_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"下载结果: <span class="hljs-subst">{results}</span>"</span>)
    
    <span class="hljs-keyword">return</span> results

<span class="hljs-built_in">print</span>(<span class="hljs-string">"并发执行多个任务:"</span>)
asyncio.run(concurrent_downloads())

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h2 data-id="heading-4">二、异步实战：网络请求</h2>
<h3 data-id="heading-5">2.1 异步HTTP请求</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> aiohttp
<span class="hljs-keyword">import</span> asyncio

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_url</span>(<span class="hljs-params">session, url, timeout=<span class="hljs-number">5</span></span>):
    <span class="hljs-string">"""异步获取URL内容"""</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(url, timeout=timeout) <span class="hljs-keyword">as</span> response:
            <span class="hljs-keyword">if</span> response.status == <span class="hljs-number">200</span>:
                content = <span class="hljs-keyword">await</span> response.text()
                <span class="hljs-keyword">return</span> {
                    <span class="hljs-string">'url'</span>: url,
                    <span class="hljs-string">'status'</span>: response.status,
                    <span class="hljs-string">'content_length'</span>: <span class="hljs-built_in">len</span>(content),
                    <span class="hljs-string">'success'</span>: <span class="hljs-literal">True</span>
                }
            <span class="hljs-keyword">else</span>:
                <span class="hljs-keyword">return</span> {
                    <span class="hljs-string">'url'</span>: url,
                    <span class="hljs-string">'status'</span>: response.status,
                    <span class="hljs-string">'success'</span>: <span class="hljs-literal">False</span>
                }
    <span class="hljs-keyword">except</span> asyncio.TimeoutError:
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'url'</span>: url,
            <span class="hljs-string">'status'</span>: <span class="hljs-string">'timeout'</span>,
            <span class="hljs-string">'success'</span>: <span class="hljs-literal">False</span>
        }
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> {
            <span class="hljs-string">'url'</span>: url,
            <span class="hljs-string">'status'</span>: <span class="hljs-string">'error'</span>,
            <span class="hljs-string">'error'</span>: <span class="hljs-built_in">str</span>(e),
            <span class="hljs-string">'success'</span>: <span class="hljs-literal">False</span>
        }

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_multiple_urls</span>(<span class="hljs-params">urls</span>):
    <span class="hljs-string">"""并发获取多个URL"""</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:
        tasks = [fetch_url(session, url) <span class="hljs-keyword">for</span> url <span class="hljs-keyword">in</span> urls]
        results = <span class="hljs-keyword">await</span> asyncio.gather(*tasks)
        <span class="hljs-keyword">return</span> results

<span class="hljs-comment"># 测试函数</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">test_http_requests</span>():
    <span class="hljs-string">"""测试HTTP请求"""</span>
    <span class="hljs-comment"># 一些测试URL（使用公开的测试API）</span>
    test_urls = [
        <span class="hljs-string">"https://httpbin.org/delay/1"</span>,  <span class="hljs-comment"># 延迟1秒</span>
        <span class="hljs-string">"https://httpbin.org/delay/2"</span>,  <span class="hljs-comment"># 延迟2秒</span>
        <span class="hljs-string">"https://httpbin.org/status/200"</span>,
        <span class="hljs-string">"https://httpbin.org/status/404"</span>,
        <span class="hljs-string">"https://httpbin.org/ip"</span>,
        <span class="hljs-string">"https://httpbin.org/user-agent"</span>
    ]
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"开始并发HTTP请求..."</span>)
    start_time = time.time()
    
    results = <span class="hljs-keyword">await</span> fetch_multiple_urls(test_urls)
    
    end_time = time.time()
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"请求完成! 总耗时: <span class="hljs-subst">{end_time - start_time:<span class="hljs-number">.2</span>f}</span>秒"</span>)
    
    <span class="hljs-comment"># 显示结果</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n请求结果:"</span>)
    <span class="hljs-keyword">for</span> i, result <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(results, <span class="hljs-number">1</span>):
        <span class="hljs-keyword">if</span> result[<span class="hljs-string">'success'</span>]:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{i}</span>. <span class="hljs-subst">{result[<span class="hljs-string">'url'</span>]}</span> - 成功, 状态码: <span class="hljs-subst">{result[<span class="hljs-string">'status'</span>]}</span>, "</span>
                  <span class="hljs-string">f"内容长度: <span class="hljs-subst">{result[<span class="hljs-string">'content_length'</span>]}</span>"</span>)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{i}</span>. <span class="hljs-subst">{result[<span class="hljs-string">'url'</span>]}</span> - 失败, 状态: <span class="hljs-subst">{result[<span class="hljs-string">'status'</span>]}</span>"</span>)
    
    <span class="hljs-keyword">return</span> results

<span class="hljs-built_in">print</span>(<span class="hljs-string">"异步HTTP请求演示:"</span>)
<span class="hljs-comment"># asyncio.run(test_http_requests())</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">"（注意：由于网络请求需要真实URL，这里只展示代码结构）"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h3 data-id="heading-6">2.2 限制并发数</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">RateLimiter</span>:
    <span class="hljs-string">"""速率限制器"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, max_concurrent</span>):
        self.semaphore = asyncio.Semaphore(max_concurrent)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">limited_fetch</span>(<span class="hljs-params">self, session, url</span>):
        <span class="hljs-string">"""带限制的获取"""</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> self.semaphore:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> fetch_url(session, url)

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">rate_limited_requests</span>(<span class="hljs-params">urls, max_concurrent=<span class="hljs-number">3</span></span>):
    <span class="hljs-string">"""带速率限制的请求"""</span>
    rate_limiter = RateLimiter(max_concurrent)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:
        tasks = []
        <span class="hljs-keyword">for</span> url <span class="hljs-keyword">in</span> urls:
            task = asyncio.create_task(
                rate_limiter.limited_fetch(session, url)
            )
            tasks.append(task)
        
        <span class="hljs-comment"># 显示进度</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"开始处理 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(urls)}</span> 个URL，并发数: <span class="hljs-subst">{max_concurrent}</span>"</span>)
        
        results = []
        <span class="hljs-keyword">for</span> i, task <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(asyncio.as_completed(tasks), <span class="hljs-number">1</span>):
            result = <span class="hljs-keyword">await</span> task
            results.append(result)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"进度: <span class="hljs-subst">{i}</span>/<span class="hljs-subst">{<span class="hljs-built_in">len</span>(urls)}</span> - <span class="hljs-subst">{result[<span class="hljs-string">'url'</span>]}</span>"</span>)
        
        <span class="hljs-keyword">return</span> results

<span class="hljs-built_in">print</span>(<span class="hljs-string">"速率限制演示:"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"可以控制同时发起的请求数量，避免对服务器造成过大压力"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h2 data-id="heading-7">三、异步文件操作</h2>
<h3 data-id="heading-8">3.1 异步读写文件</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> aiofiles
<span class="hljs-keyword">import</span> os

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">async_write_file</span>(<span class="hljs-params">filename, content</span>):
    <span class="hljs-string">"""异步写入文件"""</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiofiles.<span class="hljs-built_in">open</span>(filename, <span class="hljs-string">'w'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
            <span class="hljs-keyword">await</span> f.write(content)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"文件写入成功: <span class="hljs-subst">{filename}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"文件写入失败 <span class="hljs-subst">{filename}</span>: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">async_read_file</span>(<span class="hljs-params">filename</span>):
    <span class="hljs-string">"""异步读取文件"""</span>
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiofiles.<span class="hljs-built_in">open</span>(filename, <span class="hljs-string">'r'</span>, encoding=<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">as</span> f:
            content = <span class="hljs-keyword">await</span> f.read()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"文件读取成功: <span class="hljs-subst">{filename}</span>, 长度: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(content)}</span>"</span>)
        <span class="hljs-keyword">return</span> content
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"文件读取失败 <span class="hljs-subst">{filename}</span>: <span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_multiple_files</span>():
    <span class="hljs-string">"""处理多个文件"""</span>
    <span class="hljs-comment"># 创建一些测试文件</span>
    files_data = {
        <span class="hljs-string">"test1.txt"</span>: <span class="hljs-string">"这是第一个测试文件的内容\nHello World!"</span>,
        <span class="hljs-string">"test2.txt"</span>: <span class="hljs-string">"这是第二个测试文件\nPython异步编程很有趣"</span>,
        <span class="hljs-string">"test3.txt"</span>: <span class="hljs-string">"第三个文件\n"</span> + <span class="hljs-string">"数据行\n"</span> * <span class="hljs-number">10</span>
    }
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"开始异步文件操作演示..."</span>)
    
    <span class="hljs-comment"># 并发写入文件</span>
    write_tasks = []
    <span class="hljs-keyword">for</span> filename, content <span class="hljs-keyword">in</span> files_data.items():
        task = asyncio.create_task(async_write_file(filename, content))
        write_tasks.append(task)
    
    write_results = <span class="hljs-keyword">await</span> asyncio.gather(*write_tasks)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"写入完成，成功: <span class="hljs-subst">{<span class="hljs-built_in">sum</span>(write_results)}</span>/<span class="hljs-subst">{<span class="hljs-built_in">len</span>(write_results)}</span>"</span>)
    
    <span class="hljs-comment"># 并发读取文件</span>
    read_tasks = []
    <span class="hljs-keyword">for</span> filename <span class="hljs-keyword">in</span> files_data.keys():
        task = asyncio.create_task(async_read_file(filename))
        read_tasks.append(task)
    
    read_results = <span class="hljs-keyword">await</span> asyncio.gather(*read_tasks)
    
    <span class="hljs-comment"># 显示读取的内容摘要</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n文件内容摘要:"</span>)
    <span class="hljs-keyword">for</span> filename, content <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(files_data.keys(), read_results):
        <span class="hljs-keyword">if</span> content:
            preview = content[:<span class="hljs-number">50</span>].replace(<span class="hljs-string">'\n'</span>, <span class="hljs-string">' '</span>) + <span class="hljs-string">"..."</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{filename}</span>: <span class="hljs-subst">{preview}</span>"</span>)
    
    <span class="hljs-comment"># 清理测试文件</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n清理测试文件..."</span>)
    <span class="hljs-keyword">for</span> filename <span class="hljs-keyword">in</span> files_data.keys():
        <span class="hljs-keyword">try</span>:
            os.remove(filename)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"删除: <span class="hljs-subst">{filename}</span>"</span>)
        <span class="hljs-keyword">except</span>:
            <span class="hljs-keyword">pass</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">"异步文件操作演示:"</span>)
<span class="hljs-comment"># asyncio.run(process_multiple_files())</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h2 data-id="heading-9">四、异步与数据库</h2>
<h3 data-id="heading-10">4.1 异步数据库操作</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 这里以SQLite为例，实际中常用的是异步MySQL/PostgreSQL驱动</span>
<span class="hljs-keyword">import</span> aiosqlite

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">async_database_demo</span>():
    <span class="hljs-string">"""异步数据库操作演示"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"开始异步数据库演示..."</span>)
    
    <span class="hljs-comment"># 创建内存数据库</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiosqlite.connect(<span class="hljs-string">':memory:'</span>) <span class="hljs-keyword">as</span> db:
        <span class="hljs-comment"># 创建表</span>
        <span class="hljs-keyword">await</span> db.execute(<span class="hljs-string">'''
            CREATE TABLE users (
                id INTEGER PRIMARY KEY AUTOINCREMENT,
                name TEXT NOT NULL,
                email TEXT UNIQUE NOT NULL,
                age INTEGER
            )
        '''</span>)
        <span class="hljs-keyword">await</span> db.commit()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"表创建成功"</span>)
        
        <span class="hljs-comment"># 插入数据</span>
        users = [
            (<span class="hljs-string">'张三'</span>, <span class="hljs-string">'zhangsan@example.com'</span>, <span class="hljs-number">25</span>),
            (<span class="hljs-string">'李四'</span>, <span class="hljs-string">'lisi@example.com'</span>, <span class="hljs-number">30</span>),
            (<span class="hljs-string">'王五'</span>, <span class="hljs-string">'wangwu@example.com'</span>, <span class="hljs-number">28</span>),
            (<span class="hljs-string">'赵六'</span>, <span class="hljs-string">'zhaoliu@example.com'</span>, <span class="hljs-number">35</span>)
        ]
        
        <span class="hljs-comment"># 并发插入</span>
        insert_tasks = []
        <span class="hljs-keyword">for</span> name, email, age <span class="hljs-keyword">in</span> users:
            task = asyncio.create_task(
                db.execute(
                    <span class="hljs-string">"INSERT INTO users (name, email, age) VALUES (?, ?, ?)"</span>,
                    (name, email, age)
                )
            )
            insert_tasks.append(task)
        
        <span class="hljs-keyword">await</span> asyncio.gather(*insert_tasks)
        <span class="hljs-keyword">await</span> db.commit()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"插入 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(users)}</span> 条记录成功"</span>)
        
        <span class="hljs-comment"># 查询数据</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> db.execute(<span class="hljs-string">"SELECT * FROM users ORDER BY age"</span>) <span class="hljs-keyword">as</span> cursor:
            rows = <span class="hljs-keyword">await</span> cursor.fetchall()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n用户列表 (按年龄排序):"</span>)
            <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> rows:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  ID: <span class="hljs-subst">{row[<span class="hljs-number">0</span>]}</span>, 姓名: <span class="hljs-subst">{row[<span class="hljs-number">1</span>]}</span>, 邮箱: <span class="hljs-subst">{row[<span class="hljs-number">2</span>]}</span>, 年龄: <span class="hljs-subst">{row[<span class="hljs-number">3</span>]}</span>"</span>)
        
        <span class="hljs-comment"># 复杂查询</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n统计信息:"</span>)
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> db.execute(<span class="hljs-string">"SELECT COUNT(*), AVG(age) FROM users"</span>) <span class="hljs-keyword">as</span> cursor:
            count, avg_age = <span class="hljs-keyword">await</span> cursor.fetchone()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  用户总数: <span class="hljs-subst">{count}</span>"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  平均年龄: <span class="hljs-subst">{avg_age:<span class="hljs-number">.1</span>f}</span>"</span>)
        
        <span class="hljs-comment"># 事务演示</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n事务演示:"</span>)
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">await</span> db.execute(<span class="hljs-string">"BEGIN TRANSACTION"</span>)
            
            <span class="hljs-comment"># 更新操作</span>
            <span class="hljs-keyword">await</span> db.execute(<span class="hljs-string">"UPDATE users SET age = age + 1 WHERE age &lt; 30"</span>)
            
            <span class="hljs-comment"># 模拟一个可能失败的操作</span>
            should_fail = <span class="hljs-literal">False</span>
            <span class="hljs-keyword">if</span> should_fail:
                <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">"模拟事务失败"</span>)
            
            <span class="hljs-keyword">await</span> db.execute(<span class="hljs-string">"DELETE FROM users WHERE age &gt; 40"</span>)
            
            <span class="hljs-keyword">await</span> db.execute(<span class="hljs-string">"COMMIT"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"  事务提交成功"</span>)
            
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-keyword">await</span> db.execute(<span class="hljs-string">"ROLLBACK"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  事务回滚: <span class="hljs-subst">{e}</span>"</span>)
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n演示完成!"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"异步数据库操作演示:"</span>)
<span class="hljs-comment"># asyncio.run(async_database_demo())</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h2 data-id="heading-11">五、异步Web框架：FastAPI实战</h2>
<h3 data-id="heading-12">5.1 快速创建异步API</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI, HTTPException, BackgroundTasks
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>, <span class="hljs-type">Optional</span>
<span class="hljs-keyword">import</span> asyncio

<span class="hljs-comment"># 创建FastAPI应用</span>
app = FastAPI(title=<span class="hljs-string">"异步API演示"</span>, version=<span class="hljs-string">"1.0.0"</span>)

<span class="hljs-comment"># 数据模型</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Item</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    name: <span class="hljs-built_in">str</span>
    description: <span class="hljs-type">Optional</span>[<span class="hljs-built_in">str</span>] = <span class="hljs-literal">None</span>
    price: <span class="hljs-built_in">float</span>
    stock: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    item_id: <span class="hljs-built_in">int</span>
    quantity: <span class="hljs-built_in">int</span>
    customer_name: <span class="hljs-built_in">str</span>

<span class="hljs-comment"># 模拟数据库</span>
fake_items_db = {
    <span class="hljs-number">1</span>: Item(name=<span class="hljs-string">"笔记本电脑"</span>, description=<span class="hljs-string">"高性能游戏本"</span>, price=<span class="hljs-number">6999.99</span>, stock=<span class="hljs-number">10</span>),
    <span class="hljs-number">2</span>: Item(name=<span class="hljs-string">"智能手机"</span>, description=<span class="hljs-string">"最新款5G手机"</span>, price=<span class="hljs-number">3999.99</span>, stock=<span class="hljs-number">50</span>),
    <span class="hljs-number">3</span>: Item(name=<span class="hljs-string">"平板电脑"</span>, description=<span class="hljs-string">"轻薄便携"</span>, price=<span class="hljs-number">2999.99</span>, stock=<span class="hljs-number">30</span>)
}

orders_db = []

<span class="hljs-comment"># 异步任务（模拟耗时操作）</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_order_background</span>(<span class="hljs-params">order_id: <span class="hljs-built_in">int</span>, order_data: Order</span>):
    <span class="hljs-string">"""后台处理订单"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[后台] 开始处理订单 <span class="hljs-subst">{order_id}</span>"</span>)
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">3</span>)  <span class="hljs-comment"># 模拟耗时处理</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[后台] 订单 <span class="hljs-subst">{order_id}</span> 处理完成: <span class="hljs-subst">{order_data.customer_name}</span> 购买了 <span class="hljs-subst">{order_data.quantity}</span> 件商品"</span>)

<span class="hljs-comment"># API端点</span>
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">root</span>():
    <span class="hljs-string">"""根路径"""</span>
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">"欢迎使用异步API"</span>, <span class="hljs-string">"status"</span>: <span class="hljs-string">"运行中"</span>}

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/items/"</span>, response_model=<span class="hljs-type">List</span>[Item]</span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">list_items</span>(<span class="hljs-params">skip: <span class="hljs-built_in">int</span> = <span class="hljs-number">0</span>, limit: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span></span>):
    <span class="hljs-string">"""获取商品列表（支持分页）"""</span>
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">0.5</span>)  <span class="hljs-comment"># 模拟数据库查询延迟</span>
    items = <span class="hljs-built_in">list</span>(fake_items_db.values())[skip:skip + limit]
    <span class="hljs-keyword">return</span> items

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/items/{item_id}"</span>, response_model=Item</span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_item</span>(<span class="hljs-params">item_id: <span class="hljs-built_in">int</span></span>):
    <span class="hljs-string">"""获取单个商品"""</span>
    <span class="hljs-keyword">if</span> item_id <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> fake_items_db:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">404</span>, detail=<span class="hljs-string">"商品未找到"</span>)
    
    <span class="hljs-comment"># 模拟复杂的异步查询</span>
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">0.3</span>)
    <span class="hljs-keyword">return</span> fake_items_db[item_id]

<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/orders/"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">create_order</span>(<span class="hljs-params">order: Order, background_tasks: BackgroundTasks</span>):
    <span class="hljs-string">"""创建订单（使用后台任务）"""</span>
    <span class="hljs-keyword">if</span> order.item_id <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> fake_items_db:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">404</span>, detail=<span class="hljs-string">"商品不存在"</span>)
    
    item = fake_items_db[order.item_id]
    <span class="hljs-keyword">if</span> order.quantity &gt; item.stock:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">400</span>, detail=<span class="hljs-string">"库存不足"</span>)
    
    <span class="hljs-comment"># 更新库存</span>
    item.stock -= order.quantity
    
    <span class="hljs-comment"># 生成订单ID</span>
    order_id = <span class="hljs-built_in">len</span>(orders_db) + <span class="hljs-number">1</span>
    
    <span class="hljs-comment"># 将订单加入数据库</span>
    orders_db.append({
        <span class="hljs-string">"id"</span>: order_id,
        **order.<span class="hljs-built_in">dict</span>(),
        <span class="hljs-string">"total_price"</span>: item.price * order.quantity,
        <span class="hljs-string">"status"</span>: <span class="hljs-string">"processing"</span>
    })
    
    <span class="hljs-comment"># 添加后台任务</span>
    background_tasks.add_task(process_order_background, order_id, order)
    
    <span class="hljs-keyword">return</span> {
        <span class="hljs-string">"order_id"</span>: order_id,
        <span class="hljs-string">"message"</span>: <span class="hljs-string">"订单已接收，正在处理中"</span>,
        <span class="hljs-string">"total"</span>: item.price * order.quantity
    }

<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/orders/{order_id}"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_order_status</span>(<span class="hljs-params">order_id: <span class="hljs-built_in">int</span></span>):
    <span class="hljs-string">"""获取订单状态"""</span>
    <span class="hljs-keyword">if</span> order_id &lt; <span class="hljs-number">1</span> <span class="hljs-keyword">or</span> order_id &gt; <span class="hljs-built_in">len</span>(orders_db):
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">404</span>, detail=<span class="hljs-string">"订单不存在"</span>)
    
    <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">0.2</span>)  <span class="hljs-comment"># 模拟查询延迟</span>
    <span class="hljs-keyword">return</span> orders_db[order_id - <span class="hljs-number">1</span>]

<span class="hljs-comment"># 运行服务器（这段代码在实际文件中运行）</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-keyword">import</span> uvicorn
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"启动FastAPI服务器..."</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"访问 http://localhost:8000/docs 查看API文档"</span>)
    uvicorn.run(app, host=<span class="hljs-string">"0.0.0.0"</span>, port=<span class="hljs-number">8000</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"FastAPI异步Web框架演示:"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"1. 定义了Item和Order数据模型"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"2. 创建了商品列表、查询、下单等API端点"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"3. 使用BackgroundTasks处理耗时操作"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"4. 支持异步数据库操作（示例中是内存存储）"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h2 data-id="heading-13">六、性能优化与错误处理</h2>
<h3 data-id="heading-14">6.1 异步性能监控</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> contextlib <span class="hljs-keyword">import</span> asynccontextmanager

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncTimer</span>:
    <span class="hljs-string">"""异步计时器"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name</span>):
        self.name = name
        self.start_time = <span class="hljs-literal">None</span>
        self.end_time = <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">__aenter__</span>(<span class="hljs-params">self</span>):
        self.start_time = time.time()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[计时开始] <span class="hljs-subst">{self.name}</span>"</span>)
        <span class="hljs-keyword">return</span> self
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">__aexit__</span>(<span class="hljs-params">self, exc_type, exc_val, exc_tb</span>):
        self.end_time = time.time()
        duration = self.end_time - self.start_time
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[计时结束] <span class="hljs-subst">{self.name}</span>: <span class="hljs-subst">{duration:<span class="hljs-number">.4</span>f}</span>秒"</span>)
        <span class="hljs-keyword">if</span> exc_type:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[错误] <span class="hljs-subst">{self.name}</span>: <span class="hljs-subst">{exc_val}</span>"</span>)

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">monitored_operation</span>():
    <span class="hljs-string">"""被监控的操作"""</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> AsyncTimer(<span class="hljs-string">"monitored_operation"</span>):
        <span class="hljs-comment"># 模拟一些异步操作</span>
        <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">1</span>)
        
        <span class="hljs-comment"># 模拟可能失败的操作</span>
        <span class="hljs-keyword">if</span> time.time() % <span class="hljs-number">2</span> &gt; <span class="hljs-number">1</span>:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">"随机错误"</span>)
        
        <span class="hljs-comment"># 更多操作</span>
        <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">0.5</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-string">"操作成功"</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">error_handling_demo</span>():
    <span class="hljs-string">"""错误处理演示"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 异步错误处理 ==="</span>)
    
    <span class="hljs-comment"># 1. 基本的try-except</span>
    <span class="hljs-keyword">try</span>:
        result = <span class="hljs-keyword">await</span> monitored_operation()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"结果: <span class="hljs-subst">{result}</span>"</span>)
    <span class="hljs-keyword">except</span> ValueError <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"捕获到错误: <span class="hljs-subst">{e}</span>"</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n2. asyncio.gather的错误处理:"</span>)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">task_with_error</span>(<span class="hljs-params">n</span>):
        <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">0.1</span>)
        <span class="hljs-keyword">if</span> n == <span class="hljs-number">2</span>:
            <span class="hljs-keyword">raise</span> ValueError(<span class="hljs-string">f"任务 <span class="hljs-subst">{n}</span> 故意失败"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"任务 <span class="hljs-subst">{n}</span> 成功"</span>
    
    <span class="hljs-comment"># 方式1: 全部完成，收集异常</span>
    tasks = [task_with_error(i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>)]
    results = <span class="hljs-keyword">await</span> asyncio.gather(*tasks, return_exceptions=<span class="hljs-literal">True</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"所有任务结果:"</span>)
    <span class="hljs-keyword">for</span> i, result <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(results):
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(result, Exception):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  任务 <span class="hljs-subst">{i}</span>: 失败 - <span class="hljs-subst">{result}</span>"</span>)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  任务 <span class="hljs-subst">{i}</span>: 成功 - <span class="hljs-subst">{result}</span>"</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n3. asyncio.wait的错误处理:"</span>)
    
    tasks = [asyncio.create_task(task_with_error(i)) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>)]
    
    <span class="hljs-comment"># 等待所有任务完成</span>
    done, pending = <span class="hljs-keyword">await</span> asyncio.wait(tasks, return_when=asyncio.ALL_COMPLETED)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"完成的任务:"</span>)
    <span class="hljs-keyword">for</span> task <span class="hljs-keyword">in</span> done:
        <span class="hljs-keyword">try</span>:
            result = task.result()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  成功: <span class="hljs-subst">{result}</span>"</span>)
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  失败: <span class="hljs-subst">{e}</span>"</span>)

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">performance_optimization</span>():
    <span class="hljs-string">"""性能优化技巧"""</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 性能优化技巧 ==="</span>)
    
    <span class="hljs-comment"># 1. 避免在热路径中使用await</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"1. 避免不必要的await:"</span>)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">inefficient</span>():
        <span class="hljs-string">"""低效的实现"""</span>
        result = []
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):
            <span class="hljs-comment"># 每次循环都await，效率低</span>
            <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">0.01</span>)
            result.append(i)
        <span class="hljs-keyword">return</span> result
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">efficient</span>():
        <span class="hljs-string">"""高效的实现"""</span>
        <span class="hljs-comment"># 批量创建任务</span>
        tasks = []
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):
            task = asyncio.create_task(asyncio.sleep(<span class="hljs-number">0.01</span>))
            tasks.append((task, i))
        
        <span class="hljs-comment"># 一次性等待所有任务</span>
        results = []
        <span class="hljs-keyword">for</span> task, i <span class="hljs-keyword">in</span> tasks:
            <span class="hljs-keyword">await</span> task
            results.append(i)
        
        <span class="hljs-keyword">return</span> results
    
    <span class="hljs-comment"># 2. 使用asyncio.Queue进行流量控制</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n2. 使用asyncio.Queue:"</span>)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">worker</span>(<span class="hljs-params">name, queue</span>):
        <span class="hljs-string">"""工作者协程"""</span>
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            item = <span class="hljs-keyword">await</span> queue.get()
            <span class="hljs-keyword">if</span> item <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:  <span class="hljs-comment"># 终止信号</span>
                <span class="hljs-keyword">break</span>
            
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{name}</span> 处理: <span class="hljs-subst">{item}</span>"</span>)
            <span class="hljs-keyword">await</span> asyncio.sleep(<span class="hljs-number">0.1</span>)
            queue.task_done()
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">queue_demo</span>():
        <span class="hljs-string">"""队列演示"""</span>
        queue = asyncio.Queue(maxsize=<span class="hljs-number">5</span>)
        
        <span class="hljs-comment"># 启动工作者</span>
        workers = [
            asyncio.create_task(worker(<span class="hljs-string">f"Worker-<span class="hljs-subst">{i}</span>"</span>, queue))
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">3</span>)
        ]
        
        <span class="hljs-comment"># 生产项目</span>
        <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">10</span>):
            <span class="hljs-keyword">await</span> queue.put(<span class="hljs-string">f"Item-<span class="hljs-subst">{i}</span>"</span>)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"生产: Item-<span class="hljs-subst">{i}</span>"</span>)
        
        <span class="hljs-comment"># 等待所有项目被处理</span>
        <span class="hljs-keyword">await</span> queue.join()
        
        <span class="hljs-comment"># 停止工作者</span>
        <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> workers:
            <span class="hljs-keyword">await</span> queue.put(<span class="hljs-literal">None</span>)
        
        <span class="hljs-keyword">await</span> asyncio.gather(*workers)
    
    <span class="hljs-keyword">await</span> queue_demo()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"性能优化与错误处理:"</span>)
asyncio.run(error_handling_demo())
<span class="hljs-comment"># asyncio.run(performance_optimization())</span>

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h2 data-id="heading-15">七、实战项目：异步爬虫系统</h2>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> aiohttp
<span class="hljs-keyword">from</span> urllib.parse <span class="hljs-keyword">import</span> urlparse, urljoin
<span class="hljs-keyword">from</span> bs4 <span class="hljs-keyword">import</span> BeautifulSoup
<span class="hljs-keyword">import</span> re

<span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncWebCrawler</span>:
    <span class="hljs-string">"""异步网络爬虫"""</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, start_url, max_depth=<span class="hljs-number">2</span>, max_concurrent=<span class="hljs-number">10</span></span>):
        self.start_url = start_url
        self.max_depth = max_depth
        self.max_concurrent = max_concurrent
        self.visited_urls = <span class="hljs-built_in">set</span>()
        self.results = []
        self.semaphore = asyncio.Semaphore(max_concurrent)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">normalize_url</span>(<span class="hljs-params">self, url, base_url</span>):
        <span class="hljs-string">"""标准化URL"""</span>
        <span class="hljs-keyword">if</span> url.startswith(<span class="hljs-string">'#'</span>):
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
        <span class="hljs-keyword">if</span> url.startswith(<span class="hljs-string">'javascript:'</span>):
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
        
        <span class="hljs-comment"># 转换为绝对URL</span>
        absolute_url = urljoin(base_url, url)
        
        <span class="hljs-comment"># 移除片段标识符</span>
        parsed = urlparse(absolute_url)
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{parsed.scheme}</span>://<span class="hljs-subst">{parsed.netloc}</span><span class="hljs-subst">{parsed.path}</span>"</span>
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">fetch_page</span>(<span class="hljs-params">self, session, url</span>):
        <span class="hljs-string">"""获取页面内容"""</span>
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> self.semaphore:
            <span class="hljs-keyword">try</span>:
                <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(url, timeout=<span class="hljs-number">10</span>) <span class="hljs-keyword">as</span> response:
                    <span class="hljs-keyword">if</span> response.status == <span class="hljs-number">200</span>:
                        content_type = response.headers.get(<span class="hljs-string">'content-type'</span>, <span class="hljs-string">''</span>)
                        <span class="hljs-keyword">if</span> <span class="hljs-string">'text/html'</span> <span class="hljs-keyword">in</span> content_type:
                            html = <span class="hljs-keyword">await</span> response.text()
                            <span class="hljs-keyword">return</span> {
                                <span class="hljs-string">'url'</span>: url,
                                <span class="hljs-string">'html'</span>: html,
                                <span class="hljs-string">'status'</span>: <span class="hljs-string">'success'</span>
                            }
                        <span class="hljs-keyword">else</span>:
                            <span class="hljs-keyword">return</span> {
                                <span class="hljs-string">'url'</span>: url,
                                <span class="hljs-string">'status'</span>: <span class="hljs-string">'not_html'</span>,
                                <span class="hljs-string">'content_type'</span>: content_type
                            }
                    <span class="hljs-keyword">else</span>:
                        <span class="hljs-keyword">return</span> {
                            <span class="hljs-string">'url'</span>: url,
                            <span class="hljs-string">'status'</span>: <span class="hljs-string">'error'</span>,
                            <span class="hljs-string">'status_code'</span>: response.status
                        }
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                <span class="hljs-keyword">return</span> {
                    <span class="hljs-string">'url'</span>: url,
                    <span class="hljs-string">'status'</span>: <span class="hljs-string">'exception'</span>,
                    <span class="hljs-string">'error'</span>: <span class="hljs-built_in">str</span>(e)
                }
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_links</span>(<span class="hljs-params">self, html, base_url</span>):
        <span class="hljs-string">"""从HTML中提取链接"""</span>
        soup = BeautifulSoup(html, <span class="hljs-string">'html.parser'</span>)
        links = []
        
        <span class="hljs-keyword">for</span> link <span class="hljs-keyword">in</span> soup.find_all(<span class="hljs-string">'a'</span>, href=<span class="hljs-literal">True</span>):
            url = self.normalize_url(link[<span class="hljs-string">'href'</span>], base_url)
            <span class="hljs-keyword">if</span> url <span class="hljs-keyword">and</span> url <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.visited_urls:
                links.append(url)
        
        <span class="hljs-comment"># 提取标题</span>
        title = soup.title.string <span class="hljs-keyword">if</span> soup.title <span class="hljs-keyword">else</span> <span class="hljs-string">"无标题"</span>
        
        <span class="hljs-comment"># 提取正文（简化版）</span>
        text = soup.get_text()
        text = re.sub(<span class="hljs-string">r'\s+'</span>, <span class="hljs-string">' '</span>, text).strip()
        
        <span class="hljs-keyword">return</span> links, title, text[:<span class="hljs-number">200</span>]  <span class="hljs-comment"># 只取前200字符</span>
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">crawl</span>(<span class="hljs-params">self, session, url, depth=<span class="hljs-number">0</span></span>):
        <span class="hljs-string">"""递归爬取"""</span>
        <span class="hljs-keyword">if</span> depth &gt; self.max_depth:
            <span class="hljs-keyword">return</span>
        
        <span class="hljs-keyword">if</span> url <span class="hljs-keyword">in</span> self.visited_urls:
            <span class="hljs-keyword">return</span>
        
        self.visited_urls.add(url)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[深度 <span class="hljs-subst">{depth}</span>] 爬取: <span class="hljs-subst">{url}</span>"</span>)
        
        <span class="hljs-comment"># 获取页面</span>
        result = <span class="hljs-keyword">await</span> self.fetch_page(session, url)
        
        <span class="hljs-keyword">if</span> result[<span class="hljs-string">'status'</span>] == <span class="hljs-string">'success'</span>:
            html = result[<span class="hljs-string">'html'</span>]
            links, title, preview = self.extract_links(html, url)
            
            <span class="hljs-comment"># 保存结果</span>
            self.results.append({
                <span class="hljs-string">'url'</span>: url,
                <span class="hljs-string">'title'</span>: title,
                <span class="hljs-string">'preview'</span>: preview,
                <span class="hljs-string">'depth'</span>: depth,
                <span class="hljs-string">'link_count'</span>: <span class="hljs-built_in">len</span>(links)
            })
            
            <span class="hljs-comment"># 递归爬取链接</span>
            <span class="hljs-keyword">if</span> depth &lt; self.max_depth <span class="hljs-keyword">and</span> links:
                tasks = []
                <span class="hljs-keyword">for</span> link <span class="hljs-keyword">in</span> links:
                    <span class="hljs-keyword">if</span> link <span class="hljs-keyword">not</span> <span class="hljs-keyword">in</span> self.visited_urls:
                        task = asyncio.create_task(
                            self.crawl(session, link, depth + <span class="hljs-number">1</span>)
                        )
                        tasks.append(task)
                
                <span class="hljs-keyword">if</span> tasks:
                    <span class="hljs-keyword">await</span> asyncio.gather(*tasks)
    
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""运行爬虫"""</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"开始爬虫: <span class="hljs-subst">{self.start_url}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"最大深度: <span class="hljs-subst">{self.max_depth}</span>, 最大并发: <span class="hljs-subst">{self.max_concurrent}</span>"</span>)
        
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:
            <span class="hljs-keyword">await</span> self.crawl(session, self.start_url)
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n爬虫完成!"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"总共访问了 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(self.visited_urls)}</span> 个URL"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"收集了 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(self.results)}</span> 个页面"</span>)
        
        <span class="hljs-keyword">return</span> self.results

<span class="hljs-comment"># 使用示例</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">crawler_demo</span>():
    <span class="hljs-string">"""爬虫演示"""</span>
    <span class="hljs-comment"># 注意：实际使用时请遵守robots.txt，不要对网站造成压力</span>
    crawler = AsyncWebCrawler(
        start_url=<span class="hljs-string">"https://httpbin.org/html"</span>,  <span class="hljs-comment"># 使用测试页面</span>
        max_depth=<span class="hljs-number">1</span>,
        max_concurrent=<span class="hljs-number">5</span>
    )
    
    results = <span class="hljs-keyword">await</span> crawler.run()
    
    <span class="hljs-comment"># 显示结果</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n爬取结果:"</span>)
    <span class="hljs-keyword">for</span> i, result <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(results[:<span class="hljs-number">5</span>], <span class="hljs-number">1</span>):  <span class="hljs-comment"># 只显示前5个</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{i}</span>. <span class="hljs-subst">{result[<span class="hljs-string">'title'</span>]}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"   地址: <span class="hljs-subst">{result[<span class="hljs-string">'url'</span>]}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"   深度: <span class="hljs-subst">{result[<span class="hljs-string">'depth'</span>]}</span>, 链接数: <span class="hljs-subst">{result[<span class="hljs-string">'link_count'</span>]}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"   预览: <span class="hljs-subst">{result[<span class="hljs-string">'preview'</span>]}</span>"</span>)
        <span class="hljs-built_in">print</span>()

<span class="hljs-built_in">print</span>(<span class="hljs-string">"异步爬虫系统演示:"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"这个爬虫可以并发访问多个页面，高效收集网络信息"</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">"注意：实际使用时需要遵守网站规则，添加延迟避免被封"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n"</span> + <span class="hljs-string">"="</span>*<span class="hljs-number">50</span>)
</code></pre>
<h2 data-id="heading-16">总结：异步编程的最佳实践</h2>
<h3 data-id="heading-17">适合异步的场景：</h3>
<ol>
<li>✅ <strong>I/O密集型任务</strong>（网络请求、文件读写、数据库查询）</li>
<li>✅ <strong>高并发服务</strong>（Web服务器、API服务）</li>
<li>✅ <strong>实时应用</strong>（聊天室、实时通知）</li>
<li>✅ <strong>爬虫和数据采集</strong></li>
</ol>
<h3 data-id="heading-18">不适合异步的场景：</h3>
<ol>
<li>❌ <strong>CPU密集型任务</strong>（科学计算、图像处理）</li>
<li>❌ <strong>简单脚本</strong>（没有并发需求）</li>
<li>❌ <strong>对顺序有严格要求的任务</strong></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[maven打包方法]]></title>    <link>https://juejin.cn/post/7587671647400378408</link>    <guid>https://juejin.cn/post/7587671647400378408</guid>    <pubDate>2025-12-26T05:23:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587671647400378408" data-draft-id="7587652709395759104" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="maven打包方法"/> <meta itemprop="keywords" content="maven"/> <meta itemprop="datePublished" content="2025-12-26T05:23:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿杰AJie"/> <meta itemprop="url" content="https://juejin.cn/user/3871838955636704"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            maven打包方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3871838955636704/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿杰AJie
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T05:23:32.000Z" title="Fri Dec 26 2025 05:23:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>想打包 Maven 项目，可以根据不同需求（普通 jar、可执行 jar、war 包等）选择不同方法。下面给一个完整的说明：</p>
<hr/>
<h2 data-id="heading-0"><strong>1. 基础前提</strong></h2>
<p>确保你已经：</p>
<ul>
<li>安装了 <strong>JDK</strong>（通常 8+）</li>
<li>安装了 <strong>Maven</strong></li>
<li>在项目根目录有 <strong>pom.xml</strong></li>
</ul>
<p>可以在命令行中验证：</p>
<pre><code class="hljs">mvn -v
java -version
</code></pre>
<hr/>
<h2 data-id="heading-1"><strong>2. 打包命令</strong></h2>
<h3 data-id="heading-2"><strong>2.1 普通 jar 包</strong></h3>
<pre><code class="hljs language-go" lang="go">mvn clean <span class="hljs-keyword">package</span>
</code></pre>
<p>说明：</p>
<ul>
<li>
<p><code>clean</code>：先清理之前的编译文件</p>
</li>
<li>
<p><code>package</code>：编译项目并生成 jar/war 文件</p>
</li>
<li>
<p>打包结果：</p>
<ul>
<li>在 <code>target/</code> 目录下生成 <code>项目名-version.jar</code></li>
</ul>
</li>
</ul>
<hr/>
<h3 data-id="heading-3"><strong>2.2 可执行 jar（Spring Boot 项目）</strong></h3>
<p>如果是 <strong>Spring Boot</strong>，一般需要包含依赖，可以使用：</p>
<pre><code class="hljs language-go" lang="go">mvn clean <span class="hljs-keyword">package</span> spring-boot:repackage
</code></pre>
<p>或者：</p>
<pre><code class="hljs">mvn clean install
</code></pre>
<p>说明：</p>
<ul>
<li><code>install</code>：会把 jar 安装到本地仓库，方便其他项目依赖</li>
<li>打包后生成可直接执行的 jar：</li>
</ul>
<pre><code class="hljs">java -jar target/项目名-version.jar
</code></pre>
<hr/>
<h3 data-id="heading-4"><strong>2.3 war 包</strong></h3>
<p>如果项目是 Web 项目：</p>
<pre><code class="hljs language-go" lang="go">mvn clean <span class="hljs-keyword">package</span>
</code></pre>
<ul>
<li>
<p>在 pom.xml 中设置 <code>&lt;packaging&gt;war&lt;/packaging&gt;</code></p>
</li>
<li>
<p>打包结果：</p>
<ul>
<li>在 <code>target/</code> 下生成 <code>项目名-version.war</code></li>
</ul>
</li>
<li>
<p>可直接部署到 Tomcat 或其他容器</p>
</li>
</ul>
<hr/>
<h2 data-id="heading-5"><strong>3. 常用参数</strong></h2>
<ul>
<li>指定 profile：</li>
</ul>
<pre><code class="hljs language-go" lang="go">mvn clean <span class="hljs-keyword">package</span> -Pprod
</code></pre>
<ul>
<li>跳过测试：</li>
</ul>
<pre><code class="hljs language-go" lang="go">mvn clean <span class="hljs-keyword">package</span> -DskipTests
</code></pre>
<ul>
<li>指定 Maven 本地仓库：</li>
</ul>
<pre><code class="hljs language-lua" lang="lua">mvn clean <span class="hljs-built_in">package</span> -Dmaven.repo.<span class="hljs-keyword">local</span>=/<span class="hljs-built_in">path</span>/to/repo
</code></pre>
<hr/>
<h2 data-id="heading-6"><strong>4. 注意事项</strong></h2>
<ol>
<li><strong>依赖冲突</strong>：打包前最好 <code>mvn dependency:tree</code> 检查。</li>
<li><strong>编码问题</strong>：打包报中文乱码可在 pom.xml 设置：</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="hljs-tag">&lt;/<span class="hljs-name">project.build.sourceEncoding</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>
</code></pre>
<ol start="3">
<li><strong>Spring Boot 项目</strong>：不要手动修改 <code>target/dependency</code>，使用 Maven 插件打包。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[阿里二面：新生代垃圾回收为啥使用标记复制算法？]]></title>    <link>https://juejin.cn/post/7587785079738318854</link>    <guid>https://juejin.cn/post/7587785079738318854</guid>    <pubDate>2025-12-26T06:38:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587785079738318854" data-draft-id="7555815483686125609" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="阿里二面：新生代垃圾回收为啥使用标记复制算法？"/> <meta itemprop="keywords" content="面试,Java,后端"/> <meta itemprop="datePublished" content="2025-12-26T06:38:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员飞鱼"/> <meta itemprop="url" content="https://juejin.cn/user/1665088861772688"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            阿里二面：新生代垃圾回收为啥使用标记复制算法？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1665088861772688/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员飞鱼
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T06:38:11.000Z" title="Fri Dec 26 2025 06:38:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><p><strong>文章内容收录到个人网站，方便阅读</strong>：<a href="https://link.juejin.cn?target=http%3A%2F%2Fhardyfish.top%2F" target="_blank" title="http://hardyfish.top/" ref="nofollow noopener noreferrer">hardyfish.top/</a></p>
<blockquote>
<p>新生代垃圾回收采用<strong>标记-复制（Mark-Copy）算法</strong>的原因，主要是因为它非常适合新生代的内存特点。</p>
</blockquote>
<p>新生代特点：</p>
<blockquote>
<p><strong>对象生命周期短暂</strong>：大部分新生代对象（80%～90%）会很快变成垃圾，存活率低。</p>
<p><strong>回收频率高</strong>：新生代内存回收频繁，效率要求高。</p>
</blockquote>
<p>标记-复制算法原理：</p>
<blockquote>
<p>将内存空间划分为两部分（通常是大小相同的两个区，如Survivor区），每次回收时：</p>
<ul>
<li>
<p>标记存活对象。</p>
</li>
<li>
<p>将存活对象直接复制到另一块空闲内存区域。</p>
</li>
<li>
<p>原来的内存空间整体清空。</p>
</li>
</ul>
</blockquote>
<p><strong>为什么新生代要用标记-复制？</strong></p>
<blockquote>
<p><strong>回收效率高，速度快：</strong></p>
<ul>
<li>新生代大部分对象存活率低，复制存活对象成本低。</li>
<li>直接将存活对象复制走，剩余垃圾对象统一丢弃，不需要逐一回收，效率极高。</li>
</ul>
<p><strong>不产生内存碎片：</strong></p>
<ul>
<li>标记-复制后的存活对象全部集中存放，内存布局紧凑。</li>
<li>避免了老年代常见的内存碎片问题。</li>
</ul>
<p><strong>空间换时间的策略适合新生代：</strong></p>
<ul>
<li>新生代较小，复制成本低，即使浪费一部分内存空间，也能显著提升GC效率。</li>
</ul>
</blockquote>
<p><strong>与标记-清除或标记-整理对比：</strong></p>

































<table><thead><tr><th align="left">算法</th><th align="left">速度</th><th align="left">内存碎片</th><th align="left">空间开销</th><th align="left">适合场景</th></tr></thead><tbody><tr><td align="left">标记-复制</td><td align="left">快</td><td align="left">无碎片</td><td align="left">高（浪费一半空间）</td><td align="left">存活率低、新生代</td></tr><tr><td align="left">标记-清除</td><td align="left">慢</td><td align="left">易产生碎片</td><td align="left">低</td><td align="left">存活率高、老年代</td></tr><tr><td align="left">标记-整理</td><td align="left">较慢</td><td align="left">无碎片</td><td align="left">低</td><td align="left">存活率高、老年代</td></tr></tbody></table>
<ul>
<li>新生代垃圾多，适合牺牲空间换取极高效率。</li>
<li>老年代垃圾少，使用标记-清除或标记-整理避免空间浪费。</li>
</ul>
<p><strong>总结：</strong></p>
<blockquote>
<p>新生代之所以用标记-复制算法，根本原因是<strong>新生代对象死亡率极高</strong>。</p>
<p>标记-复制算法能以<strong>空间换时间</strong>的方式快速、高效地回收垃圾，同时避免碎片，满足新生代高频、快速的回收需求。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[关于Trae、Cursor、Kiro AI的工具大比拼]]></title>    <link>https://juejin.cn/post/7587961565476126774</link>    <guid>https://juejin.cn/post/7587961565476126774</guid>    <pubDate>2025-12-26T06:52:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587961565476126774" data-draft-id="7587825267878166569" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="关于Trae、Cursor、Kiro AI的工具大比拼"/> <meta itemprop="keywords" content="Cursor,AI编程"/> <meta itemprop="datePublished" content="2025-12-26T06:52:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端的阶梯"/> <meta itemprop="url" content="https://juejin.cn/user/2604076678261512"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            关于Trae、Cursor、Kiro AI的工具大比拼
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2604076678261512/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端的阶梯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T06:52:21.000Z" title="Fri Dec 26 2025 06:52:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、工具概览：三大AI编程工具的官方定位</h2>
<ol>
<li>
<p>Trae：AI驱动的协作式代码编辑器
官方介绍：
Trae由AI公司Anthropic（Claude母公司）推出，定位为“下一代协作式AI编程环境”。其核心卖点是与Claude 3.5 Sonnet大模型的深度集成，支持多用户实时协作、代码解释与调试，并强调“安全可控”的AI代码生成。</p>
<p>适用场景：</p>
<p>团队协作开发（尤其适合远程团队）</p>
<p>需要高精度代码解释与调试的复杂项目</p>
<p>对数据隐私有严格要求的企业级应用</p>
</li>
<li>
<p>Cursor：AI优先的下一代IDE
官方介绍：
Cursor诞生于2023年，以“让AI直接写代码”为口号，支持多模型（GPT-4、Claude、Code Llama等），提供自然语言生成代码、代码补全、智能重构等功能。其标志性功能是“Edit Mode”，允许用户通过自然语言修改现有代码。</p>
<p>适用场景：</p>
<p>快速原型开发（如Web应用、脚本）</p>
<p>个人开发者或小团队</p>
<p>需要灵活切换AI模型的场景</p>
</li>
<li>
<p>Kiro AI：垂直领域的代码生成专家
官方介绍：
Kiro AI聚焦于“特定领域代码生成”，例如游戏开发、数据科学、嵌入式系统等。其模型经过垂直领域数据微调，支持通过自然语言生成领域特定代码（如Unity脚本、Pandas数据处理流程）。</p>
<p>适用场景：</p>
<p>垂直领域开发者（如游戏、金融科技）</p>
<p>需要减少重复性代码编写的场景</p>
<p>对代码可解释性要求较高的项目</p>
</li>
</ol>
<h2 data-id="heading-1">二、核心功能对比：谁能真正提升效率？</h2>















































<table><thead><tr><th>功能</th><th>Trae_国际版</th><th>Cursor</th><th>Kiro AI</th></tr></thead><tbody><tr><td><strong>AI模型</strong></td><td>国际版不限</td><td>Claude/Gemini-3/...</td><td>目前可以无限续杯</td></tr><tr><td><em><strong>协作能力</strong></em></td><td>✅ 多用户实时协作</td><td>❌ 仅支持单人/本地协作</td><td>❌ 仅支持单人</td></tr><tr><td><em><strong>代码解释</strong></em></td><td>✅ 深度调试与错误分析?</td><td>✅ 基础解释，但深度不足?</td><td>✅ 领域特定代码解释</td></tr><tr><td><em><strong>自然语言修改</strong></em></td><td>❌ 需通过注释引导</td><td>✅ 支持直接修改代码（Edit Mode）</td><td>✅ 支持领域特定指令修改</td></tr><tr><td><em><strong>多语言支持</strong></em></td><td>✅ 全栈支持（Python/JS/Java等）</td><td>✅ 全栈支持</td><td>✅ 聚焦领域语言（如C#/Python/R）</td></tr><tr><td><em><strong>插件生态</strong></em></td><td>❌ 生态较新</td><td>✅ 丰富的VS Code插件兼容</td><td>❌ 生态有限</td></tr></tbody></table>
<h2 data-id="heading-2">三、优缺点深度剖析：谁更适合你？</h2>
<ol>
<li>
<p>Trae：安全与协作的标杆，但门槛较高</p>
<p>优点：</p>
<p>高精度代码生成
：Claude 3.5 Sonnet在数学推理和复杂逻辑上表现优异。</p>
<p>企业级安全
：支持私有化部署，数据不离开本地环境。</p>
<p>深度协作
：多用户可同时编辑同一文件，AI会实时同步修改建议。</p>
<p>缺点：</p>
<p>学习曲线陡峭
：需适应其独特的协作模式和AI交互逻辑。</p>
<p>定价昂贵
：企业版按席位收费，个人开发者成本较高。</p>
<p>定价：</p>
<p>个人免费版
：限制协作人数与模型调用次数。</p>
<p>专业版
：$20/月/人（支持Claude 3.5 Sonnet）。</p>
<p>企业版
：定制化报价（需联系销售）。</p>
</li>
<li>
<p>Cursor：灵活与高效的代表，但稳定性存疑</p>
<p>优点：</p>
<p>多模型支持
：可自由切换GPT-4、Claude等，适应不同场景。</p>
<p>Edit Mode
：通过自然语言直接修改代码，极大提升重构效率。</p>
<p>低门槛
：类似VS Code的界面，新手上手快。</p>
<p>缺点：</p>
<p>代码准确性波动
：复杂项目可能出现逻辑错误。</p>
<p>依赖网络
：需连接OpenAI/Anthropic API，延迟较高。</p>
<p>定价：</p>
<p>免费版
：限制模型为GPT-3.5，每日调用次数有限。</p>
<p>Pro版
：$20/月（支持GPT-4/Claude，无调用限制）。</p>
</li>
<li>
<p>Kiro AI：垂直领域的王者，但通用性不足</p>
<p>优点：</p>
<p>领域专家
：在游戏开发、数据科学等场景下代码质量显著优于通用模型。</p>
<p>低幻觉率
：垂直数据微调减少无关代码生成。</p>
<p>可解释性强
：生成的代码附带详细注释与逻辑说明。</p>
<p>缺点：</p>
<p>语言支持有限
：主要聚焦Python、C#、R等。</p>
<p>生态封闭
：缺乏插件与扩展能力。</p>
<p>定价：</p>
<p>免费试用
：7天全功能体验。</p>
<p>专业版
：$15/月（按领域订阅，如游戏开发包、数据科学包）。</p>
</li>
</ol>
<h2 data-id="heading-3">四、实战技巧与流程：如何最大化工具价值？</h2>
<ol>
<li>
<p>Trae：团队协作开发流程</p>
<p>场景：多人开发一个微服务后端（Python + FastAPI）。
流程：</p>
<p>初始化项目
：通过Trae创建Git仓库，邀请成员加入。</p>
<p>AI辅助编码
：</p>
<p>输入自然语言需求（如“生成一个用户认证API”），AI生成代码框架。</p>
<p>成员实时编辑，AI同步建议并检测冲突。</p>
<p>调试与部署
：</p>
<p>使用Trae内置调试器定位错误，AI提供修复方案。</p>
<p>通过CI/CD插件直接部署到云服务器。</p>
<p>技巧：</p>
<p>利用/explain命令让AI深度分析代码逻辑。</p>
<p>设置“代码审查模式”，AI自动检查团队代码规范。</p>
</li>
<li>
<p>Cursor：快速原型开发流程</p>
<p>场景：2小时内开发一个Todo List Web应用（React + TypeScript）。
流程：</p>
<p>新建项目
：选择React模板，AI生成基础文件结构。</p>
<p>自然语言开发
：</p>
<p>输入“添加一个任务列表组件，支持拖拽排序”，AI生成完整代码。</p>
<p>使用Edit Mode修改样式（如“将按钮颜色改为蓝色”）。</p>
<p>测试与优化
：</p>
<p>AI自动生成单元测试，定位潜在Bug。</p>
<p>通过“/optimize”命令优化性能关键代码。</p>
<p>技巧：</p>
<p>拆分复杂需求为多个小任务，AI生成更精准。</p>
<p>结合VS Code插件（如ESLint）提升代码质量。</p>
</li>
<li>
<p>Kiro AI：数据科学流程优化</p>
<p>场景：用Python处理10万行销售数据并生成可视化报告。
流程：</p>
<p>数据加载
：输入“用Pandas加载CSV文件，处理缺失值”，AI生成代码。</p>
<p>特征工程
：</p>
<p>输入“提取日期中的季度信息，并创建新列”，AI自动完成。</p>
<p>使用“/explain”理解每一步的统计意义。</p>
<p>可视化与报告
：</p>
<p>输入“生成折线图展示季度销售额趋势，并保存为PNG”，AI调用Matplotlib完成。</p>
<p>导出Jupyter Notebook格式的完整报告。</p>
<p>技巧：</p>
<p>优先使用Kiro AI的领域特定命令（如/data-clean）。</p>
<p>结合Pandas Profiling等库提升分析效率。</p>
</li>
</ol>
<h2 data-id="heading-4">五、总结</h2>
<p>因为市场上主流的AI模型 Claude 和 Gemini 在其官方网站上是无法直接注册中国区的账号的（国家选项中没有中国），所以要么找代理去做相关的注册，要门使用github账号直接使用Cursor、Kiro，或者使用邮件注册Trae。</p>
<p>这些工具默认整合了主流的AI模型，能够让你快速的使用模型的功能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[又是一个周末加班夜，前端的我只想哭…]]></title>    <link>https://juejin.cn/post/7587811143109197875</link>    <guid>https://juejin.cn/post/7587811143109197875</guid>    <pubDate>2025-12-26T06:54:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587811143109197875" data-draft-id="7587715742052040714" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="又是一个周末加班夜，前端的我只想哭…"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-26T06:54:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="狗头大军之江苏分军"/> <meta itemprop="url" content="https://juejin.cn/user/2955079655907879"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            又是一个周末加班夜，前端的我只想哭…
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2955079655907879/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    狗头大军之江苏分军
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T06:54:13.000Z" title="Fri Dec 26 2025 06:54:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>窗外的霓虹灯早已熄灭，外卖盒堆在桌角，咖啡杯里只剩下冰冷的残渣。我盯着屏幕上那一片红色的报错，手指悬在键盘上，不知道该从哪里开始。凌晨两点的办公室里，只剩下我和键盘的敲击声，空调的嗡嗡声像是在嘲笑我的无奈。这已经是这个月的第三个周末加班了，我甚至记不清上一次完整的周末是什么时候。朋友圈里，别人在晒聚会、晒旅行、晒美食，而我的朋友圈，永远是那句"又在加班"。我打开手机看了一眼时间，想着要不要给自己点个夜宵，但转念一想，还是算了，Bug 还没修完，哪有心情吃东西。</p>
<h2 data-id="heading-0">那些让人崩溃的瞬间</h2>
<p>周五下午五点，我正准备收拾东西下班，产品经理的消息弹了出来："这个充值页面的优惠券显示逻辑改一下，月卡用户和普通用户要区分开，周一上线。"我看着这条消息，心里咯噔一下，周五下午五点提需求，周一上线，这意味着什么？意味着我的周末又没了。我深吸一口气，回复了一个"好的"，然后打开了 <code>charge.vue</code> 文件。2908 行代码扑面而来，密密麻麻的模板、逻辑、样式混在一起，像是一团乱麻。我开始在代码里搜索"优惠券"相关的逻辑，发现这个文件已经被改过无数次了，每次需求变更都会留下一些注释掉的代码，还有一些"临时方案"，现在这些"临时方案"已经变成了"永久方案"。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 月卡用户 --&gt;
&lt;view class="subscribe-lifepass" v-if="canUseLifePassBook == 'Y' &amp;&amp; amountCalculate"&gt;
  &lt;view class="subscribe-lifepass-title"&gt;
    {{ $t("order.lifePassTitle") }}
  &lt;/view&gt;
  &lt;view class="subscribe-lifepass-content" :class="[amountCalculate.personCount &gt; 1 ? 'disabled' : '']"&gt;
    &lt;view v-if="amountCalculate.personCount == 1"&gt;-¥{{ amountCalculate.price }}
    &lt;/view&gt;
    &lt;view v-else-if="amountCalculate.personCount &gt; 1"&gt;{{ $t("order.lifePassOnlyOne") }}
    &lt;/view&gt;
  &lt;/view&gt;
&lt;/view&gt;
</code></pre>
<p>看起来很简单对吧？就是一个条件判断，显示或隐藏优惠券信息。但当我开始改的时候才发现，优惠券逻辑和月卡逻辑耦合在一起，价格计算分散在三个不同的方法里，还要考虑中英文切换的问题。更要命的是，改完这里，订单确认页 <code>orderConfirm.vue</code> 也要同步改，因为两个页面共用同一套价格计算逻辑。我花了整整一个晚上，才理清楚这些逻辑之间的关系，然后小心翼翼地修改代码，生怕改了这里，那里又出问题。每改一行代码，我都要在浏览器里刷新好几次，确保没有破坏原有的功能。一个"小细节"，牵一发而动全身，这就是前端开发的日常。</p>
<p>周六晚上，我正在家里吃晚饭，手机突然震动了起来。我拿起手机一看，是测试在群里 @所有人："线上紧急 Bug！用户预约课程时，选择多人后优惠券不显示了！"我的心一下子提到了嗓子眼，线上 Bug 意味着用户正在受影响，必须立刻修复。我放下碗筷，打开电脑，连上 VPN，开始排查问题。我立刻打开代码，在 <code>orderConfirm.vue</code> 里找到了优惠券显示的逻辑：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- 券 --&gt;
&lt;view class="subscribe-coupon" v-if="
  !(
    canUseLifePassBook == 'Y' &amp;&amp;
    amountCalculate &amp;&amp;
    amountCalculate.personCount == 1
  )
"&gt;
</code></pre>
<p>这个条件判断看起来没问题啊？月卡用户单人预约时不显示优惠券，其他情况显示。我在本地环境测试了好几遍，都没有复现问题。我开始怀疑是不是测试环境的数据有问题，于是我让测试把线上的请求数据发给我。当我仔细检查 <code>amountCalculate</code> 的数据结构时，终于发现了问题：后端返回的 <code>personCount</code> 字段，在某些情况下是字符串 <code>"1"</code>，而不是数字 <code>1</code>。JavaScript 的 <code>==</code> 比较，<code>"1" == 1</code> 是 true，所以单人预约时逻辑正常。但是当 <code>personCount</code> 是字符串 <code>"2"</code> 时，<code>"2" &gt; 1</code> 也是 true，导致多人预约时优惠券被隐藏了。原来是类型转换的坑！这种问题在开发时很难发现，因为本地环境的数据都是规范的，只有线上环境才会出现各种奇怪的数据格式。我立刻修改了代码，把 <code>==</code> 改成了 <code>===</code>，并且加上了类型转换：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 修复前</span>
amountCalculate.<span class="hljs-property">personCount</span> == <span class="hljs-number">1</span>

<span class="hljs-comment">// 修复后</span>
<span class="hljs-title class_">Number</span>(amountCalculate.<span class="hljs-property">personCount</span>) === <span class="hljs-number">1</span>
</code></pre>
<p>凌晨三点，我盯着这行代码，想起了那句话：<strong>"JavaScript 是世界上最好的语言"</strong>（笑）。修复完这个 Bug，我又测试了好几遍，确保没有其他问题，然后提交代码，发布到线上。看着部署成功的提示，我长舒了一口气，但心里却没有一丝成就感，只有疲惫。这种紧急 Bug 修复，就像是在走钢丝，一不小心就会掉下去。而且最让人无奈的是，这种问题本来是可以避免的，如果后端接口规范一点，如果前端做好类型检查，如果测试覆盖更全面一点……但是在快节奏的开发中，这些"如果"都变成了奢望。</p>
<p>最让我崩溃的是这个需求："用户可能有多个品牌的钱包余额，要支持选择不同钱包支付。"这个需求听起来很简单，不就是一个列表选择吗？但实际上，这涉及到复杂的状态管理和支付逻辑。用户可以选择钱包支付、微信支付，或者两者混合支付。每种支付方式都有不同的限制条件，比如钱包余额不足时要提示补差价，月卡用户不能使用某些优惠券，多人预约时不能使用钱包支付等等。这些规则交织在一起，形成了一个复杂的状态机，稍有不慎就会出现逻辑错误。</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template v-if="isCollapseWallet &amp;&amp; walletList.length != 0"&gt;
  &lt;view class="valueCard" v-for="(item, index) in walletList" :key="index"&gt;
    &lt;view class="valueCard-icon"&gt;
      &lt;image v-if="item.brand == 57" src="https://oss.xxx" /&gt;
      &lt;image v-if="item.brand == 58" src="https://oss.xxx" /&gt;
      &lt;image v-if="item.brand == 59" src="https://oss.xxx" /&gt;
    &lt;/view&gt;
    &lt;!-- ... --&gt;
  &lt;/view&gt;
&lt;/template&gt;
</code></pre>
<p>看起来很简单的列表渲染，但实际上要处理的逻辑非常复杂。首先是状态管理的问题，每个钱包的选中状态要互斥，用户只能选择一个钱包，而且钱包支付和微信支付也要互斥。其次是余额不足的判断，当用户选中的钱包余额不足时，要提示用户补差价，并且自动勾选微信支付。最后是支付类型的计算，钱包支付、微信支付、混合支付，三种情况对应的 <code>payType</code> 不一样，后端需要根据 <code>payType</code> 来处理支付逻辑。我花了整整一个下午，才理清楚这些状态之间的关系，然后写出了下面这段代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">computed</span>: {
  <span class="hljs-title function_">selectedOtherWalletAmount</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> selected = <span class="hljs-variable language_">this</span>.<span class="hljs-property">walletList</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">isPaySele</span>);
    <span class="hljs-keyword">return</span> selected ? selected.<span class="hljs-property">walletAmount</span> || <span class="hljs-number">0</span> : <span class="hljs-number">0</span>;
  },
  <span class="hljs-title function_">payType</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> isOthPay = <span class="hljs-variable language_">this</span>.<span class="hljs-property">walletList</span>.<span class="hljs-title function_">some</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">isPaySele</span>);
    <span class="hljs-keyword">if</span> (isOthPay &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">useWxPay</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-number">6</span>; <span class="hljs-comment">// 混合支付</span>
    }
    <span class="hljs-comment">// ... 还有一堆判断</span>
  }
}
</code></pre>
<p>这段代码看起来很简洁，但实际上是经过无数次重构和优化的结果。最开始的版本，我用了一堆 <code>if-else</code> 来判断状态，代码又长又难维护。后来我改用 <code>computed</code> 属性来计算派生状态，代码变得清晰了很多。但即使这样，我还是担心会有遗漏的边界情况，所以我写了一个测试用例列表，把所有可能的组合都测试了一遍。测试的过程中，我又发现了好几个问题，比如用户快速点击时会触发多次支付请求，钱包余额更新不及时导致显示错误等等。每修复一个问题，就会发现新的问题，就像是在打地鼠游戏一样，永远打不完。</p>
<p>周日下午，我正准备休息一下，产品经理又发来消息："英文版的充值页面，文案显示有问题。"我心里一阵无奈，这个项目要支持中英文双语，每次改功能都要检查两遍。我打开代码一看，果然又是中英文布局不一致的问题：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;view class="discount" v-if="language == 'en-US'"&gt;
  &lt;text&gt;+{{ item.rewardRatio }}%&lt;/text&gt;
  &lt;text&gt;FREE!&lt;/text&gt;
&lt;/view&gt;
&lt;view class="discount" v-else&gt;
  &lt;text&gt;赠送&lt;/text&gt;
  &lt;text&gt;+{{ item.rewardRatio }}%&lt;/text&gt;
&lt;/view&gt;
</code></pre>
<p>中英文的布局逻辑不一样，导致样式也要分开写：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;template v-if="language == 'en-US'"&gt;
  &lt;view class="value-infos-under value-infos-under-en"&gt;
    &lt;view&gt;Regular Period Charge:&lt;/view&gt;
    &lt;view&gt;¥{{ item.amount }}&lt;/view&gt;
  &lt;/view&gt;
&lt;/template&gt;
&lt;view class="value-infos-under" v-else&gt;
  续费价 ¥{{ item.amount }}
&lt;/view&gt;
</code></pre>
<p>中英文的布局逻辑不一样，英文版要把百分比放在前面，中文版要把"赠送"放在前面。而且因为英文单词比较长，样式也要单独调整，不然会出现文字溢出或者换行的问题。整个项目里，这样的中英文判断有上百处，每次改一个地方，都要检查两遍，确保中英文版本都正常显示。有时候我在想，为什么不用国际化框架来统一管理多语言？但是项目已经开发了这么久，重构的成本太高了，只能继续用这种"土办法"。每次看到这些 <code>v-if="language == 'en-US'"</code> 的判断，我都觉得很无奈，这就是技术债的代价。</p>
<h2 data-id="heading-1">那些无力的瞬间</h2>
<p>做前端开发这么多年，我遇到过无数次让人无力的瞬间。最常见的就是需求变动，产品经理说"这个功能先不做了，改成那个"，或者"上周说的那个需求，这周又要改回来"，甚至还有"能不能加个小功能？就一个按钮的事"。每次听到这些话，我都想问：你知道我为了这个功能，改了多少文件吗？你知道我为了实现这个逻辑，熬了多少个夜吗？但是我知道，问了也没用，因为在他们眼里，前端就是"改改页面"，很简单的事情。他们不知道，每一个按钮背后，都有复杂的状态管理、数据交互、异常处理。他们不知道，每一次需求变更，都可能导致整个系统的重构。</p>
<p>还有沟通上的困难。我说"这个需求技术上有风险，需要重构"，老板说"用户等不了，先上线再说"。我说"但是这样会留下技术债"，老板说"技术债以后再还"。可是"以后"，永远不会来。技术债就像滚雪球一样，越滚越大，最后变成了一个无法维护的巨型项目。每次打开代码，都能看到各种"临时方案"、"待优化"、"TODO"的注释，这些注释就像是墓碑一样，记录着那些被放弃的理想。我知道，总有一天，这些技术债会爆发，到那时候，可能就不是加班能解决的问题了，而是要推倒重来。</p>
<p>上线的压力也让人喘不过气来。测试说"这个 Bug 必须今天修完，明天要上线"，我说"但是我还没测完其他功能"，测试说"那你加班测"。于是，又是一个加班夜。有时候我在想，为什么总是这么赶？为什么不能多给一点时间，让我们把代码写得更好一点？但是我知道，在互联网行业，时间就是金钱，快速迭代才是王道。用户不会关心你的代码写得多优雅，他们只关心功能能不能用，Bug 会不会影响体验。所以我们只能在有限的时间里，尽可能地保证质量，然后祈祷不要出问题。</p>
<h2 data-id="heading-2">技术难点：Vue 组件的状态管理</h2>
<p>这次加班，最大的技术难点是多个组件之间的状态同步。整个预约流程是这样的：用户在课程列表页选择课程，跳转到订单确认页，选择优惠券，选择支付方式，最后提交订单。这个流程看起来很简单，但实际上涉及到大量的状态管理。课程信息（<code>courseInfo</code>）、价格计算（<code>amountCalculate</code>）、优惠券列表（<code>couponList</code>）、支付方式（<code>useWalletPay</code>, <code>useWxPay</code>, <code>walletList</code>）、用户信息（<code>vipInfo</code>），这些状态之间相互依赖，任何一个状态的变化都可能影响其他状态。比如用户选择了优惠券，价格就要重新计算；用户切换了支付方式，可用的优惠券列表也要更新；用户修改了预约人数，支付方式的限制条件也要改变。这种复杂的状态依赖关系，如果处理不好，就会导致数据不一致、界面显示错误等问题。</p>
<p>我的解决方案是使用 Vue 的响应式系统来管理状态。首先，我把所有的派生状态都用 <code>computed</code> 属性来计算，这样可以确保状态的一致性。比如判断是否可以使用优惠券，我不是在每个地方都写一遍判断逻辑，而是定义一个 <code>computed</code> 属性：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">computed</span>: {
  <span class="hljs-comment">// 判断是否可以使用优惠券</span>
  <span class="hljs-title function_">canUseCoupon</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">couponList</span>.<span class="hljs-property">length</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">couponList</span>.<span class="hljs-title function_">some</span>(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> e.<span class="hljs-property">canUse</span> === <span class="hljs-string">"Y"</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  },
  
  <span class="hljs-comment">// 计算选中的其他钱包余额</span>
  <span class="hljs-title function_">selectedOtherWalletAmount</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> selected = <span class="hljs-variable language_">this</span>.<span class="hljs-property">walletList</span>.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">isPaySele</span>);
    <span class="hljs-keyword">return</span> selected ? selected.<span class="hljs-property">walletAmount</span> || <span class="hljs-number">0</span> : <span class="hljs-number">0</span>;
  },
  
  <span class="hljs-comment">// 动态计算按钮样式</span>
  <span class="hljs-title function_">getFooterBtnClass</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> classList = [<span class="hljs-string">'footer-content-btn'</span>];
    <span class="hljs-keyword">const</span> status = <span class="hljs-variable language_">this</span>.<span class="hljs-property">courseInfo</span>.<span class="hljs-property">bookStatus</span>;
    <span class="hljs-keyword">const</span> isDisabled =
      !<span class="hljs-variable language_">this</span>.<span class="hljs-property">isAgree</span> ||
      ![<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>].<span class="hljs-title function_">includes</span>(status) ||
      (status === <span class="hljs-number">2</span> &amp;&amp; <span class="hljs-variable language_">this</span>.<span class="hljs-property">preAppointmentCount</span> &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">canChooseNums</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">currentIndex</span>]);
    
    <span class="hljs-keyword">if</span> (isDisabled) {
      classList.<span class="hljs-title function_">push</span>(<span class="hljs-string">'disabled'</span>);
    }
    <span class="hljs-keyword">return</span> classList;
  }
}
</code></pre>
<p>这样，无论在哪里需要判断是否可以使用优惠券，我都可以直接用 <code>this.canUseCoupon</code>，而不用担心逻辑不一致的问题。而且 <code>computed</code> 属性是有缓存的，只有依赖的数据变化时才会重新计算，性能也更好。</p>
<p>其次，我把所有的状态变更都封装成方法，而不是直接修改数据。比如切换支付方式，我定义了一个 <code>changePayType</code> 方法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">methods</span>: {
  <span class="hljs-comment">// 切换支付方式</span>
  <span class="hljs-title function_">changePayType</span>(<span class="hljs-params">type, item, index</span>) {
    <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'wallet'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">useWalletPay</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">useWalletPay</span>;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">useWalletPay</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">useWxPay</span> = <span class="hljs-literal">false</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">walletList</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">w</span> =&gt;</span> w.<span class="hljs-property">isPaySele</span> = <span class="hljs-literal">false</span>);
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'wx'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">useWxPay</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">useWxPay</span>;
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">useWxPay</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">useWalletPay</span> = <span class="hljs-literal">false</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">walletList</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">w</span> =&gt;</span> w.<span class="hljs-property">isPaySele</span> = <span class="hljs-literal">false</span>);
      }
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'otherPay'</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">walletList</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">w, i</span>) =&gt;</span> {
        w.<span class="hljs-property">isPaySele</span> = i === index ? !w.<span class="hljs-property">isPaySele</span> : <span class="hljs-literal">false</span>;
      });
      <span class="hljs-keyword">if</span> (item.<span class="hljs-property">isPaySele</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">useWalletPay</span> = <span class="hljs-literal">false</span>;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">useWxPay</span> = <span class="hljs-literal">false</span>;
      }
    }
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getAmountCalculate</span>(); <span class="hljs-comment">// 重新计算价格</span>
  }
}
</code></pre>
<p>这个方法看起来很长，但实际上逻辑很清晰：根据不同的支付类型，更新对应的状态，并且确保状态之间的互斥关系。最后调用 <code>getAmountCalculate()</code> 重新计算价格。这样做的好处是，所有的状态变更都在一个地方处理，不会出现遗漏或者不一致的情况。而且如果以后需要修改逻辑，只需要改这一个方法就可以了，不用到处找代码。</p>
<p>最后，我使用 <code>watch</code> 来监听关键状态的变化，自动触发相关的更新：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">watch</span>: {
  <span class="hljs-title function_">currentIndex</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 人数变化时，重新计算价格</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getAmountCalculate</span>();
  },
  <span class="hljs-title function_">couponCodeList</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 优惠券变化时，重新计算价格</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getAmountCalculate</span>();
  }
}
</code></pre>
<p>这样，当用户修改预约人数或者选择优惠券时，价格会自动重新计算，不需要手动调用方法。Vue 的响应式系统会自动追踪依赖关系，确保数据的一致性。</p>
<p>当然，在实现这些功能的过程中，我也踩过不少坑。最常见的就是数据类型不一致的问题，后端返回的数字字段，有时是字符串，有时是数字，导致比较和计算时出现意外的结果。还有异步数据依赖的问题，价格计算依赖多个接口返回的数据，如果加载顺序不对，就会出现数据不完整或者计算错误的情况。我不得不在每个接口调用后都加上 <code>loading</code> 状态的判断，确保所有数据都加载完成后再进行计算。另外，多个支付方式之间的互斥逻辑也很容易出错，稍不注意就会出现两个支付方式同时选中，或者都没有选中的情况。为了避免这些问题，我在每次状态变更后都会打印日志，检查状态是否正确，这样可以及时发现问题。</p>
<h2 data-id="heading-3">凌晨一点的反思</h2>
<p>调试到凌晨一点多，我还反思个鸡毛啊，抓啊睡觉吧！！！</p>
<p>对着屏幕发呆。我想起了那些被我错过的周末，那些没能参加的聚会，那些没能陪伴家人的时光。我想起了朋友问我"你怎么总是在加班"时，我无奈的笑容。我想起了女朋友说"你是不是更爱你的代码"时，我无言的沉默。我知道，这不是我想要的生活，但我又能怎么办呢？这就是互联网行业的现状，这就是前端开发的日常。我只能告诉自己，再坚持一下，再坚持一下，总会好起来的。但我心里清楚，这样的"再坚持一下"，可能会持续很久很久。</p>
<h2 data-id="heading-4">写在最后</h2>
<p>如果你也是前端开发，如果你也在加班，如果你也遇到过这些问题，那么请记住：你不是一个人。我们都在这条路上，一边写着 Bug，一边修着 Bug，一边骂着产品经理，一边继续加班。我们都经历过需求变更的无奈，都经历过线上 Bug 的恐慌，都经历过技术债的折磨。我们都在深夜里对着屏幕发呆，都在凌晨里怀疑人生，都在周末里加班到天亮。但是，我们也在成长。每一个通宵调试的 Bug，都让我们对代码有了更深的理解，让我们学会了如何排查问题，如何优化性能，如何处理边界情况。每一次需求变更，都让我们学会了更灵活的架构设计，让我们懂得了如何解耦代码，如何提高可维护性，如何应对变化。每一个上线的项目，都是我们技术能力的证明，都是我们努力的结果，都是我们价值的体现。</p>
<p>所以，加油吧，前端人。虽然又是一个周末加班夜，虽然我只想哭，但明天太阳升起的时候，我还是会继续写代码。因为，这就是我们的工作，也是我们的热爱。我们热爱创造的过程，热爱解决问题的快感，热爱看到产品上线的成就感。即使有再多的加班，再多的 Bug，再多的技术债，我们依然会坚持下去。因为我们知道，每一行代码，都在改变着这个世界；每一个功能，都在服务着千千万万的用户；每一次优化，都在让产品变得更好。这就是我们的价值，这就是我们的意义，这就是我们继续前行的动力。</p>
<hr/>
<p><em>写于凌晨  1:23，办公室的灯还亮着，外卖盒已经堆成了小山，但代码，终于跑通了。晚安，世界。晚安，Bug。晚安，我的周末。明天，又是新的一天，又是新的挑战，又是新的代码。</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[每周技术加速器：UltraRAG：突破传统RAG架构的创新与实践]]></title>    <link>https://juejin.cn/post/7587675306658840576</link>    <guid>https://juejin.cn/post/7587675306658840576</guid>    <pubDate>2025-12-26T06:53:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587675306658840576" data-draft-id="7587675443443105832" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="每周技术加速器：UltraRAG：突破传统RAG架构的创新与实践"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-26T06:53:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智见AGI"/> <meta itemprop="url" content="https://juejin.cn/user/4145611877132986"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            每周技术加速器：UltraRAG：突破传统RAG架构的创新与实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4145611877132986/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智见AGI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T06:53:12.000Z" title="Fri Dec 26 2025 06:53:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>欢迎来到我们的 「每周技术加速器」</strong> <strong>专栏！</strong></p>
<p>每周五，我们都会围绕一个前沿技术主题，展开一场深度的内部技术分享会。不仅是为了团队内部的碰撞与成长，也希望通过这样的形式，将我们的思考与实践记录、沉淀、分享给更多同行者。</p>
<p>本周，我们探讨的主题是：<strong>基于 Mcp 的 Rag 架构革新：ultra Rag 的实践与思考</strong></p>
<p>本次技术分享会围绕 UltraRAG 展开讨论。UltraRAG 并非在“生成效果”层面进行局部优化，而是试图回答一个更上层、更长期的问题：</p>
<p>RAG 是否可以像分布式系统一样，被清晰地分层、标准化和模块化，从而具备可演进性？UltraRAG 给出的答案是肯定的。</p>
<p><strong>从“能用的 RAG”到“架构级 RAG”</strong></p>
<p>在大模型应用逐步走向生产化的今天，RAG（Retrieval‑Augmented Generation）已经不再是一个“是否需要”的问题，而是一个“如何设计、如何演进、如何规模化”的架构问题。</p>
<p>许多团队已经将 RAG 成功落地，但在进入真实业务和长期演进阶段后，往往会遇到一系列更本质的困惑：</p>
<p>●为什么系统功能不断叠加，却越来越难以修改和演进？</p>
<p>●为什么一次简单的检索或生成策略调整，都会牵动大量代码？</p>
<p>●为什么 RAG 难以像数据库、消息队列那样，沉淀为稳定、可复用的基础设施？</p>
<p>这些问题的根源，并不在模型效果本身，<strong>而在于RAG 的架构层次是否成立。</strong></p>
<p>本次技术分享会围绕 UltraRAG 展开讨论。UltraRAG 并非在“生成效果”层面进行局部优化，而是试图回答一个更上层、更长期的问题：</p>
<p><strong>RAG 是否可以像分布式系统一样，被清晰地分层、标准化和模块化，从而具备可演进性？</strong></p>
<p>UltraRAG 给出的答案是肯定的。</p>
<p>作为首个基于 MCP（Model Context Protocol）的模块化 RAG 框架，UltraRAG 尝试通过<strong>协议化接口、分层架构与配置驱动机制</strong>，将 RAG 从“应用代码的一部分”，提升为“可长期演进的系统架构”。</p>
<p>在进入具体技术细节之前，先给出贯穿全文的三条核心架构判断：</p>
<p><strong>协议决定架构上限</strong></p>
<p><strong>配置是系统的控制面</strong></p>
<p><strong>RAG 正在走向工具化与实时化的基础设施阶段</strong></p>
<p><strong>从传统 RAG 说起：清晰流程下的结构性困境</strong></p>
<p><strong>1. 传统 RAG 的基本范式</strong></p>
<p>从流程上看，传统 RAG 的整体逻辑非常清晰：</p>
<p>1.用户提出问题</p>
<p>2.问题向量化（Embedding）</p>
<p>3.向量数据库相似度检索</p>
<p>4.构建 Prompt</p>
<p>5.大语言模型生成答案</p>
<p>在这一过程中，通常涉及四个关键技术模块：</p>
<p>●<strong>文档分块（Chunking）：</strong> 将长文档切分为可检索的最小单元</p>
<p>●<strong>嵌入模型（Embedding）：</strong> 将文本映射到向量空间</p>
<p>●<strong>向量数据库（Vector DB）：</strong> 进行高效相似度搜索</p>
<p>●<strong>提示词工程（Prompt Engineering）：</strong> 组织上下文以引导生成</p>
<p>从“白板设计”的角度看，这一技术路径并不复杂。但在工程实践中，问题往往从这里开始显现。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0782514aab241b89ad0a01a6c689ccd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336792&amp;x-signature=CZqY16B0YAvHzyZOJMx87WPafG0%3D" alt="" loading="lazy"/></p>
<p><strong>2. 传统 RAG 框架的五大典型问题</strong></p>
<p>在大量工程实践中，传统 RAG 框架逐渐暴露出一系列结构性问题，可以归纳为以下五个方面。</p>
<p><strong>（1）组件强耦合，开发复杂度高</strong></p>
<p>以 LangChain 等框架为代表，检索器、生成模型与业务逻辑往往在代码中直接绑定。一旦需要更换检索策略或模型后端，通常就需要修改核心代码。</p>
<p>其根本原因在于：<strong>缺乏统一的抽象层，组件之间高度耦合。</strong></p>
<p><strong>（2）配置分散，难以统一管理</strong></p>
<p>模型参数、检索参数、Prompt 模板往往散落在不同代码位置，缺乏声明式配置机制，直接导致：</p>
<p>●参数不可追溯</p>
<p>●实验难以复现</p>
<p>●配置无法版本化管理</p>
<p><strong>（3）调试困难，缺乏可观测性</strong></p>
<p>在多数传统框架中，RAG 更像一个“黑箱”：</p>
<p>●实际检索到了哪些文档？</p>
<p>●为什么选择这些内容？</p>
<p>●最终传入模型的 Prompt 具体是什么形态？</p>
<p>这些中间状态往往缺乏系统性的记录与可视化手段。</p>
<p><strong>（4）扩展性受限</strong></p>
<p>新增功能或能力通常意味着：</p>
<p>修改框架核心代码</p>
<p>这种非插件式架构，使得框架扩展成本高、生态难以形成。</p>
<p><strong>（5）多模态支持薄弱</strong></p>
<p>多数 RAG 框架在设计之初仅面向文本场景，对于图像、表格等复杂模态支持不足，往往需要通过“拼凑式”的方式进行补偿。</p>
<p><strong>3. 核心矛盾的本质</strong></p>
<p>上述问题虽然表现各异，但本质高度一致：</p>
<p><strong>现有 RAG 框架大多是代码驱动、组件紧耦合的系统，缺乏统一协议与声明式抽象层。</strong></p>
<p>这也自然引出了一个关键问题：</p>
<p>是否可以构建一个 <strong>低代码、模块化、易扩展、可复用</strong> 的 RAG 架构？</p>
<p>UltraRAG 正是对这一问题的系统性回应。</p>
<p><strong>UltraRAG：以配置与协议重构 RAG 架构</strong></p>
<p><strong>1. UltraRAG 的定位</strong></p>
<p>UltraRAG 是<strong>首个基于 MCP 架构的模块化 RAG 框架。</strong> 其目标并非提供更多内置能力，而是重新定义 RAG 系统的组织方式：</p>
<p>●使用 <strong>YAML 配置</strong> 描述 RAG Pipeline</p>
<p>●使用 <strong>标准协议</strong> 连接检索、生成与工具</p>
<p>●使用 <strong>模块化设计</strong> 实现组件解耦</p>
<p>可以将其核心理念概括为一句话：</p>
<p><strong>用配置描述系统行为，用协议连接系统能力。</strong></p>
<p><strong>2. UltraRAG 的核心特性</strong></p>
<p>UltraRAG 具备以下五个显著特性：</p>
<p><strong>●低代码：</strong> 核心流程通过 YAML 声明完成，显著降低工程复杂度</p>
<p><strong>●模块化：</strong> Retriever、Generator、Parser 等组件完全解耦</p>
<p><strong>●多模态原生支持：</strong> 文本、图像、表格统一建模与处理</p>
<p><strong>●插件式扩展：</strong> 新增能力无需修改框架核心代码</p>
<p><strong>●标准化接口：</strong> 基于 MCP 协议，实现工具级互操作</p>
<p><strong>3. 从“代码耦合”到“配置解耦”</strong></p>
<p>在传统 RAG 模式下：</p>
<p>●更换 Retriever 通常需要修改代码</p>
<p>●参数调优往往需要反复阅读与调整实现逻辑</p>
<p>而在 UltraRAG 中：</p>
<p>●Retriever 与 Generator 均通过配置独立声明</p>
<p>●后端类型、模型选择与超参数一目了然</p>
<p>●配置文件可进行版本管理、复用与对比</p>
<p>在这一模式下，配置本身即系统行为的完整描述。</p>
<p><strong>UltraRAG 的关键技术：MCP 与三层架构</strong></p>
<p><strong>1. MCP：架构级协议，而非性能优化手段</strong></p>
<p>MCP（Model Context Protocol）的核心目标，并非追求单点性能提升，而是实现：<strong>标准化、解耦与互操作</strong></p>
<p>其作用可以类比 HTTP 在 Web 体系中的地位。</p>
<p>MCP 主要带来三方面价值：</p>
<p>●<strong>工具解耦：</strong> 各类 Server 可独立运行、独立演进</p>
<p>●<strong>统一接口：</strong> 基于 JSON-RPC，接入与集成成本极低</p>
<p>●<strong>插件化扩展：</strong> 新增工具仅需实现 MCP 接口</p>
<p><strong>2. UltraRAG 的三层架构设计</strong></p>
<p>基于 MCP，UltraRAG 构建了清晰的三层体系结构：</p>
<p>●<strong>Client 层：</strong> 负责读取 YAML 配置并编排 Pipeline</p>
<p>●<strong>Server 层：</strong> 通过 MCP 暴露标准化能力接口</p>
<p>●<strong>Backend 层：</strong> 具体实现（如 FAISS、vLLM、MinerU 等）</p>
<p>这一设计的核心原则在于：</p>
<p><strong>上层仅依赖接口，而不依赖具体实现。</strong></p>
<p>各组件可像积木一样被自由替换与升级。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04a10713e190479498591a353a01e1ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336792&amp;x-signature=s7lMr%2FGcGvDqiAXepD7eR68MYkw%3D" alt="" loading="lazy"/></p>
<p><strong>3. 配置驱动的系统价值</strong></p>
<p>配置驱动并不只是减少代码量，而是带来三种系统级能力：</p>
<ul>
<li>可追溯性：配置即系统文档</li>
<li>可复现性：一个 YAML 对应一次完整实验</li>
<li>可版本化：天然适配 Git 等版本管理工具</li>
</ul>
<p>同时，YAML 的模板与继承机制，使得配置复用与组合成本极低。</p>
<p><strong>4. 多模态能力与 MinerU 的集成</strong></p>
<p>UltraRAG 的多模态能力并非后期补丁，而是源于架构层面的原生设计。</p>
<p>通过与 MinerU 的深度集成，系统能够：</p>
<ul>
<li>解析文档中的图像、表格与公式</li>
<li>将表格转为 HTML、公式转为 LaTeX</li>
<li>支持 100+ 语言的 OCR</li>
<li>自动识别文档阅读顺序</li>
</ul>
<p>这使 UltraRAG 在处理论文、财报与技术文档等复杂场景时具备显著优势。</p>
<p><strong>技术启示与 RAG 的演进方向</strong></p>
<p><strong>1. 三条关键技术启示</strong></p>
<p><strong>（1）协议优于框架</strong></p>
<p>长期来看，定义标准协议比构建封闭框架更具生命力。</p>
<p><strong>（2）配置优于代码，但需明确边界</strong></p>
<p>通用、确定性的系统行为适合配置化，特殊逻辑仍需通过代码实现。</p>
<p><strong>（3）可观测性是生产级 RAG 的关键能力</strong></p>
<p>RAG 系统不仅要“能跑”，还需要“可解释、可调试、可优化”。</p>
<p><strong>2. 从离线索引到 MCP-based 实时 RAG</strong></p>
<p>RAG 技术正经历从离线索引向实时工具调用的重要转变。</p>
<p>传统 RAG 模式依赖预构建向量索引，存在知识更新滞后与维护成本高的问题。</p>
<p>基于 MCP 的实时 RAG 模式中，模型可以直接通过工具调用实时文档服务：</p>
<ul>
<li>无需预建索引</li>
<li>知识始终保持最新</li>
<li>维护成本显著降低</li>
</ul>
<p>在这一趋势下，<strong>文档网站本身将逐步演进为 MCP Server。</strong></p>
<p><strong>3. 面向未来的三个发展趋势</strong></p>
<ul>
<li>
<p><strong>Agent-based RAG：</strong> 由 Agent 动态决策何时、如何检索</p>
</li>
<li>
<p><strong>知识图谱融合：</strong> 结合向量语义能力与关系推理能力</p>
</li>
<li>
<p><strong>个性化 RAG：</strong> 根据用户行为动态调整检索与生成策略</p>
</li>
</ul>
<p>这些趋势共同指向一个方向：</p>
<p>RAG 正在从静态系统，演进为动态、智能、可演进的知识基础设施。</p>
<p><strong>Demo演示</strong></p>
<p>UR-v2 的使用流程主要包括以下三个阶段：</p>
<ul>
<li>编写 Pipeline 配置文件</li>
<li>编译 Pipeline 并调整参数</li>
<li>运行 Pipeline</li>
</ul>
<p>此外，还可以通过可视化工具对运行结果进行分析与评估。</p>
<p><strong>数据：</strong> 使用 ultrarag 提供的10条样例数据</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3718eb566b3a4171a44cb6decb8884b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336792&amp;x-signature=1mQBwEtTnymwbPtZqyJBpXtUTgE%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a296b4728c104d5aa9dcee83f3767fe1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336792&amp;x-signature=l3k8L%2FegBsPt5dzkCUT%2FtZsp4C4%3D" alt="" loading="lazy"/></p>
<p><strong>嵌入编码：</strong> MiniCPM-Embedding-Light</p>
<p><strong>生成答案模型：</strong>  Qwen3-8B</p>
<p><strong>最终准确率：</strong> 10%</p>
<p><strong>Step 1：编写 Pipeline 配置文件</strong></p>
<p>在examples文件夹中创建并编写 Pipeline 配置文件：</p>
<pre><code class="hljs language-diff" lang="diff">servers:
  benchmark:servers/benchmark
  retriever:servers/retriever
  prompt:servers/prompt
  generation:servers/generation
  evaluation:servers/evaluation
  custom:servers/custom

pipeline:
<span class="hljs-deletion">-benchmark.get_data</span>
<span class="hljs-deletion">-retriever.retriever_init</span>
<span class="hljs-deletion">-retriever.retriever_embed</span>
<span class="hljs-deletion">-retriever.retriever_index</span>
<span class="hljs-deletion">-retriever.retriever_search</span>
<span class="hljs-deletion">-generation.generation_init</span>
<span class="hljs-deletion">-prompt.qa_rag_boxed</span>
<span class="hljs-deletion">-generation.generate</span>
<span class="hljs-deletion">-custom.output_extract_from_boxed</span>
<span class="hljs-deletion">-evaluation.evaluate</span>
</code></pre>
<p>UR-v2 的 Pipeline 配置文件需要包含以下两个部分：</p>
<ul>
<li>
<p>servers：声明当前流程所依赖的各个模块（Server）。例如，检索阶段需要使用 retriever Server。</p>
</li>
<li>
<p>pipeline：定义各 Server 中功能函数（Tool）的调用顺序。本示例展示了从数据加载、检索编码与索引构建，到生成与评测的完整流程。</p>
</li>
</ul>
<p><strong>Step 2：编译 Pipeline 并调整参数</strong></p>
<p>在运行代码前，首先需要配置运行所需的参数。UR-v2 提供了快捷的 build 指令，可自动生成当前 Pipeline 所依赖的完整参数文件。 系统会读取各个 Server 的 parameter.yaml 文件，解析本次流程中涉及的全部参数项，并统一汇总生成到一个独立的配置文件中。执行以下命令：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-built_in">printf</span>(<span class="hljs-string">"hello world!"</span>);
</code></pre>
<p>执行后，终端将输出如下内容：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/13b36c1bbb2d403c9779f1f746362e0a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336792&amp;x-signature=BRdR5rwdskMVYjpxpFkeMVOFPkY%3D" alt="" loading="lazy"/></p>
<p>系统会在examples/parameters/文件夹下生成对应的参数配置文件。打开文件后，可根据实际情况修改相关参数，例如：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">benchmark:</span>
<span class="hljs-symbol">benchmark:</span>
# key_map：定义数据字段的映射关系，将数据集中字段名映射为标准字段
<span class="hljs-symbol">key_map:</span>
<span class="hljs-symbol">gt_ls:</span>golden_answers# 答案字段名
<span class="hljs-symbol">q_ls:</span>question# 问题字段名
<span class="hljs-symbol">limit:</span>-<span class="hljs-number">1</span># 限制加载样本数量，-<span class="hljs-number">1</span> 表示加载全部
<span class="hljs-symbol">name:</span>nq# 数据集名称（如 Natural Questions）
<span class="hljs-symbol">path:</span>data/sample_nq_10.jsonl# 数据文件路径
<span class="hljs-symbol">seed:</span><span class="hljs-number">42</span># 随机种子，保证实验可复现
<span class="hljs-symbol">shuffle:</span><span class="hljs-literal">false</span># 是否打乱样本顺序，<span class="hljs-literal">false</span> 表示按原顺序加载

<span class="hljs-symbol">custom:</span> {}                    # 自定义 Server，此处为空（当前函数无参数）

<span class="hljs-symbol">evaluation:</span>
# metrics：指定评测指标，可按需增删
<span class="hljs-symbol">metrics:</span>
-acc# 准确率（Accuracy）
-f1# F1 值
-em# Exact Match
-coverem# 覆盖率式 Exact Match
-stringem# 字符串级匹配
-rouge-<span class="hljs-number">1</span># Rouge-<span class="hljs-number">1</span> 指标
-rouge-<span class="hljs-number">2</span># Rouge-<span class="hljs-number">2</span> 指标
-rouge-l# Rouge-L 指标
<span class="hljs-symbol">save_path:</span>output/evaluate_results.json# 评测结果保存路径

<span class="hljs-symbol">generation:</span>
<span class="hljs-symbol">backend:</span>vllm# 推理后端，可选 vllm / openai / hf
<span class="hljs-symbol">backend_configs:</span>
<span class="hljs-symbol">hf:</span># HuggingFace 本地推理配置
<span class="hljs-symbol">batch_size:</span><span class="hljs-number">8</span>
<span class="hljs-symbol">gpu_ids:</span><span class="hljs-number">2</span>,<span class="hljs-number">3</span>
<span class="hljs-symbol">model_name_or_path:</span>openbmb/MiniCPM4-<span class="hljs-number">8</span>B
<span class="hljs-symbol">trust_remote_code:</span><span class="hljs-literal">true</span># 允许加载带自定义代码的模型
<span class="hljs-symbol">openai:</span># OpenAI API 推理配置
<span class="hljs-symbol">api_key:</span><span class="hljs-comment">''# OpenAI API 密钥</span>
<span class="hljs-symbol">base_delay:</span><span class="hljs-number">1.0#</span> 重试间隔时间（秒）
<span class="hljs-symbol">base_url:</span>http://localhost:<span class="hljs-number">8000</span>/v1
<span class="hljs-symbol">concurrency:</span><span class="hljs-number">8</span># 并发请求数
<span class="hljs-symbol">model_name:</span>MiniCPM4-<span class="hljs-number">8</span>B
<span class="hljs-symbol">retries:</span><span class="hljs-number">3</span># 最大重试次数
<span class="hljs-symbol">vllm:</span># vLLM 推理引擎配置
<span class="hljs-symbol">dtype:</span><span class="hljs-keyword">auto</span># 自动选择精度（如 fp16/bf16）
<span class="hljs-symbol">gpu_ids:</span><span class="hljs-number">2</span>,<span class="hljs-number">3</span># 指定 GPU ID
<span class="hljs-symbol">gpu_memory_utilization:</span><span class="hljs-number">0.9#</span> GPU 显存利用率上限
<span class="hljs-symbol">model_name_or_path:</span>openbmb/MiniCPM4-<span class="hljs-number">8</span>B
<span class="hljs-symbol">model_name_or_path:</span>Qwen/Qwen3-<span class="hljs-number">8</span>B
<span class="hljs-symbol">trust_remote_code:</span><span class="hljs-literal">true</span>
<span class="hljs-symbol">sampling_params:</span># 采样参数（影响生成多样性）
<span class="hljs-symbol">chat_template_kwargs:</span>
<span class="hljs-symbol">enable_thinking:</span><span class="hljs-literal">false</span># 是否启用思维链模式
<span class="hljs-symbol">max_tokens:</span><span class="hljs-number">2048</span># 最大生成长度
<span class="hljs-symbol">temperature:</span><span class="hljs-number">0.7#</span> 温度系数（越高越随机）
<span class="hljs-symbol">top_p:</span><span class="hljs-number">0.8#</span> nucleus sampling 阈值
<span class="hljs-symbol">system_prompt:</span><span class="hljs-comment">''# 系统提示词（可留空）</span>

<span class="hljs-symbol">prompt:</span>
<span class="hljs-symbol">template:</span>prompt/qa_boxed.jinja
<span class="hljs-symbol">template:</span>prompt/qa_rag_boxed.jinja# 使用的 Prompt 模板路径（Jinja 格式）

<span class="hljs-symbol">retriever:</span>
<span class="hljs-symbol">backend:</span>sentence_transformers# 向量化后端，可选 sentence_transformers / infinity / openai
<span class="hljs-symbol">backend_configs:</span>
<span class="hljs-symbol">infinity:</span># Infinity-Emb 推理配置
<span class="hljs-symbol">bettertransformer:</span><span class="hljs-literal">false</span>
<span class="hljs-symbol">device:</span>cuda
<span class="hljs-symbol">model_warmup:</span><span class="hljs-literal">false</span>
<span class="hljs-symbol">pooling_method:</span><span class="hljs-keyword">auto</span>
<span class="hljs-symbol">trust_remote_code:</span><span class="hljs-literal">true</span>
<span class="hljs-symbol">openai:</span># OpenAI Embedding API 配置
<span class="hljs-symbol">api_key:</span><span class="hljs-comment">''</span>
<span class="hljs-symbol">base_url:</span>https://api.openai.com/v1
<span class="hljs-symbol">model_name:</span><span class="hljs-keyword">text</span>-embedding-<span class="hljs-number">3</span>-small
<span class="hljs-symbol">sentence_transformers:</span># SentenceTransformers 本地配置
<span class="hljs-symbol">device:</span>cuda
<span class="hljs-symbol">sentence_transformers_encode:</span>
<span class="hljs-symbol">encode_chunk_size:</span><span class="hljs-number">10000</span># 每批编码文本数量
<span class="hljs-symbol">normalize_embeddings:</span><span class="hljs-literal">false</span># 是否归一化嵌入向量
<span class="hljs-symbol">psg_prompt_name:</span>document# passage 编码提示词名称
<span class="hljs-symbol">psg_task:</span>null# passage 任务类型
<span class="hljs-symbol">q_prompt_name:</span>query# query 编码提示词名称
<span class="hljs-symbol">q_task:</span>null# query 任务类型
<span class="hljs-symbol">trust_remote_code:</span><span class="hljs-literal">true</span>
<span class="hljs-symbol">batch_size:</span><span class="hljs-number">16</span># 向量化批大小
<span class="hljs-symbol">corpus_path:</span>data/corpus_example.jsonl# 语料库路径
<span class="hljs-symbol">embedding_path:</span>embedding/embedding.npy# 向量保存路径
<span class="hljs-symbol">faiss_use_gpu:</span><span class="hljs-literal">true</span># 是否启用 GPU 加速的 Faiss
<span class="hljs-symbol">gpu_ids:</span><span class="hljs-number">0</span>,<span class="hljs-number">1</span># 指定 GPU 设备
<span class="hljs-symbol">index_chunk_size:</span><span class="hljs-number">50000</span># 每批构建索引的文档数
<span class="hljs-symbol">index_path:</span>index/index.index# 索引文件保存路径
<span class="hljs-symbol">is_multimodal:</span><span class="hljs-literal">false</span># 是否为多模态检索（图文混合）
<span class="hljs-symbol">model_name_or_path:</span>openbmb/MiniCPM-Embedding-Light
<span class="hljs-symbol">model_name_or_path:</span>Qwen/Qwen3-Embedding-<span class="hljs-number">0.6</span>B# 向量化模型路径
<span class="hljs-symbol">overwrite:</span><span class="hljs-literal">false</span># 是否覆盖已有 embedding / index
<span class="hljs-symbol">query_instruction:</span><span class="hljs-comment">''# query 前置指令（可为空）</span>
<span class="hljs-symbol">top_k:</span><span class="hljs-number">5</span># 检索返回的 Top-K 文档数
</code></pre>
<p>可以根据实际情况修改参数，例如：</p>
<ul>
<li>将 template 调整为RAG模版 prompt/qa_rag_boxed.jinja；</li>
<li>替换检索器与生成器的 model_name_or_path 为本地下载的模型路径；</li>
<li>若在多 GPU 环境下运行，可修改 gpu_ids 以匹配可用设备</li>
</ul>
<p><strong>Step 3：运行 Pipeline</strong></p>
<p>当参数配置完成后，即可一键运行完整流程。执行以下命令：</p>
<pre><code class="hljs language-arduino" lang="arduino">ultrarag run examples/rag_full.yaml
</code></pre>
<p>系统将依次执行配置文件中定义的各个 Server 与 Tool，并在终端中实时输出运行日志与进度信息：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e6ece8d468e1448895a892544cd7dacc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336792&amp;x-signature=EyXDGwWMDdfWxRk44ArgBLLljnk%3D" alt="" loading="lazy"/></p>
<p>运行结束后，结果（如生成内容、评测报告等）将自动保存在对应的输出路径中，如</p>
<p>/output/memory_nq_demo_rag_20251203_031625.json</p>
<p>可直接用于后续分析与可视化展示</p>
<p><strong>可视化测评</strong></p>
<p>在运行完成 yaml 文件后，系统会在 output 文件夹下自动生成一份 memory 日志文件，例如：</p>
<p>/output/memory_nq_demo_rag_20251203_031625.json 。</p>
<p>只需执行以下命令，即可启动 Case Study 可视化网站</p>
<pre><code class="hljs language-css" lang="css">python ./script/case_study<span class="hljs-selector-class">.py</span> \
  <span class="hljs-attr">--data</span> output/memory_nq_demo_rag_20251203_031625<span class="hljs-selector-class">.json</span> \
  <span class="hljs-attr">--host</span> <span class="hljs-number">0.0</span>.<span class="hljs-number">0.0</span> \
  <span class="hljs-attr">--port</span> <span class="hljs-number">8080</span> \
  <span class="hljs-attr">--title</span> "Case Study Viewer"
</code></pre>
<p>可视化测评界面：</p>
<p>包含具体的 RAG 执行步骤，以及各个步骤执行结果</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f56f4c9cf76e4c42a4f7b8c6881ea18f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336792&amp;x-signature=%2B%2FOkn7D9lxAuD0ECcAwETW0McVw%3D" alt="" loading="lazy"/></p>
<p>检索回的内容：</p>
<p>拼接后的prompt:</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb1fbe51376141abb4164d700cc3d435~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336792&amp;x-signature=6j%2B3JKKgQoZ1szQHu5imHrzO6Jk%3D" alt="" loading="lazy"/></p>
<p>模型输出内容：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/807bee8b63164b49b14f955dd3c5d70d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767336792&amp;x-signature=KOS%2FfnArM3VT3CEMRK3q2Qv0kIQ%3D" alt="" loading="lazy"/></p>
<p><strong>结语</strong></p>
<p>UltraRAG 仍处于早期发展阶段，但其所代表的方向已经十分清晰：</p>
<ul>
<li>
<p>在架构层面，强调协议化与模块化</p>
</li>
<li>
<p>在工程层面，强调配置驱动与可观测性</p>
</li>
<li>
<p>在系统形态上，走向实时化与工具化</p>
</li>
</ul>
<p>对于正在构建或规划下一代 RAG 系统的团队而言，UltraRAG 与 MCP 所提供的思路，具有重要的参考价值。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我读了OpenAI的GPT‑5.2提示指南，这样你就不用读了]]></title>    <link>https://juejin.cn/post/7587704265055567910</link>    <guid>https://juejin.cn/post/7587704265055567910</guid>    <pubDate>2025-12-26T05:32:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587704265055567910" data-draft-id="7587704265055551526" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我读了OpenAI的GPT‑5.2提示指南，这样你就不用读了"/> <meta itemprop="keywords" content="OpenAI,AIGC"/> <meta itemprop="datePublished" content="2025-12-26T05:32:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="安思派Anspire"/> <meta itemprop="url" content="https://juejin.cn/user/3044964115417419"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我读了OpenAI的GPT‑5.2提示指南，这样你就不用读了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3044964115417419/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    安思派Anspire
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T05:32:46.000Z" title="Fri Dec 26 2025 05:32:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>两周前，ChatGPT给出了一个“完美”但毫无用处的答案。它听起来很自信，格式也很好，甚至还有一个计划，但仍然没有抓住要点。就在那时，我突然明白了：大多数人没有“AI问题”……他们有一个</p>
<p>提示形状</p>
<p>问题。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fopenai%2Fopenai-cookbook%2Fblob%2Fmain%2Fexamples%2Fgpt-5%2Fgpt-5-2_prompting_guide.ipynb" target="_blank" title="https://github.com/openai/openai-cookbook/blob/main/examples/gpt-5/gpt-5-2_prompting_guide.ipynb" ref="nofollow noopener noreferrer">OpenAI官方的GPT5.2提示指南</a>基本上就是解决这个问题的蓝图——尤其是如果你将ChatGPT用于工作：写作、学习、研究、规划或开展项目。GPT5.2旨在更加准确、更有纪律性，并且在结构化工作流程方面表现更出色，但它仍然对提问方式很敏感——语气、长度和格式的重要性超出人们的想象。</p>
<p>下面是捷径：指南中的一些模式，无需成为开发者就能可靠地使输出更清晰、更简短、更准确。</p>
<p>按回车键或点击以查看全尺寸图像</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63c779ee75cb4516b1b338e768009902~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a6J5oCd5rS-QW5zcGlyZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767331965&amp;x-signature=ZMipSr5kJrVOL8d4%2FZ8H32oUUQQ%3D" alt="" loading="lazy"/></p>
<p>来源：作者创作</p>
<h2 data-id="heading-0">快速目录</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.towardsai.net%2Fi-read-openais-gpt-5-2-prompting-guide-so-you-don-t-have-to-c5efcfd92d48" target="_blank" title="https://pub.towardsai.net/i-read-openais-gpt-5-2-prompting-guide-so-you-don-t-have-to-c5efcfd92d48" ref="nofollow noopener noreferrer">任何人都可以使用的单提示配方模式1：控制长度（停止文章）模式2：防止范围蔓延（只做我要求的事）模式3：长上下文且不丢失细节模式4：模糊性规则（不做自信猜测）模式5：20秒自我检查（高风险输出）6个现实生活中的复制/粘贴提示（学生、创作者、经理等）最终入门套件（保存此部分）</a></p>
<h2 data-id="heading-1">需要记住的一件事</h2>
<p>与早期版本相比，GPT5.2倾向于产生更简洁的格式和更少不必要的冗长，但当提示清楚地定义答案的“形状”（长度、部分和</p>
<p>不</p>
<p>做什么）时，它的性能最好。 不要把提示看作是“问问题”，而更像是“编写一个微小的规范”，模型可以始终如一地遵循。</p>
<p>以下是适用于学生、创作者、管理者以及任何在ChatGPT中进行严肃工作的人的通用提示配方：角色 + 目标 + 背景 + 约束条件 + 输出格式 + 质量标准。</p>
<p>复制/粘贴模板（保持简单并填写括号）：</p>
<p>角色：你是一名[教练/编辑/分析师/导师/项目助理]。 目标：帮助我实现[特定成果]。 背景信息：以下是你需要了解的内容： -[背景情况] -[受众群体] -[我已有的内容/我尝试过的方法] 限制条件： -不要[添加新的假设/编造数据/添加额外的章节]。 -如果有信息缺失，[最多询问3个问题]或[明确陈述假设]。 -内容控制在[X句话]或[Y个要点]以内。 输出格式： -第1部分：[简短回答] -第2节：[项目符号/表格/清单] -第3节：[下一步计划] 质量标准： -使用简单的语言。 -具体且可操作。 -如果不确定，说明什么取决于什么。</p>
<h2 data-id="heading-2">模式1：控制长度（否则ChatGPT会）</h2>
<p>《GPT5.2指南》中最实用的经验之一很直白：如果你不设定长度限制，就等于让模型来决定什么是“足够”。 GPT5.2通常没那么啰嗦，但它仍然是可控的——所以当你想要一致的输出（尤其是用于工作时），明确的长度限制会产生很大的影响。</p>
<p>当你想要简洁明了、不冗长的回答时，请使用此功能：</p>
<p>回答要求： - 1个简短段落（最多4句话） - 然后最多5个要点：“关键事项”、“原因”、“下一步行动”、“风险”、“开放性问题” 无额外评论。</p>
<p>这种夹具正是将“聪明但话多”转变为“有用且可预测”的关键所在。</p>
<h2 data-id="heading-3">模式2：遏制范围蔓延（礼貌但坚定地）</h2>
<p>GPT5.2可能会陷入一个陷阱，因为它</p>
<p>太出色了</p>
<p>：它可能会做一些你没有要求的“额外”工作——额外的功能、额外的步骤、额外的格式、额外的想法。 在指南中，解决方法是明确的范围约束：告诉模型只实现你所要求的内容，并将其他一切视为可选。</p>
<p>无论何时，只要你想专注于手头的任务（如邮件、计划、大纲、提案，甚至人生决策），就使用这个模块：</p>
<p>严格按照我的要求去做——不要多做。 -不要添加额外的部分、功能或“锦上添花”的内容。 -如果你发现有改进之处，将它们列在“可选建议”下，但不要实施。 -当出现歧义时，选择最简单合理的解释。</p>
<p>这个单一约束节省了时间，因为它阻止了“有益的绕道”循环。</p>
<h2 data-id="heading-4">模式3：长文本？强制重新定位</h2>
<p>如果你粘贴长内容——会议记录、合同、研究报告、杂乱的对话——大多数人都期望ChatGPT“能搞定”。但它却会遗漏细节，还自信满满地总结出错误的内容。</p>
<p>《GPT5.2指南》建议针对长上下文采用重新锚定模式：概述关键内容，重申约束条件，然后在回答时将论点锚定到文本的相关部分。 这可以减少“迷失在滚动中”的错误，并提高对密集输入的召回率。</p>
<p>当你的输入较长（或者你</p>
<p>非常</p>
<p>在意准确性时），请使用此功能：</p>
<p>回答前： 1) 从粘贴的文本中列出5 - 8个最相关的要点（简短的要点列表）。 2) 用自己的话重述我的限制条件（1 - 2句话）。 3) 然后回答，并注明每个关键主张的来源（例如，“来自定价部分 / 来自关于X的段落”）。 如果有信息缺失，不要猜测——最多问3个问题。</p>
<p>此外：使用清晰的标签（例如，“说明：”，然后是“源文本：”）将指令与粘贴的内容分开，这样模型就不会将它们混淆。</p>
<h2 data-id="heading-5">模式4：当问题模糊不清时，不要让答案装作它不是这样</h2>
<p>这就是“病毒式”ChatGPT帖子的无声杀手：即使提示模糊，模型听起来也很确定。GPT5.2指南明确建议通过强制采取以下两种行为之一来防范过度自信的回答：问几个澄清性问题，或者提出几种解释并明确标注假设。</p>
<p>下面这个模块能将“自信的胡言乱语”转化为“有用的思考”：</p>
<p>如果我的请求含糊不清或缺少关键信息： -用一句话指出缺少的内容。 -然后执行以下操作之一： A) 最多询问3个澄清问题，或 B) 提供2 - 3种合理的解释，每种解释都有明确的假设。 不确定时，切勿编造确切的数字、引用或参考资料。</p>
<p>这与OpenAI关于ChatGPT的一般提示建议相符：要清晰明确，并在看到第一个输出后进行迭代优化。</p>
<h2 data-id="heading-6">模式5：防止代价高昂错误的“自我检查”</h2>
<p>大多数人使用ChatGPT就像使用自动售货机一样：输入提示，接收答案，然后就完事了。但该指南建议在高风险场景（法律、金融、合规、安全）中增加一个快速的自我检查环节，以发现未阐明的假设和缺乏依据的细节。</p>
<p>即使你不从事“法律工作”，这对日常生活来说也是宝贵的：合同、工作邀约、定价页面、政策、医疗信息，或者任何细节错误会产生影响的内容。</p>
<p>复制/粘贴：</p>
<p>在最终确定之前： -检查你的回答中是否有任何未基于我提供内容的具体数字、日期或主张。 -找出任何未明确说明的假设。 -在适当的时候，用有条件的语言替换过于绝对的语言。 只有在完成此检查后，才返回最终答案。</p>
<p>这基本上是一个微小的质量控制循环，也是迭代优化在提示词最佳实践中被反复推荐的原因之一。</p>
<h2 data-id="heading-7">“6个你每周都会用到的提示”</h2>
<p>现在来谈谈让这篇文章真正对任何人都有用的部分：现成可用的提示词，其中融入了上述五种模式（形状、长度、范围、依据、歧义处理、自我检查）。</p>
<ol>
<li>学生：将杂乱的笔记整理成学习计划</li>
</ol>
<hr/>
<p>角色：你是我的学习教练。 目标：将我的笔记转化为7天学习计划和一份测验。 源笔记： [粘贴笔记] 限制条件： -如果有任何主题不清楚，最多问3个问题。 -不要编造笔记中没有的事实。 -保持简洁。 输出格式： 1) “学习内容”（最多8项要点） 2) 7天计划（表格：日期 | 主题 | 练习任务） 3) 10道测验题 + 答案</p>
<h2 data-id="heading-8">2)创作者：大纲→初稿→有力改写（适合传播）</h2>
<p>角色：你是面向Medium读者的敏锐编辑。 目标：创建一个可点击的大纲和初稿。 背景： -主题：[你的主题] -受众：[初学者 / 建设者 / 创始人] -语气：简洁、直接、有故事性。 限制条件： -无泛泛而谈的填充内容。 -保持各部分简短。避免长段落。 -添加3条“吸睛金句”（可发推文的一句话），且不令人尴尬。 输出： 1) 带有二级标题和要点的大纲 2) 初稿引言（150 - 200字） 3) 3条吸睛金句</p>
<p>DataCamp的提示示例突出了相同的模式：说明适用对象、存在原因以及所需格式，这样模型就无需猜测。</p>
<ol start="3">
<li>专业：撰写能得到实际回复的邮件</li>
</ol>
<hr/>
<p>角色：你是我的沟通助理。 目标：撰写一封能得到回复的清晰邮件。 背景： -收件人：[老板/客户/教授] -关系：[正式/随意] -目的：[询问、更新、请求、推迟] 限制条件： -最多120字。 -提供2种语气选项：“直接”和“热情”。 -不要添加额外的承诺或保证。 输出： -主题行 -邮件正文 -1句话的跟进消息（48小时后发送）</p>
<h2 data-id="heading-9">4)会议：将杂乱的会议记录转化为行动</h2>
<p>角色：你是项目助理。 目标：从本次会议文本中提取行动项。 会议文本： [paste] 约束条件： -如果负责人/日期缺失，将其设置为 "TBD"（不要猜测）。 -保持结构清晰。 输出： 1) 决策（项目符号） 2) 行动项（表格：任务 | 负责人 | 截止日期 | 依赖关系 | 风险） 3) 未决问题（最多6个）</p>
<p>这是GPT5.2指南中的“结构化提取”精神：定义一个模式，区分必填项和选填项，并明确表示缺失字段，而不是猜测。</p>
<ol start="5">
<li>人生抉择：明智选择，避免陷入困境</li>
</ol>
<hr/>
<p>角色：你是一位务实的决策教练。 目标：帮助我在各选项间做出决策，避免过度思考。 我的选项： A) [选项] B) [选项] C) [选项] 我的限制条件： -预算：[ ] -时间：[ ] -风险承受能力：[低/中/高] -我最看重的：[ ] 规则： -如果有信息缺失，最多问3个问题。 -除非我要求，否则不要引入新选项。 输出： 1) 5行建议 2) 比较表（标准 | A | B | C） 3) “如果你选择A，接下来这么做”（3个步骤）</p>
<ol start="6">
<li>研究：“不要猜测——要有依据”</li>
</ol>
<hr/>
<p>如果你要在ChatGPT内进行网络研究，官方GPT5.2指南建议预先设定研究标准（研究深度、是否解决矛盾以及是否使用引用）。 用法：</p>
<p>担任研究助理。 任务：研究[主题]。 规则： -当事实不确定时，优先进行网络研究，而非仅凭假设。 -解决矛盾，并为关键主张引用来源。 -当额外研究不太可能改变结论时停止。 输出： -关键发现（要点） -矛盾+解决方案 -实际收获</p>
<p>这种风格符合OpenAI关于使用清晰指令和结构化提示（包括使用分隔符将指令与上下文分开）的一般指导原则。</p>
<h2 data-id="heading-10">关闭</h2>
<p>如果说有一个值得从官方GPT5.2提示指南中借鉴的理念，那就是：GPT5.2比旧模型更有纪律性，但它会对明确的约束条件给予回报——包括长度、范围、结构和“不要猜测”规则。 因此，与其寻找“<strong>神奇提示词</strong>”，不如建立一个小型的个人模板库：一个用于<strong>写作</strong>，一个用于<strong>学习</strong>，一个用于<strong>决策</strong>，一个用于<strong>总结</strong>，一个用于<strong>研究</strong>——并反复使用它们，直到你觉得厌烦为止。 因为真正的优势不在于巧妙的提示词，而在于可重复的工作流程：定义输出形式、防止范围蔓延、重新梳理长上下文，并在输入模糊时迫使模型承认不确定性。</p>
<p>这是最终的“保存此内容”入门套件（将其固定为便签）：</p>
<ul>
<li>
<p>“用X句话+Y个要点回答，无其他要求。”</p>
</li>
<li>
<p>“严格按照我的要求去做；将额外事项列为可选，不要去做。”</p>
</li>
<li>
<p>“如果文本较长：列出大纲 → 重申约束条件 → 答案与各部分相关联。”</p>
</li>
<li>
<p>“如果存在歧义：最多询问3个问题或展示3种带有假设的解释。”</p>
</li>
<li>
<p>“定稿前：自我检查是否存在无根据的主张和绝对化的表述。”</p>
</li>
</ul>
<p>使用这五块一周，效果提升会让你觉得不公平。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025，我的“AI Vibe Coding”时刻：一个八年Java开发者的年度复盘]]></title>    <link>https://juejin.cn/post/7587712328826748964</link>    <guid>https://juejin.cn/post/7587712328826748964</guid>    <pubDate>2025-12-26T03:50:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587712328826748964" data-draft-id="7587713001715154998" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025，我的“AI Vibe Coding”时刻：一个八年Java开发者的年度复盘"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-12-26T03:50:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="天天摸鱼的java工程师"/> <meta itemprop="url" content="https://juejin.cn/user/3109843365802925"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025，我的“AI Vibe Coding”时刻：一个八年Java开发者的年度复盘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3109843365802925/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    天天摸鱼的java工程师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T03:50:37.000Z" title="Fri Dec 26 2025 03:50:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">2025，我的“AI Vibe Coding”时刻：一个八年Java开发者的年度复盘</h2>
<blockquote>
<p><strong>写在前面</strong>：这是我作为一名 Java 后端程序员，在 AI 技术浪潮中度过的第八个年头。2025 年，或许不是我写代码最多的一年，却无疑是我写得“最轻松”、“最聪明”的一年。</p>
</blockquote>
<blockquote>
<p>本文作为我的 2025 年终总结，参与 #2025 AI/Vibe Coding 对我的影响# 年终征文活动，也想通过这篇文章，记录下我与 AI 工具共舞的一年。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">一场从“手动搬砖”到“AI赋能”的转变</h3>
<p>还记得年初时团队刚刚讨论要不要引入 AI 工具辅助开发，大家的态度一开始是观望的，我也一样。毕竟写了这么多年 Java，IDE 插件、自动补全、代码生成器都用得得心应手，何必多此一举？</p>
<p>直到我真正尝试将 <strong>GitHub Copilot</strong> 和 <strong>ChatGPT</strong> 融入开发流程，才真正体会到什么叫： <strong>“不是你不会，而是你再也不必！”</strong></p>
<hr/>
<h3 data-id="heading-2">我的 AI Coding 工具链</h3>
<p>2025年，我最常用的 AI 工具组合是：</p>
<ul>
<li><strong>ChatGPT-4 / GPT-4o（OpenAI）</strong></li>
<li><strong>GitHub Copilot</strong></li>
<li><strong>Codeium（在 JetBrains IDE 上）</strong></li>
<li><strong>LangChain + LLM 服务（用于开发智能 Agent）</strong></li>
</ul>
<h4 data-id="heading-3">使用场景一：项目启动从未如此丝滑</h4>
<p>以前新启动一个 Spring Boot 项目，我要手动配置：</p>
<ul>
<li>数据库连接</li>
<li>Security 策略</li>
<li>Redis 缓存</li>
<li>Dockerfile + CI/CD 脚本</li>
</ul>
<p>现在我只需要一句 prompt：“帮我生成一个支持 MySQL + Redis + JWT 鉴权的 Spring Boot 项目结构，并配好 Dockerfile 和 GitHub Actions。”</p>
<p><strong>5分钟之后，连注释都帮我写好了。</strong></p>
<hr/>
<h4 data-id="heading-4">使用场景二：调 bug 的思路更清晰</h4>
<p>过去调 bug，经常是：</p>
<blockquote>
<p>抓日志 → 看源码 → 猜测原因 → Google → StackOverflow → debug → 反复试错</p>
</blockquote>
<p>现在我会先把报错信息贴给 ChatGPT，附上相关代码，它会帮我：</p>
<ul>
<li>解读异常含义</li>
<li>给出可能的错误位置</li>
<li>推荐调试思路</li>
<li>有时甚至直接给出修复代码</li>
</ul>
<p>虽然它不总是对的，但节省了我大量排查路径的时间。</p>
<hr/>
<h4 data-id="heading-5">使用场景三：AI 做我的“代码合伙人”</h4>
<p>今年我尝试了一个 side project，基于 Spring Boot + LangChain 构建了一个“文档知识库助手”，可以上传 PDF / Markdown / API 文档，自动生成 Q&amp;A Agent。</p>
<p>整个项目的业务逻辑架构、数据库模型设计、接口文档，都是我和 GPT 共同完成的。那种“我说你写，你写我改”的开发体验，真的像和一个 24 小时在线的资深程序员 pair programming。</p>
<hr/>
<h3 data-id="heading-6">技术人也需要“生活Vibe”</h3>
<p>今年我最大的生活改变，是开始尝试用 AI 改变生活习惯。</p>
<ul>
<li><strong>旅行计划</strong>：用 GPT 规划了云南 8 天自由行，包含吃住、天气、景点、路线，全自动。</li>
<li><strong>亲子教育</strong>：孩子上小学，我用 GPT 编故事、出数学题、改作文，提升了陪伴质量。</li>
<li><strong>学习音乐</strong>：我甚至用 AI 帮我写了一首吉他弹唱曲，歌词、和弦、节奏全都生成，超酷！</li>
</ul>
<hr/>
<h3 data-id="heading-7">从“写代码”到“设计智能体”，开发者角色正在进化</h3>
<p>今年我也开始关注 Agent 开发（像 AutoGPT、LangChain 等），尝试把“写功能”转变为“设计 Agent 任务流”。</p>
<p>举例来说，我做了一个“代码审查 Agent”，它可以：</p>
<ul>
<li>分析 PR 的改动范围</li>
<li>判断是否符合编码规范</li>
<li>根据历史提交风格生成审查意见</li>
</ul>
<p>我意识到未来开发者可能不再只是“Coder”，而是“Agent Designer”，用 LLM 做 runtime 的一部分。</p>
<hr/>
<h3 data-id="heading-8">这一年，我重新定义了“效率”</h3>
<p>效率不再是“写了多少行代码”，而是：</p>
<ul>
<li><strong>用更少的代码解决更复杂的问题</strong></li>
<li><strong>把注意力从细节转移到系统设计</strong></li>
<li><strong>通过 AI 工具提升认知边界</strong></li>
</ul>
<hr/>
<h3 data-id="heading-9">2026，我想继续做一个“AI增强人类”的践行者</h3>
<p>2025 让我看见了 AI 不只是工具，更是一种工作方式的重塑。2026，我希望自己能：</p>
<ul>
<li>更深入理解大模型的原理（继续学习 Transformer、RAG 等技术）</li>
<li>尝试开源自己的 AI 工具链整合方案</li>
<li>帮助更多团队构建 AI-enhanced 的开发流程</li>
</ul>
<hr/>
<h3 data-id="heading-10">写在最后</h3>
<p>我是一个普通的 Java 程序员，但在 2025 年，我感受到技术变革的每一次脉动。</p>
<p>从“写代码”到“共创代码”，从“调 bug”到“设计 Agent”，从“工具使用者”到“智能协作者”——我想，这就是我的 <strong>Vibe Coding 时刻</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[服务器进程日志分析：从头皮发麻到AI解救]]></title>    <link>https://juejin.cn/post/7587704265055223846</link>    <guid>https://juejin.cn/post/7587704265055223846</guid>    <pubDate>2025-12-26T04:01:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587704265055223846" data-draft-id="7587704265055207462" data-original-type="2" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="服务器进程日志分析：从头皮发麻到AI解救"/> <meta itemprop="keywords" content="后端,运维"/> <meta itemprop="datePublished" content="2025-12-26T04:01:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="PFinal社区_南丞"/> <meta itemprop="url" content="https://juejin.cn/user/1855631357906040"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            服务器进程日志分析：从头皮发麻到AI解救
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1855631357906040/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    PFinal社区_南丞
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T04:01:05.000Z" title="Fri Dec 26 2025 04:01:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">服务器进程日志分析：从头皮发麻到AI解救</h2>
<h3 data-id="heading-1">写在前面</h3>
<p>最近在维护一台老的 <strong>Web服务器</strong>，每次查看进程的时候，<code>ps aux</code> 一敲，屏幕上刷出来密密麻麻一大堆进程信息，看得我头皮发麻。尤其是那些超长的命令参数，看着就让人心烦。想着总不能每次都这么痛苦吧，于是决定整点东西来解决这个问题。</p>
<h3 data-id="heading-2">解决思路</h3>
<p>既然每次都要看这些进程信息，那不如写个脚本，把执行结果记录下来，顺便统计一下执行时间和退出码，方便后续分析。说干就干，我写了下面这个脚本：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">command</span>=<span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
log_file=<span class="hljs-string">"command_execution_<span class="hljs-subst">$(date <span class="hljs-string">"+%Y%m%d_%H%M%S"</span>)</span>.log"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"========================================"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$log_file</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"时间: <span class="hljs-subst">$(date)</span>"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$log_file</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"命令: <span class="hljs-variable">$command</span>"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$log_file</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"========================================"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$log_file</span>"</span>
<span class="hljs-comment"># 使用Bash内置计时器</span>
start_time=<span class="hljs-variable">$SECONDS</span>
<span class="hljs-comment"># 使用临时文件避免子shell问题</span>
temp_file=$(<span class="hljs-built_in">mktemp</span>)
<span class="hljs-built_in">eval</span> <span class="hljs-string">"<span class="hljs-variable">$command</span>"</span> 2&gt;&amp;1 | <span class="hljs-built_in">tee</span> <span class="hljs-string">"<span class="hljs-variable">$temp_file</span>"</span>
exit_code=<span class="hljs-variable">${PIPESTATUS[0]}</span>
<span class="hljs-comment"># 将输出追加到日志文件</span>
<span class="hljs-built_in">cat</span> <span class="hljs-string">"<span class="hljs-variable">$temp_file</span>"</span> &gt;&gt; <span class="hljs-string">"<span class="hljs-variable">$log_file</span>"</span>
<span class="hljs-built_in">rm</span> <span class="hljs-string">"<span class="hljs-variable">$temp_file</span>"</span>
duration=$((SECONDS - start_time))
<span class="hljs-built_in">echo</span> <span class="hljs-string">"========================================"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$log_file</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"退出码: <span class="hljs-variable">$exit_code</span>"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$log_file</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"耗时: <span class="hljs-variable">${duration}</span>秒"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$log_file</span>"</span>
</code></pre>
<p>这个脚本的功能很简单：把任意命令的执行过程记录下来，包括执行时间、命令本身、完整输出、退出码和耗时。一目了然，该有的信息都有了。</p>
<h3 data-id="heading-3">实战使用</h3>
<p>把脚本往服务器上一丢，起个好记的名字，比如 <code>命令执行监控.sh</code>，然后运行一下：</p>
<pre><code class="hljs language-bash" lang="bash">./命令执行监控.sh ps aux 
</code></pre>
<p>执行完毕后，脚本会自动生成一个带时间戳的日志文件，打开一看，格式整整齐齐：</p>
<pre><code class="hljs language-typescript" lang="typescript">========================================
时间: <span class="hljs-number">2025</span>年<span class="hljs-number">12</span>月<span class="hljs-number">26</span>日 星期五 <span class="hljs-number">11</span>时<span class="hljs-number">10</span>分<span class="hljs-number">09</span>秒 <span class="hljs-variable constant_">CST</span>
命令: ps aux
========================================
<span class="hljs-variable constant_">USER</span>               <span class="hljs-variable constant_">PID</span>  %<span class="hljs-variable constant_">CPU</span> %<span class="hljs-variable constant_">MEM</span>      <span class="hljs-variable constant_">VSZ</span>    <span class="hljs-variable constant_">RSS</span>   <span class="hljs-variable constant_">TT</span>  <span class="hljs-variable constant_">STAT</span> <span class="hljs-variable constant_">STARTED</span>      <span class="hljs-variable constant_">TIME</span> <span class="hljs-variable constant_">COMMAND</span>
pfinal           <span class="hljs-number">47294</span>  <span class="hljs-number">18.2</span>  <span class="hljs-number">2.0</span> <span class="hljs-number">1494420072</span> <span class="hljs-number">338416</span>   ??  R    <span class="hljs-number">11</span>:<span class="hljs-number">01</span>上午   <span class="hljs-number">0</span>:<span class="hljs-number">47.08</span> /<span class="hljs-title class_">Applications</span>/<span class="hljs-title class_">Trae</span> <span class="hljs-variable constant_">CN</span>.<span class="hljs-property">app</span>/<span class="hljs-title class_">Contents</span>/<span class="hljs-title class_">Frameworks</span>/<span class="hljs-title class_">Trae</span> <span class="hljs-variable constant_">CN</span> <span class="hljs-title class_">Helper</span> (<span class="hljs-title class_">Renderer</span>).<span class="hljs-property">app</span>/<span class="hljs-title class_">Contents</span>/<span class="hljs-title class_">MacOS</span>/<span class="hljs-title class_">Trae</span> <span class="hljs-variable constant_">CN</span> <span class="hljs-title class_">Helper</span> (<span class="hljs-title class_">Renderer</span>) --<span class="hljs-keyword">type</span>=renderer --user-data-dir=<span class="hljs-regexp">/Users/</span>pfinal/<span class="hljs-title class_">Library</span>/<span class="hljs-title class_">Application</span> <span class="hljs-title class_">Support</span>/<span class="hljs-title class_">Trae</span> <span class="hljs-variable constant_">CN</span> --standard-schemes=vscode-webview,vscode-file --enable-sandbox --secure-schemes=vscode-webview,vscode-file --cors-schemes=vscode-webview,vscode-file --fetch-schemes=vscode-webview,vscode-file --service-worker-schemes=vscode-webview --code-cache-schemes=vscode-webview,vscode-file --app-path=<span class="hljs-regexp">/Applications/</span><span class="hljs-title class_">Trae</span> <span class="hljs-variable constant_">CN</span>.<span class="hljs-property">app</span>/<span class="hljs-title class_">Contents</span>/<span class="hljs-title class_">Resources</span>/app --enable-sandbox --enable-blink-features=<span class="hljs-title class_">HighlightAPI</span> --js-flags=--max-old-space-size=<span class="hljs-number">8192</span> --disable-blink-features=<span class="hljs-title class_">FontMatchingCTMigration</span>,<span class="hljs-title class_">StandardizedBrowserZoom</span>, --lang=zh-<span class="hljs-variable constant_">CN</span> --num-raster-threads=<span class="hljs-number">4</span> --enable-zero-copy --enable-gpu-memory-buffer-compositor-resources --enable-main-frame-before-activation --renderer-client-id=<span class="hljs-number">8</span> --time-ticks-at-unix-epoch=-<span class="hljs-number">1763549045983093</span> --launch-time-ticks=<span class="hljs-number">3169034948987</span> --shared-files --field-trial-handle=<span class="hljs-number">1718379636</span>,r,<span class="hljs-number">1980764242391010435</span>,<span class="hljs-number">4761999176824767603</span>,<span class="hljs-number">262144</span> --enable-features=<span class="hljs-title class_">DocumentPolicyIncludeJSCallStacksInCrashReports</span>,<span class="hljs-title class_">EarlyEstablishGpuChannel</span>,<span class="hljs-title class_">EstablishGpuChannelAsync</span>,<span class="hljs-title class_">PdfUseShowSaveFilePicker</span>,<span class="hljs-title class_">ScreenCaptureKitPickerScreen</span>,<span class="hljs-title class_">ScreenCaptureKitStreamPickerSonoma</span> --disable-features=<span class="hljs-title class_">CalculateNativeWinOcclusion</span>,<span class="hljs-title class_">FontationsLinuxSystemFonts</span>,<span class="hljs-title class_">MacWebContentsOcclusion</span>,<span class="hljs-title class_">ScreenAIOCREnabled</span>,<span class="hljs-title class_">SpareRendererForSitePerProcess</span>,<span class="hljs-title class_">TimeoutHangingVideoCaptureStarts</span> --variations-seed-version --vscode-<span class="hljs-variable language_">window</span>-config=<span class="hljs-attr">vscode</span>:8765d1cc-a06f-493a-a7f5-1893d3c1f3a0 --seatbelt-client=<span class="hljs-number">92</span>
_windowserver      <span class="hljs-number">158</span>  <span class="hljs-number">12.5</span>  <span class="hljs-number">0.5</span> <span class="hljs-number">44512404</span>  <span class="hljs-number">82920</span>   ??  <span class="hljs-title class_">Ss</span>   <span class="hljs-number">191125</span>  <span class="hljs-number">3232</span>:<span class="hljs-number">13.57</span> /<span class="hljs-title class_">System</span>/<span class="hljs-title class_">Library</span>/<span class="hljs-title class_">PrivateFrameworks</span>/<span class="hljs-title class_">SkyLight</span>.<span class="hljs-property">framework</span>/<span class="hljs-title class_">Resources</span>/<span class="hljs-title class_">WindowServer</span> -daemon
pfinal           <span class="hljs-number">35223</span>  <span class="hljs-number">12.5</span> <span class="hljs-number">17.2</span> <span class="hljs-number">8634410808</span> <span class="hljs-number">2880396</span>   ??  <span class="hljs-title class_">Ss</span>   <span class="hljs-number">161225</span>  <span class="hljs-number">2030</span>:<span class="hljs-number">45.83</span> /<span class="hljs-title class_">Applications</span>/<span class="hljs-title class_">OrbStack</span>.<span class="hljs-property">app</span>/<span class="hljs-title class_">Contents</span>/<span class="hljs-title class_">Frameworks</span>/<span class="hljs-title class_">OrbStack</span> <span class="hljs-title class_">Helper</span>.<span class="hljs-property">app</span>/<span class="hljs-title class_">Contents</span>/<span class="hljs-title class_">MacOS</span>/<span class="hljs-title class_">OrbStack</span> <span class="hljs-title class_">Helper</span> vmgr -build-id <span class="hljs-number">1763632535</span> -handoff
pfinal           <span class="hljs-number">47538</span>  <span class="hljs-number">11.0</span>  <span class="hljs-number">0.5</span> <span class="hljs-number">1492622204</span>  <span class="hljs-number">85000</span>   ??  S    <span class="hljs-number">11</span>:<span class="hljs-number">01</span>上午   <span class="hljs-number">0</span>:<span class="hljs-number">30.20</span> /<span class="hljs-title class_">Applications</span>/<span class="hljs-title class_">Trae</span> <span class="hljs-variable constant_">CN</span>.<span class="hljs-property">app</span>/<span class="hljs-title class_">Contents</span>/<span class="hljs-title class_">Frameworks</span>/<span class="hljs-title class_">Trae</span> <span class="hljs-variable constant_">CN</span> <span class="hljs-title class_">Helper</span> (<span class="hljs-title class_">Plugin</span>).<span class="hljs-property">app</span>/<span class="hljs-title class_">Contents</span>/<span class="hljs-title class_">MacOS</span>/<span class="hljs-title class_">Trae</span> <span class="hljs-variable constant_">CN</span> <span class="hljs-title class_">Helper</span> (<span class="hljs-title class_">Plugin</span>) --<span class="hljs-keyword">type</span>=utility --utility-sub-<span class="hljs-keyword">type</span>=node.<span class="hljs-property">mojom</span>.<span class="hljs-property">NodeService</span> --lang=zh-<span class="hljs-variable constant_">CN</span> --service-sandbox-<span class="hljs-keyword">type</span>=none --dns-result-order=ipv4first --experimental-network-inspection --inspect-port=<span class="hljs-number">0</span> --vscode-crash-reporter-process-<span class="hljs-keyword">type</span>=extensionHost --user-data-dir=<span class="hljs-regexp">/Users/</span>pfinal/<span class="hljs-title class_">Library</span>/<span class="hljs-title class_">Application</span> <span class="hljs-title class_">Support</span>/<span class="hljs-title class_">Trae</span> <span class="hljs-variable constant_">CN</span> --standard-schemes=vscode-webview,vscode-file --enable-sandbox --secure-schemes=vscode-webview,vscode-file --cors-schemes=vscode-webview,vscode-file --fetch-schemes=vscode-webview,vscode-file --service-worker-schemes=vscode-webview --code-cache-schemes=vscode-webview,vscode-file --shared-files --field-trial-handle=<span class="hljs-number">1718379636</span>,r,<span class="hljs-number">1980764242391010435</span>,<span class="hljs-number">4761999176824767603</span>,<span class="hljs-number">262144</span> --enable-features=<span class="hljs-title class_">DocumentPolicyIncludeJSCallStacksInCrashReports</span>,<span class="hljs-title class_">EarlyEstablishGpuChannel</span>,<span class="hljs-title class_">EstablishGpuChannelAsync</span>,<span class="hljs-title class_">PdfUseShowSaveFilePicker</span>,<span class="hljs-title class_">ScreenCaptureKitPickerScreen</span>,<span class="hljs-title class_">ScreenCaptureKitStreamPickerSonoma</span> --disable-features=<span class="hljs-title class_">CalculateNativeWinOcclusion</span>,<span class="hljs-title class_">FontationsLinuxSystemFonts</span>,<span class="hljs-title class_">MacWebContentsOcclusion</span>,<span class="hljs-title class_">ScreenAIOCREnabled</span>,<span class="hljs-title class_">SpareRendererForSitePerProcess</span>,<span class="hljs-title class_">TimeoutHangingVideoCaptureStarts</span> --variations-seed-version
pfinal           <span class="hljs-number">47288</span>   <span class="hljs-number">9.6</span>  <span class="hljs-number">0.4</span> <span class="hljs-number">67993920</span>  <span class="hljs-number">65248</span>   ??  S    <span class="hljs-number">11</span>:<span class="hljs-number">01</span>上午   <span class="hljs-number">0</span>:<span class="hljs-number">09.56</span> /<span class="hljs-title class_">Applications</span>/<span class="hljs-title class_">Trae</span> <span class="hljs-variable constant_">CN</span>.<span class="hljs-property">app</span>/<span class="hljs-title class_">Contents</span>/<span class="hljs-title class_">Frameworks</span>/<span class="hljs-title class_">Trae</span> <span class="hljs-variable constant_">CN</span> <span class="hljs-title class_">Helper</span> (<span class="hljs-variable constant_">GPU</span>).<span class="hljs-property">app</span>/<span class="hljs-title class_">Contents</span>/<span class="hljs-title class_">MacOS</span>/<span class="hljs-title class_">Trae</span> <span class="hljs-variable constant_">CN</span> <span class="hljs-title class_">Helper</span> (<span class="hljs-variable constant_">GPU</span>) --<span class="hljs-keyword">type</span>=gpu-process --user-data-dir=<span class="hljs-regexp">/Users/</span>pfinal/<span class="hljs-title class_">Library</span>/<span class="hljs-title class_">Application</span> <span class="hljs-title class_">Support</span>/<span class="hljs-title class_">Trae</span> <span class="hljs-variable constant_">CN</span> --gpu-preferences=<span class="hljs-title class_">UAAAAAAAAAAgAAAEAAAAAAAAAAAAAAAAAABgAAEAAAAAAAAAAAAAAAAAAAACAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAEAAAAAAAAAAIAAAAAAAAAAgAAAAAAAAA</span> --shared-files --field-trial-handle=<span class="hljs-number">1718379636</span>,r,<span class="hljs-number">1980764242391010435</span>,<span class="hljs-number">4761999176824767603</span>,<span class="hljs-number">262144</span> --enable-features=<span class="hljs-title class_">DocumentPolicyIncludeJSCallStacksInCrashReports</span>,<span class="hljs-title class_">EarlyEstablishGpuChannel</span>,<span class="hljs-title class_">EstablishGpuChannelAsync</span>,<span class="hljs-title class_">PdfUseShowSaveFilePicker</span>,<span class="hljs-title class_">ScreenCaptureKitPickerScreen</span>,<span class="hljs-title class_">ScreenCaptureKitStreamPickerSonoma</span> --disable-features=<span class="hljs-title class_">CalculateNativeWinOcclusion</span>,<span class="hljs-title class_">FontationsLinuxSystemFonts</span>,<span class="hljs-title class_">MacWebContentsOcclusion</span>,<span class="hljs-title class_">ScreenAIOCREnabled</span>,<span class="hljs-title class_">SpareRendererForSitePerProcess</span>,<span class="hljs-title class_">TimeoutHangingVideoCaptureStarts</span> --variations-seed-version --seatbelt-client=<span class="hljs-number">33</span>

............

========================================
退出码: <span class="hljs-number">0</span>
耗时: <span class="hljs-number">0</span>秒
</code></pre>
<h3 data-id="heading-4">问题又来了</h3>
<p>好了，现在日志是有了，也规整了。但问题是，这玩意儿看起来还是密密麻麻一大片啊！那些超长的命令参数，各种 CPU、内存占用数据，进程状态...看着看着又开始头疼，瞬间没有分析的心情了。</p>
<h3 data-id="heading-5">服务器卡顿？来套组合拳</h3>
<p>说到服务器卡顿，光看进程可不够。遇到服务器响应慢的时候，我一般会用一套组合拳来排查问题。配合前面那个脚本，把这些命令的输出都记录下来，然后统一丢给 AI 分析，简直不要太爽。</p>
<h4 data-id="heading-6">1. 看看资源占用情况</h4>
<p>首先用 <code>top</code> 或者 <code>htop</code> 实时看看资源使用情况，哪个进程在吃CPU，哪个进程在吃内存：</p>
<pre><code class="hljs language-bash" lang="bash">./命令执行监控.sh <span class="hljs-string">"top -b -n 1"</span>
</code></pre>
<p>这个命令会抓取一次快照，不用盯着屏幕刷新。记录下来慢慢看，香！</p>
<h4 data-id="heading-7">2. 看看网络连接</h4>
<p>服务器卡顿，很多时候是网络连接出了问题。用 <code>netstat</code> 或者 <code>ss</code> 看看当前有多少连接：</p>
<pre><code class="hljs language-bash" lang="bash">./命令执行监控.sh <span class="hljs-string">"netstat -antp"</span>
<span class="hljs-comment"># 或者用更现代的 ss 命令</span>
./命令执行监控.sh <span class="hljs-string">"ss -antp"</span>
</code></pre>
<p>看看有没有大量的 <code>TIME_WAIT</code> 或者 <code>CLOSE_WAIT</code> 状态的连接，有时候就是这些玩意儿把服务器拖慢的。</p>
<h4 data-id="heading-8">3. 检查磁盘空间</h4>
<p>磁盘满了也会导致各种奇怪的问题，用 <code>df</code> 看看磁盘使用情况：</p>
<pre><code class="hljs language-bash" lang="bash">./命令执行监控.sh <span class="hljs-string">"df -h"</span>
</code></pre>
<p>如果某个分区已经用了 100%，那八成就是它的锅。</p>
<h4 data-id="heading-9">4. 看看内存使用</h4>
<p>内存不够用的时候，系统就会开始疯狂 swap，卡得不行：</p>
<pre><code class="hljs language-bash" lang="bash">./命令执行监控.sh <span class="hljs-string">"free -m"</span>
</code></pre>
<p>看看 swap 用了多少，如果 swap 用得很高，那就该考虑加内存或者优化程序了。</p>
<h4 data-id="heading-10">5. 检查磁盘 IO</h4>
<p>有时候服务器卡，是因为磁盘 IO 太高。用 <code>iostat</code> 看看：</p>
<pre><code class="hljs language-bash" lang="bash">./命令执行监控.sh <span class="hljs-string">"iostat -x 1 5"</span>
</code></pre>
<p>这会每秒输出一次，连续输出 5 次。看看 <code>%util</code> 这一列，如果接近 100%，磁盘 IO 就是瓶颈了。</p>
<h4 data-id="heading-11">6. 看看哪些文件被打开了</h4>
<p>有时候程序会打开大量文件句柄，用 <code>lsof</code> 可以看看：</p>
<pre><code class="hljs language-bash" lang="bash">./命令执行监控.sh <span class="hljs-string">"lsof -nP | wc -l"</span>
<span class="hljs-comment"># 或者看看某个进程打开了哪些文件</span>
./命令执行监控.sh <span class="hljs-string">"lsof -p [PID]"</span>
</code></pre>
<p>如果打开的文件数量超级多，可能就是文件句柄泄漏了。</p>
<h4 data-id="heading-12">7. 看看系统日志</h4>
<p>系统日志里经常藏着各种线索，用 <code>dmesg</code> 看看内核日志：</p>
<pre><code class="hljs language-bash" lang="bash">./命令执行监控.sh <span class="hljs-string">"dmesg -T | tail -100"</span>
</code></pre>
<p>有时候会看到 OOM（Out of Memory）之类的错误信息，一看就知道问题在哪。</p>
<h4 data-id="heading-13">8. 看看 Web 服务器的错误日志</h4>
<p>如果是 Nginx 或者 Apache，直接看错误日志：</p>
<pre><code class="hljs language-bash" lang="bash">./命令执行监控.sh <span class="hljs-string">"tail -n 200 /var/log/nginx/error.log"</span>
<span class="hljs-comment"># 或者</span>
./命令执行监控.sh <span class="hljs-string">"tail -n 200 /var/log/apache2/error.log"</span>
</code></pre>
<p>日志里的报错信息往往最直接，能快速定位问题。</p>
<h4 data-id="heading-14">9. 看看 TCP 连接统计</h4>
<p>想知道有多少连接处于各种状态，可以用这个：</p>
<pre><code class="hljs language-bash" lang="bash">./命令执行监控.sh <span class="hljs-string">"netstat -an | awk '/^tcp/ {print \$6}' | sort | uniq -c"</span>
</code></pre>
<p>这会统计各种 TCP 连接状态的数量，一目了然。</p>
<h4 data-id="heading-15">10. 看看虚拟内存统计</h4>
<p>用 <code>vmstat</code> 可以看到系统的整体运行状态：</p>
<pre><code class="hljs language-bash" lang="bash">./命令执行监控.sh <span class="hljs-string">"vmstat 1 5"</span>
</code></pre>
<p>这会每秒输出一次，连续输出 5 次。可以看到 CPU、内存、IO 等各方面的统计数据。</p>
<h3 data-id="heading-16">一键收集，批量分析</h3>
<p>有了前面这个脚本，我甚至写了个更狠的，把这些命令一次性全部执行并记录下来：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
timestamp=$(<span class="hljs-built_in">date</span> <span class="hljs-string">"+%Y%m%d_%H%M%S"</span>)
report_dir=<span class="hljs-string">"server_analysis_<span class="hljs-variable">${timestamp}</span>"</span>
<span class="hljs-built_in">mkdir</span> -p <span class="hljs-string">"<span class="hljs-variable">$report_dir</span>"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"开始收集服务器信息..."</span>

<span class="hljs-comment"># 定义监控脚本路径</span>
monitor_script=<span class="hljs-string">"./命令执行监控.sh"</span>

<span class="hljs-comment"># 进程信息</span>
<span class="hljs-variable">$monitor_script</span> <span class="hljs-string">"ps aux --sort=-%cpu | head -20"</span> &gt; /dev/null
<span class="hljs-built_in">mv</span> command_execution_*.<span class="hljs-built_in">log</span> <span class="hljs-string">"<span class="hljs-variable">$report_dir</span>/01_top_cpu_processes.log"</span>

<span class="hljs-comment"># CPU和内存</span>
<span class="hljs-variable">$monitor_script</span> <span class="hljs-string">"top -b -n 1"</span> &gt; /dev/null
<span class="hljs-built_in">mv</span> command_execution_*.<span class="hljs-built_in">log</span> <span class="hljs-string">"<span class="hljs-variable">$report_dir</span>/02_top_snapshot.log"</span>

<span class="hljs-comment"># 网络连接</span>
<span class="hljs-variable">$monitor_script</span> <span class="hljs-string">"ss -antp"</span> &gt; /dev/null
<span class="hljs-built_in">mv</span> command_execution_*.<span class="hljs-built_in">log</span> <span class="hljs-string">"<span class="hljs-variable">$report_dir</span>/03_network_connections.log"</span>

<span class="hljs-comment"># 磁盘使用</span>
<span class="hljs-variable">$monitor_script</span> <span class="hljs-string">"df -h"</span> &gt; /dev/null
<span class="hljs-built_in">mv</span> command_execution_*.<span class="hljs-built_in">log</span> <span class="hljs-string">"<span class="hljs-variable">$report_dir</span>/04_disk_usage.log"</span>

<span class="hljs-comment"># 内存使用</span>
<span class="hljs-variable">$monitor_script</span> <span class="hljs-string">"free -m"</span> &gt; /dev/null
<span class="hljs-built_in">mv</span> command_execution_*.<span class="hljs-built_in">log</span> <span class="hljs-string">"<span class="hljs-variable">$report_dir</span>/05_memory_usage.log"</span>

<span class="hljs-comment"># IO 统计</span>
<span class="hljs-variable">$monitor_script</span> <span class="hljs-string">"iostat -x 1 5"</span> &gt; /dev/null
<span class="hljs-built_in">mv</span> command_execution_*.<span class="hljs-built_in">log</span> <span class="hljs-string">"<span class="hljs-variable">$report_dir</span>/06_io_stats.log"</span>

<span class="hljs-comment"># 系统日志</span>
<span class="hljs-variable">$monitor_script</span> <span class="hljs-string">"dmesg -T | tail -100"</span> &gt; /dev/null
<span class="hljs-built_in">mv</span> command_execution_*.<span class="hljs-built_in">log</span> <span class="hljs-string">"<span class="hljs-variable">$report_dir</span>/07_kernel_logs.log"</span>

<span class="hljs-comment"># TCP 连接统计</span>
<span class="hljs-variable">$monitor_script</span> <span class="hljs-string">"netstat -an | awk '/^tcp/ {print \$6}' | sort | uniq -c"</span> &gt; /dev/null
<span class="hljs-built_in">mv</span> command_execution_*.<span class="hljs-built_in">log</span> <span class="hljs-string">"<span class="hljs-variable">$report_dir</span>/08_tcp_stats.log"</span>

<span class="hljs-comment"># 虚拟内存统计</span>
<span class="hljs-variable">$monitor_script</span> <span class="hljs-string">"vmstat 1 5"</span> &gt; /dev/null
<span class="hljs-built_in">mv</span> command_execution_*.<span class="hljs-built_in">log</span> <span class="hljs-string">"<span class="hljs-variable">$report_dir</span>/09_vmstat.log"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"信息收集完成！所有日志保存在: <span class="hljs-variable">$report_dir</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"现在可以把整个目录打包发给 AI 分析了！"</span>
</code></pre>
<p>执行一次，所有数据全部到手，整整齐齐地放在一个目录里。然后把这个目录打个包，统统丢给 AI，让它帮我综合分析。</p>
<h3 data-id="heading-17">AI 时代的解法</h3>
<p>不过还好，现在是 <strong>AI 时代</strong>！这种时候就该让 AI 大显身手了。我直接把这些日志文件往 <strong>ChatGPT</strong> 或者 <strong>Claude</strong> 里面一丢，让它帮我分析。</p>
<p>结果呢？AI 把这堆东西分析得是头头是道：</p>
<ul>
<li>哪些进程占用资源最多</li>
<li>网络连接是否存在异常</li>
<li>磁盘和内存使用情况如何</li>
<li>IO 是否存在瓶颈</li>
<li>系统日志里有没有关键错误</li>
<li>还能给出针对性的优化建议</li>
</ul>
<p>原本需要一个个命令去看，一个个数据去对比分析的工作，现在变成了喝杯咖啡的功夫就能搞定的事儿。AI 甚至还能告诉你："你的服务器有 327 个 TIME_WAIT 连接，建议调整一下内核参数..."，专业得不行。</p>
<h3 data-id="heading-18">总结</h3>
<p>从最开始看到进程列表就头皮发麻，到现在轻轻松松让 AI 帮忙分析，这个流程可以说是相当舒服了。脚本负责记录，命令负责采集，AI 负责分析，我只需要坐等结果就行。</p>
<p>服务器卡顿不可怕，可怕的是不知道从哪下手。有了这套组合拳，再配合 AI 的分析能力，什么 <strong>进程分析</strong>、<strong>性能瓶颈</strong>、<strong>资源占用</strong> 都不在话下。</p>
<p>这就是工具的力量，这就是 <strong>AI 时代</strong>的便利。再也不用担心服务器上那一大堆进程信息了，香得很！</p>
<hr/>
<blockquote>
<p>代码是我的语言，终端是我的世界。</p>
<p><strong>PFinalClub</strong> · 写于上海某个加班的深夜<br/>
一个用代码偷懒的专业户 | 公众号：PFinalClub<br/>
2025.12.26</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL分库分表，从“一室一厅”到“豪华别墅区”的数据库升级之旅]]></title>    <link>https://juejin.cn/post/7587675443442614312</link>    <guid>https://juejin.cn/post/7587675443442614312</guid>    <pubDate>2025-12-26T04:20:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587675443442614312" data-draft-id="7587671647400230952" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL分库分表，从“一室一厅”到“豪华别墅区”的数据库升级之旅"/> <meta itemprop="keywords" content="后端,Java,MySQL"/> <meta itemprop="datePublished" content="2025-12-26T04:20:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="悟空码字"/> <meta itemprop="url" content="https://juejin.cn/user/3139860942296830"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL分库分表，从“一室一厅”到“豪华别墅区”的数据库升级之旅
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3139860942296830/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    悟空码字
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T04:20:10.000Z" title="Fri Dec 26 2025 04:20:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是小悟。</p>
<h2 data-id="heading-0">一、分库分表是什么？——数据库的“甜蜜烦恼”</h2>
<p>把你的MySQL数据库想象成是个小单身公寓（单库单表）：</p>
<ul>
<li>刚开始住进去时，东西不多，找啥都方便</li>
<li>后来你结婚了（用户量增加），生了娃（数据量暴增），还养了条二哈（业务复杂了）</li>
<li>现在全家挤在小公寓里，每天早上一家人抢厕所（数据库锁竞争），找双袜子要翻遍全家（全表扫描）</li>
<li>邻居天天投诉你家太吵（性能影响其他服务）</li>
</ul>
<p>这时候你需要：
<strong>分库</strong>：买下整栋楼！把不同的家人安排在不同楼层（业务垂直拆分）
<strong>分表</strong>：把每个房间再隔成小隔间！把袜子、内裤、外套分开放（数据水平拆分）</p>
<h2 data-id="heading-1">二、详细实施步骤——从“蜗居”到“豪宅”的装修指南</h2>
<h3 data-id="heading-2">第1步：设计蓝图——想清楚再动手</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 先看看现在的“房子”有多大</span>
<span class="hljs-keyword">SELECT</span> 
    TABLE_SCHEMA <span class="hljs-keyword">as</span> <span class="hljs-string">'数据库'</span>,
    TABLE_NAME <span class="hljs-keyword">as</span> <span class="hljs-string">'表名'</span>,
    ROUND((DATA_LENGTH <span class="hljs-operator">+</span> INDEX_LENGTH) <span class="hljs-operator">/</span> <span class="hljs-number">1024</span> <span class="hljs-operator">/</span> <span class="hljs-number">1024</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">as</span> <span class="hljs-string">'大小(MB)'</span>,
    TABLE_ROWS <span class="hljs-keyword">as</span> <span class="hljs-string">'行数'</span>
<span class="hljs-keyword">FROM</span> information_schema.TABLES 
<span class="hljs-keyword">WHERE</span> TABLE_SCHEMA <span class="hljs-operator">=</span> <span class="hljs-string">'你的数据库名'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> (DATA_LENGTH <span class="hljs-operator">+</span> INDEX_LENGTH) <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- 思考人生三连问：</span>
<span class="hljs-comment">-- 1. 按业务分？(用户相关、订单相关、商品相关)</span>
<span class="hljs-comment">-- 2. 按时间分？(2024订单、2025订单)</span>
<span class="hljs-comment">-- 3. 按地域分？(北京用户、上海用户)</span>
</code></pre>
<h3 data-id="heading-3">第2步：垂直分库——让专业的人住专业的楼层</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 原来都挤在一个库里</span>
<span class="hljs-keyword">CREATE</span> DATABASE single_apartment;

<span class="hljs-comment">-- 现在买栋楼，每层一个专业户</span>
<span class="hljs-keyword">CREATE</span> DATABASE user_villa;      <span class="hljs-comment">-- 用户专属楼层</span>
<span class="hljs-keyword">CREATE</span> DATABASE order_mansion;   <span class="hljs-comment">-- 订单豪华层</span>
<span class="hljs-keyword">CREATE</span> DATABASE product_tower;   <span class="hljs-comment">-- 商品展示层</span>

<span class="hljs-comment">-- 用户表搬到用户楼层</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_villa.user_info (
    user_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),
    created_at <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
    <span class="hljs-comment">-- 用户相关的其他字段...</span>
);

<span class="hljs-comment">-- 订单表搬到订单楼层  </span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> order_mansion.order_info (
    order_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    user_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>),
    status TINYINT,
    created_at <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
    <span class="hljs-comment">-- 订单相关的其他字段...</span>
);
</code></pre>
<h3 data-id="heading-4">第3步：水平分表——每个房间都装上帝视角衣柜</h3>
<p><strong>方法一：按范围分表（适合时间序列）</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 订单表按月份拆分，再也不怕找去年的订单像考古了</span>
<span class="hljs-comment">-- 2024年订单表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> order_mansion.order_202401 (
    order_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    user_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    <span class="hljs-comment">-- ... 其他字段</span>
    created_at <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at)
) <span class="hljs-keyword">PARTITION</span> <span class="hljs-keyword">BY</span> <span class="hljs-keyword">RANGE</span> (<span class="hljs-keyword">MONTH</span>(created_at)) (
    <span class="hljs-keyword">PARTITION</span> p1 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-number">2</span>),
    <span class="hljs-keyword">PARTITION</span> p2 <span class="hljs-keyword">VALUES</span> LESS THAN (<span class="hljs-number">3</span>),
    <span class="hljs-comment">-- ... 更多分区</span>
);

<span class="hljs-comment">-- 2024年2月订单表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> order_mansion.order_202402 (
    <span class="hljs-comment">-- 结构同上</span>
);
</code></pre>
<p><strong>方法二：按哈希分表（均匀分布）</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 用户表按ID取模分表，16张表够不够？</span>
<span class="hljs-comment">-- 先创建用户表模板</span>
DELIMITER $$

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">PROCEDURE</span> create_user_tables()
<span class="hljs-keyword">BEGIN</span>
    <span class="hljs-keyword">DECLARE</span> i <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>;
    WHILE i <span class="hljs-operator">&lt;</span> <span class="hljs-number">16</span> DO
        <span class="hljs-keyword">SET</span> <span class="hljs-variable">@table</span>_name <span class="hljs-operator">=</span> CONCAT(<span class="hljs-string">'user_villa.user_info_'</span>, LPAD(i, <span class="hljs-number">2</span>, <span class="hljs-string">'0'</span>));
        <span class="hljs-keyword">SET</span> <span class="hljs-variable">@sql</span> <span class="hljs-operator">=</span> CONCAT(<span class="hljs-string">'
            CREATE TABLE IF NOT EXISTS '</span>, <span class="hljs-variable">@table</span>_name, <span class="hljs-string">' (
                user_id BIGINT PRIMARY KEY AUTO_INCREMENT,
                username VARCHAR(50) NOT NULL,
                email VARCHAR(100),
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                INDEX idx_username (username)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4
        '</span>);
        <span class="hljs-keyword">PREPARE</span> stmt <span class="hljs-keyword">FROM</span> <span class="hljs-variable">@sql</span>;
        <span class="hljs-keyword">EXECUTE</span> stmt;
        <span class="hljs-keyword">DEALLOCATE</span> <span class="hljs-keyword">PREPARE</span> stmt;
        <span class="hljs-keyword">SET</span> i <span class="hljs-operator">=</span> i <span class="hljs-operator">+</span> <span class="hljs-number">1</span>;
    <span class="hljs-keyword">END</span> WHILE;
<span class="hljs-keyword">END</span>$$

DELIMITER ;

<span class="hljs-comment">-- 执行创建</span>
<span class="hljs-keyword">CALL</span> create_user_tables();
</code></pre>
<h3 data-id="heading-5">第4步：路由策略——给每个数据配个“导航系统”</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Java代码示例：数据路由导航</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ShardingNavigator</span> {
    
    <span class="hljs-comment">// 用户表路由：根据user_id决定去哪个表</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getUserTableName</span>(<span class="hljs-params">long userId</span>) {
        int tableIndex = (int) (userId % <span class="hljs-number">16</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">String</span>.<span class="hljs-title function_">format</span>(<span class="hljs-string">"user_info_%02d"</span>, tableIndex);
    }
    
    <span class="hljs-comment">// 订单表路由：根据时间决定去哪个表</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-title class_">String</span> <span class="hljs-title function_">getOrderTableName</span>(<span class="hljs-params"><span class="hljs-built_in">Date</span> orderTime</span>) {
        <span class="hljs-title class_">SimpleDateFormat</span> sdf = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">"yyyyMM"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"order_"</span> + sdf.<span class="hljs-title function_">format</span>(orderTime);
    }
    
    <span class="hljs-comment">// 组合查询：跨表查询就像组织家庭聚会</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">Order</span>&gt; <span class="hljs-title function_">getUserOrders</span>(<span class="hljs-params">long userId, <span class="hljs-built_in">Date</span> startTime, <span class="hljs-built_in">Date</span> endTime</span>) {
        <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">Order</span>&gt; allOrders = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-title class_">Calendar</span> calendar = <span class="hljs-title class_">Calendar</span>.<span class="hljs-title function_">getInstance</span>();
        calendar.<span class="hljs-title function_">setTime</span>(startTime);
        
        <span class="hljs-comment">// 遍历时间范围内的所有月份表</span>
        <span class="hljs-keyword">while</span> (calendar.<span class="hljs-title function_">getTime</span>().<span class="hljs-title function_">before</span>(endTime)) {
            <span class="hljs-title class_">String</span> tableName = <span class="hljs-title function_">getOrderTableName</span>(calendar.<span class="hljs-title function_">getTime</span>());
            <span class="hljs-title class_">String</span> sql = <span class="hljs-string">"SELECT * FROM "</span> + tableName + <span class="hljs-string">" WHERE user_id = ?"</span>;
            <span class="hljs-comment">// 执行查询并添加到结果集</span>
            <span class="hljs-comment">// ...</span>
            calendar.<span class="hljs-title function_">add</span>(<span class="hljs-title class_">Calendar</span>.<span class="hljs-property">MONTH</span>, <span class="hljs-number">1</span>);
        }
        <span class="hljs-keyword">return</span> allOrders;
    }
}
</code></pre>
<h3 data-id="heading-6">第5步：中间件配置——请个“万能管家”</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># ShardingSphere配置文件示例（YAML格式）</span>
<span class="hljs-comment"># 这位管家知道所有房间在哪</span>
<span class="hljs-attr">dataSources:</span>
  <span class="hljs-attr">ds0:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/user_villa?useSSL=false</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">your_password</span>
  <span class="hljs-attr">ds1:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3307/order_mansion?useSSL=false</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">your_password</span>

<span class="hljs-attr">shardingRule:</span>
  <span class="hljs-attr">tables:</span>
    <span class="hljs-attr">user_info:</span>
      <span class="hljs-attr">actualDataNodes:</span> <span class="hljs-string">ds0.user_info_${0..15}</span>
      <span class="hljs-attr">tableStrategy:</span>
        <span class="hljs-attr">inline:</span>
          <span class="hljs-attr">shardingColumn:</span> <span class="hljs-string">user_id</span>
          <span class="hljs-attr">algorithmExpression:</span> <span class="hljs-string">user_info_${user_id</span> <span class="hljs-string">%</span> <span class="hljs-number">16</span><span class="hljs-string">}</span>
    <span class="hljs-attr">order_info:</span>
      <span class="hljs-attr">actualDataNodes:</span> <span class="hljs-string">ds1.order_${2024..2025}${1..12}</span>
      <span class="hljs-attr">tableStrategy:</span>
        <span class="hljs-attr">standard:</span>
          <span class="hljs-attr">shardingColumn:</span> <span class="hljs-string">created_at</span>
          <span class="hljs-attr">preciseAlgorithmClassName:</span> <span class="hljs-string">com.example.TimeShardingAlgorithm</span>
  
  <span class="hljs-attr">bindingTables:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">user_info,order_info</span>
</code></pre>
<h3 data-id="heading-7">第6步：数据迁移——搬家不能丢东西</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 第一步：先抄家（备份）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> order_mansion.order_202401_new <span class="hljs-keyword">LIKE</span> order_mansion.order_202401;

<span class="hljs-comment">-- 第二步：慢慢搬（增量迁移）</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> order_mansion.order_202401_new
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> single_apartment.orders 
<span class="hljs-keyword">WHERE</span> created_at <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'2024-01-01'</span> 
  <span class="hljs-keyword">AND</span> created_at <span class="hljs-operator">&lt;</span> <span class="hljs-string">'2024-02-01'</span>;

<span class="hljs-comment">-- 第三步：检查有没有落下的</span>
<span class="hljs-keyword">SELECT</span> 
    (<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> single_apartment.orders 
     <span class="hljs-keyword">WHERE</span> created_at <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'2024-01-01'</span> <span class="hljs-keyword">AND</span> created_at <span class="hljs-operator">&lt;</span> <span class="hljs-string">'2024-02-01'</span>) <span class="hljs-keyword">as</span> old_count,
    (<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> order_mansion.order_202401_new) <span class="hljs-keyword">as</span> new_count;

<span class="hljs-comment">-- 第四步：切换门牌号（重命名）</span>
RENAME <span class="hljs-keyword">TABLE</span> 
    order_mansion.order_202401 <span class="hljs-keyword">TO</span> order_mansion.order_202401_backup,
    order_mansion.order_202401_new <span class="hljs-keyword">TO</span> order_mansion.order_202401;
</code></pre>
<h3 data-id="heading-8">第7步：全局ID生成——给每个数据发身份证</h3>
<pre><code class="hljs language-ini" lang="ini">// 雪花算法：Twitter出品，必属精品
public class SnowflakeIdGenerator {
    private final long <span class="hljs-attr">twepoch</span> = <span class="hljs-number">1288834974657</span>L<span class="hljs-comment">;</span>
    private final long <span class="hljs-attr">workerIdBits</span> = <span class="hljs-number">5</span>L<span class="hljs-comment">;</span>
    private final long <span class="hljs-attr">datacenterIdBits</span> = <span class="hljs-number">5</span>L<span class="hljs-comment">;</span>
    private final long <span class="hljs-attr">sequenceBits</span> = <span class="hljs-number">12</span>L<span class="hljs-comment">;</span>
    
    private long workerId<span class="hljs-comment">;</span>
    private long datacenterId<span class="hljs-comment">;</span>
    private long <span class="hljs-attr">sequence</span> = <span class="hljs-number">0</span>L<span class="hljs-comment">;</span>
    private long <span class="hljs-attr">lastTimestamp</span> = -<span class="hljs-number">1</span>L<span class="hljs-comment">;</span>
    
    public synchronized long nextId() {
        long <span class="hljs-attr">timestamp</span> = timeGen()<span class="hljs-comment">;</span>
        
        if (timestamp &lt; lastTimestamp) {
            throw new RuntimeException("时间倒流了，检查系统时间！")<span class="hljs-comment">;</span>
        }
        
        if (<span class="hljs-attr">lastTimestamp</span> == timestamp) {
            <span class="hljs-attr">sequence</span> = (sequence + <span class="hljs-number">1</span>) &amp; <span class="hljs-number">4095</span><span class="hljs-comment">;  // 2^12-1</span>
            if (<span class="hljs-attr">sequence</span> == <span class="hljs-number">0</span>) {
                <span class="hljs-attr">timestamp</span> = tilNextMillis(lastTimestamp)<span class="hljs-comment">;</span>
            }
        } else {
            <span class="hljs-attr">sequence</span> = <span class="hljs-number">0</span>L<span class="hljs-comment">;</span>
        }
        
        <span class="hljs-attr">lastTimestamp</span> = timestamp<span class="hljs-comment">;</span>
        
        return ((timestamp - twepoch) &lt;&lt; 22) |
               (datacenterId &lt;&lt; 17) |
               (workerId &lt;&lt; 12) |
               sequence<span class="hljs-comment">;</span>
    }
    
    // 全局唯一，趋势递增，适合分库分表
}
</code></pre>
<h2 data-id="heading-9">三、注意事项——别墅区的物业管理条例</h2>
<ol>
<li>
<p><strong>分布式事务</strong>：楼上转账，楼下扣款，必须同时成功或失败</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 使用Seata等分布式事务解决方案</span>
<span class="hljs-meta">@GlobalTransactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transferMoney</span><span class="hljs-params">(<span class="hljs-type">long</span> fromUser, <span class="hljs-type">long</span> toUser, BigDecimal amount)</span> {
    <span class="hljs-comment">// 1. 从用户库扣款</span>
    <span class="hljs-comment">// 2. 向订单库插入记录</span>
    <span class="hljs-comment">// 要么都成功，要么都回滚</span>
}
</code></pre>
</li>
<li>
<p><strong>跨表查询</strong>：想找张三的所有订单？得问遍所有表！</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 分表前：一步到位</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">123</span>;

<span class="hljs-comment">-- 分表后：变成侦查行动</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> order_202401 <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">123</span>
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> order_202402 <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">123</span>
<span class="hljs-keyword">UNION</span> <span class="hljs-keyword">ALL</span>
<span class="hljs-comment">-- ... 查遍所有月份表</span>
</code></pre>
</li>
<li>
<p><strong>JOIN操作</strong>：用户表和订单表在不同库？只能业务层JOIN</p>
<pre><code class="hljs language-ini" lang="ini">// 1. 先从用户库查用户
List&lt;User&gt; <span class="hljs-attr">users</span> = userDao.getUsers(condition)<span class="hljs-comment">;</span>
List&lt;Long&gt; <span class="hljs-attr">userIds</span> = users.stream().map(User::getId).collect(Collectors.toList())<span class="hljs-comment">;</span>

// 2. 再去订单库查这些用户的订单
List&lt;Order&gt; <span class="hljs-attr">orders</span> = orderDao.getOrdersByUserIds(userIds)<span class="hljs-comment">;</span>

// 3. 在内存中组装
Map&lt;Long, List&lt;Order&gt;&gt; <span class="hljs-attr">userOrdersMap</span> = groupOrdersByUser(orders)<span class="hljs-comment">;</span>
</code></pre>
</li>
</ol>
<h2 data-id="heading-10">四、总结</h2>
<p>分库分表就像数据库的成人礼，意味着你的业务从“小打小闹”变成了“正经事业”。但是：</p>
<p><strong>不要过早优化</strong>：如果你的数据还没到百万级别，别急着分表，就像不能因为将来可能变胖，现在就买XXL号裤子。</p>
<p><strong>选择合适的策略</strong>：按时间分？按地域分？按业务分？这就像选择衣柜整理方式，有人喜欢按季节，有人喜欢按颜色，适合的才是最好的。</p>
<p><strong>准备好工具</strong>：中间件（ShardingSphere、MyCat）是你的瑞士军刀，监控工具（Prometheus、Grafana）是你的健康检测仪。</p>
<p><strong>接受不完美</strong>：分库分表后，事务复杂了，查询麻烦了，运维困难了。但这就是成长的代价，就像长大后发现世界不是非黑即白。</p>
<p><strong>最后提醒</strong>：分库分表前，先试试这些“减肥方法”：</p>
<ol>
<li>加索引（给东西贴标签）</li>
<li>优化SQL（整理收纳技巧）</li>
<li>升级硬件（换个大房子）</li>
<li>读写分离（男女分开用厕所）</li>
</ol>
<p>只有当这些都不够用时，才考虑分库分表这个大工程。记住，好的架构是演进而来的，不是设计出来的。就像好的婚姻，需要慢慢磨合，不能一开始就分房睡（分库）还分床（分表）！</p>
<p>祝你的数据库从“小公寓”顺利升级到“豪华别墅区”，住得宽敞，查得飞快！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/337ccddaab4549c58f9029e21f3842de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5oKf56m656CB5a2X:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767327610&amp;x-signature=%2BUflMKZc4wfB%2BdvzYPBXozMTJA4%3D" alt="MySQL分库分表，从“一室一厅”到“豪华别墅区”的数据库升级之旅.png" loading="lazy"/></p>
<p><strong>谢谢你看我的文章，既然看到这里了，如果觉得不错，随手点个赞、转发、在看三连吧，感谢感谢。那我们，下次再见。</strong></p>
<p>您的一键三连，是我更新的最大动力，谢谢</p>
<p>山水有相逢，来日皆可期，谢谢阅读，我们再会</p>
<p>我手中的金箍棒，上能通天，下能探海</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[python的__init__.py]]></title>    <link>https://juejin.cn/post/7587709130531094537</link>    <guid>https://juejin.cn/post/7587709130531094537</guid>    <pubDate>2025-12-26T04:18:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587709130531094537" data-draft-id="7587779957674803251" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="python的__init__.py"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2025-12-26T04:18:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Warson_L"/> <meta itemprop="url" content="https://juejin.cn/user/2568875732117304"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            python的__init__.py
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2568875732117304/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Warson_L
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T04:18:49.000Z" title="Fri Dec 26 2025 04:18:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>即使是空的 <code>__init__.py</code>，它依然有两个核心作用，对于你（特别是做工程化开发）非常重要。</p>
<hr/>
<h3 data-id="heading-0">1. 把它变成“常规包” (Regular Package)</h3>
<p>如果你不加 <code>__init__.py</code>，Python 3 会把这个目录当作 <strong>Namespace Package（命名空间包）</strong>。</p>
<ul>
<li><strong>Namespace Package</strong> 是个高级特性，允许一个包分布在硬盘的多个不同目录下（比如 <code>plugin/</code> 文件夹一部分在 C 盘，一部分在 D 盘）。</li>
<li>对于我们这种普通的项目，你需要的是 <strong>Regular Package</strong>。加上 <code>__init__.py</code>，Python 扫描 import 时效率更高，而且行为更符合直觉。</li>
</ul>
<h3 data-id="heading-1">2. 控制 <code>from package import *</code> 的行为 (重点)</h3>
<p>这是 <code>__init__.py</code> 最实用的功能：<strong>对外暴露接口</strong>。</p>
<p>假设你的目录结构是这样：</p>
<pre><code class="hljs language-text" lang="text">strategies/
├── __init__.py
├── rsi_strategy.py   &lt;-- 里面有个 class RSIStrategy
└── ma_strategy.py    &lt;-- 里面有个 class MAStrategy
</code></pre>
<h4 data-id="heading-2">如果 <code>__init__.py</code> 是空的：</h4>
<p>你想在 <code>main.py</code> 里用这两个策略，你得写得很长：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> strategies.rsi_strategy <span class="hljs-keyword">import</span> RSIStrategy
<span class="hljs-keyword">from</span> strategies.ma_strategy <span class="hljs-keyword">import</span> MAStrategy
</code></pre>
<p><em>(如果文件名很长，这会写得很烦)</em></p>
<h4 data-id="heading-3">如果你在 <code>__init__.py</code> 里写了东西：</h4>
<p>你可以在 <code>strategies/__init__.py</code> 里写：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># strategies/__init__.py</span>
<span class="hljs-keyword">from</span> .rsi_strategy <span class="hljs-keyword">import</span> RSIStrategy
<span class="hljs-keyword">from</span> .ma_strategy <span class="hljs-keyword">import</span> MAStrategy
</code></pre>
<p><strong>现在，你在 <code>main.py</code> 里就可以这样写了：</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 变得非常简洁！</span>
<span class="hljs-keyword">from</span> strategies <span class="hljs-keyword">import</span> RSIStrategy, MAStrategy
</code></pre>
<p>这就是所谓的 <strong>“提升命名空间”</strong>。你把深层文件里的类，提到了包的顶层，让使用者（也就是你自己）调用起来更爽。</p>
<h3 data-id="heading-4">总结</h3>
<p>虽然 Python 3 不强制要求，但<strong>请务必保留 <code>__init__.py</code></strong>，哪怕是空的。
因为它标志着：“这是一个完整的、独立的 Python 源代码包”，这对于代码规范和 IDE 的智能提示都非常重要。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[若依审批流-转交]]></title>    <link>https://juejin.cn/post/7588022226739085362</link>    <guid>https://juejin.cn/post/7588022226739085362</guid>    <pubDate>2025-12-26T05:37:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588022226739085362" data-draft-id="7587779957675114547" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="若依审批流-转交"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-26T05:37:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码次位面"/> <meta itemprop="url" content="https://juejin.cn/user/1535333867720295"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            若依审批流-转交
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1535333867720295/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码次位面
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T05:37:44.000Z" title="Fri Dec 26 2025 05:37:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">转交</h2>
<p>在审批流中，转交（也称转审或转办）是指当前审批人将本应自己处理的任务，直接转移给另一人处理，并且此后该任务将完全由接手人负责，不再返回给原审批人。
<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ruoyiflow.com" target="_blank" title="https://www.ruoyiflow.com" ref="nofollow noopener noreferrer">若依工作流</a></p>
<h3 data-id="heading-1">委派和转交</h3>
<pre><code class="hljs language-text" lang="text">转交: ​彻底交接：“这件事现在完全由你负责了。”
委派: 寻求帮助：“请帮我看一下，但最终决定还是由我来做。”

简单来说，转交是“换人”，而委派/加签是“请人帮忙”。
</code></pre>
<h3 data-id="heading-2">需求描述</h3>
<blockquote>
<p>假设现在有一个请假流程， 用户提交申请数据， 审批人将任务直接转交给另外一个人处理， 跟自己没关系了！</p>
</blockquote>
<pre><code class="hljs language-text" lang="text">测试账号信息:
账号: ry
密码: ry2025

账号: ruo
密码: ry123456

账号: yi
密码: ry123456

</code></pre>
<h3 data-id="heading-3">流程建模</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3ce6fe7f3c244ad815aa2db9006319e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5qyh5L2N6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767332263&amp;x-signature=3gzMtG1ZiS%2FpOIe5uk3S87T5%2BJw%3D" alt="l2.png" loading="lazy"/></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">bpmn:definitions</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="hljs-attr">xmlns:bpmn</span>=<span class="hljs-string">"http://www.omg.org/spec/BPMN/20100524/MODEL"</span> <span class="hljs-attr">xmlns:bpmndi</span>=<span class="hljs-string">"http://www.omg.org/spec/BPMN/20100524/DI"</span> <span class="hljs-attr">xmlns:dc</span>=<span class="hljs-string">"http://www.omg.org/spec/DD/20100524/DC"</span> <span class="hljs-attr">xmlns:camunda</span>=<span class="hljs-string">"http://camunda.org/schema/1.0/bpmn"</span> <span class="hljs-attr">xmlns:di</span>=<span class="hljs-string">"http://www.omg.org/spec/DD/20100524/DI"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Definitions_1"</span> <span class="hljs-attr">targetNamespace</span>=<span class="hljs-string">"http://bpmn.io/schema/bpmn"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:process</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Process_9729"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"请假流程"</span> <span class="hljs-attr">isExecutable</span>=<span class="hljs-string">"true"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:startEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Event_0ucy4xc"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:outgoing</span>&gt;</span>Flow_1fgnagb<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:outgoing</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:startEvent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Flow_1fgnagb"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"Event_0ucy4xc"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"Activity_04kx462"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Activity_04kx462"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"请假申请"</span> <span class="hljs-attr">camunda:assignee</span>=<span class="hljs-string">"${startUser}"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:extensionElements</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">camunda:formData</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">camunda:formField</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"type"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"请假类型"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"string"</span> /&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">camunda:formField</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"reason"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"请假理由"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"string"</span> /&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">camunda:formField</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"days"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"请假天数"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"long"</span> <span class="hljs-attr">defaultValue</span>=<span class="hljs-string">""</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">camunda:formData</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:extensionElements</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:incoming</span>&gt;</span>Flow_1fgnagb<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:incoming</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:outgoing</span>&gt;</span>Flow_0nrxozi<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:outgoing</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:userTask</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Flow_0nrxozi"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"Activity_04kx462"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"Activity_0qetwmj"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Activity_0qetwmj"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"直属领导审批"</span> <span class="hljs-attr">camunda:assignee</span>=<span class="hljs-string">"${candidate}"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:extensionElements</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">camunda:formData</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">camunda:formField</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"userComment"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"评论"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"string"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">camunda:formData</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:extensionElements</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:incoming</span>&gt;</span>Flow_0nrxozi<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:incoming</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:outgoing</span>&gt;</span>Flow_0bpj5l6<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:outgoing</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:userTask</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Flow_0bpj5l6"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"Activity_0qetwmj"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"Gateway_07216c1"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:exclusiveGateway</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Gateway_07216c1"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:incoming</span>&gt;</span>Flow_0bpj5l6<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:incoming</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:outgoing</span>&gt;</span>Flow_0uf4uhb<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:outgoing</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:outgoing</span>&gt;</span>Flow_1jmp8ly<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:outgoing</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:exclusiveGateway</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:endEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Event_0lhm65y"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:incoming</span>&gt;</span>Flow_0uf4uhb<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:incoming</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:endEvent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Flow_0uf4uhb"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"审批通过"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"Gateway_07216c1"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"Event_0lhm65y"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:conditionExpression</span> <span class="hljs-attr">xsi:type</span>=<span class="hljs-string">"bpmn:tFormalExpression"</span>&gt;</span>${approved == true}<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:conditionExpression</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:sequenceFlow</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:endEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Event_0xmax1y"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:incoming</span>&gt;</span>Flow_1jmp8ly<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:incoming</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:endEvent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Flow_1jmp8ly"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"审批拒绝"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"Gateway_07216c1"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"Event_0xmax1y"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:conditionExpression</span> <span class="hljs-attr">xsi:type</span>=<span class="hljs-string">"bpmn:tFormalExpression"</span>&gt;</span>${approved==false}<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:conditionExpression</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:sequenceFlow</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:process</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:definitions</span>&gt;</span>
</code></pre>
<h3 data-id="heading-4">演示效果</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a47ef376e67c4c4696122a66f70165d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5qyh5L2N6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767332263&amp;x-signature=WUn65bO1L3BpkbSR5%2BzrY7e1q6A%3D" alt="leave1" loading="lazy"/></p>
<blockquote>
<p>使用若依(ry)账号登陆系统，发起一个请假申请， 备注，测试转交， 并将管理员作为审批人</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/873af152ee42436e83ce0095d4f6fe48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5qyh5L2N6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767332263&amp;x-signature=0MLDTLTlDujIAucO0qgKrhcRTfA%3D" alt="leave1" loading="lazy"/></p>
<blockquote>
<p>使用管理员(admin)账号登陆系统，在待办任务，找到记录并转交给，小依</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4324ba1e51f148f4aad7d5d90e9f3387~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5qyh5L2N6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767332263&amp;x-signature=tLDDiI77OrWLp083YUzaatBS4tM%3D" alt="leave1" loading="lazy"/></p>
<blockquote>
<p>使用小依(yi)账号登陆系统，在待办任务， 找到记录直接处理，</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f2a86f9a4354a4ea6c84858f8751292~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5qyh5L2N6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767332263&amp;x-signature=gEhsDHDsKbc4JJm7EJxlCcio5qw%3D" alt="leave1" loading="lazy"/></p>
<blockquote>
<p>使用小依(yi)账号登陆系统，在已办任务， 此时可以在已办任务看到审批时间线</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[百度地图MapVThree Editor：地图编辑]]></title>    <link>https://juejin.cn/post/7587714124857212982</link>    <guid>https://juejin.cn/post/7587714124857212982</guid>    <pubDate>2025-12-26T02:58:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587714124857212982" data-draft-id="7587720490930126884" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="百度地图MapVThree Editor：地图编辑"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-26T02:58:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户95208161179"/> <meta itemprop="url" content="https://juejin.cn/user/4232440491287450"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            百度地图MapVThree Editor：地图编辑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4232440491287450/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户95208161179
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T02:58:45.000Z" title="Fri Dec 26 2025 02:58:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>MapVThree Editor类 是一个功能强大超好用的地图编辑工具，让你用几行代码就能实现专业的地图绘制和编辑功能！</p>
<h2 data-id="heading-0">🤔 为什么要聊这个？</h2>
<p>最近在做地图相关的项目时，总会遇到这样的需求：需要让用户在地图上画点什么，比如标记区域、规划路线、添加标注点等等。传统的做法可能需要写一大堆代码，处理各种鼠标事件、坐标转换、图形渲染...想想就头疼对不对？</p>
<p>今天想跟大家聊聊 MapVThree Editor 这个好东西。它把复杂的地图编辑功能都封装好了，你只需要调用几个简单的 API，就能实现专业级的地图编辑体验。是不是听起来就很棒？✨</p>
<h2 data-id="heading-1">📖 快速上手：从零开始</h2>
<h3 data-id="heading-2">第一步：初始化编辑器</h3>
<p>首先，咱们得有个地图引擎，然后把 Editor 添加进去：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 创建地图引擎</span>
<span class="hljs-keyword">const</span> engine = <span class="hljs-keyword">new</span> mapvthree.<span class="hljs-title class_">Engine</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'map-container'</span>), {
    <span class="hljs-attr">rendering</span>: {
        <span class="hljs-attr">enableAnimationLoop</span>: <span class="hljs-literal">true</span>,
    },
    <span class="hljs-attr">map</span>: {
        <span class="hljs-attr">projection</span>: <span class="hljs-string">'ecef'</span>,
    },
});

<span class="hljs-comment">// 添加 Editor - 就这么简单！</span>
<span class="hljs-keyword">const</span> editor = engine.<span class="hljs-title function_">add</span>(<span class="hljs-keyword">new</span> mapvthree.<span class="hljs-title class_">Editor</span>({
    <span class="hljs-attr">type</span>: mapvthree.<span class="hljs-property">Editor</span>.<span class="hljs-property">DrawerType</span>.<span class="hljs-property">POLYGON</span>,  <span class="hljs-comment">// 默认画多边形</span>
    <span class="hljs-attr">enableMidpointHandles</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 启用中点标记，方便在边上加顶点</span>
}));
</code></pre>
<p>看到了吗？就这么几行代码，你的编辑器就准备好啦！🎉</p>
<h3 data-id="heading-3">第二步：开始绘制</h3>
<p>想画点什么？选个类型，调用 <code>start()</code> 就行：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 设置要画的图形类型</span>
editor.<span class="hljs-property">type</span> = mapvthree.<span class="hljs-property">Editor</span>.<span class="hljs-property">DrawerType</span>.<span class="hljs-property">POLYGON</span>;

<span class="hljs-comment">// 可以先设置样式</span>
editor.<span class="hljs-title function_">setStyle</span>({
    <span class="hljs-attr">fillColor</span>: <span class="hljs-string">'#ff0000'</span>,      <span class="hljs-comment">// 填充颜色</span>
    <span class="hljs-attr">fillOpacity</span>: <span class="hljs-number">0.5</span>,          <span class="hljs-comment">// 填充透明度</span>
    <span class="hljs-attr">strokeColor</span>: <span class="hljs-string">'#ffffff'</span>,    <span class="hljs-comment">// 边框颜色</span>
    <span class="hljs-attr">strokeWidth</span>: <span class="hljs-number">2</span>,            <span class="hljs-comment">// 边框宽度</span>
});

<span class="hljs-comment">// 开始绘制！</span>
editor.<span class="hljs-title function_">start</span>();
</code></pre>
<p>用户现在就可以在地图上画多边形了！是不是超简单？</p>
<h3 data-id="heading-4">第三步：监听事件</h3>
<p>绘制完成后你肯定想知道吧？监听个事件就好：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 监听创建事件</span>
editor.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'created'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'用户画好啦！'</span>);
    <span class="hljs-comment">// 可以在这里获取绘制的数据</span>
    <span class="hljs-keyword">const</span> geoJSON = editor.<span class="hljs-title function_">exportData</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'绘制的数据：'</span>, geoJSON);
});
</code></pre>
<p>有意思吧？现在你已经掌握了基础用法～</p>
<h2 data-id="heading-5">🎨 支持哪些图形类型？</h2>
<p>MapVThree Editor 支持 5 种常用的几何图形，基本上能满足日常所有需求了：</p>
<h3 data-id="heading-6">1️⃣ 多边形 (Polygon)</h3>
<pre><code class="hljs language-js" lang="js">editor.<span class="hljs-property">type</span> = mapvthree.<span class="hljs-property">Editor</span>.<span class="hljs-property">DrawerType</span>.<span class="hljs-property">POLYGON</span>;
editor.<span class="hljs-title function_">start</span>();
</code></pre>
<p>适合标记区域、划分范围等场景。</p>
<h3 data-id="heading-7">2️⃣ 折线 (Line)</h3>
<pre><code class="hljs language-js" lang="js">editor.<span class="hljs-property">type</span> = mapvthree.<span class="hljs-property">Editor</span>.<span class="hljs-property">DrawerType</span>.<span class="hljs-property">LINE</span>;
editor.<span class="hljs-title function_">start</span>();
</code></pre>
<p>适合规划路线、标记轨迹等场景。</p>
<h3 data-id="heading-8">3️⃣ 点 (Point)</h3>
<pre><code class="hljs language-js" lang="js">editor.<span class="hljs-property">type</span> = mapvthree.<span class="hljs-property">Editor</span>.<span class="hljs-property">DrawerType</span>.<span class="hljs-property">POINT</span>;
editor.<span class="hljs-title function_">start</span>();
</code></pre>
<p>适合添加标记点、地标等场景。</p>
<h3 data-id="heading-9">4️⃣ 圆形 (Circle)</h3>
<pre><code class="hljs language-js" lang="js">editor.<span class="hljs-property">type</span> = mapvthree.<span class="hljs-property">Editor</span>.<span class="hljs-property">DrawerType</span>.<span class="hljs-property">CIRCLE</span>;
editor.<span class="hljs-title function_">start</span>();
</code></pre>
<p>适合标记范围、缓冲区分析等场景。</p>
<h3 data-id="heading-10">5️⃣ 矩形 (Rectangle)</h3>
<pre><code class="hljs language-js" lang="js">editor.<span class="hljs-property">type</span> = mapvthree.<span class="hljs-property">Editor</span>.<span class="hljs-property">DrawerType</span>.<span class="hljs-property">RECTANGLE</span>;
editor.<span class="hljs-title function_">start</span>();
</code></pre>
<p>适合框选区域、快速绘制矩形范围等场景。</p>
<p>看，想画啥就画啥，切换类型就是改一行代码的事儿！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a05b71dff1c04b489b9dce82a1c4c417~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3OTUyMDgxNjExNzk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767322724&amp;x-signature=gNqkBv8xFRFAO5VsdIbCkIRWW58%3D" alt="draw" loading="lazy"/></p>
<h2 data-id="heading-11">✏️ 编辑已有图形</h2>
<p>画完之后想改？没问题！Editor 提供了强大的编辑功能。</p>
<h3 data-id="heading-12">进入编辑模式</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 点击要素时自动进入编辑模式</span>
editor.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'featureClick'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> featureId = e.<span class="hljs-property">featureId</span>;
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'点击了要素：'</span>, featureId);

    <span class="hljs-comment">// 开启编辑</span>
    editor.<span class="hljs-title function_">enableEdit</span>(featureId);
});

<span class="hljs-comment">// 也可以手动指定要编辑的要素</span>
editor.<span class="hljs-title function_">enableEdit</span>(<span class="hljs-string">'your-feature-id'</span>);

<span class="hljs-comment">// 退出编辑模式</span>
editor.<span class="hljs-title function_">disableEdit</span>();
</code></pre>
<p>进入编辑模式后，用户就可以：</p>
<ul>
<li>拖动顶点改变形状</li>
<li>在边上添加新的顶点（如果启用了 <code>enableMidpointHandles</code>）</li>
<li>整体移动图形</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/086b11329eb94cc49b490d047ca40054~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3OTUyMDgxNjExNzk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767322724&amp;x-signature=SnbvprK0vxKhWhzAfuv7KiNHltk%3D" alt="edit" loading="lazy"/></p>
<h3 data-id="heading-13">删除图形</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 删除指定 ID 的要素</span>
<span class="hljs-keyword">const</span> deletedCount = editor.<span class="hljs-title function_">deleteById</span>(<span class="hljs-string">'feature-id-123'</span>);

<span class="hljs-keyword">if</span> (deletedCount &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'删除成功！'</span>);
}

<span class="hljs-comment">// 清空所有要素</span>
editor.<span class="hljs-title function_">delete</span>();
</code></pre>
<p>简单来说就是：想编辑就 <code>enableEdit()</code>，想删除就 <code>deleteById()</code>，用大白话讲就是 API 设计得很直观！</p>
<h2 data-id="heading-14">🎭 样式自定义</h2>
<p>让图形变得更好看？当然可以！</p>
<h3 data-id="heading-15">设置默认样式</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 设置绘制时的默认样式</span>
editor.<span class="hljs-title function_">setStyle</span>({
    <span class="hljs-attr">fillColor</span>: <span class="hljs-string">'#ff0000'</span>,      <span class="hljs-comment">// 填充色</span>
    <span class="hljs-attr">fillOpacity</span>: <span class="hljs-number">0.5</span>,          <span class="hljs-comment">// 填充透明度</span>
    <span class="hljs-attr">strokeColor</span>: <span class="hljs-string">'#ffffff'</span>,    <span class="hljs-comment">// 边框色</span>
    <span class="hljs-attr">strokeWidth</span>: <span class="hljs-number">2</span>,            <span class="hljs-comment">// 边框宽度</span>
});
</code></pre>
<h3 data-id="heading-16">修改单个要素的样式</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 给特定要素换个颜色</span>
editor.<span class="hljs-title function_">updateFeatureStyle</span>(<span class="hljs-string">'feature-id-123'</span>, {
    <span class="hljs-attr">fillColor</span>: <span class="hljs-string">'#00ff00'</span>,
    <span class="hljs-attr">fillOpacity</span>: <span class="hljs-number">0.8</span>,
    <span class="hljs-attr">strokeColor</span>: <span class="hljs-string">'#000000'</span>,
    <span class="hljs-attr">strokeWidth</span>: <span class="hljs-number">3</span>,
});
</code></pre>
<p>你看，想让哪个图形变成什么样，直接改就行，实时生效！</p>
<h2 data-id="heading-17">🔄 连续绘制模式</h2>
<p>有时候需要一次性画好几个图形，一个个点按钮太麻烦？试试连续绘制模式！</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 开启连续绘制</span>
editor.<span class="hljs-title function_">start</span>({
    <span class="hljs-attr">continuous</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 关键参数</span>
});
</code></pre>
<p>开启后，用户画完一个图形，会自动开始下一个，直到手动调用 <code>editor.stop()</code> 才停止。超方便有没有！</p>
<h2 data-id="heading-18">🎯 单要素模式</h2>
<p>有些场景下，同一时刻只需要一个要素（比如选择一个区域）。这时候可以用单要素模式：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> editor = <span class="hljs-keyword">new</span> mapvthree.<span class="hljs-title class_">Editor</span>({
    <span class="hljs-attr">type</span>: mapvthree.<span class="hljs-property">Editor</span>.<span class="hljs-property">DrawerType</span>.<span class="hljs-property">POLYGON</span>,
    <span class="hljs-attr">singleMode</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 启用单要素模式</span>
});
</code></pre>
<p>启用后，每次绘制新图形时，会自动清除之前的图形。简单粗暴，正合适某些场景！</p>
<h2 data-id="heading-19">📦 数据导入导出</h2>
<h3 data-id="heading-20">导出数据</h3>
<p>把用户画的内容导出为 GeoJSON 格式：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 导出所有数据</span>
<span class="hljs-keyword">const</span> allData = editor.<span class="hljs-title function_">exportData</span>();

<span class="hljs-comment">// 只导出多边形</span>
<span class="hljs-keyword">const</span> polygons = editor.<span class="hljs-title function_">exportData</span>(mapvthree.<span class="hljs-property">Editor</span>.<span class="hljs-property">DrawerType</span>.<span class="hljs-property">POLYGON</span>);

<span class="hljs-comment">// 只导出线</span>
<span class="hljs-keyword">const</span> lines = editor.<span class="hljs-title function_">exportData</span>(mapvthree.<span class="hljs-property">Editor</span>.<span class="hljs-property">DrawerType</span>.<span class="hljs-property">LINE</span>);
</code></pre>
<p>数据格式是标准的 GeoJSON，可以直接保存到数据库或传给后端～</p>
<h3 data-id="heading-21">导入数据</h3>
<p>有现成的数据？直接导入就能显示和编辑：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> geoJSONData = {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'FeatureCollection'</span>,
    <span class="hljs-attr">features</span>: [
        {
            <span class="hljs-attr">type</span>: <span class="hljs-string">'Feature'</span>,
            <span class="hljs-attr">id</span>: <span class="hljs-string">'polygon-1'</span>,
            <span class="hljs-attr">geometry</span>: {
                <span class="hljs-attr">type</span>: <span class="hljs-string">'Polygon'</span>,
                <span class="hljs-attr">coordinates</span>: [<span class="hljs-comment">/* 坐标数组 */</span>],
            },
            <span class="hljs-attr">properties</span>: {
                <span class="hljs-attr">name</span>: <span class="hljs-string">'测试多边形'</span>,
                <span class="hljs-attr">color</span>: <span class="hljs-string">'#ff0000'</span>,
            },
        },
        <span class="hljs-comment">// 更多要素...</span>
    ],
};

<span class="hljs-comment">// 导入数据（会清除现有数据）</span>
editor.importData(geoJSONData, { <span class="hljs-attr">clear</span>: <span class="hljs-literal">true</span> });

<span class="hljs-comment">// 追加数据（不清除现有数据）</span>
editor.importData(geoJSONData, { <span class="hljs-attr">clear</span>: <span class="hljs-literal">false</span> });
</code></pre>
<p>这样就能快速加载历史数据，让用户继续编辑了。是不是很贴心？</p>
<h2 data-id="heading-22">🎧 完整的事件系统</h2>
<p>Editor 提供了一套完整的事件监听机制，让你能精确掌控用户的每个操作：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 创建要素时触发</span>
editor.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'created'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'新要素创建完成'</span>);
});

<span class="hljs-comment">// 删除要素时触发</span>
editor.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'delete'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'要素已删除'</span>);
});

<span class="hljs-comment">// 编辑要素时触发</span>
editor.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'update'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'要素已更新'</span>);
});

<span class="hljs-comment">// 点击要素时触发</span>
editor.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'featureClick'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'点击了要素：'</span>, e.<span class="hljs-property">featureId</span>);
});
</code></pre>
<p>有了这些事件，你可以在合适的时机做数据保存、状态同步等操作。</p>
<h2 data-id="heading-23">🎁 核心要点</h2>
<p>让我用总结一下：</p>
<ol>
<li><strong>初始化超简单</strong>：<code>new Editor()</code> + <code>engine.add()</code> 就搞定</li>
<li><strong>支持 5 种图形</strong>：多边形、线、点、圆、矩形，够用了</li>
<li><strong>绘制就俩步</strong>：设置 <code>type</code> + 调用 <code>start()</code></li>
<li><strong>编辑很直观</strong>：<code>enableEdit()</code> 开始编辑，<code>disableEdit()</code> 退出</li>
<li><strong>样式随心改</strong>：<code>setStyle()</code> 全局设置，<code>updateFeatureStyle()</code> 单独调整</li>
<li><strong>连续绘制</strong>：加个 <code>continuous: true</code> 参数，画个不停</li>
<li><strong>单要素模式</strong>：<code>singleMode: true</code>，画新的自动删旧的</li>
<li><strong>数据互通</strong>：<code>exportData()</code> 导出，<code>importData()</code> 导入，标准 GeoJSON 格式</li>
<li><strong>事件丰富</strong>：created、delete、update、featureClick，想监听啥监听啥</li>
</ol>
<p>基本上就能应对大部分地图编辑需求了！</p>
<p>想想看，在你的项目中，有哪些场景可以用上这个编辑器？</p>
<p>如果你觉得这篇文章对你有帮助，别忘了点个赞哦！有什么问题也可以随时问我 💪</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🎉Spring Boot 3 + 多数据源 + Druid：监控页面 + 控制台 SQL 日志，终于搞定啦！]]></title>    <link>https://juejin.cn/post/7587715742051500042</link>    <guid>https://juejin.cn/post/7587715742051500042</guid>    <pubDate>2025-12-26T04:55:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587715742051500042" data-draft-id="7587704265055109158" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🎉Spring Boot 3 + 多数据源 + Druid：监控页面 + 控制台 SQL 日志，终于搞定啦！"/> <meta itemprop="keywords" content="Spring Boot,微服务,Java"/> <meta itemprop="datePublished" content="2025-12-26T04:55:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户352180245475"/> <meta itemprop="url" content="https://juejin.cn/user/156576846710315"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🎉Spring Boot 3 + 多数据源 + Druid：监控页面 + 控制台 SQL 日志，终于搞定啦！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/156576846710315/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户352180245475
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T04:55:21.000Z" title="Fri Dec 26 2025 04:55:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>用 <strong>Spring Boot 3.x + dynamic-datasource + Druid</strong> 的时候，最让人抓狂的就是：</p>
<ul>
<li>监控页面一访问就 “No static resource druid.” 😱</li>
<li>控制台死活不打印 SQL，只有出错才冒泡 🤬</li>
<li>配置改了半天，还是不生效...</li>
</ul>
<p>经过无数次重启、翻源码、看 Issue，我终于整出一套<strong>超级稳定</strong>的方案！监控页面美美哒，多数据源切换顺滑，控制台 SQL 日志带参数打印（正常+出错都行）。</p>
<p>来来来，直接上干货～轻松复制粘贴，就能跑起来！</p>
<h2 data-id="heading-0">先加依赖，别多加！</h2>
<p>XML</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 多数据源神器 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
	    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>dynamic-datasource-spring-boot3-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span> <span class="hljs-comment">&lt;!-- 多数据源 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.3.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>  <span class="hljs-comment">&lt;!-- 最新版最香 --&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Druid 的 Spring Boot 3 专用 starter --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
		<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid-spring-boot-3-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.27<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">exclusions</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">exclusion</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">exclusion</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">exclusions</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 强制核心 druid 为 1.2.27 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>druid<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.2.27<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<p>一般只加这一个 Druid starter 就够啦！但是使用的是最新的1.2.27的包，<code>druid-spring-boot-3-starter</code>依赖的是<code>1.2.9</code>，所以需要强制添加核心，是否依赖正确的包，可以通过<code>maven help</code>来排查冲突：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d6c07eea4254d53bc281bfad6601e4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MzUyMTgwMjQ1NDc1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767329785&amp;x-signature=h97XCbP%2BFHdUosIxBJiz4YI6pec%3D" alt="image-20251226105139566" loading="lazy"/></p>
<h2 data-id="heading-1">排除原生自动配置（超级重要！不然各种冲突）</h2>
<p>在 application.yml 里加：</p>
<p>YAML</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">autoconfigure:</span>
    <span class="hljs-attr">exclude:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">com.alibaba.druid.spring.boot.autoconfigure.DruidDataSourceAutoConfigure</span>
</code></pre>
<p>或者直接在启动类上怼注解：</p>
<p>Java</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@SpringBootApplication(<span class="hljs-params">exclude = com.alibaba.druid.spring.boot.autoconfigure.DruidDataSourceAutoConfigure.<span class="hljs-keyword">class</span></span>)</span>
</code></pre>
<h2 data-id="heading-2">yml 配置（连接池 + Filter）</h2>
<p>YAML</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">dynamic:</span>
      <span class="hljs-attr">primary:</span> <span class="hljs-string">master</span>
      <span class="hljs-attr">druid:</span>
        <span class="hljs-attr">initial-size:</span> <span class="hljs-number">5</span>
        <span class="hljs-attr">min-idle:</span> <span class="hljs-number">10</span>
        <span class="hljs-attr">max-active:</span> <span class="hljs-number">20</span>
        <span class="hljs-attr">max-wait:</span> <span class="hljs-number">60000</span>
        <span class="hljs-comment"># 其他连接池参数随便调～</span>

        <span class="hljs-attr">filters:</span> <span class="hljs-string">stat,wall,slf4j</span>  <span class="hljs-comment"># stat 监控，wall 防注入，slf4j 打印日志</span>

        <span class="hljs-attr">filter:</span>
          <span class="hljs-attr">slf4j:</span>
            <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
            <span class="hljs-attr">statement-executable-sql-log-enable:</span> <span class="hljs-literal">true</span>   <span class="hljs-comment"># 带参数美化 SQL</span>
            <span class="hljs-attr">statement-log-enabled:</span> <span class="hljs-literal">false</span>                <span class="hljs-comment"># 关掉原始 ? 日志，别重复</span>
            <span class="hljs-attr">result-set-log-enabled:</span> <span class="hljs-literal">false</span>

      <span class="hljs-attr">datasource:</span>
        <span class="hljs-attr">master:</span>
          <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/db1?xxx</span>
          <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
          <span class="hljs-attr">password:</span> <span class="hljs-string">root</span>
          <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>
        <span class="hljs-attr">slave:</span>
          <span class="hljs-comment"># 同上...</span>
</code></pre>
<h2 data-id="heading-3">手动注册监控页面（最稳！自动配置容易翻车）</h2>
<p><code>1.2.27</code>并没有默认开始监控页面，需要我们自己配置，新建一个配置类 DruidMonitorConfig.java：</p>
<p>Java</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.alibaba.druid.support.jakarta.StatViewServlet;
<span class="hljs-keyword">import</span> com.alibaba.druid.support.jakarta.WebStatFilter;
<span class="hljs-keyword">import</span> org.springframework.boot.web.servlet.FilterRegistrationBean;
<span class="hljs-keyword">import</span> org.springframework.boot.web.servlet.ServletRegistrationBean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Bean;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.ResourceHandlerRegistry;
<span class="hljs-keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

<span class="hljs-keyword">import</span> java.util.HashMap;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DruidMonitorConfig</span> {

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> ServletRegistrationBean&lt;StatViewServlet&gt; <span class="hljs-title function_">statViewServlet</span><span class="hljs-params">()</span> {
        ServletRegistrationBean&lt;StatViewServlet&gt; bean = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServletRegistrationBean</span>&lt;&gt;();
        bean.setServlet(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StatViewServlet</span>());
        bean.addUrlMappings(<span class="hljs-string">"/druid/*"</span>);

        <span class="hljs-type">var</span> <span class="hljs-variable">params</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, String&gt;();
        params.put(<span class="hljs-string">"loginUsername"</span>, <span class="hljs-string">"admin"</span>);
        params.put(<span class="hljs-string">"loginPassword"</span>, <span class="hljs-string">"123456"</span>);
        params.put(<span class="hljs-string">"allow"</span>, <span class="hljs-string">""</span>);
        params.put(<span class="hljs-string">"resetEnable"</span>, <span class="hljs-string">"false"</span>);
        bean.setInitParameters(params);
        <span class="hljs-keyword">return</span> bean;
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> FilterRegistrationBean&lt;WebStatFilter&gt; <span class="hljs-title function_">webStatFilter</span><span class="hljs-params">()</span> {
        FilterRegistrationBean&lt;WebStatFilter&gt; bean = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FilterRegistrationBean</span>&lt;&gt;();
        bean.setFilter(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WebStatFilter</span>());
        bean.addUrlPatterns(<span class="hljs-string">"/*"</span>);

        <span class="hljs-type">var</span> <span class="hljs-variable">params</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, String&gt;();
        params.put(<span class="hljs-string">"exclusions"</span>, <span class="hljs-string">"*.js,*.gif,*.jpg,*.png,*.css,*.ico,/druid/*"</span>);
        bean.setInitParameters(params);
        <span class="hljs-keyword">return</span> bean;
    }

    <span class="hljs-comment">// 静态资源，别忘了！</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> WebMvcConfigurer <span class="hljs-title function_">druidResources</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WebMvcConfigurer</span>() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addResourceHandlers</span><span class="hljs-params">(ResourceHandlerRegistry registry)</span> {
                registry.addResourceHandler(<span class="hljs-string">"/druid/**"</span>)
                        .addResourceLocations(<span class="hljs-string">"classpath:/support/http/resources/"</span>);
            }
        };
    }
}
</code></pre>
<p>其中资源的路径跟很多网站与ai说的都不一样，正确的是：<code>/support/http/resources/</code></p>
<h2 data-id="heading-4">logback 让日志蹦出来</h2>
<p>XML，重要也简单，网上很多配置都出错，这是通过调试源码找到的配置。甚至很多ai也都给出错误的配置：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f8970d8925d46baa5c8999a55a8aac6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MzUyMTgwMjQ1NDc1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767329785&amp;x-signature=2clZ3vYUZ227mdjaN2kCF%2FFvugo%3D" alt="image-20251226104517723" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32a14cc0d9064df2b0645439c650160a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MzUyMTgwMjQ1NDc1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767329785&amp;x-signature=jEP3wMi3TFy0XfLDCuNuNMXbUwk%3D" alt="image-20251226104538690" loading="lazy"/></p>
<p>正确的打开方式如下：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;logger <span class="hljs-attr">name</span>=<span class="hljs-string">"druid.sql.Statement"</span> level=<span class="hljs-string">"DEBUG"</span>/&gt;
</code></pre>
<h2 data-id="heading-5">效果图（文字版哈哈）</h2>
<p>控制台正常 SQL：</p>
<p>text</p>
<pre><code class="hljs language-sql" lang="sql">DEBUG com.alibaba.druid.filter.logging.Slf4jLogFilter <span class="hljs-operator">-</span> executable <span class="hljs-keyword">sql</span>: 
<span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> ? <span class="hljs-keyword">and</span> age <span class="hljs-operator">&gt;</span> ?
<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> Parameters: <span class="hljs-number">1</span>(Long), <span class="hljs-number">18</span>(<span class="hljs-type">Integer</span>)
<span class="hljs-operator">=</span><span class="hljs-operator">=</span><span class="hljs-operator">&gt;</span> Total: <span class="hljs-number">3</span>
</code></pre>
<p>出错 SQL 也会强制打印～</p>
<p>监控页面：访问 /druid/，admin/123456 登录，就能看到 master/slave 切换、SQL 统计、慢查询，爽！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5d9b8558b8b44249aed70cb89c7a7a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MzUyMTgwMjQ1NDc1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767329785&amp;x-signature=2XN9JnK2qRq0kIAAAAWn9rYdUww%3D" alt="image-20251226114419745" loading="lazy"/></p>
<p><strong>SQL统计</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6689f0c8d1d4174bfa2e5dfd4323b42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3MzUyMTgwMjQ1NDc1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767329785&amp;x-signature=i6p%2FM%2BIRwKtILFjOYCZB%2F39h3Dg%3D" alt="image-20251226114853742" loading="lazy"/></p>
<p><strong>注意：这个版本的重置功能失效！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iframe 导致 Vue Router go(-1) 无法正常返回问题解决方案]]></title>    <link>https://juejin.cn/post/7587713001715040310</link>    <guid>https://juejin.cn/post/7587713001715040310</guid>    <pubDate>2025-12-26T03:34:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587713001715040310" data-draft-id="7587630831465496618" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iframe 导致 Vue Router go(-1) 无法正常返回问题解决方案"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-26T03:34:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mr_fang71940"/> <meta itemprop="url" content="https://juejin.cn/user/360295545716958"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iframe 导致 Vue Router go(-1) 无法正常返回问题解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/360295545716958/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mr_fang71940
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T03:34:26.000Z" title="Fri Dec 26 2025 03:34:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">📋 目录</h2>
<ol>
<li><a href="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF" title="#%E9%97%AE%E9%A2%98%E8%83%8C%E6%99%AF">问题背景</a></li>
<li><a href="#%E9%97%AE%E9%A2%98%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90" title="#%E9%97%AE%E9%A2%98%E5%8E%9F%E5%9B%A0%E5%88%86%E6%9E%90">问题原因分析</a></li>
<li><a href="#%E9%97%AE%E9%A2%98%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B" title="#%E9%97%AE%E9%A2%98%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B">问题代码示例</a></li>
<li><a href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" title="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">解决方案</a></li>
<li><a href="#%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94" title="#%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94">方案对比</a></li>
<li><a href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5" title="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">最佳实践</a></li>
<li><a href="#%E7%9B%B8%E5%85%B3%E8%B5%84%E6%BA%90" title="#%E7%9B%B8%E5%85%B3%E8%B5%84%E6%BA%90">相关资源</a></li>
</ol>
<hr/>
<h2 data-id="heading-1">问题背景</h2>
<p>在 Vue.js 应用中使用 <code>this.$router.go(-1)</code> 进行页面返回时，如果页面内部包含 iframe，会导致返回功能异常。用户点击返回按钮后，可能无法返回到预期的上一页，而是停留在当前页面或返回到 iframe 内部的某个状态。</p>
<h3 data-id="heading-2">问题场景</h3>
<ul>
<li><strong>典型场景</strong>: 页面中包含 iframe 组件（如第三方服务嵌入、文件预览、数据选择器等）</li>
<li><strong>问题表现</strong>: 点击返回按钮或操作成功后自动返回时，无法正常返回到上一页</li>
<li><strong>影响范围</strong>: 所有包含 iframe 且使用 <code>go(-1)</code> 进行返回的页面</li>
</ul>
<hr/>
<h2 data-id="heading-3">快速开始</h2>
<h3 data-id="heading-4">快速复现问题</h3>
<ol>
<li><strong>复制代码</strong>：将下面的完整代码示例复制到你的 Vue 项目中</li>
<li><strong>创建文件</strong>（根据项目结构调整路径）：
<ul>
<li><code>src/views/List.vue</code> - 列表页</li>
<li><code>src/views/Detail.vue</code> - 详情页（问题版本）</li>
<li><code>src/views/DetailFixed.vue</code> - 详情页（解决方案版本）</li>
<li><code>public/iframe-test.html</code> - iframe 测试页面（可选，用于测试）</li>
</ul>
</li>
<li><strong>配置路由</strong>：在 <code>router/index.js</code> 中添加路由配置（路径可根据项目调整）</li>
<li><strong>运行项目</strong>：启动开发服务器，访问配置的列表页路径（如 <code>/list</code>）</li>
<li><strong>测试对比</strong>：
<ul>
<li>选择"问题版本"，点击项目进入详情页，打开 iframe 并导航，然后点击返回</li>
<li>选择"解决方案版本"，重复相同操作，观察差异</li>
</ul>
</li>
</ol>
<h3 data-id="heading-5">文件结构</h3>
<pre><code class="hljs language-csharp" lang="csharp">project/
├── router/
│   └── index.js          <span class="hljs-meta"># 路由配置</span>
├── src/
│   └── views/
│       ├── List.vue          <span class="hljs-meta"># 列表页（包含版本选择）</span>
│       ├── Detail.vue        <span class="hljs-meta"># 详情页（问题版本）</span>
│       └── DetailFixed.vue   <span class="hljs-meta"># 详情页（解决方案版本）</span>
└── <span class="hljs-keyword">public</span>/
    └── iframe-test.html  <span class="hljs-meta"># iframe 测试页面（可选）</span>
</code></pre>
<p><strong>注意</strong>：以上路径为示例路径，实际使用时请根据项目结构调整路由路径和组件路径。</p>
<hr/>
<h2 data-id="heading-6">问题原因分析</h2>
<h3 data-id="heading-7">1. 浏览器历史记录机制</h3>
<p>浏览器维护一个历史记录栈（History Stack），每次页面导航都会在栈中添加一条记录：</p>
<pre><code class="hljs language-css" lang="css">历史记录栈示例：
<span class="hljs-selector-attr">[页面A]</span> -&gt; <span class="hljs-selector-attr">[页面B]</span> -&gt; <span class="hljs-selector-attr">[页面C（包含iframe）]</span> -&gt; <span class="hljs-selector-attr">[iframe内部导航1]</span> -&gt; <span class="hljs-selector-attr">[iframe内部导航2]</span>
</code></pre>
<h3 data-id="heading-8">2. iframe 对历史记录的影响</h3>
<p>当页面中包含 iframe 时，iframe 内部的导航操作会<strong>影响父页面的浏览器历史记录</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 正常情况下的历史记录</span>
[列表页] -&gt; [详情页]

<span class="hljs-comment">// 包含 iframe 后的历史记录</span>
[列表页] -&gt; [详情页] -&gt; [iframe内部页面<span class="hljs-number">1</span>] -&gt; [iframe内部页面<span class="hljs-number">2</span>] -&gt; ...
</code></pre>
<h3 data-id="heading-9">3. router.go(-1) 的工作原理</h3>
<p><code>this.$router.go(-1)</code> 是基于浏览器历史记录栈进行回退的：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 当调用 go(-1) 时</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">go</span>(-<span class="hljs-number">1</span>);  <span class="hljs-comment">// 回退到历史记录栈中的上一个条目</span>

<span class="hljs-comment">// 如果历史记录栈是：</span>
<span class="hljs-comment">// [列表页] -&gt; [详情页] -&gt; [iframe页1] -&gt; [iframe页2]</span>
<span class="hljs-comment">// 那么 go(-1) 会返回到 [iframe页2]，而不是 [列表页]</span>
</code></pre>
<h3 data-id="heading-10">4. 问题根源总结</h3>





















<table><thead><tr><th>原因</th><th>说明</th></tr></thead><tbody><tr><td><strong>iframe 导航污染历史记录</strong></td><td>iframe 内部的每次导航都会在父页面历史记录中添加条目</td></tr><tr><td><strong>go(-1) 依赖历史记录栈</strong></td><td>无法区分哪些是 iframe 产生的历史记录</td></tr><tr><td><strong>无法精确控制返回目标</strong></td><td>不知道需要回退多少步才能到达真正的上一页</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-11">问题代码示例</h2>
<h3 data-id="heading-12">完整可运行示例</h3>
<p>以下是一个完整的可运行示例，可以直接复制到项目中测试问题。</p>
<h4 data-id="heading-13">1. 路由配置 (router/index.js)</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Vue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">VueRouter</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>
<span class="hljs-title class_">Vue</span>.<span class="hljs-title function_">use</span>(<span class="hljs-title class_">VueRouter</span>)

<span class="hljs-keyword">const</span> routes = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/'</span>,
    <span class="hljs-attr">redirect</span>: <span class="hljs-string">'/list'</span>
  },
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/list'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'List'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/views/List.vue'</span>),
    <span class="hljs-attr">meta</span>: { <span class="hljs-attr">title</span>: <span class="hljs-string">'列表页'</span> }
  },
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/detail'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'Detail'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/views/Detail.vue'</span>),
    <span class="hljs-attr">meta</span>: { <span class="hljs-attr">title</span>: <span class="hljs-string">'详情页（问题版本）'</span> }
  },
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/detail-fixed'</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">'DetailFixed'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'@/views/DetailFixed.vue'</span>),
    <span class="hljs-attr">meta</span>: { <span class="hljs-attr">title</span>: <span class="hljs-string">'详情页（解决方案版本）'</span> }
  }
]

<span class="hljs-keyword">const</span> router = <span class="hljs-keyword">new</span> <span class="hljs-title class_">VueRouter</span>({
  <span class="hljs-attr">mode</span>: <span class="hljs-string">'history'</span>,
  routes
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> router
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li><code>/list</code> - 列表页，可以选择测试版本</li>
<li><code>/detail</code> - 问题版本，使用 <code>go(-1)</code> 返回</li>
<li><code>/detail-fixed</code> - 解决方案版本，使用明确的路由路径返回</li>
</ul>
<h4 data-id="heading-14">2. 列表页组件 (views/List.vue) - 完整版本</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="list-page"&gt;
    &lt;h1&gt;列表页&lt;/h1&gt;
    
    &lt;div class="version-selector"&gt;
      &lt;h3&gt;选择测试版本：&lt;/h3&gt;
      &lt;div class="version-buttons"&gt;
        &lt;button 
          @click="testVersion = 'problem'" 
          :class="{ active: testVersion === 'problem' }"
          class="version-btn problem"
        &gt;
          ❌ 问题版本
        &lt;/button&gt;
        &lt;button 
          @click="testVersion = 'fixed'" 
          :class="{ active: testVersion === 'fixed' }"
          class="version-btn fixed"
        &gt;
          ✅ 解决方案版本
        &lt;/button&gt;
      &lt;/div&gt;
      &lt;p class="version-hint"&gt;
        &lt;span v-if="testVersion === 'problem'"&gt;
          当前选择：问题版本 - 使用 go(-1) 返回，会受 iframe 影响
        &lt;/span&gt;
        &lt;span v-else&gt;
          当前选择：解决方案版本 - 使用明确路由路径返回，不受 iframe 影响
        &lt;/span&gt;
      &lt;/p&gt;
    &lt;/div&gt;
    
    &lt;div class="item-list"&gt;
      &lt;h3&gt;项目列表：&lt;/h3&gt;
      &lt;div 
        v-for="item in items" 
        :key="item.id" 
        class="item"
        @click="goToDetail(item.id)"
      &gt;
        &lt;span&gt;项目 {{ item.id }}: {{ item.name }}&lt;/span&gt;
        &lt;span class="item-hint"&gt;点击进入详情页&lt;/span&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    
    &lt;div class="info" :class="testVersion"&gt;
      &lt;h3&gt;测试说明：&lt;/h3&gt;
      &lt;p&gt;&lt;strong&gt;当前历史记录长度:&lt;/strong&gt; {{ historyLength }}&lt;/p&gt;
      &lt;p&gt;&lt;strong&gt;操作步骤：&lt;/strong&gt;&lt;/p&gt;
      &lt;ol&gt;
        &lt;li&gt;选择上方测试版本（问题版本 / 解决方案版本）&lt;/li&gt;
        &lt;li&gt;点击项目进入对应的详情页&lt;/li&gt;
        &lt;li&gt;在详情页打开 iframe 弹窗&lt;/li&gt;
        &lt;li&gt;在 iframe 内多次点击链接导航（观察历史记录变化）&lt;/li&gt;
        &lt;li&gt;点击返回按钮，观察是否能正常返回&lt;/li&gt;
      &lt;/ol&gt;
      &lt;div v-if="testVersion === 'problem'" class="warning"&gt;
        &lt;strong&gt;⚠️ 问题版本：&lt;/strong&gt;在 iframe 内导航后，返回按钮可能无法正常返回到列表页
      &lt;/div&gt;
      &lt;div v-else class="success"&gt;
        &lt;strong&gt;✅ 解决方案版本：&lt;/strong&gt;无论 iframe 内如何导航，返回按钮都能正常返回到列表页
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  name: 'List',
  data() {
    return {
      items: [
        { id: 1, name: '测试项目1' },
        { id: 2, name: '测试项目2' },
        { id: 3, name: '测试项目3' }
      ],
      historyLength: 0,
      testVersion: 'problem'  // 'problem' 或 'fixed'
    }
  },
  mounted() {
    console.log('List mounted')
    this.updateHistoryLength()
    // 监听历史记录变化
    window.addEventListener('popstate', this.updateHistoryLength)
    // 定期更新历史记录长度显示（因为 iframe 导航不会触发 popstate）
    this.historyInterval = setInterval(() =&gt; {
      this.updateHistoryLength()
    }, 500)
  },
  beforeDestroy() {
    window.removeEventListener('popstate', this.updateHistoryLength)
    if (this.historyInterval) {
      clearInterval(this.historyInterval)
    }
  },
  methods: {
    goToDetail(id) {
      if (this.testVersion === 'problem') {
        // ❌ 问题版本：不传递来源信息
        this.$router.push({
          path: '/detail',
          query: { id }
        })
      } else {
        // ✅ 解决方案版本：传递来源信息
        this.$router.push({
          path: '/detail-fixed',
          query: {
            from: this.$route.fullPath,
            id: id
          }
        })
      }
    },
    updateHistoryLength() {
      const newLength = window.history.length
      if (newLength !== this.historyLength) {
        console.log('List - 历史记录长度变化:', this.historyLength, '-&gt;', newLength)
      }
      this.historyLength = newLength
    }
  }
}
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-15">3. 详情页组件 (views/Detail.vue) - 问题版本</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="detail-page"&gt;
    &lt;div class="header"&gt;
      &lt;button @click="handleGoBack" class="back-btn"&gt;← 返回&lt;/button&gt;
      &lt;h1&gt;详情页 - 项目 {{ $route.query.id }}&lt;/h1&gt;
    &lt;/div&gt;
    &lt;div class="content"&gt;
      &lt;p&gt;这是详情页内容&lt;/p&gt;
      &lt;div class="iframe-section"&gt;
        &lt;button @click="openIframeDialog" class="open-btn"&gt;
          打开 iframe 选择器
        &lt;/button&gt;
        &lt;div v-if="dialogVisible" class="dialog-overlay" @click="closeDialog"&gt;
          &lt;div class="dialog-content" @click.stop&gt;
            &lt;div class="dialog-header"&gt;
              &lt;h3&gt;iframe 选择器&lt;/h3&gt;
              &lt;button @click="closeDialog" class="close-btn"&gt;×&lt;/button&gt;
            &lt;/div&gt;
            &lt;div class="dialog-body"&gt;
              &lt;iframe
                :src="iframeUrl"
                @load="onIframeLoad"
                ref="iframeRef"
                class="iframe"
              &gt;&lt;/iframe&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;div class="info-panel"&gt;
        &lt;h3&gt;调试信息&lt;/h3&gt;
        &lt;p&gt;当前历史记录长度: {{ historyLength }}&lt;/p&gt;
        &lt;p&gt;初始历史记录长度: {{ initialHistoryLength }}&lt;/p&gt;
        &lt;p&gt;iframe 产生的历史记录数: {{ iframeHistoryCount }}&lt;/p&gt;
        &lt;p&gt;当前路由: {{ $route.fullPath }}&lt;/p&gt;
      &lt;/div&gt;
      &lt;div class="action-section"&gt;
        &lt;button @click="handleSubmit" class="submit-btn"&gt;保存并返回&lt;/button&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  name: 'Detail',
  data() {
    return {
      dialogVisible: false,
      // 使用一个可以导航的测试页面作为 iframe
      // 这个页面会在内部进行导航，从而产生历史记录
      iframeUrl: '/iframe-test.html',
      historyLength: 0,
      initialHistoryLength: 0
    }
  },
  computed: {
    iframeHistoryCount() {
      return this.historyLength - this.initialHistoryLength
    }
  },
  mounted() {
    this.initialHistoryLength = window.history.length
    console.log('Detail mounted, 初始历史记录长度:', this.initialHistoryLength)
    this.updateHistoryLength()
    // 监听历史记录变化
    window.addEventListener('popstate', this.updateHistoryLength)
    // 定期更新历史记录长度显示（因为 iframe 导航不会触发 popstate）
    this.historyInterval = setInterval(() =&gt; {
      this.updateHistoryLength()
    }, 500)
  },
  beforeDestroy() {
    window.removeEventListener('popstate', this.updateHistoryLength)
    if (this.historyInterval) {
      clearInterval(this.historyInterval)
    }
  },
  methods: {
    // ❌ 问题代码：使用 go(-1) 返回
    handleGoBack() {
      console.log('点击返回，当前历史记录长度:', window.history.length)
      console.log('初始历史记录长度:', this.initialHistoryLength)
      console.log('iframe 产生的历史记录数:', this.iframeHistoryCount)
      this.$router.go(-1)
    },
    
    openIframeDialog() {
      this.dialogVisible = true
    },
    
    closeDialog() {
      this.dialogVisible = false
    },
    
    onIframeLoad() {
      console.log('iframe 加载完成')
      this.updateHistoryLength()
    },
    
    updateHistoryLength() {
      const newLength = window.history.length
      if (newLength !== this.historyLength) {
        console.log('历史记录长度变化:', this.historyLength, '-&gt;', newLength)
      }
      this.historyLength = newLength
    },
    async handleSubmit() {
      // 模拟保存操作
      console.log('保存数据...')
      await new Promise(resolve =&gt; setTimeout(resolve, 500))
      // ❌ 问题代码：保存成功后使用 go(-1) 返回
      console.log('保存成功，准备返回')
      this.$router.go(-1)
    }
  }
}
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-16">4. iframe 测试页面 (public/iframe-test.html)</h4>
<p>创建一个可以导航的测试页面，用于模拟 iframe 内部的导航：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>iframe 测试页面<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>iframe 测试页面<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
  
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-links"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#page1"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-link"</span>&gt;</span>页面 1<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#page2"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-link"</span>&gt;</span>页面 2<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#page3"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-link"</span>&gt;</span>页面 3<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onclick</span>=<span class="hljs-string">"navigateToPage4()"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"nav-link"</span>&gt;</span>页面 4 (JS导航)<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"content"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>页面 1<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是 iframe 测试页面的初始内容。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>点击上方的链接可以导航到不同的页面。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>每次导航都会在浏览器历史记录中添加一条记录。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"info"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">strong</span>&gt;</span>提示：<span class="hljs-tag">&lt;/<span class="hljs-name">strong</span>&gt;</span>每次点击链接都会产生新的历史记录。<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前 URL: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"currentUrl"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>历史记录数量: <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"historyCount"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// 更新当前 URL 显示</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">updateDisplay</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'currentUrl'</span>).<span class="hljs-property">textContent</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>;
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'historyCount'</span>).<span class="hljs-property">textContent</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-property">length</span>;
    }
    <span class="hljs-comment">// 页面内容</span>
    <span class="hljs-keyword">const</span> pages = {
      <span class="hljs-string">'#page1'</span>: <span class="hljs-string">'&lt;h2&gt;页面 1&lt;/h2&gt;&lt;p&gt;这是页面 1 的内容。&lt;/p&gt;'</span>,
      <span class="hljs-string">'#page2'</span>: <span class="hljs-string">'&lt;h2&gt;页面 2&lt;/h2&gt;&lt;p&gt;这是页面 2 的内容。&lt;/p&gt;'</span>,
      <span class="hljs-string">'#page3'</span>: <span class="hljs-string">'&lt;h2&gt;页面 3&lt;/h2&gt;&lt;p&gt;这是页面 3 的内容。&lt;/p&gt;'</span>,
      <span class="hljs-string">'#page4'</span>: <span class="hljs-string">'&lt;h2&gt;页面 4&lt;/h2&gt;&lt;p&gt;这是通过 JavaScript 导航到的页面 4。&lt;/p&gt;'</span>
    };
    <span class="hljs-comment">// 处理 hash 变化</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleHashChange</span>(<span class="hljs-params"/>) {
      <span class="hljs-keyword">const</span> hash = <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">hash</span> || <span class="hljs-string">'#page1'</span>;
      <span class="hljs-keyword">const</span> content = pages[hash] || pages[<span class="hljs-string">'#page1'</span>];
      <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'content'</span>).<span class="hljs-property">innerHTML</span> = content;
      <span class="hljs-title function_">updateDisplay</span>();
    }
    
    <span class="hljs-comment">// 使用 pushState 导航（会产生历史记录）</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">navigateToPage4</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">pushState</span>({ <span class="hljs-attr">page</span>: <span class="hljs-string">'page4'</span> }, <span class="hljs-string">'Page 4'</span>, <span class="hljs-string">'#page4'</span>);
      <span class="hljs-title function_">handleHashChange</span>();
    }
    <span class="hljs-comment">// 监听 hash 变化</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'hashchange'</span>, handleHashChange);
    
    <span class="hljs-comment">// 监听 popstate（浏览器前进后退）</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'popstate'</span>, handleHashChange);
    <span class="hljs-comment">// 初始化</span>
    <span class="hljs-title function_">handleHashChange</span>();
    <span class="hljs-comment">// 定期更新历史记录数量显示</span>
    <span class="hljs-built_in">setInterval</span>(updateDisplay, <span class="hljs-number">500</span>);
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h4 data-id="heading-17">5. 问题演示步骤</h4>
<ol>
<li><strong>启动项目</strong>，访问列表页 (<code>/list</code>)</li>
<li><strong>点击项目</strong>，进入详情页 (<code>/detail?id=1</code>)</li>
<li><strong>打开 iframe 弹窗</strong>，点击"打开 iframe 选择器"按钮</li>
<li><strong>在 iframe 内导航</strong>：
<ul>
<li>点击"页面 1"、"页面 2"、"页面 3"等链接</li>
<li>观察"调试信息"面板中的"iframe 产生的历史记录数"增加</li>
</ul>
</li>
<li><strong>点击返回按钮</strong>：
<ul>
<li><strong>期望</strong>：返回到列表页</li>
<li><strong>实际</strong>：可能停留在当前页或返回到 iframe 的某个状态 ❌</li>
</ul>
</li>
<li><strong>或者点击"保存并返回"</strong>：
<ul>
<li>同样会出现无法正常返回的问题</li>
</ul>
</li>
</ol>
<h4 data-id="heading-18">6. 问题现象说明</h4>
<ul>
<li>打开浏览器开发者工具的控制台，可以看到历史记录的变化</li>
<li>在 iframe 内导航后，<code>window.history.length</code> 会增加</li>
<li>使用 <code>go(-1)</code> 时，会先回退 iframe 产生的历史记录，而不是直接返回到列表页</li>
<li>需要多次点击返回按钮才能回到列表页</li>
</ul>
<hr/>
<h2 data-id="heading-19">解决方案</h2>
<h3 data-id="heading-20">方案1：使用明确的路由路径（推荐）⭐</h3>
<p><strong>优点</strong>: 简单可靠，不受 iframe 影响，易于维护<br/>
<strong>缺点</strong>: 需要传递来源参数或设置默认路径</p>
<h4 data-id="heading-21">完整解决方案代码</h4>
<h5 data-id="heading-22">1. 列表页组件 (views/List.vue) - 解决方案版本</h5>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="list-page"&gt;
    &lt;h1&gt;列表页&lt;/h1&gt;
    &lt;div class="item-list"&gt;
      &lt;div 
        v-for="item in items" 
        :key="item.id" 
        class="item"
        @click="goToDetail(item.id)"
      &gt;
        &lt;span&gt;项目 {{ item.id }}: {{ item.name }}&lt;/span&gt;
      &lt;/div&gt;
    &lt;/div&gt;
    
    &lt;div class="info"&gt;
      &lt;p&gt;✅ 解决方案版本：跳转时会传递来源信息&lt;/p&gt;
      &lt;p&gt;操作步骤：&lt;/p&gt;
      &lt;ol&gt;
        &lt;li&gt;点击上方项目进入详情页（会自动传递来源）&lt;/li&gt;
        &lt;li&gt;在详情页打开 iframe 弹窗&lt;/li&gt;
        &lt;li&gt;在 iframe 内点击链接导航&lt;/li&gt;
        &lt;li&gt;点击返回按钮，应该能正常返回到列表页 ✅&lt;/li&gt;
      &lt;/ol&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  name: 'List',
  data() {
    return {
      items: [
        { id: 1, name: '测试项目1' },
        { id: 2, name: '测试项目2' },
        { id: 3, name: '测试项目3' }
      ]
    }
  },
  methods: {
    goToDetail(id) {
      // ✅ 解决方案：传递来源信息
      this.$router.push({
        path: '/detail-fixed',
        query: {
          from: this.$route.fullPath, // 传递当前路径作为来源
          id: id
        }
      })
    }
  }
}
&lt;/script&gt;
</code></pre>
<h5 data-id="heading-23">2. 详情页组件 (views/DetailFixed.vue) - 解决方案版本</h5>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;div class="detail-page"&gt;
    &lt;div class="header"&gt;
      &lt;button @click="handleGoBack" class="back-btn"&gt;← 返回&lt;/button&gt;
      &lt;h1&gt;详情页 - 项目 {{ $route.query.id }} (解决方案版本)&lt;/h1&gt;
    &lt;/div&gt;
    &lt;div class="content"&gt;
      &lt;p&gt;这是详情页内容&lt;/p&gt;
      
      &lt;div class="iframe-section"&gt;
        &lt;button @click="openIframeDialog" class="open-btn"&gt;
          打开 iframe 选择器
        &lt;/button&gt;
        &lt;div v-if="dialogVisible" class="dialog-overlay" @click="closeDialog"&gt;
          &lt;div class="dialog-content" @click.stop&gt;
            &lt;div class="dialog-header"&gt;
              &lt;h3&gt;iframe 选择器&lt;/h3&gt;
              &lt;button @click="closeDialog" class="close-btn"&gt;×&lt;/button&gt;
            &lt;/div&gt;
            &lt;div class="dialog-body"&gt;
              &lt;iframe
                :src="iframeUrl"
                @load="onIframeLoad"
                ref="iframeRef"
                class="iframe"
              &gt;&lt;/iframe&gt;
            &lt;/div&gt;
          &lt;/div&gt;
        &lt;/div&gt;
      &lt;/div&gt;
      &lt;div class="info-panel"&gt;
        &lt;h3&gt;调试信息&lt;/h3&gt;
        &lt;p&gt;来源路径: &lt;strong&gt;{{ fromPath || '无' }}&lt;/strong&gt;&lt;/p&gt;
        &lt;p&gt;当前路由: {{ $route.fullPath }}&lt;/p&gt;
        &lt;p&gt;✅ 使用明确的路由路径返回，不受 iframe 影响&lt;/p&gt;
      &lt;/div&gt;
      &lt;div class="action-section"&gt;
        &lt;button @click="handleSubmit" class="submit-btn"&gt;保存并返回&lt;/button&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  name: 'DetailFixed',
  data() {
    return {
      dialogVisible: false,
      iframeUrl: '/iframe-test.html'
    }
  },
  computed: {
    fromPath() {
      return this.$route.query.from
    }
  },
  methods: {
    // ✅ 解决方案：使用明确的路由路径返回
    handleGoBack() {
      const fromPath = this.$route.query.from
      if (fromPath) {
        // 如果有来源信息，返回到对应的路径
        console.log('返回到来源路径:', fromPath)
        this.$router.push({ path: fromPath })
      } else {
        // 默认返回到列表页
        console.log('没有来源信息，返回到默认路径: /list')
        this.$router.push({ path: '/list' })
      }
    },
    openIframeDialog() {
      this.dialogVisible = true
    },
    closeDialog() {
      this.dialogVisible = false
    },
    onIframeLoad() {
      console.log('iframe 加载完成')
    },
    async handleSubmit() {
      // 模拟保存操作
      console.log('保存数据...')
      await new Promise(resolve =&gt; setTimeout(resolve, 500))
      
      // ✅ 解决方案：保存成功后使用 handleGoBack 方法
      console.log('保存成功，准备返回')
      this.handleGoBack()
    }
  }
}
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-24">核心代码对比</h4>
<h5 data-id="heading-25">问题版本 vs 解决方案版本</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 问题版本：使用 go(-1)</span>
<span class="hljs-title function_">handleGoBack</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">go</span>(-<span class="hljs-number">1</span>)  <span class="hljs-comment">// 可能返回到 iframe 内部</span>
}

<span class="hljs-comment">// ✅ 解决方案版本：使用明确的路由路径</span>
<span class="hljs-title function_">handleGoBack</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> fromPath = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$route</span>.<span class="hljs-property">query</span>.<span class="hljs-property">from</span>
  <span class="hljs-keyword">if</span> (fromPath) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">path</span>: fromPath }) <span class="hljs-comment">// 直接返回到来源路径</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">path</span>: <span class="hljs-string">'/list'</span> }) <span class="hljs-comment">// 默认返回路径</span>
  }
}
</code></pre>
<h5 data-id="heading-26">跳转时传递来源信息</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 问题版本：不传递来源信息</span>
<span class="hljs-title function_">goToDetail</span>(<span class="hljs-params">id</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">push</span>({
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/detail'</span>,
    <span class="hljs-attr">query</span>: { id }
  })
}
<span class="hljs-comment">// ✅ 解决方案版本：传递来源信息</span>
<span class="hljs-title function_">goToDetail</span>(<span class="hljs-params">id</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">push</span>({
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/detail-fixed'</span>,
    <span class="hljs-attr">query</span>: {
      <span class="hljs-attr">from</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">$route</span>.<span class="hljs-property">fullPath</span>, <span class="hljs-comment">// 传递当前路径作为来源</span>
      <span class="hljs-attr">id</span>: id
    }
  })
}
</code></pre>
<hr/>
<h3 data-id="heading-27">方案2：使用 sessionStorage 记录来源（自动化方案）</h3>
<p><strong>优点</strong>: 自动记录来源，无需手动传参<br/>
<strong>缺点</strong>: 直接访问或刷新页面时可能不准确</p>
<h4 data-id="heading-28">实现代码</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-comment">// 路由守卫：在进入页面时记录来源</span>
  <span class="hljs-title function_">beforeRouteEnter</span>(<span class="hljs-params">to, <span class="hljs-keyword">from</span>, next</span>) {
    <span class="hljs-comment">// 记录来源路径</span>
    <span class="hljs-keyword">const</span> fromPath = <span class="hljs-keyword">from</span>.<span class="hljs-property">fullPath</span> || <span class="hljs-string">'/list'</span>;
    sessionStorage.<span class="hljs-title function_">setItem</span>(<span class="hljs-string">'page_detail_from'</span>, fromPath);
    <span class="hljs-title function_">next</span>();
  },
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 初始化逻辑</span>
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">handleGoBack</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 优先使用 query 参数（最可靠）</span>
      <span class="hljs-keyword">const</span> fromPath = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$route</span>.<span class="hljs-property">query</span>.<span class="hljs-property">from</span>;
      <span class="hljs-keyword">if</span> (fromPath) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">path</span>: fromPath });
        <span class="hljs-keyword">return</span>;
      }
      
      <span class="hljs-comment">// 其次使用 sessionStorage</span>
      <span class="hljs-keyword">const</span> storedFrom = sessionStorage.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'page_detail_from'</span>);
      <span class="hljs-keyword">if</span> (storedFrom &amp;&amp; storedFrom !== <span class="hljs-variable language_">this</span>.<span class="hljs-property">$route</span>.<span class="hljs-property">fullPath</span>) {
        sessionStorage.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">'page_detail_from'</span>);
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">path</span>: storedFrom });
        <span class="hljs-keyword">return</span>;
      }
      
      <span class="hljs-comment">// 默认返回</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">path</span>: <span class="hljs-string">'/list'</span> });
    }
  },
  <span class="hljs-title function_">beforeDestroy</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 清理 sessionStorage</span>
    sessionStorage.<span class="hljs-title function_">removeItem</span>(<span class="hljs-string">'page_detail_from'</span>);
  }
}
</code></pre>
<h4 data-id="heading-29">注意事项</h4>
<ul>
<li><strong>sessionStorage 特性</strong>: 不同标签页之间是隔离的，不会互相影响</li>
<li><strong>直接访问问题</strong>: 如果用户直接输入 URL 或刷新页面，<code>from</code> 为 <code>undefined</code>，需要设置默认值</li>
<li><strong>清理时机</strong>: 在 <code>beforeDestroy</code> 中清理，避免内存泄漏</li>
<li><strong>key 命名</strong>: 使用唯一的 key，避免与其他页面冲突</li>
</ul>
<hr/>
<h3 data-id="heading-30">方案3：记录历史记录长度（动态计算）</h3>
<p><strong>优点</strong>: 可以准确返回到上一页<br/>
<strong>缺点</strong>: 如果用户在当前页面进行了其他导航，计算可能不准确</p>
<h4 data-id="heading-31">实现代码</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">initialHistoryLength</span>: <span class="hljs-number">0</span>  <span class="hljs-comment">// 记录初始历史记录长度</span>
    }
  },
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 记录初始历史长度</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">initialHistoryLength</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-property">length</span>;
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">handleGoBack</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 优先使用 query 参数</span>
      <span class="hljs-keyword">const</span> fromPath = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$route</span>.<span class="hljs-property">query</span>.<span class="hljs-property">from</span>;
      <span class="hljs-keyword">if</span> (fromPath) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">path</span>: fromPath });
        <span class="hljs-keyword">return</span>;
      }
      
      <span class="hljs-comment">// 计算 iframe 增加的历史记录数</span>
      <span class="hljs-keyword">const</span> iframeHistoryCount = <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-property">length</span> - <span class="hljs-variable language_">this</span>.<span class="hljs-property">initialHistoryLength</span>;
      <span class="hljs-comment">// 回退到正确的位置（跳过 iframe 产生的历史记录）</span>
      <span class="hljs-keyword">if</span> (iframeHistoryCount &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">go</span>(-(iframeHistoryCount + <span class="hljs-number">1</span>));
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">go</span>(-<span class="hljs-number">1</span>);
      }
    }
  }
}
</code></pre>
<hr/>
<h3 data-id="heading-32">方案4：在 iframe 组件中阻止历史记录（根源解决）</h3>
<p><strong>优点</strong>: 从根源解决问题，iframe 不会产生历史记录<br/>
<strong>缺点</strong>: 需要修改 iframe 组件，可能影响其他使用场景</p>
<h4 data-id="heading-33">实现代码</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// IframeComponent.vue</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 监听 iframe 的 load 事件</span>
    <span class="hljs-variable language_">this</span>.$nextTick(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>.<span class="hljs-property">externalIframe</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>.<span class="hljs-property">externalIframe</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'load'</span>, <span class="hljs-function">() =&gt;</span> {
          <span class="hljs-comment">// 使用 replaceState 替换历史记录，而不是添加</span>
          <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">replaceState</span>(
            <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-property">state</span>,
            <span class="hljs-string">''</span>,
            <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>
          );
        });
      }
    });
  }
}
</code></pre>
<p><strong>注意</strong>: 这种方法可能会影响 iframe 内部的正常导航功能，需要谨慎使用。</p>
<hr/>
<h2 data-id="heading-34">方案对比</h2>








































<table><thead><tr><th>方案</th><th>优点</th><th>缺点</th><th>适用场景</th><th>推荐度</th></tr></thead><tbody><tr><td><strong>方案1：明确路由路径</strong></td><td>简单可靠、不受iframe影响、易于维护</td><td>需要传参或默认路径</td><td>入口相对固定的页面</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>方案2：sessionStorage</strong></td><td>自动记录来源、标签页隔离</td><td>直接访问时可能不准确、需要路由守卫</td><td>入口较多且希望自动化</td><td>⭐⭐⭐⭐</td></tr><tr><td><strong>方案3：历史记录长度</strong></td><td>可以准确返回</td><td>计算可能不准确</td><td>简单场景</td><td>⭐⭐⭐</td></tr><tr><td><strong>方案4：阻止历史记录</strong></td><td>根源解决</td><td>可能影响iframe功能</td><td>特殊需求</td><td>⭐⭐</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-35">最佳实践</h2>
<h3 data-id="heading-36">1. 推荐使用方案1（明确路由路径）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 推荐：使用明确的路由路径</span>
<span class="hljs-title function_">handleGoBack</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> fromPath = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$route</span>.<span class="hljs-property">query</span>.<span class="hljs-property">from</span>;
  <span class="hljs-keyword">if</span> (fromPath) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">path</span>: fromPath });
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">path</span>: <span class="hljs-string">'/list'</span> });  <span class="hljs-comment">// 设置合理的默认路径</span>
  }
}
</code></pre>
<h3 data-id="heading-37">2. 跳转时统一传递来源信息</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 推荐：在跳转时传递来源</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">push</span>({
  <span class="hljs-attr">path</span>: <span class="hljs-string">'/detail-fixed'</span>,
  <span class="hljs-attr">query</span>: {
    <span class="hljs-attr">from</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">$route</span>.<span class="hljs-property">fullPath</span>, <span class="hljs-comment">// 传递完整路径</span>
    <span class="hljs-attr">id</span>: itemId
    <span class="hljs-comment">// 其他参数...</span>
  }
});
</code></pre>
<h3 data-id="heading-38">3. 处理多种入口场景</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ✅ 推荐：处理多种来源</span>
<span class="hljs-title function_">handleGoBack</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> fromPath = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$route</span>.<span class="hljs-property">query</span>.<span class="hljs-property">from</span>;
  <span class="hljs-comment">// 支持路由名称或路径</span>
  <span class="hljs-keyword">if</span> (fromPath) {
    <span class="hljs-keyword">if</span> (fromPath.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'/'</span>)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">path</span>: fromPath });
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">name</span>: fromPath });
    }
    <span class="hljs-keyword">return</span>;
  }
  <span class="hljs-comment">// 根据页面模式设置默认返回路径</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">isEditMode</span>) {
    <span class="hljs-comment">// 编辑模式：返回到详情页</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">push</span>({
      <span class="hljs-attr">name</span>: <span class="hljs-string">'Detail'</span>,
      <span class="hljs-attr">query</span>: { <span class="hljs-attr">id</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemId</span> }
    });
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 新建模式：返回到列表页</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">path</span>: <span class="hljs-string">'/list'</span> });
  }
}
</code></pre>
<h3 data-id="heading-39">4. 避免使用 go(-1) 的场景</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 避免：在包含 iframe 的页面中使用</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">go</span>(-<span class="hljs-number">1</span>);

<span class="hljs-comment">// ✅ 推荐：使用明确的路由路径</span>
<span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">path</span>: <span class="hljs-string">'/list'</span> });
</code></pre>
<h3 data-id="heading-40">5. 测试建议</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 测试场景：</span>
<span class="hljs-comment">// 1. 从列表页进入 -&gt; 返回应该回到列表页</span>
<span class="hljs-comment">// 2. 从详情页进入（编辑模式）-&gt; 返回应该回到详情页</span>
<span class="hljs-comment">// 3. 打开 iframe 弹窗并导航 -&gt; 返回应该不受影响</span>
<span class="hljs-comment">// 4. 直接访问 URL -&gt; 返回应该有合理的默认路径</span>
<span class="hljs-comment">// 5. 刷新页面 -&gt; 返回应该有合理的默认路径</span>
<span class="hljs-comment">// 6. 多个标签页 -&gt; 每个标签页应该独立工作</span>
</code></pre>
<hr/>
<h2 data-id="heading-41">测试和验证</h2>
<h3 data-id="heading-42">测试步骤</h3>
<h4 data-id="heading-43">1. 测试问题版本</h4>
<ol>
<li>访问 <code>/list</code> 列表页</li>
<li>点击任意项目，进入 <code>/detail?id=1</code> 详情页</li>
<li>点击"打开 iframe 选择器"按钮</li>
<li>在 iframe 内多次点击导航链接（页面1、页面2、页面3等）</li>
<li>观察浏览器开发者工具中的历史记录变化</li>
<li>点击"返回"按钮</li>
<li><strong>问题现象</strong>：可能无法直接返回到列表页，需要多次点击返回</li>
</ol>
<h4 data-id="heading-44">2. 测试解决方案版本</h4>
<ol>
<li>访问 <code>/list</code> 列表页</li>
<li>点击任意项目，进入 <code>/detail-fixed?from=/list&amp;id=1</code> 详情页</li>
<li>点击"打开 iframe 选择器"按钮</li>
<li>在 iframe 内多次点击导航链接</li>
<li>点击"返回"按钮</li>
<li><strong>预期结果</strong>：直接返回到列表页 ✅</li>
</ol>
<h3 data-id="heading-45">验证方法</h3>
<h4 data-id="heading-46">方法1：使用浏览器开发者工具</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 在浏览器控制台中执行</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'当前历史记录长度:'</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-property">length</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'当前 URL:'</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span>)

<span class="hljs-comment">// 查看历史记录</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'历史记录:'</span>, <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>)
</code></pre>
<h4 data-id="heading-47">方法2：添加调试代码</h4>
<p>在详情页组件中添加以下代码来监控历史记录：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 记录初始历史长度</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">initialHistoryLength</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-property">length</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'初始历史记录长度:'</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">initialHistoryLength</span>)
  
  <span class="hljs-comment">// 监听历史记录变化</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">checkHistory</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> currentLength = <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-property">length</span>
    <span class="hljs-keyword">const</span> diff = currentLength - <span class="hljs-variable language_">this</span>.<span class="hljs-property">initialHistoryLength</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`历史记录变化: <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.initialHistoryLength}</span> -&gt; <span class="hljs-subst">${currentLength}</span> (增加 <span class="hljs-subst">${diff}</span>)`</span>)
  }
  
  <span class="hljs-comment">// 定期检查</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">historyCheckInterval</span> = <span class="hljs-built_in">setInterval</span>(checkHistory, <span class="hljs-number">1000</span>)
},

<span class="hljs-title function_">beforeDestroy</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">historyCheckInterval</span>) {
    <span class="hljs-built_in">clearInterval</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">historyCheckInterval</span>)
  }
}
</code></pre>
<h4 data-id="heading-48">方法3：对比测试</h4>
<p>同时打开两个浏览器标签页：</p>
<ul>
<li>标签页1：访问问题版本 (<code>/detail</code>)</li>
<li>标签页2：访问解决方案版本 (<code>/detail-fixed</code>)</li>
</ul>
<p>分别测试返回功能，对比差异。</p>
<h3 data-id="heading-49">预期结果</h3>






























<table><thead><tr><th>操作</th><th>问题版本</th><th>解决方案版本</th></tr></thead><tbody><tr><td>打开 iframe 前返回</td><td>✅ 正常返回</td><td>✅ 正常返回</td></tr><tr><td>打开 iframe 后返回</td><td>❌ 可能无法返回</td><td>✅ 正常返回</td></tr><tr><td>iframe 内导航后返回</td><td>❌ 无法返回</td><td>✅ 正常返回</td></tr><tr><td>保存后自动返回</td><td>❌ 可能无法返回</td><td>✅ 正常返回</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-50">相关资源</h2>
<h3 data-id="heading-51">浏览器历史记录 API</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FHistory" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/History" ref="nofollow noopener noreferrer">MDN: History API</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FWindow%2FsessionStorage" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/sessionStorage" ref="nofollow noopener noreferrer">MDN: sessionStorage</a></li>
</ul>
<h3 data-id="heading-52">Vue Router 文档</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Frouter.vuejs.org%2Fzh%2Fguide%2Fessentials%2Fnavigation.html" target="_blank" title="https://router.vuejs.org/zh/guide/essentials/navigation.html" ref="nofollow noopener noreferrer">Vue Router: 编程式导航</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Frouter.vuejs.org%2Fzh%2Fguide%2Fadvanced%2Fnavigation-guards.html" target="_blank" title="https://router.vuejs.org/zh/guide/advanced/navigation-guards.html" ref="nofollow noopener noreferrer">Vue Router: 路由守卫</a></li>
</ul>
<h3 data-id="heading-53">iframe 相关</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FHTML%2FElement%2Fiframe" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/iframe" ref="nofollow noopener noreferrer">MDN: iframe 元素</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FWindow%2FpostMessage" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Window/postMessage" ref="nofollow noopener noreferrer">iframe 与父页面通信</a></li>
</ul>
<hr/>
<h2 data-id="heading-54">总结</h2>
<p>iframe 导致 <code>go(-1)</code> 无法正常返回的问题，根本原因是 iframe 内部的导航会污染父页面的浏览器历史记录。最佳解决方案是<strong>使用明确的路由路径进行返回</strong>，而不是依赖浏览器历史记录栈。</p>
<h3 data-id="heading-55">核心要点</h3>
<ol>
<li>✅ <strong>避免使用 <code>go(-1)</code></strong>：在包含 iframe 的页面中，使用明确的路由路径</li>
<li>✅ <strong>传递来源信息</strong>：跳转时通过 query 参数传递来源路径</li>
<li>✅ <strong>设置默认路径</strong>：为直接访问或刷新页面的情况设置合理的默认返回路径</li>
<li>✅ <strong>统一处理逻辑</strong>：在 <code>handleGoBack</code> 方法中统一处理所有返回逻辑</li>
</ol>
<h3 data-id="heading-56">代码示例总结</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 最终推荐方案</span>
<span class="hljs-title function_">handleGoBack</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> fromPath = <span class="hljs-variable language_">this</span>.<span class="hljs-property">$route</span>.<span class="hljs-property">query</span>.<span class="hljs-property">from</span>;
  <span class="hljs-keyword">if</span> (fromPath) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">path</span>: fromPath });
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">$router</span>.<span class="hljs-title function_">push</span>({ <span class="hljs-attr">path</span>: <span class="hljs-string">'/list'</span> });
  }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Node.js 第二课：用核心模块构建你的第一个服务器]]></title>    <link>https://juejin.cn/post/7587779957674606643</link>    <guid>https://juejin.cn/post/7587779957674606643</guid>    <pubDate>2025-12-26T03:28:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587779957674606643" data-draft-id="7587704265054683174" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Node.js 第二课：用核心模块构建你的第一个服务器"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2025-12-26T03:28:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Drift_Dream"/> <meta itemprop="url" content="https://juejin.cn/user/3107677514241500"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Node.js 第二课：用核心模块构建你的第一个服务器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3107677514241500/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Drift_Dream
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T03:28:57.000Z" title="Fri Dec 26 2025 03:28:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.7;font-weight:400;font-size:16px;overflow-x:hidden;color:#212122}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-bottom:8px;padding-bottom:8px}.markdown-body h1{color:#a0a0a0;font-size:38px;margin-top:32px;padding-top:32px}.markdown-body h2{color:#fff;background-color:#212122;width:fit-content;border-bottom-right-radius:100px;margin-top:47px;margin-bottom:16px;padding:4px 48px 4px 8px;line-height:1.7;font-size:30px;transition:all .3s ease-out}.markdown-body h2:hover{border-bottom-right-radius:50px;transition:all .3s ease-out}.markdown-body h3{font-size:24px;padding-left:8px;margin-top:32px;border-bottom:2px solid #c6c4c4;line-height:1.7}.markdown-body h4{font-size:20px;padding-left:8px;margin-top:32px;border-bottom:1px solid #ddd}.markdown-body h5{font-size:16px;margin-top:24px}.markdown-body h6{margin-top:16px;line-height:1.1}.markdown-body p{font-size:16px;text-align:start;white-space:normal;text-size-adjust:auto;line-height:2;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%;margin:auto;padding-left:8px;padding-right:8px}.markdown-body hr{border:none;border-top:4px double #212122;margin-top:32px;margin-bottom:32px;text-align:center}.markdown-body hr:after{content:"♥";display:inline-block;position:relative;top:-15px;padding:0 10px;color:#212122;font-size:18px}.markdown-body code{word-break:break-word;overflow-x:auto;background-color:#f1f1f1;color:#ef7060;font-size:14px;padding:.065em 6px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.7;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);margin:32px 16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-color:#212122;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);background-size:40px}.markdown-body pre&gt;code{font-size:14px;padding:16px 8px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#fff;background:#272822}.markdown-body pre&gt;code::-webkit-scrollbar{height:10px;background-color:#f5f5f5}.markdown-body pre&gt;code::-webkit-scrollbar-track{box-shadow:inset 0 0 6px rgba(0,0,0,.3);border-radius:3px;background-color:#f5f5f5}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{border-radius:3px;box-shadow:inset 0 0 6px rgba(0,0,0,.3);background-color:#555}.markdown-body a{color:#ef7060;padding:2px;text-decoration:none;border-bottom:.125em solid #ef7060;border-radius:2px;box-shadow:inset 0 -.025em 0 #ef7060;transition:box-shadow .27s cubic-bezier(.77,0,.175,1),color .27s cubic-bezier(.77,0,.175,1)}.markdown-body a:focus,.markdown-body a:hover{outline:none;box-shadow:inset 0 -1.5em 0 #ef7060;color:#fff}.markdown-body a:before{content:"⇲ ";vertical-align:top;margin-left:2px;font-family:dart!important;font-size:12px;color:inherit;opacity:.7}.markdown-body table{background:#fbfbfb;border-radius:4px;border-collapse:collapse;margin:auto;padding:5px;width:95%;box-shadow:0 5px 10px rgba(0,0,0,.1);animation:float 5s infinite}.markdown-body table th{color:#fff;background:#212122;border-bottom:1px solid #9ea7af;border-right:1px solid #343a45;font-size:18px;padding:16px;text-align:left;vertical-align:middle}.markdown-body table th:first-child{border-top-left-radius:4px}.markdown-body table th:last-child{border-top-right-radius:4px;border-right:none}.markdown-body table tr{border-top:1px solid #c1c3d1;border-bottom:1px solid #c1c3d1;color:#666b85}.markdown-body table tr:hover td{background:#212122;color:#fff;border-top:1px solid #22262e}.markdown-body table tr:first-child{border-top:none}.markdown-body table tr:last-child{border-bottom:none}.markdown-body table tr:nth-child(odd) td{background:#f1f1f1}.markdown-body table tr:nth-child(odd):hover td{background:#212122}.markdown-body table tr:last-child td:first-child{border-bottom-left-radius:4px}.markdown-body table tr:last-child td:last-child{border-bottom-right-radius:4px}.markdown-body table td{background:#fbfbfb;padding:16px;text-align:left;vertical-align:middle;font-size:16px;border-right:1px solid #c1c3d1}.markdown-body table td:last-child{border-right:0}.markdown-body blockquote{color:#777;padding:1px 16px;margin:24px 0;border-left:4px solid #c6c4c4;background-color:#f1f1f1;transition:all .3s ease-out;border-radius:4px}.markdown-body blockquote:hover{border-left-color:#212122;background-color:#212122;color:#fff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:24px}.markdown-body ol li,.markdown-body ul li{margin-bottom:6px;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body span.math{margin-left:32px;font-size:18px;font-weight:700}@media (max-width:720px){.markdown-body h1{font-size:30.4px}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:19.2px}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:12.8px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><p>创建并运行一个真正的Node.js服务器，理解HTTP模块，学会处理请求与响应。</p>
<h2 data-id="heading-0">实战项目：简易天气查询API</h2>
<h3 data-id="heading-1">1. 创建项目结构</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">mkdir</span> server-demo
<span class="hljs-built_in">cd</span> server-demo
npm init -y
npm install nodemon --save-dev
</code></pre>
<p>修改 <code>package.json</code>：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"dev"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"nodemon server.js"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h3 data-id="heading-2">2. <strong>核心模块讲解：http</strong></h3>
<p><strong>创建 <code>server.js</code>：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 导入内置的http模块</span>
<span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);

<span class="hljs-comment">// 2. 创建服务器实例</span>
<span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
  <span class="hljs-comment">// req: 请求对象，包含客户端的信息</span>
  <span class="hljs-comment">// res: 响应对象，用于向客户端返回数据</span>
  
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`收到 <span class="hljs-subst">${req.method}</span> 请求，路径: <span class="hljs-subst">${req.url}</span>`</span>);
  
  <span class="hljs-comment">// 设置响应头</span>
  res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">200</span>, { 
    <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>,
    <span class="hljs-string">'Access-Control-Allow-Origin'</span>: <span class="hljs-string">'*'</span>
  });
  
  <span class="hljs-comment">// 根据请求路径返回不同响应</span>
  <span class="hljs-keyword">if</span> (req.<span class="hljs-property">url</span> === <span class="hljs-string">'/weather/beijing'</span>) {
    res.<span class="hljs-title function_">end</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      <span class="hljs-attr">city</span>: <span class="hljs-string">"北京"</span>,
      <span class="hljs-attr">temperature</span>: <span class="hljs-string">"22°C"</span>,
      <span class="hljs-attr">condition</span>: <span class="hljs-string">"晴天"</span>
    }));
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (req.<span class="hljs-property">url</span> === <span class="hljs-string">'/weather/shanghai'</span>) {
    res.<span class="hljs-title function_">end</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      <span class="hljs-attr">city</span>: <span class="hljs-string">"上海"</span>,
      <span class="hljs-attr">temperature</span>: <span class="hljs-string">"25°C"</span>,
      <span class="hljs-attr">condition</span>: <span class="hljs-string">"多云"</span>
    }));
  } <span class="hljs-keyword">else</span> {
    res.<span class="hljs-title function_">end</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({
      <span class="hljs-attr">message</span>: <span class="hljs-string">"欢迎使用天气API"</span>,
      <span class="hljs-attr">endpoints</span>: [<span class="hljs-string">"/weather/beijing"</span>, <span class="hljs-string">"/weather/shanghai"</span>]
    }));
  }
});

<span class="hljs-comment">// 3. 监听端口</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PORT</span> = <span class="hljs-number">3000</span>;
server.<span class="hljs-title function_">listen</span>(<span class="hljs-variable constant_">PORT</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`🚀 服务器运行在: http://localhost:<span class="hljs-subst">${PORT}</span>`</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`📡 试试访问: http://localhost:<span class="hljs-subst">${PORT}</span>/weather/beijing`</span>);
});
</code></pre>
<h3 data-id="heading-3">3. <strong>运行并测试</strong></h3>
<pre><code class="hljs language-bash" lang="bash">npm run dev
</code></pre>
<p>用三种方式测试：</p>
<ol>
<li><strong>浏览器访问</strong>：打开 <code>http://localhost:3000</code></li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2aeb93cd05aa4b228e44a46145a1ce76~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRHJpZnRfRHJlYW0=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324537&amp;x-signature=h%2FEFp86uB19CcCSzaSmaKBFoyec%3D" alt="image.png" loading="lazy"/></p>
<p>2  <strong>命令行curl</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">curl http://localhost:3000/weather/shanghai
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7643aff19d6841a19101e4e3fcfedd2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRHJpZnRfRHJlYW0=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324537&amp;x-signature=z7kbvFcqYdFkbL7afsvD%2B5VgzdU%3D" alt="image.png" loading="lazy"/></p>
<ol start="3">
<li><strong>创建测试文件 <code>test.js</code></strong>：</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>);

<span class="hljs-keyword">const</span> options = {
  <span class="hljs-attr">hostname</span>: <span class="hljs-string">'localhost'</span>,
  <span class="hljs-attr">port</span>: <span class="hljs-number">3000</span>,
  <span class="hljs-attr">path</span>: <span class="hljs-string">'/weather/beijing'</span>,
  <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>
};

<span class="hljs-keyword">const</span> req = http.<span class="hljs-title function_">request</span>(options, <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
  <span class="hljs-keyword">let</span> data = <span class="hljs-string">''</span>;
  
  res.<span class="hljs-title function_">on</span>(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-params">chunk</span> =&gt;</span> {
    data += chunk;
  });
  
  res.<span class="hljs-title function_">on</span>(<span class="hljs-string">'end'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'天气数据:'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(data));
  });
});

req.<span class="hljs-title function_">end</span>();
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed1a0fb38ea643289c5f07140dcce7cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRHJpZnRfRHJlYW0=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324537&amp;x-signature=fK6HxpnfZavX%2BBUxh8RZJ4soLKA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">知识点总结</h2>
<p>✅ 掌握 <code>http.createServer()</code>创建服务器</p>
<p>✅ 理解 <code>req</code>和 <code>res</code>对象</p>
<p>✅ 学会设置响应头和状态码</p>
<p>✅ 能根据不同URL返回不同内容</p>
<p>✅ 知道如何用 <code>nodemon</code>热重载</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[首页图片懒加载实现方案解析]]></title>    <link>https://juejin.cn/post/7587715742051221514</link>    <guid>https://juejin.cn/post/7587715742051221514</guid>    <pubDate>2025-12-26T03:31:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587715742051221514" data-draft-id="7587715742051205130" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="首页图片懒加载实现方案解析"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-26T03:31:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="DEMO派"/> <meta itemprop="url" content="https://juejin.cn/user/2314902384159147"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            首页图片懒加载实现方案解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2314902384159147/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    DEMO派
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T03:31:10.000Z" title="Fri Dec 26 2025 03:31:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. IntersectionObserver API（现代推荐方案）</h2>
<p><strong>实现原理：</strong>
通过观察目标元素与视窗的交叉状态，自动触发回调函数。</p>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> images = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'img[data-src]'</span>);
<span class="hljs-keyword">const</span> imageObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
  entries.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">isIntersecting</span>) {
      <span class="hljs-keyword">const</span> img = entry.<span class="hljs-property">target</span>;
      img.<span class="hljs-property">src</span> = img.<span class="hljs-property">dataset</span>.<span class="hljs-property">src</span>;
      img.<span class="hljs-title function_">removeAttribute</span>(<span class="hljs-string">'data-src'</span>);
      imageObserver.<span class="hljs-title function_">unobserve</span>(img);
    }
  });
}, { <span class="hljs-attr">rootMargin</span>: <span class="hljs-string">'50px'</span> });

images.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">img</span> =&gt;</span> imageObserver.<span class="hljs-title function_">observe</span>(img));
</code></pre>
<p><strong>优点：</strong></p>
<p>✅ 原生浏览器支持，性能最优</p>
<p>✅ 异步执行，不阻塞主线程</p>
<p>✅ 支持阈值配置和根元素偏移</p>
<p>✅ 代码简洁，易于维护</p>
<p>✅ 支持所有现代浏览器（IE需polyfill）</p>
<p><strong>缺点：</strong></p>
<p>❌ IE不原生支持（需polyfill）</p>
<p>❌ 部分复杂场景配置需要理解</p>
<h2 data-id="heading-1">2. 传统滚动监听 + getBoundingClientRect</h2>
<p><strong>实现原理：</strong>
监听滚动事件，通过getBoundingClientRect()计算元素位置。</p>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">lazyLoadTraditional</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> images = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'img[data-src]'</span>);
  <span class="hljs-keyword">const</span> windowHeight = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
  
  images.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">img</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> rect = img.<span class="hljs-title function_">getBoundingClientRect</span>();
    <span class="hljs-keyword">if</span> (rect.<span class="hljs-property">top</span> &lt; windowHeight + <span class="hljs-number">100</span>) {
      img.<span class="hljs-property">src</span> = img.<span class="hljs-property">dataset</span>.<span class="hljs-property">src</span>;
      img.<span class="hljs-title function_">removeAttribute</span>(<span class="hljs-string">'data-src'</span>);
    }
  });
}

<span class="hljs-comment">// 添加防抖优化</span>
<span class="hljs-keyword">const</span> debouncedLazyLoad = <span class="hljs-title function_">debounce</span>(lazyLoadTraditional, <span class="hljs-number">100</span>);
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, debouncedLazyLoad);
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, debouncedLazyLoad);
</code></pre>
<p><strong>优点：</strong></p>
<p>✅ 兼容性好（支持所有浏览器）</p>
<p>✅ 无需额外依赖</p>
<p>✅ 控制精细，可自定义计算逻辑</p>
<p><strong>缺点：</strong></p>
<p>❌ 频繁触发，性能较差</p>
<p>❌ 需要手动优化（防抖/节流）</p>
<p>❌ 代码相对复杂</p>
<p>❌ 计算可能引起重排</p>
<h2 data-id="heading-2">3. offsetTop/scrollTop 计算</h2>
<p><strong>实现原理：</strong>
通过元素相对于文档的偏移位置计算。</p>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">lazyLoadOffset</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> images = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'img[data-src]'</span>);
  <span class="hljs-keyword">const</span> scrollTop = <span class="hljs-variable language_">window</span>.<span class="hljs-property">pageYOffset</span> || <span class="hljs-variable language_">document</span>.<span class="hljs-property">documentElement</span>.<span class="hljs-property">scrollTop</span>;
  <span class="hljs-keyword">const</span> windowHeight = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
  
  images.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">img</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (img.<span class="hljs-property">offsetTop</span> &lt; scrollTop + windowHeight + <span class="hljs-number">200</span>) {
      img.<span class="hljs-property">src</span> = img.<span class="hljs-property">dataset</span>.<span class="hljs-property">src</span>;
      img.<span class="hljs-title function_">removeAttribute</span>(<span class="hljs-string">'data-src'</span>);
    }
  });
}
</code></pre>
<p><strong>优点：</strong></p>
<p>✅ 兼容性极好</p>
<p>✅ 计算相对简单</p>
<p><strong>缺点：</strong></p>
<p>❌ 准确性受布局影响</p>
<p>❌ 频繁重排影响性能</p>
<p>❌ 需要处理多种滚动容器</p>
<h2 data-id="heading-3">4. 基于 CSS 的 content-visibility</h2>
<p><strong>实现原理：</strong>
利用CSS新特性延迟渲染不可见内容。</p>
<p><strong>代码示例：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript">.<span class="hljs-property">lazy</span>-container {
  content-<span class="hljs-attr">visibility</span>: auto;
  contain-intrinsic-<span class="hljs-attr">size</span>: <span class="hljs-number">0</span> 500px; <span class="hljs-comment">/* 预估高度 */</span>
}

<span class="hljs-comment">/* 图片完全加载后移除占位 */</span>
<span class="hljs-attr">img</span>:<span class="hljs-title function_">not</span>(<span class="hljs-params">[src]</span>) {
  <span class="hljs-attr">background</span>: #f0f0f0;
}
</code></pre>
<p><strong>优点：</strong></p>
<p>✅ 性能优秀（浏览器原生优化）</p>
<p>✅ 简单易用</p>
<p>✅ 适用于大量列表</p>
<p><strong>缺点：</strong></p>
<p>❌ 兼容性一般（Chrome 85+）</p>
<p>❌ 不是专门为懒加载设计</p>
<p>❌ 需要预估内容尺寸</p>
<h2 data-id="heading-4">5. 第三方库方案</h2>
<p><strong>常见库：</strong></p>
<p>lozad.js（基于IntersectionObserver）
lazysizes（功能全面）
vanilla-lazyload（轻量级）</p>
<p><strong>代码示例（lozad.js）：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> lozad <span class="hljs-keyword">from</span> <span class="hljs-string">'lozad'</span>;

<span class="hljs-keyword">const</span> observer = <span class="hljs-title function_">lozad</span>(<span class="hljs-string">'.lozad'</span>, {
  <span class="hljs-attr">rootMargin</span>: <span class="hljs-string">'100px'</span>,
  <span class="hljs-attr">loaded</span>: <span class="hljs-function">(<span class="hljs-params">el</span>) =&gt;</span> {
    el.<span class="hljs-property">classList</span>.<span class="hljs-title function_">add</span>(<span class="hljs-string">'loaded'</span>);
  }
});
observer.<span class="hljs-title function_">observe</span>();
</code></pre>
<p><strong>优点：</strong></p>
<p>✅ 功能丰富（支持背景图、iframe等）</p>
<p>✅ 自动降级处理</p>
<p>✅ 社区维护，测试充分</p>
<p>✅ 支持多种加载策略</p>
<p><strong>缺点：</strong></p>
<p>❌ 增加包体积</p>
<p>❌ 学习第三方API</p>
<p>❌ 可能包含不需要的功能</p>
<h2 data-id="heading-5">方案详细对比</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc85fbdd18484822ac5df0b1757dc377~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgREVNT-a0vg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324977&amp;x-signature=nfDsAB7PA87yir294Au49fDC5N8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-6">建议与最佳实践</h2>
<h3 data-id="heading-7">推荐方案选择</h3>
<h4 data-id="heading-8">1. 首选方案：IntersectionObserver + 优雅降级</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 示例：带降级的实现</span>
<span class="hljs-keyword">const</span> lazyLoad = (<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-string">'IntersectionObserver'</span> <span class="hljs-keyword">in</span> <span class="hljs-variable language_">window</span>) {
    <span class="hljs-comment">// 使用IntersectionObserver</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">images</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
        entries.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
          <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">isIntersecting</span>) {
            <span class="hljs-title function_">loadImage</span>(entry.<span class="hljs-property">target</span>);
            observer.<span class="hljs-title function_">unobserve</span>(entry.<span class="hljs-property">target</span>);
          }
        });
      }, { <span class="hljs-attr">rootMargin</span>: <span class="hljs-string">'50px'</span> });
      
      images.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">img</span> =&gt;</span> observer.<span class="hljs-title function_">observe</span>(img));
    };
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 降级到传统方案</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">(<span class="hljs-params">images</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> lazyLoadTraditional = <span class="hljs-title function_">debounce</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">const</span> windowHeight = <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>;
        images.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">img</span> =&gt;</span> {
          <span class="hljs-keyword">const</span> rect = img.<span class="hljs-title function_">getBoundingClientRect</span>();
          <span class="hljs-keyword">if</span> (rect.<span class="hljs-property">top</span> &lt; windowHeight + <span class="hljs-number">100</span>) {
            <span class="hljs-title function_">loadImage</span>(img);
          }
        });
      }, <span class="hljs-number">100</span>);
      
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, lazyLoadTraditional);
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'resize'</span>, lazyLoadTraditional);
      <span class="hljs-title function_">lazyLoadTraditional</span>(); <span class="hljs-comment">// 初始执行</span>
    };
  }
})();
</code></pre>
<h4 data-id="heading-9">2. 关键优化建议：</h4>
<p>占位符：使用固定宽高比容器避免布局抖动</p>
<p>渐进加载：先加载低质量占位图（LQIP）</p>
<p>错误处理：添加加载失败的回退方案</p>
<p>预加载：提前加载即将进入视口的图片</p>
<h4 data-id="heading-10">3. HTML标记示例：</h4>
<pre><code class="hljs language-javascript" lang="javascript">&lt;div <span class="hljs-keyword">class</span>=<span class="hljs-string">"image-container"</span> style=<span class="hljs-string">"aspect-ratio: 16/9;"</span>&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> 
    <span class="hljs-attr">data-src</span>=<span class="hljs-string">"image.jpg"</span> 
    <span class="hljs-attr">data-srcset</span>=<span class="hljs-string">"image-small.jpg 300w, image-large.jpg 800w"</span>
    <span class="hljs-attr">data-sizes</span>=<span class="hljs-string">"auto"</span>
    <span class="hljs-attr">alt</span>=<span class="hljs-string">"描述文本"</span>
    <span class="hljs-attr">class</span>=<span class="hljs-string">"lazy-image"</span>
    <span class="hljs-attr">width</span>=<span class="hljs-string">"800"</span>
    <span class="hljs-attr">height</span>=<span class="hljs-string">"450"</span>
  &gt;</span>
  <span class="hljs-comment">&lt;!-- 低质量占位 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lazy-placeholder"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-11">4. 性能监控：</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 监控图片加载性能</span>
<span class="hljs-keyword">const</span> perfObserver = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PerformanceObserver</span>(<span class="hljs-function">(<span class="hljs-params">list</span>) =&gt;</span> {
  list.<span class="hljs-title function_">getEntries</span>().<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Lazy-loaded image timing:'</span>, {
      <span class="hljs-attr">name</span>: entry.<span class="hljs-property">name</span>,
      <span class="hljs-attr">duration</span>: entry.<span class="hljs-property">duration</span>,
      <span class="hljs-attr">startTime</span>: entry.<span class="hljs-property">startTime</span>
    });
  });
});
perfObserver.<span class="hljs-title function_">observe</span>({ <span class="hljs-attr">entryTypes</span>: [<span class="hljs-string">'resource'</span>] });
</code></pre>
<h2 data-id="heading-12">总结</h2>
<ol>
<li>
<p>对于现代应用：IntersectionObserver是首选方案，提供最佳性能和开发体验。</p>
</li>
<li>
<p>需要兼容旧浏览器：使用IntersectionObserver polyfill或第三方库（如lazysizes）自动处理降级。</p>
</li>
<li>
<p>简单页面/少量图片：传统的滚动监听方案仍然可用，但必须添加防抖/节流优化。</p>
</li>
<li>
<p>内容密集型页面：考虑结合CSS content-visibility和懒加载，获得双重性能提升。</p>
</li>
<li>
<p>企业级项目：评估使用成熟的第三方库，节省开发时间，获得更多高级功能。</p>
</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67ea7de0de694ee38a2b407ab4c12946~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgREVNT-a0vg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324977&amp;x-signature=YZ1h74UefcJLpSi99oeUE8m1kwk%3D" alt="在这里插入图片描述" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[微信模板消息不能长期订阅？可以试试“用工关系“]]></title>    <link>https://juejin.cn/post/7587652709395677184</link>    <guid>https://juejin.cn/post/7587652709395677184</guid>    <pubDate>2025-12-26T04:44:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587652709395677184" data-draft-id="7587596841874341922" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="微信模板消息不能长期订阅？可以试试“用工关系“"/> <meta itemprop="keywords" content="微信小程序"/> <meta itemprop="datePublished" content="2025-12-26T04:44:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="沃夫上校"/> <meta itemprop="url" content="https://juejin.cn/user/3562891402822152"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            微信模板消息不能长期订阅？可以试试“用工关系“
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3562891402822152/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    沃夫上校
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T04:44:52.000Z" title="Fri Dec 26 2025 04:44:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">前言</h2>
<p>在微信小程序开发时，通常会有发送模板消息功能，但是微信的模板消息存在限制</p>
<p>大多数小程序资质，只能一次性订阅，不能长期订阅</p>
<blockquote>
<p>当然，也存在各种技巧，可以实现<strong>假性“长期订阅”</strong></p>
</blockquote>
<p>这种情况下，我们可以选择<strong>用工关系</strong>来达成我们这一需求</p>
<blockquote>
<p><strong>配合微信官方文档食用效果更佳</strong></p>
<p>文档地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fframework%2Fopen-ability%2Flaboruse%2Fintro.html" target="_blank" title="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/laboruse/intro.html" ref="nofollow noopener noreferrer">开放能力 / 用工关系</a></p>
</blockquote>
<h2 data-id="heading-1">用工关系是什么？</h2>
<blockquote>
<p>用工关系功能，支持与小程序有用工关系的用户能与对应的小程序进行绑定。绑定后</p>
<ul>
<li>小程序可以向已绑定的用户推送用工关系消息通知</li>
<li>绑定用户将能在微信「小程序助手」中接收用工关系消息通知</li>
</ul>
<p>通过这个功能，确保小程序在用工场景下的关键业务信息高效触达。</p>
</blockquote>
<p>如果存在发送微信消息进行通知的需求，就可以使用此功能进行实现</p>
<h2 data-id="heading-2">用工关系的前期准备</h2>
<h3 data-id="heading-3">1. 添加小程序类目</h3>
<p>此功能只支持<strong>非个人主体</strong>下的如下小程序类目</p>
<ul>
<li>物流服务/医疗服务/政务民生/金融业</li>
<li>教育服务/交通服务/房地产服务/生活服务</li>
<li>IT科技/餐饮服务/旅游服务/商家自营/商业服务</li>
</ul>
<blockquote>
<p>如果不巧你的类目不在里面，可以试试 <strong>商业服务 &gt; 软件/建站/技术开发</strong></p>
</blockquote>
<p>在添加支持的小程序类目，并且审核通过以后，可以在公众平台看到多了个<strong>行业能力 &gt; 用工关系</strong> 菜单</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe357af8e5224e50ab46ef51bb33b8ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKD5aSr5LiK5qCh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767329092&amp;x-signature=Q2RCcwrXP68jH6crlKn0A4XEsdU%3D" alt="467326da-3776-4f7f-a9d8-f04ee2e7211d.png" loading="lazy"/></p>
<p>看到这个，你的第一步就完成了</p>
<h3 data-id="heading-4">2. 开通功能</h3>
<p>点击<strong>用工关系</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52b87fa1f64e45308c7c4a9fc45b1c74~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKD5aSr5LiK5qCh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767329092&amp;x-signature=DFicAy6%2Fk4A3rSk4SsrBn6ALXTI%3D" alt="210266b7-1447-47f0-be40-d53a47d6bdd8.png" loading="lazy"/></p>
<p>再点击<strong>去开通</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e98472f71a948419535235cf54bbe8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKD5aSr5LiK5qCh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767329092&amp;x-signature=VH6EekBuHq3p2iJ12kMkXZAzW48%3D" alt="09fff195-95ee-458f-a219-9723af1682e5.png" loading="lazy"/></p>
<p>填入表单信息之后，点击<strong>提交</strong></p>
<p>然后等待审核，一般两三个小时就通过了</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6dcf4e9d3f664828bd8748207ced5a73~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKD5aSr5LiK5qCh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767329092&amp;x-signature=hVwxQvXaKsaUPJXCZAQOZuUnQoY%3D" alt="887f2903-af7f-49a0-adeb-64b5abd996dc.png" loading="lazy"/></p>
<p>看到这个，你的第二步也完成了</p>
<h3 data-id="heading-5">3. 新增用工消息模版</h3>
<p>我的模板，点击<strong>添加</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4018ed120f84d4b967a0b366da41e97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKD5aSr5LiK5qCh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767329092&amp;x-signature=8bPBb7szLgSv%2BStQlLhtrPOzvYc%3D" alt="66203a47-28fb-4842-8424-9d7a8787c35f.png" loading="lazy"/></p>
<p>填写模板信息</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85f013ae0c1449b5a3fb69de39462c4c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKD5aSr5LiK5qCh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767329092&amp;x-signature=990h82C8Q7WcOGllrS%2B7DXEWTbs%3D" alt="eacb228f-2d32-4c75-bee4-f431ca35de81.png" loading="lazy"/></p>
<blockquote>
<p><strong>注意</strong></p>
<ul>
<li>为增加审核通过几率，模板的<strong>发送场景说明</strong>写详细一点，具体使用场景是什么？怎么触发的消息？</li>
<li>另外，标题不能太宽泛，需要具体一点</li>
</ul>
<p>以下是错误示范</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efdd1861a1be4c89b861cb320e3237b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKD5aSr5LiK5qCh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767329092&amp;x-signature=0lfKUay9gCenvd1puPOvnuov2IA%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebb21e63b3da40dcac70765f859d46d2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKD5aSr5LiK5qCh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767329092&amp;x-signature=bmZejMdxCOXK26XUQpw0MakG6AI%3D" alt="image.png" loading="lazy"/></p>
</blockquote>
<p>填写好模板信息，就可以提交审核了</p>
<p>微信给出的审核时间是7-15天，实际上一天内就会审核完成</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed1456d53b99442aae3cb2eaf02b2db0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKD5aSr5LiK5qCh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767329092&amp;x-signature=UxGoYLGUwLk4hfqBF4aTxFy67Ng%3D" alt="image.png" loading="lazy"/></p>
<p>看到这个，你的第三步也完成了，前期准备阶段结束</p>
<h2 data-id="heading-6">怎么使用用工关系？</h2>
<p>这里有个原则：</p>
<ul>
<li>绑定<code>openid</code>，才能发送到具体人</li>
<li>绑定<strong>用工关系</strong>，才能接收消息</li>
<li>订阅<strong>消息模板</strong>，才能接收具体模板消息</li>
</ul>
<h3 data-id="heading-7">1. 绑定用工关系</h3>
<blockquote>
<p>绑定用工关系接口（前端调用）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fapi%2Fopen-api%2Femployee-relation%2Fwx.bindEmployeeRelation.html" target="_blank" title="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/employee-relation/wx.bindEmployeeRelation.html" ref="nofollow noopener noreferrer">wx.bindEmployeeRelation</a></p>
</blockquote>
<p>这个接口会拉起一个弹框，用户可以选择<strong>允许</strong>或<strong>拒绝</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3ce4120269c4912a7ba09eee14153e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKD5aSr5LiK5qCh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767329092&amp;x-signature=KrMXWDEm8Buw0TPOgqbNd98tKTg%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p><strong>注意</strong>，要是选择了<strong>拒绝</strong>，那么只能<strong>24小时</strong>之后才能再次绑定</p>
</blockquote>
<p>点击允许，会显示这样一个页面</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5bc3884a5e8e40ce88050e876a563633~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKD5aSr5LiK5qCh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767329092&amp;x-signature=TFdPub1N2fxFQOL%2Bi6aKjDx5glg%3D" alt="image.png" loading="lazy"/></p>
<p>因为我在<code>wx.bindEmployeeRelation</code>传入了<strong>模板id</strong></p>
<p>所以可以在绑定的同时，订阅消息模板</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/932d60ab025f42e9b2d8d50ef07e0fa6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKD5aSr5LiK5qCh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767329092&amp;x-signature=hdnB55muudbE3BqMaF%2Fx3bh4wX0%3D" alt="image.png" loading="lazy"/></p>
<p>绑定之后，你的<strong>微信首页</strong>会出现这样一个"小程序助手"</p>
<blockquote>
<p>后续<strong>消息</strong>也是发到这个里面</p>
</blockquote>
<p>点进去，可以看到</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44b7389edba14b739d91c4b4317b30b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKD5aSr5LiK5qCh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767329092&amp;x-signature=kza%2FmApH9P1%2F8dyz0cSR3%2B%2FFKV4%3D" alt="image.png" loading="lazy"/></p>
<p>观察到这个，第一步完成</p>
<h3 data-id="heading-8">2. 发送用工消息</h3>
<blockquote>
<p>推送用工消息接口（后端调用）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fserver%2FAPI%2Flaboruse%2Fapi_sendemployeerelationmsg.html" target="_blank" title="https://developers.weixin.qq.com/miniprogram/dev/server/API/laboruse/api_sendemployeerelationmsg.html" ref="nofollow noopener noreferrer">SendEmployeeRelationMsg</a></p>
</blockquote>
<p>先去微信公众平台，点进要发送的消息模板详情，右下角有个这样的东西</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08e840a92328438591c8a2be4a854ba3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKD5aSr5LiK5qCh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767329092&amp;x-signature=6fxLE4hwj8RW9Hx21uxZDviUfnA%3D" alt="image.png" loading="lazy"/></p>
<p>这个就是<strong>模板消息变量</strong>了，先记下来<code>thing1、time1</code>，后面会解释</p>
<p>我们可以设计一个这样的模板消息类（使用java实现，当然你也可以用其他语言）</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TemplateMessageVo</span> {
    <span class="hljs-meta">@Schema(description = "OPENID", required = true)</span>
    <span class="hljs-keyword">private</span> String touser;

    <span class="hljs-meta">@Schema(description = "模板ID", required = true)</span>
    <span class="hljs-keyword">private</span> String template_id;

    <span class="hljs-meta">@Schema(description = "模板跳转链接")</span>
    <span class="hljs-keyword">private</span> String page;

    <span class="hljs-meta">@Schema(description = "发送内容")</span>
    <span class="hljs-keyword">private</span> String data;
}
</code></pre>
<p>再构建一个消息发送测试方法</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Test</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">test</span><span class="hljs-params">()</span> {
    <span class="hljs-type">TemplateMessageVo</span> <span class="hljs-variable">params</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TemplateMessageVo</span>();
    params.setTouser(<span class="hljs-string">"接收消息用户的openid"</span>);
    params.setTemplate_id(<span class="hljs-string">"要发送的消息模板id"</span>);
    params.setPage(<span class="hljs-string">"要跳转的小程序页面"</span>);

    <span class="hljs-comment">// 使用 HashMap 构建数据结构</span>
    Map&lt;String, Object&gt; data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-comment">// 内层字段</span>
    Map&lt;String, String&gt; thing1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    charString1.put(<span class="hljs-string">"value"</span>, <span class="hljs-string">"1224-0059"</span>);

    Map&lt;String, String&gt; time1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
    amount1.put(<span class="hljs-string">"value"</span>, <span class="hljs-string">"2025年12月24日 08:11"</span>);

    <span class="hljs-comment">// 模板消息变量，有顺序要求</span>
    Map&lt;String, Object&gt; dataContent = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedHashMap</span>&lt;&gt;();
    <span class="hljs-comment">// 模板消息变量1</span>
    dataContent.put(<span class="hljs-string">"thing1"</span>, thing1);
    <span class="hljs-comment">// 模板消息变量2</span>
    dataContent.put(<span class="hljs-string">"time1"</span>, time1);

    data.put(<span class="hljs-string">"data"</span>, dataContent);

    <span class="hljs-type">String</span> <span class="hljs-variable">dataString</span> <span class="hljs-operator">=</span> JSON.toJSONString(data);
    params.setData(dataString);

    <span class="hljs-type">JSONObject</span> <span class="hljs-variable">messAge</span> <span class="hljs-operator">=</span> JSONObject.parseObject(JSONObject.toJSONString(params));
    System.out.println(messAge);

    <span class="hljs-comment">// 调用微信发送用工消息接口</span>
    wechatService.sendTemplateMessage(params);
}
</code></pre>
<p>可以看到，这里我们用上了上面说的<code>thing1、time1</code></p>
<p>有先后顺序要求，必须和模板里面的顺序保持一致</p>
<blockquote>
<p><strong>注意</strong>，模板变量的值，存在违禁词，比如要是这样写入变量</p>
<pre><code class="hljs language-java" lang="java">Map&lt;String, String&gt; thing1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
charString1.put(<span class="hljs-string">"value"</span>, <span class="hljs-string">"焚烧"</span>);
</code></pre>
<p>那调用微信接口时，会提示<strong>违禁词错误</strong></p>
<p>哪些是违禁词可以看下微信官方的违禁词规则</p>
</blockquote>
<p>调用成功之后，我们会在<code>小程序助手</code>中，看到这样一条消息</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84bbc8b7c5844492a39ca7d0777857a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKD5aSr5LiK5qCh:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767329092&amp;x-signature=BtPrjOtpmphKv62Eeww30iMqCiQ%3D" alt="image.png" loading="lazy"/></p>
<p>看到这个，就是发送成功了，第二步也成功完成了</p>
<p>至此，圆满结束</p>
<h2 data-id="heading-9">其他</h2>
<p>至于其他的像 解绑用工关系、检查用工关系、数据库同步等，可以按需求进行设计</p>
<p>这里提几个常见的坑</p>
<h3 data-id="heading-10">该功能有版本要求</h3>
<ul>
<li>支持基础库版本：3.10.0以上</li>
<li>支持微信版本：8.0.62以上</li>
</ul>
<h3 data-id="heading-11">该功能需要真机调试</h3>
<h3 data-id="heading-12">消息模板只能订阅一次，已经订阅过了再订阅会报错</h3>
<p>使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fapi%2Fopen-api%2Femployee-relation%2Fwx.bindEmployeeRelation.html" target="_blank" title="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/employee-relation/wx.bindEmployeeRelation.html" ref="nofollow noopener noreferrer">wx. bindEmployeeRelation</a> 或者 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fapi%2Fopen-api%2Femployee-relation%2Fwx.requestSubscribeEmployeeMessage.html" target="_blank" title="https://developers.weixin.qq.com/miniprogram/dev/api/open-api/employee-relation/wx.requestSubscribeEmployeeMessage.html" ref="nofollow noopener noreferrer">wx.requestSubscribeEmployeeMessage</a></p>
<p>如果在<code>wx. bindEmployeeRelation</code>已经订阅过模板了</p>
<p>再使用<code>wx.requestSubscribeEmployeeMessage</code>去订阅模板，会报错</p>
<h3 data-id="heading-13">data 参数格式</h3>
<p>调用发送消息接口<a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fserver%2FAPI%2Flaboruse%2Fapi_sendemployeerelationmsg.html" target="_blank" title="https://developers.weixin.qq.com/miniprogram/dev/server/API/laboruse/api_sendemployeerelationmsg.html" ref="nofollow noopener noreferrer">SendEmployeeRelationMsg</a>时，要特别注意<code>data</code>格式：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"template_id"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"bV8Jk-XXXXXX"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"page"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"page/XXX"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"touser"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"oL7T268t3zlOb64IvrN64-XXXXXX"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"{"</span>data<span class="hljs-string">":{"</span>character_string1<span class="hljs-string">":{"</span>value<span class="hljs-string">":"</span>aaa<span class="hljs-string">"},"</span>amount1<span class="hljs-string">":{"</span>value<span class="hljs-string">":"</span><span class="hljs-number">222</span><span class="hljs-string">"}}}"</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><code>data</code>的值是个json字符串，转化过来的<code>json</code>对象是这样的:</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"data"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"character_string1"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"aaa"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"amount1"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"222"</span>
    <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-14">参考信息</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fminiprogram%2Fdev%2Fframework%2Fopen-ability%2Flaboruse%2Fintro.html" target="_blank" title="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/laboruse/intro.html" ref="nofollow noopener noreferrer">开放能力 / 用工关系</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fcommunity%2Fdevelop%2Farticle%2Fdoc%2F000022f4470bc8e1a814e9c2f6b013" target="_blank" title="https://developers.weixin.qq.com/community/develop/article/doc/000022f4470bc8e1a814e9c2f6b013" ref="nofollow noopener noreferrer">微信开放社区 - 小程序-消息通知之“用工关系”开发过程记录</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue 表格 vxe-table 树结构实现单元格复制粘贴功能，实现树层级节点复制功能]]></title>    <link>https://juejin.cn/post/7587675443442778152</link>    <guid>https://juejin.cn/post/7587675443442778152</guid>    <pubDate>2025-12-26T05:25:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587675443442778152" data-draft-id="7587675306658463744" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue 表格 vxe-table 树结构实现单元格复制粘贴功能，实现树层级节点复制功能"/> <meta itemprop="keywords" content="Vue.js"/> <meta itemprop="datePublished" content="2025-12-26T05:25:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户467269559761"/> <meta itemprop="url" content="https://juejin.cn/user/907519374921993"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue 表格 vxe-table 树结构实现单元格复制粘贴功能，实现树层级节点复制功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/907519374921993/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户467269559761
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T05:25:47.000Z" title="Fri Dec 26 2025 05:25:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>vue 表格 vxe-table 树结构实现单元格复制粘贴功能，实现树层级节点复制功能；树结构默认是平级粘贴，可以通过 clip-config.isDeepPaste 启用深层数据结构的粘贴，需要注意树结构只支持 tree-config.transform 模式</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fvxetable.cn" target="_blank" title="https://vxetable.cn" ref="nofollow noopener noreferrer">vxetable.cn</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0189e76944d41028d4b69f0fde2e987~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NDY3MjY5NTU5NzYx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767331547&amp;x-signature=deIDEntIBdiG1WfENNYId1v01uQ%3D" alt="areaTreeClipDeep" loading="lazy"/></p>
<p>可以通过 clip-config.isDeepPaste 启用深层数据结构的粘贴</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">vxe-grid</span> <span class="hljs-attr">v-bind</span>=<span class="hljs-string">"gridOptions"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">vxe-grid</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { reactive } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">const</span> gridOptions = <span class="hljs-title function_">reactive</span>({
  <span class="hljs-attr">border</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">height</span>: <span class="hljs-number">500</span>,
  <span class="hljs-attr">showOverflow</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">keepSource</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">columnConfig</span>: {
    <span class="hljs-attr">resizable</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-attr">treeConfig</span>: {
    <span class="hljs-attr">transform</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">rowField</span>: <span class="hljs-string">'id'</span>,
    <span class="hljs-attr">parentField</span>: <span class="hljs-string">'parentId'</span>
  },
  <span class="hljs-attr">mouseConfig</span>: {
    <span class="hljs-attr">area</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 是否开启区域选取</span>
  },
  <span class="hljs-attr">areaConfig</span>: {
    <span class="hljs-attr">multiple</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 是否启用多区域选取功能</span>
  },
  <span class="hljs-attr">editConfig</span>: {
    <span class="hljs-attr">mode</span>: <span class="hljs-string">'cell'</span>, <span class="hljs-comment">// 单元格编辑模式</span>
    <span class="hljs-attr">trigger</span>: <span class="hljs-string">'dblclick'</span>, <span class="hljs-comment">// 双击单元格激活编辑状态</span>
    <span class="hljs-attr">showStatus</span>: <span class="hljs-literal">true</span>
  },
  <span class="hljs-attr">clipConfig</span>: {
    <span class="hljs-attr">isDeepPaste</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 是否深层粘贴，用于树结构，启用后粘贴时会覆盖到子级数据进行粘贴</span>
  },
  <span class="hljs-attr">keyboardConfig</span>: {
    <span class="hljs-attr">isClip</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否开启复制粘贴</span>
    <span class="hljs-attr">isArrow</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否开启方向键功能</span>
    <span class="hljs-attr">isShift</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否开启同时按住方向键以活动区域为起始，向指定方向扩展单元格区域</span>
    <span class="hljs-attr">isTab</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否开启 Tab 键功能</span>
    <span class="hljs-attr">isEnter</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否开启回车键功能</span>
    <span class="hljs-attr">isEdit</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否开启任意键进入编辑（功能键除外）</span>
    <span class="hljs-attr">isBack</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否开启Backspace键功能</span>
    <span class="hljs-attr">isDel</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否开启删除键功能</span>
    <span class="hljs-attr">isEsc</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 是否开启Esc键关闭编辑功能</span>
    <span class="hljs-attr">isFNR</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 是否开启查找与替换</span>
  },
  <span class="hljs-attr">columns</span>: [
    { <span class="hljs-attr">type</span>: <span class="hljs-string">'seq'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">80</span> },
    { <span class="hljs-attr">field</span>: <span class="hljs-string">'name'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'名称'</span>, <span class="hljs-attr">minWidth</span>: <span class="hljs-number">300</span>, <span class="hljs-attr">treeNode</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">dragSort</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">editRender</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'input'</span> } },
    { <span class="hljs-attr">field</span>: <span class="hljs-string">'size'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'大小'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">140</span>, <span class="hljs-attr">editRender</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'input'</span> } },
    { <span class="hljs-attr">field</span>: <span class="hljs-string">'type'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'类型'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">140</span>, <span class="hljs-attr">editRender</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'input'</span> } },
    { <span class="hljs-attr">field</span>: <span class="hljs-string">'createBy'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'创建人'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">200</span>, <span class="hljs-attr">editRender</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'input'</span> } },
    { <span class="hljs-attr">field</span>: <span class="hljs-string">'updateDate'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'修改时间'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">200</span>, <span class="hljs-attr">editRender</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'input'</span> } },
    { <span class="hljs-attr">field</span>: <span class="hljs-string">'createDate'</span>, <span class="hljs-attr">title</span>: <span class="hljs-string">'创建时间'</span>, <span class="hljs-attr">width</span>: <span class="hljs-number">200</span>, <span class="hljs-attr">editRender</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'input'</span> } }
  ],
  <span class="hljs-attr">data</span>: [
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10000</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'文件1.xlsx'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'xlsx'</span>, <span class="hljs-attr">size</span>: <span class="hljs-number">3200</span>, <span class="hljs-attr">createBy</span>: <span class="hljs-string">'王五'</span>, <span class="hljs-attr">updateDate</span>: <span class="hljs-string">'2020-09-11'</span>, <span class="hljs-attr">createDate</span>: <span class="hljs-string">'2020-08-01'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10050</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'部署目录'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">size</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">createBy</span>: <span class="hljs-string">'老六'</span>, <span class="hljs-attr">updateDate</span>: <span class="hljs-string">'2020-08-01'</span>, <span class="hljs-attr">createDate</span>: <span class="hljs-string">'2021-04-01'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">24300</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-number">10050</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'菜单配置.avi'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'avi'</span>, <span class="hljs-attr">size</span>: <span class="hljs-number">1024</span>, <span class="hljs-attr">createBy</span>: <span class="hljs-string">'小芳'</span>, <span class="hljs-attr">updateDate</span>: <span class="hljs-string">'2020-10-24'</span>, <span class="hljs-attr">createDate</span>: <span class="hljs-string">'2020-03-01'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">20045</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-number">24300</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'角色说明.html'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'html'</span>, <span class="hljs-attr">size</span>: <span class="hljs-number">600</span>, <span class="hljs-attr">createBy</span>: <span class="hljs-string">'老徐'</span>, <span class="hljs-attr">updateDate</span>: <span class="hljs-string">'2020-08-01'</span>, <span class="hljs-attr">createDate</span>: <span class="hljs-string">'2021-04-01'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">10053</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-number">24300</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'权限配置.avi'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'avi'</span>, <span class="hljs-attr">size</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">createBy</span>: <span class="hljs-string">'老胡'</span>, <span class="hljs-attr">updateDate</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">createDate</span>: <span class="hljs-string">'2021-04-01'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">24330</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-number">10053</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'部署秘钥.txt'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'txt'</span>, <span class="hljs-attr">size</span>: <span class="hljs-number">25</span>, <span class="hljs-attr">createBy</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">updateDate</span>: <span class="hljs-string">'2020-09-11'</span>, <span class="hljs-attr">createDate</span>: <span class="hljs-string">'2021-10-01'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">21011</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-number">10053</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'流程文档。pdf'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'pdf'</span>, <span class="hljs-attr">size</span>: <span class="hljs-number">512</span>, <span class="hljs-attr">createBy</span>: <span class="hljs-string">'老张'</span>, <span class="hljs-attr">updateDate</span>: <span class="hljs-string">'2021-08-01'</span>, <span class="hljs-attr">createDate</span>: <span class="hljs-string">'201-01-01'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">22200</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-number">10053</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'解决 bug 文件.js'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'js'</span>, <span class="hljs-attr">size</span>: <span class="hljs-number">1024</span>, <span class="hljs-attr">createBy</span>: <span class="hljs-string">'小刘'</span>, <span class="hljs-attr">updateDate</span>: <span class="hljs-string">'2020-10-24'</span>, <span class="hljs-attr">createDate</span>: <span class="hljs-string">'2021-06-01'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">23666</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'发版目录'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">size</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">createBy</span>: <span class="hljs-string">'老刘'</span>, <span class="hljs-attr">updateDate</span>: <span class="hljs-string">'2020-02-18'</span>, <span class="hljs-attr">createDate</span>: <span class="hljs-string">'2020-11-01'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">23677</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-number">23666</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'替换问题文件.js'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'js'</span>, <span class="hljs-attr">size</span>: <span class="hljs-number">1024</span>, <span class="hljs-attr">createBy</span>: <span class="hljs-string">'老冯'</span>, <span class="hljs-attr">updateDate</span>: <span class="hljs-string">'2019-09-11'</span>, <span class="hljs-attr">createDate</span>: <span class="hljs-string">'2021-06-01'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">23671</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-number">23677</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'发布流程.avi'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'avi'</span>, <span class="hljs-attr">size</span>: <span class="hljs-number">1024</span>, <span class="hljs-attr">createBy</span>: <span class="hljs-string">'小牛'</span>, <span class="hljs-attr">updateDate</span>: <span class="hljs-string">'2020-08-01'</span>, <span class="hljs-attr">createDate</span>: <span class="hljs-string">'2021-06-01'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">23672</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-number">23677</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'配置流程.mp4'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'mp4'</span>, <span class="hljs-attr">size</span>: <span class="hljs-number">1024</span>, <span class="hljs-attr">createBy</span>: <span class="hljs-string">'李四'</span>, <span class="hljs-attr">updateDate</span>: <span class="hljs-string">'2020-02-09'</span>, <span class="hljs-attr">createDate</span>: <span class="hljs-string">'2021-06-01'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">23688</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-number">23666</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'测试流程.mp4'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'mp4'</span>, <span class="hljs-attr">size</span>: <span class="hljs-number">1024</span>, <span class="hljs-attr">createBy</span>: <span class="hljs-string">'小三'</span>, <span class="hljs-attr">updateDate</span>: <span class="hljs-string">'2019-10-24'</span>, <span class="hljs-attr">createDate</span>: <span class="hljs-string">'2021-06-01'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">23681</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-number">23688</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'问题记录.txt'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'txt'</span>, <span class="hljs-attr">size</span>: <span class="hljs-number">1024</span>, <span class="hljs-attr">createBy</span>: <span class="hljs-string">'小李'</span>, <span class="hljs-attr">updateDate</span>: <span class="hljs-string">'2020-08-01'</span>, <span class="hljs-attr">createDate</span>: <span class="hljs-string">'2021-06-01'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">23682</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-number">23688</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'发布说明.html'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'html'</span>, <span class="hljs-attr">size</span>: <span class="hljs-number">1024</span>, <span class="hljs-attr">createBy</span>: <span class="hljs-string">'小徐'</span>, <span class="hljs-attr">updateDate</span>: <span class="hljs-string">'2021-02-18'</span>, <span class="hljs-attr">createDate</span>: <span class="hljs-string">'2021-06-01'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">24555</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'资源目录'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">size</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">createBy</span>: <span class="hljs-string">'小小'</span>, <span class="hljs-attr">updateDate</span>: <span class="hljs-string">'2020-08-01'</span>, <span class="hljs-attr">createDate</span>: <span class="hljs-string">'2020-10-01'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">24566</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-number">24555</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'铃声文件.mp3'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'mp3'</span>, <span class="hljs-attr">size</span>: <span class="hljs-number">1024</span>, <span class="hljs-attr">createBy</span>: <span class="hljs-string">'老八'</span>, <span class="hljs-attr">updateDate</span>: <span class="hljs-string">'2020-02-29'</span>, <span class="hljs-attr">createDate</span>: <span class="hljs-string">'2021-06-01'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">24577</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-number">24555</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'上线人员列表.xlsx'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'xlsx'</span>, <span class="hljs-attr">size</span>: <span class="hljs-number">1024</span>, <span class="hljs-attr">createBy</span>: <span class="hljs-string">'小红'</span>, <span class="hljs-attr">updateDate</span>: <span class="hljs-string">'2020-08-01'</span>, <span class="hljs-attr">createDate</span>: <span class="hljs-string">'2021-06-01'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">30000</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'评审目录'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">size</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">createBy</span>: <span class="hljs-string">'小何'</span>, <span class="hljs-attr">updateDate</span>: <span class="hljs-string">'2020-01-26'</span>, <span class="hljs-attr">createDate</span>: <span class="hljs-string">'2020-09-05'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">30001</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-number">30000</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'评审文件.xlsx'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'xlsx'</span>, <span class="hljs-attr">size</span>: <span class="hljs-number">36522</span>, <span class="hljs-attr">createBy</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">updateDate</span>: <span class="hljs-string">'2021-02-22'</span>, <span class="hljs-attr">createDate</span>: <span class="hljs-string">'2020-08-09'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">30010</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-number">30000</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'更多文件'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">size</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">createBy</span>: <span class="hljs-string">'小徐'</span>, <span class="hljs-attr">updateDate</span>: <span class="hljs-string">'2021-02-22'</span>, <span class="hljs-attr">createDate</span>: <span class="hljs-string">'2020-08-09'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">30011</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-number">30010</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'评审文件.xlsx'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'xlsx'</span>, <span class="hljs-attr">size</span>: <span class="hljs-number">36522</span>, <span class="hljs-attr">createBy</span>: <span class="hljs-string">'李四'</span>, <span class="hljs-attr">updateDate</span>: <span class="hljs-string">'2021-02-22'</span>, <span class="hljs-attr">createDate</span>: <span class="hljs-string">'2020-08-09'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">30012</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-number">30010</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'其他目录'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">size</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">createBy</span>: <span class="hljs-string">'老刘'</span>, <span class="hljs-attr">updateDate</span>: <span class="hljs-string">'2021-02-22'</span>, <span class="hljs-attr">createDate</span>: <span class="hljs-string">'2020-08-09'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">30102</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-number">30012</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'评审文件.xlsx'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'xlsx'</span>, <span class="hljs-attr">size</span>: <span class="hljs-number">36522</span>, <span class="hljs-attr">createBy</span>: <span class="hljs-string">'小康'</span>, <span class="hljs-attr">updateDate</span>: <span class="hljs-string">'2021-02-22'</span>, <span class="hljs-attr">createDate</span>: <span class="hljs-string">'2020-08-09'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">40000</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'文件4.xlsx'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'ppt'</span>, <span class="hljs-attr">size</span>: <span class="hljs-number">2048</span>, <span class="hljs-attr">createBy</span>: <span class="hljs-string">'王五'</span>, <span class="hljs-attr">updateDate</span>: <span class="hljs-string">'2020-10-04'</span>, <span class="hljs-attr">createDate</span>: <span class="hljs-string">'2020-11-07'</span> },
    { <span class="hljs-attr">id</span>: <span class="hljs-number">50000</span>, <span class="hljs-attr">parentId</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">'文件5.xlsx'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'pdf'</span>, <span class="hljs-attr">size</span>: <span class="hljs-number">3652</span>, <span class="hljs-attr">createBy</span>: <span class="hljs-string">'小张'</span>, <span class="hljs-attr">updateDate</span>: <span class="hljs-string">'2020-12-08'</span>, <span class="hljs-attr">createDate</span>: <span class="hljs-string">'2020-04-08'</span> }
  ]
})
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fx-extends%2Fvxe-table" target="_blank" title="https://gitee.com/x-extends/vxe-table" ref="nofollow noopener noreferrer">gitee.com/x-extends/v…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Mac M2安装OpenCV记录]]></title>    <link>https://juejin.cn/post/7587713001714810934</link>    <guid>https://juejin.cn/post/7587713001714810934</guid>    <pubDate>2025-12-26T03:16:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587713001714810934" data-draft-id="7587713001714253878" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Mac M2安装OpenCV记录"/> <meta itemprop="keywords" content="OpenCV"/> <meta itemprop="datePublished" content="2025-12-26T03:16:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Pavel同学"/> <meta itemprop="url" content="https://juejin.cn/user/1275089221590568"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Mac M2安装OpenCV记录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1275089221590568/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Pavel同学
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T03:16:40.000Z" title="Fri Dec 26 2025 03:16:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">OpenCV下载安装</h2>
<h3 data-id="heading-1">Python下使用</h3>
<p>建议直接通过 brew install opencv 安装最新版本
可以通过下面代码查看验证opencv版本，如果正常显示版本号就代表安装成功，可以正常使用了</p>
<pre><code class="hljs language-python" lang="python">    <span class="hljs-keyword">import</span> cv2
    <span class="hljs-built_in">print</span>(cv2.__version__)
    
    <span class="hljs-comment">#/PycharmProjects/med-alay/cv.py </span>
    <span class="hljs-comment">#4.12.0</span>
</code></pre>
<h3 data-id="heading-2">Java下使用</h3>
<h4 data-id="heading-3">源码下载</h4>
<p>在官网 <a href="https://link.juejin.cn?target=https%3A%2F%2Fopencv.org%2Freleases%2F" target="_blank" title="https://opencv.org/releases/" ref="nofollow noopener noreferrer">opencv.org/releases/</a> 下载最新4.12.0的source源码
下载好的源码放到 ~/opencv文件夹下,解压文件，进入源码目录创建build文件夹</p>
<pre><code class="hljs language-shell" lang="shell">    cd opencv-4.12.0
    mkdir build &amp;&amp; cd build
</code></pre>
<h4 data-id="heading-4">安装opencv_contrib</h4>
<p>在build目录下安装opencv_contrib</p>
<pre><code class="hljs language-shell" lang="shell">git clone https://github.com/opencv/opencv_contrib.git
cd opencv_contrib
git checkout 4.12.0
</code></pre>
<h4 data-id="heading-5">cmake安装</h4>
<pre><code class="hljs language-ini" lang="ini">在build目录下执行下面命令安装
这里注意 JAVA_HOME 环境变量需要设置好 我本地用的是jdk21
CMAKE_INSTALL_PREFIX 编译结果输出文件目录
在自己的jdk目录确认 JAVA_INCLUDE_PATH JAVA_AWT_LIBRARY JAVA_JVM_LIBRARY目录下对应是否存在配置的文件
-D <span class="hljs-attr">BUILD_opencv_java</span>=<span class="hljs-literal">ON</span> 设置成<span class="hljs-literal">ON</span>,在后续java工程中调用需要最终编译的jar文件
-D OPENCV_EXTRA_MODULES_PATH 设置成opencv_contrib目录下的moudles文件目录
</code></pre>
<pre><code class="hljs language-shell" lang="shell">cmake \
-DCMAKE_SYSTEM_PROCESSOR=arm64 \
-DCMAKE_OSX_ARCHITECTURES=arm64 \
-DWITH_OPENJPEG=OFF \
-DWITH_IPP=OFF \
-D CMAKE_BUILD_TYPE=RELEASE \
-D CMAKE_INSTALL_PREFIX=/usr/local/opencv \
-D JAVA_INCLUDE_PATH=$JAVA_HOME/include \
-D JAVA_AWT_LIBRARY=$JAVA_HOME/lib/libawt.dylib \
-D JAVA_JVM_LIBRARY=$JAVA_HOME/lib/server/libjvm.dylib \
-D BUILD_opencv_python2=OFF \
-D BUILD_opencv_java=ON \
-D INSTALL_PYTHON_EXAMPLES=OFF \
-D INSTALL_C_EXAMPLES=OFF \
-D BUILD_ZLIB=OFF \
-D OPENCV_ENABLE_NONFREE=ON \
-D OPENCV_EXTRA_MODULES_PATH=~/opencv/opencv-4.12.0/build/opencv_contrib/modules \
-D BUILD_EXAMPLES=ON ..
</code></pre>
<h4 data-id="heading-6">make</h4>
<p>表示使用全部8个内核来运行make指令，可以按实际硬件情况调整，过程大概5~20分钟</p>
<pre><code class="hljs language-shell" lang="shell"/></pre>
<p>make -j8</p>
<pre><code class="hljs"/></pre>
<h4 data-id="heading-7">安装</h4>
<pre><code class="hljs language-shell" lang="shell"/></pre>
<p>sudo make install</p>
<pre><code class="hljs"/></pre>
<h4 data-id="heading-8">Idea使用opencv配置</h4>
<p>在上面编译安装成功后会在 /usr/local/opencv/share/java/opencv4 文件夹下找到 opencv-4120.jar
在Idea lib里下添加jar包或者将jar包上传的到本地私库直接通过maven引用
maven坐标</p>
<pre><code class="hljs language-xml" lang="xml">    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.opencv<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>opencv<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.12.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>在Main方法中验证</p>
<pre><code class="hljs language-java" lang="java"/></pre>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> </span>{
    System.<span class="hljs-built_in">load</span>(<span class="hljs-string">"/usr/local/opencv/share/java/opencv4/libopencv_java4120.dylib"</span>);
    Mat image = Imgcodecs.<span class="hljs-built_in">imread</span>(<span class="hljs-string">"~/images/test.png"</span>);
    System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"width: "</span> + image.<span class="hljs-built_in">width</span>());
    System.out.<span class="hljs-built_in">println</span>(<span class="hljs-string">"height: "</span> + image.<span class="hljs-built_in">height</span>());
}
</code></pre>
<pre><code class="hljs"/></pre>
<p>如果能正常输出宽高则正常安装调试成功</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[国产AI大模型 Minimax M2.1效果相当惊艳，赶紧试试]]></title>    <link>https://juejin.cn/post/7587825267877724201</link>    <guid>https://juejin.cn/post/7587825267877724201</guid>    <pubDate>2025-12-26T05:44:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587825267877724201" data-draft-id="7587713001714696246" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="国产AI大模型 Minimax M2.1效果相当惊艳，赶紧试试"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-12-26T05:44:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逛逛GitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1442202996186093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            国产AI大模型 Minimax M2.1效果相当惊艳，赶紧试试
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442202996186093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逛逛GitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T05:44:17.000Z" title="Fri Dec 26 2025 05:44:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>01、炫酷的个人主页</p>
<p>提示词：请用 HTML + CSS + 原生 JS 写一个单文件的个人主页。要求：黑色背景，绿色霓虹字体，打字机效果输出文字，背景要有动态的矩阵代码雨（Matrix Rain）落下，并且包含一个入侵系统的按钮，点击后屏幕出现故障 Glitch 效果。然后展示一个叫张三的算法工程师的个人介绍。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f579d239b42a43cf8d5a0a05cb070eb0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767332657&amp;x-signature=mLxgx%2Bofyyb6mcBFmnlOn9PE%2BFE%3D" alt="image.png" loading="lazy"/></p>
<p>可以看大 M2.1 模型对 CSS 动画、Canvas 的掌控还是很好的，代码雨的效果也很惊艳。</p>
<p>02、炫酷高光卡片</p>
<p>最近有一个想法， 想做一个打卡的小应用。如果坚持打卡或达成了某种成就，奖励一个非常好看的虚拟纪念展示卡片。</p>
<p>以前写带有高光反射的卡片效果要很长时间，我让 M2.1 试了一下。</p>
<p>提示词：写一个展示球鞋的展示页面。使用 Tilt.js 的逻辑或者纯 CSS transform，当鼠标在卡片上移动时，卡片要跟随鼠标位置进行 3D 倾斜，并带有高光反射效果 Glassmorphism 玻璃拟态。布局要现代 minimalist，球鞋的可以直接拿我桌面上的图片。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c2eb95e4c424a049591a380b0c6c4b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767332657&amp;x-signature=vWxxm1%2Br%2BSSwUtOcGeb9IC7hwc8%3D" alt="image.png" loading="lazy"/></p>
<p>Cool！这就是我想要的效果。</p>
<p>可以看到 M2.1 对空间几何理解能力，以及对现代 UI 趋势玻璃拟态的理解还是比较好的。</p>
<p>03、模拟鸟群飞行</p>
<p>提示词：实现 Boids 算法的三个核心规则：分离（Separation）、对齐（Alignment）、内聚（Cohesion）。在屏幕上生成 100 个三角形代表鸟，增加一个捕食者（红点），鸟群需要自动躲避捕食者</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3dd75602f0dc48a3b9bf25f5525dc41b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767332657&amp;x-signature=pEGKclcZFyllxHgiBeAjzeaD%2Bhk%3D" alt="image.png" loading="lazy"/></p>
<p>这是经典的群体智能算法， M2.1 模型对向量计算的理解还是比较不错的。</p>
<p>我在玩的过程中，让我想到了拿网子去水里网鱼的体验。。。</p>
<p>同时你可以让 M2.1 使用其他语言再实现一下，比如使用 Python：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/017210b3fb8d461dbaee5330a0867798~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767332657&amp;x-signature=bYS5gb%2BArXrswMuiCJbHemV5ZzQ%3D" alt="image.png" loading="lazy"/></p>
<p>04、iOS APP 开发</p>
<p>提示词：用 SwiftUI 写一个 iOS App 原型。屏幕中间是一个木鱼。点击木鱼时：1. 播放敲击音效；2. 木鱼缩放动画；3. 屏幕飘出‘功德 +1’文字并渐渐消失。记录总功德数，保存在本地 UserDefaults 中</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e994b4cfc89447ba6ffc8184ed237e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767332657&amp;x-signature=DE9fEtB0Ydn65iMIfPwF%2Blw3Quo%3D" alt="image.png" loading="lazy"/></p>
<p>命令输入之后，M2.1 会自动帮你建立一个目录。这个小的 Demo 是打开可以直接运行的，没有报错。而且相关音效也指导你从网上下载下来，放到指定的文件夹里面。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97b2f1475a9e4c6e832298dd2365ec1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767332657&amp;x-signature=Q8i3xwcNApOrQdJmTyUnpuJlHD0%3D" alt="图片" loading="lazy"/></p>
<p>05、如何使用</p>
<p>我这里使用 Mac 基于 Claude Code + Minimax 2.1 举例子，如果是 Windows 或者 Linux 也类似，直接问 AI 就行了。</p>
<p>用量大的小伙伴可以试下 Coding plan 计划，都加持了最新的 M2.1 模型。并且支持图形理解、联网搜索 MCP。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08a8777aad2044e0b9790762bb0ef07b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767332657&amp;x-signature=sAls3SMBveirycKCXnPHcvOZedc%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">地址：https:<span class="hljs-comment">//platform.minimaxi.com/subscribe/coding-plan</span>
</code></pre>
<p>安装 Claude Code</p>
<pre><code class="hljs language-bash" lang="bash">npm install -g @anthropic-ai/claude-code
</code></pre>
<p>安装成功后，输入 Claude Code 如果能进去说明你安装成功了。此时可能会提示你 Unable to connect to Anthropic services，不用着急</p>
<p>创建密钥</p>
<p>你需要前往 Minimax 的开放平台，去创建一个新的密钥。</p>
<pre><code class="hljs language-vbnet" lang="vbnet">地址：https://platform.minimaxi.com/user-center/basic-information/<span class="hljs-keyword">interface</span>-<span class="hljs-keyword">key</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8fa7e9e0086e4b939dfa250cc39b4cc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767332657&amp;x-signature=w7BVfOzlrstHd9oZZBxLytDPeuI%3D" alt="图片" loading="lazy"/></p>
<p>创建完新的密钥一定要复制保存，因为这个密钥只会显示一次，没办法再次查看。</p>
<p>配置 Claude Code</p>
<p>然后打开你的 Terminal，输入下面的命令就行了。</p>
<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-keyword">export</span> ANTHROPIC_BASE_URL=<span class="hljs-string">"https://api.minimaxi.com/anthropic"</span><span class="hljs-keyword">export</span> ANTHROPIC_AUTH_TOKEN=<span class="hljs-string">"复制的 Key"</span><span class="hljs-keyword">export</span> API_TIMEOUT_MS=<span class="hljs-string">"3000000"</span><span class="hljs-keyword">export</span> <span class="hljs-built_in">CLAUDE_CODE_DISABLE_NONESSENTIAL_TRAFFIC</span>=<span class="hljs-string">"1"</span><span class="hljs-keyword">export</span> ANTHROPIC_MODEL=<span class="hljs-string">"MiniMax-M2.1"</span><span class="hljs-keyword">export</span> ANTHROPIC_SMALL_FAST_MODEL=<span class="hljs-string">"MiniMax-M2.1"</span><span class="hljs-keyword">export</span> ANTHROPIC_DEFAULT_SONNET_MODEL=<span class="hljs-string">"MiniMax-M2.1"</span><span class="hljs-keyword">export</span> ANTHROPIC_DEFAULT_OPUS_MODEL=<span class="hljs-string">"MiniMax-M2.1"</span><span class="hljs-keyword">export</span> ANTHROPIC_DEFAULT_HAIKU_MODEL=<span class="hljs-string">"MiniMax-M2.1"</span>
</code></pre>
<p>然后打开 Claude Code，显示 MiniMax-M2.1 就 ok 了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0035ac57bdb24d81bc8f1ecf1322a2c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767332657&amp;x-signature=mv2OblDNIiGSpjwvUEgLXY%2FP9f8%3D" alt="图片" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025 AI/Vibe Coding对我的影响：从效率革命到创作重构]]></title>    <link>https://juejin.cn/post/7587779957675229235</link>    <guid>https://juejin.cn/post/7587779957675229235</guid>    <pubDate>2025-12-26T05:46:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587779957675229235" data-draft-id="7587715742051729418" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025 AI/Vibe Coding对我的影响：从效率革命到创作重构"/> <meta itemprop="keywords" content="Trae"/> <meta itemprop="datePublished" content="2025-12-26T05:46:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="自由的疯"/> <meta itemprop="url" content="https://juejin.cn/user/3859724262192288"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025 AI/Vibe Coding对我的影响：从效率革命到创作重构
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3859724262192288/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    自由的疯
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T05:46:29.000Z" title="Fri Dec 26 2025 05:46:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>站在2025年末回望，这一年我的技术世界被两个关键词彻底重塑——AI Agent与Vibe Coding。作为一名深耕后端开发的程序员，年初我搜索的还只是「ChatGPT提升编码效率技巧」，年末收藏夹里已塞满「Vibe Coding协作框架」「轻量化Agent开发实践」等深度内容。这些技术不只是工具的迭代，更颠覆了我的工作模式、拓展了能力边界，甚至重塑了技术与生活的连接方式。</p>
<h2 data-id="heading-0">一、Vibe Coding：人机协作重构开发效率天花板</h2>
<p>今年最显著的改变，是从「指令式编码」转向了「Vibe Coding」的协作范式。最初接触这个概念，是看到陶哲轩用ChatGPT结合Lean证明助手完成复杂数学证明的案例——人类提供整体思路和直觉方向，AI即兴生成代码片段，再通过验证工具修正偏差，这种像「即兴合奏」的协作模式，让我彻底放弃了对AI的「命令式使用」。</p>
<p>我日常开发的核心工具是集成了Gemini 3的Cursor编辑器，这一年用它完成了3个核心项目的后端重构。放在去年，单是梳理旧系统的数据库关联关系、编写100+接口的单元测试，至少需要两周时间；而今年采用Vibe Coding模式，我只需向AI传递「高内聚低耦合」「兼容旧版接口」的核心诉求，它就能快速生成基础代码框架，再根据我给出的业务逻辑片段，补全数据校验、异常处理等细节。印象最深的是一次解决分布式锁死问题，我只描述了「并发场景下数据一致性异常」的现象，AI就主动猜测可能的诱因，生成3种解决方案的代码片段，还标注了每种方案的适用场景，最终帮我把问题排查时间从两天压缩到3小时。</p>
<p>这种协作并非无懈可击，AI常会在复杂逻辑处「跑调」——比如生成的代码忽略了分布式事务的边界条件，或是引用了已废弃的依赖包。但正如陶哲轩所说，人类的价值在于做「乐队指挥」：把控整体方向、修正偏差、在关键节点做出创造性决策。这一年我深刻体会到，Vibe Coding不是让AI替代开发者，而是把我们从重复性劳动中解放出来，专注于更有价值的架构设计和逻辑创新。据我粗略统计，今年的编码效率至少提升了60%，原本需要一周完成的迭代任务，现在3天就能高质量交付。</p>
<h2 data-id="heading-1">二、AI Agent：从工具到伙伴，突破个体能力边界</h2>
<p>如果说Vibe Coding提升了效率，那AI Agent则彻底拓宽了我的能力边界。今年中旬，我参与了一个轻量化创业项目，核心需求是开发一个面向中小企业的简易协作平台。放在过去，这样的项目需要前端、后端、运维至少3人协作一周才能完成原型；而这次我仅联合1名产品经理，借助AI Agent就实现了「一人多岗」的突破。</p>
<p>我们用自主部署的Agent工具链，将项目拆分为「接口开发」「前端原型」「文档生成」三个模块：后端逻辑通过Vibe Coding模式快速落地，前端原型由AI根据产品原型图自动生成基础代码，再由我微调样式和交互；最省心的是文档撰写——Agent能自动抓取代码注释，生成接口文档，还能根据开发日志生成每日进度报告。整个原型开发仅用了两天，这让我真切感受到李志飞所说的「10人军团撬动千亿市场」的轻量化创业魅力。</p>
<p>更意外的收获是，AI Agent让我有能力涉足原本陌生的领域。今年我尝试开发了一个个人用的旅行规划Agent，只需输入出行时间、预算、偏好，它就能生成详细的行程方案，还能自动抓取实时航班、酒店信息。这个过程中，我需要用到前端可视化、第三方API集成等原本不熟悉的技术，而AI Agent成了我的「实时导师」——从API调用规范到前端组件选型，随时能给出可落地的建议。这种「边学边做」的模式，让我在2025年完成了从「后端开发者」到「全栈实践者」的转型。</p>
<h2 data-id="heading-2">三、技术渗透生活：从编码到生活的Vibe延伸</h2>
<p>AI/Vibe Coding的影响不止于工作，更悄然融入了我的生活，让技术从「谋生工具」变成了「生活调剂」。今年暑假，我用AI Agent为家人规划了一场云南自驾之旅——通过自然语言描述「带老人和孩子、轻松节奏、偏爱自然景观」，Agent生成了3套行程方案，还自动标注了沿途的亲子设施和医疗点；遇到不确定的景点开放信息，它还能实时抓取官方公告进行更新。这场几乎零踩坑的旅行，让我第一次感受到技术服务生活的温度。</p>
<p>在个人成长方面，我用Vibe Coding模式学习了世界模型相关的前沿知识。面对Meta的V-JEPA 2这类复杂的技术文档，我不再是逐字啃读，而是让AI先提炼核心框架，再针对我不懂的「抽象表示空间预测」等概念，生成可视化的代码演示和简化案例。这种「人机协作学习」的模式，让我在短时间内理解了原本需要数月才能吃透的前沿技术，也让我意识到：未来的学习不再是个体的死记硬背，而是人机协同的高效认知。</p>
<h2 data-id="heading-3">四、2025年度感悟：在技术浪潮中锚定自身价值</h2>
<p>回望2025年，AI/Vibe Coding给我的最大启示，不是「技术如何替代人类」，而是「人类如何与技术共生」。这一年我也有过迷茫：当AI能在3小时生成3000行工业级代码，当Agent能独立完成项目原型，开发者的核心价值到底是什么？直到深入实践Vibe Coding我才明白，AI擅长的是执行和细节填充，而人类的核心竞争力在于创造力、判断力和共情能力——是对业务场景的深刻理解，是对架构设计的整体把控，是在技术选型时的权衡决策，这些都是当前AI无法替代的。</p>
<p>这一年的得失也很清晰：收获的是效率的跃升、能力的拓展和生活的便利，遗憾的是在追求效率的过程中，有过过度依赖AI的阶段，导致对部分基础技术的理解变得生疏。好在我及时调整了策略，将AI定位为「协作伙伴」而非「替代者」，在借助它提升效率的同时，坚持深入钻研核心技术原理。</p>
<p>展望2026，随着世界模型和具身智能的发展，AI与开发的协作将更深度、更自然。而我会继续以开放的心态拥抱技术变革，在Vibe Coding的协作模式中，持续打磨自己的核心竞争力——毕竟，技术浪潮永远向前，唯有锚定自身价值，才能在变革中站稳脚跟。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript性能优化：我用这7个V8引擎冷门技巧将页面加载速度提升了40%]]></title>    <link>https://juejin.cn/post/7587671647400214568</link>    <guid>https://juejin.cn/post/7587671647400214568</guid>    <pubDate>2025-12-26T04:16:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587671647400214568" data-draft-id="7587675443442597928" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript性能优化：我用这7个V8引擎冷门技巧将页面加载速度提升了40%"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-12-26T04:16:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript性能优化：我用这7个V8引擎冷门技巧将页面加载速度提升了40%
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T04:16:49.000Z" title="Fri Dec 26 2025 04:16:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>JavaScript性能优化：我用这7个V8引擎冷门技巧将页面加载速度提升了40%</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>在现代Web开发中，性能优化始终是一个绕不开的话题。随着前端应用越来越复杂，JavaScript的执行效率直接影响着用户体验。作为Chrome和Node.js的核心引擎，V8的性能特性往往决定了我们的代码能跑多快。本文将揭示7个鲜为人知的V8引擎优化技巧，这些技巧帮助我将实际项目的页面加载速度提升了惊人的40%。</p>
<p>大多数开发者都熟悉基础的性能优化手段，如减少DOM操作、使用事件委托等。但深入到V8引擎层面时，我们发现还有大量未被充分利用的优化机会。通过理解V8的内部工作机制——包括隐藏类（Hidden Classes）、内联缓存（Inline Caches）、涡轮扇（TurboFan）编译器等的运作原理，我们可以编写出更符合引擎特性的高效代码。</p>
<h2 data-id="heading-2">主体</h2>
<h3 data-id="heading-3">1. 利用隐藏类保持对象结构稳定</h3>
<p>V8使用隐藏类（Hidden Classes或称为Maps）来优化属性访问。当对象结构发生变化时，V8不得不创建新的隐藏类，这会带来性能开销。</p>
<p><strong>不推荐的写法：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> user = {};
  user.<span class="hljs-property">name</span> = <span class="hljs-string">'John'</span>;
  user.<span class="hljs-property">age</span> = <span class="hljs-number">30</span>;  <span class="hljs-comment">// 此时已创建一个隐藏类</span>
  <span class="hljs-keyword">delete</span> user.<span class="hljs-property">age</span>; <span class="hljs-comment">// 破坏隐藏类</span>
}
</code></pre>
<p><strong>优化的写法：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 一次性初始化所有属性</span>
  <span class="hljs-keyword">const</span> user = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'John'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-literal">null</span> <span class="hljs-comment">// 即使暂时不需要也预先声明</span>
  };
}
</code></pre>
<p>实测表明，在频繁创建对象的场景下，保持对象结构稳定可以减少约15%的执行时间。</p>
<h3 data-id="heading-4">2. 避免数字属性的"元素种类"转换</h3>
<p>V8对数组和类似数组的对象有精细的"元素种类"(Elements Kind)分类（如PACKED_SMI_ELEMENTS、HOLEY_DOUBLE_ELEMENTS等）。当数组中元素类型发生变化时，会导致昂贵的转换操作。</p>
<p><strong>不推荐的写法：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]; <span class="hljs-comment">// PACKED_SMI_ELEMENTS</span>
arr.<span class="hljs-title function_">push</span>(<span class="hljs-number">4.5</span>); <span class="hljs-comment">// 转换为PACKED_DOUBLE_ELEMENTS</span>
</code></pre>
<p><strong>优化的写法：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 如果知道会混合类型，一开始就用double类型</span>
<span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1.0</span>, <span class="hljs-number">2.0</span>, <span class="hljs-number">3.0</span>];
arr.<span class="hljs-title function_">push</span>(<span class="hljs-number">4.5</span>); <span class="hljs-comment">// No transition needed</span>
</code></pre>
<p>在数值计算密集的场景下，这种优化可以带来高达20%的性能提升。</p>
<h3 data-id="heading-5">3. Single-threaded模式的合理利用</h3>
<p>现代CPU都有多个核心，但JavaScript是单线程的。V8有一些针对单线程优化的内部机制：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Worker线程中：</span>
<span class="hljs-title class_">Atomics</span>.<span class="hljs-title function_">store</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Int32Array</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedArrayBuffer</span>(<span class="hljs-number">4</span>)),<span class="hljs-number">0</span>,<span class="hljs-number">123</span>);
<span class="hljs-comment">// Main线程中：</span>
<span class="hljs-keyword">while</span> (<span class="hljs-title class_">Atomics</span>.<span class="hljs-title function_">load</span>(sharedArray,<span class="hljs-number">0</span>) !==<span class="hljs-number">123</span>){}
</code></pre>
<p>虽然共享内存很强大但应谨慎使用。过度使用Worker间通信可能抵消并行计算的收益。</p>
<h3 data-id="heading-6">4. TurboFan友好的函数编写方式</h3>
<p>V8的TurboFan优化编译器会对热函数进行深度优化。要让你的函数能被TurboFan有效优化：</p>
<ul>
<li><strong>保持参数类型一致</strong>：混合类型会导致去优化(deoptimization)</li>
<li><strong>避免try-catch块</strong>：它们会显著影响TurboFan的优化能力</li>
<li><strong>限制函数大小</strong>：过大的函数难以被内联</li>
</ul>
<p>实测显示经过TurboFan优化的代码比基线编译器生成的代码快5-10倍。</p>
<h3 data-id="heading-7">5. ArrayBuffer和TypedArray的高效使用</h3>
<p>对于二进制数据处理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Allocate once, reuse many times:</span>
<span class="hljs-keyword">const</span> bufferPool = [];
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getBuffer</span>(<span class="hljs-params">size</span>) {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i =<span class="hljs-number">0</span>;i&lt;bufferPool.<span class="hljs-property">length</span>;i++){
        <span class="hljs-keyword">if</span>(bufferPool[i].<span class="hljs-property">byteLength</span>&gt;=size){
            <span class="hljs-keyword">return</span> bufferPool.<span class="hljs-title function_">splice</span>(i,<span class="hljs-number">1</span>)[<span class="hljs-number">0</span>];
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(size);
}

<span class="hljs-comment">// Usage:</span>
<span class="hljs-keyword">const</span> buf=<span class="hljs-title function_">getBuffer</span>(<span class="hljs-number">1024</span>);
<span class="hljs-comment">// ...after use...</span>
bufferPool.<span class="hljs-title function_">push</span>(buf);
</code></pre>
<p>这种方法避免了频繁的内存分配/回收开销，在处理大型二进制数据时可提升30%以上性能。</p>
<p>###18pt6. V8的内联缓存(IC)机制利用</p>
<p>V8使用多态内联缓存(Polymorphic Inline Cache)加速属性访问：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Bad:超过4种不同类型的value会导致megamorphic状态 </span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">process</span>(<span class="hljs-params">items</span>) {
    items.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(item.<span class="hljs-property">value</span>)); 
}

<span class="hljs-title function_">process</span>([{<span class="hljs-attr">value</span>:<span class="hljs-number">1</span>},{<span class="hljs-attr">value</span>:<span class="hljs-string">'a'</span>},{<span class="hljs-attr">value</span>:{}},{<span class="hljs-attr">value</span>:<span class="hljs-literal">true</span>}, {<span class="hljs-attr">value</span>:<span class="hljs-title class_">Symbol</span>()}]);
</code></pre>
<p>应将不同类型处理分开：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">processNumbers</span>(<span class="hljs-params">numbers</span>){<span class="hljs-comment">/*...*/</span>}
<span class="hljs-keyword">function</span> <span class="hljs-title function_">processStrings</span>(<span class="hljs-params">strings</span>){<span class="hljs-comment">/*...*/</span>}
</code></pre>
<p>这种改变在某些情况下减少了70%的属性查找时间。</p>
<p>###7.microtask与macrotask的精细控制</p>
<p>理解事件循环的不同阶段：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// MacroTask例子：</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">()=&gt;</span><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'timeout'</span>),<span class="hljs-number">0</span>);

<span class="hljs-comment">// MicroTask例子：</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">()=&gt;</span><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'promise'</span>));

<span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">()=&gt;</span>{
    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>().<span class="hljs-title function_">then</span>(heavyCalculation);<span class="hljs-comment">// Bad!</span>
});
</code></pre>
<p>应将耗时操作放在idle时期或Web Worker中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">requestIdleCallback</span>(<span class="hljs-function">(<span class="hljs-params">deadline</span>)=&gt;</span>{
    <span class="hljs-keyword">while</span>(deadline.<span class="hljs-title function_">timeRemaining</span>()&gt;<span class="hljs-number">0</span>){
        <span class="hljs-title function_">heavyChunkOfWork</span>();
    }
});
</code></pre>
<p>正确区分任务类型可显著改善主线程响应性。</p>
<p>##总结</p>
<p>深入理解V8引擎的工作原理不仅能帮助我们写出更高效的JavaScript代码，还能在前端性能优化的道路上走得更远。本文介绍的7个技巧——从隐藏类的维护到任务队列的控制——都是建立在对V8内部机制的深刻理解之上。</p>
<p>记住一点原则：最符合直觉的代码写法不一定是最优的执行路径。通过微观层面的调优积累起来的性能优势最终会转化为可观的用户体验提升。在你的下一个项目中尝试应用这些技术并测量实际效果吧！</p>
<p>最后要强调的是：任何没有测量依据的优化都是不可靠的。强烈建议在进行此类底层优化时使用Chrome DevTools的性能分析工具和Node.js的--trace-opt/--trace-deopt标志来验证你的改进确实产生了预期效果。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[若依审批流-委派]]></title>    <link>https://juejin.cn/post/7587779957674885171</link>    <guid>https://juejin.cn/post/7587779957674885171</guid>    <pubDate>2025-12-26T04:47:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587779957674885171" data-draft-id="7587715742051483658" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="若依审批流-委派"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-26T04:47:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码次位面"/> <meta itemprop="url" content="https://juejin.cn/user/1535333867720295"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            若依审批流-委派
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1535333867720295/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码次位面
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T04:47:35.000Z" title="Fri Dec 26 2025 04:47:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在审批流中，委派​ 是一种常见的操作，指的是当前审批人将本应由自己处理的任务，临时交给他人代为处理，但最终决策权和责任仍归属于原审批人。</p>
</blockquote>
<p>点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ruoyiflow.com" target="_blank" title="https://www.ruoyiflow.com" ref="nofollow noopener noreferrer">若依工作流</a>进行在线体验</p>
<h2 data-id="heading-0">工作原理</h2>
<p>审批流中的“委派”通常具备以下几个关键特点：</p>
<ul>
<li><strong>临时性与可逆性</strong>：委派通常是一种临时性的安排。例如，当正式审批人休假、出差或因其他原因暂时无法处理任务时，会进行委派。一旦原审批人恢复工作，委派关系可能就会结束。</li>
<li><strong>责任主体不变</strong>：尽管任务被交给他人处理，但<strong>最终的责任仍然由原审批人（即委派人）承担</strong>。被委派人的操作通常被视为替原审批人提供参考意见或初步处理。</li>
<li><strong>流程的可回溯性</strong>：在流程记录中，委派操作、被委派人的处理意见以及流程如何返回至原审批人，这些信息通常都会被记录下来，确保流程的透明和可追溯 。</li>
</ul>
<h2 data-id="heading-1">需求</h2>
<blockquote>
<p>假设现在有一个请假流程， 用户提交申请数据， 审批人将任务委派给另一个跟进，被委派人给出自己的意见后，任务继续流转到审批人。（类似虚线任务）</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/366a2d2bbc0741dd90d29a4f17d386a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5qyh5L2N6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767329255&amp;x-signature=ow1986tQNhJG9bIhCTlPpkmUxy8%3D" alt="image.png" loading="lazy"/></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">bpmn:definitions</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="hljs-attr">xmlns:bpmn</span>=<span class="hljs-string">"http://www.omg.org/spec/BPMN/20100524/MODEL"</span> <span class="hljs-attr">xmlns:bpmndi</span>=<span class="hljs-string">"http://www.omg.org/spec/BPMN/20100524/DI"</span> <span class="hljs-attr">xmlns:dc</span>=<span class="hljs-string">"http://www.omg.org/spec/DD/20100524/DC"</span> <span class="hljs-attr">xmlns:camunda</span>=<span class="hljs-string">"http://camunda.org/schema/1.0/bpmn"</span> <span class="hljs-attr">xmlns:di</span>=<span class="hljs-string">"http://www.omg.org/spec/DD/20100524/DI"</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Definitions_1"</span> <span class="hljs-attr">targetNamespace</span>=<span class="hljs-string">"http://bpmn.io/schema/bpmn"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:process</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Process_9729"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"请假流程"</span> <span class="hljs-attr">isExecutable</span>=<span class="hljs-string">"true"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:startEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Event_0ucy4xc"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:outgoing</span>&gt;</span>Flow_1fgnagb<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:outgoing</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:startEvent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Flow_1fgnagb"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"Event_0ucy4xc"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"Activity_04kx462"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Activity_04kx462"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"请假申请"</span> <span class="hljs-attr">camunda:assignee</span>=<span class="hljs-string">"${startUser}"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:extensionElements</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">camunda:formData</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">camunda:formField</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"type"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"请假类型"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"string"</span> /&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">camunda:formField</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"reason"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"请假理由"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"string"</span> /&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">camunda:formField</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"days"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"请假天数"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"long"</span> <span class="hljs-attr">defaultValue</span>=<span class="hljs-string">""</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">camunda:formData</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:extensionElements</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:incoming</span>&gt;</span>Flow_1fgnagb<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:incoming</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:outgoing</span>&gt;</span>Flow_0nrxozi<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:outgoing</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:userTask</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Flow_0nrxozi"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"Activity_04kx462"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"Activity_0qetwmj"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:userTask</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Activity_0qetwmj"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"直属领导审批"</span> <span class="hljs-attr">camunda:assignee</span>=<span class="hljs-string">"${candidate}"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:extensionElements</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">camunda:formData</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">camunda:formField</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"userComment"</span> <span class="hljs-attr">label</span>=<span class="hljs-string">"评论"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"string"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">camunda:formData</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:extensionElements</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:incoming</span>&gt;</span>Flow_0nrxozi<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:incoming</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:outgoing</span>&gt;</span>Flow_0bpj5l6<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:outgoing</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:userTask</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Flow_0bpj5l6"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"Activity_0qetwmj"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"Gateway_07216c1"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:exclusiveGateway</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Gateway_07216c1"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:incoming</span>&gt;</span>Flow_0bpj5l6<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:incoming</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:outgoing</span>&gt;</span>Flow_0uf4uhb<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:outgoing</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:outgoing</span>&gt;</span>Flow_1jmp8ly<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:outgoing</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:exclusiveGateway</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:endEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Event_0lhm65y"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:incoming</span>&gt;</span>Flow_0uf4uhb<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:incoming</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:endEvent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Flow_0uf4uhb"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"审批通过"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"Gateway_07216c1"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"Event_0lhm65y"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:conditionExpression</span> <span class="hljs-attr">xsi:type</span>=<span class="hljs-string">"bpmn:tFormalExpression"</span>&gt;</span>${approved == true}<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:conditionExpression</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:sequenceFlow</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:endEvent</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Event_0xmax1y"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:incoming</span>&gt;</span>Flow_1jmp8ly<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:incoming</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:endEvent</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:sequenceFlow</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"Flow_1jmp8ly"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"审批拒绝"</span> <span class="hljs-attr">sourceRef</span>=<span class="hljs-string">"Gateway_07216c1"</span> <span class="hljs-attr">targetRef</span>=<span class="hljs-string">"Event_0xmax1y"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">bpmn:conditionExpression</span> <span class="hljs-attr">xsi:type</span>=<span class="hljs-string">"bpmn:tFormalExpression"</span>&gt;</span>${approved==false}<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:conditionExpression</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:sequenceFlow</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:process</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">bpmn:definitions</span>&gt;</span>
</code></pre>
<h2 data-id="heading-2">演示效果</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d88418d30f9d4ab1b6876cf4e31d711a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5qyh5L2N6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767329255&amp;x-signature=pbmgy1y%2BsKILSw%2Bp2B%2BbBetwSkY%3D" alt="leave1" loading="lazy"/></p>
<blockquote>
<p>使用若依(ry)账号登陆系统，发起一个请假申请， 备注，测试委派， 注意，我同样选择了ry这个账户做审批人</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96cfebf844344529be7212c60abab853~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5qyh5L2N6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767329255&amp;x-signature=Q7I6AzHMQNKOrUSuJy6ioXhtnds%3D" alt="leave1" loading="lazy"/></p>
<blockquote>
<p>使用若依(ry)账号登陆系统，在待办任务，通过委派操作，将任务先转交给admin</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a2509a14707a4ab190cd9b4951756349~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5qyh5L2N6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767329255&amp;x-signature=Q%2Ff1gnu96r%2Fo9BKsJu%2BKJk9RDgs%3D" alt="leave1" loading="lazy"/></p>
<blockquote>
<p>使用管理员(admin)账号登陆系统， 在待办任务菜单中， 会看到一个带有审查操作的记录， 点击它给出意见。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f027f77ba45343a6b7330007f6dfd91a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5qyh5L2N6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767329255&amp;x-signature=0Dt1qBGV3rf5P0%2FdM8wOji1ACx8%3D" alt="leave1" loading="lazy"/></p>
<blockquote>
<p>使用若依(ry)账号登陆系统，在待办任务菜单， 将会看到任务重新回到自己清单中， 也看到了admin的意见。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3ed3aa504d546e8a4947853f656857a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Luj56CB5qyh5L2N6Z2i:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767329255&amp;x-signature=4JEZY2WwqY2an9XQhOlWceJSzDw%3D" alt="leave1" loading="lazy"/></p>
<blockquote>
<p>使用若依(ry)账号登陆系统，在待办任务中，执行通过，拒绝等操作， 时间线看到了最终效果。</p>
</blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.ruoyiflow.com" target="_blank" title="https://www.ruoyiflow.com" ref="nofollow noopener noreferrer">若依工作流</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[不如摸鱼去的 2025 年终总结，今年的关键词是直面天命]]></title>    <link>https://juejin.cn/post/7588022226738888754</link>    <guid>https://juejin.cn/post/7588022226738888754</guid>    <pubDate>2025-12-26T04:57:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7588022226738888754" data-draft-id="7587684397531365403" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="不如摸鱼去的 2025 年终总结，今年的关键词是直面天命"/> <meta itemprop="keywords" content="前端,年终总结"/> <meta itemprop="datePublished" content="2025-12-26T04:57:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不如摸鱼去"/> <meta itemprop="url" content="https://juejin.cn/user/26044011388510"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            不如摸鱼去的 2025 年终总结，今年的关键词是直面天命
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/26044011388510/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不如摸鱼去
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T04:57:43.000Z" title="Fri Dec 26 2025 04:57:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33f022bf5d7e47bdb10acf7d0e1f6dd8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767330052&amp;x-signature=IKuBf2QpssyNS35pQ25yhTvBCI0%3D" alt="" loading="lazy"/></p>
<p>大家好，我是不如摸鱼去。一转眼又到了年底总结的时候，在这一年我也步入了而立之年。</p>
<p>对我来说，2025 年是很不平凡的一年。工作上匆匆忙忙、连滚带爬、没有涨薪；开源分享和写文章取得了一定成果；生活上经历了父亲患癌治疗、人生第一次手术等变故。</p>
<p>总感觉人生的前三十年像是一直没长大，而世界却无法继续支持我维持这个状态。在学校的时候，每过一年就会有个考试告诉我“你升级了”；而离开学校后，只有残酷的现实跳出来告诉我：“小子，你得升级闯关了”。当然，通过之后得到的也不是分数，而是人生经历。</p>
<p>所以说，今年我的关键词是直面天命。人生是用来经历的，而不是被考核的，喜怒哀乐皆是天命。</p>
<h2 data-id="heading-0">关于工作</h2>
<p>关于工作的总结就是四个字：<strong>变化很小</strong>。</p>
<p>今年的工作也是匆匆忙忙、连滚带爬，只要肯干活，就有干不完的活。不过出来打工最重要的是赚钱，有工作干就已经很不错了（手动🐶）。</p>
<p>群里好几个小伙伴都经历了失业，后疫情 + AI 时代，前端的工作机会确实是少了。虽然宏观上工作机会的确少了，涨薪不易，但是具体到个人，还是得努力学习、完善自我，争取得到更好的工作和薪资。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d73e48d6ce04aab8818c2800fa42912~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767330052&amp;x-signature=7mBy%2BYDuaaN5N9Yk9igpVtBcFTo%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">关于生活</h2>
<h3 data-id="heading-2">父亲患病</h3>
<h4 data-id="heading-3">起初</h4>
<p>今年国庆节，我没有回家，和对象一起到哈尔滨旅游，去看了老虎、索菲亚教堂等等。准备去长白山的前一天，接到了我妹的电话，说我爸去医院看痔疮，医生说可能是不好的东西。我当时脑子都懵了，赶紧买了票从哈尔滨连夜回到了商丘老家，路上哭了几次。</p>
<h4 data-id="heading-4">到上海治疗</h4>
<p>回到家，医生找我谈话，判断下来是直肠CA，县里医院也能做，让我考虑一下是不是在这个医院治疗。唉，这块也没了解过，完全是个盲区。</p>
<p>连夜了解了相关的知识后，还是决定到上海来看病，于是买了第二天的票带我爸到了上海。到复旦肿瘤医院交病理、看医生、住院、手术、造口护理、化疗，直到今天已经接近两个月了。中间请了一个月的假陪我父亲看病。看病陪护的日子感觉好长好长，一周像是过了一年，每天都在恶补相关的知识。还好有我两个妹妹和我对象在，帮我爸度过了最艰难的日子。</p>
<h4 data-id="heading-5">费用</h4>
<p>我爸是河南的农村医保，并且买了个重疾险。来到上海是异地就医，办理了临时异地就医（其实直接办长期就行，报销比例会高点），住院大概有 50% 的报销比例。</p>
<p>总体医保结算后的费用大概是自己付了 6.1 万，然后保险赔付了 4.9 万。不过有很多非医院的付费项目不能报销，大概整个手术下来有个 4 万左右的自费费用吧。目前还在化疗中，费用比较分散，还没有统计。</p>
<h4 data-id="heading-6">小结</h4>
<p>其实我爸并不是痔疮。痔疮人人都有，两年前他有点便血，我让他去医院检查，但是他不愿意去（据他解释是听村里人说痔疮做手术会失禁），害怕做手术。去年年底回家问他还有症状吗，他说已经好了。其实他都是装的，八九月份突然暴瘦了，感觉不对劲才去的医院。</p>
<p>唉，要是早点催他去医院检查，就能有更好的治疗方案了。有钱难买早知道，遇事只能向前看，尽力配合医生治疗，希望能够早日康复起来！</p>
<h3 data-id="heading-7">我的人生第一次手术</h3>
<p>2023 年阳康之后，我不幸得了肛周脓肿，也是个难受的病，去医院做了个门诊切开引流术。本来准备 2025 年国庆节之后做个根治手术解决这个问题，没想到赶上我爸罹患了直肠 CA。</p>
<p>本月初，我爸情况稳定之后，我在仁济医院做了人生第一次全麻手术。全麻的感觉很奇妙，进去的时候还在跟麻醉医生聊天，说了几句话后就没有知觉了，随后醒来就是在复苏室了。</p>
<p>据说人从肛肠科出来后，都会成长不少😭。</p>
<p>目前还在康复中，非常感谢我对象在我康复的过程中帮助我换药，陪我去医院复诊。整个术后的过程，前三天就是疼疼疼，前两周就是上厕所疼。医生说真男人坚持一个月就是康复了😂。</p>
<h3 data-id="heading-8">游戏</h3>
<p>去年《黑神话·悟空》很火，它是第一部国产 3A 大作，我也买了，并且还做完了成就，体验下来非常不错。其实我也没有玩过什么 3A，只是感觉自己要去玩一玩。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edd8f5bd675a42f6a5d82b87ad07d886~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767330052&amp;x-signature=YANJivNwLwhtaeeafQOhJUj%2Buno%3D" alt="" loading="lazy"/>
《黑神话·悟空》的画面很精美，游戏也很好玩，真的很期待DLC。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8853f0b82784fecb6ddc197ea721469~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767330052&amp;x-signature=QPUf782AW8%2BRfTWXwp7NjhbA5FA%3D" alt="" loading="lazy"/>
拔根猴毛来拜一拜，调息中...
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af6481443f9b483383869d1b8f2619e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767330052&amp;x-signature=TLnTxhNpem1qhJp8xCk%2BT30xyC4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">养鱼</h3>
<p>2023 年居家隔离结束的时候，起了个草缸，买了点青鳉养了养，现在又养了点白云金丝和斗鱼。这些鱼都挺好养的，斗鱼的互动性还很强，平时喂鱼跟喂狗一样，一摆手鱼就过来了。写代码累了，就来和鱼们玩一玩，休息休息，哈哈。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f37c23d2389242218a8d995260fa2389~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767330052&amp;x-signature=3auPGy2BT9W5h%2FN7%2Bcbijw3n5I0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">领养小猫</h3>
<p>我对象一直想养个猫，于是在这周领养了一只小黑猫，暂时取名小黑毛。来了几天了，逐渐熟络了。</p>
<p>它长这样：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2948eba30d084ed9a103ebf4362ec5b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767330052&amp;x-signature=X%2BIYp0PeoJiogo515%2FBebM6X7Y0%3D" alt="" loading="lazy"/></p>
<p>这样：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b0d862dfd624e5caa9efbf3da63db48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767330052&amp;x-signature=dhooIyEL1L6cUgnzvhYn%2F73RwhI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">小结</h3>
<p>生活总是是五味杂陈的，不能一直甜也没有一直苦，九九百十一难都走过了，还怕这小小生活吗，哈哈，共勉。</p>
<h2 data-id="heading-12">开源分享</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/173fe44837a9459f9e1d1d95f19924c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767330052&amp;x-signature=%2B%2FysM6Xl3UrUO%2Bo0%2FXuHt%2BFOvc8%3D" alt="" loading="lazy"/></p>
<p>参与开源项目是个人成长最好的方式之一。不过很遗憾，由于家里和自身身体上的一些原因，近两个月很少在开源项目上投入精力，看看我的GitHub 2025总结吧。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e33f5ff20e7e4c3aafe4a2a9b8cfd8fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767330052&amp;x-signature=4%2BZxSueE514RcG%2F6khewjnARIzs%3D" alt="" loading="lazy"/>
以下是我创建和参与的开源项目，欢迎一起参与！</p>
<ul>
<li><strong>wot-ui</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwot-ui.cn%2F" target="_blank" title="https://wot-ui.cn/" ref="nofollow noopener noreferrer">wot-ui.cn/</a><br/>
一个基于 Vue3 + TS 开发，提供 70+ 高质量组件，支持暗黑模式、国际化和自定义主题，高颜值、轻量化的 uni-app 组件库。</li>
<li><strong>wot-starter</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fstarter.wot-ui.cn%2F" target="_blank" title="https://starter.wot-ui.cn/" ref="nofollow noopener noreferrer">starter.wot-ui.cn/</a><br/>
飞一般开发体验的 uni-app 模板。</li>
<li><strong>uni-mini-ci</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMoonofweisheng%2Funi-mini-ci" target="_blank" title="https://github.com/Moonofweisheng/uni-mini-ci" ref="nofollow noopener noreferrer">github.com/Moonofweish…</a><br/>
一个 uni-app 小程序端构建后支持 CI（持续集成）的插件。</li>
<li><strong>@wot-ui/router</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fwot-ui%2Fmy-uni" target="_blank" title="https://github.com/wot-ui/my-uni" ref="nofollow noopener noreferrer">github.com/wot-ui/my-u…</a><br/>
一个轻量级 uni-app 路由库。</li>
<li>等等...</li>
</ul>
<p>当然，你可以到我的 GitHub 主页 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMoonofweisheng" target="_blank" title="https://github.com/Moonofweisheng" ref="nofollow noopener noreferrer">github.com/Moonofweish…</a> 探索更多我的开源项目。</p>
<h2 data-id="heading-13">团队成员、朋友们和贡献者</h2>
<h3 data-id="heading-14">团队成员</h3>
<p>我们的小开源团队，已经初具规模，以吾观之，也是人才济济啊。</p>
<ul>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fskiyee" target="_blank" title="https://github.com/skiyee" ref="nofollow noopener noreferrer">Skiyee</a></strong>： <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Funi-ku" target="_blank" title="https://github.com/uni-ku" ref="nofollow noopener noreferrer">uni-ku</a> 的创立者，重金雇佣兵，精通 JS 和 TS 的全能攻城狮。</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F810505339" target="_blank" title="https://github.com/810505339" ref="nofollow noopener noreferrer">二狗</a></strong>：灵活就业大师，问题毁灭者，总能迅速解决各种技术难题。</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjasper-ops" target="_blank" title="https://github.com/jasper-ops" ref="nofollow noopener noreferrer">Jasper</a></strong>：新技术狂热分子，始终走在技术前沿，热衷于探索最新的开发趋势。</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FYahaneXY" target="_blank" title="https://github.com/YahaneXY" ref="nofollow noopener noreferrer">兔子不想和你说话</a></strong>：萌新守卫者，耐心指导新手，帮助他们快速成长。</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FRJQingHuan" target="_blank" title="https://github.com/RJQingHuan" ref="nofollow noopener noreferrer">人间有味是清欢</a></strong>：Pull Shark，热衷参与开源组件建设。</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTAYUN" target="_blank" title="https://github.com/TAYUN" ref="nofollow noopener noreferrer">云阁</a></strong>：新晋队员，初生牛犊猛如虎。</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FXiabaiyou" target="_blank" title="https://github.com/Xiabaiyou" ref="nofollow noopener noreferrer">百友</a></strong>：新晋队员，失业再就业专家。</li>
<li><strong><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxiaohe0601" target="_blank" title="https://github.com/xiaohe0601" ref="nofollow noopener noreferrer">xiaohe0601</a></strong>：新晋队员，uni-echarts 创立者，nutui-uniapp的 维护者，npm Trusted Publisher 发包大师。</li>
</ul>
<p>同时也结交了很多社区朋友，像来自<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Funi-helper" target="_blank" title="https://github.com/uni-helper" ref="nofollow noopener noreferrer">uni-helper</a>团队的各位好朋友们，大哥 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FModyQyW" target="_blank" title="https://github.com/ModyQyW" ref="nofollow noopener noreferrer">ModyQyW</a>，FD 哥 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FFliPPeDround" target="_blank" title="https://github.com/FliPPeDround" ref="nofollow noopener noreferrer">FliPPeDround</a>等等，还有来自<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Funibest-tech%2Funibest" target="_blank" title="https://github.com/unibest-tech/unibest" ref="nofollow noopener noreferrer">unibest</a>的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ffeige996" target="_blank" title="https://github.com/feige996" ref="nofollow noopener noreferrer">菲鸽</a>，还有我的群友们，也非常感谢他们。</p>
<h3 data-id="heading-15">贡献者</h3>
<p>我们有八十多个贡献者，经常贡献的朋友也有很多个，非常感谢这些朋友们。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62755ff212ea4e31b3a2487a9741d4b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767330052&amp;x-signature=fHUO%2BI1pvKwmY8poXOeF5vq0ICc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-16">2k Star 以及获奖啦</h3>
<p>GitHub 达到 2k Star。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b0a0a92f3344ed89bf922c15f87ac81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767330052&amp;x-signature=6TaMdZrRDKX8M38O%2BivQjvfskiU%3D" alt="" loading="lazy"/></p>
<p>在 DCloud 2025 插件大赛中获得了一个小奖，也是很高兴的一个事情。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18a00af862ec4ca1b280e47e3be0b1cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767330052&amp;x-signature=5VXA0MfsVvUcslmpib710QjlxqY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-17">社群</h3>
<p>目前已经创建了 3 个 QQ 互助交流群和 2 个微信互助交流群，群友人数达到了 2k 以上了😌。</p>
<h2 data-id="heading-18">写文章</h2>
<p>2025 年，我在尝试写文章分享一些前端和 AI 编程相关的知识和最佳实践，例如公众号、掘金、CSDN、小红书、抖音等等。不过在这方面，我还是个拙劣的模仿者，探索中...</p>
<p>目前已经写了几十篇文章，内容主要分为了四个专栏，分别是：uni-app 最佳实践、AI 编程提效、wot-ui 开发指南和前端百宝箱，主要是沉淀和分享我的一些实践和方案。我用 AI 总结了今年的主要内容，做了手绘图如下。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8852fa03dd8c4cc493c4e2373a6374c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767330052&amp;x-signature=kEEkJgjmAMV%2BmuZXW6iprfl5qNk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1bf4103f9fb74884924f7af67688d52f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767330052&amp;x-signature=CrpuAuIMGW%2F64Wfdpc1FV5qw%2FVk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/26cdec778f0b4d788e5bd2a7cb94da36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767330052&amp;x-signature=cnFaItJADy1x4T1T%2Fa5lsIzv8jQ%3D" alt="" loading="lazy"/>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9cefebc525e3428da75574639c97cb30~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767330052&amp;x-signature=hEAfrWeoG0e2fmoVHZbj3TaOIEQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-19">小结</h3>
<p>写文章这方面，我是刚刚起步，希望可以作为一个自身的积累，也可以作为一个副业，同时希望可以和大家多多交流、分享。</p>
<h2 data-id="heading-20">AI Coding</h2>
<p>2024 年以来，AI Coding 取代前端开发的论调层出不穷，出一个新的大模型，前端就会死一次。</p>
<p>虽然不想承认，但是 AI Coding 的确是在推动一场信息行业的工业革命，它正在重塑整个行业的工作流。</p>
<p>不过目前 AI Coding 仍然没有替代任何一个职业，“AI 落地的最后一公里”仍未解决，人仍然在 AI Coding 中扮演着决策者和指导者的角色。</p>
<p>尽管当前 AI Coding 的脉络仍未清晰，但是 AI Coding 未来确实无比值得期待。所以我们要拥抱变化，拥抱未来，拥抱 AI Coding。</p>
<p>我也在努力探索 AI Coding 工具在前端开发上的落地，写了多篇文章被 Trae 公众号收录为最佳实践。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7e2c5a3249e4962b454e3c14bb082c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767330052&amp;x-signature=WKbq7uSfF45kv16%2FHjbZFdn9ZuI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/75190809620a4387b1b62abcbbae577f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767330052&amp;x-signature=unvlVdqNLo0Ha87V%2FcP6G1KPHdQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b09cac3b7bf4f198b3e4a0ec43b0e82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767330052&amp;x-signature=8QtmssF6kfLnd1ThEL1OOaZ%2Fy14%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b4338dcd3f0413fa8f3494515208e2f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5aaC5pG46bG85Y67:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767330052&amp;x-signature=j40GaIqJA8MbaUSwM3ChD4BzgzM%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-21">总结与展望</h2>
<h3 data-id="heading-22">2025 总结</h3>
<p>2025 年对我来说是不平凡的一年，很多事情催人成长。坎坷再多也无需多言，只得直面天命，每个人都是自己的大圣、自己的天命人。</p>
<h3 data-id="heading-23">2026 展望</h3>
<p>2026 年，希望我爸快快康复，希望我的家人、各位和家人身体都健健康康的，也希望自己工作顺利，并且能将我的开源项目、写文章、自媒体的想法能够做得更好，目标就不详细列出来了，有的时候计划不如变化啊。</p>
<p><em><strong>欢迎评论区沟通、讨论、分享👇👇</strong></em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🏆2025 AI/Vibe Coding 对我的影响 | 年终技术征文]]></title>    <link>https://juejin.cn/post/7587675443442450472</link>    <guid>https://juejin.cn/post/7587675443442450472</guid>    <pubDate>2025-12-26T03:04:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587675443442450472" data-draft-id="7586836874016751626" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🏆2025 AI/Vibe Coding 对我的影响 | 年终技术征文"/> <meta itemprop="keywords" content="前端,后端,人工智能"/> <meta itemprop="datePublished" content="2025-12-26T03:04:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="掘金酱"/> <meta itemprop="url" content="https://juejin.cn/user/1556564194374926"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🏆2025 AI/Vibe Coding 对我的影响 | 年终技术征文
            <!----> <!----></h1> <div class="container team-follow" data-v-d326b38e="" data-v-61fb5e44=""><div class="left" data-v-d326b38e=""><a href="/team/7255271989291450420/posts" data-v-d326b38e=""><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7b3e5e62bb3a4eff89269d51825c4a1f~tplv-k3u1fbpfcp-watermark.image?" class="icon" data-v-d326b38e=""/></a> <div class="content" data-v-d326b38e=""><div style="display: flex" data-v-d326b38e=""><a href="/team/7255271989291450420/posts" data-v-d326b38e=""><p class="title-line" data-v-d326b38e=""><span title="掘金运营团队" class="title" data-v-d326b38e="">掘金运营团队</span> <img src="//lf-web-assets.juejin.cn/obj/juejin-web/xitu_juejin_web/255e400027b783cbad76dc41527e7695.svg" alt="team icon" class="team-icon" data-v-d326b38e=""/></p></a></div> <div class="meta-box team" data-v-d326b38e="" data-v-61fb5e44=""><time datetime="2025-12-26T03:04:16.000Z" title="Fri Dec 26 2025 03:04:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-d326b38e="" data-v-61fb5e44="">
                2025-12-26
              </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-d326b38e="" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/></svg> <span class="views-count" style="display:none;" data-v-d326b38e="" data-v-61fb5e44="">
                32
              </span> <span class="read-time" data-v-d326b38e="" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-d326b38e="" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-d326b38e="" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-d326b38e="" data-v-61fb5e44=""/></svg>
                阅读6分钟
              </span> <!----> <!----></div></div></div> <button class="jj-follow-button follow-btn" style="display:none;" data-v-b60b2868="" data-v-d326b38e=""><span data-v-b60b2868="" data-v-d326b38e=""><i class="byte-icon byte-icon--plus" data-v-d326b38e=""><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 48 48"><path fill="none" d="M0 0h48v48H0z"/><path d="M24.7 4c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8V22h16.7c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8v1.4c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1H26v16.7c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1h-1.4c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8V26H5.3c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8v-1.4c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1H22V5.3c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1h1.4z"/></svg></i>
        关注
      </span></button></div> <div class="team-user block-hidden" data-v-61fb5e44=""><div class="avatar jj-avatar avatar" data-v-03256cc6="" data-v-61fb5e44=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="avatar" class="lazy avatar-img" data-v-5244ef91="" data-v-03256cc6=""/> </div> <!----> <span class="position ellipsis" data-v-61fb5e44="">
              ❤首席客服君 @掘金
            </span></div> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.7;font-weight:400;font-size:16px;overflow-x:hidden;color:#2c3e50;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Fira Sans,Droid Sans,Helvetica Neue,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;font-weight:600;margin-top:35px;margin-bottom:8px;padding-bottom:5px}.markdown-body h1 :before,.markdown-body h2 :before,.markdown-body h3 :before,.markdown-body h4 :before,.markdown-body h5 :before,.markdown-body h6 :before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:8px;margin-top:50px;font-size:24px;border-bottom:1px solid #eaecef}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #eaecef;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;font-weight:400;background-color:rgba(27,31,35,.05);color:#476582;margin:0;font-size:.85em;border-radius:3px;font-size:.87em;padding:.165em .5em}.markdown-body code,.markdown-body pre{font-family:source-code-pro,Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.6;padding:20px 24px;background-color:#282c34;border-radius:6px}.markdown-body pre&gt;code{font-size:14px;padding:0;margin:0;word-break:normal;display:block;overflow-x:auto;color:#fff}.markdown-body a{text-decoration:none;color:#3eaf7c;font-weight:500}.markdown-body a:active,.markdown-body a:hover{color:#42b983;border-bottom:1px solid #42b983}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;margin:16px 0;border-collapse:collapse}.markdown-body thead{background:#f6f6f6;background:#3eaf7c;color:#000;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f6f8fa}.markdown-body td,.markdown-body th{border:1px solid #dfe2e5;padding:10px 16px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{font-size:14px;padding:6px 23px;margin:22px 0;border-left:6px solid #42b983;background-color:#f3f5f7;font-weight:400}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body p,.markdown-body ul{line-height:1.7}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="base16/tomorrow-night">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d4ef939034d4f9e8f6f5798c339e98d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767323834&amp;x-signature=J1QOhizcBRAyjdlcthKi9thLZXY%3D" alt="img_v3_02t9_51022880-c5f3-4f3c-8892-b6f6ca1ba8eg.png" loading="lazy"/></p>
<p>当岁末的钟声临近，我们又站在了一年的重点回望。2025年，对你而言，是怎样的轮廓呢？</p>
<p>它或许是由一行行被AI重构的代码勾勒，是某个深夜与新技术“顿悟时刻”的灵光一现，也可能是生活中因为智能体工具而悄然改变的工作状态。</p>
<p>从智能体（Agent）的横空出世到多模态技术的经验突破，技术愈加深入地流淌尽我们的工作和生活日常，塑造着属于每个人的独特“Vibe”。</p>
<p>今天，稀土掘金正式发起这场专属社区的<strong>年终“围炉夜话”</strong> ，我们不谈宏大的行业预言，不设苛刻的评审框架。我们只想邀请您，记录下属于你的数字年轮。</p>
<h2 data-id="heading-0">✨主题 ：2025 AI/Vibe Coding对我的影响</h2>
<p>本次征文不再是一场竞赛，而是一次社区的年终“围炉夜话”。我们鼓励所有成员停下脚步，回望2025年技术与个人生活交织的痕迹。无论是代码世界的深刻变革，还是AI工具带来的细微习惯改变，每一次记录，都是我们共同的“数字年轮”。</p>
<h2 data-id="heading-1">⁉️如何参与</h2>
<p>发布文章时选择带话题 <strong><a href="https://juejin.cn/theme/detail/7586482726807535666?contentType=1" target="_blank" title="https://juejin.cn/theme/detail/7586482726807535666?contentType=1">#2025 AI/Vibe Coding 对我的影响#</a></strong> 就可以被统计到哦💁🏻</p>
<p align="left"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a9b3efe1391432e9d11a481dc69d654~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767323834&amp;x-signature=sEjrW%2Fi%2FBgY3QgXKsygZqyJDwjU%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2">🗒️赛道说明</h3>
<p><code>参与者可以任选其一进行投稿，也可同时参与，不限制投稿文章数。</code></p>
<h4 data-id="heading-3">赛道一：2025，我的“Vibe Coding”时刻</h4>
<blockquote>
<p><strong>主题解读</strong></p>
<p>聚焦技术<strong>对“我”的个体影响</strong>。可以是一个AI工具、一个开源项目、一次技术决策、一种行业趋势，也可以是技术带来的某种生活方式。</p>
<p><strong>内容方向建议</strong></p>
<ul>
<li><em>Agent革命</em></li>
</ul>
<p>ChatGPT/Gemini如何改变我的开发效率，大模型如何让我的代码如鱼得水？（技术冲破对工作模式/效率带来的影响，任意模型/技术皆可）</p>
<ul>
<li><em>生活Vibe</em></li>
</ul>
<p>Web3、数字游民等概念开启的新生活尝试，分享自己用AI生成旅行攻略、创作音乐、辅导孩子学习的故事等；</p>
<ul>
<li><em>年度总结</em></li>
</ul>
<p>以个人视角，复盘你在某个技术领域（前端、后端、AI、运维等）或者生活上这一年的得失与观察。</p>
</blockquote>
<h4 data-id="heading-4">赛道二：「我和TRAE的这一年」</h4>
<blockquote>
<p><strong>主题解读</strong></p>
<p>一个针对TRAE的专属回忆录，记录掘金社区TRAE深度用户与其共同成长的故事。</p>
<p><strong>内容方向建议</strong></p>
<ul>
<li><em>成长见证</em></li>
</ul>
<p>记录自己使用TRAE完成的第一篇文章、第一个获赞、第一次参与开源项目、第一次开发的游戏等；</p>
<ul>
<li><em>连接故事</em></li>
</ul>
<p>通过社区所结识到的志同道合的TRAE友、参与的线下/线上活动、与TRAE官方运营互动的有趣瞬间；</p>
<ul>
<li><em>产品共建</em></li>
</ul>
<p>对TRAE功能提出的建议被采纳，或使用各个模式提升学习效率的真实体验瞬间。</p>
</blockquote>
<p><em>❗参加<strong>赛道二</strong> 的文章除话题 <a href="https://juejin.cn/theme/detail/7586482726807535666?contentType=1" target="_blank" title="https://juejin.cn/theme/detail/7586482726807535666?contentType=1">#2025 AI/Vibe对我的影响</a> 外，<strong>必须加上<a href="https://juejin.cn/tag/Trae" target="_blank" title="https://juejin.cn/tag/Trae">#TRAE</a>标签</strong>。</em></p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dca9a88a7ebd4c19ae7aa71c7101ef44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767323834&amp;x-signature=dpYkYxiBbC29UAkJENI6BpE0290%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-5">☝️征文要求</h3>
<p>本次征文活动需要符合主题，对于文章类型以及活动参与方式，我们有以下几点小要求。</p>
<ol>
<li>
<p>文章须为<strong>原创文章</strong>，内容符合<a href="https://juejin.cn/book/6844733795329900551/section/6844733795380232199" target="_blank" title="https://juejin.cn/book/6844733795329900551/section/6844733795380232199">掘金社区的内容标准和规范</a>。</p>
</li>
<li>
<p>本次征文<strong>不限制文章题材</strong>，可以是你对行业的总结和见解，也可以是你对行业未来发展的预测，本次活动不接受下面几种文章：</p>
<ol>
<li>资源聚合类文章，例如 Awesome-List；</li>
<li>翻译类文章和利用AI生产文章；</li>
<li>与本次主题无关的文章；</li>
<li>学习笔记/知识点汇总类文章；</li>
<li>有失中立性、公正性的内容，比如由公司或者公司的代理机构（如公关公司）所撰写，单纯希望宣传自己的商业产品或者公司的内容；</li>
<li>内容与活动主题不符、非原创内容，有洗稿、营销软文、广告、抄袭嫌疑的文章。</li>
</ol>
</li>
<li>
<p>刷赞、刷量等有作弊行为的文章，直接取消比赛资格，不参与评选；</p>
</li>
<li>
<p>AI代写文章、AI聊天记录等不计入活动（AI检测超过<strong>70%</strong> 取消文章获奖资格）；</p>
</li>
<li>
<p>活动文章需要选择话题：<a href="https://juejin.cn/theme/detail/7586482726807535666?contentType=1" target="_blank" title="https://juejin.cn/theme/detail/7586482726807535666?contentType=1">juejin.cn/theme/detai…</a></p>
</li>
<li>
<p>获奖作品，著作权归作者所有，掘金拥有使用权；</p>
</li>
</ol>
<h3 data-id="heading-6">🥇奖项设置</h3>
<blockquote>
<p><em>文章将根据<strong>专家评审得分</strong>（占比70%）和<strong>文章热度</strong>（占比30%）得分加权计算。<strong>未获得官方推荐</strong>的文章不参与奖项评选。</em></p>
</blockquote>





























































<table><thead><tr><th>奖项名称</th><th>奖项设置</th><th>获奖人数</th><th>奖品名称</th><th>奖品图</th></tr></thead><tbody><tr><td><strong>主赛道</strong></td><td>优秀文章奖（前10篇）</td><td>10名</td><td>小熊（Bear）电烧烤炉 多功能料理锅电烤炉 DKL-D12A1</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfe1f14ebbba4ef4b00c4f1c9f804a58~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767323834&amp;x-signature=Qjm5LvT3LdJpW0JC115Or6fewGw%3D" alt="image.png" loading="lazy"/></td></tr><tr><td/><td>掘金达人奖（11-40篇）</td><td>30名</td><td>稀土掘金 Yoyo抱枕新版-450g</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0994f46b5f64a0983edcae0dcaf582b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767323834&amp;x-signature=lo4Gk4BvrxUFWvJ%2FXW%2FhJ9D0%2BdM%3D" alt="" loading="lazy"/></td></tr><tr><td/><td>阳光普照奖（41-100篇）</td><td>60名</td><td>稀土掘金 x ByteMall 联名盲盒</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a503e8c6651439081513b9eebf0e548~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767323834&amp;x-signature=tEkMzMsHLFZc%2FSXUZ7SsG31BokE%3D" alt="" loading="lazy"/></td></tr><tr><td><strong>TRAE特别赛道鼓励奖（叠加）</strong></td><td>TOP1-10</td><td>10名</td><td>价值200元 TRAE连帽卫衣+抱枕</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3df35e973e984ffabc678b056123c053~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767323834&amp;x-signature=i%2Fux7WfqX17hQv%2FwV4vrBCqfE64%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a9cdcce418454a83810d84be38fcfc78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767323834&amp;x-signature=9MmJYqi%2FrvKgdwMZ9IpaMMMsVJE%3D" alt="" loading="lazy"/></td></tr><tr><td/><td>TOP11-30</td><td>20名</td><td>价值100元 TRAE圆领卫衣</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cea27183efa24e44b251b24b35ba9434~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767323834&amp;x-signature=Jc6qnBPlS9XpFIPvqPVSw2bp%2Bdc%3D" alt="" loading="lazy"/></td></tr><tr><td/><td>TOP31-50</td><td>20名</td><td>价值50元 TRAE单肩包</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/148795305e4248a684ba2a4c95709a06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767323834&amp;x-signature=EVDA1An%2BdW%2BTPQNdLBa5pcPP98o%3D" alt="" loading="lazy"/></td></tr><tr><td/><td>TOP51-100</td><td>50名</td><td>TRAE小鼠标垫</td><td><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23f8a2ea09714ea1ac2d9b8a41ce3248~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5o6Y6YeR6YWx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767323834&amp;x-signature=rR4PsGmC%2BZWF9NMUoSwQzxIRzZI%3D" alt="" loading="lazy"/></td></tr></tbody></table>
<h2 data-id="heading-7">🤵征文对象</h2>
<p>掘金社区全体掘友</p>
<h2 data-id="heading-8">⏰活动时间</h2>
<p>2025年12月26日——2026年1月25日23:59</p>
<h2 data-id="heading-9">👀 活动Q&amp;A</h2>
<p><strong>Q1：投稿数量有限制吗？</strong></p>
<p>A：没有。</p>
<p><strong>Q2：一篇文章可以同时参与多个社区活动吗？</strong></p>
<p>A：不行。一篇文章只能参与一个社区活动，可以写多篇文章参与不同的活动。</p>
<p><strong>Q3: 本次活动中写了多篇文章，可以多次获奖吗？</strong></p>
<p>A：参加特别赛道的文章，同时参与主赛道激励文章排名，中奖奖品兼得。但是，主赛道奖项一个用户只能获得一次，多篇文章上榜时选取最高名次获奖。</p>
<p><strong>Q4：如何算是成功参与了活动？</strong></p>
<p>A：活动期间，在掘金平台发布2025 AI/Vibe 对我的影响年终技术征文，选择带话题  <strong><a href="https://juejin.cn/theme/detail/7586482726807535666?contentType=1" target="_blank" title="https://juejin.cn/theme/detail/7586482726807535666?contentType=1">#2025 AI/Vibe Coding 对我的影响#</a></strong>  ，即可成功参与活动。注意话题≠标签！</p>
<h3 data-id="heading-10">💡注意事项</h3>
<p>2026年1月25日活动结束后，约10-15个工作日通过<strong>系统消息</strong>的形式公示获奖情况，预计填写问卷后的20个工作日内完成奖品发放。</p>
<p>技术浪潮奔涌向前，但属于个体的记忆同样珍贵。让我们用文字，为这不平凡的一年按下存档键。</p>
<p><strong>来掘金，写下你的2025。你的故事，我们都在听。</strong></p>
<blockquote>
<p>注：最终解释权归<em><strong>稀土掘金技术社区</strong></em> 官方所有</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Cesium 去掉默认瓦片和地形，解决网络不好时地图加载缓慢的问题]]></title>    <link>https://juejin.cn/post/7587729264184885311</link>    <guid>https://juejin.cn/post/7587729264184885311</guid>    <pubDate>2025-12-26T03:12:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587729264184885311" data-draft-id="7587712328826355748" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Cesium 去掉默认瓦片和地形，解决网络不好时地图加载缓慢的问题"/> <meta itemprop="keywords" content="前端,cesium"/> <meta itemprop="datePublished" content="2025-12-26T03:12:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="闲云一鹤"/> <meta itemprop="url" content="https://juejin.cn/user/729731452122382"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Cesium 去掉默认瓦片和地形，解决网络不好时地图加载缓慢的问题
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/729731452122382/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    闲云一鹤
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T03:12:34.000Z" title="Fri Dec 26 2025 03:12:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">抽丝剥茧，找到真凶</h2>
<p>甲方反馈地图经常出现偶发性加载缓慢的问题</p>
<p>我寻思在我本地开发环境很快啊，上了测试环境也没毛病，咋个部署到正式环境就地图慢了？</p>
<p>经过排查发现每次地图加载缓慢时 <code>endpoint</code> 接口都在报错（控制台也提示 net::ERR_CONNECTION_TIMED_OUT），并且百度也无法访问(甲方项目部署在内网，访问公网不太流畅)</p>
<p>破案了！罪魁祸首就是这两个接口请求在报错（图片无错误是因为我网络好，这里假装它在报错）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36705965fdc243e2b8a4c28090d4d752~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767323554&amp;x-signature=nTDEe%2BbD3F3sJPSglhtAs2fPlGg%3D" alt="1.png" loading="lazy"/></p>
<p><code>https://api.cesium.com/v1/assets/1/endpoint?access_token="你的token"</code>
<code>https://api.cesium.com/v1/assets/2/endpoint?access_token="你的token"</code></p>
<p>这两个接口请求分别是加载 cesium 默认的地形数据和地图瓦片（其中 assets/1 是地形，assets/2 是瓦片）由于 cesium 服务器在国外，所以网络波动等原因会导致访问不稳定，从而影响地图加载速度</p>
<p>哪怕你是调用了第三方的地图瓦片，比如天地图瓦片服务，如果网络不稳定也会出现此错误，它会阻塞地图的正常加载</p>
<p>要想彻底解决只有将它禁用</p>
<h2 data-id="heading-1">禁用 cesium 默认地图瓦片</h2>
<p>默认地图瓦片默认是启用的，需要手动禁用</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> viewer = <span class="hljs-keyword">new</span> Cesium.<span class="hljs-built_in">Viewer</span>(<span class="hljs-string">'CesiumViewer'</span>, {
  ...
  imageryProvider: <span class="hljs-literal">false</span> <span class="hljs-comment">// 不加载默认底图</span>
  ...
})
</code></pre>
<p>我们来测试下效果，这里放图片（算了不放了，节约文章空间）</p>
<h2 data-id="heading-2">禁用 cesium 默认地形数据</h2>
<p>地形默认是不启用的，如果你自己启动了，把它注释了就可以了</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-type">const</span> viewer = <span class="hljs-keyword">new</span> Cesium.<span class="hljs-built_in">Viewer</span>(<span class="hljs-string">'CesiumViewer'</span>, {
  ...
  terrain: Cesium.Terrain.<span class="hljs-built_in">fromWorldTerrain</span>(), <span class="hljs-comment">// 使用Cesium官方的地形服务 全球地形数据</span>
  ...
})
</code></pre>
<p>注意：我的 Cesium 版本为 1.128，不同版本的启动地形和加载默认地图方法会不一样，请根据你项目中的版本去官方查找对应的 api 进行修改</p>
<p>刚接触三维地图的朋友可能会问，地形是个什么玩意？开启与关闭有何区别？这里我放两张截图来作对比（采用同样的视角）</p>
<p>这是加载地形的效果：可以看见，山势有明显的高低起伏</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d3d6d2e44ec4586afa695499e0d26af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767323554&amp;x-signature=Qabf4eA3KGOhWKJwyw6KQLNc15g%3D" alt="2.png" loading="lazy"/></p>
<p>这是关闭地形的效果：可以看见，山的高度没了，地图的 3D 立体变成了二维扁平</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b3aa42bf15f48a78e9655827cfe776a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zey5LqR5LiA6bmk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767323554&amp;x-signature=D5hS5QIht2e%2FZmMeR27urHfqiWg%3D" alt="3.png" loading="lazy"/></p>
<h2 data-id="heading-3">结语</h2>
<p>细心的朋友可能会问，既然地形对于三维地图如此重要，那么把他禁用了那岂不是效果大打折扣吗？是的，那么有什么办法，既能解决网络不好时报错，又能使地形存在呢？</p>
<p>办法是有的，那就是自己部署地形服务并调用，不从 cesium 官方获取地形接口即可</p>
<p>具体如何操作？如果有人感兴趣的话就下次再写吧</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[系统的雪崩-反脆弱设计]]></title>    <link>https://juejin.cn/post/7587684397530890267</link>    <guid>https://juejin.cn/post/7587684397530890267</guid>    <pubDate>2025-12-26T03:14:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587684397530890267" data-draft-id="7587715742051057674" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="系统的雪崩-反脆弱设计"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-26T03:14:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="自由生长2024"/> <meta itemprop="url" content="https://juejin.cn/user/1591748569862670"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            系统的雪崩-反脆弱设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748569862670/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    自由生长2024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T03:14:19.000Z" title="Fri Dec 26 2025 03:14:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>摘要：雪崩Avalanche 或 Cascading Failure）在计算机系统、尤其是分布式系统中，指的是<strong>一个局部故障引发连锁反应，导致整个系统或大部分服务不可用的现象</strong>。就像雪山上的一个小扰动可能引发巨大雪崩一样，系统中的一个小问题会像多米诺骨牌一样层层放大，最终造成全局瘫痪。</p>
<hr/>
<h4 data-id="heading-0">🌪️ 例子：</h4>
<p>假设你有一个 Web 应用，它依赖一个数据库：</p>
<ol>
<li>数据库因为慢查询变慢了（初始故障）。</li>
<li>Web 服务请求数据库时开始超时或堆积。</li>
<li>Web 服务的线程/连接被占满，无法处理新请求。</li>
<li>用户不断重试，流量反而增加。</li>
<li>Web 服务彻底卡死，连健康检查都失败。</li>
<li>负载均衡器把流量切到其他实例 → 其他实例也因同样原因崩溃。</li>
<li><strong>整个系统宕机</strong> —— 这就是雪崩。</li>
</ol>
<p>可以这么通俗的理解，问题不断的在系统中放大， 由一个很小的问题开始，然后形成灾难性的后果。</p>
<p>雪崩的本质原因是整体内部容错性太低，反脆弱性太低。</p>
<p>再比如，一条很长的路，突然就堵车了3公里，走到堵车源头，可能是两个人在一个很窄的路口吵架不让路，这条路就是很脆弱，因为这两个人把整个路口堵住了，这就是交通拥堵，也可以说是路的“雪崩”。</p>
<p>反脆弱的措施，就是专门找个交警盯着，不让这种事发生。</p>
<hr/>
<h4 data-id="heading-1">🔥 雪崩的常见诱因：</h4>





























<table><thead><tr><th>原因</th><th>说明</th></tr></thead><tbody><tr><td><strong>资源耗尽</strong></td><td>CPU、内存、线程池、连接数被打满</td></tr><tr><td><strong>同步阻塞调用</strong></td><td>A 等 B，B 等 C，C 挂了 → 全链路卡住</td></tr><tr><td><strong>无超时/重试失控</strong></td><td>无限重试或超时太长，加剧资源占用</td></tr><tr><td><strong>缓存击穿/穿透</strong></td><td>大量请求直达数据库，压垮后端</td></tr><tr><td><strong>自动扩缩容滞后</strong></td><td>故障发生太快，扩容来不及救场</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-2">🛡️ 如何防止雪崩？（常用手段）</h4>
<ol>
<li>
<p><strong>超时控制（Timeout）</strong><br/>
所有远程调用必须设合理超时，避免无限等待。</p>
</li>
<li>
<p><strong>熔断（Circuit Breaker）</strong><br/>
比如 Hystrix、Sentinel：当错误率过高，自动“熔断”，直接拒绝请求，给下游喘息时间。</p>
</li>
<li>
<p><strong>限流（Rate Limiting）</strong><br/>
控制入口流量，防止系统被突发请求冲垮。</p>
</li>
<li>
<p><strong>降级（Degradation）</strong><br/>
非核心功能临时关闭（如“推荐模块”不加载），保住主流程。</p>
</li>
<li>
<p><strong>异步 &amp; 队列削峰</strong><br/>
用消息队列缓冲请求，避免瞬时高峰直冲后端。</p>
</li>
<li>
<p><strong>隔离（Bulkhead）</strong><br/>
按服务/资源分组隔离，一个模块故障不影响其他（比如线程池隔离）。</p>
</li>
</ol>
<hr/>
<h4 data-id="heading-3">✅ 一句话总结：</h4>
<blockquote>
<p><strong>雪崩 = 小故障 + 正反馈循环 + 无防护机制 → 全局崩溃</strong><br/>
防雪崩的关键是<strong>打断连锁反应</strong>，让故障“止血”在局部。</p>
</blockquote>
<p>如果你在做微服务或高并发系统，防雪崩是稳定性设计的核心之一。需要具体场景的防护方案吗？</p>
<h2 data-id="heading-4">蝴蝶效应</h2>
<p><strong>“雪崩”和“蝴蝶效应”在系统稳定性语境下有很强的相似性</strong>：</p>
<ul>
<li>
<p><strong>蝴蝶效应</strong>（来自混沌理论）：初始条件的微小变化，可能引发系统长期行为的巨大差异。</p>
<blockquote>
<p>“一只蝴蝶在巴西扇动翅膀，可能引起得克萨斯州的一场龙卷风。”</p>
</blockquote>
</li>
<li>
<p><strong>雪崩效应</strong>（在工程/分布式系统中）：一个看似微不足道的故障（比如一个服务响应变慢），如果没有被及时隔离或处理，会通过依赖链、重试、资源竞争等机制不断放大，最终导致整个系统崩溃。</p>
</li>
</ul>
<hr/>
<h4 data-id="heading-5">✅ 相同点：</h4>

























<table><thead><tr><th>维度</th><th>蝴蝶效应</th><th>雪崩</th></tr></thead><tbody><tr><td>起点</td><td>微小扰动</td><td>局部故障（如一个节点慢、一次超时）</td></tr><tr><td>结果</td><td>系统级巨大变化</td><td>全局服务不可用</td></tr><tr><td>核心机制</td><td>非线性放大、正反馈</td><td>依赖传播、资源耗尽、连锁失败</td></tr></tbody></table>
<h4 data-id="heading-6">❗细微差别：</h4>
<ul>
<li><strong>蝴蝶效应</strong>更偏向<strong>理论/哲学层面</strong>，强调系统的<strong>不可预测性</strong>。</li>
<li><strong>雪崩</strong>是<strong>工程实践中的具体问题</strong>，强调<strong>可防御性</strong>——我们可以通过设计（熔断、限流等）来<strong>阻断</strong>它。</li>
</ul>
<blockquote>
<p>所以可以说：<strong>雪崩是“可干预的蝴蝶效应”</strong>。<br/>
在软件系统里，我们承认复杂性，但更要通过架构手段<strong>把“蝴蝶扇翅膀”关在笼子里</strong>，不让它变成龙卷风。</p>
</blockquote>
<h3 data-id="heading-7">缓存雪崩</h3>
<p>缓存雪崩（Cache Avalanche） 是“雪崩效应”在缓存系统中的一种典型表现，指的是大量缓存数据在同一时间失效（或缓存服务整体宕机），导致瞬间海量请求直接打到后端数据库或其他底层存储，造成数据库负载激增、响应变慢甚至崩溃，进而引发整个系统不可用。</p>
<p>假设你运营一个电商网站，商品详情页依赖 Redis 缓存来减轻数据库压力：</p>
<p>所有商品的缓存 统一设置了 1 小时过期时间（比如 TTL = 3600s）。<br/>
系统平稳运行，99% 的请求命中缓存，数据库很轻松。<br/>
问题来了：今天凌晨 2:00，一批热门商品（比如 iPhone、AirPods）的缓存同时过期。<br/>
此时恰逢“凌晨秒杀活动”开始，大量用户涌入访问这些商品。<br/>
因为缓存已失效，成千上万的请求瞬间穿透缓存，直冲数据库。<br/>
数据库 CPU 飙升到 100%，响应变慢 → Web 服务等待超时 → 用户不断刷新重试 → 请求更多……<br/>
最终：数据库连接池耗尽，服务全面瘫痪。</p>
<p>这就是典型的 缓存雪崩：不是单个 key 失效，而是大批 key 集中失效，形成“雪崩式”冲击。</p>
<p>如何防止缓存雪崩？</p>
<p>设置随机过期时间</p>
<p>缓存永不过期 + 后台异步更新</p>
<p>反脆弱设计1：高可用缓存架构：使用 Redis Cluster、主从+哨兵等，避免单点故障导致整个缓存不可用</p>
<p>反脆弱设计2：当检测到数据库压力过大时，自动触发熔断，返回兜底数据（如“稍后再试”）或限流。</p>
<p>反脆弱设计3：多级缓存：本地缓存 + 分布式缓存（如 Redis），即使 Redis 宕机，本地缓存还能扛一阵。但是这样会引入复杂度，要确定自己是否能处理。</p>
<p>设计高并发系统，缓存雪崩是必须提前规划的关键风险点。</p>
<hr/>
<h2 data-id="heading-8">🛠️ 工程师的应对哲学：</h2>
<blockquote>
<p>“<strong>永远假设依赖会失败，网络会延迟，资源会耗尽。</strong>”<br/>
—— 正是因为知道“小风险会演变成大灾难”，所以我们才需要：</p>
<ul>
<li>健壮的错误处理</li>
<li>自动化的故障隔离</li>
<li>清晰的服务边界</li>
</ul>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别 “糙” 体验！Ooder 企业级 AI：重构国产企业软件的 4 大核心解决方案]]></title>    <link>https://juejin.cn/post/7587714124857442358</link>    <guid>https://juejin.cn/post/7587714124857442358</guid>    <pubDate>2025-12-26T03:26:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587714124857442358" data-draft-id="7587720490930405412" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别 “糙” 体验！Ooder 企业级 AI：重构国产企业软件的 4 大核心解决方案"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-26T03:26:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别 “糙” 体验！Ooder 企业级 AI：重构国产企业软件的 4 大核心解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T03:26:15.000Z" title="Fri Dec 26 2025 03:26:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>国产企业软件 “糙” 的痛点早已深入人心 —— 界面陈旧像 “上古系统”、操作繁琐绕晕业务人员、技术落后难适配新场景、部署复杂还易出故障。但这并非无法破解，Ooder 企业级 AI 以 “深入业务需求、技术落地为王” 为核心，联动全栈框架与程序员协同，从根源上解决四大核心痛点，让国产企业软件既有 “自主可控” 的底气，又有 “专业精致” 的体验。</p>
<h2 data-id="heading-0">一、界面陈旧？AI 驱动视觉 + 业务双重构</h2>
<h3 data-id="heading-1">核心痛点</h3>
<p>界面设计脱节业务流程，按钮杂乱、字段堆砌，采购填单要翻 3 屏找核心字段，非技术人员上手需专门培训。</p>
<h3 data-id="heading-2">Ooder AI 解决方案</h3>
<ol>
<li>业务导向自动布局：基于 Ooder 特有注解驱动特性，AI 识别业务流程逻辑，将 “供应商编码 + 商品编码” 等高频关联字段自动归为核心组，低频字段默认折叠，界面分区清晰如 “左核心、右配置、下辅助”。</li>
<li>标准化视觉升级：AI 调用 Ooder 框架内置的企业级 UI 组件库，自动统一配色、字体和交互逻辑，告别 “复古风”，同时保留业务人员熟悉的操作路径，无需重新适应。</li>
<li>角色适配个性化：根据采购、财务、库管等不同角色，AI 自动筛选展示专属字段，无用信息自动隐藏，新手也能 1 分钟上手核心操作。</li>
</ol>
<h2 data-id="heading-3">二、操作繁琐？AI 简化流程 + 智能辅助</h2>
<h3 data-id="heading-4">核心痛点</h3>
<p>审批需反复切换页面、报表制作依赖 IT 人员、重复录入工作占比高，业务效率被严重拖累。</p>
<h3 data-id="heading-5">Ooder AI 解决方案</h3>
<ol>
<li>流程自动化生成：AI 解析业务链路，自动生成 “填单 - 校验 - 审批 - 归档” 的闭环流程，减少 80% 的手动跳转操作，紧急采购填单时间从 5 分钟压缩至 1 分钟。</li>
<li>无代码智能填报：支持自然语言输入和数据自动联想，输入 “2024 年 Q4 原材料采购”，AI 自动填充历史供应商、常用规格等信息，减少重复录入。</li>
<li>自助报表工具：像用 Excel 一样拖拽操作，AI 自动识别数据关联关系，生成符合业务需求的分析报表，非技术人员也能独立完成数据看板搭建。</li>
</ol>
<h2 data-id="heading-6">三、技术落后？AI + 全栈框架实现底层升级</h2>
<h3 data-id="heading-7">核心痛点</h3>
<p>架构僵化难扩展、技术栈陈旧不兼容、二次开发门槛高，企业个性化需求难以满足。</p>
<h3 data-id="heading-8">Ooder AI 解决方案</h3>
<ol>
<li>标准化架构注入：Ooder 全栈框架提供统一技术底座，AI 将陈旧的平铺式代码自动重构为 “GroupItem 分组 + 内部配置类” 模式，49 + 视图文件可按优先级分批升级，维护成本降低 40%。</li>
<li>注解驱动灵活扩展：借助 Ooder 特有@GroupItem等注解，AI 自动适配业务扩展需求，新增字段时无需修改整体架构，仅需添加对应注解配置，开发效率提升 50%。</li>
<li>兼容现有系统资产：AI 通过字段映射和框架注入方法，确保重构后系统与原有数据、接口无缝兼容，零故障上线，避免 “推倒重来” 的浪费。</li>
</ol>
<h2 data-id="heading-9">四、部署困难？AI 自动化适配 + 轻量化落地</h2>
<h3 data-id="heading-10">核心痛点</h3>
<p>部署步骤繁琐、环境依赖复杂、跨平台适配差，IT 团队需花费大量时间调试。</p>
<h3 data-id="heading-11">Ooder AI 解决方案</h3>
<ol>
<li>环境自动适配：AI 扫描目标服务器环境，自动识别操作系统、数据库版本，生成个性化部署脚本，无需手动修改配置参数。</li>
<li>一键化部署流程：整合 “依赖安装 - 配置初始化 - 数据迁移 - 启动验证” 全流程，AI 自动执行各步骤并实时排查异常，部署时间从数小时缩短至 10 分钟内。</li>
<li>轻量化运维支持：AI 实时监控系统运行状态，自动识别部署后的兼容性问题，给出精准修复建议，减少 IT 团队的运维压力。</li>
</ol>
<h2 data-id="heading-12">核心价值：企业级 AI 不是玩具，是业务赋能利器</h2>
<p>Ooder 企业级 AI 的核心不是 “炫技”，而是深入企业实际需求的 “精准赋能”—— 它以全栈框架为底座，让程序员聚焦业务核心，AI 承接重复劳动，最终实现三大价值：</p>
<ul>
<li>体验升级：界面清晰度 + 50%，操作效率 + 30%，彻底告别 “糙” 体验；</li>
<li>效率翻倍：开发重构周期缩短 60%，业务人员上手成本降低 70%；</li>
<li>风险可控：向后兼容保障现有资产，标准化流程降低试错成本。</li>
</ul>
<p>国产企业软件的突围，从来不是单纯的技术堆砌，而是让技术真正贴合业务需求。Ooder 企业级 AI 用 “AI + 框架 + 程序员” 的协同模式，破解了 “界面糙、操作繁、技术旧、部署难” 的行业痛点，让国产企业软件既有自主可控的硬核实力，又有贴近用户的柔软体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用Java Stream，将集合转换为一对一Map]]></title>    <link>https://juejin.cn/post/7587684397531021339</link>    <guid>https://juejin.cn/post/7587684397531021339</guid>    <pubDate>2025-12-26T03:26:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587684397531021339" data-draft-id="7587715742051139594" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用Java Stream，将集合转换为一对一Map"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-12-26T03:26:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="申城异乡人"/> <meta itemprop="url" content="https://juejin.cn/user/3245414056985831"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用Java Stream，将集合转换为一对一Map
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3245414056985831/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    申城异乡人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T03:26:34.000Z" title="Fri Dec 26 2025 03:26:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在日常的开发工作中，我们经常使用到Java Stream，特别是Stream API中提供的<code>Collectors.toList()</code>收集器，</p>
<p>但有些场景下，我们需要将集合转换为Map，这时候就需要使用到Stream API中提供的另一个收集器：</p>
<p><code>Collectors.toMap</code>，它可以将流中的元素映射为键值对，并收集到一个Map中。</p>
<h2 data-id="heading-0">1. 三种主要的重载方法</h2>
<p><code>Collectors.toMap</code>有3种重载方法，分别是：</p>
<p>1)<strong>两个参数的重载方法（最简单的形式）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T, K, U&gt; Collector&lt;T, ?, Map&lt;K,U&gt;&gt; toMap(Function&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">K</span>&gt; keyMapper,
                                Function&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">U</span>&gt; valueMapper) {
	<span class="hljs-keyword">return</span> toMap(keyMapper, valueMapper, throwingMerger(), HashMap::<span class="hljs-keyword">new</span>);
}
</code></pre>
<p>2)<strong>三个参数的重载方法（包含冲突处理）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T, K, U&gt; Collector&lt;T, ?, Map&lt;K,U&gt;&gt; toMap(Function&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">K</span>&gt; keyMapper,
                                Function&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">U</span>&gt; valueMapper,
                                BinaryOperator&lt;U&gt; mergeFunction) {
    <span class="hljs-keyword">return</span> toMap(keyMapper, valueMapper, mergeFunction, HashMap::<span class="hljs-keyword">new</span>);
}
</code></pre>
<p>3)<strong>四个参数的重载方法（指定Map实现）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> &lt;T, K, U, M <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Map</span>&lt;K, U&gt;&gt;
   Collector&lt;T, ?, M&gt; toMap(Function&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">K</span>&gt; keyMapper,
                            Function&lt;? <span class="hljs-built_in">super</span> T, ? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">U</span>&gt; valueMapper,
                            BinaryOperator&lt;U&gt; mergeFunction,
                            Supplier&lt;M&gt; mapSupplier) {
    BiConsumer&lt;M, T&gt; accumulator
            = (map, element) -&gt; map.merge(keyMapper.apply(element),
                                          valueMapper.apply(element), mergeFunction);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CollectorImpl</span>&lt;&gt;(mapSupplier, accumulator, mapMerger(mergeFunction), CH_ID);
}
</code></pre>
<p>接下来，我们结合使用示例详细讲解。</p>
<h2 data-id="heading-1">2. 使用示例</h2>
<h3 data-id="heading-2">2.1 将对象的某些属性转换为Map</h3>
<p>假设有一个城市列表，需要将其转换为Map，其中Key为城市ID、Value为城市名称，转换方法如下所示：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Getter</span>
<span class="hljs-meta">@Setter</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">City</span> {
    <span class="hljs-keyword">private</span> Integer cityId;

    <span class="hljs-keyword">private</span> String cityName;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">City</span><span class="hljs-params">(Integer cityId, String cityName)</span> {
        <span class="hljs-built_in">this</span>.cityId = cityId;
        <span class="hljs-built_in">this</span>.cityName = cityName;
    }
}
</code></pre>
<pre><code class="hljs language-java" lang="java">List&lt;City&gt; cityList = Arrays.asList(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"北京"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"上海"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"广州"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"深圳"</span>)
);
Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, City::getCityName));
System.out.println(cityMap);
</code></pre>
<p>输出结果：</p>
<blockquote>
<p>{1=北京, 2=上海, 3=广州, 4=深圳}</p>
</blockquote>
<h3 data-id="heading-3">2.2 将对象列表转换为Map（ID -&gt; 对象）</h3>
<p>仍然使用上面的城市列表，需要将其转换为Map，其中Key为城市ID、Value为城市对象，转换方法如下所示：</p>
<pre><code class="hljs language-java" lang="java">List&lt;City&gt; cityList = Arrays.asList(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"北京"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"上海"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"广州"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"深圳"</span>)
);
Map&lt;Integer, City&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, city -&gt; city));
<span class="hljs-type">City</span> <span class="hljs-variable">city</span> <span class="hljs-operator">=</span> cityMap.get(<span class="hljs-number">1</span>);
System.out.println(<span class="hljs-string">"城市ID: "</span> + city.getCityId());
System.out.println(<span class="hljs-string">"城市名称: "</span> + city.getCityName());
</code></pre>
<p>输出结果如下所示：</p>
<blockquote>
<p>城市ID: 1
城市名称: 北京</p>
</blockquote>
<p>上面的写法等价于：</p>
<pre><code class="hljs language-java" lang="java">Map&lt;Integer, City&gt; cityMap = cityList.stream()
    	.collect(Collectors.toMap(City::getCityId, Function.identity()));
</code></pre>
<p>因为<code>Function.identity()</code>内部实现是下面这样的：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> &lt;T&gt; Function&lt;T, T&gt; <span class="hljs-title function_">identity</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> t -&gt; t;
}
</code></pre>
<h3 data-id="heading-4">2.3 键冲突处理</h3>
<p>假设上面的城市列表中有一个ID重复的城市：</p>
<pre><code class="hljs language-java" lang="java">List&lt;City&gt; cityList = Arrays.asList(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"北京"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"上海"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"广州"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"深圳"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"天津"</span>)
);
Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, City::getCityName));
System.out.println(<span class="hljs-string">"城市ID: 4, 城市名称: "</span> + cityMap.get(<span class="hljs-number">4</span>));
</code></pre>
<p>此时运行代码，会抛出<code>java.lang.IllegalStateException</code>异常，如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad5bff41cf40443994c502a37403892c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz5Z-O5byC5Lmh5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324394&amp;x-signature=HucqYoD9JvlfNzJv%2FQ7VkGxLxRY%3D" alt="" loading="lazy"/></p>
<p>有3种常见的键冲突处理方式，分别是保留旧值、使用新值和合并值，接下来一一讲解。</p>
<p>1)方式一：保留旧值</p>
<pre><code class="hljs language-java" lang="java">Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, City::getCityName, (oldValue, newValue) -&gt; oldValue));
</code></pre>
<p>输出结果：</p>
<blockquote>
<p>城市ID: 4, 城市名称: 深圳</p>
</blockquote>
<p>2)方式二：使用新值</p>
<pre><code class="hljs language-java" lang="java">Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, City::getCityName, (oldValue, newValue) -&gt; newValue));
</code></pre>
<p>输出结果：</p>
<blockquote>
<p>城市ID: 4, 城市名称: 天津</p>
</blockquote>
<p>3)方式三：合并值</p>
<pre><code class="hljs language-java" lang="java">Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, City::getCityName, 
        		(oldValue, newValue) -&gt; oldValue + <span class="hljs-string">", "</span> + newValue));
</code></pre>
<p>输出结果：</p>
<blockquote>
<p>城市ID: 4, 城市名称: 深圳, 天津</p>
</blockquote>
<h3 data-id="heading-5">2.4 数据分组聚合</h3>
<p>假设有一个销售记录列表，需要将其转换为Map，其中Key为销售员、Value为该销售员的总销售额，转换方法如下所示：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Getter</span>
<span class="hljs-meta">@Setter</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SalesRecord</span> {
    <span class="hljs-keyword">private</span> String salesPerson;

    <span class="hljs-keyword">private</span> BigDecimal amount;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">SalesRecord</span><span class="hljs-params">(String salesPerson, BigDecimal amount)</span> {
        <span class="hljs-built_in">this</span>.salesPerson = salesPerson;
        <span class="hljs-built_in">this</span>.amount = amount;
    }
}
</code></pre>
<pre><code class="hljs language-java" lang="java">List&lt;SalesRecord&gt; salesRecordList = Arrays.asList(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">SalesRecord</span>(<span class="hljs-string">"张三"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"1000"</span>)),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">SalesRecord</span>(<span class="hljs-string">"李四"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"2000"</span>)),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">SalesRecord</span>(<span class="hljs-string">"张三"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"980"</span>))
);

Map&lt;String, BigDecimal&gt; salesRecordMap = salesRecordList.stream()
        .collect(Collectors.toMap(SalesRecord::getSalesPerson, SalesRecord::getAmount, BigDecimal::add));
System.out.println(salesRecordMap);
</code></pre>
<p>输出结果：</p>
<blockquote>
<p>{李四=2000, 张三=1980}</p>
</blockquote>
<p>上面的例子是销售额累加，也可以只取最小值：</p>
<pre><code class="hljs language-java" lang="java">Map&lt;String, BigDecimal&gt; salesRecordMap = salesRecordList.stream()
        .collect(Collectors.toMap(SalesRecord::getSalesPerson, SalesRecord::getAmount, BigDecimal::min));
</code></pre>
<p>此时的输出结果：</p>
<blockquote>
<p>{李四=2000, 张三=980}</p>
</blockquote>
<p>或者只取最大值：</p>
<pre><code class="hljs language-java" lang="java">Map&lt;String, BigDecimal&gt; salesRecordMap = salesRecordList.stream()
        .collect(Collectors.toMap(SalesRecord::getSalesPerson, SalesRecord::getAmount, BigDecimal::max));
</code></pre>
<p>此时的输出结果：</p>
<blockquote>
<p>{李四=2000, 张三=1000}</p>
</blockquote>
<h3 data-id="heading-6">2.5 指定Map实现</h3>
<p>默认情况下，<code>Collectors.toMap</code>是将结果收集到HashMap中，如果有需要，我们也可以指定成TreeMap或者LinkedHashMap。</p>
<p>如果想要保持插入顺序，可以指定使用LinkedHashMap：</p>
<pre><code class="hljs language-java" lang="java">List&lt;City&gt; cityList = Arrays.asList(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"上海"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"北京"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"深圳"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"广州"</span>)
);
Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, City::getCityName,
                (existing, replacement) -&gt; existing, LinkedHashMap::<span class="hljs-keyword">new</span>));
System.out.println(cityMap);
</code></pre>
<p>输出结果：</p>
<blockquote>
<p>{2=上海, 1=北京, 4=深圳, 3=广州}</p>
</blockquote>
<p>如果想要按键排序，可以指定使用TreeMap：</p>
<pre><code class="hljs language-java" lang="java">List&lt;City&gt; cityList = Arrays.asList(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"上海"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"北京"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"深圳"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"广州"</span>)
);
Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, City::getCityName,
                (existing, replacement) -&gt; existing, TreeMap::<span class="hljs-keyword">new</span>));
System.out.println(cityMap);
</code></pre>
<p>输出结果：</p>
<blockquote>
<p>{1=北京, 2=上海, 3=广州, 4=深圳}</p>
</blockquote>
<h2 data-id="heading-7">3. 注意事项</h2>
<h3 data-id="heading-8">3.1 空异常</h3>
<p>如果valueMapper中取出的值有null值，会抛出<code>java.lang.NullPointerException</code>异常，如下示例：</p>
<pre><code class="hljs language-java" lang="java">List&lt;City&gt; cityList = Arrays.asList(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"北京"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"上海"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"广州"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"深圳"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">5</span>, <span class="hljs-literal">null</span>)
);
Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, City::getCityName));
System.out.println(cityMap);
</code></pre>
<p>运行以上代码会抛出异常，如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d288447108164d26985edd91c27e430a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz5Z-O5byC5Lmh5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324394&amp;x-signature=lP0nkReM4pnGZp6WqyEI2Kyufs0%3D" alt="" loading="lazy"/></p>
<p>有两种解决方案，第一种解决方案是过滤null值：</p>
<pre><code class="hljs language-java" lang="java">Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .filter(city -&gt; city.getCityName() != <span class="hljs-literal">null</span>)
        .collect(Collectors.toMap(City::getCityId, City::getCityName));
</code></pre>
<p>第二种解决方案是提供默认值：</p>
<pre><code class="hljs language-java" lang="java">Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId,
                city -&gt; Optional.ofNullable(city.getCityName()).orElse(<span class="hljs-string">"未知"</span>)));
</code></pre>
<h3 data-id="heading-9">3.2 键重复异常</h3>
<p>如果出现重复键，且没有提供mergeFunction参数，会抛出<code>java.lang.IllegalStateException</code>异常，如下示例：</p>
<pre><code class="hljs language-java" lang="java">List&lt;City&gt; cityList = Arrays.asList(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">1</span>, <span class="hljs-string">"北京"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">2</span>, <span class="hljs-string">"上海"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">3</span>, <span class="hljs-string">"广州"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"深圳"</span>),
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-number">4</span>, <span class="hljs-string">"天津"</span>)
);
Map&lt;Integer, String&gt; cityMap = cityList.stream()
        .collect(Collectors.toMap(City::getCityId, City::getCityName));
System.out.println(cityMap);
</code></pre>
<p>运行以上代码会抛出异常，如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/80f904404b9744e8a1379f64a65540fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55Sz5Z-O5byC5Lmh5Lq6:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324394&amp;x-signature=ZFH7K4V%2BTqNshyn32SOOiRBYDUc%3D" alt="" loading="lazy"/></p>
<p>解决方案见本篇文章<strong>2.3 键冲突处理</strong>部分。</p>
<h2 data-id="heading-10">4. 总结</h2>
<p><code>Collectors.toMap</code>是Stream API中提供的一个非常方便的收集器，它可以将流中的元素映射为键值对，并收集到一个Map中。</p>
<p>它适用于一对一映射的场景，但在使用时，要注意避免<code>java.lang.NullPointerException</code>异常和</p>
<p><code>java.lang.IllegalStateException</code>异常。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[数据库连接池原理与HikariCP调优实战]]></title>    <link>https://juejin.cn/post/7587715742050975754</link>    <guid>https://juejin.cn/post/7587715742050975754</guid>    <pubDate>2025-12-26T03:07:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587715742050975754" data-draft-id="7587704265054830630" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="数据库连接池原理与HikariCP调优实战"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-26T03:07:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="嘻哈baby"/> <meta itemprop="url" content="https://juejin.cn/user/485305583405066"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            数据库连接池原理与HikariCP调优实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/485305583405066/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    嘻哈baby
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T03:07:13.000Z" title="Fri Dec 26 2025 03:07:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>刚工作那会儿，遇到过一个诡异的问题：服务刚启动时第一批请求特别慢，好几秒才响应，之后就正常了。</p>
<p>查了半天发现是数据库连接的锅——每次请求都新建连接，TCP握手 + MySQL认证，一套下来几百毫秒。用上连接池后，响应时间从秒级降到毫秒级。</p>
<p>连接池这东西，平时不出问题感觉不到它的存在，一出问题就是大麻烦。这篇文章讲清楚原理和调优，让你以后遇到问题能快速定位。</p>
<h2 data-id="heading-1">为什么需要连接池</h2>
<h3 data-id="heading-2">创建连接的代价</h3>
<p>数据库连接不是直接就能用的，要经过：</p>
<pre><code class="hljs language-lua" lang="lua">客户端                    数据库
   |                        |
   |<span class="hljs-comment">------- SYN ---------&gt;  |  </span>
   |&lt;<span class="hljs-comment">------ SYN-ACK ------  |  TCP三次握手</span>
   |<span class="hljs-comment">------- ACK ---------&gt;  |  </span>
   |                        |
   |<span class="hljs-comment">---- 认证请求 --------&gt;  |</span>
   |&lt;<span class="hljs-comment">--- 认证Challenge ----  |  MySQL认证</span>
   |<span class="hljs-comment">---- 认证响应 --------&gt;  |</span>
   |&lt;<span class="hljs-comment">--- 认证OK ----------  |</span>
   |                        |
</code></pre>
<p>一次连接建立，最少也要几十毫秒（局域网），跨机房可能几百毫秒。</p>
<p>如果每次查询都新建连接：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 不用连接池（千万别这样写）</span>
<span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> {
    <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> DriverManager.getConnection(url, user, password);  <span class="hljs-comment">// 每次新建</span>
    <span class="hljs-keyword">try</span> {
        <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> conn.prepareStatement(<span class="hljs-string">"SELECT * FROM user WHERE id = ?"</span>);
        ps.setInt(<span class="hljs-number">1</span>, id);
        <span class="hljs-type">ResultSet</span> <span class="hljs-variable">rs</span> <span class="hljs-operator">=</span> ps.executeQuery();
        <span class="hljs-comment">// ...</span>
    } <span class="hljs-keyword">finally</span> {
        conn.close();  <span class="hljs-comment">// 用完就关</span>
    }
}
</code></pre>
<p>假设100 QPS，每个连接建立耗时50ms，光建连接就得5秒。</p>
<h3 data-id="heading-3">连接池的作用</h3>
<p>连接池预先创建好一批连接，要用的时候借出去，用完还回来：</p>
<pre><code class="hljs language-lua" lang="lua">+<span class="hljs-comment">--------------------+</span>
|    连接池          |
|  +<span class="hljs-comment">----+ +----+     |</span>
|  |conn| |conn| ... |   &lt;- 空闲连接
|  +<span class="hljs-comment">----+ +----+     |</span>
+<span class="hljs-comment">--------------------+</span>
      ^      |
      |      v
   还回   借出
      ^      |
      |      v
+<span class="hljs-comment">--------------------+</span>
|    应用代码        |
+<span class="hljs-comment">--------------------+</span>
</code></pre>
<p>好处：</p>
<ol>
<li><strong>避免重复建连接</strong>：几十毫秒 → 微秒级</li>
<li><strong>控制连接数量</strong>：防止撑爆数据库</li>
<li><strong>连接复用</strong>：一个连接可以被多个请求复用</li>
</ol>
<h2 data-id="heading-4">连接池核心原理</h2>
<h3 data-id="heading-5">核心数据结构</h3>
<p>一个连接池至少要有这些东西：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleConnectionPool</span> {
    <span class="hljs-comment">// 空闲连接队列</span>
    <span class="hljs-keyword">private</span> Queue&lt;Connection&gt; idleConnections = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;&gt;();
    
    <span class="hljs-comment">// 正在使用的连接</span>
    <span class="hljs-keyword">private</span> Set&lt;Connection&gt; activeConnections = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();
    
    <span class="hljs-comment">// 最大连接数</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">maxPoolSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>;
    
    <span class="hljs-comment">// 等待获取连接的线程</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
}
</code></pre>
<h3 data-id="heading-6">获取连接的流程</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> Connection <span class="hljs-title function_">getConnection</span><span class="hljs-params">(<span class="hljs-type">long</span> timeout)</span> {
    <span class="hljs-keyword">synchronized</span> (lock) {
        <span class="hljs-type">long</span> <span class="hljs-variable">deadline</span> <span class="hljs-operator">=</span> System.currentTimeMillis() + timeout;
        
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            <span class="hljs-comment">// 1. 有空闲连接，直接返回</span>
            <span class="hljs-keyword">if</span> (!idleConnections.isEmpty()) {
                <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> idleConnections.poll();
                activeConnections.add(conn);
                <span class="hljs-keyword">return</span> conn;
            }
            
            <span class="hljs-comment">// 2. 没达到最大数，创建新连接</span>
            <span class="hljs-keyword">if</span> (activeConnections.size() &lt; maxPoolSize) {
                <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> createNewConnection();
                activeConnections.add(conn);
                <span class="hljs-keyword">return</span> conn;
            }
            
            <span class="hljs-comment">// 3. 等待其他线程归还</span>
            <span class="hljs-type">long</span> <span class="hljs-variable">waitTime</span> <span class="hljs-operator">=</span> deadline - System.currentTimeMillis();
            <span class="hljs-keyword">if</span> (waitTime &lt;= <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SQLException</span>(<span class="hljs-string">"获取连接超时"</span>);
            }
            lock.wait(waitTime);
        }
    }
}
</code></pre>
<h3 data-id="heading-7">归还连接</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">returnConnection</span><span class="hljs-params">(Connection conn)</span> {
    <span class="hljs-keyword">synchronized</span> (lock) {
        activeConnections.remove(conn);
        
        <span class="hljs-comment">// 检查连接是否还有效</span>
        <span class="hljs-keyword">if</span> (isValid(conn)) {
            idleConnections.offer(conn);
        } <span class="hljs-keyword">else</span> {
            conn.close();  <span class="hljs-comment">// 坏了就丢掉</span>
        }
        
        lock.notifyAll();  <span class="hljs-comment">// 唤醒等待的线程</span>
    }
}
</code></pre>
<h3 data-id="heading-8">连接有效性检测</h3>
<p>连接可能因为各种原因失效：</p>
<ul>
<li>数据库重启</li>
<li>网络中断</li>
<li>连接超时被踢</li>
</ul>
<p>所以借出前要检测：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isValid</span><span class="hljs-params">(Connection conn)</span> {
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 方式1：发送轻量查询</span>
        <span class="hljs-type">Statement</span> <span class="hljs-variable">stmt</span> <span class="hljs-operator">=</span> conn.createStatement();
        stmt.execute(<span class="hljs-string">"SELECT 1"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    } <span class="hljs-keyword">catch</span> (SQLException e) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<h2 data-id="heading-9">HikariCP：最快的连接池</h2>
<p>HikariCP是目前最快的Java连接池，SpringBoot 2.x默认用它。</p>
<h3 data-id="heading-10">为什么HikariCP快</h3>
<ol>
<li><strong>字节码优化</strong>：用Javassist动态生成代理类，比反射快</li>
<li><strong>无锁设计</strong>：用CAS代替synchronized，减少线程阻塞</li>
<li><strong>FastList</strong>：自定义的List实现，针对连接池场景优化</li>
<li><strong>精简代码</strong>：整个核心代码只有几千行</li>
</ol>
<h3 data-id="heading-11">基本配置</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">hikari:</span>
      <span class="hljs-comment"># 连接池大小</span>
      <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">5</span>          <span class="hljs-comment"># 最小空闲连接</span>
      <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">20</span>    <span class="hljs-comment"># 最大连接数</span>
      
      <span class="hljs-comment"># 超时设置</span>
      <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>  <span class="hljs-comment"># 获取连接超时（毫秒）</span>
      <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">600000</span>       <span class="hljs-comment"># 空闲连接超时（毫秒）</span>
      <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span>      <span class="hljs-comment"># 连接最大存活时间（毫秒）</span>
      
      <span class="hljs-comment"># 连接检测</span>
      <span class="hljs-attr">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span>
</code></pre>
<h3 data-id="heading-12">连接池大小怎么设</h3>
<p>这是最常被问的问题。官方有个公式：</p>
<pre><code class="hljs language-scss" lang="scss">连接数 = (核心数 * <span class="hljs-number">2</span>) + 有效磁盘数
</code></pre>
<p>但实际情况要复杂得多，建议从小开始逐步调整：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-comment"># 一般Web应用</span>
最大连接数 = CPU核数 * 2 ~ 4

<span class="hljs-comment"># 例如8核服务器</span>
<span class="hljs-section">maximum-pool-size: 20</span>
<span class="hljs-section">minimum-idle: 5</span>
</code></pre>
<p>为什么不是越大越好？</p>
<pre><code class="hljs">连接数太多：
├── 数据库连接数有限（MySQL默认151）
├── 每个连接都占内存（MySQL每连接约1MB）
├── 更多连接 = 更多上下文切换
└── 锁竞争更激烈
</code></pre>
<p>经验法则：<strong>宁可排队等连接，不要撑爆数据库</strong>。</p>
<h3 data-id="heading-13">超时参数详解</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">hikari:</span>
  <span class="hljs-comment"># 获取连接最多等30秒</span>
  <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
  
  <span class="hljs-comment"># 空闲连接超过10分钟就关闭</span>
  <span class="hljs-comment"># 注意：要小于数据库的wait_timeout</span>
  <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">600000</span>
  
  <span class="hljs-comment"># 连接最多存活30分钟，然后强制关闭重建</span>
  <span class="hljs-comment"># 防止连接时间太长出问题</span>
  <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span>
</code></pre>
<p><strong>关键点</strong>：<code>max-lifetime</code> 必须比数据库的 <code>wait_timeout</code> 小几分钟：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查看MySQL的wait_timeout</span>
<span class="hljs-keyword">SHOW</span> VARIABLES <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'wait_timeout'</span>;
<span class="hljs-comment">-- 默认28800秒（8小时）</span>
</code></pre>
<p>如果 <code>max-lifetime &gt; wait_timeout</code>，数据库会先把连接断掉，连接池不知道，就会拿到死连接。</p>
<h3 data-id="heading-14">监控指标</h3>
<p>HikariCP暴露了很多指标，配合Prometheus很好用：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 开启指标</span>
<span class="hljs-type">HikariConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HikariConfig</span>();
config.setMetricRegistry(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PrometheusMeterRegistry</span>(...));
</code></pre>
<p>关键指标：</p>
<pre><code class="hljs language-promql" lang="promql"># 活跃连接数
hikaricp_connections_active

# 空闲连接数
hikaricp_connections_idle

# 等待获取连接的线程数
hikaricp_connections_pending

# 获取连接耗时
hikaricp_connections_acquire_seconds
</code></pre>
<p><strong>告警规则</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">groups:</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">hikari-alerts</span>
  <span class="hljs-attr">rules:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">ConnectionPoolExhausted</span>
    <span class="hljs-attr">expr:</span> <span class="hljs-string">hikaricp_connections_pending</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">0</span>
    <span class="hljs-attr">for:</span> <span class="hljs-string">1m</span>
    <span class="hljs-attr">annotations:</span>
      <span class="hljs-attr">summary:</span> <span class="hljs-string">"连接池耗尽，有线程在等待"</span>
      
  <span class="hljs-bullet">-</span> <span class="hljs-attr">alert:</span> <span class="hljs-string">ConnectionAcquireSlow</span>
    <span class="hljs-attr">expr:</span> <span class="hljs-string">hikaricp_connections_acquire_seconds_max</span> <span class="hljs-string">&gt;</span> <span class="hljs-number">1</span>
    <span class="hljs-attr">for:</span> <span class="hljs-string">5m</span>
    <span class="hljs-attr">annotations:</span>
      <span class="hljs-attr">summary:</span> <span class="hljs-string">"获取连接超过1秒"</span>
</code></pre>
<h2 data-id="heading-15">常见问题排查</h2>
<h3 data-id="heading-16">问题1：Connection is not available</h3>
<pre><code class="hljs language-csharp" lang="csharp">HikariPool<span class="hljs-number">-1</span> - Connection <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> available, request timed <span class="hljs-keyword">out</span> after <span class="hljs-number">30000</span>ms
</code></pre>
<p>原因：连接池满了，30秒内没拿到连接。</p>
<p>排查：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 看数据库实际连接数</span>
<span class="hljs-keyword">SHOW</span> STATUS <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'Threads_connected'</span>;

<span class="hljs-comment">-- 看连接来源</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> information_schema.processlist;
</code></pre>
<p>可能原因：</p>
<ol>
<li>连接池太小</li>
<li>有慢查询占着连接不放</li>
<li>连接泄漏（借出去没还）</li>
</ol>
<h3 data-id="heading-17">问题2：连接泄漏</h3>
<p>连接借出去忘了还，池子里的连接越来越少。</p>
<p>HikariCP有泄漏检测：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">hikari:</span>
  <span class="hljs-attr">leak-detection-threshold:</span> <span class="hljs-number">60000</span>  <span class="hljs-comment"># 连接借出超过60秒就报警</span>
</code></pre>
<p>日志会显示借出连接的堆栈，定位泄漏代码：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">ProxyLeakTask</span> <span class="hljs-selector-tag">-</span> <span class="hljs-selector-tag">Connection</span> <span class="hljs-selector-tag">leak</span> <span class="hljs-selector-tag">detection</span> <span class="hljs-selector-tag">triggered</span> <span class="hljs-selector-tag">for</span> <span class="hljs-selector-tag">conn0</span>
    <span class="hljs-selector-tag">at</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.UserService</span><span class="hljs-selector-class">.getUser</span>(UserService.<span class="hljs-attribute">java</span>:<span class="hljs-number">42</span>)
    <span class="hljs-selector-tag">at</span> ...
</code></pre>
<h3 data-id="heading-18">问题3：连接被数据库断开</h3>
<pre><code class="hljs language-perl" lang="perl">Communications <span class="hljs-keyword">link</span> failure
The <span class="hljs-keyword">last</span> packet successfully received from the server was xxx milliseconds ago
</code></pre>
<p>原因：连接闲置太久，被数据库踢了。</p>
<p>解决：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">hikari:</span>
  <span class="hljs-comment"># 定期发心跳保活</span>
  <span class="hljs-attr">keepalive-time:</span> <span class="hljs-number">30000</span>  <span class="hljs-comment"># 每30秒发一次心跳</span>
  
  <span class="hljs-comment"># 或者让连接在数据库踢之前主动关闭</span>
  <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1700000</span>  <span class="hljs-comment"># 小于wait_timeout</span>
</code></pre>
<h3 data-id="heading-19">问题4：启动时连接失败</h3>
<p>服务启动时数据库还没好，连接失败：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">hikari:</span>
  <span class="hljs-comment"># 初始化时允许失败</span>
  <span class="hljs-attr">initialization-fail-timeout:</span> <span class="hljs-number">-1</span>
  
  <span class="hljs-comment"># 慢慢重试</span>
  <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
</code></pre>
<p>或者用优雅启动，等数据库好了再接入流量。</p>
<h2 data-id="heading-20">多数据源配置</h2>
<p>实际项目经常要连多个库：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@Primary</span>
    <span class="hljs-meta">@ConfigurationProperties("spring.datasource.primary.hikari")</span>
    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">primaryDataSource</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> DataSourceBuilder.create().type(HikariDataSource.class).build();
    }
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@ConfigurationProperties("spring.datasource.secondary.hikari")</span>
    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">secondaryDataSource</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> DataSourceBuilder.create().type(HikariDataSource.class).build();
    }
}
</code></pre>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">primary:</span>
      <span class="hljs-attr">hikari:</span>
        <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://master:3306/db</span>
        <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">20</span>
    <span class="hljs-attr">secondary:</span>
      <span class="hljs-attr">hikari:</span>
        <span class="hljs-attr">jdbc-url:</span> <span class="hljs-string">jdbc:mysql://slave:3306/db</span>
        <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">10</span>
</code></pre>
<h3 data-id="heading-21">读写分离</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RoutingDataSource</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractRoutingDataSource</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> Object <span class="hljs-title function_">determineCurrentLookupKey</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> TransactionSynchronizationManager.isCurrentTransactionReadOnly() 
            ? <span class="hljs-string">"slave"</span> : <span class="hljs-string">"master"</span>;
    }
}
</code></pre>
<h2 data-id="heading-22">生产经验</h2>
<h3 data-id="heading-23">经验1：监控先行</h3>
<p>上线前先把监控加上。连接池问题往往是间歇性的，没监控数据很难定位。</p>
<h3 data-id="heading-24">经验2：压测确定参数</h3>
<p>不同业务对连接池需求不同。用压测工具（JMeter、wrk）在真实负载下调整参数。</p>
<h3 data-id="heading-25">经验3：分环境配置</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 开发环境</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">profiles:</span> <span class="hljs-string">dev</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">hikari:</span>
      <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">5</span>

<span class="hljs-comment"># 生产环境</span>
<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">profiles:</span> <span class="hljs-string">prod</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">hikari:</span>
      <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">30</span>
</code></pre>
<h3 data-id="heading-26">经验4：多机房注意网络</h3>
<p>我们有跨机房数据库访问的场景，连接建立延迟高。这种情况下：</p>
<ol>
<li>适当增大 <code>connection-timeout</code></li>
<li>用更激进的预热策略</li>
<li>我们用星空组网把两边网络打通后，延迟稳定很多</li>
</ol>
<h2 data-id="heading-27">总结</h2>
<p>连接池的核心就三件事：</p>

























<table><thead><tr><th>功能</th><th>配置项</th><th>建议值</th></tr></thead><tbody><tr><td>池大小</td><td>maximum-pool-size</td><td>CPU核数 * 2 ~ 4</td></tr><tr><td>超时控制</td><td>connection-timeout</td><td>30秒</td></tr><tr><td>连接存活</td><td>max-lifetime</td><td>&lt; 数据库wait_timeout</td></tr></tbody></table>
<p>记住几个原则：</p>
<ol>
<li><strong>连接数不是越多越好</strong>，够用就行</li>
<li><strong>监控比调参重要</strong>，先能看到问题</li>
<li><strong>连接泄漏是大忌</strong>，用框架自动管理</li>
<li><strong>超时要协调</strong>，连接池和数据库要配合</li>
</ol>
<p>连接池配好了是透明的，配不好就是定时炸弹。希望这篇文章能帮你理解原理，遇到问题时知道往哪个方向排查。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Kotlin协程：Job.cancel() 和 Scope.cancel() 的区别详解！！！]]></title>    <link>https://juejin.cn/post/7587704265054945318</link>    <guid>https://juejin.cn/post/7587704265054945318</guid>    <pubDate>2025-12-26T03:28:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587704265054945318" data-draft-id="7587779957674573875" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Kotlin协程：Job.cancel() 和 Scope.cancel() 的区别详解！！！"/> <meta itemprop="keywords" content="Kotlin,Android,Android Jetpack"/> <meta itemprop="datePublished" content="2025-12-26T03:28:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QING618"/> <meta itemprop="url" content="https://juejin.cn/user/339115460529117"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Kotlin协程：Job.cancel() 和 Scope.cancel() 的区别详解！！！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/339115460529117/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QING618
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T03:28:58.000Z" title="Fri Dec 26 2025 03:28:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 Kotlin 协程中，<code>Job.cancel()</code> 和 <code>Scope.cancel()</code> 都用于取消协程，但它们的作用范围和行为有重要区别：</p>
<h2 data-id="heading-0">1. Job.cancel()</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> job = launch {
    <span class="hljs-comment">// 协程体</span>
}
job.cancel()  <span class="hljs-comment">// 只取消这个特定的 job</span>
</code></pre>
<p><strong>特点：</strong></p>
<ul>
<li>只取消<strong>单个 Job</strong> 及其子协程</li>
<li>不会影响同一作用域中的其他 Job</li>
<li>Job 被取消后，仍然可以附加新的子协程</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> job1 = scope.launch { <span class="hljs-comment">/* 任务1 */</span> }
<span class="hljs-keyword">val</span> job2 = scope.launch { <span class="hljs-comment">/* 任务2 */</span> }

job1.cancel()  <span class="hljs-comment">// 只取消 job1，job2 继续运行</span>
</code></pre>
<h2 data-id="heading-1">2. Scope.cancel()</h2>
<pre><code class="hljs language-kotlin" lang="kotlin">scope.cancel()  <span class="hljs-comment">// 取消整个作用域及其所有协程</span>
</code></pre>
<p><strong>特点：</strong></p>
<ul>
<li>取消<strong>整个作用域</strong>中的所有协程</li>
<li>作用域被取消后，<strong>不能再启动新的协程</strong></li>
<li>所有子 Job 都会被取消</li>
</ul>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> scope = CoroutineScope(Dispatchers.IO)

scope.launch { <span class="hljs-comment">/* 任务1 */</span> }
scope.launch { <span class="hljs-comment">/* 任务2 */</span> }

scope.cancel()  <span class="hljs-comment">// 取消所有任务，且 scope 不能再 launch 新协程</span>
</code></pre>
<h2 data-id="heading-2">3. 关键区别对比</h2>






























<table><thead><tr><th>特性</th><th>Job.cancel()</th><th>Scope.cancel()</th></tr></thead><tbody><tr><td>作用范围</td><td>单个 Job + 其子协程</td><td>整个作用域 + 所有协程</td></tr><tr><td>后续使用</td><td>可继续启动新协程</td><td>作用域已失效，不能启动新协程</td></tr><tr><td>状态影响</td><td>Job 进入 Cancelling 状态</td><td>Scope 和所有 Job 都取消</td></tr><tr><td>典型场景</td><td>取消特定任务</td><td>清理整个界面/组件资源</td></tr></tbody></table>
<h2 data-id="heading-3">4. 实际例子</h2>
<h3 data-id="heading-4">Job.cancel() 示例</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> scope = CoroutineScope(SupervisorJob())

<span class="hljs-keyword">val</span> jobA = scope.launch {
    delay(<span class="hljs-number">1000</span>)
    println(<span class="hljs-string">"Job A 完成"</span>)
}

<span class="hljs-keyword">val</span> jobB = scope.launch {
    delay(<span class="hljs-number">2000</span>)
    println(<span class="hljs-string">"Job B 完成"</span>)
}

<span class="hljs-comment">// 只取消 jobA，jobB 继续运行</span>
jobA.cancel()

<span class="hljs-comment">// scope 仍然可用，可以启动新协程</span>
scope.launch { println(<span class="hljs-string">"新协程"</span>) }
</code></pre>
<h3 data-id="heading-5">Scope.cancel() 示例</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> scope = CoroutineScope(SupervisorJob())

scope.launch { <span class="hljs-comment">/* 任务1 */</span> }
scope.launch { <span class="hljs-comment">/* 任务2 */</span> }

<span class="hljs-comment">// 取消整个作用域</span>
scope.cancel()

<span class="hljs-comment">// 这里会抛出异常：Scope is cancelled</span>
scope.launch { println(<span class="hljs-string">"这不会执行"</span>) }
</code></pre>
<h2 data-id="heading-6">5. 重要细节</h2>
<h3 data-id="heading-7">Scope.cancel() 的内部实现</h3>
<p>kotlin</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// CoroutineScope 的 cancel() 实际上调用了关联 Job 的 cancel()</span>
<span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> CoroutineScope.<span class="hljs-title">cancel</span><span class="hljs-params">(cause: <span class="hljs-type">CancellationException</span>? = <span class="hljs-literal">null</span>)</span></span> {
    <span class="hljs-keyword">val</span> job = coroutineContext[Job]
        ?: error(<span class="hljs-string">"Scope cannot be cancelled because it does not have a job"</span>)
    job.cancel(cause)
}
</code></pre>
<h3 data-id="heading-8">结构化并发的体现</h3>
<ul>
<li>在结构化并发中，通常使用 <code>scope.cancel()</code> 来清理资源</li>
<li>ViewModel 销毁时：<code>viewModelScope.cancel()</code></li>
<li>Activity 销毁时：<code>lifecycleScope.cancel()</code></li>
</ul>
<h3 data-id="heading-9">异常处理差异</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Job.cancel() 可以指定原因</span>
job.cancel(<span class="hljs-string">"用户取消操作"</span>)

<span class="hljs-comment">// Scope.cancel() 同样可以</span>
scope.cancel(TimeoutCancellationException(<span class="hljs-string">"超时"</span>))
</code></pre>
<h2 data-id="heading-10">6. 最佳实践建议</h2>
<ol>
<li>
<p><strong>使用 Job.cancel()</strong>  当需要：</p>
<ul>
<li>取消特定的后台任务</li>
<li>实现可取消的单个操作</li>
<li>不影响其他并行任务</li>
</ul>
</li>
<li>
<p><strong>使用 Scope.cancel()</strong>  当需要：</p>
<ul>
<li>组件（Activity/Fragment）销毁时清理资源</li>
<li>取消整个工作流的所有任务</li>
<li>确保没有协程泄露</li>
</ul>
</li>
<li>
<p><strong>在 ViewModel 中</strong>：</p>
</li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyViewModel</span> : <span class="hljs-type">ViewModel</span>() {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> customScope = CoroutineScope(SupervisorJob())
    
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startWork</span><span class="hljs-params">()</span></span> {
        customScope.launch { <span class="hljs-comment">/* 工作 */</span> }
    }
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCleared</span><span class="hljs-params">()</span></span> {
        customScope.cancel()  <span class="hljs-comment">// 清理自定义作用域</span>
        <span class="hljs-keyword">super</span>.onCleared()
    }
    
    <span class="hljs-comment">// viewModelScope 会自动管理，无需手动取消</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">useViewModelScope</span><span class="hljs-params">()</span></span> {
        viewModelScope.launch { <span class="hljs-comment">/* 自动绑定生命周期 */</span> }
    }
}
</code></pre>
<p><strong>核心总结</strong>：<code>Job.cancel()</code> 是<strong>选择性取消</strong>，<code>Scope.cancel()</code> 是<strong>全面清理</strong>。在结构化并发中，通常让作用域管理生命周期，仅在特殊情况下单独取消特定 Job。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从“抖音同款”到“豆包同款”：视频云正在进入 Agent 时代]]></title>    <link>https://juejin.cn/post/7587779957674672179</link>    <guid>https://juejin.cn/post/7587779957674672179</guid>    <pubDate>2025-12-26T03:40:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587779957674672179" data-draft-id="7587704265054994470" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从“抖音同款”到“豆包同款”：视频云正在进入 Agent 时代"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-12-26T03:40:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="字节跳动视频云技术团队"/> <meta itemprop="url" content="https://juejin.cn/user/3026268632912584"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从“抖音同款”到“豆包同款”：视频云正在进入 Agent 时代
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3026268632912584/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    字节跳动视频云技术团队
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T03:40:20.000Z" title="Fri Dec 26 2025 03:40:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者 | 凌敏</p>
<p>对于普通人而言，音视频算得上是最“接地气”的技术——不需要具备专业背景，就能直观地感受到技术能力高低带来的体验层面的差异。比如，观看世界杯直播，模糊的画面、明显的延迟、卡顿的互动，都能直接影响球迷观看体验。</p>
<p>在移动互联网时代，人们对于音视频技术的要求其实很简单，就是“看得清、看得爽”。这也是火山引擎视频云能够在这一时期杀出重围的关键——<strong>火山引擎将抖音在亿级 DAU 场景下长期打磨和验证的能力，封装成一系列解决方案，向业界输出“抖音同款”的音视频能力，重点解决画质、时延、稳定性和大规模分发问题，为用户带来更高清、更实时、更沉浸的视频体验。</strong></p>
<p>但到了 AI 时代，人们对音视频能力的要求又迈向新的高度，视频不只用来“看”，还要能够“听”和“理解”，甚至能够与人“对话”。比如，在教育场景，大家希望 AI 老师能实时对话，并能根据辅导对象智能匹配教学内容；在娱乐场景，大家希望 AI 陪伴助手更懂自己，更有“人味儿”。<strong>什么样的视频云，才能支撑起这一想象？</strong> 在 2025 年冬季火山引擎原动力大会“智能视频云”论坛上，火山引擎视频云通过一场自我进化给出了答案——<strong>过去，火山引擎视频云提供的是“抖音同款”的经典能力。这一次，火山引擎视频云将进化为打造“</strong> <strong>豆包</strong> <strong>同款” 的生成式智能。</strong></p>
<p>面对 AI 时代的音视频场景，“豆包同款”视频云 <strong>在技术侧，提供从底层（</strong> <strong>AIGC</strong> <strong>传输系统）、到核心引擎 AI MediaKit+MIPP（智能媒体处理平台），再到顶层音视频互动</strong> <strong>智能体</strong> <strong>三重支撑；在服务侧，</strong> <strong>火山引擎</strong> <strong>视频与边缘服务的海外拓展，正帮助中国企业加速出海。</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32702c8ccd0b408299150ff588a0daa9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo6KeG6aKR5LqR5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767325220&amp;x-signature=a67GpVNtMoDU3JvxNquR%2B%2Bc1r7Y%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">1 从“抖音同款”到“豆包同款”，音视频技术的三重进化底层技术支撑：AIGC 传输系统让多模态交互成为可能</h2>
<p>正如前文所言，AI 时代，人们对于音视频的期待提升到了能理解、能互动的新高度。只有获取更多维度的信息，AI 才能真正理解用户意图，生成准确、自然的响应。这也意味着，传输系统需要处理更多模态的信息，比如视频、音频、图像、文字等。</p>
<p>在这样的需求背景下，支撑豆包等大规模 AI 应用的 AIGC 传输系统应运而生。它<strong>不仅支持实时、</strong> <strong>长连接</strong> <strong>的多</strong> <strong>模态</strong> <strong>数据传输，还能覆盖多样化的实时交互场景</strong>：从实时音视频传输到实时语音流，再到 Push-to-Talk 半实时语音交互，以控制信令传输，都能基于这一套基础设施稳定运行。为了提升复杂网络环境下的稳定性，AIGC 传输系统还内置了弱网对抗机制，保障用户和智能体的流畅互动。</p>
<p>AIGC 传输系统带来的，是面向人机实时交互场景的多模态数据传输能力的升级，它能支撑大规模、高并发和突发业务场景下的 AIGC 多模态数据实时传输，为智能体应用提供稳定、实时、可扩展的多模态数据传输能力。在传输之上，还需要一个覆盖生产端、分析端、消费端的全链路核心引擎，对底层原子能力进行统一编排与调用。基于 AIGC 传输系统与分布式多媒体智能处理平台 MIPP 的能力支撑，火山引擎视频云核心引擎 AI MediaKit 也实现了全面升级。</p>
<p>核心引擎：AI MediaKit 将“王牌”原子能力引入大模型</p>
<p>在过去，传统媒体工具套件的核心是媒体数据处理与服务的技术集合，这套经典能力长期用于开发音视频播放或录制的各类功能。但在 AIGC 时代，媒体价值链路被重新定义，内容不再只是拍摄、播放，而是生成、分析、理解、消费；用户也不再只是观看，而是通过自然语言、语音、图像等方式参与交互。</p>
<p>这也是为什么，火山引擎视频云选择将经典能力升级为 AI MediaKit——<strong>作为面向 AI</strong> <strong>云原生</strong> <strong>时代的极致效率工具，AI MediaKit 将原先在抖音、</strong> <strong>豆包</strong> <strong>等业务中打磨成熟的媒体处理技术，升级成更细粒度的原子能力。这些在视频云时代长期积累的媒体处理原子能力，也是火山引擎最核心、也最具竞争力的能力。</strong> 在视频理解、AI 推搜、内容二次创作等场景中，AI MediaKit 能够将大模型的多模态理解能力和 AIGC 生成能力引入音视频处理流程，让系统不仅能“看见”和“听见”，还能理解内容含义，从而更好地放大媒体价值。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f52c88750684423cb0f080f3209b28a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo6KeG6aKR5LqR5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767325220&amp;x-signature=Ex6I8Xahb1PtygqPD56VdQQNTTg%3D" alt="" loading="lazy"/></p>
<p>AI MediaKit 的另一个核心价值在于，能<strong>提升内容生产效率和体验</strong>。比如，AI MediaKit 面向大模型调用与编排更加友好。与直接调用大模型能力相比，AI MediaKit 提供预设的、可配置的 AI 工作流，可以从数据预处理和后处理、并发任务处理降低延时等多个角度，把多媒体处理能力和大模型原子能力编排得更好，效率也更高。</p>
<p>以视频翻译场景为例，过去长期面对人工翻译成本高、制作周期长，传统机器翻译效果不理想、无法提供沉浸式的播放体验等核心痛点。“声影智译”基于豆包大模型，结合视频云的理解和内容预处理能力 + 多媒体工程能力和知识库，比如为大模型提供更适合的“原材料”，提供平滑的语句切分、适宜语速、精准定位说话人等工程能力，确保整体翻译效果可以达到业务生产水平。从而整体实现视频多模态翻译，包括文本翻译、声音翻译以及面容翻译。</p>
<p>AI MediaKit 深度融合生成式 AI 和多模态理解能力，提升多媒体处理能力的深度和广度。此次升级不仅带来了能力与效率的提升，也推动多媒体能力从单一工具向价值放大器转变，帮助企业以更高性价比构建面向生产级的 AI 应用与音视频智能体。</p>
<p>顶层应用：音视频互动智能体推动交互体验升级</p>
<p>构建一个真正可靠、能在生产环境中稳定运行的智能体并非易事，需要整合一整套复杂系统能力。为了降低企业构建音视频智能体门槛，火山引擎提供了一套完整的解决方案——将原本只是工具属性的音视频对话 AI 方案，升级为一个交流更顺畅、体验更好，并且具有记忆、能自己解决问题的音视频互动智能体。企业能够直接调用这套方案，快速搭建智能体。</p>
<p>火山引擎智能互动产品负责人杨若扬表示，音视频互动智能体此次升级最关键的转变在于两方面：<strong>其一，</strong> <strong>AI</strong> <strong>在感官体验上更加接近真人；其二，AI 智能体拥有特定场景的知识和技能。</strong> 为了让音视频互动智能体更具“真人感”，火山引擎通过模型精调，使得智能体的回复更加口语化，并覆盖了开心、激动、撒娇、安慰、生气等 20 多种情绪状态，以及夹子音、气泡音、悄悄话等多种表达方式，甚至还能根据上下文内容及对话对象的情绪状态，自动选择合适的表达方式，并在语速、音调甚至方言等方面进行动态调整。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5753d0b072a4df0ad65e8a1c5fa8f96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a2X6IqC6Lez5Yqo6KeG6aKR5LqR5oqA5pyv5Zui6Zif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767325220&amp;x-signature=PFhlIMdXSb%2FEkDWNbBlo9jy7E1U%3D" alt="" loading="lazy"/></p>
<p>本次音视频互动智能体升级带来最大的惊喜，来自<strong>声纹</strong> <strong>识别——能够通过不同音色识别对话对象。这项能力对于不少应用场景来说，极为关键。</strong> 比如，在人和 AI 进行一对一交流的过程中，如果不具备声纹识别能力，大模型往往会将所有人声一并识别，导致交互混乱。通过声纹识别，智能体可以认准主讲人的声音，将非主讲人的人声全部屏蔽，实现声纹层面的降噪效果。目前，该项能力已支持无感注册，仅需采集约 10 秒的目标音色即可完成识别。</p>
<p>此外，声纹识别还能根据不同说话对象，实现个性化应答。以 AI 玩具为例，当智能体识别到是在与小孩子交流时，回应的声音会更加可爱；当智能体识别到是在与爸爸交流时，除了回应内容发生变化，也会切换成更为自然的语气。</p>
<p>对于陪伴类 AI 应用而言，最重要的一个功能就是长期记忆。音视频互动智能体本次在长期记忆方面的升级，也是一大亮点。通过持续记录历史交流内容，智能体能<strong>将原本碎片化的交互变成连续性故事，基于这些记忆，智能体更能理解用户的偏好，甚至能够主动提供信息与建议，人和智能体的沟通也更加个性化。</strong> 比如，个人助手能够记住用户关注的行业热点、工作习惯，陪伴应用能够记住用户的年龄、性别、喜好，教育应用能够记住孩子的年龄信息以及各学科的学习进度和理解情况。</p>
<p>在教育、游戏、创作等典型应用场景中，音视频互动智能体的价值可以得到最佳体现。在<strong>教育场景</strong>中，AI 老师通过声音复刻技术以及情绪、表达方式上的优化，能够与线上真人老师高度一致。以“与爱为舞”为例，通过打造“全时、全知、全能”的 AI 导师，能够实现“人机协同”的深度耦合。</p>
<p>在<strong>游戏场景</strong>中，AI 游戏陪玩不仅能提供情绪价值，还能实时感知游戏进程，为玩家提供专业攻略指导。以 TapTap 游戏陪玩 Agent 为例，其 AI 游戏助手一端借助火山引擎实时音视频实现了用户交互链路，另一端对接自有的多模态理解能力与大模型推理能力，并通过融合模型能力与搭建系统工程的方式，TapTap 将 Agent 拆成三层能力：感知游戏、理解游戏，以及基于完整上下文和游戏世界引擎，生成对用户友好的提示，并通过 UI 和语音的方式与玩家进行互动。</p>
<p>与教育、游戏场景相比，在<strong>创作场景</strong>中，音视频互动智能体扮演的角色稍显不同。以今年较为火爆的视频生成、Vibe coding 场景为例，高质量的 Prompt 门槛越来越高，普通用户只能依靠“抽卡”。音视频互动智能体能通过多轮对话理解用户意图，明确创作目标，进而提升创作可控性，提高效率。</p>
<p>在智能硬件方面，火山引擎联合乐鑫共同推出了一套名为“喵伴”的硬件开发套件。 <strong>“喵伴”最大的亮点在于，这是一个能够开箱即用的硬件 Demo 方案，开发者可以方便快捷地搭建自己的产品，5 分钟跑通业务链路，快速进行功能验证。</strong> 此外，“喵伴”提供标准化接口，能够兼容多硬件设备硬件，大幅降低适配成本。</p>
<p>可以预见的是，随着技术和应用的不断拓展，音视频互动智能体的智能交互体验，还会带来更多惊喜。其中一个较为清晰的趋势就是多人群聊，通过多智能体协作，为用户带来更复杂、多角色的互动体验，从而为视频会议、AI 教学、狼人杀、游戏语音带来更多玩法和可能性。</p>
<p>从底层（AIGC 传输系统）、到核心引擎 AI MediaKit+MIPP（智能媒体处理平台），再到顶层音视频互动智能体，火山引擎视频云将音视频中最核心多项能力进行了系统性重构与升级。音视频技术侧的行业叙事，已被火山引擎“卷”到了新高度。而在服务侧，火山引擎也试图开“卷”——将一系列音视频能力，打造成中国企业出海的“秘密武器”。</p>
<h2 data-id="heading-1">2 国产 AI 应用，掀起出海浪潮</h2>
<p>国产 AI 应用出海，早已是不可逆的浪潮。《2025 年 AIGC 海外移动应用市场分析》报告显示，2025 年 Q1 中国 AI 应用全球市场份额跃升至 7.9%，并且还在持续增长。但对不少企业而言，出海始终是一道难解的“题”：方案适配、网络体验、资源利用、商业模式……每个都是牵一发而动全身的关键变量。</p>
<p>一面是企业迫切的出海需求，一面是艰巨的现实挑战。火山引擎视频与边缘服务通过一套体系化的出海解决方案，帮助企业征战海外市场。比如，为了解决出海应用体验差、不稳定、成本高等痛点，火山引擎通过智能全球加速（IGA），提供了一套 AI 应用加速方案，能让大模型请求、模型训练数据传输以及模型生成等场景，在全球范围内实现更快、更稳、更安全，帮助开发者降低试错成本，加速验证和落地 AI 应用的商业模式。</p>
<p>为了提升互动的实时性，火山引擎还推出了面向出海场景的 Conversational AI 解决方案，支持超过一百种语言的交互能力。同时支持音视频、图像等多模态的交互，通过模型、语音、视频以及数字人通话场景，帮助企业实现业务创新。</p>
<p>当前，火山引擎这套出海解决方案已经帮助多个中国 AI 应用加速走向全世界。以近几年热门的出海方向短剧、漫剧场景为例，麦芽短剧依托火山引擎声影智译，实现了高效、专业的 AI 视频翻译，视频内容能够无障碍全球化传播，并通过精细化字幕擦除，实现高质量的无痕擦除，最大程度的还原视频画面。</p>
<p>从内容生产到分发再到变现，火山引擎视频云通过一场全方位的进化，构成了一条完整的出海价值链条。毕竟在追求效率与商业回报上，火山引擎一直走的是极为务实的路线，将技术优势持续转化为可规模化、可验证的业务价值。</p>
<p>而这轮从“抖音同款”经典能力，到“豆包同款”生成式智能的进化，本质上，也是火山引擎在为下一个十年的交互方式做准备。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[nghttp2 与现代 HTTP 生态：从幕后英雄到 HTTP/2 事实标准]]></title>    <link>https://juejin.cn/post/7587684397531217947</link>    <guid>https://juejin.cn/post/7587684397531217947</guid>    <pubDate>2025-12-26T03:51:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587684397531217947" data-draft-id="7587699390204149770" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="nghttp2 与现代 HTTP 生态：从幕后英雄到 HTTP/2 事实标准"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-26T03:51:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="自由生长2024"/> <meta itemprop="url" content="https://juejin.cn/user/1591748569862670"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            nghttp2 与现代 HTTP 生态：从幕后英雄到 HTTP/2 事实标准
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748569862670/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    自由生长2024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T03:51:08.000Z" title="Fri Dec 26 2025 03:51:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在互联网协议快速迭代的今天，HTTP/3 已经逐渐成为许多大站点的标配，但提起 HTTP/2 的普及史，几乎绕不开一个名字——<strong>nghttp2</strong>。这个由 Tatsuhiro Tsujikawa 开发的纯 C 语言 HTTP/2 实现库，虽然低调，却堪称 HTTP/2 时代最成功的幕后英雄。</p>
<h3 data-id="heading-0">一、nghttp2 为什么如此重要？</h3>
<p>HTTP/2 于 2015 年正式成为 RFC 7540，带来了多路复用、头部压缩、服务器推送等革命性特性。但与此同时，浏览器和服务器都需要一个可靠、高性能的 HTTP/2 帧层实现。当时市面上几乎没有成熟的开源选项，而 nghttp2 恰好在 2012 年左右就开始开发，并在 HTTP/2 标准化前后迅速成熟，成为了事实上的参考实现。</p>
<p>它最大的特点是：</p>
<ul>
<li>性能优秀（纯 C，内存占用极低）</li>
<li>API 设计清晰，易于集成</li>
<li>严格遵循 RFC，同时保持前瞻性（很早就支持优先级、流量控制、推送等全部特性）</li>
<li>维护极其活跃（至今仍在持续更新）</li>
</ul>
<p>正是因为这些优点，nghttp2 迅速成为 HTTP/2 生态的“基础设施”。</p>
<h3 data-id="heading-1">二、哪些明星项目在用它？</h3>
<p>几乎所有主流软件在支持 HTTP/2 时，都直接或间接依赖 nghttp2：</p>
<ul>
<li><strong>curl</strong> —— 全球使用最广泛的命令行 HTTP 客户端。从 7.33.0 版起，curl 的 HTTP/2 支持完全基于 nghttp2。只要你执行过 <code>curl --http2</code>，几乎肯定就在用 nghttp2。</li>
<li><strong>Apache HTTP Server</strong> —— 其官方 mod_http2 模块依赖 nghttp2，是最早提供完整 HTTP/2 支持的主流 Web 服务器之一。</li>
<li><strong>Node.js</strong> —— 在 v18 之前，其内置的 http2 模块长期依赖 nghttp2（位于 deps/nghttp2 目录）。因此，在 2018–2022 年间，几乎所有使用 Node.js HTTP/2 的服务都在用它。但从 Node.js 18 起，官方已切换为自研实现，不再依赖 nghttp2。</li>
<li><strong>nghttp2 项目自带工具</strong> —— 如 nghttpx（功能强大的 HTTP/2 → HTTP/1.1 多协议代理）、h2load（业内最权威的 HTTP/2/3 基准测试工具之一）。</li>
</ul>
<p>除此之外，还有 Kamailio、Open5GS（5G 核心网）等电信级项目，以及无数 Linux 发行版软件包，都把 nghttp2 作为 curl、apache2 等包的硬依赖。</p>
<p>可以说：<strong>只要你用过带有 HTTP/2 的 curl、Apache，或者 Node.js 的 http2 模块，你就已经在间接使用 nghttp2 了</strong>。</p>
<h3 data-id="heading-2">三、从 HTTP/2 到 HTTP/3，nghttp2 的“接班人”们</h3>
<p>随着 HTTP/3（基于 QUIC + UDP）的兴起，nghttp2 的直接使命已经告一段落，但它的“家族”却完美接棒：</p>
<ul>
<li><strong>ngtcp2</strong> —— 负责 QUIC 传输层（名字中的 ‘tcp’ 意指其提供了类似 TCP 的可靠流传输语义，尽管实际运行在 UDP 之上）</li>
<li><strong>nghttp3</strong> —— 负责 HTTP/3 的帧层、QPACK 头部压缩等上层语义</li>
</ul>
<p>如今 curl 官方最推荐的 HTTP/3 实现组合就是 <strong>ngtcp2 + nghttp3 + OpenSSL/quictls/wolfSSL</strong>，延续了 nghttp2 团队一贯的高质量传统。</p>
<h3 data-id="heading-3">四、结语：低调的基石，持久的影响力</h3>
<p>nghttp2 没有华丽的营销，也没有成为独立的公司，但它用最朴实的方式完成了使命：<br/>
让 HTTP/2 从 RFC 论文走进千千万万的服务器、客户端和开发者工具，成为 2015 年以来互联网最广泛部署的 HTTP 协议版本之一。</p>
<p>在 HTTP/3 逐渐普及的 2025 年，我们或许已经很少直接提到 nghttp2 这个名字，但它的 DNA 依然活在 curl、Node.js、Apache、nghttpx、h2load，以及整个 nghttp 家族之中。</p>
<p>它不是最闪耀的明星，却是最坚实的基石。<br/>
很多时候，真正改变世界的东西，往往就藏在这些安静的 C 语言库里。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[效率翻倍！自媒体人必备神器：用扣子(Coze)搭建专属素材库，告别灵感枯竭]]></title>    <link>https://juejin.cn/post/7587729264184967231</link>    <guid>https://juejin.cn/post/7587729264184967231</guid>    <pubDate>2025-12-26T03:20:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587729264184967231" data-draft-id="7587713001714778166" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="效率翻倍！自媒体人必备神器：用扣子(Coze)搭建专属素材库，告别灵感枯竭"/> <meta itemprop="keywords" content="Coze"/> <meta itemprop="datePublished" content="2025-12-26T03:20:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吾鳴"/> <meta itemprop="url" content="https://juejin.cn/user/3683842894347076"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            效率翻倍！自媒体人必备神器：用扣子(Coze)搭建专属素材库，告别灵感枯竭
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3683842894347076/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吾鳴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-26T03:20:16.000Z" title="Fri Dec 26 2025 03:20:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是吾鳴。专注于分享提升工作与生活效率的工具，无偿分享AI领域相关的精选报告，持续关注AI的前沿动向。</p>
<p>前面写了篇文章介绍如何使用扣子编程来实现一个抓取公众号文章内容（《使用扣子（Coze）无代码方式实现了一个抓取公众号文章内容的工作流》）的工作流，后台有挺多朋友私信问，能不能优化一下，做成可以批量采集的，这样可以大大提升素材收集时候效率，同时一些链接可否直接点击跳转，图片可否直接查看等。</p>
<p>做自媒体的，素材库肯定是少不了，平常创作的时候，可以看看素材库中的素材，有些图片可以作为二创的来源。</p>
<p>和这些朋友交流，发现他（她）们现在使用的素材库里面的链接直接就是文本，没法直接点击跳转；图片也是一个url，没法直接预览，使用起来效率不高。</p>
<p>原本我也想偷偷懒，想直接使用扣子编程继续优化之前的Demo，奈何它还不是特别成熟，所以就自己手撸了一个工作流，这个工作流可以基于飞书多维表格，你只需要把你想收集的文章链接填入表格中，然后在工作流侧填入这个表格，便可以实现文章的内容采集到飞书多维表格中，可以看看效果。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1863508e8074fb4a219656a62d5c870~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324016&amp;x-signature=Ar%2BE%2Bo9nO7sQJlBqF6u3Q0%2B2mG0%3D" alt="" loading="lazy"/></p>
<p>表格中的内容包含“文章链接”、“标题”、“作者”、“发文时间”、“封面图”、“配图”、“摘要”、“发文位置”、“文案内容”、“原文链接”。</p>
<p>这个工作流有两个难点，第一个是微信公众号文章的内容信息的提取，第二个就是多维表格中的字段类型并非都是简单类型，需要对数据的处理较多。</p>
<p>下面将开始对这个工作流做下详细的讲解，内容比较干，建议收藏，需要的时候可以随时找到。</p>
<h2 data-id="heading-0">1. 完整的工作流程</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/082ab94f2c6149f6b6dbc098f7ba6f62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324016&amp;x-signature=CJadKnG9QwEEEU9J%2Bnh0sqil1aA%3D" alt="" loading="lazy"/></p>
<p>1、读取文章链接：首先会先从飞书表格中读取你整理出来的文章链接。</p>
<p>2、获取飞书认证：这个需要先去获取飞书的凭证，以便在上传素材到多维表格的时候需要使用。</p>
<p>3、获取文章内容：通过三方的插件，根据提供的文章链接获取文章内容，并解析出来标题、封面图、配图等信息。</p>
<p>4、图片上传表格：通过飞书多维表格提供的接口上传图片到多维表格中，后面添加附件时，需要使用到此接口返回的信息。</p>
<p>5、文章数据转成数据表格式：需要把封面图、配图列表、标题、文章内容等信息转成数据表需要的格式。</p>
<p>6、文章数据写入数据表：把已经转好格式的记录数据，通过使用飞书多维表格写入记录的接口把记录都写入到数据表中。</p>
<h2 data-id="heading-1">2. 工作流详细节点解读</h2>
<h3 data-id="heading-2">2.1. 开始</h3>
<ul>
<li>app_token：飞书多维表格标识</li>
<li>table_name：飞书多维表格数据表名称</li>
<li>api_token：插件认证，可后台回复【芝麻开门】，私聊我获取</li>
<li>fs_app_id：飞书应用ID</li>
<li>fs_app_secret：飞书应用密钥</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd98db8d5af649d696619b52089afa4d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324016&amp;x-signature=bGZRyySgGJqBYDMTBPA9aQmGbS0%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-3">2.1.1. app_token&amp;table_name如何获取？</h4>
<p>点击多维表格，进入到详情页，点击一张数据表，app_token和table_name就是如我下图这样获取，复制到对应的参数上即可。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/542cc3219aa34a4d8db92fca377c4292~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324016&amp;x-signature=TbSqorHNRChwpcPaBTqsDZZFHto%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-4">2.1.2. fs_app_id&amp;fs_app_secret如何获取？</h4>
<p>从飞书的开放平台进入到开发者后台（<a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.feishu.cn%2Fapp%3Flang%3Dzh-CN" target="_blank" title="https://open.feishu.cn/app?lang=zh-CN" ref="nofollow noopener noreferrer">open.feishu.cn/app?lang=zh…</a>），点击你的应用，进入到应用详情页即可获取。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d8cf517deb646978850382f8e20b619~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324016&amp;x-signature=3ODCOjsI9TJzPiqg1WY8LKyapIE%3D" alt="" loading="lazy"/></p>
<p>如果你没有飞书应用，别着急，文章后面有一章节会讲如何创建应用以及要如何设置应用的权限。现在就继续看工作流讲解部分。</p>
<h3 data-id="heading-5">2.2. 读取表格数据</h3>
<p>这个节点的作用是用来读取飞书表格的数据，目的就是将文章的链接给读取出来，使用到了官方的插件【飞书多维表格】的search_record工具。</p>
<p>需要注意field_names参数，因为只需要读取文章的链接，所以这里就输入了“文章链接”，表示只读取这一个字段的值。</p>
<p>page_size，是只一次都回来记录的最大值。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93b389e9ec504688991a262af0987464~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324016&amp;x-signature=rpiujajax%2BkrAuHzN9zHuIDT66U%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">2.3. 获取飞书认证</h3>
<p>这个节点用来获取飞书多维表格接口认证，便于流程后面的接口调用，使用到了扣子三方插件【飞书工具箱】的【tenant_access_token】工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd86770b998a49f9b1ea5f41bda86c60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324016&amp;x-signature=oF2%2BVjos1tVNKpOpNK9V2%2BYKu58%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">2.4. 批量获取素材</h3>
<p>这个节点用来循环的获取文章的内容，使用到了扣子官方的循环节点。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e5e47d52e0f4613a72b092eb87fbf2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324016&amp;x-signature=15wybIVjFIqMOv0W2cTFyMbSjy4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">2.5. 获取文章url</h3>
<p>因为从飞书表格中读取出来的文章链接并非只有链接，所以这个节点的作用就是把文章的链接给提取出来，使用到了扣子三方插件【字符串工具合集】的【get_json_value】工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/36acc487550941c0b087f7a74881c090~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324016&amp;x-signature=94S2KNJN1fx5xhT4eIgpAdPoiJs%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-bash" lang="bash">json_path固定参数：$.文章链接[0].<span class="hljs-built_in">link</span>
</code></pre>
<h3 data-id="heading-9">2.6. 微信公众号文章内容提取</h3>
<p>这个节点根据输入的公众号文章链接提取文章信息，使用到了扣子三方插件【公众号文章信息获取】的【get_wechat_article_info】工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5f2ef06ddd04a81b11b120a2311f2bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324016&amp;x-signature=10M9aUHqLKGiV2GUoJIrsG5E3JE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">2.7. 批量上传配图到飞书表格</h3>
<p>这个节点用来将文章的配图上传到飞书表格，后面的添加附件字段的时候，需要使用到这个节点返回的结果，使用到了扣子三方插件【飞书工具箱】的【batch_upload_medias】工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4ca2b7d028543fa965711d2faa59e2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324016&amp;x-signature=6z1U3crLnCJHfp1DU74pou3D0Bo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">2.8. 封面图转成列表格式</h3>
<p>因为上传图片到飞书表格的插件只能接收列表，封面图只是单个，所以需要这个工具做转化，使用到了扣子三方插件【字符串工具合集】的【str_2_list】工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/93639f7263294afba6e669087aece22f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324016&amp;x-signature=5ih9ygj5RTAUf5lU7Fvs5xF6ghY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">2.9. 上传封面图到飞书表格</h3>
<p>这个节点用来上传封面图到飞书表格，使用了和【2.7. 批量上传配图到飞书表格】节点一样的插件。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ffbee7892ea04fd885a04097bbbe0e56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324016&amp;x-signature=uRgh2xhryQNGqyXBGCTmu%2FdaFQE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-13">2.10. 配图转成飞书格式</h3>
<p>这个节点是将配图上传到飞书表格后的结果转成后面飞书表格可以理解的格式，使用到了扣子三方插件【飞书工具箱】的【upload_files_result_to_json】工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d107e7acdd24411b13f13d375d71660~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324016&amp;x-signature=B2IJ38CX%2F%2FozmjIQqj8DWSzzjKs%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-14">2.11. 封面图转成飞书格式</h3>
<p>这个节点使用了和【2.10. 配图转成飞书格式】一样的插件。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72fe049a74d14be6a7f97fa1145ee821~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324016&amp;x-signature=cLiKtot6Al8rKj2CmZlCixfEnPU%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-15">2.12. 公众号文章内容转成飞书格式</h3>
<p>这个节点是把获取到的文章内容转成飞书格式，使用到了扣子三方插件【公众号文章信息提取】的【wechat_article_info_to_json】工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db8a18069e67459b8c77446ee79ce765~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324016&amp;x-signature=hcN1hFJbl6M5oKk%2FWXReUUaZkGc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-16">2.13. 文章链接转成飞书格式</h3>
<p>这个节点是为了把文章的链接变成表格的超链接的格式，以便可以直接点击打开，使用到了扣子三方插件【飞书工具箱】的【url_to_feishu_link】工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dba8fe26ef5b49d59e9f9559f7bd31ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324016&amp;x-signature=ON9g1%2BuG1Ijkq1GUkhwfrkSuzc4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-17">2.14. 文章数据转成飞书表格记录格式</h3>
<p>这个节点就是把前面节点转化的多种数据统一转化成飞书多维表格记录的格式，以便可以把记录写入到多维表格中。使用到了扣子三方插件【飞书工具箱】的【data_to_feishu】工具。</p>
<p>这里的rules是一个映射规则，目的是把数据和表格记录中字段做一个映射，直接把下方的拷贝进去即可。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f70a1cb1baf3439a85d164d2e736b295~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324016&amp;x-signature=VG7iX4%2B3bZbwEgzDbJ4X%2B8zu8rY%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[  {    <span class="hljs-string">"field_name"</span>: <span class="hljs-string">"标题"</span>,    <span class="hljs-string">"idx"</span>: 1,    <span class="hljs-string">"json_path"</span>: <span class="hljs-string">"$.title"</span>  },  {    <span class="hljs-string">"field_name"</span>: <span class="hljs-string">"摘要"</span>,    <span class="hljs-string">"idx"</span>: 1,    <span class="hljs-string">"json_path"</span>: <span class="hljs-string">"$.summary"</span>  },  {    <span class="hljs-string">"field_name"</span>: <span class="hljs-string">"作者"</span>,    <span class="hljs-string">"idx"</span>: 1,    <span class="hljs-string">"json_path"</span>: <span class="hljs-string">"$.author"</span>  },  {    <span class="hljs-string">"field_name"</span>: <span class="hljs-string">"发文时间"</span>,    <span class="hljs-string">"idx"</span>: 1,    <span class="hljs-string">"json_path"</span>: <span class="hljs-string">"$.publish_time"</span>  },  {    <span class="hljs-string">"field_name"</span>: <span class="hljs-string">"文案内容"</span>,    <span class="hljs-string">"idx"</span>: 1,    <span class="hljs-string">"json_path"</span>: <span class="hljs-string">"$.content"</span>  },  {    <span class="hljs-string">"field_name"</span>: <span class="hljs-string">"封面图"</span>,    <span class="hljs-string">"idx"</span>: 3,    <span class="hljs-string">"json_path"</span>: <span class="hljs-string">"$.file_infos_json"</span>  },  {    <span class="hljs-string">"field_name"</span>: <span class="hljs-string">"配图"</span>,    <span class="hljs-string">"idx"</span>: 2,    <span class="hljs-string">"json_path"</span>: <span class="hljs-string">"$.file_infos_json"</span>  },  {    <span class="hljs-string">"field_name"</span>: <span class="hljs-string">"发文位置"</span>,    <span class="hljs-string">"idx"</span>: 1,    <span class="hljs-string">"json_path"</span>: <span class="hljs-string">"$.location"</span>  },  {    <span class="hljs-string">"field_name"</span>: <span class="hljs-string">"原文链接"</span>,    <span class="hljs-string">"idx"</span>: 4,    <span class="hljs-string">"json_path"</span>: <span class="hljs-string">"$.link_info"</span>  }]</span>
</code></pre>
<h3 data-id="heading-18">2.15. 更新记录到飞书表格</h3>
<p>这个节点就是把前面节点整理好的内容写入到飞书表格中，使用到了扣子官方的插件【飞书多维表格】的【add_records】工具。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b554e94467cf40cdbb50fa116c3ce198~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324016&amp;x-signature=zCNi8w4fzsH2dyxmb8nQ0paqYUY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-19">2.16. 结束</h3>
<p>records有值说明素材采集成功了，没有值说明失败了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4e3c843e15e484cb62d0ee4dd5ab34a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324016&amp;x-signature=Og7ZVA5gp76j0gA%2FICN34%2Bn9Cd0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-20">3. 飞书应用创建&amp;权限配置</h2>
<h3 data-id="heading-21">3.1. 应用创建</h3>
<p>进入到飞书的开放者后台（<a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.feishu.cn%2Fapp%3Flang%3Dzh-CN" target="_blank" title="https://open.feishu.cn/app?lang=zh-CN" ref="nofollow noopener noreferrer">open.feishu.cn/app?lang=zh…</a>），点击“创建企业自建应用按钮”，输入应用名称、应用描述等信息后，点击“创建”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d9254c210ba4becafc08c5acc9a78a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324016&amp;x-signature=g3k3%2F9ScA7%2BIzvEA2SFnMVkM2x4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-22">3.2. 权限配置</h3>
<p>进入到应用详情页，点击应用详情页左侧菜单栏的“权限管理”中，点击“开通权限”按钮，选择“查看、评论、编辑和管理多维表格”这个权限。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57e2801c94d44b55ad049b2d2c4f8149~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324016&amp;x-signature=916Ue%2BoYXuzpU74bbqUbhVUrkGw%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-23">3.3. 添加机器人</h3>
<p>添加应用机器人，需要通过这个机器人来给飞书多维表格授权，点击左侧菜单栏的“添加应用能力”菜单，点击添加机器人即可。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f90e1ea3e55f441da34a6c9409034fb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324016&amp;x-signature=7lQOJZ%2B6HaWaFFcdApxfTAlac%2FY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-24">3.4. 发布应用</h3>
<p>在左侧菜单栏点击“版本管理与发布”，点击“创建版本”按钮，填写信息发布即可。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b499617890da46d9aed8c2ca990d20d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324016&amp;x-signature=PnPWvbbJLNUhJTLplV0cxj%2FrYUA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-25">3.5. 添加群组</h3>
<p>这个操作需要在飞书客户端进行，创建好群组之后将刚刚创建的应用机器人作为群机器人。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14215f45080648ff997e90ff1d5bdd2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324016&amp;x-signature=HYUOl%2Fp2dPpLuYCKpmE168w1fsY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-26">3.6. 飞书文件夹添加协作人</h3>
<p>把上面创建好的群组，添加为多维表格所在的文件夹的协作者，给它管理文件夹的权限。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84a9a18f3e32436d90ef7eb908def8a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324016&amp;x-signature=AZijhHS1ODfkzZTcvtQ8wFKnvEY%3D" alt="" loading="lazy"/></p>
<p>添加完，应用的app id和 app secret就可以正常使用了。</p>
<h2 data-id="heading-27">4. 总结</h2>
<p>本文主要介绍了如何使用扣子工作流来建设自媒体素材库，通过coze+飞书多维表格的方式，把公众号文章的素材收集到飞书多维表格中。只需要将想收集的文章的链接添加到飞书表格中即可，大大提升了素材收集的效率。</p>
<p>最后，需要注意的是，工作流使用到的多维表格的模板需要提前创建好，表格的字段名称与类型需要和模板保持一致，需要多维表格模板的朋友可以文章留言“素材库模板”，并且三连后，私信我获取。</p>
<p>本文的分享就到这里，如果您觉得有收获的话，可以给个一键三连，您的鼓励是吾鳴持续输出的最大动力。有什么疑问也可以打在评论区，吾鳴会第一时间回复。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb0c520cfb954a6cb4efc93884811dc4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC-6bO0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767324016&amp;x-signature=dmpkDFyScY%2FAyZjXw7dh2LZMI8Y%3D" alt="" loading="lazy"/></p>
<p>最近实战了一些扣子（Coze）工作流相关的案例，包含小红薯图文生成、爆款视频剪辑、办公提效等扣子案例，内附详细的教程和工作流安装包，感兴趣的朋友可以来个<strong>一键三连（必须动作）</strong> ，文章评论区评论“<strong>扣子案例</strong>”领取。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用 10 行代码就能当 “服务器老板”+“网络小偷”+“文件管家”？Node.js：别不信！]]></title>    <link>https://juejin.cn/post/7587473691170603008</link>    <guid>https://juejin.cn/post/7587473691170603008</guid>    <pubDate>2025-12-25T16:46:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7587473691170603008" data-draft-id="7587631760253190163" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用 10 行代码就能当 “服务器老板”+“网络小偷”+“文件管家”？Node.js：别不信！"/> <meta itemprop="keywords" content="前端,JavaScript,Node.js"/> <meta itemprop="datePublished" content="2025-12-25T16:46:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风止何安啊"/> <meta itemprop="url" content="https://juejin.cn/user/2517239724512420"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用 10 行代码就能当 “服务器老板”+“网络小偷”+“文件管家”？Node.js：别不信！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2517239724512420/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风止何安啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-25T16:46:33.000Z" title="Thu Dec 25 2025 16:46:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;color:rgba(46,36,36,.87);overflow-x:hidden}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{margin-bottom:5px;font-size:30px;font-weight:500}.markdown-body h1:before{content:"#";margin-right:10px;color:#1976d2}.markdown-body h2{font-size:28px;font-weight:400;border-left:5px solid #454545;margin-top:20px;padding-left:10px;transition:all .3s ease-in-out}.markdown-body h2:hover{border-color:#1976d2}.markdown-body h3{font-size:24px;font-weight:400;margin-top:15px;padding-bottom:0}.markdown-body h4{font-size:20px;font-weight:500}.markdown-body h5{font-size:16px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h2:first-letter,.markdown-body h3:first-letter,.markdown-body p:first-letter{text-transform:capitalize}.markdown-body em{text-emphasis:dot;text-emphasis-position:under}.markdown-body img{display:block;margin:0 auto!important;max-width:100%;border-radius:2px;box-shadow:0 2px 4px -1px rgba(0,0,0,.2),0 4px 5px 0 rgba(0,0,0,.14),0 1px 10px 0 rgba(0,0,0,.12)!important}.markdown-body hr{position:relative;width:98%;height:1px;border:none;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,#ddd,#999,#ddd);overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background:#fff;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center}.markdown-body code{font-weight:900;word-break:break-word;border-radius:2px;overflow-x:auto;font-size:.87em;padding:.065em .4em;background-color:#fbe5e1;color:#c0341d}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border-radius:0 4px}.markdown-body pre&gt;code{font-weight:400;font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{margin:0 4px;text-decoration:none;color:#027fff;transition:all .3s ease-in-out;padding-bottom:4px;border-bottom:2px solid transparent}.markdown-body a:after{content:"";display:inline-block;width:18px;height:18px;margin-left:4px;vertical-align:middle;background-image:url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMiIgaGVpZ2h0PSIyMiI+PGcgZmlsbD0ibm9uZSIgZmlsbC1ydWxlPSJldmVub2RkIiBzdHJva2U9IiMwMjdGRkYiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCI+PHBhdGggZD0iTTkuODE1IDYuNDQ4bDEuOTM2LTEuOTM2YzEuMzM3LTEuMzM2IDMuNTgtMS4yNTkgNS4wMTMuMTczIDEuNDMyIDEuNDMyIDEuNTEgMy42NzYuMTczIDUuMDEzbC0xLjQ1MiAxLjQ1Mi0uOTY4Ljk2OGMtMS4zMzcgMS4zMzYtMy41ODEgMS4yNTktNS4wMTMtLjE3MyIvPjxwYXRoIGQ9Ik0xMS4yNjcgMTUuMzY3bC0xLjkzNiAxLjkzNmMtMS4zMzYgMS4zMzctMy41OCAxLjI2LTUuMDEyLS4xNzMtMS40MzItMS40MzItMS41MS0zLjY3Ni0uMTczLTUuMDEybDEuNDUyLTEuNDUyLjk2OC0uOTY4YzEuMzM2LTEuMzM3IDMuNTgtMS4yNiA1LjAxMi4xNzMiLz48L2c+PC9zdmc+);background-size:cover;background-repeat:no-repeat}.markdown-body a:hover{border-color:#027fff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body a.footnote-backref:after,.markdown-body a.footnote-ref:after,.markdown-body sup a:after{display:none!important}.markdown-body table{margin:0 auto 10px;font-size:12px;width:auto;max-width:100%;overflow:auto;border:2px solid #c6c6c6}.markdown-body table img{box-shadow:none!important}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body del{color:rgba(0,0,0,.6)}.markdown-body blockquote{position:relative;color:#666;padding:5px 23px 1px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:hsla(0,0%,78.4%,.12);transition:all .2s ease-in-out}.markdown-body blockquote:hover{border-color:#1976d2}.markdown-body blockquote:after,.markdown-body blockquote:before{position:absolute;font-size:24px;font-weight:800;line-height:24px;color:#cbcbcb;opacity:.6}.markdown-body blockquote:before{content:"“";top:4px;left:6px}.markdown-body blockquote:after{content:"”";right:8px;bottom:-8px}.markdown-body blockquote&gt;p,.markdown-body blockquote blockquote{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body details{outline:none;border:none;border-left:4px solid #1976d2;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary:hover::-webkit-details-marker{color:#1976d2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>前言</strong></h2>
<p>当你叩开 <code>Node.js</code> 的大门，会发现它的内核逻辑恰似一套精密的 <strong>“后端工具链”</strong>：<code>http</code>模块是搭建服务的 <strong>“基建脚手架”</strong>，以极简代码就能拉起可被浏览器访问的 <strong>Web 端点</strong>；<code>https</code>模块是对接外部世界的 <strong>“数据导管”</strong>，能安全拉取远程接口的资源流；而<code>fs</code>模块则是连接本地存储的 <strong>“文件算子”</strong>，实现磁盘内容的读写调度。这三者如同<strong>后端开发的 “基础三角”</strong>，支撑起服务端程序最核心的能力骨架。</p>
<p>就像学会用<strong>锅铲、炒勺、漏勺</strong>搞定一桌菜，<code>Node.js</code> 的<code>http</code>、<code>https</code>、<code>fs</code>这 <strong>“三板斧”</strong>，能帮你轻松搞定<strong>服务搭建、网络请求、文件读写</strong>这三件大事。那我们就来看看这 <strong>“三板斧”</strong>，它们到底咋用？</p>
<h3 data-id="heading-1"><strong>第一斧</strong>：用<code>http</code>模块，10 行代码搭个 Web 服务器</h3>
<p>想象一下：你对着电脑喊 <strong>“我要开个网站”</strong>，Node.js 的<code>http</code>模块立刻给你搬来服务器的 “零件”，10 行代码就能让浏览器访问到你的页面。</p>
<p>比如这串代码：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> http = <span class="hljs-built_in">require</span>(<span class="hljs-string">'http'</span>) <span class="hljs-comment">// 搬来HTTP“工具包”</span>

<span class="hljs-comment">// 造一个服务器：收到请求就“回应”</span>
<span class="hljs-keyword">const</span> server = http.<span class="hljs-title function_">createServer</span>(<span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (req.<span class="hljs-property">url</span> === <span class="hljs-string">'/home'</span>) { <span class="hljs-comment">// 如果访问“/home”路径</span>
        res.<span class="hljs-title function_">writeHead</span>(<span class="hljs-number">200</span>, { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'text/html; charset=utf-8'</span> }) <span class="hljs-comment">// 告诉浏览器：我给你的是HTML，编码是utf-8</span>
        res.<span class="hljs-title function_">end</span>(<span class="hljs-string">'&lt;h2&gt;首页&lt;/h2&gt;'</span>) <span class="hljs-comment">// 把“首页”这两个字扔给浏览器</span>
    }
})

<span class="hljs-comment">// 让服务器“蹲在”3000端口等请求</span>
server.<span class="hljs-title function_">listen</span>(<span class="hljs-number">3000</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'server is running at http://localhost:3000'</span>)
})
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/71230c6bbc674e5ea34ae1529536c226~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767285993&amp;x-signature=%2FDKFCouoex%2FIp1yGHcTVNv7mSS4%3D" alt="image.png" loading="lazy"/></p>
<p><strong>效果</strong>：打开浏览器输入<code>http://localhost:3000/home</code>，就能看到 “首页” 两个大字 —— 是不是就10来行代码就出来了？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81df88a5f20d4d8cb2acae0be0e5938a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767285993&amp;x-signature=eHTsxnJhgOuYlP01eVKxZQLu0Gc%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-2"><strong>第二斧</strong>：用<code>https</code>模块，“偷” 点网上的数据</h3>
<p>如果说<code>http</code>是 <strong>“开商店”</strong>，那<code>https</code>模块就是 <strong>“去别人家商店买东西”</strong>—— 比如从掘金 API 里扒点热门文章：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> https = <span class="hljs-built_in">require</span>(<span class="hljs-string">'https'</span>); <span class="hljs-comment">// 搬来HTTPS“购物袋”</span>

<span class="hljs-comment">// 去掘金API“买”热门文章数据</span>
https.<span class="hljs-title function_">get</span>(
    <span class="hljs-string">'https://api.juejin.cn/content_api/v1/content/article_rank?category_id=1&amp;type=hot&amp;count=3'</span>,
    <span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
        <span class="hljs-keyword">let</span> content = <span class="hljs-string">''</span>;
            res.<span class="hljs-title function_">on</span>(<span class="hljs-string">'data'</span>, <span class="hljs-function">(<span class="hljs-params">chunk</span>) =&gt;</span> { <span class="hljs-comment">// 数据“碎片”过来了，先攒着</span>
            content += chunk;
        })
        res.<span class="hljs-title function_">on</span>(<span class="hljs-string">'end'</span>, <span class="hljs-function">() =&gt;</span> { <span class="hljs-comment">// 数据攒够了，打印出来看看</span>
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(content);
        })
    }
)
</code></pre>
<p><strong>效果</strong>：运行代码后，控制台会跳出掘金的文章数据 —— 相当于 <code>Node.js</code> 帮你 <strong>“爬”</strong> 了个网页，是不是很神奇？</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c29c67a5fb8543cdb6eb1968f79c88c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767285993&amp;x-signature=G3NnbYvRMg1T%2FkxPyrpcsP31uT4%3D" alt="image.png" loading="lazy"/></p>
<p>可能很多人觉得控制台的东西很乱，但中文你总认得了吧？明显看到热搜第一的文章：<strong>2025快手直播至暗时刻</strong>。（也就是<code>title</code>那一行）。</p>
<h3 data-id="heading-3"><strong>第三斧</strong>：用<code>fs</code>模块，让 Node.js 当 “文件管家”</h3>
<p>电脑里的文件，<code>Node.js</code> 能用<code>fs</code>模块随便折腾：既能 <strong>“读”</strong> 文件里的内容，也能 <strong>“写”</strong> 新内容进去。</p>
<p>比如<strong>读文件</strong>：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>); <span class="hljs-comment">// 搬来文件操作“管家”</span>

<span class="hljs-comment">// 读text.txt里的内容（就是那句“床前明月光”）</span>
fs.<span class="hljs-title function_">readFile</span>(<span class="hljs-string">'./text.txt'</span>, <span class="hljs-string">'utf-8'</span>, <span class="hljs-function">(<span class="hljs-params">err, data</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!err) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data); <span class="hljs-comment">// 打印出“床前明月光，疑是地上霜”</span>
    }
})
</code></pre>
<p>然后我们创建一个文件夹<code>text.txt</code>：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b46903d898334ca68ffc2140447cdd62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767285993&amp;x-signature=HkTXWpFvkzP%2BjD2iPa%2BXMAaS%2BmA%3D" alt="image.png" loading="lazy"/></p>
<p>用<code>node</code>运行，就可以看到文本里的内容了：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a029461691a483fb6af227d9c0ee1eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767285993&amp;x-signature=rgmmwgl4jnMMSur52wfeJtl7cJA%3D" alt="image.png" loading="lazy"/></p>
<p>再比如<strong>写文件</strong>：</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// 往readme.md里写“你好”</span>
fs.<span class="hljs-title function_">writeFile</span>(<span class="hljs-string">'./readme.md'</span>, <span class="hljs-string">'你好'</span>, <span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (!err) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'写入成功'</span>); <span class="hljs-comment">// 成功后控制台提示</span>
    }
})
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e62f4044f2044f838cd0986cc4758a48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767285993&amp;x-signature=3WPSHJ4rdztH536uAvUz08DewsA%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/67d2fbd0e7844c44bf7d0f8ebb910ed0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO5q2i5L2V5a6J5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767285993&amp;x-signature=Qjp7mKI4d08rEqqn5q1RAq9iL%2Bg%3D" alt="image.png" loading="lazy"/></p>
<p><strong>效果</strong>：运行后，文件夹里会多出一个<code>readme.md</code>，打开就是 “你好”—— 相当于 <code>Node.js</code> 帮你写了个小文档！</p>
<h3 data-id="heading-4"><strong>总结</strong>：Node.js 的 “三板斧”，其实是 “三把钥匙”</h3>
<ul>
<li><code>http</code>是<strong>开服务器的钥匙</strong>：让你从 “网页浏览者” 变成 “网页搭建者”；</li>
<li><code>https</code>是<strong>连互联网的钥匙</strong>：让你从 “数据消费者” 变成 “数据获取者”；</li>
<li><code>fs</code>是<strong>控本地文件的钥匙</strong>：让你从 “文件操作者” 变成 “文件自动化管理者”。</li>
</ul>
<h2 data-id="heading-5"><strong>结语</strong></h2>
<p>从拉起一个 HTTP 服务，到拉取远程接口数据，再到操控本地文件，Node.js 的<code>http</code>、<code>https</code>与<code>fs</code>模块，本质是将 <strong>“网络通信”</strong> 与 <strong>“本地操作”</strong> 的底层能力封装成了开发者可直接调用的接口。掌握这三者，就相当于拿到了 <code>Node.js</code> 后端开发的 <strong>“入门密钥”</strong>，后续无论是构建 API 服务、处理数据流转，还是管理文件资源，都能以此为基，向外延伸出更复杂的应用场景。</p>
<p>本篇依旧是<code>Node.js</code>的基础知识，感兴趣的话可以配套另外一篇基础知识一起👀：</p>
<blockquote>
<p><a href="https://juejin.cn/post/7587017021314072611" target="_blank" title="https://juejin.cn/post/7587017021314072611">Steam玩累了？那用 Node.js 写个小游戏：手把手玩懂 JS 运行环境</a></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>