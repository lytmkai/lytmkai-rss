<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[请求洪峰来了，怎么使用消息队列削峰? 我们来深入的聊一下]]></title>    <link>https://juejin.cn/post/7586505172815675443</link>    <guid>https://juejin.cn/post/7586505172815675443</guid>    <pubDate>2025-12-22T17:02:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586505172815675443" data-draft-id="7586550947703373834" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="请求洪峰来了，怎么使用消息队列削峰? 我们来深入的聊一下"/> <meta itemprop="keywords" content="后端,架构"/> <meta itemprop="datePublished" content="2025-12-22T17:02:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="自由生长2024"/> <meta itemprop="url" content="https://juejin.cn/user/1591748569862670"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            请求洪峰来了，怎么使用消息队列削峰? 我们来深入的聊一下
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748569862670/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    自由生长2024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T17:02:52.000Z" title="Mon Dec 22 2025 17:02:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读25分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>摘要： 本文以秒杀场景为例，深入浅出讲解消息队列“削峰”原理，对比无队列直接冲击与异步缓冲差异，揭示票务系统“疯狂刷新”背后的多层限流设计。用“蓄水池”“排队取号”等比喻拆解本质，坦言高并发技术已成熟，价值在于细节与架构洞察。全文通俗真实，兼顾技术与行业思考，适合后台工程师阅读。</p>
</blockquote>
<h2 data-id="heading-0">请求洪峰来了，怎么使用消息队列削峰?</h2>
<p>这是一个非常经典的系统设计问题。</p>
<p>咱们前面插个嘴，这些技术真的很难吗？跟景区卖票限流没有本质区别。</p>
<p>它只是互联网业务场景下的一种需要，因为他们需要满足很多用户同时访问，因此这些年成为了一种“显学”。一个后台开发岗位JD里，总会多少带“高并发，高可用”字眼，实际上弄清楚本质，你也就知道怎么回事了。</p>
<p>简单来说，“削峰” 就像是在你家门口修了一个“蓄水池”（消息队列），当洪水（大量请求）来的时候，你不直接让水冲进屋子（服务器），而是先存进池子里，然后家里用水管按自己能承受的速度慢慢放水用。</p>
<p>如果不这么做，屋子（服务器）可能直接就被冲垮了（宕机）。</p>
<p>我们可以通过一个具体的“秒杀活动”场景，来一步步拆解怎么用消息队列来“削峰”。</p>
<h4 data-id="heading-1">🌊 第一步：理解“没有削峰”会发生什么？</h4>
<p>想象一下双十一，10万人同时点“下单”按钮。</p>
<ul>
<li><strong>直接冲击</strong>：这10万个请求瞬间全部涌向你的订单服务器。</li>
<li><strong>结果</strong>：服务器每秒只能处理1000个请求，瞬间被压垮，系统崩溃，所有人都买不了东西。</li>
</ul>
<h4 data-id="heading-2">🧱 第二步：引入“消息队列”这堵墙</h4>
<p>我们要做的是 <strong>“异步化”<strong>和</strong>“缓冲”</strong>。</p>
<h5 data-id="heading-3">1. 生产者（快速接收，不处理）</h5>
<p>当用户的请求（比如秒杀下单）来了，你的Web服务器（生产者）只做两件事：</p>
<ol>
<li>
<p><strong>简单校验</strong>：检查用户登录状态、验证码对不对（这一步很快）。</p>
</li>
<li>
<p><strong>扔进队列</strong>：把下单的指令（用户ID、商品ID）打包成一条“消息”，扔进**消息队列（比如 RabbitMQ、Kafka、RocketMQ）**里。</p>
</li>
<li>
<p><strong>立刻回复</strong>：马上告诉用户：“您的请求已收到，请在订单页查看结果”。(这是理想的优雅处理方式，然后我们待会分析实际情况)</p>
</li>
</ol>
<blockquote>
<p><strong>关键点</strong>：Web服务器<strong>不</strong>去扣库存，<strong>不</strong>去算价格，<strong>不</strong>去发短信。它只负责“收单”，处理完就立刻去接下一个请求。这样Web服务器就能扛住每秒几万的请求。</p>
</blockquote>
<h5 data-id="heading-4">2. 消费者（慢慢处理，稳如老狗）</h5>
<p>这时候，你的后台有一台专门的“订单处理机”（消费者），它会从消息队列里<strong>一条一条</strong>（或者批量）地拿消息。</p>
<ul>
<li>它按照自己舒服的速度（比如每秒处理1000条）去干活。</li>
<li>它去检查库存、生成订单、扣减余额、发短信通知。</li>
<li>如果处理完了，就告诉队列：“这条我干完了，删了吧”。</li>
</ul>
<h4 data-id="heading-5">📊 第三步：效果对比</h4>






























<table><thead><tr><th align="left">阶段</th><th align="left">没有消息队列（直接冲）</th><th align="left">使用消息队列（削峰）</th></tr></thead><tbody><tr><td align="left"><strong>请求涌入</strong></td><td align="left">10万请求瞬间砸向服务器</td><td align="left">10万请求瞬间扔进队列（队列抗住）</td></tr><tr><td align="left"><strong>服务器压力</strong></td><td align="left">瞬间爆炸，CPU 100%，宕机</td><td align="left">压力平缓，按固定速度消费</td></tr><tr><td align="left"><strong>用户体验</strong></td><td align="left">页面打不开，报错500</td><td align="left">立刻得到“已受理”的响应</td></tr><tr><td align="left"><strong>最终结果</strong></td><td align="left">全部失败</td><td align="left">前1000个抢到的人成功，后面的人失败（但系统没崩）</td></tr></tbody></table>
<h4 data-id="heading-6">💻 第四步：代码逻辑大概是怎样的？</h4>
<p>为了让你更直观地理解，我写一个非常简化的伪代码：</p>
<p><strong>1. 接收请求的接口（生产者）</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 这个接口非常快，只负责把消息扔进队列</span>
<span class="hljs-meta">@app.route(<span class="hljs-params"><span class="hljs-string">'/seckill'</span>, methods=[<span class="hljs-string">'POST'</span>]</span>)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">seckill</span>():
    user_id = get_current_user()
    product_id = request.form[<span class="hljs-string">'product_id'</span>]
    
    <span class="hljs-comment"># 1. 简单检查（比如Redis里看还有没有库存）</span>
    <span class="hljs-keyword">if</span> redis.decr(<span class="hljs-string">"stock:"</span> + product_id) &lt; <span class="hljs-number">0</span>: <span class="hljs-comment"># 对应商品的库存-1</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"已售罄"</span>
    
    <span class="hljs-comment"># 2. 核心操作：把下单任务扔进消息队列</span>
    <span class="hljs-comment"># 这一步非常快，就像把信扔进邮筒</span>
    mq.send(<span class="hljs-string">"order_queue"</span>, {
        <span class="hljs-string">"user_id"</span>: user_id,
        <span class="hljs-string">"product_id"</span>: product_id
    })
    
    <span class="hljs-comment"># 3. 立刻返回成功（其实还没真正下单，只是拿到了排队号）</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"请求已受理，请稍后查看订单"</span>
</code></pre>
<p><strong>2. 后台处理程序（消费者）</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 这个程序一直在后台跑，速度可控</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">order_consumer</span>():
    <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
        <span class="hljs-comment"># 从队列里拿消息（如果没有消息，就阻塞等着）</span>
        msg = mq.receive(<span class="hljs-string">"order_queue"</span>)
        
        <span class="hljs-comment"># 拿到消息后，开始真正干活（这一步慢，但没关系）</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 真正的业务逻辑：扣库存、生成订单、发短信</span>
            service.create_order(msg.user_id, msg.product_id)
            mq.ack(msg) <span class="hljs-comment"># 告诉队列：这活干完了</span>
        <span class="hljs-keyword">except</span>:
            mq.nack(msg) <span class="hljs-comment"># 告诉队列：这活没干完，稍后再试</span>
</code></pre>
<h4 data-id="heading-7">📌 你该怎么用</h4>
<ol>
<li><strong>拆分流程</strong>：把你的业务拆成“<strong>快速接收</strong>”和“<strong>慢慢干活</strong>”两部分。</li>
<li><strong>引入中间件</strong>：在中间加一个消息队列（如 RabbitMQ）。</li>
<li><strong>前端只管发</strong>：用户的请求来了，校验完参数，立刻发消息到队列，然后就返回“处理中”。</li>
<li><strong>后端慢慢收</strong>：用后台程序从队列里读数据，按部就班地处理业务。</li>
</ol>
<p>这样，无论外面有多少并发请求，你的后端数据库和核心服务看到的流量永远是平缓的，就像山谷被削平了一样。这就是“削峰”。</p>
<p>像排队取号一样，因为窗口接待的速度是有限的，所以让人拿个号在那等，也很餐厅限流一样（想想你去一家很火的餐厅，然后做到门外面排队的样子）。</p>
<p>我们再说不体面，不优雅的，让我厌恶的，现实中更多的实现方式。</p>
<p>很多抢票的是这么做的，比如演唱会门票，你不停的刷新页面抢到了一张，然后，等你点进去准备付款，又告诉你，对不起，已经被卖出去了。也就是说，它是来了两道门，第一道门是超额放人进来，第二道是拼付款速度。这些网站之所以这么做，是为了快速成交，不给用户太多的付款时间。</p>
<p>12306不会这么做，如果你刷到了，并且进入到支付页面，基本上就给你30分钟左右的支付时间，超时取消，算是比较体面的一种方式吧。</p>
<h2 data-id="heading-8">疯狂抢票刷新页面的背后</h2>
<p>对于不做显示的异步任务的网站，让用户一直在页面刷新，其实流量还挺爆炸的，很多用户刷30分钟也刷不到新票放出来，但是很多票务秒杀网站就是让用户一直刷新。</p>
<p>事实上，不是“不做排队”，而是把排队逻辑藏在了前端 + 网关 + 后端的多层防御体系里，并且用了很多“伪装”和“过滤”手段。</p>
<p>所以，提个问题，<strong>“很多票务/电商秒杀确实让用户疯狂刷新页面，看起来没做排队，那为什么系统没炸？”</strong></p>
<hr/>
<h4 data-id="heading-9">🧨 表象 vs 实际：用户“刷” ≠ 请求真打到核心系统</h4>
<p>当用户在大麦网疯狂点“立即抢购”时，<strong>绝大多数请求根本到不了订单服务</strong>。系统在前面设了多道“筛子”：</p>
<h5 data-id="heading-10">✅ 第 1 层：前端限流（最廉价）</h5>
<ul>
<li>按钮点击后 <strong>立刻禁用 1~3 秒</strong>（防止手快党连点）；</li>
<li>加 <strong>验证码</strong>（图形、滑块、短信），过滤掉 90% 的机器人；</li>
<li>用 <strong>本地倒计时</strong> 控制“开抢前不能点”，避免提前压测。</li>
</ul>
<blockquote>
<p>💡 用户以为自己在“抢”，其实只是在和前端交互。</p>
</blockquote>
<h5 data-id="heading-11">✅ 第 2 层：CDN + API 网关限流</h5>
<ul>
<li>请求先到 <strong>CDN 或 Nginx / API 网关</strong>（如 Kong、阿里云 API Gateway）；</li>
<li>这里做 <strong>IP 限流</strong>（比如每秒最多 5 次请求）、<strong>用户 ID 限流</strong>；</li>
<li>超过的直接返回 <code>429 Too Many Requests</code>，不进后端。</li>
</ul>
<blockquote>
<p>💡 10 万用户刷，可能只有 1 万能穿过这层。</p>
</blockquote>
<h5 data-id="heading-12">✅ 第 3 层：缓存预检（Redis 快速拦截）</h5>
<ul>
<li>请求到达业务服务后，<strong>第一件事不是查数据库，而是查 Redis</strong>：
<ul>
<li>商品是否已售罄？→ 直接返回“已抢光”；</li>
<li>用户是否已在排队？→ 返回“请勿重复提交”；</li>
<li>库存是否 &gt; 0？→ 如果为 0，直接拒绝。</li>
</ul>
</li>
<li>这些操作 <strong>微秒级完成</strong>，不涉及复杂逻辑。</li>
</ul>
<blockquote>
<p>💡 又过滤掉 80% 的无效请求。</p>
</blockquote>
<h5 data-id="heading-13">✅ 第 4 层：真正的“排队”——但用户不知道</h5>
<ul>
<li>只有通过以上所有检查的请求，才会进入<strong>真正的排队机制</strong>，比如：
<ul>
<li>写入 <strong>消息队列</strong>（异步下单）；</li>
<li>或进入 <strong>Redis 分布式队列</strong>（如用 List + BLPOP）；</li>
<li>甚至用 <strong>令牌桶</strong>：开抢瞬间放出 N 个令牌，抢到才能继续。</li>
</ul>
</li>
</ul>
<blockquote>
<p>⚠️ 但这时候，<strong>用户已经收到“排队中”或“处理中”的提示了</strong>，不再疯狂刷新。</p>
</blockquote>
<hr/>
<h4 data-id="heading-14">🎭 为什么让用户“感觉在抢”？</h4>
<p>这是<strong>产品设计 + 心理学</strong>的结合：</p>
<ul>
<li>如果直接说“您已进入队列，请等待”，用户会觉得“没参与感”；</li>
<li>而“疯狂点击 → 转圈 → 成功/失败” 的反馈，让人觉得“是我手慢了”，而不是“系统不行”，而且能营造出超级火爆的场面，甚至营造一种失落的感觉，让用户因为错失演出，滋生出厌恶损失心理，从而愿意高价去卖黄牛的票（系统的设计背后都是心理学）；</li>
<li>实际上，<strong>点击第 1 次之后，后续点击基本都被前端或网关拦住了</strong>。</li>
</ul>
<blockquote>
<p>🔍 可以打开浏览器开发者工具，监控 Network：
在真正的秒杀开抢时，你会发现<strong>第二次点击根本没发请求</strong>，或者返回了 429。</p>
</blockquote>
<hr/>
<h4 data-id="heading-15">🆚 对比两种模式</h4>






























<table><thead><tr><th>场景</th><th>“裸奔式刷新”（无防护）</th><th>“伪装式刷新”（真实秒杀系统）</th></tr></thead><tbody><tr><td>用户行为</td><td>无限刷，每次都发请求</td><td>刷多次，但多数请求被拦截</td></tr><tr><td>后端压力</td><td>直接爆炸</td><td>99% 流量在边缘被消化</td></tr><tr><td>核心系统</td><td>被冲垮</td><td>几乎无感</td></tr><tr><td>用户体验</td><td>全部失败 + 报错</td><td>少数成功 + 多数“公平失败”</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-16">✅ 总结：</h4>
<blockquote>
<p><strong>“让用户刷”是一种 UI 假象，背后是层层限流 + 缓存拦截 + 异步排队的组合拳。<br/>
真正的高并发系统，绝不会让原始流量直达数据库或订单服务。</strong></p>
</blockquote>
<p><strong>表面的“混乱”其实是精心设计的“有序过滤”</strong>。</p>
<h2 data-id="heading-17">如果在洪峰中让一次请求像常规请求那样直接排队？</h2>
<p>如果让请求在 Web 服务器前面直接排队（比如用线程池、连接队列），而不是扔进消息队列，行不行？</p>
<p>答案是：<strong>短期可以，但扛不住真正的“秒杀级”高并发，而且体验和可靠性差很多。</strong></p>
<hr/>
<h4 data-id="heading-18">🧱 对比两种“排队”方式</h4>








































<table><thead><tr><th>维度</th><th><strong>Web 层直接排队（同步阻塞）</strong></th><th><strong>消息队列排队（异步缓冲）</strong></th></tr></thead><tbody><tr><td><strong>排队位置</strong></td><td>在 Web 服务器的线程/连接队列里</td><td>在独立的消息中间件（如 Kafka）里</td></tr><tr><td><strong>请求状态</strong></td><td>用户连接一直挂着（TCP 连接未释放）</td><td>用户立刻收到响应，连接释放</td></tr><tr><td><strong>资源占用</strong></td><td>每个排队请求占用内存 + 线程 + 连接</td><td>只占用消息队列的磁盘/内存，Web 无负担</td></tr><tr><td><strong>可扩展性</strong></td><td>队列长度受限于单机资源（通常几百~几千）</td><td>队列可分布式、持久化，轻松撑百万级</td></tr><tr><td><strong>容灾能力</strong></td><td>Web 服务器一崩，所有排队请求全丢</td><td>消息持久化，服务重启后继续处理</td></tr><tr><td><strong>用户体验</strong></td><td>页面卡死、超时、504 Gateway Timeout</td><td>立刻提示“已受理”，后台慢慢处理</td></tr></tbody></table>
<p>很早的时候，上大学选课的时候，大家能看到，每次选课系统开放的时候，刷着刷着，选课网站崩了，这就是直接使用Web层排队的结果。</p>
<hr/>
<h4 data-id="heading-19">🌰 举个现实例子：</h4>
<p>假设你有 10 万用户同时点“秒杀”。</p>
<h5 data-id="heading-20">✖️ 方案 A：Web 服务器自己排队（比如 Tomcat 线程池）</h5>
<ul>
<li>Tomcat 默认最大线程数 200。</li>
<li>前 200 个请求在处理，剩下 99800 个在操作系统连接队列或反向代理（如 Nginx）里排队。</li>
<li>但 Nginx 的 <code>backlog</code> 通常也就几千。</li>
<li><strong>结果</strong>：大量请求直接被拒绝（Connection Refused）或超时（Timeout），用户看到“网络错误”，疯狂刷新 → 雪崩。</li>
</ul>
<h5 data-id="heading-21">✔️ 方案 B：用消息队列</h5>
<ul>
<li>Web 服务器 1 秒处理 5000 个“收单”请求（只校验+入队），全部快速返回。</li>
<li>消息队列存下 10 万条消息（Kafka 轻松扛住）。</li>
<li>后台消费者以每秒 1000 条的速度稳稳处理。</li>
<li><strong>结果</strong>：系统不崩，用户知道“已提交”，即使没抢到也觉得公平。</li>
</ul>
<hr/>
<h4 data-id="heading-22">⚠️ 更严重的问题：<strong>资源耗尽</strong></h4>
<p>在“直接排队”模式下：</p>
<ul>
<li>每个 HTTP 请求都维持一个 TCP 连接；</li>
<li>每个连接可能对应一个线程或协程；</li>
<li>10 万个连接 ≈ 几 GB 内存 + 大量上下文切换；</li>
<li>操作系统可能直接 OOM（内存溢出）或无法新建连接。</li>
</ul>
<p>而消息队列把“请求”从“活跃连接”变成了“静态数据”，资源消耗天差地别。</p>
<hr/>
<h4 data-id="heading-23">✅ 结论：</h4>
<blockquote>
<p><strong>“在 Web 层直接排队”本质上还是同步模型，只是把崩溃时间推迟了一点点；<br/>
而“消息队列削峰”是真正的异步解耦，把瞬时压力转化为可持续处理的任务流。</strong></p>
</blockquote>
<p>所以，在高并发场景（尤其是秒杀、抢购、抢红包），<strong>必须用消息队列（或类似异步机制）做削峰</strong>，不能依赖 Web 服务器自己的排队能力。</p>
<h2 data-id="heading-24">排队取号的朴素逻辑和必要性</h2>
<p>上面说过，请求队列削锋就像医院就诊排队取号一样，也像银行柜台处理逻辑一样，因为窗口处理请求的速度是有限的，所以让人拿个号在那等， 逻辑非常的朴素。</p>
<p>没有取票机之前，所有的人必须在窗口后面等着，连坐的地方都没有，难受不难受？</p>
<p>这正是消息队列削峰的核心思想，我在一一对应展开说明，其实这部分过于通俗，知道本质的可以直接跳过了：</p>
<h4 data-id="heading-25">🎫 1. 削锋就像“排队取号”</h4>
<ul>
<li><strong>用户请求</strong>：就是去银行办事的<strong>客户</strong>。</li>
<li><strong>Web服务器</strong>：就是那个<strong>发号机</strong>。
<ul>
<li>它的任务只是检查一下你带没带身份证（简单校验），然后“滴”一声给你一张号（发消息到队列）。</li>
<li>发号机速度极快，一分钟能发几百个号。</li>
</ul>
</li>
<li><strong>消息队列</strong>：就是那个<strong>等待区</strong>。
<ul>
<li>所有拿到号的人都在这里坐着等。</li>
</ul>
</li>
<li><strong>后台消费者</strong>：就是那个<strong>办事窗口</strong>。
<ul>
<li>窗口的速度是固定的，不管外面来了多少人，窗口永远是“叫一个，办一个”。</li>
<li>如果窗口忙不过来，号就在等待区排队，人不会堵在门口。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-26">🍽️ 2. 就像“餐厅排号限流”</h4>
<ul>
<li><strong>高峰期</strong>：几百人涌向餐厅。</li>
<li><strong>如果没有队列</strong>：所有人都挤在门口和过道里，谁也动不了，服务员上不了菜，厨房也乱套了（服务器死锁/崩溃）。</li>
<li><strong>使用队列</strong>：
<ul>
<li>门口服务员说：“里面满了，您拿个号在路边等吧。”（请求被放入消息队列）。</li>
<li>餐厅里面还是按照原本的节奏，吃完一桌翻台一桌（消费者处理完一条消息，再取下一条）。</li>
<li>虽然外面排队的人很多，但餐厅内部秩序井然，不会因为人多而瘫痪。</li>
</ul>
</li>
</ul>
<hr/>
<h4 data-id="heading-27">🤔 这样做有什么好处？</h4>
<ol>
<li>
<p><strong>系统不崩</strong>：这是最大的好处。不管流量是平时的10倍还是100倍，你的核心业务处理能力（消费者）永远在自己的能力范围内工作。现实中，如果没有取号机制，不安排等候区，大家一直排着长长的队列，你会发现门被堵实了，影响正常的同行。</p>
</li>
<li>
<p><strong>用户体验好</strong>：用户虽然需要等待（比如去订单页刷新），但至少 <strong>不会看到“504网关超时”或者“服务器开小差了”</strong> 这种报错。用户看到的是“请求已提交”，心里就有底了。</p>
</li>
<li>
<p><strong>错峰处理</strong>：比如秒杀活动在0点结束，但处理订单可能要持续到凌晨1点。这没关系，只要在天亮前处理完就行。把瞬间的洪峰拉平成一个缓坡。</p>
</li>
</ol>
<h4 data-id="heading-28">⚠️ 需要注意的“坑”</h4>
<p>虽然这个比喻很形象，但在实际开发中，还需要注意一点小区别：</p>
<p><strong>号不会过期 vs. 消息会过期/积压</strong></p>
<ul>
<li>在餐厅，如果你等太久没去，号可能会作废。</li>
<li>在消息队列里，如果消费者挂了或者处理太慢，消息会<strong>堆积</strong>。
<ul>
<li>如果积压太多，队列可能会满（需要监控）。</li>
<li>如果处理太慢，用户可能要等很久才知道自己没抢到（这时候通常需要配合“熔断”和“降级”策略，比如超过一定数量直接拒绝请求，就像餐厅满员了直接说“今天不营业了”）。</li>
</ul>
</li>
</ul>
<p><strong>总结：消息队列就是一个“解耦”和“缓冲”的神器，它把“瞬时的高并发”转化为了“持续的异步任务流”。</strong></p>
<h2 data-id="heading-29">本质上当下没有太多技术含量但是细节很多的工作</h2>
<p>老是嚷嚷着什么高并发，高可用，现在技术已经很成熟了，再继续抠这些，感觉就像孔乙己穿着那个长袍不愿意脱下一样。</p>
<p>其实，这种技术既然已经成熟了，除了些许细节需要注意，它短期来看，也很难有什么新的突破了。</p>
<p>当然，这种“没什么技术含量”的感觉，也是优秀工程思维的核心——大道至简。真正的技术含量不在于把事情搞得多么玄乎，而在于用最简单、最稳定、最便宜的办法，把那个“不可能”的问题给解决了。</p>
<p>这里面的“技术含量”，其实不在于“用了队列”，而在于把细节处理好：</p>
<h4 data-id="heading-30">🎯 1. 技术含量在于“认知的穿透力”</h4>
<p>当所有人都在喊“服务器要炸了，快加机器”的时候，你能一眼看穿问题的本质不是“算力不够”，而是**“流量的突发性”和“处理能力的恒定性”之间的矛盾**。</p>
<ul>
<li>
<p><strong>难点</strong>：不被表象（CPU 100%）迷惑，精准定位到是“同步阻塞”导致了雪崩。</p>
</li>
<li>
<p><strong>技术含量</strong>：这是一种<strong>架构层面的洞察力</strong>。你知道系统瓶颈在哪里，也知道怎么绕过去。</p>
</li>
</ul>
<h4 data-id="heading-31">⚙️ 2. 技术含量在于“异步化”的改造</h4>
<p>看起来只是加了个队列，但要把一个原本“用户点了按钮 -&gt; 立刻扣库存 -&gt; 立刻返回成功”的同步流程，改成异步的，这中间全是坑：</p>
<ul>
<li>
<p><strong>状态管理</strong>：用户点了，你返回“排队中”，那用户怎么知道最后成功没？你需要设计一套<strong>状态查询机制</strong>（比如订单状态轮询或WebSocket推送）。</p>
</li>
<li>
<p><strong>数据一致性</strong>：如果消息发出去了，结果扣库存的时候数据库挂了，这条消息算不算？这就涉及到<strong>消息的可靠性投递</strong>、<strong>幂等性处理</strong>（防止同一条消息被重复消费导致库存扣成负数）。</p>
</li>
<li>
<p><strong>死信处理</strong>：如果那条消息因为数据格式错误一直处理不了，它会卡在那里，你需要一个“死信队列”来专门处理这些“钉子户”。</p>
</li>
</ul>
<h4 data-id="heading-32">🛡️ 3. 技术含量在于“兜底”和“治理”</h4>
<p>“排队”容易，“维持秩序”难。</p>
<ul>
<li>
<p><strong>积压怎么办</strong>：如果后台处理太慢，队列里堆积了几百万条消息，内存爆了怎么办？你需要<strong>监控告警</strong>，甚至需要<strong>动态扩容</strong>消费者。</p>
</li>
<li>
<p><strong>熔断机制</strong>：如果队列满了，你是把新来的请求丢掉，还是阻塞住？这就需要设计<strong>限流和降级策略</strong>。</p>
</li>
<li>
<p><strong>选型</strong>：你是用 RabbitMQ（灵活但吞吐量一般），还是用 Kafka（吞吐量巨大但延迟稍高），还是用 RocketMQ（金融级可靠）？这需要根据业务场景做权衡。</p>
</li>
</ul>
<h4 data-id="heading-33">📉 4. 技术含量在于“取舍”</h4>
<p>“削峰”其实也是一种 **“欺骗” **。你是在用 <strong>“响应时间”</strong> 换取 <strong>“系统稳定性”</strong>。</p>
<ul>
<li>
<p>技术含量在于你清楚地知道：<strong>让用户等3秒看到结果，比让用户立刻看到错误页面要好得多</strong>。</p>
</li>
<li>
<p>这种在<strong>用户体验</strong>和<strong>系统可用性</strong>之间做权衡的能力，是工程师为了务实不得不做的取舍。</p>
</li>
</ul>
<p>高并发是朴素而简单的东西，并不是什么复杂的东西，难在其长链条中有很多细节， 难在一旦出了错，需要被扣奖金和绩效，或者造成严重的工程事故，因此难在不能出错。</p>
<h2 data-id="heading-34">成熟工种带来的价值焦虑</h2>
<p>高并发高可用这一套,我称之为成熟工种，新人跟着老师傅认真干上一两次完整的流程，也就成为了有经验的老师傅，差不多理解本质了都知道咋弄。</p>
<p>有的时候，互联网行业的软件工程自嘲“搬砖”，可以称得上是没法反驳了。</p>
<p><strong>这是对“软件工程”现状最精准、最残忍的暴击。</strong></p>
<p><strong>一旦你看透了本质，剩下的真的就只是“体力活”和“熟练工种”。</strong></p>
<p>这触及了程序员这个职业最核心的焦虑之一：<strong>工作的“可替代性”</strong>。</p>
<h4 data-id="heading-35">🧱 1. 大部分工作确实是“搬砖”</h4>
<ul>
<li>
<p><strong>CRUD 工程师</strong>：增删改查，写接口，拼页面。只要是个正经计算机毕业的本科生，给他两三个月熟悉业务，确实能上手。</p>
</li>
<li>
<p><strong>业务逻辑的堆砌</strong>：大部分公司的代码，就是接近 if-else 的排列组合。这不需要天才，只需要耐心和记忆力。</p>
</li>
<li>
<p><strong>框架的成熟</strong>：现在各种框架太成熟了，把很多底层细节都封装好了。你只需要按照文档“填空”就行。</p>
</li>
</ul>
<h4 data-id="heading-36">🧩 2. “知道咋弄”和“能弄好”之间，隔着一条鸿沟</h4>
<p>这就是为什么虽然“换个人能干”，但还是有不可替代性的原因。<strong>“知道”只是第一步，后面的坑，才是你经验的价值所在。</strong></p>
<ul>
<li>
<p><strong>填坑的能力</strong>：你知道怎么用消息队列削峰，这是“知道”。但当消息队列挂了、消息丢了、重复消费了、积压了几十亿条了，那个“差不多理解本质”的新人怎么办？这时候靠的是你debug的直觉和经验。</p>
</li>
<li>
<p><strong>代码的“气味”</strong>：新人写出的代码能跑，但可能是一坨意大利面条（Spaghetti Code），耦合度极高，半年后谁都不敢动。你写出的代码，结构清晰，易于维护，扩展性强。这种“代码洁癖”和设计能力，是长期训练出来的。</p>
</li>
<li>
<p><strong>对业务的理解</strong>：你不仅仅是在写代码，你是在解决业务问题。你对业务的深刻理解，让你能设计出更合理的流程，避免很多无用功。新人往往只看得到需求文档的字面意思。</p>
</li>
<li>
<p><strong>权衡的艺术</strong>：技术没有银弹。用消息队列，你得权衡一致性、可用性、复杂度。这种在各种限制条件下做最优解的能力，是“经验值”的直接体现。</p>
</li>
</ul>
<h4 data-id="heading-37">📊 3. 程序员的价值金字塔</h4>
<p>其实，程序员的工作可以分为三层，你的焦虑主要来自于处于中间层：</p>
<ul>
<li>
<p><strong>第一层：基础执行层（可替代性高）</strong></p>
<ul>
<li>工作内容：实现具体的接口、页面、简单的业务逻辑。</li>
<li>状态：就是“换个人也能干”。这是纯体力活，卷的是代码量和加班时长。</li>
</ul>
</li>
<li>
<p><strong>第二层：系统设计层（核心竞争力）</strong></p>
<ul>
<li>工作内容：设计架构、解决复杂技术难题、优化性能、保障系统稳定。</li>
<li>状态：这需要经验和天赋。不是随便拉个人就能设计出淘宝那种级别的秒杀系统的。</li>
</ul>
</li>
<li>
<p><strong>第三层：业务/产品层（不可替代性）</strong></p>
<ul>
<li>工作内容：通过技术手段创造商业价值，或者用技术去改变一个行业。</li>
<li>状态：这时候你已经不是个单纯的程序员了，你是个懂技术的业务专家。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-38">💡 所以，该怎么办？</h4>
<ol>
<li>
<p><strong>不要把“写代码”当成你的核心价值</strong>。代码只是你实现想法的工具。你的核心价值是你的**“解决问题的能力”<strong>和</strong>“架构思维”**。</p>
</li>
<li>
<p><strong>往上走，不要在底层卷</strong>。多去思考系统设计，多去了解业务，多去学习那些“道”层面的东西，而不是死磕某个新出的框架语法。</p>
</li>
<li>
<p><strong>把自己当成一个“手艺人”</strong>。虽然工作很傻，但你可以追求代码的优雅，追求架构的简洁。这种<strong>职业自豪感</strong>，是你对抗“工作无意义感”的最大武器。</p>
</li>
<li>
<p><strong>承认工作的平凡，但不放弃自己的不凡</strong>。大部分工作确实是平凡的，但这不妨碍你在这个平凡的岗位上，成为一个牛逼的人。</p>
</li>
</ol>
<h2 data-id="heading-39">概览高并发高可用的三板斧</h2>
<p>最后，我们来再次回顾和总结一下互联网工作场景中的高并发高可用的老三样或者三板斧。</p>
<p><strong>“高并发”这三个字，被吹得神乎其神，搞得好像多么高深莫测似的，其实剥开那层玄学外衣，内核确实就是那“老三样”。</strong></p>
<p>大家之所以觉得它厉害，往往是因为它把这“老三样”玩到了极致，并且处理了这三样东西带来的各种烂摊子。</p>
<p>我们把这“三板斧”扒一扒，看看它到底有多“了不起”：</p>
<h4 data-id="heading-40">🪓 第一斧：缓存 (Cache)</h4>
<ul>
<li><strong>本质</strong>：就是 <strong>“别老问数据库”</strong>。</li>
<li><strong>操作</strong>：把数据放在内存里（Redis/Memcached）或者用户身边（CDN）。</li>
<li><strong>技术含量在哪</strong>：
<ul>
<li><strong>面子上</strong>：谁都会<code>set</code>和<code>get</code>。</li>
<li><strong>里子上</strong>：缓存穿透（查不到怎么办）、缓存击穿（热点Key失效瞬间）、缓存雪崩（大量Key同时失效）、数据一致性（数据库改了，缓存怎么同步）。<strong>解决这些“并发症”才是真功夫。</strong></li>
</ul>
</li>
</ul>
<p>这里面涉及了缓存和数据如何同步的细节问题。</p>
<h4 data-id="heading-41">🪓 第二斧：限流 (Rate Limiting)</h4>
<ul>
<li><strong>本质</strong>：就是**“干不过来就直接拒绝”**。</li>
<li><strong>操作</strong>：令牌桶、漏桶、计数器，核心逻辑就是“超了就滚”。</li>
<li><strong>技术含量在哪</strong>：
<ul>
<li><strong>面子上</strong>：<code>if (count &gt; limit) return error</code>。</li>
<li><strong>里子上</strong>：怎么动态调整阈值？是按机器负载调还是按业务重要性调？拒绝的时候怎么保证用户体验不崩？<strong>在“拒绝谁”和“拒绝多少”之间找平衡，靠经验。</strong></li>
</ul>
</li>
</ul>
<h4 data-id="heading-42">🪓 第三斧：异步 (消息队列) / 降级 (Degradation)</h4>
<ul>
<li>
<p><strong>本质</strong>：就是 <strong>“削峰填谷”</strong> 和 <strong>“丢卒保车”</strong>。</p>
</li>
<li>
<p><strong>操作</strong>：</p>
<ul>
<li><strong>异步</strong>：把同步调用改成发消息，让请求排队去。</li>
<li><strong>降级</strong>：大促的时候，评论功能卡？关了！推荐商品卡？关了！只要下单能用就行。</li>
</ul>
</li>
<li>
<p><strong>技术含量在哪</strong>：</p>
<ul>
<li><strong>面子上</strong>：引入个MQ中间件，或者注释掉几行代码。</li>
<li><strong>里子上</strong>：
<ul>
<li><strong>异步</strong>：分布式事务怎么保证？消息丢了怎么补偿？怎么保证消息不被重复消费？</li>
<li><strong>降级</strong>：怎么判断什么时候该降级？降级的开关在哪？降级之后怎么快速切回来？<strong>这需要对业务逻辑极其清晰的“优先级划分”。</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<hr/>
<p><strong>单看每一个技术点，确实没什么了不起的</strong>。大学刚毕业的实习生背背八股文，都能给你讲得头头是道。</p>
<p><strong>真正的“了不起”（或者说“恶心”），在于这几点：</strong></p>
<ol>
<li>
<p><strong>组合拳的复杂度</strong>：
不是单用缓存，也不是单用MQ，而是缓存+限流+MQ+降级+熔断（熔断其实也算降级的一种）一起上。这堆东西交织在一起，<strong>系统的复杂度是指数级上升的</strong>。一个请求过来，你得知道它走了哪条路，中间出了问题怎么排查。</p>
</li>
<li>
<p><strong>海量数据的细节</strong>：
本地跑个Demo，1秒处理10个请求，用HashMap存数据都行。但在生产环境，1秒几万请求，这时候<strong>Redis的网络延迟、MQ的堆积能力、数据库连接池的大小、甚至服务器网卡的带宽</strong>，都会成为瓶颈。</p>
<ul>
<li><em>技术含量在于：你得懂计算机体系结构，懂网络，懂操作系统，才能把这些组件在极限情况下压榨出性能。</em></li>
</ul>
</li>
<li>
<p><strong>兜底方案的完备性</strong>：
最怕的不是系统扛不住，而是**“雪崩”**——A挂了拖垮B，B挂了拖垮C，最后全挂。</p>
<ul>
<li><em>技术含量在于：你得预判到所有可能的失败点，并且在每个点都设置“熔断器”和“逃生通道”。这是一种极致的防御性编程思维。</em></li>
</ul>
</li>
</ol>
<h4 data-id="heading-43">📌 总结</h4>
<p>高并发高可用，它确实就是那几招，<strong>没什么了不起的</strong>。但要把这几招在几万台机器、几亿用户上耍得滴水不漏，不出乱子，这就是大厂愿意给高薪的原因。</p>
<p><strong>它本质就是“老三样”。但能把这“老三样”伺候好的人，确实也不多。</strong> 这就是现实。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift、SwiftUI 与 SwiftData：走向成熟的 2025 -- 肘子的 Swift 周报 #116]]></title>    <link>https://juejin.cn/post/7586559672128864308</link>    <guid>https://juejin.cn/post/7586559672128864308</guid>    <pubDate>2025-12-22T23:57:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586559672128864308" data-draft-id="7585555806667882530" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift、SwiftUI 与 SwiftData：走向成熟的 2025  -- 肘子的 Swift 周报 #116"/> <meta itemprop="keywords" content="Swift,SwiftUI,人工智能"/> <meta itemprop="datePublished" content="2025-12-22T23:57:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="东坡肘子"/> <meta itemprop="url" content="https://juejin.cn/user/1548526032528727"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift、SwiftUI 与 SwiftData：走向成熟的 2025  -- 肘子的 Swift 周报 #116
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1548526032528727/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    东坡肘子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T23:57:50.000Z" title="Mon Dec 22 2025 23:57:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3fe19d80bf7c4fdc937a67db9a914afc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lic5Z2h6IKY5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767052670&amp;x-signature=8%2BAzv2ZvVa3ldLeiG%2FUJb58vMMM%3D" alt="issue116.webp" loading="lazy"/></p>
<h2 data-id="heading-0">Swift、SwiftUI 与 SwiftData：走向成熟的 2025</h2>
<p>在过去的几天里，我回顾了这一年来 Swift、SwiftUI 以及 SwiftData 的演进。总的感觉是：惊喜虽不算多，但“成熟感”却在不经意间扑面而来。</p>
<p>毋庸置疑，Swift 今年的重头戏在于改善并发编程的体验。尽管新增的选项和关键字在短期内又给开发者带来了不小的困扰，但经过这几个月的讨论与实践，社区已经显现出逐渐总结出新范式实践路径的趋势。我不认为新范式被确立且广泛接受会是一个简单、迅速的过程，但或许再过一两年，开发者对 Swift 的讨论重心将从并发转向跨平台，届时 Swift 也将迈入全新的发展阶段。</p>
<p>今年 SwiftUI 的更新重心大多集中在 Liquid Glass 的适配上。受限于系统初期的实现，显示效果起初并不尽如人意，但在 iOS 26.2 版本发布后，性能与稳定性都有了显著改善。坦率地说，对于今年 SwiftUI 没有引入更多革命性的新功能，我个人是挺高兴的。这让框架团队和开发者都能获得一点喘息之机，去进一步消化这个框架。在现阶段，解决遗留问题、优化性能与稳定性，远比一味堆砌新特性更有意义。</p>
<p>“变化较小”在 SwiftData 身上体现得尤为明显。但我认为 SwiftData 今年的表现尤为值得肯定，特别是许多改进与新功能都向下适配到了更早的系统版本。真希望它在三年前初次发布时，就能具备现在的状态。尽管 SwiftData 目前仍缺失一些关键功能，但对于相当比例的项目而言，它已经足以胜任。有了这个稳固的基础，其未来几年在性能与功能上的提高非常值得期待。</p>
<p>对于 2025 年 Swift 三件套的交出的答卷，我个人是满意的，不知你的感受如何？</p>
<p>这是本年度的最后一期周报，由衷感谢各位一年的陪伴与厚爱。</p>
<p>祝大家新年快乐，Happy Coding!</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-116%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-116/" ref="nofollow noopener noreferrer">本期内容</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-115%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-115/" ref="nofollow noopener noreferrer">前一期内容</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2F" target="_blank" title="https://fatbobman.com/zh/weekly/" ref="nofollow noopener noreferrer">全部周报列表</a></p>
<blockquote>
<p>🚀 <strong>《肘子的 Swift 周报》</strong></p>
<p>每周为你精选最值得关注的 Swift、SwiftUI 技术动态</p>
<ul>
<li><strong>📮 立即订阅</strong> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fweekly.fatbobman.com%2Ffatbobman" target="_blank" title="https://weekly.fatbobman.com/fatbobman" ref="nofollow noopener noreferrer">weekly.fatbobman.com</a> 获取完整内容</li>
<li><strong>👥 加入社区</strong> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscord.com%2Finvite%2F7FedN5E2QQ" target="_blank" title="https://discord.com/invite/7FedN5E2QQ" ref="nofollow noopener noreferrer">Discord</a> 与 2000+ 开发者交流</li>
<li><strong>📚 深度教程</strong> | <a href="https://link.juejin.cn?target=http%3A%2F%2Ffatbobman.com" target="_blank" title="http://fatbobman.com" ref="nofollow noopener noreferrer">fatbobman.com</a> 探索 200+ 原创文章</li>
</ul>
</blockquote>
<h2 data-id="heading-1">活动</h2>
<h3 data-id="heading-2"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0116-08" target="_blank" title="https://l.fatbobman.com/w0116-08" ref="nofollow noopener noreferrer">iOS Conf SG 2026</a></h3>
<p>下个月（1 月 21 日 - 23 日），iOS Conf SG 将在新加坡举行。我也将前往现场，并作为嘉宾进行主题为 <strong>“Using SwiftUI as a Language”</strong> 的演讲——不仅关于代码，更是关于思维方式的转换。</p>
<p>如果你也在附近，或者计划前往，欢迎来现场打招呼！组委会专门为我的读者提供了优惠：<a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fiosconfsg2026" target="_blank" title="https://l.fatbobman.com/iosconfsg2026" ref="nofollow noopener noreferrer">Fatbobman 读者专属九折优惠链接</a></p>
<h2 data-id="heading-3">近期推荐</h2>
<h3 data-id="heading-4"><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fposts%2Fmy-eight-years-with-cloudkit%2F%3Futm_source%3Dfatbobman%2520weekly%2520issue%2520116%26utm_medium%3Dweb" target="_blank" title="https://fatbobman.com/zh/posts/my-eight-years-with-cloudkit/?utm_source=fatbobman%20weekly%20issue%20116&amp;utm_medium=web" ref="nofollow noopener noreferrer">我和 CloudKit 的这八年：从开源 IceCream 到商业应用实战</a></h3>
<p>我一直认为，所谓的苹果生态是由很多的硬件、软件、服务、人文、气质等综合构建起来的。在这其中，CloudKit 无疑是非常重要的一环。而且对于开发者来说，用好 CloudKit 不仅可以给用户更好的体验，也能低成本的为自己的应用带来创新。</p>
<p>IceCream 作者 <a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fcaiyue5" target="_blank" title="https://x.com/caiyue5" ref="nofollow noopener noreferrer">Cai Yue</a> 分享他与 CloudKit 八年的开发历程：从 2017 年开源 IceCream 并获得 Apple 官方认可，到将 CloudKit 应用于 Music Mate 和 Setlists 等商业项目的实战经验。文章深入探讨了 CloudKit 的核心优势、关键局限以及进阶玩法。</p>
<hr/>
<h3 data-id="heading-5"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0116-01" target="_blank" title="https://l.fatbobman.com/w0116-01" ref="nofollow noopener noreferrer">Swift 2025 年度总结 (What's new in Swift: December 2025 Edition)</a></h3>
<p>这是一篇面向 Swift 社区的年度收官综述文章，由 <a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Ftimsneath" target="_blank" title="https://x.com/timsneath" ref="nofollow noopener noreferrer">Tim Sneath</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.linkedin.com%2Fin%2Fdavelester-dev%2F" target="_blank" title="https://www.linkedin.com/in/davelester-dev/" ref="nofollow noopener noreferrer">Dave Lester</a> 撰写，系统回顾了 2025 年 Swift 生态在语言特性、平台覆盖与社区建设方面的关键进展。</p>
<p>文章不仅总结了 Swift 6.2 在并发模型上通过更温和的默认策略降低使用门槛，同时继续推进 C++ 互操作与内存安全能力；更重要的是，从 Android、WASM、Windows、BSD、嵌入式到 AWS 等方向的持续投入，反复强化了一个清晰信号——Swift 已不再只是围绕 Apple 平台展开的语言。</p>
<p>或许你未必会认同其中的每一项变化，但在迈入第二个十年后的第一个年头里，Swift 依然交出了一份相当扎实的答卷。</p>
<hr/>
<h3 data-id="heading-6"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0116-02" target="_blank" title="https://l.fatbobman.com/w0116-02" ref="nofollow noopener noreferrer">关于 SwiftUI 的讨论 (My PM insisted we switch to SwiftUI for a massive legacy app rewrite. The result is exactly what you'd expect)</a></h3>
<p>几天前无意间在 Reddit 上看到的帖子，作者对 PM 轻易选择 SwiftUI 有所抱怨，认为其无法胜任他们一个七年前开发的应用转换。对于这个观点我不置可否，但评论区的走向却出乎意料——绝大多数参与者都坚定地站在了 SwiftUI 的一边。</p>
<p>大量开发者认为：</p>
<ul>
<li>SwiftUI 本身已经足够成熟，问题出在实施方式上</li>
<li>应该渐进式迁移，而不是一次性重写</li>
<li>避开 SwiftUI 的弱项——比如可以保留 UIKit 导航，只迁移视图层</li>
<li>多个大型项目（10+ 年历史）已成功完成迁移</li>
</ul>
<p>这个帖子展现了一个出乎我预料的现实：SwiftUI 在实际生产环境中的采用率比我们想象的高得多；开发者社区对 SwiftUI 的信心已经建立。在 2025 年底，“SwiftUI 难堪大任”的论调或许已经站不住脚了。</p>
<blockquote>
<p>作为 SwiftUI 框架的推崇者，我既喜欢该框架，也很清楚它仍有很长的路要走。如果你仍在犹豫是否应该在 SwiftUI 上下功夫，或许可以看一下我在去年写的<a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fposts%2Fcommon-misconceptions-about-swiftui%2F%3Futm_source%3Dfatbobman%2520weekly%2520issue%2520116%26utm_medium%3Dweb" target="_blank" title="https://fatbobman.com/zh/posts/common-misconceptions-about-swiftui/?utm_source=fatbobman%20weekly%20issue%20116&amp;utm_medium=web" ref="nofollow noopener noreferrer">《几个常见的关于 SwiftUI 的误解》</a>——这篇文章讨论的很多误解，恰好在这次 Reddit 讨论中得到了印证。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0116-03" target="_blank" title="https://l.fatbobman.com/w0116-03" ref="nofollow noopener noreferrer">非 Sendable 优先设计 (Non-Sendable First Design)</a></h3>
<p>随着 Swift 6 时代的到来，开发者逐渐养成了一种惯性：要么让类型符合 <code>Sendable</code>，要么给它套上 <code>@MainActor</code> 或 <code>actor</code>。在这篇文章中，<a href="https://link.juejin.cn?target=https%3A%2F%2Fmastodon.social%2F%40mattiem" target="_blank" title="https://mastodon.social/@mattiem" ref="nofollow noopener noreferrer">Matt Massicotte</a> 提出了一个极具启发性的哲学：<strong>“非 Sendable 优先设计”</strong>。</p>
<p>这一思路的关键在于对“隔离（Isolation）”的重新认识：隔离本身是一种约束。当一个类型被标记为 <code>@MainActor</code>，它实际上就失去了在非 UI 环境下进行同步调用的自由度。相比之下，一个非隔离、非 Sendable 的普通类型反而具有更高的通用性——它可以被任意 Actor 持有，并在其内部安全地进行同步访问，同时也更容易遵循 <code>Equatable</code> 等基础协议，而无需处理跨隔离域带来的复杂性。</p>
<p>随着 Swift 引入 NonisolatedNonsendingByDefault，这种“非 Sendable 优先”的设计路径不再像过去那样笨重或别扭，反而逐渐显现出其优势：以更少的隔离、换取更清晰的语义与更低的架构负担。这或许并非适用于所有场景，但在 Swift 6 之后，它已经成为一种值得认真考虑的、符合语言直觉的“减法”方案。</p>
<hr/>
<h3 data-id="heading-8"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0116-04" target="_blank" title="https://l.fatbobman.com/w0116-04" ref="nofollow noopener noreferrer">使用 Registry 加速依赖解析 (Resolving Swift Packages faster With Registry from Tuist)</a></h3>
<p>传统的 SPM 依赖解析是基于 Git URL 的，Xcode 需要克隆整个 Git 仓库来获取版本信息和代码，这在依赖较多（如 Firebase）时非常耗时。而 Registry 是苹果定义的另一种规范：通过包的标识符（ID）直接下载特定版本的归档文件，跳过了繁重的 Git 操作。Tuist 最近宣布将其 Swift Package Registry 功能向所有开发者开放，最大的变化是现在无需登录或创建 Tuist 账号即可使用。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.linkedin.com%2Fin%2Fgamehelper%2F" target="_blank" title="https://www.linkedin.com/in/gamehelper/" ref="nofollow noopener noreferrer">Lee Young-jun</a> 实测发现，使用 Registry 后，依赖解析（Installation）时间缩短至原来的约 35%；但项目生成与构建阶段并未获得同等收益，甚至略有回退。在 GitHub Actions 中配合缓存使用时，二次构建的依赖安装时间则从 53s 降至 11s，优势主要体现在 CI 场景。</p>
<p>总体来看，Tuist Registry 并非“全流程加速器”，而是一个专注于依赖解析与缓存友好性的优化点。如果你的项目依赖数量庞大、CI 成本较高，它值得优先尝试。</p>
<hr/>
<h3 data-id="heading-9"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0116-05-1" target="_blank" title="https://l.fatbobman.com/w0116-05-1" ref="nofollow noopener noreferrer">iOS Timer 与 DispatchSourceTimer 选择与安全封装技巧｜有限状态机防止闪退</a></h3>
<p>很多开发者在处理 <code>DispatchSourceTimer</code> 时，最头疼的就是它那“易碎”的状态：调用顺序稍有不对便会引发闪退。<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fzhgchgli" target="_blank" title="https://x.com/zhgchgli" ref="nofollow noopener noreferrer">ZhgChgLi</a> 在本文中针对这种极其敏感的状态管理提出了工程化的解决方案。文章详尽列举了导致崩溃的五大常见场景（如重复 resume、suspend 状态下直接释放等），并分享了如何利用有限状态机 (FSM) 封装操作，从逻辑层屏蔽非法调用，同时配合私有串行队列确保多线程环境下的调用安全。</p>
<blockquote>
<p>这是一篇引导读者从“写代码”转向“做设计”的实战案例。它不仅讲清了 GCD 定时器的正确使用方式，更展示了如何借助设计模式，将一个“危险”的底层 API，封装为语义清晰、使用安全、可长期维护的工业级组件。在 Swift Concurrency 日益成为主流的今天，理解并优雅地封装这些底层 GCD 工具，依然是高级 iOS 开发者的重要基本功。</p>
</blockquote>
<h2 data-id="heading-10">工具</h2>
<h3 data-id="heading-11"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0116-06" target="_blank" title="https://l.fatbobman.com/w0116-06" ref="nofollow noopener noreferrer">ml-sharp：照片秒变 3D 场景</a></h3>
<p>苹果在上周开源了 SHARP (Sharp Monocular View Synthesis)，一个能在不到 1 秒内将单张 2D 照片转换为 3D 场景的 AI 模型（模型大小 2.8 GB）。相比之前的最佳模型，视觉质量提升 25-34%，速度提升 1000 倍。</p>
<p>社区普遍认为 SHARP 可能用于未来版本的空间照片功能。目前 iOS 26 的 Spatial Scenes 使用 Neural Engine 进行深度重建，而 SHARP 采用更先进的 3D Gaussian Splatting 技术，质量显著提升。</p>
<p>模型支持 CPU/CUDA/MPS 运行，已有开发者在 M1/M2/M3 Mac 上成功运行。输出的 .ply 文件兼容各种 3DGS 查看器，Vision Pro 用户可通过 Metal Splatter 直接<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2FSadlyItsBradley%2Fstatus%2F2001294992145588232" target="_blank" title="https://x.com/SadlyItsBradley/status/2001294992145588232" ref="nofollow noopener noreferrer">查看效果</a>。</p>
<p>尽管苹果在通用语言大模型上不如竞争对手惊艳，但在垂直场景的 AI 模型上，凭借硬件深度整合与明确的应用导向，依然展现出强大的竞争力。</p>
<hr/>
<h3 data-id="heading-12"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0116-07" target="_blank" title="https://l.fatbobman.com/w0116-07" ref="nofollow noopener noreferrer">MaterialView: 突破 NSVisualEffectView 限制的毛玻璃视图</a></h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Foskargroth" target="_blank" title="https://x.com/oskargroth" ref="nofollow noopener noreferrer">Oskar Groth</a> (<a href="https://link.juejin.cn?target=https%3A%2F%2Fcindori.com%2Fsensei" target="_blank" title="https://cindori.com/sensei" ref="nofollow noopener noreferrer">Sensei</a> 作者)开源了 MaterialView，一个能够突破 <code>NSVisualEffectView</code> 限制的高度可定制毛玻璃视图库。通过逆向 Control Center 的实现，Oskar 实现了对模糊半径、饱和度、亮度和色调的完全控制，并撰写了详细的<a href="https://link.juejin.cn?target=https%3A%2F%2Foskargroth.com%2Fblog%2Freverse-engineering-nsvisualeffectview%3Futm_source%3Dfatbobman%2520weekly%2520issue%2520116%26utm_medium%3Dweb" target="_blank" title="https://oskargroth.com/blog/reverse-engineering-nsvisualeffectview?utm_source=fatbobman%20weekly%20issue%20116&amp;utm_medium=web" ref="nofollow noopener noreferrer">技术文章</a>讲解实现原理。</p>
<p>与系统原生材质只能“选类型”不同，MaterialView 将模糊效果彻底参数化，允许开发者精确控制模糊半径、饱和度、亮度、tint 颜色与混合模式，并支持 active / inactive / emphasized / accessibility 等状态配置。这使得它非常适合用于侧边栏、浮层面板、工具窗口等对视觉一致性要求极高的场景。</p>
<p>该库同时支持 SwiftUI 与 AppKit，并提供了一个可实时调参的 Demo App，方便快速探索不同材质组合的效果。</p>
<blockquote>
<p>需要注意的是，它依赖部分未公开的 Core Animation 能力（如 <code>CABackdropLayer</code>、<code>CAFilter</code> 等）。尽管这些 API 多年来相当稳定，但仍存在未来系统版本变动的潜在风险。</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3552aa1b80b2445c944d310ce6f9c1f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lic5Z2h6IKY5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767052670&amp;x-signature=swudm3vB6tfsdI6ioj8Bp0JRzbw%3D" alt="materialview-demo.gif" loading="lazy"/></p>
<h2 data-id="heading-13">往期内容</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-115%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-115/" ref="nofollow noopener noreferrer">周日小插曲 - #115</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-114%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-114/" ref="nofollow noopener noreferrer">挖掘“沉默的专家”- #114</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhttps%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-113%2F" target="_blank" title="https://https://fatbobman.com/zh/weekly/issue-113/" ref="nofollow noopener noreferrer">当 Android 手机『强行兼容』AirDrop - #113</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-112%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-112/" ref="nofollow noopener noreferrer">毕业 30 年同学群：一场 AI 引发的“真假难辨”危机 - #112</a></li>
</ul>
<h2 data-id="heading-14">💝 支持与反馈</h2>
<p>如果本期周报对你有帮助，请：</p>
<ul>
<li>👍 <strong>点赞</strong> - 让更多开发者看到</li>
<li>💬 <strong>评论</strong> - 分享你的看法或问题</li>
<li>🔄 <strong>转发</strong> - 帮助同行共同成长</li>
</ul>
<hr/>
<blockquote>
<p>🚀 <strong>拓展 Swift 视野</strong></p>
<ul>
<li><strong>📮 邮件订阅</strong> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fweekly.fatbobman.com%2Fwelcome" target="_blank" title="https://weekly.fatbobman.com/welcome" ref="nofollow noopener noreferrer">weekly.fatbobman.com</a> 获取独家技术洞察</li>
<li><strong>👥 开发者社区</strong> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscord.com%2Finvite%2F7FedN5E2QQ" target="_blank" title="https://discord.com/invite/7FedN5E2QQ" ref="nofollow noopener noreferrer">Discord</a> 实时交流开发经验</li>
<li><strong>📚 原创教程</strong> | <a href="https://link.juejin.cn?target=http%3A%2F%2Ffatbobman.com" target="_blank" title="http://fatbobman.com" ref="nofollow noopener noreferrer">fatbobman.com</a> 学习 Swift/SwiftUI 最佳实践</li>
</ul>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Netty（27）Netty的拦截器和过滤器是什么？如何使用它们？]]></title>    <link>https://juejin.cn/post/7586491717874139155</link>    <guid>https://juejin.cn/post/7586491717874139155</guid>    <pubDate>2025-12-22T22:57:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586491717874139155" data-draft-id="7586490798432485439" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Netty（27）Netty的拦截器和过滤器是什么？如何使用它们？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-22T22:57:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Netty（27）Netty的拦截器和过滤器是什么？如何使用它们？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T22:57:06.000Z" title="Mon Dec 22 2025 22:57:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Netty中，拦截器和过滤器通常指的是在处理网络请求和响应时，插入到ChannelPipeline中的各种处理器（Handler）。这些处理器可以对数据进行拦截、修改、过滤、记录等操作，类似于Servlet中的过滤器或Spring中的拦截器。</p>
<h3 data-id="heading-0">1. Netty的拦截器和过滤器概述</h3>
<ul>
<li><strong>拦截器（Interceptor）</strong>：通常指的是能够在请求或响应处理的某个阶段进行拦截，并对其进行处理的机制。在Netty中，<code>ChannelHandler</code>可以起到拦截器的作用。</li>
<li><strong>过滤器（Filter）</strong>：通常指的是对数据进行过滤、修改等操作的机制。在Netty中，<code>ChannelHandler</code>也可以起到过滤器的作用。</li>
</ul>
<h3 data-id="heading-1">2. 如何使用拦截器和过滤器</h3>
<p>在Netty中，拦截器和过滤器的实现主要依赖于<code>ChannelHandler</code>和<code>ChannelPipeline</code>。通过将不同的<code>ChannelHandler</code>添加到<code>ChannelPipeline</code>中，可以实现各种拦截和过滤功能。</p>
<h3 data-id="heading-2">3. 代码示例</h3>
<p>以下是一个详细的代码示例，展示了如何在Netty中使用拦截器和过滤器。</p>
<h4 data-id="heading-3">1. 定义一个简单的服务器</h4>
<p>首先，我们定义一个简单的服务器，它将接收客户端的消息并返回响应。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.bootstrap.ServerBootstrap;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelPipeline;
<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;
<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleServer</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">bossGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(<span class="hljs-number">1</span>);
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">workerGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ServerBootstrap</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerBootstrap</span>();
            b.group(bossGroup, workerGroup)
             .channel(NioServerSocketChannel.class)
             .childHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {
                 <span class="hljs-meta">@Override</span>
                 <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception {
                     <span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> ch.pipeline();
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LoggingHandler</span>()); <span class="hljs-comment">// Logging interceptor</span>
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">AuthenticationHandler</span>()); <span class="hljs-comment">// Authentication filter</span>
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleServerHandler</span>()); <span class="hljs-comment">// Main handler</span>
                 }
             });

            b.bind(<span class="hljs-number">8080</span>).sync().channel().closeFuture().sync();
        } <span class="hljs-keyword">finally</span> {
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }
}
</code></pre>
<h4 data-id="heading-4">2. 实现拦截器（LoggingHandler）</h4>
<p><code>LoggingHandler</code>是一个简单的拦截器，它在每次接收到消息时进行日志记录。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoggingHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ChannelInboundHandlerAdapter</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg)</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"Received message: "</span> + msg);
        <span class="hljs-built_in">super</span>.channelRead(ctx, msg); <span class="hljs-comment">// 继续传递消息给下一个处理器</span>
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> {
        cause.printStackTrace();
        ctx.close();
    }
}
</code></pre>
<h4 data-id="heading-5">3. 实现过滤器（AuthenticationHandler）</h4>
<p><code>AuthenticationHandler</code>是一个简单的过滤器，它在处理消息前进行认证检查。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInboundHandlerAdapter;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AuthenticationHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ChannelInboundHandlerAdapter</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 假设 msg 是一个字符串，包含用户名和密码</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> (String) msg;
        <span class="hljs-keyword">if</span> (authenticate(message)) {
            <span class="hljs-built_in">super</span>.channelRead(ctx, msg); <span class="hljs-comment">// 认证通过，继续传递消息给下一个处理器</span>
        } <span class="hljs-keyword">else</span> {
            ctx.writeAndFlush(<span class="hljs-string">"Authentication failed"</span>);
            ctx.close();
        }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">authenticate</span><span class="hljs-params">(String message)</span> {
        <span class="hljs-comment">// 简单的认证逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"username:password"</span>.equals(message);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> {
        cause.printStackTrace();
        ctx.close();
    }
}
</code></pre>
<h4 data-id="heading-6">4. 实现主处理器（SimpleServerHandler）</h4>
<p><code>SimpleServerHandler</code>是服务器的主要处理器，它处理经过认证的消息并返回响应。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleServerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SimpleChannelInboundHandler</span>&lt;String&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, String msg)</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"Processing message: "</span> + msg);
        ctx.writeAndFlush(<span class="hljs-string">"Hello, "</span> + msg);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> {
        cause.printStackTrace();
        ctx.close();
    }
}
</code></pre>
<h4 data-id="heading-7">5. 定义客户端</h4>
<p>定义一个简单的客户端来测试服务器。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.bootstrap.Bootstrap;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelPipeline;
<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;
<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;
<span class="hljs-keyword">import</span> io.netty.handler.codec.string.StringDecoder;
<span class="hljs-keyword">import</span> io.netty.handler.codec.string.StringEncoder;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleClient</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Bootstrap</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bootstrap</span>();
            b.group(group)
             .channel(NioSocketChannel.class)
             .handler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {
                 <span class="hljs-meta">@Override</span>
                 <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception {
                     <span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> ch.pipeline();
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringDecoder</span>());
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringEncoder</span>());
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleClientHandler</span>());
                 }
             });

            b.connect(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">8080</span>).sync().channel().closeFuture().sync();
        } <span class="hljs-keyword">finally</span> {
            group.shutdownGracefully();
        }
    }
}

<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleClientHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SimpleChannelInboundHandler</span>&lt;String&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelActive</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> {
        ctx.writeAndFlush(<span class="hljs-string">"username:password"</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, String msg)</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"Received response: "</span> + msg);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> {
        cause.printStackTrace();
        ctx.close();
    }
}
</code></pre>
<p>通过以上示例，您可以看到如何在Netty中使用拦截器和过滤器。拦截器和过滤器可以通过实现<code>ChannelHandler</code>接口并将其添加到<code>ChannelPipeline</code>中来实现。拦截器用于在处理请求和响应的某个阶段进行拦截，而过滤器则用于对数据进行过滤和修改。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Netty（28）Netty的内存管理和垃圾回收机制是如何工作的？]]></title>    <link>https://juejin.cn/post/7586555198115135494</link>    <guid>https://juejin.cn/post/7586555198115135494</guid>    <pubDate>2025-12-22T22:57:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586555198115135494" data-draft-id="7586500093844537386" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Netty（28）Netty的内存管理和垃圾回收机制是如何工作的？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-22T22:57:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Netty（28）Netty的内存管理和垃圾回收机制是如何工作的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T22:57:56.000Z" title="Mon Dec 22 2025 22:57:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Netty的内存管理机制是其高性能的一个重要组成部分。Netty通过一套自定义的内存分配和释放机制来提高性能并减少垃圾回收（GC）压力。以下是Netty内存管理和垃圾回收机制的详细介绍。</p>
<h3 data-id="heading-0">1. 内存管理机制</h3>
<p>Netty的内存管理主要依赖于其<code>ByteBuf</code>类和内存池机制。<code>ByteBuf</code>是Netty的数据容器，类似于Java的<code>ByteBuffer</code>，但具有更多的功能和更高的性能。</p>
<h4 data-id="heading-1">1.1 ByteBuf</h4>
<p><code>ByteBuf</code>是Netty中用于数据读写的核心组件，具有以下特点：</p>
<ul>
<li><strong>引用计数</strong>：<code>ByteBuf</code>采用引用计数来管理内存，当引用计数归零时，内存会被释放。</li>
<li><strong>池化机制</strong>：<code>ByteBuf</code>可以通过内存池进行分配和回收，减少了频繁的内存分配和释放操作，提升了性能。</li>
</ul>
<h4 data-id="heading-2">1.2 ByteBuf的类型</h4>
<p><code>ByteBuf</code>有两种主要类型：</p>
<ul>
<li><strong>Heap ByteBuf</strong>：基于JVM堆内存的<code>ByteBuf</code>，适用于需要与传统Java代码交互的场景。</li>
<li><strong>Direct ByteBuf</strong>：基于直接内存（堆外内存）的<code>ByteBuf</code>，适用于网络I/O操作，减少了内存复制，提高了性能。</li>
</ul>
<h3 data-id="heading-3">2. 内存池机制</h3>
<p>Netty通过内存池来提高内存分配和释放的效率。内存池机制主要包括以下几个组件：</p>
<ul>
<li><strong>PooledByteBufAllocator</strong>：内存池分配器，用于管理<code>ByteBuf</code>的分配和回收。</li>
<li><strong>Arena</strong>：内存池中的内存区域，负责具体的内存分配和回收操作。</li>
<li><strong>Chunk</strong>：内存池中的内存块，每个Chunk包含多个Page。</li>
<li><strong>Page</strong>：内存池中的基本分配单位，每个Page包含多个Subpage。</li>
<li><strong>Subpage</strong>：内存池中的最小分配单位。</li>
</ul>
<h3 data-id="heading-4">3. 引用计数和垃圾回收机制</h3>
<p>Netty通过引用计数来管理<code>ByteBuf</code>的生命周期。每次分配一个<code>ByteBuf</code>时，引用计数为1。当调用<code>ByteBuf.release()</code>方法时，引用计数减1，当引用计数归零时，内存会被释放。</p>
<h3 data-id="heading-5">4. 代码示例</h3>
<p>以下是一个详细的代码示例，展示了Netty的内存管理和垃圾回收机制。</p>
<h4 data-id="heading-6">1. 使用PooledByteBufAllocator分配和释放内存</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.buffer.ByteBuf;
<span class="hljs-keyword">import</span> io.netty.buffer.PooledByteBufAllocator;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ByteBufExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 创建一个PooledByteBufAllocator</span>
        <span class="hljs-type">PooledByteBufAllocator</span> <span class="hljs-variable">allocator</span> <span class="hljs-operator">=</span> PooledByteBufAllocator.DEFAULT;

        <span class="hljs-comment">// 分配一个ByteBuf</span>
        <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> allocator.buffer(<span class="hljs-number">256</span>);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 使用ByteBuf进行读写操作</span>
            buf.writeInt(<span class="hljs-number">42</span>);
            <span class="hljs-type">int</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> buf.readInt();
            System.out.println(<span class="hljs-string">"Read value: "</span> + value);

            <span class="hljs-comment">// 检查引用计数</span>
            System.out.println(<span class="hljs-string">"Reference count: "</span> + buf.refCnt());
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// 释放ByteBuf</span>
            buf.release();
            System.out.println(<span class="hljs-string">"Reference count after release: "</span> + buf.refCnt());
        }
    }
}
</code></pre>
<h4 data-id="heading-7">2. 使用Direct ByteBuf进行网络I/O操作</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.bootstrap.ServerBootstrap;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelPipeline;
<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;
<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;
<span class="hljs-keyword">import</span> io.netty.handler.codec.string.StringDecoder;
<span class="hljs-keyword">import</span> io.netty.handler.codec.string.StringEncoder;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NettyServer</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">bossGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(<span class="hljs-number">1</span>);
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">workerGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ServerBootstrap</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerBootstrap</span>();
            b.group(bossGroup, workerGroup)
             .channel(NioServerSocketChannel.class)
             .childHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {
                 <span class="hljs-meta">@Override</span>
                 <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception {
                     <span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> ch.pipeline();
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringDecoder</span>());
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">StringEncoder</span>());
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleServerHandler</span>());
                 }
             });

            b.bind(<span class="hljs-number">8080</span>).sync().channel().closeFuture().sync();
        } <span class="hljs-keyword">finally</span> {
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }
}

<span class="hljs-keyword">import</span> io.netty.buffer.ByteBuf;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleServerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SimpleChannelInboundHandler</span>&lt;String&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, String msg)</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"Received message: "</span> + msg);

        <span class="hljs-comment">// 分配一个Direct ByteBuf</span>
        <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> ctx.alloc().directBuffer();
        buf.writeBytes((<span class="hljs-string">"Echo: "</span> + msg).getBytes());

        <span class="hljs-comment">// 发送响应</span>
        ctx.writeAndFlush(buf);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> {
        cause.printStackTrace();
        ctx.close();
    }
}
</code></pre>
<h3 data-id="heading-8">5. 内存泄漏检测</h3>
<p>Netty提供了内存泄漏检测机制，帮助开发者发现和解决内存泄漏问题。可以通过设置<code>io.netty.leakDetection.level</code>系统属性来启用内存泄漏检测。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryLeakDetectionExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 启用高级别的内存泄漏检测</span>
        System.setProperty(<span class="hljs-string">"io.netty.leakDetection.level"</span>, <span class="hljs-string">"paranoid"</span>);

        <span class="hljs-type">PooledByteBufAllocator</span> <span class="hljs-variable">allocator</span> <span class="hljs-operator">=</span> PooledByteBufAllocator.DEFAULT;
        <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> allocator.buffer(<span class="hljs-number">256</span>);

        <span class="hljs-comment">// 忘记释放ByteBuf，模拟内存泄漏</span>
        <span class="hljs-comment">// buf.release();</span>

        <span class="hljs-comment">// 触发GC，查看内存泄漏检测日志</span>
        System.gc();
    }
}
</code></pre>
<p>通过以上示例，您可以看到Netty的内存管理和垃圾回收机制的工作原理。Netty通过<code>ByteBuf</code>和内存池机制来提高内存分配和释放的效率，并通过引用计数和内存泄漏检测来管理内存的生命周期。这些机制共同确保了Netty的高性能和低GC开销。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一篇搞定 dotnet ef：EF Core 常用命令与实战指南]]></title>    <link>https://juejin.cn/post/7586570254860582952</link>    <guid>https://juejin.cn/post/7586570254860582952</guid>    <pubDate>2025-12-22T22:58:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586570254860582952" data-draft-id="7586518130761728040" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一篇搞定 dotnet ef：EF Core 常用命令与实战指南"/> <meta itemprop="keywords" content="C#,.NET"/> <meta itemprop="datePublished" content="2025-12-22T22:58:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="唐青枫"/> <meta itemprop="url" content="https://juejin.cn/user/3737995266234280"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一篇搞定 dotnet ef：EF Core 常用命令与实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3737995266234280/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    唐青枫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T22:58:00.000Z" title="Mon Dec 22 2025 22:58:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">基础知识</h3>

























<table><thead><tr><th>项目</th><th>说明</th></tr></thead><tbody><tr><td><strong>EF Core</strong></td><td>.NET 的 ORM 框架，支持 Code First、Database First。</td></tr><tr><td><strong>dotnet ef</strong></td><td>一个 <strong>CLI 工具</strong>，用于管理 EF Core 迁移、数据库操作。</td></tr><tr><td><strong>安装方式</strong></td><td>通常安装在项目中（推荐）：<br/><code>dotnet add package Microsoft.EntityFrameworkCore.Design</code><br/>全局工具：<code>dotnet tool install --global dotnet-ef</code></td></tr><tr><td><strong>使用位置</strong></td><td>在包含 <code>*.csproj</code> 的目录执行，或者使用 <code>--project</code> 指定项目路径。</td></tr></tbody></table>
<blockquote>
<p>在执行任何 dotnet ef 命令前，需要在 csproj 中包含 Microsoft.EntityFrameworkCore.Design 包。</p>
</blockquote>
<h3 data-id="heading-1">命令总览</h3>




























































<table><thead><tr><th>命令</th><th>作用</th><th>典型场景</th></tr></thead><tbody><tr><td><code>dotnet ef migrations add</code></td><td>添加新的数据库迁移</td><td>增加或修改实体模型后</td></tr><tr><td><code>dotnet ef migrations list</code></td><td>查看已有迁移</td><td>确认数据库版本</td></tr><tr><td><code>dotnet ef migrations remove</code></td><td>删除最新迁移</td><td>回滚刚添加但未应用的迁移</td></tr><tr><td><code>dotnet ef migrations script</code></td><td>生成 SQL 脚本</td><td>手工执行迁移</td></tr><tr><td><code>dotnet ef database update</code></td><td>更新数据库到指定迁移</td><td>同步数据库与模型</td></tr><tr><td><code>dotnet ef database drop</code></td><td>删除数据库</td><td>重置开发环境</td></tr><tr><td><code>dotnet ef dbcontext info</code></td><td>查看 DbContext 信息</td><td>调试上下文配置</td></tr><tr><td><code>dotnet ef dbcontext list</code></td><td>列出可用 DbContext</td><td>多上下文项目</td></tr><tr><td><code>dotnet ef dbcontext scaffold</code></td><td>根据现有数据库生成实体</td><td>Database First 逆向工程</td></tr><tr><td><code>dotnet ef dbcontext optimize</code></td><td>预生成模型快照以提升启动速度</td><td>高性能场景</td></tr></tbody></table>
<h3 data-id="heading-2">常用命令详解 + 示例</h3>
<h4 data-id="heading-3">创建迁移</h4>
<pre><code class="hljs language-shell" lang="shell">dotnet ef migrations add InitialCreate
</code></pre>
<p>在 <code>Migrations</code>/ 目录下生成：</p>
<ul>
<li>
<p><code>YYYYMMDDHHMMSS_InitialCreate.cs</code>：迁移代码</p>
</li>
<li>
<p><code>AppDbContextModelSnapshot.cs</code>：模型快照文件</p>
</li>
</ul>
<p>常用参数：</p>






























<table><thead><tr><th>参数</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>--project</code></td><td>指定启动项目</td><td><code>--project ./MyApp</code></td></tr><tr><td><code>--startup-project</code></td><td>指定包含 <code>Program.cs</code> 的启动项目</td><td><code>--startup-project ./MyApp.Web</code></td></tr><tr><td><code>--context</code></td><td>指定 DbContext</td><td><code>--context AppDbContext</code></td></tr><tr><td><code>--output-dir</code></td><td>指定迁移文件夹</td><td><code>--output-dir Data/Migrations</code></td></tr></tbody></table>
<blockquote>
<p>在多项目架构中（如分离 <code>DAL</code>/启动项目），务必同时指定 <code>--project</code> 和 <code>--startup-project</code>。</p>
</blockquote>
<h4 data-id="heading-4">应用迁移</h4>
<pre><code class="hljs language-shell" lang="shell">dotnet ef database update
</code></pre>
<ul>
<li>
<p>将数据库更新到最新迁移。</p>
</li>
<li>
<p>如果数据库不存在，会自动创建。</p>
</li>
</ul>
<p>可指定版本：</p>
<pre><code class="hljs language-shell" lang="shell">dotnet ef database update InitialCreate
</code></pre>
<p>将数据库回滚到指定迁移（或升级到某个中间版本）。</p>
<h4 data-id="heading-5">查看迁移</h4>
<pre><code class="hljs language-shell" lang="shell">dotnet ef migrations list
</code></pre>
<p>输出：</p>
<pre><code class="hljs">20250922121212_InitialCreate
20250923104530_AddUserTable
</code></pre>
<h4 data-id="heading-6">删除迁移</h4>
<pre><code class="hljs language-shell" lang="shell">dotnet ef migrations remove
</code></pre>
<ul>
<li>
<p>删除最新迁移文件。</p>
</li>
<li>
<p>仅限未执行 <code>database update</code> 的迁移。</p>
</li>
</ul>
<h4 data-id="heading-7">生成 SQL 脚本</h4>
<pre><code class="hljs language-shell" lang="shell">dotnet ef migrations script
</code></pre>
<ul>
<li>
<p>生成从初始数据库到最新迁移的 <code>SQL</code> 脚本。</p>
</li>
<li>
<p>可指定起止迁移：</p>
</li>
</ul>
<pre><code class="hljs language-shell" lang="shell">dotnet ef migrations script InitialCreate AddUserTable -o update.sql
</code></pre>
<h4 data-id="heading-8">删除数据库</h4>
<pre><code class="hljs language-shell" lang="shell">dotnet ef database drop
</code></pre>
<ul>
<li>
<p>交互式确认后删除数据库。</p>
</li>
<li>
<p>可加 <code>--force</code> 跳过确认。</p>
</li>
</ul>
<h4 data-id="heading-9">查看 DbContext 信息</h4>
<pre><code class="hljs language-shell" lang="shell">dotnet ef dbcontext info
</code></pre>
<p>输出数据库提供程序、连接字符串等信息。</p>
<h4 data-id="heading-10">列出 DbContext</h4>
<pre><code class="hljs language-shell" lang="shell">dotnet ef dbcontext list
</code></pre>
<p>用于多上下文项目，可快速确认可用的 <code>DbContext</code>。</p>
<h4 data-id="heading-11">数据库逆向生成实体 (Database First)</h4>
<pre><code class="hljs language-shell" lang="shell">dotnet ef dbcontext scaffold \
"Server=localhost;Database=MyDb;User Id=sa;Password=Passw0rd;" \
Microsoft.EntityFrameworkCore.SqlServer \
--output-dir Models --context MyDbContext
</code></pre>
<p>常用参数：</p>





























<table><thead><tr><th>参数</th><th>说明</th></tr></thead><tbody><tr><td><code>--schema</code></td><td>指定数据库模式</td></tr><tr><td><code>--table</code></td><td>指定表（可多次指定）</td></tr><tr><td><code>--context-dir</code></td><td>指定 DbContext 文件夹</td></tr><tr><td><code>--force</code></td><td>覆盖已有文件</td></tr><tr><td><code>--use-database-names</code></td><td>保留数据库原始命名（不做 PascalCase 转换）</td></tr></tbody></table>
<h4 data-id="heading-12">模型预编译优化</h4>
<p><code>EF Core 6+</code> 提供：</p>
<pre><code class="hljs language-shell" lang="shell">dotnet ef dbcontext optimize
</code></pre>
<ul>
<li>
<p>在编译时预生成模型元数据，提升启动速度。</p>
</li>
<li>
<p>适合大型数据库或高性能场景。</p>
</li>
</ul>
<h3 data-id="heading-13">开发常用流程示例</h3>
<h4 data-id="heading-14">Code First 开发流程</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">1. 添加初始迁移</span>
dotnet ef migrations add InitialCreate
<span class="hljs-meta prompt_">
# </span><span class="bash">2. 创建/更新数据库</span>
dotnet ef database update
<span class="hljs-meta prompt_">
# </span><span class="bash">3. 修改实体模型后生成新迁移</span>
dotnet ef migrations add AddUserTable
<span class="hljs-meta prompt_">
# </span><span class="bash">4. 应用到数据库</span>
dotnet ef database update
</code></pre>
<h4 data-id="heading-15">Database First 开发流程</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">从现有数据库生成实体与上下文</span>
dotnet ef dbcontext scaffold \
"Server=localhost;Database=MyDb;User Id=sa;Password=Passw0rd;" \
Microsoft.EntityFrameworkCore.SqlServer \
--output-dir Models
</code></pre>
<h3 data-id="heading-16">常见问题与技巧</h3>





























<table><thead><tr><th>问题</th><th>解决方案</th></tr></thead><tbody><tr><td><strong>找不到 <code>dotnet ef</code> 命令</strong></td><td><code>dotnet tool install --global dotnet-ef</code></td></tr><tr><td><strong>提示找不到 DbContext</strong></td><td>检查 <code>--startup-project</code> 或 <code>--context</code> 是否指定正确</td></tr><tr><td><strong>跨项目调用失败</strong></td><td>使用 <code>--project</code> 指定包含迁移的类库项目，<code>--startup-project</code> 指定启动项目</td></tr><tr><td><strong>数据库连接不生效</strong></td><td>检查 <code>Program.cs</code> 中 <code>UseSqlServer/UseNpgsql</code> 配置</td></tr><tr><td><strong>生产环境手动部署</strong></td><td>使用 <code>dotnet ef migrations script</code> 生成 SQL 并在 DBA 审核后执行</td></tr></tbody></table>
<h3 data-id="heading-17">总结</h3>





























<table><thead><tr><th>命令</th><th>场景</th></tr></thead><tbody><tr><td><code>dotnet ef migrations add</code></td><td><strong>创建迁移</strong></td></tr><tr><td><code>dotnet ef database update</code></td><td><strong>同步数据库</strong></td></tr><tr><td><code>dotnet ef migrations list</code></td><td><strong>查看迁移历史</strong></td></tr><tr><td><code>dotnet ef dbcontext scaffold</code></td><td><strong>逆向工程</strong></td></tr><tr><td><code>dotnet ef migrations script</code></td><td><strong>生成 SQL 脚本</strong></td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[短思考第261天，浪费时间的十个低效行为，看看你中了几个？]]></title>    <link>https://juejin.cn/post/7586500093844455466</link>    <guid>https://juejin.cn/post/7586500093844455466</guid>    <pubDate>2025-12-22T16:24:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586500093844455466" data-draft-id="7586490798432354367" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="短思考第261天，浪费时间的十个低效行为，看看你中了几个？"/> <meta itemprop="keywords" content="前端,AI编程"/> <meta itemprop="datePublished" content="2025-12-22T16:24:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员码歌"/> <meta itemprop="url" content="https://juejin.cn/user/764915820529831"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            短思考第261天，浪费时间的十个低效行为，看看你中了几个？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/764915820529831/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员码歌
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T16:24:31.000Z" title="Mon Dec 22 2025 16:24:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>你有没发现自己时间总不够用，但又说不清都浪费在哪了？2026年快要来了，总结一下码歌觉得浪费时间的十个低效行为，看看你中了几个？</p>
<h3 data-id="heading-0">1、过分完美</h3>
<p>总想着做到完美再发出来？要醒醒了！等你发布的时候，人家早就已经迭代几轮了。</p>
<p>码哥前段时间做的AI导航网站就有这种感觉，总想把所有功能都做完了再发布插件市场，其实完成MVP功能就可以直接扔市场验证了。迭代＞完美。</p>
<p>破局：极短时间完成MVP扔到市场，先完成再优化，不发布永远是0。</p>
<h3 data-id="heading-1">2、过度准备</h3>
<p>收藏了巨多博客或ai热点，做了好多计划表，然后告诉自己"还没准备好"？</p>
<p>码歌年初就有计划打造自己的IP，想了非常多，也准备了非常久，一直没踏出第一步。</p>
<p>破局：72小时内必须迈出第一步，有第一步才有第二步，别想着一步登天！</p>
<h3 data-id="heading-2">3、指望别人</h3>
<p>等领导给机会、等贵人相助...最扎心的真相是：没人比你更在乎你的人生</p>
<p>破局：把"谁能帮我"改成"我怎么搞定"</p>
<h3 data-id="heading-3">4、闲聊八卦</h3>
<p>一天八卦2小时=一年浪费730小时！与其讨论别人，不如提升自己</p>
<p>破局：对话偏向八卦时立刻问自己"这跟我有关系吗"</p>
<h3 data-id="heading-4">5、 刷短视频</h3>
<p>最隐蔽的时间黑洞！更可怕的是它在降低你的专注力和深度思考能力，以前能看完一本书，现在1000字都看不下去</p>
<p>破局：每天限制30分钟，分两次刷</p>
<h3 data-id="heading-5">6、反复比价</h3>
<p>为省几块钱比价半小时？你的时间不值钱吗？能用钱解决的别用时间折腾💰</p>
<p>破局：100元内对比不超过5分钟</p>
<h3 data-id="heading-6">7️、频繁切换任务</h3>
<p>人脑不是CPU！每次切换任务=浪费23分钟专注力恢复时间</p>
<p>破局：番茄工作法，一次只做一件事</p>
<h3 data-id="heading-7">8、不切实际的幻想</h3>
<p>幻想身体健康然后继续吃零食吃泡面？幻想和目标的区别是：目标有行动计划</p>
<p>破局：把幻想拆解成今天就能做的第一步，比如晚上跑跑步</p>
<h3 data-id="heading-8">9、内耗纠结</h3>
<p>反复想"如果当初那样做"...过去已结束，未来没发生，你只能掌控现在</p>
<p>破局：发现内耗时立刻起身做2分钟小事</p>
<h3 data-id="heading-9">10、无效社交</h3>
<p>参加尬聊饭局维护塑料人脉？5个深交好友胜过500个点赞之交</p>
<p>破局：每次社交前问自己"我真心想去吗？不去会怎样？"</p>
<blockquote>
<p>看完扎心没，你中了几个？码歌起码中了5个，其实不用一次改掉所有问题，
从最容易的那个开始改，一个月搞定一个就够了，发现问题才是解决问题的第一步！
2026年，改掉坏习惯、多思考、持续输出、起码用ai干十个项目，立个flag ！</p>
</blockquote>
<p>我是”<strong>程序员码歌</strong>“，<strong>全网昵称统一</strong>，10+年大厂程序员经验，在职场，玩副业，目标副业年收入百万，探索可复利可复制的一人企业玩法，<strong>可去gzh围观</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[你以为 Props 只是传参？ 不，它是 React 组件设计的“灵魂系统”]]></title>    <link>https://juejin.cn/post/7586493936677814312</link>    <guid>https://juejin.cn/post/7586493936677814312</guid>    <pubDate>2025-12-22T16:55:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586493936677814312" data-draft-id="7586559672128372788" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="你以为 Props 只是传参？ 不，它是 React 组件设计的“灵魂系统”"/> <meta itemprop="keywords" content="React.js"/> <meta itemprop="datePublished" content="2025-12-22T16:55:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="白兰地空瓶"/> <meta itemprop="url" content="https://juejin.cn/user/191753514127514"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            你以为 Props 只是传参？ 不，它是 React 组件设计的“灵魂系统”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/191753514127514/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    白兰地空瓶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T16:55:21.000Z" title="Mon Dec 22 2025 16:55:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>90% 的 React 初学者，都低估了 Props。</strong><br/>
他们以为它只是“从父组件往子组件传点数据”。</p>
</blockquote>
<p>但真正写过复杂组件、设计过通用组件的人都知道一句话：</p>
<blockquote>
<p><strong>Props 决定了一个组件“好不好用”，而不是“能不能用”。</strong></p>
</blockquote>
<p>这篇文章，我们不讲 API 清单、不背概念，<br/>
而是围绕 <strong>Props 系统的 5 个核心能力</strong>，一次性讲透 React 组件化的底层逻辑：</p>
<ul>
<li>Props 传递</li>
<li>Props 解构</li>
<li>默认值（defaultProps / 默认参数）</li>
<li>类型校验（PropTypes）</li>
<li>children 插槽机制（React 的核武器）</li>
</ul>
<p>👉 看完你会明白：<br/>
<strong>React 真正厉害的不是 JSX，而是 Props 设计。</strong></p>
<hr/>
<h2 data-id="heading-0">一、Props 的本质：组件的“对外接口”</h2>
<p>先抛一个结论：</p>
<blockquote>
<p><strong>React 组件 ≈ 一个函数 + 一套 Props 接口</strong></p>
</blockquote>
<p>来看一个最简单的组件 👇</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Greeting</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello, {props.name}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>
}
</code></pre>
<p>使用时：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;Greeting <span class="hljs-attr">name</span>=<span class="hljs-string">"白兰地"</span> /&gt;
</code></pre>
<p>很多人到这里就停了，但问题是：</p>
<blockquote>
<p>❓<code>name</code> 到底是什么？</p>
</blockquote>
<p>答案是：</p>
<blockquote>
<p><strong>name 不是变量，是组件对外暴露的能力。</strong></p>
</blockquote>
<p>Props 本质上是：</p>
<ul>
<li>父组件 👉 子组件的<strong>输入</strong></li>
<li>组件作者 👉 使用者的<strong>约定</strong></li>
</ul>
<hr/>
<h2 data-id="heading-1">二、Props 解构：不是语法糖，而是“设计声明”</h2>
<p>对比两种写法 👇</p>
<h3 data-id="heading-2">❌ 不推荐</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Greeting</span>(<span class="hljs-params">props</span>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello, {props.name}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>
}
</code></pre>
<h3 data-id="heading-3">✅ 推荐</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Greeting</span>(<span class="hljs-params">{ name }</span>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello, {name}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>
}
</code></pre>
<p>为什么？</p>
<blockquote>
<p><strong>解构不是为了少写字，而是为了表达意图。</strong></p>
</blockquote>
<p>当你看到函数签名：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Greeting</span>(<span class="hljs-params">{ name, message, showIcon }</span>) {}
</code></pre>
<p>你立刻就知道：</p>
<ul>
<li>这个组件“需要什么”</li>
<li>组件的“输入边界”在哪里</li>
</ul>
<p>👉 <strong>好的组件，从函数签名就能读懂。</strong></p>
<hr/>
<h2 data-id="heading-4">三、Props 默认值：组件“健壮性”的第一步</h2>
<p>看这个组件 👇</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Greeting</span>(<span class="hljs-params">{ name, message }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Hello, {name}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{message}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p>如果使用者这么写：</p>
<pre><code class="hljs language-ini" lang="ini">&lt;Greeting <span class="hljs-attr">name</span>=<span class="hljs-string">"空瓶"</span> /&gt;
</code></pre>
<p>会发生什么？</p>
<blockquote>
<p><code>message === undefined</code></p>
</blockquote>
<p>这时候就轮到 <strong>默认值</strong> 出场了。</p>
<hr/>
<h3 data-id="heading-5">方式一：defaultProps（经典）</h3>
<pre><code class="hljs language-css" lang="css">Greeting<span class="hljs-selector-class">.defaultProps</span> = {
  message: <span class="hljs-string">'Welcome!'</span>
}
</code></pre>
<h3 data-id="heading-6">方式二：解构默认值（更推荐）</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Greeting</span>(<span class="hljs-params">{ name, message = <span class="hljs-string">'Welcome!'</span> }</span>) {}
</code></pre>
<blockquote>
<p>💡<strong>默认值不是兜底，而是组件设计的一部分。</strong></p>
</blockquote>
<p>它代表的是：</p>
<ul>
<li>“在你不配置的情况下”</li>
<li>“组件应该表现成什么样”</li>
</ul>
<hr/>
<h2 data-id="heading-7">四、Props 类型校验：组件的“自说明文档”</h2>
<p>来看一段很多人忽略、但非常值钱的代码 👇</p>
<pre><code class="hljs language-csharp" lang="csharp">import PropTypes <span class="hljs-keyword">from</span> <span class="hljs-string">'prop-types'</span>

Greeting.propTypes = {
  name: PropTypes.<span class="hljs-built_in">string</span>.isRequired,
  message: PropTypes.<span class="hljs-built_in">string</span>,
  showIcon: PropTypes.<span class="hljs-built_in">bool</span>,
}
</code></pre>
<p>很多人会说：</p>
<blockquote>
<p>“这不是可有可无吗？”</p>
</blockquote>
<p>但在真实项目里，它解决的是：</p>
<ul>
<li>❌ 参数传错没人发现</li>
<li>❌ 新人不知道组件怎么用</li>
<li>❌ 组件一多，全靠猜</li>
</ul>
<hr/>
<h3 data-id="heading-8">🔍 PropTypes 的真正价值</h3>
<blockquote>
<p><strong>不是防 bug，而是“降低理解成本”。</strong></p>
</blockquote>
<p>当你看到 propTypes，就等于看到一份说明书：</p>
<ul>
<li>哪些 props 必须传？</li>
<li>哪些是可选？</li>
<li>类型是什么？</li>
</ul>
<p>👉 <strong>一个没有 propTypes 的通用组件，本质上是“黑盒”。</strong></p>
<hr/>
<h2 data-id="heading-9">五、children：React Props 系统的“王炸”</h2>
<p>如果只能选一个 Props 机制，我会毫不犹豫选：</p>
<blockquote>
<p>🧨 <strong>children</strong></p>
</blockquote>
<p>来看一个 Card 组件 👇</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">Card</span> = (<span class="hljs-params">{ children, className = <span class="hljs-string">''</span> }</span>) =&gt; {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{</span>`<span class="hljs-attr">card</span> ${<span class="hljs-attr">className</span>}`}&gt;</span>
      {children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p>使用时：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Card</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"user-card"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>张三<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>高级前端工程师<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span>查看详情<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Card</span>&gt;</span>
</code></pre>
<p>这里发生了一件非常重要的事情：</p>
<blockquote>
<p><strong>组件不再关心“内容是什么”。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-10">🧠 children 的设计哲学</h3>
<blockquote>
<p><strong>组件负责“骨架”，使用者负责“填充”。</strong></p>
</blockquote>
<ul>
<li>Card 只负责：边框、阴影、间距</li>
<li>children 决定：展示什么内容</li>
</ul>
<p>这让组件具备了两个特性：</p>
<ul>
<li>✅ 高度复用</li>
<li>✅ 永不过期</li>
</ul>
<hr/>
<h2 data-id="heading-11">六、children + Props = 通用组件的终极形态</h2>
<p>再看一个更高级的例子：Modal 👇</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Modal</span> <span class="hljs-attr">HeaderComponent</span>=<span class="hljs-string">{MyHeader}</span> <span class="hljs-attr">FooterComponent</span>=<span class="hljs-string">{MyFooter}</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是一个弹窗<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>你可以在这里显示任何 JSX<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Modal</span>&gt;</span>
</code></pre>
<p>Modal 的实现：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Modal</span>(<span class="hljs-params">{ HeaderComponent, FooterComponent, children }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">HeaderComponent</span> /&gt;</span>
      {children}
      <span class="hljs-tag">&lt;<span class="hljs-name">FooterComponent</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<p>这背后是一个非常高级的思想：</p>
<blockquote>
<p><strong>Props 不只是数据，也可以是组件。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-12">七、请记住这 5 条 Props 设计铁律</h2>
<blockquote>
<p>🔥 如果你只能记住一段话，请记住这里</p>
</blockquote>
<ol>
<li>Props 是组件的“对外接口”，不是随便传的变量</li>
<li>解构 Props，是在声明组件的能力边界</li>
<li>默认值，决定组件的“基础体验”</li>
<li>类型校验，让组件自带说明书</li>
<li>children，让组件从“可用”变成“好用”</li>
</ol>
<hr/>
<h2 data-id="heading-13">八、写在最后</h2>
<p>当你真正理解 Props 之后，你会发现：</p>
<ul>
<li>React 不只是 UI 库</li>
<li>它在教你<strong>如何设计 API</strong></li>
<li>如何让别人“用得爽”</li>
</ul>
<blockquote>
<p><strong>Props 写得好不好，决定了一个人 React 水平的上限。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python环境安装]]></title>    <link>https://juejin.cn/post/7586493936677732392</link>    <guid>https://juejin.cn/post/7586493936677732392</guid>    <pubDate>2025-12-22T15:16:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586493936677732392" data-draft-id="7586493936677716008" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python环境安装"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-22T15:16:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用泥种荷花"/> <meta itemprop="url" content="https://juejin.cn/user/4212984289442030"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python环境安装
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4212984289442030/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用泥种荷花
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T15:16:34.000Z" title="Mon Dec 22 2025 15:16:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Anaconda：多版本环境管理</h2>
<h3 data-id="heading-1">一、下载渠道选择：优先镜像源，规避官方痛点</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anaconda.com%2Fdownload%2Fsuccess" target="_blank" title="https://www.anaconda.com/download/success" ref="nofollow noopener noreferrer">Anaconda 官方下载</a>存在两个问题：</p>
<ol>
<li>需登录账号才能下载；</li>
<li>服务器在境外，下载慢。</li>
</ol>
<p><strong>推荐使用<a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.tuna.tsinghua.edu.cn%2Fanaconda%2Farchive%2F" target="_blank" title="https://mirrors.tuna.tsinghua.edu.cn/anaconda/archive/" ref="nofollow noopener noreferrer">清华镜像源</a></strong>，无需登录，下载快。</p>
<h3 data-id="heading-2">二、版本选择关键：以发布日期为准，优先最新版</h3>
<p>注意：不要选网页最底部版本，需按「发布日期」选最新版。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b8abfa762ea74bdfb015f629cd3d45ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5rOl56eN6I236Iqx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767021393&amp;x-signature=mPosae3%2FVJ%2F9in9BvWROqqptRJE%3D" alt="" loading="lazy"/></p>
<p>核心：以发布日期判断版本，优先最新版，避免旧版兼容性错误、安装异常。</p>
<h3 data-id="heading-3">三、控制台使用前置：配置环境变量</h3>
<p>Anaconda 安装后需配置环境变量，否则无法直接使用 conda 命令。</p>
<h4 data-id="heading-4">3.1 环境变量配置步骤</h4>
<ol>
<li>进入：设置 → 系统 → 关于 → 高级系统设置 → 环境变量。</li>
<li>编辑 Path 变量，新增环境变量路径。</li>
<li>保存，重启控制台生效。</li>
</ol>
<h4 data-id="heading-5">3.2 默认环境变量路径（参考）</h4>
<p>默认路径（需根据实际安装目录调整）：</p>
<pre><code class="hljs language-text" lang="text">C:\ProgramData\anaconda3
C:\ProgramData\anaconda3\Scripts
C:\ProgramData\anaconda3\Library\bin
</code></pre>
<h4 data-id="heading-6">3.3 安装与配置验证</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检测是否正确安装conda</span>
conda --version 
</code></pre>
<blockquote>
<p>提示：若提示“conda 不是内部或外部命令”，检查路径是否正确或重启控制台。</p>
</blockquote>
<h2 data-id="heading-7">uv：新一代高性能Python包管理器</h2>
<p>uv 由 Astral 公司基于 Rust 开发，兼容 pip 使用习惯，核心优势为<strong>安装速度极快、内存占用低、内置虚拟环境管理</strong>，是 pip/venv 的高效替代方案。</p>
<h3 data-id="heading-8">一、安装uv：优先镜像源，规避下载超时</h3>
<p>直接从官方源安装易因网络问题超时，推荐使用国内镜像源，Windows/macOS/Linux 通用。</p>
<h4 data-id="heading-9">1.1 镜像源安装命令</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 清华PyPI镜像安装（推荐）</span>
pip3 install uv -i https://pypi.tuna.tsinghua.edu.cn/simple
</code></pre>
<h4 data-id="heading-10">1.2 安装验证</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看版本号，正常显示则安装成功</span>
uv --version
</code></pre>
<blockquote>
<p>提示：若Windows系统提示“uv 不是内部或外部命令”，需检查Python的Scripts目录（如C:\ProgramData\anaconda3\Scripts）是否加入环境变量，或重启终端。</p>
</blockquote>
<h3 data-id="heading-11">二、项目中使用uv</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 初始化项目</span>
uv init project_demo
</code></pre>
<p>配置项目uv镜像配置，配置<code>pyproject.toml</code>文件</p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[project]</span>
<span class="hljs-attr">name</span> = <span class="hljs-string">"project_demo"</span>
<span class="hljs-attr">version</span> = <span class="hljs-string">"0.1.0"</span>
<span class="hljs-attr">requires-python</span> = <span class="hljs-string">"&gt;=3.13"</span>

<span class="hljs-section">[tool.uv]</span>
<span class="hljs-attr">index-url</span> = <span class="hljs-string">"https://pypi.tuna.tsinghua.edu.cn/simple"</span>

</code></pre>
<h3 data-id="heading-12">三、常见问题解决</h3>
<h4 data-id="heading-13">3.1 安装时权限不足</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># ========== 方式1：仅当前用户安装（无需管理员权限） ==========</span>
<span class="hljs-comment"># 特点：安装到当前用户专属目录，不影响其他用户，无需管理员权限</span>
<span class="hljs-comment"># 注意：安装后需手动将上述路径添加到「用户环境变量Path」，否则无法直接使用uv命令</span>
pip3 install --user uv -i https://pypi.tuna.tsinghua.edu.cn/simple

<span class="hljs-comment"># ========== 方式2：全局安装（所有用户可用，推荐） ==========</span>
<span class="hljs-comment"># 特点：安装到Python全局目录，所有登录该电脑的用户均可使用，需管理员权限</span>
<span class="hljs-comment"># 前置操作：必须右键「命令提示符」→「以管理员身份运行」后执行此命令</span>
pip3 install uv -i https://pypi.tuna.tsinghua.edu.cn/simple
</code></pre>
<h2 data-id="heading-14">Ruff：代码格式化工具</h2></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Andrej Karpathy:2025年大模型发展总结]]></title>    <link>https://juejin.cn/post/7586491717873860627</link>    <guid>https://juejin.cn/post/7586491717873860627</guid>    <pubDate>2025-12-22T15:19:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586491717873860627" data-draft-id="7585502118459752467" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Andrej Karpathy:2025年大模型发展总结"/> <meta itemprop="keywords" content="GitHub,后端"/> <meta itemprop="datePublished" content="2025-12-22T15:19:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="赛博东哥CyberFD"/> <meta itemprop="url" content="https://juejin.cn/user/4323692639162087"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Andrej Karpathy:2025年大模型发展总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4323692639162087/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    赛博东哥CyberFD
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T15:19:40.000Z" title="Mon Dec 22 2025 15:19:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e4eeee8cdc7439f805c86d3ae6e6b8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LWb5Y2a5Lic5ZOlQ3liZXJGRA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767021580&amp;x-signature=QHf8ELuCJNP9jnX0rHzMZAgEZFw%3D" alt="image.png" loading="lazy"/></p>
<p>2025 年，无疑是大型语言模型（LLMs）领域的一年，技术进展迅速且充满变革。从训练方法的创新到全新应用层次的诞生，行业格局发生了深刻的变化。AI 领域第一 KOL <strong>Andrej Karpathy</strong> 发表自己针对 2025 年 AI 发展的回顾</p>
<p>我将从我个人角度，分析文章中提到的关键技术、趋势和实际应用，跟着一起回顾一下 2025 年的 AI 之路</p>
<h3 data-id="heading-0">1. RLVR：可验证奖励下的“推理时刻”</h3>
<p>在 2025 年初，大模型的标准生产线还是“预训练（Pretraining）+ 指令微调（SFT）+ 人类反馈强化学习（RLHF）”。这套流程虽然稳定，但潜力已近触顶。</p>
<p>今年，<strong>RLVR（基于可验证奖励的强化学习）</strong>  正式入场，成为大模型训练的新标配。通过在数学、代码等具备“客观真理标准”的环境中进行强化学习，模型自发演化出了类似人类的“推理”能力。它们学会了自我纠错、步骤拆解以及多路径尝试。</p>
<p><strong>核心变化：</strong></p>
<ul>
<li><strong>DeepSeek R1 与 OpenAI o1/o3</strong> 证明了这一点：推理不再是单纯的文本模仿，而是优化目标驱动下的策略发现。</li>
<li><strong>算力分配重构</strong>：过去算力主要堆在预训练阶段，现在大量算力向 RLVR 倾斜。业内发现，在可验证领域，RL 的投入产出比（Capability/$）极高。</li>
<li><strong>新 Scaling Law</strong>：我们拥有了一个控制模型能力的新旋钮——<strong>推理时算力（Test-time compute）</strong> 。通过增加模型的“思考时间”，性能可以实现非线性增长。</li>
</ul>
<h3 data-id="heading-1">2. “召唤幽灵”而非“驯化动物”：参差不齐的智能</h3>
<p>2025 年，我们终于看清了 AI 智能的底色：我们不是在“养育动物”，而是在“召唤幽灵”。</p>
<p>人类大脑的进化是为了在丛林中生存，而 LLM 的神经元是为了模拟人类文本、解决数学谜题、在 LM Arena 中博取人类的好感。这种完全不同的底层逻辑，导致了  <strong>“锯齿状智能”（Jagged Intelligence）</strong>  的出现：模型可能在量子物理领域是天才，但在处理简单的逻辑陷阱或防御越狱攻击时，却像个心智不全的小学生。</p>
<p><strong>关于 Benchmark 的幻灭：</strong>  由于 RLVR 的普及，刷榜（Benchmaxxing）变得空前简单。只要环境可验证，模型就能通过 RL 快速覆盖这些知识盲点。</p>
<p>现在的共识是：<strong>高分不代表 AGI</strong>。一些实验室正在通过制造大量合成数据来“修剪”这些智能锯齿，试图让模型在某些特定领域呈现出超越常人的统治力。</p>
<h3 data-id="heading-2">3. <strong>Cursor 与 LLM 应用的新层次</strong></h3>
<p>Cursor 的爆发揭示了一个残酷但清晰的现实：纯包装（Wrapper）没有未来，但<strong>深度垂直的编排层（Orchestration Layer）</strong> 大有可为。</p>
<p>现在的开发者不再只是谈论“接入 API”，而是讨论“做一个 X 行业的 Cursor”。这类应用的核心竞争力在于：</p>
<ul>
<li><strong>上下文工程（Context Engineering）</strong> ：如何更精准地喂入数据。</li>
<li><strong>复杂任务编排</strong>：将 LLM 调用串联成复杂的 DAG（有向无环图），在性能与成本间走钢丝。</li>
<li><strong>原生 GUI 与交互</strong>：不再仅仅是对话框，而是为特定场景定制的操作界面。</li>
<li><strong>自主权滑块（Autonomy Slider）</strong> ：让用户在“辅助执行”与“全自动代理”之间自由切换。</li>
</ul>
<p>从产品视角来看，大模型厂商负责交付“通才大学生”，而垂直 App 负责将这些大学生组织成专业的、可交付业务价值的“专业团队”。</p>
<h3 data-id="heading-3">4. Claude Code：回归 Localhost 的 Agent</h3>
<p>Claude Code（CC）的出现，给“什么才是真正的 Agent”打了个样。与 OpenAI 执着于云端容器（Cloud-based）的思路不同，CC 选择运行在用户的<strong>本地环境（Localhost）</strong> 。</p>
<p>这种“接地气”的做法解决了两个痛点：<strong>隐私与上下文</strong>。</p>
<p>Agent 可以直接读取你的私有代码库、调用本地编译器、感受你的开发环境。</p>
<p>它不再是浏览器里一个冰冷的网页，而是一个“住”在你电脑里的<strong>数字精灵</strong>，与你并肩作战。这标志着 AI 交互范式的转移：从“去中心化的云服务”回归到“个性化的本地助手”。</p>
<h3 data-id="heading-4">5. Vibe Coding：代码的“快消品化”</h3>
<p>2025 年，“Vibe Coding”（氛围感编程）从一个推特热梗变成了现实。 当 AI 的生成能力跨过临界点，编程的门槛崩塌了。你不需要精通 Rust 或 C++，只要逻辑清晰，通过自然语言就能指挥 AI 编织出复杂的程序。</p>
<p>这带来了软件生产逻辑的巨变：</p>
<ul>
<li><strong>代码不再“昂贵”</strong> ：过去写一个工具需要权衡 ROI，现在代码是廉价的、瞬时的、用完即弃的。</li>
<li><strong>人人都是开发者</strong>：这种技术扩散让普通人的获益远超专业人士，它打破了技能壁垒。</li>
<li><strong>软件地貌重塑</strong>：我们会看到大量“一次性软件”或“极度个性化软件”的诞生。</li>
</ul>
<h3 data-id="heading-5">6. Nano Banana 与 LLM 的图形界面</h3>
<p>2025 年，<strong>Google Gemini Nano Banana</strong> 的推出展示了 LLM 的另一个革命性进展。</p>
<p>在过去的计算机发展历程中，图形用户界面（GUI）为计算机操作提供了直观和高效的交互方式。同样，</p>
<p>LLM 的图形界面（GUI）也开始崭露头角，呈现出多种形式的互动方式，如图像生成、信息图表、幻灯片和视频等。这种图形化的交互模式，让用户能够更加自然地与 LLM 进行互动。</p>
<p><strong>Nano Banana</strong> 的出现只是这一趋势的开始，它通过图像生成、文本生成和知识整合的结合，预示了未来 LLM 图形界面可能的多样性。</p>
<p>最终，LLM 可能不再仅仅是通过文本输入来进行交互，而是通过更加直观和视觉化的方式与用户沟通。</p>
<h3 data-id="heading-6">总结</h3>
<p>2025 年对于 LLM 领域来说，是充满变革的一年。从 <strong>RLVR</strong> 的引入到 <strong>Vibe Coding</strong> 的普及，从<strong>本地 AI Agent</strong> 到 <strong>LLM 应用的层次化发展</strong>，技术的每一次突破都为未来的人工智能发展奠定了更深的基础。虽然 LLM 的能力已经取得了显著进展，但从技术的深度和实际应用的广度来看，LLM 领域仍然有着巨大的发展空间。在未来，我们不仅可以期待技术进步的加速，还将见证 AI 与我们的生活、工作方式更加紧密地融合。</p>
<h3 data-id="heading-7">最后，谈谈对 AI 产品落地的启发</h3>
<ol>
<li><strong>从“对话框”思维转向“Agent 编排”思维</strong>：不要再执着于如何调优 Prompt 让模型回答得更好，而要思考如何构建一套闭环的反馈环境（Verifiable Environment），利用 RL 的思路让模型在特定业务场景下进行“自我进化”，不一定是技术上闭环，也可以是业务上的闭环，只要能持续推动 Agent 应用迭代进步。</li>
<li><strong>抓住“本地化上下文”的机会</strong>：Claude Code 的成功提醒我们，真正的杀手级 Agent 可能不需要跑在云端，而是需要深度嵌入用户的工作流和本地数据。私域数据和本地环境的操作权，是对抗大模型厂商“收割”的护城河。</li>
<li><strong>重新定义软件的生命周期</strong>：如果代码已经变成“瞬时且免费”的资源，我们的重心应从“如何交付稳定的功能”转向“如何提供更精准的交互意图理解”。在 Vibe Coding 时代，<strong>审美、逻辑抽象能力和对用户痛点的洞察</strong>，比工程实现能力更重要。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0b370270b274e06b06f33b50df1e1aa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LWb5Y2a5Lic5ZOlQ3liZXJGRA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767021580&amp;x-signature=mwZac1G6k4%2Bay8%2FMRzTIEtT700I%3D" alt="Gemini_Generated_Image_1vsa881vsa881vsa.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀糟糕，我实现的k8s informer好像是依托答辩]]></title>    <link>https://juejin.cn/post/7586493936677748776</link>    <guid>https://juejin.cn/post/7586493936677748776</guid>    <pubDate>2025-12-22T15:26:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586493936677748776" data-draft-id="7586452779713757199" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀糟糕，我实现的k8s informer好像是依托答辩"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-22T15:26:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="有态度的下等马"/> <meta itemprop="url" content="https://juejin.cn/user/448256476727662"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀糟糕，我实现的k8s informer好像是依托答辩
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/448256476727662/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    有态度的下等马
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T15:26:00.000Z" title="Mon Dec 22 2025 15:26:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>💡 糟糕，k8s informer我好像拉一坨大的</p>
<p>近段时间在做云原生AI算力平台，之前提到使用k8s informer机制管控多渠道提交的训练任务。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef3cb59b054145cdb776d48bbb1bc73b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767022063&amp;x-signature=IaCER33kcRxWBnOwtOQTv66DDC8%3D" alt="" loading="lazy"/></p>
<p>上面第4点：</p>
<p>informer会监听通过cli和网页portal提交的job， 回显到portal平台，并在job发生状态变更时通知用户。</p>
<h2 data-id="heading-0">1. informer是实现声明式controller设计的核心</h2>
<p>k8s采用声明式设计， 以结果为导向， 实现这一关键能力的组件是k8s各种controller：</p>
<p>定义某对象的期望状态，实时监控并达成这个状态（调谐Reconcile） 就是控制器做的事情， No signal was sent. No webhook fired。</p>
<p>informer是k8s client-go库的一部分：</p>
<ul>
<li>① 监听资源</li>
<li>②并本地缓存</li>
<li>③通知上层应用发生了一些事件（job创建、job pending、job运行、job完成/失败）</li>
</ul>
<p>减少了apiserver的调用流量、优化性能、反应式自动化运维  （我当前的需求有点类似于反应式自动化运维😄）。</p>
<h2 data-id="heading-1">2. informer核心使用流程</h2>
<p>运行一个完整的informer： list ---&gt; watch ---&gt; cache---&gt; react。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/476a993690e64441820c0ba4081ff831~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767022063&amp;x-signature=ywCbAvZ%2FlkWNsTS5lpGUurHsMLI%3D" alt="" loading="lazy"/></p>
<p>① 从apiserver拉取指定的gvr资源, 形成首次资源快照</p>
<p>② 持续监听资源的变更事件进deltaFIFO队列，这里是通过HTTP/1.1 的<code>Chunked Transfer Encoding</code>（分块传输编码）来实现的</p>
<p>③ 通过上述①②两步得到资源的最新状态并缓存，注意，缓存的是资源对象，而不是资源变更事件， 另外是线程安全的存储。</p>
<p>④ 事件处理，应用在业务层面的动作，可以写日志，可以做controller的Reconcile动作。</p>
<p>开发者主要考量在<code>react（EventHandler）</code>阶段，其余能力client-go sdk会提供。</p>
<p>apiserver--&gt;reflector(拉取/监听)--&gt;DeltaFiFO(队列)--&gt; Process（处理）--&gt;Handler（用户代码）</p>
<h3 data-id="heading-2">2.1 Watch机制： chunked transfer encoding</h3>
<p>分块传输能力是http1.1 常见功能，不需要像websocket那样升级协议到帧格式，http连接中每个事件是独立的，直到连接关闭。</p>
<p>请求spiserver时查询参数加上<code>watch=true</code>, 会提示服务器本次是监听请求
响应核心特征是响应头包含<code>Transfer-Encoding: chunked</code></p>
<p>验证</p>
<pre><code class="hljs language-ini" lang="ini">终端1：kubectl proxy <span class="hljs-attr">--port</span>=<span class="hljs-number">8081</span>  ： 在主机上<span class="hljs-number">8081</span>端口代理aiserver服务

终端2： curl "http://localhost:8081/api/v1/namespaces/team-a/pods?<span class="hljs-attr">watch</span>=<span class="hljs-literal">true</span><span class="hljs-string">"  --verbose
</span></code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0446b2f795744d23bc2aae0bd08b379e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767022063&amp;x-signature=ZFqBrnPN3X7na%2Fros5xmpWAtf7I%3D" alt="" loading="lazy"/></p>
<p>在client-go sdk中会为informer watch建立稳定的长连接（断线重连、重试等）</p>
<h2 data-id="heading-3">3. 一个常规的informer实践</h2>
<p>利用kubeconfig创建informer（绑定gvr）， 启动informer（带终止信道）</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
	<span class="hljs-string">"fmt"</span>
	<span class="hljs-string">"time"</span>

	v1 <span class="hljs-string">"k8s.io/api/core/v1"</span>
	<span class="hljs-string">"k8s.io/apimachinery/pkg/fields"</span>
	<span class="hljs-string">"k8s.io/client-go/kubernetes"</span>
	<span class="hljs-string">"k8s.io/client-go/tools/cache"</span>
	<span class="hljs-string">"k8s.io/client-go/tools/clientcmd"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	config, _ := clientcmd.BuildConfigFromFlags(<span class="hljs-string">""</span>, <span class="hljs-string">"/home/user/.kube/config"</span>)
	clientset, _ := kubernetes.NewForConfig(config)

	podInformer := cache.NewSharedIndexInformer(
		cache.NewListWatchFromClient(
			clientset.CoreV1().RESTClient(),
			<span class="hljs-string">"pods"</span>,
			v1.NamespaceAll,
			fields.Everything(),
		),
		&amp;v1.Pod{},
		time.Minute*<span class="hljs-number">10</span>, <span class="hljs-comment">// resync 周期</span>
		cache.Indexers{ <span class="hljs-comment">// cache上的快速过滤器</span>
			<span class="hljs-string">"byNode"</span>: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(obj <span class="hljs-keyword">interface</span>{})</span></span> ([]<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) {
				pod := obj.(*v1.Pod)
				<span class="hljs-keyword">return</span> []<span class="hljs-type">string</span>{pod.Spec.NodeName}, <span class="hljs-literal">nil</span>
			}},
	)

	podInformer.AddEventHandler(cache.ResourceEventHandlerFuncs{
		DeleteFunc: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(obj <span class="hljs-keyword">interface</span>{})</span></span> {
			pod := obj.(*v1.Pod)
			fmt.Printf(<span class="hljs-string">"[DELETED] Pod: %s/%s\n"</span>, pod.Namespace, pod.Name)
		},
	})

	<span class="hljs-comment">// 启动 informer (必须在独立goroutine中，因为Run方法是同步方法)</span>
	stopCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{})
	<span class="hljs-keyword">defer</span> <span class="hljs-built_in">close</span>(stopCh)
	<span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> {
		fmt.Println(<span class="hljs-string">"Starting PodInformer..."</span>)
		podInformer.Run(stopCh) <span class="hljs-comment">// 同步方法，会阻塞直到 stopCh 关闭</span>
		fmt.Println(<span class="hljs-string">"PodInformer stopped"</span>)
	}()

	<span class="hljs-comment">//  等待缓存同步就绪</span>
	<span class="hljs-keyword">if</span> !cache.WaitForCacheSync(stopCh, podInformer.HasSynced) {
		<span class="hljs-built_in">panic</span>(<span class="hljs-string">"failed to wait for cache sync"</span>)
	}
	&lt;-stopCh
}
</code></pre>
<ul>
<li>
<p>informer有<code>resync</code>机制： 周期性重放数据，目的是为业务提供补偿机会，上面设置了10分钟重放周期, =0或者不设置则不重放。</p>
</li>
<li>
<p>使用<code>cache.NewListWatchFromClient</code>设置了informer的<code>local cache</code>， 开发者可以直接把<code>local cache</code>当成监听对象的集合,client-go会确保local cache正确反映当前的资源对象。</p>
</li>
<li>
<p><code>informer.Run(stopCh)</code> 是一个同步的函数，持续执行list-watch-cache-react这个引擎， 在应用层面需要以子goroutine形式，client-go另有informer工厂，informerFactory.Start(stopCh) 内部也是启协程，这里也要认识到信道stopCh在golang中的通信作用。</p>
</li>
</ul>
<blockquote>
<p>为加快这个informer cache访问速度，还可以给这个cache加上索引器<code>Indexers</code>, 后面可直接使用索引器访问cache。</p>
</blockquote>
<h3 data-id="heading-4">3.1 拉了一坨大的</h3>
<p>如果把业务需求都做在EventHandler里面，长此以往会拉一坨大的。</p>
<p>首先这是一个<strong>事件队列消费模型</strong>，Add/Update/Delete变更事件是从一个叫<code>deltaFIFO</code>队列中pop出来的， 既然是队列模型，那么队列消费的高可用、高性能、可扩展问题就避免不了：</p>
<ul>
<li>
<p>事件需要同步挨个处理，否则控制器侧拿到的最终资源状态可能不对，那么这种挨个处理也就谈不上高性能。</p>
</li>
<li>
<p>但是应用又是多实例部署， 多个informer都走同样的list-watch-cache-react流程， 客观上围绕informer deltaFIIO又形成多生产者=&gt;多消费者模型，这种局面EventHandler就要考量幂等和资源一致性问题。</p>
</li>
<li>
<p>队列常规的高可用考量：① 消费者宕机时事件丢失  ② 消费失败如何重试（重试又有幂等性问题）</p>
</li>
<li>
<p>informer有<code>resync</code>机制：会对<code>local cache</code>中的资源构造<code>onUpdate事件</code>，也会走EventHandler, 所以EventHandler做的很重，会很麻烦。</p>
</li>
</ul>
<p>如果业务逻辑很重或者强依赖重试，推荐上<code>[workQueue](https://pkg.go.dev/k8s.io/client-go@v0.35.0/util/workqueue "workQueue")</code>, 支持以下功能：</p>
<ul>
<li>
<p>公平：按添加顺序处理元素</p>
</li>
<li>
<p>元素去重：单个item不会被并发消费多次；如果一个item在消费前被多次添加，它只会被消费一次</p>
</li>
<li>
<p>多个消费者和生产者， 支持消费时重排</p>
</li>
<li>
<p>关闭通知</p>
</li>
</ul>
<h2 data-id="heading-5">4. <a href="https://link.juejin.cn?target=https%3A%2F%2Fmedium.com%2F%40dhruvbhl%2Finformers-listers-workqueues-the-brain-behind-your-controller-f5b0967026de" title="https://medium.com/@dhruvbhl/informers-listers-workqueues-the-brain-behind-your-controller-f5b0967026de" target="_blank" ref="nofollow noopener noreferrer">controller调谐设计</a></h2>
<p>学习controller的设计：除了informer，还提供了额外的工具，帮助开发者高效感知最新的资源，执行调谐工作。</p>





















<table><thead><tr><th>package</th><th>role</th></tr></thead><tbody><tr><td>informer</td><td>Eyes(watch and cache them)</td></tr><tr><td>lister</td><td>Memory(read from lcoal cache)</td></tr><tr><td>workQueue</td><td>task list (reconcile work)</td></tr></tbody></table>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c74090dc69b149aa8a9bde5fb46954d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767022063&amp;x-signature=Advz76wzZDH8D7%2BUx6mo7FqEYio%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> PodController <span class="hljs-keyword">struct</span> {
	clientset kubernetes.Interface
	queue     workqueue.TypedRateLimitingInterface[<span class="hljs-type">string</span>]
	informer  cache.SharedIndexInformer
	indexer   cache.Indexer
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewPodController</span><span class="hljs-params">(clientset kubernetes.Interface)</span></span> *PodController {
	<span class="hljs-comment">// 创建 Pod informer</span>
	podInformer := cache.NewSharedIndexInformer(
		cache.NewListWatchFromClient(
			clientset.CoreV1().RESTClient(),
			<span class="hljs-string">"pods"</span>,
			v1.NamespaceAll,
			fields.Everything(),
		),
		&amp;v1.Pod{},
		time.Minute*<span class="hljs-number">10</span>, <span class="hljs-comment">// resync 周期</span>
		cache.Indexers{
			<span class="hljs-string">"byNode"</span>: <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(obj <span class="hljs-keyword">interface</span>{})</span></span> ([]<span class="hljs-type">string</span>, <span class="hljs-type">error</span>) {
				pod := obj.(*v1.Pod)
				<span class="hljs-keyword">return</span> []<span class="hljs-type">string</span>{pod.Spec.NodeName}, <span class="hljs-literal">nil</span>
			}},
	)

	<span class="hljs-comment">// 创建控制器</span>
	controller := &amp;PodController{
		clientset: clientset,
		queue: workqueue.NewTypedRateLimitingQueue(
			workqueue.DefaultTypedControllerRateLimiter[<span class="hljs-type">string</span>]( <span class="hljs-string">"string"</span>),
		),
		informer: podInformer,
		indexer:  podInformer.GetIndexer(),
	}

	<span class="hljs-comment">// 注册事件处理器</span>
	podInformer.AddEventHandler(cache.ResourceEventHandlerFuncs{
		AddFunc:    controller.handleAdd,
		UpdateFunc: controller.handleUpdate,
		DeleteFunc: controller.handleDelete,
	})

	<span class="hljs-keyword">return</span> controller
}
</code></pre>
<h3 data-id="heading-6">①  Informers: The Eyes on the Cluster</h3>
<p>informer是一个管道，当发生变化时，该informer管道可确保：</p>
<ul>
<li>本地缓存local cache已更新</li>
<li>任何已注册的事件处理程序(add/update/delete)都会收到通知</li>
</ul>
<p>informer不会直接调用控制器的Reconcile方法，事件处理程序的唯一工作是将<code>key (namespace/name)</code>入队（workQueue）</p>
<blockquote>
<p>为什么使用key？<br/>
资源对象变化很快→键更稳定→更适合数据去重。</p>
</blockquote>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *PodController)</span></span> handleAdd(obj <span class="hljs-keyword">interface</span>{}) {
	key, err := cache.MetaNamespaceKeyFunc(obj)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		klog.Errorf(<span class="hljs-string">"Couldn't get key for object %+v: %v"</span>, obj, err)
		<span class="hljs-keyword">return</span>
	}
	c.queue.Add(key)
}
</code></pre>
<h3 data-id="heading-7">② key一旦入队，就由workQueue接管</h3>
<ul>
<li>去重</li>
<li>重试、出队消费失败重排： 队列行为增强系统可用性</li>
<li>限速： 弹性设计，增强可用性和效率</li>
</ul>
<h3 data-id="heading-8">③ lister：其实就是Indexers索引器</h3>
<p>使用lister从local cache 读取最新的资源状态（不需要从api server读取），</p>
<p>最终执行控制器的<code>Reconcile</code>逻辑。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3fc780e25aa74e5ba84a0ced3fec39df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pyJ5oCB5bqm55qE5LiL562J6ams:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767022063&amp;x-signature=nTm3E%2BgwCeEeeCqnTnpAWdBz568%3D" alt="" loading="lazy"/></p>
<p>通过<code>workQueue</code>将架构从基于资源事件的队列转换为基于资源的队列 。</p>
<p>注意：这个时候的workQueue有事件压缩的效果： 在被消费之前，如果该资源有多个变更事件，只会保留首次入队（更新时间戳）。</p>
<p>Controller不关心对象如何到达当前状态，只关心当前状态是否与期望状态一致，并采取行动使其一致。</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *PodController)</span></span> Run(workers <span class="hljs-type">int</span>, stopCh &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{}) {
	<span class="hljs-keyword">defer</span> c.queue.ShutDown()

	klog.Info(<span class="hljs-string">"Starting Pod controller"</span>)

	<span class="hljs-keyword">go</span> c.informer.Run(stopCh)

	<span class="hljs-keyword">if</span> !cache.WaitForCacheSync(stopCh, c.informer.HasSynced) {
		klog.Error(<span class="hljs-string">"Timed out waiting for caches to sync"</span>)
		<span class="hljs-keyword">return</span>
	}

	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; workers; i++ {
		<span class="hljs-keyword">go</span> wait.Until(c.runWorker, time.Second, stopCh)
	}

	&lt;-stopCh
	klog.Info(<span class="hljs-string">"Stopping Pod controller"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *PodController)</span></span> runWorker() {
	<span class="hljs-keyword">for</span> c.processNextWorkItem() {
	}
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *PodController)</span></span> processNextWorkItem() <span class="hljs-type">bool</span> {
	key, quit := c.queue.Get()
	<span class="hljs-keyword">if</span> quit {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
	}

	<span class="hljs-keyword">defer</span> c.queue.Done(key)

	err := c.syncPod(key)
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		klog.Errorf(<span class="hljs-string">"Error syncing pod %s: %v"</span>, key, err)
		c.queue.AddRateLimited(key)
		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
	}

	c.queue.Forget(key)
	<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	<span class="hljs-comment">// 创建 clientset</span>
	<span class="hljs-comment">// config, _ := rest.InClusterConfig()</span>

	homepath := homedir.HomeDir()
	kubeconfig := filepath.Join(homepath, <span class="hljs-string">".kube"</span>, <span class="hljs-string">"config"</span>)
	config, err := clientcmd.BuildConfigFromFlags(<span class="hljs-string">""</span>, kubeconfig) <span class="hljs-comment">// 集群外认证访问 apiserver</span>
	<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
		klog.Errorf(<span class="hljs-string">"Error building kubeconfig: %v"</span>, err)
	}
	clientset, _ := kubernetes.NewForConfig(config)

	controller := NewPodController(clientset)
	stopCh := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>{})
	controller.Run(<span class="hljs-number">3</span>, stopCh)
}
</code></pre>
<hr/>
<h3 data-id="heading-9">4.1  屎上雕花</h3>
<p>上文产生的"一坨大的"是一个重度的事件处理行为：sync到mysql并做出通知。</p>
<p>咱就缺一个队列，可以使用workQueue， 但是本次需求要跟踪每次状态变更，于是要规避workQueue的事件压缩行为。</p>
<p>于是本次将(原资源key+ 资源版本+ 资源状态)整体作为入队元素。</p>
<pre><code class="hljs language-css" lang="css"> item := QueueItem{
        Key:     fmt.<span class="hljs-built_in">Sprintf</span>(<span class="hljs-string">"%s/%s"</span>, pod.Namespace, pod.Name),
        Version: pod.ResourceVersion,
        Status ： pod.Status，
    }
</code></pre>
<p>利用队列削峰填谷，满足了业务的需求和高可用、可扩展要求。</p>
<p>注意出队消费时仍要保证幂等操作， 可采用（资源key+资源version) 作为幂等键实现幂等的判定。</p>
<p>这就是某企业项目屎上雕花的经历， 老鸟轻喷。</p>
<p>🤖 🚀 👑 🛠️ 💡 🌟 🤖 ☕ 🔗 📄 📖 🌏 💼 🗣️</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从微信公众号&小程序的SDK剖析JSBridge]]></title>    <link>https://juejin.cn/post/7586505172815626291</link>    <guid>https://juejin.cn/post/7586505172815626291</guid>    <pubDate>2025-12-22T15:31:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586505172815626291" data-draft-id="7586550947703291914" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从微信公众号&amp;小程序的SDK剖析JSBridge"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-22T15:31:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="若梦plus"/> <meta itemprop="url" content="https://juejin.cn/user/2875978149798093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从微信公众号&amp;小程序的SDK剖析JSBridge
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978149798093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    若梦plus
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T15:31:55.000Z" title="Mon Dec 22 2025 15:31:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从微信公众号&amp;小程序的SDK剖析JSBridge</h2>
<h3 data-id="heading-1">引言</h3>
<p>在移动互联网时代,Hybrid应用已成为主流开发模式之一。JSBridge作为连接JavaScript与Native的核心桥梁,让Web页面能够调用原生能力,实现了跨平台开发的完美平衡。微信作为国内最大的超级应用,其公众号JSSDK和小程序架构为我们提供了绝佳的JSBridge实践案例。本文将深入剖析这两套SDK的实现原理,帮助读者理解JSBridge的本质与设计思想。</p>
<h3 data-id="heading-2">一、JSBridge核心概念</h3>
<h4 data-id="heading-3">1.1 什么是JSBridge</h4>
<p>JSBridge是JavaScript与Native之间的通信桥梁,它建立了双向消息通道,使得:</p>
<ul>
<li><strong>JavaScript调用Native</strong>: Web页面可以调用原生能力(相机、地理位置、支付等)</li>
<li><strong>Native调用JavaScript</strong>: 原生代码可以向Web页面传递数据或触发事件</li>
</ul>
<h4 data-id="heading-4">1.2 JSBridge通信架构</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph WebView层
        A[JavaScript代码]
    end

    subgraph JSBridge层
        B[消息队列]
        C[协议解析器]
    end

    subgraph Native层
        D[原生API Handler]
        E[系统能力]
    end

    A --&gt;|发起调用| B
    B --&gt;|解析协议| C
    C --&gt;|转发请求| D
    D --&gt;|调用能力| E
    E --&gt;|返回结果| D
    D --&gt;|回调| C
    C --&gt;|执行callback| A

    style A fill:#e1f5ff
    style E fill:#fff4e1
    style C fill:#f0f0f0
</code></pre>
<h4 data-id="heading-5">1.3 通信方式对比</h4>
<p>JSBridge主要有三种实现方式:</p>





























<table><thead><tr><th>方式</th><th>原理</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>URL Schema拦截</td><td>通过iframe.src触发特定协议</td><td>兼容性好,iOS/Android通用</td><td>有URL长度限制,不支持同步返回</td></tr><tr><td>注入API</td><td>Native向WebView注入全局对象</td><td>调用简单直接</td><td>Android 4.2以下有安全风险</td></tr><tr><td>MessageHandler</td><td>WKWebView的postMessage机制</td><td>性能好,安全性高</td><td>仅iOS可用</td></tr></tbody></table>
<h3 data-id="heading-6">二、微信公众号JSSDK实现原理</h3>
<h4 data-id="heading-7">2.1 JSSDK架构设计</h4>
<p>微信公众号的JSSDK基于WeixinJSBridge封装,提供了更安全和易用的接口。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant H5 as H5页面
    participant SDK as wx-JSSDK
    participant Bridge as WeixinJSBridge
    participant Native as 微信客户端

    H5-&gt;&gt;SDK: 调用wx.config()
    SDK-&gt;&gt;Native: 请求签名验证
    Native--&gt;&gt;SDK: 返回验证结果

    H5-&gt;&gt;SDK: 调用wx.chooseImage()
    SDK-&gt;&gt;Bridge: invoke('chooseImage', params)
    Bridge-&gt;&gt;Native: 转发调用请求
    Native-&gt;&gt;Native: 打开相册选择
    Native--&gt;&gt;Bridge: 返回图片数据
    Bridge--&gt;&gt;SDK: 触发回调
    SDK--&gt;&gt;H5: success(res)
</code></pre>
<h4 data-id="heading-8">2.2 JSSDK初始化流程</h4>
<p><strong>JSSDK的初始化需要完成配置验证和ready状态准备:</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 步骤1: 引入JSSDK</span>
&lt;script src=<span class="hljs-string">"https://res.wx.qq.com/open/js/jweixin-1.6.0.js"</span>&gt;&lt;/script&gt;

<span class="hljs-comment">// 步骤2: 配置权限验证</span>
wx.<span class="hljs-title function_">config</span>({
  <span class="hljs-attr">debug</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">appId</span>: <span class="hljs-string">'your-app-id'</span>,
  <span class="hljs-attr">timestamp</span>: <span class="hljs-number">1234567890</span>,
  <span class="hljs-attr">nonceStr</span>: <span class="hljs-string">'random-string'</span>,
  <span class="hljs-attr">signature</span>: <span class="hljs-string">'sha1-signature'</span>,
  <span class="hljs-attr">jsApiList</span>: [<span class="hljs-string">'chooseImage'</span>, <span class="hljs-string">'uploadImage'</span>, <span class="hljs-string">'getLocation'</span>]
});

<span class="hljs-comment">// 步骤3: 监听ready事件</span>
wx.<span class="hljs-title function_">ready</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 配置成功后才能调用API</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'JSSDK初始化完成'</span>);
});

wx.<span class="hljs-title function_">error</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">res</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'配置失败:'</span>, res);
});
</code></pre>
<p><strong>配置验证流程说明:</strong></p>
<ol>
<li><strong>获取签名</strong>: 后端通过jsapi_ticket和当前URL生成SHA1签名</li>
<li><strong>前端配置</strong>: 将签名等参数传入wx.config()</li>
<li><strong>客户端验证</strong>: 微信客户端校验签名的合法性</li>
<li><strong>授权完成</strong>: 验证通过后触发ready事件</li>
</ol>
<h4 data-id="heading-9">2.3 WeixinJSBridge底层机制</h4>
<p><strong>WeixinJSBridge是微信内部提供的原生接口,不对外公开但可以直接使用:</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 检测WeixinJSBridge是否ready</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">onBridgeReady</span>(<span class="hljs-params"/>) {
  <span class="hljs-title class_">WeixinJSBridge</span>.<span class="hljs-title function_">invoke</span>(
    <span class="hljs-string">'getBrandWCPayRequest'</span>,
    {
      <span class="hljs-attr">appId</span>: <span class="hljs-string">'wx123456'</span>,
      <span class="hljs-attr">timeStamp</span>: <span class="hljs-string">'1234567890'</span>,
      <span class="hljs-attr">nonceStr</span>: <span class="hljs-string">'randomstring'</span>,
      <span class="hljs-attr">package</span>: <span class="hljs-string">'prepay_id=xxx'</span>,
      <span class="hljs-attr">signType</span>: <span class="hljs-string">'MD5'</span>,
      <span class="hljs-attr">paySign</span>: <span class="hljs-string">'signature'</span>
    },
    <span class="hljs-keyword">function</span>(<span class="hljs-params">res</span>) {
      <span class="hljs-keyword">if</span> (res.<span class="hljs-property">err_msg</span> === <span class="hljs-string">'get_brand_wcpay_request:ok'</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'支付成功'</span>);
      }
    }
  );
}

<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">WeixinJSBridge</span> === <span class="hljs-string">'undefined'</span>) {
  <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'WeixinJSBridgeReady'</span>, onBridgeReady, <span class="hljs-literal">false</span>);
} <span class="hljs-keyword">else</span> {
  <span class="hljs-title function_">onBridgeReady</span>();
}
</code></pre>
<p><strong>WeixinJSBridge与wx JSSDK的关系:</strong></p>
<ul>
<li><code>WeixinJSBridge</code>: 底层原生接口,直接由微信客户端注入,无需引入外部JS</li>
<li><code>wx JSSDK</code>: 基于WeixinJSBridge的高级封装,提供统一的API规范和安全验证</li>
</ul>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[H5页面] --&gt;|引入jweixin.js| B[wx JSSDK]
    B --&gt;|封装调用| C[WeixinJSBridge]
    C --&gt;|Native注入| D[微信客户端]
    D --&gt;|系统能力| E[&amp;#34;相机、支付、定位等&amp;#34;]

    style B fill:#07c160
    style C fill:#ff9800
    style D fill:#576b95
</code></pre>
<h4 data-id="heading-10">2.4 典型API调用示例</h4>
<p><strong>以选择图片为例,展示完整的调用链路:</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 封装图片选择功能</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">selectImages</span>(<span class="hljs-params">count = <span class="hljs-number">9</span></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    wx.<span class="hljs-title function_">chooseImage</span>({
      <span class="hljs-attr">count</span>: count,          <span class="hljs-comment">// 最多选择数量</span>
      <span class="hljs-attr">sizeType</span>: [<span class="hljs-string">'original'</span>, <span class="hljs-string">'compressed'</span>],
      <span class="hljs-attr">sourceType</span>: [<span class="hljs-string">'album'</span>, <span class="hljs-string">'camera'</span>],
      <span class="hljs-attr">success</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">res</span>) {
        <span class="hljs-keyword">const</span> localIds = res.<span class="hljs-property">localIds</span>; <span class="hljs-comment">// 返回本地图片ID列表</span>
        <span class="hljs-title function_">resolve</span>(localIds);
      },
      <span class="hljs-attr">fail</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">err</span>) {
        <span class="hljs-title function_">reject</span>(err);
      }
    });
  });
}

<span class="hljs-comment">// 使用示例</span>
wx.<span class="hljs-title function_">ready</span>(<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> imageIds = <span class="hljs-keyword">await</span> <span class="hljs-title function_">selectImages</span>(<span class="hljs-number">5</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'已选择图片:'</span>, imageIds);

    <span class="hljs-comment">// 继续上传图片</span>
    <span class="hljs-title function_">uploadImages</span>(imageIds);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'选择失败:'</span>, error);
  }
});

<span class="hljs-keyword">function</span> <span class="hljs-title function_">uploadImages</span>(<span class="hljs-params">localIds</span>) {
  localIds.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">localId</span> =&gt;</span> {
    wx.<span class="hljs-title function_">uploadImage</span>({
      <span class="hljs-attr">localId</span>: localId,
      <span class="hljs-attr">isShowProgressTips</span>: <span class="hljs-number">1</span>,
      <span class="hljs-attr">success</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">res</span>) {
        <span class="hljs-keyword">const</span> serverId = res.<span class="hljs-property">serverId</span>; <span class="hljs-comment">// 服务器端图片ID</span>
        <span class="hljs-comment">// 将serverId发送给后端保存</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'上传成功:'</span>, serverId);
      }
    });
  });
}
</code></pre>
<h3 data-id="heading-11">三、微信小程序双线程架构</h3>
<h4 data-id="heading-12">3.1 小程序架构设计</h4>
<p><strong>微信小程序采用双线程模型,将渲染层与逻辑层完全隔离:</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph 渲染层[渲染层 View - WebView]
        A[WXML模板]
        B[WXSS样式]
        C[组件系统]
    end

    subgraph 逻辑层[逻辑层 AppService - JSCore]
        D[JavaScript代码]
        E[小程序API - wx对象]
        F[数据管理]
    end

    subgraph 系统层[Native - 微信客户端]
        G[JSBridge]
        H[网络请求]
        I[文件系统]
        J[设备能力]
    end

    A -.-&gt;|数据绑定| F
    C -.-&gt;|事件触发| D
    D --&gt;|setData| G
    G --&gt;|更新视图| A
    E --&gt;|调用能力| G
    G --&gt;|转发请求| H
    G --&gt;|转发请求| I
    G --&gt;|转发请求| J

    style 渲染层 fill:#e3f2fd
    style 逻辑层 fill:#f3e5f5
    style 系统层 fill:#fff3e0
</code></pre>
<p><strong>架构设计的核心优势:</strong></p>
<ol>
<li><strong>安全隔离</strong>: 逻辑层无法直接操作DOM,防止XSS攻击</li>
<li><strong>多WebView支持</strong>: 每个页面独立WebView,支持多页面并存</li>
<li><strong>性能优化</strong>: 逻辑层使用JSCore,不加载DOM/BOM,执行更快</li>
</ol>
<h4 data-id="heading-13">3.2 小程序JSBridge通信机制</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Logic as 逻辑层&lt;br/&gt;(JSCore)
    participant Bridge as JSBridge
    participant Native as Native层
    participant View as 渲染层&lt;br/&gt;(WebView)

    Note over Logic,View: 场景1: 数据更新
    Logic-&gt;&gt;Bridge: setData({key: value})
    Bridge-&gt;&gt;Native: 序列化数据
    Native-&gt;&gt;View: 传递Virtual DOM diff
    View-&gt;&gt;View: 更新页面渲染

    Note over Logic,View: 场景2: 事件响应
    View-&gt;&gt;Bridge: bindtap事件触发
    Bridge-&gt;&gt;Native: 序列化事件对象
    Native-&gt;&gt;Logic: 调用事件处理函数
    Logic-&gt;&gt;Logic: 执行业务逻辑

    Note over Logic,View: 场景3: API调用
    Logic-&gt;&gt;Bridge: wx.request(options)
    Bridge-&gt;&gt;Native: 转发网络请求
    Native-&gt;&gt;Native: 发起HTTP请求
    Native--&gt;&gt;Bridge: 返回响应数据
    Bridge--&gt;&gt;Logic: 触发success回调
</code></pre>
<h4 data-id="heading-14">3.3 数据通信实现</h4>
<p><strong>setData是小程序中最核心的通信API,用于逻辑层向渲染层传递数据:</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Page</span>({
  <span class="hljs-attr">data</span>: {
    <span class="hljs-attr">userInfo</span>: {},
    <span class="hljs-attr">items</span>: []
  },

  <span class="hljs-attr">onLoad</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 通过setData更新数据,触发视图更新</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({
      <span class="hljs-attr">userInfo</span>: {
        <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
        <span class="hljs-attr">avatar</span>: <span class="hljs-string">'https://example.com/avatar.jpg'</span>
      },
      <span class="hljs-attr">items</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]
    });
  },

  <span class="hljs-comment">// 优化建议: 只更新变化的字段</span>
  <span class="hljs-attr">updateUserName</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">newName</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({
      <span class="hljs-string">'userInfo.name'</span>: newName  <span class="hljs-comment">// 使用路径语法,减少数据传输</span>
    });
  },

  <span class="hljs-comment">// 避免频繁setData</span>
  <span class="hljs-attr">handleScroll</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
    <span class="hljs-comment">// 错误示范: 每次滚动都setData</span>
    <span class="hljs-comment">// this.setData({ scrollTop: e.detail.scrollTop });</span>

    <span class="hljs-comment">// 正确做法: 节流处理</span>
    <span class="hljs-built_in">clearTimeout</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollTimer</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">scrollTimer</span> = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">scrollTop</span>: e.<span class="hljs-property">detail</span>.<span class="hljs-property">scrollTop</span> });
    }, <span class="hljs-number">100</span>);
  }
});
</code></pre>
<p><strong>setData底层流程:</strong></p>
<ol>
<li><strong>序列化数据</strong>: 将JS对象序列化为JSON字符串</li>
<li><strong>通过JSBridge发送</strong>: Native层接收数据</li>
<li><strong>传递到渲染层</strong>: Native将数据转发到WebView</li>
<li><strong>Virtual DOM Diff</strong>: 计算差异并更新视图</li>
</ol>
<h4 data-id="heading-15">3.4 小程序API调用机制</h4>
<p><strong>小程序的wx对象是Native注入的JSBridge接口:</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 网络请求示例</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUserData</span>(<span class="hljs-params">userId</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    wx.<span class="hljs-title function_">request</span>({
      <span class="hljs-attr">url</span>: <span class="hljs-string">`https://api.example.com/user/<span class="hljs-subst">${userId}</span>`</span>,
      <span class="hljs-attr">method</span>: <span class="hljs-string">'GET'</span>,
      <span class="hljs-attr">header</span>: {
        <span class="hljs-string">'content-type'</span>: <span class="hljs-string">'application/json'</span>
      },
      <span class="hljs-title function_">success</span>(<span class="hljs-params">res</span>) {
        <span class="hljs-keyword">if</span> (res.<span class="hljs-property">statusCode</span> === <span class="hljs-number">200</span>) {
          <span class="hljs-title function_">resolve</span>(res.<span class="hljs-property">data</span>);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`请求失败: <span class="hljs-subst">${res.statusCode}</span>`</span>));
        }
      },
      <span class="hljs-title function_">fail</span>(<span class="hljs-params">err</span>) {
        <span class="hljs-title function_">reject</span>(err);
      }
    });
  });
}

<span class="hljs-comment">// 使用async/await优化</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadUserInfo</span>(<span class="hljs-params"/>) {
  wx.<span class="hljs-title function_">showLoading</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">'加载中...'</span> });

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> userData = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchUserData</span>(<span class="hljs-number">123</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({ <span class="hljs-attr">userInfo</span>: userData });
  } <span class="hljs-keyword">catch</span> (error) {
    wx.<span class="hljs-title function_">showToast</span>({
      <span class="hljs-attr">title</span>: <span class="hljs-string">'加载失败'</span>,
      <span class="hljs-attr">icon</span>: <span class="hljs-string">'none'</span>
    });
  } <span class="hljs-keyword">finally</span> {
    wx.<span class="hljs-title function_">hideLoading</span>();
  }
}
</code></pre>
<p><strong>API调用流程图:</strong></p>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart TD
    A[小程序调用 wx.request] --&gt; B{JSBridge检查}
    B --&gt;|参数校验| C[序列化请求参数]
    C --&gt; D[Native接管网络请求]
    D --&gt; E[系统发起HTTP请求]
    E --&gt; F{请求结果}
    F --&gt;|成功| G[回调success函数]
    F --&gt;|失败| H[回调fail函数]
    G --&gt; I[返回数据到逻辑层]
    H --&gt; I
    I --&gt; J[complete函数执行]

    style A fill:#07c160
    style D fill:#ff9800
    style E fill:#2196f3
</code></pre>
<h3 data-id="heading-16">四、自定义JSBridge实现</h3>
<h4 data-id="heading-17">4.1 基础实现方案</h4>
<p><strong>基于URL Schema拦截实现一个简单的JSBridge:</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">JSBridge</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbacks</span> = {};
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbackId</span> = <span class="hljs-number">0</span>;

    <span class="hljs-comment">// 注册全局回调处理函数</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-property">_handleMessageFromNative</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">_handleCallback</span>.<span class="hljs-title function_">bind</span>(<span class="hljs-variable language_">this</span>);
  }

  <span class="hljs-comment">// JavaScript调用Native</span>
  <span class="hljs-title function_">callNative</span>(<span class="hljs-params">method, params = {}, callback</span>) {
    <span class="hljs-keyword">const</span> cbId = <span class="hljs-string">`cb_<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.callbackId++}</span>`</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbacks</span>[cbId] = callback;

    <span class="hljs-keyword">const</span> schema = <span class="hljs-string">`jsbridge://<span class="hljs-subst">${method}</span>?params=<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(
      <span class="hljs-built_in">JSON</span>.stringify(params)
    )}</span>&amp;callbackId=<span class="hljs-subst">${cbId}</span>`</span>;

    <span class="hljs-comment">// 创建隐藏iframe触发schema</span>
    <span class="hljs-keyword">const</span> iframe = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'iframe'</span>);
    iframe.<span class="hljs-property">style</span>.<span class="hljs-property">display</span> = <span class="hljs-string">'none'</span>;
    iframe.<span class="hljs-property">src</span> = schema;
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(iframe);

    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(iframe);
    }, <span class="hljs-number">100</span>);
  }

  <span class="hljs-comment">// Native回调JavaScript</span>
  <span class="hljs-title function_">_handleCallback</span>(<span class="hljs-params">callbackId, result</span>) {
    <span class="hljs-keyword">const</span> callback = <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbacks</span>[callbackId];
    <span class="hljs-keyword">if</span> (callback) {
      <span class="hljs-title function_">callback</span>(result);
      <span class="hljs-keyword">delete</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">callbacks</span>[callbackId];
    }
  }

  <span class="hljs-comment">// 注册可被Native调用的方法</span>
  <span class="hljs-title function_">registerHandler</span>(<span class="hljs-params">name, handler</span>) {
    <span class="hljs-variable language_">this</span>[name] = handler;
  }
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">const</span> bridge = <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSBridge</span>();

<span class="hljs-comment">// 调用Native方法</span>
bridge.<span class="hljs-title function_">callNative</span>(<span class="hljs-string">'getLocation'</span>, {
  <span class="hljs-attr">type</span>: <span class="hljs-string">'wgs84'</span>
}, <span class="hljs-keyword">function</span>(<span class="hljs-params">location</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'位置信息:'</span>, location);
});

<span class="hljs-comment">// 注册供Native调用的方法</span>
bridge.<span class="hljs-title function_">registerHandler</span>(<span class="hljs-string">'updateTitle'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">title</span>) {
  <span class="hljs-variable language_">document</span>.<span class="hljs-property">title</span> = title;
});
</code></pre>
<h4 data-id="heading-18">4.2 Promise风格封装</h4>
<p><strong>将回调风格改造为Promise,提升开发体验:</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ModernJSBridge</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">JSBridge</span> {
  <span class="hljs-title function_">invoke</span>(<span class="hljs-params">method, params = {}</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">callNative</span>(method, params, <span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (result.<span class="hljs-property">code</span> === <span class="hljs-number">0</span>) {
          <span class="hljs-title function_">resolve</span>(result.<span class="hljs-property">data</span>);
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(result.<span class="hljs-property">message</span>));
        }
      });
    });
  }
}

<span class="hljs-comment">// 现代化使用方式</span>
<span class="hljs-keyword">const</span> bridge = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ModernJSBridge</span>();

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUserLocation</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> location = <span class="hljs-keyword">await</span> bridge.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">'getLocation'</span>, {
      <span class="hljs-attr">type</span>: <span class="hljs-string">'wgs84'</span>
    });
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'经度:'</span>, location.<span class="hljs-property">longitude</span>);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'纬度:'</span>, location.<span class="hljs-property">latitude</span>);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取位置失败:'</span>, error.<span class="hljs-property">message</span>);
  }
}
</code></pre>
<h4 data-id="heading-19">4.3 Native端实现(以Android为例)</h4>
<p><strong>Android端需要拦截WebView的URL请求并解析协议:</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 这是伪代码示意,用JavaScript语法描述Android的WebViewClient逻辑</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">JSBridgeWebViewClient</span> {
  <span class="hljs-title function_">shouldOverrideUrlLoading</span>(<span class="hljs-params">view, url</span>) {
    <span class="hljs-comment">// 拦截自定义协议</span>
    <span class="hljs-keyword">if</span> (url.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'jsbridge://'</span>)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleJSBridgeUrl</span>(url);
      <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  <span class="hljs-comment">// 拦截处理,不加载URL</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;  <span class="hljs-comment">// 正常加载</span>
  }

  <span class="hljs-title function_">handleJSBridgeUrl</span>(<span class="hljs-params">url</span>) {
    <span class="hljs-comment">// 解析: jsbridge://getLocation?params=xxx&amp;callbackId=cb_1</span>
    <span class="hljs-keyword">const</span> urlObj = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(url);
    <span class="hljs-keyword">const</span> method = urlObj.<span class="hljs-property">hostname</span>;  <span class="hljs-comment">// getLocation</span>
    <span class="hljs-keyword">const</span> params = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(
      <span class="hljs-built_in">decodeURIComponent</span>(urlObj.<span class="hljs-property">searchParams</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'params'</span>))
    );
    <span class="hljs-keyword">const</span> callbackId = urlObj.<span class="hljs-property">searchParams</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'callbackId'</span>);

    <span class="hljs-comment">// 调用原生能力</span>
    <span class="hljs-keyword">switch</span>(method) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'getLocation'</span>:
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getLocation</span>(params, <span class="hljs-function">(<span class="hljs-params">location</span>) =&gt;</span> {
          <span class="hljs-comment">// 回调JavaScript</span>
          <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">callJS</span>(callbackId, {
            <span class="hljs-attr">code</span>: <span class="hljs-number">0</span>,
            <span class="hljs-attr">data</span>: location
          });
        });
        <span class="hljs-keyword">break</span>;
    }
  }

  <span class="hljs-title function_">callJS</span>(<span class="hljs-params">callbackId, result</span>) {
    <span class="hljs-keyword">const</span> script = <span class="hljs-string">`window._handleMessageFromNative('<span class="hljs-subst">${callbackId}</span>', <span class="hljs-subst">${
      <span class="hljs-built_in">JSON</span>.stringify(result)
    }</span>)`</span>;
    webView.evaluateJavascript(script, <span class="hljs-literal">null</span>);
  }

  <span class="hljs-title function_">getLocation</span>(<span class="hljs-params">params, callback</span>) {
    <span class="hljs-comment">// 调用Android LocationManager获取位置</span>
    <span class="hljs-comment">// 这里是伪代码,实际需要原生Java/Kotlin实现</span>
    <span class="hljs-keyword">const</span> location = {
      <span class="hljs-attr">longitude</span>: <span class="hljs-number">116.404</span>,
      <span class="hljs-attr">latitude</span>: <span class="hljs-number">39.915</span>
    };
    <span class="hljs-title function_">callback</span>(location);
  }
}
</code></pre>
<h3 data-id="heading-20">五、性能优化与最佳实践</h3>
<h4 data-id="heading-21">5.1 性能优化要点</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[JSBridge性能优化] --&gt; B[通信优化]
    A --&gt; C[数据优化]
    A --&gt; D[调用优化]
    A --&gt; E[内存管理]

    B --&gt; B1[减少通信频次]
    B --&gt; B2[批量传输数据]
    B --&gt; B3[使用增量更新]
    B --&gt; B4[避免大数据传输]

    C --&gt; C1[JSON序列化优化]
    C --&gt; C2[数据压缩]
    C --&gt; C3[惰性加载]
    C --&gt; C4[缓存机制]

    D --&gt; D1[异步非阻塞]
    D --&gt; D2[超时处理]
    D --&gt; D3[失败重试]
    D --&gt; D4[降级方案]

    E --&gt; E1[及时释放回调]
    E --&gt; E2[避免内存泄漏]
    E --&gt; E3[限制队列长度]

    style A fill:#e3f2fd
    style B fill:#fff3e0
    style C fill:#f3e5f5
    style D fill:#e8f5e9
    style E fill:#ffe0b2
</code></pre>
<h4 data-id="heading-22">5.2 最佳实践</h4>
<p><strong>1. 合理使用setData(小程序场景):</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 不好的做法</span>
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>({
    [<span class="hljs-string">`items[<span class="hljs-subst">${i}</span>]`</span>]: data[i]
  });  <span class="hljs-comment">// 100次通信</span>
}

<span class="hljs-comment">// 好的做法</span>
<span class="hljs-keyword">const</span> updates = {};
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">100</span>; i++) {
  updates[<span class="hljs-string">`items[<span class="hljs-subst">${i}</span>]`</span>] = data[i];
}
<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">setData</span>(updates);  <span class="hljs-comment">// 1次通信</span>
</code></pre>
<p><strong>2. 实现超时与错误处理:</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeJSBridge</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">ModernJSBridge</span> {
  <span class="hljs-title function_">invoke</span>(<span class="hljs-params">method, params = {}, timeout = <span class="hljs-number">5000</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([
      <span class="hljs-variable language_">super</span>.<span class="hljs-title function_">invoke</span>(method, params),
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">_, reject</span>) =&gt;</span> {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
          <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`调用<span class="hljs-subst">${method}</span>超时`</span>));
        }, timeout);
      })
    ]);
  }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> bridge.<span class="hljs-title function_">invoke</span>(<span class="hljs-string">'slowMethod'</span>, {}, <span class="hljs-number">3000</span>);
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-keyword">if</span> (error.<span class="hljs-property">message</span>.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'超时'</span>)) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'请求超时,请检查网络'</span>);
  }
}
</code></pre>
<p><strong>3. 权限与安全检查:</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// JSSDK安全最佳实践</span>
<span class="hljs-keyword">const</span> secureConfig = {
  <span class="hljs-comment">// 1. 签名在后端生成,前端不暴露secret</span>
  <span class="hljs-attr">getSignature</span>: <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">url</span>) {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/wechat/signature'</span>, {
      <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
      <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ url })
    });
    <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>();
  },

  <span class="hljs-comment">// 2. 动态配置jsApiList,按需授权</span>
  <span class="hljs-attr">init</span>: <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> signature = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getSignature</span>(location.<span class="hljs-property">href</span>);
    wx.<span class="hljs-title function_">config</span>({
      ...signature,
      <span class="hljs-attr">jsApiList</span>: [<span class="hljs-string">'chooseImage'</span>]  <span class="hljs-comment">// 只申请需要的权限</span>
    });
  }
};
</code></pre>
<h3 data-id="heading-23">六、调试技巧</h3>
<h4 data-id="heading-24">6.1 调试流程</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">flowchart LR
    A[开发阶段] --&gt; B{启用debug模式}
    B --&gt;|wx.config debug:true| C[查看vconsole日志]
    B --&gt;|Chrome DevTools| D[断点调试]

    C --&gt; E[检查API调用]
    D --&gt; E

    E --&gt; F{定位问题}
    F --&gt;|签名错误| G[检查后端签名逻辑]
    F --&gt;|API调用失败| H[检查权限配置]
    F --&gt;|通信异常| I[检查JSBridge实现]

    G --&gt; J[修复并重测]
    H --&gt; J
    I --&gt; J

    style B fill:#ff9800
    style F fill:#f44336
    style J fill:#4caf50
</code></pre>
<h4 data-id="heading-25">6.2 常见问题排查</h4>
<p><strong>1. 微信JSSDK签名失败:</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 调试签名问题</span>
wx.<span class="hljs-title function_">config</span>({
  <span class="hljs-attr">debug</span>: <span class="hljs-literal">true</span>,  <span class="hljs-comment">// 开启调试模式</span>
  <span class="hljs-comment">// ... 其他配置</span>
});

wx.<span class="hljs-title function_">error</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">res</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'配置失败详情:'</span>, res);
  <span class="hljs-comment">// 常见错误:</span>
  <span class="hljs-comment">// invalid signature - 签名错误,检查URL是否一致(不含#hash)</span>
  <span class="hljs-comment">// invalid url domain - 域名未配置到白名单</span>
});

<span class="hljs-comment">// 检查点:</span>
<span class="hljs-comment">// 1. 确保URL不包含hash部分</span>
<span class="hljs-keyword">const</span> url = location.<span class="hljs-property">href</span>.<span class="hljs-title function_">split</span>(<span class="hljs-string">'#'</span>)[<span class="hljs-number">0</span>];

<span class="hljs-comment">// 2. 确保timestamp是整数</span>
<span class="hljs-keyword">const</span> timestamp = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>() / <span class="hljs-number">1000</span>);

<span class="hljs-comment">// 3. 确保签名算法正确(SHA1)</span>
<span class="hljs-comment">// 签名原串: jsapi_ticket=xxx&amp;noncestr=xxx&amp;timestamp=xxx&amp;url=xxx</span>
</code></pre>
<p><strong>2. 小程序setData性能问题:</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 开启性能监控</span>
wx.<span class="hljs-title function_">setEnableDebug</span>({
  <span class="hljs-attr">enableDebug</span>: <span class="hljs-literal">true</span>
});

<span class="hljs-comment">// 监控setData性能</span>
<span class="hljs-keyword">const</span> perfObserver = wx.<span class="hljs-title function_">createPerformanceObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
  entries.<span class="hljs-title function_">getEntries</span>().<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">entry</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">entryType</span> === <span class="hljs-string">'render'</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'渲染耗时:'</span>, entry.<span class="hljs-property">duration</span>);
    }
  });
});

perfObserver.<span class="hljs-title function_">observe</span>({ <span class="hljs-attr">entryTypes</span>: [<span class="hljs-string">'render'</span>, <span class="hljs-string">'script'</span>] });
</code></pre>
<h3 data-id="heading-26">七、总结</h3>
<p>JSBridge作为Hybrid开发的核心技术,通过建立JavaScript与Native的通信桥梁,实现了Web技术与原生能力的完美融合。本文通过剖析微信公众号JSSDK和小程序SDK,深入理解了以下关键点:</p>
<ol>
<li><strong>通信机制</strong>: URL Schema拦截、API注入、MessageHandler三种主流方式</li>
<li><strong>架构设计</strong>: 微信小程序的双线程模型提供了安全性和性能的最佳平衡</li>
<li><strong>实现原理</strong>: 从JSSDK的签名验证到小程序的setData机制,理解了完整的调用链路</li>
<li><strong>最佳实践</strong>: 性能优化、错误处理、安全防护等工程化经验</li>
</ol>
<p>掌握JSBridge原理不仅能帮助我们更好地使用微信生态的各种能力,也为构建自己的Hybrid框架提供了坚实的理论基础。在实际项目中,应根据具体场景选择合适的实现方案,并持续关注性能与安全,打造更优质的用户体验。</p>
<h3 data-id="heading-27">参考资料</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fzz_jesse%2Farticle%2Fdetails%2F131297966" target="_blank" title="https://blog.csdn.net/zz_jesse/article/details/131297966" ref="nofollow noopener noreferrer">从微信JS-SDK认识JSBridge - CSDN</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fzhuanlan.zhihu.com%2Fp%2F429774488" target="_blank" title="https://zhuanlan.zhihu.com/p/429774488" ref="nofollow noopener noreferrer">微信小程序渲染层与逻辑层独立及JSBridge原理分析 - 知乎</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2F2401_89241768%2Farticle%2Fdetails%2F149710338" target="_blank" title="https://blog.csdn.net/2401_89241768/article/details/149710338" ref="nofollow noopener noreferrer">JSBridge原理与实现全解析 - CSDN</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.rootsense.com.cn%2Fh5%2Fsmart%2Fdeveloping%2F241.htm" target="_blank" title="https://www.rootsense.com.cn/h5/smart/developing/241.htm" ref="nofollow noopener noreferrer">微信小程序基础架构浅析 - ROOTSENSE</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fjavascript.plainenglish.io%2Fwhat-is-jsbridge-f72f3c0987f1" target="_blank" title="https://javascript.plainenglish.io/what-is-jsbridge-f72f3c0987f1" ref="nofollow noopener noreferrer">What is JSBridge - JavaScript in Plain English</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.aliyun.com%2Farticle%2F818505" target="_blank" title="https://developer.aliyun.com/article/818505" ref="nofollow noopener noreferrer">一文详解JSBridge实现原理 - 阿里云</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 开发实战：解决华为 HarmonyOS 任务列表不显示 App 名称的终极指南]]></title>    <link>https://juejin.cn/post/7586540799250989110</link>    <guid>https://juejin.cn/post/7586540799250989110</guid>    <pubDate>2025-12-22T15:56:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586540799250989110" data-draft-id="7586500093844439082" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 开发实战：解决华为 HarmonyOS 任务列表不显示 App 名称的终极指南"/> <meta itemprop="keywords" content="Flutter,Android,华为"/> <meta itemprop="datePublished" content="2025-12-22T15:56:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨夜寻晴天"/> <meta itemprop="url" content="https://juejin.cn/user/1943592288391496"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 开发实战：解决华为 HarmonyOS 任务列表不显示 App 名称的终极指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1943592288391496/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨夜寻晴天
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T15:56:23.000Z" title="Mon Dec 22 2025 15:56:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">问题背景</h2>
<p>在 Flutter 应用开发中，我们最近遇到了一个棘手的兼容性问题：在部分 <strong>华为手机（HarmonyOS 4.2.0，如 Mate 30 Pro 5G）</strong> 上，应用运行时的<strong>最近任务列表（Overview Screen）<strong>中，只显示应用图标，却</strong>不显示应用名称（App Name）</strong>。</p>
<p>虽然我们在 <code>AndroidManifest.xml</code> 中正确配置了 <code>android:label</code>，但在 HarmonyOS 系统上依然无效。这不仅影响用户体验，也可能导致应用在审核时被拒（如华为应用市场审核指南第 2.19 项）。</p>
<h2 data-id="heading-1">问题分析</h2>
<p>经过多次排查与尝试，我们发现该问题主要由以下几个因素共同导致：</p>
<ol>
<li><strong>Flutter 引擎初始化干扰</strong>：FlutterActivity 初始化过程中可能会重置窗口属性，导致原生的标签设置被覆盖。</li>
<li><strong>API 兼容性</strong>：Android 不同版本对 <code>TaskDescription</code>（任务描述）的 API 支持不同。HarmonyOS 基于较新的 Android 版本，对旧版 API（如基于 Bitmap 的设置）可能兼容性不佳。</li>
<li><strong>资源加载机制</strong>：直接硬编码字符串可能导致编码或加载失败，必须规范使用 <code>strings.xml</code> 资源。</li>
<li><strong>时序问题</strong>：仅在 <code>onCreate</code> 中设置可能过早，应用启动后的某些系统回调可能会再次刷新任务状态，导致设置失效。</li>
</ol>
<h2 data-id="heading-2">解决方案：三级加固策略</h2>
<p>为了彻底解决这个问题，我们采用了一套“组合拳”方案，从资源配置到原生代码层层加固。</p>
<h3 data-id="heading-3">第一步：规范化资源配置</h3>
<p>首先，确保 <code>AndroidManifest.xml</code> 中不使用硬编码，而是引用资源文件。</p>
<p><strong>1. 定义 <code>strings.xml</code></strong>
在 <code>android/app/src/main/res/values/strings.xml</code> 和 <code>values-zh/strings.xml</code> 中明确定义应用名：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">string</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"app_name"</span>&gt;</span>您的应用名称<span class="hljs-tag">&lt;/<span class="hljs-name">string</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span>
</code></pre>
<p><strong>2. 配置 <code>AndroidManifest.xml</code></strong>
确保 <code>application</code> 和 <code>activity</code> 节点都引用了该资源，并配置 <code>localeConfig</code>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">application</span>
    <span class="hljs-attr">android:label</span>=<span class="hljs-string">"@string/app_name"</span>
    <span class="hljs-attr">android:localeConfig</span>=<span class="hljs-string">"@xml/locales_config"</span>
    <span class="hljs-attr">...</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">activity</span>
        <span class="hljs-attr">android:name</span>=<span class="hljs-string">".MainActivity"</span>
        <span class="hljs-attr">android:label</span>=<span class="hljs-string">"@string/app_name"</span>
        <span class="hljs-attr">...</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">activity</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">application</span>&gt;</span>
</code></pre>
<h3 data-id="heading-4">第二步：原生代码强制干预 (Kotlin)</h3>
<p>这是解决问题的核心。我们需要在 <code>MainActivity.kt</code> 中手动设置 <code>TaskDescription</code>。我们采用了 <strong>“三级加固”</strong> 策略：</p>
<ol>
<li><strong>多生命周期设置</strong>：在 <code>onCreate</code>（创建时）和 <code>onResume</code>（可见时）都进行设置。</li>
<li><strong>延迟设置</strong>：在 <code>onResume</code> 后延迟 1 秒再次强制刷新，防止被 Flutter 引擎后续逻辑覆盖。</li>
<li><strong>API 自适应</strong>：针对 Android 9.0+ 使用资源 ID 方式（更稳定），旧版本使用 Bitmap 方式。</li>
</ol>
<p><strong>完整代码实现 (<code>MainActivity.kt</code>)：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.your.<span class="hljs-keyword">package</span>.name

<span class="hljs-keyword">import</span> android.app.ActivityManager
<span class="hljs-keyword">import</span> android.graphics.BitmapFactory
<span class="hljs-keyword">import</span> android.os.Build
<span class="hljs-keyword">import</span> android.os.Bundle
<span class="hljs-keyword">import</span> android.os.Handler
<span class="hljs-keyword">import</span> android.os.Looper
<span class="hljs-keyword">import</span> android.util.Log
<span class="hljs-keyword">import</span> io.flutter.embedding.android.FlutterActivity

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MainActivity</span> : <span class="hljs-type">FlutterActivity</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        <span class="hljs-comment">// 1. 初始化时尝试设置</span>
        updateTaskDescription()
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onResume</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onResume()
        <span class="hljs-comment">// 2. 界面可见时再次设置</span>
        updateTaskDescription()
        
        <span class="hljs-comment">// 3. 关键修复：延迟 1 秒再次设置</span>
        <span class="hljs-comment">// 防止 Flutter 引擎在启动完成后重置了窗口属性，导致之前的设置失效</span>
        Handler(Looper.getMainLooper()).postDelayed({
            updateTaskDescription()
        }, <span class="hljs-number">1000</span>)
    }

    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">updateTaskDescription</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">val</span> appName = getString(R.string.app_name)
            
            <span class="hljs-comment">// 尝试设置窗口标题，作为一种补充手段</span>
            <span class="hljs-keyword">try</span> {
                title = appName
            } <span class="hljs-keyword">catch</span> (e: Exception) {
                <span class="hljs-comment">// 忽略设置 title 失败</span>
            }

            <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.P) {
                <span class="hljs-comment">// Android 9 (API 28) 及以上：直接使用资源 ID，更稳定</span>
                <span class="hljs-comment">// 第三个参数 0 表示使用系统默认颜色</span>
                <span class="hljs-keyword">val</span> taskDescription = ActivityManager.TaskDescription(appName, R.mipmap.launcher_icon, <span class="hljs-number">0</span>)
                setTaskDescription(taskDescription)
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) {
                <span class="hljs-comment">// Android 5.0 至 8.1：使用 Bitmap 解码</span>
                <span class="hljs-keyword">val</span> icon = BitmapFactory.decodeResource(resources, R.mipmap.launcher_icon)
                <span class="hljs-keyword">val</span> taskDescription = ActivityManager.TaskDescription(appName, icon)
                setTaskDescription(taskDescription)
            }
        } <span class="hljs-keyword">catch</span> (e: Exception) {
            Log.e(<span class="hljs-string">"MainActivity"</span>, <span class="hljs-string">"Failed to update TaskDescription"</span>, e)
        }
    }
}
</code></pre>
<h2 data-id="heading-5">小结</h2>
<p>华为 HarmonyOS 系统对应用元数据的读取机制较为严格。通过在原生层主动调用 <code>setTaskDescription</code>，并配合 <strong>延迟执行</strong> 策略，我们成功绕过了系统或框架层面的干扰，确保了应用名称在最近任务列表中正确显示。</p>
<p>如果您的 Flutter 应用也遇到了类似问题，不妨尝试上述方案！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 v5 到 v6：这次 Ant Design 升级真的香]]></title>    <link>https://juejin.cn/post/7586338196302577710</link>    <guid>https://juejin.cn/post/7586338196302577710</guid>    <pubDate>2025-12-22T14:18:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586338196302577710" data-draft-id="7586504691845660681" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 v5 到 v6：这次 Ant Design 升级真的香"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-12-22T14:18:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端一小卒"/> <meta itemprop="url" content="https://juejin.cn/user/1943592286564045"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 v5 到 v6：这次 Ant Design 升级真的香
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1943592286564045/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端一小卒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T14:18:56.000Z" title="Mon Dec 22 2025 14:18:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>2025 年 11 月底，Ant Design 正式发布了 v6 版本。</p>
<p>回顾过去，从 v3 到 v4 的断崖式升级，到 v5 引入 CSS-in-JS 带来的心智负担和性能压力，很多前端同学一提到“升级”就条件反射般护住发际线。但这一次，Ant Design 团队明显听到了社区的呼声。</p>
<p>v6 没有为了“创新”而搞大刀阔斧的重构，而是聚焦于<strong>解决长期痛点</strong>、<strong>提升开发体验</strong>和<strong>平滑迁移</strong>。本文结合一线业务开发中的真实场景，聊聊 v6 的核心变化，以及这次升级到底值不值得升。</p>
<h2 data-id="heading-0">样式覆盖不再是“玄学”</h2>
<p>你一定深有体会：设计师要求改 <code>Select</code> 下拉框背景色、调整 <code>Modal</code> 头部内边距，或者给 <code>Table</code> 的某个单元格加特殊样式。在 v5 及之前，你只能打开控制台，一层层扒 DOM 结构，找到类似 <code>.ant-select-selector</code> 的 class，然后用 <code>:global</code> 或 <code>!important</code> 暴力覆盖。一旦组件库内部 DOM 微调，你的样式就崩了。</p>
<p><strong>全量 DOM 语义化 + 细粒度 classNames / styles API</strong><br/>
v6 对所有组件进行了 <strong>DOM 语义化改造</strong>（如用 <code>&lt;header&gt;</code>、<code>&lt;main&gt;</code> 等代替无意义的 <code>&lt;div&gt;</code>），更重要的是引入了复数形式的 <code>classNames</code> 和 <code>styles</code> 属性，让你直接通过语义化的 key 来定制关键区域。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// v6 写法：精准、安全、健壮</span>
&lt;<span class="hljs-title class_">Modal</span>
  title=<span class="hljs-string">"业务配置"</span>
  open={<span class="hljs-literal">true</span>}
  classNames={{
    <span class="hljs-attr">header</span>: <span class="hljs-string">'my-modal-header'</span>,
    <span class="hljs-attr">body</span>: <span class="hljs-string">'my-modal-body'</span>,
    <span class="hljs-attr">footer</span>: <span class="hljs-string">'my-modal-footer'</span>,
    <span class="hljs-attr">mask</span>: <span class="hljs-string">'glass-blur-mask'</span>, <span class="hljs-comment">// 甚至能直接控制遮罩</span>
    <span class="hljs-attr">content</span>: <span class="hljs-string">'my-modal-content'</span>,
  }}
  styles={{
    <span class="hljs-attr">header</span>: { <span class="hljs-attr">borderBottom</span>: <span class="hljs-string">'1px solid #eee'</span>, <span class="hljs-attr">padding</span>: <span class="hljs-string">'16px 24px'</span> },
    <span class="hljs-attr">body</span>: { <span class="hljs-attr">padding</span>: <span class="hljs-string">'24px'</span> },
  }}
&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>内容区域...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
&lt;/<span class="hljs-title class_">Modal</span>&gt;
</code></pre>
<p><strong>v5 vs v6 对比（Modal 头部样式定制）</strong>：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">// v5（hack 写法，易崩）</span>
<span class="hljs-keyword">import</span> { <span class="hljs-variable language_">global</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>; <span class="hljs-comment">// 或直接写 less</span>
:<span class="hljs-title function_">global</span>(<span class="hljs-params">.ant-modal-header</span>) {
  border-<span class="hljs-attr">bottom</span>: 1px solid #eee !important;
}
</code></pre>
<p><strong>v6 技术价值</strong></p>
<ul>
<li><strong>不再依赖内部 class 名</strong>：官方承诺这些 key（如 header、body）的存在，即使未来 DOM 结构变化，你的样式依然有效。</li>
<li><strong>支持动态样式</strong>：<code>styles</code> 属性接受对象，方便结合主题或 props 动态生成。</li>
</ul>
<h2 data-id="heading-1">原生 CSS 变量全面回归</h2>
<p>v5 的 CSS-in-JS 方案虽然解决了按需加载和动态主题，但在大型后台系统里，运行时生成样式的 JS 开销仍然明显，尤其在低端设备上切换主题或路由时容易掉帧、闪烁。</p>
<p><strong>v6 的解法：零运行时（Zero-runtime）CSS 变量模式</strong><br/>
彻底抛弃 CSS-in-JS，默认使用原生 CSS Variables（Custom Properties）。</p>
<ul>
<li><strong>体积更小</strong>：CSS 文件显著减小（官方称部分场景下减少 30%+）。</li>
<li><strong>响应更快</strong>：主题切换只需修改 CSS 变量值，浏览器原生处理，毫秒级生效，无需重新生成哈希类名。</li>
<li><strong>暗黑模式友好</strong>：直接通过 <code>--antd-color-primary</code> 等变量实现全局主题切换。</li>
</ul>
<p>这对需要支持多品牌色、暗黑模式的 SaaS 平台来说，是巨大的性能红利。</p>
<h2 data-id="heading-2">高频场景官方接管</h2>
<p>瀑布流布局、Drawer 拖拽调整大小、InputNumber 加减按钮等，都是业务中常见需求，但之前往往需要引入第三方库或自己手写，增加维护成本和打包体积。</p>
<p><strong>v6 的解法：新增实用组件 &amp; 交互优化</strong></p>
<ul>
<li><strong>Masonry 瀑布流</strong>（内置）</li>
</ul>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Masonry</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'antd'</span>;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Masonry</span> <span class="hljs-attr">columns</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">xs:</span> <span class="hljs-attr">1</span>, <span class="hljs-attr">sm:</span> <span class="hljs-attr">2</span>, <span class="hljs-attr">md:</span> <span class="hljs-attr">3</span>, <span class="hljs-attr">lg:</span> <span class="hljs-attr">4</span> }} <span class="hljs-attr">gutter</span>=<span class="hljs-string">{16}</span>&gt;</span>
  {items.map(item =&gt; (
    <span class="hljs-tag">&lt;<span class="hljs-name">Card</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item.id}</span> <span class="hljs-attr">cover</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{item.cover}</span> /&gt;</span>} {...item} /&gt;
  ))}
<span class="hljs-tag">&lt;/<span class="hljs-name">Masonry</span>&gt;</span></span>
</code></pre>
<ul>
<li><strong>Drawer 支持拖拽</strong>：原生支持拖拽改变宽度，无需自己写 resize 逻辑。</li>
<li><strong>InputNumber 支持 spinner 模式</strong>：加减按钮直接在输入框两侧，像购物车那样。</li>
<li><strong>其他</strong>：Tooltip 支持平移（panning）、弹层默认支持模糊蒙层（blur mask）等交互优化。</li>
</ul>
<p>这些补齐了业务高频场景，减少了“自己造轮子”的痛苦。</p>
<h2 data-id="heading-3">升级建议：这次真的“平滑”吗？</h2>
<p><strong>v6 迁移关键事实</strong></p>
<ul>
<li><strong>React 版本要求</strong>：必须升级到 <strong>React 18+</strong>（不再支持 React 17 及以下）。</li>
<li><strong>破坏性变更</strong>：部分 API 被废弃（如 <code>bordered</code> → <code>variant</code>、<code>headStyle</code> → <code>styles.header</code> 等），v7 将彻底移除。</li>
<li><strong>兼容性</strong>：v5 项目绝大多数业务逻辑代码无需改动，但若大量使用了深层 hack 样式，可能需要调整。</li>
<li><strong>推荐工具</strong>：官方提供 Codemod 迁移脚本，可自动化处理大部分废弃 API。</li>
</ul>
<p><strong>建议</strong></p>
<ol>
<li><strong>新项目</strong>：直接上 v6，享受更好的性能、体验和未来维护性。</li>
<li><strong>v5 项目</strong>：先在 dev 分支尝试升级。无大量 hack 样式的话，成本很低。</li>
<li><strong>v4 及更老项目</strong>：跨度较大，建议先逐步迁移到 v5，再升 v6；或在新模块中使用 v6（配合微前端或包隔离）。</li>
<li><strong>升级前检查</strong>：
<ul>
<li>确认 React ≥ 18</li>
<li>运行官方 Codemod</li>
<li>验证目标浏览器支持 CSS 变量（IE 彻底不支持）</li>
</ul>
</li>
</ol>
<h2 data-id="heading-4">总结</h2>
<p>Ant Design v6 是一次**“返璞归真”**的升级。它把控制权还给开发者（语义化 API），用现代浏览器特性解决性能问题（零运行时 CSS 变量），并补齐了业务高频组件。</p>
<p><strong>升级核心收益</strong></p>
<ul>
<li>更少的 hack 代码，更健壮的样式</li>
<li>显著的性能提升（主题切换、渲染速度）</li>
<li>官方接管高频业务组件，减少第三方依赖</li>
<li>平滑迁移路径，真正降低了“升级火葬场”的风险</li>
</ul>
<p>对于业务开发者来说，这意味着：<strong>更少的加班、更快的页面、更早下班</strong>。</p>
<p><strong>参考链接</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fant.design%2Fdocs%2Freact%2Fmigration-v6-cn%2F" target="_blank" title="https://ant.design/docs/react/migration-v6-cn/" ref="nofollow noopener noreferrer">Ant Design v6 迁移指南</a>（中文） / <a href="https://link.juejin.cn?target=https%3A%2F%2Fant.design%2Fdocs%2Freact%2Fmigration-v6" target="_blank" title="https://ant.design/docs/react/migration-v6" ref="nofollow noopener noreferrer">English</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fant.design%2Fdocs%2Fblog%2Fsemantic-beauty-cn%2F" target="_blank" title="https://ant.design/docs/blog/semantic-beauty-cn/" ref="nofollow noopener noreferrer">语义化更新说明</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fant.design%2Fchangelog-cn%2F" target="_blank" title="https://ant.design/changelog-cn/" ref="nofollow noopener noreferrer">更新日志 (Changelog)</a>（中文） / <a href="https://link.juejin.cn?target=https%3A%2F%2Fant.design%2Fchangelog" target="_blank" title="https://ant.design/changelog" ref="nofollow noopener noreferrer">English</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[GIS 数据转换：使用 GDAL 将 TXT 转换为 Shp 数据]]></title>    <link>https://juejin.cn/post/7586540799250710582</link>    <guid>https://juejin.cn/post/7586540799250710582</guid>    <pubDate>2025-12-22T14:31:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586540799250710582" data-draft-id="7586490798432141375" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="GIS 数据转换：使用 GDAL 将 TXT 转换为 Shp 数据"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-12-22T14:31:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GIS之路"/> <meta itemprop="url" content="https://juejin.cn/user/4346787284915481"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            GIS 数据转换：使用 GDAL 将 TXT 转换为 Shp 数据
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4346787284915481/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GIS之路
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T14:31:48.000Z" title="Mon Dec 22 2025 14:31:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<blockquote>
<p>❝</p>
<p>TXT 作为一种文本格式，可以很方便的存储一些简单几何数据。在 GIS 开发中，经常需要进行数据的转换处理，其中常见的便是将 TXT 转换为 Shp 数据进行展示。</p>
</blockquote>
<p>本篇教程在之前一系列文章的基础上讲解</p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">GDAL 简介</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">GDAL 下载安装</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">GDAL 开发起步</a></li>
</ul>
<p>如如果你还没有看过，建议从以上内容开始。</p>
<h2 data-id="heading-1">1. 开发环境</h2>
<p>本文使用如下开发环境，以供参考。</p>
<p>时间：<code>2025年</code></p>
<p>系统：<code>Windows 11</code></p>
<p>Python：<code>3.11.7</code></p>
<p>GDAL：<code>3.11.1</code></p>
<h2 data-id="heading-2">2. 数据准备</h2>
<p><code>TXT</code>（纯文本文件）是一种最基本的文件格式，仅存储无格式的文本数据，适用于各种场景（如数据交换、日志记录、配置文件等）。</p>
<p><strong>如下是全国省会城市人口 TXT 文本结构：</strong></p>
<pre><code class="hljs language-rust" lang="rust">ID,Name,Longitude,Latitude,Population
<span class="hljs-number">1</span>,Beijing,<span class="hljs-number">116.40</span>,<span class="hljs-number">39.90</span>,<span class="hljs-number">2171</span>万
<span class="hljs-number">2</span>,Shanghai,<span class="hljs-number">121.47</span>,<span class="hljs-number">31.23</span>,<span class="hljs-number">2487</span>万
<span class="hljs-number">3</span>,Guangzhou,<span class="hljs-number">113.26</span>,<span class="hljs-number">23.12</span>,<span class="hljs-number">1868</span>万
<span class="hljs-number">4</span>,Shenzhen,<span class="hljs-number">114.05</span>,<span class="hljs-number">22.55</span>,<span class="hljs-number">1756</span>万
<span class="hljs-number">5</span>,Tianjin,<span class="hljs-number">117.20</span>,<span class="hljs-number">39.08</span>,<span class="hljs-number">1373</span>万
<span class="hljs-number">6</span>,Chongqing,<span class="hljs-number">106.50</span>,<span class="hljs-number">29.53</span>,<span class="hljs-number">3205</span>万
<span class="hljs-number">7</span>,Chengdu,<span class="hljs-number">104.06</span>,<span class="hljs-number">30.67</span>,<span class="hljs-number">2094</span>万
<span class="hljs-number">8</span>,Wuhan,<span class="hljs-number">114.30</span>,<span class="hljs-number">30.60</span>,<span class="hljs-number">1121</span>万
<span class="hljs-number">9</span>,Hangzhou,<span class="hljs-number">120.15</span>,<span class="hljs-number">30.28</span>,<span class="hljs-number">1194</span>万
<span class="hljs-number">10</span>,Nanjing,<span class="hljs-number">118.78</span>,<span class="hljs-number">32.04</span>,<span class="hljs-number">931</span>万
<span class="hljs-number">11</span>,Xi<span class="hljs-symbol">'an</span>,<span class="hljs-number">108.93</span>,<span class="hljs-number">34.27</span>,<span class="hljs-number">1295</span>万
<span class="hljs-number">12</span>,Changsha,<span class="hljs-number">112.97</span>,<span class="hljs-number">28.20</span>,<span class="hljs-number">839</span>万
<span class="hljs-number">13</span>,Zhengzhou,<span class="hljs-number">113.62</span>,<span class="hljs-number">34.75</span>,<span class="hljs-number">1260</span>万
<span class="hljs-number">14</span>,Harbin,<span class="hljs-number">126.63</span>,<span class="hljs-number">45.75</span>,<span class="hljs-number">1076</span>万
<span class="hljs-number">15</span>,Shenyang,<span class="hljs-number">123.43</span>,<span class="hljs-number">41.80</span>,<span class="hljs-number">831</span>万
<span class="hljs-number">16</span>,Qingdao,<span class="hljs-number">120.38</span>,<span class="hljs-number">36.07</span>,<span class="hljs-number">1007</span>万
<span class="hljs-number">17</span>,Dalian,<span class="hljs-number">121.62</span>,<span class="hljs-number">38.92</span>,<span class="hljs-number">745</span>万
<span class="hljs-number">18</span>,Xiamen,<span class="hljs-number">118.08</span>,<span class="hljs-number">24.48</span>,<span class="hljs-number">516</span>万
<span class="hljs-number">19</span>,Ningbo,<span class="hljs-number">121.55</span>,<span class="hljs-number">29.88</span>,<span class="hljs-number">854</span>万
<span class="hljs-number">20</span>,Hefei,<span class="hljs-number">117.28</span>,<span class="hljs-number">31.86</span>,<span class="hljs-number">937</span>万
<span class="hljs-number">21</span>,Fuzhou,<span class="hljs-number">119.30</span>,<span class="hljs-number">26.08</span>,<span class="hljs-number">829</span>万
<span class="hljs-number">22</span>,Jinan,<span class="hljs-number">117.00</span>,<span class="hljs-number">36.67</span>,<span class="hljs-number">920</span>万
<span class="hljs-number">23</span>,Taiyuan,<span class="hljs-number">112.55</span>,<span class="hljs-number">37.87</span>,<span class="hljs-number">530</span>万
<span class="hljs-number">24</span>,Changchun,<span class="hljs-number">125.35</span>,<span class="hljs-number">43.88</span>,<span class="hljs-number">906</span>万
<span class="hljs-number">25</span>,Kunming,<span class="hljs-number">102.72</span>,<span class="hljs-number">25.04</span>,<span class="hljs-number">846</span>万
<span class="hljs-number">26</span>,Nanning,<span class="hljs-number">108.37</span>,<span class="hljs-number">22.82</span>,<span class="hljs-number">874</span>万
<span class="hljs-number">27</span>,Lanzhou,<span class="hljs-number">103.82</span>,<span class="hljs-number">36.06</span>,<span class="hljs-number">435</span>万
<span class="hljs-number">28</span>,Yinchuan,<span class="hljs-number">106.27</span>,<span class="hljs-number">38.47</span>,<span class="hljs-number">285</span>万
<span class="hljs-number">29</span>,Xining,<span class="hljs-number">101.77</span>,<span class="hljs-number">36.62</span>,<span class="hljs-number">263</span>万
<span class="hljs-number">30</span>,Urümqi,<span class="hljs-number">87.62</span>,<span class="hljs-number">43.82</span>,<span class="hljs-number">405</span>万
<span class="hljs-number">31</span>,Lhasa,<span class="hljs-number">91.11</span>,<span class="hljs-number">29.65</span>,<span class="hljs-number">86</span>万
<span class="hljs-number">32</span>,Haikou,<span class="hljs-number">110.20</span>,<span class="hljs-number">20.05</span>,<span class="hljs-number">287</span>万
</code></pre>
<h2 data-id="heading-3">3. 导入依赖</h2>
<p><code>TXT</code>作为一种矢量数据格式，可以使用矢量库<code>OGR</code>进行处理，以实现<code>TXT</code>数据从文本格式转换为<code>Shp</code>格式。其中还涉及坐标定义，所以还需要引入<code>osr</code>模块。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">from</span> osgeo <span class="hljs-keyword">import</span> ogr,osr
<span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> csv
</code></pre>
<h2 data-id="heading-4">4. 数据读取与转换</h2>
<p>定义一个方法<code>Txt2Shp(txtPath,shpPath,encoding="UTF-8")</code>用于将<code>TXT</code>数据转换为<code>Shp</code>数据。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
说明：将 TXT 文件转换为 Shapfile 文件
参数：
    -txtPath：TXT 文件路径
    -shpPath：Shp 文件路径
    -encoding：TXT 文件编码
"""</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">Txt2Shp</span>(<span class="hljs-params">txtPath,shpPath,encoding=<span class="hljs-string">"UTF-8"</span></span>)
</code></pre>
<p>在进行<code>TXT</code>数据格式转换之前，需要检查数据路径是否存在。</p>
<pre><code class="hljs language-lua" lang="lua"># 检查文件是否存在
<span class="hljs-keyword">if</span> <span class="hljs-built_in">os</span>.<span class="hljs-built_in">path</span>.exists(txtPath):
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"TXT 文件存在。"</span>)
<span class="hljs-keyword">else</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"TXT 文件不存在，请重新选择文件！"</span>)
    <span class="hljs-keyword">return</span>
</code></pre>
<p>通过<code>GetDriverByName</code>获取<code>Shp</code>数据驱动，并使用<code>os.path.exists</code>方法检查<code>Shp</code>文件是否已经创建，如果存在则将其删除。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 注册所有驱动</span>
ogr.RegisterAll()

<span class="hljs-comment"># 添加Shp数据源</span>
shpDriver = ogr.GetDriverByName(<span class="hljs-string">'ESRI Shapefile'</span>)

<span class="hljs-keyword">if</span> os.path.exists(shpPath):
    <span class="hljs-keyword">try</span>:
        shpDriver.DeleteDataSource(shpPath)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"文件已删除！"</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"文件删除出错：<span class="hljs-subst">{e}</span>"</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">False</span>
</code></pre>
<p>接着创建<code>Shp</code>数据源和空间参考，数据坐标系这里定义为4326。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 创建Shp数据源</span>
shpDataSource = shpDriver.CreateDataSource(shpPath)
<span class="hljs-keyword">if</span> shpDataSource <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"无法创建Shp数据源，请检查文件！"</span>)
    <span class="hljs-keyword">return</span> false
<span class="hljs-comment"># 创建空间参考</span>
spatialReference = osr.SpatialReference()
spatialReference.ImportFromEPSG(<span class="hljs-number">4326</span>)
</code></pre>
<p>之后通过数据源方法<code>CreateLayer</code>创建<code>Shp</code>图层，使用图层方法<code>CreateField</code>添加属性字段，需要定义属性名称以及属性字段类型。</p>
<pre><code class="hljs language-less" lang="less"># 创建图层
<span class="hljs-selector-tag">shpLayer</span> = <span class="hljs-selector-tag">shpDataSource</span><span class="hljs-selector-class">.CreateLayer</span>(<span class="hljs-string">"points"</span>,spatialReference,ogr.wkbPoint)

# 添加图层字段
<span class="hljs-selector-tag">shpLayer</span><span class="hljs-selector-class">.CreateField</span>(ogr.<span class="hljs-built_in">FieldDefn</span>(<span class="hljs-string">"ID"</span>,ogr.OFTString))
<span class="hljs-selector-tag">shpLayer</span><span class="hljs-selector-class">.CreateField</span>(ogr.<span class="hljs-built_in">FieldDefn</span>(<span class="hljs-string">"Name"</span>,ogr.OFTString))
<span class="hljs-selector-tag">shpLayer</span><span class="hljs-selector-class">.CreateField</span>(ogr.<span class="hljs-built_in">FieldDefn</span>(<span class="hljs-string">"Longitude"</span>,ogr.OFTReal))
<span class="hljs-selector-tag">shpLayer</span><span class="hljs-selector-class">.CreateField</span>(ogr.<span class="hljs-built_in">FieldDefn</span>(<span class="hljs-string">"Latitude"</span>,ogr.OFTReal))
<span class="hljs-selector-tag">shpLayer</span><span class="hljs-selector-class">.CreateField</span>(ogr.<span class="hljs-built_in">FieldDefn</span>(<span class="hljs-string">"Population"</span>,ogr.OFTString))
</code></pre>
<p>读取<code>TXT</code>数据并将其转换为<code>Shapefile</code>数据，在打开数据时，根据<code>TXT</code>文件属性，使用逗号分隔符进行读取并跳过表头行数据。之后根据行数据进行属性遍历，将读取的字段值和几何属性写入到要素对象中。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 读取TXT文件</span>
<span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(txtPath,<span class="hljs-string">"r"</span>,encoding=encoding) <span class="hljs-keyword">as</span> txtFile:
    <span class="hljs-comment"># 根据逗号分隔符进行读取</span>
    reader = csv.reader(txtFile,delimiter=<span class="hljs-string">","</span>)
    <span class="hljs-comment"># 跳过表头</span>
    header = <span class="hljs-built_in">next</span>(reader)
    <span class="hljs-comment"># 遍历记录</span>
    <span class="hljs-keyword">for</span> row <span class="hljs-keyword">in</span> reader:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"要素记录：<span class="hljs-subst">{row}</span>"</span>)
        <span class="hljs-comment"># 创建要素</span>
        feature = ogr.Feature(shpLayer.GetLayerDefn())

        <span class="hljs-comment"># 根据图层字段写入属性</span>
        feature.SetField(<span class="hljs-string">"ID"</span>,<span class="hljs-built_in">str</span>(row[<span class="hljs-number">0</span>]))
        feature.SetField(<span class="hljs-string">"Name"</span>,<span class="hljs-built_in">str</span>(row[<span class="hljs-number">1</span>]))
        feature.SetField(<span class="hljs-string">"Longitude"</span>,<span class="hljs-built_in">float</span>(row[<span class="hljs-number">2</span>]))
        feature.SetField(<span class="hljs-string">"Latitude"</span>,<span class="hljs-built_in">float</span>(row[<span class="hljs-number">3</span>]))
        feature.SetField(<span class="hljs-string">"Population"</span>,<span class="hljs-built_in">str</span>(row[<span class="hljs-number">4</span>]))

        <span class="hljs-comment"># 创建几何对象</span>
        wkt = <span class="hljs-string">f"POINT(<span class="hljs-subst">{<span class="hljs-built_in">float</span>(row[<span class="hljs-number">2</span>])}</span> <span class="hljs-subst">{<span class="hljs-built_in">float</span>(row[<span class="hljs-number">3</span>])}</span>)"</span>
        pointGeom = ogr.CreateGeometryFromWkt(wkt)

        feature.SetGeometry(pointGeom)

        <span class="hljs-comment"># 将要素添加到图层</span>
        shpLayer.CreateFeature(feature)
        feature = <span class="hljs-literal">None</span>

CreateCpgFile2Encode(shpPath,encoding)
<span class="hljs-comment"># 释放数据资源        </span>
shpDataSource = <span class="hljs-literal">None</span>
</code></pre>
<p>其中<code>CreateCpgFile2Encode</code>方法用于创建字符编码文件，后缀名为<code>.cpg</code>。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
说明：创建.cpg文件指定字符编码
参数：
    -shpPath：Shp文件路径
    -encoding：Shp文件字符编码
"""</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">CreateCpgFile2Encode</span>(<span class="hljs-params">shpPath,encoding</span>):
    fileName = os.path.splitext(shpPath)[<span class="hljs-number">0</span>]
    cpgFile = fileName + <span class="hljs-string">".cpg"</span>

    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(cpgFile,<span class="hljs-string">"w"</span>,encoding=encoding) <span class="hljs-keyword">as</span> f:
        f.write(encoding)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"成功创建编码文件: <span class="hljs-subst">{cpgFile}</span>"</span>)
</code></pre>
<p>程序成功转换数据显示如下：<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10f03e53d8b14f8eaf79549da9f969af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767018708&amp;x-signature=Y%2BNBTLQrPFbuh%2Be4RsqBhfLAL8c%3D" alt="" loading="lazy"/></p>
<p>使用<code>ArcMap</code>打开显示结果如下：<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/074a8d3ab9434bd880ada8a55ab50ce1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgR0lT5LmL6Lev:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767018708&amp;x-signature=t61QtbAYKXmOoT6IH%2BK%2BunaGRF8%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flink源码阅读：Watermark机制]]></title>    <link>https://juejin.cn/post/7586505172815495219</link>    <guid>https://juejin.cn/post/7586505172815495219</guid>    <pubDate>2025-12-22T14:46:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586505172815495219" data-draft-id="7586504691845775369" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flink源码阅读：Watermark机制"/> <meta itemprop="keywords" content="Flink,大数据"/> <meta itemprop="datePublished" content="2025-12-22T14:46:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="面向Google编程"/> <meta itemprop="url" content="https://juejin.cn/user/1063982986695374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flink源码阅读：Watermark机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1063982986695374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    面向Google编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T14:46:58.000Z" title="Mon Dec 22 2025 14:46:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前面我们已经梳理了 Flink 状态和 Checkpoint 相关的源码。从本文开始，我们再来关注另外几个核心概念，即时间、Watermark 和窗口。</p>
<h3 data-id="heading-0">写在前面</h3>
<p>在 Flink 中 Watermark 是用来解决数据乱序问题的，它也是窗口关闭的触发条件。对于 Watermark 的概念和用法还不熟悉的同学可以先阅读<a href="https://link.juejin.cn?target=https%3A%2F%2Fjackeyzhe.github.io%2F2025%2F06%2F30%2FFlink%25E5%25AD%25A6%25E4%25B9%25A0%25E7%25AC%2594%25E8%25AE%25B0%25EF%25BC%259A%25E6%2597%25B6%25E9%2597%25B4%25E4%25B8%258EWatermark%2F" target="_blank" title="https://jackeyzhe.github.io/2025/06/30/Flink%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%EF%BC%9A%E6%97%B6%E9%97%B4%E4%B8%8EWatermark/" ref="nofollow noopener noreferrer">Flink学习笔记：时间与Watermark</a>一文。下面我们进入正题，开始梳理 Watermark 相关的源码。</p>
<h3 data-id="heading-1">Watermark 定义</h3>
<p>Watermark 的定义非常简单，它继承了 <code>StreamElement</code> 类，内部只有一个 timestamp 变量。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PublicEvolving</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Watermark</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">StreamElement</span> {

    <span class="hljs-comment">/** The watermark that signifies end-of-event-time. */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Watermark</span> <span class="hljs-variable">MAX_WATERMARK</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watermark</span>(Long.MAX_VALUE);

    <span class="hljs-comment">/** The watermark that signifies is used before any actual watermark has been generated. */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Watermark</span> <span class="hljs-variable">UNINITIALIZED</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Watermark</span>(Long.MIN_VALUE);

    <span class="hljs-comment">// ------------------------------------------------------------------------</span>

    <span class="hljs-comment">/** The timestamp of the watermark in milliseconds. */</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> timestamp;

    <span class="hljs-comment">/** Creates a new watermark with the given timestamp in milliseconds. */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Watermark</span><span class="hljs-params">(<span class="hljs-type">long</span> timestamp)</span> {
        <span class="hljs-built_in">this</span>.timestamp = timestamp;
    }

    <span class="hljs-comment">/** Returns the timestamp associated with this {<span class="hljs-doctag">@link</span> Watermark} in milliseconds. */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getTimestamp</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> timestamp;
    }

    <span class="hljs-comment">// ------------------------------------------------------------------------</span>

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">equals</span><span class="hljs-params">(Object o)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span> == o
                || o != <span class="hljs-literal">null</span>
                        &amp;&amp; o.getClass() == <span class="hljs-built_in">this</span>.getClass()
                        &amp;&amp; ((Watermark) o).timestamp == timestamp;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">hashCode</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> (<span class="hljs-type">int</span>) (timestamp ^ (timestamp &gt;&gt;&gt; <span class="hljs-number">32</span>));
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Watermark @ "</span> + timestamp;
    }
}
</code></pre>
<h3 data-id="heading-2">Watermark 处理过程</h3>
<p>我们先来回顾一下 Watermark 的生成方法。</p>
<pre><code class="hljs language-ini" lang="ini">SingleOutputStreamOperator&lt;Event&gt; <span class="hljs-attr">withTimestampsAndWatermarks</span> = source
        .assignTimestampsAndWatermarks(
                WatermarkStrategy.forBoundedOutOfOrderness(Duration.ofSeconds(20))
        )<span class="hljs-comment">;</span>
</code></pre>
<h4 data-id="heading-3">初始化</h4>
<p>在定义 Watermark 的时候，我们调用 assignTimestampsAndWatermarks 方法。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">public</span> <span class="hljs-type">SingleOutputStreamOperator</span>&lt;<span class="hljs-type">T</span>&gt; assignTimestampsAndWatermarks(
        <span class="hljs-type">WatermarkStrategy</span>&lt;<span class="hljs-type">T</span>&gt; watermarkStrategy) {
    <span class="hljs-keyword">final</span> <span class="hljs-type">WatermarkStrategy</span>&lt;<span class="hljs-type">T</span>&gt; cleanedStrategy <span class="hljs-operator">=</span> clean(watermarkStrategy);
    <span class="hljs-comment">// match parallelism to input, to have a 1:1 source -&gt; timestamps/watermarks relationship</span>
    <span class="hljs-comment">// and chain</span>
    <span class="hljs-keyword">final</span> int inputParallelism <span class="hljs-operator">=</span> getTransformation().getParallelism();
    <span class="hljs-keyword">final</span> <span class="hljs-type">TimestampsAndWatermarksTransformation</span>&lt;<span class="hljs-type">T</span>&gt; transformation <span class="hljs-operator">=</span>
            new <span class="hljs-type">TimestampsAndWatermarksTransformation</span>&lt;&gt;(
                    <span class="hljs-string">"Timestamps/Watermarks"</span>,
                    inputParallelism,
                    getTransformation(),
                    cleanedStrategy,
                    <span class="hljs-literal">false</span>);
    getExecutionEnvironment().addOperator(transformation);
    <span class="hljs-keyword">return</span> new <span class="hljs-type">SingleOutputStreamOperator</span>&lt;&gt;(getExecutionEnvironment(), transformation);
}
</code></pre>
<p>这个方法接收了一个 WatermarkStrategy 参数，把它封装到 TimestampsAndWatermarksTransformation 中之后，就添加到 transformations 列表中了。在生成 StreamGraph 的过程中，会调用每个 transformation 的 transform 方法。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c0920d6ef954cfebbd21e82caec352b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767019617&amp;x-signature=o4HDvIbnF0FMPCn3rJFzH1z2dEM%3D" alt="transform" loading="lazy"/></p>
<p>通过这个调用链路，创建出了 TimestampsAndWatermarksOperatorFactory，在初始化 StreamTask 时，会调用 <code>TimestampsAndWatermarksOperatorFactory.createStreamOperator</code> 方法来创建 TimestampsAndWatermarksOperator，并调用它的 open 方法。</p>
<p>在这个 open 方法中，主要是生成 timestampAssigner 和 watermarkGenerator。timestampAssigner 是用于提取时间戳，watermarkGenerator 是用于生成 Watermark。</p>
<p>生成完成之后注册了一个定时器，到指定时间后会调用 onProcessingTime 方法。</p>
<pre><code class="hljs language-scss" lang="scss">public void <span class="hljs-built_in">onProcessingTime</span>(long timestamp) throws Exception {
    watermarkGenerator<span class="hljs-selector-class">.onPeriodicEmit</span>(wmOutput);

    final long now = <span class="hljs-built_in">getProcessingTimeService</span>()<span class="hljs-selector-class">.getCurrentProcessingTime</span>();
    <span class="hljs-built_in">getProcessingTimeService</span>()<span class="hljs-selector-class">.registerTimer</span>(now + watermarkInterval, this);
}
</code></pre>
<p>这个方法的逻辑也很简单，先发送创建并发送 Watermark，然后再注册一个定时器。</p>
<h4 data-id="heading-4">发送 Watermark</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/849537fb82f2428a9e6f354166bc984a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767019617&amp;x-signature=Q9U8zY0irzZ%2FXBuYc4IwxU8BhUM%3D" alt="emitWatermark" loading="lazy"/></p>
<p>我们以 BoundedOutOfOrdernessWatermarks 为例，它向下游发送了一个 Watermark，时间戳为 maxTimestamp - outOfOrdernessMillis - 1（maxTimestamp 是当前最大的事件时间戳，outOfOrdernessMillis 是我们定义的周期时间毫秒值）。随后在 WatermarkEmitter.emitWatermark 方法中，更新了当前 Watermark 的值。最后 RecordWriterOutput.emitWatermark 则是向下游广播当前的 Watermark。</p>
<h4 data-id="heading-5">下游处理</h4>
<p>下游处理方法我们从 <code>StreamOneInputProcessor.processInput</code> 入手，先来看具体的调用链路。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47b303cc67ec47a09609ba5245c80c4a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767019617&amp;x-signature=nDd1rjWpLmI7VtcAyN%2FF1peSqO0%3D" alt="processWatermark" loading="lazy"/></p>
<p>在 inputWatermark 方法中，先是对 alignedSubpartitionStatuses 进行调整，alignedSubpartitionStatuses 这个变量主要是用来获取最小的 Watermark。最后调用了 <code>findAndOutputNewMinWatermarkAcrossAlignedSubpartitions</code> 方法。这个方法中，会获取到所有上游最小的 Watermark，如果它大于最近发送的一个 Watermark，就会向下游发送。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">emitWatermark</span><span class="hljs-params">(Watermark watermark)</span> throws Exception </span>{
    watermarkGauge.<span class="hljs-built_in">setCurrentWatermark</span>(watermark.<span class="hljs-built_in">getTimestamp</span>());
    <span class="hljs-keyword">operator</span>.<span class="hljs-built_in">processWatermark</span>(watermark);
}
</code></pre>
<p>这个发送方法中，调用了 <code>operator.processWatermark</code>，我们接着看这个处理方法。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7ef73c2e5d74e5bb1ab37c51992a0ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2i5ZCRR29vZ2xl57yW56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767019617&amp;x-signature=3h9jC4RjjTX6lbtfWAemX2W6Ywk%3D" alt="advanceWatermark" loading="lazy"/></p>
<p>在 tryAdvanceWatermark 方法中如果 Watermark 的时间大于 eventTimeTimersQueue 队列中头节点的时间，那么对 eventTimeTimersQueue 这个队列进行出队操作，这个操作意味着触发了窗口计算。</p>
<pre><code class="hljs language-ini" lang="ini">public boolean tryAdvanceWatermark(
        long time, InternalTimeServiceManager.ShouldStopAdvancingFn shouldStopAdvancingFn)
        throws Exception {
    <span class="hljs-attr">currentWatermark</span> = time<span class="hljs-comment">;</span>
    InternalTimer&lt;K, N&gt; timer<span class="hljs-comment">;</span>
    boolean <span class="hljs-attr">interrupted</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    while ((<span class="hljs-attr">timer</span> = eventTimeTimersQueue.peek()) != null
            &amp;&amp; timer.getTimestamp() &lt;= time
            &amp;&amp; !cancellationContext.isCancelled()
            &amp;&amp; !interrupted) {
        keyContext.setCurrentKey(timer.getKey())<span class="hljs-comment">;</span>
        eventTimeTimersQueue.poll()<span class="hljs-comment">;</span>
        triggerTarget.onEventTime(timer)<span class="hljs-comment">;</span>
        taskIOMetricGroup.getNumFiredTimers().inc()<span class="hljs-comment">;</span>
        // Check if we should stop advancing after at least one iteration to guarantee progress
        // and prevent a potential <span class="hljs-attr">starvation.
        interrupted</span> = shouldStopAdvancingFn.test()<span class="hljs-comment">;</span>
    }
    return !interrupted<span class="hljs-comment">;</span>
}
</code></pre>
<p>之后 Watermark 就随着数据流一直到 sink 节点，在 StreamSink 中，支持用户自己实现方法向 sink 中写入 Watermark，除此之外什么也不做。</p>
<h3 data-id="heading-6">总结</h3>
<p>本文我们一起梳理了 Watermark 相关的源码，从 Watermark 的定义，到 Watermark 的处理过程。处理过程分成了初始化、上游发送和下游处理三部分。在下游处理部分，关于触发窗口计算的部分我们简单带过了，后面会再详细介绍这部分。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C# 正则表达式（2）：Regex 基础语法与常用 API 全解析]]></title>    <link>https://juejin.cn/post/7586505172815511603</link>    <guid>https://juejin.cn/post/7586505172815511603</guid>    <pubDate>2025-12-22T14:51:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586505172815511603" data-draft-id="7584824891595341860" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C# 正则表达式（2）：Regex 基础语法与常用 API 全解析"/> <meta itemprop="keywords" content="前端,C#,正则表达式"/> <meta itemprop="datePublished" content="2025-12-22T14:51:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="烛阴"/> <meta itemprop="url" content="https://juejin.cn/user/950397795841032"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C# 正则表达式（2）：Regex 基础语法与常用 API 全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/950397795841032/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    烛阴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T14:51:09.000Z" title="Mon Dec 22 2025 14:51:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、IsMatch 入门</h2>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Text.RegularExpressions;

<span class="hljs-keyword">class</span> <span class="hljs-title">Program</span>
{
    <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">Main</span>()</span>
    {
        <span class="hljs-built_in">string</span> input = <span class="hljs-string">"2025-12-18"</span>;
        <span class="hljs-built_in">string</span> pattern = <span class="hljs-string">@"^\d{4}-\d{2}-\d{2}$"</span>;

        <span class="hljs-built_in">bool</span> isValid = Regex.IsMatch(input, pattern);
        Console.WriteLine(isValid); <span class="hljs-comment">// True</span>
    }
}
</code></pre>
<p><strong>解析：</strong>：</p>
<ul>
<li><code>pattern</code> 是正则表达式，<code>@"..."</code> 是 C# 的逐字字符串字面量。</li>
<li><code>^</code> 和 <code>$</code>：锚点，表示“从头到尾整串匹配”</li>
<li><code>\d{4}</code>：4 位数字。</li>
<li><code>-</code>：字面量“-”。</li>
<li><code>Regex.IsMatch</code>：看字符串中是不是“满足这个模式”。</li>
</ul>
<hr/>
<h2 data-id="heading-1">二、C# Regex 的 5 个核心方法</h2>
<p>在 <code>System.Text.RegularExpressions.Regex</code> 里，最常用的就是这 5 个方法：</p>
<ol>
<li><code>IsMatch</code></li>
<li><code>Match</code></li>
<li><code>Matches</code></li>
<li><code>Replace</code></li>
<li><code>Split</code></li>
</ol>
<hr/>
<h2 data-id="heading-2">三、Regex.IsMatch：最常用的“判断是否匹配”</h2>
<p><code>IsMatch</code> 是表单校验、输入合法性检查中使用频率最高的方法。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">bool</span> isEmail = Regex.IsMatch(email, pattern);
</code></pre>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">string</span> input = <span class="hljs-string">"Order12345"</span>;
<span class="hljs-built_in">string</span> pattern = <span class="hljs-string">@"\d{3}"</span>;

<span class="hljs-built_in">bool</span> has3Digits = Regex.IsMatch(input, pattern); <span class="hljs-comment">// True</span>
</code></pre>
<p>注意点：</p>
<ul>
<li>默认只要“包含”满足 pattern 的子串，就返回 true，并不要求整个字符串都完全匹配。</li>
<li>如果你想“整个字符串必须符合这个规则”，要在 pattern 外面加上 <code>^</code> 和 <code>$</code>：</li>
</ul>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 只允许由 3~5 位数字组成，不允许多一个字符</span>
<span class="hljs-built_in">string</span> pattern = <span class="hljs-string">@"^\d{3,5}$"</span>;
</code></pre>
<hr/>
<h2 data-id="heading-3">四、Regex.Match：获取第一个匹配</h2>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">string</span> text = <span class="hljs-string">"My phone is 123-456-7890."</span>;
<span class="hljs-built_in">string</span> pattern = <span class="hljs-string">@"\d{3}-\d{3}-\d{4}"</span>;

Match match = Regex.Match(text, pattern);
<span class="hljs-keyword">if</span> (match.Success)
{
    Console.WriteLine(match.Value);  <span class="hljs-comment">// "123-456-7890"</span>
    Console.WriteLine(match.Index);  <span class="hljs-comment">// 起始索引</span>
    Console.WriteLine(match.Length); <span class="hljs-comment">// 匹配的长度</span>
}
</code></pre>
<p>常用成员：</p>
<ul>
<li><code>match.Success</code>：是否匹配成功。</li>
<li><code>match.Value</code>：匹配到的字符串。</li>
<li><code>match.Index</code>：匹配在原文本中的起始位置（从 0 开始）。</li>
<li><code>match.Length</code>：长度。</li>
</ul>
<p><code>Regex.Match</code> 也有带起始位置、带 <code>RegexOptions</code> 的重载：</p>
<hr/>
<h2 data-id="heading-4">五、Regex.Matches：获取所有匹配结果（多个）</h2>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">string</span> text = <span class="hljs-string">"ID: 100, 200, 300"</span>;
<span class="hljs-built_in">string</span> pattern = <span class="hljs-string">@"\d+"</span>;

MatchCollection matches = Regex.Matches(text, pattern);
<span class="hljs-keyword">foreach</span> (Match m <span class="hljs-keyword">in</span> matches)
{
    Console.WriteLine(<span class="hljs-string">$"<span class="hljs-subst">{m.Value}</span> at <span class="hljs-subst">{m.Index}</span>"</span>);
}
<span class="hljs-comment">// 输出:</span>
<span class="hljs-comment">// 100 at 4</span>
<span class="hljs-comment">// 200 at 9</span>
<span class="hljs-comment">// 300 at 14</span>
</code></pre>
<p><strong>解析：</strong></p>
<ul>
<li>返回的是一个 <code>MatchCollection</code>，可以 <code>foreach</code> 遍历。</li>
<li>每个 <code>Match</code> 和前面一样，有 <code>Value</code>、<code>Index</code>、<code>Groups</code> 等属性。</li>
</ul>
<hr/>
<h2 data-id="heading-5">六、Regex.Replace：按模式搜索并替换</h2>
<p><code>Regex.Replace</code> 和字符串的 <code>Replace</code> 很像，但支持模式匹配。</p>
<h3 data-id="heading-6">1. 固定字符串替换匹配内容</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">string</span> input = <span class="hljs-string">"2025/12/18"</span>;
<span class="hljs-built_in">string</span> pattern = <span class="hljs-string">@"/"</span>;

<span class="hljs-built_in">string</span> result = Regex.Replace(input, pattern, <span class="hljs-string">"-"</span>);
Console.WriteLine(result); <span class="hljs-comment">// "2025-12-18"</span>
</code></pre>
<p>这相当于“把所有 <code>/</code> 都换成 <code>-</code>”，和 <code>input.Replace("/", "-")</code> 类似，但 pattern 可以写得更复杂。</p>
<h3 data-id="heading-7">2.用捕获组重排内容</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">string</span> input = <span class="hljs-string">"2025-12-18"</span>;
<span class="hljs-built_in">string</span> pattern = <span class="hljs-string">@"(\d{4})-(\d{2})-(\d{2})"</span>;

<span class="hljs-comment">// 把 yyyy-MM-dd 改成 dd/MM/yyyy</span>
<span class="hljs-built_in">string</span> result = Regex.Replace(input, pattern, <span class="hljs-string">"$3/$2/$1"</span>);
<span class="hljs-comment">// result: "18/12/2025"</span>
</code></pre>
<p><strong>解析：</strong></p>
<p>这里的 <code>$1</code>、<code>$2</code>、<code>$3</code> 是捕获组</p>
<h3 data-id="heading-8">3. 更高级的 <code>MatchEvaluator</code> 版本</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">string</span> input = <span class="hljs-string">"Price: 100 USD, 200 USD"</span>;
<span class="hljs-built_in">string</span> pattern = <span class="hljs-string">@"(\d+)\s*USD"</span>;

<span class="hljs-built_in">string</span> result = Regex.Replace(input, pattern, m =&gt;
{
    <span class="hljs-built_in">int</span> <span class="hljs-keyword">value</span> = <span class="hljs-built_in">int</span>.Parse(m.Groups[<span class="hljs-number">1</span>].Value);
    <span class="hljs-built_in">int</span> converted = (<span class="hljs-built_in">int</span>)(<span class="hljs-keyword">value</span> * <span class="hljs-number">7.2</span>); <span class="hljs-comment">// 假设汇率</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">$"<span class="hljs-subst">{converted}</span> CNY"</span>;
});

Console.WriteLine(result);
<span class="hljs-comment">// "Price: 720 CNY, 1440 CNY"</span>
</code></pre>
<hr/>
<h2 data-id="heading-9">七、Regex.Split：按“模式”切割字符串</h2>
<blockquote>
<p>可以实现多分隔符的切割</p>
</blockquote>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">string</span> input = <span class="hljs-string">"apple, banana; cherry|date"</span>;
<span class="hljs-built_in">string</span> pattern = <span class="hljs-string">@"[,;|]\s*"</span>; <span class="hljs-comment">// 逗号；分号；竖线 + 可选空白</span>

<span class="hljs-built_in">string</span>[] parts = Regex.Split(input, pattern);

<span class="hljs-keyword">foreach</span> (<span class="hljs-keyword">var</span> p <span class="hljs-keyword">in</span> parts)
{
    Console.WriteLine(p);
}
<span class="hljs-comment">// apple</span>
<span class="hljs-comment">// banana</span>
<span class="hljs-comment">// cherry</span>
<span class="hljs-comment">// date</span>
</code></pre>
<hr/>
<h2 data-id="heading-10">八、正则基础语法（一）：字面字符与转义</h2>
<h3 data-id="heading-11">1. 字面字符</h3>
<p>绝大多数普通字符在正则里就是字面意思：</p>
<ul>
<li>模式：<code>abc</code> → 匹配文本中出现的 <code>abc</code>。</li>
<li>模式：<code>hello</code> → 匹配文本中出现的 <code>hello</code>。</li>
</ul>
<h3 data-id="heading-12">2. 特殊字符（元字符）</h3>
<p>这些字符在正则中有特殊含义：</p>
<ul>
<li><code>.</code> <code>^</code> <code>$</code> <code>*</code> <code>+</code> <code>?</code> <code>(</code> <code>)</code> <code>[</code> <code>]</code> <code>{</code> <code>}</code> <code>\</code> <code>|</code></li>
</ul>
<p>如果你要匹配其中任意一个“字面意义上的”字符，就要用 <code>\</code> 转义。</p>
<p>例如：</p>
<ul>
<li>匹配一个点号 <code>.</code> → 模式 <code>\.</code></li>
<li>匹配一个星号 <code>*</code> → 模式 <code>\*</code></li>
<li>匹配一对括号 <code>(abc)</code> → 模式 <code>\(</code> + <code>abc</code> + <code>\)</code></li>
</ul>
<p>在 C# 中配合逐字字符串：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">string</span> pattern = <span class="hljs-string">@"\."</span>;   <span class="hljs-comment">// 匹配 "."</span>
<span class="hljs-built_in">string</span> pattern2 = <span class="hljs-string">@"\*"</span>;  <span class="hljs-comment">// 匹配 "*"</span>
</code></pre>
<p>如果不用 <code>@</code>：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">string</span> pattern = <span class="hljs-string">"\\."</span>;   <span class="hljs-comment">// C# 字符串里写成 "\\." 才表示一个反斜杠+点</span>
</code></pre>
<p>实践中几乎所有正则字符串都用 <code>@""</code>，可以少一半反斜杠。</p>
<hr/>
<h2 data-id="heading-13">九、正则基础语法（二）：预定义字符类 \d / \w / \s</h2>
<p>预定义字符类是正则里最常用的工具，它们代表一类字符。</p>
<h3 data-id="heading-14">1. <code>\d</code> / <code>\D</code>：数字与非数字</h3>
<ul>
<li><code>\d</code>：digit，匹配 0–9 的任意一位数字，相当于 <code>[0-9]</code>。</li>
<li><code>\D</code>：非数字，相当于 <code>[^0-9]</code>。</li>
</ul>
<p><strong>示例：匹配一个或多个数字</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">string</span> pattern = <span class="hljs-string">@"\d+"</span>;
</code></pre>
<h3 data-id="heading-15">2. <code>\w</code> / <code>\W</code>：单词字符与非单词字符</h3>
<ul>
<li><code>\w</code>：word，匹配字母、数字和下划线，相当于 <code>[A-Za-z0-9_]</code>。</li>
<li><code>\W</code>：非 <code>\w</code>。</li>
</ul>
<p><strong>示例：匹配“单词”（一串字母数字下划线）</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">string</span> pattern = <span class="hljs-string">@"\w+"</span>;
</code></pre>
<h3 data-id="heading-16">3. <code>\s</code> / <code>\S</code>：空白字符与非空白字符</h3>
<ul>
<li><code>\s</code>：space，匹配空格、制表符、换行等所有空白字符。</li>
<li><code>\S</code>：非空白。</li>
</ul>
<p><strong>示例：</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-built_in">string</span> pattern = <span class="hljs-string">@"\s+"</span>; <span class="hljs-comment">// 匹配一个或多个空白</span>
</code></pre>
<h2 data-id="heading-17">结语</h2>
<p><strong>点个赞，关注我获取更多实用 C# 技术干货！如果觉得有用，记得收藏本文</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[年终总结 - 2025 故事集]]></title>    <link>https://juejin.cn/post/7586555198114906118</link>    <guid>https://juejin.cn/post/7586555198114906118</guid>    <pubDate>2025-12-22T14:51:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586555198114906118" data-draft-id="7581669438577492004" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="年终总结 - 2025 故事集"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2025-12-22T14:51:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jimmy"/> <meta itemprop="url" content="https://juejin.cn/user/1996368846261294"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            年终总结 - 2025 故事集
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1996368846261294/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jimmy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T14:51:56.000Z" title="Mon Dec 22 2025 14:51:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>📕 如果您刚好点了进来，却不想完整阅读该文章但又想知道它记录了什么。可跳到文末<strong>总结</strong>。</p>
</blockquote>
<h3 data-id="heading-0">前言</h3>
<p>时隔<strong>四个月</strong>，再执笔即将进入了新的一年 <strong>2026</strong> 年...</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d39e86c88d24a34a1e6be79e2176d15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmltbXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767019916&amp;x-signature=FWtDt6c58P4%2Bkncx8T%2BYdbbOqcs%3D" alt="2025 &amp; 2026" loading="lazy"/></p>
<p>时间像往常一样无声息地流动，已近年尾，在过去的 <strong>2025</strong> 年，三百多天时间里面，发生了很多的事情，或喜，或悲，或静，或闹...此时，灯亮着，窗外偶尔有远处汽车的沙沙声。我在其中，开始回顾并记录撞进心底的瞬间和感受。</p>
<h3 data-id="heading-1">你好，世界</h3>
<p>还是<strong>熟悉的四月份</strong>的一天凌晨，老妈跟我在走廊里踱步~</p>
<p>随着清脆的哭声响起，二宝如期而至。过了段时间，护士出来报出<strong>母女平安</strong>是我们听到的此刻最让人心安的话语。</p>
<blockquote>
<p>为什么说是<strong>熟悉的四月份</strong>，因为老大也是四月份出生的</p>
</blockquote>
<p>因为老婆在工作日凌晨分娩，所以我的休陪产的单也先提交了。在收到老婆产后无需我协助事情的话语后，我撤销了陪产单，屁颠屁颠地去上班赚奶粉钱了😄</p>
<p>嗯，从<a href="https://juejin.cn/post/7338255194608255003#heading-2" target="_blank" title="https://juejin.cn/post/7338255194608255003#heading-2">准奶爸</a>到首次<a href="https://juejin.cn/post/7455315760274751507#heading-2" target="_blank" title="https://juejin.cn/post/7455315760274751507#heading-2">喜当爹</a>至今，短短三年时间里面，自己已经是两个小孩的爸爸，真是一个让自己意想不到的速度。</p>
<p>自从当了父母之后，我们更加懂得自己父母的<strong>无私且伟大</strong>，孩子的<strong>天真和无知</strong>。</p>
<p>相对于第一次喜当爹时候，自己慌张无措，老妈辛苦地忙前忙后，手慌脚乱。有了第一次的经验，我们对于二宝的处理还是挺稳定：</p>
<ul>
<li>在预产期临近的两三天，我们准备好了大包小包的待产包 -&gt; <strong>alway stand by</strong></li>
<li>产后的三天时间，请护工照看老婆和新生儿，老妈在旁边陪同，老爸在家照看大宝</li>
<li>出院后，老婆和二宝直接月子中心坐月子。老妈和我在家照看大宝，周末月子中心看二宝</li>
</ul>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/62c883b4c9074c5da6ad03bacd1fdb8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmltbXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767019916&amp;x-signature=ZSaUqYEJcLROtBKwLUAb75q2txU%3D" alt="daughters in nursing room" loading="lazy"/></p>
<p align="center">👆即将出月子中心，大宝和二宝的合影👆</p>
<h3 data-id="heading-2">在日常里接力的我们</h3>
<p>每天，我们都觉得时间不够用，能留出些许空间和时间来放松，已经很满足😌</p>
<h4 data-id="heading-3">老婆来回奔波的工作日</h4>
<p>在休完三个多月的产假之后，老婆就去复工了。因为二宝还小，老婆会每天中午都回来哺乳。从小孩三个多月到七个多月，雷打不动，公司和家两头跑。</p>
<p>那一台小电驴，隔三差五就需要去充电。小小电驴，已经超出了它的价值~</p>
<p>好不容易，让二宝断奶了。断奶是件很痛苦的事情，要熬夜，涨奶胸痛等。我还记得在成功断奶后的那天晚上，老婆还特意叫我出去买瓶酒回来庆祝一下✨</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e41ff5a6b3ca429ab84f20485e7acbb2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmltbXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767019916&amp;x-signature=Ik%2BylNdo7wMSNSpt%2F3sWpBmx0R4%3D" alt="beer" loading="lazy"/></p>
<p align="center">👆5%-8% vol 的鸡尾酒👆</p>
<p>虽然二宝断奶了，但是老婆在工作不忙的时候，还是会中午回来看看。用我老婆的话说：<strong>有点讨厌，但是又有点舍不得二宝</strong>。</p>
<h4 data-id="heading-4">工作日，爷爷奶奶的时光</h4>
<p>老婆跟我，工作日都需要上班，嗯~赚奶粉钱😀</p>
<p>然后，两个宝宝，工作日的时候主要给爷爷和奶奶带。</p>
<p>有时候，两个宝宝都需要奶奶抱，这可苦了奶奶的腰板子了。爷爷更多的时候，是充当了厨师的角色，保证一家人的三餐伙食，嗯~<strong>老爸的厨艺真好</strong>👍</p>
<p>爷爷奶奶一天下来的流程：早上带娃出去晒太阳，遛娃（主要是让大宝动起来，中午好睡觉）；中午喂饭，午休（大宝一般中午休息两个钟，下午三或四点起来）；下午洗澡（怕冷着小孩，一般天黑前洗完），喂饭，陪玩；晚上，等老婆和我下班回来，爷爷和奶奶才有空闲的时间。一般这个时候，爷爷就喜欢下楼去周边逛，奶奶就会躺着床上直一下腰板子（有时会跟爷爷下楼逛街）。工作日的时候，如果奶奶晚上没有出去逛街，那么，会在九点多喂完奶给大宝，奶奶会哄大宝睡觉；如果奶奶外出，那么我就会哄大宝睡觉。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1890196a31384edcb04b256d1b9bd94a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmltbXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767019916&amp;x-signature=%2BVtv%2BxavORCaHUjeAo5AkApEtUE%3D" alt="mother's birthday" loading="lazy"/></p>
<p align="center">👆奶奶生日的时候，两宝和爷爷奶奶合影👆</p>
<h4 data-id="heading-5">休息日，我们的时光</h4>
<p><strong>工作日，班上完了；休息日，该带娃了</strong>。爷爷奶奶休息日放假，想去哪里就去哪里，放松放松。</p>
<p>休息日带娃，我们的宗旨就是：<strong>尽量让娃多动</strong>。所以，我们基本都会外出。忙忙碌碌，嗯，我们分享两件事情：</p>
<p>我还记得，某个周末，我们在商场逛了一天，让大宝在商场里面走，她逛得贼开心（这可不，逛得有多累，睡得有多香），推着二宝。中午直接在商场里面解决吃饭的问题，大宝直接在婴儿车上解决了午睡的事情，二宝则是被老婆或者我背在身上睡觉。母婴室没人的时候，我们就会在里面小憩一会。等两宝醒来之后，再逛一下，<strong>一天的时间过得慢但是又很快</strong>。</p>
<p>今年的国庆连着中秋，我们在这个长假期里面，会带他们在小区里面露营（在草坪上铺一垫子），让她们自己玩。大宝走路的年纪，这里走那里走，我得<strong>屁颠屁颠</strong>跟她后面，从这里把她抱过来那里，从那边把她哄过来这边，<strong>真想拿条链子绑着她</strong>。相反，二宝就淡定多了，只能在那块布那里爬来爬去，被她妈妈限制着。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0be16f71224949b9911866ea57997786~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmltbXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767019916&amp;x-signature=gGHOOW9RyDB75S1OU4r6XyjPB%2FE%3D" alt="Mid-Autumn Festival" loading="lazy"/></p>
<p align="center">👆中秋节当晚，在哄两娃睡着后，老婆跟我在阳台拜月👆</p>
<h3 data-id="heading-6">没有惊喜的工位</h3>
<p>相对于上一年工作的惊吓，今年的工作可以用没有惊喜来形容。</p>
<blockquote>
<p>至于为什么说上一年是惊吓，今年没有惊喜。后面有时间，会出一篇文章来分享下。</p>
</blockquote>
<p>简简单单的工位，一水杯，一记事本，一台式电脑，一绿植。屁股一坐，一整天嗖一下就过去了~</p>
<p>在公司，让我活跃起来的，就是<strong>中午</strong>吃饭的时候。我们的小团体（一安卓，一产品和我）开车去周边吃饭。这段时间，是我们唠嗑的时间，无拘无束，即使我们偶尔会浪费掉午休的时间，但是我还是觉得挺不错的，时间花得值...</p>
<p>工作上糟心的事十根手指可数不过来，触动且温暖了心窝的事情屈指可数。</p>
<p>记得招进来的一个新人，我带了他几天，最后入职短短几天被某人恶心而离职了。他离职的前一天，点了一杯奶茶给我，虽然自己嘴里面说着别客气，但是心里面暖暖的。他才进来短短几天就走人了，自己心里莫名生气：为什么我自己招的人，自己带着熟悉项目后，一转手就被恶心到要离职了？？？最终他却还<strong>温柔地</strong>以自我问题作离职的原因。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1645ba344d694632bb38142173e05302~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmltbXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767019916&amp;x-signature=WhCPiwcJ8giirpRx5VskgCYb8oI%3D" alt="colleague communication" loading="lazy"/></p>
<p align="center">👆点了份奶茶放我桌面后的对话👆</p>
<h3 data-id="heading-7">把明天轻轻放进心里</h3>
<p><strong>2026 年</strong>悄然将至。在对新的一年有所展望之前，我们先回顾下<a href="https://juejin.cn/post/7455315760274751507" target="_blank" title="https://juejin.cn/post/7455315760274751507">年终总结 - 2024 故事集</a>中立下的两个 <code>Flags</code> 和完成的情况：</p>























<table><thead><tr><th>序号</th><th>目标</th><th>实际</th><th>完成率</th></tr></thead><tbody><tr><td>1</td><td>分享文章 <strong>20+</strong> 篇</td><td>分享文章 <strong>18</strong> 篇</td><td>90%</td></tr><tr><td>2</td><td>锻炼 <strong>30+</strong> 次</td><td>锻炼 <strong>32</strong> 次</td><td>107%</td></tr></tbody></table>
<p>嗯~ 目标完成率还不赖。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac82e714d32c46ed967524500f9d5155~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmltbXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767019916&amp;x-signature=xqUjmOxcHSg73xV4%2BQ8mJEWUHXA%3D" alt="do execise" loading="lazy"/></p>
<p align="center">👆每次锻炼我都会在朋友圈记录，每次耗时 45 分钟左右👆</p>
<p>对于分享文章，一开始就是<strong>秉承着记录自己在工作中遇到的一些问题，方便自己和其他人查找的宗旨</strong>来进行记录，后面是因为平台搞了奖励而进行的一些创作。而现在，随着 <code>chatgpt</code>, <code>deepseek</code> 等大语言模型的机器人横空出世，浅显的分享和问题的记录都显得<strong>鸡肋</strong>。所以，在 2026 新的一年内，文章的分享要更加有目的性和实际的意义。2026 年，谁知道会有几篇文章会出炉，也许一篇，也许十篇，也许二十篇，也许零篇。</p>
<p>对于锻炼，这是我长期需要坚持的一件事情，也是最好量化的事情。在新的一年里面，锻炼的次数需 <code>35+</code> 。</p>
<p>为人父母，为人儿女。我们都有自己的那份责任，2026 年，希望自己更多的时间是回归家庭 - 去听听孩子的欢声笑语，去看看爸妈脸上的笑容，去体验大家聚在一起热热闹闹的氛围 <strong>and more</strong></p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70f2a49cb51b43b499d1f06286512f40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmltbXk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767019916&amp;x-signature=WexaN1iOl67dRdstSurrcOlWPN8%3D" alt="family gathering" loading="lazy"/></p>
<p align="center">👆老爸生日，大姐，二姐大家的娃聚在一起👆</p>
<h3 data-id="heading-8">总结</h3>
<p><strong>2025</strong> 年，简简单单却忙忙碌碌👇：</p>
<p>在生活方面，欢迎二宝加入大家庭。这让我们接下来的一年时间里面，时间安排更加充实紧凑，更感受到当爹妈的不容易，感恩自己的父母在以前那年代含辛茹苦带大了我们三姐弟。在工作方面，没有太多想记录的东西，平平淡淡地打卡上下班。</p>
<p>展望 <strong>2026</strong>，还是给自己制定了锻炼次数的量化目标。在这个人工智能逐渐成熟的环境下，希望自己能够使用它提升工作效率和帮助自己成长。在 <strong>2026</strong> 年，自己的重心会放在家庭这边，去感受孩子的成长和家的氛围。</p>
<p align="right"><b>完成于中国广东省广州市</b></p>
<p align="right"><b>2025 年 12 月 22 日</b></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[听一听技术面试官的心路历程：他们也会有瓶颈，也会表现不如人意]]></title>    <link>https://juejin.cn/post/7586490798432239679</link>    <guid>https://juejin.cn/post/7586490798432239679</guid>    <pubDate>2025-12-22T14:54:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586490798432239679" data-draft-id="7586491717873778707" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="听一听技术面试官的心路历程：他们也会有瓶颈，也会表现不如人意"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-22T14:54:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="uzong"/> <meta itemprop="url" content="https://juejin.cn/user/372082495985181"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            听一听技术面试官的心路历程：他们也会有瓶颈，也会表现不如人意
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/372082495985181/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    uzong
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T14:54:23.000Z" title="Mon Dec 22 2025 14:54:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">听一听技术面试官的心路历程：他们也会有瓶颈，也会表现不如人意</h2>
<p>很多人以为，坐在面试桌对面的技术面试官，手握生杀大权，只需“考倒”候选人便算完成任务。但其实，真正优秀的面试官，并不是为了设卡，而是为了“发现”——发现那些有潜力、能与团队长期共成长的人。</p>
<p>我做技术面试官已有多年，从最初照本宣科地问八股文，到如今更关注候选人的思维模式、协作意识和成长轨迹，这一路走来，自己也在不断被重塑。今天想和大家聊聊，一个真实、有血有肉的技术面试官，在这场双向奔赴中，是如何自我成长的，又遇到了哪些瓶颈。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0838d1d70de34b66bd5d604c05cd6092~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767020063&amp;x-signature=subt5pHAdKdhqR58LBOSQnmBDAY%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-1">面试官的第一课：准备、氛围与反馈</h3>
<p>成为合格面试官的基础，远不止“会写代码”。</p>
<ul>
<li><strong>准备充分</strong>：提前阅读简历，设计有针对性的问题，而不是临时起意问“你用过 Redis 吗？”</li>
<li><strong>营造安全氛围</strong>：让候选人放松下来，才能看到真实的水平。紧张之下，再优秀的人也可能语无伦次。</li>
<li><strong>及时反馈</strong>：面试结束不是终点。快速记录关键观察点，与团队共享评估，避免主观偏差累积。</li>
</ul>
<p>这些看似基础的要求，恰恰是区分“走过场”和“真识人”的分水岭。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b309f381031b40508c5cf2836d4931c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767020063&amp;x-signature=Gkt4w591vunnqeWXdvxkQVeAKsA%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-2">当候选人自称“架构师”，期待值就变了</h3>
<p>有一次，一位候选人简历上写着“主导过千万级用户系统的架构设计”。那一刻，我对他的整体要求自然提高了——不仅要看技术深度，还要看系统性思维、权衡能力、甚至对业务的理解。</p>
<p>如果实际表现与标签严重不符，落差感会让整个面试体验变得尴尬。这种“高开低走”的情况，往往比平庸更令人失望。因为这不只是能力问题，更是诚信与自我认知的问题。</p>
<p>反过来，当遇到真正思维缜密、表达清晰、自信而不自负的候选人时，那种交流本身就是一种滋养。即使最终他选择了别家公司，我也常会想：“和这样的人聊一小时，胜过自己闷头写三天代码。”</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f68d5d24c87e4923b0c50c36dedbab9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767020063&amp;x-signature=4EQODW16XkdpU%2FiftU0xrId49j0%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-3">双向选择，从来不是客套话</h3>
<p>越来越多的优秀人才在面试中展现出强烈的主体意识。他们不仅回答问题，也在评估我们：团队是否专业？技术氛围是否开放？Leader 是否值得追随？</p>
<p>曾有一位候选人后来告诉我：“之所以选择你们，是因为和你那轮面试聊得很透，感觉你们真的在认真做事。” 这句话让我欣慰很久——原来我的提问方式、倾听态度，甚至对技术细节的追问，都在无形中传递着团队的“味道”。</p>
<p>当然，也有遗憾。有些通过全部面试的候选人，最终去了薪资更高、平台更大的公司。我们尊重他们的选择，也承认：人才流动本就是市场的常态。但每一次高质量的对话，都是一次自我校准的机会。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e47baca48b7e4e1692738c896958ef18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767020063&amp;x-signature=eMCpKn60SNtp2H%2Bjd1y44m3rHEw%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-4">警惕那些“滑头”的套路</h3>
<p>不是所有候选人都在真诚交流。有些人擅长把具体问题引向抽象方法论：“这个问题关键在于顶层设计”“我们要建立长效机制”……听起来高屋建瓴，实则回避技术细节。</p>
<p>这类“职场老油条”，往往缺乏真正的工程手感。他们用话术掩盖能力的空洞，用流程代替思考。作为面试官，必须练就一双“去噪”的耳朵——在华丽辞藻中捕捉真实信号。</p>
<hr/>
<h3 data-id="heading-5">工具箱里的实用方法</h3>
<p>这些年，我逐渐积累了一些有效的考察手段：</p>
<ul>
<li><strong>情景模拟</strong>：比如“现在短链系统崩溃了，客户投诉不断，你如何在10分钟内定位并缓解？”</li>
<li><strong>代码评审视角</strong>：不只看对错，更看候选人是否关注可维护性、边界条件、日志设计等工程细节。</li>
<li><strong>组合拳追问</strong>：一个问题连环深挖，直到触及底层逻辑。比如从“你怎么优化接口性能？”一路问到缓存策略、数据库索引、网络传输开销。</li>
</ul>
<p>对于资深候选人，我们更看重系统性、全局观，而非某个 API 的用法。</p>
<hr/>
<h3 data-id="heading-6">常见误区：别被标签绑架</h3>
<ul>
<li>过度迷信“大厂背景”或“名校学历”；</li>
<li>被精心包装的项目经历迷惑；</li>
<li>无意识地因年龄、性别、学历产生偏见。</li>
</ul>
<p>真正的评估，应回归到“这个人能不能解决问题、愿不愿意协作、有没有持续成长的意愿”。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2d637a4aacd43c4923c7e56b228e937~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767020063&amp;x-signature=kkBWCiyGb%2B5EGt78HeN7F%2Fa2dic%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-7">六个核心维度，缺一不可</h3>
<ol>
<li><strong>技术能力</strong>：不考死记硬背，而看解题思路与优化过程。鼓励“边写边讲”，暴露思维路径。</li>
<li><strong>问题解决</strong>：用开放性问题观察其拆解、假设、验证的能力。STAR 原则很有效。</li>
<li><strong>学习潜力</strong>：问“最近学了什么新技术？”看他是否主动探索、总结、分享。</li>
<li><strong>沟通协作</strong>：能否清晰表达？是否主动确认需求？面对分歧如何处理？</li>
<li><strong>责任心</strong>：在项目中是“我推动了”还是“我们做了”？失败时是否甩锅？</li>
<li><strong>文化匹配</strong>：他理想中的团队是什么样？是否认同我们的节奏与价值观？</li>
</ol>
<p>所谓“对味”，其实就是这些维度综合作用下的直觉判断——但它必须建立在扎实的观察之上，而非玄学。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/844a7c8c1ba74c3e946d41f73fe81575~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767020063&amp;x-signature=ZBhdPCdYN7vwyGDC3DvdxWMKPLU%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-8">不同岗位，不同视角</h3>
<p>作为团队负责人，我常要面试前端、测试、产品等非后端角色。这时，技术细节反而退居其次，更关注：</p>
<ul>
<li>逻辑是否严谨？</li>
<li>分析是否透彻？</li>
<li>表达是否清晰？</li>
<li>是否具备结构化思维、抽象能力和批判性思考？</li>
</ul>
<p>比如问前端：“你如何从收到一个线上 bug 到最终闭环？” 看的是全流程意识，而非只会调样式。</p>
<hr/>
<h3 data-id="heading-9">高阶识人：压力、沉默与失败</h3>
<p>真正考验一个人的，不是顺境中的表现，而是逆境中的反应。</p>
<ul>
<li><strong>压力测试</strong>：故意质疑方案，“太复杂了，有没有更简单的？” 观察其是否慌乱、防御，还是冷静调整。</li>
<li><strong>沉默压迫</strong>：在关键回答后保持安静，看他是否会主动补充、反思——这是 ownership 的体现。</li>
<li><strong>失败复盘</strong>：比起成功案例，我更爱问：“你做过最失败的技术决策是什么？”<br/>
优秀者会坦然承认错误，分析根因，并推动系统性改进（如引入自动化测试）。</li>
</ul>
<p>这些方法，适用于中高级岗位，能有效区分“执行者”和“主导者”。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/853f4059e5c943439a0c6cc87a738cb1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767020063&amp;x-signature=Te7oyVNjioYBsPkqkztfKDs4yPU%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-10">面试官的瓶颈：我们也在挣扎</h3>
<p>别以为面试官总是游刃有余。事实上，我们同样面临诸多困境：</p>
<ol>
<li><strong>评估维度单一</strong>：只看编码，忽略协作、成长性；</li>
<li><strong>主观偏见</strong>：凭感觉打分，缺乏一致性；</li>
<li><strong>知识滞后</strong>：对新兴技术不熟，问题陈旧；</li>
<li><strong>角色局限</strong>：只当“守门人”，忽视候选人体验；</li>
<li><strong>缺乏方法论</strong>：面试随意，评分模糊；</li>
<li><strong>精力枯竭</strong>：每周面10+人，后期标准松动；</li>
<li><strong>培训缺失</strong>：不会追问，听不出真假；</li>
<li><strong>领域盲区</strong>：跨岗面试时力不从心；</li>
<li><strong>思维固化</strong>：只找“像自己的人”，扼杀多样性；</li>
<li><strong>决策疲劳</strong>：因急招而“将就”，埋下隐患。</li>
</ol>
<p>这些问题，每一个都可能让一次本该精准的评估，变成一场误判。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4eb8466bab2946b9bb581990c9f40a93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767020063&amp;x-signature=GquzLvuKl3RCeZbej%2BdIPMGSZEI%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-11">如何突破？三个方向</h3>
<ol>
<li><strong>建立结构化评估框架</strong><br/>
不同职级，权重不同。初级重基础与学习力，高级重系统设计与影响力。与岗位胜任力模型对齐。</li>
<li><strong>拥抱行为面试与情境模拟</strong><br/>
少问“Redis 有几种数据类型”，多问“请讲一个你解决过的最复杂技术难题”。用真实场景代替知识问答。</li>
<li><strong>持续学习，反哺团队</strong><br/>
定期研究行业趋势，参与技术分享。把面试中发现的共性问题（如多数人不懂可观测性），转化为团队能力建设议题。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/176ce52ff1d64de7a89980ea39879836~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767020063&amp;x-signature=2aGZrJN51yaNIgXjV22W631qTtU%3D" alt="" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-12">最后几句心里话</h3>
<ul>
<li><strong>宁可错过，不要错招</strong>。一个不合适的人，对团队的伤害远大于空缺。</li>
<li><strong>强者吸引强者</strong>。你提问的质量，代表团队的专业水准。</li>
<li><strong>面试是镜子</strong>。你在评估别人，别人也在评估你。每一次对话，都是组织形象的投射。</li>
</ul>
<p>技术面试官，不该是冷冰冰的筛选机器，而应是人才与组织之间的桥梁。这条路没有终点，只有持续精进。</p>
<p>毕竟，<strong>识人，终究是一场对自我的修行</strong>。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[没开挂！英伟达开源“通玩千款游戏”的AI模型，只为给机器人造个脑子]]></title>    <link>https://juejin.cn/post/7586518130761367592</link>    <guid>https://juejin.cn/post/7586518130761367592</guid>    <pubDate>2025-12-22T15:01:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586518130761367592" data-draft-id="7586493936677699624" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="没开挂！英伟达开源“通玩千款游戏”的AI模型，只为给机器人造个脑子"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2025-12-22T15:01:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            没开挂！英伟达开源“通玩千款游戏”的AI模型，只为给机器人造个脑子
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T15:01:50.000Z" title="Mon Dec 22 2025 15:01:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果说ChatGPT读完了人类互联网所有的书，那么英伟达刚刚开源的NitroGen，就是那个在网吧里泡了4万个小时、看遍了所有大神操作的“超级玩家”。</p>
<p>就在最近，英伟达联合斯坦福、加州理工搞了个大动作，正式开源了名为NitroGen的视觉-动作基础模型。这一手操作直接在AI圈和游戏圈炸了锅。这可不是那种只会跑固定脚本的简陋外挂，而是一个真正长了眼睛、会思考、能操作手柄的通用智能体。</p>
<p>很多人第一反应是：英伟达这是要搞个全能代练？其实，这盘棋下得比你想象的要大得多。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Fasdafsdgfg-1024x429.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/asdafsdgfg-1024x429.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a746944751e045deaec88fa5df53b3e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767020509&amp;x-signature=FEfP4HDDEoLVCAFQINhM4VZWMZI%3D" alt="asdafsdgfg" loading="lazy"/></a></p>
<p><strong>它凭什么能通关一千款游戏？</strong></p>
<p>以往的游戏AI，大多是“专才”。下围棋的AlphaGo不会打星际，打Dota的OpenAI Five不会玩超级马里奥。但NitroGen主打就是一个“全能”。</p>
<p>它的训练数据堪称恐怖：40,000小时的公开游戏视频，覆盖了超过1,000款游戏。从《巫师3》这种复杂的3A大作，到《赛博朋克2077》的霓虹夜景，再到各种横版跳跃小游戏，它全都要。</p>
<p>但最绝的不是数据量，而是它“偷师”的方法。</p>
<p>我们都知道训练AI最贵的是人工标注数据。英伟达的研究团队这次想了个天才般的点子：他们专门去找那些带有“手柄按键显示层”的游戏直播录像。通过算法，把视频里玩家按下的键位自动提取出来，直接对应到当时的游戏画面上。这样一来，不仅省了巨额的人工费，还直接让AI学会了人类高手的操作逻辑。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Fdafsdgdfg-1024x322.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/dafsdgdfg-1024x322.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3016330c2cba46e48c2320edf6bd3667~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767020509&amp;x-signature=UiQ3rT9t8Vt8FlGEoRmbqWp3yNM%3D" alt="dafsdgdfg" loading="lazy"/></a></p>
<p><strong>这不只是玩游戏，这是机器人的模拟考</strong></p>
<p>NitroGen的各种技术指标确实亮眼。比如它的架构魔改自英伟达的机器人模型GR00T，它是纯视觉驱动的——也就是说，它像人一样盯着屏幕看像素，然后输出手柄指令，而不是去读取游戏后台内存数据作弊。</p>
<p>在测试中，即便把NitroGen扔到一个它从未见过的全新游戏里，稍微给点数据微调一下，它的上手速度比从零训练的模型快得多，任务成功率最高能提升52%。这意味着它已经掌握了一套通用的“游戏语法”。</p>
<p>但如果你以为黄仁勋花大钱搞这个只是为了在游戏里虐菜，那就格局小了。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Ffsdgfdgdfg-1024x377.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/fsdgfdgdfg-1024x377.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10f0feb7064a4acaa14ae0869d81503f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767020509&amp;x-signature=4brbTowW%2FXwkoF7%2BXu9Ibd6q8WI%3D" alt="fsdgfdgdfg" loading="lazy"/></a></p>
<p>英伟达机器人总监Jim Fan直接点破了天机：电子游戏是训练“具身智能”最完美的模拟宇宙。</p>
<p>现实世界太复杂、容错率太低，你不能让一个刚出厂的机器人去厨房练切菜，切到手或者烧了厨房代价太大。但游戏世界物理规则自洽、反馈即时。如果一个AI能学会在《赛博朋克》里开车、在《古墓丽影》里攀岩、在《我的世界》里合成工具，那么这种对环境的感知力、决策力，是可以迁移到现实世界的机器人身上的。</p>
<p>NitroGen就是英伟达给未来机器人准备的“大脑预演”。</p>
<p><strong>开源的意义：具身智能的GPT时刻？</strong></p>
<p>最让开发者兴奋的是，英伟达这次非常敞亮。</p>
<p>项目主页、论文、代码仓库、甚至连预训练的模型权重和那4万小时处理过的数据集，全部在Hugging Face上开源了。这意味着，全球的研究者不需要再去重复造轮子，直接可以在NitroGen的基础上，去训练针对特定游戏的超强AI，或者是验证新的机器人算法。</p>
<p>我们正在见证一个有趣的转折点：以前我们教AI玩游戏是为了娱乐，现在AI玩游戏，是为了学会如何在这个物理世界中生存和工作。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2025%2F12%2Frghtyhyth-1024x446.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2025/12/rghtyhyth-1024x446.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7f0729babac4705ae882b12ea197925~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767020509&amp;x-signature=CmONyIjEwircIPq38Ojl1LXNd7M%3D" alt="rghtyhyth" loading="lazy"/></a></p>
<p>对于NitroGen来说，通关一千款游戏只是热身，它的星辰大海，是走出屏幕，走进现实。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[求1~n的累加和]]></title>    <link>https://juejin.cn/post/7586479864272224262</link>    <guid>https://juejin.cn/post/7586479864272224262</guid>    <pubDate>2025-12-22T13:04:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586479864272224262" data-draft-id="7586479864272191494" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="求1~n的累加和"/> <meta itemprop="keywords" content="C++"/> <meta itemprop="datePublished" content="2025-12-22T13:04:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ozyzo"/> <meta itemprop="url" content="https://juejin.cn/user/458965109710202"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            求1~n的累加和
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/458965109710202/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ozyzo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T13:04:39.000Z" title="Mon Dec 22 2025 13:04:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">代码如下:</h2>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span>

<span class="hljs-comment">// 计算1-n的和</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">sum</span><span class="hljs-params">(<span class="hljs-type">int</span> n)</span> {
    <span class="hljs-type">int</span> result = <span class="hljs-number">0</span>;
    <span class="hljs-comment">// 循环累加1到n</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt;= n; i++) {
        result += i;
    }
    <span class="hljs-comment">// 输出结果（修正原printf的错误格式）</span>
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"1到%d的和是：%d\n"</span>, n, result);
}

<span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">()</span> {
    <span class="hljs-type">int</span> n;
    <span class="hljs-built_in">printf</span>(<span class="hljs-string">"请输入n的值："</span>);
    <span class="hljs-comment">// 读取用户输入的n</span>
    <span class="hljs-built_in">scanf</span>(<span class="hljs-string">"%d"</span>, &amp;n);
    <span class="hljs-comment">// 调用sum函数计算并输出</span>
    sum(n);
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h2 data-id="heading-1">运行结果如下:</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c37c9f0096542d2a6a487e39235b1b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgb3p5em8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767013479&amp;x-signature=UXBRuJ5hkWUrLk5muq2fSSIyYLw%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C#/.NET/.NET Core技术前沿周刊 | 第 64 期（2025年12.1-12.21）]]></title>    <link>https://juejin.cn/post/7586479864272273414</link>    <guid>https://juejin.cn/post/7586479864272273414</guid>    <pubDate>2025-12-22T13:10:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586479864272273414" data-draft-id="7586540799250251830" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C#/.NET/.NET Core技术前沿周刊 | 第 64 期（2025年12.1-12.21）"/> <meta itemprop="keywords" content="后端,.NET"/> <meta itemprop="datePublished" content="2025-12-22T13:10:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="追逐时光者"/> <meta itemprop="url" content="https://juejin.cn/user/2770425031690333"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C#/.NET/.NET Core技术前沿周刊 | 第 64 期（2025年12.1-12.21）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2770425031690333/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    追逐时光者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T13:10:25.000Z" title="Mon Dec 22 2025 13:10:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c18034479dd44be9df41606958a5cb6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767013824&amp;x-signature=tbm%2Br6zqJBf9Ps8QxXvc3OippyE%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">前言</h2>
<p>C#/.NET/.NET Core技术前沿周刊，你的每周技术指南针！记录、追踪C#/.NET/.NET Core领域、生态的每周最新、最实用、最有价值的技术文章、社区动态、优质项目和学习资源等。让你时刻站在技术前沿，助力技术成长与视野拓宽。</p>
<blockquote>
<p>欢迎投稿、推荐或自荐优质文章、项目、学习资源等。</p>
</blockquote>
<ul>
<li><strong>🏆技术前沿周刊Gitee开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fysgdaydayup%2FDotNetGuide%2Fblob%2Fmain%2Fdocs%2FDotNet%2FDotNetWeekly.md" target="_blank" title="https://gitee.com/ysgdaydayup/DotNetGuide/blob/main/docs/DotNet/DotNetWeekly.md" ref="nofollow noopener noreferrer">gitee.com/ysgdaydayup…</a></li>
<li><strong>📰技术前沿周刊GitHub开源地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FYSGStudyHards%2FDotNetGuide%2Fblob%2Fmain%2Fdocs%2FDotNet%2FDotNetWeekly.md" target="_blank" title="https://github.com/YSGStudyHards/DotNetGuide/blob/main/docs/DotNet/DotNetWeekly.md" ref="nofollow noopener noreferrer">github.com/YSGStudyHar…</a></li>
</ul>
<h2 data-id="heading-1">精选 8 个 .NET 开发实用的类库，效率提升利器！</h2>
<ul>
<li><strong>文章简介：</strong> 精选 8 个 .NET 开发实用的类库，.NET 开发效率提升利器！</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FhzHCwM3BaUyZO9HCqODIEQ" target="_blank" title="https://mp.weixin.qq.com/s/hzHCwM3BaUyZO9HCqODIEQ" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/hzHCwM3Ba…</a></li>
</ul>
<h2 data-id="heading-2">Visual Studio 2026 正式版下载与安装详细教程（附带产品密钥）！</h2>
<ul>
<li><strong>文章简介：</strong> 最近发现很多小伙伴反馈 Visual Studio 2026 安装占用磁盘空间较大，今天大姚出一期 Visual Studio 2026 正式版下载与安装详细教程，我们可以通过仅选择所需的工作负荷、组件、语言包来节省安装时间和磁盘空间，希望可以帮助到有需要的小伙伴！</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FwbZiTPjhKlFOeU3MgIbq0A" target="_blank" title="https://mp.weixin.qq.com/s/wbZiTPjhKlFOeU3MgIbq0A" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/wbZiTPjhK…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5bec5194a6847dd8a6612728d7534da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767013824&amp;x-signature=beuGr7t0BNoShQG5abTy1Zpl07o%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-3">一个 .NET 开源免费、功能强大的 UI 自动化库</h2>
<ul>
<li><strong>文章简介：</strong> FlaUI 是一个 .NET 开源免费（MIT license）、功能强大 的 UI 自动化库，专为 Windows 桌面应用程序（如 Win32、WinForms、WPF、Store Apps 等应用）的自动化测试而设计。该项目基于 Microsoft 的原生 UI Automation 库构建，并作为这些库的封装器，提供了丰富的功能和灵活的 API，以便开发者能够高效地编写自动化测试脚本。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FPE4S-fUyeG7U8Z78NYu6Rw" target="_blank" title="https://mp.weixin.qq.com/s/PE4S-fUyeG7U8Z78NYu6Rw" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/PE4S-fUye…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32a1862e16614ae6af955676f6a1b8f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767013824&amp;x-signature=9nHePQq6%2BbqtwefHAnqEEGD2n%2BI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">Newtonsoft.Json 与 System.Text.Json 多态反序列化的安全性差异解析</h2>
<ul>
<li><strong>文章简介：</strong> 多态反序列化是处理继承结构对象序列化的常见需求，但不同 JSON 序列化库的实现机制差异会带来显著的安全风险。微软 CA2326 规则明确警示：避免使用非安全的 JsonSerializerSettings 配置（如 Newtonsoft.Json 的 TypeNameHandling 非 None 值），否则可能引发类型注入攻击。本文将对比 Newtonsoft.Json 与 System.Text.Json 在多态反序列化中的实现差异，重点分析安全性问题，并通过代码实例验证两者的安全表现。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2FMeteorSeed%2Fp%2F19366736" target="_blank" title="https://www.cnblogs.com/MeteorSeed/p/19366736" ref="nofollow noopener noreferrer">www.cnblogs.com/MeteorSeed/…</a></li>
</ul>
<h2 data-id="heading-5">.NET 和 .NET Framework 2025 年 12 月服务发布更新</h2>
<ul>
<li><strong>文章简介：</strong> 欢迎来到我们 2025 年 12 月的联合.NET 服务更新。让我们进入.NET 和.NET Framework 的最新版本，这里简要介绍一下我们服务版本中的新内容。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fdevblogs.microsoft.com%2Fdotnet%2Fdotnet-and-dotnet-framework-december-2025-servicing-updates%2F" target="_blank" title="https://devblogs.microsoft.com/dotnet/dotnet-and-dotnet-framework-december-2025-servicing-updates/" ref="nofollow noopener noreferrer">devblogs.microsoft.com/dotnet/dotn…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa88f8829d994a3daa2219d1eabfe653~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767013824&amp;x-signature=DEiUCskPWwRJTqa6WL6FbutDs08%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">如何构建带有.NET MAUI 的 iOS 小部件</h2>
<ul>
<li><strong>文章简介：</strong> 我是一名.NET 开发者，主要专注于.NET MAUI 到 ASP.NET 后端服务。因为我最近大量接触小部件，遇到了许多障碍和极其有限的文档，我决定写这篇文章，展示用 .NET MAUI 构建完整小部件是完全可能的。而且还能以类似原生开发环境的专业方式完成，不用担心每次新构建或更新都会让一切崩溃。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fdevblogs.microsoft.com%2Fdotnet%2Fhow-to-build-ios-widgets-with-dotnet-maui" target="_blank" title="https://devblogs.microsoft.com/dotnet/how-to-build-ios-widgets-with-dotnet-maui" ref="nofollow noopener noreferrer">devblogs.microsoft.com/dotnet/how-…</a></li>
</ul>
<h2 data-id="heading-7">.NET 10 网络改进</h2>
<ul>
<li><strong>文章简介：</strong> 和每次版本一样，我们会发布一篇关于.NET 网络领域新颖有趣变化和新增内容的博客文章。这次，我们将讨论 HTTP 改进、新的 Web 套接字 API、 安全变更以及许多网络原语的独特新增内容。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fdevblogs.microsoft.com%2Fdotnet%2Fdotnet-10-networking-improvements%2F" target="_blank" title="https://devblogs.microsoft.com/dotnet/dotnet-10-networking-improvements/" ref="nofollow noopener noreferrer">devblogs.microsoft.com/dotnet/dotn…</a></li>
</ul>
<h2 data-id="heading-8">分享 4 款基于 C# 编写、实用、开源的 Visual Studio 扩展插件</h2>
<ul>
<li><strong>文章简介：</strong> EFCore.Visualizer 是一款可以直接在 Visual Studio 中查看 EF Core 查询计划调试器可视化工具（帮助开发者分析和优化数据库查询性能），目前，该可视化工具支持 SQL Server、PostgreSQL、SQLite、MySQL 和 Oracle。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FDTX-UAZhle9dxnD4MjebCw" target="_blank" title="https://mp.weixin.qq.com/s/DTX-UAZhle9dxnD4MjebCw" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/DTX-UAZhl…</a></li>
</ul>
<h2 data-id="heading-9">完美复刻！一个基于 C# 和 WPF 开源的网易云音乐客户端</h2>
<ul>
<li><strong>文章简介：</strong> MusicApp 是一个基于 C# 和 WPF 技术开发的模仿网易云音乐界面的音乐应用项目。该项目旨在通过实践学习 WPF 开发，非常适合 WPF 入门学习者作为入门参考项目，本项目已实现基本音乐播放功能。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FCIWd7qx-S95Xv02pZCBpgw" target="_blank" title="https://mp.weixin.qq.com/s/CIWd7qx-S95Xv02pZCBpgw" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/CIWd7qx-S…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5577a160dfbd42e7825b6b44621a20ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767013824&amp;x-signature=yzB8ZR8Gfrp9rd5fXTyWmKzHZQQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">一款基于 .NET 和 Quartz.NET 开源的任务调度 Web 界面管理</h2>
<ul>
<li><strong>文章简介：</strong> quartzui 是一款基于 Quartz.NET 3.0（后升级至3.2.4）的任务调度 Web 界面管理工具，专为简化任务调度管理而设计。该项目支持通过 Web 界面进行任务调度配置、监控及管理，极大地提高了任务调度的便捷性和效率。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FqByA7G0EFVY0S2J5l9in1A" target="_blank" title="https://mp.weixin.qq.com/s/qByA7G0EFVY0S2J5l9in1A" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/qByA7G0EF…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8827d7380d3e435cb6c607dab03ac266~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767013824&amp;x-signature=zGdgMYZxP7niQ9nwg7lU2yDkDvg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-11">一个 WPF 开源、免费的 SVG 图像查看控件</h2>
<ul>
<li><strong>文章简介：</strong> SVGImage 是一个为 WPF（Windows Presentation Foundation）应用程序设计、开源（MIT license）、免费的 SVG（Scalable Vector Graphics）图像查看控件。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F69x0B6jhYja58Ze0NSi9ew" target="_blank" title="https://mp.weixin.qq.com/s/69x0B6jhYja58Ze0NSi9ew" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/69x0B6jhY…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c873b94c37a4d6481b010baffa29bf8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767013824&amp;x-signature=Lb%2FIouUqQnD81fXFPOJ%2Bogo8HWc%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-12">一个基于 .NET + Vue3 开源、免费、精美的通用业务型后台管理系统</h2>
<ul>
<li><strong>文章简介：</strong> SimpleAdmin 是一个基于 .NET + Vue3 开发的通用业务型后台管理系统，适用于各类需要后台管理功能的企业级应用、网站后台、数据监控平台等场景。它提供了丰富的功能模块和精美的用户界面，能够帮助开发者快速搭建起稳定、高效的后台管理系统，提升开发效率和管理水平。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FQV2B3et6Df9FrU3RzYDWrQ" target="_blank" title="https://mp.weixin.qq.com/s/QV2B3et6Df9FrU3RzYDWrQ" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/QV2B3et6D…</a></li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aa5ce0b0518c49f08876cfb464c7dac6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6L-96YCQ5pe25YWJ6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767013824&amp;x-signature=ZVcsolptxeStNzt%2FUAaS5Mt4yy0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-13">精选 6 款开源的 WinForm UI 控件库，轻松让你的老牌 WinForm 应用焕然一新！</h2>
<ul>
<li><strong>文章简介：</strong> 今天大姚给大家分享 6 款开源的 WinForm UI 控件库，轻松让你的老牌 WinForm 应用焕然一新！</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fl4ccmjKzodcwhxYDRTdukg" target="_blank" title="https://mp.weixin.qq.com/s/l4ccmjKzodcwhxYDRTdukg" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/l4ccmjKzo…</a></li>
</ul>
<h2 data-id="heading-14">全面支持国产化！C# 开源跨平台 UI 框架，支持 Windows、Mac、Linux</h2>
<ul>
<li><strong>文章简介：</strong> CPF（Cross-Platform Framework） 是一款基于 C# 开发的开源跨平台 UI 框架，专注于国产化适配与全平台支持（Windows/macOS/Linux）。项目采用模块化设计，提供高性能的渲染引擎与丰富的控件库，旨在解决国产操作系统生态中缺乏成熟 C# UI 解决方案的痛点，同时兼容主流国际平台。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FqbmUS5gT1be6ZWpYm0FRPw" target="_blank" title="https://mp.weixin.qq.com/s/qbmUS5gT1be6ZWpYm0FRPw" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/qbmUS5gT1…</a></li>
</ul>
<h2 data-id="heading-15">一个基于 .NET 开源、高性能、可扩展的套接字服务器应用程序框架</h2>
<ul>
<li><strong>文章简介：</strong> SuperSocket 是一个用于 .NET 的高性能、可扩展的套接字服务器应用程序框架。它为开发者提供了构建自定义网络通信应用程序的强大架构，支持包括 TCP、UDP 和 WebSocket 在内的多种协议。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FoNA-dDh80e-WI__9Itf2JA" target="_blank" title="https://mp.weixin.qq.com/s/oNA-dDh80e-WI__9Itf2JA" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/oNA-dDh80…</a></li>
</ul>
<h2 data-id="heading-16">C#AI系列(7):从零开始LLM之Tokenizer实现</h2>
<ul>
<li><strong>文章简介：</strong> LLM只做一个事情，就是吃掉token吐出token，token是LLM（大语言模型）的基本元素。token与LLM的关系，相当于乐高积木与乐高工厂，我的世界方块与我的世界游戏。那么token到底是什么呢？有人翻译成令牌，有人翻译成词源。我们不妨换个概念理解，token就是最小操作、最小信息单元的意思。这个最小是相对于LLM要处理的原始文本来说的。举个栗子，当一个句子文本输入到电脑中，天然就就具有字符级别的切分。如果不打算继续拆分或组合，我们可以通过一个映射关系，将现有这些字符转换为整数数组，称为编码过程。编码后数组内的元素就是token，元素取值就等于token取值。LLM可以吃掉这个token数组，并吐出新数组。对这个新数组按前前述的映射进行逆转换，称为解码过程。解码后我们就能得到人类可以理解的文本了。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fluojin765%2Fp%2F19378939" target="_blank" title="https://www.cnblogs.com/luojin765/p/19378939" ref="nofollow noopener noreferrer">www.cnblogs.com/luojin765/p…</a></li>
</ul>
<h2 data-id="heading-17">.NET10 New feature 新增功能介绍-JIT编译器改进</h2>
<ul>
<li><strong>文章简介：</strong> 首先.NET10是一个LTS版本，微软官方支持3年，所以作为最新的主力版本，可以尽快升级使用。今天我们详细介绍一下.NET 10的一些新功能-JIT编译器改进。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Ftianqing%2Fp%2F19378803" target="_blank" title="https://www.cnblogs.com/tianqing/p/19378803" ref="nofollow noopener noreferrer">www.cnblogs.com/tianqing/p/…</a></li>
</ul>
<h2 data-id="heading-18">.Net通过EFCore和仓储模式实现统一数据权限管控并且相关权限配置动态生成</h2>
<ul>
<li><strong>文章简介：</strong> .Net通过EFCore和仓储模式实现统一数据权限管控并且相关权限配置动态生成。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fnet-kevin-li%2Fp%2F19368351" target="_blank" title="https://www.cnblogs.com/net-kevin-li/p/19368351" ref="nofollow noopener noreferrer">www.cnblogs.com/net-kevin-l…</a></li>
</ul>
<h2 data-id="heading-19">OpenCVSharp：HOG行人检测</h2>
<ul>
<li><strong>文章简介：</strong> HOG行人检测是一种基于方向梯度直方图特征的计算机视觉目标检测技术，它通过计算图像局部区域的梯度方向直方图来描述目标的外观形状特征。该算法首先将图像分割为小的连通区域（细胞单元），计算每个单元内像素的梯度方向并生成直方图，然后将相邻的细胞单元组合成块并对块内的直方图进行归一化处理，最终形成能够有效描述行人轮廓和形状的特征向量。这些特征向量被输入到预先训练好的SVM分类器中，判断图像区域是否包含行人，并通过多尺度扫描策略在不同大小的窗口中搜索目标，从而实现对图像中行人的准确检测和定位。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fmingupupu%2Fp%2F19365183" target="_blank" title="https://www.cnblogs.com/mingupupu/p/19365183" ref="nofollow noopener noreferrer">www.cnblogs.com/mingupupu/p…</a></li>
</ul>
<h2 data-id="heading-20">OpenCVSharp：学习人脸检测例子</h2>
<ul>
<li><strong>文章简介：</strong> OpenCVSharp关于人脸检测提供了两个例子，一个是使用级联分类器另一个是使用DNN模型。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fmingupupu%2Fp%2F19363129" target="_blank" title="https://www.cnblogs.com/mingupupu/p/19363129" ref="nofollow noopener noreferrer">www.cnblogs.com/mingupupu/p…</a></li>
</ul>
<h2 data-id="heading-21">Aspire 13：从.NET 编排工具到真正的多语言云原生应用平台</h2>
<ul>
<li><strong>文章简介：</strong> Aspire 13 的发布标志着微软云原生开发工具链的一个决定性转折点。通过正式去除 ".NET" 前缀并更名为 "Aspire"，该平台已从一个以.NET 为中心的编排器演变为一个广泛的、多语言通用的应用平台 1。这一战略转变的核心在于将 Python 和 JavaScript (Node.js) 提升为与.NET 同等的一等公民，彻底解决了现代分布式系统开发中跨语言协作的碎片化痛点 2。本文将深入剖析 Aspire 13 的架构变革，重点阐述其如何通过标准化的 "AppHost" 模型来统一管理异构微服务的生命周期。我们将详细探讨新增的 Aspire.Hosting.Python 包及其对 Python 生态系统（如 uv 包管理器、ASGI 标准、虚拟环境）的深度集成；分析基于 OpenTelemetry (OTLP) 的统一可观测性架构如何消除语言间的监控壁垒；并揭示 Aspire 13 如何通过智能化的环境变量注入和自动化的 Dockerfile 生成，重塑了从本地开发到生产部署的完整工作流 1。此外，本文还将审视这一版本对底层基础设施的要求，包括对.NET 10 SDK 的依赖以及全新的生命周期管理工具 aspire do 的引入 2。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fshanyou%2Fp%2F19360467" target="_blank" title="https://www.cnblogs.com/shanyou/p/19360467" ref="nofollow noopener noreferrer">www.cnblogs.com/shanyou/p/1…</a></li>
</ul>
<h2 data-id="heading-22">用 .NET 最小化 API 构建高性能 API</h2>
<ul>
<li><strong>文章简介：</strong> 在当今快速发展的应用开发领域，构建快速、可扩展且可维护的API已成为现代应用的关键要求。随着.NET技术的不断演进，微软推出了最小化API(Minimal APIs)这一创新架构，旨在简化API开发流程同时显著提升性能。最小化API通过减少模板代码、优化启动时间，让开发者能够专注于业务逻辑而非框架复杂性，为构建高性能API提供了全新的解决方案。本文将深入探讨如何利用.NET中的最小化API架构构建高性能API，通过简洁的代码示例和实用建议，帮助开发者掌握这一现代API开发方法。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fpowertoolsteam%2Fp%2F19360421" target="_blank" title="https://www.cnblogs.com/powertoolsteam/p/19360421" ref="nofollow noopener noreferrer">www.cnblogs.com/powertoolst…</a></li>
</ul>
<h2 data-id="heading-23">2025年 WebTransport 生态深度研究：JavaScript 客户端与.NET 10 SignalR 的演进与融合</h2>
<ul>
<li><strong>文章简介：</strong> 在实时网络通信领域，2025年标志着从传统的基于 TCP 的 WebSocket 协议向基于 UDP 和 QUIC 的下一代传输协议——WebTransport 的关键转型期。本报告旨在针对 WebTransport 在 JavaScript 客户端生态系统中的支持现状，以及微软.NET 10 框架下 ASP.NET Core SignalR 对该协议的服务端实现能力，进行详尽的基准测试与架构分析。研究显示，截至 2025 年第四季度，WebTransport 的生态呈现出显著的“两极分化”特征。在客户端方面，以 Chrome 和 Firefox 为代表的浏览器阵营已经实现了高度成熟且稳定的支持，不仅完全遵循 W3C 标准，更在流控制和拥塞管理上表现优异；然而，Apple 的 WebKit 内核（Safari）依旧是普及的最大阻碍，仅在实验性版本中有限度开放。在服务端方面，随着.NET 10 的发布，ASP.NET Core SignalR 将 WebTransport 从“实验性预览”正式推进至“生产就绪”阶段，尽管其对底层操作系统（如 Windows Server 2022/2025 和特定 Linux 发行版）的依赖依然构成了部署门槛。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fshanyou%2Fp%2F19355053" target="_blank" title="https://www.cnblogs.com/shanyou/p/19355053" ref="nofollow noopener noreferrer">www.cnblogs.com/shanyou/p/1…</a></li>
</ul>
<h2 data-id="heading-24">OpenCVSharp：了解几种特征检测</h2>
<ul>
<li><strong>文章简介：</strong> 前面已经介绍过了OpenCVSharp中封装的几个特征检测算法，其实里面还有很多特征检测算法，不再一篇一篇地介绍了，其它的都放在这一篇，简单过一下，有点印象即可。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fmingupupu%2Fp%2F19352075" target="_blank" title="https://www.cnblogs.com/mingupupu/p/19352075" ref="nofollow noopener noreferrer">www.cnblogs.com/mingupupu/p…</a></li>
</ul>
<h2 data-id="heading-25">C#AI系列(6): C#离线实现高效OCR</h2>
<ul>
<li><strong>文章简介：</strong> 实现OCR，我们直接从Tesseract（Apache 2.0，star 71.4K）开始。Tesseract 是目前最活跃、最精确的开源 OCR（光学字符识别）引擎之一，由 Google 维护。它能把图片中的印刷或手写文字转换成可编辑的纯文本、PDF、HTML 等多种格式，支持包括中文等 100 多种语言。Tesseract 4 以后引入基于深度学习的 LSTM 神经网络模型，对整行文字进行识别，准确率大幅提升。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fluojin765%2Fp%2F19346320" target="_blank" title="https://www.cnblogs.com/luojin765/p/19346320" ref="nofollow noopener noreferrer">www.cnblogs.com/luojin765/p…</a></li>
</ul>
<h2 data-id="heading-26">OpenCVSharp：学习连通性检测的使用</h2>
<ul>
<li><strong>文章简介：</strong> 连通性检测是计算机视觉中的一种基础图像处理技术，用于识别和标记二值图像中相互连接的像素区域。简单来说，它能够找出图像中所有独立的"连通区域"（即像素之间相互连接形成的区域）。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fmingupupu%2Fp%2F19344713" target="_blank" title="https://www.cnblogs.com/mingupupu/p/19344713" ref="nofollow noopener noreferrer">www.cnblogs.com/mingupupu/p…</a></li>
</ul>
<h2 data-id="heading-27">WPF个人文档（一）—— 基础语法&amp;组件篇</h2>
<ul>
<li><strong>文章简介：</strong> WPF个人文档（一）—— 基础语法&amp;组件篇。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fleaf-7-scouts%2Fp%2F19336808" target="_blank" title="https://www.cnblogs.com/leaf-7-scouts/p/19336808" ref="nofollow noopener noreferrer">www.cnblogs.com/leaf-7-scou…</a></li>
</ul>
<h2 data-id="heading-28">.Net微服务网关注册和管理（基于Consul + Nginx实现）</h2>
<ul>
<li><strong>文章简介：</strong> 在微服务架构中，API网关作为请求入口，负责路由转发、负载均衡、认证鉴权等核心功能。Consul提供服务注册与发现能力，Nginx作为高性能反向代理，二者结合可实现动态网关管理。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fnet-kevin-li%2Fp%2F19332353" target="_blank" title="https://www.cnblogs.com/net-kevin-li/p/19332353" ref="nofollow noopener noreferrer">www.cnblogs.com/net-kevin-l…</a></li>
</ul>
<h2 data-id="heading-29">.NET 10 网络改进：HTTP、安全与网络原语的全面升级</h2>
<ul>
<li><strong>文章简介：</strong> 随着.NET 10的发布，微软在网络技术栈上带来了一系列令人兴奋的改进和新增功能。这些改进覆盖了HTTP协议处理、WebSockets API、安全增强以及网络基础原语等多个方面。本文将深入探讨这些技术改进，帮助开发者更好地理解和利用.NET 10在网络编程方面的最新能力。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fpowertoolsteam%2Fp%2F19330426" target="_blank" title="https://www.cnblogs.com/powertoolsteam/p/19330426" ref="nofollow noopener noreferrer">www.cnblogs.com/powertoolst…</a></li>
</ul>
<h2 data-id="heading-30">C#实现三菱MC通讯协议库（4C帧-格式1）</h2>
<ul>
<li><strong>文章简介：</strong> 根据三菱的 Melsec 通讯协议(本文称MC协议)手册内容，使用串口实现了 PC 与 PLC 的通讯，能够通过QnA兼容4C帧的格式1实现 PC 读写 PLC 的软元件存储器内容(异步方法)，最后用一个 C#控制台项目测试了通讯库功能。</li>
<li><strong>文章地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fdragonet-Z%2Fp%2F19318911" target="_blank" title="https://www.cnblogs.com/dragonet-Z/p/19318911" ref="nofollow noopener noreferrer">www.cnblogs.com/dragonet-Z/…</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[lombook java: 找不到符号]]></title>    <link>https://juejin.cn/post/7586506307726983178</link>    <guid>https://juejin.cn/post/7586506307726983178</guid>    <pubDate>2025-12-22T13:43:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586506307726983178" data-draft-id="7586338196302512174" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="lombook java: 找不到符号"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-22T13:43:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倚栏听风雨"/> <meta itemprop="url" content="https://juejin.cn/user/2682464103830750"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            lombook java: 找不到符号
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2682464103830750/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倚栏听风雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T13:43:59.000Z" title="Mon Dec 22 2025 13:43:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fsinat_38719275%2Farticle%2Fdetails%2F106453328" target="_blank" title="https://blog.csdn.net/sinat_38719275/article/details/106453328" ref="nofollow noopener noreferrer">blog.csdn.net/sinat_38719…</a></p>
<h4 data-id="heading-0">8.idea版本的问题 202003版本问题</h4>
<p>添加如下代码：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">-Djps.track.ap.dependencies</span>=<span class="hljs-literal">false</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9da0677fb6034d2daa3264941e395363~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCa5qCP5ZCs6aOO6Zuo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767015839&amp;x-signature=iZls7hoW8FvMjbEkazjFwz2qmuw%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Swift 6.2 列传（第十三篇）：香香公主的“倾城之恋”与优先级飞升]]></title>    <link>https://juejin.cn/post/7586338196302217262</link>    <guid>https://juejin.cn/post/7586338196302217262</guid>    <pubDate>2025-12-22T12:02:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586338196302217262" data-draft-id="7586504691845300233" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Swift 6.2 列传（第十三篇）：香香公主的“倾城之恋”与优先级飞升"/> <meta itemprop="keywords" content="Swift,Apple,编程语言"/> <meta itemprop="datePublished" content="2025-12-22T12:02:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大熊猫侯佩"/> <meta itemprop="url" content="https://juejin.cn/user/4292907536222152"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Swift 6.2 列传（第十三篇）：香香公主的“倾城之恋”与优先级飞升
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4292907536222152/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大熊猫侯佩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T12:02:44.000Z" title="Mon Dec 22 2025 12:02:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/805d895844e647068ee5dcf3d84e2dd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767009764&amp;x-signature=11hVP5fOrMs9PZgT9gQqXgSLeBE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<blockquote>
<p><strong>摘要</strong>：在并发编程的江湖里，当一个位高权重的任务被迫等待一个无名小卒时，会发生什么？Swift 6.2 带来的 <code>Task Priority Escalation APIs</code> 就像是香香公主那惊心动魄的美貌，能让原本慵懒的后台任务瞬间“鸡犬升天”。本文将借大熊猫侯佩与香香公主的沙漠奇遇，为您解析 SE-0462 的奥秘。</p>
</blockquote>
<h2 data-id="heading-0">0️⃣ 🐼 序章：回疆的慢车与急惊风</h2>
<p>回疆，赛里木湖畔的数字荒原。</p>
<p>这里是系统资源的边缘地带，网络带宽如同细细的涓流。大熊猫侯佩正蹲在一块虚拟的岩石上，第 10086 次尝试刷新他的“高德地图导航”。</p>
<p>“这该死的路痴属性……”侯佩焦躁地拍了拍自己圆润的脑袋，顺手摸了一把头顶那倔强的黑毛，“还好，发际线依然坚挺，<strong>绝对没有秃</strong>。只是这下载速度，比蜗牛爬还慢。”</p>
<p>在他的视野里，代表下载任务的进度条（Task）是一个穿着破烂羊皮袄的老头，正赶着一辆破破烂烂的牛车，在 <code>background</code>（后台）优先级的泥潭里慢悠悠地挪动。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e95083494ec34adab3e4d0567cc213c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767009764&amp;x-signature=6gTXHoSnGuq7nswv1HER7ewfM5c%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>突然，天地变色。远处的数据流卷起狂沙，一支装备精良、杀气腾腾的皇家骑兵队（高优先级任务）呼啸而来，却被这辆破牛车死死挡在了单行道上。</p>
<p>骑兵队的为首者刚要发怒，却见那破牛车旁，不知何时站了一位白衣少女。她鬓边插着一朵天山雪莲，肌肤胜雪，虽然只是静静站着，却让周围狂暴的 CPU 周期瞬间变得温柔起来。</p>
<p>她是<strong>香香公主</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/227677915de442fea541434c862fac50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767009764&amp;x-signature=cIq88kgMvxMW2VIjBh6FJzxNb2I%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>当那位皇家骑兵统领（Main Actor）看到香香公主竟然也在等待这辆牛车时，他立刻下令：“传令下去！给这破车换上法拉利的引擎！全军护送！谁敢让公主多等一秒，提头来见！”</p>
<p>刹那间，那辆原本属于 <code>background</code> 优先级的牛车，瞬间获得了 <code>high</code> 优先级的加持，快得连影子都看不清。</p>
<p><strong>在本次穿越大冒险中，您将学到如下内容：</strong></p>
<ul>
<li>0️⃣ 🐼 序章：回疆的慢车与急惊风</li>
<li>1️⃣ 🚀 什么是任务优先级提升？</li>
<li>2️⃣ 🕵️‍♂️ 监控飞升：withTaskPriorityEscalationHandler</li>
<li>3️⃣ 🎛️ 手动干预：escalatePriority(to:)</li>
<li>4️⃣ 🐢 vs 🐇：自动还是手动？</li>
<li>5️⃣ 🛑 尾声：失控的无名氏</li>
</ul>
<p>侯佩目瞪口呆，嘴里的竹笋掉在了地上：“这就叫……一人得道，鸡犬升天？这难道就是传说中的 <strong>Priority Escalation（优先级提升）</strong>？”;)</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3fb9f3f31e14d1a908af6b7fa4af590~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767009764&amp;x-signature=FseUdUxnGYM8mIrLJKazSoPl1Kg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1">1️⃣ 🚀 什么是任务优先级提升？</h2>
<p>在 Swift 的并发世界里，这叫 <strong>“优先级反转（Priority Inversion）”的自动消解</strong>。</p>
<p>香香公主（高优先级任务）需要等待那个破老头（低优先级任务）的结果（比如 Data Race 里的锁，或者是 <code>await</code> 一个结果）。如果系统不干预，高贵的公主就要在这个“低贱”的队列里无限期等待，这显然不符合皇家（UI 响应性）的体面。</p>
<p>于是，Swift 运行时会自动把那个老头的优先级提升，让他暂时拥有和公主一样的地位，直到他把事情做完。</p>
<p><strong>SE-0462</strong> 赋予了我们监控这种“飞升”现象的能力，甚至允许我们手动干预。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72cb44aecd8c49bbb2f6b453337a678d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767009764&amp;x-signature=PFIlFOGtREjx3sB0zookzvFEll8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-2">2️⃣ 🕵️‍♂️ 监控飞升：withTaskPriorityEscalationHandler</h2>
<p>“虽然飞升很爽，但那个赶车的老头得知道自己被‘提拔’了啊，不然他还以为自己在逛花园呢。”侯佩捡起竹笋，若有所思。</p>
<p>Swift 6.2 引入了 <strong><code>withTaskPriorityEscalationHandler</code></strong>，让任务能够感知自己是否“被动”变强了。</p>
<p>侯佩看着香香公主正在试图从一个慢速服务器获取最新的食谱（她最近想学做竹笋炒肉喂侯佩），于是写下了这段代码：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 创建一个中等优先级 (medium) 的任务</span>
<span class="hljs-keyword">let</span> newsFetcher <span class="hljs-operator">=</span> <span class="hljs-type">Task</span>(priority: .medium) {
    <span class="hljs-comment">// 🛡️ 使用处理程序包裹你的业务逻辑</span>
    <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> withTaskPriorityEscalationHandler {
        <span class="hljs-comment">// 这里是任务原本要做的苦力活</span>
        <span class="hljs-comment">// 比如去下载一个 JSON 数据</span>
        <span class="hljs-keyword">let</span> url <span class="hljs-operator">=</span> <span class="hljs-type">URL</span>(string: <span class="hljs-string">"https://hws.dev/messages.json"</span>)<span class="hljs-operator">!</span>
        <span class="hljs-keyword">let</span> (data, <span class="hljs-keyword">_</span>) <span class="hljs-operator">=</span> <span class="hljs-keyword">try</span> <span class="hljs-keyword">await</span> <span class="hljs-type">URLSession</span>.shared.data(from: url)
        <span class="hljs-keyword">return</span> data
    } onPriorityEscalated: { oldPriority, newPriority <span class="hljs-keyword">in</span>
        <span class="hljs-comment">// 🚨 这里的闭包会在优先级发生变化时被调用</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"天哪！公主在等我！我的优先级从 <span class="hljs-subst">\(oldPriority)</span> 飞升到了 <span class="hljs-subst">\(newPriority)</span>！"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"兄弟们，抄家伙，开足马力干活了！"</span>)
    }
}
</code></pre>
<p>香香公主眨着那双清澈如水的眼睛，好奇地问：“侯大哥，这意思是，一旦有人催这个任务，它自己就会知道？”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7e64aff18214a4bb52ff98e289ee621~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767009764&amp;x-signature=LbKJOVscFPdbZbBNMmvEdPL0cFw%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>“没错。”侯佩解释道，顺便摆了一个自以为很帅的 Pose，“这就好比我在睡觉，如果只是普通人叫我，我理都不理；但如果是你叫我，我脑子里的这个 <code>onPriorityEscalated</code> 就会立刻触发，瞬间从‘死猪模式’切换到‘舔狗模式’……啊不，是‘战斗模式’。”</p>
<h2 data-id="heading-3">3️⃣ 🎛️ 手动干预：escalatePriority(to:)</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c8aa09386454d298e085b7c9c1ba11f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767009764&amp;x-signature=DaumdAkPq6kNnQjmnJr1%2BxQhmNI%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>通常情况下，优先级提升是自动发生的（比如高优先级任务 <code>await</code> 了低优先级任务）。但有时候，我们作为架构师，需要扮演“陈家洛”的角色，手动去推一把。</p>
<p>Swift 6.2 允许我们使用 <strong><code>escalatePriority(to:)</code></strong> 来手动提升某个任务的优先级。</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 侯佩看着下载进度条太慢，实在忍不住了</span>
<span class="hljs-comment">// 他决定动用特权，手动把优先级拉满</span>
newsFetcher.escalatePriority(to: .high)
</code></pre>
<p>香香公主有些担忧：“可是，如果我们把它提升到了 <code>high</code>，后来又觉得不重要了，能把它降回去吗？”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5b2e50cd3254fe5be3228cf3bd9afff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767009764&amp;x-signature=PAVJtWpKpabmbYvT10i5JHWhvGA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>侯佩摇了摇头，神色变得严肃起来（虽然脸上还粘着竹笋渣）：“妹子，江湖路是一条不归路。在 Swift 的任务调度里，<strong>优先级只能升，不能降</strong>。”</p>
<blockquote>
<p><strong>💡 技术要点</strong>：
你的 <code>onPriorityEscalated</code> 回调可能会被触发多次。比如从 <code>low</code> 升到 <code>medium</code>，再从 <code>medium</code> 升到 <code>high</code>。但这就像武功境界，一旦突破，就回不到从前了。这是为了防止系统调度的震荡。</p>
</blockquote>
<h2 data-id="heading-4">4️⃣ 🐢 vs 🐇：自动还是手动？</h2>
<p>香香公主看着那些在数据流中奔跑的任务，问道：“那我们是不是应该把所有任务都手动设为最高级？这样大家都很开心呀。”</p>
<p>侯佩叹了口气，语重心长地说：“傻丫头，如果人人都是 VIP，那就没有 VIP 了。如果所有任务都是 <code>high</code>，那 CPU 就会像陷入‘红花会’内乱一样，谁也抢不到资源。”</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5abb8a18a6d143fdac0e8f20a55af23a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767009764&amp;x-signature=bNoBUpiO4xgrxSWx2Y32u%2BuDbiE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p><strong>官方建议（Note）：</strong> 任务优先级提升通常是自动发生的，而且 Swift 做得很棒。虽然这个 API 给了我们手动的权力，但在绝大多数情况下，还是应该顺其自然，<strong>无为而治</strong>。除非你真的遇到了特殊的性能瓶颈。</p>
<p>就像香香公主的美，不需要刻意修饰，自然就能引得千军万马为之驻足。</p>
<h2 data-id="heading-5">5️⃣ 🛑 尾声：失控的无名氏</h2>
<p>夕阳西下，赛里木湖波光粼粼。</p>
<p>经过优先级的调整，数据终于下载完成了。侯佩看着手里高清的地图，终于确认了自己的位置——好吧，他离目的地还有三千公里，果然又走反了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33a8f3cb56504e609af413c6b644a13c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767009764&amp;x-signature=HLSJrjRDEy4PNy%2BgHod7dUJbbWA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>就在这时，系统中突然窜出一个黑影！</p>
<p>那是一个失控的后台任务（Rogue Task），它像是个疯子一样在内存里乱窜，消耗着宝贵的电量，却又不干正事。</p>
<p>“站住！”侯佩大喝一声，想要通过代码杀掉这个进程，“你是哪个部门的？叫什么名字？”</p>
<p>然而，那个任务只是留下一串乱码，继续狂奔。侯佩尴尬地发现，他创建这个任务的时候，<strong>忘记给它起名字了</strong>。在调试器里，它只是一个冷冰冰的内存地址。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da081ec09f194dd3b84a579e0a6cb9d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767009764&amp;x-signature=cbs1ZjNySxKpERScVQrPvE4QL5o%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>“这就尴尬了，”侯佩挠了挠头，看着香香公主投来的疑惑目光，“我想教训它，却连它叫‘阿猫’还是‘阿狗’都不知道。”</p>
<p>香香公主轻轻一笑，指着下一章的预告说：“侯大哥，别急，听说下一招能给它们每人发一张身份证。”</p>
<p><strong>（欲知后事如何，且看下回分解：Task Naming —— 也就是给任务起个响当当的绰号，好让你在它闯祸时能指名道姓地骂它。）</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a526ac5e8cd4117b9b15ba13a8ab291~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn54aK54yr5L6v5L2p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767009764&amp;x-signature=l77QihLczTlmmnUxtmoggHX%2FqU8%3D" alt="在这里插入图片描述" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[pnpm + monorepo 才是 AI 协同开发的最佳方案！🚀🚀🚀]]></title>    <link>https://juejin.cn/post/7586518130761007144</link>    <guid>https://juejin.cn/post/7586518130761007144</guid>    <pubDate>2025-12-22T12:17:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586518130761007144" data-draft-id="7586490798431600703" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="pnpm + monorepo 才是 AI 协同开发的最佳方案！🚀🚀🚀"/> <meta itemprop="keywords" content="前端,React.js,AI编程"/> <meta itemprop="datePublished" content="2025-12-22T12:17:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="萌萌哒草头将军"/> <meta itemprop="url" content="https://juejin.cn/user/1116759543260727"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            pnpm + monorepo 才是 AI 协同开发的最佳方案！🚀🚀🚀
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1116759543260727/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    萌萌哒草头将军
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T12:17:54.000Z" title="Mon Dec 22 2025 12:17:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h3 data-id="heading-0">前言</h3>
<p>最近业余时间一直忙着开发 AudioDock：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmmdctjj%2FAudioDock" target="_blank" title="https://github.com/mmdctjj/AudioDock" ref="nofollow noopener noreferrer">github.com/mmdctjj/Aud…</a></p>
<p>很少更新文章，但是今天抽空总结下最近开发时的一些思考，希望可以给大家带来新的开发思路！</p>
<h3 data-id="heading-1">pnpm + monorepo + AI = 效率翻倍</h3>
<p>今天的主角是 pnpm ，不过还是得结合正在做的项目来说明！</p>
<p>我的项目是包含了桌面端、移动端的全栈项目，并且前后端分离，除此之外还包含了一些工具库。</p>
<p>整体使用 pnpm + monorepo 的形式管理项目。</p>
<pre><code class="hljs language-bash" lang="bash">soundX/
├── apps/                <span class="hljs-comment"># 应用层 (前端/客户端)</span>
│   ├── mobile/         <span class="hljs-comment"># 移动端应用 (React Native / Expo)</span>
│   ├── desktop/        <span class="hljs-comment"># 桌面端应用 (Electron)</span>
│   └── mini/           <span class="hljs-comment"># 迷你端/小程序应用</span>
├── services/            <span class="hljs-comment"># 后端服务层</span>
│   └── api/            <span class="hljs-comment"># 核心后端 API 服务 (通常是 NestJS)</span>
├── packages/            <span class="hljs-comment"># 公共模块与包 (内部依赖)</span>
│   ├── db/             <span class="hljs-comment"># 数据库模型与 Prisma 配置</span>
│   ├── ws/             <span class="hljs-comment"># WebSocket 通讯协议与逻辑</span>
│   ├── utils/          <span class="hljs-comment"># 公共工具函数</span>
│   └── <span class="hljs-built_in">test</span>/           <span class="hljs-comment"># 测试辅助工具</span>
├── Dockerfile           <span class="hljs-comment"># 容器化部署配置</span>
├── docker-compose.yml   <span class="hljs-comment"># 多服务编排配置</span>
├── package.json         <span class="hljs-comment"># 根目录配置与工作区管理</span>
├── pnpm-workspace.yaml  <span class="hljs-comment"># pnpm 工作区定义</span>
└── nginx.conf           <span class="hljs-comment"># Nginx 反向代理配置</span>
</code></pre>
<p>最近一直重度使用 AI 开发，没想到这种结构，让我的开发更加流畅：</p>
<h4 data-id="heading-2">全量的上下文信息</h4>
<p>AI 在开发时，始终是全量的上下文（前、后端）信息，让AI 生成一个请求函数和参数返回值类型，基本上可以很准确的实现</p>
<h4 data-id="heading-3">统一的类型管理</h4>
<p>这是 pnpm + monorepo 最大的优点了，统一的类型管理和统一的构建范式，即使想让 AI 重构，很少会出现重构失败的情况</p>
<h4 data-id="heading-4">跨应用开发</h4>
<p>我开发移动端的时候，如果对 AI 生成的效果不满意，经常让 AI 熟悉下桌面端的相同功能，在开发移动端的功能，效果会得到很大的提升！</p>
<h3 data-id="heading-5">遇到的问题</h3>
<h4 data-id="heading-6">多模块复用</h4>
<p>我们知道，一个标准的前后端分离项目，需要多个模块的配合：models、servies、views。</p>
<p>像我的这个项目移动端（React Native）和桌面端（Electron）都会出现这些模块，包括后续会实现的小程序和电视端，大概率还是需要这些的，所以，我将公共的部分抽离成了单独的包：db、services（后知后觉，还没抽离）！</p>
<h4 data-id="heading-7">让人摸不着头脑的 nestjs</h4>
<p>我之前已经写过 nestjs 的文章了，介绍了他基础的开发范式，controller、servide、module。可以说是 spring boot 无痛切换 Node 的最佳方案了，但是在我第一次打包的时候傻眼了，打包之后一直报错：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Error</span>: <span class="hljs-title class_">Cannot</span> find <span class="hljs-variable language_">module</span> <span class="hljs-string">'@nestjs/core'</span>
<span class="hljs-title class_">Require</span> <span class="hljs-attr">stack</span>:
| - <span class="hljs-regexp">/usr/</span>src/app/dist/main.<span class="hljs-property">js</span>
</code></pre>
<p>一开始以为是我的 Dockerfile 配置的有问题，反复调整，折磨了我一个周末才发现这是在 pnpm monorepo 项目里开发必然会出现的问题。</p>
<p>解决方法很简单，构建的时候，在单独下载一次生产环境的依赖包就可以了！</p>
<pre><code class="hljs language-sql" lang="sql"># <span class="hljs-number">2.</span> 安装生产依赖 <span class="hljs-operator">+</span> 全局安装 prisma (用于 db push)
RUN apt<span class="hljs-operator">-</span><span class="hljs-keyword">get</span> <span class="hljs-keyword">update</span> <span class="hljs-operator">-</span>y <span class="hljs-operator">&amp;&amp;</span> apt<span class="hljs-operator">-</span><span class="hljs-keyword">get</span> install <span class="hljs-operator">-</span>y openssl
RUN npm i <span class="hljs-operator">-</span>g pnpm prisma<span class="hljs-variable">@6</span><span class="hljs-number">.6</span><span class="hljs-number">.0</span> <span class="hljs-operator">&amp;&amp;</span> pnpm install <span class="hljs-comment">--prod --frozen-lockfile --ignore-scripts</span>
</code></pre>
<p>出现这个问题的主要原因是 pnpm 的软连接机制在打包的时候会失效，所以找不到这个包。</p>
<h4 data-id="heading-8">Prisma 让我又爱又恨</h4>
<p>解决完第一个问题，以为可以正常运行我的包了，结果没想到这时候是 Prisma 的问题了。</p>
<p>Prisma 最大的好处是可以自动生成类型文件、基础的业务查询！</p>
<p>但是真的没想到，这些便捷的后面隐藏着无数的坑，第二个问题是 <a href="https://link.juejin.cn?target=mailto%3APrisma%406.x" target="_blank" title="mailto:Prisma@6.x" ref="nofollow noopener noreferrer">Prisma@6.x</a> 版本默认输出客户端文件在 pnpm 项目里也会找不到文件在哪。</p>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-symbol">node:</span>internal/modules/cjs/<span class="hljs-symbol">loader:</span><span class="hljs-number">1386</span>
  <span class="hljs-keyword">throw</span> err;
  ^
<span class="hljs-title class_">Error</span>: <span class="hljs-title class_">Cannot</span> find <span class="hljs-keyword">module</span> <span class="hljs-string">'.prisma/client/default'</span>
<span class="hljs-title class_">Require</span> <span class="hljs-symbol">stack:</span> - <span class="hljs-regexp">/app/node</span>_modules/.pnpm/<span class="hljs-variable">@prisma</span>+client<span class="hljs-variable">@6</span>.<span class="hljs-number">8</span>.2_prisma<span class="hljs-variable">@6</span>.<span class="hljs-number">8</span>.2_typescript<span class="hljs-variable">@5</span>.<span class="hljs-number">9</span>.3__typescript<span class="hljs-variable">@5</span>.<span class="hljs-number">9.3</span>/node_modules/<span class="hljs-variable">@prisma</span>/client/default.js
</code></pre>
<p>后来看到需要使用自定义输出路径才不会出现这个问题。</p>
<p>但是使用自定义文件输出的文件是 CMD 格式的文件，于是我将 Prisma 的版本升级到了最新的 7.x 版本，新版本要求必须使用自定义路径输出客户端文件，并且生成的是 ES 格式的文件，可以在前端直接引入类型。</p>
<p>但是玩玩没想到，输出之后的文件会有三个变量一直报错</p>
<pre><code class="hljs language-bash" lang="bash">apps/api dev: generated/prisma/internal/prismaNamespace.ts:114:14 - error TS2742: The inferred <span class="hljs-built_in">type</span> of <span class="hljs-string">'DbNull'</span> cannot be named without a reference to <span class="hljs-string">'.pnpm/@prisma+client-runtime-utils@7.0.0/node_modules/@prisma/client-runtime-utils'</span>. This is likely not portable. A <span class="hljs-built_in">type</span> annotation is necessary.

apps/api dev: 114 <span class="hljs-built_in">export</span> const DbNull = runtime.DbNull
apps/api dev:                  ~~~~~~

apps/api dev: generated/prisma/internal/prismaNamespace.ts:121:14 - error TS2742: The inferred <span class="hljs-built_in">type</span> of <span class="hljs-string">'JsonNull'</span> cannot be named without a reference to <span class="hljs-string">'.pnpm/@prisma+client-runtime-utils@7.0.0/node_modules/@prisma/client-runtime-utils'</span>. This is likely not portable. A <span class="hljs-built_in">type</span> annotation is necessary.

apps/api dev: 121 <span class="hljs-built_in">export</span> const JsonNull = runtime.JsonNull
apps/api dev:                  ~~~~~~~~

apps/api dev: generated/prisma/internal/prismaNamespace.ts:128:14 - error TS2742: The inferred <span class="hljs-built_in">type</span> of <span class="hljs-string">'AnyNull'</span> cannot be named without a reference to <span class="hljs-string">'.pnpm/@prisma+client-runtime-utils@7.0.0/node_modules/@prisma/client-runtime-utils'</span>. This is likely not portable. A <span class="hljs-built_in">type</span> annotation is necessary.

apps/api dev: 128 <span class="hljs-built_in">export</span> const AnyNull = runtime.AnyNull
apps/api dev:                  ~~~~~~~
</code></pre>
<p>没办法又回退到了 6.x 版本直接手写 modal 了。</p>
<h3 data-id="heading-9">最后</h3>
<p>目前已经开发完了大部分功能了，大概集中开发了两三个周末的时间，整体来说 pnpm + monorepo 协同 AI 开发我感觉是个人或者小团队开发的最快形式了。</p>
<p>可能会有小伙伴担心是不是很费大模型的 token ？</p>
<p>我没试过小项目，但是如果真的免费 token 用完了，可以再注册一个新账号继续使用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Agent】MemOS 源码笔记---(7)---MemScheduler 细节]]></title>    <link>https://juejin.cn/post/7586479864272093190</link>    <guid>https://juejin.cn/post/7586479864272093190</guid>    <pubDate>2025-12-22T12:27:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586479864272093190" data-draft-id="7586491717873270803" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Agent】MemOS 源码笔记---(7)---MemScheduler 细节"/> <meta itemprop="keywords" content="算法,人工智能,机器学习"/> <meta itemprop="datePublished" content="2025-12-22T12:27:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="罗西的思考"/> <meta itemprop="url" content="https://juejin.cn/user/351470467691175"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Agent】MemOS 源码笔记---(7)---MemScheduler 细节
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/351470467691175/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    罗西的思考
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T12:27:13.000Z" title="Mon Dec 22 2025 12:27:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读26分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【Agent】MemOS 源码笔记---(7)---MemScheduler 细节</h2>
<ul>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x00 摘要</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x01 组件关系</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x02 实现</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.1 GeneralScheduler</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.2 SchedulerDispatcher</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">2.3 SchedulerRetriever</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0x03 关联</a></p>
<ul>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.1 SchedulerDispatcher 和 GeneralScheduler</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.2 GeneralScheduler 和 TreeTextMemory</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.3 总结</a></li>
<li><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">3.4 MosCore</a></li>
</ul>
</li>
<li>
<p><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">0xFF 参考</a></p>
</li>
</ul>
<h3 data-id="heading-1">0x00 摘要</h3>
<p>记忆调度就像大脑的注意力机制，动态决定在合适的时刻调用合适的记忆。</p>
<p>在 MemOS 中，<strong>记忆调度（Memory Scheduling）</strong> 通过对【不同使用效率（参数&gt;激活&gt;工作&gt;其他明文）的记忆】的相互调度，让模型能更高效、准确地获取用户所需的记忆。在对话和任务进行时，通过预测用户后续对话所需记忆并提前调入高效率记忆类型如激活记忆工作记忆，加速推理链路。</p>
<p>记忆调度的具体实现就是MemScheduler ，这是一个与 MemOS 系统并行运行的并发记忆管理系统，它协调 AI 系统中工作记忆、长时记忆和激活记忆之间的记忆操作。它通过事件驱动调度处理记忆检索、更新和压缩。该系统特别适合需要动态记忆管理的对话代理和推理系统。</p>
<p>备注：本文基于MemOS的文档和源码进行学习，似乎其文档并没有跟上源码更新的速度，而且也有部分功能未实现或者未开源。</p>
<p>前一篇介绍了 MemScheduler 的总体概念，本篇来看看实现细节。</p>
<h3 data-id="heading-2">0x01 组件关系</h3>
<p>最核心的几个组件关系如下：</p>
<ul>
<li>GeneralScheduler 是整个调度系统的核心组件，继承自 BaseScheduler，负责处理不同类型的消息（查询、回答、添加等），并协调其他组件完成具体任务。</li>
<li>SchedulerDispatcher 是消息分发器，负责将不同类型的消息分发给对应的processor，支持并行处理（可选）。</li>
<li>SchedulerRetriever 是记忆检索器，负责从记忆库中搜索、重排序和过滤记忆项，提供智能记忆管理功能。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fb95ef5952641588c8a4a6f509f27c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767011233&amp;x-signature=YBjKu%2BcIbu8HAkKtkVLsesWCWTE%3D" alt="MemScheduler-7-1" loading="lazy"/></p>
<p>MemScheduler-7-1</p>
<p>MemOS-main\src\memos\templates\mem_scheduler_prompts.py 中可以看到使用的prompt。</p>
<pre><code class="hljs language-makefile" lang="makefile">PROMPT_MAPPING = {
    <span class="hljs-string">"intent_recognizing"</span>: INTENT_RECOGNIZING_PROMPT,
    <span class="hljs-string">"memory_reranking"</span>: MEMORY_RERANKING_PROMPT,
    <span class="hljs-string">"query_keywords_extraction"</span>: QUERY_KEYWORDS_EXTRACTION_PROMPT,
    <span class="hljs-string">"memory_filtering"</span>: MEMORY_FILTERING_PROMPT,
    <span class="hljs-string">"memory_redundancy_filtering"</span>: MEMORY_REDUNDANCY_FILTERING_PROMPT,
    <span class="hljs-string">"memory_combined_filtering"</span>: MEMORY_COMBINED_FILTERING_PROMPT,
    <span class="hljs-string">"memory_answer_ability_evaluation"</span>: MEMORY_ANSWER_ABILITY_EVALUATION_PROMPT,
}
</code></pre>
<h3 data-id="heading-3">0x02 实现</h3>
<h4 data-id="heading-4">2.1 GeneralScheduler</h4>
<p>BaseScheduler是基类，而GeneralScheduler才是真正起作用的派生类。</p>
<p>GeneralScheduler采用生产者-消费者模型进行工作，是基于消息队列的内存调度器。</p>
<ul>
<li>
<p>该类是 MemOS 中基于<code>BaseScheduler</code>的具体调度器实现，专注于处理查询、回答和添加内存等核心任务。核心组件架构：</p>
<ul>
<li>消息队列：使用 memos_message_queue 来存储待处理的消息。</li>
<li>消费者线程：使用 _message_consumer 方法持续轮询队列并处理消息。</li>
<li>分发器：SchedulerDispatcher 负责将消息路由到对应的processor。</li>
<li>处理器：针对不同消息类型的具体processor。</li>
</ul>
</li>
<li>
<p>核心功能包括：</p>
<ul>
<li>注册消息类型（查询 / 回答 / 添加）注册对应的processor，实现任务的定向分发；</li>
<li>处理查询消息时，提取关键词、更新查询监控、执行内存检索与重排序，并支持激活内存的周期性更新；</li>
<li>处理添加内存消息时，记录新增内存日志并同步到监控系统；</li>
<li>基于会话对话轮次逻辑，根据意图检测和时间触发机制决定决定是否执行内存检索，确保工作内存的时效性和相关性。</li>
</ul>
</li>
<li>
<p>特色是基于消息类型的模块化处理机制，结合意图识别和时间触发的混合调度策略，支持按用户和内存立方体分组处理消息，保证多用户场景下的内存隔离和处理效率。</p>
</li>
</ul>
<h5 data-id="heading-5">2.1.1 消息处理</h5>
<p>SchedulerDispatcher将消息路由到适当的处理器。</p>
<h6 data-id="heading-6">消息类型与processor注册</h6>
<p>初始化时注册了三种消息processor。</p>
<pre><code class="hljs language-objectivec" lang="objectivec">        <span class="hljs-meta"># register handlers</span>
        handlers = {
            QUERY_LABEL: <span class="hljs-keyword">self</span>._query_message_consumer,
            ANSWER_LABEL: <span class="hljs-keyword">self</span>._answer_message_consumer,
            ADD_LABEL: <span class="hljs-keyword">self</span>._add_message_consumer,
        }
        <span class="hljs-keyword">self</span>.dispatcher.register_handlers(handlers)
</code></pre>
<ul>
<li>_query_message_consumer：处理用户查询 QUERY_LABEL，触发记忆检索和重排序</li>
<li>_answer_message_consumer：处理系统回答 ANSWER_LABEL。</li>
<li>_add_message_consumer：处理新增记忆请求 ADD_LABEL。</li>
</ul>
<p>QUERY_LABEL在memos/mem_scheduler/schemas/general_schemas.py文件中定义为一个常量：</p>
<ul>
<li>QUERY_LABEL="query"</li>
<li>ANSWER_LABEL ="anSwer"</li>
<li>ADD_LABEL = "add"</li>
</ul>
<p>这是一个预定义的字符串常量，值为"query"。</p>
<h6 data-id="heading-7">消息分发过程</h6>
<ul>
<li>消息提交：通过submit_messages 将ScheduleMessageItem放入消息队列。</li>
<li>消息消费：_message_consumer 线程定期从队列中取出所有消息。</li>
<li>消息分发：调用self.dispatcher.dispatch(messages)按消息标签分发到对应的processor。</li>
</ul>
<h5 data-id="heading-8">2.1.2 流程</h5>
<p>GeneralScheduler的流程如下。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a70ce41552c344929865d4182468c0a5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767011233&amp;x-signature=IVKNM%2F5tc3S%2FrtVy2984pstGgeM%3D" alt="MemScheduler-7-2" loading="lazy"/></p>
<p>MemScheduler-7-2</p>
<h5 data-id="heading-9">2.1.3 完整代码</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">GeneralScheduler</span>(<span class="hljs-title class_ inherited__">BaseScheduler</span>):
    <span class="hljs-string">"""通用调度器，实现查询、回答和添加内存等具体任务的处理逻辑"""</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config: GeneralSchedulerConfig</span>):
        <span class="hljs-string">"""使用给定定配置初始化通用调度器"""</span>
        <span class="hljs-built_in">super</span>().__init__(config)

        <span class="hljs-comment"># 查询关键词数量限制（从配置获取，默认20）</span>
        self.query_key_words_limit = self.config.get(<span class="hljs-string">"query_key_words_limit"</span>, <span class="hljs-number">20</span>)

        <span class="hljs-comment"># 注册消息processor（按消息标签绑定对应的处理方法）</span>
        handlers = {
            QUERY_LABEL: self._query_message_consumer,  <span class="hljs-comment"># 处理查询消息</span>
            ANSWER_LABEL: self._answer_message_consumer,  <span class="hljs-comment"># 处理回答消息</span>
            ADD_LABEL: self._add_message_consumer,  <span class="hljs-comment"># 处理添加内存消息</span>
        }
        self.dispatcher.register_handlers(handlers)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_query_message_consumer</span>(<span class="hljs-params">self, messages: <span class="hljs-built_in">list</span>[ScheduleMessageItem]</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""
        处理和响应队列中的查询触发消息

        参数:
            messages: 要处理的查询消息列表
        """</span>
        <span class="hljs-comment"># 按用户和内存立方体分组处理消息</span>
        grouped_messages = self.dispatcher.group_messages_by_user_and_cube(messages=messages)

        <span class="hljs-comment"># 验证消息合法性（确保标签与消息类型匹配）</span>
        self.validate_schedule_messages(messages=messages, label=QUERY_LABEL)

        <span class="hljs-comment"># 遍历分组消息，按用户和内存立方体处理</span>
        <span class="hljs-keyword">for</span> user_id <span class="hljs-keyword">in</span> grouped_messages:
            <span class="hljs-keyword">for</span> mem_cube_id <span class="hljs-keyword">in</span> grouped_messages[user_id]:
                messages = grouped_messages[user_id][mem_cube_id]
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(messages) == <span class="hljs-number">0</span>:
                    <span class="hljs-keyword">return</span>

                <span class="hljs-comment"># 获取当前内存立方体实例</span>
                mem_cube = messages[<span class="hljs-number">0</span>].mem_cube

                <span class="hljs-comment"># 从消息更新当前上下文（线程安全）</span>
                self._set_current_context_from_message(msg=messages[<span class="hljs-number">0</span>])

                <span class="hljs-comment"># 更新查询监控器（为每个消息注册查询记录）</span>
                <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> messages:
                    <span class="hljs-comment"># 若监控器不存在则创建</span>
                    self.monitor.register_query_monitor_if_not_exists(
                        user_id=user_id, mem_cube_id=mem_cube_id
                    )

                    <span class="hljs-comment"># 提取查询内容和关键词</span>
                    query = msg.content
                    query_keywords = self.monitor.extract_query_keywords(query=query)

                    <span class="hljs-comment"># 关键词提取失败时的 fallback 逻辑</span>
                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(query_keywords) == <span class="hljs-number">0</span>:
                        stripped_query = query.strip()
                        <span class="hljs-comment"># 根据语言类型选择分词方式</span>
                        <span class="hljs-keyword">if</span> is_all_english(stripped_query):
                            words = stripped_query.split()  <span class="hljs-comment"># 英文按空格分词</span>
                        <span class="hljs-keyword">elif</span> is_all_chinese(stripped_query):
                            words = stripped_query  <span class="hljs-comment"># 中文按字符处理</span>
                        <span class="hljs-keyword">else</span>:
                            words = stripped_query  <span class="hljs-comment"># 混合语言默认按字符处理</span>

                        <span class="hljs-comment"># 取前N个关键词（去重）</span>
                        query_keywords = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">set</span>(words[: self.query_key_words_limit]))

                    <span class="hljs-comment"># 创建查询监控项并添加到数据库</span>
                    item = QueryMonitorItem(
                        user_id=user_id,
                        mem_cube_id=mem_cube_id,
                        query_text=query,
                        keywords=query_keywords,
                        max_keywords=DEFAULT_MAX_QUERY_KEY_WORDS,
                    )

                    <span class="hljs-comment"># 同步到数据库</span>
                    query_db_manager = self.monitor.query_monitors[user_id][mem_cube_id]
                    query_db_manager.obj.put(item=item)
                    query_db_manager.sync_with_orm()  <span class="hljs-comment"># 添加后同步到数据库</span>

                <span class="hljs-comment"># 提取所有查询内容</span>
                queries = [msg.content <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> messages]

                <span class="hljs-comment"># 执行会话轮次处理（检索相关内存）</span>
                cur_working_memory, new_candidates = self.process_session_turn(
                    queries=queries,
                    user_id=user_id,
                    mem_cube_id=mem_cube_id,
                    mem_cube=mem_cube,
                    top_k=self.top_k,
                )

                <span class="hljs-comment"># 重排序内存重排序并替换工作内存</span>
                new_order_working_memory = self.replace_working_memory(
                    user_id=user_id,
                    mem_cube_id=mem_cube_id,
                    mem_cube=mem_cube,
                    original_memory=cur_working_memory,
                    new_memory=new_candidates,
                )

                <span class="hljs-comment"># 若启用激活内存，执行周期性更新</span>
                <span class="hljs-keyword">if</span> self.enable_activation_memory:
                    self.update_activation_memory_periodically(
                        interval_seconds=self.monitor.act_mem_update_interval,
                        label=QUERY_LABEL,
                        user_id=user_id,
                        mem_cube_id=mem_cube_id,
                        mem_cube=messages[<span class="hljs-number">0</span>].mem_cube,
                    )

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_answer_message_consumer</span>(<span class="hljs-params">self, messages: <span class="hljs-built_in">list</span>[ScheduleMessageItem]</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""
        处理和响应队列中的回答触发消息

        参数:
          messages: 要处理的回答消息列表
        """</span>
        <span class="hljs-comment"># 按用户和内存立方体分组处理消息</span>
        grouped_messages = self.dispatcher.group_messages_by_user_and_cube(messages=messages)

        <span class="hljs-comment"># 验证消息合法性</span>
        self.validate_schedule_messages(messages=messages, label=ANSWER_LABEL)

        <span class="hljs-comment"># 遍历分组消息，更新上下文（具体回答逻辑可在此扩展）</span>
        <span class="hljs-keyword">for</span> user_id <span class="hljs-keyword">in</span> grouped_messages:
            <span class="hljs-keyword">for</span> mem_cube_id <span class="hljs-keyword">in</span> grouped_messages[user_id]:
                messages = grouped_messages[user_id][mem_cube_id]
                <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(messages) == <span class="hljs-number">0</span>:
                    <span class="hljs-keyword">return</span>

                <span class="hljs-comment"># 从消息更新当前上下文</span>
                self._set_current_context_from_message(msg=messages[<span class="hljs-number">0</span>])

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_add_message_consumer</span>(<span class="hljs-params">self, messages: <span class="hljs-built_in">list</span>[ScheduleMessageItem]</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""处理和响应队列中的添加内存消息"""</span>
        <span class="hljs-comment"># 按用户和内存立方体分组处理消息</span>
        grouped_messages = self.dispatcher.group_messages_by_user_and_cube(messages=messages)

        <span class="hljs-comment"># 验证消息合法性</span>
        self.validate_schedule_messages(messages=messages, label=ADD_LABEL)
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 遍历分组消息，处理每个添加内存请求</span>
            <span class="hljs-keyword">for</span> user_id <span class="hljs-keyword">in</span> grouped_messages:
                <span class="hljs-keyword">for</span> mem_cube_id <span class="hljs-keyword">in</span> grouped_messages[user_id]:
                    messages = grouped_messages[user_id][mem_cube_id]
                    <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(messages) == <span class="hljs-number">0</span>:
                        <span class="hljs-keyword">return</span>

                    <span class="hljs-comment"># 从消息更新当前上下文</span>
                    self._set_current_context_from_message(msg=messages[<span class="hljs-number">0</span>])

                    <span class="hljs-comment"># 处理每条消息中的内存ID列表</span>
                    <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> messages:
                        <span class="hljs-keyword">try</span>:
                            <span class="hljs-comment"># 解析消息内容中的内存ID列表（JSON格式）</span>
                            userinput_memory_ids = json.loads(msg.content)
                        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                            userinput_memory_ids = []

                        <span class="hljs-comment"># 遍历内存ID，记录添加日志（跳过工作内存类型）</span>
                        mem_cube = msg.mem_cube
                        <span class="hljs-keyword">for</span> memory_id <span class="hljs-keyword">in</span> userinput_memory_ids:
                            mem_item: TextualMemoryItem = mem_cube.text_mem.get(memory_id=memory_id)
                            mem_type = mem_item.metadata.memory_type
                            mem_content = mem_item.memory

                            <span class="hljs-comment"># 跳过工作内存（通常不需要手动添加）</span>
                            <span class="hljs-keyword">if</span> mem_type == WORKING_MEMORY_TYPE:
                                <span class="hljs-keyword">continue</span>

                            <span class="hljs-comment"># 记录添加内存的日志</span>
                            self.log_adding_memory(
                                memory=mem_content,
                                memory_type=mem_type,
                                user_id=msg.user_id,
                                mem_cube_id=msg.mem_cube_id,
                                mem_cube=msg.mem_cube,
                                log_func_callback=self._submit_web_logs,
                            )

        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            logger.error(<span class="hljs-string">f"Error: <span class="hljs-subst">{e}</span>"</span>, exc_info=<span class="hljs-literal">True</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_session_turn</span>(<span class="hljs-params">
        self,
        queries: <span class="hljs-built_in">str</span> | <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>],
        user_id: UserID | <span class="hljs-built_in">str</span>,
        mem_cube_id: MemCubeID | <span class="hljs-built_in">str</span>,
        mem_cube: GeneralMemCube,
        top_k: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span>,
    </span>) -&gt; <span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">list</span>[TextualMemoryItem], <span class="hljs-built_in">list</span>[TextualMemoryItem]] | <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""
        处理对话轮次：
        - 当查询列表达到窗口大小时，触发内存检索；
        - 若检索被触发，立即切换到新内存。
        """</span>

        <span class="hljs-comment"># 获取文本内存实例（仅支持TreeTextMemory类型）</span>
        text_mem_base = mem_cube.text_mem
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(text_mem_base, TreeTextMemory):
            logger.error(
                <span class="hljs-string">f"未实现！期望TreeTextMemory，但获取到<span class="hljs-subst">{<span class="hljs-built_in">type</span>(text_mem_base).__name__}</span> "</span>
                <span class="hljs-string">f"（mem_cube_id=<span class="hljs-subst">{mem_cube_id}</span>，user_id=<span class="hljs-subst">{user_id}</span>）。 "</span>
                <span class="hljs-string">f"text_mem_base值：<span class="hljs-subst">{text_mem_base}</span>"</span>,
                exc_info=<span class="hljs-literal">True</span>,
            )
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>

        <span class="hljs-comment"># 获取当前工作内存及文本内容</span>
        cur_working_memory: <span class="hljs-built_in">list</span>[TextualMemoryItem] = text_mem_base.get_working_memory()
        text_working_memory: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>] = [w_m.memory <span class="hljs-keyword">for</span> w_m <span class="hljs-keyword">in</span> cur_working_memory]
        <span class="hljs-comment"># 检测查询意图（判断是否需要触发检索）</span>
        intent_result = self.monitor.detect_intent(
            q_list=queries, text_working_memory=text_working_memory
        )

        <span class="hljs-comment"># 检查是否达到时间触发条件</span>
        time_trigger_flag = <span class="hljs-literal">False</span>
        <span class="hljs-keyword">if</span> self.monitor.timed_trigger(
            last_time=self.monitor.last_query_consume_time,
            interval_seconds=self.monitor.query_trigger_interval,
        ):
            time_trigger_flag = <span class="hljs-literal">True</span>

        <span class="hljs-comment"># 根据意图和时间触发条件决定是否执行检索</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">not</span> intent_result[<span class="hljs-string">"trigger_retrieval"</span>]) <span class="hljs-keyword">and</span> (<span class="hljs-keyword">not</span> time_trigger_flag):
            <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
        <span class="hljs-keyword">elif</span> (<span class="hljs-keyword">not</span> intent_result[<span class="hljs-string">"trigger_retrieval"</span>]) <span class="hljs-keyword">and</span> time_trigger_flag:
            intent_result[<span class="hljs-string">"trigger_retrieval"</span>] = <span class="hljs-literal">True</span>
            intent_result[<span class="hljs-string">"missing_evidences"</span>] = queries
        <span class="hljs-keyword">else</span>:
            logger.info(
                <span class="hljs-string">f"触发查询调度（user_id=<span class="hljs-subst">{user_id}</span>，mem_cube_id=<span class="hljs-subst">{mem_cube_id}</span>）。 "</span>
                <span class="hljs-string">f"缺失证据：<span class="hljs-subst">{intent_result[<span class="hljs-string">'missing_evidences'</span>]}</span>"</span>
            )

        <span class="hljs-comment"># 处理缺失的证据（需要检索的内容）</span>
        missing_evidences = intent_result[<span class="hljs-string">"missing_evidences"</span>]
        num_evidence = <span class="hljs-built_in">len</span>(missing_evidences)
        <span class="hljs-comment"># 为每个证据分配Top-K配额（确保至少返回1条）</span>
        k_per_evidence = <span class="hljs-built_in">max</span>(<span class="hljs-number">1</span>, top_k // <span class="hljs-built_in">max</span>(<span class="hljs-number">1</span>, num_evidence))
        new_candidates = []

        <span class="hljs-comment"># 为每个缺失证据执行检索</span>
        <span class="hljs-keyword">for</span> item <span class="hljs-keyword">in</span> missing_evidences:
            info = {
                <span class="hljs-string">"user_id"</span>: user_id,
                <span class="hljs-string">"session_id"</span>: <span class="hljs-string">""</span>,
            }

            <span class="hljs-comment"># 执行检索</span>
            results: <span class="hljs-built_in">list</span>[TextualMemoryItem] = self.retriever.search(
                query=item,
                mem_cube=mem_cube,
                top_k=k_per_evidence,
                method=self.search_method,
                info=info,
            )
            new_candidates.extend(results)

        <span class="hljs-comment"># 返回当前工作内存和新检索到的候选内存</span>
        <span class="hljs-keyword">return</span> cur_working_memory, new_candidates
</code></pre>
<h4 data-id="heading-10">2.2 SchedulerDispatcher</h4>
<p>SchedulerDispatcher 负责将消息路由到对应的processor。SchedulerDispatcher 不使用任何模型进行消息分发或分类判断。下面是它的工作原理：</p>
<ul>
<li>该类是基于线程池的消息分发器，核心作用是根据消息标签（label）将消息路由到对应的processor，实现消息的定向批量处理。</li>
<li>核心功能包括：支持单个 / 批量注册消息processor、按用户 ID 和内存立方体 ID 分组消息、串行 / 并行两种分发模式、优雅关闭和任务监控。</li>
<li>特色是采用上下文感知线程池（ContextThreadPoolExecutor），支持并行任务执行以提升效率；消息分组机制保证同用户同内存立方体的消息集中处理，避免上下文混乱；完善的任务生命周期管理（取消、等待、异常捕获）确保系统稳定。</li>
</ul>
<h5 data-id="heading-11">2.2.1 分发逻辑</h5>
<p>SchedulerDispatcher 是基于消息标签进行操作的，而不是使用任何机器学习模型或大语言模型进行分类，具体分发逻辑如下：</p>
<ul>
<li>
<p>消息分组：将消息按标签进行分组。</p>
</li>
<li>
<p>processor查找：依据标签查找注册的processor。处理函数在初始化时被明确注册。</p>
</li>
<li>
<p>执行模式：</p>
<ul>
<li>串行模式：直接调用processor</li>
<li>并行模式：通过线程池异步执行</li>
</ul>
</li>
</ul>
<p>消息通过其标签属性进行分发</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ScheduleMessageItem</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, label: <span class="hljs-built_in">str</span>, content: <span class="hljs-built_in">str</span>, ...</span>):
        self.label = label  <span class="hljs-comment"># 分发键</span>
        self.content = content
        <span class="hljs-comment"># ... 其他属性</span>
</code></pre>
<p>调度器使用简单的字典查找来路由消息到处理函数，在 SchedulerDispatcher.dispatch() 中：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">label_groups</span> = defaultdict(list)
for message in msg_list:
    label_groups<span class="hljs-section">[message.label]</span>.append(message)  <span class="hljs-comment"># 按标签分组</span>

for label, msgs in label_groups.items():
    <span class="hljs-attr">handler</span> = self.handlers.get(label, self._default_message_handler)
    handler(msgs)  <span class="hljs-comment"># 基于标签直接调用函数</span>
</code></pre>
<p>当启用并行分发时，也只是并行执行处理函数，但仍不使用模型进行路由：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">if</span> self.enable_parallel_dispatch <span class="hljs-keyword">and</span> self.dispatcher_executor <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
    future = self.dispatcher_executor.submit(handler, msgs)  <span class="hljs-comment"># 并行执行</span>
</code></pre>
<p>消息流程示例</p>
<pre><code class="hljs language-arduino" lang="arduino">传入消息
├── 带有标签的消息 <span class="hljs-string">"query"</span>
│       ├── 没有模型参与确定使用哪个处理函数
│       │
│       ├── 按标签分组
│       │
│       └── 查找 <span class="hljs-string">"query"</span> 处理函数
│           ├── 调用已注册的 _query_message_consumer 函数直接调用
│
└── 并行处理（如果启用）
</code></pre>
<h5 data-id="heading-12">2.2.2 流程</h5>
<p>SchedulerDispatcher的流程如下。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72baa10ecb074c20bcd83eb8325dcae9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767011233&amp;x-signature=QM4TR0FenXbmB1QYPpU%2BZswUP%2Fg%3D" alt="MemScheduler-7-3" loading="lazy"/></p>
<p>MemScheduler-7-3</p>
<h5 data-id="heading-13">2.2.3 代码</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SchedulerDispatcher</span>(<span class="hljs-title class_ inherited__">BaseSchedulerModule</span>):
    <span class="hljs-string">"""
    基于线程池的消息分发器，根据消息标签将消息路由到专用processor。

    特性：
    - 每个消息标签对应独立的线程池处理逻辑
    - 支持批量消息处理
    - 支持优雅关闭
    - 支持批量注册processor
    """</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, max_workers=<span class="hljs-number">30</span>, enable_parallel_dispatch=<span class="hljs-literal">False</span></span>):
        <span class="hljs-built_in">super</span>().__init__()
        self.max_workers = max_workers  <span class="hljs-comment"># 线程池最大工作线程数</span>

        <span class="hljs-comment"># 仅在并行模式下初始化线程池</span>
        self.enable_parallel_dispatch = enable_parallel_dispatch
        self.thread_name_prefix = <span class="hljs-string">"dispatcher"</span>  <span class="hljs-comment"># 线程名称前缀</span>
        <span class="hljs-keyword">if</span> self.enable_parallel_dispatch:
            self.dispatcher_executor = ContextThreadPoolExecutor(
                max_workers=self.max_workers, thread_name_prefix=self.thread_name_prefix
            )
        <span class="hljs-keyword">else</span>:
            self.dispatcher_executor = <span class="hljs-literal">None</span>  <span class="hljs-comment"># 串行模式下线程池为None</span>

        self.handlers: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Callable</span>] = {}  <span class="hljs-comment"># 已注册的消息processor（标签→processor映射）</span>
        self._running = <span class="hljs-literal">False</span>  <span class="hljs-comment"># 分发器运行状态标识</span>
        self._futures = <span class="hljs-built_in">set</span>()  <span class="hljs-comment"># 用于监控的活跃任务集合</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">register_handler</span>(<span class="hljs-params">self, label: <span class="hljs-built_in">str</span>, handler: <span class="hljs-type">Callable</span>[[<span class="hljs-built_in">list</span>[ScheduleMessageItem]], <span class="hljs-literal">None</span>]</span>):
        <span class="hljs-string">"""
        为特定消息标签注册processor函数。

        参数:
            label: 要处理的消息标签
            handler: 处理该标签消息的可调用对象，接收消息列表作为参数
        """</span>
        self.handlers[label] = handler

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">register_handlers</span>(<span class="hljs-params">
        self, handlers: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Callable</span>[[<span class="hljs-built_in">list</span>[ScheduleMessageItem]], <span class="hljs-literal">None</span>]]
    </span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""
        从字典中批量注册多个processor。

        参数:
            handlers: 标签到processor函数的映射字典，格式：{标签: processor可调用对象}
        """</span>
        <span class="hljs-keyword">for</span> label, handler <span class="hljs-keyword">in</span> handlers.items():
            <span class="hljs-comment"># 验证标签类型（必须为字符串）</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(label, <span class="hljs-built_in">str</span>):
                <span class="hljs-keyword">continue</span>
            <span class="hljs-comment"># 验证processor是否可调用</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">callable</span>(handler):
                <span class="hljs-keyword">continue</span>
            <span class="hljs-comment"># 注册单个processor</span>
            self.register_handler(label=label, handler=handler)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_default_message_handler</span>(<span class="hljs-params">self, messages: <span class="hljs-built_in">list</span>[ScheduleMessageItem]</span>) -&gt; <span class="hljs-literal">None</span>:
        <span class="hljs-string">"""默认消息processor（当找不到对应标签的processor时使用）"""</span>
        logger.debug(<span class="hljs-string">f"使用默认消息processor处理消息：<span class="hljs-subst">{messages}</span>"</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">group_messages_by_user_and_cube</span>(<span class="hljs-params">
        self, messages: <span class="hljs-built_in">list</span>[ScheduleMessageItem]
    </span>) -&gt; <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">list</span>[ScheduleMessageItem]]]:
        <span class="hljs-string">"""
        将消息按用户ID和内存立方体ID分组，生成嵌套字典结构。

        参数:
            messages: 要分组的ScheduleMessageItem对象列表

        返回:
            嵌套字典，结构如下：
            {
                "user_id_1": {
                    "mem_cube_id_1": [消息1, 消息2, ...],
                    "mem_cube_id_2": [消息3, 消息4, ...],
                    ...
                },
                "user_id_2": {
                    ...
                },
                ...
            }
            其中每个消息保持原始ScheduleMessageItem对象
        """</span>
        <span class="hljs-comment"># 初始化嵌套默认字典（自动创建不存在的键）</span>
        grouped_dict = defaultdict(<span class="hljs-keyword">lambda</span>: defaultdict(<span class="hljs-built_in">list</span>))

        <span class="hljs-comment"># 按用户ID→内存立方体ID的层级分组消息</span>
        <span class="hljs-keyword">for</span> msg <span class="hljs-keyword">in</span> messages:
            grouped_dict[msg.user_id][msg.mem_cube_id].append(msg)

        <span class="hljs-comment"># 将默认字典转换为普通字典，输出更简洁</span>
        <span class="hljs-keyword">return</span> {user_id: <span class="hljs-built_in">dict</span>(cube_groups) <span class="hljs-keyword">for</span> user_id, cube_groups <span class="hljs-keyword">in</span> grouped_dict.items()}

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_handle_future_result</span>(<span class="hljs-params">self, future: Future</span>):
        <span class="hljs-string">"""处理异步任务结果，捕获异常并清理任务集合"""</span>
        self._futures.remove(future)  <span class="hljs-comment"># 从活跃任务集合中移除已完成任务</span>
         future.result()  <span class="hljs-comment"># 获取任务结果，触发可能的异常</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">dispatch</span>(<span class="hljs-params">self, msg_list: <span class="hljs-built_in">list</span>[ScheduleMessageItem]</span>):
        <span class="hljs-string">"""
        将消息列表分发到对应的processor。

        参数:
            msg_list: 要处理的ScheduleMessageItem对象列表
        """</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> msg_list:
            <span class="hljs-keyword">return</span>

        <span class="hljs-comment"># 按消息标签分组（同一标签的消息交给同一个processor）</span>
        label_groups = defaultdict(<span class="hljs-built_in">list</span>)
        <span class="hljs-keyword">for</span> message <span class="hljs-keyword">in</span> msg_list:
            label_groups[message.label].append(message)

        <span class="hljs-comment"># 处理每个标签对应的消息组</span>
        <span class="hljs-keyword">for</span> label, msgs <span class="hljs-keyword">in</span> label_groups.items():
            <span class="hljs-comment"># 获取该标签对应的processor，无则使用默认processor</span>
            handler = self.handlers.get(label, self._default_message_handler)
            <span class="hljs-comment"># 并行模式：提交任务到线程池异步执行</span>
            <span class="hljs-keyword">if</span> self.enable_parallel_dispatch <span class="hljs-keyword">and</span> self.dispatcher_executor <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
                <span class="hljs-comment"># 提交任务到线程池，捕获变量避免循环引用问题</span>
                future = self.dispatcher_executor.submit(handler, msgs)
                self._futures.add(future)  <span class="hljs-comment"># 将任务添加到活跃任务集合</span>
                <span class="hljs-comment"># 绑定任务完成回调函数</span>
                future.add_done_callback(self._handle_future_result)
                logger.info(<span class="hljs-string">f"已将 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(msgs)}</span> 条消息作为异步任务分发"</span>)
            <span class="hljs-comment"># 串行模式：直接调用processor同步执行</span>
            <span class="hljs-keyword">else</span>:
                handler(msgs)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">join</span>(<span class="hljs-params">self, timeout: <span class="hljs-built_in">float</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
        <span class="hljs-string">"""等待所有已分发任务完成。

        参数:
            timeout: 最大等待时间（秒），None表示无限等待

        返回:
            bool: 所有任务完成返回True，超时返回False
        """</span>
        <span class="hljs-comment"># 串行模式下无异步任务，直接返回True</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> self.enable_parallel_dispatch <span class="hljs-keyword">or</span> self.dispatcher_executor <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-literal">True</span>

        <span class="hljs-comment"># 等待所有活跃任务完成</span>
        done, not_done = concurrent.futures.wait(
            self._futures, timeout=timeout, return_when=concurrent.futures.ALL_COMPLETED
        )

        <span class="hljs-comment"># 检查已完成任务中的异常</span>
        <span class="hljs-keyword">for</span> future <span class="hljs-keyword">in</span> done:
            <span class="hljs-keyword">try</span>:
                future.result()
            <span class="hljs-keyword">except</span> Exception:
                logger.error(<span class="hljs-string">"关闭过程中processor执行失败"</span>, exc_info=<span class="hljs-literal">True</span>)

        <span class="hljs-comment"># 返回是否所有任务都已完成</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">len</span>(not_done) == <span class="hljs-number">0</span>
</code></pre>
<h4 data-id="heading-14">2.3 SchedulerRetriever</h4>
<p>SchedulerRetriever 是MemOS中负责记忆检索和重排序的核心模块，是连接查询和记忆存储的关键桥梁，负责确保系统能够准确、高效地检索和排序相关记忆。</p>
<p>内存检索与推理的本质是：在正确时间找到正确信息。</p>
<h5 data-id="heading-15">2.3.1 功能</h5>
<p>SchedulerRetriever 的功能如下：</p>
<ul>
<li>
<p>记忆检索功能</p>
<ul>
<li>
<p>搜索实现：通过 search 方法在文本记忆库中查找与查询相关的记忆项</p>
</li>
<li>
<p>支持多种搜索模式：</p>
<ul>
<li>快速搜索（fast mode）</li>
<li>精细搜索（fine mode）</li>
<li>多类型记忆检索：同时搜索长期记忆和用户记忆</li>
</ul>
</li>
</ul>
</li>
<li>
<p>记忆重排序</p>
<ul>
<li>LLM辅助重排序：使用 rerank_memories 方法通过大语言模型对检索到的记忆进行重新排序</li>
<li>智能相关性判断：基于查询内容判断记忆的相关性，提升记忆使用的准确性</li>
</ul>
</li>
<li>
<p>记忆处理与过滤</p>
<ul>
<li>记忆去重：使用 filter_vector_based_similar_memories 过滤过于相似的记忆项</li>
<li>长度过滤：使用 filter_too_short_memories 移除过短的记忆项</li>
<li>无关记忆过滤：通过 filter_unrelated_memories 移除与当前查询历史无关的记忆</li>
<li>冗余记忆过滤：通过 filter_redundant_memories 移除重复的记忆项</li>
</ul>
</li>
<li>
<p>记忆整合：在 process_and_rerank_memories 方法中整合原始记忆和新检索的记忆，进行统一处理</p>
</li>
</ul>
<h5 data-id="heading-16">2.3.2 详细步骤说明</h5>
<p>SchedulerRetriever 的详细步骤如下：</p>
<ul>
<li>搜索阶段：根据查询在 TreeTextMemory 中搜索相关记忆项</li>
<li>合并阶段：将原始记忆和新检索的记忆合并成一个列表</li>
<li>相似度过滤：使用相似度移除过于相似的记忆项</li>
<li>长度过滤：移除过短的记忆项（默认阈值为6个字符）</li>
<li>去重处理：确保记忆项唯一性，同时保持原有顺序</li>
<li>LLM重排序：利用大语言模型根据查询相关性对记忆进行重新排序</li>
<li>无关记忆过滤：移除与查询历史无关的记忆项</li>
<li>返回结果：返回优化后的记忆列表供系统使用</li>
</ul>
<h5 data-id="heading-17">2.3.3 调用关系</h5>
<p>一般来说，业界的<strong>检索时机</strong>有两种主要方法：</p>
<ul>
<li><strong>主动检索</strong>：在每轮开始时自动加载记忆，确保上下文始终可用，但会为不需要记忆访问的轮次引入不必要延迟</li>
<li><strong>反应式检索</strong>（内存即工具）：代理被赋予查询记忆的工具，自行决定何时检索上下文，更高效但需要额外LLM调用</li>
</ul>
<p>SchedulerRetriever 作为 BaseScheduler 的核心组件，主要在处理用户查询和更新工作记忆时被调用，负责记忆的检索、处理、重排序和过滤等核心功能，具体场景为：</p>
<ul>
<li>初始化：在BaseScheduler 的initialize_modules中建立SchedulerRetriever 实例。</li>
<li>查询处理：当 GeneralScheduler 接收到 QUERY_LABEL 消息时，调用 process_session_turn 方法触发 self.retriever.search() 来检索相关记忆。</li>
<li>工作记忆更新：在 replace_working_memory 过程中对候选记忆进行处理和重排序</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">└── GeneralScheduler<span class="hljs-selector-class">._query_message_consumer</span>()
  └── BaseScheduler<span class="hljs-selector-class">.process_session_turn</span>()
      └── SchedulerRetriever<span class="hljs-selector-class">.search</span>() --------&gt; 检索相关记忆

└── BaseScheduler<span class="hljs-selector-class">.replace_working_memory</span>()
  └── SchedulerRetriever<span class="hljs-selector-class">.process_and_rerank_memories</span>() ------&gt; 处理和重排序记忆
      └──SchedulerRetriever<span class="hljs-selector-class">.filter_unrelated_memories</span>() -----&gt; 过滤无关记忆
</code></pre>
<h5 data-id="heading-18">2.3.4 实现</h5>
<h6 data-id="heading-19">记忆检索流程（search 方法）</h6>
<p>作为对比，从业界角度看，一般会从多个维度评估潜在记忆，单纯依赖基于向量的相关性是常见陷阱。相似性得分可能找出概念相似但过时或琐碎的记忆。最有效策略是结合所有三个维度的混合方法：</p>
<ul>
<li><strong>相关性</strong>（语义相似性）：与当前对话的概念关联度</li>
<li><strong>新鲜度</strong>（基于时间）：记忆创建的时间远近</li>
<li><strong>重要性</strong>（显著性）：记忆的整体关键程度</li>
</ul>
<p>SchedulerRetriever的 search方法会 调用TreeTextMemory的功能来进行搜索。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b481cf8e011f472a93424e1e15ebcf75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767011233&amp;x-signature=vlJ44ps50w2OktbWa8%2FP72Vmhds%3D" alt="MemScheduler-7-4" loading="lazy"/></p>
<p>MemScheduler-7-4</p>
<h6 data-id="heading-20">记忆全流程处理与重排（process_and_rerank_memories 方法）</h6>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60961cfd9ddc4878b29ef610db7835ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767011233&amp;x-signature=hFyWesdUUFA1SLK85KM1y9ovhJA%3D" alt="MemScheduler-7-5" loading="lazy"/></p>
<p>MemScheduler-7-5</p>
<h6 data-id="heading-21">LLM 记忆重排流程（rerank_memories 方法）</h6>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fbc35684fd284404a9c275d6bf56cd1e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg572X6KW_55qE5oCd6ICD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767011233&amp;x-signature=Sbr9MiAczBUq0rFkB5%2BXweQCcTk%3D" alt="MemScheduler-7-6" loading="lazy"/></p>
<p>MemScheduler-7-6</p>
<h6 data-id="heading-22">代码</h6>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SchedulerRetriever</span>(<span class="hljs-title class_ inherited__">BaseSchedulerModule</span>):
    <span class="hljs-string">"""
    MemOS 记忆检索与优化调度器
    核心功能：检索树状文本内存、合并新旧记忆、多维度过滤、LLM 智能重排，为 Agent 提供精准记忆支持
    继承自 BaseSchedulerModule，遵循 MemOS 调度器模块统一接口规范
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, process_llm: BaseLLM, config: BaseSchedulerConfig</span>):
        <span class="hljs-string">"""
        初始化检索调度器实例
        Args:
            process_llm: 用于记忆重排的 LLM 实例（BaseLLM 基类对象）
            config: 调度器配置对象（BaseSchedulerConfig 基类，包含过滤、检索等参数）
        """</span>
        <span class="hljs-built_in">super</span>().__init__()  <span class="hljs-comment"># 调用父类 BaseSchedulerModule 的初始化方法</span>

        <span class="hljs-comment"># 超参数配置：记忆过滤阈值</span>
        self.filter_similarity_threshold = <span class="hljs-number">0.75</span>  <span class="hljs-comment"># 相似度过滤阈值（≥0.75 的记忆视为重复）</span>
        self.filter_min_length_threshold = <span class="hljs-number">6</span>     <span class="hljs-comment"># 长度过滤阈值（字符数＜6 的记忆视为过短，将被过滤）</span>

        self.config: BaseSchedulerConfig = config  <span class="hljs-comment"># 保存调度器配置</span>
        self.process_llm = process_llm             <span class="hljs-comment"># 保存用于重排的 LLM 实例</span>

        <span class="hljs-comment"># 初始化记忆过滤器：委托处理「无关记忆」和「冗余记忆」过滤逻辑</span>
        self.memory_filter = MemoryFilter(process_llm=process_llm, config=config)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">search</span>(<span class="hljs-params">
        self,
        query: <span class="hljs-built_in">str</span>,
        mem_cube: GeneralMemCube,
        top_k: <span class="hljs-built_in">int</span>,
        method: <span class="hljs-built_in">str</span> = TreeTextMemory_SEARCH_METHOD,
        info: <span class="hljs-built_in">dict</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
    </span>) -&gt; <span class="hljs-built_in">list</span>[TextualMemoryItem]:
        <span class="hljs-string">"""
        根据查询语句在文本内存中检索相关记忆
        Args:
            query: 检索查询字符串（如 Agent 的当前对话查询）
            mem_cube: 记忆立方体（GeneralMemCube，MemOS 中存储各类记忆的核心数据结构）
            top_k: 返回的Top-K 相关记忆数量
            method: 检索方法（默认使用 TreeTextMemory 的标准搜索方法）
            info: 检索附加信息（需包含 user_id、session_id，用于记录记忆使用历史）

        Returns:
            检索到的文本型记忆项列表（list[TextualMemoryItem]）；检索失败返回空列表
        """</span>
        text_mem_base = mem_cube.text_mem  <span class="hljs-comment"># 从记忆立方体中提取文本内存核心实例</span>
        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 仅支持 TreeTextMemory 的两种检索方法</span>
            <span class="hljs-keyword">if</span> method <span class="hljs-keyword">in</span> [TreeTextMemory_SEARCH_METHOD, TreeTextMemory_FINE_SEARCH_METHOD]:
                <span class="hljs-comment"># 断言文本内存类型为 TreeTextMemory（确保检索方法兼容性）</span>
                <span class="hljs-keyword">assert</span> <span class="hljs-built_in">isinstance</span>(text_mem_base, TreeTextMemory)
                <span class="hljs-comment"># 若未传入 info，打印警告并初始化空信息（用于历史记录存储）</span>
                <span class="hljs-keyword">if</span> info <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
                    info = {<span class="hljs-string">"user_id"</span>: <span class="hljs-string">""</span>, <span class="hljs-string">"session_id"</span>: <span class="hljs-string">""</span>}

                <span class="hljs-comment"># 根据检索方法设置模式：快速搜索（fast）或精细搜索（fine）</span>
                mode = <span class="hljs-string">"fast"</span> <span class="hljs-keyword">if</span> method == TreeTextMemory_SEARCH_METHOD <span class="hljs-keyword">else</span> <span class="hljs-string">"fine"</span>
                <span class="hljs-comment"># 检索长期记忆（LongTermMemory）</span>
                results_long_term = text_mem_base.search(
                    query=query, top_k=top_k, memory_type=<span class="hljs-string">"LongTermMemory"</span>, mode=mode, info=info
                )
                <span class="hljs-comment"># 检索用户记忆（UserMemory）</span>
                results_user = text_mem_base.search(
                    query=query, top_k=top_k, memory_type=<span class="hljs-string">"UserMemory"</span>, mode=mode, info=info
                )
                <span class="hljs-comment"># 合并长期记忆和用户记忆的检索结果</span>
                results = results_long_term + results_user
            <span class="hljs-keyword">else</span>:
                <span class="hljs-comment"># 不支持的检索方法：抛出未实现异常（传入文本内存类型）</span>
                <span class="hljs-keyword">raise</span> NotImplementedError(<span class="hljs-built_in">str</span>(<span class="hljs-built_in">type</span>(text_mem_base)))
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-comment"># 检索异常：打印错误日志（包含堆栈信息），返回空列表</span>
            logger.error(<span class="hljs-string">f"Fail to search. The exeption is <span class="hljs-subst">{e}</span>."</span>, exc_info=<span class="hljs-literal">True</span>)
            results = []
        <span class="hljs-keyword">return</span> results

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">rerank_memories</span>(<span class="hljs-params">
        self, queries: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>], original_memories: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>], top_k: <span class="hljs-built_in">int</span>
    </span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>], <span class="hljs-built_in">bool</span>]:
        <span class="hljs-string">"""
        基于 LLM 对记忆进行相关性重排（根据查询语句调整记忆顺序）
        Args:
            queries: 用于判断相关性的查询列表（通常为当前对话查询）
            original_memories: 待重排的记忆文本列表
            top_k: 重排后返回的 Top-K 记忆数量

        Returns:
            Tuple[重排后的记忆文本列表（长度≤top_k）, 重排成功标志（bool）]

        Note:
            若 LLM 重排失败（如 JSON 解析异常），降级为原始记忆顺序（截断至 top_k）
        """</span>

        logger.info(<span class="hljs-string">f"Starting memory reranking for <span class="hljs-subst">{<span class="hljs-built_in">len</span>(original_memories)}</span> memories"</span>)

        <span class="hljs-comment"># 构建 LLM 重排提示词（使用 "memory_reranking" 模板）</span>
        prompt = self.build_prompt(
            <span class="hljs-string">"memory_reranking"</span>,
            queries=[<span class="hljs-string">f"[0] <span class="hljs-subst">{queries[<span class="hljs-number">0</span>]}</span>"</span>],  <span class="hljs-comment"># 格式化查询（仅取第一个查询，标记为 [0]）</span>
            current_order=[<span class="hljs-string">f"[<span class="hljs-subst">{i}</span>] <span class="hljs-subst">{mem}</span>"</span> <span class="hljs-keyword">for</span> i, mem <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(original_memories)],  <span class="hljs-comment"># 格式化原始记忆顺序</span>
        )

        <span class="hljs-comment"># 调用 LLM 生成重排结果（构造用户角色消息）</span>
        response = self.process_llm.generate([{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: prompt}])

        <span class="hljs-keyword">try</span>:
            <span class="hljs-comment"># 解析 LLM 响应中的 JSON 数据（期望格式：{"new_order": [索引列表], "reasoning": "重排理由"}）</span>
            response = extract_json_dict(response)
            new_order = response[<span class="hljs-string">"new_order"</span>][:top_k]  <span class="hljs-comment"># 提取 Top-K 索引顺序</span>
            <span class="hljs-comment"># 根据新索引映射回原始记忆文本</span>
            text_memories_with_new_order = [original_memories[idx] <span class="hljs-keyword">for</span> idx <span class="hljs-keyword">in</span> new_order]
            success_flag = <span class="hljs-literal">True</span>  <span class="hljs-comment"># 重排成功标志</span>
        <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
            <span class="hljs-comment"># 重排异常（如 JSON 解析失败、键缺失）：打印错误日志，使用原始顺序降级</span>
            text_memories_with_new_order = original_memories[:top_k]  <span class="hljs-comment"># 截断原始记忆至 top_k</span>
            success_flag = <span class="hljs-literal">False</span>  <span class="hljs-comment"># 重排失败标志</span>
        <span class="hljs-keyword">return</span> text_memories_with_new_order, success_flag

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_and_rerank_memories</span>(<span class="hljs-params">
        self,
        queries: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>],
        original_memory: <span class="hljs-built_in">list</span>[TextualMemoryItem],
        new_memory: <span class="hljs-built_in">list</span>[TextualMemoryItem],
        top_k: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span>,
    </span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-type">Optional</span>[<span class="hljs-built_in">list</span>[TextualMemoryItem]], <span class="hljs-built_in">bool</span>]:
        <span class="hljs-string">"""
        记忆全流程处理：合并新旧记忆 → 过滤冗余/过短记忆 → LLM 重排 → 返回优化后记忆
        Args:
            queries: 用于重排的查询列表（判断记忆相关性的依据）
            original_memory: 原始记忆列表（已存储的历史记忆，TextualMemoryItem 类型）
            new_memory: 新记忆列表（待合并的新增记忆，TextualMemoryItem 类型）
            top_k: 最终返回的最大记忆数量（默认 10）

        Returns:
            Tuple[优化后的 TextualMemoryItem 列表（长度≤top_k）, 处理成功标志（bool）]；失败返回 (None, False)
        """</span>
        <span class="hljs-comment"># 1. 合并原始记忆和新记忆（形成完整记忆池）</span>
        combined_memory = original_memory + new_memory

        <span class="hljs-comment"># 2. 构建「归一化文本→记忆对象」的映射（用于后续重排后还原记忆对象）</span>
        <span class="hljs-comment"># transform_name_to_key：文本归一化函数（如去空格、小写，确保匹配一致性）</span>
        memory_map = {
            transform_name_to_key(name=mem_obj.memory): mem_obj <span class="hljs-keyword">for</span> mem_obj <span class="hljs-keyword">in</span> combined_memory
        }

        <span class="hljs-comment"># 2. 提取所有记忆的文本内容（用于过滤和重排）</span>
        combined_text_memory = [m.memory <span class="hljs-keyword">for</span> m <span class="hljs-keyword">in</span> combined_memory]

        <span class="hljs-comment"># 4. 相似度过滤：移除过于相似的记忆（基于向量相似度，阈值 0.75）</span>
        filtered_combined_text_memory = filter_vector_based_similar_memories(
            text_memories=combined_text_memory,
            similarity_threshold=self.filter_similarity_threshold,
        )

        <span class="hljs-comment"># 5. 长度过滤：移除过短记忆（字符数＜6 的记忆视为无效，阈值 6）</span>
        filtered_combined_text_memory = filter_too_short_memories(
            text_memories=filtered_combined_text_memory,
            min_length_threshold=self.filter_min_length_threshold,
        )

        <span class="hljs-comment"># 6. 去重：基于归一化文本的字典去重（保留原始顺序）</span>
        unique_memory = <span class="hljs-built_in">list</span>(<span class="hljs-built_in">dict</span>.fromkeys(filtered_combined_text_memory))

        <span class="hljs-comment"># 7. LLM 智能重排：按与查询的相关性调整记忆顺序</span>
        text_memories_with_new_order, success_flag = self.rerank_memories(
            queries=queries,
            original_memories=unique_memory,
            top_k=top_k,
        )

        <span class="hljs-comment"># 8. 映射回原始记忆对象（从文本列表还原为 TextualMemoryItem 列表）</span>
        memories_with_new_order = []
        <span class="hljs-keyword">for</span> text <span class="hljs-keyword">in</span> text_memories_with_new_order:
            normalized_text = transform_name_to_key(name=text)  <span class="hljs-comment"># 文本归一化（确保与 memory_map 键匹配）</span>
            <span class="hljs-keyword">if</span> normalized_text <span class="hljs-keyword">in</span> memory_map:  <span class="hljs-comment"># 检查归一化文本是否存在于映射中</span>
                memories_with_new_order.append(memory_map[normalized_text])
            <span class="hljs-keyword">else</span>:
                <span class="hljs-comment"># 日志警告：记忆文本未找到映射（可能是归一化异常或记忆对象缺失）</span>
                logger.warning(
                    <span class="hljs-string">f"Memory text not found in memory map. text: <span class="hljs-subst">{text}</span>;\n"</span>
                    <span class="hljs-string">f"Keys of memory_map: <span class="hljs-subst">{memory_map.keys()}</span>"</span>
                )

        <span class="hljs-keyword">return</span> memories_with_new_order, success_flag

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_unrelated_memories</span>(<span class="hljs-params">
        self,
        query_history: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>],
        memories: <span class="hljs-built_in">list</span>[TextualMemoryItem],
    </span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">list</span>[TextualMemoryItem], <span class="hljs-built_in">bool</span>]:
        <span class="hljs-string">"""
        过滤与查询历史无关的记忆（委托给 MemoryFilter 实现）
        Args:
            query_history: 查询历史列表（Agent 的对话历史）
            memories: 待过滤的记忆列表（TextualMemoryItem 类型）
        Returns:
            Tuple[过滤后的记忆列表, 过滤成功标志]
        """</span>
        <span class="hljs-keyword">return</span> self.memory_filter.filter_unrelated_memories(query_history, memories)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_redundant_memories</span>(<span class="hljs-params">
        self,
        query_history: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>],
        memories: <span class="hljs-built_in">list</span>[TextualMemoryItem],
    </span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">list</span>[TextualMemoryItem], <span class="hljs-built_in">bool</span>]:
        <span class="hljs-string">"""
        过滤冗余记忆（委托给 MemoryFilter 实现）
        Args:
            query_history: 查询历史列表（判断冗余的上下文依据）
            memories: 待过滤的记忆列表（TextualMemoryItem 类型）
        Returns:
            Tuple[过滤后的记忆列表, 过滤成功标志]
        """</span>
        <span class="hljs-keyword">return</span> self.memory_filter.filter_redundant_memories(query_history, memories)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">filter_unrelated_and_redundant_memories</span>(<span class="hljs-params">
        self,
        query_history: <span class="hljs-built_in">list</span>[<span class="hljs-built_in">str</span>],
        memories: <span class="hljs-built_in">list</span>[TextualMemoryItem],
    </span>) -&gt; <span class="hljs-type">Tuple</span>[<span class="hljs-built_in">list</span>[TextualMemoryItem], <span class="hljs-built_in">bool</span>]:
        <span class="hljs-string">"""
        同时过滤「无关记忆」和「冗余记忆」（基于 LLM 分析，委托给 MemoryFilter 实现）
        Args:
            query_history: 查询历史列表（上下文依据）
            memories: 待过滤的记忆列表（TextualMemoryItem 类型）
        Returns:
            Tuple[过滤后的记忆列表, 过滤成功标志]
        """</span>
        <span class="hljs-keyword">return</span> self.memory_filter.filter_unrelated_and_redundant_memories(query_history, memories)
</code></pre>
<h3 data-id="heading-23">0x03 关联</h3>
<p>SchedulerDispatcher、GeneralScheduler 和 TreeTextMemory 之间存在明确的依赖和协作关系。</p>
<h4 data-id="heading-24">3.1 SchedulerDispatcher 和 GeneralScheduler</h4>
<p>SchedulerDispatcher 负责消息的分发和处理，是一个底层的消息处理组件。GeneralScheduler 是一个更高级别的调度器，利用 SchedulerDispatcher 来管理不同类型的消息（如查询、回答、添加记忆等）。</p>
<ul>
<li>GeneralScheduler 依赖 SchedulerDispatcher</li>
<li>SchedulerDispatcher 是 GeneralScheduler 的一个组件，在 GeneralScheduler 的 init 方法中，创建了一个 SchedulerDispatcher 实例并赋值给 self.dispatcher</li>
</ul>
<p>GeneralScheduler 使用 self.dispatcher 来：</p>
<ul>
<li>注册消息处理器（handlers）</li>
<li>分发消息（通过 self.dispatcher.dispatch()）</li>
<li>批量处理消息（通过 self.dispatcher.group_messages_by_user_and_cube()）</li>
<li>等待任务完成（通过 self.dispatcher.join()）</li>
<li>关闭调度器（通过 self.dispatcher.shutdown()）</li>
</ul>
<h4 data-id="heading-25">3.2 GeneralScheduler 和 TreeTextMemory</h4>
<p>TreeTextMemory 是记忆存储和检索的核心组件，提供了添加、搜索、更新和删除记忆的功能，GeneralScheduler 利用 TreeTextMemory 来管理记忆的生命周期，处理与记忆相关的各种操作。</p>
<ul>
<li>GeneralScheduler 依赖 TreeTextMemory来执行实际的记忆操作</li>
<li>TreeTextMemory 提供了 GeneralScheduler 所需的记忆存储和检索功能</li>
</ul>
<p>GeneralScheduler 通过 mem_cube.text_mem 访问 TreeTextMemory 实例，GeneralScheduler 使用 TreeTextMemory 来：</p>
<ul>
<li>
<p>TreeTextMemory 包含了 MemoryManager 和 Searcher 等组件，这些组件被 GeneralScheduler 间接使用</p>
</li>
<li>
<p>获取工作记忆（通过 text_mem_base.get_working_memory()）</p>
</li>
<li>
<p>搜索记忆（通过 self.retriever.search()，其中 retriever 使用 TreeTextMemory 的搜索功能），检索过程涉及：</p>
<ul>
<li>使用 TaskGoalParser 解析查询</li>
<li>使用 GraphMemoryRetriever 从图数据库检索记忆</li>
<li>使用 Reranker 对检索到的记忆进行重排序</li>
<li>使用 MemoryReasoner 进行推理以优化结果</li>
</ul>
</li>
<li>
<p>添加记忆（通过 self.memory_manager.add()，其中 memory_manager 与 TreeTextMemory 相关联）</p>
</li>
<li>
<p>替换工作记忆（通过 text_mem_base.replace_working_memory()）</p>
</li>
<li>
<p>获取记忆（通过 mem_cube.text_mem.get(memory_id=memory_id)）</p>
</li>
<li>
<p>GeneralScheduler 接收不同类型的消息（查询、回答、添加记忆等），根据消息类型，GeneralScheduler 调用相应的处理器，处理器使用 TreeTextMemory 的方法来执行具体操作</p>
</li>
</ul>
<p>GeneralScheduler 和 TreeTextMemory 之间是一种协作关系，其中：</p>
<ul>
<li>GeneralScheduler 是一个高级调度器，负责处理不同类型的消息并协调记忆操作</li>
<li>TreeTextMemory 是记忆操作的实际执行者，提供了存储、检索、更新和组织记忆的功能</li>
</ul>
<p>两者通过定义良好的接口进行交互，GeneralScheduler 调用 TreeTextMemory 的方法来执行具体操作 这种设计实现了关注点分离，使调度逻辑和记忆管理逻辑可以独立开发和维护。</p>
<p>协作范例如下：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># GeneralScheduler 处理查询消息的简化流程</span>
def process_query(self, query, mem_cube):
    <span class="hljs-comment"># 1. 获取当前工作记忆</span>
    <span class="hljs-attr">current_memory</span> = mem_cube.text_mem.get_working_memory()
    <span class="hljs-comment"># 2. 检索相关记忆</span>
    <span class="hljs-attr">new_candidates</span> = mem_cube.text_mem.search(query, top_k=self.top_k)
    <span class="hljs-comment"># 3. 更新工作记忆</span>
    mem_cube.text_mem.replace_working_memory(new_candidates)
</code></pre>
<h4 data-id="heading-26">3.3 总结</h4>
<p>三者之间的依赖关系可以概括为：</p>
<ul>
<li>GeneralScheduler → SchedulerDispatcher（使用其进行消息分发）</li>
<li>GeneralScheduler → TreeTextMemory（使用其进行记忆操作）</li>
</ul>
<p>具体来说：</p>
<ul>
<li>SchedulerDispatcher 是一个消息分发器，负责将不同类型的消息路由到相应的处理器</li>
<li>GeneralScheduler 是一个高级调度器，它使用 SchedulerDispatcher 来管理消息，并使用 TreeTextMemory 来处理与记忆相关的操作</li>
<li>TreeTextMemory 是记忆存储和检索的核心组件，为 GeneralScheduler 提供底层的记忆操作支持</li>
</ul>
<p>这种设计使得系统能够有效地处理不同类型的消息，并对记忆进行相应的操作，实现了消息处理和记忆管理的解耦。</p>
<h4 data-id="heading-27">3.4 MosCore</h4>
<p>MosCore 是一个很好的范例。</p>
<pre><code class="hljs language-diff" lang="diff">MosCore
<span class="hljs-deletion">- uses GeneralMemCube</span>
<span class="hljs-deletion">- uses GeneralScheduler</span>
  - uses MemoryManager
  - uses TreeTextMemory
<span class="hljs-deletion">- uses UserManager</span>
</code></pre>
<p>在如下代码中，可以管窥。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MOSCore</span>:
    <span class="hljs-string">"""
    The MOSCore (Memory Operating System Core) class manages multiple MemCube objects and their operations.
    It provides methods for creating, searching, updating, and deleting MemCubes, supporting multi-user scenarios.
    MOSCore acts as an operating system layer for handling and orchestrating MemCube instances.
    """</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, config: MOSConfig, user_manager: UserManager | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span></span>):
        self.config = config
        self.user_id = config.user_id
        self.session_id = config.session_id
        self.chat_llm = LLMFactory.from_config(config.chat_model)
        self.mem_reader = MemReaderFactory.from_config(config.mem_reader)
        self.chat_history_manager: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, ChatHistory] = {}
        <span class="hljs-comment"># use thread safe dict for multi-user product-server scenario</span>
        self.mem_cubes: OptimizedThreadSafeDict[<span class="hljs-built_in">str</span>, GeneralMemCube] = (
            OptimizedThreadSafeDict() <span class="hljs-keyword">if</span> user_manager <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span> <span class="hljs-keyword">else</span> {}
        )
        self._register_chat_history()

        <span class="hljs-comment"># Use provided user_manager or create a new one</span>
        <span class="hljs-keyword">if</span> user_manager <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
            self.user_manager = user_manager
        <span class="hljs-keyword">else</span>:
            self.user_manager = UserManager(user_id=self.user_id <span class="hljs-keyword">if</span> self.user_id <span class="hljs-keyword">else</span> <span class="hljs-string">"root"</span>)

        <span class="hljs-comment"># Initialize mem_scheduler</span>
        self._mem_scheduler_lock = Lock()
        self.enable_mem_scheduler = self.config.get(<span class="hljs-string">"enable_mem_scheduler"</span>, <span class="hljs-literal">False</span>)
        <span class="hljs-keyword">if</span> self.enable_mem_scheduler:
            self._mem_scheduler = self._initialize_mem_scheduler()
            self._mem_scheduler.mem_cubes = self.mem_cubes
        <span class="hljs-keyword">else</span>:
            self._mem_scheduler: GeneralScheduler = <span class="hljs-literal">None</span>
</code></pre>
<h3 data-id="heading-28">0xFF 参考</h3>
<p>本文使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarkdown.com.cn" target="_blank" title="https://markdown.com.cn" ref="nofollow noopener noreferrer">markdown.com.cn</a> 排版</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[WebCut前端视频编辑UI框架一周开源进度]]></title>    <link>https://juejin.cn/post/7586479864272125958</link>    <guid>https://juejin.cn/post/7586479864272125958</guid>    <pubDate>2025-12-22T12:31:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586479864272125958" data-draft-id="7586479864272076806" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="WebCut前端视频编辑UI框架一周开源进度"/> <meta itemprop="keywords" content="前端,UI Kit,音视频开发"/> <meta itemprop="datePublished" content="2025-12-22T12:31:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="否子戈"/> <meta itemprop="url" content="https://juejin.cn/user/4072246798192349"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            WebCut前端视频编辑UI框架一周开源进度
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4072246798192349/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    否子戈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T12:31:29.000Z" title="Mon Dec 22 2025 12:31:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>自从上次发布了WebCut的开源信息之后，获得了非常多小伙伴的关注，也有很多小伙伴还不知道，所以我打算写一些更新进度文章，让关注的小伙伴了解WebCut的最新进展。</p>
<h3 data-id="heading-0">什么是WebCut？</h3>
<p>对于还不了解的小伙伴，我先介绍一下WebCut。它是一款开源的前端（Web）视频编辑UI框架。说的简单点，就是它可以在你的网页上快速植入一个可以用来进行视频编辑的插件，这样你就可以以最低的成本快速实现相关需求。它以组件化思想对外开放，可以通过任意组合的形式，实现各种造型的视频编辑界面。</p>
<h3 data-id="heading-1">什么人需要WebCut？</h3>
<ul>
<li>
<p>开发者：如果你的老板要你在你们的web产品中快速上线一个视频编辑功能，你需要它</p>
</li>
<li>
<p>老网站系统维护者：如果你们的系统希望实现用户在系统中完成所有操作，包括视频的编辑，你需要它</p>
</li>
<li>
<p>创作者：如果你在找剪映的免费替代品，你需要它</p>
</li>
</ul>
<h3 data-id="heading-2">目前支持哪些功能？</h3>
<ul>
<li>
<p><strong>核心功能：</strong></p>
</li>
<li>
<p>视频播放/编辑画布</p>
</li>
<li>
<p>时间轴素材管理器：不同类型素材的渲染效果、高度、分栏、滚动、时间刻度（含缩放）、时间游标、素材时长和位置拖拽调整等等</p>
</li>
<li>
<p>处理工具：分割裁剪、水平翻转、两段视频合并连接</p>
</li>
<li>
<p>视频导出：视频格式、分辨率、码率、音频导出等</p>
</li>
<li>
<p>基础信息编辑：位置、大小、透明度、旋转</p>
</li>
<li>
<p>信息编辑：音视频的声量调节</p>
</li>
<li>
<p><strong>外围功能</strong></p>
</li>
<li>
<p>长宽比调整</p>
</li>
<li>
<p>播放器进度显示器</p>
</li>
<li>
<p>暗黑主题和浅色主题切换</p>
</li>
<li>
<p>多语言（8种），含语言切换组件</p>
</li>
<li>
<p><strong>进阶功能</strong></p>
</li>
<li>
<p>时间轴定制：可在时间轴上扩展各种附加元素</p>
</li>
<li>
<p>媒体库管理：管理各种素材、导入（含文件夹导入）、添加、多选按顺序添加等等</p>
</li>
<li>
<p>素材类型：视频、音频、图片（含gif）、文字（含文字样式编辑）</p>
</li>
<li>
<p>媒体库定制：特定类型素材新增菜单添加功能、新增媒体类型等</p>
</li>
<li>
<p>动画：可扩展的动画功能</p>
</li>
<li>
<p>滤镜：可扩展的滤镜功能</p>
</li>
<li>
<p>转场效果：可扩展的转场效果</p>
</li>
<li>
<p><strong>VIP功能</strong></p>
</li>
<li>
<p>视频水印（含运动效果）</p>
</li>
<li>
<p>文本转语音</p>
</li>
</ul>
<h3 data-id="heading-3">本周开源日志</h3>
<p>本周我们实现了动画、滤镜、转场这3个在视频编辑器技术实现中非常麻烦的功能，这里展开讲一下。</p>
<ul>
<li>动画</li>
</ul>
<p>动画主要指素材在视频中的运动效果，这里的运动主要通过改变素材的基本属性来实现。例如通过改变素材的位置信息来实现位移，通过改变大小来实现运动中的缩放效果，通过改变透明度来实现闪动效果等等。同时，这些属性的变化可以两两组合，实现非常酷炫的动画。</p>
<p>在WebCut中，一个动画由两个部分组成，一个部分定义keyframe，它是一组key-value，其中key代表时间进度，例如5%, 40%, 90%，value代表在这个时间点上应该以什么属性展示时间点之间，则通过动画运算来进行补间；另一部分是参数，用于计算动画的速度。如果以前开发过css的小伙伴，应该对animation非常了解。</p>
<ul>
<li>滤镜</li>
</ul>
<p>滤镜主要指对素材的画面表现进行变化，例如灰度、鲜亮、高斯模糊等效果。在WebCut中，主要通过对视频画面的帧进行滤镜处理，从而让整个视频拥有滤镜效果。</p>
<ul>
<li>转场</li>
</ul>
<p>转场主要针对的是两段视频的连接方式，它的实现比较复杂，结合了动画、滤镜等效果，而且还要处理两段视频的衔接。其实现难度非常大。不过WebCut已经做了高度集成，提供了非常便捷的接口，开发者只需要根据接口文档，传入参数，即可完成自己的转场效果。</p>
<p>除了上面提到的3个非常重要的功能，本周，我们还对WebCut做了一项非常重要的设计实现，就是实现了“扩展包”功能。开发者可基于该功能，定义自己的扩展包，并把它注册到WebCut中，即可实现自己的复杂功能。我们的VIP功能就是基于该扩展包功能实现。简单讲，扩展包提供了非常明确的typescript类型接口，你只需要实现该接口，就可以轻松对视频编辑器进行扩展，以增加WebCut本身没有的功能。</p>
<p>另外，我们还做了一些小更新。例如增加了在媒体库中直接上传整个文件夹的能力，增加了多选多个素材并按顺序插入到画布中的能力等。更多功能，还需要你自己去发现～</p>
<p>👉传送门：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwebcut.top" target="_blank" title="https://webcut.top" ref="nofollow noopener noreferrer">webcut.top</a></p>
<p>🌹Github点赞：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftangshuang%2Fwebcut" target="_blank" title="https://github.com/tangshuang/webcut" ref="nofollow noopener noreferrer">github.com/tangshuang/…</a></p>
<p>关注我的公众号 wwwtangshuangnet ，持续获取WebCut更新日志。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[记一次服务器大并发下高延迟问题的定位]]></title>    <link>https://juejin.cn/post/7586491717873369107</link>    <guid>https://juejin.cn/post/7586491717873369107</guid>    <pubDate>2025-12-22T12:45:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586491717873369107" data-draft-id="7586490798431584319" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="记一次服务器大并发下高延迟问题的定位"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-22T12:45:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="码财同行"/> <meta itemprop="url" content="https://juejin.cn/user/3883950915978728"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            记一次服务器大并发下高延迟问题的定位
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3883950915978728/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    码财同行
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T12:45:41.000Z" title="Mon Dec 22 2025 12:45:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近一段时间，项目增加了小游戏平台的支持，而小游戏的网络要求是 websocket，因此服务器也对 websocket 网络进行了支持。</p>
<p>最近，开始压测新的架构，发现了一个很有意思的问题：</p>
<ol>
<li>当并发较少时，如100人同时在线，一切正常</li>
<li>当并发增大，比如增加到1500人，客户端的延迟显著增加，甚至将正常玩的玩家踢下线。</li>
</ol>
<p>实际感受下来，客户端的延迟能达到1.5s左右，基本不可玩。</p>
<p>于是开始定位这个并发造成的延迟问题。</p>
<p>在现有的架构中，消息流转的方向如下：</p>
<p>client → LB → server → LB → client</p>
<p>整个流程涉及三方：客户端client、负责负载均衡的LB、以及服务器server本身。</p>
<p>这三方都可能会有问题，于是我设计了几个 case 来依次排除：</p>
<p>1）第一个可能就是客户端问题，比如客户端队列调度延迟或者其他bug。排除的方法就是用压测机器人和真实客户端来对比，如果压测机器人也有较高的延迟，那就可以排除client问题。测试下来，机器人统计的延迟也是很高，90%的耗时为900多ms，因此排除客户端client问题。</p>
<p>2）第二个可能是LB问题，有时候如果LB限制了带宽，也可能造成较高的延迟。排除的方法是将LB替换成其他不走LB的形式，在我们K8S服务器集群中是将LB换成 NodePort 的形式供客户端链接。测试下来，换成 NodePort 方式连接后，延迟依然还在，因此排除LB问题。</p>
<p>3）最后一种可能就是服务器server本身的问题。但是之前非小游戏的情况下，压测是正常的，因此我的怀疑点就落到websocket 网络层实现上，当然，还有一个可能是服务器的业务逻辑层的处理比较耗时。</p>
<p>先来看看是否是逻辑层处理比较耗时。</p>
<p>这个比较简单，就是在逻辑处理的入口和出口处增加时间统计。结果是逻辑处理非常快，基本是毫秒级别的耗时，因此排除了逻辑层的问题。</p>
<p>那最后的怀疑点就落到了网络层上。为了证实自己的猜想，我将压测机器人还原为 tcp 网络，发现延迟显著下降到正常水平（10ms以内），于是根据逻辑推理，问题出在 websocket 服务上。</p>
<p>现在的网络层 loop 是这样的流程：</p>
<pre><code class="hljs language-c++" lang="c++"><span class="hljs-keyword">while</span> (<span class="hljs-built_in">IsRunning</span>())
{
    <span class="hljs-comment">// 处理 websocket 网络IO</span>
    _ProcWebSocket();
    
    <span class="hljs-comment">// 处理TCP网络IO （内部TCP通信）</span>
    _ProcTcpEpoll();
    
    <span class="hljs-comment">// 处理逻辑层过来的消息（消息队列）</span>
    _ProcNetQueue()
}
</code></pre>
<p>根据以往的经验，很可能是调度循环 loop 里处理消息发送的流程积压的比较多，也就是 <code>_ProcWebSocket</code> 调度时间不足导致的。</p>
<p>查看代码，发现是调用的是 <code>RunOnce</code>, 它的实现也比较简单：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CWSServer::RunOnce</span><span class="hljs-params">()</span>
</span>{
    m_endpoint.<span class="hljs-built_in">poll_one</span>();
}
</code></pre>
<p>翻看 websocket 库文档后，发现除了 poll_one 之外还有个 poll，他们的区别就是一次处理多少 websocket 的IO 事件：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/932a5adf1006409d9b6e08b413b3b3f0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56CB6LSi5ZCM6KGM:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767012341&amp;x-signature=ONALpQoD8712UhUSDcbXTPg2%2Bok%3D" alt="image.png" loading="lazy"/></p>
<p>很明显，一次循环调度一次 poll_one 造成了底层IO 的挤压，我调试时候发现，并发超过1500人之后，poll_one 调用10次都不够。</p>
<p>最终的修改方案也比较简单，使用 poll 来尽量多的调度触发的事件，有多少调用多少，类似 epoll（获取有多少个事件，然后依次处理）:</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">CWSServer::RunOnce</span><span class="hljs-params">()</span>
</span>{
    <span class="hljs-comment">// Start the Asio io_service run loop</span>
    <span class="hljs-comment">// 非阻塞调用，会一次处理多个事件</span>
    m_endpoint.<span class="hljs-built_in">poll</span>();
}
</code></pre>
<p>修改完毕之后，大并发下，延迟下降到10ms，基本满足需求。</p>
<p>更进一步：这次问题的定位还是比较耗时的，如果引入一下消息追踪的工具，能较快的定位到延迟出在哪个环节；
另外，如果能增加一些消息延迟的监控或者统计，能更快发现问题。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[这真的是我看过最深刻的2025年AI大模型年度复盘]]></title>    <link>https://juejin.cn/post/7586506307726753802</link>    <guid>https://juejin.cn/post/7586506307726753802</guid>    <pubDate>2025-12-22T12:52:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586506307726753802" data-draft-id="7586504691845496841" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="这真的是我看过最深刻的2025年AI大模型年度复盘"/> <meta itemprop="keywords" content="LLM"/> <meta itemprop="datePublished" content="2025-12-22T12:52:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智泊AI"/> <meta itemprop="url" content="https://juejin.cn/user/3572727470361578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            这真的是我看过最深刻的2025年AI大模型年度复盘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3572727470361578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智泊AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T12:52:10.000Z" title="Mon Dec 22 2025 12:52:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>AndrejKarpathy前几天发了一篇2025年LLM年度回顾。他是OpenAI联合创始人、前特斯拉AI总监，也是全球最有影响力的AI研究者之一。这篇文章里有6个观点，每一个都理解得非常深刻。强烈推荐大家看看。</p>
<p><strong>第一: 训练方法彻底变了</strong></p>
<p>2025年之前，训练一个好用的大模型基本是三步走。预训练、监督微调、人类反馈强化学习。这个配方从 2020年用到现在，稳定了5年。</p>
<p>2025年多了关键的第四步: RLVR。全称是Reinforcementfrom VerifiableLearningRewards，翻译过来就是可验证奖励的强化学习。</p>
<p>什么意思?简单说，就是让模型在有标准答案的环境里反复练习。比如数学题，答案对就是对错就是错，不需要人来打分。代码也一样，能跑通就是能跑通。</p>
<p>这和之前的训练有什么本质区别?以前的监督微调和人类反馈，本质上是照葫芦画瓢，人给什么样本，模型学什么样本。但RLVR不一样，它让模型自己摸索出解题策略。就像学游泳，之前是看教学视频模仿动作，现在是直接扔水里，只要你能游到对岸，怎么划水我不管。</p>
<p>结果呢?模型自己悟出了看起来像推理的东西它学会了把大问题拆成小步骤，学会了走错路时回头重来。这些策略如果靠人类标注示范，根本标不出来，因为人自己也说不清正确的思考过程长什么样。</p>
<p>这个变化带来一个连锁反应，算力的分配方式变了。以前大部分算力砸在预训练阶段，现在越来越多算力用于RL阶段。模型的参数规模没怎么涨，但推理能力飙升。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"><strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p>
<p>OpenAl的o1是这条路的起点，o3 是真正让人感觉到不一样的拐点。</p>
<p>还有个新玩法，推理时也能花更多算力。让模型想久一点，生成更长的推理链条，效果就更好。这相当于多了一个调节能力的旋钮。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c1d8f598b4ce499fb3cf48d425ac23ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm65rOKQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767012730&amp;x-signature=04UOtC0FIIdShT1GQ66irXw6BFQ%3D" alt="图片" loading="lazy"/></p>
<p><strong>第二: 我们终于搞懂了 AI 是什么形状的</strong></p>
<p>聪明Karpathy 用了一个很妙的比喻，我们不是在养动物，而是在召唤幽灵。</p>
<p>人类的智能是进化出来的，优化目标是在从林里让部落活下去。大模型的智能是训练出来的，优化目标是模仿人类文本、在数学题里拿分、在评测榜单上刷分。优化目标完全不同，出来的东西当然也完全不同。</p>
<p>所以 AI的智能是参差不齐的，英文叫jaggedintelligence。它可以在某些领域表现得像全知全能的学者，同时在另一些领域犯小学生都不会犯的错。上一秒帮你推导复杂公式，下一秒被一个简单的越狱提示骗走你的数据。</p>
<p>为什么会这样?因为哪个领域有可验证的奖励模型在那个领域就会长出尖刺。数学有标准答案代码能跑测试，所以这些领域进步飞快。但常识社交、创意这些领域，什么是对很难定义，模型就没法高效学习。</p>
<p>这也让Karpathy 对基准测试失去了信任。道理很简单，测试题本身就是可验证环境，模型完全可以针对测试环境做优化。刷榜变成了一门艺术。</p>
<p>所有基准都刷满了，但离真正的通用智能还差得远，这是完全可能发生的事。</p>
<p><strong>第三: LLM 应用层浮出水面</strong></p>
<p>今年火得一塌糊涂。但 Karpathy 认为Cursor它最大的意义不是产品本身，而是证明了LLM应用这个新物种的存在。</p>
<p>大家开始讨论X领域的Cursor，这说明一种新的软件范式成立了。</p>
<p>这类应用做什么?第一，做上下文工程，把相关信息整理好，喂给模型。第二，编排多个模型调用，后台可能串了一堆 API 调用，平衡效果和成本。第三，提供专业场景的界面，让人类能在关键节点介入。第四，给用户一个自主程度滑杆你可以让它多干点，也可以让它少干点。</p>
<p>有个问题被讨论了一整年，这个应用层有多厚?</p>
<p>模型厂商会不会把所有应用都吃掉?</p>
<p>Karpathy的判断是，模型厂商培养的是有通用能力的大学毕业生，但LLM应用负责把这些毕业生组织起来、培训上岗，变成能在具体行业干活的专业团队。数据、传感器、执行器、反馈循环，这些都是应用层的活。</p>
<p><strong>第四: AI 搬进了你的电脑</strong></p>
<p>Claude Code 是今年最让Karpathy 印象深刻的产品之一。它展示了 AI 智能体应该长什么样，能调用工具、能做推理、能循环执行、能解决复杂问题。</p>
<p>但更关键的是，它跑在你的电脑上。用你的环境你的数据、你的上下文。</p>
<p>Karpathy认为OpenAI 在这里判断失误了。他们把Codex和智能体的重心放在云端容器里从 ChatGPT 去调度。这像是在瞄准AGI 终局,但我们还没到那一步。</p>
<p>现实是，AI的能力还是参差不齐的，还需要人类在旁边看着、配合着干活。把智能体放在本地和开发者并肩工作，才是当下更合理的选择。</p>
<p>Claude Code 用一个极简的命令行界面做到了这一点。AI不再只是你访问的一个网站，而是住在你电脑里的一个小精灵。这是一种全新的人机交互范式。</p>
<p><strong>第五: Vibe Coding 起飞了</strong></p>
<p>2025 年，AI 的能力跨过了一个门槛。你可以纯用英语描述需求，让它帮你写程序，完全不用管代码长什么样。</p>
<p>Karpathy 随手发了条推特，给这种编程方式起了个名字叫 vibe coding，结果这个词火遍全网。</p>
<p>这意味着什么?编程不再是专业程序员的专利，普通人也能做。这和过去所有技术的扩散模式都不一样。以前新技术总是先被大公司、政府、专业人士掌握，然后才慢慢下沉。但大模型反过来普通人从中受益的比例远超专业人士。</p>
<p>不只是让不会编程的人能编程。对会编程的人来说，很多以前不值得写的小程序现在都值得写了。</p>
<p>Karpathy 自己就用 vibe coding 做了一堆项目。用Rust 写了个定制的分词器、做了好几个工具类 App、甚至写了一次性的程序只为找一个 bug。</p>
<p>代码突然变得廉价、即用即弃、像草稿纸一样随便写。这会彻底改变软件的形态和程序员的工作内容。</p>
<p><strong>第六: 大模型的图形界面时代要来了</strong></p>
<p>Google的Gemini Nano Banana 是今年最被低估的产品之一。它能根据对话内容实时生成图片: 信息图、动画，把回复画出来而不是写出来。</p>
<p>Karpathy把这件事放到更大的历史脉络里看大模型是下一个重大计算范式，就像70年代、80年代的计算机一样。所以我们会看到类似的演进路径。</p>
<p>现在和大模型聊天，有点像80年代在终端敲命令。文字是机器喜欢的格式，但不是人喜欢的格式。人其实不爱读文字，读文字又慢又累。人喜欢看图、看视频、看空间布局。这就是传统计算机为什么要发明图形界面。</p>
<p>大模型也需要自己的GUI。它应该用我们喜欢的方式跟我们说话，图片、幻灯片、白板、动画、小应用。现在的Emoji和Markdown 只是初级形态，帮文字化个妆。</p>
<p>真正的 LLM GUI 会是什么样?Nano Banana 是一个早期暗示。最有意思的是，这不只是图像生成的事。它需要把文本生成、图像生成、世界知识全部绞在一起，在模型权重里融为一体。</p>
<p>Karpathy 的总结是这样的。2025 年的大模型比他预期的聪明，也比他预期的蠢。两者同时成立。</p>
<p>但有一点很确定，即使以现在的能力，我们连10%的潜力都没挖掘出来。还有太多想法可以试整个领域感觉是敞开的。他相信进步会继续飞速推进，同时也相信还有大量的工作要做。两件事并不矛盾。</p>
<p>2026年，系好安全带继续加速吧。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fyuan.zhipoai.cn%2F" target="_blank" title="https://yuan.zhipoai.cn/" ref="nofollow noopener noreferrer"><strong>更多AI大模型学习视频及资源，都在智泊AI。</strong></a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型原理剖析——DeepSeek-V3深度解析：671B参数MoE大模型的技术突破与实践]]></title>    <link>https://juejin.cn/post/7586452779713495055</link>    <guid>https://juejin.cn/post/7586452779713495055</guid>    <pubDate>2025-12-22T12:57:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586452779713495055" data-draft-id="7586518130761105448" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型原理剖析——DeepSeek-V3深度解析：671B参数MoE大模型的技术突破与实践"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2025-12-22T12:57:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="艾醒"/> <meta itemprop="url" content="https://juejin.cn/user/708512558088669"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型原理剖析——DeepSeek-V3深度解析：671B参数MoE大模型的技术突破与实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/708512558088669/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    艾醒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T12:57:43.000Z" title="Mon Dec 22 2025 12:57:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在大模型赛道中，“参数规模”与“推理效率”往往是一对矛盾体——更大的参数通常意味着更强的能力，但也会带来更高的计算与内存成本。而DeepSeek-V3的出现，正是通过架构、训练、调度等多维度的技术创新，在671B超大参数规模下实现了“高效能+低成本”的平衡。本文将从基础架构到训练细节，全面解析DeepSeek-V3的技术亮点，并结合实例让复杂概念更易理解。</p>
<h2 data-id="heading-1">DeepSeek-V3的定位与核心目标</h2>
<p>DeepSeek-V3是一款<strong>671B参数的通用大语言模型</strong>，采用<strong>混合专家（Mixture-of-Experts，MoE）架构</strong>，核心目标是：在保持超大模型能力的同时，实现<strong>高效推理</strong>与<strong>成本效益训练</strong>——其每个Token仅激活37B参数（约总参数的5.5%），既避免了全参数激活的高成本，又能通过专家分工覆盖各类任务。</p>
<h2 data-id="heading-2">基础架构创新：MLA+MoE，从“通用能力”到“高效推理”</h2>
<p>DeepSeek-V3的基础架构由**多头潜在注意力（MLA）<strong>和</strong>混合专家（MoE）**两大核心模块组成，二者分别解决“推理效率”与“能力覆盖”的问题。</p>
<h3 data-id="heading-3">1. MLA（多头潜在注意力）：用“低秩压缩”降低推理内存开销</h3>
<p>传统Transformer的注意力机制中，KV缓存（存储键值对的缓存）会随输入文本长度线性增长，处理长文档时极易引发内存瓶颈。而MLA通过<strong>低秩压缩技术</strong>对KV缓存进行降维：</p>
<ul>
<li>核心逻辑：将高维的KV矩阵压缩为低维矩阵，在不显著损失信息的前提下，减少缓存占用。</li>
<li>实际效果：处理大规模数据（如10万字的学术论文）时，内存占用降低40%以上，推理速度提升30%，同时保证生成内容的准确性。</li>
</ul>
<p>当你让大模型总结一篇10万字的行业报告时，传统大模型的KV缓存可能需要占用20GB GPU显存，导致推理延迟超过1分钟；而MLA压缩后，缓存仅需12GB显存，推理延迟缩短至40秒以内。</p>
<h3 data-id="heading-4">2. MoE（混合专家架构）：细粒度分工，让“专业的专家做专业的事”</h3>
<p>MoE架构的核心是“将大模型拆分为多个‘专家模块’，根据输入动态激活对应专家”，DeepSeek-V3的MoE有两个关键设计：</p>
<ul>
<li><strong>细粒度专家+共享专家</strong>：包含多组“路由专家”（负责特定任务，如数学推理、翻译）和“共享专家”（负责通用任务，如语义理解）；</li>
<li><strong>动态激活</strong>：每个Token仅激活37B参数对应的专家（而非全671B参数），避免全量计算的高成本。</li>
</ul>
<p><strong>例子</strong>：</p>
<ul>
<li>当你输入“求解方程x²-5x+6=0”：Router（路由模块）会识别这是数学任务，激活“数学符号推理专家”，仅调用该专家的参数完成计算；</li>
<li>当你输入“将‘人工智能重塑产业格局’翻译成英文”：Router会激活“跨语言转换专家”，调用对应的语言模型参数完成翻译。</li>
</ul>
<p>这种方式的优势是：相比全参数激活的大模型，推理成本降低80%以上，同时每个专家的“专精能力”更突出。</p>
<p><strong>图示</strong>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/efbc8ba31afb40b3843e97f692151166~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Im-6YaS:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767013063&amp;x-signature=iq0X7dka42g1jRzbhzyRtq4Jf6g%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ol>
<li><strong>输入与预处理</strong>：<br/>
原始数据经过特征提取（如文本的 Token Embedding、语音的梅尔频谱）后，转化为模型可处理的向量特征。</li>
<li><strong>路由器（Router）</strong>：<br/>
MoE 的「大脑」，核心功能是<strong>根据输入特征的语义/分布，计算每个专家网络的「适配权重」</strong>（例如：输入是医疗文本→医疗专家权重高，输入是法律文本→法律专家权重高）。<br/>
常见实现：全连接层 + Softmax（输出各专家的概率权重）。</li>
<li><strong>门控机制（Gating）</strong>：<br/>
实现「稀疏激活」的关键：
<ul>
<li>第一步：筛选 <strong>Top-K 个权重最高的专家</strong>（K&lt;&lt;N，例如 N=100 个专家，仅激活 K=5 个），避免所有专家参与计算（降低算力消耗）；</li>
<li>第二步：对选中的 K 个专家，再次归一化权重（确保权重和为1），用于后续输出融合。</li>
</ul>
</li>
<li><strong>专家网络（Expert Networks）</strong>：<br/>
并行的「专用子模型」，每个专家专注于处理某一类型的输入（如特定领域、特定语义特征），结构可灵活设计（如 Transformer 层、CNN、MLP 等）。<br/>
核心特点：<strong>仅 Top-K 个专家被激活计算，其余专家闲置</strong>（稀疏性）。</li>
<li><strong>加权融合与输出</strong>：<br/>
被激活的 K 个专家各自输出结果，门控机制将这些结果按「专家权重」加权求和（权重越高的专家，对最终输出的贡献越大），最终得到模型的预测/生成结果。</li>
</ol>
<h2 data-id="heading-5">MoE的动态调度：从“分配不均”到“负载均衡”</h2>
<p>MoE架构的痛点是“任务分配不均”——热门专家（如翻译专家）可能持续过载，而冷门专家长期空闲，导致计算瓶颈。DeepSeek-V3通过<strong>无辅助损失负载均衡策略</strong>解决这一问题：</p>
<h4 data-id="heading-6">负载均衡的核心逻辑：</h4>
<p>根据每个专家的<strong>历史利用率</strong>，动态调整其接收新任务的概率：</p>
<ul>
<li>利用率过高的专家：降低其接收任务的概率（避免过载）；</li>
<li>利用率过低的专家：提高其接收任务的概率（充分利用资源）。</li>
</ul>
<p><strong>例子</strong>：
假设系统中有5个翻译专家，其中专家A因翻译质量高，连续接收了10个任务，利用率达到90%（其他专家仅30%）。此时策略会：</p>
<ul>
<li>把专家A的任务接收概率从50%降至10%；</li>
<li>把专家B-E的接收概率从10%提升至22.5%；</li>
</ul>
<p>后续翻译任务会更多分配给空闲专家，避免专家A过载导致的推理延迟增加。</p>
<h2 data-id="heading-7">高效训练框架：从GPU集群到混合精度，压缩训练成本</h2>
<p>训练671B参数的MoE模型，需要解决“集群通信开销大”“内存占用高”的问题，DeepSeek-V3的训练框架通过两大技术实现突破：</p>
<h3 data-id="heading-8">1. DualPipe算法：计算与通信“重叠进行”，减少空闲时间</h3>
<p>传统分布式训练中，GPU的“计算”和“跨节点通信”是串行的（先算完再传数据），导致GPU在通信阶段处于空闲状态。DualPipe的创新是：</p>
<ul>
<li>将计算与通信阶段<strong>重叠进行</strong>：GPU在完成部分计算后，立即开始传输中间结果，其他GPU接收数据的同时准备计算；</li>
<li>配合2048个NVIDIA H800 GPU集群+高效跨节点通信内核，实现“近乎零开销”的跨节点通信。</li>
</ul>
<p><strong>例子</strong>：
传统训练流程：GPU1计算10分钟→传输数据2分钟→GPU2计算10分钟（总耗时22分钟）；
DualPipe流程：GPU1计算5分钟后开始传数据，GPU2接收数据的同时准备计算→总耗时15分钟，训练效率提升40%以上。</p>
<h3 data-id="heading-9">2. FP8混合精度训练：“精度取舍”平衡速度与性能</h3>
<p>大模型训练通常用FP32/BF16精度，但内存占用高、计算慢。DeepSeek-V3采用<strong>FP8混合精度策略</strong>：</p>
<ul>
<li>大部分计算（如矩阵乘法，占70%计算量）用FP8精度：内存占用仅为FP32的1/4，计算速度提升2倍；</li>
<li>关键操作（如梯度更新、损失计算）保持BF16精度：避免精度损失导致模型收敛效果差。</li>
</ul>
<p><strong>例子</strong>：
模型中的“Transformer块内的矩阵乘法”用FP8计算，内存占用从100GB降至25GB；而“梯度反向传播”用BF16，确保模型能稳定学习到数据中的规律。最终训练周期从30天缩短至18天，成本降低40%。</p>
<h2 data-id="heading-10">多标记预测MTP：一次生成多个Token，提升生成效率与连贯性</h2>
<p>传统大模型采用“Next Token Prediction”（逐个生成Token），速度慢且易出现上下文脱节。DeepSeek-V3引入<strong>多标记预测（MTP）技术</strong>，同时预测多个连续Token：</p>
<h3 data-id="heading-11">MTP的技术原理：</h3>
<p>通过<strong>D个串行模块</strong>实现：每个模块共享“嵌入层”“输出头”，包含“Transformer块”和“投影矩阵”——既复用了模型参数，又能捕捉Token间的长程依赖。</p>
<h3 data-id="heading-12">MTP的实际效果：</h3>
<ul>
<li>生成速度提升2-3倍：一次预测多个连续Token，减少生成步骤；</li>
<li>内容更连贯：捕捉长程依赖，避免“前言不搭后语”的问题。</li>
</ul>
<p><strong>例子</strong>：
生成文本“深度学习在计算机视觉领域的典型应用包括图像分类、目标检测和语义分割”：</p>
<ul>
<li>传统方式：逐个生成“深→度→学→习→在→…→语→义→分→割”（需20+步骤）；</li>
<li>MTP方式：一次预测“深度学习”“在计算机视觉领域”“图像分类、目标检测和语义分割”等连续序列（仅需8个步骤），且生成的应用列表更符合“计算机视觉”的上下文逻辑。</li>
</ul>
<h2 data-id="heading-13">推理专精：DeepSeek-R1的“逻辑分析”优势</h2>
<p>除了通用模型V3，DeepSeek还推出了<strong>推理模型DeepSeek-R1</strong>，专注于深度逻辑分析场景：</p>
<ul>
<li>架构：基于强化学习优化的推理优先架构；</li>
<li>训练：多阶段强化学习（RL）训练，注重“思维链（CoT）推理”；</li>
<li>适用场景：复杂逻辑题（如“三段论推理”）、代码调试（如定位Python代码的逻辑错误）、复杂决策分析等。</li>
</ul>
<h2 data-id="heading-14">总结</h2>
<p>DeepSeek-V3通过“MoE架构+MLA注意力+负载均衡+混合精度训练+MTP生成”的技术组合，在671B参数规模下实现了“能力强、速度快、成本低”的平衡；而DeepSeek-R1则填补了“深度逻辑分析”的场景空白。二者形成互补，覆盖了通用任务与专业推理的需求。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型原理剖析——多头潜在注意力 (MLA) 详解]]></title>    <link>https://juejin.cn/post/7586493936677584936</link>    <guid>https://juejin.cn/post/7586493936677584936</guid>    <pubDate>2025-12-22T12:59:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586493936677584936" data-draft-id="7586518130761138216" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型原理剖析——多头潜在注意力 (MLA) 详解"/> <meta itemprop="keywords" content="算法"/> <meta itemprop="datePublished" content="2025-12-22T12:59:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="艾醒"/> <meta itemprop="url" content="https://juejin.cn/user/708512558088669"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型原理剖析——多头潜在注意力 (MLA) 详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/708512558088669/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    艾醒
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T12:59:41.000Z" title="Mon Dec 22 2025 12:59:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>多头潜在注意力(Multi-Head Latent Attention, MLA)是DeepSeek团队于2024年在DeepSeek模型中首次提出的创新注意力机制，通过低秩联合压缩键值(KV)缓存，在保持模型性能的同时显著降低内存占用和计算开销，特别适合长文本处理和大规模语言模型部署。</p>
<h2 data-id="heading-1">核心原理：从显式关联到潜在映射</h2>
<p><strong>核心思想</strong>：将传统多头注意力的KV矩阵压缩到低维潜在空间，仅存储压缩后的潜向量，推理时动态重构完整KV。</p>
<p><strong>工作流程</strong>：</p>
<ol>
<li>
<p><strong>下投影</strong>：将输入向量映射到低维潜在空间(维度d_c，远小于原始维度)
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>k</mi></msub><mo>=</mo><mi>X</mi><mo separator="true">⋅</mo><msubsup><mi>W</mi><mi>k</mi><mi>D</mi></msubsup><mo separator="true">,</mo><msub><mi>C</mi><mi>v</mi></msub><mo>=</mo><mi>X</mi><mo separator="true">⋅</mo><msubsup><mi>W</mi><mi>v</mi><mi>D</mi></msubsup></mrow><annotation encoding="application/x-tex">C_k = X·W_k^D, C_v = X·W_v^D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1244em;vertical-align:-0.2831em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4169em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0883em;vertical-align:-0.247em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span></span></span></span></span></p>
<p>其中<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mi>k</mi><mi>D</mi></msubsup></mrow><annotation encoding="application/x-tex">W_k^D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1244em;vertical-align:-0.2831em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4169em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span/></span></span></span></span></span></span></span></span></span>、<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mi>v</mi><mi>D</mi></msubsup></mrow><annotation encoding="application/x-tex">W_v^D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0883em;vertical-align:-0.247em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span></span></span></span></span>为压缩矩阵，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">C_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>、<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">C_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>为键值的潜在表示</p>
</li>
<li>
<p><strong>上投影重构</strong>：计算注意力前，将潜在表示恢复为全维度
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>K</mi><mo>=</mo><msub><mi>C</mi><mi>k</mi></msub><mo separator="true">⋅</mo><msubsup><mi>W</mi><mi>k</mi><mi>U</mi></msubsup><mo separator="true">,</mo><mi>V</mi><mo>=</mo><msub><mi>C</mi><mi>v</mi></msub><mo separator="true">⋅</mo><msubsup><mi>W</mi><mi>v</mi><mi>U</mi></msubsup></mrow><annotation encoding="application/x-tex">K = C_k·W_k^U, V = C_v·W_v^U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1244em;vertical-align:-0.2831em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4169em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span/></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0883em;vertical-align:-0.247em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span></span></span></span></span>
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mi>k</mi><mi>U</mi></msubsup></mrow><annotation encoding="application/x-tex">W_k^U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1244em;vertical-align:-0.2831em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4169em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span/></span></span></span></span></span></span></span></span></span>、<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>W</mi><mi>v</mi><mi>U</mi></msubsup></mrow><annotation encoding="application/x-tex">W_v^U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0883em;vertical-align:-0.247em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span></span></span></span></span>为解压缩矩阵</p>
</li>
<li>
<p><strong>注意力计算</strong>：使用标准多头注意力公式</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mi>t</mi><mi>t</mi><mi>e</mi><mi>n</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">,</mo><mi>K</mi><mo separator="true">,</mo><mi>V</mi><mo stretchy="false">)</mo><mo>=</mo><mi>s</mi><mi>o</mi><mi>f</mi><mi>t</mi><mi>m</mi><mi>a</mi><mi>x</mi><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">⋅</mo><msup><mi>K</mi><mi>T</mi></msup><mi mathvariant="normal">/</mi><mtext>√</mtext><msub><mi>d</mi><mi>k</mi></msub><mo stretchy="false">)</mo><mo separator="true">⋅</mo><mi>V</mi></mrow><annotation encoding="application/x-tex">Attention(Q, K, V) = softmax(Q·K^T/√d_k)·V</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">A</span><span class="mord mathnormal">tt</span><span class="mord mathnormal">e</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.0913em;vertical-align:-0.25em;"/><span class="mord mathnormal">so</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">K</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mord">/√</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.22222em;">V</span></span></span></span></span></p>
</li>
<li>
<p><strong>缓存优化</strong>：仅存储低维潜在向量C_k、C_v，而非完整KV矩阵，大幅减少内存占用</p>
</li>
</ol>
<h2 data-id="heading-2">技术创新：四大突破点</h2>
<h3 data-id="heading-3">低秩KV联合压缩</h3>
<ul>
<li>将KV从原始维度(如<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mi>h</mi></msub><mo separator="true">⋅</mo><msub><mi>d</mi><mi>h</mi></msub><mo>=</mo><mn>16384</mn></mrow><annotation encoding="application/x-tex">n_h·d_h=16384</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">16384</span></span></span></span></span>)压缩至潜在维度(如<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>c</mi></msub><mo>=</mo><mn>2048</mn></mrow><annotation encoding="application/x-tex">d_c=2048</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2048</span></span></span></span></span>)，压缩比达8:1</li>
<li>利用自然语言底层线性冗余和模型过参数化特性，在几乎不损失信息的前提下实现高效压缩</li>
<li>显存占用从O(n·h·<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>h</mi></msub></mrow><annotation encoding="application/x-tex">d_h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>)降至O(n·<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">d_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>)，减少约87.5%</li>
</ul>
<h3 data-id="heading-4">解耦RoPE(旋转位置编码)</h3>
<ul>
<li><strong>问题</strong>：标准RoPE的非线性旋转操作与低秩压缩不兼容，直接压缩会破坏位置信息</li>
<li><strong>创新</strong>：将查询和键表示拆分为位置敏感和非敏感两部分
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>q</mi><mo>=</mo><mo stretchy="false">[</mo><msub><mi>q</mi><mi>r</mi></msub><mi>o</mi><mi>p</mi><mi>e</mi><mo separator="true">;</mo><msub><mi>q</mi><mi>n</mi></msub><mi>o</mi><mi>r</mi><mi>o</mi><mi>p</mi><mi>e</mi><mo stretchy="false">]</mo><mo separator="true">,</mo><mi>k</mi><mo>=</mo><mo stretchy="false">[</mo><msub><mi>k</mi><mi>r</mi></msub><mi>o</mi><mi>p</mi><mi>e</mi><mo separator="true">;</mo><msub><mi>k</mi><mi>n</mi></msub><mi>o</mi><mi>r</mi><mi>o</mi><mi>p</mi><mi>e</mi><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">q = [q_rope; q_norope], k = [k_rope; k_norope]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal">o</span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0359em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal">oro</span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mclose">]</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mopen">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal">o</span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0315em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal">oro</span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mclose">]</span></span></span></span></span></li>
<li>仅对非位置部分进行压缩，保留完整位置信息，确保长文本理解能力</li>
</ul>
<h3 data-id="heading-5">矩阵吸收优化</h3>
<ul>
<li><strong>推理加速</strong>：将上投影矩阵预乘到查询投影中
<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>q</mi></msub><mi>k</mi><mo>=</mo><msubsup><mi>W</mi><mi>q</mi><mi>U</mi></msubsup><mo separator="true">⋅</mo><mo stretchy="false">(</mo><msubsup><mi>W</mi><mi>k</mi><mi>U</mi></msubsup><msup><mo stretchy="false">)</mo><mi>T</mi></msup></mrow><annotation encoding="application/x-tex">W_qk = W_q^U·(W_k^U)^T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.2244em;vertical-align:-0.3831em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3831em;"><span/></span></span></span></span></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4169em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span></span></span></span></span></li>
<li>使注意力计算简化为：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>o</mi><mi>f</mi><mi>t</mi><mi>m</mi><mi>a</mi><mi>x</mi><mo stretchy="false">(</mo><msub><mi>C</mi><mi>q</mi></msub><mo separator="true">⋅</mo><msub><mi>W</mi><mi>q</mi></msub><mi>k</mi><mo separator="true">⋅</mo><msubsup><mi>C</mi><mi>k</mi><mi>T</mi></msubsup><mi mathvariant="normal">/</mi><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt><mo stretchy="false">)</mo><mo separator="true">⋅</mo><mo stretchy="false">(</mo><msub><mi>C</mi><mi>v</mi></msub><mo separator="true">⋅</mo><msubsup><mi>W</mi><mi>v</mi><mi>U</mi></msubsup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">softmax(C_q·W_qk·C_k^T/\sqrt{d_k})·(C_v·W_v^U)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.1433em;vertical-align:-0.2861em;"/><span class="mord mathnormal">so</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.4169em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2831em;"><span/></span></span></span></span></span><span class="mord">/</span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8572em;"><span class="svg-align" style="top:-3em;"><span class="pstrut" style="height:3em;"/><span class="mord" style="padding-left:0.833em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.8172em;"><span class="pstrut" style="height:3em;"/><span class="hide-tail" style="min-width:0.853em;height:1.08em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.08em" viewbox="0 0 400000 1080" preserveaspectratio="xMinYMin slice"><path d="M95,702&#10;c-2.7,0,-7.17,-2.7,-13.5,-8c-5.8,-5.3,-9.5,-10,-9.5,-14&#10;c0,-2,0.3,-3.3,1,-4c1.3,-2.7,23.83,-20.7,67.5,-54&#10;c44.2,-33.3,65.8,-50.3,66.5,-51c1.3,-1.3,3,-2,5,-2c4.7,0,8.7,3.3,12,10&#10;s173,378,173,378c0.7,0,35.3,-71,104,-213c68.7,-142,137.5,-285,206.5,-429&#10;c69,-144,104.5,-217.7,106.5,-221&#10;l0 -0&#10;c5.3,-9.3,12,-14,20,-14&#10;H400000v40H845.2724&#10;s-225.272,467,-225.272,467s-235,486,-235,486c-2.7,4.7,-9,7,-19,7&#10;c-6,0,-10,-1,-12,-3s-194,-422,-194,-422s-65,47,-65,47z&#10;M834 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.1828em;"><span/></span></span></span></span><span class="mclose">)</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8413em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></li>
<li>减少一次矩阵乘法，提升推理速度约1.7倍</li>
</ul>
<h3 data-id="heading-6">多头并行+潜变量协同</h3>
<ul>
<li>每个注意力头独立学习不同特征维度的潜在模式，捕捉多粒度语义关联</li>
<li>相比单一潜注意力，多头结构能并行挖掘不同维度的隐性关系，避免表达瓶颈</li>
</ul>
<h3 data-id="heading-7">三、与传统注意力机制对比</h3>








































<table><thead><tr><th>机制</th><th>核心特点</th><th>KV缓存大小</th><th>计算复杂度</th><th>表达能力</th></tr></thead><tbody><tr><td><strong>MHA(多头)</strong></td><td>每个头独立KV</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo separator="true">⋅</mo><mi>h</mi><mo separator="true">⋅</mo><msub><mi>d</mi><mi>h</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n·h·d_h)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">h</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo separator="true">⋅</mo><mi>h</mi><mo separator="true">⋅</mo><msub><mi>d</mi><mi>h</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n²·h·d_h)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">h</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></td><td>强(全表达)</td></tr><tr><td><strong>MQA(单头)</strong></td><td>所有头共享KV</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo separator="true">⋅</mo><msub><mi>d</mi><mi>h</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n·d_h)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo separator="true">⋅</mo><msub><mi>d</mi><mi>h</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n²·d_h)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></td><td>弱(表达受限)</td></tr><tr><td><strong>GQA(分组)</strong></td><td>每组共享KV</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo separator="true">⋅</mo><mi>g</mi><mo separator="true">⋅</mo><msub><mi>d</mi><mi>h</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n·g·d_h)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo separator="true">⋅</mo><mi>g</mi><mo separator="true">⋅</mo><msub><mi>d</mi><mi>h</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n²·g·d_h)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></td><td>中(部分表达)</td></tr><tr><td><strong>MLA(潜在)</strong></td><td>KV压缩至潜空间</td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><mi>n</mi><mo separator="true">⋅</mo><msub><mi>d</mi><mi>c</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n·d_c)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathnormal">n</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></td><td><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>O</mi><mo stretchy="false">(</mo><msup><mi>n</mi><mn>2</mn></msup><mo separator="true">⋅</mo><msub><mi>d</mi><mi>c</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">O(n²·d_c)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0641em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span></td><td>强(全表达且增广)</td></tr></tbody></table>
<p><strong>关键优势</strong>：</p>
<ul>
<li><strong>内存效率</strong>：MLA的KV缓存仅为MHA的(<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>c</mi></msub><mi mathvariant="normal">/</mi><mo stretchy="false">(</mo><mi>h</mi><mo separator="true">⋅</mo><msub><mi>d</mi><mi>h</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">d_c/(h·d_h)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">/</span><span class="mopen">(</span><span class="mord mathnormal">h</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mclose">)</span></span></span></span></span>)，如DeepSeek-V3中从6.8GB降至3.2GB，减少53%</li>
<li><strong>计算速度</strong>：推理延迟从89ms降至42ms，提升53%</li>
<li><strong>表达能力</strong>：理论证明MLA表达能力严格强于GQA(同KV缓存大小时)，可表示更多函数关系</li>
</ul>
<h2 data-id="heading-8">DeepSeek中的MLA实现细节</h2>
<p>DeepSeek-V3/R1中MLA关键参数：</p>
<ul>
<li>嵌入维度d: 7168</li>
<li>头数<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>n</mi><mi>h</mi></msub></mrow><annotation encoding="application/x-tex">n_h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">h</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>: 128</li>
<li>潜在维度<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>c</mi></msub></mrow><annotation encoding="application/x-tex">d_c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8444em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>: 2048(约为原始1/8)</li>
<li>查询投影维度: 1536</li>
<li>非RoPE头维度: 128</li>
</ul>
<p><strong>完整计算流程</strong>：</p>
<ol>
<li>输入投影</li>
</ol>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>Q</mi><mo>=</mo><mi>X</mi><mo separator="true">⋅</mo><msub><mi>W</mi><mi>Q</mi></msub><mspace linebreak="newline"/><msub><mi>C</mi><mi>k</mi></msub><mo>=</mo><mi>X</mi><mo separator="true">⋅</mo><msubsup><mi>W</mi><mi>k</mi><mi>D</mi></msubsup><mspace linebreak="newline"/><msub><mi>C</mi><mi>v</mi></msub><mo>=</mo><mi>X</mi><mo separator="true">⋅</mo><msubsup><mi>W</mi><mi>v</mi><mi>D</mi></msubsup></mrow><annotation encoding="application/x-tex">Q = X·W_Q \\
C_k = X·W_k^D\\
C_v = X·W_v^D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord mathnormal">Q</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">Q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1383em;vertical-align:-0.247em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1383em;vertical-align:-0.247em;"/><span class="mord mathnormal" style="margin-right:0.07847em;">X</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span></span></span></span></span></div>
<ol start="2">
<li>预计算优化</li>
</ol>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>W</mi><mi>q</mi></msub><mi>k</mi><mo>=</mo><msubsup><mi>W</mi><mi>q</mi><mi>U</mi></msubsup><mo separator="true">⋅</mo><mo stretchy="false">(</mo><msubsup><mi>W</mi><mi>k</mi><mi>U</mi></msubsup><msup><mo stretchy="false">)</mo><mi>T</mi></msup><mo separator="true">,</mo><mtext>可预先计算</mtext></mrow><annotation encoding="application/x-tex">W_qk = W_q^U·(W_k^U)^T  , 可预先计算</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9805em;vertical-align:-0.2861em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.2744em;vertical-align:-0.3831em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.3831em;"><span/></span></span></span></span></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord cjk_fallback">可预先计算</span></span></span></span></span></div>
<ol start="3">
<li>注意力得分</li>
</ol>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mi>s</mi><mi>c</mi><mi>o</mi><mi>r</mi><mi>e</mi><mi>s</mi><mo>=</mo><mo stretchy="false">(</mo><mi>Q</mi><mo separator="true">⋅</mo><msub><mi>W</mi><mi>q</mi></msub><mi>k</mi><mo stretchy="false">)</mo><mo separator="true">⋅</mo><msubsup><mi>C</mi><mi>k</mi><mi>T</mi></msubsup><mi mathvariant="normal">/</mi><msqrt><msub><mi>d</mi><mi>k</mi></msub></msqrt><mspace linebreak="newline"/><mi>p</mi><mi>r</mi><mi>o</mi><mi>b</mi><mi>s</mi><mo>=</mo><mi>s</mi><mi>o</mi><mi>f</mi><mi>t</mi><mi>m</mi><mi>a</mi><mi>x</mi><mo stretchy="false">(</mo><mi>s</mi><mi>c</mi><mi>o</mi><mi>r</mi><mi>e</mi><mi>s</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">scores = (Q·W_qk)·C_k^T / \sqrt{d_k} \\
probs = softmax(scores)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">scores</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.2922em;vertical-align:-0.2861em;"/><span class="mopen">(</span><span class="mord mathnormal">Q</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">q</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span/></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mclose">)</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.13889em;">T</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span><span class="mord">/</span><span class="mord sqrt"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0061em;"><span class="svg-align" style="top:-3.2em;"><span class="pstrut" style="height:3.2em;"/><span class="mord" style="padding-left:1em;"><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span><span style="top:-2.9661em;"><span class="pstrut" style="height:3.2em;"/><span class="hide-tail" style="min-width:1.02em;height:1.28em;"><svg xmlns="http://www.w3.org/2000/svg" width="400em" height="1.28em" viewbox="0 0 400000 1296" preserveaspectratio="xMinYMin slice"><path d="M263,681c0.7,0,18,39.7,52,119&#10;c34,79.3,68.167,158.7,102.5,238c34.3,79.3,51.8,119.3,52.5,120&#10;c340,-704.7,510.7,-1060.3,512,-1067&#10;l0 -0&#10;c4.7,-7.3,11,-11,19,-11&#10;H40000v40H1012.3&#10;s-271.3,567,-271.3,567c-38.7,80.7,-84,175,-136,283c-52,108,-89.167,185.3,-111.5,232&#10;c-22.3,46.7,-33.8,70.3,-34.5,71c-4.7,4.7,-12.3,7,-23,7s-12,-1,-12,-1&#10;s-109,-253,-109,-253c-72.7,-168,-109.3,-252,-110,-252c-10.7,8,-22,16.7,-34,26&#10;c-22,17.3,-33.3,26,-34,26s-26,-26,-26,-26s76,-59,76,-59s76,-60,76,-60z&#10;M1001 80h400000v40h-400000z"/></svg></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2339em;"><span/></span></span></span></span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">p</span><span class="mord mathnormal">ro</span><span class="mord mathnormal">b</span><span class="mord mathnormal">s</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">so</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">t</span><span class="mord mathnormal">ma</span><span class="mord mathnormal">x</span><span class="mopen">(</span><span class="mord mathnormal">scores</span><span class="mclose">)</span></span></span></span></span></div>
<ol start="4">
<li>值上投影与加权</li>
</ol>
<div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>V</mi><mi>r</mi></msub><mi>e</mi><mi>c</mi><mo>=</mo><msub><mi>C</mi><mi>v</mi></msub><mo separator="true">⋅</mo><msubsup><mi>W</mi><mi>v</mi><mi>U</mi></msubsup><mspace linebreak="newline"/><mi>o</mi><mi>u</mi><mi>t</mi><mi>p</mi><mi>u</mi><mi>t</mi><mo>=</mo><mi>p</mi><mi>r</mi><mi>o</mi><mi>b</mi><mi>s</mi><mo separator="true">⋅</mo><msub><mi>V</mi><mi>r</mi></msub><mi>e</mi><mi>c</mi><mo separator="true">⋅</mo><msub><mi>W</mi><mi>O</mi></msub></mrow><annotation encoding="application/x-tex">V_rec = C_v·W_v^U \\
output = probs·V_rec·W_O</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal">ec</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.1383em;vertical-align:-0.247em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.453em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">U</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.247em;"><span/></span></span></span></span></span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:0.8095em;vertical-align:-0.1944em;"/><span class="mord mathnormal">o</span><span class="mord mathnormal">u</span><span class="mord mathnormal">tp</span><span class="mord mathnormal">u</span><span class="mord mathnormal">t</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal">p</span><span class="mord mathnormal">ro</span><span class="mord mathnormal">b</span><span class="mord mathnormal">s</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal">ec</span><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.1389em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">O</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span></div>
<p><strong>推理优化</strong>：仅缓存<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">C_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>、<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">C_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>，而非完整K、V，在生成新token时，只需计算新token的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">C_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03148em;">k</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>、<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>C</mi><mi>v</mi></msub></mrow><annotation encoding="application/x-tex">C_v</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0715em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">v</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span>并追加到缓存，显著减少内存占用和带宽需求</p>
<h2 data-id="heading-9">应用场景与优势</h2>
<h3 data-id="heading-10">长文本处理</h3>
<ul>
<li>支持数倍于传统模型的上下文长度(如从4K到32K token)</li>
<li>在保持95%+模型精度的同时，KV缓存占用降低30-50%</li>
<li>特别适合文档摘要、知识问答等需要长程依赖理解的任务</li>
</ul>
<h3 data-id="heading-11">大规模模型部署</h3>
<ul>
<li>降低硬件门槛：相同GPU可部署更大模型或支持更多并发</li>
<li>减少碳排放：推理能耗降低约40%</li>
<li>适合云服务、边缘设备和移动端部署</li>
</ul>
<h3 data-id="heading-12">多模态融合</h3>
<ul>
<li>设计共享潜在编码器，将不同模态(文本、图像、视频)映射到统一空间</li>
<li>实现跨模态细粒度对齐，在医疗影像-文本分析等任务中F1-score提升至0.92</li>
</ul>
<h2 data-id="heading-13">总结</h2>
<p><strong>MLA核心价值</strong>：通过"以计算换存储"策略，在几乎不损失模型表达能力的前提下，解决了大模型推理的内存瓶颈，为长文本理解和高效部署开辟了新路径。</p>
<p><strong>未来发展方向</strong>：</p>
<ul>
<li>TransMLA: 将现有GQA模型无缝转换为MLA，提升表达能力而不增加内存开销</li>
<li>FlashMLA: DeepSeek最新优化，进一步提升推理速度，降低内存占用</li>
<li>与MoE(混合专家)结合，在保持轻量的同时增强模型多样性和推理能力</li>
</ul>
<p>MLA不仅是注意力机制的技术创新，更是大模型工程化的关键突破，为构建更高效、更强大的AI系统奠定了基础。随着研究深入，MLA有望成为下一代大型语言模型的标配组件，推动AI从"能用"向"好用"跨越。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[并发编程高级技巧：运行时检测死锁，告别死锁焦虑]]></title>    <link>https://juejin.cn/post/7586504691845234697</link>    <guid>https://juejin.cn/post/7586504691845234697</guid>    <pubDate>2025-12-22T11:18:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586504691845234697" data-draft-id="7586498198148792371" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="并发编程高级技巧：运行时检测死锁，告别死锁焦虑"/> <meta itemprop="keywords" content="后端,性能优化,Java"/> <meta itemprop="datePublished" content="2025-12-22T11:18:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="桦说编程"/> <meta itemprop="url" content="https://juejin.cn/user/2212689394274136"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            并发编程高级技巧：运行时检测死锁，告别死锁焦虑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2212689394274136/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    桦说编程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T11:18:18.000Z" title="Mon Dec 22 2025 11:18:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好,我是桦说编程。</p>
<blockquote>
<p>死锁是多线程编程的噩梦，一旦发生程序就会挂起。本文介绍 Guava 的 <code>CycleDetectingLockFactory</code>，让你在开发阶段就能发现潜在死锁，而不是等到生产环境暴雷。</p>
</blockquote>
<h2 data-id="heading-0">问题背景：死锁焦虑</h2>
<p>使用 <code>ReentrantLock</code> 或 <code>synchronized</code> 时，最担心的就是死锁：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 线程1：先锁A，再锁B</span>
lockA.lock();
lockB.lock();

<span class="hljs-comment">// 线程2：先锁B，再锁A</span>
lockB.lock();
lockA.lock();
</code></pre>
<p>这种代码在单元测试中可能运行正常，但在生产环境高并发时突然死锁，程序挂起，只能重启。</p>
<p><strong>核心痛点</strong>：</p>
<ul>
<li>死锁难以复现，测试阶段很难发现</li>
<li>一旦发生，只能强制重启</li>
<li>排查需要线程 dump 分析，耗时耗力</li>
</ul>
<h2 data-id="heading-1">CycleDetectingLockFactory：运行时死锁检测</h2>
<p>Guava 提供的 <code>CycleDetectingLockFactory</code> 通过<strong>构建锁的依赖图</strong>，在获取锁时实时检测是否会形成环路（死锁）。</p>
<h3 data-id="heading-2">核心原理</h3>
<ol>
<li><strong>锁依赖图</strong>：记录每个线程获取锁的顺序</li>
<li><strong>环路检测</strong>：尝试获取新锁时，检查是否会形成环路</li>
<li><strong>即时失败</strong>：检测到潜在死锁时，立即抛出 <code>PotentialDeadlockException</code></li>
</ol>
<h3 data-id="heading-3">三种检测策略</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. THROW - 抛出异常（推荐用于开发/测试环境）</span>
CycleDetectingLockFactory.newInstance(Policies.THROW);

<span class="hljs-comment">// 2. WARN - 打印警告日志（适合生产环境）</span>
CycleDetectingLockFactory.newInstance(Policies.WARN);

<span class="hljs-comment">// 3. DISABLED - 禁用检测（性能敏感场景）</span>
CycleDetectingLockFactory.newInstance(Policies.DISABLED);
</code></pre>
<h2 data-id="heading-4">对比演示：死锁 vs 死锁检测</h2>
<h3 data-id="heading-5">场景：转账系统</h3>
<p>两个账户相互转账，线程1从A转到B，线程2从B转到A。</p>
<h3 data-id="heading-6">死锁版本（ReentrantLock）</h3>
<p>使用普通 <code>ReentrantLock</code>，程序会挂起：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Account</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ReentrantLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReentrantLock</span>();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transfer</span><span class="hljs-params">(Account target, <span class="hljs-type">int</span> amount)</span> {
        lock.lock();  <span class="hljs-comment">// 先锁自己</span>
        <span class="hljs-keyword">try</span> {
            target.lock.lock();  <span class="hljs-comment">// 再锁对方 - 可能死锁!</span>
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 转账逻辑</span>
            } <span class="hljs-keyword">finally</span> {
                target.lock.unlock();
            }
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }
}
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-css" lang="css">线程<span class="hljs-number">1</span> 获取了 账户<span class="hljs-selector-tag">A</span> 的锁
线程<span class="hljs-number">2</span> 获取了 账户<span class="hljs-selector-tag">B</span> 的锁
=== <span class="hljs-number">3</span>秒后程序仍未结束，发生死锁 ===
线程<span class="hljs-number">1</span>状态: WAITING
线程<span class="hljs-number">2</span>状态: WAITING
</code></pre>
<h3 data-id="heading-7">死锁检测版本（CycleDetectingLockFactory）</h3>
<p>替换为 <code>CycleDetectingLockFactory</code>，死锁会被立即检测：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">CycleDetectingLockFactory</span> <span class="hljs-variable">lockFactory</span> <span class="hljs-operator">=</span>
    CycleDetectingLockFactory.newInstance(Policies.THROW);

<span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Account</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Lock lock;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">Account</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> balance)</span> {
        <span class="hljs-built_in">this</span>.lock = lockFactory.newReentrantLock(name);  <span class="hljs-comment">// 使用工厂创建锁</span>
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transfer</span><span class="hljs-params">(Account target, <span class="hljs-type">int</span> amount)</span> {
        lock.lock();
        <span class="hljs-keyword">try</span> {
            target.lock.lock();  <span class="hljs-comment">// 检测到死锁会抛出异常</span>
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 转账逻辑</span>
            } <span class="hljs-keyword">finally</span> {
                target.lock.unlock();
            }
        } <span class="hljs-keyword">catch</span> (PotentialDeadlockException e) {
            System.err.println(<span class="hljs-string">"检测到潜在死锁: "</span> + e.getMessage());
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }
}
</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-css" lang="css">线程<span class="hljs-number">1</span> 获取了 账户<span class="hljs-selector-tag">A</span> 的锁
线程<span class="hljs-number">2</span> 获取了 账户<span class="hljs-selector-tag">B</span> 的锁
线程<span class="hljs-number">2</span> 检测到潜在死锁!
死锁信息: Potential Deadlock from LockGraphNode{账户<span class="hljs-selector-tag">B</span>} <span class="hljs-selector-tag">to</span> LockGraphNode{账户<span class="hljs-selector-tag">A</span>}
=== 程序正常结束，未发生死锁挂起 ===
</code></pre>
<h2 data-id="heading-8">实战建议</h2>
<h3 data-id="heading-9">1. 开发/测试环境使用 THROW 策略</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在测试环境配置</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">CycleDetectingLockFactory</span> <span class="hljs-variable">lockFactory</span> <span class="hljs-operator">=</span>
    CycleDetectingLockFactory.newInstance(Policies.THROW);
</code></pre>
<p><strong>好处</strong>：单元测试、集成测试中自动发现死锁问题，快速失败。</p>
<h3 data-id="heading-10">2. 生产环境使用 WARN 策略</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在生产环境配置</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">CycleDetectingLockFactory</span> <span class="hljs-variable">lockFactory</span> <span class="hljs-operator">=</span>
    CycleDetectingLockFactory.newInstance(Policies.WARN);
</code></pre>
<p><strong>好处</strong>：记录告警日志，但不中断业务，便于后续优化。</p>
<h3 data-id="heading-11">3. 性能敏感场景可以禁用</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 性能优先场景</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">CycleDetectingLockFactory</span> <span class="hljs-variable">lockFactory</span> <span class="hljs-operator">=</span>
    CycleDetectingLockFactory.newInstance(Policies.DISABLED);
</code></pre>
<p><strong>注意</strong>：只有在确认没有死锁风险，且性能测试证明检测有明显开销时才禁用。</p>
<h3 data-id="heading-12">4. 更好的方案：固定加锁顺序</h3>
<p>死锁检测只是兜底手段，根本解决方案是<strong>避免环路依赖</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 按照固定顺序加锁，避免死锁</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">safeTransfer</span><span class="hljs-params">(Account from, Account to, <span class="hljs-type">int</span> amount)</span> {
    <span class="hljs-type">Account</span> <span class="hljs-variable">first</span> <span class="hljs-operator">=</span> System.identityHashCode(from) &lt; System.identityHashCode(to) ? from : to;
    <span class="hljs-type">Account</span> <span class="hljs-variable">second</span> <span class="hljs-operator">=</span> first == from ? to : from;

    first.lock.lock();
    <span class="hljs-keyword">try</span> {
        second.lock.lock();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 转账逻辑</span>
        } <span class="hljs-keyword">finally</span> {
            second.lock.unlock();
        }
    } <span class="hljs-keyword">finally</span> {
        first.lock.unlock();
    }
}
</code></pre>
<h2 data-id="heading-13">完整示例</h2>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * CycleDetectingLockFactory 死锁检测演示
 *
 * &lt;p&gt;与 DeadlockDemo 相同的转账场景，但使用 CycleDetectingLockFactory
 * &lt;p&gt;当检测到潜在死锁时，会立即抛出 PotentialDeadlockException，而不是挂起程序
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CycleDetectingLockDemo</span> {

    <span class="hljs-comment">// 创建锁工厂，THROW 策略会在检测到死锁时抛出异常</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">CycleDetectingLockFactory</span> <span class="hljs-variable">lockFactory</span> <span class="hljs-operator">=</span>
            CycleDetectingLockFactory.newInstance(CycleDetectingLockFactory.Policies.THROW);

    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Account</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String name;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Lock lock;
        <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> balance;

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">Account</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> balance)</span> {
            <span class="hljs-built_in">this</span>.name = name;
            <span class="hljs-built_in">this</span>.balance = balance;
            <span class="hljs-comment">// 使用 CycleDetectingLockFactory 创建锁</span>
            <span class="hljs-comment">// 每个锁都有一个唯一的标识，用于构建锁的依赖图</span>
            <span class="hljs-built_in">this</span>.lock = lockFactory.newReentrantLock(name);
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transfer</span><span class="hljs-params">(Account target, <span class="hljs-type">int</span> amount)</span> {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 先锁定自己的账户</span>
                lock.lock();
                <span class="hljs-keyword">try</span> {
                    System.out.println(Thread.currentThread().getName() +
                            <span class="hljs-string">" 获取了 "</span> + name + <span class="hljs-string">" 的锁"</span>);

                    <span class="hljs-comment">// 模拟业务处理耗时</span>
                    Thread.sleep(<span class="hljs-number">100</span>);

                    <span class="hljs-comment">// 尝试锁定目标账户</span>
                    <span class="hljs-comment">// 如果会形成循环依赖（死锁），这里会立即抛出 PotentialDeadlockException</span>
                    target.lock.lock();
                    <span class="hljs-keyword">try</span> {
                        System.out.println(Thread.currentThread().getName() +
                                <span class="hljs-string">" 获取了 "</span> + target.name + <span class="hljs-string">" 的锁"</span>);

                        <span class="hljs-built_in">this</span>.balance -= amount;
                        target.balance += amount;

                        System.out.println(Thread.currentThread().getName() +
                                <span class="hljs-string">" 完成转账: "</span> + name + <span class="hljs-string">" -&gt; "</span> + target.name + <span class="hljs-string">" ¥"</span> + amount);
                    } <span class="hljs-keyword">finally</span> {
                        target.lock.unlock();
                    }
                } <span class="hljs-keyword">finally</span> {
                    lock.unlock();
                }
            } <span class="hljs-keyword">catch</span> (CycleDetectingLockFactory.PotentialDeadlockException e) {
                <span class="hljs-comment">// 检测到潜在死锁，立即抛出异常</span>
                System.err.println(Thread.currentThread().getName() +
                        <span class="hljs-string">" 检测到潜在死锁!"</span>);
                System.err.println(<span class="hljs-string">"死锁信息: "</span> + e.getMessage());
                <span class="hljs-comment">// 打印完整的锁依赖链</span>
                e.printStackTrace();
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">return</span> name + <span class="hljs-string">": ¥"</span> + balance;
        }
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-type">Account</span> <span class="hljs-variable">accountA</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Account</span>(<span class="hljs-string">"账户A"</span>, <span class="hljs-number">1000</span>);
        <span class="hljs-type">Account</span> <span class="hljs-variable">accountB</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Account</span>(<span class="hljs-string">"账户B"</span>, <span class="hljs-number">1000</span>);

        System.out.println(<span class="hljs-string">"=== CycleDetectingLockFactory 死锁检测演示 ==="</span>);
        System.out.println(<span class="hljs-string">"初始状态: "</span> + accountA + <span class="hljs-string">", "</span> + accountB);
        System.out.println();

        <span class="hljs-comment">// 线程1: A -&gt; B 转账</span>
        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            accountA.transfer(accountB, <span class="hljs-number">200</span>);
        }, <span class="hljs-string">"线程1"</span>);

        <span class="hljs-comment">// 线程2: B -&gt; A 转账</span>
        <span class="hljs-type">Thread</span> <span class="hljs-variable">thread2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
            accountB.transfer(accountA, <span class="hljs-number">300</span>);
        }, <span class="hljs-string">"线程2"</span>);

        thread1.start();
        thread2.start();

        <span class="hljs-comment">// 等待线程结束</span>
        thread1.join(<span class="hljs-number">5000</span>);
        thread2.join(<span class="hljs-number">5000</span>);

        System.out.println();
        System.out.println(<span class="hljs-string">"=== 程序正常结束，未发生死锁挂起 ==="</span>);
        System.out.println(<span class="hljs-string">"最终状态: "</span> + accountA + <span class="hljs-string">", "</span> + accountB);
        System.out.println(<span class="hljs-string">"线程1状态: "</span> + thread1.getState());
        System.out.println(<span class="hljs-string">"线程2状态: "</span> + thread2.getState());
    }

    <span class="hljs-comment">/**
     * 演示正确的锁顺序 - 避免死锁
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SafeTransferDemo</span> {
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
            <span class="hljs-type">Account</span> <span class="hljs-variable">accountA</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Account</span>(<span class="hljs-string">"账户A"</span>, <span class="hljs-number">1000</span>);
            <span class="hljs-type">Account</span> <span class="hljs-variable">accountB</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Account</span>(<span class="hljs-string">"账户B"</span>, <span class="hljs-number">1000</span>);

            System.out.println(<span class="hljs-string">"=== 安全转账演示（按固定顺序加锁）==="</span>);
            System.out.println(<span class="hljs-string">"初始状态: "</span> + accountA + <span class="hljs-string">", "</span> + accountB);
            System.out.println();

            <span class="hljs-comment">// 两个线程都按照相同的顺序加锁：先 A 后 B</span>
            <span class="hljs-type">Thread</span> <span class="hljs-variable">thread1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
                safeTransfer(accountA, accountB, <span class="hljs-number">200</span>);
            }, <span class="hljs-string">"线程1"</span>);

            <span class="hljs-type">Thread</span> <span class="hljs-variable">thread2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
                safeTransfer(accountB, accountA, <span class="hljs-number">300</span>);
            }, <span class="hljs-string">"线程2"</span>);

            thread1.start();
            thread2.start();

            thread1.join();
            thread2.join();

            System.out.println();
            System.out.println(<span class="hljs-string">"=== 安全转账完成 ==="</span>);
            System.out.println(<span class="hljs-string">"最终状态: "</span> + accountA + <span class="hljs-string">", "</span> + accountB);
        }

        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">safeTransfer</span><span class="hljs-params">(Account from, Account to, <span class="hljs-type">int</span> amount)</span> {
            <span class="hljs-comment">// 按照固定顺序加锁：使用 hashCode 或其他标识符确定顺序</span>
            <span class="hljs-type">Account</span> <span class="hljs-variable">first</span> <span class="hljs-operator">=</span> System.identityHashCode(from) &lt; System.identityHashCode(to) ? from : to;
            <span class="hljs-type">Account</span> <span class="hljs-variable">second</span> <span class="hljs-operator">=</span> first == from ? to : from;

            <span class="hljs-keyword">try</span> {
                first.lock.lock();
                <span class="hljs-keyword">try</span> {
                    System.out.println(Thread.currentThread().getName() +
                            <span class="hljs-string">" 获取了 "</span> + first.name + <span class="hljs-string">" 的锁"</span>);

                    Thread.sleep(<span class="hljs-number">100</span>);

                    second.lock.lock();
                    <span class="hljs-keyword">try</span> {
                        System.out.println(Thread.currentThread().getName() +
                                <span class="hljs-string">" 获取了 "</span> + second.name + <span class="hljs-string">" 的锁"</span>);

                        from.balance -= amount;
                        to.balance += amount;

                        System.out.println(Thread.currentThread().getName() +
                                <span class="hljs-string">" 完成转账: "</span> + from.name + <span class="hljs-string">" -&gt; "</span> + to.name + <span class="hljs-string">" ¥"</span> + amount);
                    } <span class="hljs-keyword">finally</span> {
                        second.lock.unlock();
                    }
                } <span class="hljs-keyword">finally</span> {
                    first.lock.unlock();
                }
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-14">核心要点</h2>
<h3 data-id="heading-15">CycleDetectingLockFactory 的优势</h3>
<ol>
<li><strong>即时反馈</strong>：开发阶段就能发现潜在死锁</li>
<li><strong>零侵入</strong>：只需替换锁的创建方式，业务代码不变</li>
<li><strong>可配置</strong>：根据环境选择不同策略（抛异常/告警/禁用）</li>
<li><strong>清晰诊断</strong>：异常信息包含完整的锁依赖链</li>
</ol>
<h3 data-id="heading-16">使用场景</h3>
<ul>
<li><strong>推荐使用</strong>：多个锁、加锁顺序不确定的场景</li>
<li><strong>测试环境</strong>：全局使用 THROW 策略，自动化测试发现问题</li>
<li><strong>生产环境</strong>：使用 WARN 策略作为监控手段</li>
<li><strong>不推荐</strong>：单锁场景、加锁顺序固定的场景（无必要）</li>
</ul>
<h2 data-id="heading-17">总结</h2>
<ul>
<li><strong>死锁难以复现</strong>，生产环境暴露成本高，<code>CycleDetectingLockFactory</code> 让问题前移</li>
<li><strong>THROW 策略</strong>用于测试环境，<strong>WARN 策略</strong>用于生产环境</li>
<li><strong>死锁检测是兜底</strong>，根本方案是设计合理的加锁顺序</li>
<li><strong>零侵入改造</strong>，只需替换锁的创建方式，立即获得死锁检测能力</li>
<li><strong>检测开销</strong>：需要维护锁依赖图，有轻微性能损耗</li>
</ul>
<p>使用 <code>CycleDetectingLockFactory</code> 可以让你摆脱死锁焦虑，在开发阶段就发现问题，而不是等到生产环境暴雷后手忙脚乱。</p>
<hr/>
<p>如果这篇文章对你有帮助，欢迎关注我，持续分享高质量技术干货，助你更快提升编程能力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[💪别再迷茫！一份让你彻底掌控 TypeScript 类型系统的终极指南]]></title>    <link>https://juejin.cn/post/7586506307726491658</link>    <guid>https://juejin.cn/post/7586506307726491658</guid>    <pubDate>2025-12-22T11:25:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586506307726491658" data-draft-id="7586482860103827483" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="💪别再迷茫！一份让你彻底掌控 TypeScript 类型系统的终极指南"/> <meta itemprop="keywords" content="前端,TypeScript"/> <meta itemprop="datePublished" content="2025-12-22T11:25:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="hboot"/> <meta itemprop="url" content="https://juejin.cn/user/2084329777543191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            💪别再迷茫！一份让你彻底掌控 TypeScript 类型系统的终极指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2084329777543191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    hboot
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T11:25:34.000Z" title="Mon Dec 22 2025 11:25:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    16
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>TypeScript</code>现在的普及度已经很高了，虽然它是一种静态类型定义，但它的庞大已足够我们要向对待一门语言一样对待它了，去深入学习，以便更好的利用它的能力。</p>
<p>当然了，我们首先要明确为什么需要它，而不是把它当作一种负担：</p>
<ul>
<li>编译时类型检查，避免了运行时才检查的数据类型错误，导致系统奔溃。</li>
<li>提升开发效率，IDE基于类型系统提供了精准的代码补全、接口提示。减少了查询文档、查询API的成本。</li>
<li>增强了代码可读性，通过类型注解帮助成员快速理解函数输入、输出，降低了协作成本。</li>
</ul>
<h2 data-id="heading-0">类型系统基石</h2>
<p>像一门语言有基本的语法一样，<code>TypeScript</code>也有基本的类型定义，这些基本类型对应<code>JavaScript</code>中的基本数据类型，包括<code>number</code>、<code>string</code>、<code>boolean</code>、<code>null</code>、<code>undefined</code>、<code>symbol</code>、<code>bigint</code>、<code>object</code>。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"hboot"</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">18</span>;
<span class="hljs-keyword">const</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">`hello, <span class="hljs-subst">${name}</span>`</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">uniqueKey</span>: <span class="hljs-built_in">symbol</span> = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">"key"</span>);
</code></pre>
<h3 data-id="heading-1">空类型、任意类型、未知类型</h3>
<p><code>void</code>表示空类型，<code>any</code>表示任意类型，<code>unknown</code>表示未知类型。</p>
<ul>
<li><code>void</code> 常用于函数无返回值时的返回类型声明；</li>
<li><code>any</code> 表示任意类型，失去了类型检查的能力，非必要不要用；</li>
<li><code>unknown</code> 表示未知类型，可以用来代替<code>any</code>，但是它不能直接用，必须通过类型断言或类型守卫明确具体类型才能操作。</li>
<li><code>never</code> 表示没有任何类型，变量和函数返回不会存在任何实际值。它是所有类型的字类型，可以赋值给任意类型。</li>
</ul>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">noReturn</span>(<span class="hljs-params">msg: <span class="hljs-built_in">string</span></span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(msg);
}

<span class="hljs-keyword">let</span> <span class="hljs-attr">name</span>: <span class="hljs-built_in">any</span> = <span class="hljs-string">"admin"</span>;
<span class="hljs-comment">// 可以任意赋值</span>
name = <span class="hljs-number">123</span>;
<span class="hljs-comment">// 甚至是当作函数调用,这导致开发不易发现，运行时才报错</span>
<span class="hljs-title function_">name</span>():

<span class="hljs-keyword">let</span> <span class="hljs-attr">age</span>: <span class="hljs-built_in">unknown</span> = <span class="hljs-number">18</span>;
<span class="hljs-comment">// 类型为未知，无法直接操作</span>
age += <span class="hljs-number">10</span>;
<span class="hljs-comment">// 通过类型守卫，明确类型为 number</span>
<span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> age === <span class="hljs-string">'number'</span>) { 
    age += <span class="hljs-number">10</span>;
}
</code></pre>
<h2 data-id="heading-2">复合类型</h2>
<p>复合类型就是基础类型的组合，包括数组、对象、元组、枚举、类。</p>
<h3 data-id="heading-3">数组</h3>
<p>数组的类型定义<code>T[]</code>或<code>Array&lt;T&gt;</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 数组</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">names</span>: <span class="hljs-built_in">string</span>[] = [<span class="hljs-string">'admin'</span>, <span class="hljs-string">'user'</span>];
<span class="hljs-keyword">let</span> <span class="hljs-attr">names</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt; = [<span class="hljs-string">'admin'</span>, <span class="hljs-string">'user'</span>];
</code></pre>
<h3 data-id="heading-4">对象</h3>
<p>对象类型定义对象的属性名、属性类型。属性支持可选、只读、索引签名。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 对象</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">user</span>: { <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span> } = {
    <span class="hljs-attr">name</span>: <span class="hljs-string">'hboot'</span>,
    <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>
}
</code></pre>
<h3 data-id="heading-5">元组</h3>
<p>元组是明确了数组长度以及元素类型的。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 元组</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">userInfo</span>: [<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>] = [<span class="hljs-string">'hboot'</span>, <span class="hljs-number">18</span>];
</code></pre>
<h3 data-id="heading-6">枚举</h3>
<p>枚举用于定义一组有特殊含义的常量，比如状态码、类型标识等。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 枚举</span>
<span class="hljs-keyword">const</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Status</span> { 
    <span class="hljs-title class_">Success</span> = <span class="hljs-number">200</span>,
    <span class="hljs-title class_">Fail</span> = <span class="hljs-number">500</span>
}
</code></pre>
<p>未赋值时，枚举值从 0 开始递增。如果自定义了开始值，则后面的值递增。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Status</span> { 
  <span class="hljs-title class_">Success</span>, <span class="hljs-comment">// 0</span>
  <span class="hljs-title class_">Fail</span> <span class="hljs-comment">// 1</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Status</span> { 
  <span class="hljs-title class_">Success</span> = <span class="hljs-number">1</span>, <span class="hljs-comment">// 1</span>
  <span class="hljs-title class_">Fail</span> <span class="hljs-comment">// 2</span>
}
</code></pre>
<p>可以通过<code>const enum</code>修饰枚举定义，在编译时仅保留常量值，减少代码体积。</p>
<h3 data-id="heading-7">类<code>Class</code></h3>
<p>类<code>class</code>是面向对象编程的核心。es6中已经增强了对类的支持，可以通过类定义对象，明确属性、方法。类不仅可以用来创建实例，也可以作为类型注解描述实例类型。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
}
</code></pre>
<p>类的定义包括实例属性、实例方法、静态属性、静态方法，同时还支持通过访问修饰符控制成员可见。</p>
<p>子类可以通过<code>extends</code>继承父类的非<code>private</code>成员，重写父类方法。<strong>仅能继承一个父类。</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {
  <span class="hljs-title class_">WangWang</span>() {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"WangWang"</span>;
  }
}
</code></pre>
<p>类可以通过<code>implements</code>实现接口，用于约束类的实现，包括属性、方法，仅约束结构，不提供实现。<strong>可实现多个接口</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-title function_">speak</span>(): <span class="hljs-built_in">void</span>;
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-title function_">speak</span>(): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"WangWang"</span>);
  }
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
}
</code></pre>
<p>通过<code>abstract</code>关键字可以声明抽象类，抽象类不能被实例化。它只定义了字段、方法结构，未实现具体逻辑，它仅可被子类继承，并需要实现它定义的所有抽象成员。</p>
<h2 data-id="heading-8">高级类型</h2>
<p>基础类型可以满足绝大多数业务，但面对复杂业务需要类型复用、条件判断、属性筛选则需要高级类型。</p>
<h3 data-id="heading-9">复用类型</h3>
<p>为了复用类型，可以通过<code>type</code> \ <code>interface</code>定义类型。<code>type</code>可以定义任意类型，包括基础类型、复合类型、联合类型等，比较灵活；<code>interface</code> 只能定义对象类型,但是可以<code>继承</code>和<code>同名合并</code>。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// type</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Age</span> = <span class="hljs-built_in">number</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">User</span> = { 
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">age</span>: <span class="hljs-title class_">Age</span>;
}
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Status</span> = <span class="hljs-string">'success'</span> | <span class="hljs-number">200</span>;

<span class="hljs-comment">// interface</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> { 
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">SuperUser</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">User</span> { 
    <span class="hljs-attr">role</span>: <span class="hljs-built_in">string</span>;
}
</code></pre>
<p><code>interface</code> 不同于类<code>class</code>,它可以继承多个接口。</p>
<h3 data-id="heading-10">联合/交叉类型</h3>
<p>联合类型通过<code>|</code>表示变量可以是任意其中一种类型；交叉类型通过<code>&amp;</code>表示变量必须同时满足多个类型。</p>
<p>联合类型使用时需要类型守卫明确类型后才能操作,如果变量已经赋值，则会自动推导出类型；</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Age</span> = <span class="hljs-built_in">number</span> | <span class="hljs-built_in">string</span>;

<span class="hljs-keyword">let</span> <span class="hljs-attr">age</span>: <span class="hljs-title class_">Age</span> = <span class="hljs-number">18</span>;
age+=<span class="hljs-number">2</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">agePlus</span>(<span class="hljs-params">age: Age</span>){ 
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> age === <span class="hljs-string">'number'</span>){ 
        age+=<span class="hljs-number">2</span>;
    }
    <span class="hljs-keyword">return</span> age;
}
</code></pre>
<p>交叉类型常用合并对象类型，需要满足所有类型条件。<strong>如果无法满足所有类型条件，则该类型为<code>never</code></strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">User</span> = { 
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
}
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Address</span> = { 
    <span class="hljs-attr">address</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">UserAddress</span> = <span class="hljs-title class_">User</span> &amp; <span class="hljs-title class_">Address</span>;
</code></pre>
<h3 data-id="heading-11">泛型</h3>
<p>泛型是将类型参数化，可以不指定具体类型来定义函数、类、接口。在使用时在传入具体类型，它可以高度抽象定义类型，保障类型复用和类型安全。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 函数泛型</span>
<span class="hljs-keyword">function</span> getData&lt;T&gt;(<span class="hljs-attr">data</span>: T): T {
    <span class="hljs-keyword">return</span> data;
}

<span class="hljs-comment">// 接口泛型</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">IData</span>&lt;T&gt; {
    <span class="hljs-attr">data</span>: T;
}

<span class="hljs-comment">// 类泛型</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Data</span>&lt;T&gt; {
    <span class="hljs-attr">data</span>: T[] = [];
}
</code></pre>
<p>因为不知道具体类型，就无法获知这个类型有什么属性，可以调用什么方法。为了使用某个属性或者某个方法，我们使用泛型约束来指定这个类型必须有哪些属性或者方法。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> getData&lt;T <span class="hljs-keyword">extends</span> { <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> }&gt;(<span class="hljs-attr">data</span>: T): <span class="hljs-built_in">string</span> {
    <span class="hljs-keyword">return</span> data.<span class="hljs-property">name</span>;
}
</code></pre>
<p>在调用具有泛型的类型时，需要传递具体类型，有时候这个泛型我们知道在很多情况下就是某一个类型，避免重复传入，我们可以指定泛型的默认类型，从而在使用时不再需要传入。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">User</span> = { 
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">function</span> getData&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">User</span> = <span class="hljs-title class_">User</span>&gt;(<span class="hljs-attr">data</span>: T): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">return</span> data.<span class="hljs-property">name</span>;
}
</code></pre>
<p>泛型约束和默认类型不需要同时出现，也可以定义其一，根据需求使用。</p>
<h2 data-id="heading-12">类型运算</h2>
<p>除了定义具体类型，还可以通过类型运算从一个类型得到一个新的类型。也可以称之为推导，从一个类型推导为另一个类型。类型运算也是导致一些复杂类型产生的因素。</p>
<h3 data-id="heading-13">类型守卫</h3>
<p>类型守卫是在运行时判断数据类型，它可以精准到具体类型，用于类型收窄，包括<code>unknown</code>、联合类型、类继承。关键字包括<code>typeof</code> <code>instanceof</code> <code>in</code> <code>is</code></p>
<p><strong><code>typeof</code> 用于判断基础类型。但是无法判断 <code>null</code>，<code>typeof null</code> 返回 <code>'object'</code>，可通过<code>value!==null</code> 进行判断。</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">agePlus</span>(<span class="hljs-params">age: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span></span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> age === <span class="hljs-string">"number"</span>) {
    age += <span class="hljs-number">2</span>;
  }
  <span class="hljs-keyword">return</span> age;
}
</code></pre>
<p><strong><code>instanceof</code> 判断是否为某个类实例。</strong></p>
<pre><code class="hljs language-ts" lang="ts">
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {
  <span class="hljs-title class_">WangWang</span>() {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"WangWang"</span>;
  }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {
  <span class="hljs-title class_">MiaoMiao</span>() {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"MiaoMiao"</span>;
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">speak</span>(<span class="hljs-params">animal: Animal</span>) {
  <span class="hljs-keyword">if</span> (animal <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Dog</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${animal.name}</span>:<span class="hljs-subst">${animal.WangWang()}</span>`</span>;
  }
  <span class="hljs-keyword">if</span> (animal <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Cat</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${animal.name}</span>:<span class="hljs-subst">${animal.MiaoMiao()}</span>`</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${animal.name}</span>`</span>;
}
</code></pre>
<p><strong><code>in</code> 适用于对象类型定义，用于判断是否包含某个属性</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Dog</span> = {
  <span class="hljs-attr">a</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span>;
};
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  <span class="hljs-attr">d</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">c</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getAttr</span>(<span class="hljs-params">animal: Dog | Cat</span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-string">"b"</span> <span class="hljs-keyword">in</span> animal) {
    <span class="hljs-keyword">return</span> animal.<span class="hljs-property">a</span>;
  }

  <span class="hljs-keyword">if</span> (<span class="hljs-string">"d"</span> <span class="hljs-keyword">in</span> animal) {
    <span class="hljs-keyword">return</span> animal.<span class="hljs-property">c</span>;
  }

  <span class="hljs-keyword">return</span> <span class="hljs-string">"unknown"</span>;
}
</code></pre>
<p><strong><code>is</code> 用于精准明确是什么类型，但是判断逻辑是我们自己写的，这就要求我们判断逻辑要精确，否则可能导致运行时错误。</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Dog</span> = {
  <span class="hljs-attr">a</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span>;
};
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  <span class="hljs-attr">d</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">c</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-comment">// 内部逻辑自定义判断是否为某个类型</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isDog</span>(<span class="hljs-params">animal: Dog | Cat</span>): animal is <span class="hljs-title class_">Dog</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-string">"b"</span> <span class="hljs-keyword">in</span> animal;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">getAttr</span>(<span class="hljs-params">animal: Dog | Cat</span>) {
  <span class="hljs-comment">// 调用时如果为true，则推导为Dog</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isDog</span>(animal)) {
    <span class="hljs-keyword">return</span> animal.<span class="hljs-property">a</span>;
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">return</span> animal.<span class="hljs-property">c</span>;
  }
}
</code></pre>
<h3 data-id="heading-14">类型断言</h3>
<p>类型断言是将一个类型临时转为另一个类型，仅在编译阶段告诉TypeScript是什么类型，不能改变变量的实际类型。</p>
<p>类型断言需要开发者明确保证断言类型正确，否则可能会导致运行时异常。对于不确定的类型，因该优先使用<code>类型守卫</code>.</p>
<p><strong>使用<code>as</code>断言类型，可以转<code>unknown</code>类型、父类型转子类型场景。</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">let</span> <span class="hljs-attr">age</span>: <span class="hljs-built_in">unknown</span> = <span class="hljs-number">34</span>;
<span class="hljs-comment">// 可以断言类型为string，从而调用字符串的方法。</span>
<span class="hljs-comment">// 但是在运行时会报错</span>
(age <span class="hljs-keyword">as</span> <span class="hljs-built_in">string</span>).<span class="hljs-title function_">toUpperCase</span>();
</code></pre>
<p>还可以通过<code>as const</code>断言为只读常量，常用于固定值的类型约束。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 类型为 string</span>
<span class="hljs-keyword">const</span> name = <span class="hljs-string">"hboot"</span>;

<span class="hljs-comment">// 类型为字面量 "hboot" 类型</span>
<span class="hljs-keyword">const</span> name = <span class="hljs-string">"hboot"</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;
</code></pre>
<p><strong>使用<code>!</code>断言非空，常用于访问某个可选属性时，断言非空</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  d?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">c</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">let</span> <span class="hljs-attr">cat</span>: <span class="hljs-title class_">Cat</span> = {
  <span class="hljs-attr">c</span>: <span class="hljs-number">20</span>,
};
<span class="hljs-comment">// 未断言时调用报错属性 d 可能未定义</span>
<span class="hljs-comment">// cat.d.toUpperCase();</span>

<span class="hljs-comment">// 断言非空后则不会再提时报错，但是运行时报错 </span>
cat.<span class="hljs-property">d</span>!.<span class="hljs-title function_">toUpperCase</span>();
</code></pre>
<blockquote>
<p>所以，断言要谨慎使用、避免滥用，确保断言的类型是是实际数据类型的兼容类型。</p>
</blockquote>
<p><strong>还可以通过双层断言将一个明确的类型断言为另一个类型。</strong></p>
<p>这个操作很危险，实例中将<code>string</code>类型断言为<code>Cat</code>对象类型去访问属性<code>c</code>,编译通过，运行时爆炸。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  d?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">c</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">let</span> name = <span class="hljs-string">"hboot"</span>;

(name <span class="hljs-keyword">as</span> <span class="hljs-built_in">unknown</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">Cat</span>).<span class="hljs-property">c</span>;
</code></pre>
<h3 data-id="heading-15">运算符</h3>
<p>运算符可以从一个类型的到另一个类型。<code>类型安全</code>，类型运算的操作有很多</p>
<p><strong><code>keyof</code> 得到对象类型的所有字段<code>key</code>类型构成的联合类型。</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  d?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">c</span>: <span class="hljs-built_in">number</span>;
};
<span class="hljs-comment">// 得到 Cat 的所有字段 key 类型 联合类型 "d" | "c"</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Keys</span> = keyof <span class="hljs-title class_">Cat</span>;

<span class="hljs-comment">// 如果字段是索引签名，则返回索引签名的类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  [<span class="hljs-attr">x</span>: <span class="hljs-built_in">string</span>]: <span class="hljs-built_in">unknown</span>;
};
<span class="hljs-comment">// 得到的是索引签名类型 string</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Keys</span> = keyof <span class="hljs-title class_">Cat</span>;
</code></pre>
<p><strong><code>typeof</code> 之前再类型守卫里已经介绍过了，它可以返回变量的类型（基本类型）。</strong></p>
<p><strong>索引访问（IndexedAccessType）获取类型,比如我们要获取对象类型里某个字段的类型，就可以使用索引获取。</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  d?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">c</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-comment">// 获取字段类型为 string，但由于字段是可选 ？，</span>
<span class="hljs-comment">// 所以返回的是 string | undefined</span>
<span class="hljs-keyword">type</span> D = <span class="hljs-title class_">Cat</span>[<span class="hljs-string">"d"</span>];
</code></pre>
<p>也可以通过联合类型获取到多个字段的类型，结果为一个联合类型。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> D = <span class="hljs-title class_">Cat</span>[<span class="hljs-string">"d"</span>|<span class="hljs-string">"c"</span>]

<span class="hljs-comment">// 如果想要获取所有字段类型,可以通过keyof 获取到所有key的联合类型</span>
<span class="hljs-keyword">type</span> D = <span class="hljs-title class_">Cat</span>[keyof <span class="hljs-title class_">Cat</span>]
</code></pre>
<p>索引最重要的一点是可以对数组、元组元素的类型索引获取.</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> names = [<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>];
<span class="hljs-comment">// 索引第一个元素的类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Name</span> = names[<span class="hljs-number">0</span>];

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Names</span> = <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt;;
<span class="hljs-comment">// 索引数组元素的类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Name</span> = <span class="hljs-title class_">Names</span>[<span class="hljs-built_in">number</span>];
</code></pre>
<p>还可以搭配<code>typeof</code> 对变量的类型进行索引获取。</p>
<p><strong>条件类型（ConditionalType），通过输入的类型，决定输出类型</strong>，通过<code>extends</code>关键字和三元表达式来标识。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Name</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span> ? <span class="hljs-built_in">string</span> : <span class="hljs-built_in">number</span>;

<span class="hljs-comment">// 输入泛型参数返回类型，</span>
<span class="hljs-comment">// 输出类型为 string</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Admin</span> = <span class="hljs-title class_">Name</span>&lt;<span class="hljs-built_in">string</span>&gt;;
<span class="hljs-comment">// 输出类型为 number</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">User</span> = <span class="hljs-title class_">Name</span>&lt;<span class="hljs-built_in">unknown</span>&gt;;
</code></pre>
<p>也可以声明一个函数书写更复杂的判断逻辑。既然通过<code>extends</code>关键字以及泛型参数，那么也可以增加泛型约束、泛型默认值。</p>
<p><strong>映射类型（MappedType）,从一个类型创建一个新类型</strong>,建立在索引签名语法之上,通过对对象的字段键值、字段类型进行转换操作。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  name?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">type</span> <span class="hljs-title class_">ToFunction</span>&lt;T&gt; = {
  [K <span class="hljs-keyword">in</span> keyof T]: <span class="hljs-function">() =&gt;</span> T[K];
};

<span class="hljs-comment">// 从基本类型转换成函数类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">CatFunction</span> = <span class="hljs-title class_">ToFunction</span>&lt;<span class="hljs-title class_">Cat</span>&gt;;
<span class="hljs-comment">/**
 *  type CatFunction = {
 *    name?: (() =&gt; string | undefined) | undefined;
 *    age: () =&gt; number;
 *  }
 */</span>
</code></pre>
<p><strong>文本类型（LiteralType）</strong>，通过扩展字符串生成文本类型，表现同字符串字面值相同。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Name</span> = <span class="hljs-string">"hboot"</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">GoodName</span> = <span class="hljs-string">`Good, <span class="hljs-subst">${Name}</span>`</span>;
</code></pre>
<p>利用文本类型扩展，可以结合映射类型，改变键值，得到一个全新的类型。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ToFunction</span>&lt;T&gt; = {
  [K <span class="hljs-keyword">in</span> keyof T <span class="hljs-keyword">as</span> <span class="hljs-string">`on_<span class="hljs-subst">${<span class="hljs-built_in">string</span> &amp; K}</span>`</span>]: <span class="hljs-function">() =&gt;</span> T[K];
};

<span class="hljs-comment">// 就会得到不同键值、不同类型的新对象类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">CatFunction</span> = <span class="hljs-title class_">ToFunction</span>&lt;<span class="hljs-title class_">Cat</span>&gt;;
<span class="hljs-comment">/**
 *  type CatFunction = {
 *    on_name?: (() =&gt; string | undefined) | undefined;
 *    on_age: () =&gt; number;
 *  }
 */</span>
</code></pre>
<p><strong><code>infer</code> 类型推断</strong>，通常用于泛型参数推导；函数返回值类型推导</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Name</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Array</span>&lt;infer U&gt; ? U : T;

<span class="hljs-comment">// 条件类型推导 得到数组元素类型 string</span>
<span class="hljs-keyword">type</span> str = <span class="hljs-title class_">Name</span>&lt;<span class="hljs-built_in">string</span>[]&gt;;
<span class="hljs-comment">// 非数组类型，返回原类型 { name: string }</span>
<span class="hljs-keyword">type</span> info = <span class="hljs-title class_">Name</span>&lt;{ <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> }&gt;;
</code></pre>
<h3 data-id="heading-16">内置工具函数</h3>
<p>除了上述我们要手动去实现逻辑从而创建新的类型外，提供了内置函数可以直接使用，这些工具提供一些常用的类型转换逻辑。</p>
<p><strong><code>Partial&lt;T&gt;</code> 得到一个新类型，定义类型所有的字段都是可选的，与之相反的是<code>Required&lt;T&gt;</code></strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  name?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">type</span> <span class="hljs-title class_">NewCat</span> = <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">Cat</span>&gt;;
<span class="hljs-comment">/**
 * type NewCat = {
 *   name?: string;
 *   age?: number;
 * }
 */</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">RequiredCat</span> = <span class="hljs-title class_">Required</span>&lt;<span class="hljs-title class_">Cat</span>&gt;;
<span class="hljs-comment">/**
 * type RequiredCat = {
 *   name: string;
 *   age: number;
 * }
 */</span>
</code></pre>
<p><strong><code>Pick&lt;T,Keys&gt;</code> 从一个类型中选择某些字段得到一个新类型，<code>Omit&lt;T,Keys&gt;</code>从一个类型中删除某些字段得到一个新类型</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  name?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">type</span> <span class="hljs-title class_">NewCat</span> = <span class="hljs-title class_">Pick</span>&lt;<span class="hljs-title class_">Cat</span>, <span class="hljs-string">'name'</span>&gt;;
<span class="hljs-comment">/**
 * type NewCat = {
 *   name?: string;
 * }
 */</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">NewCat</span> = <span class="hljs-title class_">Omit</span>&lt;<span class="hljs-title class_">Cat</span>, <span class="hljs-string">'age'</span>&gt;;
<span class="hljs-comment">/**
 * type NewCat = {
 *   name?: string;
 * }
 */</span>
</code></pre>
<p><strong><code>Readonly&lt;T&gt;</code> 得到一个新类型，定义类型所有的字段都是只读的,初始化后不可以修改</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Cat</span> = {
  name?: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-keyword">type</span> <span class="hljs-title class_">ReadonlyCat</span> = <span class="hljs-title class_">Readonly</span>&lt;<span class="hljs-title class_">Cat</span>&gt;;

<span class="hljs-keyword">let</span> <span class="hljs-attr">cat</span>: <span class="hljs-title class_">ReadonlyCat</span> = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"hboot"</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
};

<span class="hljs-comment">// 报错，不可以修改再赋值，属性是只读的</span>
<span class="hljs-comment">// cat.age = 20;</span>
</code></pre>
<p>它没有与之相反定义的工具，怎么处理让所有只读属性都变为可编辑的呢？还记得上面讲过的<strong>映射类型</strong>吗？</p>
<p>在映射类型中通过使用<code>-</code>符号将所有字段的<code>readonly</code>修饰符都移除掉</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">MutableType</span>&lt;T&gt; = {
  -<span class="hljs-keyword">readonly</span> [K <span class="hljs-keyword">in</span> keyof T]: T[K];
};

<span class="hljs-keyword">let</span> <span class="hljs-attr">cat</span>: <span class="hljs-title class_">MutableType</span>&lt;<span class="hljs-title class_">ReadonlyCat</span>&gt; = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"hboot"</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">18</span>,
};

<span class="hljs-comment">// 通过映射类型 -readonly 移除掉属性的只读修饰符</span>
cat.<span class="hljs-property">age</span> = <span class="hljs-number">20</span>;
</code></pre>
<p><strong><code>Record&lt;Keys,T&gt;</code> 可以创建一个由<code>Keys</code>组成的属性对应类型为<code>T</code>的对象类型</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Animal</span> = <span class="hljs-title class_">Record</span>&lt;
  <span class="hljs-string">"dog"</span> | <span class="hljs-string">"cat"</span>,
  {
    <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
  }
&gt;;

<span class="hljs-comment">/**
 * type Animal = {
 *   dog: {
 *     name: string;
 *     age: number;
 *   };
 *   cat: {
 *     name: string;
 *     age: number;
 *  }; 
 * }
 */</span>
</code></pre>
<p><strong><code>Exclude&lt;U,T&gt;</code>从指定联合类型<code>U</code>排除某个满足 <code>T</code>类型的成员，得到新类型；与之相反的是<code>Extract&lt;U,T&gt;</code></strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Type</span> = <span class="hljs-title class_">Exclude</span>&lt;<span class="hljs-string">"name"</span> | <span class="hljs-string">"age"</span> | <span class="hljs-number">32</span>, <span class="hljs-built_in">number</span> | <span class="hljs-string">"name"</span>&gt;;

<span class="hljs-comment">/**
 * type Type = "age"
 */</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Type</span> = <span class="hljs-title class_">Extract</span>&lt;<span class="hljs-string">"name"</span> | <span class="hljs-string">"age"</span> | <span class="hljs-number">32</span>, <span class="hljs-built_in">number</span> | <span class="hljs-string">"name"</span>&gt;;
<span class="hljs-comment">/**
 * type Type = "name" | 32
 */</span>
</code></pre>
<p><strong><code>NonNullable&lt;Type&gt;</code>排除<code>null</code>和<code>undefined</code>的成员，得到新类型</strong></p>
<p><strong><code>Parameters&lt;Type&gt;</code> 从函数类型提取函数的参数类型，得到一个元组类型</strong>,非函数类型定义得到<code>never</code>类型。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Fun</span> = <span class="hljs-function">(<span class="hljs-params">name: <span class="hljs-built_in">string</span>, age: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Params</span> = <span class="hljs-title class_">Parameters</span>&lt;<span class="hljs-title class_">Fun</span>&gt;;
<span class="hljs-comment">/**
 * type Params = [name: string, age: number]
 */</span>
</code></pre>
<p><strong><code>ConstructorParameters&lt;Type&gt;</code> 从构造函数类型提取构造函数的参数类型，得到一个元组类型或数组类型</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">FunConstructorParams</span> = <span class="hljs-title class_">ConstructorParameters</span>&lt;<span class="hljs-title class_">FunctionConstructor</span>&gt;;
<span class="hljs-comment">/**
 * type FunConstructorParams = string[]
 */</span>

<span class="hljs-keyword">type</span> <span class="hljs-title class_">ErrorConstructorParams</span> = <span class="hljs-title class_">ConstructorParameters</span>&lt;<span class="hljs-title class_">ErrorConstructor</span>&gt;;
<span class="hljs-comment">/**
 * type ErrorConstructorParams =  [message?: string, options?: ErrorOptions]
 */</span>
</code></pre>
<p><strong><code>ReturnType&lt;Type&gt;</code> 从函数类型提取函数的返回值类型</strong>,对于非函数类型会得到<code>any</code>.</p>
<p><strong><code>Awaited</code> 用来获取异步函数的返回值类型</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Fun</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Promise</span>&lt;{ <span class="hljs-attr">data</span>: <span class="hljs-built_in">string</span> }&gt;;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">FunType</span> = <span class="hljs-title class_">Awaited</span>&lt;<span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-title class_">Fun</span>&gt;&gt;;
<span class="hljs-comment">/**
 * type FunType = {
 *   data: string;
 * }
 */</span>
</code></pre>
<p><strong><code>InstanceType&lt;Type&gt;</code> 从构造函数类型提取构造函数的实例类型</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Fun</span> = <span class="hljs-keyword">new</span> () =&gt; { <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> };

<span class="hljs-keyword">type</span> <span class="hljs-title class_">FunType</span> = <span class="hljs-title class_">InstanceType</span>&lt;<span class="hljs-title class_">Fun</span>&gt;;
<span class="hljs-comment">/**
 * type FunType = {
 *   name: string;
 * }
 */</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">AnimalType</span> = <span class="hljs-title class_">InstanceType</span>&lt;<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Animal</span>&gt;;
<span class="hljs-comment">/**
 * type AnimalType = Animal
 */</span>
</code></pre>
<p><strong><code>NoInfer&lt;T&gt;</code>阻止从该处推导泛型参数类型</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> compare&lt;T <span class="hljs-keyword">extends</span> <span class="hljs-built_in">string</span>&gt;(<span class="hljs-attr">a</span>: T[], b?: <span class="hljs-title class_">NoInfer</span>&lt;T&gt;) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a, b);
}

<span class="hljs-comment">// 锁定了泛型 T 类型是 "admin" | "test" , 所以传入参数 "hboot" 会提示报错</span>
<span class="hljs-comment">// 如果没有 NoInfer 则不会报错，推断类型 string</span>
<span class="hljs-title function_">compare</span>([<span class="hljs-string">"admin"</span>, <span class="hljs-string">"test"</span>], <span class="hljs-string">"hboot"</span>);

</code></pre>
<p><strong><code>ThisParameterType&lt;T&gt;</code> 提取函数类型中的<code>this</code>参数的类型</strong>，如果没有<code>this</code>参数则返回<code>unknown</code></p>
<p><strong><code>OmitThisParameter&lt;Type&gt;</code> 移除函数类型中的<code>this</code>参数，得到一个新的函数类型</strong>，如果没有<code>this</code>参数或不是函数类型则返回类型本身。</p>
<p><strong><code>ThisType&lt;Type&gt;</code> 用于指定方法上下文中的<code>this</code>类型，不会返回新类型</strong>,指定后在方法中就可以通过<code>this</code>访问到指定属性。但是需要开启<code>noImplicitThis</code>（tsconfig.json）标志才可以使用。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">Dog</span> = {
  <span class="hljs-title function_">speak</span>(): <span class="hljs-built_in">void</span>;
} &amp; <span class="hljs-title class_">ThisType</span>&lt;<span class="hljs-title class_">Animal</span>&gt;;

<span class="hljs-keyword">const</span> <span class="hljs-attr">dog</span>: <span class="hljs-title class_">Dog</span> = {
  <span class="hljs-title function_">speak</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 通过this 可以访问到 name 属性</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
  },
};
</code></pre>
<p><strong>文本类型工具，用于处理文本，包括:</strong></p>
<ul>
<li><code>Uppercase&lt;StringType&gt;</code>  将字符串转换为大写</li>
<li><code>Lowercase&lt;StringType&gt;</code> 将字符串转换为小写</li>
<li><code>Capitalize&lt;StringType&gt;</code> 将字符串的第一个字符转换为大写</li>
<li><code>Uncapitalize&lt;StringType&gt;</code> 将字符串的开头字符转换为小写</li>
</ul>
<h2 data-id="heading-17">命名空间</h2>
<p>通过关键字<code>namespace</code> 定义空间名，用于分组相关的类型和值，避免命名冲突。并可通过<code>export</code>导出供外部使用</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Hboot</span> {
  <span class="hljs-comment">//外部无法访问</span>
  <span class="hljs-keyword">const</span> name = <span class="hljs-string">"hboot"</span> <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>;

  <span class="hljs-comment">// 外部可以访问</span>
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getName</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> name;
  }
}

<span class="hljs-title class_">Hboot</span>.<span class="hljs-title function_">getName</span>();
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Netty（25）Netty的序列化和反序列化机制是什么？]]></title>    <link>https://juejin.cn/post/7586491717873156115</link>    <guid>https://juejin.cn/post/7586491717873156115</guid>    <pubDate>2025-12-22T12:00:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586491717873156115" data-draft-id="7586490798431535167" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Netty（25）Netty的序列化和反序列化机制是什么？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-22T12:00:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Netty（25）Netty的序列化和反序列化机制是什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T12:00:11.000Z" title="Mon Dec 22 2025 12:00:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Netty支持多种序列化和反序列化机制，包括Java原生的序列化机制、Google的Protocol Buffers、JSON、XML等。下面将详细介绍如何在Netty中实现序列化和反序列化，并结合代码示例进行说明。</p>
<h3 data-id="heading-0">Java原生序列化</h3>
<p>Java原生序列化机制可以使用 <code>ObjectEncoder</code> 和 <code>ObjectDecoder</code> 来实现。</p>
<h4 data-id="heading-1">示例：使用Java原生序列化机制</h4>
<ol>
<li><strong>定义一个可序列化的对象</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.io.Serializable;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyMessage</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;
    <span class="hljs-keyword">private</span> String content;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyMessage</span><span class="hljs-params">(String content)</span> {
        <span class="hljs-built_in">this</span>.content = content;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getContent</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> content;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setContent</span><span class="hljs-params">(String content)</span> {
        <span class="hljs-built_in">this</span>.content = content;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"MyMessage{"</span> +
                <span class="hljs-string">"content='"</span> + content + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">'}'</span>;
    }
}
</code></pre>
<ol start="2">
<li><strong>服务器端实现</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.bootstrap.ServerBootstrap;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelPipeline;
<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;
<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;
<span class="hljs-keyword">import</span> io.netty.handler.codec.serialization.ClassResolvers;
<span class="hljs-keyword">import</span> io.netty.handler.codec.serialization.ObjectDecoder;
<span class="hljs-keyword">import</span> io.netty.handler.codec.serialization.ObjectEncoder;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SerializationServer</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">bossGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(<span class="hljs-number">1</span>);
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">workerGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ServerBootstrap</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerBootstrap</span>();
            b.group(bossGroup, workerGroup)
             .channel(NioServerSocketChannel.class)
             .childHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {
                 <span class="hljs-meta">@Override</span>
                 <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception {
                     <span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> ch.pipeline();
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectEncoder</span>());
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectDecoder</span>(ClassResolvers.cacheDisabled(<span class="hljs-literal">null</span>)));
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SerializationServerHandler</span>());
                 }
             });

            b.bind(<span class="hljs-number">8080</span>).sync().channel().closeFuture().sync();
        } <span class="hljs-keyword">finally</span> {
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }
}

<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SerializationServerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SimpleChannelInboundHandler</span>&lt;MyMessage&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, MyMessage msg)</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"Server received: "</span> + msg);
        ctx.writeAndFlush(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyMessage</span>(<span class="hljs-string">"Hello from server!"</span>));
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> {
        cause.printStackTrace();
        ctx.close();
    }
}
</code></pre>
<ol start="3">
<li><strong>客户端实现</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.bootstrap.Bootstrap;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelPipeline;
<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;
<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;
<span class="hljs-keyword">import</span> io.netty.handler.codec.serialization.ClassResolvers;
<span class="hljs-keyword">import</span> io.netty.handler.codec.serialization.ObjectDecoder;
<span class="hljs-keyword">import</span> io.netty.handler.codec.serialization.ObjectEncoder;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SerializationClient</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Bootstrap</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bootstrap</span>();
            b.group(group)
             .channel(NioSocketChannel.class)
             .handler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {
                 <span class="hljs-meta">@Override</span>
                 <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception {
                     <span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> ch.pipeline();
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectEncoder</span>());
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectDecoder</span>(ClassResolvers.cacheDisabled(<span class="hljs-literal">null</span>)));
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SerializationClientHandler</span>());
                 }
             });

            b.connect(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">8080</span>).sync().channel().closeFuture().sync();
        } <span class="hljs-keyword">finally</span> {
            group.shutdownGracefully();
        }
    }
}

<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SerializationClientHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SimpleChannelInboundHandler</span>&lt;MyMessage&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelActive</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> {
        ctx.writeAndFlush(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyMessage</span>(<span class="hljs-string">"Hello from client!"</span>));
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, MyMessage msg)</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"Client received: "</span> + msg);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> {
        cause.printStackTrace();
        ctx.close();
    }
}
</code></pre>
<h3 data-id="heading-2">使用Protocol Buffers</h3>
<p>Protocol Buffers（Protobuf）是一种灵活、高效、自动化的序列化机制，适用于语言无关、平台无关的数据交换格式。以下是使用Protobuf的示例。</p>
<h4 data-id="heading-3">示例：使用Protobuf进行序列化和反序列化</h4>
<ol>
<li><strong>定义Protobuf消息</strong>：</li>
</ol>
<p>创建一个 <code>message.proto</code> 文件：</p>
<pre><code class="hljs language-protobuf" lang="protobuf">syntax = "proto3";

option java_package = "com.example.protobuf";
option java_outer_classname = "MessageProtos";

message MyMessage {
    string content = 1;
}
</code></pre>
<ol start="2">
<li><strong>生成Java类</strong>：</li>
</ol>
<p>使用 <code>protoc</code> 编译 <code>message.proto</code> 文件：</p>
<pre><code class="hljs language-sh" lang="sh">protoc --java_out=. message.proto
</code></pre>
<ol start="3">
<li><strong>服务器端实现</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.example.protobuf.MessageProtos.MyMessage;
<span class="hljs-keyword">import</span> io.netty.bootstrap.ServerBootstrap;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelPipeline;
<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;
<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;
<span class="hljs-keyword">import</span> io.netty.handler.codec.protobuf.ProtobufDecoder;
<span class="hljs-keyword">import</span> io.netty.handler.codec.protobuf.ProtobufEncoder;
<span class="hljs-keyword">import</span> io.netty.handler.codec.protobuf.ProtobufVarint32FrameDecoder;
<span class="hljs-keyword">import</span> io.netty.handler.codec.protobuf.ProtobufVarint32LengthFieldPrepender;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProtobufServer</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">bossGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(<span class="hljs-number">1</span>);
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">workerGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ServerBootstrap</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerBootstrap</span>();
            b.group(bossGroup, workerGroup)
             .channel(NioServerSocketChannel.class)
             .childHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {
                 <span class="hljs-meta">@Override</span>
                 <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception {
                     <span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> ch.pipeline();
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ProtobufVarint32FrameDecoder</span>());
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ProtobufDecoder</span>(MyMessage.getDefaultInstance()));
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ProtobufVarint32LengthFieldPrepender</span>());
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ProtobufEncoder</span>());
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ProtobufServerHandler</span>());
                 }
             });

            b.bind(<span class="hljs-number">8080</span>).sync().channel().closeFuture().sync();
        } <span class="hljs-keyword">finally</span> {
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }
}

<span class="hljs-keyword">import</span> com.example.protobuf.MessageProtos.MyMessage;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProtobufServerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SimpleChannelInboundHandler</span>&lt;MyMessage&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, MyMessage msg)</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"Server received: "</span> + msg.getContent());
        <span class="hljs-type">MyMessage</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> MyMessage.newBuilder().setContent(<span class="hljs-string">"Hello from server!"</span>).build();
        ctx.writeAndFlush(response);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> {
        cause.printStackTrace();
        ctx.close();
    }
}
</code></pre>
<ol start="4">
<li><strong>客户端实现</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.example.protobuf.MessageProtos.MyMessage;
<span class="hljs-keyword">import</span> io.netty.bootstrap.Bootstrap;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelPipeline;
<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;
<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;
<span class="hljs-keyword">import</span> io.netty.handler.codec.protobuf.ProtobufDecoder;
<span class="hljs-keyword">import</span> io.netty.handler.codec.protobuf.ProtobufEncoder;
<span class="hljs-keyword">import</span> io.netty.handler.codec.protobuf.ProtobufVarint32FrameDecoder;
<span class="hljs-keyword">import</span> io.netty.handler.codec.protobuf.ProtobufVarint32LengthFieldPrepender;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProtobufClient</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Bootstrap</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bootstrap</span>();
            b.group(group)
             .channel(NioSocketChannel.class)
             .handler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {
                 <span class="hljs-meta">@Override</span>
                 <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception {
                     <span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> ch.pipeline();
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ProtobufVarint32FrameDecoder</span>());
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ProtobufDecoder</span>(MyMessage.getDefaultInstance()));
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ProtobufVarint32LengthFieldPrepender</span>());
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ProtobufEncoder</span>());
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ProtobufClientHandler</span>());
                 }
             });

            b.connect(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">8080</span>).sync().channel().closeFuture().sync();
        } <span class="hljs-keyword">finally</span> {
            group.shutdownGracefully();
        }
    }
}

<span class="hljs-keyword">import</span> com.example.protobuf.MessageProtos.MyMessage;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProtobufClientHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SimpleChannelInboundHandler</span>&lt;MyMessage&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelActive</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> {
        <span class="hljs-type">MyMessage</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> MyMessage.newBuilder().setContent(<span class="hljs-string">"Hello from client!"</span>).build();
        ctx.writeAndFlush(message);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, MyMessage msg)</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"Client received: "</span> + msg.getContent());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> {
        cause.printStackTrace();
        ctx.close();
    }
}
</code></pre>
<h3 data-id="heading-4">使用JSON</h3>
<p>Netty也支持使用JSON进行序列化和反序列化。</p>
<h4 data-id="heading-5">示例：使用JSON进行序列化和反序列化</h4>
<ol>
<li><strong>添加依赖</strong>：</li>
</ol>
<p>在 <code>pom.xml</code> 中添加 Jackson 的依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.fasterxml.jackson.core<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jackson-databind<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.13.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<ol start="2">
<li><strong>定义消息对象</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyMessage</span> {
    <span class="hljs-keyword">private</span> String content;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyMessage</span><span class="hljs-params">()</span> {
    }

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">MyMessage</span><span class="hljs-params">(String content)</span> {
        <span class="hljs-built_in">this</span>.content = content;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getContent</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> content;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setContent</span><span class="hljs-params">(String content)</span> {
        <span class="hljs-built_in">this</span>.content = content;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">toString</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"MyMessage{"</span> +
                <span class="hljs-string">"content='"</span> + content + <span class="hljs-string">'\''</span> +
                <span class="hljs-string">'}'</span>;
    }
}
</code></pre>
<ol start="3">
<li><strong>自定义编解码器</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;
<span class="hljs-keyword">import</span> io.netty.buffer.ByteBuf;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.handler.codec.MessageToByteEncoder;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JsonEncoder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MessageToByteEncoder</span>&lt;Object&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">encode</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg, ByteBuf out)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">byte</span>[] bytes = objectMapper.writeValueAsBytes(msg);
        out.writeBytes(bytes);
    }
}

<span class="hljs-keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;
<span class="hljs-keyword">import</span> io.netty.buffer.ByteBuf;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.handler.codec.ByteToMessageDecoder;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JsonDecoder</span>&lt;T&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ByteToMessageDecoder</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ObjectMapper</span> <span class="hljs-variable">objectMapper</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectMapper</span>();
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;T&gt; clazz;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">JsonDecoder</span><span class="hljs-params">(Class&lt;T&gt; clazz)</span> {
        <span class="hljs-built_in">this</span>.clazz = clazz;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">decode</span><span class="hljs-params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[in.readableBytes()];
        in.readBytes(bytes);
        <span class="hljs-type">T</span> <span class="hljs-variable">obj</span> <span class="hljs-operator">=</span> objectMapper.readValue(bytes, clazz);
        out.add(obj);
    }
}
</code></pre>
<ol start="4">
<li><strong>服务器端实现</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.bootstrap.ServerBootstrap;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelPipeline;
<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;
<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JsonServer</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">bossGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>(<span class="hljs-number">1</span>);
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">workerGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ServerBootstrap</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerBootstrap</span>();
            b.group(bossGroup, workerGroup)
             .channel(NioServerSocketChannel.class)
             .childHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {
                 <span class="hljs-meta">@Override</span>
                 <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception {
                     <span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> ch.pipeline();
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JsonDecoder</span>&lt;&gt;(MyMessage.class));
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JsonEncoder</span>());
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JsonServerHandler</span>());
                 }
             });

            b.bind(<span class="hljs-number">8080</span>).sync().channel().closeFuture().sync();
        } <span class="hljs-keyword">finally</span> {
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }
}

<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JsonServerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SimpleChannelInboundHandler</span>&lt;MyMessage&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, MyMessage msg)</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"Server received: "</span> + msg);
        ctx.writeAndFlush(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyMessage</span>(<span class="hljs-string">"Hello from server!"</span>));
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> {
        cause.printStackTrace();
        ctx.close();
    }
}
</code></pre>
<ol start="5">
<li><strong>客户端实现</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.bootstrap.Bootstrap;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelPipeline;
<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;
<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JsonClient</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Bootstrap</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bootstrap</span>();
            b.group(group)
             .channel(NioSocketChannel.class)
             .handler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {
                 <span class="hljs-meta">@Override</span>
                 <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception {
                     <span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> ch.pipeline();
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JsonDecoder</span>&lt;&gt;(MyMessage.class));
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JsonEncoder</span>());
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">JsonClientHandler</span>());
                 }
             });

            b.connect(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">8080</span>).sync().channel().closeFuture().sync();
        } <span class="hljs-keyword">finally</span> {
            group.shutdownGracefully();
        }
    }
}

<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">JsonClientHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SimpleChannelInboundHandler</span>&lt;MyMessage&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelActive</span><span class="hljs-params">(ChannelHandlerContext ctx)</span> {
        ctx.writeAndFlush(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MyMessage</span>(<span class="hljs-string">"Hello from client!"</span>));
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, MyMessage msg)</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"Client received: "</span> + msg);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> {
        cause.printStackTrace();
        ctx.close();
    }
}
</code></pre>
<p>通过以上示例，您可以了解如何在Netty中使用Java原生序列化、Protocol Buffers和JSON进行序列化和反序列化。选择哪种方式取决于您的具体需求和环境。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Netty（26）如何实现基于Netty的RPC框架？]]></title>    <link>https://juejin.cn/post/7586479864271978502</link>    <guid>https://juejin.cn/post/7586479864271978502</guid>    <pubDate>2025-12-22T12:02:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586479864271978502" data-draft-id="7586540799250055222" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Netty（26）如何实现基于Netty的RPC框架？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-22T12:02:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Netty（26）如何实现基于Netty的RPC框架？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T12:02:21.000Z" title="Mon Dec 22 2025 12:02:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>基于Netty实现一个简单的RPC框架涉及到多个步骤，包括定义协议、序列化和反序列化、客户端和服务器的通信等。以下是一个详细的实现过程：</p>
<h3 data-id="heading-0">步骤概述</h3>
<ol>
<li><strong>定义RPC请求和响应的协议</strong></li>
<li><strong>实现序列化和反序列化机制</strong></li>
<li><strong>实现服务器端</strong></li>
<li><strong>实现客户端</strong></li>
<li><strong>实现服务代理和动态代理</strong></li>
</ol>
<h3 data-id="heading-1">1. 定义RPC请求和响应的协议</h3>
<p>使用Java对象来定义请求和响应：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.io.Serializable;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RpcRequest</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;
    <span class="hljs-keyword">private</span> String className;
    <span class="hljs-keyword">private</span> String methodName;
    <span class="hljs-keyword">private</span> Class&lt;?&gt;[] parameterTypes;
    <span class="hljs-keyword">private</span> Object[] parameters;

    <span class="hljs-comment">// Getters and setters</span>
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RpcResponse</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">long</span> <span class="hljs-variable">serialVersionUID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1L</span>;
    <span class="hljs-keyword">private</span> Object result;
    <span class="hljs-keyword">private</span> Throwable error;

    <span class="hljs-comment">// Getters and setters</span>
}
</code></pre>
<h3 data-id="heading-2">2. 实现序列化和反序列化机制</h3>
<p>使用Java原生的序列化机制：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.buffer.ByteBuf;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.handler.codec.MessageToByteEncoder;
<span class="hljs-keyword">import</span> io.netty.handler.codec.ByteToMessageDecoder;

<span class="hljs-keyword">import</span> java.io.*;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RpcEncoder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">MessageToByteEncoder</span>&lt;Object&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">encode</span><span class="hljs-params">(ChannelHandlerContext ctx, Object msg, ByteBuf out)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">ByteArrayOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayOutputStream</span>();
        <span class="hljs-type">ObjectOutputStream</span> <span class="hljs-variable">oos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(bos);
        oos.writeObject(msg);
        oos.flush();
        <span class="hljs-type">byte</span>[] bytes = bos.toByteArray();
        out.writeInt(bytes.length);
        out.writeBytes(bytes);
    }
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RpcDecoder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ByteToMessageDecoder</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;?&gt; genericClass;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RpcDecoder</span><span class="hljs-params">(Class&lt;?&gt; genericClass)</span> {
        <span class="hljs-built_in">this</span>.genericClass = genericClass;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">decode</span><span class="hljs-params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">if</span> (in.readableBytes() &lt; <span class="hljs-number">4</span>) {
            <span class="hljs-keyword">return</span>;
        }
        in.markReaderIndex();
        <span class="hljs-type">int</span> <span class="hljs-variable">dataLength</span> <span class="hljs-operator">=</span> in.readInt();
        <span class="hljs-keyword">if</span> (in.readableBytes() &lt; dataLength) {
            in.resetReaderIndex();
            <span class="hljs-keyword">return</span>;
        }
        <span class="hljs-type">byte</span>[] bytes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[dataLength];
        in.readBytes(bytes);
        <span class="hljs-type">ByteArrayInputStream</span> <span class="hljs-variable">bis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ByteArrayInputStream</span>(bytes);
        <span class="hljs-type">ObjectInputStream</span> <span class="hljs-variable">ois</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(bis);
        out.add(ois.readObject());
    }
}
</code></pre>
<h3 data-id="heading-3">3. 实现服务器端</h3>
<p>服务器端需要处理客户端的请求，调用相应的服务方法，并返回结果。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.bootstrap.ServerBootstrap;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelPipeline;
<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;
<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioServerSocketChannel;

<span class="hljs-keyword">import</span> java.lang.reflect.Method;
<span class="hljs-keyword">import</span> java.util.HashMap;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RpcServer</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; serviceMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">registerService</span><span class="hljs-params">(String interfaceName, Object service)</span> {
        serviceMap.put(interfaceName, service);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">(<span class="hljs-type">int</span> port)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">bossGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">workerGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">ServerBootstrap</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerBootstrap</span>();
            b.group(bossGroup, workerGroup)
             .channel(NioServerSocketChannel.class)
             .childHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {
                 <span class="hljs-meta">@Override</span>
                 <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception {
                     <span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> ch.pipeline();
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RpcDecoder</span>(RpcRequest.class));
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RpcEncoder</span>());
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RpcServerHandler</span>(serviceMap));
                 }
             });

            b.bind(port).sync().channel().closeFuture().sync();
        } <span class="hljs-keyword">finally</span> {
            bossGroup.shutdownGracefully();
            workerGroup.shutdownGracefully();
        }
    }
}

<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;

<span class="hljs-keyword">import</span> java.lang.reflect.Method;
<span class="hljs-keyword">import</span> java.util.Map;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RpcServerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SimpleChannelInboundHandler</span>&lt;RpcRequest&gt; {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Map&lt;String, Object&gt; serviceMap;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RpcServerHandler</span><span class="hljs-params">(Map&lt;String, Object&gt; serviceMap)</span> {
        <span class="hljs-built_in">this</span>.serviceMap = serviceMap;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, RpcRequest request)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">RpcResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RpcResponse</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Object</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> serviceMap.get(request.getClassName());
            <span class="hljs-keyword">if</span> (service == <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Service not found: "</span> + request.getClassName());
            }
            <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> service.getClass().getMethod(request.getMethodName(), request.getParameterTypes());
            <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> method.invoke(service, request.getParameters());
            response.setResult(result);
        } <span class="hljs-keyword">catch</span> (Throwable t) {
            response.setError(t);
        }
        ctx.writeAndFlush(response);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> {
        cause.printStackTrace();
        ctx.close();
    }
}
</code></pre>
<h3 data-id="heading-4">4. 实现客户端</h3>
<p>客户端需要发送RPC请求并接收响应。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> io.netty.bootstrap.Bootstrap;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelPipeline;
<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;
<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;

<span class="hljs-keyword">import</span> java.lang.reflect.Proxy;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RpcClient</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String host;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> port;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RpcClient</span><span class="hljs-params">(String host, <span class="hljs-type">int</span> port)</span> {
        <span class="hljs-built_in">this</span>.host = host;
        <span class="hljs-built_in">this</span>.port = port;
    }

    <span class="hljs-keyword">public</span> &lt;T&gt; T <span class="hljs-title function_">create</span><span class="hljs-params">(Class&lt;T&gt; serviceClass)</span> {
        <span class="hljs-keyword">return</span> (T) Proxy.newProxyInstance(serviceClass.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>&lt;?&gt;[]{serviceClass}, <span class="hljs-keyword">new</span> <span class="hljs-title class_">RpcClientProxy</span>(host, port, serviceClass));
    }
}

<span class="hljs-keyword">import</span> io.netty.channel.ChannelHandlerContext;
<span class="hljs-keyword">import</span> io.netty.channel.SimpleChannelInboundHandler;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RpcClientHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SimpleChannelInboundHandler</span>&lt;RpcResponse&gt; {
    <span class="hljs-keyword">private</span> RpcResponse response;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, RpcResponse response)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-built_in">this</span>.response = response;
    }

    <span class="hljs-keyword">public</span> RpcResponse <span class="hljs-title function_">getResponse</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> response;
    }
}
</code></pre>
<h3 data-id="heading-5">5. 实现服务代理和动态代理</h3>
<p>使用动态代理来简化客户端的调用逻辑。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.lang.reflect.InvocationHandler;
<span class="hljs-keyword">import</span> java.lang.reflect.Method;
<span class="hljs-keyword">import</span> java.util.concurrent.CountDownLatch;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-keyword">import</span> io.netty.bootstrap.Bootstrap;
<span class="hljs-keyword">import</span> io.netty.channel.Channel;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelInitializer;
<span class="hljs-keyword">import</span> io.netty.channel.ChannelPipeline;
<span class="hljs-keyword">import</span> io.netty.channel.EventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.nio.NioEventLoopGroup;
<span class="hljs-keyword">import</span> io.netty.channel.socket.SocketChannel;
<span class="hljs-keyword">import</span> io.netty.channel.socket.nio.NioSocketChannel;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RpcClientProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String host;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> port;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Class&lt;?&gt; serviceClass;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RpcClientProxy</span><span class="hljs-params">(String host, <span class="hljs-type">int</span> port, Class&lt;?&gt; serviceClass)</span> {
        <span class="hljs-built_in">this</span>.host = host;
        <span class="hljs-built_in">this</span>.port = port;
        <span class="hljs-built_in">this</span>.serviceClass = serviceClass;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-type">RpcRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RpcRequest</span>();
        request.setClassName(serviceClass.getName());
        request.setMethodName(method.getName());
        request.setParameterTypes(method.getParameterTypes());
        request.setParameters(args);

        <span class="hljs-type">RpcClientHandler</span> <span class="hljs-variable">handler</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RpcClientHandler</span>();
        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">group</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Bootstrap</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Bootstrap</span>();
            b.group(group)
             .channel(NioSocketChannel.class)
             .handler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt;() {
                 <span class="hljs-meta">@Override</span>
                 <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception {
                     <span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> ch.pipeline();
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RpcEncoder</span>());
                     p.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RpcDecoder</span>(RpcResponse.class));
                     p.addLast(handler);
                 }
             });

            <span class="hljs-type">Channel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> b.connect(host, port).sync().channel();
            channel.writeAndFlush(request).sync();

            <span class="hljs-type">CountDownLatch</span> <span class="hljs-variable">latch</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">CountDownLatch</span>(<span class="hljs-number">1</span>);
            handler.channelReadComplete(channel.pipeline().lastContext(), latch);
            latch.await(<span class="hljs-number">10</span>, TimeUnit.SECONDS);

            <span class="hljs-type">RpcResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> handler.getResponse();
            <span class="hljs-keyword">if</span> (response.getError() != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">throw</span> response.getError();
            }
            <span class="hljs-keyword">return</span> response.getResult();
        } <span class="hljs-keyword">finally</span> {
            group.shutdownGracefully();
        }
    }
}
</code></pre>
<h3 data-id="heading-6">使用示例</h3>
<ol>
<li><strong>定义服务接口和实现</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">HelloService</span> {
    String <span class="hljs-title function_">hello</span><span class="hljs-params">(String name)</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HelloService</span> {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">hello</span><span class="hljs-params">(String name)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello, "</span> + name;
    }
}
</code></pre>
<ol start="2">
<li><strong>启动服务器</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RpcServerMain</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">RpcServer</span> <span class="hljs-variable">server</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RpcServer</span>();
        server.registerService(HelloService.class.getName(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">HelloServiceImpl</span>());
        server.start(<span class="hljs-number">8080</span>);
    }
}
</code></pre>
<ol start="3">
<li><strong>客户端调用</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RpcClientMain</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">RpcClient</span> <span class="hljs-variable">client</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RpcClient</span>(<span class="hljs-string">"localhost"</span>, <span class="hljs-number">8080</span>);
        <span class="hljs-type">HelloService</span> <span class="hljs-variable">helloService</span> <span class="hljs-operator">=</span> client.create(HelloService.class);
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> helloService.hello(<span class="hljs-string">"World"</span>);
        System.out.println(result);
    }
}
</code></pre>
<p>通过以上步骤，您可以实现一个基于Netty的简单RPC框架。这个框架包括了基本的序列化和反序列化机制、客户端和服务器的通信、服务注册和调用等功能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从夯到拉，锐评 28 个后端技术！]]></title>    <link>https://juejin.cn/post/7586498198148661299</link>    <guid>https://juejin.cn/post/7586498198148661299</guid>    <pubDate>2025-12-22T10:09:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586498198148661299" data-draft-id="7586263211089133594" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从夯到拉，锐评 28 个后端技术！"/> <meta itemprop="keywords" content="后端,程序员,编程语言"/> <meta itemprop="datePublished" content="2025-12-22T10:09:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员鱼皮"/> <meta itemprop="url" content="https://juejin.cn/user/2444938365386621"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从夯到拉，锐评 28 个后端技术！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2444938365386621/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员鱼皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T10:09:09.000Z" title="Mon Dec 22 2025 10:09:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是程序员鱼皮。从夯到拉，锐评 28 个后端技术，一口气说完！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7a4722110f34164ae95d6ff4ead4148~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=ysvyLOmcAdvjgrSUfdhcm0%2FLsbY%3D" alt="" loading="lazy"/></p>
<p>正式开始前先郑重声明，每个后端技术都有自己的应用场景，很多时候没办法完全公平地去比较。本期鱼皮只是希望帮大家学到知识、认识更多的技术。而且由于我是个学 Java 的，也会带有一定的主观性，某些跟语言绑定的技术我会以 Java 生态作为例子。</p>
<p>大家也可以在评论区打出自己的评价，看看跟我想的是否一样。</p>
<p>⭐️ 本文对应视频版：<a href="https://link.juejin.cn?target=https%3A%2F%2Fbilibili.com%2Fvideo%2FBV1HiqQBgEoN" target="_blank" title="https://bilibili.com/video/BV1HiqQBgEoN" ref="nofollow noopener noreferrer">bilibili.com/video/BV1Hi…</a></p>
<h2 data-id="heading-0">评价维度</h2>
<p>接下来我将从 5 个维度来评价这些后端技术:</p>
<ol start="0">
<li>实用性：能解决多少实际问题</li>
<li>生态成熟度：包括社区活跃度、文档完善度、第三方库丰富度等</li>
<li>学习成本：上手难度和学习曲线</li>
<li>性能表现：比如吞吐量、响应速度、资源占用等</li>
<li>维护成本：后期迭代和排查问题的难度</li>
</ol>
<p>作为开发者，我个人最看重的是实用性和生态成熟度。毕竟技术是用来解决问题的，生态好意味着遇到问题能很快找到解决方案。</p>
<h2 data-id="heading-1">后端技术从夯到拉排行榜</h2>
<h4 data-id="heading-2">1、Spring 【顶级】</h4>
<p>上来就是重量级，这是 Java 后端开发的绝对霸主，企业级应用的基石。Spring 框架统治 Java 企业级开发十几年，IoC 容器和 AOP 编程思想深入人心，从 Web 开发、数据访问、批处理到安全认证，Spring 全家桶都能给你安排的明明白白。国内大厂标配，社区活跃度非常好，出了 Bug 很快就能找到解决方案。但缺点是传统的 Spring 配置比较繁琐，给到 <strong>顶级</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bd5b444fd72b4663b64a5bd784743a4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=FeAdXmsU21SaFDwwuu56GMX%2B5R8%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-3">第二个：Spring Boot 【夯】</h4>
<p>Spring 的亲儿子，Java 快速开发的不二之选。约定大于配置，能够轻松整合 Spring 全家桶，开箱即用。自动配置省心省力，内嵌服务器一键启动，几行代码就能跑起来一个 Web 应用。缺点是依赖太多，打包文件动辄上百 M，而且启动速度慢、内存占用高。不过现在有了 GraalVM 原生镜像技术，这些问题正在被改善，考虑到 Java 后端标配的江湖地位，必须给到 <strong>夯</strong>！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3e6e1c41f61043108f0ced2b9d616846~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=2TSWvj5LLbA3x0ONLWT2fKDZ%2FH0%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-4">3、EJB 【拉】</h4>
<p>全名 Enterprise JavaBeans，企业级 Java 的黑历史。当年 Sun 公司力推的重量级框架，配置复杂到离谱，开发效率低、性能还差。正是因为 EJB 太难用，才催生了 Spring 框架的诞生。现在已经被淘汰，毫无疑问给到 <strong>拉</strong>！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcf777a940424d12b121afaa76c4ea7f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=jByYKRz%2F8qRBGec7a%2BohqIS7jxQ%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-5">第四个：Docker 【夯】</h4>
<p>容器化技术的绝对王者，解决环境一致性问题的神器。Docker 把应用和环境打包在一起，开发环境和生产环境完全一致，再也不用听 “在我机器上能跑啊” 这种鬼话。它很轻量、秒级启动、资源占用少，是微服务架构的基石，也是 CI/CD 的好搭档。Docker 的学习曲线友好，文档齐全，社区活跃到爆炸。唯一的缺点可能就是 Windows 上体验稍差，但瑕不掩瑜，给到 <strong>夯</strong>！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/836fac7504804c6cbd851ef201718871~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=ErUU8mxcB0XXMyEOFZgXNjK2nrM%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-6">第五个：Kubernetes 【顶级】</h4>
<p>容器编排领域的霸主，云原生的核心技术。简称 K8s，是管理成百上千个 Docker 容器的神器。自动扩缩容、服务发现、负载均衡、滚动更新全都给你安排的明明白白，大厂标配。但学习难度较大，配置文件能把人绕晕，小项目没必要用它，适合大规模集群和复杂场景，给到 <strong>顶级</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f96cdd41de44f2fbad9768ec4c1a250~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=lr6LByQV25pZCVa0Ad%2F%2FXEJByB8%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-7">第六个：Redis 【夯】</h4>
<p>高性能键值存储数据库，缓存界的扛把子，快到飞起。它支持字符串、列表、哈希、集合、有序集合五大数据结构，常用于实现缓存、分布式锁、排行榜等。它的核心处理逻辑采用单线程，持久化方案成熟。唯一要注意的是内存成本和数据一致性问题，必须给到 <strong>夯</strong>！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/baee7bd25b434d6480710350527d328d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=ryuW0sZSvL8IZhmF1e7IyfbkCf8%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-8">第七个：Memcached 【NPC】</h4>
<p>缓存界的老前辈，简单的分布式内存缓存系统。它简单纯粹，就是个键值存储，性能也还不错。但是功能太单一，只支持字符串、没有持久化，没有主从复制、扩展性差。现在基本被 Redis 全面碾压，只有一些老项目还在用，给到 <strong>NPC</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8cab62bc7c1341fb88b87d5131385d3a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=fPugw0eZ3BCotRsPYCXcXvDBgm8%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-9">第八个：MySQL 【夯】</h4>
<p>关系型数据库的常青树，国内使用率最高的数据库。ACID 特性保证数据安全，事务支持完善，开源免费，中小企业首选。虽然复杂查询性能一般、功能扩展性不如 PostgreSQL，但凭借超高的普及度和成熟的生态，给到 <strong>夯</strong>！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/804556f014104eb8ba4f8475d8632992~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=0qzS7EvL6WgwFxzBaQbKpK6V6x4%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-10">9、PostgreSQL 【顶级】</h4>
<p>据说是功能最强大的开源数据库。支持 JSON、数组、地理信息、向量（通过插件实现）等复杂类型，扩展性极强，适合复杂查询和数据分析场景。性能和稳定性都不输 MySQL，甚至在某些场景更优秀，但是我这里只能给到 <strong>顶级</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e682700f39a496e8d8ae841b6b2babe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=cxa%2BLVVLn5tv%2BjWJ%2Bum5tBoSPWw%3D" alt="" loading="lazy"/></p>
<p>我知道有同学不服，从技术角度看，PostgreSQL 确实更胜一筹，但是目前国内生态不如 MySQL，遇到问题后解决的成本更高，学习难度也更大。虽然 AI 给 PostgreSQL 助力了，但再三考虑现在还是只能给到 <strong>顶级</strong>。</p>
<h4 data-id="heading-11">第十个：MongoDB 【人上人】</h4>
<p>NoSQL 文档数据库的代表，存储 JSON 格式数据，Schema 非常灵活，查询语言直观，容易上手，横向扩展也很容易，适合快速迭代的项目。但事务的处理能力上还是不如传统关系型数据库成熟，适合内容管理、日志存储等不需要强一致性的场景，给到 <strong>人上人</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4c637196cbb4ca79ee533795f2de111~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=Q%2Bh4yoQQll4MjLCLUll%2FNh%2FSP%2Bo%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-12">第十一个：Nginx 【夯】</h4>
<p>Web 服务器和反向代理的王者，高性能 HTTP 服务器。它的高并发处理能力强悍，占用资源少，性能吊打 Apache，使用场景也很多，负载均衡、静态资源服务、SSL 卸载样样在行。学习成本也不高，在我这给到 <strong>夯爆了</strong>！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1e8cd1b88c04e038b0604264b60f761~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=vYDGOZBVBkrT7KenXYZKGXjQk9Q%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-13">第十二个：RabbitMQ 【人上人】</h4>
<p>功能完善的经典消息队列。基于 AMQP 协议，支持多种消息模式，路由灵活；自带管理界面，监控方便。但性能不如 Kafka，吞吐量有限，适合中小规模的异步处理场景，给到 <strong>人上人</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77253be9e2774633a96bcfb1adb9eed6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=8ql03pzy4NWsVEJ6MPThcA3%2B0Cg%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-14">第十三个：Kafka 【顶级】</h4>
<p>那么下一个自然是消息队列的性能怪兽 Kafka，分布式流处理平台。吞吐量很大，百万级 TPS 轻松拿下，而且采用分布式架构，可靠性高，是日志收集 / 流式计算的标配、大数据场景的基础设施。不足之处是运维复杂，学习成本高，消息顺序性和重复消费需要仔细处理，给到 <strong>顶级</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c2640ae9ab3a417a9c381399188d3119~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=5a1uW4QMlTp3qyxv0OPGpaWRpOc%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-15">14、Elasticsearch 【夯】</h4>
<p>搜索引擎界的一哥，分布式搜索和分析引擎。基于 Lucene，全文搜索速度贼快；采用分布式架构，能应对 PB 级数据。除了搜索外，还能用来做日志分析、数据可视化，是 ELK 技术栈的核心。不足之处是资源占用较高，有一定的调优难度。但毕竟是搜索场景必备技术，给到 <strong>夯</strong>！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ff2feff1e72842908c56e23fb0abcbbe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=RCOGfeI0jdtmAw9Boo0mg6zyKSE%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-16">15、Git 【夯】</h4>
<p>版本控制的绝对霸主，分布式代码管理工具。它采用分布式架构，每个开发者本地都有完整的代码仓库，分支管理能力强大，合并冲突的处理机制完善。再加上 GitHub、GitLab 等平台的生态加持，已经成为开发者必备技能，不会 Git 基本就告别开发了，给到 <strong>夯爆了</strong>！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b77955d74fd34ebf938e7f02700f3efb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=FAueWhLFq71fMN5PEP6f%2B5j%2Fxkk%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-17">第十六个：SVN 【拉】</h4>
<p>上古时代的集中式版本管理系统。采用集中式架构，必须联网才能提交代码，分支管理能力弱，处理合并冲突比较麻烦。Git 出来之后被按在地上反复摩擦，现在还在用 SVN 的基本都是十年前的老项目。真的该淘汰了，给到 <strong>拉</strong>！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d595dee344345ef8be710f44d007c31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=PB9h2jLvrmK1kR5dFUgNcX3POe0%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-18">第十七个：gRPC 【顶级】</h4>
<p>Google 出品的高性能 RPC 框架，微服务间通信的利器。RPC 就是远程过程调用，让你调用远程服务就像调用本地方法一样简单。</p>
<p>gRPC 基于 HTTP/2 协议，性能强悍，使用 Protocol Buffers 序列化，使得体积小速度快，流式传输支持也很完善；而且还支持多种编程语言，是跨语言服务调用的首选，给到 <strong>顶级</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cddadb2064846058c9d9b9dae4f8f41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=V%2BEUBduLBNRCnTs%2F3hR5jldmbug%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-19">第十八个：Dubbo 【人上人】</h4>
<p>阿里开源的高性能 RPC 框架，国内微服务的老大哥。性能优秀，支持多种通信协议和负载均衡策略，服务治理功能也很完善。国内文档和案例还算丰富，但是国外用的少，给到 <strong>人上人</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/db28c49fa776443a97165504afde2706~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=dbqRDoH2cMT8Sc04w96cQVQ5mEo%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-20">19、Nacos 【人上人】</h4>
<p>阿里出品的服务发现和配置中心，微服务治理的新秀。它提供了友好的配置管理界面，支持多种服务注册模式，灵活性高，是 Spring Cloud Alibaba 的核心组件。但跟 Dubbo 一样，国际化程度不够，给到 <strong>人上人</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f75f78afb02249d4bfca81d8c2128def~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=36l6%2BYIFZlrEPuJEtdWo19rflSA%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-21">20、Zookeeper 【NPC】</h4>
<p>分布式协调服务的老前辈了，能够实现配置管理、服务发现、分布式锁。具有强一致性保证，数据可靠。但缺点是运维复杂，并且在大规模集群下写性能和选举恢复速度一般。随着 Kafka 转向 KRaft 架构以及 etcd 在云原生领域的霸权，ZK 正在慢慢退居二线，只能给到 <strong>NPC</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95a74905060e478d8e9c686d22d54c7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=piMBKCYy3lKu2OL1JPglj%2FpgVPc%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-22">21、etcd 【顶级】</h4>
<p>Go 语言编写的分布式键值存储，云原生时代的协调服务。它是 Kubernetes 的御用存储，基于 Raft 协议实现，有强一致性保证，性能比 Zookeeper 好。它的 API 简洁，同时支持 HTTP 和 gRPC 接口。缺点是国内生态一般，中文资料相对较少。但作为云原生场景首选，我相信它火起来只是时间问题，给到 <strong>顶级</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ab84f168a1247479e423c09c7e5fece~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=%2BS2iZGvmmrSeprC8lKgT%2FJZnsts%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-23">22、Prometheus 【人上人】</h4>
<p>开源的系统监控和告警工具集。采用 Pull 模式采集数据，配置灵活，提供 PromQL 查询语言，还可以和 Grafana 可视化工具完美搭档。但长期存储需要额外方案，而且告警规则配置有点繁琐，维护成本确实不低。考虑到监控的重要性和云原生的趋势，给到 <strong>人上人</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21ee8e1d7e4c4210929aeb62df664fc6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=eU3SEVtYX6JWNZcsrk%2Bsk%2BPpDLo%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-24">第二十三个：Jenkins 【人上人】</h4>
<p>CI/CD 的老大哥，持续集成的经典工具。流水线配置灵活，插件生态非常丰富，开源免费，社区活跃。但问题也很明显，界面老旧，用户体验一般；配置复杂，新手容易懵；而且资源占用较高。虽然 Jenkins 仍然是企业级 CI/CD 的主流选择，但很多开发者去拥抱 GitHub Actions、GitLab CI 这些体验更好的新工具了，给到 <strong>人上人</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b066e170bf4949348b376e01e3fbbf18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=UfmHc8dmC1JJFEAwZEgNXl30Q%2B8%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-25">第二十四个：GraphQL 【NPC】</h4>
<p>API 查询语言的新贵，灵活的数据获取方案。客户端可以按需获取数据，一个接口就能搞定所有查询，告别 RESTful 的接口爆炸问题，适合前端复杂的项目使用。</p>
<p>但学习成本高，在国内应用场景相对有限，大部分公司还是用 RESTful，给到 <strong>NPC</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/067a6ab01fbb4c579d55c0ed6a2b62e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=j21SPgifRF8%2BfPL7hXE6LtSNuOA%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-26">第二十五个：Swagger 【人上人】</h4>
<p>接口文档自动化工具。可以通过注解自动生成接口文档，还提供在线调试功能方便测试，支持多种编程语言，是前后端协作的神器。</p>
<p>但是相比数据库、缓存这些基础设施，Swagger 并不算刚需，现在用 AI 或者 Postman 也能搞定接口文档，给到 <strong>人上人</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/54516a2ade8242a1b2141e0c5836def6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=NFkmf7I5HCn60SzOwDk%2BwZ%2BnFRU%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-27">第二十六个：Tomcat 【NPC】</h4>
<p>经典的 Java Web 容器，曾经的王者，支持 Servlet 和 JSP 规范，配置灵活，文档完善。但现在 Spring Boot 内嵌服务器一键启动，谁还单独部署 Tomcat 啊？而且你敢信，甚至有同学都不知道 Tomcat！而且它的性能也不如 Undertow。时代变了，只能给到 <strong>NPC</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1acd2c7d35e344f79d5807c7f24f7036~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=NX%2BOx74Vb9zH017TCnfhPhYf8nc%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-28">27、Struts 【拉】</h4>
<p>Java Web 框架的老古董，MVC 框架的先驱。曾经风光一时，和 Spring、Hibernate 组成 SSH 三剑客。但架构老旧、漏洞频出、性能一般、学习成本高，现在应该没有新项目在用了吧？妥妥的 <strong>拉中拉</strong>！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad5c8eb9939842d082d510bc4aa4e811~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=rOUxm8vl1AtlQI5LCyd7ClId60U%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-29">28、JSP 【拉】</h4>
<p>Java 服务端页面技术，前后端混合开发的产物。把 Java 代码和 HTML 混在一起写，性能差、调试困难、代码混乱，维护起来简直是噩梦。</p>
<p>现在都前后端分离了，谁还用 JSP 啊？给到 <strong>拉</strong>！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/394d11d796eb47838df9ef2f1154c3b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=9YIiJpwMu6G86vLgs7Ad20urnW4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-30">最后</h2>
<p>最终排行如图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f558c44b8edc482ea3debe8cbcaa40a9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6bG855qu:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767002948&amp;x-signature=rCfiCevcX1pMxWAR9cf07ZkBf5g%3D" alt="" loading="lazy"/></p>
<p>OK 就分享到这里，如果你们还想看哪些技术的排名，或者你觉得哪个技术的排名不合理，都可以在评论区告诉我哦。我是鱼皮，关注我，带你解锁更多编程和 AI 知识~</p>
<h2 data-id="heading-31">更多</h2>
<p>💻 编程学习交流：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fcode-nav" target="_blank" title="https://github.com/liyupi/code-nav" ref="nofollow noopener noreferrer">编程导航</a> 📃 简历快速制作：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Flaoyujianli" target="_blank" title="https://github.com/liyupi/laoyujianli" ref="nofollow noopener noreferrer">老鱼简历</a> ✏️ 面试刷题神器：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fliyupi%2Fmianshiya" target="_blank" title="https://github.com/liyupi/mianshiya" ref="nofollow noopener noreferrer">面试鸭</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【翻译】adb screenrecord 帮助文档]]></title>    <link>https://juejin.cn/post/7586491717872877587</link>    <guid>https://juejin.cn/post/7586491717872877587</guid>    <pubDate>2025-12-22T10:13:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586491717872877587" data-draft-id="7586479864271667206" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【翻译】adb screenrecord 帮助文档"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-12-22T10:13:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="沐怡旸"/> <meta itemprop="url" content="https://juejin.cn/user/2875978146656750"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【翻译】adb screenrecord 帮助文档
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978146656750/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    沐怡旸
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T10:13:55.000Z" title="Mon Dec 22 2025 10:13:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>将设备屏幕录制为 .mp4 文件。</p>
</blockquote>
<pre><code class="hljs language-lua" lang="lua">选项：  
<span class="hljs-comment">--size 宽度x高度  </span>
设置视频尺寸，例如 <span class="hljs-string">"1280x720"</span>。默认使用设备主显示屏分辨率（若支持），否则使用 <span class="hljs-number">1280</span>x720。为获得最佳效果，请使用 AVC 编码器支持的尺寸。  
<span class="hljs-comment">--bit-rate 速率  </span>
设置视频比特率（单位：比特/秒）。数值可直接以比特或兆比特表示，例如 <span class="hljs-string">'4000000'</span> 等同于 <span class="hljs-string">'4M'</span>。默认值为 <span class="hljs-number">20</span>Mbps。  
<span class="hljs-comment">--bugreport  </span>
在录制的视频中添加额外信息（如时间戳叠加层），便于在提交故障报告时提供更详实的画面记录。  
<span class="hljs-comment">--time-limit 时长  </span>
设置最大录制时长（单位：秒）。默认值为 <span class="hljs-number">180</span>。设置为 <span class="hljs-number">0</span> 可取消时长限制。  
<span class="hljs-comment">--display-id 编号  </span>
指定要录制的物理显示屏编号。默认为主显示屏。可通过 <span class="hljs-string">"dumpsys SurfaceFlinger --display-id"</span> 查看有效的显示屏编号。  
<span class="hljs-comment">--poweron 编号  </span>
开启指定物理显示屏后退出，不进行录制。  
可通过 <span class="hljs-string">"dumpsys SurfaceFlinger --display-id"</span> 查看有效的显示屏编号。  
<span class="hljs-comment">--poweroff 编号  </span>
关闭指定物理显示屏后退出，不进行录制。  
可通过 <span class="hljs-string">"dumpsys SurfaceFlinger --display-id"</span> 查看有效的显示屏编号。  
<span class="hljs-comment">--verbose  </span>
在标准输出中显示详细运行信息。  
<span class="hljs-comment">--help  </span>
显示本帮助信息。
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Nuxt 3 项目自动化部署到宝塔服务器全攻略 (GitHub Actions + rsync)]]></title>    <link>https://juejin.cn/post/7586338196302037038</link>    <guid>https://juejin.cn/post/7586338196302037038</guid>    <pubDate>2025-12-22T10:19:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586338196302037038" data-draft-id="7586482860103696411" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Nuxt 3 项目自动化部署到宝塔服务器全攻略 (GitHub Actions + rsync)"/> <meta itemprop="keywords" content="自动化运维"/> <meta itemprop="datePublished" content="2025-12-22T10:19:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="知航驿站"/> <meta itemprop="url" content="https://juejin.cn/user/4125023356335576"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Nuxt 3 项目自动化部署到宝塔服务器全攻略 (GitHub Actions + rsync)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4125023356335576/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    知航驿站
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T10:19:16.000Z" title="Mon Dec 22 2025 10:19:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本指南详细介绍了如何利用 GitHub Actions 持续集成工具，将 Nuxt 3 项目（静态生成 SSG 模式）自动化部署到宝塔面板服务器。</p>
<ul>
<li><strong>🚀 演示地址</strong>: <a href="https://link.juejin.cn?target=http%3A%2F%2Fnuxt.haiwb.com%2F" target="_blank" title="http://nuxt.haiwb.com/" ref="nofollow noopener noreferrer">nuxt.haiwb.com/</a></li>
<li><strong>📖 项目文档</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fhangjob.github.io%2Fnuxt-web-plugin%2F" target="_blank" title="https://hangjob.github.io/nuxt-web-plugin/" ref="nofollow noopener noreferrer">hangjob.github.io/nuxt-web-pl…</a></li>
</ul>
<hr/>
<h2 data-id="heading-0">插件介绍</h2>
<p><code>nuxt-web-plugin</code> 是一款面向 <strong>Nuxt 3/4</strong> 的全能增强插件，旨在提升开发体验（DX）并为应用提供坚实的基础能力。</p>
<h3 data-id="heading-1">核心特性：</h3>
<ul>
<li><strong>🔐 深度安全防护</strong>: 集成 AES-GCM 对称加密、RSA 非对称加密及 SHA-256 哈希算法，支持加密存储（Storage/Cookie）。</li>
<li><strong>🛰️ 智能请求封装</strong>: 基于 <code>$fetch</code> 的统一网络层，内置 <strong>自动去重 (Dedupe)</strong>、<strong>短时缓存 (Cache)</strong> 和 <strong>并发锁 (Lock)</strong>，有效防止重复请求。</li>
<li><strong>🖼️ 页面水印系统</strong>: 动态 Canvas 水印，支持防篡改监测（Anti-Tamper），保护页面内容版权。</li>
<li><strong>🔍 SEO &amp; 设备检测</strong>: 自动元标签生成与移动端/平板/桌面端精准识别。</li>
<li><strong>🎨 玻璃拟态布局</strong>: 内置一套现代化的插件控制台模板，完美支持 Tailwind 暗色模式。</li>
</ul>
<hr/>
<h2 data-id="heading-2">一、 准备工作</h2>
<h3 data-id="heading-3">1.1 服务器环境</h3>
<ul>
<li>确保服务器已安装 <strong>宝塔面板</strong>。</li>
<li>在宝塔面板中创建一个 <strong>静态网站</strong>（或 PHP 网站，但我们只需其静态能力）。</li>
<li>记住你的网站根目录，例如：<code>/www/wwwroot/nuxt.haiwb.com</code>。</li>
</ul>
<h3 data-id="heading-4">1.2 生成 SSH 密钥对</h3>
<p>在你的本地终端或服务器执行以下命令（建议在服务器执行）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 生成密钥对 (ed25519 算法更安全且简短)</span>
ssh-keygen -t ed25519 -C <span class="hljs-string">"github-actions-deploy"</span>
</code></pre>
<ol>
<li><strong>公钥 (<code>.pub</code>)</strong>: 将内容复制并添加到服务器的 <code>~/.ssh/authorized_keys</code> 文件中。</li>
<li><strong>私钥</strong>: 将内容完整复制，下一步使用。</li>
</ol>
<hr/>
<h2 data-id="heading-5">二、 GitHub 仓库配置</h2>
<p>进入你的 GitHub 项目仓库，点击 <code>Settings -&gt; Secrets and variables -&gt; Actions</code>，点击 <code>New repository secret</code> 添加以下变量：</p>






























<table><thead><tr><th align="left">变量名</th><th align="left">说明</th><th align="left">示例值</th></tr></thead><tbody><tr><td align="left"><code>SERVER_SSH_KEY</code></td><td align="left">刚才生成的 <strong>私钥</strong> 内容</td><td align="left"><code>-----BEGIN OPENSSH PRIVATE KEY----- ...</code></td></tr><tr><td align="left"><code>SERVER_HOST</code></td><td align="left">服务器公网 IP 或域名</td><td align="left"><code>1.2.3.4</code> 或 <code>nuxt.haiwb.com</code></td></tr><tr><td align="left"><code>SERVER_USER</code></td><td align="left">SSH 登录名</td><td align="left"><code>root</code> (建议使用有权限的普通用户)</td></tr><tr><td align="left"><code>SERVER_TARGET</code></td><td align="left">宝塔面板中的网站根目录</td><td align="left"><code>/www/wwwroot/nuxt.haiwb.com</code></td></tr></tbody></table>
<hr/>
<h2 data-id="heading-6">三、 编写工作流文件</h2>
<p>在项目根目录创建 <code>.github/workflows/deploy-playground.yml</code> 文件：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">Playground</span> <span class="hljs-string">to</span> <span class="hljs-string">Baota</span>

<span class="hljs-attr">on:</span>
  <span class="hljs-attr">push:</span>
    <span class="hljs-attr">branches:</span> [<span class="hljs-string">main</span>] <span class="hljs-comment"># 仅在代码推送到 main 分支时触发</span>
  <span class="hljs-attr">workflow_dispatch:</span>  <span class="hljs-comment"># 支持在 GitHub Actions 页面手动点击运行</span>

<span class="hljs-attr">jobs:</span>
  <span class="hljs-attr">deploy-to-baota:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">Upload</span> <span class="hljs-string">to</span> <span class="hljs-string">Server</span>
    <span class="hljs-attr">runs-on:</span> <span class="hljs-string">ubuntu-latest</span>

    <span class="hljs-attr">steps:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Checkout</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/checkout@v4</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">pnpm</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">pnpm/action-setup@v4</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">version:</span> <span class="hljs-number">9</span>
          <span class="hljs-attr">run_install:</span> <span class="hljs-literal">false</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Setup</span> <span class="hljs-string">Node</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">actions/setup-node@v4</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-attr">node-version:</span> <span class="hljs-number">24</span> <span class="hljs-comment"># 关键：Node 版本需匹配项目要求 (v24.4.1+)</span>
          <span class="hljs-attr">cache:</span> <span class="hljs-string">'pnpm'</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Install</span> <span class="hljs-string">Dependencies</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">pnpm</span> <span class="hljs-string">install</span> <span class="hljs-string">--no-frozen-lockfile</span>

      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Build</span> <span class="hljs-string">Playground</span> <span class="hljs-string">(Static)</span>
        <span class="hljs-attr">run:</span> <span class="hljs-string">|
          # 准备模块环境
          pnpm run dev:prepare
          cd playground
          # 生成静态文件 (SSG)
          npx nuxi generate 
          echo "Build Output Check:"
          ls -R .output/public/ # 打印构建结果，方便排查路径问题
</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">Deploy</span> <span class="hljs-string">to</span> <span class="hljs-string">Server</span>
        <span class="hljs-attr">uses:</span> <span class="hljs-string">easingthemes/ssh-deploy@main</span>
        <span class="hljs-attr">with:</span>
          <span class="hljs-comment"># SSH 私钥</span>
          <span class="hljs-attr">SSH_PRIVATE_KEY:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SERVER_SSH_KEY</span> <span class="hljs-string">}}</span>
          <span class="hljs-comment"># 远程主机信息</span>
          <span class="hljs-attr">REMOTE_HOST:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SERVER_HOST</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">REMOTE_USER:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SERVER_USER</span> <span class="hljs-string">}}</span>
          <span class="hljs-attr">TARGET:</span> <span class="hljs-string">${{</span> <span class="hljs-string">secrets.SERVER_TARGET</span> <span class="hljs-string">}}</span>
          <span class="hljs-comment"># 部署源目录 (Nuxt 3 SSG 产物路径)</span>
          <span class="hljs-attr">SOURCE:</span> <span class="hljs-string">"playground/.output/public/"</span>
          <span class="hljs-comment"># rsync 参数: r(递归), l(链接), g(组), o(所有者), D(设备), z(压缩), v(详细), c(校验), --delete(删除多余文件)</span>
          <span class="hljs-attr">ARGS:</span> <span class="hljs-string">"-rlgoDzvc -i --delete"</span>
          <span class="hljs-comment"># 关键排坑：排除服务器系统锁定的文件，否则会报 Operation not permitted (rsync code 23)</span>
          <span class="hljs-attr">EXCLUDE:</span> <span class="hljs-string">"/.user.ini, /.htaccess, /.well-known/, /cgi-bin/"</span>
</code></pre>
<hr/>
<h2 data-id="heading-7">四、 核心避坑指南 (Troubleshooting)</h2>
<h3 data-id="heading-8">4.1 Node 引擎版本报错</h3>
<p><strong>错误信息</strong>: <code>Unsupported engine: wanted: {"node":"&gt;=24.4.1"}</code>
<strong>原因</strong>: 项目 <code>package.json</code> 限制了高版本 Node，而 GitHub Actions 默认环境较低。
<strong>对策</strong>: 在 <code>actions/setup-node</code> 步骤中明确指定 <code>node-version: 24</code>。</p>
<h3 data-id="heading-9">4.2 预渲染死链报错</h3>
<p><strong>错误信息</strong>: <code>Exiting due to prerender errors</code>
<strong>原因</strong>: Nuxt 3 在 <code>generate</code> 过程中会检查所有链接，如果发现指向 <code>/docs</code> 等不存在的内部路径会报错。
<strong>对策</strong>:</p>
<ol>
<li>在 <code>nuxt.config.ts</code> 中配置 <code>nitro: { prerender: { failOnError: false } }</code>。</li>
<li>将外部链接或独立部署的链接改为绝对路径（如 <code>https://...</code>）。</li>
</ol>
<h3 data-id="heading-10">4.3 rsync exited with code 23</h3>
<p><strong>错误信息</strong>: <code>unlink(.user.ini) failed: Operation not permitted (1)</code>
<strong>原因</strong>: 宝塔面板会自动在网站目录创建 <code>.user.ini</code> 并锁定（<code>i</code> 权限）。<code>rsync</code> 尝试删除该文件以便同步时会被拦截。
<strong>对策</strong>: 在部署脚本中使用 <code>EXCLUDE</code> 配置将其排除掉。</p>
<hr/>
<h2 data-id="heading-11">五、 Nginx 伪静态设置 (非常重要)</h2>
<p>为了让 Nuxt 的客户端路由正常工作，请在宝塔面板的网站设置 -&gt; <strong>伪静态</strong> 中添加以下内容：</p>
<pre><code class="hljs language-nginx" lang="nginx">location / {
  # 优先寻找文件和目录，找不到则 fallback 到 index.html 让 Vue 处理路由
  try_files $uri $uri/ /index.html;
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[# Hologres Dynamic Table：高效增量刷新，构建实时统一数仓的核心利器]]></title>    <link>https://juejin.cn/post/7586493936677257256</link>    <guid>https://juejin.cn/post/7586493936677257256</guid>    <pubDate>2025-12-22T10:24:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586493936677257256" data-draft-id="7586493936676929576" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="# Hologres Dynamic Table：高效增量刷新，构建实时统一数仓的核心利器"/> <meta itemprop="keywords" content="数据分析,人工智能"/> <meta itemprop="datePublished" content="2025-12-22T10:24:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            # Hologres Dynamic Table：高效增量刷新，构建实时统一数仓的核心利器
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T10:24:42.000Z" title="Mon Dec 22 2025 10:24:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在企业数据架构逐步走向实时化与一体化的过程中，如何高效处理“大量历史 + 少量新增”的业务数据，已成为建设统一数仓与实时数仓时绕不开的关键挑战。</p>
<p>传统全量刷新方式在面对亿级历史数据时，往往面临刷新延迟高、计算成本大、链路复杂等问题。为了解决这些痛点，业界逐渐形成了一种新的数据处理范式——Dynamic Table（动态表），它通过声明式语法自动维护物化结果，并支持高效的增量刷新能力。</p>
<p>阿里云 Hologres 作为高性能实时数仓引擎，原生提供了 Dynamic Table，并基于有状态增量计算模型，在多表关联、聚合等复杂场景下展现出显著性能优势。本文将深入解析 Hologres Dynamic Table 的技术原理与实践价值。</p>
<h2 data-id="heading-0"><strong>为什么需要增量刷新能力？</strong></h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a7cbfe82f53407f8b20fd0266ebe284~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767003882&amp;x-signature=g0JORnr3f8EAYl1mmUoq%2BhXDHsU%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-1">典型业务场景</h3>
<p>在电商、互联网、金融等行业，以下场景极为常见：</p>
<p><strong>实时运营分析</strong></p>
<ul>
<li>
<p>订单、支付、退款等多源数据，按用户、商品、活动等维度进行关联与聚合，形成实时运营看板；</p>
</li>
<li>
<p>运营与业务团队希望以分钟级、甚至更高频率刷新核心指标。</p>
</li>
</ul>
<p><strong>用户与商品特征构建</strong></p>
<ul>
<li>
<p>将用户信息、行为数据、订单数据、商品信息、支付信息等多张表进行 Join，生成统一的特征宽表；</p>
</li>
<li>
<p>这些宽表通常是推荐、风控、画像等应用的输入，需要稳定、快速地更新。</p>
</li>
</ul>
<p><strong>资金与交易监控</strong></p>
<ul>
<li>交易流水、账户信息、风控结果等数据源不断产生新的记录；需要以较短的刷新间隔计算聚合指标或风控特征。</li>
</ul>
<p>这些场景的共同特点是：</p>
<blockquote>
<p><strong>历史数据规模庞大（亿级），但每次新增或变更的数据量很小（通常 &lt;1%）。</strong></p>
</blockquote>
<h3 data-id="heading-2">传统数据加工的局限</h3>
<p>在缺少增量引擎的情况下，常见做法是：</p>
<ul>
<li>
<p>使用一条或多条 SQL 定义目标宽表或汇总表；</p>
</li>
<li>
<p>定时执行全量计算（如 INSERT OVERWRITE、CTAS），每次从基表完整扫描数据、执行多表 Join、再进行聚合；</p>
</li>
<li>
<p>通过调度系统编排上游任务和下游任务之间的依赖。</p>
</li>
</ul>
<p>这种模式存在若干明显不足：</p>
<ul>
<li>
<p><strong>刷新时延受限：</strong> 数据规模增大后，每次全量扫描和计算耗时较长。当业务希望从“每小时刷新”提升到“每 5 分钟刷新”时，往往需要成倍增加计算资源，也可能遇到物理资源上限。</p>
</li>
<li>
<p><strong>计算成本较高</strong>：即使每次只有 1% 左右的数据发生变化，全量模式仍需对 100% 数据进行扫描和计算，CPU、IO 和网络资源利用效率不高。</p>
</li>
<li>
<p><strong>链路复杂，维护成本高</strong>：为降低单任务压力，工程实践中常将复杂逻辑拆解为多层中间表，形成较长的任务链路。链路越长，依赖越多，维护难度和变更风险也随之上升。</p>
</li>
</ul>
<p>因此，在“历史数据量大、实时数据实时产生”的场景下，引入真正高效的增量刷新机制，是提升数据时效与降低资源利用率的关键。</p>
<h2 data-id="heading-3">二、什么是 Dynamic Table？Hologres 的增量刷新如何工作？</h2>
<p>Dynamic Table是当前一种主流的声明式数据处理架构，该架构可以自动处理并存储一个或者多个基表（Base Table）对象的数据关联、聚合结果，内置不同的数据刷新策略，业务可以根据需求设置不同的数据刷新策略，实现数据从基表对象到Dynamic Table的自动流转，满足业务统一开发、数据自动流转、处理时效性等诉求。</p>
<p>增量（incremental）、全量（full）是Dynamic Table的两种不同刷新方式，底层实现原理具有显著的差异：</p>
<ul>
<li>
<p><strong>全量刷新</strong>是指每次执行刷新时，都以全量的方式进行数据处理，并将基表的关联、聚合结果物化写入Dynamic Table，其技术原理类似于INSERT OVERWRITE。</p>
</li>
<li>
<p><strong>增量刷新</strong>模式下，每次刷新时只会读取基表中<strong>新增</strong>的数据，根据中间聚合状态和增量数据计算最终结果并更新到Dynamic Table中。相比全量刷新，增量刷新每次处理的数据量更少，效率更高，从而可以非常有效地提升刷新任务的时效性，同时降低计算资源的使用。</p>
</li>
</ul>
<p>增量Dynamic Table的计算遵循如下计算模式：</p>
<ol>
<li>
<p><strong>增全量刷新</strong>阶段：Dynamic Table的第一次刷新会把已有的所有历史数据都进行计算，即相当于把所有历史数据都当作增量来进行计算。这一阶段一般耗时比较长。</p>
</li>
<li>
<p><strong>增量刷新</strong>阶段：在增全量刷新完成后，以后的每次Dynamic Table刷新仅针对增量数据进行计算。理论上这些刷新应该耗时较短。</p>
</li>
</ol>
<p>在增量 Dynamic Table 的实现上，业界存在不同的技术路径。一种常见的做法是采用<strong>无状态增量计算模型</strong>：每次刷新时，系统仅基于源表的变更数据，重新推导整个查询逻辑，而不持久化任何中间计算状态。这种方式虽然节省存储，但在面对复杂查询（如多表关联、去重聚合等）时，往往需要反复扫描大量历史数据，导致刷新效率低下，甚至在某些场景下增量计算的开销反而超过全量。</p>
<p>相比之下，Hologres 采用了<strong>有状态增量计算模型</strong>：在首次全量构建 Dynamic Table 时，同步生成并持久化关键的中间状态（例如聚合结果、多表 Join 的中间产物等）。后续的增量刷新只需将新增或变更的数据与这些状态表进行高效合并，无需重复处理历史数据。这种设计以有限且可控的额外存储开销为代价，<strong>显著提升了复杂场景下的刷新性能和资源利用率，尤其适合“海量历史 + 少量增量”的典型业务负载</strong>。
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef1ce8162c9e419db58577aea438cd07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767003882&amp;x-signature=iMIWUaQcY%2FyfIMzl89kBGuaAgsc%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">三、Hologres 增量刷新的实战优势</h2>
<p>我们通过三个典型场景验证 Hologres 的性能表现（测试环境：Hologres 15CU Serverless，竞品采用相似规格）。</p>
<p>对于增量数据，本实验模拟两种场景：</p>
<ol>
<li>
<p>Append only：即源表的增量数据只有新增（Insert），没有修改（update和delete）。这在日志、埋点数据表中非常常见。</p>
</li>
<li>
<p>Retraction（回撤）：源表的增量数据包含Insert、Update和Delete的数据。这适用于数据库类的表。</p>
</li>
</ol>
<p>对于Append only的源表，很多增量计算算子都可以大幅简化，状态表也可以大幅缩小。所以在性能环节，可以看到Append only源表的增量计算性能会更好。</p>
<h3 data-id="heading-5">场景 1：单表聚合（COUNT DISTINCT + SUM）</h3>
<p>该场景使用的工作负载如下所示：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b309221d209d479a82768c426585c34f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767003882&amp;x-signature=FDKjWtjkry3tzaxSgdZHcESKBCM%3D" alt="image.png" loading="lazy"/></p>
<p>Hologres建表SQL如下：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DYNAMIC</span> <span class="hljs-keyword">TABLE</span> DT_ORDER_DETAIL_AGG <span class="hljs-keyword">with</span> (
    auto_refresh_mode <span class="hljs-operator">=</span> <span class="hljs-string">'incremental'</span>, 
    auto_refresh_enable <span class="hljs-operator">=</span> <span class="hljs-string">'false'</span>, 
    freshness <span class="hljs-operator">=</span> <span class="hljs-string">'1 minutes'</span>
)<span class="hljs-keyword">AS</span> 
<span class="hljs-keyword">SELECT</span>
  PRODUCT_ID,
  <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> USER_ID) <span class="hljs-keyword">AS</span> UV,
  <span class="hljs-built_in">SUM</span>(LINE_AMOUNT) <span class="hljs-keyword">AS</span> SUM_LINE_AMOUNT,
  <span class="hljs-built_in">MAX</span>(QUANTITY) <span class="hljs-keyword">AS</span> MAX_QUANTITY
<span class="hljs-keyword">FROM</span> ORDER_DETAIL
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> PRODUCT_ID;
</code></pre>
<p>测试结果如下表所示（完整测试SQL见附录）：</p>



























































<table><thead><tr><th><strong>刷新</strong></th><th><strong>源表行数</strong></th><th/><th><strong>某国际知名产品无状态增量计算刷新耗时(s)</strong></th><th/><th><strong>Hologres刷新耗时(s)</strong></th><th/></tr></thead><tbody><tr><td/><td><strong>Retraction</strong></td><td><strong>Appendonly</strong></td><td><strong>Retraction</strong></td><td><strong>Appendonly</strong></td><td><strong>Retraction</strong></td><td><strong>Appendonly</strong></td></tr><tr><td><strong>增全量刷新</strong></td><td>ORDER_DETAIL: 10M</td><td/><td>1.5</td><td>1.3</td><td>4.6</td><td>3.9</td></tr><tr><td><strong>增量第一次</strong></td><td>每张表 <br/>UPDATE 0.5%<br/>INSERT 0.5%</td><td>每张表 <br/>INSERT 1.0%</td><td>7.8</td><td>2.4</td><td>0.59</td><td>0.48</td></tr><tr><td><strong>增量第二次</strong></td><td/><td/><td>8.1</td><td>2.7</td><td>0.49</td><td>0.41</td></tr><tr><td><strong>增量第三次</strong></td><td/><td/><td>7.8</td><td>2.9</td><td>0.45</td><td>0.3</td></tr></tbody></table>
<p>可以看到Hologres增全量刷新阶段较慢，但后面的每次增量刷新都很快，符合预期。</p>
<p>无状态增量刷新性能较差的主要原因是无状态增量执行计划变得更加复杂，包含36个计算节点，且变更数据触及了大量分区，需要从源表重新扫描计算所有的数据。在有回撤数据时，处理数据变更前后因果关系会导致计算逻辑会变得更加复杂，进一步变慢，增量计算显得没有意义。</p>
<p>Hologres增量刷新快的核心原因是每次增量计算都是基于上次计算生成的状态表（State），这极大的简化了增量计算逻辑。此例中Hologres中各表存储大小如下所示（源表是Retraction的情况），结果表很小，而因为min/max/count distinct这两种聚合函数与sum/count这类不同，状态表需要存储对应列的所有原始数据，所以相比结果表要大很多。</p>

















<table><thead><tr><th/><th><strong>源表</strong></th><th><strong>结果表</strong></th><th><strong>状态表</strong></th></tr></thead><tbody><tr><td><strong>存储</strong></td><td>252 MB</td><td>1 MB</td><td>93 MB</td></tr></tbody></table>
<h3 data-id="heading-6">场景 2：两表 Join（订单 + 明细）</h3>
<p>两表Join是大数据处理中一种较为简单的基本场景，测试使用的具体工作负载如下图所示
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3554fe51baf43fb8f9a708c90e79533~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767003882&amp;x-signature=mpGBCEKmm8iPH0lnrvhilWnK8uU%3D" alt="image.png" loading="lazy"/></p>
<p>Hologres建表SQL如下：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DYNAMIC</span> <span class="hljs-keyword">TABLE</span> DT_ORDER_DETAIL
<span class="hljs-keyword">WITH</span> (
  auto_refresh_mode <span class="hljs-operator">=</span> <span class="hljs-string">'incremental'</span>, 
  auto_refresh_enable <span class="hljs-operator">=</span> <span class="hljs-string">'false'</span>, 
  freshness <span class="hljs-operator">=</span> <span class="hljs-string">'1 minutes'</span>
) <span class="hljs-keyword">AS</span> 
<span class="hljs-keyword">SELECT</span>
  o.ORDER_ID,
  o.ORDER_DATE,
  o.ORDER_STATUS,
  oi.ORDER_ITEM_ID,
  oi.PRODUCT_ID,
  oi.QUANTITY,
  oi.UNIT_PRICE,
  oi.LINE_AMOUNT
<span class="hljs-keyword">FROM</span> ORDERS o
<span class="hljs-keyword">JOIN</span> ORDER_ITEMS oi
  <span class="hljs-keyword">ON</span> o.ORDER_ID <span class="hljs-operator">=</span> oi.ORDER_ID;
</code></pre>
<p>测试结果如下表所示（完整测试SQL见附录），无状态增量刷新引擎在数据含有回撤的时候执行计划包含50个节点，源表大部分分区的数据被反复读取参与聚合，导致性能不佳。而数据不包含回撤（Appendonly）时，无状态增量刷新执行计划相对简单，含有35个节点，且新增数据不会触及太多分区，表现良好，体现出了增量计算的意义。</p>



























































<table><thead><tr><th/><th><strong>源表行数</strong></th><th/><th><strong>某国际知名产品无状态增量计算(s)</strong></th><th/><th><strong>Hologres刷新耗时(s)</strong></th><th/></tr></thead><tbody><tr><td/><td><strong>Retraction</strong></td><td><strong>Appendonly</strong></td><td><strong>Retraction</strong></td><td><strong>Appendonly</strong></td><td><strong>Retraction</strong></td><td><strong>Appendonly</strong></td></tr><tr><td><strong>增全量刷新</strong></td><td><strong>ORDERS</strong>: 5M<br/><strong>ORDER_ITEMS</strong>: 10M</td><td/><td>10</td><td>8.7</td><td>9.2</td><td>6.29</td></tr><tr><td><strong>增量第一次</strong></td><td>每张表 <br/>UPDATE 0.5%<br/>INSERT 0.5%</td><td>每张表 <br/>INSERT 1.0%</td><td>22</td><td>1.1</td><td>2.2</td><td>0.68</td></tr><tr><td><strong>增量第二次</strong></td><td/><td/><td>19</td><td>2.2</td><td>1.1</td><td>0.50</td></tr><tr><td><strong>增量第三次</strong></td><td/><td/><td>22</td><td>1.7</td><td>1.9</td><td>0.51</td></tr></tbody></table>
<p>Hologres中各表存储大小如下所示，在这种场景下状态表存了源表的部分列数据，实际存储小于源表。</p>

















<table><thead><tr><th/><th><strong>源表</strong></th><th><strong>结果表</strong></th><th><strong>状态表</strong></th></tr></thead><tbody><tr><td><strong>存储</strong></td><td>370 MB</td><td>350 MB</td><td>228 MB</td></tr></tbody></table>
<h3 data-id="heading-7">场景 3：五表复杂 Join（订单 + 用户 + 商品 + 支付等）</h3>
<p>多表Join是一种相对更常见、真实的场景，测试具体使用的工作负载如下:
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e52878c421c4566bb42b3712f73e621~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767003882&amp;x-signature=mBcM1KqrAbP%2FEqvzNE0xprSI9pE%3D" alt="image.png" loading="lazy"/></p>
<p>Hologres的测试脚本如下：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">DYNAMIC</span> <span class="hljs-keyword">TABLE</span> DT_ORDER_DETAIL
<span class="hljs-keyword">WITH</span> (
  auto_refresh_mode <span class="hljs-operator">=</span> <span class="hljs-string">'incremental'</span>, 
  auto_refresh_enable <span class="hljs-operator">=</span> <span class="hljs-string">'false'</span>, 
  freshness <span class="hljs-operator">=</span> <span class="hljs-string">'1 minutes'</span>
) <span class="hljs-keyword">AS</span> 
<span class="hljs-keyword">SELECT</span>
  o.ORDER_ID,
  o.ORDER_DATE,
  o.ORDER_STATUS,
  u.USER_ID,
  u.USER_NAME,
  u.EMAIL,
  u.STATUS <span class="hljs-keyword">AS</span> USER_STATUS,
  oi.ORDER_ITEM_ID,
  oi.PRODUCT_ID,
  p.PRODUCT_NAME,
  p.CATEGORY,
  p.PRICE       <span class="hljs-keyword">AS</span> PRODUCT_PRICE,
  oi.QUANTITY,
  oi.UNIT_PRICE,
  oi.LINE_AMOUNT,
  pay.PAYMENT_ID,
  pay.PAY_AMOUNT,
  pay.PAY_METHOD,
  pay.PAY_TIME
<span class="hljs-keyword">FROM</span> ORDERS o
<span class="hljs-keyword">JOIN</span> USERS u
  <span class="hljs-keyword">ON</span> o.USER_ID <span class="hljs-operator">=</span> u.USER_ID
<span class="hljs-keyword">JOIN</span> ORDER_ITEMS oi
  <span class="hljs-keyword">ON</span> o.ORDER_ID <span class="hljs-operator">=</span> oi.ORDER_ID
<span class="hljs-keyword">JOIN</span> PRODUCTS p
  <span class="hljs-keyword">ON</span> oi.PRODUCT_ID <span class="hljs-operator">=</span> p.PRODUCT_ID
<span class="hljs-keyword">LEFT</span> <span class="hljs-keyword">JOIN</span> PAYMENTS pay
  <span class="hljs-keyword">ON</span> o.ORDER_ID <span class="hljs-operator">=</span> pay.ORDER_ID;
</code></pre>
<p>测试结果如下表所示（完整测试SQL见附录），无状态增量计算引擎无论是只包含插入还是有回撤，性能都相对较差，原因也是类似的。五表Join的场景下，增量计算的执行节点超过140个，会大量读取源表数据。</p>



























































<table><thead><tr><th/><th><strong>源表行数</strong></th><th/><th><strong>某国际知名产品无状态增量计算(s)</strong></th><th/><th><strong>Hologres刷新耗时(s)</strong></th><th/></tr></thead><tbody><tr><td/><td><strong>Retraction</strong></td><td><strong>Appendonly</strong></td><td><strong>Retraction</strong></td><td><strong>Appendonly</strong></td><td><strong>Retraction</strong></td><td><strong>Appendonly</strong></td></tr><tr><td><strong>增全量刷新</strong></td><td><strong>ORDER_ITEMS</strong>: 10M<br/><strong>PAYMENTS</strong>: 4.9M<br/><strong>ORDERS</strong>: 5M<br/><strong>PRODUCTS</strong>: 50K<br/><strong>USERS</strong>: 500K</td><td/><td>23</td><td>23</td><td>30</td><td>22</td></tr><tr><td><strong>增量第一次</strong></td><td>每张表 <br/>UPDATE 0.5%<br/>INSERT 0.5%</td><td>每张表 <br/>INSERT 1.0%</td><td>55</td><td>26</td><td>3.9</td><td>2.8</td></tr><tr><td><strong>增量第二次</strong></td><td/><td/><td>58</td><td>27</td><td>3.2</td><td>1.8</td></tr><tr><td><strong>增量第三次</strong></td><td/><td/><td>60</td><td>26</td><td>2.9</td><td>1.8</td></tr></tbody></table>
<p>Hologres中各表存储大小如下所示，状态表会存储每一次Join的中间结果</p>

















<table><thead><tr><th/><th><strong>源表</strong></th><th><strong>结果表</strong></th><th><strong>状态表</strong></th></tr></thead><tbody><tr><td><strong>存储</strong></td><td>594 MB</td><td>1218 MB</td><td>1094 MB</td></tr></tbody></table>
<h2 data-id="heading-8">四、有状态增量计算：为何更高效？</h2>
<p>基于前面的实验结果，不难看出，无状态增量计算方案适用条件其实比较苛刻，在很多场景中基于少量数据的增量计算开销甚至会超过第一次的全量计算，丧失了增量计算的意义。</p>
<p>而相比较之下，Hologres的有状态增量计算方案可以适用于大多数的场景，通常只需要满足增量数据较少这一个条件即可。下图以单表聚合场景(<code>sum(value) group by key</code>)为例，展示了有状态方案的基本原理，增量计算过程中可以从状态表中直接获取历史数据的聚合结果，而不需要基于历史表的原始数据重新计算。此外在读取状态表数据时，也进一步引入了OLAP查询中常用的runtime filter优化，在增量数据较少的场景中，大幅减少状态表数据读取量，使刷新性能得到了显著的提升。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d6eceb6f2e947ee813e533fd51a4d92~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767003882&amp;x-signature=5ltW4H0byFwf%2FCyjOUJtww0T7%2Fs%3D" alt="image.png" loading="lazy"/></p>
<p>有状态方案一个显著的缺点是与无状态方案相比会需要占用额外的存储空间用于状态表的存储。如上述实验数据所示，实际额外存储大小通常与涉及到的源表、结果表的大小相关。</p>
<p>这一缺点通常是可以接受的，因为在业务实践操作中，这部分存储一般是可控的,不会无限增长。这是因为：</p>
<ul>
<li>
<p>分区表的场景中，只有活跃分区需要状态表，历史分区转全量刷新后不再需要状态表（这个过程是自动的，分区不再活跃后会自动清理状态表）。因此只有最近的一两个分区才需要状态表，这极大地减少了状态表的存储空间。因此Hologres Dynamic Table增量计算状态表没有Flink常见的状态膨胀问题。</p>
</li>
<li>
<p>非分区表场景中，可以为状态表配置合适的TTL，丢弃一些不再需要的历史状态减少存储空间</p>
</li>
</ul>
<h2 data-id="heading-9">总结：Hologres Dynamic Table 的核心价值</h2>
<p>面对企业日益增长的实时分析需求，Hologres 的 Dynamic Table 通过有状态增量计算引擎，从根本上解决了传统方案在复杂查询下“增量不增效”的痛点。它不仅大幅缩短了数据刷新延迟，还显著降低了计算资源消耗和运维复杂度，真正实现了“写一次 SQL，自动高效更新”的体验。无论你是构建实时看板、用户画像宽表，还是风控特征管道，Hologres 都能以稳定、高性能、低成本的方式支撑你的核心数据链路。</p>
<h2 data-id="heading-10">附录</h2>
<h3 data-id="heading-11">无状态 &amp; 有状态增量计算底层原理对比分析</h3>
<p>从上面的实验结果来看，Hologres的有状态实现方案在大多数的场景中是要优于无状态增量计算引擎的，本小节将对两者的底层计算原理进行对比分析，说明造成这种性能差异的根本原因。</p>
<h4 data-id="heading-12">符号说明</h4>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi></mrow><annotation encoding="application/x-tex">R</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.00773em;">R</span></span></span></span></span>：表示一个关系表</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><mo stretchy="false">(</mo><mi>E</mi><mi>x</mi><mi>p</mi><mi>r</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Delta(Expr)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">Δ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mord mathnormal">x</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">)</span></span></span></span></span>：表示一个关系计算表达式的增量变化</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mi>r</mi><mi>e</mi><mo stretchy="false">(</mo><mi>R</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Pre(R)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">re</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mclose">)</span></span></span></span></span>：表示一个关系表在某次增量变化之前的快照</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mi>o</mi><mi>s</mi><mi>t</mi><mo stretchy="false">(</mo><mi>R</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Post(R)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">os</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mclose">)</span></span></span></span></span>：表示一个关系表在某次增量变化之后的快照</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>t</mi><mi>a</mi><mi>t</mi><mi>e</mi><mo stretchy="false">(</mo><mi>E</mi><mi>x</mi><mi>p</mi><mi>r</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">State(Expr)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">St</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mord mathnormal">x</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">)</span></span></span></span></span>：表示某一个关系计算表达式的持久化状态</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>⋈</mo></mrow><annotation encoding="application/x-tex">\bowtie</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.51em;vertical-align:-0.005em;"/><span class="mrel">⋈</span></span></span></span></span>：表示关联操作（Join）</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mi>g</mi><mi>g</mi><mo stretchy="false">(</mo><mi>E</mi><mi>x</mi><mi>p</mi><mi>r</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Agg(Expr)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.03588em;">gg</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mord mathnormal">x</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">)</span></span></span></span></span>：表示对某一个关系计算表达式做聚合运算</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>M</mi><mi>e</mi><mi>r</mi><mi>g</mi><mi>e</mi><mo stretchy="false">(</mo><mi>E</mi><mi>x</mi><mi>p</mi><mi>r</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">Merge(Expr)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal" style="margin-right:0.02778em;">er</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mord mathnormal">e</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mord mathnormal">x</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose">)</span></span></span></span></span>：聚合运算的特例，每一个分组只有两行数据</p>
<h4 data-id="heading-13">多表Join场景</h4>
<h5 data-id="heading-14">无状态实现Hologres Dynamic Table：高效增量刷新，构建实时统一数仓的核心利器</h5>
<p>无状态多表Inner Join的增量计算公式如下（原理可参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdl.acm.org%2Fdoi%2F10.1145%2F3588720" target="_blank" title="https://dl.acm.org/doi/10.1145/3588720" ref="nofollow noopener noreferrer">论文</a>），根据实际执行计划推测某无状态增量计算引擎的多表Join增量计算应该也是基于该公式实现的</p>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><mo stretchy="false">(</mo><mi>R</mi><mi mathvariant="normal">_</mi><mn>1</mn><mtext> </mtext><mo>⋈</mo><mtext> </mtext><mo>⋯</mo><mtext> </mtext><mo>⋈</mo><mtext> </mtext><mi>R</mi><mi mathvariant="normal">_</mi><mi>n</mi><mo stretchy="false">)</mo><mtext> </mtext><mspace linebreak="newline"/><mo>=</mo><mtext> </mtext><mi mathvariant="normal">Δ</mi><mo stretchy="false">(</mo><mi>R</mi><mi mathvariant="normal">_</mi><mn>1</mn><mo stretchy="false">)</mo><mtext> </mtext><mo>⋈</mo><mtext> </mtext><mi>P</mi><mi>o</mi><mi>s</mi><mi>t</mi><mo stretchy="false">(</mo><mi>R</mi><mi mathvariant="normal">_</mi><mn>2</mn><mo stretchy="false">)</mo><mtext> </mtext><mo>⋈</mo><mtext> </mtext><mi>P</mi><mi>o</mi><mi>s</mi><mi>t</mi><mo stretchy="false">(</mo><mi>R</mi><mi mathvariant="normal">_</mi><mn>3</mn><mo stretchy="false">)</mo><mtext> </mtext><mo>⋈</mo><mtext> </mtext><mo>…</mo><mtext> </mtext><mi>P</mi><mi>o</mi><mi>s</mi><mi>t</mi><mo stretchy="false">(</mo><mi>R</mi><mi mathvariant="normal">_</mi><mi>n</mi><mo stretchy="false">)</mo><mtext> </mtext><mspace linebreak="newline"/><mo>∪</mo><mtext> </mtext><mi>P</mi><mi>r</mi><mi>e</mi><mo stretchy="false">(</mo><mi>R</mi><mi mathvariant="normal">_</mi><mn>1</mn><mo stretchy="false">)</mo><mtext> </mtext><mo>⋈</mo><mtext> </mtext><mi mathvariant="normal">Δ</mi><mo stretchy="false">(</mo><mi>R</mi><mi mathvariant="normal">_</mi><mn>2</mn><mo stretchy="false">)</mo><mtext> </mtext><mo>⋈</mo><mtext> </mtext><mi>P</mi><mi>o</mi><mi>s</mi><mi>t</mi><mo stretchy="false">(</mo><mi>R</mi><mi mathvariant="normal">_</mi><mn>3</mn><mo stretchy="false">)</mo><mtext> </mtext><mo>⋈</mo><mtext> </mtext><mo>…</mo><mtext> </mtext><mi>P</mi><mi>o</mi><mi>s</mi><mi>t</mi><mo stretchy="false">(</mo><mi>R</mi><mi mathvariant="normal">_</mi><mi>n</mi><mo stretchy="false">)</mo><mtext> </mtext><mspace linebreak="newline"/><mo>∪</mo><mtext> </mtext><mi>P</mi><mi>r</mi><mi>e</mi><mo stretchy="false">(</mo><mi>R</mi><mi mathvariant="normal">_</mi><mn>1</mn><mo stretchy="false">)</mo><mtext> </mtext><mo>⋈</mo><mtext> </mtext><mi>P</mi><mi>r</mi><mi>e</mi><mo stretchy="false">(</mo><mi>R</mi><mi mathvariant="normal">_</mi><mn>2</mn><mo stretchy="false">)</mo><mtext> </mtext><mo>⋈</mo><mtext> </mtext><mi mathvariant="normal">Δ</mi><mo stretchy="false">(</mo><mi>R</mi><mi mathvariant="normal">_</mi><mn>3</mn><mo stretchy="false">)</mo><mtext> </mtext><mo>⋈</mo><mtext> </mtext><mo>…</mo><mtext> </mtext><mi>P</mi><mi>o</mi><mi>s</mi><mi>t</mi><mo stretchy="false">(</mo><mi>R</mi><mi mathvariant="normal">_</mi><mi>n</mi><mo stretchy="false">)</mo><mtext> </mtext><mspace linebreak="newline"/><mtext> </mtext><mo>…</mo><mtext> </mtext><mspace linebreak="newline"/><mo>∪</mo><mtext> </mtext><mi>P</mi><mi>r</mi><mi>e</mi><mo stretchy="false">(</mo><mi>R</mi><mi mathvariant="normal">_</mi><mn>1</mn><mo stretchy="false">)</mo><mtext> </mtext><mo>⋈</mo><mtext> </mtext><mi>P</mi><mi>r</mi><mi>e</mi><mo stretchy="false">(</mo><mi>R</mi><mi mathvariant="normal">_</mi><mn>2</mn><mo stretchy="false">)</mo><mtext> </mtext><mo>⋈</mo><mtext> </mtext><mi>P</mi><mi>r</mi><mi>e</mi><mo stretchy="false">(</mo><mi>R</mi><mi mathvariant="normal">_</mi><mn>3</mn><mo stretchy="false">)</mo><mtext> </mtext><mo>…</mo><mtext> </mtext><mi mathvariant="normal">Δ</mi><mo stretchy="false">(</mo><mi>R</mi><mi mathvariant="normal">_</mi><mi>n</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Delta(R\_1 \bowtie \cdots \bowtie R\_n) \\=  \Delta(R\_1) \bowtie Post(R\_2) \bowtie Post(R\_3) \bowtie \ldots Post(R\_n) \\ \cup Pre(R\_1) \bowtie \Delta(R\_2) \bowtie Post(R\_3) \bowtie \ldots Post(R\_n) \\ \cup Pre(R\_1) \bowtie Pre(R\_2) \bowtie \Delta(R\_3) \bowtie \ldots Post(R\_n) \\  \ldots \\ \cup Pre(R\_1) \bowtie Pre(R\_2) \bowtie Pre(R\_3) \dots \Delta(R\_n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mord">Δ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord">_1 </span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">⋈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.51em;vertical-align:-0.005em;"/><span class="mord"> </span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">⋯</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"> </span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">⋈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mord"> </span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">n</span><span class="mclose">)</span><span class="mord"> </span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:0.3669em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mord"> Δ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord">_1</span><span class="mclose">)</span><span class="mord"> </span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">⋈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mord"> </span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">os</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord">_2</span><span class="mclose">)</span><span class="mord"> </span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">⋈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mord"> </span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">os</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord">_3</span><span class="mclose">)</span><span class="mord"> </span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">⋈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mord"> </span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"> </span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">os</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">n</span><span class="mclose">)</span><span class="mord"> </span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mord">∪</span><span class="mord"> </span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">re</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord">_1</span><span class="mclose">)</span><span class="mord"> </span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">⋈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mord"> Δ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord">_2</span><span class="mclose">)</span><span class="mord"> </span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">⋈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mord"> </span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">os</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord">_3</span><span class="mclose">)</span><span class="mord"> </span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">⋈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mord"> </span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"> </span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">os</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">n</span><span class="mclose">)</span><span class="mord"> </span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mord">∪</span><span class="mord"> </span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">re</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord">_1</span><span class="mclose">)</span><span class="mord"> </span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">⋈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mord"> </span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">re</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord">_2</span><span class="mclose">)</span><span class="mord"> </span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">⋈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mord"> Δ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord">_3</span><span class="mclose">)</span><span class="mord"> </span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">⋈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mord"> </span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"> </span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">os</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">n</span><span class="mclose">)</span><span class="mord"> </span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:0.123em;"/><span class="mord"> </span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"> </span></span><span class="mspace newline"/><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mord">∪</span><span class="mord"> </span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">re</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord">_1</span><span class="mclose">)</span><span class="mord"> </span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">⋈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mord"> </span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">re</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord">_2</span><span class="mclose">)</span><span class="mord"> </span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">⋈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mord"> </span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">re</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord">_3</span><span class="mclose">)</span><span class="mord"> </span><span class="mspace" style="margin-right:0.1667em;"/><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord"> Δ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord" style="margin-right:0.02778em;">_</span><span class="mord mathnormal">n</span><span class="mclose">)</span></span></span></span></span></p>
<p>该方案主要会有如下弊端：</p>
<ul>
<li>
<p>Join次数较多，会有至少 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mtext> </mtext><mo>∗</mo><mtext> （</mtext><mi>N</mi><mtext> </mtext><mo>−</mo><mtext> </mtext><mn>1</mn><mtext>）</mtext></mrow><annotation encoding="application/x-tex">N * （N - 1）</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord"> </span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord"> </span><span class="mord cjk_fallback">（</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord"> </span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord"> 1</span><span class="mord cjk_fallback">）</span></span></span></span></span>次</p>
</li>
<li>
<p>每一路Union的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>N</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">N-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">1</span></span></span></span></span>次Join中，只有一个是增量数据级的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><mo stretchy="false">(</mo><mi>R</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Delta(R)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">Δ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mclose">)</span></span></span></span></span>，其他路都是源表数量级的<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>P</mi><mi>r</mi><mi>e</mi><mtext>、</mtext><mi>P</mi><mi>o</mi><mi>s</mi><mi>t</mi></mrow><annotation encoding="application/x-tex">Pre、Post</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">re</span><span class="mord cjk_fallback">、</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">os</span><span class="mord mathnormal">t</span></span></span></span></span>，这种场景中Join Filter效果不好保证，可能会多扫描很多数据</p>
</li>
<li>
<p>当增量数据含有回撤时，需要调控不同Union之间的输出顺序来确保因果关系，会使上面的计算流程变得更重</p>
</li>
</ul>
<h5 data-id="heading-15">有状态实现</h5>
<p>Hologres的有状态多表Join计算公式原理大致如下，因为所有的中间计算结果状态会通过状态表（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>t</mi><mi>a</mi><mi>t</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">State</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">St</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span></span></span></span></span>）持久化保存下来，因此可以按照两表Join的公式做简单展开</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e30711c81fb4f2d8751b9d392754adb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767003882&amp;x-signature=1qI7kyyAJrqNbVY55wHhmYiHnoA%3D" alt="image.png" loading="lazy"/></p>
<p>有状态方案以额外的存储开销为代价换来了：</p>
<ul>
<li>
<p>更少的Join次数，忽略<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><mo stretchy="false">(</mo><mi>R</mi><mi mathvariant="normal">_</mi><mn>1</mn><mo stretchy="false">)</mo><mtext> </mtext><mo>⋈</mo><mtext> </mtext><mi mathvariant="normal">Δ</mi><mo stretchy="false">(</mo><mi>R</mi><mi mathvariant="normal">_</mi><mn>2</mn><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Delta(R\_1) \bowtie \Delta(R\_2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mord">Δ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord">_1</span><span class="mclose">)</span><span class="mord"> </span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">⋈</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.06em;vertical-align:-0.31em;"/><span class="mord"> Δ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord">_2</span><span class="mclose">)</span></span></span></span></span>这种轻量级的Join，只有<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>2</mn><mtext> </mtext><mo>∗</mo><mtext> （</mtext><mi>N</mi><mtext> </mtext><mo>−</mo><mtext> </mtext><mn>1</mn><mtext>）</mtext></mrow><annotation encoding="application/x-tex">2 * （N - 1）</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">2 </span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.7667em;vertical-align:-0.0833em;"/><span class="mord"> </span><span class="mord cjk_fallback">（</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord"> </span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord"> 1</span><span class="mord cjk_fallback">）</span></span></span></span></span>次Join 操作</p>
</li>
<li>
<p>更少的数据读取，<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi></mrow><annotation encoding="application/x-tex">\Delta</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord">Δ</span></span></span></span></span> 和<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>t</mi><mi>a</mi><mi>t</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">State</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">St</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span></span></span></span></span>Join的Filter下推简单高效，通常只需要读取<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>t</mi><mi>a</mi><mi>t</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">State</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">St</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span></span></span></span></span>表中的少数行</p>
</li>
<li>
<p>更简单的回撤处理逻辑，只需要在同一层内调整数据输出顺序确保因果关系</p>
</li>
</ul>
<h4 data-id="heading-16">单表聚合场景</h4>
<p>单表聚合场景相对较为简单，无状态、有状态两种方案的计算公式原理分别如下：</p>
<p>某无状态增量计算引擎：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><mo stretchy="false">(</mo><mrow><mi mathvariant="sans-serif">A</mi><mi mathvariant="sans-serif">g</mi><mi mathvariant="sans-serif">g</mi></mrow><mo stretchy="false">(</mo><mi>R</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mtext>  </mtext><mo>=</mo><mtext> </mtext><mrow><mi mathvariant="sans-serif">A</mi><mi mathvariant="sans-serif">g</mi><mi mathvariant="sans-serif">g</mi></mrow><mo fence="true" stretchy="true" minsize="1.8em" maxsize="1.8em">(</mo><mtext>      </mtext><mrow><mi mathvariant="sans-serif">A</mi><mi mathvariant="sans-serif">g</mi><mi mathvariant="sans-serif">g</mi></mrow><mo stretchy="false">(</mo><mi mathvariant="normal">Δ</mi><mo stretchy="false">(</mo><mi>R</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mtext>      </mtext><mtext>  </mtext><mo>⋈</mo><mtext>  </mtext><mtext>      </mtext><mi>R</mi><mtext>    </mtext><mo fence="true" stretchy="true" minsize="1.8em" maxsize="1.8em">)</mo></mrow><annotation encoding="application/x-tex">\Delta(\mathsf{Agg}(R))   = \mathsf{Agg}\Bigl(       \mathsf{Agg}(\Delta(R))       \;\bowtie\;       R     \Bigr)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">Δ</span><span class="mopen">(</span><span class="mord"><span class="mord mathsf" style="margin-right:0.01389em;">Agg</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mclose">))</span><span class="mord">  </span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.8em;vertical-align:-0.65em;"/><span class="mord"> </span><span class="mord"><span class="mord mathsf" style="margin-right:0.01389em;">Agg</span></span><span class="mopen"><span class="delimsizing size2">(</span></span><span class="mord">      </span><span class="mord"><span class="mord mathsf" style="margin-right:0.01389em;">Agg</span></span><span class="mopen">(</span><span class="mord">Δ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mclose">))</span><span class="mord">      </span><span class="mspace" style="margin-right:0.2778em;"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">⋈</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.8em;vertical-align:-0.65em;"/><span class="mord">      </span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord">    </span><span class="mclose"><span class="delimsizing size2">)</span></span></span></span></span></span></p>
<p>Hologres有状态：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Δ</mi><mo stretchy="false">(</mo><mrow><mi mathvariant="sans-serif">A</mi><mi mathvariant="sans-serif">g</mi><mi mathvariant="sans-serif">g</mi></mrow><mo stretchy="false">(</mo><mi>R</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mtext>  </mtext><mo>=</mo><mtext> </mtext><mrow><mi mathvariant="sans-serif">M</mi><mi mathvariant="sans-serif">e</mi><mi mathvariant="sans-serif">r</mi><mi mathvariant="sans-serif">g</mi><mi mathvariant="sans-serif">e</mi></mrow><mo fence="true" stretchy="true" minsize="1.8em" maxsize="1.8em">(</mo><mtext>      </mtext><mrow><mi mathvariant="sans-serif">A</mi><mi mathvariant="sans-serif">g</mi><mi mathvariant="sans-serif">g</mi></mrow><mo stretchy="false">(</mo><mi mathvariant="normal">Δ</mi><mo stretchy="false">(</mo><mi>R</mi><mo stretchy="false">)</mo><mo stretchy="false">)</mo><mtext>      </mtext><mtext>  </mtext><mo>⋈</mo><mtext>  </mtext><mtext>      </mtext><mi>S</mi><mi>t</mi><mi>a</mi><mi>t</mi><mi>e</mi><mo stretchy="false">(</mo><mi>R</mi><mo stretchy="false">)</mo><mtext>    </mtext><mo fence="true" stretchy="true" minsize="1.8em" maxsize="1.8em">)</mo></mrow><annotation encoding="application/x-tex">\Delta(\mathsf{Agg}(R))   = \mathsf{Merge}\Bigl(       \mathsf{Agg}(\Delta(R))       \;\bowtie\;       State(R)     \Bigr)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">Δ</span><span class="mopen">(</span><span class="mord"><span class="mord mathsf" style="margin-right:0.01389em;">Agg</span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mclose">))</span><span class="mord">  </span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.8em;vertical-align:-0.65em;"/><span class="mord"> </span><span class="mord"><span class="mord mathsf">Merge</span></span><span class="mopen"><span class="delimsizing size2">(</span></span><span class="mord">      </span><span class="mord"><span class="mord mathsf" style="margin-right:0.01389em;">Agg</span></span><span class="mopen">(</span><span class="mord">Δ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mclose">))</span><span class="mord">      </span><span class="mspace" style="margin-right:0.2778em;"/><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">⋈</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1.8em;vertical-align:-0.65em;"/><span class="mord">      </span><span class="mord mathnormal">St</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mclose">)</span><span class="mord">    </span><span class="mclose"><span class="delimsizing size2">)</span></span></span></span></span></span></p>
<p>公式大体是比较相似的，主要区别是Hologres的有状态方案持久化存储了历史数据的聚合结果，因此有以下优势：</p>
<ul>
<li>
<p>不需要重新计算历史数据的聚合结果</p>
</li>
<li>
<p><span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>S</mi><mi>t</mi><mi>a</mi><mi>t</mi><mi>e</mi></mrow><annotation encoding="application/x-tex">State</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord mathnormal">St</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span></span></span></span></span>表数据量极小，Join 操作可以显著减少读取数据量</p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么"软件测试"很重要？——从 Bug 到高质量软件的保障]]></title>    <link>https://juejin.cn/post/7586452779713249295</link>    <guid>https://juejin.cn/post/7586452779713249295</guid>    <pubDate>2025-12-22T10:45:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586452779713249295" data-draft-id="7586496648379056128" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么&quot;软件测试&quot;很重要？——从 Bug 到高质量软件的保障 "/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-12-22T10:45:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无限大6"/> <meta itemprop="url" content="https://juejin.cn/user/2865758605422890"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么"软件测试"很重要？——从 Bug 到高质量软件的保障 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2865758605422890/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无限大6
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T10:45:59.000Z" title="Mon Dec 22 2025 10:45:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🧪 为什么"软件测试"很重要？——从 Bug 到高质量软件的保障 🐛</h2>
<blockquote>
<p>大家好，我是无限大，欢迎收看十万个为什么系列文章</p>
<p>希望今天的内容能对大家有所帮助</p>
</blockquote>
<p>今天咱们来聊聊软件测试这个"软件质量的守门员"！想象一下，你下载了一款新游戏，刚玩5分钟就崩溃了；你用网购APP付款，结果钱扣了却没订单——这些糟心的体验，都是因为软件测试没做好！</p>
<h3 data-id="heading-1">🤔 核心问题：软件测试到底是干啥的？为什么需要自动化测试？</h3>
<p>很多人觉得软件测试就是"点点点"，其实远不止这么简单！软件测试就像"质量检测员"，在软件发布前找出所有可能的问题，确保用户拿到手的是高质量产品。</p>
<h4 data-id="heading-2">软件测试的本质</h4>
<p>软件测试是一种<strong>验证软件质量的过程</strong>，通过各种方法检查软件是否满足需求、是否存在bug、是否性能良好、是否安全可靠。</p>
<h4 data-id="heading-3">为什么需要自动化测试？</h4>
<ul>
<li>⏱️ <strong>节省时间</strong>：一次编写，多次执行，比手工测试快10倍以上</li>
<li>🔍 <strong>提高覆盖率</strong>：可以覆盖更多测试场景，减少漏测</li>
<li>🎯 <strong>一致性</strong>：每次测试都一样，不会受情绪、疲劳影响</li>
<li>💪 <strong>回归测试</strong>：代码改动后快速验证，防止旧bug重现</li>
</ul>
<h3 data-id="heading-4">📜 软件测试的"进化史"：从手工到自动化</h3>
<h4 data-id="heading-5">1. 🖐️ 手工测试时代："人肉测试机"</h4>
<p>20世纪80年代，软件测试主要靠手工完成。测试人员像"人肉测试机"一样，反复点击按钮、输入数据、检查结果。</p>
<p>这就像"用手检查生产线的产品"，效率低、容易出错，而且只能覆盖有限的测试场景。</p>
<h4 data-id="heading-6">2. 🤖 自动化测试时代："机器人测试"</h4>
<p>2000年后，自动化测试开始兴起。测试人员编写脚本，让计算机自动执行测试用例。</p>
<p>这就像"用机器人检查生产线"，效率高、一致性好，可以24小时不间断测试。</p>
<h4 data-id="heading-7">3. 🚀 智能化测试时代："AI测试师"</h4>
<p>近年来，AI技术开始融入软件测试。AI可以自动生成测试用例、预测bug位置、分析测试结果。</p>
<p>这就像"用AI质检师检查生产线"，不仅效率更高，还能发现人类难以发现的问题！</p>
<h3 data-id="heading-8">🔧 技术原理：软件测试的核心技术</h3>
<h4 data-id="heading-9">1. 📝 测试用例设计："怎么测？测什么？"</h4>
<p>测试用例是软件测试的"剧本"，定义了测试的步骤、输入、预期输出。设计好的测试用例能覆盖更多场景，减少漏测。</p>
<p><strong>常见的测试用例设计方法</strong>：</p>
<ul>
<li>等价类划分：将输入划分为若干等价类，每个等价类只测一个</li>
<li>边界值分析：重点测试边界情况（如最大值、最小值、空值）</li>
<li>因果图：分析输入条件和输出结果的因果关系</li>
<li>场景法：模拟用户实际使用场景</li>
</ul>
<h4 data-id="heading-10">2. 🤖 自动化测试框架："测试的脚手架"</h4>
<p>自动化测试框架是一套工具和库，用于编写、执行和管理自动化测试。</p>
<p><strong>常见的自动化测试框架</strong>：</p>
<ul>
<li>Web测试：Selenium、Cypress</li>
<li>接口测试：Postman、RestAssured</li>
<li>移动测试：Appium、Espresso</li>
<li>性能测试：JMeter、LoadRunner</li>
</ul>
<p><strong>代码实例</strong>：用Python + Selenium进行Web自动化测试</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> selenium <span class="hljs-keyword">import</span> webdriver
<span class="hljs-keyword">from</span> selenium.webdriver.common.by <span class="hljs-keyword">import</span> By
<span class="hljs-keyword">from</span> selenium.webdriver.support.ui <span class="hljs-keyword">import</span> WebDriverWait
<span class="hljs-keyword">from</span> selenium.webdriver.support <span class="hljs-keyword">import</span> expected_conditions <span class="hljs-keyword">as</span> EC

<span class="hljs-comment"># 初始化浏览器</span>
driver = webdriver.Chrome()
<span class="hljs-keyword">try</span>:
    <span class="hljs-comment"># 打开百度首页</span>
    driver.get(<span class="hljs-string">"https://www.baidu.com"</span>)
  
    <span class="hljs-comment"># 输入搜索关键词</span>
    search_box = driver.find_element(By.ID, <span class="hljs-string">"kw"</span>)
    search_box.send_keys(<span class="hljs-string">"软件测试"</span>)
  
    <span class="hljs-comment"># 点击搜索按钮</span>
    search_button = driver.find_element(By.ID, <span class="hljs-string">"su"</span>)
    search_button.click()
  
    <span class="hljs-comment"># 等待搜索结果加载</span>
    WebDriverWait(driver, <span class="hljs-number">10</span>).until(
        EC.presence_of_element_located((By.ID, <span class="hljs-string">"content_left"</span>))
    )
  
    <span class="hljs-comment"># 验证搜索结果</span>
    title = driver.title
    <span class="hljs-keyword">if</span> <span class="hljs-string">"软件测试"</span> <span class="hljs-keyword">in</span> title:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"✅ 测试通过：搜索结果包含关键词"</span>)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"❌ 测试失败：搜索结果不包含关键词"</span>)
      
<span class="hljs-keyword">finally</span>:
    <span class="hljs-comment"># 关闭浏览器</span>
    driver.quit()
</code></pre>
<p><strong>运行结果</strong>：</p>
<pre><code class="hljs">✅ 测试通过：搜索结果包含关键词
</code></pre>
<h4 data-id="heading-11">3. 📊 测试覆盖率："测了多少？还有多少没测？"</h4>
<p>测试覆盖率是衡量测试完整性的指标，常见的覆盖率有：</p>
<ul>
<li>语句覆盖率：执行了多少代码行</li>
<li>分支覆盖率：执行了多少条件分支</li>
<li>路径覆盖率：执行了多少代码路径</li>
</ul>
<h3 data-id="heading-12">📊 趣味对比：手工测试 vs 自动化测试</h3>













































<table><thead><tr><th>对比项</th><th>手工测试</th><th>自动化测试</th></tr></thead><tbody><tr><td><strong>执行速度</strong></td><td>慢（小时级）</td><td>快（分钟级）</td></tr><tr><td><strong>执行成本</strong></td><td>高（人力成本）</td><td>低（一次性编写）</td></tr><tr><td><strong>一致性</strong></td><td>差（容易受情绪影响）</td><td>好（每次都一样）</td></tr><tr><td><strong>覆盖率</strong></td><td>低（只能覆盖有限场景）</td><td>高（可覆盖大量场景）</td></tr><tr><td><strong>重复执行</strong></td><td>疲劳（重复操作容易出错）</td><td>高效（可24小时不间断）</td></tr><tr><td><strong>回归测试</strong></td><td>耗时（每次都要重新执行）</td><td>快捷（一键执行）</td></tr><tr><td><strong>适合场景</strong></td><td>探索性测试、UI细节测试</td><td>回归测试、性能测试、安全测试</td></tr></tbody></table>
<h3 data-id="heading-13">🏢 软件测试的类型：从功能到安全</h3>
<p>软件测试有很多类型，被称为"测试家族"：</p>















































<table><thead><tr><th>测试类型</th><th>测试内容</th><th>比喻</th><th>例子</th></tr></thead><tbody><tr><td><strong>功能测试</strong></td><td>软件的功能是否正常</td><td>检查汽车能不能开</td><td>登录、注册、下单功能测试</td></tr><tr><td><strong>性能测试</strong></td><td>软件的响应速度和稳定性</td><td>测试汽车的加速性能和最高时速</td><td>并发用户测试、负载测试</td></tr><tr><td><strong>安全测试</strong></td><td>软件的安全性</td><td>检查汽车的防盗系统</td><td>渗透测试、漏洞扫描</td></tr><tr><td><strong>兼容性测试</strong></td><td>软件在不同环境下的表现</td><td>测试汽车在不同路况的表现</td><td>不同浏览器、不同设备测试</td></tr><tr><td><strong>回归测试</strong></td><td>代码改动后是否引入新bug</td><td>汽车维修后是否正常运行</td><td>每次代码发布前的测试</td></tr><tr><td><strong>用户体验测试</strong></td><td>软件的易用性</td><td>测试汽车的驾驶体验</td><td>界面美观度、操作流畅度测试</td></tr></tbody></table>
<h3 data-id="heading-14">🎮 软件测试的神奇应用场景</h3>
<h4 data-id="heading-15">1. 🛒 电商平台："双11"的保障</h4>
<p>电商平台在"双11"期间，会面临海量用户访问和订单处理。软件测试人员需要提前进行压力测试，确保系统能承受峰值流量。</p>
<p><strong>数据支撑</strong>：2023年天猫双11，每秒处理订单量超过58万笔，这背后离不开严格的性能测试！</p>
<h4 data-id="heading-16">2. 🏥 医疗软件："人命关天"</h4>
<p>医疗软件的bug可能危及生命。测试人员需要进行严格的功能测试和安全测试，确保软件的准确性和可靠性。</p>
<h4 data-id="heading-17">3. 🚗 自动驾驶："零容忍bug"</h4>
<p>自动驾驶软件的每一个bug都可能导致事故。测试人员需要模拟各种场景，确保软件在极端情况下也能正常工作。</p>
<h3 data-id="heading-18">⚠️ 常见误区纠正</h3>
<h4 data-id="heading-19">1. "软件测试就是找bug？"</h4>
<p>不！软件测试不仅是找bug，还包括验证需求、改进质量、降低风险等多个方面。</p>
<h4 data-id="heading-20">2. "测试可以发现所有bug？"</h4>
<p>不！软件测试只能降低bug的概率，不能保证100%没有bug。这就像"体检不能发现所有疾病"一样。</p>
<h4 data-id="heading-21">3. "自动化测试可以替代手工测试？"</h4>
<p>不！自动化测试和手工测试是互补的。自动化适合重复、规则的测试，手工适合探索性、创造性的测试。</p>
<h4 data-id="heading-22">4. "测试应该在开发完成后进行？"</h4>
<p>不！测试应该贯穿整个软件开发周期，从需求阶段就开始介入，越早发现问题，修复成本越低。</p>
<p><strong>数据支撑</strong>：需求阶段发现的bug，修复成本是生产环境的1/100；编码阶段发现的bug，修复成本是生产环境的1/10。</p>
<h3 data-id="heading-23">🔮 未来展望：软件测试的发展趋势</h3>
<h4 data-id="heading-24">1. 🧠 AI驱动的测试</h4>
<p>AI将融入测试的各个环节，包括自动生成测试用例、智能预测bug、自动修复简单bug等。</p>
<h4 data-id="heading-25">2. 📱 移动优先测试</h4>
<p>随着移动互联网的发展，移动应用测试将成为主流，包括跨平台测试、设备兼容性测试等。</p>
<h4 data-id="heading-26">3. ☁️ 云测试平台</h4>
<p>云测试平台将越来越普及，提供大量真实设备和环境，方便测试人员进行各种场景的测试。</p>
<h4 data-id="heading-27">4. 🔒 安全测试常态化</h4>
<p>随着网络安全问题的日益严重，安全测试将成为软件测试的必备环节，融入到开发的各个阶段。</p>
<h3 data-id="heading-28">🎓 互动小测验：你答对了吗？</h3>



































<table><thead><tr><th>问题</th><th>答案</th><th>你答对了吗？</th></tr></thead><tbody><tr><td>软件测试的本质是什么？</td><td>验证软件质量的过程</td><td>✅/❌</td></tr><tr><td>自动化测试比手工测试快多少倍？</td><td>10倍以上</td><td>✅/❌</td></tr><tr><td>需求阶段发现bug的修复成本是生产环境的多少？</td><td>1/100</td><td>✅/❌</td></tr><tr><td>自动化测试适合哪种场景？</td><td>回归测试</td><td>✅/❌</td></tr><tr><td>AI在软件测试中的应用包括什么？</td><td>自动生成测试用例</td><td>✅/❌</td></tr></tbody></table>
<h3 data-id="heading-29">🎯 结语：软件测试是质量的保障</h3>
<p>软件测试就像"质量守门员"，在软件发布前把好最后一道关。没有软件测试，就没有高质量的软件；没有自动化测试，就没有快速迭代的互联网产品。</p>
<p>下次使用软件时，不妨想想背后有多少测试人员在默默付出，确保你有良好的使用体验！</p>
<hr/>
<h3 data-id="heading-30">💬 互动话题</h3>
<ol>
<li>你遇到过最糟心的软件bug是什么？</li>
<li>你觉得自动化测试会完全替代手工测试吗？</li>
<li>你对AI驱动的测试有什么期待？</li>
</ol>
<p>快来评论区聊聊你的想法！💬 点赞收藏不迷路，咱们下期继续探索计算机的"十万个为什么"！🎉</p>
<p><strong>关注我</strong>，下期带你解锁更多计算机的"奇葩冷知识"！🤓</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再踩 Stream 的坑了！Java 函数式编程安全指南]]></title>    <link>https://juejin.cn/post/7586306813727473674</link>    <guid>https://juejin.cn/post/7586306813727473674</guid>    <pubDate>2025-12-22T09:12:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586306813727473674" data-draft-id="7586338196301594670" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再踩 Stream 的坑了！Java 函数式编程安全指南"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-12-22T09:12:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="sino爱学习"/> <meta itemprop="url" content="https://juejin.cn/user/1873223544473431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再踩 Stream 的坑了！Java 函数式编程安全指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1873223544473431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    sino爱学习
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T09:12:32.000Z" title="Mon Dec 22 2025 09:12:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"/>
<blockquote>
<p><strong>目标</strong>：确保 Stream 使用安全、可读、可维护，避免空指针、重复 key、边界问题、并发隐患等常见坑。Stream 提供了优雅的函数式编程方式，但不当使用容易引入隐蔽 bug。团队统一规范是关键。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">一、空集合与边界条件处理</h3>
<h4 data-id="heading-2">1. <code>allMatch</code> / <code>anyMatch</code> / <code>noneMatch</code></h4>
<ul>
<li><strong>规范</strong>：空集合时，<code>allMatch</code> 和 <code>noneMatch</code> 返回 <strong>true</strong>，<code>anyMatch</code> 返回 <strong>false</strong>。如果业务语义上空集合应视为“不成立”或需特殊处理，<strong>必须显式判空</strong>。</li>
<li><strong>示例</strong></li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 错误：空列表时返回 true，可能误导业务（如“所有人都成年”）</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">allAdult</span> <span class="hljs-operator">=</span> list.stream().allMatch(p -&gt; p.getAge() &gt;= <span class="hljs-number">18</span>);

<span class="hljs-comment">// 推荐：显式处理空集合</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">allAdult</span> <span class="hljs-operator">=</span> list.isEmpty() ? <span class="hljs-literal">false</span> : list.stream()
    .allMatch(p -&gt; p.getAge() &gt;= <span class="hljs-number">18</span>);

<span class="hljs-comment">// 或者使用 anyMatch 的场景</span>
<span class="hljs-type">boolean</span> <span class="hljs-variable">hasMinor</span> <span class="hljs-operator">=</span> !list.isEmpty() &amp;&amp; list.stream().anyMatch(p -&gt; p.getAge() &lt; <span class="hljs-number">18</span>);
</code></pre>
<ul>
<li><strong>原因</strong>：vacuous truth（空集真理）导致逻辑偏差。实际项目中常因忽略空集合而埋下 bug。</li>
</ul>
<h4 data-id="heading-3">2. <code>findFirst</code> / <code>findAny</code> 与 null 元素</h4>
<ul>
<li><strong>规范</strong>：Stream 中可能包含 null 元素时，<strong>必须先过滤 null</strong>，否则在排序、比较或 Optional 处理时可能 NPE。</li>
<li><strong>示例</strong></li>
</ul>
<pre><code class="hljs language-java" lang="java">Optional&lt;Person&gt; firstPerson = list.stream()
    .filter(Objects::nonNull)  <span class="hljs-comment">// 先过滤 null</span>
    .findFirst();
</code></pre>
<ul>
<li><strong>原因</strong>：<code>findFirst()</code> 返回 Optional，但后续操作（如 comparator）遇到 null 会抛 NPE。</li>
</ul>
<hr/>
<h3 data-id="heading-4">二、<code>Collectors.toMap()</code> 安全使用</h3>
<h4 data-id="heading-5">1. key / value 不允许 null</h4>
<ul>
<li><strong>规范</strong>：<code>Collectors.toMap()</code> 对 key 或 value 为 null 会抛 <strong>NullPointerException</strong>。必须提前过滤或提供默认值。</li>
<li><strong>示例</strong></li>
</ul>
<pre><code class="hljs language-java" lang="java">Map&lt;String, String&gt; map = list.stream()
    .filter(p -&gt; p.getName() != <span class="hljs-literal">null</span> &amp;&amp; p.getSex() != <span class="hljs-literal">null</span>)  <span class="hljs-comment">// 过滤 null</span>
    .collect(Collectors.toMap(
        Person::getName,
        p -&gt; Objects.requireNonNullElse(p.getSex(), <span class="hljs-string">"未知"</span>),
        (v1, v2) -&gt; v1  <span class="hljs-comment">// 合并函数，必备</span>
    ));
</code></pre>
<ul>
<li><strong>原因</strong>：HashMap 的 merge 方法不允许 null value（尽管 HashMap 本身允许）。</li>
</ul>
<h4 data-id="heading-6">2. duplicate key 处理</h4>
<ul>
<li><strong>规范</strong>：<strong>始终提供 merge function</strong>，即使当前数据无重复，也要显式定义策略（保留第一个/最后一个/合并/抛异常）。</li>
<li><strong>示例</strong></li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 保留第一个</span>
.collect(Collectors.toMap(Person::getId, Function.identity(), (existing, replacement) -&gt; existing));

<span class="hljs-comment">// 保留最后一个</span>
.collect(Collectors.toMap(Person::getId, Function.identity(), (existing, replacement) -&gt; replacement));

<span class="hljs-comment">// 合并（如求和）</span>
.collect(Collectors.toMap(Person::getId, Person::getScore, Integer::sum));
</code></pre>
<ul>
<li><strong>原因</strong>：无 merge function 时，duplicate key 抛 <strong>IllegalStateException</strong>。并行流下更易触发。</li>
</ul>
<h4 data-id="heading-7">3. 并行场景补充</h4>
<ul>
<li><strong>规范</strong>：并行流下建议使用 <code>Collectors.toConcurrentMap()</code> 以获得线程安全 Map。</li>
</ul>
<hr/>
<h3 data-id="heading-8">三、Optional 的使用规范</h3>
<h4 data-id="heading-9">1. <code>map</code> vs <code>flatMap</code></h4>
<ul>
<li><strong>规范</strong>：
<ul>
<li>字段不可能 null → 用 <code>map</code></li>
<li>字段可能 null → 用 <code>flatMap(Optional.ofNullable(...))</code></li>
</ul>
</li>
<li><strong>示例</strong></li>
</ul>
<pre><code class="hljs language-java" lang="java">Optional&lt;String&gt; sexOpt = optionalPerson
    .flatMap(p -&gt; Optional.ofNullable(p.getSex()));  <span class="hljs-comment">// 安全处理 null 字段</span>

Optional&lt;Integer&gt; ageOpt = optionalPerson
    .map(Person::getAge);  <span class="hljs-comment">// age 不为 null</span>
</code></pre>
<h4 data-id="heading-10">2. 避免盲用 <code>get()</code></h4>
<ul>
<li><strong>规范</strong>：<strong>禁止直接调用 <code>get()</code></strong> 无判断。优先 <code>orElse</code> / <code>orElseGet</code> / <code>orElseThrow</code>。</li>
<li><strong>示例</strong></li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">sex</span> <span class="hljs-operator">=</span> sexOpt.orElse(<span class="hljs-string">"未知"</span>);
<span class="hljs-type">String</span> <span class="hljs-variable">sex</span> <span class="hljs-operator">=</span> sexOpt.orElseGet(() -&gt; computeDefaultSex());
</code></pre>
<hr/>
<h3 data-id="heading-11">四、map / peek / forEach 的副作用规范</h3>
<h4 data-id="heading-12">1. <code>map</code></h4>
<ul>
<li><strong>用途</strong>：纯转换元素，返回新值。</li>
<li><strong>规范</strong>：<strong>禁止在 map 中产生副作用</strong>（如修改原对象、IO、日志）。</li>
<li><strong>示例</strong></li>
</ul>
<pre><code class="hljs language-java" lang="java">List&lt;Integer&gt; ages = list.stream()
    .map(Person::getAge)  <span class="hljs-comment">// 纯转换</span>
    .toList();
</code></pre>
<h4 data-id="heading-13">2. <code>peek</code></h4>
<ul>
<li><strong>用途</strong>：<strong>仅用于调试或日志</strong>，观察中间元素。</li>
<li><strong>规范</strong>：
<ul>
<li><strong>禁止在 peek 中修改元素或外部状态</strong>（副作用）。</li>
<li>并行流中 peek 执行顺序不可控，可能被优化掉（Java 9+）。</li>
</ul>
</li>
<li><strong>示例</strong></li>
</ul>
<pre><code class="hljs language-java" lang="java">list.stream()
    .filter(p -&gt; p.getAge() &gt; <span class="hljs-number">18</span>)
    .peek(p -&gt; System.out.println(<span class="hljs-string">"过滤后: "</span> + p))  <span class="hljs-comment">// 仅调试</span>
    .map(Person::getName)
    .toList();
</code></pre>
<h4 data-id="heading-14">3. <code>forEach</code></h4>
<ul>
<li><strong>规范</strong>：终端操作，仅用于最终消费。避免复杂业务逻辑。</li>
</ul>
<hr/>
<h3 data-id="heading-15">五、并行流（parallelStream）使用规范</h3>
<ul>
<li><strong>规范</strong>：
<ul>
<li><strong>仅限 CPU 密集型、纯计算、无副作用、无状态的任务</strong>（如大数据量数值计算）。</li>
<li><strong>禁止</strong> 用于 IO、DB、RPC、锁操作或有副作用的场景。</li>
<li>确保操作 stateless（无共享可变状态）和 non-interfering（不修改源）。</li>
<li>数据结构引用局部性好（如原始数组）时收益更高；链表等差。</li>
</ul>
</li>
<li><strong>示例</strong></li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 适合：纯计算</span>
<span class="hljs-type">long</span> <span class="hljs-variable">sum</span> <span class="hljs-operator">=</span> longList.parallelStream().reduce(<span class="hljs-number">0L</span>, Long::sum);

<span class="hljs-comment">// 不适合：IO 操作</span>
list.parallelStream().forEach(<span class="hljs-built_in">this</span>::saveToDb);  <span class="hljs-comment">// 禁止！</span>
</code></pre>
<ul>
<li><strong>原因</strong>：副作用导致数据竞争、不可预测结果；开销大时性能反而下降。</li>
</ul>
<hr/>
<h3 data-id="heading-16">六、空指针防御通用模式</h3>
<ol>
<li>Stream 元素可能 null → <code>filter(Objects::nonNull)</code></li>
<li>字段可能 null → <code>Optional.ofNullable</code> + <code>flatMap</code> / <code>orElse</code></li>
<li>集合空 → 判空或用 <code>Stream.ofNullable</code>（Java 9+）</li>
<li><code>toMap</code> key/value → 过滤或兜底 + merge function</li>
<li>短路操作（如 <code>findFirst</code>）返回 Optional → 安全消费</li>
</ol>
<hr/>
<h3 data-id="heading-17">七、可读性与可维护性</h3>
<ul>
<li>链式调用不超过 <strong>4-5 个操作</strong>，否则拆分成独立方法或使用中间变量。</li>
<li>复杂逻辑优先用传统 for 循环，Stream 仅用于简单数据转换/聚合。</li>
<li><strong>必须添加注释</strong> 说明边界处理（如空集合、null、duplicate key）。</li>
<li>优先使用不可变对象和纯函数风格。</li>
<li>代码审查重点检查：副作用、并行流使用、merge function 是否缺失。</li>
</ul>
<hr/>
<h3 data-id="heading-18">八、总结（团队执行要点）</h3>
<ol>
<li><strong>空集合/null 元素/字段</strong> → 永远防御，不过度信任 Stream 默认行为。</li>
<li><strong>toMap/toConcurrentMap</strong> → 必提供 merge function，防御 null 和 duplicate。</li>
<li><strong>Optional</strong> → 禁止盲 get()，善用 flatMap/orElse。</li>
<li><strong>map/peek/forEach</strong> → map 无副作用，peek 仅调试，forEach 仅终端消费。</li>
<li><strong>parallelStream</strong> → 严格限定场景，避免副作用和 IO。</li>
<li><strong>可读性</strong> → 短链、注释、优先传统循环处理复杂逻辑。</li>
</ol>
<blockquote>
<p>Stream 优雅强大，但“优雅”不等于“安全”。团队规范是避免坑的最后防线，违反规范等于自埋雷区。定期审查 Stream 代码，养成防御式编程习惯！</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[C++团队的流式系统之路：从学习成本到实战策略]]></title>    <link>https://juejin.cn/post/7586482860103417883</link>    <guid>https://juejin.cn/post/7586482860103417883</guid>    <pubDate>2025-12-22T09:25:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586482860103417883" data-draft-id="7586338196301692974" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="C++团队的流式系统之路：从学习成本到实战策略"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-12-22T09:25:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="自由生长2024"/> <meta itemprop="url" content="https://juejin.cn/user/1591748569862670"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            C++团队的流式系统之路：从学习成本到实战策略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1591748569862670/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    自由生长2024
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T09:25:29.000Z" title="Mon Dec 22 2025 09:25:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>摘要：在实时数据处理领域，流式系统已成为现代架构的基石。对于C++团队而言，流式系统的选型和构建始终伴随着<strong>学习成本</strong>、<strong>构建成本</strong>和<strong>性能</strong>的权衡。本文旨在探讨C++团队如何在这些挑战中找到平衡点。</p>
<hr/>
<h2 data-id="heading-0">C++团队的流式系统之路：从学习成本到实战策略</h2>
<h3 data-id="heading-1">一、学习成本：从“简单上手”到“深度掌控”</h3>
<h4 data-id="heading-2">1. Java生态的“开箱即用” vs C++的“碎片化工具链”</h4>























<table><thead><tr><th>语言生态</th><th>学习曲线</th><th>核心优势</th><th>典型代表</th></tr></thead><tbody><tr><td><strong>Java</strong></td><td>中等偏上</td><td>完整的流处理抽象（窗口、状态、容错）</td><td>Apache Flink</td></tr><tr><td><strong>C++</strong></td><td>极高</td><td>贴近硬件、极致性能</td><td>Kafka + librdkafka</td></tr></tbody></table>
<blockquote>
<p><code>librdkafka</code> 这个名字中的 <strong>“rd”</strong> ，其实是作者 <strong>Eden Hill</strong>（该项目的创建者和主要维护者）在早期开发的一系列开源项目中使用的命名前缀，有一种广为接受的说法是： <strong>“rd” 是 “Realtime Data” 的缩写</strong>，因为这些工具主要用于实时数据处理。虽然 Eden Hill 本人没有在官方文档中明确说明，但社区普遍接受这一解释。</p>
</blockquote>
<p>C++实际工作环境的很多基建都是拼搭的，并没有很出名的名字，不信你可以观察看看，所以大多功能也都是按需开发的，项目也比较小，比较专用，大一统的业务项目比较少。</p>
<p><strong>C++团队的困境</strong>：</p>
<ul>
<li>没有“一站式”流处理框架（如Flink），需拼接多个工具（如Kafka、Redis、自定义逻辑）。</li>
<li>需手动实现核心机制（如Exactly-Once、Watermark），学习成本陡峭。</li>
</ul>
<p><strong>典型场景</strong>：</p>
<ul>
<li>一位C++工程师用 <code>librdkafka</code> 实现点击计数，却发现：
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 原始代码：简单Map计数</span>
std::map&lt;std::string, <span class="hljs-type">int</span>&gt; user_clicks;
<span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; event : events) {
    user_clicks[event.userId]++;
}
</code></pre>
但很快遇到问题：
<ul>
<li><strong>状态持久化</strong>：如何定期保存？（需自己实现 WAL 或 Redis）</li>
<li><strong>去重</strong>：如何处理重复事件？（需维护 event_id 去重表）</li>
<li><strong>窗口管理</strong>：如何清理过期数据？（需遍历 Map 判断时间戳）</li>
</ul>
</li>
</ul>
<blockquote>
<p><strong>结论</strong>：C++团队在“简单需求”上看似轻松，但一旦涉及复杂语义，学习成本远高于 Java 流式框架。</p>
</blockquote>
<hr/>
<h4 data-id="heading-3">2. 混合架构的“渐进式学习”策略</h4>
<p>C++团队常采用“分层学习”策略：</p>
<ol>
<li><strong>先用 Kafka + librdkafka</strong>：熟悉消息消费、生产流程。</li>
<li><strong>再接入 Flink</strong>：用 Flink SQL 处理复杂逻辑（如窗口聚合）。</li>
<li><strong>逐步自研核心模块</strong>：仅在关键路径（如高频交易规则）替换为 C++。</li>
</ol>
<p>如果所有工具都是纯血C++，自己手搓，那么公司得花多少钱养这么些人呢？</p>
<p>以大数据基建为例：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[学习阶段] --&gt; B[Kafka基础]
    B --&gt; C[Flink高级]
    C --&gt; D[自研模块]
</code></pre>
<hr/>
<h3 data-id="heading-4">二、构建成本：自研 vs 现成框架的经济账</h3>
<h4 data-id="heading-5">1. 自研流式系统的代价</h4>






























<table><thead><tr><th>维度</th><th>自研成本</th><th>现成框架（如 Flink）</th></tr></thead><tbody><tr><td>开发时间</td><td>数月到数年</td><td>几小时（SQL即可）</td></tr><tr><td>功能完整性</td><td>需手动实现 Exactly-Once、Watermark、Checkpoint</td><td>开箱即用</td></tr><tr><td>维护成本</td><td>永久性投入</td><td>社区支持 + 文档完善</td></tr><tr><td>性能优化</td><td>需精细调优（SIMD、内存池）</td><td>JVM 优化成熟</td></tr></tbody></table>
<p><strong>真实案例</strong>：</p>
<ul>
<li>某金融公司曾尝试自研流式引擎，耗时 18 个月，最终因无法处理“事件时间窗口”和“Exactly-Once”而放弃，转回 Flink。</li>
</ul>
<h4 data-id="heading-6">2. 混合架构的“低成本高收益”模式</h4>

























<table><thead><tr><th>层级</th><th>技术选型</th><th>作用</th></tr></thead><tbody><tr><td><strong>核心层</strong></td><td>C++ + Kafka</td><td>微秒级处理（如风控规则）</td></tr><tr><td><strong>通用层</strong></td><td>Flink</td><td>聚合、关联、存储</td></tr><tr><td><strong>解耦层</strong></td><td>Kafka</td><td>消息缓冲与数据格式转换</td></tr></tbody></table>
<p><strong>优势</strong>：</p>
<ul>
<li><strong>C++只处理关键路径</strong>：如“1秒内同一IP登录失败超过100次”，其他逻辑由 Flink 处理。</li>
<li><strong>避免重复造轮子</strong>：C++团队无需重写窗口、状态管理等通用功能。</li>
</ul>
<hr/>
<h3 data-id="heading-7">三、C++团队的实战策略：从工具到哲学</h3>
<h4 data-id="heading-8">1. 工具选型：C++ + Kafka 的黄金组合</h4>
<p><strong>librdkafka</strong> 是 C++ 团队的首选，其优势在于：</p>
<ul>
<li><strong>性能</strong>：比 Java Kafka 客户端快 30%+（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fedenhill%2Flibrdkafka%2Fwiki%2FPerformance" target="_blank" title="https://github.com/edenhill/librdkafka/wiki/Performance" ref="nofollow noopener noreferrer">基准测试</a>）。</li>
<li><strong>灵活性</strong>：支持回调式消费，可深度定制处理逻辑。</li>
<li><strong>轻量</strong>：无需 JVM，适合资源受限环境。</li>
</ul>
<p><strong>代码示例</strong>：C++ 实现点击计数（简化版）</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;librdkafka/rdkafkacpp.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unordered_map&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ClickCounter</span> : <span class="hljs-keyword">public</span> RdKafka::MessageHandler {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">msg_consume</span><span class="hljs-params">(RdKafka::Message* msg)</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-keyword">auto</span> event = <span class="hljs-built_in">parse_event</span>(msg-&gt;<span class="hljs-built_in">payload</span>());
        <span class="hljs-keyword">auto</span>&amp; count = user_clicks[event.userId];
        count++;
        <span class="hljs-keyword">if</span> (count &gt;= threshold) {
            <span class="hljs-built_in">trigger_alert</span>(event.userId);
        }
    }

<span class="hljs-keyword">private</span>:
    std::unordered_map&lt;std::string, <span class="hljs-type">int</span>&gt; user_clicks;
    <span class="hljs-type">int</span> threshold = <span class="hljs-number">100</span>;
};
</code></pre>
<p><strong>局限性</strong>：</p>
<ul>
<li><strong>无状态一致性</strong>：服务重启后计数归零。</li>
<li><strong>无自动去重</strong>：需自行实现 event_id 去重逻辑。</li>
</ul>
<hr/>
<h4 data-id="heading-9">2. 性能优化：C++ 的“最后一公里”</h4>
<p>C++ 团队在极端性能场景下的优化技巧：</p>






























<table><thead><tr><th>优化点</th><th>实现方式</th><th>效果</th></tr></thead><tbody><tr><td><strong>零拷贝</strong></td><td><code>mmap</code> + <code>sendfile</code></td><td>减少 CPU 占用 20%~30%</td></tr><tr><td><strong>内存池</strong></td><td>自定义内存池分配器</td><td>避免频繁内存申请</td></tr><tr><td><strong>SIMD 加速</strong></td><td>使用 <code>__m256</code> 指令集</td><td>批量处理速度提升 3~5 倍</td></tr><tr><td><strong>批处理</strong></td><td>将小事件聚合成批次</td><td>减少 I/O 次数</td></tr></tbody></table>
<p><strong>真实案例</strong>：某电信公司的 C++ 流处理引擎</p>
<ul>
<li>使用 SIMD 优化用户行为评分逻辑，将单用户处理时间从 2ms 降至 0.4ms。</li>
<li>通过内存池减少 GC 压力（尽管 C++ 无 GC，但频繁 <code>new/delete</code> 仍会导致碎片化）。</li>
</ul>
<hr/>
<h3 data-id="heading-10">四、C++团队的哲学：务实与妥协的艺术</h3>
<h4 data-id="heading-11">1. <strong>不要为“高性能”牺牲可维护性</strong></h4>
<ul>
<li><strong>错误做法</strong>：为追求微秒级延迟，完全放弃框架，手动实现所有逻辑。</li>
<li><strong>正确做法</strong>：用 C++ 优化关键路径，其他部分交给成熟框架。</li>
</ul>
<h4 data-id="heading-12">2. <strong>混合架构是 C++ 团队的生存之道</strong></h4>
<ul>
<li><strong>C++ 做“刀刃”</strong>：处理毫秒级响应、高频事件。</li>
<li><strong>Flink 做“底盘”</strong>：负责复杂计算、状态管理、容错恢复。</li>
</ul>
<h4 data-id="heading-13">3. <strong>性能优化要“适度”</strong></h4>
<ul>
<li><strong>过度优化</strong>：为节省 1ms 增加 10 倍代码复杂度，得不偿失。</li>
<li><strong>合理取舍</strong>：用 Flink 的 <code>TUMBLE</code> 窗口代替手动时间管理，节省数周开发时间。</li>
</ul>
<hr/>
<h3 data-id="heading-14">五、结语：C++ 团队的流式系统之道</h3>
<p>C++ 团队在流式系统领域的挑战，本质上是 <strong>“极致性能”与“工程效率”</strong> 的博弈。通过以下策略，可以找到最佳平衡点：</p>
<ol>
<li><strong>优先使用 Kafka + librdkafka</strong>：快速构建基础流处理能力。</li>
<li><strong>混合架构分层设计</strong>：C++ 处理关键路径，Flink 处理通用逻辑。</li>
<li><strong>只在必要时自研</strong>：避免重复造轮子，聚焦业务价值。</li>
<li><strong>性能优化适度</strong>：用工具链解决 80% 问题，留 20% 给 C++ 优化。</li>
</ol>
<blockquote>
<p><strong>最终结论</strong>：<br/>
C++ 团队不是在“对抗 Java 生态”，而是在用 C++ 的“手术刀”解决流处理中的“硬骨头”。真正的高手，是懂得何时“用框架”，何时“动手写”的务实派。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 3.38 30天发6个版本，Google 程序员的头发还好吗？]]></title>    <link>https://juejin.cn/post/7586493936676814888</link>    <guid>https://juejin.cn/post/7586493936676814888</guid>    <pubDate>2025-12-22T09:24:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586493936676814888" data-draft-id="7586482851103211555" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 3.38 30天发6个版本，Google 程序员的头发还好吗？"/> <meta itemprop="keywords" content="Flutter,客户端"/> <meta itemprop="datePublished" content="2025-12-22T09:24:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员老刘"/> <meta itemprop="url" content="https://juejin.cn/user/662360127965769"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 3.38 30天发6个版本，Google 程序员的头发还好吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/662360127965769/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员老刘
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T09:24:45.000Z" title="Mon Dec 22 2025 09:24:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>大家好，我是老刘</strong></p>
<p>最近如果你盯着 Flutter 的 release 页面会发现，从 11月12日 到 12月11日，短短 30 天内，Flutter 官方竟然一口气更新了 6 个版本！</p>
<p>平均 5 天一个版本，最夸张的时候，两个补丁版本的间隔甚至不到 24 小时。比我提交代码到 dev 分支还要勤快。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/533f81aeb799437194ee5109a52ce2e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6ICB5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767000284&amp;x-signature=U8U1H0dCgyK38kehPgyYFctqoLU%3D" alt="" loading="lazy"/></p>
<p>看着 3.38.x 的版本号一路狂飙，真心想问问：Google 程序员的头发还好吗？</p>
<h2 data-id="heading-0">这些版本到底修了啥？</h2>
<p>下面整理了 Flutter 3.38 各个小版本的更新内容</p>
<h3 data-id="heading-1">Flutter 3.38.5</h3>
<p><strong>发布日期</strong> ：2025年12月13日<br/>
<strong>修复内容</strong> ：</p>
<ul>
<li>flutter/179700 ：将 Dart SDK 更新至 3.10.4 版本。</li>
</ul>
<h3 data-id="heading-2">Flutter 3.38.4</h3>
<p><strong>发布日期</strong> ：2025年12月5日<br/>
<strong>修复内容</strong> ：</p>
<ul>
<li>flutter/178547 ：修复 Linux 桌面端使用 Skia 渲染器时的渲染问题。</li>
<li>flutter/178529 ：修复运行 debug web 时 AppLocalizations 被意外删除的问题。</li>
<li>flutter/178660 ：修复当 .dart_tool 目录结构不完整时， flutter widget-preview start 崩溃的问题。</li>
<li>flutter/175227 ：修复 Flutter Web 应用在 Chrome 中启动时显示 --no-sandbox 警告的问题。</li>
<li>flutter/179155 ：修复项目外部 pubspec.yaml 变动导致 Widget Previewer 崩溃的问题。</li>
<li>flutter/156692 ：修复目标应用意外断开连接导致 flutter attach 崩溃的问题。</li>
<li>flutter/179008 ：修复 macOS 上根项目运行 pub get 后，外部 pubspec.yaml 变动导致重复 spawn pub get 的问题。</li>
<li>flutter/178715 ：修复 Linux/macOS 上缺少桌面工具时，对 Android 项目运行 flutter test 失败的问题。</li>
</ul>
<h3 data-id="heading-3">Flutter 3.38.3</h3>
<p><strong>发布日期</strong> ：2025年11月22日<br/>
<strong>修复内容</strong> ：</p>
<ul>
<li>flutter/178772 ：修复 Flutter Engine 报告的版本号与 Framework 版本不一致的问题。</li>
<li>flutter/178804 ：将 Dart SDK 更新至 3.10.1 版本。</li>
</ul>
<h3 data-id="heading-4">Flutter 3.38.2</h3>
<p><strong>发布日期</strong> ：2025年11月19日<br/>
<strong>修复内容</strong> ：</p>
<ul>
<li>flutter/178472 ：修复分析 Dart 文件变更过程中退出 Widget Previewer 导致崩溃的问题。</li>
<li>flutter/178452 ：修复 add-to-app 场景下 iOS 构建报错 "Improperly formatted define flag" 的问题。</li>
<li>flutter/178486 ：修复禁用 Web 支持时启动 Widget Previewer 抛出异常的问题。</li>
<li>flutter/178317 ：修复插件依赖变更时运行 flutter pub get 导致 Widget Previewer 崩溃的问题。</li>
<li>flutter/178318 ：修复单一进程崩溃提交多个崩溃报告的问题。</li>
<li>flutter/176399 ：修复编译 Windows 桌面应用时不支持 Visual Studio 2026 的问题。</li>
<li>flutter/175058 ：修复目标项目未运行 pub get 时 Widget Previewer 启动失败的问题。</li>
<li>flutter/178421 ：修复 IDE 调试物理 iOS 26 设备时应用启动卡白屏的问题。</li>
</ul>
<h3 data-id="heading-5">Flutter 3.38.1</h3>
<p><strong>发布日期</strong> ：2025年11月14日<br/>
<strong>修复内容</strong> ：</p>
<ul>
<li>flutter/178400 ：正式添加对 Dart 3.10 stable 版本的支持。</li>
</ul>
<h3 data-id="heading-6">Flutter 3.38.0</h3>
<p><strong>发布日期</strong> ：2025年11月13日</p>
<ul>
<li>初始稳定版本发布 ：包含该周期的所有新特性（如对 iOS 26 的支持、Dart 3.10 新语法支持、Widget Previewer 改进等）。</li>
</ul>
<p><strong>总结一下</strong></p>
<p>这一个月，Flutter 团队基本上就是在<strong>修 Widget Previewer -&gt; 升 Dart -&gt; 修各平台兼容性</strong>这个循环里狂奔。</p>
<hr/>
<h2 data-id="heading-7">Flutter 3.38还处于观察期</h2>
<p>老刘之前在很多场合都反复强调过一个“防坑指南”：<strong>一个新的 Flutter 版本发布后，至少要观察两个月，等它基本稳定了，没有什么大问题了，再考虑升级。</strong></p>
<p>看看 3.38 这一个月的表现，完全验证了老刘的这个观点。30 天 6 个版本，这频率虽然感人，但也意味着这个版本目前还非常不稳定。尤其是这次更新涉及到了Dart SDK 的升级，很容易牵一发而动全身。</p>
<p>对于我们在公司里维护的商业项目，<strong>稳定永远是第一位的</strong>。你抢先升级，大概率会遇到各种编译失败、工具崩溃（比如上面提到的 Previewer 各种崩）、甚至运行时的诡异 Bug。到时候为了修这些非业务逻辑的 Bug，加班掉头发的可是你自己。</p>
<p>所以，老刘真心建议：<strong>先别动</strong>。让 3.38 再“飞”一会儿。等它发到 3.38.8 甚至出了 3.39，社区里的坑都被填得差不多了，才是我们入场的最佳时机。现在，就静静地看着 Google 的大佬们表演（修 Bug）就好。</p>
<hr/>
<h2 data-id="heading-8">总结：别慌，这是好事（大概）</h2>
<p>看到这里，可能很多同学心里会犯嘀咕：Google 这么着急发版，是不是 Flutter 要凉或者质量不行？</p>
<p>其实大可不必惊慌。老刘觉得，这反而是好事。</p>
<p>熟悉 Flutter 的老朋友都知道，这属于“传统保留节目”了。</p>
<p>几乎每一个大版本发布后，都会紧跟着一串小补丁，这恰恰说明 Google 依然在重兵投入 Flutter，发现问题解决问题的速度极快。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae9a2e4252974365b8ca477615c56c16~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6ICB5YiY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1767000284&amp;x-signature=1aPljVTh8W9%2F30vFxBZcLmD795Y%3D" alt="3.16出了9个小版本" loading="lazy"/></p>
<p>毕竟，只有亲儿子才会得到如此细致（虽然有点急躁）的照料，没人会给弃子这么勤快地修 Bug。</p>
<p>所以，看着版本号飙升，我们应该感到欣慰。</p>
<p>这每一个版本号背后，都是 Google 工程师奋斗的里程碑（和献祭的头发）。</p>
<p>只要 Flutter 还在变好，还在快速迭代，这点头发掉了就掉了罢——反正掉的是他们的，我们坐享其成，挺好。</p>
<blockquote>
<p>如果看到这里的同学对客户端或者Flutter开发感兴趣，欢迎联系老刘，我们互相学习。</p>
<p>私信免费领老刘整理的《Flutter开发手册》，覆盖90%应用开发场景。</p>
<p>可以作为Flutter学习的知识地图。</p>
<p>—— laoliu_dev</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[技术视角下的 Credits 消耗与优化]]></title>    <link>https://juejin.cn/post/7586482851103195171</link>    <guid>https://juejin.cn/post/7586482851103195171</guid>    <pubDate>2025-12-22T09:18:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7586482851103195171" data-draft-id="7586496648378253312" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="技术视角下的 Credits 消耗与优化"/> <meta itemprop="keywords" content="Agent"/> <meta itemprop="datePublished" content="2025-12-22T09:18:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里巴巴AI编程社区"/> <meta itemprop="url" content="https://juejin.cn/user/1757434193132441"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            技术视角下的 Credits 消耗与优化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1757434193132441/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里巴巴AI编程社区
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-22T09:18:36.000Z" title="Mon Dec 22 2025 09:18:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-22
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是 Qoder 团队的夏振华，主要负责 Qoder Agent 相关工作。今天我将从技术角度解释 Qoder 中 Credits 的消耗机制，并分享节省 Credits 的最佳实践。</p>
<h2 data-id="heading-0">一、主流 AI 模型的定价策略</h2>
<p>首先，很多用户对海外模型的定价体系不太了解，所以对 Credits 的消耗“没概念”——比如一个任务为什么会消耗这么多 Credits？</p>
<p>这里以某厂商的两个模型系列为例：</p>
<ul>
<li>O 系列（模型最新）：输入 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>5</mn><mi mathvariant="normal">/</mi><mi>M</mi><mi>T</mi><mi>o</mi><mi>k</mi><mtext>，输出</mtext></mrow><annotation encoding="application/x-tex">5/MTok，输出 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">5/</span><span class="mord mathnormal" style="margin-right:0.13889em;">MT</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord cjk_fallback">，输出</span></span></span></span></span>25/MTok，缓存读取价格 $0.50/MTok。</li>
<li>S 系列（模型次新）：输入 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>3</mn><mi mathvariant="normal">/</mi><mi>M</mi><mi>T</mi><mi>o</mi><mi>k</mi><mtext>，输出</mtext></mrow><annotation encoding="application/x-tex">3/MTok，输出 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">3/</span><span class="mord mathnormal" style="margin-right:0.13889em;">MT</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.03148em;">k</span><span class="mord cjk_fallback">，输出</span></span></span></span></span>15/MTok，缓存读取价格 $0.30/MTok。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fd4f9f6f5804d848ff9d3a39ee3aaac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5be05be0QUnnvJbnqIvnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766999916&amp;x-signature=MQQ1wdGSXTZb2ZtpJ9eRLTAOoSQ%3D" alt="" loading="lazy"/></p>
<p>两个系列的整体定价策略基本类似，但最关键的一点：如果能命中缓存，成本只要 1/10！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f90eb979b67b488fa7168c60e395bb05~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5be05be0QUnnvJbnqIvnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766999916&amp;x-signature=GGdro8tRd64yPGR7mxW6yzGO4BY%3D" alt="" loading="lazy"/></p>
<p>所以，Qoder 做了很多技术策略去优化缓存命中率。而大家在使用时，如果也能用一些能命中缓存的方式，也会非常节省成本。</p>
<h2 data-id="heading-1">二、Qoder Agent 的交互成本构成</h2>
<p>接下来，让我们来看下 Coding Agent 的交互流程与 Token 消耗的情况：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcbe84f999e44aafad17b2e267420527~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5be05be0QUnnvJbnqIvnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766999916&amp;x-signature=PEyj1eGBP5Fe5zRHHrXXzD27jTg%3D" alt="" loading="lazy"/></p>
<ol>
<li><strong>System+Tools</strong><br/>
如果做过 Agent 的开发的同学可能会了解到，我们会给模型一个身份：“你是一个编程专家，擅长 XXX，遇到 XXX 情况要用 XXX 工具”。还会给模型很多工具，例如代码读取、代码编辑、终端执行、Web 检索……如果用了 MCP，也会加进去。</li>
</ol>
<p>这部分一般是可以命中缓存的，在前面的模型下约 $0.3/MTok。</p>
<ol start="2">
<li>
<p><strong>User</strong><br/>
你其实在提问的时候，经常会类似我这里写到的一些用法，比如：“帮我生成一个 to-do APP。”<br/>
你还可能引入文件、图片（比如设计稿截图）、Agents.md、Rules、目录等辅助让 Agent 的生成的更好。这部分是输入，一般会命中到前面讲的那个模型的成本里面的 catch。</p>
</li>
<li>
<p><strong>Action</strong><br/>
然后模型会输出一个一个的 Action，相当于让模型帮我去构建一个 to do APP，那么这个模型可能会说：“我要读 一个文件” 、“我要编辑 一个文件”或 “我要创建一个新文件”。这个其实就是模型的输出，模型的输出是比较贵的，约 $15/MTok。</p>
</li>
<li>
<p><strong>Observation</strong></p>
</li>
</ol>
<p>最后 Qoder 的 Agent 就会通过工具会调用的方式去拿到这个 Action 对应的一个 Observation 的结果。这个结果通过 Catch Write 的方式去请求模型，成本约 $3.75/MTok。</p>
<p>重点来了：你问一个问题，Agent 不是一次就完事的！它会循环调用模型：Action → Observation → Action → Observation……直到任务完成或需要你确认。</p>
<p>所以，一次用户请求 = N 次模型调用 = N 次收费！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/244844b4029945b2b32a443d81c7c72a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5be05be0QUnnvJbnqIvnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766999916&amp;x-signature=%2BFs5sqfzkEfj9%2FNnvD6Uqwz99fo%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">三、Qoder 真实场景成本测算</h2>
<p>一次对话的成本计算公式：​<code>​总成本 = 模型调用次数 × (缓存部分 + 普通输入 + 输出部分)​</code>​。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee94498093284859bf591ad90b651742~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5be05be0QUnnvJbnqIvnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766999916&amp;x-signature=X8nzwLn%2BJpQu7tI77iHMXooc9kc%3D" alt="" loading="lazy"/></p>
<p>一次对话的成本，其实它是由那个模型调用的次数作为这个基数的，就是你调十次那就收十次的钱。如果你问一个你好，Qoder 回一个你好，那可能就只收一次的钱。每一次的话，其实有它的缓存部分，也有没有命中缓存的部分，再加上模型的输出部分，最后加在一起的总成本。</p>
<h3 data-id="heading-3">场景 1：上下文长度对成本的影响</h3>
<ul>
<li>从 100K 上下文开始对话，假设一次任务调用 10 次模型，90%缓存命中率：</li>
</ul>

<ul>
<li>O 系列模型：≈ $1.00/次对话</li>
<li>S 系列模型：≈ $0.59/次对话</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e88a0d97b544dafb1fd3bcdcc038226~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5be05be0QUnnvJbnqIvnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766999916&amp;x-signature=lq4xP30kOElDem59qO0fB9rD69s%3D" alt="" loading="lazy"/></p>
<ul>
<li>同样的任务，从20K上下文开始对话：</li>
</ul>

<ul>
<li>O 系列模型：≈ $0.22/次对话</li>
<li>S 系列模型：≈ $0.13/次对话</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef5ca534b1f044a090f759f8de3fe4d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5be05be0QUnnvJbnqIvnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766999916&amp;x-signature=kjkofs%2BB1fEc9GArcN0e%2Bg49gAQ%3D" alt="" loading="lazy"/></p>
<p>可以看出，从20K上下文开始对话与从100K上下文开始对话相比，可以节省约 78%成本。所以，如果你的新任务和历史对话无关，请务必新开一个窗口！</p>
<p>目前Qoder 支持查看用户的Credits 消耗账单，在真实场景下，我们的单次对话调用大约<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0.1</mn><mtext> </mtext></mrow><annotation encoding="application/x-tex">0.1~</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">0.1</span><span class="mspace nobreak"> </span></span></span></span></span>1，这是正常的 Credits 消耗范围。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c541f00de37f40308769d51623203aa8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5be05be0QUnnvJbnqIvnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766999916&amp;x-signature=zTjUuid77NnJiVHHBRRvv%2B2KuzE%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">场景 2：上下文压缩对成本的影响</h3>
<p>当上下文快达到模型上限（比如 200K）时，必须做压缩。Claude Code 上下文在 160~180K 时的一次压缩成本大约 $0.48。Qoder 做了深度优化，通过智能缓存命中，一次压缩成本节省 84%！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e422243983b24cbb8fc1ecbe2a26676e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5be05be0QUnnvJbnqIvnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766999916&amp;x-signature=m14zyhy7LylvWThp%2F8uWb9mvE9k%3D" alt="" loading="lazy"/></p>
<p>上下文逐论累积，到达阈值压缩，每次模型交互都会有相关的压缩成本。以文件大小影响压缩成本为例：</p>
<ul>
<li>小文件任务：成本 ≈ $0.20，结束时上下文 ≈ 40K</li>
<li>大文件任务：成本 ≈ $0.65，结束时上下文 ≈ 140K</li>
</ul>
<p>结束时上下文大小也会直接影响后续追问成本。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad246738c1904e7d985d4115cfad8192~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5be05be0QUnnvJbnqIvnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766999916&amp;x-signature=l7f2F5D31R1c5lZ93tnjTLxvAo4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-5">四、节省 Credits 的最佳实践</h2>
<h3 data-id="heading-6">1. 无关话题，新开窗口</h3>
<p>避免上下文积累，保持会话简洁，减少 Token 消耗。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c526648922f6495a80856b1ae8e4d9e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5be05be0QUnnvJbnqIvnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766999916&amp;x-signature=45faNrchDhmhw4AXOEJLIx%2BS5Vs%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">2. 明确告知期望行为</h3>
<p>告诉 AI：特定项目不要写测试、不要运行、不要写过程说明和解释文档。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da9efa6055e64516abb8df153434078c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5be05be0QUnnvJbnqIvnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766999916&amp;x-signature=8qwCgThHNFXmBkWDor1hEZCxaPo%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-8">3. 发现跑偏，立即终止</h3>
<p>发现 Agent 偏离目标时，立即停止，避免无谓 Token 消耗。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3fc159a37046439e9c870987eb8b55b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5be05be0QUnnvJbnqIvnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766999916&amp;x-signature=R2TwEgTO8VQrGp0ztmcVfvwIYi0%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">4. 慎用对话式回滚</h3>
<p>如果某一次的对话产生了一些代码变更，不是我预期内的，建议使用 Qoder 的 Revert 功能或 Reject 变更，不推荐通过聊天让 AI 回滚代码。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66e4c69d186b4d6baee615e922260ea7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5be05be0QUnnvJbnqIvnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766999916&amp;x-signature=MNhaKCpMmwzm7hoOrvKH12sT0MU%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-10">5. 按需选择模型等级</h3>
<p>Qoder提供多级模型选择，您可根据任务复杂度和具体场景需求灵活选择适合的模型：</p>
<ul>
<li>Lite：适合简单任务，例如：简单问答、语法检查。</li>
<li>Efficient：经济高效，适合日常编码、小功能开发。</li>
<li>Auto、Performance：适合复杂功能、全栈开发。</li>
<li>Ultimate：使用海外最好、最顶尖的模型，适合企业级项目、高精度任务成本最高。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4a5a29344c54c4cb9b795eaaeed6a97~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5be05be0QUnnvJbnqIvnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766999916&amp;x-signature=YrLxAL9Jpv4nvIlVuNygAD%2BtT%2Fs%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">6. 优化代码仓库结构</h3>
<p>尽量让我们的代码仓库的结构和 AI 更友好：</p>
<ul>
<li>控制仓库代码文件的长度，避免过长的代码文件。建议单文件不超过200行，避免2000+行的巨无霸文件，以提升代码可维护性和AI处理效率。</li>
<li>使用强类型语言，减少 AI 幻觉</li>
<li>写代码时添加函数注释，提升 AI 检索精度</li>
<li>配置 ​<code>​.qoderignore​</code>​，排除无需分析的目录（如 ​<code>​node_modules​</code>​、构建产物、隐私文件），减少无效 Token。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d48dbe9a82f04c5d840bbdaf9f2f5ccb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5be05be0QUnnvJbnqIvnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766999916&amp;x-signature=oIv3sEJO%2B2ORZDeryDFss6xDb44%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-12">7. 按需启用 MCP 工具</h3>
<p>MCP 的工具你可以按需启用，别因为某个 MCP 工具“挺火”就一直开着，它会一直占着你的上下文成本！不用的 MCP，赶紧禁用。避免加载“工具数量庞大”的低效 MCP。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49c8d53a87b74ed283a10f57de6377d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5be05be0QUnnvJbnqIvnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766999916&amp;x-signature=VoJC8EwTFMD7LCJvdyjeaVaChqM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-13">8. 连续对话利用缓存</h3>
<p>模型缓存有效期基本上在 5~10 分钟，如果你提完问题，半小时后再追问，就无法命中缓存，成本就会更高。</p>
<p><strong>妙招</strong>：用 Qoder 的消息队列！任务还在跑时，直接在输入框里写下一条指令，回车。它会自动排队，无缝衔接，大幅度命中缓存，降低 Credits！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a4af8072d564943a308d64b3aa1b93f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5be05be0QUnnvJbnqIvnpL7ljLo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766999916&amp;x-signature=FRZ9FQJ3IRF6EY1LKumi9ghumPQ%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-14">总结</h2>
<p>节省Credits的本质，是提升人机协作的效率，绝非一味地减少使用，而是通过<strong>清晰的指令</strong>、<strong>对上下文的主动管理</strong>和<strong>恰到好处的人机分工</strong>，来极致提升人机协作的效率。掌握这些技巧，您将能最大化Credits的价值，让Qoder真正成为提升您开发效率和创造力的强大助力！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[上线前不做 Code Review？你可能正在给团队埋雷！]]></title>    <link>https://juejin.cn/post/7585743487258705929</link>    <guid>https://juejin.cn/post/7585743487258705929</guid>    <pubDate>2025-12-21T12:15:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585743487258705929" data-draft-id="7584861353805135908" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="上线前不做 Code Review？你可能正在给团队埋雷！"/> <meta itemprop="keywords" content="前端,代码规范,团队管理"/> <meta itemprop="datePublished" content="2025-12-21T12:15:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="gyx_这个杀手不太冷静"/> <meta itemprop="url" content="https://juejin.cn/user/958429872534056"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            上线前不做 Code Review？你可能正在给团队埋雷！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/958429872534056/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    gyx_这个杀手不太冷静
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T12:15:55.000Z" title="Sun Dec 21 2025 12:15:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    58
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>一位前端同事花一周时间重构了一个核心组件，自测通过、性能优化、UI 完美。<br/>
上线 2 小时后，用户反馈“页面白屏”——原来漏掉了空状态处理。<br/>
紧急回滚、加班修复、产品信任受损……<br/>
而这一切，本可以在一次 15 分钟的 Code Review 中避免。</p>
</blockquote>
<p>Code Review（代码审查）从来不是“找茬”，而是给<strong>前端团队上了一个最高效的质量保险</strong>。它不仅能提前拦截 Bug，更是知识共享、规范落地、新人成长的加速器。</p>
<h2 data-id="heading-0">一、什么是 Code Review</h2>
<h3 data-id="heading-1">1.1 Code Review 的核心价值和目标</h3>
<p>Code Review 翻译成中文，就是<strong>代码审查</strong>。在前端开发过程中，它不仅是<strong>保证代码质量</strong>的关键环节，更是<strong>团队知识共享</strong>、<strong>技术统一</strong>和<strong>工程规范落地</strong>的重要机制。团队成员通过规划化的代码审查流程，能够提前<strong>发现潜在问题</strong>，<strong>提升代码的可以维护性</strong>。</p>
<h3 data-id="heading-2">1.2 Code Review 发生在什么时候</h3>
<p>通常发生在：</p>
<ul>
<li>开发者完成一个功能、修复一个 bug 或进行重构后</li>
<li>将代码推送到远程仓库并发起 <strong>Pull Request（PR）</strong>  或 <strong>Merge Request（MR）</strong></li>
<li>在代码合并到主干分支（如 <code>master</code> / <code>main</code>）<strong>之前</strong></li>
</ul>
<h2 data-id="heading-3">二、为什么要 Code Review</h2>
<p>代码审查真的不是为了找茬，而是为了让<strong>团队</strong>能走得<strong>更远、更稳</strong>的关键一环。想一想，如果花了一周时间，优化了各种性能，写了一大堆代码，结果上线后发现了一个严重 bug，需要紧急修复。这不仅浪费了时间，还可能影响用户对产品团队和开发团队的信任。</p>
<p>下面列举几个 Code Review 的作用：</p>
<ul>
<li><strong>提前发现缺陷</strong><br/>
在 Code Review 阶段发现的逻辑错误、业务理解偏差、性能隐患等时有发生，可以提前发现问题</li>
<li><strong>提高代码质量</strong><br/>
主要体现在代码健壮性、设计合理性、代码优雅性等方面，持续 Code Review 可以提升团队整体代码质量</li>
<li><strong>统一规范和风格</strong><br/>
集团编码规范自不必说，对于代码风格要不要统一，可能会有不同的看法，个人观点对于风格也不强求。不过代码风格的统一更有助于提升代码的可读性及让继任者快速上手</li>
<li><strong>团队共识</strong><br/>
通过多次讨论与交流，逐步达成团队共识，特别是对架构理解和设计原则的认知，在共识的基础上团队也会更有凝聚力，特别是在较多新人加入时尤为重要</li>
</ul>
<h2 data-id="heading-4">三、怎么做 Code Review</h2>
<h3 data-id="heading-5">3.1 代码提交者</h3>
<h5 data-id="heading-6">3.1.1 使用自动化工具</h5>
<ul>
<li>ESLint + Prettier</li>
</ul>
<p>下面是 VS Code 关于 Prettier 的配置示例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"editor.formatOnSave"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"editor.defaultFormatter"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"esbenp.prettier-vscode"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"[vue]"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"editor.defaultFormatter"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"esbenp.prettier-vscode"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"[javascript]"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"editor.defaultFormatter"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"esbenp.prettier-vscode"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"[html]"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"editor.defaultFormatter"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"esbenp.prettier-vscode"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"[jsonc]"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"editor.defaultFormatter"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"esbenp.prettier-vscode"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"[json]"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"editor.defaultFormatter"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"esbenp.prettier-vscode"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"[javascriptreact]"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"editor.defaultFormatter"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"esbenp.prettier-vscode"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"eslint.codeActionsOnSave.mode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"problems"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"eslint.validate"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
        <span class="hljs-string">"typescript"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"javascript"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"javascriptreact"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-string">"typescriptreact"</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"editor.codeActionsOnSave"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-comment">// 指定是否在保存文件时自动整理导入</span>
        <span class="hljs-attr">"source.organizeImports"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"always"</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>利用 Ctrl + S 自动格式化代码</p>
<ul>
<li>Husky + Lint-staged</li>
</ul>
<p>安装依赖</p>
<pre><code class="hljs language-csharp" lang="csharp">yarn <span class="hljs-keyword">add</span> -D husky
yarn <span class="hljs-keyword">add</span> -D lint-staged
</code></pre>
<p><strong>husky</strong></p>
<p>一个为 git 客户端增加 hook 的工具。安装后，它会自动在仓库中的 .husky/ 目录下增加相应的钩子；比如 pre-commit 钩子就会在你执行 git commit 的触发。我们可以在 pre-commit 中实现一些比如 lint 检查、单元测试、代码美化等操作。</p>
<p>package.json 需要添加 prepare 脚本</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"prepare"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"husky install"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>做完以上工作，就可以使用 husky 创建一个 hook 了</p>
<pre><code class="hljs language-sql" lang="sql">npx husky <span class="hljs-keyword">add</span> .husky<span class="hljs-operator">/</span>pre<span class="hljs-operator">-</span><span class="hljs-keyword">commit</span> "npx lint-staged"
</code></pre>
<p><strong>lint-staged</strong></p>
<p>一个仅仅过滤出 Git 代码暂存区文件(被 git add 的文件)的工具；这个很实用，因为我们如果对整个项目的代码做一个检查，可能耗时很长，如果是老项目，要对之前的代码做一个代码规范检查并修改的话，这可能就麻烦了，可能导致项目改动很大。所以这个 lint-staged，对团队项目和开源项目来说，是一个很好的工具，它是对个人要提交的代码的一个规范和约束。</p>
<p>此时我们已经实现了监听 Git hooks，接下来我们需要在 pre-commit 这个 hook 使用 Lint-staged 对代码进行 prettier 的自动化修复和 ESLint 的检查，如果发现不符合代码规范的文件则直接退出 commit。</p>
<p>并且 Lint-staged 只会对 Git 暂存区(git add 的代码)内的代码进行检查而不是全量代码，且会自动将 prettier 格式化后的代码添加到此次 commit 中。</p>
<p>在 package.json 中配置</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
 <span class="hljs-attr">"husky"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"pre-commit"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"lint-staged"</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"lint-staged"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"*.{ts,tsx,js}"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"eslint --fix"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"prettier --write"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-string">"git add"</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsunmh207%2FAI-Codereview-Gitlab" target="_blank" title="https://github.com/sunmh207/AI-Codereview-Gitlab" ref="nofollow noopener noreferrer">AI-Codereview-Gitlab</a></li>
</ul>
<p>合并代码的时候自动触发执行基于大模型的自动化代码审查工具。可以先根据 AI 提示选择性的整改一波，然后再找评审的人 CR。感兴趣的可以点击<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsunmh207%2FAI-Codereview-Gitlab" target="_blank" title="https://github.com/sunmh207/AI-Codereview-Gitlab" ref="nofollow noopener noreferrer">链接</a>了解一下。</p>
<p>功能如下：</p>
<ol>
<li>🚀 多模型支持
<ul>
<li>兼容DeepSeek、ZhipuAI、OpenAI、Anthropic、通义千问和Ollama，想用哪个就用哪个。</li>
</ul>
</li>
<li>📢消息即时主动
<ul>
<li>结果审查一键直达钉钉、企业微信或飞书，代码问题无处可藏！</li>
</ul>
</li>
<li>📅自动化日报生成
<ul>
<li>基于 GitLab &amp; GitHub &amp; Gitea Commit 记录，自动整理每日开发进度，谁在摸鱼、谁在卷，一目了然 😼。</li>
</ul>
</li>
<li>📊可视化仪表板
<ul>
<li>集中展示所有代码审查记录，项目统计、开发者统计，数据说话，甩锅无门！</li>
</ul>
</li>
<li>🎭 评论风格任你选
<ul>
<li>专业型🤵：严谨严谨，正式专业。</li>
<li>论型😈：毒舌吐槽，专治不服（“这代码是用脚写的吗？”）</li>
<li>绅士型😍：温柔建议，如沐春风（“也许这里可以再优化一下呢~”）</li>
<li>幽默型🤪：搞笑点评，快乐改码（“be if-else比我的相亲经历还曲折！”）</li>
</ul>
</li>
</ol>
<h5 data-id="heading-7">3.1.2 发起 Code Review 时间和代码量</h5>
<ul>
<li>时间：尽量<strong>上线前一天</strong>发起评审</li>
<li>代码量：最好在 400 行以下。根据数据分析发现，从代码行数来看，超过 400 行的 CR，缺陷发现率会急剧下降；从 CR 速度来看，超过500 行/小时后，Review 质量也会大大降低，一个高质量的 CR 最好控制在一个小时以内。</li>
</ul>
<h3 data-id="heading-8">3.2 代码评审者</h3>
<h5 data-id="heading-9">3.2.1 评审时重点关注内容</h5>
<p>作为前端评审者，可以检查以下维度：</p>













































<table><thead><tr><th>维度</th><th>检查点示例</th></tr></thead><tbody><tr><td><strong>功能正确性</strong></td><td>逻辑是否覆盖所有场景？边界条件（空值、错误状态）是否处理？</td></tr><tr><td><strong>可读性 &amp; 可维护性</strong></td><td>变量/函数命名是否清晰？组件职责是否单一？重复代码是否可复用？</td></tr><tr><td><strong>TypeScript 安全</strong></td><td>是否滥用 <code>any</code> / <code>@ts-ignore</code>？类型定义是否准确？</td></tr><tr><td><strong>框架规范</strong></td><td>React：<code>key</code> 是否合理？<code>useEffect</code> 依赖是否完整？Vue：响应式使用是否正确？</td></tr><tr><td><strong>样式 &amp; UI</strong></td><td>是否避免全局 CSS 污染？是否适配移动端？是否符合设计系统？</td></tr><tr><td><strong>性能</strong></td><td>是否有不必要的重渲染？图片/资源是否优化？第三方库是否按需引入？</td></tr><tr><td><strong>可访问性 (a11y)</strong></td><td>是否使用语义化标签？表单是否有 label？键盘导航是否支持？</td></tr><tr><td><strong>安全性</strong></td><td>用户输入是否转义？是否避免 XSS（如 <code>dangerouslySetInnerHTML</code>）？</td></tr><tr><td><strong>测试覆盖</strong></td><td>关键逻辑是否有单元测试？用户路径是否有 E2E 测试？</td></tr></tbody></table>
<h5 data-id="heading-10">3.2.2 怎么写 Review 评论</h5>
<p>首先，不要吝啬你的赞美。<strong>代码写的好的地方要表扬！！</strong></p>
<p>区分优先级：</p>
<ul>
<li>🔴 <strong>必须改</strong>：Bug、安全漏洞、破坏性变更</li>
<li>🟡 <strong>建议改</strong>：可读性、性能优化、最佳实践</li>
<li>🟢 <strong>可讨论</strong>：风格偏好（应由 Lint 工具统一）</li>
</ul>
<p>用好 “What-Why-How” 法则</p>
<p>✅ 正确示范：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">What: 这里直接操作 DOM (`document.getElementById`)  </span>
<span class="hljs-section">Why: 在 React 中绕过虚拟 DOM 会导致状态不一致，且难以测试  </span>
<span class="hljs-section">How: 建议改用 `useRef` 获取元素引用，或通过状态驱动 UI 更新</span>
</code></pre>
<p>❌ 避免：</p>
<pre><code class="hljs">“这里写得不好” → 太模糊
“你应该用 Hooks 重写” → 没说明原因
“我以前都这么写的” → 主观经验，缺乏依据
</code></pre>
<h2 data-id="heading-11">总结</h2>
<p>好的 Code Review 是团队进步的放大器，它可以：</p>
<ul>
<li>让新人成长得更快</li>
<li>让系统变得更稳定</li>
<li>让"技术债"更少</li>
<li>让协作更高效</li>
</ul>
<h2 data-id="heading-12">参考文章</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.aliyun.com%2Farticle%2F1164854" target="_blank" title="https://developer.aliyun.com/article/1164854" ref="nofollow noopener noreferrer">一文梳理Code Review方法论与实践总结</a></li>
</ul>
<h2 data-id="heading-13">感谢</h2>
<ul>
<li>文中如有错误，欢迎在评论区批评指正。</li>
<li>如果本文对你有帮助，就<strong>点赞、收藏</strong>支持下吧！感谢阅读。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端轮子（1）--前端部署后-判断页面是否为最新]]></title>    <link>https://juejin.cn/post/7585706951603601434</link>    <guid>https://juejin.cn/post/7585706951603601434</guid>    <pubDate>2025-12-21T02:18:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585706951603601434" data-draft-id="7585463258690502665" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端轮子（1）--前端部署后-判断页面是否为最新"/> <meta itemprop="keywords" content="前端,Vue.js,Node.js"/> <meta itemprop="datePublished" content="2025-12-21T02:18:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员小易"/> <meta itemprop="url" content="https://juejin.cn/user/2032344744857127"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端轮子（1）--前端部署后-判断页面是否为最新
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2032344744857127/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员小易
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T02:18:14.000Z" title="Sun Dec 21 2025 02:18:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>前端轮子系列：</p>
<ol>
<li><a href="https://juejin.cn/spost/7585706951603601434" target="_blank" title="https://juejin.cn/spost/7585706951603601434">前端部署后-判断页面是否为最新</a></li>
<li>如何优雅diy响应数据</li>
<li>如何优雅进行webview调试</li>
<li>如何实现测试环境的自动登录</li>
<li/>
</ol>
</blockquote>
<blockquote>
<p>项目部署后：通知更新、强制刷新、自测访问的页面为最新代码（是否发版成功）<br/>
重点：<strong>自测、提测、修改bug</strong>后，确认访问的为<strong>最新页面</strong></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e5d14d5dcee4533938fe6b167aab982~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY5bCP5piT:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766888338&amp;x-signature=CZ5zNZQsNzIVWwr9mEh1fKlvH6M%3D" alt="check-version.gif" loading="lazy"/></p>
<h2 data-id="heading-0">实现思路</h2>
<p>目的：生成新的版本标识，通过对比标识 ==&gt; 当前为最新 还是 旧页面</p>
<ol>
<li>生成版本号：如：1.1.10 ，或者时间戳（202512201416）
<ul>
<li>自动化脚本生成</li>
<li>手动控制</li>
</ul>
</li>
<li>对比版本号：相等=&gt; 当前为最新；不等 =&gt; 当前为旧页面</li>
<li>通过对比结果 对应处理产品逻辑 完事儿~</li>
</ol>
<h2 data-id="heading-1">具体实现</h2>
<h3 data-id="heading-2">方案一：生成时间戳，注入变量，控制台打印</h3>
<h4 data-id="heading-3">在vue-cli项目中</h4>
<p>通过vue.config.js 入变量<br/>
然后在main.js中打印变量</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// main.js</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'__BUILD_TIME__'</span>, __BUILD_TIME__)
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vue.config.js</span>
<span class="hljs-keyword">const</span> _date = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BUILD_TIME</span> = _date.<span class="hljs-property">toLocaleString</span> ? _date.<span class="hljs-title function_">toLocaleString</span>() : _date.<span class="hljs-title function_">getTime</span>()

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">configureWebpack</span>: {
    <span class="hljs-attr">plugins</span>: [
      <span class="hljs-keyword">new</span> webpack.<span class="hljs-title class_">DefinePlugin</span>({
        <span class="hljs-attr">__BUILD_TIME__</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable constant_">BUILD_TIME</span>)
      })
    ]
  },
}

</code></pre>
<h4 data-id="heading-4">在vite项目中</h4>
<p>通过vite.config.js 注入 <strong>BUILD_TIME</strong> 变量<br/>
然后在main.js中打印 <strong>BUILD_TIME</strong> 变量</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// main.js</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'__BUILD_TIME__'</span>, __BUILD_TIME__)
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">const</span> _date = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BUILD_TIME</span> = _date.<span class="hljs-property">toLocaleString</span> ? _date.<span class="hljs-title function_">toLocaleString</span>() : _date.<span class="hljs-title function_">getTime</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">define</span>: {
      <span class="hljs-attr">__BUILD_TIME__</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(<span class="hljs-variable constant_">BUILD_TIME</span>)
    },
  }
})
</code></pre>
<p>这种方案，实现了在控制台打印。但是对于生产环境，无法做到版本号的对比<br/>
为啥？ 因为上线 一般会去掉日志的打印， 所以咱通过版本号来~</p>
<h3 data-id="heading-5">方案二：记录版本号，轮询对比版本号</h3>
<ol>
<li>编写生成版本号的脚本，生成版本号文件</li>
<li>build结束，调用脚本去生成版本号文件</li>
<li>轮询对比版本号文件，如果版本号不一致，做相应操作</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// dist/version.json</span>
{
  <span class="hljs-string">"buildTime"</span>: <span class="hljs-string">"2025-12-20 14:16:00"</span>
}
</code></pre>
<p><strong>prebuild</strong>: build前执行的脚本<br/>
<strong>postbuild</strong>：build结束后执行的脚本，用于生成版本号文件</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// package.json</span>
{
  <span class="hljs-string">"scripts"</span>: {
    <span class="hljs-string">"postbuild"</span>: <span class="hljs-string">"node scripts/generate-version-dist.mjs"</span>
  }
}
</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// scripts/generate-version-dist.mjs</span>
<span class="hljs-keyword">import</span> { writeFile } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:fs/promises'</span>
<span class="hljs-keyword">import</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'node:path'</span>
<span class="hljs-keyword">import</span> { fileURLToPath } <span class="hljs-keyword">from</span> <span class="hljs-string">'node:url'</span>

<span class="hljs-keyword">const</span> __filename = <span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>)
<span class="hljs-keyword">const</span> __dirname = path.<span class="hljs-title function_">dirname</span>(__filename)
<span class="hljs-keyword">const</span> root = path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'..'</span>)


<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> _date = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>()
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BUILD_TIME</span> = _date.<span class="hljs-property">toLocaleString</span> ? _date.<span class="hljs-title function_">toLocaleString</span>() : _date.<span class="hljs-title function_">getTime</span>()

  <span class="hljs-keyword">const</span> outPath = path.<span class="hljs-title function_">join</span>(root, <span class="hljs-string">'dist'</span>, <span class="hljs-string">'version.json'</span>)
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">writeFile</span>(outPath, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ <span class="hljs-variable constant_">BUILD_TIME</span> }, <span class="hljs-literal">null</span>, <span class="hljs-number">2</span>) + <span class="hljs-string">'\n'</span>, <span class="hljs-string">'utf-8'</span>)

}

<span class="hljs-title function_">main</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'[generate-version] failed'</span>, e)
  process.<span class="hljs-title function_">exit</span>(<span class="hljs-number">1</span>)
})
</code></pre>
<h4 data-id="heading-6">轮询对比版本号</h4>
<ol>
<li>轮询对比版本号文件，如果版本号不一致，做相应操作</li>
<li>页面隐藏、切后台时，停止轮询，页面关闭时，停止轮询</li>
<li>页面显示、切前台时，开始轮询</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// main.js</span>
<span class="hljs-keyword">import</span> { createVersionPoller } <span class="hljs-keyword">from</span> <span class="hljs-string">'./utils/versionPoller'</span>
<span class="hljs-title function_">createVersionPoller</span>({
  <span class="hljs-attr">versionUrl</span>: <span class="hljs-string">'/version.json'</span>,
  <span class="hljs-attr">storageKey</span>: <span class="hljs-string">'__VERSION_CHECK__CURRENT_BUILD_TIME__'</span>,
  <span class="hljs-attr">intervalMs</span>: <span class="hljs-number">15_000</span>,
  <span class="hljs-attr">maxDelayMs</span>: <span class="hljs-number">60_000</span>,
  <span class="hljs-attr">onResult</span>: <span class="hljs-function">(<span class="hljs-params">{ remoteVersion, remoteBuildTime }</span>) =&gt;</span> {
    <span class="hljs-comment">// 轮询到json文件 成功，额外处理逻辑</span>
  },
  <span class="hljs-attr">onError</span>: <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-comment">// 轮询失败，额外处理逻辑</span>
  },
  <span class="hljs-attr">onUpdate</span>: <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 版本号不一致，需要更新，额外处理逻辑</span>
  }
}).<span class="hljs-title function_">start</span>()


</code></pre>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">/**
 * 轮询 /version.json，对比 buildTime 判断是否需要更新（setTimeout + 错误指数退让）
 *
 * 行为说明：
 * - start() 会自动注册监听：visibilitychange / beforeunload / unload
 * - stop() 会清理定时器并卸载监听
 * - 请求失败会指数退让（delay *= 2，最大不超过 maxDelayMs）；成功后恢复 intervalMs
 * - currentBuildTime 会写入 localStorage（storageKey）
 *
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Object</span>} <span class="hljs-variable">options</span>
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} [options.versionUrl='/version.json'] 版本文件地址
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} [options.storageKey='__VERSION_CHECK__CURRENT_BUILD_TIME__'] localStorage key
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} [options.intervalMs=15000] 正常轮询间隔（毫秒）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} [options.maxDelayMs=60000] 退让最大间隔（毫秒）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">(info:{localBuildTime:string,remoteBuildTime:string,remoteVersion:string,data:any</span>})=&gt;void} [options.onResult] 每次成功拉取后的回调
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">(error:any)=&gt;void</span>} [options.onError] 拉取失败回调
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">(info:{localBuildTime:string,remoteBuildTime:string,remoteVersion:string,data:any</span>})=&gt;void} [options.onUpdate] 发现新 buildTime 时回调（默认会 stop）
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">createVersionPoller</span>(<span class="hljs-params">{
  versionUrl = <span class="hljs-string">'/version.json'</span>,
  storageKey = <span class="hljs-string">'__VERSION_CHECK__CURRENT_BUILD_TIME__'</span>,
  intervalMs = <span class="hljs-number">15000</span>,
  maxDelayMs = <span class="hljs-number">60000</span>,
  onResult,
  onError,
  onUpdate
} = {}</span>) {
  <span class="hljs-keyword">let</span> timer = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">let</span> stopped = <span class="hljs-literal">true</span>
  <span class="hljs-keyword">let</span> delayMs = intervalMs
  <span class="hljs-keyword">let</span> bound = <span class="hljs-literal">false</span>

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">readLocal</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-variable language_">window</span>.<span class="hljs-property">localStorage</span>.<span class="hljs-title function_">getItem</span>(storageKey) || <span class="hljs-string">''</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">writeLocal</span> = (<span class="hljs-params">v</span>) =&gt; v &amp;&amp; <span class="hljs-variable language_">window</span>.<span class="hljs-property">localStorage</span>.<span class="hljs-title function_">setItem</span>(storageKey, <span class="hljs-title class_">String</span>(v))

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">clear</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!timer) <span class="hljs-keyword">return</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-built_in">clearTimeout</span>(timer)
    timer = <span class="hljs-literal">null</span>
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">isVisible</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">document</span>.<span class="hljs-property">visibilityState</span> !== <span class="hljs-string">'hidden'</span>
  }

  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchRemote</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> sep = versionUrl.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'?'</span>) ? <span class="hljs-string">'&amp;'</span> : <span class="hljs-string">'?'</span>
    <span class="hljs-keyword">const</span> url = <span class="hljs-string">`<span class="hljs-subst">${versionUrl}</span><span class="hljs-subst">${sep}</span>t=<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url, { <span class="hljs-attr">cache</span>: <span class="hljs-string">'no-store'</span>, <span class="hljs-attr">headers</span>: { <span class="hljs-string">'Cache-Control'</span>: <span class="hljs-string">'no-cache'</span> } })
    <span class="hljs-keyword">if</span> (!res.<span class="hljs-property">ok</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`fetch <span class="hljs-subst">${versionUrl}</span> failed: <span class="hljs-subst">${res.status}</span>`</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>()
  }

  <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">tick</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (stopped || !<span class="hljs-title function_">isVisible</span>()) <span class="hljs-keyword">return</span>

    <span class="hljs-keyword">const</span> localBuildTime = <span class="hljs-title function_">readLocal</span>() || <span class="hljs-string">''</span>

    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetchRemote</span>()
      <span class="hljs-keyword">const</span> remoteVersion = <span class="hljs-title class_">String</span>(data?.<span class="hljs-property">version</span> || <span class="hljs-string">''</span>)
      <span class="hljs-keyword">const</span> remoteBuildTime = <span class="hljs-title class_">String</span>(data?.<span class="hljs-property">BUILD_TIME</span> || <span class="hljs-string">''</span>)

      delayMs = intervalMs
      onResult?.({ localBuildTime, remoteBuildTime, remoteVersion, data })

      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>( remoteBuildTime , <span class="hljs-string">'=&gt;'</span>, localBuildTime)

      <span class="hljs-keyword">if</span> (remoteBuildTime &amp;&amp; remoteBuildTime !== localBuildTime) {
        <span class="hljs-comment">// 记录最新 buildTime，避免重复提示同一个更新</span>
        <span class="hljs-title function_">writeLocal</span>(remoteBuildTime)
        onUpdate?.({ localBuildTime, remoteBuildTime, remoteVersion, data })
      }
    } <span class="hljs-keyword">catch</span> (e) {
      delayMs = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(maxDelayMs, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">500</span>, delayMs * <span class="hljs-number">2</span>))
      onError?.(e)
    }

    timer = <span class="hljs-variable language_">window</span>.<span class="hljs-built_in">setTimeout</span>(tick, delayMs)
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">onVisibilityChange</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (stopped) <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-title function_">isVisible</span>()) <span class="hljs-keyword">return</span> <span class="hljs-title function_">clear</span>()
    <span class="hljs-title function_">clear</span>()
    timer = <span class="hljs-variable language_">window</span>.<span class="hljs-built_in">setTimeout</span>(tick, <span class="hljs-number">0</span>)
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">ensureBound</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (bound) <span class="hljs-keyword">return</span>
    bound = <span class="hljs-literal">true</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'visibilitychange'</span>, onVisibilityChange)
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'beforeunload'</span>, stop)
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'unload'</span>, stop)
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">ensureUnbound</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!bound) <span class="hljs-keyword">return</span>
    bound = <span class="hljs-literal">false</span>
    <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'visibilitychange'</span>, onVisibilityChange)
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'beforeunload'</span>, stop)
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'unload'</span>, stop)
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">start</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> (!stopped) <span class="hljs-keyword">return</span>
    stopped = <span class="hljs-literal">false</span>
    delayMs = intervalMs
    <span class="hljs-title function_">ensureBound</span>()
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_">isVisible</span>()) timer = <span class="hljs-variable language_">window</span>.<span class="hljs-built_in">setTimeout</span>(tick, <span class="hljs-number">0</span>)
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">stop</span>(<span class="hljs-params"/>) {
    stopped = <span class="hljs-literal">true</span>
    <span class="hljs-title function_">clear</span>()
    <span class="hljs-title function_">ensureUnbound</span>()
  }

  <span class="hljs-keyword">return</span> { start, stop }
}

</code></pre>
<h2 data-id="heading-7">注意点</h2>
<ul>
<li>轮询版本文件，拼 时间戳、设置请求头 避免命中缓存</li>
<li>轮询版本文件，时间间隔不要太短，耗费网络，虽然已经做了轮询指数退让</li>
<li>生成的版本文件 生成到dist下 注意访问路径</li>
<li>版本号需要上传到git，需要手动执行脚本&amp;commit + push</li>
</ul>
<h2 data-id="heading-8">源码</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fxiaoyi1255%2Fversion-check" target="_blank" title="https://github.com/xiaoyi1255/version-check" ref="nofollow noopener noreferrer">xiaoyi1255</a></p>
<h2 data-id="heading-9">结语</h2>
<p>如果本文对你有收获，麻烦动动发财的小手，点点关注、点点赞！！！👻👻👻</p>
<p>因为收藏===会了</p>
<p>如果有不对、更好的方式实现、可以优化的地方欢迎在评论区指出，谢谢👾👾👾</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从硬编码到 Schema 推断：前端表单开发的工程化转型]]></title>    <link>https://juejin.cn/post/7585758163435601926</link>    <guid>https://juejin.cn/post/7585758163435601926</guid>    <pubDate>2025-12-21T12:01:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585758163435601926" data-draft-id="7585751355592507411" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从硬编码到 Schema 推断：前端表单开发的工程化转型"/> <meta itemprop="keywords" content="前端,Vue.js,架构"/> <meta itemprop="datePublished" content="2025-12-21T12:01:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="光头老石"/> <meta itemprop="url" content="https://juejin.cn/user/2963939077135006"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从硬编码到 Schema 推断：前端表单开发的工程化转型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2963939077135006/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    光头老石
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T12:01:14.000Z" title="Sun Dec 21 2025 12:01:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、你的表单，是否正在失控？</h2>
<p>想象一个场景，你正在开发一个“企业贷款申请”或“保险理赔”系统。</p>
<p>最初，页面只有 5 个字段，你写得优雅从容。随着业务迭代，表单像吹气球一样膨胀到了 50 多个字段： <strong>“如果用户选了‘个体工商户’，不仅要隐藏‘企业法人’字段，还得去动态请求‘经营地’的下拉列表，同时‘注册资本’的校验规则还要从‘必填’变成‘选填’……”</strong></p>
<p>于是，你的 Vue 文件变成了这样：</p>
<ul>
<li><code>&lt;template&gt;</code> 里塞满了深层嵌套的 <code>v-if</code> 和 <code>v-show</code>。</li>
<li><code>&lt;script&gt;</code> 里到处是监听联动逻辑的 <code>watch</code> 和冗长的 <code>if-else</code>。</li>
<li><strong>最痛苦的是：</strong> 当后端决定调整字段名，或者公司要求把这套逻辑复用到小程序时，你发现逻辑和 UI 已经像麻绳一样死死缠在一起，拆不开了。</li>
</ul>
<p><strong>“难道写表单，真的只能靠体力活吗？”</strong></p>
<p>为了摆脱这种低效率重复，我们尝试将 <strong>中间件思想</strong> 引入 Vue 3，把复杂的业务规则从 UI 框架中剥离出来。今天，我就把这套“一次编写，到处复用”的工程化方案分享给你。</p>
<hr/>
<h2 data-id="heading-1">二、 核心思想：让数据自带“说明书”</h2>
<p>传统模式下，前端像是一个**“搬运工”：拿到后端数据，手动判断哪个该显、哪个该隐。</p>
<p>而工程化模式下，前端更像是一个“组装厂”**：数据在进入 UI 层之前，先经过一套“中间件流水线”，数据会被自动标注上 UI 描述信息（Schema）。</p>
<h3 data-id="heading-2">1. 什么是 Schema 推断？</h3>
<p>数据不再是冷冰冰的键值对，而是变成了一个包含“元数据”的对象。通过 TypeScript 的类型推断，我们让数据自己告诉页面：</p>
<ul>
<li>我应该用什么组件渲染（<code>componentType</code>）</li>
<li>我是否应该被显示（<code>visible</code>）</li>
<li>我依赖哪些字段（<code>dependencies</code>）</li>
<li>我的下拉选项去哪里拉取（<code>request</code>）</li>
</ul>
<h3 data-id="heading-3">2. UI 框架只是“皮肤”</h3>
<p>既然逻辑都抽离到了框架无关的中间件里，那么 UI 层无论是用 Ant Design 还是 Element Plus，都只是换个“解析器”而已。</p>
<hr/>
<h2 data-id="heading-4">三、 实战：构建 Vue 3 自动化渲染引擎</h2>
<h3 data-id="heading-5">1. 组件注册表</h3>
<p>首先，我们要定义一个组件映射表，把抽象的字符串类型映射为具体的 Vue 组件。</p>
<p>TypeScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src-vue/components/FormRenderer/componentRegistry.ts</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">NumberField</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../FieldRenderers/NumberField.vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">SelectField</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../FieldRenderers/SelectField.vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TextField</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../FieldRenderers/TextField.vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ModeToggle</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'../FieldRenderers/ModeToggle.vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> componentRegistry = {
  <span class="hljs-attr">number</span>: <span class="hljs-title class_">NumberField</span>,
  <span class="hljs-attr">select</span>: <span class="hljs-title class_">SelectField</span>,
  <span class="hljs-attr">text</span>: <span class="hljs-title class_">TextField</span>,
  <span class="hljs-attr">modeToggle</span>: <span class="hljs-title class_">ModeToggle</span>,
} <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>
</code></pre>
<h3 data-id="heading-6">2. 组装线：自动渲染器（AutoFormRenderer）</h3>
<p>这是我们的核心引擎。它不关心业务，只负责按照加工好的 <code>_fieldOrder</code> 和 <code>_schema</code> 进行遍历。</p>
<pre><code class="hljs language-ini" lang="ini">&lt;template&gt;
  &lt;a-row :<span class="hljs-attr">gutter</span>=<span class="hljs-string">"[16,16]"</span>&gt;
    &lt;template <span class="hljs-attr">v-for</span>=<span class="hljs-string">"key in orderedKeys"</span> :key=<span class="hljs-string">"key"</span>&gt;
      &lt;component
        <span class="hljs-attr">v-if</span>=<span class="hljs-string">"shouldRender(key)"</span>
        :<span class="hljs-attr">is</span>=<span class="hljs-string">"resolveComponent(key)"</span>
        :<span class="hljs-attr">value</span>=<span class="hljs-string">"data[key]"</span>
        :<span class="hljs-attr">config</span>=<span class="hljs-string">"schema[key].fieldConfig"</span>
        :<span class="hljs-attr">dependencies</span>=<span class="hljs-string">"collectDeps(schema[key])"</span>
        :<span class="hljs-attr">request</span>=<span class="hljs-string">"schema[key].request"</span>
        @update:<span class="hljs-attr">value</span>=<span class="hljs-string">"onFieldChange(key, $event)"</span>
      /&gt;
    &lt;/template&gt;
  &lt;/a-row&gt;
&lt;/template&gt;

&lt;script setup <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;
const <span class="hljs-attr">props</span> = defineProps&lt;{ data: any }&gt;()<span class="hljs-comment">;</span>
const <span class="hljs-attr">schema</span> = computed(() =&gt; props.data?._schema || {})<span class="hljs-comment">;</span>
const <span class="hljs-attr">orderedKeys</span> = computed(() =&gt; props.data?._fieldOrder || Object.keys(props.data))<span class="hljs-comment">;</span>

// 根据中间件注入的 visible 函数判断显隐
function shouldRender(key: string) {
  const <span class="hljs-attr">s</span> = schema.value[key]<span class="hljs-comment">;</span>
  if (!s || s.fieldConfig?.hidden) return false<span class="hljs-comment">;</span>
  return s.visible ? s.visible(props.data) : true<span class="hljs-comment">;</span>
}

function resolveComponent(key: string) {
  const <span class="hljs-attr">type</span> = schema.value[key]?.componentType || <span class="hljs-string">'text'</span><span class="hljs-comment">;</span>
  return componentRegistry<span class="hljs-section">[type]</span><span class="hljs-comment">;</span>
}
&lt;/script&gt;
</code></pre>
<h3 data-id="heading-7">3. 原子化：会“思考”的字段组件</h3>
<p>以 <code>SelectField</code> 为例，它不再是被动等待赋值，而是能感知依赖。当它依赖的字段（如“省份”）变化时，它会自动重新调用 <code>request</code>。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">defineProps</span>([<span class="hljs-string">'value'</span>, <span class="hljs-string">'dependencies'</span>, <span class="hljs-string">'request'</span>]);
<span class="hljs-keyword">const</span> options = <span class="hljs-title function_">ref</span>([]);

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">loadOptions</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">request</span>) {
    options.<span class="hljs-property">value</span> = <span class="hljs-keyword">await</span> props.<span class="hljs-title function_">request</span>(props.<span class="hljs-property">dependencies</span> || {});
  }
}

<span class="hljs-comment">// 深度监听依赖变化，实现联动效果</span>
<span class="hljs-title function_">watch</span>(<span class="hljs-function">() =&gt;</span> props.<span class="hljs-property">dependencies</span>, loadOptions, { <span class="hljs-attr">deep</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span> });
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h2 data-id="heading-8">四、 方案的“真香”时刻</h2>
<h3 data-id="heading-9">1. 逻辑与 UI 的彻底解耦</h3>
<p>所有的联动规则、校验逻辑、接口请求都定义在独立于框架的 <code>src/core</code> 下。如果你明天想把项目从 Vue 3 迁到 React，你只需要重写那几个基础字段组件，核心业务逻辑 <strong>一行都不用动</strong>。</p>
<h3 data-id="heading-10">2. “洁癖型”提交</h3>
<p>很多动态表单方案会将 <code>visible</code>、<code>options</code> 等 UI 状态混入业务数据，导致传给后端的 JSON 极其混乱。我们的方案在提交前会运行一次“清洗中间件”：</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">cleanPayload</span> = submitCompileOutputs(formData.compileOutputs)<span class="hljs-comment">;</span>
// 自动剔除所有以 _ 开头的辅助字段和临时状态
</code></pre>
<p>后端拿到的永远是干净、纯粹的业务模型。</p>
<h3 data-id="heading-11">3. 开发体验的飞跃</h3>
<p>现在，当后端新增一个字段时，你的工作流变成了：</p>
<ol>
<li>
<p>在类型推断引擎里加一行规则。</p>
</li>
<li>
<p>刷新页面，字段已经按预定的位置和样式长好了。</p>
<p>你不再需要去 .vue 文件里翻找几百行处的 template 插入 HTML，更不需要担心漏掉了哪个 v-if。</p>
</li>
</ol>
<hr/>
<h2 data-id="heading-12">结语：不要为了用框架而用框架</h2>
<p>很多时候，我们觉得 Vue 或 React 难维护，是因为我们将<strong>过重的业务决策</strong>交给了<strong>视图层</strong>。</p>
<p>通过引入中间件和 Schema 推断，我们实际上在 UI 框架之上建立了一个“业务逻辑防火墙”。Vue 只负责监听交互和渲染结果，而变幻莫测的业务规则被关在了纯 TypeScript 编写的沙盒里。</p>
<p><strong>这种“工程化”的思维，不仅是为了今天能快速复刻功能，更是为了明天业务变动时，我们能优雅地“配置升级”，而不是“推倒重来”。</strong></p>
<hr/>
<p><strong>你是如何处理复杂表单联动的？欢迎在评论区分享你的“避坑”指南！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 的金额计算用 long 还是 BigDecimal？资深程序员这样选]]></title>    <link>https://juejin.cn/post/7585485074038554630</link>    <guid>https://juejin.cn/post/7585485074038554630</guid>    <pubDate>2025-12-21T02:42:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585485074038554630" data-draft-id="7577705544875589670" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 的金额计算用 long 还是 BigDecimal？资深程序员这样选"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-12-21T02:42:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刘大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 的金额计算用 long 还是 BigDecimal？资深程序员这样选
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刘大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T02:42:38.000Z" title="Sun Dec 21 2025 02:42:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0">前言</h3>
<p>最近接触一个新项目，发现系统中所有金额相关字段都使用<code>long</code>类型来表示。</p>
<p>作为一个习惯使用<code>BigDecimal</code>处理金额的开发者，这让我产生了疑惑：这会不会有精度问题？为什么要这样设计？</p>
<p>“用<code>double</code>不行吗？它也能表示小数啊！”</p>
<p>经过一番研究和思考，把最终得出的结论来和大家详细分享一下。</p>
<h3 data-id="heading-1">一、double、float类型比较</h3>
<p><code>double</code>和<code>float</code>都是Java中的浮点数类型，它们采用IEEE 754标准来表示小数。</p>
<p>这种表示方法类似于科学计数法，但存在一个致命问题：<strong>不是所有小数都能精确表示</strong>。</p>
<p>举一个简单的例子：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">double</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">0.1</span>;
<span class="hljs-type">double</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">0.2</span>;
<span class="hljs-type">double</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> a + b;
System.out.println(result); 
<span class="hljs-comment">// 输出：0.30000000000000004</span>
</code></pre>
<p>什么？简单的0.1 + 0.2居然不等于0.3？</p>
<p>是的，这是因为在二进制的计算中，有些十进制小数没有办法精确表示，就像1除以3一样，在十进制中也不能精确表示（0.33333...）。</p>
<h3 data-id="heading-2">二、BigDecimal 解决方案</h3>
<h4 data-id="heading-3">BigDecimal的正确用法</h4>
<p><code>BigDecimal</code>可以解决精度问题，但必须正确使用。</p>
<p><strong>错误的构造方式</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">BigDecimal</span> <span class="hljs-variable">wrong1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">0.1</span>); 
<span class="hljs-type">BigDecimal</span> <span class="hljs-variable">wrong2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">0.2</span>);
</code></pre>
<p>这种传入浮点型的构造方式还是会有精度问题。</p>
<p><strong>正确的构造方式</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">BigDecimal</span> <span class="hljs-variable">correct1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.1"</span>);
<span class="hljs-type">BigDecimal</span> <span class="hljs-variable">correct2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.2"</span>);
System.out.println(<span class="hljs-string">"正确方式: "</span> + correct1.add(correct2)); <span class="hljs-comment">// 0.3</span>
</code></pre>
<p>通过传入字符串进行构造。</p>
<p><strong>或者用valueOf（内部也是转字符串）</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">BigDecimal</span> <span class="hljs-variable">safe1</span> <span class="hljs-operator">=</span> BigDecimal.valueOf(<span class="hljs-number">0.1</span>);
<span class="hljs-type">BigDecimal</span> <span class="hljs-variable">safe2</span> <span class="hljs-operator">=</span> BigDecimal.valueOf(<span class="hljs-number">0.2</span>);
System.out.println(<span class="hljs-string">"安全方式: "</span> + safe1.add(safe2)); <span class="hljs-comment">// 0.3</span>
</code></pre>
<h4 data-id="heading-4">BigDecimal的运算规则</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BigDecimalOperations</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">price</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"19.99"</span>);
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">quantity</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"3"</span>);
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">taxRate</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.13"</span>);
        
        <span class="hljs-comment">// 乘法</span>
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">subtotal</span> <span class="hljs-operator">=</span> price.multiply(quantity);
        
        <span class="hljs-comment">// 除法必须指定精度和舍入模式</span>
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">tax</span> <span class="hljs-operator">=</span> subtotal.multiply(taxRate)
                               .setScale(<span class="hljs-number">2</span>, RoundingMode.HALF_UP);
        
        <span class="hljs-comment">// 加法</span>
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> subtotal.add(tax);
        
        System.out.println(<span class="hljs-string">"小计: "</span> + subtotal); <span class="hljs-comment">// 59.97</span>
        System.out.println(<span class="hljs-string">"税金: "</span> + tax);      <span class="hljs-comment">// 7.80</span>
        System.out.println(<span class="hljs-string">"总计: "</span> + total);    <span class="hljs-comment">// 67.77</span>
    }
}
</code></pre>
<h4 data-id="heading-5">BigDecimal的比较操作</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BigDecimalComparison</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">num1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"10.00"</span>);
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">num2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"10.000"</span>);
        
        <span class="hljs-comment">// 错误：比较引用</span>
        System.out.println(<span class="hljs-string">"== 比较: "</span> + (num1 == num2)); <span class="hljs-comment">// false</span>
        
        <span class="hljs-comment">// 错误：equals会比较精度</span>
        System.out.println(<span class="hljs-string">"equals比较: "</span> + num1.equals(num2)); <span class="hljs-comment">// false</span>
        
        <span class="hljs-comment">// 正确：compareTo只比较数值</span>
        System.out.println(<span class="hljs-string">"compareTo比较: "</span> + (num1.compareTo(num2) == <span class="hljs-number">0</span>)); <span class="hljs-comment">// true</span>
    }
}
</code></pre>
<h4 data-id="heading-6">BigDecimal的缺点</h4>
<ol>
<li><strong>性能开销</strong>：对象创建和运算成本高</li>
<li><strong>内存占用</strong>：每个对象需要20-30字节</li>
<li><strong>使用复杂</strong>：容易用错构造方法和运算规则</li>
<li><strong>代码冗长</strong>：简单的运算也需要多行代码</li>
</ol>
<h3 data-id="heading-7">三、long方案</h3>
<h4 data-id="heading-8">核心思想：以分为单位存储</h4>
<p>使用<code>long</code>表示金额的核心思路是：不以元为单位，而以最小货币单位（分）存储。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LongAmountDemo</span> {
    <span class="hljs-comment">// 工具方法：元转分</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">yuanToFen</span><span class="hljs-params">(<span class="hljs-type">double</span> yuan)</span> {
        <span class="hljs-keyword">return</span> Math.round(yuan * <span class="hljs-number">100</span>);
    }
    
    <span class="hljs-comment">// 工具方法：分转元（用于显示）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">fenToYuanDisplay</span><span class="hljs-params">(<span class="hljs-type">long</span> fen)</span> {
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"¥%.2f"</span>, fen / <span class="hljs-number">100.0</span>);
    }
    
    <span class="hljs-comment">// 工具方法：分转元（用于计算）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">fenToYuan</span><span class="hljs-params">(<span class="hljs-type">long</span> fen)</span> {
        <span class="hljs-keyword">return</span> fen / <span class="hljs-number">100.0</span>;
    }
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 以分为单位存储所有金额</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">price</span> <span class="hljs-operator">=</span> yuanToFen(<span class="hljs-number">19.99</span>);  <span class="hljs-comment">// 1999分 = 19.99元</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">quantity</span> <span class="hljs-operator">=</span> <span class="hljs-number">3</span>;
        <span class="hljs-type">long</span> <span class="hljs-variable">taxRate</span> <span class="hljs-operator">=</span> <span class="hljs-number">13</span>;  <span class="hljs-comment">// 13% = 0.13，这里用整数表示百分比</span>
        
        <span class="hljs-comment">// 计算过程全部使用整数运算</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">subtotal</span> <span class="hljs-operator">=</span> price * quantity;                    <span class="hljs-comment">// 5997分</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">tax</span> <span class="hljs-operator">=</span> (subtotal * taxRate) / <span class="hljs-number">100</span>;               <span class="hljs-comment">// 780分</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> subtotal + tax;                         <span class="hljs-comment">// 6777分</span>
        
        System.out.println(<span class="hljs-string">"小计: "</span> + fenToYuanDisplay(subtotal)); <span class="hljs-comment">// ¥59.97</span>
        System.out.println(<span class="hljs-string">"税金: "</span> + fenToYuanDisplay(tax));      <span class="hljs-comment">// ¥7.80</span>
        System.out.println(<span class="hljs-string">"总计: "</span> + fenToYuanDisplay(total));    <span class="hljs-comment">// ¥67.77</span>
    }
}
</code></pre>
<h4 data-id="heading-9">long方案的优势</h4>
<p><strong>1.绝对精确</strong>
整数运算在计算机中是精确的，不会出现浮点数的精度问题。</p>
<p><strong>2.性能卓越</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// long运算 - 机器指令级别，极快</span>
<span class="hljs-type">long</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000L</span>, b = <span class="hljs-number">2000L</span>;
<span class="hljs-type">long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> a + b;

<span class="hljs-comment">// BigDecimal运算 - 方法调用，对象创建，较慢</span>
<span class="hljs-type">BigDecimal</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"10.00"</span>);
<span class="hljs-type">BigDecimal</span> <span class="hljs-variable">d</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"20.00"</span>);
<span class="hljs-type">BigDecimal</span> <span class="hljs-variable">result2</span> <span class="hljs-operator">=</span> c.add(d);
</code></pre>
<p><strong>3.存储高效</strong></p>
<ul>
<li><code>long</code>：固定8字节</li>
<li><code>BigDecimal</code>：对象头+数值，通常20-30字节</li>
</ul>
<p><strong>4.序列化简单</strong>
在数据库、JSON、网络传输中处理更简单。</p>
<h4 data-id="heading-10">实际业务应用</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    <span class="hljs-comment">// 订单金额（分）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> orderAmount;
    <span class="hljs-comment">// 优惠金额（分）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> discountAmount;
    <span class="hljs-comment">// 实付金额（分）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">long</span> actualAmount;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">calculateOrder</span><span class="hljs-params">(<span class="hljs-type">long</span> unitPrice, <span class="hljs-type">int</span> quantity, <span class="hljs-type">long</span> discountRate)</span> {
        <span class="hljs-comment">// 计算订单金额</span>
        orderAmount = unitPrice * quantity;
        
        <span class="hljs-comment">// 计算优惠金额</span>
        discountAmount = (orderAmount * discountRate) / <span class="hljs-number">100</span>;
        
        <span class="hljs-comment">// 计算实付金额</span>
        actualAmount = orderAmount - discountAmount;
    }
    
    <span class="hljs-comment">// 显示方法</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDisplayAmount</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"订单金额: %s, 优惠: %s, 实付: %s"</span>, 
            formatFen(orderAmount),
            formatFen(discountAmount),
            formatFen(actualAmount));
    }
    
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">formatFen</span><span class="hljs-params">(<span class="hljs-type">long</span> fen)</span> {
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"¥%.2f"</span>, fen / <span class="hljs-number">100.0</span>);
    }
}
</code></pre>
<h3 data-id="heading-11">四、各种方案的适用场景</h3>
<h4 data-id="heading-12">double/float：绝对不要用于金额</h4>
<ul>
<li>科学计算、图形处理</li>
<li>统计分析（允许误差）</li>
<li>物理模拟</li>
<li>不适用于任何金额计算</li>
</ul>
<h4 data-id="heading-13">BigDecimal：复杂金融计算</h4>
<ul>
<li>高精度利率、汇率计算</li>
<li>税务计算（需要复杂小数运算）</li>
<li>银行核心系统</li>
<li>需要任意精度的场景</li>
</ul>
<h4 data-id="heading-14">long：大多数业务系统</h4>
<ul>
<li>电商订单系统</li>
<li>支付系统</li>
<li>账户余额管理</li>
<li>积分、优惠券系统</li>
</ul>
<h3 data-id="heading-15">五、BigDecimal的最佳实践</h3>
<p>如果确实需要使用BigDecimal，请遵循以下规则：</p>
<h4 data-id="heading-16">1. 构造方法</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 推荐</span>
<span class="hljs-type">BigDecimal</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.1"</span>);
<span class="hljs-type">BigDecimal</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> BigDecimal.valueOf(<span class="hljs-number">0.1</span>);  <span class="hljs-comment">// 内部转字符串</span>

<span class="hljs-comment">// 避免</span>
<span class="hljs-type">BigDecimal</span> <span class="hljs-variable">c</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-number">0.1</span>);      <span class="hljs-comment">// 精度问题</span>
</code></pre>
<h4 data-id="heading-17">2. 运算控制</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">BigDecimal</span> <span class="hljs-variable">num1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"10.00"</span>);
<span class="hljs-type">BigDecimal</span> <span class="hljs-variable">num2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"3.00"</span>);

<span class="hljs-comment">// 除法必须指定精度</span>
<span class="hljs-type">BigDecimal</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> num1.divide(num2, <span class="hljs-number">4</span>, RoundingMode.HALF_UP);

<span class="hljs-comment">// 乘法建议控制精度</span>
<span class="hljs-type">BigDecimal</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> num1.multiply(num2).setScale(<span class="hljs-number">2</span>, RoundingMode.HALF_UP);
</code></pre>
<h4 data-id="heading-18">3. 数值比较</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">BigDecimal</span> <span class="hljs-variable">amount1</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"100.00"</span>);
<span class="hljs-type">BigDecimal</span> <span class="hljs-variable">amount2</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"100.000"</span>);

<span class="hljs-comment">// 正确</span>
<span class="hljs-keyword">if</span> (amount1.compareTo(amount2) == <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// 数值相等</span>
}

<span class="hljs-comment">// 错误</span>
<span class="hljs-keyword">if</span> (amount1.equals(amount2)) {
    <span class="hljs-comment">// 不会执行，因为精度不同</span>
}
</code></pre>
<h3 data-id="heading-19">六、long方案的实施建议</h3>
<h4 data-id="heading-20">1. 建立工具类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MoneyUtils</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">MoneyUtils</span><span class="hljs-params">()</span> {} <span class="hljs-comment">// 工具类，防止实例化</span>
    
    <span class="hljs-comment">// 元转分</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">yuanToFen</span><span class="hljs-params">(<span class="hljs-type">double</span> yuan)</span> {
        <span class="hljs-keyword">return</span> Math.round(yuan * <span class="hljs-number">100</span>);
    }
    
    <span class="hljs-comment">// 分转元（显示用）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">fenToDisplayYuan</span><span class="hljs-params">(<span class="hljs-type">long</span> fen)</span> {
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"¥%.2f"</span>, fen / <span class="hljs-number">100.0</span>);
    }
    
    <span class="hljs-comment">// 分转元（计算用）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">double</span> <span class="hljs-title function_">fenToYuan</span><span class="hljs-params">(<span class="hljs-type">long</span> fen)</span> {
        <span class="hljs-keyword">return</span> fen / <span class="hljs-number">100.0</span>;
    }
    
    <span class="hljs-comment">// 金额加法（防止溢出）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">long</span> amount1, <span class="hljs-type">long</span> amount2)</span> {
        <span class="hljs-keyword">return</span> Math.addExact(amount1, amount2);
    }
    
    <span class="hljs-comment">// 金额乘法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">long</span> <span class="hljs-title function_">multiply</span><span class="hljs-params">(<span class="hljs-type">long</span> amount, <span class="hljs-type">int</span> multiplier)</span> {
        <span class="hljs-keyword">return</span> Math.multiplyExact(amount, multiplier);
    }
}
</code></pre>
<h4 data-id="heading-21">2. 数据库设计</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 使用bigint存储金额（分）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    order_amount <span class="hljs-type">BIGINT</span> COMMENT <span class="hljs-string">'订单金额（分）'</span>,
    discount_amount <span class="hljs-type">BIGINT</span> COMMENT <span class="hljs-string">'优惠金额（分）'</span>,
    actual_amount <span class="hljs-type">BIGINT</span> COMMENT <span class="hljs-string">'实付金额（分）'</span>
);
</code></pre>
<h4 data-id="heading-22">3. API设计</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 请求和响应中使用Long类型表示金额（分）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderRequest</span> {
    <span class="hljs-keyword">private</span> Long productId;
    <span class="hljs-keyword">private</span> Integer quantity;
    <span class="hljs-keyword">private</span> Long unitPrice;  <span class="hljs-comment">// 单价（分）</span>
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderResponse</span> {
    <span class="hljs-keyword">private</span> String orderNo;
    <span class="hljs-keyword">private</span> Long totalAmount;  <span class="hljs-comment">// 总金额（分）</span>
    <span class="hljs-keyword">private</span> String displayAmount; <span class="hljs-comment">// 显示金额 "¥99.99"</span>
}
</code></pre>
<h3 data-id="heading-23">总结与选择</h3>
<h4 data-id="heading-24">为什么那个项目选择long？</h4>
<p>现在我可以理解那个项目的设计思路了：</p>
<ol>
<li><strong>业务特性</strong>：主要是简单的加减乘运算，没有复杂的小数除法</li>
<li><strong>性能要求</strong>：高并发场景，需要最优性能</li>
<li><strong>团队协作</strong>：统一规范，避免BigDecimal的误用</li>
<li><strong>系统复杂度</strong>：降低系统复杂度和维护成本</li>
</ol>
<h4 data-id="heading-25">如何选择？</h4>



































<table><thead><tr><th>场景</th><th>推荐方案</th><th>理由</th></tr></thead><tbody><tr><td>简单业务系统</td><td><strong>long</strong></td><td>性能好，简单可靠</td></tr><tr><td>银行金融系统</td><td><strong>BigDecimal</strong></td><td>精度要求极高</td></tr><tr><td>高并发交易</td><td><strong>long</strong></td><td>性能至关重要</td></tr><tr><td>复杂税务计算</td><td><strong>BigDecimal</strong></td><td>需要复杂小数运算</td></tr><tr><td>新项目启动</td><td><strong>long</strong></td><td>技术债务少</td></tr></tbody></table>
<p>技术选型从来都不是单一的，理解业务的需求，能选择出最适合的技术方案就是最好的方案。</p>
<blockquote>
<p>本文首发于公众号：程序员刘大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote>
<h4 data-id="heading-26">📌往期精彩</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2F6V83qjR6u0nyfzL-14xYAw" target="_blank" title="https://mp.weixin.qq.com/s/6V83qjR6u0nyfzL-14xYAw" ref="nofollow noopener noreferrer">《async/await 到底要不要加 try-catch？异步错误处理最佳实践》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FPQ_w7CDVoIZPn-CVH2DKJg" target="_blank" title="https://mp.weixin.qq.com/s/PQ_w7CDVoIZPn-CVH2DKJg" ref="nofollow noopener noreferrer">《Vue3 和 Vue2 的核心区别？很多开发者都没完全搞懂的 10 个细节》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fp0n2mN5RDDDaIWuHHVRUZQ" target="_blank" title="https://mp.weixin.qq.com/s/p0n2mN5RDDDaIWuHHVRUZQ" ref="nofollow noopener noreferrer">《Java 开发必看：什么时候用 for，什么时候用 Stream？》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FqI3TRTdDfRJSH9kCTqAQUw" target="_blank" title="https://mp.weixin.qq.com/s/qI3TRTdDfRJSH9kCTqAQUw" ref="nofollow noopener noreferrer">《这 10 个 MySQL 高级用法，让你的代码又快又好看》</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangGraph1.0速通指南（二）—— LangGraph1.0 条件边、记忆、人在回路]]></title>    <link>https://juejin.cn/post/7585553799298056238</link>    <guid>https://juejin.cn/post/7585553799298056238</guid>    <pubDate>2025-12-21T05:49:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585553799298056238" data-draft-id="7585076863820660787" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangGraph1.0速通指南（二）—— LangGraph1.0 条件边、记忆、人在回路"/> <meta itemprop="keywords" content="人工智能,Agent,LangChain"/> <meta itemprop="datePublished" content="2025-12-21T05:49:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型真好玩"/> <meta itemprop="url" content="https://juejin.cn/user/3140624091453053"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangGraph1.0速通指南（二）—— LangGraph1.0 条件边、记忆、人在回路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3140624091453053/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型真好玩
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T05:49:52.000Z" title="Sun Dec 21 2025 05:49:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">前言</h2>
<p>上篇内容《<a href="https://juejin.cn/post/7584689488770252835" target="_blank" title="https://juejin.cn/post/7584689488770252835">LangGraph1.0速通指南（一）—— 核心概念、点、边</a>》中笔者介绍了LangGraph 的基本概念，以及如何通过定义节点与边来构建多种图结构。有了这些基础，大家已经能够搭建起一个可运行的智能体工作流。</p>
<p>在本文中笔者将进一步展开 LangGraph 更为灵活和强大的能力。你将学习到：</p>
<ul>
<li><strong>条件边（Conditional Edges）</strong> ：除条件函数外，如何让图结构根据运行时的状态动态选择下一步路径，实现分支与循环逻辑；</li>
<li><strong>记忆（Memory）</strong> ：如何让 LangGraph 在多次调用中保留和更新状态，构建LangGraph持续运行的能力</li>
<li><strong>人在回路（Human-in-the-loop）</strong> ：如何在关键节点引入人工确认或干预，使LangGraph图更加可控、可靠。</li>
</ul>
<p>LangGraph1.0 与先前版本变动不大，预计花费三节左右的时间讲解，同时也要说明笔者的专栏<a href="https://juejin.cn/column/7526240014499495972" target="_blank" title="https://juejin.cn/column/7526240014499495972">《深入浅出LangChain&amp;LangGraph AI Agent 智能体开发》</a>适合所有对 LangChain 感兴趣的学习者，无论之前是否接触过 LangChain。该专栏基于笔者在实际项目中的深度使用经验，系统讲解了使用LangChain/LangGraph如何开发智能体，目前已更新 32 讲，并持续补充实战与拓展内容。欢迎感兴趣的同学关注笔者的掘金账号与专栏，也可关注笔者的同名微信公众号 <strong>大模型真好玩</strong>，每期分享涉及的代码均可在公众号私信: <strong>LangChain智能体开发</strong>免费获取。</p>
<h2 data-id="heading-1">一、使用Command对象：边定义的第二种方法</h2>
<p>上篇内容《<a href="https://juejin.cn/post/7584689488770252835" target="_blank" title="https://juejin.cn/post/7584689488770252835">LangGraph1.0速通指南（一）—— 核心概念、点、边</a>》中笔者介绍了通过 <code>add_conditional_edges</code> 配合条件路由函数来定义边的方法。该函数根据图的状态返回下一个节点的名称，从而实现动态路由。</p>
<pre><code class="hljs language-python" lang="python">...
<span class="hljs-keyword">def</span> <span class="hljs-title function_">conditional_edge</span>(<span class="hljs-params">state: State</span>) -&gt; <span class="hljs-type">Literal</span>[<span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, END]:
    select = state[<span class="hljs-string">"nList"</span>][-<span class="hljs-number">1</span>]
    <span class="hljs-keyword">if</span> select == <span class="hljs-string">"b"</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'b'</span>
    <span class="hljs-keyword">elif</span> select == <span class="hljs-string">'c'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">'c'</span>
    <span class="hljs-keyword">elif</span> select == <span class="hljs-string">'q'</span>:
        <span class="hljs-keyword">return</span> END
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">return</span> END

...


builder.add_conditional_edges(<span class="hljs-string">"a"</span>, conditional_edge)
</code></pre>
<p>这是一种将<strong>路由逻辑</strong>（边）与<strong>节点执行逻辑</strong>（点）分离的清晰模式。然而，LangGraph 提供了另一种更为直接的控制流方式：允许节点函数在返回时，不仅更新状态，还能<strong>显式指定接下来要执行的节点</strong>。这是通过返回一个特殊的 <code>langgraph.types.Command</code> 对象来实现的。</p>
<h3 data-id="heading-2">1.1 <code>Command</code> 对象：将路由逻辑内置于节点</h3>
<p><code>Command</code> 对象主要有两个关键指令：</p>
<ul>
<li><strong><code>update</code></strong>: 用于更新图的状态。</li>
<li><strong><code>goto</code></strong>: 用于指定下一个要执行的节点。</li>
</ul>
<p>这意味着可以在节点的处理函数内部，直接决定工作流的下一步走向，无需提前在图中定义好所有条件边。对于下图中的节点A，笔者希望在执行其逻辑后，根据当前状态选择跳转节点B或节点C：</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3241372ced94feb926336ab2ffb2365~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766900991&amp;x-signature=uUI4mGzZtHpCbTDX03L%2BXbw4nbY%3D" alt="11.png" width="50%" loading="lazy"/></p>
<p>这就需要重写<code>node_a</code>函数</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">node_a</span>(<span class="hljs-params">state: State</span>) -&gt; Command[<span class="hljs-type">Literal</span>[<span class="hljs-string">'b'</span>,<span class="hljs-string">'c'</span>, END]]:
    select = state[<span class="hljs-string">'nList'</span>][-<span class="hljs-number">1</span>]
    <span class="hljs-keyword">if</span> select == <span class="hljs-string">'b'</span>:
        next_node = <span class="hljs-string">'b'</span>
    <span class="hljs-keyword">elif</span> select == <span class="hljs-string">'c'</span>:
        next_node = <span class="hljs-string">'c'</span>
    <span class="hljs-keyword">elif</span> select == <span class="hljs-string">'q'</span>:
        next_node = END
    <span class="hljs-keyword">else</span>:
        next_node = END

    <span class="hljs-keyword">return</span> Command(
        update=State(nList=[select]),
        goto=next_node
    )
</code></pre>
<h3 data-id="heading-3">1.2 完整示例与执行过程分析</h3>
<ol>
<li>
<p>将这种思路应用到<a href="https://juejin.cn/post/7584689488770252835" target="_blank" title="https://juejin.cn/post/7584689488770252835">上篇文章</a>的条件图结构中，完整的代码如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> START, END, StateGraph
<span class="hljs-keyword">import</span> operator
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> TypedDict, <span class="hljs-type">List</span>, Annotated, <span class="hljs-type">Literal</span>

<span class="hljs-keyword">from</span> langgraph.types <span class="hljs-keyword">import</span> Command


<span class="hljs-keyword">class</span> <span class="hljs-title class_">State</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    nList: Annotated[<span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>], operator.add]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">node_a</span>(<span class="hljs-params">state: State</span>) -&gt; Command[<span class="hljs-type">Literal</span>[<span class="hljs-string">'b'</span>,<span class="hljs-string">'c'</span>, END]]:
    select = state[<span class="hljs-string">'nList'</span>][-<span class="hljs-number">1</span>]
    <span class="hljs-keyword">if</span> select == <span class="hljs-string">'b'</span>:
        next_node = <span class="hljs-string">'b'</span>
    <span class="hljs-keyword">elif</span> select == <span class="hljs-string">'c'</span>:
        next_node = <span class="hljs-string">'c'</span>
    <span class="hljs-keyword">elif</span> select == <span class="hljs-string">'q'</span>:
        next_node = END
    <span class="hljs-keyword">else</span>:
        next_node = END

    <span class="hljs-keyword">return</span> Command(
        update=State(nList=[select]),
        goto=next_node
    )

<span class="hljs-keyword">def</span> <span class="hljs-title function_">node_b</span>(<span class="hljs-params">state: State</span>):
    <span class="hljs-keyword">return</span> Command(
        goto=END
    )

<span class="hljs-keyword">def</span> <span class="hljs-title function_">node_c</span>(<span class="hljs-params">state: State</span>):
    <span class="hljs-keyword">return</span> Command(
        goto=END
    )



builder = StateGraph(State)
builder.add_node(<span class="hljs-string">"a"</span>, node_a)
builder.add_node(<span class="hljs-string">"b"</span>, node_b)
builder.add_node(<span class="hljs-string">"c"</span>, node_c)

builder.add_edge(START, <span class="hljs-string">"a"</span>)

graph = builder.<span class="hljs-built_in">compile</span>()

user = <span class="hljs-built_in">input</span>(<span class="hljs-string">'b, c or q to quit:'</span>)
input_state = State(
    nList=[user]
)
<span class="hljs-built_in">print</span>(graph.invoke(input_state))
</code></pre>
</li>
<li>
<p>运行测试，分析输入 <code>'b'</code> 时的执行过程：</p>
<ol>
<li>
<p><strong>初始状态</strong>：<code>State(nList=['b'])</code></p>
</li>
<li>
<p><strong>执行节点 A</strong>：</p>
<ul>
<li>读取状态 <code>nList[-1]</code>，得到 <code>'b'</code>。</li>
<li>逻辑判断 <code>next_node = 'b'</code>。</li>
<li>返回 <code>Command(update=State(nList=['b']), goto='b')</code>。</li>
<li><strong>状态更新</strong>：<code>update</code> 指令将 <code>['b']</code> 追加到原状态。由于 <code>reducer</code> 是 <code>operator.add</code>，状态变为 <code>nList=['b', 'b']</code>。</li>
</ul>
</li>
<li>
<p><strong>跳转与执行</strong>：根据 <code>goto='b'</code>，图跳转到节点 B。</p>
</li>
<li>
<p><strong>执行节点 B</strong>：节点 B 返回 <code>Command(goto=END)</code>，图运行结束。</p>
</li>
<li>
<p><strong>最终输出状态</strong>：<code>{'nList': ['b', 'b']}</code>。</p>
</li>
<li>
<p>输入 <code>'c'</code> 或其它字符（如 <code>'q'</code>）的逻辑类似，最终状态会分别为 <code>['c', 'c']</code> 或 <code>['q']</code>。</p>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b84048c3efda405a942524107eb77535~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766900991&amp;x-signature=7cbFmvF%2BDAvRLzeUkTHYcWvqCeo%3D" alt="0.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fcd83efd58cd4c2dafc63bc223035b34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766900991&amp;x-signature=xUiiv02Xx5YXJukrOIcRY9xAuBs%3D" alt="1.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3dfdd975dd93434782b2b37cbd2de5ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766900991&amp;x-signature=4uuCKOpO1BnjWnZImnxyQ%2BV2azQ%3D" alt="2.png" loading="lazy"/></p>
</li>
</ol>
<h3 data-id="heading-4">1.3 方法对比选型</h3>
<p>虽然 <code>Command</code> 对象提供了强大的、由节点驱动流程的能力，但在大多数智能体工作流的设计中，<strong>笔者更推荐使用 <code>add_conditional_edges</code> 配合条件路由函数的方式来定义边</strong>。</p>
<p>主要原因在于“<strong>关注点分离</strong>”和“<strong>可维护性</strong>”。将“做什么”（节点逻辑）和“接下来去哪”（路由逻辑）分开定义，使得图的结构更加清晰、易于理解和调试。图的<code>builder</code>本身就能完整反映业务逻辑的流转，而不是将控制流隐藏在节点的实现细节里。</p>
<p>因此，<code>Command</code> 方案更适合作为一种高级或特定场景下的补充手段，而在构建清晰、可维护的 LangGraph 应用时，应优先考虑使用条件边函数来定义路由。</p>
<h2 data-id="heading-5">二、Memory：实现智能体的长期记忆</h2>
<p>在 LangGraph 的工作流中，节点按顺序执行，状态随之更新。然而，这种状态默认只存在于单次调用（<code>invoke</code>）的生命周期内。为了让智能体像人类一样拥有“记忆”，能够在多次交互中记住上下文（例如，像在 DeepSeek 网页中进行的多轮对话），LangGraph 提供了<strong>检查点（Checkpoint）</strong> 机制。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d46e8df421a74a97b8c4287d672a4904~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766900991&amp;x-signature=bRw%2BY6WYtLiUYA0Out5K1qADqFo%3D" alt="3.png" loading="lazy"/></p>
<h3 data-id="heading-6">2.1 理解检查点：状态快照与线程</h3>
<p><strong>检查点</strong>是 LangGraph 实现记忆功能的核心。它本质上是在图运行的<strong>关键步骤（如每个节点执行后）</strong>  对当前完整状态进行的一次快照（Snapshot），并将其持久化存储。这个过程类似于为虚拟机保存恢复点。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03113417b6ff41aa886a3354eaf40710~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766900991&amp;x-signature=93B11SD2S34w70cjsODo3lWRc6A%3D" alt="4.png" loading="lazy"/></p>
<p>这些按时间顺序排列的检查点集合，构成了一个<strong>线程（Thread）</strong> 。在线程中，每次<code>graph.invoke</code>调用的历史记录都被完整保存。这解释了为何在 DeepSeek 中，“新对话”会开启一个没有历史的纯净会话——因为它开启了一个新的线程。</p>
<p><strong>检查点的核心优势：</strong></p>
<p>引入检查点机制为智能体开发带来了如下关键能力：</p>
<ol>
<li><strong>状态持久化</strong>：即使图停止运行，状态也能被保留，下次可从断点恢复。</li>
<li><strong>错误恢复与重试</strong>：当某个节点执行失败时，可以从上一个检查点恢复状态并重试，避免丢失全部进度。</li>
<li><strong>时间旅行与回滚</strong>：如果发现智能体在长期运行后“跑偏”，可以回滚到任意历史检查点，并从该健康状态重新开始。</li>
<li><strong>暂停与继续</strong>：可以暂停一个长时间运行的任务，并在之后准确地从中断处继续执行。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed9c7cc7f3d341549297021aaa8a7f69~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766900991&amp;x-signature=KCMKPWXf83qswoFh350OtOFdQ7s%3D" alt="5.png" loading="lazy"/></p>
<h3 data-id="heading-7">2.2 实战：使用内存检查点器</h3>
<p>LangGraph 提供了多种检查点存储后端，包括内存 (<code>InMemorySaver</code>)、Postgres数据库等。本篇分享笔者以最简单的内存检查点器为例进行演示。其他存储器的用法类似，大家可以在笔者的文章《<a href="https://juejin.cn/post/7555795679382831113" target="_blank" title="https://juejin.cn/post/7555795679382831113">深入浅出LangGraph AI Agent智能体开发教程（九）—LangGraph长短期记忆管理</a>》中查看详细示例。</p>
<ol>
<li>
<p><strong>构建基础图：</strong> 复用上一节中基于 <code>Command</code> 对象的路由图结构。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> START, END, StateGraph
<span class="hljs-keyword">import</span> operator
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> TypedDict, <span class="hljs-type">List</span>, Annotated, <span class="hljs-type">Literal</span>
<span class="hljs-keyword">from</span> langgraph.types <span class="hljs-keyword">import</span> Command


<span class="hljs-keyword">class</span> <span class="hljs-title class_">State</span>(<span class="hljs-title class_ inherited__">TypedDict</span>):
    nList: Annotated[<span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>], operator.add]

<span class="hljs-keyword">def</span> <span class="hljs-title function_">node_a</span>(<span class="hljs-params">state: State</span>) -&gt; Command[<span class="hljs-type">Literal</span>[<span class="hljs-string">'b'</span>,<span class="hljs-string">'c'</span>, END]]:
    select = state[<span class="hljs-string">'nList'</span>][-<span class="hljs-number">1</span>]
    <span class="hljs-keyword">if</span> select == <span class="hljs-string">'b'</span>:
        next_node = <span class="hljs-string">'b'</span>
    <span class="hljs-keyword">elif</span> select == <span class="hljs-string">'c'</span>:
        next_node = <span class="hljs-string">'c'</span>
    <span class="hljs-keyword">elif</span> select == <span class="hljs-string">'q'</span>:
        next_node = END
    <span class="hljs-keyword">else</span>:
        next_node = END

    <span class="hljs-keyword">return</span> Command(
        update=State(nList=[select]),
        goto=next_node
    )

<span class="hljs-keyword">def</span> <span class="hljs-title function_">node_b</span>(<span class="hljs-params">state: State</span>):
    <span class="hljs-keyword">return</span> Command(
        goto=END
    )

<span class="hljs-keyword">def</span> <span class="hljs-title function_">node_c</span>(<span class="hljs-params">state: State</span>):
    <span class="hljs-keyword">return</span> Command(
        goto=END
    )



builder = StateGraph(State)
builder.add_node(<span class="hljs-string">"a"</span>, node_a)
builder.add_node(<span class="hljs-string">"b"</span>, node_b)
builder.add_node(<span class="hljs-string">"c"</span>, node_c)

builder.add_edge(START, <span class="hljs-string">"a"</span>)
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b722abc84f14ee58c82d373e2cfbafd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766900991&amp;x-signature=FL1pDzjXcEu%2B%2FoUktJxa%2FvqWD%2F8%3D" alt="11.png" loading="lazy"/></p>
</li>
<li>
<p><strong>引入内存检查点器：</strong> 从 <code>langgraph.checkpoint.memory</code> 导入 <code>InMemorySaver</code>，并实例化。<code>config</code> 中的 <code>thread_id</code> 是关键，它标识了会话线程。相同 <code>thread_id</code> 下的所有调用将共享状态历史。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.checkpoint.memory <span class="hljs-keyword">import</span> InMemorySaver

memory = InMemorySaver()

config = {
    <span class="hljs-string">"configurable"</span>:{
        <span class="hljs-string">"thread_id"</span>, <span class="hljs-string">"1"</span>
    }
}
</code></pre>
</li>
<li>
<p><strong>编译时启用检查点：</strong> 在编译图时，通过 <code>checkpointer</code> 参数传入检查点器实例。</p>
<pre><code class="hljs language-python" lang="python">graph = builder.<span class="hljs-built_in">compile</span>(checkpointer=memory)
</code></pre>
</li>
<li>
<p><strong>在循环调用中体验记忆：</strong> 现在笔者通过一个循环来模拟多轮交互。关键在于，每次调用 <code>graph.invoke</code> 时都传入相同的 <code>config</code>，这样 LangGraph 就会自动加载该线程 (<code>thread_id=’1’</code>) 的上一次状态，并在执行后保存新状态。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
    user = <span class="hljs-built_in">input</span>(<span class="hljs-string">'b, c or q to quit:'</span>)
    input_state = State(
        nList=[user]
    )
    result = graph.invoke(input_state, config)
    <span class="hljs-built_in">print</span>(result)
    <span class="hljs-keyword">if</span> result[<span class="hljs-string">'nList'</span>][-<span class="hljs-number">1</span>] == <span class="hljs-string">'q'</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'quit'</span>)
        <span class="hljs-keyword">break</span>
</code></pre>
</li>
<li>
<p><strong>运行测试：</strong> 输入序列：<code>b → c → b → q</code>，<strong>执行过程解析：</strong></p>
<ul>
<li><strong>第一轮 (<code>输入b</code>)</strong> ：初始状态 <code>[‘b’]</code>。节点A执行后更新状态为 <code>[‘b’, ‘b’]</code> 并跳转到节点B，最终状态为 <code>[‘b’, ‘b’]</code>。</li>
<li><strong>第二轮 (<code>输入c</code>)</strong> ：由于检查点存在，<strong>初始状态并非空列表，而是上一轮的最终状态 <code>[‘b’, ‘b’]</code></strong> 。输入<code>c</code>后，状态会累积到<code>['b','b','c','c']</code></li>
<li><strong>第三轮 (<code>输入b</code>)</strong> ：状态继续累积。</li>
<li><strong>第四轮 (<code>输入q</code>)</strong> ：触发退出。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2cf98c7e0fd64db1888d653b7e30a768~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766900991&amp;x-signature=TIJc48xa5OR%2FhzwE%2Fi4DiUq3dU4%3D" alt="6.png" loading="lazy"/></p>
</li>
<li>
<p>通过简单的几步配置,LangGraph图即可具备“记忆”能力。<code>thread_id</code> 是管理不同记忆会话的钥匙。只要使用相同的 <code>thread_id</code>，智能体就能在多次调用间保持并累积状态。对于生产环境，只需将 <code>InMemorySaver</code> 替换为 <code>PostgresSaver</code> 或自定义的持久化检查点器，即可实现稳定可靠的长期记忆。更详细的关于LangGraph记忆的内容大家可参考笔者的文章： <a href="https://juejin.cn/post/7555795679382831113" target="_blank" title="https://juejin.cn/post/7555795679382831113">深入浅出LangGraph AI Agent智能体开发教程（九）—LangGraph长短期记忆管理</a></p>
</li>
</ol>
<h2 data-id="heading-8">三、中断与人在回路</h2>
<p>在许多实际场景中需要在智能体工作流的关键节点引入人工判断。例如，在大模型调用工具执行数据库写操作、发送邮件或进行其他高风险动作前，必须由人工确认。LangGraph 通过<strong>中断（Interrupt）</strong>  机制优雅地支持了这种“人在回路（Human-in-the-loop）”模式。</p>
<p>中断允许一个正在运行的图在特定节点暂停，将控制权交还给外部程序（通常是等待用户输入），然后根据外部输入的结果决定如何恢复执行。这个强大的功能同样建立在之前介绍的<strong>检查点（Checkpoint）</strong>  机制之上。</p>
<p align="center"><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5b722abc84f14ee58c82d373e2cfbafd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766900991&amp;x-signature=FL1pDzjXcEu%2B%2FoUktJxa%2FvqWD%2F8%3D" alt="11.png" width="50%" loading="lazy"/></p>
<h3 data-id="heading-9">3.1 核心概念：<code>interrupt</code> 与 <code>Command(resume=...)</code></h3>
<p>继续改造之前使用的条件路由图。核心改动在于，当节点 <code>A</code> 遇到无法处理的输入时，不再直接结束，而是<strong>主动引发一个中断</strong>，等待外部干预。</p>
<p><strong>实现中断需要两个关键操作：</strong></p>
<ol>
<li><strong>在节点内引发中断</strong>：使用 <code>interrupt()</code> 函数。这会抛出一个特殊信号，使图立即暂停运行，并将包含中断信息的快照保存到检查点中。</li>
<li><strong>从外部恢复执行</strong>：向图中发送一个带有 <code>resume</code> 指令的 <code>Command</code> 对象。这个指令的值会传递回引发中断的节点，作为其 <code>interrupt()</code> 调用的返回值，从而使节点得以继续执行。</li>
</ol>
<h3 data-id="heading-10">3.2 示例：中断代码实战</h3>
<ol>
<li>
<p>笔者对之前的 <code>node_a</code> 进行修改。当用户输入不是预期的 <code>‘b’</code>， <code>‘c’</code> 或 <code>‘q’</code> 时，触发中断。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">node_a</span>(<span class="hljs-params">state: State</span>) -&gt; Command[<span class="hljs-type">Literal</span>[<span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, END]]:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'进入 A 节点'</span>)
    select = state[<span class="hljs-string">'nList'</span>][-<span class="hljs-number">1</span>]
    <span class="hljs-keyword">if</span> select == <span class="hljs-string">'b'</span>:
        next_node = <span class="hljs-string">'b'</span>
    <span class="hljs-keyword">elif</span> select == <span class="hljs-string">'c'</span>:
        next_node = <span class="hljs-string">'c'</span>
    <span class="hljs-keyword">elif</span> select == <span class="hljs-string">'q'</span>:
        next_node = END
    <span class="hljs-keyword">else</span>:
        admin = interrupt(<span class="hljs-string">f"未期望的输出 <span class="hljs-subst">{select}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'用户重新输入是:'</span>,admin)
        <span class="hljs-keyword">if</span> admin == <span class="hljs-string">'continue'</span>:
            next_node = <span class="hljs-string">'b'</span>
            select = <span class="hljs-string">'b'</span>
        <span class="hljs-keyword">else</span>:
            next_node = END
            select = <span class="hljs-string">'q'</span>

    <span class="hljs-keyword">return</span> Command(
        update=State(nList=[select]),
        goto=next_node
    )
</code></pre>
</li>
<li>
<p>构建图并启用检查点，中断依赖检查点来保存和恢复状态，因此必须配置检查点器。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> START, END, StateGraph
<span class="hljs-keyword">from</span> langgraph.checkpoint.memory <span class="hljs-keyword">import</span> InMemorySaver

<span class="hljs-comment"># 构建图</span>
builder = StateGraph(State)
builder.add_node(<span class="hljs-string">"a"</span>, node_a)
builder.add_node(<span class="hljs-string">"b"</span>, node_b)
builder.add_node(<span class="hljs-string">"c"</span>, node_c)
builder.add_edge(START, <span class="hljs-string">"a"</span>)

<span class="hljs-comment"># 配置内存检查点器和线程</span>
memory = InMemorySaver()
config = {<span class="hljs-string">"configurable"</span>: {<span class="hljs-string">"thread_id"</span>: <span class="hljs-string">"1"</span>}}

<span class="hljs-comment"># 编译时传入检查点器</span>
graph = builder.<span class="hljs-built_in">compile</span>(checkpointer=memory)
</code></pre>
</li>
<li>
<p>实现外部中断处理循环:</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
    user = <span class="hljs-built_in">input</span>(<span class="hljs-string">'b, c or q to quit:'</span>)
    input_state = State(
        nList=[user]
    )
    result = graph.invoke(input_state, config)
    <span class="hljs-built_in">print</span>(result)

    <span class="hljs-keyword">if</span> <span class="hljs-string">'__interrupt__'</span> <span class="hljs-keyword">in</span> result:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f'Interrupt:<span class="hljs-subst">{result}</span>'</span>)
        msg = result[<span class="hljs-string">'__interrupt__'</span>][-<span class="hljs-number">1</span>].value
        <span class="hljs-built_in">print</span>(msg)
        human = <span class="hljs-built_in">input</span>(<span class="hljs-string">f"\n<span class="hljs-subst">{msg}</span>, 重新输入: "</span>)
        human_response = Command(
            resume=human
        )
        result = graph.invoke(human_response, config)

    <span class="hljs-keyword">if</span> result[<span class="hljs-string">'nList'</span>][-<span class="hljs-number">1</span>] == <span class="hljs-string">'q'</span>:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'quit'</span>)
        <span class="hljs-keyword">break</span>
</code></pre>
</li>
<li>
<p>运行结果分析：假设输入 <code>p</code>（一个非法值），流程如下：</p>
<ul>
<li><strong>触发中断</strong>：节点A识别到 <code>p</code>，调用 <code>interrupt(“未预期的输入...”</code>。图在此刻<strong>立即暂停</strong>，并将当前状态（包括中断信息）保存为检查点。<code>graph.invoke</code> 返回的结果中会包含一个特殊的 <code>__interrupt__</code> 字段。</li>
<li><strong>人工干预</strong>：外部循环检测到中断，打印信息并等待用户输入。用户输入 <code>continue</code>。</li>
<li><strong>恢复执行</strong>：外部程序构建一个 <code>Command(resume=’continue’)</code> 并再次调用 <code>graph.invoke</code>。<strong>关键点</strong>：因为使用了相同的 <code>thread_id</code>，图会从上一个检查点（即中断处）恢复。</li>
<li><strong>节点继续运行</strong>：恢复后，节点A中 <code>interrupt()</code> 调用处将返回 <code>admin_decision = ‘continue’</code>。程序流程进入 <code>if admin_decision == 'continue'</code> 分支，最终前往节点B并结束。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6247d250bc814348bbcb6c5c042535b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L55yf5aW9546p:q75.awebp?rk3s=f64ab15b&amp;x-expires=1766900991&amp;x-signature=UFMTe8VI6sQv%2BI6XXSlP3EjhhCA%3D" alt="8.png" loading="lazy"/></p>
<p><strong>重要说明</strong>：当图从中断点恢复时，整个图会重新执行。但由于检查点保存了中断前的状态（包括 <code>nList</code>），并且 <code>interrupt()</code> 会返回新的 <code>resume</code> 值，因此节点能基于新信息做出不同的决策。<code>__interrupt__</code> 是一个列表，因为一个图可以在不同节点触发多个中断，LangGraph 会跟踪所有中断的上下文。</p>
</li>
</ol>
<p>以上完整代码均可关注笔者同名微信公众号：<strong>大模型真好玩</strong>，并私信  <strong>LangChain智能体开发</strong> 获得</p>
<h2 data-id="heading-11">四、总结</h2>
<p>本期文章深入讲解了 LangGraph 1.0 的三大进阶功能：<strong>条件边</strong>（除条件函数外，还能通过 Command 对象实现节点内路由）、<strong>记忆</strong>（利用检查点机制实现状态持久化与多轮对话能力）以及<strong>人在回路</strong>（通过中断机制在关键节点引入人工干预）。现在大家就学习到了LangGraph的基本技能，但目前这些知识点还比较零碎，下篇分享笔者将结合大模型使用LangGraph编写一个智能体，帮助大家全局掌握这些知识点的用法，掌握LangGraph智能体开发的基本技能！</p>
<p><a href="https://juejin.cn/column/7526240014499495972" title="https://juejin.cn/column/7526240014499495972" target="_blank">《深入浅出LangChain&amp;LangGraph AI Agent 智能体开发》</a>专栏内容源自笔者在实际学习和工作中对 LangChain 与 LangGraph 的深度使用经验，旨在帮助大家系统性地、高效地掌握 AI Agent 的开发方法，在各大技术平台获得了不少关注与支持。目前已更新32讲，正在更新LangGraph1.0速通指南，并随时补充笔者在实际工作中总结的拓展知识点。如果大家感兴趣，欢迎关注笔者的掘金账号与专栏，也可关注笔者的同名微信公众号 <strong>大模型真好玩</strong>，每期分享涉及的代码均可在公众号私信: <strong>LangChain智能体开发</strong>免费获取。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[275. Java Stream API - flatMap 操作：展开一对多的关系，拉平你的流！]]></title>    <link>https://juejin.cn/post/7585502118459981843</link>    <guid>https://juejin.cn/post/7585502118459981843</guid>    <pubDate>2025-12-21T01:44:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7585502118459981843" data-draft-id="7585490245006737414" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="275. Java Stream API - flatMap 操作：展开一对多的关系，拉平你的流！"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2025-12-21T01:44:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Cache技术分享"/> <meta itemprop="url" content="https://juejin.cn/user/1662117313262776"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            275. Java Stream API - flatMap 操作：展开一对多的关系，拉平你的流！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1662117313262776/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Cache技术分享
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-12-21T01:44:48.000Z" title="Sun Dec 21 2025 01:44:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-12-21
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">275. Java Stream API - flatMap 操作：展开一对多的关系，拉平你的流！</h2>
<hr/>
<h4 data-id="heading-1">🧠 背景：我们为什么需要 <code>flatMap</code>？</h4>
<p>假设我们有以下结构：</p>
<ul>
<li>每个 <code>Country</code> 拥有多个 <code>City</code></li>
<li>每个 <code>City</code> 有一个人口数 <code>population</code></li>
</ul>
<p>我们的目标是：<strong>统计所有城市的总人口数</strong>。</p>
<p>最直接的写法当然是<strong>嵌套 for 循环</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">int</span> <span class="hljs-variable">totalPopulation</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
<span class="hljs-keyword">for</span> (Country country : countries) {
    <span class="hljs-keyword">for</span> (City city : country.cities()) {
        totalPopulation += city.population();
    }
}
System.out.println(<span class="hljs-string">"Total population = "</span> + totalPopulation);
</code></pre>
<p>📌 输出：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Total</span> <span class="hljs-variable">population</span> <span class="hljs-operator">=</span> <span class="hljs-number">24493</span>
</code></pre>
<p>虽然有效，但 <code>Java 8</code> 之后我们有了更优雅的方式：<strong>使用流 + <code>flatMap</code> 来处理一对多的关系</strong>。</p>
<hr/>
<h3 data-id="heading-2">🔁 用 <code>flatMap</code> 优雅替代嵌套循环</h3>
<h4 data-id="heading-3">✅ 定义模型结构</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">record</span> <span class="hljs-title class_">City</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> population)</span> {}
<span class="hljs-keyword">record</span> <span class="hljs-title class_">Country</span><span class="hljs-params">(String name, List&lt;City&gt; cities)</span> {}
</code></pre>
<h4 data-id="heading-4">✅ 初始化数据</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">City</span> <span class="hljs-variable">newYork</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-string">"New York"</span>, <span class="hljs-number">8_258</span>);
<span class="hljs-type">City</span> <span class="hljs-variable">losAngeles</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-string">"Los Angeles"</span>, <span class="hljs-number">3_821</span>);
<span class="hljs-type">Country</span> <span class="hljs-variable">usa</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Country</span>(<span class="hljs-string">"USA"</span>, List.of(newYork, losAngeles));

<span class="hljs-type">City</span> <span class="hljs-variable">london</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-string">"London"</span>, <span class="hljs-number">8_866</span>);
<span class="hljs-type">City</span> <span class="hljs-variable">manchester</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-string">"Manchester"</span>, <span class="hljs-number">568</span>);
<span class="hljs-type">Country</span> <span class="hljs-variable">uk</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Country</span>(<span class="hljs-string">"United Kingdom"</span>, List.of(london, manchester));

<span class="hljs-type">City</span> <span class="hljs-variable">paris</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-string">"Paris"</span>, <span class="hljs-number">2_103</span>);
<span class="hljs-type">City</span> <span class="hljs-variable">marseille</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">City</span>(<span class="hljs-string">"Marseille"</span>, <span class="hljs-number">877</span>);
<span class="hljs-type">Country</span> <span class="hljs-variable">france</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Country</span>(<span class="hljs-string">"France"</span>, List.of(paris, marseille));

List&lt;Country&gt; countries = List.of(usa, uk, france);
</code></pre>
<hr/>
<h4 data-id="heading-5">🚀 使用 <code>flatMap</code> 重写统计逻辑</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">int</span> <span class="hljs-variable">totalPopulation</span> <span class="hljs-operator">=</span> countries.stream()
                               .flatMap(country -&gt; country.cities().stream())  <span class="hljs-comment">// 展开所有城市</span>
                               .mapToInt(City::population)                     <span class="hljs-comment">// 提取人口</span>
                               .sum();                                         <span class="hljs-comment">// 累加总人口</span>

System.out.println(<span class="hljs-string">"Total population = "</span> + totalPopulation);
</code></pre>
<p>📌 输出：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Total</span> <span class="hljs-variable">population</span> <span class="hljs-operator">=</span> <span class="hljs-number">24493</span>
</code></pre>
<hr/>
<h3 data-id="heading-6">🔍 <code>flatMap</code> 是如何工作的？</h3>
<p><code>flatMap</code> 是两个操作的组合：</p>
<h4 data-id="heading-7">步骤 1️⃣：映射（map）</h4>
<pre><code class="hljs language-java" lang="java">country -&gt; country.cities().stream()
</code></pre>
<p>这一步将每个 <code>Country</code> 映射为它的城市流，得到的是一个 <code>Stream&lt;Stream&lt;City&gt;&gt;</code>（流的流）。</p>
<hr/>
<h4 data-id="heading-8">步骤 2️⃣：展平（flat）</h4>
<p><code>flatMap</code> 会<strong>自动帮你把多个子流合并为一个连续的扁平流</strong>（<code>Stream&lt;City&gt;</code>），这样你就可以对所有城市统一处理！</p>
<p>🎯 类比图示：</p>
<pre><code class="hljs language-java" lang="java">Stream&lt;Country&gt;  ---映射---&gt;  Stream&lt;Stream&lt;City&gt;&gt;
                     |
                     +---&gt;  展平（flatten）---&gt;  Stream&lt;City&gt;
</code></pre>
<hr/>
<h3 data-id="heading-9">📚 延伸案例：<code>Map</code> 结构的 <code>flatMap</code></h3>
<p>假设我们有一个 <code>Continent</code> 类型，它包含一个 Map：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">record</span> <span class="hljs-title class_">Continent</span><span class="hljs-params">(Map&lt;String, Country&gt; countries)</span> {}
</code></pre>
<p>此时，如果你想从 <code>Continent</code> 中提取所有国家，可以这样写：</p>
<pre><code class="hljs language-java" lang="java">Function&lt;Continent, Stream&lt;Country&gt;&gt; continentToCountry =
    continent -&gt; continent.countries().values().stream();
</code></pre>
<p>再进一步，还可以这样嵌套 <code>flatMap</code>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">int</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> continents.stream()
                      .flatMap(continent -&gt; continent.countries().values().stream())
                      .flatMap(country -&gt; country.cities().stream())
                      .mapToInt(City::population)
                      .sum();
</code></pre>
<hr/>
<h3 data-id="heading-10">🧠 小结：<code>flatMap</code> 用法口诀</h3>

























<table><thead><tr><th>用法场景</th><th>对应方法</th></tr></thead><tbody><tr><td>一对一映射（每个元素 → 单个新值）</td><td><code>.map()</code></td></tr><tr><td>一对多映射（每个元素 → 多个新值）</td><td><code>.flatMap()</code></td></tr><tr><td>提取嵌套集合中的内容并扁平化</td><td><code>.flatMap()</code></td></tr><tr><td>转换成基础类型流（<code>int/long/double</code>）</td><td><code>.mapToInt()</code> 等</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-11">🧪 练习建议（课堂可选）</h3>
<h4 data-id="heading-12">❓ 问题：下面代码的输出是什么？</h4>
<pre><code class="hljs language-java" lang="java">List&lt;String&gt; words = List.of(<span class="hljs-string">"java"</span>, <span class="hljs-string">"stream"</span>, <span class="hljs-string">"api"</span>);

List&lt;Character&gt; chars = words.stream()
                             .flatMap(word -&gt; word.chars().mapToObj(c -&gt; (<span class="hljs-type">char</span>) c))
                             .toList();

System.out.println(chars);
</code></pre>
<p>🎯 答案：</p>
<pre><code class="hljs language-java" lang="java">[j, a, v, a, s, t, r, e, a, m, a, p, i]
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>