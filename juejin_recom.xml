<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[浅谈Java并发编程中断的哲学]]></title>    <link>https://juejin.cn/post/7576580177662377994</link>    <guid>https://juejin.cn/post/7576580177662377994</guid>    <pubDate>2025-11-26T05:58:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576580177662377994" data-draft-id="7576608733611851802" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 浅谈Java并发编程中断的哲学"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-26T05:58:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="shark_chili"/> <meta itemprop="url" content="https://juejin.cn/user/2858385964801672"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             浅谈Java并发编程中断的哲学
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2858385964801672/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    shark_chili
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T05:58:22.000Z" title="Wed Nov 26 2025 05:58:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>我们通过并发编程提升了系统的吞吐量，同时我们也希望并发运行的线程能够及时停止并做好资源归纳，所以笔者就借此文来谈谈Java并发编程中线程中断的艺术。</p>
<p>我是 <strong>SharkChili</strong> ，Java 开发者，<strong>Java Guide</strong> 开源项目维护者。欢迎关注我的公众号：<strong>写代码的SharkChili</strong>，也欢迎您了解我的开源项目 mini-redis：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fshark-ctrl%2Fmini-redis" target="_blank" title="https://github.com/shark-ctrl/mini-redis" ref="nofollow noopener noreferrer">github.com/shark-ctrl/…</a>。</p>
<p>为方便与读者交流，现已创建读者群。关注上方公众号获取我的联系方式，添加时备注<strong>加群</strong>即可加入。</p>
<h2 data-id="heading-1">详解Java中断的哲学</h2>
<h3 data-id="heading-2">何时触发中断阻塞</h3>
<p>按照操作系统对于线程的任务调度管理来说，当触发以下几种情况时线程就会阻塞而处于<code>BLOCKED</code>、<code>WAITING</code>、<code>TIMED_WAITING</code>几种状态： 第一种是线程执行IO请求，在等待IO资源返回，触发阻塞，此时线程就处于<code>BLOCKED</code>状态，例如服务端<code>server</code>执行<code>serverSocket.accept()</code>等待就绪的客户端接入：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ce4a5cef0ce453780e6bc8d226ef4a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741501&amp;x-signature=d22t39WPi1xf7axXwR1JmUFdDSk%3D" alt="" loading="lazy"/></p>
<p>第二种则是等待条件为真期间，线程因此挂起等待<code>notify</code>通知或者通过sleep休眠，进而处于<code>WAITING</code>或者<code>TIMED_WAITING</code>：</p>
<pre><code class="hljs language-scss" lang="scss">new <span class="hljs-built_in">Thread</span>(() -&gt; ThreadUtil<span class="hljs-selector-class">.sleep</span>(<span class="hljs-number">3600</span>), "t-<span class="hljs-number">0</span>")<span class="hljs-selector-class">.start</span>();
</code></pre>
<p>因为并发互斥原因，线程需要等待其它线程释放监视锁而进入<code>BLOCKED</code>阻塞态：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58cd5a40d3204acfbfaa3abc71a41f15~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741501&amp;x-signature=CcBLzSVul7LwPfr5IB2tazKDrB4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">Java是如何响应中断的</h3>
<p>在操作系统中，线程的中断方式一般分为以下两种：</p>
<ol>
<li>抢占式：当线程需要中断时，直接强制让线程立刻停止手里的任务</li>
<li>协作式：当线程需要中断时，通过标识告知线程需要被中断，线程轮询检查时看到这个标识就会直接中断</li>
</ol>
<p>而Java线程则是采用协作式中断，即调用interrupt时其底层仅仅是将线程设置为可中断状态，等到线程主动检查到线程标识被设置为中断时，则触发<code>InterruptedException</code>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e4a168b4771242ff8ba1c50172f78fa3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741501&amp;x-signature=Vxsp1F%2BZgl2pwbWIb5j%2FypEn%2BvA%3D" alt="" loading="lazy"/></p>
<p>对应的我们以<code>Linux</code>为例给出<code>JDK</code>底层关于线程中断函数<code>interrupt</code>的实现，即位于<code>os_linux.cpp</code>的<code>interrupt</code>方法，可以看到其底层本质上就是定位到java线程对应的os线程并将其中断标识设置为<code>true</code>：</p>
<pre><code class="hljs language-scss" lang="scss">void os::<span class="hljs-built_in">interrupt</span>(Thread* thread) {
  <span class="hljs-built_in">assert</span>(Thread::current() == thread || Threads_lock-&gt;<span class="hljs-built_in">owned_by_self</span>(),
    "possibility of dangling Thread pointer");

  OSThread* osthread = thread-&gt;<span class="hljs-built_in">osthread</span>();
  
  if (!osthread-&gt;interrupted()) {
    <span class="hljs-comment">//设置os线程中断标识为true</span>
    osthread-&gt;<span class="hljs-built_in">set_interrupted</span>(true);
    <span class="hljs-comment">//......</span>
  }

 <span class="hljs-comment">//......</span>

}
</code></pre>
<p>同时我们也给出处于<code>sleep</code>休眠状态的线程响应中断的源码，同样是以<code>Linux</code>为例的线程封装类<code>os_linux.cpp</code>下的<code>sleep</code>函数，可以看到进行休眠时其底层在明确知晓线程可被中断的时候，就会在<code>for</code>循环中知晓休眠并定期检查可中断状态：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">os::sleep</span><span class="hljs-params">(Thread* thread, jlong millis, <span class="hljs-type">bool</span> interruptible)</span> </span>{
   <span class="hljs-comment">//......</span>

  <span class="hljs-keyword">if</span> (interruptible) {
    jlong prevtime = <span class="hljs-built_in">javaTimeNanos</span>();

    <span class="hljs-keyword">for</span> (;;) {
      <span class="hljs-comment">//循环中感知到中断直接返回OS_INTRPT标识</span>
      <span class="hljs-keyword">if</span> (os::<span class="hljs-built_in">is_interrupted</span>(thread, <span class="hljs-literal">true</span>)) {
        <span class="hljs-keyword">return</span> OS_INTRPT;
      }

  
    }
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">//......</span>
  }
}
</code></pre>
<h3 data-id="heading-4">线程中断的守则</h3>
<p>通常来说我们对线程中断响应度越高，就越容易处理并优雅的完成兜底动作，一般来说，在处理线程中断时一般会出现如下两种情况：</p>
<ol>
<li>当前代码层面对象实例不具备处理该中断异常</li>
<li>处于线程内部的run方法感知到中断无法向上抛出</li>
</ol>
<p>针对情况1，本质上就是权责上的转移，如果当前业务层面不具备处理此类异常的能力，那么就将异常向上层抛出传递给上层使用者：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sleep</span><span class="hljs-params">(<span class="hljs-type">int</span> seconds)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        TimeUnit.SECONDS.sleep(seconds);
    }
</code></pre>
<p>而情况2则相对麻烦一些，如果类似于<code>Runnable</code> 这种无法向上抛出的内置接口类的实现，我们则可以主动去捕获中断中断异常，并将在完成必要的资源清理工作后，将当前线程打断从而让高层栈帧感知到这个异常中断：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Task</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">run</span>(<span class="hljs-params"/>) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">sleep</span>(<span class="hljs-number">1000</span>);
            } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">InterruptedException</span> e) {
                <span class="hljs-comment">//执行当前线程资源清理</span>
                <span class="hljs-comment">//打断当前线程引发更高层线程响应此中断</span>
                <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">currentThread</span>().<span class="hljs-title function_">interrupt</span>();
            }
        }
    }
</code></pre>
<h2 data-id="heading-5">Java线程中断处理的一些实践</h2>
<h3 data-id="heading-6">基于标识取消任务</h3>
<p>我们先来说说基于自定义标识的方式中断线程，即非java内置方法层面的协作式标识来停止线程，通过任务运行时轮询检测，一旦线程轮询检查看到中断标识设置为<code>true</code>，则直接结束运行：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e24817849cc44cfba8cee46cc1a513c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741501&amp;x-signature=cxNTI1mZTkQbdzHGxkx7Iup%2BYow%3D" alt="" loading="lazy"/></p>
<p>对应的我们给出自定义协作式中断的实现，整体思路为：</p>
<ol>
<li>采用<code>cancelled</code>标识中断状态，并用<code>volatile</code>保证可见性</li>
<li>内置初始化一个执行线程thread</li>
<li>对外暴露<code>start</code>方法，执行线程启动</li>
<li>对外暴露<code>cancel</code>方法修改线程中断状态</li>
<li><code>run</code>方法执行业务逻辑，并定期轮询检查中断标识，一旦标识被设置为<code>true</code>则退出循环，结束线程</li>
</ol>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">Task</span> <span class="hljs-title">implements</span> <span class="hljs-title">Runnable</span> {
    <span class="hljs-comment">/**
     * 使用volatile修饰保证标识修改可见
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">volatile</span> boolean cancelled = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">private</span> final Thread thread = <span class="hljs-keyword">new</span> Thread(<span class="hljs-keyword">this</span>);

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">start</span>()</span> {
        thread.start();
    }

    <span class="hljs-comment">/**
     * 停止时，通过cancel请求取消
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">cancel</span>()</span> {
        cancelled = <span class="hljs-literal">true</span>;

    }

   
    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span>()</span> {
        <span class="hljs-comment">//取消标识检测，如果取消则直接结束循环</span>
        <span class="hljs-keyword">while</span> (!cancelled) {
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"running"</span>);
            ThreadUtil.sleep(<span class="hljs-number">1000</span>);
        }
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"task cancelled"</span>);
    }
}
</code></pre>
<p>对应的我们也给出这种方式的使用示例，可以看到我们的测试代码会在5s后调用task暴露的任务取消方法完成线程中断：</p>
<pre><code class="hljs language-scss" lang="scss"> <span class="hljs-comment">//线程启动运行5s</span>
        Task task = new <span class="hljs-built_in">Task</span>();
        task<span class="hljs-selector-class">.start</span>();
        <span class="hljs-comment">//休眠5s后将task任务对应线程中断</span>
        new <span class="hljs-built_in">Thread</span>(()-&gt;{
            ThreadUtil<span class="hljs-selector-class">.sleep</span>(<span class="hljs-number">5000</span>);
            task<span class="hljs-selector-class">.cancel</span>();
        })<span class="hljs-selector-class">.start</span>();
</code></pre>
<p>而执行的输出结果如下，是符合我们预期的：</p>
<pre><code class="hljs language-arduino" lang="arduino">running
running
running
running
running
running
task cancelled
</code></pre>
<p>当然这种做法也存在一定的弊端，即带有阻塞性质的操作，任务可能出现永远无法检查取消标志，例如我们的线程在循环往阻塞阻塞队列<code>blockingQueue</code>的<code>put</code>添加元素，一旦队列空间达到容器上界，当前线程就会阻塞即无法执行到循环分支上：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58ff76b93c90411f9e06da37b5fff4ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741501&amp;x-signature=i8LXE5bAWwN1HrHkMk7wbzXFo9k%3D" alt="" loading="lazy"/></p>
<p>对应我们也给出这段错误的样例，即阻塞队列添加操作后阻塞而走不到循环判断：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">private</span> final BlockingQueue&lt;String&gt; blockingQueue = <span class="hljs-keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="hljs-number">100</span>);

    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span>()</span> {
        <span class="hljs-comment">//取消标识检测，如果取消则直接结束循环</span>
        <span class="hljs-keyword">while</span> (!cancelled) {
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"running"</span>);
            <span class="hljs-keyword">try</span> {
                queue.put(RandomUtil.randomInt(<span class="hljs-number">10</span>));
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                <span class="hljs-comment">//......</span>
            }
        }
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"task cancelled"</span>);
    }
</code></pre>
<p>测试代码还是和上一小节一致，不多赘述，测试输出结果如下，即第二次添加操作时发现队列已满而阻塞从而无法打断：</p>
<pre><code class="hljs language-arduino" lang="arduino">running
running
</code></pre>
<h3 data-id="heading-7">如何处理阻塞式的中断</h3>
<p>参考<code>java</code>内置方法<code>Thread.sleep(1000);</code>或者<code>wait()</code>方法，其底层都会针对外部中断操作做检测，一旦感知到中断就会提前返回，即执行如下步骤：</p>
<ol>
<li>清除中断状态</li>
<li>抛出<code>InterruptedException</code>让被中断线程感知异常</li>
</ol>
<p>所以对于阻塞式中断的的正确方式为：</p>
<blockquote>
<p>通过合理的时机发出中断请求，让线程在下一个合适时候处理中断</p>
</blockquote>
<p>所以对于上述阻塞队列操作来说，可以按照如下方式进行线程优雅中断：</p>
<ol>
<li>对外暴露<code>interrupt</code>方法打断当前线程，确保阻塞队列插入阻塞时依然可以利用内置方法完成线程打断</li>
<li>线程感知中断时不可直接抛出异常，而是利用异常捕获将资源处理清楚，再次执行中断循环监测，正常退出线程逻辑</li>
</ol>
<p>对应我们给出改造后的代码，可以看到我们将<code>cancel</code>改为调用线程的中断方法将线程中断，同时在感知到中断异常时会将执行中断后的兜底逻辑：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">/**
     * 停止时，通过cancel请求取消
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">cancel</span>()</span> {
        thread.interrupt();
    }


    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span>()</span> {

            <span class="hljs-comment">//取消标识检测，如果取消则直接结束循环</span>
            <span class="hljs-keyword">while</span> (!Thread.currentThread().isInterrupted()) {
                System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"运行中......"</span>);
                Integer element = RandomUtil.randomInt(<span class="hljs-number">10</span>);
                <span class="hljs-keyword">try</span> {
                    queue.put(element);
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                   <span class="hljs-comment">//处理中断</span>
                }

            }
        

    }
</code></pre>
<h3 data-id="heading-8">合理的中断策略</h3>
<p>笔者在上面的文章中对于抛出的异常给出了一段<code>todo</code>的伏笔，这里我们就来说说线程面对中断异常后响应的哲学。一般来说，线程级或者服务级的中断策略为：</p>
<ol>
<li>尽快的退出</li>
<li>必要时完成手头任务的清理</li>
</ol>
<p>这也就是为什么<code>java</code>中各种并发包的类库对于中断的任务仅仅是抛出<code>InterruptedException</code>而不是直接处理掉中断 ，例如<code>ArrayBlockingQueue</code>的<code>put</code>方法：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">//将任务中的中断InterruptedException 丢给调用栈的上层代码执行</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">put</span>(<span class="hljs-params">E e</span>) throws InterruptedException</span> {
        checkNotNull(e);
        final ReentrantLock <span class="hljs-keyword">lock</span> = <span class="hljs-keyword">this</span>.<span class="hljs-keyword">lock</span>;
        <span class="hljs-comment">//上可打断的锁</span>
        <span class="hljs-keyword">lock</span>.lockInterruptibly();
        <span class="hljs-keyword">try</span> {
           <span class="hljs-comment">//......</span>
        } <span class="hljs-keyword">finally</span> {
        <span class="hljs-comment">//1. 释放锁</span>
            <span class="hljs-keyword">lock</span>.unlock();
        }
    }
</code></pre>
<p>而中断策略的响应，正确的做法应该是让执行该任务的线程进行按照如下原则进行处理：</p>
<ol>
<li>如果不具备处理的能力，则将异常向上传递</li>
<li>如果无法传递异常则显示抛出中断让上层的调用栈感知。</li>
</ol>
<p>以我们Task生产者代码为例，我们将提交给线程即哪些继承<code>runnable</code>或者<code>lambda</code>表达式统称为任务，一般来说持有这些任务的线程不一定是这些任务的执行者，它们仅拥有对于任务状态管理的一些权限，例如一个主线程<code>main</code>方法调用<code>thread-0</code>异步执行阻塞队列存取操作：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e1256a578f740e699ea6134750fb099~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741501&amp;x-signature=GenASIAgWi87eZ6og1BGjM1ji24%3D" alt="" loading="lazy"/></p>
<p>所以从任务的维度来说，执行任务的线程应该小心的保存中断的状态，即在面对中断时，它们不应该对中断进行任何的干预，而是让拥有线程的代码段做出正确的响应，即让<code>thread-0</code>感知到中断异常然后将状态状态还原向上传递：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e411eec27fed4c47baced0c3e0f4deaa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741501&amp;x-signature=rDMIY7tVzEpKoBAUIq%2B03HdTdEA%3D" alt="" loading="lazy"/></p>
<p>对应的我们也给出阻塞存储元素的优雅中断处理：</p>
<ol>
<li>轮询检测本地中断标识，若未中断执行插入</li>
<li>感知中断，捕获异常并打印未能处理的元素</li>
<li>完成资源兜底，主动打断线程将状态向上传递</li>
</ol>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">//外部线程打断的方法</span>
 <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">cancel</span>()</span> {
        thread.interrupt();
    }


    @Override
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span>()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">//取消标识检测，如果取消则直接结束循环</span>
            <span class="hljs-keyword">while</span> (!Thread.currentThread().isInterrupted()) {
                System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"运行中......"</span>);
                Integer element = RandomUtil.randomInt(<span class="hljs-number">10</span>);
                <span class="hljs-keyword">try</span> {
                    queue.put(element);
                } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                    Console.log(<span class="hljs-string">"线程中断，未处理资源:{}"</span>, element);
                    Thread.currentThread().interrupt();
                }

            }
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (thread.isInterrupted()) {
                System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"任务已取消"</span>);
            }
        }
        
    }
</code></pre>
<p>对应的我们也给出输出结果，可以看到阻塞的队列在被打断后完成必要的资源兜底，就会将中断状态向上传递：</p>
<pre><code class="hljs language-erlang" lang="erlang">运行中......
运行中......
线程中断，未处理资源:<span class="hljs-number">6</span>
任务已取消
</code></pre>
<h3 data-id="heading-9">时刻保留中断的状态</h3>
<p>需要注意的是，执行者仅仅传递中断还是不行的，更重要的一点是：</p>
<blockquote>
<p>在必要时刻，保存中断的状态，并返回前恢复状态，而不是捕获到isInterrupted，避免陷入无限循环的漩涡。</p>
</blockquote>
<p>很多情况下当前任务不具备处理中断的能力，例如<code>Runnable</code>收到中断的请求不可抛出异常交由上层调用栈处理，那么就在收到中断请求，按照如下步骤执行：</p>
<ol>
<li>基于本地标识保留中断状态</li>
<li>完成必要的收尾工作</li>
<li>在返回前打断该线程恢复中断状态</li>
</ol>
<p>例如：线程0循环获取阻塞队列元素，在因为没有元素而阻塞时，线程1打断该线程，已按照时刻保留中断的状态守则，线程0则应该按照如下步骤执行：</p>
<ol>
<li>收到中断，利用本地变量保留中断状态</li>
<li>继续循环等待元素获取</li>
<li>获取到元素并返回，在返回前将当前线程打断，让外部感知</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee16b441da88409dbc89349f238fda46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741501&amp;x-signature=TKct7DhZIAgwPFzoIU4DrIRo8sU%3D" alt="" loading="lazy"/></p>
<p>对应的我们给出消费者循环获取元素并处理状态的代码：</p>
<pre><code class="hljs language-arduino" lang="arduino">
 <span class="hljs-keyword">private</span> <span class="hljs-type">static</span> <span class="hljs-keyword">final</span> BlockingQueue&lt;<span class="hljs-type">String</span>&gt; blockingQueue = <span class="hljs-keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="hljs-number">1</span>);

<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">String</span> <span class="hljs-title">getNextElement</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-type">boolean</span> interrupted = <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {

                <span class="hljs-keyword">try</span> {
                    <span class="hljs-comment">//1. 等待结果返回而阻塞</span>
                    <span class="hljs-keyword">return</span> blockingQueue.<span class="hljs-built_in">take</span>();
                } <span class="hljs-built_in">catch</span> (InterruptedException e) {
                    <span class="hljs-comment">//2.收到异常中断，小心保存中断状态，继续阻塞等待元素返回</span>
                    interrupted = <span class="hljs-literal">true</span>;
                    <span class="hljs-built_in">Console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-string">"消费者线程中断，待完成本次资源获取后执行中断"</span>);
                }
            }
        } finally {
            <span class="hljs-comment">//3. 返回前基于中断标识将中断状态向上传递</span>
            <span class="hljs-keyword">if</span> (interrupted) {
                <span class="hljs-built_in">Console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-string">"消费者线程已中断"</span>);
                Thread.<span class="hljs-built_in">currentThread</span>().<span class="hljs-built_in">interrupt</span>();
            }
        }

    }
</code></pre>
<p>对应的我们也给出测试代码，即在消费者阻塞后将其打断，并投递元素，让其完成优雅中断：</p>
<pre><code class="hljs language-arduino" lang="arduino"> <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">String</span>[] args)</span> </span>{
        <span class="hljs-comment">//消费者线程</span>
        Thread thread = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Thread</span>(() -&gt; {
            <span class="hljs-type">String</span> nextElement = <span class="hljs-built_in">getNextElement</span>();
            <span class="hljs-built_in">Console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-string">"消费者线程获取结果：{}"</span>, nextElement);
        });
        thread.<span class="hljs-built_in">start</span>();
        <span class="hljs-built_in">Console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-string">"消费者线程启动"</span>);
        <span class="hljs-comment">//休眠5s后将task任务对应线程中断</span>
        <span class="hljs-keyword">new</span> <span class="hljs-built_in">Thread</span>(() -&gt; {
            <span class="hljs-comment">//休眠5s后将task任务对应线程中断</span>
            ThreadUtil.<span class="hljs-built_in">sleep</span>(<span class="hljs-number">5000</span>);
            thread.<span class="hljs-built_in">interrupt</span>();
            <span class="hljs-comment">//休眠5s后再投递元素</span>
            ThreadUtil.<span class="hljs-built_in">sleep</span>(<span class="hljs-number">5000</span>);
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">String</span> element = RandomUtil.<span class="hljs-built_in">randomString</span>(<span class="hljs-number">10</span>);
                <span class="hljs-built_in">Console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-string">"生产者线程投递：{}"</span>, element);
                blockingQueue.<span class="hljs-built_in">put</span>(element);
            } <span class="hljs-built_in">catch</span> (InterruptedException e) {
                <span class="hljs-comment">//......</span>
            }
        }).<span class="hljs-built_in">start</span>();
    }
</code></pre>
<p>输出结果如下，可以看到消费者在收到中断后明确保留中断状态，并完成资源处理的工作后执行中断：</p>
<pre><code class="hljs">消费者线程启动
消费者线程中断，待完成本次资源获取后执行中断
生产者线程投递：7gmnj1rqpj
消费者线程已中断
消费者线程获取结果：7gmnj1rqpj
</code></pre>
<h3 data-id="heading-10">超时任务取消的最优解</h3>
<p>如果我们现在需要实现这样以一个函数，该函数会接受外部传入一个异步任务并提交到我们的线程池异步执行，并具备如下要求：</p>
<ol>
<li>要求在给定时间完成执行</li>
<li>任务执行完成后，要知晓是超时取消，还是正常执行完成返回，即任务正确执行则返回true，反之返回false</li>
<li>任务执行过程中可被中断</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9da9a81465ee465eb931e0e11b4ef29a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741501&amp;x-signature=f4XKfkLQVf2ustkA15dKQHxqcRo%3D" alt="" loading="lazy"/></p>
<p>所以对于该需求，要做到如下几点：</p>
<ol>
<li>可以感知任务执行完成并返回<code>true</code></li>
<li>可以感知任务执行超时，并返回<code>false</code></li>
<li>任务可中断，直接抛出让上层代码解决</li>
</ol>
<p>对应我们给出如下代码，可以看到我们采用<code>submit</code>获取异步任务的<code>Future</code>对象，利用<code>Future</code>实现带有时限的阻塞获取，一旦超时则直接抛出超时异常，并在函数返回前的finally语句块调用cancel取消任务，需要注意的是这个cancel方法并不会一味的取消任务：</p>
<ol>
<li>如果任务已完成，这就意味着任务已到达终态，不可取消，<code>cancel</code>就会返回<code>false</code></li>
<li>如果任务因为超时等原因调用cancel，那么任务则还是活跃的，调用<code>cancel</code>可以取消并直接返回<code>true</code></li>
</ol>
<p>所以基于cancel这个特点，我们直接取反，即可实现正确执行返回true，超时返回false：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final ExecutorService executor = ThreadUtil.newExecutor(<span class="hljs-number">10</span>);

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-keyword">get</span>(Runnable r, int timeout,TimeUnit timeUnit) throws InterruptedException {
        Future&lt;?&gt; future = executor.submit(r);
        <span class="hljs-keyword">try</span> {
            future.<span class="hljs-keyword">get</span>(timeout, timeUnit);
        } <span class="hljs-keyword">catch</span> (TimeoutException e) {
            Console.<span class="hljs-keyword">error</span>(<span class="hljs-string">"任务执行超时"</span>);
        } <span class="hljs-keyword">catch</span> (ExecutionException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-built_in">new</span> RuntimeException(e);
        } <span class="hljs-keyword">finally</span> {
            /*
             <span class="hljs-number">1</span>. cancel方法传参为<span class="hljs-literal">true</span>，即任务正常完成不可取消直接返回<span class="hljs-literal">false</span>，反之返回<span class="hljs-literal">true</span>
             <span class="hljs-number">2</span>. 如果任务已经完成，cancel则返回<span class="hljs-literal">false</span>，反之返回<span class="hljs-literal">true</span>
             */
            <span class="hljs-keyword">return</span> future.cancel(<span class="hljs-literal">true</span>);

        }

    }
</code></pre>
<p>对应的我们也给出测试代码，可以看到笔者的代码休眠2s，等到超时时间为1s，这也就意味着cancel最终会成功超时取消返回true：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">try</span> {
            <span class="hljs-type">boolean</span> isTimeOut = <span class="hljs-built_in">get</span>(() -&gt; {
                ThreadUtil.<span class="hljs-built_in">sleep</span>(<span class="hljs-number">2000</span>);
                <span class="hljs-built_in">Console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-string">"任务执行完成"</span>);
            }, <span class="hljs-number">1</span>,TimeUnit.SECONDS);

            <span class="hljs-built_in">Console</span>.<span class="hljs-built_in">log</span>(<span class="hljs-string">"任务是否超时：{}"</span>, isTimeOut);
        } <span class="hljs-built_in">catch</span> (InterruptedException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(e);
        }
</code></pre>
<p>输出结果如下，可以看到任务执行超时后直接打断休眠，任务执行到已完成的输出，然后执行超时取消，如果取反得到false：</p>
<pre><code class="hljs language-arduino" lang="arduino">任务执行超时
任务执行完成
任务是否超时：<span class="hljs-literal">true</span>
</code></pre>
<h3 data-id="heading-11">处理系统层面阻塞IO</h3>
<p>有时候阻塞并非来自阻塞式并发包的调用，而是例如硬件层面文件IO或者网络层面的<code>socket IO</code>，这种API涉及内核态调用，通过<code>interrupt</code>我们也只能修改中断表示，无法直接将其中断。</p>
<p>所以我们只能通过间接的手段干预其资源关闭来做到中断，无论是socket还是文件IO，本质上都是针对系统或者网卡IO数据的阻塞读取，所以我们可以直接通过关闭文件IO流或者socket套接字来间接打断其资源读取。 <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bb7d2690d934dab801c0f1d05a7b3bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc2hhcmtfY2hpbGk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741501&amp;x-signature=MhG9aEgOIi4Tpa96bzrkt2mRda4%3D" alt="" loading="lazy"/></p>
<p>对应的我们以文件IO为例给出代码示例，可以看到我们通过继承thread重写其中断方法，当我们需要打断系统资源时，直接关闭其流通道让工作线程感知到这一点，然后通过原生interrupt修改中断状态：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IOThread</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Thread</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BufferedReader utf8Reader;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">IOThread</span><span class="hljs-params">(String path)</span> {
        utf8Reader = FileUtil.getUtf8Reader(path);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-type">String</span> <span class="hljs-variable">line</span> <span class="hljs-operator">=</span> utf8Reader.readLine();
                Console.log(line);
            } <span class="hljs-keyword">catch</span> (IOException e) {
                <span class="hljs-comment">//保存IO上下文状态</span>
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
            }
        }

    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">interrupt</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">//强制关闭IO让其感知中断</span>
            utf8Reader.close();
        } <span class="hljs-keyword">catch</span> (IOException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-built_in">super</span>.interrupt();
        }
    }


    
}
</code></pre>
<p>对应的我们也给出使用示例，这段代码会在中断线程调用<code>interrupt</code>关闭流通道直接直接将<code>IOUtil</code> 线程打断：</p>
<pre><code class="hljs language-ini" lang="ini">
        IOThread <span class="hljs-attr">ioThread</span> = new IOThread(<span class="hljs-string">"F:\test.txt"</span>)<span class="hljs-comment">;</span>
        Thread <span class="hljs-attr">thread</span> = new Thread(() -&gt; {
            ThreadUtil.sleep(10_000)<span class="hljs-comment">;</span>
            ioThread.interrupt()<span class="hljs-comment">;</span>
        })<span class="hljs-comment">;</span>

        thread.start()<span class="hljs-comment">;</span>
        ioThread.start()<span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-12">小结</h2>
<p>本文针对Java并发编程的中断的使用技巧、状态保存、合理的中断时机和不同场景的中断方式进行了深入的剖析的讲解，希望对你有帮助。</p>
<p>我是 <strong>SharkChili</strong> ，Java 开发者，<strong>Java Guide</strong> 开源项目维护者。欢迎关注我的公众号：<strong>写代码的SharkChili</strong>，也欢迎您了解我的开源项目 mini-redis：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fshark-ctrl%2Fmini-redis" target="_blank" title="https://github.com/shark-ctrl/mini-redis" ref="nofollow noopener noreferrer">github.com/shark-ctrl/…</a>。</p>
<p>为方便与读者交流，现已创建读者群。关注上方公众号获取我的联系方式，添加时备注<strong>加群</strong>即可加入。</p>
<h2 data-id="heading-13">参考</h2>
<p>《Java并发编程实战》</p>
<p>本文使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarkdown.com.cn" target="_blank" title="https://markdown.com.cn" ref="nofollow noopener noreferrer">markdown.com.cn</a> 排版</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[检索增强生成（RAG）与大语言模型微调（Fine-tuning）的差异、优势及使用场景详解]]></title>    <link>https://juejin.cn/post/7576646533615108150</link>    <guid>https://juejin.cn/post/7576646533615108150</guid>    <pubDate>2025-11-26T06:14:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576646533615108150" data-draft-id="7576698454924279814" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="检索增强生成（RAG）与大语言模型微调（Fine-tuning）的差异、优势及使用场景详解"/> <meta itemprop="keywords" content="LLM,Agent,程序员"/> <meta itemprop="datePublished" content="2025-11-26T06:14:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型教程"/> <meta itemprop="url" content="https://juejin.cn/user/1145012233707299"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            检索增强生成（RAG）与大语言模型微调（Fine-tuning）的差异、优势及使用场景详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1145012233707299/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型教程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T06:14:06.000Z" title="Wed Nov 26 2025 06:14:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读26分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p>微调大语言模型是利用特定任务或领域的定制数据集，对预训练模型进行调整,而检索增强生成（RAG）则将检索系统与生成模型相结合，动态地将外部的、最新的知识融入生成结果中。</p>
<h2 data-id="heading-0">引言</h2>
<p>随着生成式人工智能（Gen AI）和自然语言处理（NLP）技术的持续演进，业界对更强大、更高效模型的需求呈指数级增长。从聊天机器人、虚拟助手，到复杂的内容生成与搜索系统，NLP 应用正日益成为现代技术不可或缺的组成部分。然而，伴随着这一不断增长的需求，也带来了如何提升这些系统性能与适应能力的挑战，尤其是在复杂且动态变化的环境中。</p>
<p>目前，提升 NLP 模型性能的两种主流方法是检索增强生成（Retrieval-Augmented Generation, RAG）和微调（fine-tuning）。微调长期以来一直是机器学习领域的常用手段，通过使用额外数据进行训练，使模型能够适应特定任务；而 RAG 则引入了一种创新范式——将检索系统的优势与生成模型相结合，构建出一种动态机制，以应对那些需要大规模信息访问和上下文敏感性的任务。</p>
<p>AI 工程师在项目中常常面临一个艰难抉择：究竟应选择 RAG 还是微调？每种方法都有其独特的优势与权衡取舍，因此必须深入理解它们各自的强项、局限性以及最适合的应用场景。本文旨在全面解析这两种技术，帮助读者掌握所需知识，从而做出明智决策，并在其工作中高效地运用这些强大工具。</p>
<h2 data-id="heading-1">自然语言处理技术背景</h2>
<p>自然语言处理（NLP）的发展历程由一系列创新推动，旨在让机器能够精准且细腻地理解和生成人类语言。早期的方法，如基于规则的系统和统计模型，依赖人工设计的特征和领域特定的规则。然而，这些方法在可扩展性和泛化能力方面常常面临困难。</p>
<p>深度学习的兴起成为 NLP 发展的关键转折点，引入了能够从大规模数据集中捕捉复杂模式的神经网络架构。word2vec 和 GloVe 等模型率先提出了词嵌入方法，将词语表示为稠密向量空间中的点，从而提升了对上下文的理解能力。随后，基于 Transformer 架构的大语言模型（Large Language Models, LLMs）——如谷歌提出的 BERT（Bidirectional Encoder Representations from Transformers）和 OpenAI 开发的 GPT（Generative Pre-trained Transformer）——通过自注意力机制实现了对文本上下文的深度理解，彻底革新了整个领域。</p>
<p>尽管取得了这些进展，挑战依然存在。在大规模语料库上训练的模型虽然在通用任务上表现优异，但在特定领域应用或面对不断变化的数据时往往缺乏适应性。这一差距催生了微调（fine-tuning）等技术的发展：即利用额外的任务特定数据对预训练模型进行进一步优化。微调被证明非常有效，但通常需要大量的计算资源和时间投入。</p>
<p>近年来，检索增强生成（Retrieval-Augmented Generation, RAG）作为一种互补性方法应运而生。RAG 将检索系统与生成模型相结合，无需进行大规模重新训练，即可让模型在推理过程中动态访问外部知识库。这一创新为那些需要实时获取最新信息或领域专业知识的任务提供了传统微调之外的一种极具吸引力的替代方案。</p>
<p>解码基础：深入解析 RAG 与微调</p>
<h2 data-id="heading-2">检索增强生成（RAG）详解</h2>
<p>RAG 是 NLP 领域的一项创新方法，它将信息检索能力与语言生成能力有机结合。其核心思想是在生成过程中，使大语言模型能够动态访问并利用外部知识，从而显著增强其表达与推理能力。</p>
<p>RAG 架构主要由两个关键组件构成：检索器（retriever）和生成器（generator）。检索器负责从庞大的文档集合或知识库中搜索并提取与当前任务相关的信息。该组件通常采用先进的信息检索技术，例如稠密向量表示（dense vector representations）和高效的相似性搜索算法，以针对给定查询或上下文精准定位最相关的知识片段。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2654a1d0b3144838f6c103b4321ec70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764742445&amp;x-signature=eNwuGAtK0%2BU2xke73eu%2B6G7%2F8rQ%3D" alt="" loading="lazy"/></p>
<p>另一方面，生成器（generator）是一种语言模型，它结合检索到的信息与原始输入，生成连贯、语境恰当且准确的响应。该组件利用预训练语言模型（如 GPT 或 BART）的强大能力，在生成类人文本的同时，融入检索器提供的外部知识。</p>
<p>RAG 通过将生成过程以检索到的信息为条件，将外部知识整合进语言模型中。这种方法使模型能够访问其初始训练数据中可能不存在的最新或任务特定信息。因此，经过 RAG 增强的模型能够在各种任务和领域中提供更准确、更及时、信息更丰富且上下文更相关的回答。</p>
<h2 data-id="heading-3">一个典型的 RAG 系统包含以下关键组件：</h2>
<ul>
<li>
<p><strong>知识库（Knowledge Base）</strong></p>
<p>：可以是一个大规模文档语料库、包含外部信息的结构化数据，甚至整个互联网。</p>
</li>
<li>
<p><strong>检索器（Retriever）</strong></p>
<p>：负责从知识库中搜索并提取相关信息的模块。</p>
</li>
<li>
<p><strong>编码器（Encoder）</strong></p>
<p>：将输入查询和文档转换为稠密向量表示的组件。</p>
</li>
<li>
<p><strong>相似性搜索（Similarity Search）</strong></p>
<p>：一种基于向量相似度识别最相关文档的算法。</p>
</li>
<li>
<p><strong>生成器（Generator）</strong></p>
<p>：利用检索到的信息和输入上下文生成最终输出的语言模型。</p>
</li>
<li>
<p><strong>融合机制（Fusion Mechanism）</strong></p>
<p>：一种将检索信息与输入相结合以引导生成过程的方法。</p>
</li>
</ul>
<hr/>
<p><strong>微调详解</strong></p>
<p>微调（Fine-tuning）是 NLP 中一种强大的技术，指对预训练语言模型进行进一步训练，使其适应特定任务或专门领域。该过程充分利用大型通用模型已有的知识和能力，并对其进行定制化调整，从而在目标应用场景中实现更优性能。</p>
<p>本质上，微调建立在迁移学习（transfer learning）的概念之上——即模型可将在一个任务中学到的知识迁移到另一个相关任务中。在语言模型的语境下，这意味着模型在预训练阶段获得的通用语言理解与生成能力，可以被进一步细化和专业化，以满足具体用例的需求。这种方法显著减少了对任务特定训练数据的需求，并加速了面向各类应用的高性能模型的开发进程。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e17d22bea014027ab9762ff5410a710~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764742445&amp;x-signature=QTa4TB879n2lWxxALfn24wOelZ8%3D" alt="" loading="lazy"/></p>
<p>微调过程包括将预训练模型暴露于一个精心构建的、能够代表目标任务或领域的数据集。在此阶段，模型的参数会被调整，以优化其在新任务上的表现，同时保留预训练阶段获得的基础语言知识。这种精妙的平衡使模型既能利用其对语言的广泛理解，又能发展出针对特定应用场景的专业能力。</p>
<p>微调模型的主要步骤包括：</p>
<ul>
<li>选择一个合适的预训练模型作为起点</li>
<li>准备高质量、面向具体任务的微调数据集</li>
<li>定义任务特定的模型架构（例如，添加分类层）</li>
<li>配置微调过程中的超参数</li>
<li>在新数据集上训练模型，并更新模型参数</li>
<li>在独立的测试集上评估微调后模型的性能</li>
<li>根据需要迭代优化整个流程，直至达到预期效果</li>
</ul>
<p>微调使开发者能够在无需大量计算资源或海量数据的前提下，为各种应用场景（如情感分析、命名实体识别和问答系统等）构建专用模型。这一方法大大降低了使用前沿语言模型的门槛，加速了人工智能解决方案在各行各业的落地与普及。</p>
<hr/>
<p><strong>RAG 与微调正面交锋：性能指标对比</strong></p>
<p><strong>准确性与精确度</strong></p>
<p>在评估 RAG 与微调方法的性能时，准确性和精确度是关键指标，其表现会因具体任务而异。RAG 在需要最新或专业知识的场景中表现卓越，而微调则在任务模式清晰、数据分布稳定的情况下更具优势。</p>
<p>影响两种方法准确性的因素各不相同。对于 RAG 而言，外部知识库的质量与相关性至关重要；检索机制的有效性，以及将检索信息与生成过程融合的能力，也显著影响最终准确性。此外，知识库的多样性与覆盖广度决定了 RAG 在不同领域中的表现。</p>
<p>对于微调而言，任务特定训练数据的质量与数量极为关键。预训练领域与目标任务领域之间的相似度也会影响准确性。此外，学习率、训练轮数等超参数的选择，也会显著影响微调后模型的性能。</p>
<p>在需要访问大量且最新信息的场景中，RAG 通常优于微调。例如，在开放域问答任务中，RAG 可借助其庞大的知识库提供更准确的答案，尤其对于涉及近期事件或原始训练数据未涵盖的专业主题的问题。</p>
<p>相反，在任务结构清晰、数据分布稳定的场景下（如命名实体识别或情感分析），微调模型往往表现更佳。这类任务在不同文本中保持相对一致的模式，微调模型可通过专门学习任务特有的模式和细微差别，实现更高的准确率。</p>
<p>事实核查是 RAG 展现更高准确性的另一领域。通过从知识库中的多个来源检索并交叉验证信息，RAG 能提供比微调模型更可靠的事实验证——后者仅受限于训练期间编码到模型参数中的信息。</p>
<p>然而，在需要深入理解特定领域术语或高度专业化语言模式的任务中，微调可能胜过 RAG。例如，在法律文书分析或医疗报告生成等场景中，若外部知识库未能全面覆盖该专业领域，那么基于领域数据微调的模型往往会比 RAG 系统取得更高的准确性。</p>
<h2 data-id="heading-4">适应性与泛化能力</h2>
<p>适应性与泛化能力是人工智能模型的关键特性，决定了模型在面对新数据和新任务时的表现能力。检索增强生成（RAG）模型与微调模型在这两个方面展现出不同的特点，各自具有独特的优势与局限。</p>
<p>RAG 模型在适应新信息和新场景方面表现更优。通过利用外部知识库，RAG 无需重新训练即可整合最新信息，使其在信息快速变化的动态环境中始终保持时效性和相关性。</p>
<p>相比之下，微调模型虽然在特定任务上高度专业化，但在适应性方面往往存在困难。它们容易出现“灾难性遗忘”现象——即模型在适应新任务或新数据时，会丢失先前学到的知识。这是因为微调过程会调整模型参数以优化新任务的性能，可能会覆盖掉对先前任务有用的知识。</p>
<p>RAG 通过维护一个独立且可更新的知识库来避免灾难性遗忘问题。它不修改模型内部参数，而是从外部来源检索相关信息，从而在适应新数据的同时，不会损害其在已学任务上的表现。</p>
<h2 data-id="heading-5">泛化能力在以下任务中尤为重要：</h2>
<ul>
<li>
<p><strong>开放域问答</strong></p>
<p>：RAG 能够访问广泛的知识库，即使面对训练中未见过的主题，也能回答多样化的问题。</p>
</li>
<li>
<p><strong>零样本学习</strong></p>
<p>：RAG 可借助知识库中的相关信息，在未经显式训练的任务上取得合理表现。</p>
</li>
<li>
<p><strong>跨语言任务</strong></p>
<p>：微调模型在遇到训练数据中未包含的语言或方言时可能表现不佳，而 RAG 则有可能检索并利用多语言信息。</p>
</li>
<li>
<p><strong>时序推理</strong></p>
<p>：RAG 能整合最新信息，因此更适合处理涉及当前事件或不断演进知识的任务。</p>
</li>
</ul>
<p>RAG 与微调在适应性方面的关键差异包括：</p>
<ul>
<li>
<p><strong>知识整合方式</strong></p>
<p>：RAG 动态整合新信息，而微调模型需重新训练。</p>
</li>
<li>
<p><strong>灾难性遗忘</strong></p>
<p>：RAG 基本避免了该问题，微调模型则容易受其影响。</p>
</li>
<li>
<p><strong>任务灵活性</strong></p>
<p>：RAG 无需重新训练即可适应更广泛的任务，而微调模型更具任务专一性。</p>
</li>
<li>
<p><strong>持续学习能力</strong></p>
<p>：RAG 通过更新知识库支持持续学习；微调模型训练完成后知识通常是固定的。</p>
</li>
<li>
<p><strong>对未见数据的泛化能力</strong></p>
<p>：得益于广泛的一般知识访问，RAG 在全新场景中通常表现更佳。</p>
</li>
</ul>
<h2 data-id="heading-6">资源需求与计算开销</h2>
<p>RAG 与微调模型的计算需求存在显著差异，这直接影响它们在实际应用中的部署与可扩展性。由于 RAG 需要在推理时实时维护并查询大型外部知识库，通常需要更多的计算资源。</p>
<p>在 GPU/TPU 使用方面，微调在训练阶段通常需要大量计算资源，但推理阶段效率更高。RAG 模型在初始设置阶段计算负担较轻，但在推理过程中需要持续的 GPU/TPU 算力，以支持实时信息检索与整合。</p>
<p>内存需求也大不相同。微调模型将所有信息存储于模型参数中，导致模型体积较大，但推理速度可能更快。RAG 模型的核心部分较小，但需要额外内存来存储和访问外部知识库。</p>
<p>两种方法在可扩展性方面各有挑战。微调模型在特定任务上扩展性良好，但若需覆盖不同领域，往往需要重新训练或使用多个独立模型。RAG 系统因其模块化结构，在多样化任务中具备更好的可扩展性——只需更新知识库，无需改动核心模型。</p>





























<table><thead><tr><th>模型规模</th><th>任务</th><th>RAG 计算开销</th><th>微调计算开销</th></tr></thead><tbody><tr><td>小</td><td>问答</td><td>中</td><td>低</td></tr><tr><td>中</td><td>命名实体识别</td><td>高</td><td>中</td></tr><tr><td>大</td><td>摘要生成</td><td>极高</td><td>高</td></tr></tbody></table>
<p><strong>优化 RAG 系统资源使用的建议：</strong></p>
<ul>
<li>实现高效的索引与检索算法。</li>
<li>对高频访问信息使用缓存机制。</li>
<li>对大规模知识库采用分布式计算。</li>
</ul>
<p><strong>优化微调的建议：</strong></p>
<ul>
<li>使用参数高效微调技术（如适配器层）。</li>
<li>应用量化与剪枝以减小模型体积。</li>
<li>利用迁移学习减少新任务的训练时间。</li>
</ul>
<p>两种方法均可受益于硬件加速和优化的推理引擎。选择 RAG 还是微调，通常需在计算开销、任务灵活性和性能需求之间进行权衡，具体取决于应用场景。</p>
<p>推理速度与延迟</p>
<p>RAG 模型虽灵活且能访问动态实时信息，但本质上推理速度较慢。其高延迟主要源于检索过程：在生成响应前，RAG 必须搜索知识库、检索相关信息，并将其与用户查询整合。尽管这一额外步骤增强了模型获取最新信息的能力，但也带来了显著的时间开销。</p>
<p>在推理阶段的计算需求方面，两者也有明显区别。微调模型已将任务特定知识内化到参数中，推理时通常计算负担较轻，仅依赖输入和预训练/微调后的权重。而 RAG 模型需维护并查询大型外部知识库，计算密集度高，可能需要额外硬件资源。</p>
<p>部署时选择 RAG 还是微调，取决于应用的具体需求。对于实时聊天机器人或自动交易系统等对延迟敏感的任务，微调模型的低延迟更具优势。而对于新闻摘要或动态事实核查等对信息时效性要求高的应用，RAG 的额外延迟可能是可接受的，因其能获取并整合最新信息。</p>
<h2 data-id="heading-7">实施策略：让 RAG 与微调落地</h2>
<p><strong>RAG 实施蓝图</strong></p>
<p>构建 RAG 系统包含若干关键步骤，每一步都对模型的有效性和效率至关重要。首先进行数据准备，收集并预处理高质量、多样化的语料库，作为 RAG 系统运行时查询的知识基础。</p>
<p>其次，训练检索器组件。RAG 中的检索器通常使用嵌入模型（如 BERT 或 DPR，即 Dense Passage Retriever）将查询和文档编码为稠密向量表示，以便进行相似性搜索。</p>
<p>接下来是检索器与生成器的集成，这是关键环节。需设计一条高效流水线，能根据输入查询快速检索相关信息，并无缝融入生成过程。生成器通常是一个预训练语言模型（如 GPT），需进一步微调以有效利用检索到的信息。</p>
<p><strong>常用 RAG 框架与工具包括：</strong></p>
<ul>
<li>
<p><strong>Haystack</strong></p>
<p>：端到端 RAG 框架，提供文档存储、检索器和阅读器组件。</p>
</li>
<li>
<p><strong>LangChain</strong></p>
<p>：简化大语言模型与外部数据源及其他计算模块结合的库。</p>
</li>
<li>
<p><strong>Hugging Face Transformers</strong></p>
<p>：提供用于检索和生成任务的预训练模型与工具。</p>
</li>
</ul>
<p>以下是一个简化的 RAG 系统伪代码：</p>
<pre><code class="hljs language-ini" lang="ini">def rag_system(query, knowledge_base):
    <span class="hljs-comment"># 检索相关文档</span>
    <span class="hljs-attr">relevant_docs</span> = retriever.get_relevant_documents(query, knowledge_base)
    <span class="hljs-comment"># 拼接检索到的文档作为上下文</span>
    <span class="hljs-attr">context</span> = <span class="hljs-string">" "</span>.join(relevant_docs)
    <span class="hljs-comment"># 结合查询与上下文生成响应</span>
    <span class="hljs-attr">response</span> = generator.generate(query + context)
    return response

<span class="hljs-comment"># 使用示例</span>
<span class="hljs-attr">query</span> = <span class="hljs-string">"法国的首都是哪里？"</span>
<span class="hljs-attr">response</span> = rag_system(query, knowledge_base)
print(response)
</code></pre>
<p><strong>RAG 实施最佳实践：</strong></p>
<ul>
<li>确保知识库内容多样且高质量，覆盖广泛主题。</li>
<li>定期更新知识库以保持准确性和时效性。</li>
<li>实现高效的索引与检索机制，降低延迟。</li>
<li>在任务特定数据上微调生成器，提升输出连贯性与相关性。</li>
<li>建立稳健的评估流程，衡量检索信息与生成响应的质量。</li>
<li>考虑在初步检索后加入重排序步骤，提升相关性。</li>
<li>尝试不同检索与生成模型组合，找到最适合具体用例的配置。</li>
</ul>
<p><strong>微调实施蓝图</strong></p>
<p>对预训练语言模型进行微调需采用系统化方法，确保模型有效适应目标任务或领域。首先进行数据准备：收集、清洗并按需标注高质量的领域特定数据集，作为模型专项训练的基础。</p>
<p>随后进入模型选择阶段，挑选合适的预训练模型（如 BERT、GPT 或 T5），并根据任务需求（如分类、摘要或问答）对模型架构进行微调，例如添加任务特定层。</p>
<p>准备好数据与模型后，开始微调过程：使用合适的超参数、损失函数和优化器在任务特定数据集上训练模型，并通过验证集定期评估，防止过拟合。</p>
<p><strong>常用微调框架与工具包括：</strong></p>
<ul>
<li>
<p><strong>Hugging Face Transformers</strong></p>
<p>：提供预训练模型、分词器及多种 NLP 任务的微调工具。</p>
</li>
<li>
<p><strong>PyTorch 与 TensorFlow</strong></p>
<p>：主流机器学习框架，支持自定义模型的实现与微调。</p>
</li>
<li>
<p><strong>Google Colab 与 Kaggle</strong></p>
<p>：提供免费 GPU 的云端平台，适合微调小型模型。</p>
</li>
</ul>
<p>以下是一个用于情感分析的微调伪代码示例：</p>
<pre><code class="hljs language-ini" lang="ini">from transformers import AutoModelForSequenceClassification, AutoTokenizer, Trainer, TrainingArguments

<span class="hljs-comment"># 加载预训练模型与分词器</span>
<span class="hljs-attr">model_name</span> = <span class="hljs-string">"bert-base-uncased"</span>
<span class="hljs-attr">model</span> = AutoModelForSequenceClassification.from_pretrained(model_name, num_labels=<span class="hljs-number">2</span>)
<span class="hljs-attr">tokenizer</span> = AutoTokenizer.from_pretrained(model_name)

<span class="hljs-comment"># 数据预处理</span>
def preprocess_function(examples):
    return tokenizer(examples<span class="hljs-section">["text"]</span>, <span class="hljs-attr">truncation</span>=<span class="hljs-literal">True</span>, padding=<span class="hljs-literal">True</span>)

<span class="hljs-attr">tokenized_datasets</span> = raw_datasets.map(preprocess_function, batched=<span class="hljs-literal">True</span>)

<span class="hljs-comment"># 训练参数设置</span>
<span class="hljs-attr">training_args</span> = TrainingArguments(
    <span class="hljs-attr">output_dir</span>=<span class="hljs-string">"./results"</span>,
    <span class="hljs-attr">evaluation_strategy</span>=<span class="hljs-string">"epoch"</span>,
    <span class="hljs-attr">save_strategy</span>=<span class="hljs-string">"epoch"</span>,
    <span class="hljs-attr">learning_rate</span>=<span class="hljs-number">2</span>e-<span class="hljs-number">5</span>,
    <span class="hljs-attr">per_device_train_batch_size</span>=<span class="hljs-number">16</span>,
    <span class="hljs-attr">num_train_epochs</span>=<span class="hljs-number">3</span>,
    <span class="hljs-attr">weight_decay</span>=<span class="hljs-number">0.01</span>,
)

<span class="hljs-comment"># 定义训练器</span>
<span class="hljs-attr">trainer</span> = Trainer(
    <span class="hljs-attr">model</span>=model,
    <span class="hljs-attr">args</span>=training_args,
    <span class="hljs-attr">train_dataset</span>=tokenized_datasets[<span class="hljs-string">"train"</span>],
    <span class="hljs-attr">eval_dataset</span>=tokenized_datasets[<span class="hljs-string">"validation"</span>],
)

<span class="hljs-comment"># 开始训练</span>
trainer.train()

</code></pre>
<p><strong>微调实施最佳实践：</strong></p>
<ul>
<li>
<p><strong>任务数据质量</strong></p>
<p>：确保数据集干净、标注准确，并能代表目标领域或任务。</p>
</li>
<li>
<p><strong>超参数调优</strong></p>
<p>：尝试不同学习率、批次大小和训练轮数以优化性能。</p>
</li>
<li>
<p><strong>防止过拟合</strong></p>
<p>：使用 dropout、早停或正则化等技术提升泛化能力。</p>
</li>
<li>
<p><strong>定期评估</strong></p>
<p>：训练过程中监控验证集表现，确保有效学习。</p>
</li>
<li>
<p><strong>利用预训练层</strong></p>
<p>：冻结基础模型，仅微调任务特定层，提高资源效率。</p>
</li>
<li>
<p><strong>高效资源利用</strong></p>
<p>：使用 GPU/TPU 云资源及批处理加速微调。</p>
</li>
<li>
<p><strong>持续更新</strong></p>
<p>：定期用新数据重新训练模型，保持时效性与准确性。</p>
</li>
</ul>
<p>遵循此蓝图，可高效实现各类 NLP 任务的微调，在保证任务性能的同时优化资源使用。</p>
<p>选择合适的 AI 模型增强技术</p>
<p><strong>RAG 的优势场景</strong></p>
<p>RAG 在需要访问海量、最新信息且无需重新训练即可适应新数据的场景中表现卓越。这使其特别适用于知识持续演进或信息范围过于广泛、难以完全内化到单一模型参数中的领域。</p>
<p>典型例子是开放域问答系统。与仅依赖参数内嵌知识的微调模型不同，RAG 能动态从知识库中检索并整合最新信息。这一能力对虚拟助手或客服聊天机器人至关重要，因为它们需在广泛主题上提供准确、及时的回答。</p>
<p>RAG 在需要事实准确性与内容多样性的内容生成任务中同样出色。例如，在自动新闻摘要或报告生成中，RAG 可引入最新数据与统计信息，确保内容既新颖又准确。这种动态知识整合在金融等领域尤为宝贵，因为市场状况与公司信息瞬息万变。</p>
<p>RAG 处理频繁更新信息的能力在许多现实应用中具有显著优势。例如在医疗领域，基于 RAG 的系统无需反复重新训练，即可同步最新研究成果、治疗方案和药物信息，确保医护人员在关键决策时获得最新、最相关的知识。</p>
<p><strong>RAG 的主要应用场景包括：</strong></p>
<ul>
<li>开放域问答与聊天机器人</li>
<li>实时新闻摘要与分析</li>
<li>科学文献综述与研究辅助</li>
<li>金融市场分析与报告</li>
<li>教育工具与互动学习平台</li>
<li>事实核查与虚假信息检测系统</li>
</ul>
<p>在这些场景中，RAG 将大语言模型的泛化能力与信息检索系统的精准性与时效性相结合，成为处理复杂、知识密集型任务的强大工具。</p>
<p><strong>微调的优势场景</strong></p>
<p>微调适用于任务特定优化和低延迟性能至关重要的场景。一个典型领域是特定领域的自然语言处理任务。例如，在法律、医疗或技术文档分析中，微调模型通过专项训练理解专业术语、上下文和细微差别，表现优于通用模型。</p>
<p>任务特定性能优化是微调的另一优势。在情感分析、垃圾邮件检测或命名实体识别等应用中，微调模型通过聚焦特定任务数据集，实现卓越性能，不仅能准确识别，还能稳健处理领域特有细节。</p>
<p>微调在低延迟环境中同样表现出色。由于不依赖外部检索机制，微调模型比 RAG 等检索增强系统生成响应更快，非常适合聊天机器人、语音助手和实时翻译等对响应速度要求极高的应用。</p>
<p>在医疗或金融等数据隐私至关重要的环境中，微调模型还具备额外优势：通过将任务知识直接嵌入模型，减少了对外部数据检索的依赖，从而降低数据泄露或隐私违规风险。</p>
<p><strong>微调的主要应用场景包括：</strong></p>
<ul>
<li>社交媒体或客户反馈的情感分析</li>
<li>法律与医疗文档分析</li>
<li>个性化推荐与用户画像</li>
<li>金融系统中的欺诈检测与风险评估</li>
<li>低延迟客户服务聊天机器人</li>
<li>任务特定摘要与报告生成</li>
<li>领域特定翻译与语言模型</li>
<li>技术支持与故障排查助手</li>
</ul>
<p>在这些场景中，微调模型凭借其任务专精能力和快速响应效率，成为不可或缺的方法。其对稳定数据集和内嵌知识的依赖，使其在可预测、任务聚焦的应用中持续高效。</p>
<p><strong>混合方法：两全其美</strong></p>
<p>结合 RAG 与微调的混合方法，为同时需要最新信息检索与任务特定优化的场景提供了强大解决方案。这类方法融合两者优势，构建出更灵活高效的 AI 系统。</p>
<p>一种有效策略是以微调模型作为 RAG 系统的基础。这样，模型既具备特定领域的专业知识，又能访问并整合外部信息。例如，在医疗诊断系统中，基础模型可微调于医学术语和常见诊疗流程，而 RAG 能力则使其检索最新研究成果或罕见病例。</p>
<p>另一种方法是先用 RAG 进行初步信息检索，再对输出生成过程进行微调。这在事实准确性与风格一致性均重要的内容创作任务中尤为有用。例如，新闻摘要系统可用 RAG 收集相关事实，再通过微调语言模型按特定新闻风格生成摘要。</p>
<p><strong>混合方法的实际应用包括：</strong></p>
<ul>
<li>法律研究工具：结合微调模型理解法律语言，RAG 访问最新判例与法规。</li>
<li>教育平台：微调用于个性化教学，RAG 检索多样且最新的学习资料。</li>
<li>金融分析系统：微调模型预测市场趋势，RAG 整合实时经济数据。</li>
</ul>
<p>下图决策树可指导从业者根据具体用例选择最合适的方法，在专业深度与信息时效性之间取得平衡。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/428f2c509d5345e684c3046633e0366c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764742445&amp;x-signature=YmRab3wA7nATSk%2B6TzLY1aq3Hh4%3D" alt="" loading="lazy"/></p>
<p><strong>结论</strong></p>
<p>RAG 与微调代表了提升 AI 模型性能的两种不同路径，各有优势与局限。RAG 擅长需要访问大规模、频繁更新知识库的场景，具备无需重新训练即可适应新信息的灵活性。而微调则在任务专精应用中表现突出，提供更快的推理速度和更紧凑的模型。</p>
<p>选择 RAG 还是微调时，需综合考虑任务性质、数据更新频率、计算资源及可解释性需求。RAG 更适合开放域任务和需要最新信息的应用；微调则适用于知识稳定、定义明确的专项任务。</p>
<p>将所选方法与项目具体需求和约束对齐至关重要。需权衡推理速度、模型大小、适应性以及对外部知识库的依赖程度。某些情况下，结合 RAG 与微调的混合方法可能是最优解。</p>
<p>鼓励从业者亲自尝试两种方法，积累实践经验。</p>
<p><strong>常见问题解答</strong></p>
<p><strong>Q：RAG 与微调在推理速度上有何差异？</strong> A：微调模型通常推理速度更快。图表显示，在所有模型规模（小、中、大）下，微调模型的推理时间始终低于 RAG 模型。</p>
<p><strong>Q：实施 RAG 系统的主要挑战有哪些？</strong> A：关键挑战包括构建与维护大规模、最新知识库，实现高效检索机制，平衡检索准确性与速度。此外，确保检索信息的相关性及其与生成过程的无缝整合也较为复杂。</p>
<p><strong>Q：如何判断我的任务是否只需微调，还是应考虑 RAG？</strong> A：若任务定义清晰、知识领域稳定且无需频繁更新，可选择微调。若应用需访问广泛且频繁更新的知识库，或需处理原始训练数据范围之外的查询，则应考虑 RAG。</p>
<p><strong>Q：RAG 与微调能否有效结合？</strong> A：可以。混合方法非常有效。例如，可将微调模型作为 RAG 系统的基础，结合专业领域知识与外部信息检索能力；也可先用 RAG 检索信息，再对生成过程进行微调以适配特定任务或风格。</p>
<p><strong>Q：RAG 与微调在模型可解释性方面有何差异？</strong> A：RAG 通常更具可解释性，因其能提供检索信息的来源，便于追溯模型决策过程。微调模型虽在特定任务上可能更准确，但其推理过程透明度较低。</p>
<p><strong>Q：除 RAG 与微调外，模型增强技术还有哪些新兴趋势？</strong> A：新兴趋势包括：持续学习技术（使模型无需完整重训即可更新知识）、更高效的参数高效微调方法、基于先进神经架构的改进检索机制，以及能动态决定何时使用内部知识 vs. 外部检索的模型。</p>
<h3 data-id="heading-8">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别盲排！云监控 2.0 SysOM 破解 4 大隐式内存痛点]]></title>    <link>https://juejin.cn/post/7576661150683938831</link>    <guid>https://juejin.cn/post/7576661150683938831</guid>    <pubDate>2025-11-26T06:26:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576661150683938831" data-draft-id="7576569518262845440" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别盲排！云监控 2.0 SysOM 破解 4 大隐式内存痛点"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2025-11-26T06:26:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别盲排！云监控 2.0 SysOM 破解 4 大隐式内存痛点
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T06:26:38.000Z" title="Wed Nov 26 2025 06:26:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：尝君</p>
<h2 data-id="heading-0">背景</h2>
<p>在云原生架构普及的背景下，容器化显著提升了应用交付效率和资源利用率，但也带来了运维挑战。由于容器对底层系统的抽象，内存可见性降低，导致高负载下出现的内存占用过高、抖动甚至服务退化等问题难以及时发现和定位。传统依赖人工、日志回溯和逐节点分析的排查方式效率低下，难以应对动态环境；而隐性内存泄漏等长期问题则持续影响稳定性并推高运维成本。</p>
<p>为此，<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Fcms%3Fspm%3Da1z389.11499242.0.0.65452413vvcY0e%26utm_content%3Dg_1000408141" target="_blank" title="https://www.aliyun.com/product/cms?spm=a1z389.11499242.0.0.65452413vvcY0e&amp;utm_content=g_1000408141" ref="nofollow noopener noreferrer">云监控2.0</a> <strong>[</strong> <strong>1]</strong> 全新打造底层操作系统诊断 <strong>[</strong> <strong>2]</strong> 能力，可实现对主机、容器运行时及应用进程的全栈内存状态一键扫描与统一分析。该方案无需侵入业务，即可快速识别异常模式，显著提升问题发现与根因定位效率。</p>
<h2 data-id="heading-1">业务痛点解析</h2>
<p>隐式内存占用指业务运行中间接产生的系统内存消耗，未体现在应用进程的常规指标（如 RSS/PSS）中，因而难以被监控或业务感知。尽管不表现为“显式”使用，却真实占用物理内存。由于缺乏有效暴露与归因机制，这类内存往往在系统层面持续累积，最终导致可用内存下降、频繁回收甚至 OOM。在高负载、高并发或复杂云原生架构中，该问题尤为突出，严重影响服务延迟、调度效率与系统稳定性。因此，亟需结合内核级追踪与全栈关联分析，实现从“看到内存用量”到“理解内存成因”的跃迁，提升可观测性与资源治理精度。</p>
<h3 data-id="heading-2">痛点 1：文件缓存(filecache)高</h3>
<p>filecache 用来提升文件访问性能，并且理论上可以在内存不足时被回收，但高 filecache 在生产环境中也引发了诸多问题：</p>
<ul>
<li>filecache 回收时，直接影响业务响应时间（RT），在高并发环境中，这种延时尤为显著，可能导致用户体验急剧下降。例如，在电商网站的高峰购物时段，filecache 的回收延时可能会引起用户购物和付款卡顿，直接影响用户体验。</li>
<li>在 Kubernetes（k8s）环境中，workingset 包含活跃的文件缓存，如果这些活跃缓存过高，会直接影响 K8s 的调度决策，导致容器无法被高效调度到合适的节点，从而影响应用的可用性和整体的资源利用率。</li>
</ul>
<h3 data-id="heading-3">痛点 2：SReclaimable 高</h3>
<p>SReclaimable 是内核维护的可回收缓存，虽不计入用户进程内存统计，但受应用行为（如频繁文件操作、临时文件创建/删除）显著影响。尽管系统可在内存压力下回收它，但回收过程涉及复杂的锁竞争与同步，常引发较高的 CPU 开销和延迟抖动。SReclaimable 长期高位会占用大量物理内存，却因监控通常只关注进程 RSS 或容器内存而被忽视，造成内存压力误判。</p>
<p>因此，应将 SReclaimable 纳入关键内存指标，结合应用行为与内核观测，实现精准归因与动态管控，防范其对系统稳定性的潜在威胁。</p>
<h3 data-id="heading-4">痛点 3：memory group 残留</h3>
<p>cgroup 与 namespace 是容器运行时的核心机制。在高频调度场景（如大规模微服务或批处理系统）中，若清理不及时或内核释放延迟，易引发 cgroup 泄漏——即无关联进程的 cgroup 目录未被回收。这不仅占用内核内存，还会引起内存统计误差，导致监控异常、延时抖动等问题。</p>
<p>因此，保障 cgroup 生命周期闭环，结合内核监控与主动巡检，及时清理残留实例，是高密度容器环境稳定性治理的关键。</p>
<h3 data-id="heading-5">痛点 4：内存不足，却找不到去哪儿了</h3>
<p>当系统内存紧张时，常规工具（如 top）难以揭示真实内存去向——它们无法观测内核驱动（如 GPU、网卡、RDMA）直接分配的内存。在 AI 训练等高性能场景中，GPU 驱动会大量申请  memory、DMA buffer 等系统内存用于显存映射与通信，但这些关键开销对用户“不可见”。运维人员只能看到 MemAvailable 骤降甚至耗尽，却无法定位具体任务、机制或判断是否存在泄漏。</p>
<p>这种可观测性盲区严重拖慢排障效率，可能导致服务中断或训练失败。更糟的是，根因不明易使同类问题反复发生，引发故障蔓延，威胁系统稳定性。</p>
<h2 data-id="heading-6">解决方案：用 SysOM 诊断隐式内存</h2>
<h3 data-id="heading-7">方案介绍</h3>
<p>在四种隐式内存占用场景中，文件缓存（page cache）过高最为常见。以该场景为例，核心问题是：哪些进程在读写哪些文件，导致缓存堆积？</p>
<p>解答的关键在于实现从内存页（page）到具体文件路径的精准归因。这需深入内核，完成从物理内存到文件语义的映射，主要分两步：</p>
<ul>
<li>由 page 定位 inode：通过 page-&gt;mapping 和 index 找到其所属的 address_space 和文件 inode；</li>
<li>由 inode 还原文件路径：遍历 dentry 缓存，在挂载命名空间中重建完整路径（如 /data/model/xxx.bin）。</li>
</ul>
<p>要实现端到端追溯，系统需具备两大能力：全量扫描文件缓存页，以及根据 inode 高效解析对应路径。传统工具仅提供静态统计，缺乏进程-文件-页的动态关联。唯有构建细粒度、可追溯、低开销的全链路归因机制，才能回答“谁、读了什么、占了多少”，实现高缓存场景下的精准诊断与快速响应。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/315385c91bbb412e812f4f4599e549d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764743198&amp;x-signature=v5tdUZJ%2B17Ewg7VY3XT9iUFdMLM%3D" alt="图片" loading="lazy"/></p>
<p>我们也调研分析了多种方案的优缺点：</p>






























<table><thead><tr><th>方案</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>驱动模块(ko)</td><td>实现简单</td><td>侵入性强，存在宕机风险，且内核版本繁多，适配难度大</td></tr><tr><td>eBPF</td><td>无宕机风险，兼容性好</td><td>循环能力不足</td></tr><tr><td>mincore 系统调用</td><td>基于系统调用</td><td>关闭的文件无法扫描</td></tr><tr><td>kcore</td><td>具备全量扫描能力</td><td>CPU 消耗大</td></tr></tbody></table>
<p>最终我们选择基于 kcore 来解析系统 filecache 对应的文件，但也需要解决几个问题：</p>
<ol>
<li>
<p>kcore 读的是 raw 内存，没有数据结构信息。</p>
</li>
<li>
<p>kcore 需要遍历全量内存，在大内存系统下，CPU 消耗大，时间长。</p>
</li>
<li>
<p>需要支持整机和容器级的文件缓存扫描。</p>
</li>
</ol>
<h3 data-id="heading-8">方案实施</h3>
<p>针对传统 kcore 方案在文件缓存分析中内存依赖强、兼容性差、开销高等问题，我们提出一种基于 eBPF  BTF 协同的轻量级解析机制。</p>
<p>核心优势在于：利用内核自带的 BTF 信息，动态获取关键数据结构的字段偏移，实现跨版本、跨发行版的安全内存解析。针对 page cache 物理页离散分布、全量遍历成本高的挑战，使用采样策略——仅需捕获少量活跃的缓存页，即可回溯至对应 inode，解析出文件路径及所属 cgroup。结合 /proc/kpageflags 和 /proc/kpagecgroup 提供的页级属性（如是否为文件页、可回收性、cgroup 归属等），实现物理内存到容器和工作负载的精准归因。</p>
<p>该方案首次在生产环境中实现非侵入、低开销、高精度的文件缓存溯源，突破“看得见总量、看不见来源”的瓶颈，为缓存膨胀与隐性内存占用提供有效诊断手段。</p>
<h2 data-id="heading-9">教育行业某客户通过控制台解决内存高问题</h2>
<p>K8s 是一个开源的容器编排平台，主要用于自动化部署、扩展和管理容器化应用。它提供一个强大的、灵活的架构来支持大规模的应用服务，从而简化了应用的运维管理，企业在享受 K8s 在容器编排和部署所带来的便利时，同时也面临新的问题。</p>
<h3 data-id="heading-10">案例 1：通过 SysOM 分析容器内存工作集高</h3>
<p>Kubernetes 采用内存工作集(workingset)来监控和管理容器的内存使用，当容器内存使用量超过了设置的内存限制或者节点出现内存压力时，kubernetes 会根据 workingset 来决定是否驱逐或者杀死容器。</p>
<p><strong>内存工作集计算公式：</strong> Workingset = 匿名内存 + active_file。匿名内存一般是程序通过 new/malloc/mmap 方式分配，而 active_file 是进程读写文件引入，程序一般对这类内存使用存在不透明情况，经常容易出问题。客户通过容器监控发现其 K8s 集群中某个 pod 的 Workingset 内存持续走高，无法进一步定位究竟是什么原因导致的 Workingset 内存使用高。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bb76a89ccdbc4ea18e270464264c0cda~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764743198&amp;x-signature=51UWgNE5UluXn1UefybFFCZ2QEA%3D" alt="图片" loading="lazy"/></p>
<p>针对上述场景，先找到 Pod 所在的 ECS 节点，通过使用 SysOM 使用内存全景分析诊断，选择目标 ECS 节点后，再选择目标 Pod，发起诊断：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34a45e25c0514b2b983ba03df52c8569~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764743198&amp;x-signature=70hg4iZ4oBkczNCT47eVhnazTYU%3D" alt="图片" loading="lazy"/></p>
<p>诊断结果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bbd9c747e3ad4862bab40475a90e01d6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764743198&amp;x-signature=bDOZwCuODbtYS9MrBRxECl697IY%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c96be8719674024885b02dee2890dbf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764743198&amp;x-signature=MbaPEYv959dNqK1didruLtlsfDE%3D" alt="图片" loading="lazy"/></p>
<p>诊断结论明确指出：容器 xxx 内存使用率过高，存在内存不足风险，主要因文件缓存占用较大。</p>
<p>查看文件缓存排序表可见，前两个容器中的日志文件（路径为宿主机映射路径，容器内实际位于 /var/log）共占用约 228MB 缓存，系业务程序读写日志所致。</p>
<p>建议优化日志写入方式或限制缓存增长，避免 WorkingSet 内存过高触发 OOM 或直接内存回收，导致业务延迟。</p>
<p><strong>修复建议：</strong></p>
<ol>
<li>
<p>通过手动执行 echo 1 &gt; /proc/sys/vm/drop_caches 来主动释放缓存。</p>
</li>
<li>
<p>如产生文件缓存的文件是非必要文件，可以通过手动删除文件释放缓存。</p>
</li>
<li>
<p>使用 ack 集群的内存 QoS 功能（复制链接至浏览器打开）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Fack%2Fack-managed-and-ack-dedicated%2Fuser-guide%2Fmemory-qos-for-containers%3Fspm%3Da2c4g.11186623.0.0.58fa162eSqDX9Q" target="_blank" title="https://help.aliyun.com/zh/ack/ack-managed-and-ack-dedicated/user-guide/memory-qos-for-containers?spm=a2c4g.11186623.0.0.58fa162eSqDX9Q" ref="nofollow noopener noreferrer">help.aliyun.com/zh/ack/ack-…</a></p>
</li>
</ol>
<h3 data-id="heading-11">案例 2： 通过SysOM分析共享内存高</h3>
<p>某行业客户发现，在运行较久的机器上，通过 free -h 看到的剩余内存较少，buff/cache 比较多，客户通过分析和查阅资料，通过执行 echo 3 &gt; /proc/sys/vm/drop_caches 来主动释放缓存。客户发现，使用该方法可以回收部分缓存，但是仍然还有大量的 cache 占用没有释放：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/688edeca29384be8afeb4054ea4ecd95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764743198&amp;x-signature=2PkL6ZDmdEjDv1nnuKP02gO5ywY%3D" alt="图片" loading="lazy"/></p>
<p>针对上述场景，通过使用 SysOM 对目标 ECS 进行内存全景分析诊断，诊断的结果如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a5ceffb5771489fa8ded6dffad33d2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764743198&amp;x-signature=j7ZShucXHNP3NwASRbA2fspci5I%3D" alt="图片" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/354c5685b17a44ffbeb7b922803fa5fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764743198&amp;x-signature=s%2F9njw2YKcEPmRMnYzj0HDcrjWE%3D" alt="图片" loading="lazy"/></p>
<p>诊断结论明确指出：共享内存占用过高（34.35 GB），且以大量小文件（如 160 KB）为主，疑似存在泄露。从共享内存缓存占用排序表可见，占用最高的前 30 个文件均来自 /dev/shm/ganglia/*，证实了小文件泄漏问题。由此判断，客户业务程序在该目录下创建了共享内存文件但未及时释放。结合业务场景评估后，可直接删除这些文件以释放缓存内存。</p>
<p>内存全景诊断结果说明及详细使用教程可参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Falinux%2Fuser-guide%2Fmemory-panorama-analysis-function-instructions%3Fspm%3Da2c4g.11186623.0.0.558351c0g5NK0J" target="_blank" title="https://help.aliyun.com/zh/alinux/user-guide/memory-panorama-analysis-function-instructions?spm=a2c4g.11186623.0.0.558351c0g5NK0J" ref="nofollow noopener noreferrer">help.aliyun.com/zh/alinux/u…</a></p>
<h2 data-id="heading-12">客户收益</h2>
<p>目前操作系统诊断能力 <strong>[</strong> <strong>3]</strong> 能够对高负载、网络延迟抖动、内存泄漏、内存溢出(OOM)、宕机、I/O 流量分析及性能抖动等各种复杂问题进行一键诊断，在保障稳定性的同时最大化资源效率，更重要的是，该能力有效缓解系统资源压力引发的性能抖动——如文件缓存膨胀或内核内存增长触发直接回收甚至 OOM Killer，造成延迟或服务中断。通过及时识别异常占用并释放非必要缓存，可避免 Pod 频繁进入内存回收路径，降低进程阻塞与响应延迟，保障关键业务服务质量。</p>
<p><strong>下一步规划：</strong></p>
<p>我们将持续演进 SysOM 的智能运维能力：融合大模型的泛化理解与小模型的实时推理，构建分层诊断体系，实现异常早期识别、根因推测与处置建议生成；支持跨平台、多环境统一管理，扩展主流 OS 发行版兼容性；深化内核级细粒度监控，填补观测盲区，并集成至告警框架，推动运维从“被动响应”转向“主动防控”。整体推动操作系统从资源管理者向智能运维中枢演进，为关键业务提供更强技术底座。</p>
<p>如果您想了解更多的诊断能力，可参考系统诊断文档。</p>
<p><strong>相关链接：</strong></p>
<p>[1] 云监控 2.0</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faccount.aliyun.com%2Flogin%2Flogin.htm%3Foauth_callback%3Dhttps%3A%2F%2Fcmsnext.console.aliyun.com%2Fnext%2Fhome" target="_blank" title="https://account.aliyun.com/login/login.htm?oauth_callback=https://cmsnext.console.aliyun.com/next/home" ref="nofollow noopener noreferrer">account.aliyun.com/login/login…</a></p>
<p>[2] 系统诊断</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Faccount.aliyun.com%2Flogin%2Flogin.htm%3Foauth_callback%3Dhttps%3A%2F%2Fcmsnext.console.aliyun.com%2Fnext%2Fregion%2Fcn-shanghai%2Fworkspace%2Fdefault-cms-1808078950770264-cn-shanghai%2Fapp%2Fhost%2Fhost-sysom" target="_blank" title="https://account.aliyun.com/login/login.htm?oauth_callback=https://cmsnext.console.aliyun.com/next/region/cn-shanghai/workspace/default-cms-1808078950770264-cn-shanghai/app/host/host-sysom" ref="nofollow noopener noreferrer">account.aliyun.com/login/login…</a></p>
<p>[3] 操作系统诊断能力</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Falinux%2Fuser-guide%2Foperating-system-console%2F%3Fspm%3Da2c4g.11186623.help-menu-2632541.d_2_0.423151c0lfR1YN%26scm%3D20140722.H_2848563._.OR_help-T_cn~zh-V_1" target="_blank" title="https://help.aliyun.com/zh/alinux/user-guide/operating-system-console/?spm=a2c4g.11186623.help-menu-2632541.d_2_0.423151c0lfR1YN&amp;scm=20140722.H_2848563._.OR_help-T_cn~zh-V_1" ref="nofollow noopener noreferrer">help.aliyun.com/zh/alinux/u…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[antd Image base64缓存 + loading 态优化方案]]></title>    <link>https://juejin.cn/post/7576609946190987300</link>    <guid>https://juejin.cn/post/7576609946190987300</guid>    <pubDate>2025-11-26T06:28:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576609946190987300" data-draft-id="7576575703166828550" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="antd Image base64缓存 + loading 态优化方案"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-26T06:28:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jolyne_"/> <meta itemprop="url" content="https://juejin.cn/user/339101640827981"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            antd Image base64缓存 + loading 态优化方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/339101640827981/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jolyne_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T06:28:12.000Z" title="Wed Nov 26 2025 06:28:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>项目遇到一个需要优化的点。就是公司的网要么都比较差，在点击 Image 查看预览时，会加载很久，并且没有loading态。而且来回切换时，每次都重新请求，没有缓存。我们的图片是存在七牛的，而七牛并没有缓存，所以前端通过 base64 来实现缓存</p>
<h2 data-id="heading-1">思路</h2>
<p>请先看原本的代码：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">IImgDTO</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/service/base/v1/organization/get-page"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">IObj</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/utils/interface"</span>;
<span class="hljs-keyword">import</span> { classNames } <span class="hljs-keyword">from</span> <span class="hljs-string">"@/utils/tools"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">GetProps</span>, <span class="hljs-title class_">Image</span>, <span class="hljs-title class_">Skeleton</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"antd"</span>;
<span class="hljs-keyword">import</span> { useEffect, useRef, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">type</span> <span class="hljs-title class_">PreviewGroupType</span> = <span class="hljs-title class_">GetProps</span>&lt;<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Image</span>.<span class="hljs-property">PreviewGroup</span>&gt;;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ITXImagesRenderProps</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">PreviewGroupType</span> {
  <span class="hljs-attr">imgs</span>: <span class="hljs-title class_">IImgDTO</span>[];
  showCount?: <span class="hljs-built_in">number</span>;
  width?: <span class="hljs-built_in">number</span>;
  height?: <span class="hljs-built_in">number</span>;
  className?: <span class="hljs-built_in">string</span>;
  <span class="hljs-comment">/** <span class="hljs-doctag">@param</span> 仅展示第一张，剩余的预览查看 */</span>
  albumFlag?: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-comment">/** <span class="hljs-doctag">@param</span> 更多图标的类名 */</span>
  moreClassName?: <span class="hljs-built_in">string</span>;
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">TXImagesRender</span> = <span class="hljs-keyword">function</span> <span class="hljs-title function_">TXImagesRender_</span>(<span class="hljs-params">
  props: ITXImagesRenderProps
</span>) {
  <span class="hljs-keyword">const</span> {
    imgs = [],
    showCount = <span class="hljs-number">2</span>,
    className = <span class="hljs-string">""</span>,
    width = <span class="hljs-number">32</span>,
    height = width,
    albumFlag = <span class="hljs-literal">false</span>,
    moreClassName = <span class="hljs-string">""</span>,
    ...reset
  } = props;
  <span class="hljs-keyword">const</span> [visible, setVisible] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> [current, setCurrent] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>);

  <span class="hljs-keyword">if</span> (!imgs.<span class="hljs-property">length</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"-"</span>;
  }

  <span class="hljs-keyword">let</span> showImgs = imgs;
  <span class="hljs-keyword">let</span> num = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">if</span> (showImgs.<span class="hljs-property">length</span> &gt; showCount) {
    num = showImgs.<span class="hljs-property">length</span> - showCount + <span class="hljs-number">1</span>;
    showImgs = imgs.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, showCount - <span class="hljs-number">1</span>);
  }

  <span class="hljs-keyword">if</span> (albumFlag) {
    num = <span class="hljs-number">0</span>;
    showImgs = imgs.<span class="hljs-title function_">slice</span>(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Image.PreviewGroup</span>
      {<span class="hljs-attr">...reset</span>}
      <span class="hljs-attr">items</span>=<span class="hljs-string">{imgs?.map?.((r)</span> =&gt;</span> r.fullPath)}
      preview={{
        visible,
        onVisibleChange: setVisible,
        current,
        onChange: (index) =&gt; setCurrent(index),
      }}
    &gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{classNames({</span> "<span class="hljs-attr">flex</span> <span class="hljs-attr">gap-1</span>"<span class="hljs-attr">:</span> <span class="hljs-attr">true</span>, [<span class="hljs-attr">className</span>]<span class="hljs-attr">:</span> <span class="hljs-attr">true</span> })}&gt;</span>
        {showImgs.map((r, rIndx) =&gt; {
          return (
            <span class="hljs-tag">&lt;<span class="hljs-name">Image</span>
              <span class="hljs-attr">key</span>=<span class="hljs-string">{rIndx}</span>
              <span class="hljs-attr">width</span>=<span class="hljs-string">{width}</span>
              <span class="hljs-attr">height</span>=<span class="hljs-string">{height}</span>
              <span class="hljs-attr">src</span>=<span class="hljs-string">{r.fullThumbnailPath}</span>
              <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> {
                setCurrent(rIndx);
              }}
            /&gt;
          );
        })}
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
          <span class="hljs-attr">className</span>=<span class="hljs-string">{classNames({</span>
            "<span class="hljs-attr">bg-gray-400</span>/<span class="hljs-attr">30</span> <span class="hljs-attr">cursor-pointer</span> <span class="hljs-attr">flex</span> <span class="hljs-attr">items-center</span> <span class="hljs-attr">justify-center</span> <span class="hljs-attr">rounded</span>"<span class="hljs-attr">:</span>
              <span class="hljs-attr">true</span>,
            <span class="hljs-attr">hidden:</span> !<span class="hljs-attr">num</span>,
            [<span class="hljs-attr">moreClassName</span>]<span class="hljs-attr">:</span> <span class="hljs-attr">true</span>,
          })}
          <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> {
            setCurrent(showCount - 1);
            setVisible(true);
          }}
          style={{
            height: `${height}px`,
            width: `${width}px`,
          }}
        &gt;
          +{num}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Image.PreviewGroup</span>&gt;</span></span>
  );
};

</code></pre>
<p>原本的代码在 preview 点开时没有 loading，网差的时候体验就不好。虽然antd Image在左右切换时会缓存，但在首次点开时依旧需要请求图片。</p>
<p>因此改动后，通过base64手动缓存图片，再加loading态，来实现优化方案</p>
<p>新的代码：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-comment">//...</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">TXImagesRender</span> = <span class="hljs-keyword">function</span> <span class="hljs-title function_">TXImagesRender_</span>(<span class="hljs-params">
  props: ITXImagesRenderProps
</span>) {
  <span class="hljs-keyword">const</span> {
    imgs = [],
    showCount = <span class="hljs-number">2</span>,
    className = <span class="hljs-string">""</span>,
    width = <span class="hljs-number">32</span>,
    height = width,
    albumFlag = <span class="hljs-literal">false</span>,
    moreClassName = <span class="hljs-string">""</span>,
    ...reset
  } = props;

  <span class="hljs-comment">//...</span>
  <span class="hljs-keyword">const</span> [loading, setLoading] = useState&lt;<span class="hljs-built_in">boolean</span>&gt;(<span class="hljs-literal">false</span>);
  <span class="hljs-keyword">const</span> imgRef = useRef&lt;<span class="hljs-title class_">HTMLImageElement</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [base64Obj, setBase64Obj] = useState&lt;<span class="hljs-title class_">IObj</span>&gt;({});

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleImageLoaded</span> = (<span class="hljs-params">url: <span class="hljs-built_in">string</span></span>) =&gt; {
    <span class="hljs-keyword">if</span> (base64Obj[url]) {
      <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>)
      <span class="hljs-keyword">return</span>
    }
    <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> img = imgRef.<span class="hljs-property">current</span>;

      <span class="hljs-keyword">if</span> (!img) <span class="hljs-keyword">return</span>;

      <span class="hljs-keyword">const</span> canvas = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">"canvas"</span>);
      canvas.<span class="hljs-property">width</span> = img.<span class="hljs-property">naturalWidth</span>;
      canvas.<span class="hljs-property">height</span> = img.<span class="hljs-property">naturalHeight</span>;
      <span class="hljs-keyword">const</span> ctx = canvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">"2d"</span>);
      <span class="hljs-keyword">if</span> (!ctx) <span class="hljs-keyword">return</span>;

      ctx.<span class="hljs-title function_">drawImage</span>(img, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
      <span class="hljs-keyword">const</span> dataURL = canvas.<span class="hljs-title function_">toDataURL</span>(<span class="hljs-string">"image/png"</span>);
      <span class="hljs-title function_">setBase64Obj</span>(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span> ({
        ...prev,
        [url]: dataURL,
      }));
    } <span class="hljs-keyword">catch</span> (err) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"无法生成Base64（可能因跨域图片）"</span>, err);
    }
  };

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> currentImgHasBase64 = base64Obj[imgs[current]?.<span class="hljs-property">fullPath</span>]
    <span class="hljs-keyword">if</span> (visible &amp;&amp; !currentImgHasBase64) {
      <span class="hljs-title function_">setLoading</span>(<span class="hljs-literal">true</span>);
    }
  }, [visible, current, base64Obj])

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Image.PreviewGroup</span>
      <span class="hljs-attr">preview</span>=<span class="hljs-string">{{</span>
        <span class="hljs-attr">imageRender:</span> (<span class="hljs-attr">node</span>, <span class="hljs-attr">info</span>) =&gt;</span> (
          <span class="hljs-tag">&lt;&gt;</span>
            {loading &amp;&amp; <span class="hljs-tag">&lt;<span class="hljs-name">Skeleton.Image</span> <span class="hljs-attr">active</span> /&gt;</span>}
            <span class="hljs-tag">&lt;<span class="hljs-name">img</span> 
              <span class="hljs-attr">className</span>=<span class="hljs-string">{classNames({</span> "!<span class="hljs-attr">hidden</span>"<span class="hljs-attr">:</span> <span class="hljs-attr">loading</span> })}
              <span class="hljs-attr">src</span>=<span class="hljs-string">{base64Obj[info.image.url]</span> ?? <span class="hljs-attr">info.image.url</span>}
              <span class="hljs-attr">ref</span>=<span class="hljs-string">{imgRef}</span>
              <span class="hljs-attr">onLoad</span>=<span class="hljs-string">{()</span> =&gt;</span> handleImageLoaded(info.image.url)}
              crossOrigin="anonymous"
            /&gt;
          <span class="hljs-tag">&lt;/&gt;</span></span>
        ),
      }}
    &gt;
      <span class="hljs-comment">//...</span>
    &lt;/<span class="hljs-title class_">Image</span>.<span class="hljs-property">PreviewGroup</span>&gt;
  );
};
</code></pre>
<p>新代码加了两个逻辑，在预览点开时，加载loading态，当onLoad时间图片加载完成时，取消loading态。还需要判断一个东西，如果base64缓存已经存在了，则不需要loading态了，直接使用缓存的即可</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Docker Compose 部署certbot实现TLS证书签发和续期]]></title>    <link>https://juejin.cn/post/7576646533615140918</link>    <guid>https://juejin.cn/post/7576646533615140918</guid>    <pubDate>2025-11-26T06:18:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576646533615140918" data-draft-id="7576646533614944310" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Docker Compose 部署certbot实现TLS证书签发和续期"/> <meta itemprop="keywords" content="自动化运维"/> <meta itemprop="datePublished" content="2025-11-26T06:18:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="猿先生133"/> <meta itemprop="url" content="https://juejin.cn/user/3923509324823005"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Docker Compose 部署certbot实现TLS证书签发和续期
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3923509324823005/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    猿先生133
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T06:18:55.000Z" title="Wed Nov 26 2025 06:18:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前提条件</h2>
<ul>
<li>有现成的域名、公网IP</li>
<li>可访问公网的服务器</li>
<li>可用的邮箱</li>
</ul>
<h2 data-id="heading-1">开始部署</h2>
<h3 data-id="heading-2">1. Certbot 镜像拉取</h3>
<pre><code class="hljs language-shell" lang="shell">docker pull certbot/certbot:v5.1.0
</code></pre>
<h3 data-id="heading-3">2. 创建 <code>docker-compose.yml</code> 文件</h3>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-attr">services:</span>
  <span class="hljs-attr">nginx:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">nginx:1.25.4</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">nginx</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"80:80"</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"443:443"</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">/etc/localtime:/etc/localtime:ro</span>                  <span class="hljs-comment"># 和服务器时间同步</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">/root/docker/nginx/nginx/:/etc/nginx/</span>             <span class="hljs-comment"># 主配置目录</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">/root/docker/nginx/nginx/certs/:/etc/letsencrypt</span>  <span class="hljs-comment"># 证书配置目录</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">/root/docker/nginx/html/:/usr/share/nginx/html</span>    <span class="hljs-comment"># 网站根目录</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">/root/docker/nginx/log/:/var/log/nginx</span>            <span class="hljs-comment"># 日志目录</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">nginx-network</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">entrypoint:</span> [<span class="hljs-string">"/docker-entrypoint.sh"</span>]
    <span class="hljs-attr">command:</span> [<span class="hljs-string">"nginx"</span>, <span class="hljs-string">"-g"</span>, <span class="hljs-string">"daemon off;"</span>]
    <span class="hljs-attr">stop_signal:</span> <span class="hljs-string">SIGQUIT</span>
    <span class="hljs-attr">logging:</span>
      <span class="hljs-attr">driver:</span> <span class="hljs-string">json-file</span>
    <span class="hljs-attr">networks:</span> 
      <span class="hljs-bullet">-</span> <span class="hljs-string">nginx-network</span>
    <span class="hljs-attr">depends_on:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">certbot</span>   <span class="hljs-comment"># 确保 Certbot 先启动（非必须）</span>

  <span class="hljs-attr">certbot:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">certbot/certbot</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">certbot</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">/root/docker/nginx/nginx/certs/:/etc/letsencrypt</span>      <span class="hljs-comment"># 证书存储目录（与 Nginx 共享）</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">/root/docker/nginx/html/:/var/www/html</span>                <span class="hljs-comment"># HTTP 验证所需的 Webroot</span>
    <span class="hljs-attr">networks:</span> 
      <span class="hljs-bullet">-</span> <span class="hljs-string">nginx-network</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>

<span class="hljs-attr">networks:</span>
  <span class="hljs-attr">nginx-network:</span>
    <span class="hljs-attr">external:</span> <span class="hljs-literal">true</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">bridge</span>

</code></pre>
<h3 data-id="heading-4">3. 修改 <code>nginx.conf</code> 或 创建 <code>tansuo.conf</code> 文件</h3>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-string">server</span> {
    <span class="hljs-string">listen</span> <span class="hljs-number">80</span><span class="hljs-string">;</span>
    <span class="hljs-string">server_name</span> <span class="hljs-string">tansuo.com;</span>  <span class="hljs-comment"># 替换为你的域名</span>
    <span class="hljs-comment">#配置http验证可访问</span>
    <span class="hljs-string">location</span> <span class="hljs-string">^~</span> <span class="hljs-string">/.well-known/acme-challenge/</span> {
        <span class="hljs-comment">#此目录都是nginx容器内的目录，对应宿主机volumes中的http验证目录，而宿主机的又与certbot容器中命令--webroot-path指定目录一致，从而就整个串起来了，解决了http验证问题</span>
        <span class="hljs-string">root</span> <span class="hljs-string">/etc/letsencrypt;</span>
    }
    <span class="hljs-comment"># 其他请求重定向到HTTPS</span>
    <span class="hljs-string">location</span> <span class="hljs-string">/</span> {
        <span class="hljs-string">return</span> <span class="hljs-number">301</span> <span class="hljs-string">https://$host$request_uri;</span>
    }
}

</code></pre>
<h3 data-id="heading-5">4. 启动服务</h3>
<pre><code class="hljs language-js" lang="js">docker compose -f docker-compose.<span class="hljs-property">yml</span> up -d
</code></pre>
<h3 data-id="heading-6">5. 测试证书发放</h3>
<p>运行以下命令测试证书发放是否正常：</p>
<pre><code class="hljs language-js" lang="js">docker compose run --rm certbot certonly --webroot --webroot-path /etc/letsencrypt --dry-run -d tansuo.<span class="hljs-property">com</span>
</code></pre>
<p>如果输出 <code>The dry run was successful.</code>，说明测试成功。</p>
<p>如果出现：：404字样，首先检查yml配置是否和文章中的匹配，其次检查域名和公网IP是否正确绑定。最后重启nginx服务。</p>
<h3 data-id="heading-7">6. 正式获取证书</h3>
<p>如果测试成功，去掉 <code>--dry-run</code> 参数正式获取证书：</p>
<pre><code class="hljs language-js" lang="js">docker compose run --rm certbot certonly --webroot --webroot-path /etc/letsencrypt -d tansuo.<span class="hljs-property">com</span>
</code></pre>
<p>按照提示输入邮箱等信息，完成证书申请。</p>
<h3 data-id="heading-8">7. 生成证书文件</h3>
<p>Certbot 会在 <code>/root/docker/nginx/nginx/certs/live/tansuo.com/</code> 目录下生成证书文件，包括：</p>
<ul>
<li><code>fullchain.pem</code>：完整的证书链</li>
<li><code>privkey.pem</code>：私钥</li>
</ul>
<h3 data-id="heading-9">8. 创建 HTTPS 配置文件</h3>
<p>在你自定义的配置文件，比如上文创建的<code>tansuo.conf</code> 中配置 HTTPS信息：</p>
<pre><code class="hljs language-js" lang="js">server {
    listen       <span class="hljs-number">443</span> ssl;
    server_name  tansuo.<span class="hljs-property">com</span>;

    ssl_certificate /etc/letsencrypt/live/xxx.<span class="hljs-property">com</span>/fullchain.<span class="hljs-property">pem</span>;
    ssl_certificate_key /etc/letsencrypt/live/xxx.<span class="hljs-property">com</span>/privkey.<span class="hljs-property">pem</span>;
    ssl_session_timeout 5m;
    ssl_protocols <span class="hljs-title class_">TLSv1</span> <span class="hljs-title class_">TLSv1</span><span class="hljs-number">.1</span> <span class="hljs-title class_">TLSv1</span><span class="hljs-number">.2</span>;
    ssl_ciphers <span class="hljs-variable constant_">ECDHE</span>-<span class="hljs-variable constant_">RSA</span>-<span class="hljs-title class_">AES128</span>-<span class="hljs-variable constant_">GCM</span>-<span class="hljs-title class_">SHA256</span>:<span class="hljs-attr">HIGH</span>:!<span class="hljs-attr">aNULL</span>:!<span class="hljs-title class_">MD5</span>:!<span class="hljs-title class_">RC4</span>:!<span class="hljs-variable constant_">DHE</span>;
    ssl_prefer_server_ciphers on;

    location / {
        root   /usr/share/nginx/html;
        index  index.<span class="hljs-property">html</span> index.<span class="hljs-property">htm</span>;
    }

    location /api/ {
        proxy_pass <span class="hljs-attr">http</span>:<span class="hljs-comment">//gateway:18080/;</span>
    }

    error_page   <span class="hljs-number">500</span> <span class="hljs-number">502</span> <span class="hljs-number">503</span> <span class="hljs-number">504</span>  /50x.<span class="hljs-property">html</span>;
    location = /50x.<span class="hljs-property">html</span> {
        root   /usr/share/nginx/html;
    }
}
</code></pre>
<p>将此文件挂载到 Nginx 的配置目录中，我的tansuo.conf位于conf.d目录下。</p>
<h3 data-id="heading-10">9. 重启 Nginx</h3>
<p>重新加载 Nginx 配置以应用 HTTPS：</p>
<pre><code class="hljs language-js" lang="js">docker compose restart nginx
</code></pre>
<h3 data-id="heading-11">10. 配置定时任务自动续期</h3>
<p>为了避免证书过期，创建一个检查脚本，设置定时任务为每月 1 号凌晨 2 点检查证书是否过期&amp;自动续期证书&amp;重启 Nginx：
vi renew-certbot.sh</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>

<span class="hljs-comment"># Certbot SSL 证书自动续期脚本（针对90天有效期优化）</span>
<span class="hljs-comment"># 证书有效期：90天，推荐每30天检查续期</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"=== SSL 证书自动续期脚本开始执行 ==="</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"执行时间: <span class="hljs-subst">$(date)</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"证书类型: Let's Encrypt (90天有效期)"</span>

<span class="hljs-comment"># 设置变量</span>
LOG_FILE=<span class="hljs-string">"/var/log/certbot-renew.log"</span>
COMPOSE_DIR=<span class="hljs-string">"/root/docker"</span>

<span class="hljs-comment"># 记录开始时间</span>
START_TIME=$(<span class="hljs-built_in">date</span> +%s)

<span class="hljs-comment"># 检查必要目录</span>
<span class="hljs-keyword">if</span> [ ! -d <span class="hljs-string">"<span class="hljs-variable">$COMPOSE_DIR</span>"</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"错误: Docker Compose 目录不存在: <span class="hljs-variable">$COMPOSE_DIR</span>"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$LOG_FILE</span>"</span>
    <span class="hljs-built_in">exit</span> 1
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 切换到工作目录</span>
<span class="hljs-built_in">cd</span> <span class="hljs-string">"<span class="hljs-variable">$COMPOSE_DIR</span>"</span> || {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"错误: 无法切换到目录 <span class="hljs-variable">$COMPOSE_DIR</span>"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$LOG_FILE</span>"</span>
    <span class="hljs-built_in">exit</span> 1
}

<span class="hljs-built_in">echo</span> <span class="hljs-string">"工作目录: <span class="hljs-subst">$(pwd)</span>"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$LOG_FILE</span>"</span>

<span class="hljs-comment"># 检查 Docker 服务</span>
<span class="hljs-keyword">if</span> ! systemctl is-active --quiet docker; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"错误: Docker 服务未运行，尝试启动..."</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$LOG_FILE</span>"</span>
    systemctl start docker
    <span class="hljs-built_in">sleep</span> 10
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 检查证书过期时间（可选）</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"检查证书状态..."</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$LOG_FILE</span>"</span>
docker compose run --<span class="hljs-built_in">rm</span> certbot certificates 2&gt;&amp;1 | grep -E <span class="hljs-string">"(EXPIRED|VALID|Domains)"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$LOG_FILE</span>"</span>

<span class="hljs-comment"># 执行证书续期（--quiet 模式减少输出）</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"开始证书续期检查..."</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$LOG_FILE</span>"</span>
docker compose run --<span class="hljs-built_in">rm</span> certbot renew --quiet --non-interactive 2&gt;&amp;1 | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$LOG_FILE</span>"</span>

RENEW_RESULT=<span class="hljs-variable">${PIPESTATUS[0]}</span>

<span class="hljs-keyword">if</span> [ <span class="hljs-variable">$RENEW_RESULT</span> -eq 0 ]; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"✓ 证书续期检查完成"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$LOG_FILE</span>"</span>
    
    <span class="hljs-comment"># 检查是否有证书被更新</span>
    <span class="hljs-keyword">if</span> docker compose run --<span class="hljs-built_in">rm</span> certbot certificates 2&gt;&amp;1 | grep -q <span class="hljs-string">"待续期"</span>; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"检测到证书需要更新，重启 Nginx..."</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$LOG_FILE</span>"</span>
        
        <span class="hljs-comment"># 重启 Nginx</span>
        docker compose restart nginx 2&gt;&amp;1 | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$LOG_FILE</span>"</span>
        
        <span class="hljs-keyword">if</span> [ <span class="hljs-variable">${PIPESTATUS[0]}</span> -eq 0 ]; <span class="hljs-keyword">then</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"✓ Nginx 重启成功"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$LOG_FILE</span>"</span>
            <span class="hljs-comment"># 发送通知（可选）</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"证书续期成功 - <span class="hljs-subst">$(date)</span>"</span> &gt;&gt; /tmp/cert-renew-success.log
        <span class="hljs-keyword">else</span>
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"⚠ Nginx 重启失败，请手动检查"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$LOG_FILE</span>"</span>
        <span class="hljs-keyword">fi</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"ℹ 无需续期，证书仍在有效期内"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$LOG_FILE</span>"</span>
    <span class="hljs-keyword">fi</span>
<span class="hljs-keyword">else</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"✗ 证书续期失败，退出码: <span class="hljs-variable">$RENEW_RESULT</span>"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$LOG_FILE</span>"</span>
    <span class="hljs-comment"># 可以在这里添加报警通知</span>
    <span class="hljs-built_in">exit</span> <span class="hljs-variable">$RENEW_RESULT</span>
<span class="hljs-keyword">fi</span>

<span class="hljs-comment"># 计算执行时间</span>
END_TIME=$(<span class="hljs-built_in">date</span> +%s)
DURATION=$((END_TIME - START_TIME))

<span class="hljs-built_in">echo</span> <span class="hljs-string">"脚本执行完成，耗时: <span class="hljs-variable">${DURATION}</span>秒"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$LOG_FILE</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"完成时间: <span class="hljs-subst">$(date)</span>"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$LOG_FILE</span>"</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"========================================"</span> | <span class="hljs-built_in">tee</span> -a <span class="hljs-string">"<span class="hljs-variable">$LOG_FILE</span>"</span>
</code></pre>
<p>设置定时任务：</p>
<pre><code class="hljs">crontab -e
</code></pre>
<p>添加以下内容：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Let's Encrypt 证书自动续期（90天有效期）</span>
<span class="hljs-comment"># 每月1号凌晨2点检查（足够安全）</span>
0 2 1 * * /root/renew-certbot.sh &gt;/dev/null 2&gt;&amp;1

<span class="hljs-comment"># 日志清理（每月清理一次旧日志）</span>
0 3 1 * * find /var/log -name <span class="hljs-string">"certbot-renew.*.log"</span> -mtime +30 -delete
</code></pre>
<p>保存后，定时任务将自动运行。</p>
<hr/>
<h2 data-id="heading-12">总结</h2>
<p>通过以上步骤，使用 Certbot 为你的网站配置了TLS证书，并设置了自动续期任务。确保网站始终安全可靠，避免因证书过期导致的服务中断。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot整合Apache Spark实现一个简单的数据分析功能]]></title>    <link>https://juejin.cn/post/7576559408659955764</link>    <guid>https://juejin.cn/post/7576559408659955764</guid>    <pubDate>2025-11-26T06:24:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576559408659955764" data-draft-id="7576559408659939380" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot整合Apache Spark实现一个简单的数据分析功能"/> <meta itemprop="keywords" content="后端,Java"/> <meta itemprop="datePublished" content="2025-11-26T06:24:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员西西"/> <meta itemprop="url" content="https://juejin.cn/user/326976944214804"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot整合Apache Spark实现一个简单的数据分析功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/326976944214804/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员西西
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T06:24:41.000Z" title="Wed Nov 26 2025 06:24:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>ApacheSpark是一个开源的大数据处理框架，它提供了丰富的功能和API，用于分布式数据处理、数据分析和机器学习等任务。在SpringBoot中整合ApacheSpark可以实现更加灵活和高效的数据分析应用。下面我们就来看看如何在SpringBoot应用中整合ApacheSpark。</p>
<h2 data-id="heading-0">第一步、添加依赖</h2>
<p>由于需要用到Apache Spark数据处理相关的功能，所以需要引入Spark的SQL依赖，如下所示。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.spark<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spark-sql_2.12<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h2 data-id="heading-1">第二步、编写配置类</h2>
<p>在SpringBoot项目中创建SparkConfig配置类并且添加SparkSession的依赖Bean。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SparkConfig</span> {
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> SparkSession sparkSession() {
        <span class="hljs-keyword">return</span> SparkSession.builder()
                .appName(<span class="hljs-string">"SpringBootSparkIntegration"</span>)
                .master(<span class="hljs-string">"local[*]"</span>) <span class="hljs-comment">// 在本地模式下运行</span>
                .getOrCreate();
    }
}
</code></pre>
<h2 data-id="heading-2">第三步、编写控制类</h2>
<p>创建一个Controller类，用于处理请求并调用ApacheSpark进行数据分析</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/test"</span>)
public class TestController {


    <span class="hljs-variable">@Autowired</span>
    private SparkSession sparkSession;

    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">"/analyze"</span>)
    public Map&lt;String,Object&gt; <span class="hljs-built_in">test</span>(){
        <span class="hljs-selector-tag">Map</span>&lt;<span class="hljs-selector-tag">String</span>,<span class="hljs-selector-tag">Object</span>&gt; <span class="hljs-selector-tag">ajax</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">HashMap</span>&lt;&gt;();

        <span class="hljs-comment">// 创建 SparkContext</span>
        <span class="hljs-selector-tag">JavaSparkContext</span> <span class="hljs-selector-tag">sparkContext</span> = <span class="hljs-selector-tag">JavaSparkContext</span><span class="hljs-selector-class">.fromSparkContext</span>(sparkSession.<span class="hljs-built_in">sparkContext</span>());

        <span class="hljs-comment">// 创建一个 RDD</span>
        <span class="hljs-selector-tag">JavaRDD</span>&lt;<span class="hljs-selector-tag">Integer</span>&gt; <span class="hljs-selector-tag">dataRDD</span> = <span class="hljs-selector-tag">sparkContext</span><span class="hljs-selector-class">.parallelize</span>(Arrays.<span class="hljs-built_in">asList</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>));

        <span class="hljs-comment">// 执行一些数据分析操作</span>
        <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">count</span> = <span class="hljs-selector-tag">dataRDD</span><span class="hljs-selector-class">.count</span>();

        <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">Person</span>&gt; <span class="hljs-selector-tag">personList</span> = <span class="hljs-selector-tag">Arrays</span><span class="hljs-selector-class">.asList</span>(new <span class="hljs-built_in">Person</span>(<span class="hljs-string">"Alice"</span>, <span class="hljs-number">30</span>), new <span class="hljs-built_in">Person</span>(<span class="hljs-string">"Bob"</span>, <span class="hljs-number">25</span>));
        <span class="hljs-comment">// 创建一个 Dataset</span>
        <span class="hljs-selector-tag">Dataset</span>&lt;<span class="hljs-selector-tag">Row</span>&gt; <span class="hljs-selector-tag">dataset</span> = <span class="hljs-selector-tag">sparkSession</span><span class="hljs-selector-class">.createDataFrame</span>(personList, Person.class);

        <span class="hljs-comment">// 执行一些 SQL 查询</span>
        <span class="hljs-selector-tag">dataset</span><span class="hljs-selector-class">.createOrReplaceTempView</span>(<span class="hljs-string">"people"</span>);

        <span class="hljs-selector-tag">Dataset</span>&lt;<span class="hljs-selector-tag">Row</span>&gt; <span class="hljs-selector-tag">result</span> = <span class="hljs-selector-tag">sparkSession</span><span class="hljs-selector-class">.sql</span>(<span class="hljs-string">"SELECT * FROM people"</span>);
        <span class="hljs-selector-tag">ajax</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"data"</span>,count);
        <span class="hljs-selector-tag">ajax</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"result"</span>,result.<span class="hljs-built_in">collectAsList</span>().<span class="hljs-built_in">get</span>(<span class="hljs-number">0</span>).<span class="hljs-built_in">json</span>());
        <span class="hljs-selector-tag">sparkSession</span><span class="hljs-selector-class">.stop</span>();
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ajax</span>;
    }
}
</code></pre>
<p>Person实体类如下所示。</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> implements Serializable {
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> name;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> age;

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Person</span><span class="hljs-params">()</span> </span>{}

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Person</span><span class="hljs-params">(<span class="hljs-type">String</span> name, <span class="hljs-type">int</span> age)</span> </span>{
        <span class="hljs-keyword">this</span>.name = name;
        <span class="hljs-keyword">this</span>.age = age;
    }

    <span class="hljs-comment">// Getters and setters</span>
}
</code></pre>
<p>这里需要注意，直接引入Apache Spark的时候，在项目启动的时候会报一个HADOOP_HOME不存在的异常。这个异常是可以忽略的，当然如果需要解决的话，就可以到</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73c0539a2a1943f7a6c70de12496f061~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6KW_6KW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764743081&amp;x-signature=wVlWOZrzb2uhtUWMuOMNC4ROXIQ%3D" alt="image.png" loading="lazy"/></p>
<p>添加配置完成之后项目启动就正常了。</p>
<h2 data-id="heading-3">启动项目并测试</h2>
<p>启动SpringBoot应用，并访  <strong>/analyze</strong>路径，即可触发数据分析操作。如下所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/354cd5b234dd4973942f1db012cff9ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP5ZGY6KW_6KW_:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764743081&amp;x-signature=GGOMdmnpqQ%2FIr%2Fqb47CO8h6U8NA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">总结</h2>
<p>到这里，你就可以在SpringBoot应用中使用ApacheSpark进行数据分析了。当然，实际应用中可能会涉及更加复杂的数据处理和分析任务，你可以根据实际需求扩展和优化代码。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[架构火花｜AI时代，架构师的护城河在哪里？]]></title>    <link>https://juejin.cn/post/7576821684250886187</link>    <guid>https://juejin.cn/post/7576821684250886187</guid>    <pubDate>2025-11-26T06:33:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576821684250886187" data-draft-id="7576580177662525450" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="架构火花｜AI时代，架构师的护城河在哪里？"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-11-26T06:33:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="腾讯云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/3456520257538830"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            架构火花｜AI时代，架构师的护城河在哪里？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3456520257538830/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    腾讯云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T06:33:29.000Z" title="Wed Nov 26 2025 06:33:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>提示词只是表象，定义问题的能力才是核心，11 月 4 日，在腾讯云架构师深圳同盟中，一场关于 AI 时代架构师价值的讨论引发深思。当 AI 被比作“博士生”，我们不得不重新思考：在 AI 快速进化的今天，什么才是架构师真正的护城河？</p>
<h2 data-id="heading-1">提示词是新时代的护城河吗？</h2>
<p>“写提示词感觉就像在随机广撒网，无法在写之前就知道结果是否OK。”</p>
<p>“提示词缺乏像SOLID原则那样的通用方法论，每个场景都需要重新摸索。”</p>
<p>“大模型更新后，精心打磨的提示词可能一夜过时……”</p>
<p>许多架构师表达了共同的困惑。而工具使用门槛的降低让一些成员感到价值被稀释——如果AI工具付费VIP账号就能获得超越十年经验的能力，那么传统经验积累的价值何在？</p>
<p>有成员认为提示词未来成本会越来越弱，提示词不会像以前要绞尽脑汁去想。这种趋势出现的原因是：第一，提示词成本不符合ai公司的价值，它一定是服务用户的，是降低人们使用成本(降本增效)，第二，深度思考的出现一定程度上减少你写提示词的数量，他会根据少量提示词自动思考补充。而且写提示词这事，其实有专门的类似提示词专家这样的agent帮你写，基本上是没有任何门槛的，只不过很多一线的员工并不知道，所以通过培训去做引导还是很重要的。</p>
<p>而现在的AI应用越来越多都是垂直领域应用，基座模型经过特定领域知识微调后形成的模型，需要将大量的用户提问作为模板样例或者微调数据，能把意图识别准确率提升到90%+，这些都是应用开发者该做的事情，和基座模型本身迭代的关系越来越小了。所有模型的输出都不可能百分百准确，但领域垂直+提示词引导，这种会大大减少模型的幻觉。关键是，这种方式对 AI 小白来说，提升的效率可不止 10 倍。</p>
<p>有成员提出提示词的好坏和复杂程度关系不大。架构师们要开始转变一个意识：文档即架构。文档能写清楚，那么你问题定义和思路就是清楚的，否则再好的大模型都没有用。提示词是人与大模型沟通的桥梁，写好提示词其实对应的是定义问题的能力。而定义问题的能力还真不是每个人都有的，有些人动手能力强，但把问题描述清楚的能力不一定强。</p>
<h2 data-id="heading-2">超越工具使用的深层能力</h2>
<p>在这场讨论中，几位资深架构师指出了更深层的本质：</p>
<p>随着模型能力提升，提示词可能会变得越来越简单。这种进化意味着架构师需要从技术实现者向问题定义者转型。一位成员引用 Google 早期工程师 George Herrick 的理论：“压缩即理解。”基于大语言文本模型的 next token 预测算法，本质上是对世界知识的压缩和解压。架构师的价值就在于为这种压缩和解压提供正确的主题和方向。</p>
<p>批判性思维不可或缺。对结果的鉴别能力比使用能力更重要。这让人想起在搜索引擎时代，有人连广告和真实结果都分不清。比如下个软件，结果下了一堆不是自己想要的。在AI时代，这种鉴别能力更加关键。</p>
<p>架构思维才是根本。换句更接地气的话说，如果你不知道 SOLID 原则，就无法快速对着一段 AI 产出的代码空谈优化，而设计模式也是一样。用摄影类比，AI将我们的实践成本实现了从胶片到数码相机的提升，但摄影师的构图能力永远不会变。</p>
<p>AI 使用的上限，或者说让其发挥最大效力是取决于使用者的想象力以及使用者的视野、以及高维度的知识储备。在一个潦草的底层设计上”用尽” AI 筑高楼，也远不如掌舵者——也就是前中后期架构师，在基于具体架构模式、结合具体业务场景、机器成本、算法与开销取舍下的每一个动态治理决策。</p>
<h2 data-id="heading-3">如何构建真正的护城河</h2>
<p>架构师该如何去构建真正的护城河？深圳同盟的成员们提出了自己的看法：</p>
<p>方法一：培养垂直领域洞察力。这是一个结合了系统性的知识构建、独特的思维训练和持续的实践应用的过程。它不仅仅是知道更多，更是看得更深、想得更远、连接得更广。</p>
<p>方法二：善用工具，但不依赖工具。有成员分享实际案例：“一个报告，有数据有分析有图表，人工做起来可能得半天时间，AI一分钟搞定。”但关键在于，使用者需要有能力判断结果的可靠性和有效性。</p>
<h2 data-id="heading-4">结语</h2>
<p>AI 时代，毫无疑问的是，只会写代码的工程师价值会越来越低，能理解业务、能借助工具解决复杂问题，把商业需求落地的工程师会更有价值。架构师的护城河不在于掌握了多少工具的使用技巧，而在于精准定义问题的能力、对结果的鉴别能力 、领域知识和架构思维的深度、将商业需求转化为技术方案的能力。</p>
<p>正如深圳同盟社群讨论中形成的共识：“用好大模型，最关键的是定义问题的能力和批判性思维。”在这个 AI 快速发展的时代，这些基础能力反而显得弥足珍贵。毕竟，再强大的 AI，也需要懂得提问的驾驭者来指引方向。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[智能体变笨了是什么原因？ 怎么优化？]]></title>    <link>https://juejin.cn/post/7576689869809287204</link>    <guid>https://juejin.cn/post/7576689869809287204</guid>    <pubDate>2025-11-26T06:21:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576689869809287204" data-draft-id="7576698454924312582" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="智能体变笨了是什么原因？ 怎么优化？"/> <meta itemprop="keywords" content="Agent,程序员,LLM"/> <meta itemprop="datePublished" content="2025-11-26T06:21:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型教程"/> <meta itemprop="url" content="https://juejin.cn/user/1145012233707299"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            智能体变笨了是什么原因？ 怎么优化？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1145012233707299/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型教程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T06:21:10.000Z" title="Wed Nov 26 2025 06:21:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p><strong>“</strong>  大模型应用开发，做出来只是开始，做好才是能力。 <strong>”</strong></p>
<p>昨天在优化完智能体的记忆功能之后，今天做进一步的测试，然后就发现在多轮对话之后智能体好像变笨了；之前能够回答得很好的问题，现在有点失灵了。</p>
<p>因此，既然产生了问题，那么就要想办法解决问题；正如之前的一位同事的口头禅——需求是合理的，那么就可以做。</p>
<h2 data-id="heading-0">智能体优化</h2>
<p>今天测试过程中遇到的问题主要有以下几种现象，随着对话轮数的增多，智能体无法准确识别工具并调用，甚至开始使用自身的知识和历史记录进行回答；并且，无法保证知识来源的准确性。</p>
<p>其次，模型调用工具开始变得不准确，无法准确生成调用参数，导致召回结果为空。</p>
<p>再有，随着对话轮数的增多，模型的回答质量越来越差，在你质问它的时候，它也无法解决问题，并且会持续性犯同样的错误。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/189775042a254d049aaab2af3736fc6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764742870&amp;x-signature=OWee8EXPYeacUYmMfHGlWbL7XTQ%3D" alt="" loading="lazy"/></p>
<p>比如说，在测试的过程中，模型会生成一个明显错误的调用参数，然后你质问它，它会告诉你参数是错的；然后你再问一个同样的问题，它还会用同样的参数。</p>
<p>所以，面对以上这些问题，我们需要想办法去进行优化；但到底应该怎么优化呢？</p>
<p>其实从理论上来说，智能体的优化方案就那几种，最重要的是我们需要找到一个最合适的值。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/171c8938d456439c8241523cb099ef46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764742870&amp;x-signature=zrCa0JKKx7E0i4DPFP%2FH4wt68gE%3D" alt="" loading="lazy"/></p>
<p>智能体的优化方向主要有以下几个环节：</p>
<ul>
<li>上下文长度</li>
<li>历史记录管理</li>
<li>提示词的优化</li>
<li>工具的优化</li>
</ul>
<h2 data-id="heading-1">上下文长度</h2>
<p>上下文长度是影响大模型或者说智能体的稳定性的第一要素，针对不同的环境，不同的模型，不同的上下文窗口，我们需要测试出一个最优的上下文长度，这样才能让智能体尽可能的表现最好。</p>
<h2 data-id="heading-2">历史记录管理</h2>
<p>历史记录管理是控制模型上下文长度的一个重要手段，而且历史记录的质量也会直接影响到智能体的质量。</p>
<p>在历史记录管理中，我们有两种方式控制历史记录的长度，一种是使用固定长度的token，另一种是使用固定的对话次数，一般情况下维持在六到十轮对话最好。</p>
<p>但历史记录会因为不同的问题，不同的回答，影响其长度和对话轮数；如使用订长的token，那么随着回答长度的增多，对话轮数会变少；而如果使用固定轮数的历史记录，那么随着回答的增多，其长度会变大。</p>
<h2 data-id="heading-3">提示词优化</h2>
<p>在提示词中，我们不但要明确告诉模型它的工作职责，还要明确告诉模型有哪些工具，每个工具有什么用，在什么情况下需要调用工具，在什么情况下又可以不调用工具等等一系列问题。</p>
<h2 data-id="heading-4">工具优化</h2>
<p>工具优化分为两个方面，其一是工具的描述，包括功能描述和参数描述；事实上，工具描述从本质上来说，也属于提示词的一部分，因为一个好的工具描述能够明确告诉模型，这个工具有什么用，以及应该怎么用。</p>
<p>其二，是工具中参数验证，比如有些参数可能是枚举类型，这时就需要在描述中把枚举值列举出来；并且对参数进行验证，因为模型虽然会尽可能的按照你的要求生成工具调用参数，但我们无法完全保证其调用参数的准确性。</p>
<p>其次，我们可以在工具中使用一些规则验证和转换，如根据地区查询时，当包含某个关键字或词时，就设置一个默认值；如只要包含浙江，浙江省等就默认是全省。</p>
<p>这样经过以上几种优化方式对智能体进行优化，就能大大提升智能体的质量和稳定性；但具体的效果还需要在不同的环境和业务场景中进行测试。</p>
<p>智能体开发就是一个反复测试，反复实验的过程，这个过程没有捷径。</p>
<h2 data-id="heading-5">学习资源推荐</h2>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一键屏蔽某国IP访问实战]]></title>    <link>https://juejin.cn/post/7576669556150403110</link>    <guid>https://juejin.cn/post/7576669556150403110</guid>    <pubDate>2025-11-26T06:38:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576669556150403110" data-draft-id="7576580177662640138" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一键屏蔽某国IP访问实战"/> <meta itemprop="keywords" content="前端,Node.js,Nginx"/> <meta itemprop="datePublished" content="2025-11-26T06:38:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="洞窝技术"/> <meta itemprop="url" content="https://juejin.cn/user/2538113306470631"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一键屏蔽某国IP访问实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2538113306470631/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    洞窝技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T06:38:20.000Z" title="Wed Nov 26 2025 06:38:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body .octicon{display:inline-block;fill:currentColor;vertical-align:text-bottom}.markdown-body .anchor{float:left;line-height:1;margin-left:-20px;padding-right:4px}.markdown-body .anchor:focus{outline:none}.markdown-body h1 .octicon-link,.markdown-body h2 .octicon-link,.markdown-body h3 .octicon-link,.markdown-body h4 .octicon-link,.markdown-body h5 .octicon-link,.markdown-body h6 .octicon-link{color:#1b1f23;vertical-align:middle;visibility:hidden}.markdown-body h1:hover .anchor,.markdown-body h2:hover .anchor,.markdown-body h3:hover .anchor,.markdown-body h4:hover .anchor,.markdown-body h5:hover .anchor,.markdown-body h6:hover .anchor{text-decoration:none}.markdown-body h1:hover .anchor .octicon-link,.markdown-body h2:hover .anchor .octicon-link,.markdown-body h3:hover .anchor .octicon-link,.markdown-body h4:hover .anchor .octicon-link,.markdown-body h5:hover .anchor .octicon-link,.markdown-body h6:hover .anchor .octicon-link{visibility:visible}.markdown-body h1:hover .anchor .octicon-link:before,.markdown-body h2:hover .anchor .octicon-link:before,.markdown-body h3:hover .anchor .octicon-link:before,.markdown-body h4:hover .anchor .octicon-link:before,.markdown-body h5:hover .anchor .octicon-link:before,.markdown-body h6:hover .anchor .octicon-link:before{width:16px;height:16px;content:" ";display:inline-block;background-image:url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' aria-hidden='true'%3E%3Cpath fill-rule='evenodd' d='M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z'/%3E%3C/svg%3E")}.markdown-body{-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%;color:#24292e;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif,Apple Color Emoji,Segoe UI Emoji;font-size:16px;line-height:1.5;word-wrap:break-word}.markdown-body details{display:block}.markdown-body summary{display:list-item}.markdown-body a{background-color:initial}.markdown-body a:active,.markdown-body a:hover{outline-width:0}.markdown-body strong{font-weight:inherit;font-weight:bolder}.markdown-body h1{margin:.67em 0}.markdown-body img{border-style:none}.markdown-body code,.markdown-body kbd,.markdown-body pre{font-family:monospace,monospace;font-size:1em}.markdown-body hr{box-sizing:initial;overflow:visible}.markdown-body input{font:inherit;margin:0;overflow:visible}.markdown-body [type=checkbox]{box-sizing:border-box;padding:0}.markdown-body *{box-sizing:border-box}.markdown-body input{font-family:inherit;font-size:inherit;line-height:inherit}.markdown-body a{color:#0366d6;text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body strong{font-weight:600}.markdown-body hr{height:0;margin:15px 0;overflow:hidden;background:transparent;border-bottom:1px solid #dfe2e5}.markdown-body hr:after,.markdown-body hr:before{display:table;content:""}.markdown-body hr:after{clear:both}.markdown-body table{border-spacing:0;border-collapse:collapse}.markdown-body td,.markdown-body th{padding:0}.markdown-body details summary{cursor:pointer}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:0;margin-bottom:0}.markdown-body h1{font-size:32px}.markdown-body h1,.markdown-body h2{font-weight:600}.markdown-body h2{font-size:24px}.markdown-body h3{font-size:20px}.markdown-body h3,.markdown-body h4{font-weight:600}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:14px}.markdown-body h5,.markdown-body h6{font-weight:600}.markdown-body h6{font-size:12px}.markdown-body p{margin-top:0;margin-bottom:10px}.markdown-body blockquote{margin:0}.markdown-body ol,.markdown-body ul{padding-left:0;margin-top:0;margin-bottom:0}.markdown-body ol ol,.markdown-body ul ol{list-style-type:lower-roman}.markdown-body ol ol ol,.markdown-body ol ul ol,.markdown-body ul ol ol,.markdown-body ul ul ol{list-style-type:lower-alpha}.markdown-body dd{margin-left:0}.markdown-body code,.markdown-body pre{font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px}.markdown-body pre{margin-top:0;margin-bottom:0}.markdown-body input::-webkit-inner-spin-button,.markdown-body input::-webkit-outer-spin-button{margin:0;-webkit-appearance:none;appearance:none}.markdown-body :checked+.radio-label{position:relative;z-index:1;border-color:#0366d6}.markdown-body .border{border:1px solid #e1e4e8!important}.markdown-body .border-0{border:0!important}.markdown-body .border-bottom{border-bottom:1px solid #e1e4e8!important}.markdown-body .rounded-1{border-radius:3px!important}.markdown-body .bg-white{background-color:#fff!important}.markdown-body .bg-gray-light{background-color:#fafbfc!important}.markdown-body .text-gray-light{color:#6a737d!important}.markdown-body .pl-3,.markdown-body .px-3{padding-left:16px!important}.markdown-body .px-3{padding-right:16px!important}.markdown-body .f6{font-size:12px!important}.markdown-body .lh-condensed{line-height:1.25!important}.markdown-body .text-bold{font-weight:600!important}.markdown-body .pl-c{color:#6a737d}.markdown-body .pl-c1,.markdown-body .pl-s .pl-v{color:#005cc5}.markdown-body .pl-e,.markdown-body .pl-en{color:#6f42c1}.markdown-body .pl-s .pl-s1,.markdown-body .pl-smi{color:#24292e}.markdown-body .pl-ent{color:#22863a}.markdown-body .pl-k{color:#d73a49}.markdown-body .pl-pds,.markdown-body .pl-s,.markdown-body .pl-s .pl-pse .pl-s1,.markdown-body .pl-sr,.markdown-body .pl-sr .pl-cce,.markdown-body .pl-sr .pl-sra,.markdown-body .pl-sr .pl-sre{color:#032f62}.markdown-body .pl-smw,.markdown-body .pl-v{color:#e36209}.markdown-body .pl-bu{color:#b31d28}.markdown-body .pl-ii{color:#fafbfc;background-color:#b31d28}.markdown-body .pl-c2{color:#fafbfc;background-color:#d73a49}.markdown-body .pl-c2:before{content:"^M"}.markdown-body .pl-sr .pl-cce{font-weight:700;color:#22863a}.markdown-body .pl-ml{color:#735c0f}.markdown-body .pl-mh,.markdown-body .pl-mh .pl-en,.markdown-body .pl-ms{font-weight:700;color:#005cc5}.markdown-body .pl-mi{font-style:italic;color:#24292e}.markdown-body .pl-mb{font-weight:700;color:#24292e}.markdown-body .pl-md{color:#b31d28;background-color:#ffeef0}.markdown-body .pl-mi1{color:#22863a;background-color:#f0fff4}.markdown-body .pl-mc{color:#e36209;background-color:#ffebda}.markdown-body .pl-mi2{color:#f6f8fa;background-color:#005cc5}.markdown-body .pl-mdr{font-weight:700;color:#6f42c1}.markdown-body .pl-ba{color:#586069}.markdown-body .pl-sg{color:#959da5}.markdown-body .pl-corl{text-decoration:underline;color:#032f62}.markdown-body .mb-0{margin-bottom:0!important}.markdown-body .my-2{margin-bottom:8px!important;margin-top:8px!important}.markdown-body .pl-0{padding-left:0!important}.markdown-body .py-0{padding-top:0!important;padding-bottom:0!important}.markdown-body .pl-1{padding-left:4px!important}.markdown-body .pl-2{padding-left:8px!important}.markdown-body .py-2{padding-top:8px!important;padding-bottom:8px!important}.markdown-body .pl-3{padding-left:16px!important}.markdown-body .pl-4{padding-left:24px!important}.markdown-body .pl-5{padding-left:32px!important}.markdown-body .pl-6{padding-left:40px!important}.markdown-body .pl-7{padding-left:48px!important}.markdown-body .pl-8{padding-left:64px!important}.markdown-body .pl-9{padding-left:80px!important}.markdown-body .pl-10{padding-left:96px!important}.markdown-body .pl-11{padding-left:112px!important}.markdown-body .pl-12{padding-left:128px!important}.markdown-body hr{border-bottom-color:#eee}.markdown-body kbd{display:inline-block;padding:3px 5px;font:11px SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;line-height:10px;color:#444d56;vertical-align:middle;background-color:#fafbfc;border:1px solid #d1d5da;border-radius:3px;box-shadow:inset 0 -1px 0 #d1d5da}.markdown-body:after,.markdown-body:before{display:table;content:""}.markdown-body:after{clear:both}.markdown-body&gt;:first-child{margin-top:0!important}.markdown-body&gt;:last-child{margin-bottom:0!important}.markdown-body a:not([href]){color:inherit;text-decoration:none}.markdown-body blockquote,.markdown-body details,.markdown-body dl,.markdown-body ol,.markdown-body p,.markdown-body pre,.markdown-body table,.markdown-body ul{margin-top:0;margin-bottom:16px}.markdown-body hr{height:.25em;padding:0;margin:24px 0;background-color:#e1e4e8;border:0}.markdown-body blockquote{padding:0 1em;color:#6a737d;border-left:.25em solid #dfe2e5}.markdown-body blockquote&gt;:first-child{margin-top:0}.markdown-body blockquote&gt;:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin-top:24px;margin-bottom:16px;font-weight:600;line-height:1.25}.markdown-body h1{font-size:2em}.markdown-body h1,.markdown-body h2{padding-bottom:.3em;border-bottom:1px solid #eaecef}.markdown-body h2{font-size:1.5em}.markdown-body h3{font-size:1.25em}.markdown-body h4{font-size:1em}.markdown-body h5{font-size:.875em}.markdown-body h6{font-size:.85em;color:#6a737d}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:0;margin-bottom:0}.markdown-body li{word-wrap:break-all}.markdown-body li&gt;p{margin-top:16px}.markdown-body li+li{margin-top:.25em}.markdown-body dl{padding:0}.markdown-body dl dt{padding:0;margin-top:16px;font-size:1em;font-style:italic;font-weight:600}.markdown-body dl dd{padding:0 16px;margin-bottom:16px}.markdown-body table{display:block;width:100%;overflow:auto}.markdown-body table th{font-weight:600}.markdown-body table td,.markdown-body table th{padding:6px 13px;border:1px solid #dfe2e5}.markdown-body table tr{background-color:#fff;border-top:1px solid #c6cbd1}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}.markdown-body img{max-width:100%;box-sizing:initial;background-color:#fff}.markdown-body img[align=right]{padding-left:20px}.markdown-body img[align=left]{padding-right:20px}.markdown-body code{padding:.2em .4em;margin:0;font-size:85%;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body pre{word-wrap:normal}.markdown-body pre&gt;code{padding:0;margin:0;font-size:100%;word-break:normal;white-space:pre;background:transparent;border:0}.markdown-body .highlight{margin-bottom:16px}.markdown-body .highlight pre{margin-bottom:0;word-break:normal}.markdown-body .highlight pre,.markdown-body pre{padding:16px;overflow:auto;font-size:85%;line-height:1.45;background-color:#f6f8fa;border-radius:3px}.markdown-body pre code{display:inline;max-width:auto;padding:0;margin:0;overflow:visible;line-height:inherit;word-wrap:normal;background-color:initial;border:0}.markdown-body .commit-tease-sha{display:inline-block;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:90%;color:#444d56}.markdown-body .full-commit .btn-outline:not(:disabled):hover{color:#005cc5;border-color:#005cc5}.markdown-body .blob-wrapper{overflow-x:auto;overflow-y:hidden}.markdown-body .blob-wrapper-embedded{max-height:240px;overflow-y:auto}.markdown-body .blob-num{width:1%;min-width:50px;padding-right:10px;padding-left:10px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;line-height:20px;color:rgba(27,31,35,.3);text-align:right;white-space:nowrap;vertical-align:top;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}.markdown-body .blob-num:hover{color:rgba(27,31,35,.6)}.markdown-body .blob-num:before{content:attr(data-line-number)}.markdown-body .blob-code{position:relative;padding-right:10px;padding-left:10px;line-height:20px;vertical-align:top}.markdown-body .blob-code-inner{overflow:visible;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:12px;color:#24292e;word-wrap:normal;white-space:pre}.markdown-body .pl-token.active,.markdown-body .pl-token:hover{cursor:pointer;background:#ffea7f}.markdown-body .tab-size[data-tab-size="1"]{-moz-tab-size:1;tab-size:1}.markdown-body .tab-size[data-tab-size="2"]{-moz-tab-size:2;tab-size:2}.markdown-body .tab-size[data-tab-size="3"]{-moz-tab-size:3;tab-size:3}.markdown-body .tab-size[data-tab-size="4"]{-moz-tab-size:4;tab-size:4}.markdown-body .tab-size[data-tab-size="5"]{-moz-tab-size:5;tab-size:5}.markdown-body .tab-size[data-tab-size="6"]{-moz-tab-size:6;tab-size:6}.markdown-body .tab-size[data-tab-size="7"]{-moz-tab-size:7;tab-size:7}.markdown-body .tab-size[data-tab-size="8"]{-moz-tab-size:8;tab-size:8}.markdown-body .tab-size[data-tab-size="9"]{-moz-tab-size:9;tab-size:9}.markdown-body .tab-size[data-tab-size="10"]{-moz-tab-size:10;tab-size:10}.markdown-body .tab-size[data-tab-size="11"]{-moz-tab-size:11;tab-size:11}.markdown-body .tab-size[data-tab-size="12"]{-moz-tab-size:12;tab-size:12}.markdown-body .task-list-item{list-style-type:none}.markdown-body .task-list-item+.task-list-item{margin-top:3px}.markdown-body .task-list-item input{margin:0 .2em .25em -1.6em;vertical-align:middle}</style><style data-highlight="" data-highlight-key="github">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c801015fd006484384445c9421b6ec01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rSe56qd5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764743900&amp;x-signature=HHfRRlcEraGFkMLaaiCsPUZPHTA%3D" alt="logo.png" loading="lazy"/>
在网站运营、网络安全或流量管控场景中，按国家/地区限制IP访问（如仅允许国内IP访问、屏蔽特定国家IP）是常见需求。实现这一需求的核心步骤是：获取目标国家的IP段 → 将IP段配置到 Nginx 中生效。本文将详细讲解如何通过Node.js或Shell脚本获取国家IP段，并结合 Nginx 的geo模块完成配置。</p>
<h2 data-id="heading-0">一、选择 IP 数据源</h2>
<p>获取国家 IP 段的前提是选择可靠的数据源，目前主流免费/商用数据源包括：</p>
<h3 data-id="heading-1">1. MaxMind GeoLite2</h3>
<p>MaxMind 是全球知名的 IP 地理信息服务商，提供免费的 GeoLite2 数据库（需注册账号），包含 IPv4/IPv6 的国家 / 地区映射，数据精度高且更新及时（每月更新）。</p>
<h3 data-id="heading-2">2. apnic</h3>
<p>apnic提供免费可直接获取的IP信息，直接下载就能获取最新的IP数据信息。</p>
<h3 data-id="heading-3">3. 其他</h3>
<ul>
<li>ip2region：国内开源的 IP 定位库，支持国家 / 城市级映射，数据文件小（约 10MB），查询速度快。</li>
<li>17monip（纯真 IP）：国内常用的 IP 库，需定期下载更新包。</li>
<li>IP2Location LITE：类似 GeoLite2 的免费数据库，提供 CSV/MMDB 格式。</li>
</ul>
<p>本文以apnic为例讲解（兼容性和易用性最优）。</p>
<h2 data-id="heading-4">二、获取国家 IP 段的方法</h2>
<h3 data-id="heading-5">方法 1：使用bash脚本获取并处理</h3>
<p>这种方式适合linux系统下的简单使用，兼容centos、ubuntu等系统。</p>
<h4 data-id="heading-6">步骤一：获取数据</h4>
<p>可以使用<code>wget</code>或者<code>curl</code>这种命令直接从远程下载脚本，脚本地址取最新数据<code>http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest</code>，脚本内容类似：</p>
<pre><code class="hljs language-bash" lang="bash">wget -c -O /tmp http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest

curl -C - -o /tmp http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest
</code></pre>
<h3 data-id="heading-7">步骤二：处理数据</h3>
<p>官方提供的数据通常都是txt格式的，逐行进行排列的数据。我们要使用还需要对数据进行解析，把我们需要的数据单独获取出来。可以使用脚本的<code>awk</code>命令进行处理。</p>
<p><code>awk</code>的命令格式:</p>
<pre><code class="hljs language-bash" lang="bash">awk [参数] [处理内容] [操作对象]
</code></pre>
<h3 data-id="heading-8">完整脚本</h3>
<p>我们假设要把数据处理成“起始IP|数量/前缀长度|注册机构|国家代码”的格式，按照这个逻辑，再加上错误处理，我们输出以下脚本：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-built_in">set</span> -eu  <span class="hljs-comment"># 移除 pipefail，兼容低版本 Bash，保留关键错误检查</span>

<span class="hljs-comment"># 脚本配置</span>
URL=<span class="hljs-string">"http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest"</span>
DOWNLOAD_DIR=<span class="hljs-string">"/root/apnic"</span>
DOWNLOAD_FILENAME=<span class="hljs-string">"delegated-apnic-latest"</span>
IPV4_OUTPUT_FILENAME=<span class="hljs-string">"apnic_ipv4.txt"</span>
IPV6_OUTPUT_FILENAME=<span class="hljs-string">"apnic_ipv6.txt"</span>

<span class="hljs-comment"># 帮助信息</span>
<span class="hljs-function"><span class="hljs-title">show_help</span></span>() {
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"用法：<span class="hljs-variable">$0</span> --download-dir &lt;下载目录&gt; [--temp-dir &lt;临时目录&gt;]"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"选项："</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  --download-dir  可选，文件下载保存目录"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"  -h/--help       显示帮助信息"</span>
}

<span class="hljs-comment"># 解析命令行参数</span>
<span class="hljs-function"><span class="hljs-title">parse_args</span></span>() {

    <span class="hljs-keyword">while</span> [[ <span class="hljs-variable">$#</span> -gt 0 ]]; <span class="hljs-keyword">do</span>
        <span class="hljs-keyword">case</span> <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> <span class="hljs-keyword">in</span>
            --download-dir)
                DOWNLOAD_DIR=<span class="hljs-string">"<span class="hljs-variable">$2</span>"</span>
                <span class="hljs-built_in">shift</span> 2
                ;;
            -h|--<span class="hljs-built_in">help</span>)
                show_help
                <span class="hljs-built_in">exit</span> 0
                ;;
            *)
                <span class="hljs-built_in">echo</span> <span class="hljs-string">"错误：未知参数 <span class="hljs-variable">$1</span>"</span>
                show_help
                <span class="hljs-built_in">exit</span> 1
                ;;
        <span class="hljs-keyword">esac</span>
    <span class="hljs-keyword">done</span>
}

<span class="hljs-comment"># 检查依赖工具（wget 或 curl）</span>
<span class="hljs-function"><span class="hljs-title">check_dependencies</span></span>() {
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">command</span> -v wget &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
        DOWNLOAD_TOOL=<span class="hljs-string">"wget"</span>
    <span class="hljs-keyword">elif</span> <span class="hljs-built_in">command</span> -v curl &amp;&gt; /dev/null; <span class="hljs-keyword">then</span>
        DOWNLOAD_TOOL=<span class="hljs-string">"curl"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"错误：未找到 wget 或 curl，请先安装其中一个工具"</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>
}

<span class="hljs-comment"># 下载文件 + 校验文件有效性</span>
<span class="hljs-function"><span class="hljs-title">download_file</span></span>() {
    <span class="hljs-built_in">local</span> download_path=<span class="hljs-string">"<span class="hljs-variable">${DOWNLOAD_DIR}</span>/<span class="hljs-variable">${DOWNLOAD_FILENAME}</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"=== 开始下载文件 ==="</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"URL: <span class="hljs-variable">$URL</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"保存路径: <span class="hljs-variable">$download_path</span>"</span>

    <span class="hljs-comment"># 检查下载目录是否存在</span>
    <span class="hljs-keyword">if</span> [[ ! -d <span class="hljs-string">"<span class="hljs-variable">$DOWNLOAD_DIR</span>"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">mkdir</span> -p <span class="hljs-string">"<span class="hljs-variable">$DOWNLOAD_DIR</span>"</span> || {
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"错误：无法创建保持目录 <span class="hljs-variable">$DOWNLOAD_DIR</span>"</span>
            <span class="hljs-built_in">exit</span> 1
        }
    <span class="hljs-keyword">fi</span>

    <span class="hljs-comment"># 下载文件（支持断点续传）</span>
    <span class="hljs-keyword">if</span> [[ <span class="hljs-string">"<span class="hljs-variable">$DOWNLOAD_TOOL</span>"</span> == <span class="hljs-string">"wget"</span> ]]; <span class="hljs-keyword">then</span>
        wget -c -O <span class="hljs-string">"<span class="hljs-variable">$download_path</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$URL</span>"</span> || {
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"错误：wget 下载失败（可能是网络问题或服务器异常）"</span>
            <span class="hljs-built_in">exit</span> 1
        }
    <span class="hljs-keyword">else</span>
        curl -C - -o <span class="hljs-string">"<span class="hljs-variable">$download_path</span>"</span> <span class="hljs-string">"<span class="hljs-variable">$URL</span>"</span> || {
            <span class="hljs-built_in">echo</span> <span class="hljs-string">"错误：curl 下载失败（可能是网络问题或服务器异常）"</span>
            <span class="hljs-built_in">exit</span> 1
        }
    <span class="hljs-keyword">fi</span>

    <span class="hljs-comment"># 校验下载文件是否为空</span>
    <span class="hljs-keyword">if</span> [[ ! -s <span class="hljs-string">"<span class="hljs-variable">$download_path</span>"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"错误：下载的文件为空，请检查 URL 或网络连接"</span>
        <span class="hljs-built_in">rm</span> -f <span class="hljs-string">"<span class="hljs-variable">$download_path</span>"</span>  <span class="hljs-comment"># 删除空文件</span>
        <span class="hljs-built_in">exit</span> 1
    <span class="hljs-keyword">fi</span>

    <span class="hljs-built_in">echo</span> <span class="hljs-string">"=== 文件下载完成（大小：<span class="hljs-subst">$(du -sh <span class="hljs-string">"<span class="hljs-variable">$download_path</span>"</span> | awk '{print $1}')</span>）==="</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"下载文件路径: <span class="hljs-variable">$download_path</span>"</span>
    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">return</span> 0
}

<span class="hljs-comment"># 解析并筛选 IPv4/IPv6（容错增强）</span>
<span class="hljs-function"><span class="hljs-title">parse_and_filter_ip</span></span>() {
    <span class="hljs-built_in">local</span> download_path=<span class="hljs-string">"<span class="hljs-variable">${DOWNLOAD_DIR}</span>/<span class="hljs-variable">${DOWNLOAD_FILENAME}</span>"</span>
    <span class="hljs-built_in">local</span> ipv4_output=<span class="hljs-string">"<span class="hljs-variable">${DOWNLOAD_DIR}</span>/<span class="hljs-variable">${IPV4_OUTPUT_FILENAME}</span>"</span>
    <span class="hljs-built_in">local</span> ipv6_output=<span class="hljs-string">"<span class="hljs-variable">${DOWNLOAD_DIR}</span>/<span class="hljs-variable">${IPV6_OUTPUT_FILENAME}</span>"</span>

    <span class="hljs-built_in">echo</span> <span class="hljs-string">"=== 开始解析文件 ==="</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"源文件: <span class="hljs-variable">$download_path</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"解析目录: <span class="hljs-variable">$DOWNLOAD_DIR</span>"</span>

    <span class="hljs-comment"># 清空输出文件（避免残留旧数据）</span>
    &gt; <span class="hljs-string">"<span class="hljs-variable">$ipv4_output</span>"</span>
    &gt; <span class="hljs-string">"<span class="hljs-variable">$ipv6_output</span>"</span>

    <span class="hljs-comment"># 筛选规则：</span>
    <span class="hljs-comment"># 1. 跳过注释行（以 # 开头）和空行</span>
    <span class="hljs-comment"># 2. 第 3 列（type）为 ipv4/ipv6 的行</span>
    <span class="hljs-comment"># 3. 输出格式：起始IP|数量/前缀长度|注册机构|国家代码（字段 4|5|1|2）</span>
    <span class="hljs-comment"># 用 awk 处理，即使部分行格式异常也不中断</span>
    awk -F <span class="hljs-string">'|'</span> <span class="hljs-string">'
        !/^#/ &amp;&amp; NF &gt;= 6 {  # 只处理非注释行且字段数≥6的行
            if ($3 == "ipv4") {
                print $4 "|" $5 "|" $1 "|" $2 &gt;&gt; "'</span><span class="hljs-string">"<span class="hljs-variable">$ipv4_output</span>"</span><span class="hljs-string">'"
            } else if ($3 == "ipv6") {
                print $4 "|" $5 "|" $1 "|" $2 &gt;&gt; "'</span><span class="hljs-string">"<span class="hljs-variable">$ipv6_output</span>"</span><span class="hljs-string">'"
            }
        }
    '</span> <span class="hljs-string">"<span class="hljs-variable">$download_path</span>"</span> || {
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"警告：部分行格式异常，已跳过"</span>
    }

    <span class="hljs-comment"># 检查筛选结果（允许其中一种IP类型为空，避免误判）</span>
    <span class="hljs-keyword">if</span> [[ -s <span class="hljs-string">"<span class="hljs-variable">$ipv4_output</span>"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"IPv4 筛选完成，记录数：<span class="hljs-subst">$(wc -l &lt; <span class="hljs-string">"<span class="hljs-variable">$ipv4_output</span>"</span>)</span> 行"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"警告：未筛选到 IPv4 数据（可能文件格式变更或无相关记录）"</span>
    <span class="hljs-keyword">fi</span>

    <span class="hljs-keyword">if</span> [[ -s <span class="hljs-string">"<span class="hljs-variable">$ipv6_output</span>"</span> ]]; <span class="hljs-keyword">then</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"IPv6 筛选完成，记录数：<span class="hljs-subst">$(wc -l &lt; <span class="hljs-string">"<span class="hljs-variable">$ipv6_output</span>"</span>)</span> 行"</span>
    <span class="hljs-keyword">else</span>
        <span class="hljs-built_in">echo</span> <span class="hljs-string">"警告：未筛选到 IPv6 数据（可能文件格式变更或无相关记录）"</span>
    <span class="hljs-keyword">fi</span>

    <span class="hljs-built_in">echo</span> <span class="hljs-string">"=== 解析筛选完成 ==="</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"IPv4 文件路径: <span class="hljs-variable">$ipv4_output</span>"</span>
    <span class="hljs-built_in">echo</span> <span class="hljs-string">"IPv6 文件路径: <span class="hljs-variable">$ipv6_output</span>"</span>
    <span class="hljs-built_in">echo</span>
    <span class="hljs-built_in">return</span> 0
}

<span class="hljs-comment"># 主流程</span>
<span class="hljs-function"><span class="hljs-title">main</span></span>() {
    parse_args <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
    check_dependencies
    download_file
    parse_and_filter_ip

    <span class="hljs-built_in">echo</span> <span class="hljs-string">"=== 任务全部完成 ==="</span>
}

<span class="hljs-comment"># 启动脚本</span>
main <span class="hljs-string">"<span class="hljs-variable">$@</span>"</span>
</code></pre>
<p>脚本首先设置默认变量，也就是默认的存储位置是<code>/root/apnic</code>，然后再把最新数据下载到文件里，通过命令筛选我们需要的数据分别存到对应的文件中。</p>
<h3 data-id="heading-9">方法 2：Node.js处理数据</h3>
<p>使用nodejs整体流程设计上就不需要临时存储文件了，我们直接每次获取之后在内存中就全部处理完成。整体处理如下：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> axios = <span class="hljs-built_in">require</span>(<span class="hljs-string">'axios'</span>);
<span class="hljs-comment">// 要允许通过的国家</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">ALLowList</span> = [<span class="hljs-string">'CN'</span>, <span class="hljs-string">'HK'</span>, <span class="hljs-string">'MO'</span>, <span class="hljs-string">'TW'</span>];

<span class="hljs-comment">// 获取远程数据</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getApnicTxt</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> axios.<span class="hljs-title function_">get</span>(<span class="hljs-string">'http://ftp.apnic.net/apnic/stats/apnic/delegated-apnic-latest'</span>);
    <span class="hljs-keyword">return</span> res.<span class="hljs-property">data</span>;
}

<span class="hljs-comment">// apnic|BD|ipv4|103.132.248.0|1024|20190116|allocated</span>
<span class="hljs-comment">// apnic|ID|ipv6|2001:df0:f180::|48|20190718|assigned</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">createIpRecord</span>(<span class="hljs-params">line, dot = <span class="hljs-string">'24'</span></span>) {
    <span class="hljs-keyword">const</span> parts = line.<span class="hljs-title function_">split</span>(<span class="hljs-string">'|'</span>);
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">ALLowList</span>.<span class="hljs-title function_">includes</span>(parts[<span class="hljs-number">1</span>])) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">`allow <span class="hljs-subst">${parts[<span class="hljs-number">3</span>]}</span>/<span class="hljs-subst">${dot}</span>; #<span class="hljs-subst">${parts[<span class="hljs-number">1</span>]}</span>`</span>;
    }
    <span class="hljs-keyword">return</span> <span class="hljs-string">`deny <span class="hljs-subst">${parts[<span class="hljs-number">3</span>]}</span>/<span class="hljs-subst">${dot}</span>; #<span class="hljs-subst">${parts[<span class="hljs-number">1</span>]}</span>`</span>;
}

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> txts = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getApnicTxt</span>();
    <span class="hljs-keyword">const</span> list = txts.<span class="hljs-title function_">split</span>(<span class="hljs-string">'\n'</span>);
    <span class="hljs-keyword">const</span> ipv4list = [];
    <span class="hljs-keyword">const</span> ipv6list = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>; index &lt; list.<span class="hljs-property">length</span>; index++) {
        <span class="hljs-keyword">const</span> txt = list[index];
        <span class="hljs-keyword">if</span> (txt.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'|ipv4|'</span>)) {
            ipv4list.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">createIpRecord</span>(txt));
        }
        <span class="hljs-keyword">if</span> (txt.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'|ipv6|'</span>)) {
            ipv6list.<span class="hljs-title function_">push</span>(<span class="hljs-title function_">createIpRecord</span>(txt, <span class="hljs-string">'32'</span>));
        }
    }
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'ipv4list'</span>, ipv4list);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'ipv4list'</span>, ipv6list);
}

<span class="hljs-title function_">main</span>();
</code></pre>
<p>脚本中同样是先获取最新的数据，然后直接交给处理函数进行分批处理。这里我们假设处理的结果是给nginx使用的，所以我们直接在结构上增加<code>allow</code>和<code>deny</code>前缀，方便在nginx中直接使用。</p>
<h2 data-id="heading-10">三、配置nginx文件</h2>
<h3 data-id="heading-11">方法1：使用<code>allow</code>进行管理</h3>
<p>这种配置方式兼容新老版本的nginx，只需要在nginx中提前引入配置文件，每次更新配置文件内容之后重启nginx就能达到自动允许和拒绝来源国家的访问地址。</p>
<pre><code class="hljs language-nginx" lang="nginx">server {
    listen 80;
    listen [::]:80;
    server_name your-domain.com;

    # 引入允许的IP白名单
    include /etc/nginx/conf.d/china-ipv4.conf;
    include /etc/nginx/conf.d/china-ipv6.conf;

    # 可选：放行本地回环（避免自己被拦）
    allow 127.0.0.1;
    allow ::1;

    # 拒绝所有未匹配的请求
    deny all;

    location / {
        root /var/www/html;
        index index.html;
        # 你的其他配置...
    }
}
</code></pre>
<p>通过以上配置就可以达到只允许我们需要的访问，其他国家访问一律禁止。</p>
<h3 data-id="heading-12">方法2：使用geo模块</h3>
<p>Nginx 通过geo模块（默认编译）实现 IP 段的快速匹配，该模块将 IP 段加载到内存中，查询效率极高（不受 IP 段数量影响）。</p>
<pre><code class="hljs language-nginx" lang="nginx">http {
    # 定义IPv4的国家匹配变量（$is_cn_v4：1=中国IP，0=非中国IP）
    geo $is_cn_v4 {
        default 0;
        include /etc/nginx/conf.d/cn-ipv4.conf;  # 引入中国IPv4段文件
    }

    # 定义IPv6的国家匹配变量（如需支持IPv6）
    geo $is_cn_v6 {
        default 0;
        include /etc/nginx/conf.d/cn-ipv6.conf;  # 引入中国IPv6段文件
    }

    # 合并IPv4/IPv6的匹配结果
    map $scheme $is_cn {
        http $is_cn_v4;
        https $is_cn_v4;
        httpv6 $is_cn_v6;
        httpsv6 $is_cn_v6;
    }

    server {
      listen 80;
      listen [::]:80;
      server_name yourdomain.com;

      # 非中国IP返回403
      if ($is_cn != 1) {
          return 403;
      }

      # 正常业务配置...
      location / {
          root /var/www/html;
          index index.html;
      }
  }
}
</code></pre>
<p>通过使用nginx的geo模块可以非常快速的识别到ip对应的国家，然后在具体的路由中通过自动一判断来返回自己想要返回的内容。同样的，配置文件更新之后要重新启动nginx服务。</p>
<h3 data-id="heading-13">其他命令</h3>
<p>检查nginx配置文件是否正确。</p>
<pre><code class="hljs">nginx -t
</code></pre>
<p>重新启动nginx。</p>
<pre><code class="hljs">systemctl restart nginx
</code></pre>
<p>严重IP匹配的效果。</p>
<pre><code class="hljs language-bash" lang="bash">curl -H <span class="hljs-string">"X-Forwarded-For: 8.8.8.8"</span> http://yourdomain.com  <span class="hljs-comment"># 8.8.8.8为美国IP</span>
</code></pre>
<h2 data-id="heading-14">四、注意事项</h2>
<p>在具体的使用过程中还有一些是需要特别注意的：</p>
<ol>
<li>geo和allow的配置文件格式是不一样的。</li>
<li>如果使用云服务做转发，来源ip是云服务的地址，需要额外增加IP透传的功能。</li>
<li>远程地址的更新没那么快，可以设置每隔一周来定时更新一次。持续访问可能会被官方封禁哦。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TVP首场香港活动重磅启幕，AI出海变革风向如何把握？]]></title>    <link>https://juejin.cn/post/7576698454924558342</link>    <guid>https://juejin.cn/post/7576698454924558342</guid>    <pubDate>2025-11-26T06:45:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576698454924558342" data-draft-id="7576821684250935339" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TVP首场香港活动重磅启幕，AI出海变革风向如何把握？"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-26T06:45:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="腾讯云开发者"/> <meta itemprop="url" content="https://juejin.cn/user/3456520257538830"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TVP首场香港活动重磅启幕，AI出海变革风向如何把握？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3456520257538830/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    腾讯云开发者
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T06:45:10.000Z" title="Wed Nov 26 2025 06:45:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>引言</strong></h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d3f055d691a4f4498b7d4dd9dbd9473~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764744310&amp;x-signature=Vt7j%2BzGHolKBLC6reBg300LjOpg%3D" alt="" loading="lazy"/></p>
<p>全球化与数字技术深度融合背景下，AI 已从辅助工具升级为变革核心引擎，深度渗透千行百业，更是粤港澳大湾区企业数字化转型的关键支点。作为中国开放度与经济活力顶尖的区域，大湾区正处数字化转型关键节点，香港则凭国际枢纽优势成为其链接全球的核心接口。AI 不仅能优化本地生产流程，更能助力企业精准匹配海外市场需求、高效适配本地化运营，其赋能的跨境供应链协同、本地化研发，正成为大湾区企业依托香港布局全球的核心抓手，推动区域产业升级。</p>
<p>然而，企业拥抱 AI 驱动的全球化浪潮时，新的挑战也接踵而至。AI 如何与产业深度融合，释放全球化价值？AI 当前核心进展与未来趋势如何，落地案例带来哪些启示？又该如何凝聚多方力量、构建高效协同的产业生态？破解这些行业共性问题，是沉淀出海方法论的关键，更是大湾区企业实现高质量出海的核心所在。</p>
<p><strong>11 月 26 日（周三）</strong> ，TVP 首场香港活动即将重磅启幕！本次 <strong>「腾讯云 TVP 思享会」</strong> 特邀粤港澳大湾区领军企业、携手 AI 领域顶尖专家学者，围绕 “AI 领航 智汇出海” 展开深度对话，共探 AI 赋能企业出海新路径，推动大湾区数字化转型与跨境发展提质增效。</p>
<h2 data-id="heading-1"><strong>活动介绍</strong></h2>
<p><strong>「AI 领航·智汇出海 | 腾讯云 TVP 思享会 大湾区数字化转型高管沙龙」</strong> 由腾讯云 TVP、CIO 时代、新基建创新研究院联合主办， 邀请到多位香港标杆企业、学术领袖与 AI 技术大咖，从香港国际枢纽优势到 AI 驱动的跨境破局，从本地化适配到全球市场攻坚，带来一场聚焦粤港澳大湾区产业升级的思想碰撞。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/500102e6dc87427cb89322f0e7f15d47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IW-6K6v5LqR5byA5Y-R6ICF:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764744310&amp;x-signature=Nk6HEUv8Wc4U1oLuCTbaXRFbov0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2"><strong>结语</strong></h2>
<p>本次腾讯云 TVP 思享会是腾讯云 TVP 系列活动首次走进香港，旨在通过多视角的话题与多形式的交流，串联不同行业与领域专家。希望通过本次沙龙，携手产业界与学术界领袖，共同探寻粤港澳大湾区高质量出海的多元可能与实践方向。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[都React 19了,他到底带来了什么?]]></title>    <link>https://juejin.cn/post/7576559408660234292</link>    <guid>https://juejin.cn/post/7576559408660234292</guid>    <pubDate>2025-11-26T06:50:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576559408660234292" data-draft-id="7576559408660152372" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="都React 19了,他到底带来了什么?"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-26T06:50:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="周尛先森"/> <meta itemprop="url" content="https://juejin.cn/user/3562073402377933"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            都React 19了,他到底带来了什么?
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3562073402377933/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    周尛先森
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T06:50:42.000Z" title="Wed Nov 26 2025 06:50:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/7c865216d9814d28a29831d6cbc2def2~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp#?w=1920&amp;h=1080&amp;s=225936&amp;e=webp&amp;b=020e37" alt="src=http___pic1.win4000.com_wallpaper_2020-07-22_5f17fe7fe9959.jpg&amp;refer=http___pic1.win4000 (1).webp" loading="lazy"/></p>
<p>如果你还在 React 应用的 <code>useEffect</code>里写 <code>fetch</code>请求，那你就做错了。我们每天都听到这种说法。但我们应该怎么做才对呢？好吧，事实证明，React 团队已经清楚地听到了我们的声音。React 19.2 不仅仅是修补异步问题——它通过 <code>use()</code>、<code>&lt;Suspense&gt;</code>、<code>useTransition()</code>以及现在的 View Transitions，从头重建了异步处理机制。这些基础构建块共同将异步逻辑从一个"必要的麻烦"转变为一流的架构特性。让我带你了解 React 的异步叙事是如何彻底改变的，以及它为什么对你的团队很重要。</p>
<p><strong>旧方式：useEffect + isLoading</strong></p>
<p>让我们从一个展示旧的 <code>useEffect</code>/ <code>fetch</code>组合模式的例子开始：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">ImageViewer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [imageId, setImageId] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>);
  <span class="hljs-keyword">const</span> [imageData, setImageData] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">null</span>);
  <span class="hljs-keyword">const</span> [isPending, setIsPending] = <span class="hljs-title function_">useState</span>(<span class="hljs-literal">false</span>);

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setIsPending</span>(<span class="hljs-literal">true</span>);
    <span class="hljs-title function_">fetchImage</span>(imageId).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
      <span class="hljs-title function_">setImageData</span>(data);
      <span class="hljs-title function_">setIsPending</span>(<span class="hljs-literal">false</span>);
    });
  }, [imageId]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setImageId((id) =&gt; id + 1)}&gt;Next Image<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      {isPending ? <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>Loading...<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span> : }
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>（这里的 <code>fetchImage</code>只是 <code>fetch</code>的一个包装函数，以保持示例简短。）</p>
<p>这个模式确实能用，但你做了很多重复性的工作。例如，你管理了三个状态（<code>imageId</code>, <code>imageData</code>, <code>isPending</code>），而实际上你只是想显示一张图片。加载状态逻辑是手动的，错误处理也常常是事后才考虑。而且很可能，你的代码库中每个异步操作看起来都略有不同。</p>
<p>最糟糕的是，那个 <code>useEffect</code>的依赖数组是个隐患。漏掉一个依赖项，你会得到过时的闭包；包含太多依赖项，又会触发无限循环。这是无数生产环境 bug 的根源。</p>
<p>这并不理想，老实说，用这种代码你能做到的最好程度就是"不搞砸"。而这并不是你想要编写的代码类型。</p>
<p><strong>新的异步基础构建块</strong></p>
<p>React 19.2 给我们提供了一种完全不同的方法。我们不再用 <code>useEffect</code>来管理 Promise，而是直接使用 <code>use()</code>和 <code>&lt;Suspense&gt;</code>来处理 Promise。</p>
<p><strong>核心模式：use() + <code>&lt;Suspense&gt;</code></strong></p>
<p>下面是使用 React 新的 <code>use</code>Hook 和 <code>Suspense</code>组件组合重写的同一个组件：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { use, <span class="hljs-title class_">Suspense</span>, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ImageViewer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [imageId, setImageId] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>);
  <span class="hljs-keyword">const</span> [imageDataPromise, setImageDataPromise] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetchImage</span>(<span class="hljs-number">1</span>));

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleNext</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> nextId = imageId + <span class="hljs-number">1</span>;
    <span class="hljs-title function_">setImageId</span>(nextId);
    <span class="hljs-title function_">setImageDataPromise</span>(<span class="hljs-title function_">fetchImage</span>(nextId));
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleNext}</span>&gt;</span>Next Image<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">ImageSkeleton</span> /&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">Image</span> <span class="hljs-attr">imageDataPromise</span>=<span class="hljs-string">{imageDataPromise}</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Image</span>(<span class="hljs-params">{ imageDataPromise }</span>) {
  <span class="hljs-keyword">const</span> image = <span class="hljs-title function_">use</span>(imageDataPromise);
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>{image.title}<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
      
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>看看这有多简洁。没有 <code>useEffect</code>。没有手动的 <code>isPending</code>状态。父组件中没有条件渲染逻辑。我们存储的是一个 Promise 而不是数据，React 会处理剩下的事情。</p>
<p><strong>但这是如何工作的呢？<code>&lt;Suspense&gt;</code>背后的魔法</strong></p>
<p>当 <code>&lt;Suspense&gt;</code>尝试渲染其子组件时，<code>&lt;Image&gt;</code>组件会调用 <code>use(imageDataPromise)</code>。如果那个 Promise 还没有解决，<code>use()</code>会直接<em>抛出</em>这个 Promise。是的——像抛出异常一样抛出它。</p>
<p>我知道你在想什么："用异常来控制流程？这太奇怪了！"但请听我说，因为这其实非常巧妙。</p>
<p>那个被抛出的 Promise 会向上冒泡穿过组件树，直到被 <code>&lt;Suspense&gt;</code>捕获。<code>&lt;Suspense&gt;</code>于是知道："啊，我的子组件需要从这个 Promise 获取数据。我会显示我的加载状态（fallback），并等待这个 Promise 解决。"</p>
<p>当 Promise 解决后，<code>&lt;Suspense&gt;</code>会重新渲染其子组件，<code>use()</code>返回数据，图片就显示出来了。</p>
<p>这消除了在组件树的每个层级进行条件渲染的需要。加载状态变得声明式，因为你可以用 <code>&lt;Suspense&gt;</code>包装异步组件，并定义在加载时显示什么。React 会处理时机。</p>
<p><strong>更流畅的交互：useTransition() + action</strong></p>
<p>但我们可以让它变得更好。目前，当你点击 "Next Image" 时，按钮在新图片加载期间仍然可点击。这不是很好的用户体验；用户可能会多次点击，造成竞态条件。React 19.2 引入了 action props 和 <code>useTransition()</code>来优雅地处理这种情况：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Button</span>(<span class="hljs-params">{ action, children }</span>) {
  <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">onClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">startTransition</span>(<span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">action</span>();
    });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClick}</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">{isPending}</span>&gt;</span>
      {children}
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ImageViewer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [imageId, setImageId] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>);
  <span class="hljs-keyword">const</span> [imageDataPromise, setImageDataPromise] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetchImage</span>(<span class="hljs-number">1</span>));

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleNext</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> nextId = imageId + <span class="hljs-number">1</span>;
    <span class="hljs-title function_">setImageId</span>(nextId);
    <span class="hljs-title function_">setImageDataPromise</span>(<span class="hljs-title function_">fetchImage</span>(nextId));
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">action</span>=<span class="hljs-string">{handleNext}</span>&gt;</span>Next Image<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">ImageSkeleton</span> /&gt;</span>}&gt;
        <span class="hljs-tag">&lt;<span class="hljs-name">Image</span> <span class="hljs-attr">imageDataPromise</span>=<span class="hljs-string">{imageDataPromise}</span> /&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>名为 <code>action</code>的 prop 本身并没有什么特别之处。它只是一个约定，告诉其他开发者这个按钮会将处理器包装在一个过渡（transition）中。</p>
<p><strong>View Transitions：GPU 加速的润色</strong></p>
<p>既然我们谈到了异步的 UI 部分，让我们聊聊 View Transitions。React 19.2（在实验性分支上）添加了对浏览器原生 View Transitions API 的支持。这让你在异步内容加载时能获得如黄油般顺滑的、GPU 加速的动画。而且只需要几行代码。</p>
<p>首先，添加一些 CSS 动画：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-keyword">@keyframes</span> fadeIn {
  <span class="hljs-selector-tag">from</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>; }
  <span class="hljs-selector-tag">to</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>; }
}
<span class="hljs-keyword">@keyframes</span> fadeOut {
  <span class="hljs-selector-tag">from</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>; }
  <span class="hljs-selector-tag">to</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0</span>; }
}
<span class="hljs-keyword">@keyframes</span> pulse {
  <span class="hljs-number">0%</span>, <span class="hljs-number">100%</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">1</span>; }
  <span class="hljs-number">50%</span> { <span class="hljs-attribute">opacity</span>: <span class="hljs-number">0.5</span>; }
}

::<span class="hljs-built_in">view-transition-old</span>(image-container) {
  <span class="hljs-attribute">animation</span>: fadeOut <span class="hljs-number">0.3s</span> ease-out;
}
::<span class="hljs-built_in">view-transition-new</span>(image-container) {
  <span class="hljs-attribute">animation</span>: fadeIn <span class="hljs-number">0.3s</span> ease-in;
}
::<span class="hljs-built_in">view-transition-old</span>(button-pulse) {
  <span class="hljs-attribute">animation</span>: pulse <span class="hljs-number">0.3s</span> ease-in-out;
}
</code></pre>
<p>然后将 View Transitions 添加到你的组件中：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { experimental_useViewTransition <span class="hljs-keyword">as</span> useViewTransition } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Image</span>(<span class="hljs-params">{ imageDataPromise }</span>) {
  <span class="hljs-keyword">const</span> image = <span class="hljs-title function_">use</span>(imageDataPromise);
  <span class="hljs-keyword">return</span> ;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ImageSkeleton</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"image-skeleton"</span> /&gt;</span></span>;
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Button</span>(<span class="hljs-params">{ action, children, disabled }</span>) {
  <span class="hljs-keyword">const</span> [isPending, startTransition] = <span class="hljs-title function_">useTransition</span>();
  <span class="hljs-keyword">const</span> viewTransition = <span class="hljs-title function_">useViewTransition</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">onClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">startTransition</span>(<span class="hljs-keyword">async</span> () =&gt; {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">action</span>();
    });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> {<span class="hljs-attr">...viewTransition</span>("<span class="hljs-attr">button-pulse</span>")}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{onClick}</span> <span class="hljs-attr">disabled</span>=<span class="hljs-string">{isPending}</span>&gt;</span>
        {children}
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ImageViewer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [imageId, setImageId] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">1</span>);
  <span class="hljs-keyword">const</span> [imageDataPromise, setImageDataPromise] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetchImage</span>(<span class="hljs-number">1</span>));

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleNext</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> nextId = imageId + <span class="hljs-number">1</span>;
    <span class="hljs-title function_">setImageId</span>(nextId);
    <span class="hljs-title function_">setImageDataPromise</span>(<span class="hljs-title function_">fetchImage</span>(nextId));
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">action</span>=<span class="hljs-string">{handleNext}</span>&gt;</span>Next Image<span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> {<span class="hljs-attr">...useViewTransition</span>("<span class="hljs-attr">image-container</span>")}&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">ImageSkeleton</span> /&gt;</span>}&gt;
          <span class="hljs-tag">&lt;<span class="hljs-name">Image</span> <span class="hljs-attr">imageDataPromise</span>=<span class="hljs-string">{imageDataPromise}</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>就这样。浏览器会自动处理 GPU 加速的过渡动画。你的骨架屏淡出，你的图片淡入，你的按钮在加载时会脉动。效果非常丝滑，而你几乎没写什么代码。</p>
<p><strong>注意：</strong> ​ 你需要 React 19.2 实验版才能使用此功能：<code>npm install react@experimental react-dom@experimental</code></p>
<p><strong>这对前端团队为何重要</strong></p>
<p>这些改变不仅仅是清理 <code>useEffect</code>/ <code>fetch</code>的烂摊子。它关乎构建一个更优秀的 React，这个 React 终于承认异步是一等公民。</p>
<p>这些模式意味着你的团队编写的代码更容易理解和维护。框架处理了更多事情。UI 响应更迅捷，因为它是按需更新的。你正在利用更多底层框架的能力，为你的应用赋予具有流畅动画的现代感。</p>
<p>这不再是"你爷爷辈的 React"了，是时候让团队开始使用这些新工具了。</p>
<p><strong>关键要点</strong></p>
<ul>
<li>
<p>React 19.2 带来了"无处不在的异步"。</p>
</li>
<li>
<p>这些基础构建块作为一个系统协同工作：</p>
<ul>
<li><code>use()</code>从 Promise 中提取数据</li>
<li><code>&lt;Suspense&gt;</code>声明式地处理加载状态</li>
<li><code>useTransition()</code>免费为你提供加载标志</li>
<li>View Transitions 添加 GPU 加速的润色</li>
</ul>
</li>
<li>
<p>旧方式（<code>useEffect</code>和 <code>fetch</code>）对 React 来说是个严重的痛点，但我们有了很好的替代方案。</p>
</li>
<li>
<p>React 的异步基础构建块意味着更少的代码、更少的 bug 和更好的用户体验。</p>
</li>
<li>
<p>你的团队可以更专注于构建体验，而不是支撑它的底层管道。</p>
</li>
</ul>
<p><strong>非 19.2 的选择：TanStack Query</strong></p>
<p>话虽如此，如果你还没准备好升级到 React 19.2，有一个很好的替代方案：TanStack Query（前身为 React Query）。它适用于任何 React 版本，并为你提供自动缓存、后台重新获取、乐观更新等功能。它是一个久经考验的解决方案，解决了与 React 19.2 异步基础构建块相同的问题，只是 API 不同。有充分的理由说明为什么这么多 React 应用都安装了 <code>react-query</code>。</p>
<p><strong>下一步：React 19.2 引领的前端未来</strong></p>
<p>React 19.2 已经发布。它是稳定的。你应该将其用于生产环境（除了仍在完善中的 View Transitions）。</p>
<p>异步变革已经到来。React 终于解决了它最大的痛点，框架也因此变得更好。</p>
<p>如果你还没有探索过 React 19.2，现在是时候了。在一个副项目上试试 <code>use()</code>和 <code>&lt;Suspense&gt;</code>，看看异步逻辑变得多么简单。你会惊讶于自己以前没有它是怎么过的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MUI sx prop 中的响应式适配]]></title>    <link>https://juejin.cn/post/7576646142316216361</link>    <guid>https://juejin.cn/post/7576646142316216361</guid>    <pubDate>2025-11-26T06:09:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576646142316216361" data-draft-id="7576646142316183593" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MUI sx prop 中的响应式适配"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-26T06:09:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="米诺zuo"/> <meta itemprop="url" content="https://juejin.cn/user/2436173497373399"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MUI sx prop 中的响应式适配
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173497373399/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    米诺zuo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T06:09:25.000Z" title="Wed Nov 26 2025 06:09:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h3 data-id="heading-0"><code>sx</code> Prop 响应式适配：核心思想</h3>
<p>在 <code>sx</code> prop 中，你不需要写复杂的 CSS Media Queries。相反，你可以直接将一个<strong>对象</strong>赋值给某个 CSS 属性。这个对象的<strong>键是断点名称</strong>，<strong>值是该断点下要应用的样式</strong>。</p>
<h2 data-id="heading-1">MUI 会在底层自动为你生成对应的 Media Queries 代码。</h2>
<h3 data-id="heading-2">1. 默认断点</h3>
<p>MUI 内置了一套标准的断点，你可以直接使用：</p>



































<table><thead><tr><th align="left">断点名称</th><th align="left">屏幕宽度范围</th><th align="left">设备类型示例</th></tr></thead><tbody><tr><td align="left"><code>xs</code></td><td align="left">0px 及以上</td><td align="left">超小屏幕（手机）</td></tr><tr><td align="left"><code>sm</code></td><td align="left">600px 及以上</td><td align="left">小屏幕（平板）</td></tr><tr><td align="left"><code>md</code></td><td align="left">900px 及以上</td><td align="left">中等屏幕（小型笔记本）</td></tr><tr><td align="left"><code>lg</code></td><td align="left">1200px 及以上</td><td align="left">大屏幕（桌面）</td></tr><tr><td align="left"><code>xl</code></td><td align="left">1536px 及以上</td><td align="left">超大屏幕（大型桌面）</td></tr></tbody></table>
<h2 data-id="heading-3"><strong>关键点</strong>：断点是<strong>向上应用</strong>的。这意味着你为 <code>sm</code> 设置的样式会同时应用于 <code>sm</code>, <code>md</code>, <code>lg</code>, <code>xl</code>，除非被更大断点的样式覆盖。</h2>
<h3 data-id="heading-4">2. 基本用法：对象语法</h3>
<p>这是最常用的方式。直接将一个对象传递给 CSS 属性。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Box</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@mui/material/Box'</span>;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Box</span>
  <span class="hljs-attr">sx</span>=<span class="hljs-string">{{</span>
    // <span class="hljs-attr">在所有屏幕上</span>，<span class="hljs-attr">字体大小都是</span> <span class="hljs-attr">1rem</span>
    <span class="hljs-attr">fontSize:</span> '<span class="hljs-attr">1rem</span>',
    // <span class="hljs-attr">在</span> '<span class="hljs-attr">sm</span>' <span class="hljs-attr">断点</span> (<span class="hljs-attr">600px</span>) <span class="hljs-attr">及以上</span>，<span class="hljs-attr">字体大小变为</span> <span class="hljs-attr">1.5rem</span>
    <span class="hljs-attr">fontSize:</span> {
      <span class="hljs-attr">sm:</span> '<span class="hljs-attr">1.5rem</span>',
    },
    // <span class="hljs-attr">你可以一次性定义多个断点</span>
    <span class="hljs-attr">fontSize:</span> {
      <span class="hljs-attr">xs:</span> '<span class="hljs-attr">1rem</span>',   // <span class="hljs-attr">0px</span>+
      <span class="hljs-attr">sm:</span> '<span class="hljs-attr">1.2rem</span>', // <span class="hljs-attr">600px</span>+
      <span class="hljs-attr">md:</span> '<span class="hljs-attr">1.5rem</span>', // <span class="hljs-attr">900px</span>+
      <span class="hljs-attr">lg:</span> '<span class="hljs-attr">1.8rem</span>', // <span class="hljs-attr">1200px</span>+
    },
    // <span class="hljs-attr">同样适用于其他属性</span>，<span class="hljs-attr">比如颜色</span>
    <span class="hljs-attr">color:</span> {
      <span class="hljs-attr">xs:</span> '<span class="hljs-attr">primary.main</span>',
      <span class="hljs-attr">md:</span> '<span class="hljs-attr">secondary.main</span>',
    }
  }}
&gt;</span>
  响应式文本
<span class="hljs-tag">&lt;/<span class="hljs-name">Box</span>&gt;</span></span>
</code></pre>
<p><strong>工作原理</strong>：</p>
<ul>
<li>当屏幕宽度 &lt; 600px 时，应用 <code>xs</code> 的样式（如果没定义，则用基础值）。</li>
<li>当屏幕宽度 &gt;= 600px 且 &lt; 900px 时，应用 <code>sm</code> 的样式。</li>
<li>当屏幕宽度 &gt;= 900px 且 &lt; 1200px 时，应用 <code>md</code> 的样式。</li>
<li>...以此类推。</li>
</ul>
<hr/>
<h3 data-id="heading-5">3. 断点简写语法</h3>
<p>如果你只想在某个断点及以上应用一个值，而不关心更小断点的样式，可以使用数组语法。数组的索引顺序对应断点顺序 <code>[xs, sm, md, lg, xl]</code>。</p>
<pre><code class="hljs language-jsx" lang="jsx">&lt;<span class="hljs-title class_">Box</span>
  sx={{
    <span class="hljs-comment">// 数组语法</span>
    <span class="hljs-comment">// [xs, sm, md, lg, xl]</span>
    <span class="hljs-attr">padding</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>], 
    <span class="hljs-comment">// 等价于：</span>
    <span class="hljs-comment">// padding: 1,  // xs</span>
    <span class="hljs-comment">// padding: 2,  // sm</span>
    <span class="hljs-comment">// padding: 3,  // md</span>
    <span class="hljs-comment">// padding: 3,  // lg (沿用 md 的值)</span>
    <span class="hljs-comment">// padding: 3,  // xl (沿用 md 的值)</span>
  }}
&gt;
  简写语法
&lt;/<span class="hljs-title class_">Box</span>&gt;
</code></pre>
<h2 data-id="heading-6"><strong>注意</strong>：这种语法不够直观，且灵活性较低。<strong>官方更推荐使用对象语法</strong>，因为它更清晰、更易维护。</h2>
<h3 data-id="heading-7">4. 结合 <code>display</code> 属性实现复杂布局</h3>
<p>响应式适配最常见的用途之一就是控制元素的显示和隐藏，或者改变它的布局方式。</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Grid</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@mui/material/Grid'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Card</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'@mui/material/Card'</span>;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Grid</span> <span class="hljs-attr">container</span> <span class="hljs-attr">spacing</span>=<span class="hljs-string">{2}</span>&gt;</span>
  {/* 
    这个卡片在手机上是 12 列（占满一行），
    在平板及以上是 6 列（一行两个）。
  */}
  <span class="hljs-tag">&lt;<span class="hljs-name">Grid</span> 
    <span class="hljs-attr">item</span> 
    <span class="hljs-attr">sx</span>=<span class="hljs-string">{{</span>
      <span class="hljs-attr">width:</span> { <span class="hljs-attr">xs:</span> '<span class="hljs-attr">100</span>%', <span class="hljs-attr">sm:</span> '<span class="hljs-attr">50</span>%' } // <span class="hljs-attr">或者直接用</span> <span class="hljs-attr">Grid</span> <span class="hljs-attr">的</span> <span class="hljs-attr">xs</span>, <span class="hljs-attr">sm</span> <span class="hljs-attr">props</span>
    }}
  &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Card</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">Card</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">Grid</span>&gt;</span>
  {/* 
    这个元素在手机上隐藏，在平板及以上显示。
  */}
  <span class="hljs-tag">&lt;<span class="hljs-name">Box</span>
    <span class="hljs-attr">sx</span>=<span class="hljs-string">{{</span>
      <span class="hljs-attr">display:</span> { <span class="hljs-attr">xs:</span> '<span class="hljs-attr">none</span>', <span class="hljs-attr">sm:</span> '<span class="hljs-attr">block</span>' }
    }}
  &gt;</span>
    只在平板和桌面显示
  <span class="hljs-tag">&lt;/<span class="hljs-name">Box</span>&gt;</span>
  {/*
    这个元素在手机上垂直排列，在桌面上水平排列。
  */}
  <span class="hljs-tag">&lt;<span class="hljs-name">Box</span>
    <span class="hljs-attr">sx</span>=<span class="hljs-string">{{</span>
      <span class="hljs-attr">display:</span> '<span class="hljs-attr">flex</span>',
      <span class="hljs-attr">flexDirection:</span> { <span class="hljs-attr">xs:</span> '<span class="hljs-attr">column</span>', <span class="hljs-attr">md:</span> '<span class="hljs-attr">row</span>' }
    }}
  &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Box</span>&gt;</span>项目1<span class="hljs-tag">&lt;/<span class="hljs-name">Box</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Box</span>&gt;</span>项目2<span class="hljs-tag">&lt;/<span class="hljs-name">Box</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">Box</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Grid</span>&gt;</span></span>
</code></pre>
<hr/>
<h3 data-id="heading-8">5. 使用自定义断点</h3>
<p>如果你的设计稿不符合 MUI 的默认断点，你可以在主题中自定义它们。</p>
<p><strong>步骤 1：在主题中定义断点</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// theme.js</span>
<span class="hljs-keyword">import</span> { createTheme } <span class="hljs-keyword">from</span> <span class="hljs-string">'@mui/material/styles'</span>;
<span class="hljs-keyword">const</span> theme = <span class="hljs-title function_">createTheme</span>({
  <span class="hljs-attr">breakpoints</span>: {
    <span class="hljs-attr">values</span>: {
      <span class="hljs-attr">xs</span>: <span class="hljs-number">0</span>,
      <span class="hljs-attr">sm</span>: <span class="hljs-number">600</span>,
      <span class="hljs-attr">md</span>: <span class="hljs-number">900</span>,
      <span class="hljs-attr">lg</span>: <span class="hljs-number">1200</span>,
      <span class="hljs-attr">xl</span>: <span class="hljs-number">1536</span>,
      <span class="hljs-comment">// 添加一个自定义断点</span>
      <span class="hljs-attr">tablet</span>: <span class="hljs-number">800</span>, 
    },
  },
});
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> theme;
</code></pre>
<p><strong>步骤 2：在 <code>sx</code> prop 中使用自定义断点</strong></p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// 确保你的组件被 &lt;ThemeProvider theme={theme}&gt; 包裹</span>
&lt;<span class="hljs-title class_">Box</span>
  sx={{
    <span class="hljs-comment">// 现在你可以直接使用 'tablet' 这个断点了</span>
    <span class="hljs-attr">fontSize</span>: {
      <span class="hljs-attr">xs</span>: <span class="hljs-string">'1rem'</span>,
      <span class="hljs-attr">tablet</span>: <span class="hljs-string">'1.4rem'</span>, <span class="hljs-comment">// 在 800px 及以上应用</span>
      <span class="hljs-attr">lg</span>: <span class="hljs-string">'1.8rem'</span>,
    }
  }}
&gt;
  使用自定义断点
&lt;/<span class="hljs-title class_">Box</span>&gt;
</code></pre>
<hr/>
<h3 data-id="heading-9">6. 最佳实践与技巧</h3>
<ol>
<li><strong>移动优先</strong>：始终从最小的断点 <code>xs</code> 开始设计，然后逐步向上增强。这符合“移动优先”的设计理念，也与你编写的对象顺序一致。
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// ✅ 好的做法</span>
sx={{ <span class="hljs-attr">p</span>: { <span class="hljs-attr">xs</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">sm</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">md</span>: <span class="hljs-number">3</span> } }}

<span class="hljs-comment">// ❌ 不推荐的做法（从大到小）</span>
sx={{ <span class="hljs-attr">p</span>: { <span class="hljs-attr">md</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">sm</span>: <span class="hljs-number">2</span>, <span class="hljs-attr">xs</span>: <span class="hljs-number">1</span> } }}
</code></pre>
</li>
<li><strong>保持简洁</strong>：不要在 <code>sx</code> 中定义过于复杂的响应式逻辑。如果某个组件的响应式行为非常复杂，考虑将其拆分成一个独立的、使用 <code>styled</code> API 创建的组件。</li>
<li><strong>利用间距单位</strong>：在响应式设计中，多使用 <code>spacing</code> 单位（如 <code>p: 2</code>, <code>m: 3</code>），而不是固定的像素值，这样可以保持整体设计的一致性。</li>
<li><strong>优先使用 Grid 组件的 props</strong>：对于 <code>Grid</code> 的响应式列宽，直接使用其内置的 <code>xs</code>, <code>sm</code>, <code>md</code> 等 props（如 <code>&lt;Grid item xs={12} sm={6} /&gt;</code>）比用 <code>sx</code> prop 更简洁、更符合其设计意图。<code>sx</code> prop 更适用于非 Grid 组件或 Grid 内部元素的样式定制。</li>
</ol>
<h3 data-id="heading-10">总结</h3>
<p><code>sx</code> prop 的响应式功能是一个革命性的工具，它将复杂的 Media Queries 抽象成了简单直观的对象语法。掌握它，你就能以极高的效率构建出精美、流畅的响应式用户界面。记住这个核心模式：</p>
<pre><code class="hljs language-jsx" lang="jsx">sx={{
  <span class="hljs-attr">cssProperty</span>: {
    <span class="hljs-attr">breakpoint</span>: <span class="hljs-string">'value'</span>,
    <span class="hljs-attr">anotherBreakpoint</span>: <span class="hljs-string">'anotherValue'</span>,
  }
}}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Gemini 3.0 Pro Preview 实测报告]]></title>    <link>https://juejin.cn/post/7576592590948646946</link>    <guid>https://juejin.cn/post/7576592590948646946</guid>    <pubDate>2025-11-26T06:48:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576592590948646946" data-draft-id="7576681897296936975" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Gemini 3.0 Pro Preview 实测报告"/> <meta itemprop="keywords" content="Gemini"/> <meta itemprop="datePublished" content="2025-11-26T06:48:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="智见AGI"/> <meta itemprop="url" content="https://juejin.cn/user/4145611877132986"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Gemini 3.0 Pro Preview 实测报告
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4145611877132986/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    智见AGI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T06:48:29.000Z" title="Wed Nov 26 2025 06:48:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/556b958764f244e595a817ab039add3e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764744509&amp;x-signature=S0wcGGX1I4QMGSOuOoYI%2Fi0LEKM%3D" alt="图片" loading="lazy"/></p>
<p>紧随 Grok 4.1 发布之后，AI 界最重磅的消息无疑是 Gemini 3.0 的亮相。这次 Gemini 从 2.5 到 3.0 并不只是一次“参数升级”、支持更多 token 或更稳定的上下文输入，而是一种全新的开发方式革新。无论是推理、多模态、前端生成，还是智能体整体的构建体验，Gemini 3 都带来了肉眼可见的跨代差距。今天我们就带来一份新鲜出炉的Gemini 3.0 实测报告。</p>
<p><strong>1</strong></p>
<p><strong>Gemini 3.0 核心能力</strong></p>
<p>这一代 Gemini 的设计核心被官方概括为三个方向：<strong>Learn anything、Build anything、Plan anything</strong> ——让模型不仅能理解复杂信息、构建实际产品，还能规划多步骤任务，真正靠近“可执行的智能体”。</p>
<p>我们目前测试的是新发布的 Gemini 3 Pro（gemini-3-pro-preview）。虽然它在参数上看起来与 Gemini 2.5 差不多：百万级上下文、64k 输出、知识训练截止同样是 2025 年 1 月，但实际体验完全是跨代的。Gemini 3 的核心优势不在指标，而在于推理深度、结构化响应、格式稳定性，以及对 vibe coding 与前端生成的天然适配。过去这段时间的测试里，最明显的两个变化是：</p>
<p><strong>●提示词格式明显简化</strong> ——从过去的 Chain-of-Thought，走向更自然、更结构化的提示方式；</p>
<p><strong>●视觉与前端生成能力大幅提升</strong> —— 一句风格描述就能生成完整、统一、可落地的 UI。</p>
<p><strong>1.1提示词深度分析</strong></p>
<p>在智能体开发中，回看上一代 Gemini 2.5，它更像是一位“优秀但需要明确指令的程序员”——需要先把架构画好、把每个 Agent 的职责写清楚、把 tech stack 写明白，它才知道如何接手。我们还往往需要额外给它参考模版、补充上下文，才能让它理解我们要开发的智能体结构。</p>
<p>但来到 Gemini 3.0，体验完全变了。它的角色不再只是“执行你给的指令”，而更像是一位“懂产品、也懂工程”的产品经理 + 程序员。我们只需要用自然语言描述想做的产品，Gemini就能理解需求、推断合理架构、确保技术可行性，并补上很多没写出的逻辑细节。这意味着未来做智能体，不再需要把精力放在繁杂的提示工程上，而可以把更多注意力放在  <strong>“产品到底要解决什么问题”</strong>  这件更重要的事上。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ef561eb504f4ddfab0c21f111803802~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764744509&amp;x-signature=OVDHr1LDhmoYqrIm%2BCrYEuKNoYI%3D" alt="图片" loading="lazy"/></p>
<p>在Gemini 2.5 时代开发智能体的提示词文档</p>
<p><strong>1.2全新开发交互界面</strong></p>
<p>这次发布会除了在 Google AI Studio 里新增的 preview 预览功能之外，更关键的是它背后所体现出的 Gemini 3 在整体设计能力上的跃升。上一代模型往往更关注“把功能做出来”，界面风格、配色和版式需要我们手动调整；而这一次，可以明显感觉到 Gemini 3 在审美、布局一致性、风格协调等方面已经更像一位懂设计的合作者。哪怕只给一句模糊描述，它给出的界面也更统一、更现代、更像“产品级作品”。preview 功能只是入口，让我们能看见并标注要修改的细节；但真正的变化是：Gemini 3 默认就能把产品做得更美、更完整。</p>
<p>下面提供的几个实操案例，对比 Gemini 2.5 和 Gemini 3.0 在 相同提示词 下生成的不同产物，可以更直观地看到这一代模型在设计感、结构化能力与整体完成度上的跨代提升。</p>
<p><strong>2</strong></p>
<p><strong>实操案例</strong></p>
<p><strong>2.1游戏开发</strong></p>
<p>在游戏生成的场景中，Gemini 2.5 Pro 与 Gemini 3.0 Pro Preview 的差异最为明显。Gemini 2.5 Pro 虽然能够实现基础玩法（平台、跳跃、重力逻辑等），但画面非常粗糙：色彩简单、像素细节缺失、角色造型只是基础方块，整体更像工程原型。而 Gemini 3.0 Pro Preview 在同样提示下生成的画面明显更接近真实游戏：像素风格统一、色彩更协调、元素细节丰富, HUD、砖块、地形的表现都更成熟，整体视觉品质提升是跨代的。不过也需要注意的是，在多次生成过程中，Gemini 3.0 Pro Preview 在游戏和 3D 渲染任务中出现了多次崩溃，稳定性远不如 Gemini 2.5 Pro。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc6c88c2bb2641628044a74a1971e669~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764744509&amp;x-signature=HWcH%2Fl7uOpf5SQI475uU8Bvl1bw%3D" alt="图片" loading="lazy"/></p>
<p>由Gemini 2.5 Pro 生成</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30c5828f1449486a91eb2913f6f27a33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764744509&amp;x-signature=3Auuyn3S%2B6e6%2FRrcGG0oufzavN4%3D" alt="图片" loading="lazy"/></p>
<p>由Gemini 3 Pro Preview 生成</p>
<p>**<br/>
**</p>
<p><strong>2.2网页设计</strong></p>
<p>**<br/>
**</p>
<p>网页设计方面，两代模型都能顺利完成基础结构与组件拆分，整体差距不如游戏场景那么夸张。但在更细节的设计层面，3.0 Pro Preview 的提升依然明显：页面风格更统一、排版更高级、配色更精致，界面整体更接近设计师作品；相同提示下的 2.5 则视觉上更模板化、字距与布局相对普通。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bba0a0eb28b4e7b803f61a90bce31f6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764744509&amp;x-signature=TLRGFg6e1MhyfuLYehoy7%2BtSZs4%3D" alt="图片" loading="lazy"/></p>
<p>由Gemini 2.5 Pro 生成</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b0942adb42814972842ce779f786c471~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764744509&amp;x-signature=HxSr9F49dgxq8X8e39ErVyBFNwU%3D" alt="图片" loading="lazy"/></p>
<p>由Gemini 3.0 Pro Preview 生成</p>
<p><strong>3</strong></p>
<p><strong>性能测试</strong></p>
<p>Gemini 3 在推理、多模态、视觉解析、编程、Agent 工具调用、长时序任务和长上下文处理上全面领先。</p>
<p><strong>3.1学术推理（Academic Reasoning）</strong></p>
<p>Gemini 3 在高难推理类任务中展现出跨代跃迁式的进步。无论是抽象逻辑、数学竞赛难度的题目还是综合推理场景，它都显著领先 Gemini 2.5、GPT-5.1 与 Claude。这类任务反映模型的深度思考能力，是智能体进行决策、金融分析和业务判断的重要基础。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f5b028a2bc364d629c13483d29c7805d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764744509&amp;x-signature=EG8Jlu6i1b4lg5%2BmeT9sPaxJAJg%3D" alt="图片" loading="lazy"/></p>
<p><strong>3.2 多模态理解（视觉、图像、图表、视频）</strong></p>
<p>Gemini 3 的视觉能力相比上一代有巨大飞跃，从 UI 屏幕解析到复杂图表推理都显著领先。尤其是 ScreenSpot-Pro，从 11% 跃升至 72%，表明模型能够真正理解前端界面结构。这对自动生成前端设计、工业图纸识别、视频分析都非常关键。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb565c40135a44e2806279678ac7ca9f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764744509&amp;x-signature=Y6e79W3JorO4RUkg77rbaACcGxU%3D" alt="图片" loading="lazy"/></p>
<p><strong>3.3 OCR（文档识别）</strong></p>
<p>在 OCR 评测中，Gemini 3 的编辑距离最低、识别最准确，尤其擅长结构化文档、扫描件、合同和工程图纸。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d26e80dfc534027985e892111397c9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764744509&amp;x-signature=B%2B%2FcUHgccVMkA3hcKLb4rJ11YO8%3D" alt="图片" loading="lazy"/></p>
<p><strong>3.4  编程能力（Coding &amp; Terminal）</strong></p>
<p>Gemini 3 在代码生成、终端操作、自动修复程序（SWE-Bench）等任务上全面领先。它不仅能写代码，还能理解系统行为并执行多步骤任务，真正适合作为 Agent 的“技术执行层”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0021f65e3c4d4561b651ddeb17796b65~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764744509&amp;x-signature=lMrtIka81NBV%2BvJWZ2Ff%2B4hGpAI%3D" alt="图片" loading="lazy"/></p>
<p><strong>3.5 Agent 原生能力（工具调用 &amp; 长时序任务）</strong></p>
<p>这是 Gemini 3 最突出的部分，无论是工具链调用（API、数据库、函数组合）还是长时序任务规划，Gemini 3 都远超 2.5 和竞品。尤其是 Vending-Bench 2，Gemini 3 的收益是 2.5 的约 10 倍。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/959cde7d3a444553a196243187159973~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764744509&amp;x-signature=78uVepU439%2Br%2BCxmzDym7i%2FaLH8%3D" alt="图片" loading="lazy"/></p>
<p><strong>3.6 知识、检索、跨语言能力</strong></p>
<p>**<br/>
**</p>
<p>在涵盖知识问答、事实检索、多语言、多文化常识等几十项指标中，Gemini 3 都表现稳定且处于第一梯队</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e00140b827cd421cb43630acac2e375a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764744509&amp;x-signature=avUY6He3R8Xu5KYMCFPKlC2FChA%3D" alt="图片" loading="lazy"/></p>
<p><strong>3.7 长上下文能力（Long Context）</strong></p>
<p>Gemini 3 的长上下文能力比 Gemini 2.5 提升巨大，在 128k 和 1M token 上都更稳定。对合规文档、长篇论文等任务帮助巨大。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/916af008898d4d85b4a38dda89637cd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764744509&amp;x-signature=aAVoNPhTAF0w1JnDli5noHsUh3k%3D" alt="图片" loading="lazy"/></p>
<p><strong>4</strong></p>
<p><strong>从 Gemini 2.5 迁移到 Gemini 3.0</strong></p>
<p>如果项目本身开始更看重界面美感、交互体验，或者希望智能体具备更强的自主规划能力，那确实可以考虑从 2.5 升级到 Gemini 3.0 Pro Preview；尤其是那些不擅长写复杂提示词、但想快速做出产品原型的产品经理式开发者，会明显感觉 3.0 更顺手、更聪明。不过，虽然 3.0 在设计、推理和整体产品能力上都像是一次跨代升级，但毕竟还是 Preview，稳定性还有提升空间，复杂场景里偶尔会崩溃，真正迁移前还是需要多测一测、看看是否适合当前的项目节奏。以下是从Gemini 2.5 Pro 升级到 3.0 Pro Preview 需要注意的几个点。</p>
<p><strong>4.1 思考能力（Thinking）：</strong></p>
<p>○在之前为了让 Gemini 2.5 进行深度推理而依赖复杂的 Prompt 工程（如 Chain-of-thought），那么在 Gemini 3 中可以使用 thinking_level: "high" 搭配更简化的提示语。更复杂的提示词可能误导Gemini 3.0 。</p>
<p><strong>4.2 PDF 与文档理解（PDF &amp; document understanding）：</strong></p>
<p>○PDF 的默认 OCR 分辨率有所调整。如果业务依赖对高密度文档的特定解析表现，可以测试新的 media_resolution_high 选项，确保结果的准确度。</p>
<p><strong>4.3 Token 消耗（Token consumption）：</strong></p>
<p>○迁移到 Gemini 3 Pro 后, token 的消耗速度有所更改。在读取PDF 时， token 消耗可能增加, 而视频解析上 token 消耗可能减少。</p>
<p><strong>4.4 稳定性：</strong></p>
<p>○值得注意的是在我们尝试以上实操案例的过程中：Gemini 3 Pro Preview 虽然能够生成明显更高质量、更细腻、更具设计感的产物，但整体稳定性仍有不足。多次出现报错。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ad353b80de9447fa045480d010b3de8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764744509&amp;x-signature=LVZRbcylKefJ6DW1zxxWNBZ%2FG%2BI%3D" alt="图片" loading="lazy"/></p>
<p><strong>5</strong></p>
<p><strong>Google 新发布的 Antigravity IDE</strong></p>
<p>除了 Gemini 3 的发布外，这次 Google 还推出了全新的 AI-first IDE —— <strong>Antigravity</strong>。这是一个以 Agent 为核心的新型开发环境，由 Gemini 3 Pro 驱动，能够直接控制编辑器、终端和浏览器，实现“让 AI 自主写代码、运行程序、测试页面”的完整闭环。与传统的 AI 编程助手不同，Antigravity 更像是一位真正的“开发伙伴”，不仅能提出方案，还能主动执行。平台同时提供多智能体协作视图以及可审计的工件（Artifacts），让复杂系统的构建过程更加透明和可控。Antigravity 的推出，也意味着 Google 正在构建一个从“模型 → Agent → 开发工具链”的完整生态，为未来的应用开发方式带来全新的可能性。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f328e04c249049238a4d27bda4bda82f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pm66KeBQUdJ:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764744509&amp;x-signature=4eUTR2vM73crD7M%2BQnKBIflG7dc%3D" alt="图片" loading="lazy"/></p>
<p><strong>6</strong></p>
<p><strong>总结</strong></p>
<p>整体体验下来，Gemini 3.0 真的是把“开发流程”重新洗牌了一遍。从想法到界面，从逻辑到执行，这一代已经不再只是协助你写代码，而是能参与到整个产品的思考和实现中，像是旁边多坐了一位既懂设计又懂工程的同事。而在视觉和美术方面，它的提升也特别明显——网页更有质感、游戏设计更精致，3D物理效果处理更真实，UI 整体风格也更统一、更像成品！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[fluwx 拉起小程序WXLog:Error:fail to load Keychain status:-25300, keyData null:1]]></title>    <link>https://juejin.cn/post/7576661150683873295</link>    <guid>https://juejin.cn/post/7576661150683873295</guid>    <pubDate>2025-11-26T06:18:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576661150683873295" data-draft-id="7576556950332227584" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="fluwx 拉起小程序WXLog:Error:fail to load Keychain status:-25300, keyData null:1"/> <meta itemprop="keywords" content="iOS,Flutter,微信小程序"/> <meta itemprop="datePublished" content="2025-11-26T06:18:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="tbit"/> <meta itemprop="url" content="https://juejin.cn/user/536217406945822"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            fluwx 拉起小程序WXLog:Error:fail to load Keychain status:-25300, keyData null:1
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/536217406945822/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    tbit
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T06:18:05.000Z" title="Wed Nov 26 2025 06:18:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>最近在 Flutter 项目中使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fpub.dev%2Fpackages%2Ffluwx" target="_blank" title="https://pub.dev/packages/fluwx" ref="nofollow noopener noreferrer">fluwx</a> 插件版本5.7.5 版本开发微信拉起小程序功能。在调试过程中发现一个奇怪的现象：<strong>Android 端可以正常拉起微信小程序，但 iOS 端却毫无反应</strong>。</p>
<p>查看 iOS 控制台日志，核心报错如下：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">WXLog:</span><span class="hljs-keyword">Error</span>:fail <span class="hljs-keyword">to</span> load Keychain status:-<span class="hljs-number">25300</span>, keyData null:<span class="hljs-number">1</span>
</code></pre>
<h2 data-id="heading-1">问题复现与日志分析</h2>
<p>在排查过程中，我捕获到了详细的日志流。虽然前面的检查步骤显示 <code>check passed</code>，但在最后一步 Universal Link 校验时失败了，并尝试降级使用 Scheme 跳转。</p>
<p><strong>关键错误日志：</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// Universal Link 校验通过的前几步</span>
<span class="hljs-number">2025</span><span class="hljs-number">-11</span><span class="hljs-number">-20</span> <span class="hljs-number">10</span>:<span class="hljs-number">07</span>:<span class="hljs-number">59.773</span> ... <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, check passed,
<span class="hljs-number">2025</span><span class="hljs-number">-11</span><span class="hljs-number">-20</span> <span class="hljs-number">10</span>:<span class="hljs-number">07</span>:<span class="hljs-number">59.775</span> ... <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, check passed,
...

<span class="hljs-comment">// 核心报错点 1：Universal Link 校验失败</span>
<span class="hljs-number">2025</span><span class="hljs-number">-11</span><span class="hljs-number">-20</span> <span class="hljs-number">10</span>:<span class="hljs-number">08</span>:<span class="hljs-number">02.351</span> ... <span class="hljs-number">5</span>, <span class="hljs-number">0</span>, Universal Link check failed. The application <span class="hljs-keyword">is</span> launched <span class="hljs-keyword">by</span> WeChat via scheme...

<span class="hljs-comment">// 核心报错点 2：Keychain 读取失败</span>
<span class="hljs-number">2025</span><span class="hljs-number">-11</span><span class="hljs-number">-20</span> <span class="hljs-number">10</span>:<span class="hljs-number">08</span>:<span class="hljs-number">09.554</span> ... WXLog:Error:fail to load Keychain status:<span class="hljs-number">-25300</span>, keyData <span class="hljs-literal">null</span>:<span class="hljs-number">1</span>
</code></pre>
<h2 data-id="heading-2">排查过程</h2>
<h3 data-id="heading-3">1. 官方文档与自查指引</h3>
<p>首先，我根据日志中提示的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdevelopers.weixin.qq.com%2Fcommunity%2Fdevelop%2Fdoc%2F000ce0403bc9d0ea1a0a67f415b409" target="_blank" title="https://developers.weixin.qq.com/community/develop/doc/000ce0403bc9d0ea1a0a67f415b409" ref="nofollow noopener noreferrer">微信开放平台自查指引</a> 进行了全面检查，发现好多微信开发者平台，帖子都有25300的问题，但是都是先提出问题，后面没有解决问题，这里吐槽一下。</p>
<h3 data-id="heading-4">2. 对比官方 Demo</h3>
<p>下载了 <code>fluwx</code> 的官方 Demo 进行运行对比。发现官方 Demo 中的 <code>register</code> 和 <code>open</code> 代码逻辑与我的项目中基本一致，但 Demo 能正常运行，我的项目却不行。</p>
<h3 data-id="heading-5">3. 检查 Universal Link 配置</h3>
<p>重点检查了 Universal Link 的相关配置，确认无误：</p>
<ul>
<li>✅ <code>apple-app-site-association</code> 文件已上传至服务器 <code>.well-known</code> 目录。</li>
<li>✅ 文件内容格式正确（JSON 格式，包含正确的 TeamID 和 BundleID）。</li>
<li>✅ Xcode 中 Associated Domains 已正确配置 <code>applinks:yourdomain.com</code>。</li>
</ul>
<h2 data-id="heading-6">最终解决方案</h2>
<p>在排查了所有常规配置后，我发现必须在 iOS 原生层的 <code>AppDelegate</code> 中手动实现微信的代理回调方法，才能解决这个问题。</p>
<p>虽然 <code>fluwx</code> 源码内部似乎已经处理了这些逻辑，但在我的环境下（可能是版本兼容性或特定的插件冲突），显式地在原生层重写以下代码解决了问题。</p>
<h3 data-id="heading-7">修改 <code>AppDelegate.m</code> (或 <code>AppDelegate.swift</code>)</h3>
<p>在 iOS 工程的 <code>AppDelegate</code> 中添加以下代码：</p>
<p>Objective-C</p>
<pre><code class="hljs language-objectivec" lang="objectivec"><span class="hljs-comment">// 处理 URL Scheme 跳转 (旧版微信跳转方式)</span>
- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)app openURL:(<span class="hljs-built_in">NSURL</span> *)url options:(<span class="hljs-built_in">NSDictionary</span>&lt;<span class="hljs-built_in">UIApplicationOpenURLOptionsKey</span>, <span class="hljs-type">id</span>&gt; *)options {
    <span class="hljs-comment">// 必须调用 super，否则可能影响 Flutter 其他插件</span>
    [<span class="hljs-variable language_">super</span> application:app openURL:url options:options];
    
    <span class="hljs-comment">// 手动处理微信回调</span>
    <span class="hljs-keyword">if</span> ([WXApi handleOpenURL:url delegate:<span class="hljs-keyword">self</span>]) {
        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"[WeChat] 分享回调 url: %@"</span>, url);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
}

<span class="hljs-comment">// 处理 Universal Link 跳转 (iOS 9+ 推荐方式)</span>
- (<span class="hljs-type">BOOL</span>)application:(<span class="hljs-built_in">UIApplication</span> *)application continueUserActivity:(<span class="hljs-built_in">NSUserActivity</span> *)userActivity restorationHandler:(<span class="hljs-type">void</span> (^)(<span class="hljs-built_in">NSArray</span>&lt;<span class="hljs-type">id</span>&lt;<span class="hljs-built_in">UIUserActivityRestoring</span>&gt;&gt; * _Nullable))restorationHandler {
    [<span class="hljs-variable language_">super</span> application:application continueUserActivity:userActivity restorationHandler:restorationHandler];

    <span class="hljs-keyword">if</span> ([WXApi handleOpenUniversalLink:userActivity delegate:<span class="hljs-keyword">self</span>]) {
        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"[WeChat] 分享回调 webpageURL: %@"</span>, userActivity.webpageURL);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">YES</span>;
}

<span class="hljs-comment">// 微信 SDK 回调处理</span>
- (<span class="hljs-type">void</span>)onReq:(BaseReq*)req {
    <span class="hljs-comment">// 处理从微信启动 App 的逻辑，例如获取开放标签传递的 extinfo</span>
    <span class="hljs-keyword">if</span> ([req isKindOfClass:[LaunchFromWXReq <span class="hljs-keyword">class</span>]]) {
        LaunchFromWXReq *wxreq = (LaunchFromWXReq *)req;
        WXMediaMessage *msg = wxreq.message;
        <span class="hljs-built_in">NSString</span> *extinfo = msg.messageExt;
        
        <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"[WeChat] 分享回调 extinfo: %@"</span>, extinfo);
    }
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"[WeChat] onReq 回调收到"</span>);
}

<span class="hljs-comment">// 如果需要处理响应结果，还需要实现 onResp</span>
- (<span class="hljs-type">void</span>)onResp:(BaseResp*)resp {
    <span class="hljs-built_in">NSLog</span>(<span class="hljs-string">@"[WeChat] onResp 回调收到 code: %d"</span>, resp.errCode);
}
</code></pre>
<h2 data-id="heading-8">总结</h2>
<p>虽然 <code>fluwx</code> 插件旨在让开发者免于编写原生代码，但在处理复杂的第三方 SDK 集成（特别是涉及 iOS 系统级跳转如 Universal Link）时，有时仍需要回归原生层进行“补丁”处理。</p>
<p>希望这篇记录能帮助遇到同样问题的开发者节省排查时间。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[十、路由和导航]]></title>    <link>https://juejin.cn/post/7576605171772096562</link>    <guid>https://juejin.cn/post/7576605171772096562</guid>    <pubDate>2025-11-26T06:19:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576605171772096562" data-draft-id="7576538234273923082" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="十、路由和导航"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-26T06:19:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="常乐我净616"/> <meta itemprop="url" content="https://juejin.cn/user/2080711784530167"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            十、路由和导航
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2080711784530167/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    常乐我净616
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T06:19:42.000Z" title="Wed Nov 26 2025 06:19:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Angular中，路由是一个重要的模块，用于在应用程序中定义网址（URL）和它们对应的组件。Angular路由器（Router）管理从一个视图到另一个视图的导航，实现单页应用（SPA）的不同视图显示。</p>
<h2 data-id="heading-0">一路由的基本使用</h2>
<ul>
<li>
<ol>
<li>在index.html 中添加 默认路径</li>
</ol>
<pre><code class="hljs language-ini" lang="ini">&lt;base <span class="hljs-attr">href</span>=<span class="hljs-string">"/"</span>&gt;
</code></pre>
</li>
<li>
<ol start="2">
<li><strong>定义路由</strong>： 路由的定义通常在应用模块中完成，通过<code>RouterModule.forRoot(routes)</code>方法注册。</li>
</ol>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NgModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">RouterModule</span>, <span class="hljs-title class_">Routes</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HomeComponent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./home/home.component'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AboutComponent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./about/about.component'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-attr">routes</span>: <span class="hljs-title class_">Routes</span> = [
  { <span class="hljs-attr">path</span>: <span class="hljs-string">''</span>, <span class="hljs-attr">redirectTo</span>: <span class="hljs-string">'/home'</span>, <span class="hljs-attr">pathMatch</span>: <span class="hljs-string">'full'</span> }, <span class="hljs-comment">// 默认路由 重定向 </span>
  { <span class="hljs-attr">path</span>: <span class="hljs-string">'home'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HomeComponent</span> },
  { <span class="hljs-attr">path</span>: <span class="hljs-string">'about'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">AboutComponent</span> },
    { <span class="hljs-attr">path</span>: <span class="hljs-string">'**'</span>, <span class="hljs-attr">component</span>: <span class="hljs-title class_">HomeComponent</span> } <span class="hljs-comment">// 404路由</span>
];

<span class="hljs-meta">@NgModule</span>({
  <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">RouterModule</span>.<span class="hljs-title function_">forRoot</span>(routes)],
  <span class="hljs-attr">exports</span>: [<span class="hljs-title class_">RouterModule</span>]
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppRoutingModule</span> {}
</code></pre>
</li>
<li>
<ol start="3">
<li><strong>路由模块导入</strong>： 通常，将路由配置在一个单独的模块<code>AppRoutingModule</code>中，并在主模块   <code>AppModule</code>中导入这个模块。</li>
</ol>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> { NgModule } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;
<span class="hljs-keyword">import</span> { BrowserModule } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/platform-browser'</span>;
<span class="hljs-keyword">import</span> { AppRoutingModule } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app-routing.module'</span>;
<span class="hljs-keyword">import</span> { AppComponent } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.component'</span>;

<span class="hljs-meta">@NgModule(<span class="hljs-params">{
  declarations: [
    AppComponent
  ],
  imports: [
    BrowserModule,
    AppRoutingModule
  ],
  providers: [],
  bootstrap: [AppComponent]
}</span>)</span>
export <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> { }
</code></pre>
</li>
<li>
<ol start="4">
<li>在app.component.html 开始使用</li>
</ol>
<pre><code class="hljs language-xml" lang="xml">
<span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">routerLink</span>=<span class="hljs-string">"/home"</span>&gt;</span>Home<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">routerLink</span>=<span class="hljs-string">"/about"</span>&gt;</span>About<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">router-outlet</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">router-outlet</span>&gt;</span>
</code></pre>
</li>
</ul>
<h2 data-id="heading-1">二 路由传参</h2>
<h3 data-id="heading-2">query传参</h3>
<ol>
<li><strong>导航时传递查询参数</strong></li>
</ol>
<p>使用<code>[queryParams]</code>传递参数。
<code>    &lt;a [routerLink]="['/products']" [queryParams]="{ category: 'electronics' }"&gt;View            Electronics&lt;/a&gt;    </code>
2.  <strong>在组件中接收查询参数</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin">使用`ActivatedRoute`服务获取查询参数。

```
<span class="hljs-keyword">import</span> { ActivatedRoute } from <span class="hljs-string">'@angular/router'</span>;
<span class="hljs-keyword">import</span> { Component, OnInit } from <span class="hljs-string">'@angular/core'</span>;

<span class="hljs-meta">@Component({
  selector: <span class="hljs-string">'app-product-list'</span>,
  templateUrl: <span class="hljs-string">'./product-list.component.html'</span>
})</span>
export <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductListComponent</span> <span class="hljs-title">implements</span> <span class="hljs-title">OnInit</span> {

  <span class="hljs-keyword">constructor</span>(<span class="hljs-keyword">private</span> route: ActivatedRoute) {}

  ngOnInit(): void {
    <span class="hljs-keyword">this</span>.route.queryParams.subscribe(params =&gt; {
      <span class="hljs-keyword">const</span> category = params[<span class="hljs-string">'category'</span>];
      console.log(category);
    });
    <span class="hljs-keyword">this</span>.route.snapshot.queryParamMap.<span class="hljs-keyword">get</span>(<span class="hljs-string">'category'</span>) <span class="hljs-comment">//快照方式</span>
  }
}
```
</code></pre>
<h3 data-id="heading-3">parameter 传参</h3>
<ol>
<li><strong>设置路由</strong></li>
</ol>
<pre><code class="hljs language-go" lang="go">在路由配置中使用<span class="hljs-string">`:`</span>符号定义路径参数。例如：
</code></pre>
<pre><code class="hljs language-ini" lang="ini">```
const routes: <span class="hljs-attr">Routes</span> = [
  { path: <span class="hljs-string">'product/:id'</span>, component: ProductDetailComponent }
]<span class="hljs-comment">;</span>
```
</code></pre>
<p>2.  <strong>导航时传递参数</strong></p>
<pre><code class="hljs language-css" lang="css">使用`<span class="hljs-selector-attr">[routerLink]</span>`传递参数。

```
&lt;<span class="hljs-selector-tag">a</span> <span class="hljs-selector-attr">[routerLink]</span>="<span class="hljs-selector-attr">[<span class="hljs-string">'/product'</span>, productId]</span>"&gt;View Product&lt;/<span class="hljs-selector-tag">a</span>&gt;
```    
</code></pre>
<p>3.  <strong>在组件中接收参数</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin">使用`ActivatedRoute`服务获取参数。

```
<span class="hljs-keyword">import</span> { ActivatedRoute } from <span class="hljs-string">'@angular/router'</span>;
<span class="hljs-keyword">import</span> { Component, OnInit } from <span class="hljs-string">'@angular/core'</span>;

<span class="hljs-meta">@Component({
  selector: <span class="hljs-string">'app-product-detail'</span>,
  templateUrl: <span class="hljs-string">'./product-detail.component.html'</span>
})</span>
export <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductDetailComponent</span> <span class="hljs-title">implements</span> <span class="hljs-title">OnInit</span> {
  productId: string;

  <span class="hljs-keyword">constructor</span>(<span class="hljs-keyword">private</span> route: ActivatedRoute) {}

  ngOnInit(): void {
    <span class="hljs-keyword">this</span>.productId = <span class="hljs-keyword">this</span>.route.snapshot.paramMap.<span class="hljs-keyword">get</span>(<span class="hljs-string">'id'</span>);
     <span class="hljs-keyword">this</span>.route.params.subscribe(params =&gt; {
   console.log(params[<span class="hljs-string">'id'</span>]) 
 })
  }
}
```
</code></pre>
<h2 data-id="heading-4">三、 路由嵌套</h2>
<ol>
<li><strong>设置主路由</strong></li>
</ol>
<p>在主路由设置中，引入一个组件，并为该组件定义一个子路由模块。</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">const routes:</span> <span class="hljs-string">Routes</span> <span class="hljs-string">=</span> [
  { <span class="hljs-attr">path:</span> <span class="hljs-string">'dashboard'</span>, <span class="hljs-attr">component:</span> <span class="hljs-string">DashboardComponent</span> },
  { <span class="hljs-attr">path:</span> <span class="hljs-string">'admin'</span>, <span class="hljs-attr">component:</span> <span class="hljs-string">AdminComponent</span>, <span class="hljs-attr">children:</span> [
    { <span class="hljs-attr">path:</span> <span class="hljs-string">'users'</span>, <span class="hljs-attr">component:</span> <span class="hljs-string">UsersComponent</span> },
    { <span class="hljs-attr">path:</span> <span class="hljs-string">'settings'</span>, <span class="hljs-attr">component:</span> <span class="hljs-string">SettingsComponent</span> }
  ]}
]<span class="hljs-string">;</span>
</code></pre>
<ol start="2">
<li>
<p><strong>使用 <code>&lt;router-outlet&gt;</code> 指令</strong></p>
<p>在父组件的模板中插入<code>&lt;router-outlet&gt;</code>指令，以加载子路由的组件。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- admin.component.html --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>Admin Section<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">nav</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">routerLink</span>=<span class="hljs-string">"users"</span>&gt;</span>Users<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">routerLink</span>=<span class="hljs-string">"settings"</span>&gt;</span>Settings<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">nav</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">router-outlet</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">router-outlet</span>&gt;</span>
</code></pre>
<p>在<code>AdminComponent</code>里使用<code>&lt;router-outlet&gt;</code>，用于展示其子路由对应组件的视图。</p>
</li>
<li>
<p><strong>导航到嵌套路由</strong></p>
</li>
</ol>
<p>使用<code>routerLink</code>来导航至子路由路径。</p>
<pre><code class="hljs language-xml" lang="xml">```
<span class="hljs-comment">&lt;!-- 在父组件中，例如 dashboard.component.html --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">routerLink</span>=<span class="hljs-string">"/admin"</span>&gt;</span>Admin Section<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">routerLink</span>=<span class="hljs-string">"/admin/users"</span>&gt;</span>Manage Users<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
```
</code></pre>
<h2 data-id="heading-5">四、编程式路由导航</h2>
<ul>
<li>1 方式一使用<code>navigate</code>方法</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Router</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Component</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;

<span class="hljs-meta">@Component</span>({
<span class="hljs-attr">selector</span>: <span class="hljs-string">'app-example'</span>,
<span class="hljs-attr">templateUrl</span>: <span class="hljs-string">'./example.component.html'</span>,
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExampleComponent</span> {

<span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> router: Router</span>) {}

<span class="hljs-title function_">goToUserDetail</span>(<span class="hljs-params">userId: <span class="hljs-built_in">number</span></span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">router</span>.<span class="hljs-title function_">navigate</span>([<span class="hljs-string">'/user'</span>, userId]);
}
}

</code></pre>
<ul>
<li>2 方式二使用<code>navigateByUrl</code>方法</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Router</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/router'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Component</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@angular/core'</span>;

<span class="hljs-meta">@Component</span>({
<span class="hljs-attr">selector</span>: <span class="hljs-string">'app-example'</span>,
<span class="hljs-attr">templateUrl</span>: <span class="hljs-string">'./example.component.html'</span>,
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExampleComponent</span> {

<span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> router: Router</span>) {}

<span class="hljs-title function_">goToHome</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">router</span>.<span class="hljs-title function_">navigateByUrl</span>(<span class="hljs-string">'/home'</span>);
}
}

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[若依系统集成kafka]]></title>    <link>https://juejin.cn/post/7576571960289738787</link>    <guid>https://juejin.cn/post/7576571960289738787</guid>    <pubDate>2025-11-26T06:47:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576571960289738787" data-draft-id="7576559408660119604" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="若依系统集成kafka"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-26T06:47:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="流水不腐518"/> <meta itemprop="url" content="https://juejin.cn/user/1505647403997856"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            若依系统集成kafka
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1505647403997856/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    流水不腐518
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T06:47:17.000Z" title="Wed Nov 26 2025 06:47:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>若依系统集成Kafka实现主题监听处理的完整方案</p>
<h2 data-id="heading-0">1. 添加依赖</h2>
<p>首先在项目的pom.xml中添加Kafka依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.kafka<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-kafka<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.8.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h2 data-id="heading-1">2. 配置Kafka连接</h2>
<p>在<code>application.yml</code>中配置Kafka：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">kafka:</span>
    <span class="hljs-comment"># Kafka服务器地址</span>
    <span class="hljs-attr">bootstrap-servers:</span> <span class="hljs-string">localhost:9092</span>
    <span class="hljs-attr">consumer:</span>
      <span class="hljs-comment"># 消费者组ID</span>
      <span class="hljs-attr">group-id:</span> <span class="hljs-string">ruoyi-group</span>
      <span class="hljs-comment"># 自动重置offset为最早</span>
      <span class="hljs-attr">auto-offset-reset:</span> <span class="hljs-string">earliest</span>
      <span class="hljs-comment"># 键的反序列化类</span>
      <span class="hljs-attr">key-deserializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringDeserializer</span>
      <span class="hljs-comment"># 值的反序列化类</span>
      <span class="hljs-attr">value-deserializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringDeserializer</span>
    <span class="hljs-attr">producer:</span>
      <span class="hljs-comment"># 键的序列化类</span>
      <span class="hljs-attr">key-serializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringSerializer</span>
      <span class="hljs-comment"># 值的序列化类</span>
      <span class="hljs-attr">value-serializer:</span> <span class="hljs-string">org.apache.kafka.common.serialization.StringSerializer</span>
    <span class="hljs-attr">listener:</span>
      <span class="hljs-comment"># 监听器类型，单条记录处理</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">single</span>
</code></pre>
<h2 data-id="heading-2">3. 创建Kafka配置类</h2>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">package</span> com.ruoyi.framework.config;

<span class="hljs-keyword">import</span> org.springframework.context.<span class="hljs-keyword">annotation</span>.Configuration;
<span class="hljs-keyword">import</span> org.springframework.kafka.<span class="hljs-keyword">annotation</span>.EnableKafka;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableKafka</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KafkaConfig</span> {
    <span class="hljs-comment">// 如果需要自定义配置可以在这里添加</span>
}
</code></pre>
<h2 data-id="heading-3">4. 创建消息生产者服务</h2>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">ruoyi</span>.<span class="hljs-property">system</span>.<span class="hljs-property">service</span>;

<span class="hljs-keyword">import</span> org.<span class="hljs-property">slf4j</span>.<span class="hljs-property">Logger</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">slf4j</span>.<span class="hljs-property">LoggerFactory</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">beans</span>.<span class="hljs-property">factory</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">Autowired</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">kafka</span>.<span class="hljs-property">core</span>.<span class="hljs-property">KafkaTemplate</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">stereotype</span>.<span class="hljs-property">Service</span>;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KafkaProducerService</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title class_">Logger</span> log = <span class="hljs-title class_">LoggerFactory</span>.<span class="hljs-title function_">getLogger</span>(<span class="hljs-title class_">KafkaProducerService</span>.<span class="hljs-property">class</span>);
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">KafkaTemplate</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; kafkaTemplate;
    
    <span class="hljs-comment">/**
     * 发送消息到指定主题
     * <span class="hljs-doctag">@param</span> topic 主题名称
     * <span class="hljs-doctag">@param</span> message 消息内容
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">sendMessage</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> topic, <span class="hljs-built_in">String</span> message</span>) {
        kafkaTemplate.<span class="hljs-title function_">send</span>(topic, message)
            .<span class="hljs-title function_">addCallback</span>(
                result -&gt; log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"消息发送成功: topic={}, message={}"</span>, topic, message),
                ex -&gt; log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"消息发送失败: topic={}, message={}, error={}"</span>, topic, message, ex.<span class="hljs-title function_">getMessage</span>())
            );
    }
    
    <span class="hljs-comment">/**
     * 发送用户操作日志消息
     * <span class="hljs-doctag">@param</span> message 日志消息
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">sendUserLog</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> message</span>) {
        <span class="hljs-title function_">sendMessage</span>(<span class="hljs-string">"user-operation-log"</span>, message);
    }
    
    <span class="hljs-comment">/**
     * 发送系统通知消息
     * <span class="hljs-doctag">@param</span> message 通知消息
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">sendSystemNotice</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> message</span>) {
        <span class="hljs-title function_">sendMessage</span>(<span class="hljs-string">"system-notice"</span>, message);
    }
}
</code></pre>
<h2 data-id="heading-4">5. 创建消息消费者服务</h2>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">ruoyi</span>.<span class="hljs-property">system</span>.<span class="hljs-property">service</span>;

<span class="hljs-keyword">import</span> org.<span class="hljs-property">slf4j</span>.<span class="hljs-property">Logger</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">slf4j</span>.<span class="hljs-property">LoggerFactory</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">kafka</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">KafkaListener</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">stereotype</span>.<span class="hljs-property">Service</span>;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KafkaConsumerService</span> {
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final <span class="hljs-title class_">Logger</span> log = <span class="hljs-title class_">LoggerFactory</span>.<span class="hljs-title function_">getLogger</span>(<span class="hljs-title class_">KafkaConsumerService</span>.<span class="hljs-property">class</span>);
    
    <span class="hljs-comment">/**
     * 监听用户操作日志主题
     * <span class="hljs-doctag">@param</span> message 消息内容
     */</span>
    <span class="hljs-meta">@KafkaListener</span>(topics = <span class="hljs-string">"user-operation-log"</span>, groupId = <span class="hljs-string">"ruoyi-group"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">handleUserOperationLog</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> message</span>) {
        log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"接收到用户操作日志: {}"</span>, message);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 这里处理业务逻辑，比如保存到数据库</span>
            <span class="hljs-comment">// userLogService.saveLog(message);</span>
            log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"用户操作日志处理完成: {}"</span>, message);
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
            log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"处理用户操作日志失败: {}, error: {}"</span>, message, e.<span class="hljs-title function_">getMessage</span>());
        }
    }
    
    <span class="hljs-comment">/**
     * 监听系统通知主题
     * <span class="hljs-doctag">@param</span> message 消息内容
     */</span>
    <span class="hljs-meta">@KafkaListener</span>(topics = <span class="hljs-string">"system-notice"</span>, groupId = <span class="hljs-string">"ruoyi-group"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">handleSystemNotice</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> message</span>) {
        log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"接收到系统通知: {}"</span>, message);
        
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 处理系统通知逻辑</span>
            <span class="hljs-comment">// 比如发送站内信、邮件通知等</span>
            log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"系统通知处理完成: {}"</span>, message);
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
            log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"处理系统通知失败: {}, error: {}"</span>, message, e.<span class="hljs-title function_">getMessage</span>());
        }
    }
    
    <span class="hljs-comment">/**
     * 监听多个主题
     * <span class="hljs-doctag">@param</span> message 消息内容
     */</span>
    <span class="hljs-meta">@KafkaListener</span>(topics = {<span class="hljs-string">"topic1"</span>, <span class="hljs-string">"topic2"</span>, <span class="hljs-string">"topic3"</span>}, groupId = <span class="hljs-string">"ruoyi-group"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">handleMultipleTopics</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> message</span>) {
        log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"接收到多主题消息: {}"</span>, message);
        <span class="hljs-comment">// 处理多个主题的消息</span>
    }
}
</code></pre>
<h2 data-id="heading-5">6. 创建控制器测试接口</h2>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">package</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.ruoyi</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.controller</span><span class="hljs-selector-class">.system</span>;

<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">com</span><span class="hljs-selector-class">.ruoyi</span><span class="hljs-selector-class">.system</span><span class="hljs-selector-class">.service</span><span class="hljs-selector-class">.KafkaProducerService</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.beans</span><span class="hljs-selector-class">.factory</span><span class="hljs-selector-class">.annotation</span><span class="hljs-selector-class">.Autowired</span>;
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">org</span><span class="hljs-selector-class">.springframework</span><span class="hljs-selector-class">.web</span><span class="hljs-selector-class">.bind</span><span class="hljs-selector-class">.annotation</span>.*;

@<span class="hljs-selector-tag">RestController</span>
@<span class="hljs-selector-tag">RequestMapping</span>(<span class="hljs-string">"/kafka"</span>)
<span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">KafkaTestController</span> {
    
    <span class="hljs-variable">@Autowired</span>
    private KafkaProducerService kafkaProducerService;
    
    <span class="hljs-comment">/**
     * 发送测试消息
     */</span>
    <span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/send"</span>)
    public String <span class="hljs-built_in">sendMessage</span>(<span class="hljs-variable">@RequestParam</span> String topic, <span class="hljs-variable">@RequestParam</span> String message) {
        <span class="hljs-selector-tag">kafkaProducerService</span><span class="hljs-selector-class">.sendMessage</span>(topic, message);
        <span class="hljs-selector-tag">return</span> "消息发送成功";
    }
    
    <span class="hljs-comment">/**
     * 发送用户操作日志
     */</span>
    @<span class="hljs-selector-tag">PostMapping</span>(<span class="hljs-string">"/sendUserLog"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">sendUserLog</span>(<span class="hljs-variable">@RequestParam</span> String message) {
        <span class="hljs-selector-tag">kafkaProducerService</span><span class="hljs-selector-class">.sendUserLog</span>(message);
        <span class="hljs-selector-tag">return</span> "用户操作日志发送成功";
    }
    
    <span class="hljs-comment">/**
     * 发送系统通知
     */</span>
    @<span class="hljs-selector-tag">PostMapping</span>(<span class="hljs-string">"/sendSystemNotice"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">sendSystemNotice</span>(<span class="hljs-variable">@RequestParam</span> String message) {
        <span class="hljs-selector-tag">kafkaProducerService</span><span class="hljs-selector-class">.sendSystemNotice</span>(message);
        <span class="hljs-selector-tag">return</span> "系统通知发送成功";
    }
}
</code></pre>
<h2 data-id="heading-6">7. 批量消息处理</h2>
<p>如果需要处理批量消息，可以配置批量监听：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">kafka:</span>
    <span class="hljs-attr">listener:</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">batch</span>
    <span class="hljs-attr">consumer:</span>
      <span class="hljs-attr">max-poll-records:</span> <span class="hljs-number">50</span>  <span class="hljs-comment"># 一次拉取最大记录数</span>
      <span class="hljs-attr">fetch-max-wait:</span> <span class="hljs-number">5000</span>  <span class="hljs-comment"># 拉取最大等待时间</span>
</code></pre>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * 批量消息监听
 */</span>
<span class="hljs-meta">@KafkaListener</span>(topics = <span class="hljs-string">"batch-topic"</span>, groupId = <span class="hljs-string">"ruoyi-group"</span>)
<span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">handleBatchMessages</span>(<span class="hljs-params">List&lt;<span class="hljs-built_in">String</span>&gt; messages</span>) {
    log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"接收到批量消息，数量: {}"</span>, messages.<span class="hljs-title function_">size</span>());
    
    <span class="hljs-keyword">for</span> (<span class="hljs-title class_">String</span> message : messages) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 处理每条消息</span>
            log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"处理消息: {}"</span>, message);
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">Exception</span> e) {
            log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"处理消息失败: {}, error: {}"</span>, message, e.<span class="hljs-title function_">getMessage</span>());
        }
    }
}
</code></pre>
<h2 data-id="heading-7">8. 错误处理和重试机制</h2>
<pre><code class="hljs language-typescript" lang="typescript">package com.<span class="hljs-property">ruoyi</span>.<span class="hljs-property">framework</span>.<span class="hljs-property">config</span>;

<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">context</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">Bean</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">context</span>.<span class="hljs-property">annotation</span>.<span class="hljs-property">Configuration</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">kafka</span>.<span class="hljs-property">config</span>.<span class="hljs-property">ConcurrentKafkaListenerContainerFactory</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">kafka</span>.<span class="hljs-property">core</span>.<span class="hljs-property">ConsumerFactory</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">retry</span>.<span class="hljs-property">backoff</span>.<span class="hljs-property">FixedBackOffPolicy</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">retry</span>.<span class="hljs-property">policy</span>.<span class="hljs-property">SimpleRetryPolicy</span>;
<span class="hljs-keyword">import</span> org.<span class="hljs-property">springframework</span>.<span class="hljs-property">retry</span>.<span class="hljs-property">support</span>.<span class="hljs-property">RetryTemplate</span>;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KafkaListenerConfig</span> {
    
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">ConcurrentKafkaListenerContainerFactory</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">kafkaListenerContainerFactory</span>(<span class="hljs-params">
            ConsumerFactory&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">String</span>&gt; consumerFactory</span>) {
        
        <span class="hljs-title class_">ConcurrentKafkaListenerContainerFactory</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; factory =
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConcurrentKafkaListenerContainerFactory</span>&lt;&gt;();
        factory.<span class="hljs-title function_">setConsumerFactory</span>(consumerFactory);
        
        <span class="hljs-comment">// 设置重试机制</span>
        factory.<span class="hljs-title function_">setRetryTemplate</span>(<span class="hljs-title function_">retryTemplate</span>());
        
        <span class="hljs-comment">// 设置并发数</span>
        factory.<span class="hljs-title function_">setConcurrency</span>(<span class="hljs-number">3</span>);
        
        <span class="hljs-keyword">return</span> factory;
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">RetryTemplate</span> <span class="hljs-title function_">retryTemplate</span>(<span class="hljs-params"/>) {
        <span class="hljs-title class_">RetryTemplate</span> retryTemplate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RetryTemplate</span>();
        
        <span class="hljs-title class_">FixedBackOffPolicy</span> backOffPolicy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FixedBackOffPolicy</span>();
        backOffPolicy.<span class="hljs-title function_">setBackOffPeriod</span>(<span class="hljs-number">3000</span>); <span class="hljs-comment">// 重试间隔3秒</span>
        
        <span class="hljs-title class_">SimpleRetryPolicy</span> retryPolicy = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleRetryPolicy</span>();
        retryPolicy.<span class="hljs-title function_">setMaxAttempts</span>(<span class="hljs-number">3</span>); <span class="hljs-comment">// 最大重试次数</span>
        
        retryTemplate.<span class="hljs-title function_">setBackOffPolicy</span>(backOffPolicy);
        retryTemplate.<span class="hljs-title function_">setRetryPolicy</span>(retryPolicy);
        
        <span class="hljs-keyword">return</span> retryTemplate;
    }
}
</code></pre>
<h2 data-id="heading-8">9. 使用示例</h2>
<p>在业务服务中使用Kafka：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">IUserService</span> {
    
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">KafkaProducerService</span> kafkaProducerService;
    
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">updateUser</span>(<span class="hljs-params">User user</span>) {
        <span class="hljs-comment">// 更新用户逻辑</span>
        <span class="hljs-comment">// ...</span>
        
        <span class="hljs-comment">// 发送操作日志到Kafka</span>
        <span class="hljs-title class_">String</span> logMessage = <span class="hljs-title class_">String</span>.<span class="hljs-title function_">format</span>(<span class="hljs-string">"用户%s更新了信息: %s"</span>, 
            <span class="hljs-title class_">SecurityUtils</span>.<span class="hljs-title function_">getUsername</span>(), user.<span class="hljs-title function_">getUserName</span>());
        kafkaProducerService.<span class="hljs-title function_">sendUserLog</span>(logMessage);
    }
}
</code></pre>
<h2 data-id="heading-9">注意事项</h2>
<ol>
<li><strong>确保Kafka服务正常运行</strong></li>
<li><strong>根据实际需求调整主题和消费者组配置</strong></li>
<li><strong>生产环境需要配置集群和认证信息</strong></li>
<li><strong>合理设置消息重试和错误处理机制</strong></li>
<li><strong>监控Kafka消息积压情况</strong></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TypeScript 里 infer 常见用法]]></title>    <link>https://juejin.cn/post/7576571960288182307</link>    <guid>https://juejin.cn/post/7576571960288182307</guid>    <pubDate>2025-11-26T06:35:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576571960288182307" data-draft-id="7576592590948384802" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TypeScript 里 infer 常见用法"/> <meta itemprop="keywords" content="前端,TypeScript"/> <meta itemprop="datePublished" content="2025-11-26T06:35:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Tonychen"/> <meta itemprop="url" content="https://juejin.cn/user/1503787637022109"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TypeScript 里 infer 常见用法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1503787637022109/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Tonychen
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T06:35:42.000Z" title="Wed Nov 26 2025 06:35:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1 什么是「infer」</h2>
<h3 data-id="heading-1">1.1 概念</h3>
<p><code>infer</code> 只能在 <strong>条件类型（conditional types）</strong> 中使用，用来 <strong>在类型推断时声明一个待推断的类型变量</strong>。</p>
<p>语法为：</p>
<pre><code class="hljs language-typescript" lang="typescript">T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SomeType</span>&lt;infer U&gt; ? U : <span class="hljs-built_in">never</span>
</code></pre>
<p>可以这么理解：</p>
<ul>
<li>如果 <code>T</code> 能匹配 <code>SomeType&lt;某个类型&gt;</code> 的结构</li>
<li>那么把内部类型推断为 <code>U</code></li>
<li>然后返回 <code>U</code></li>
</ul>
<h3 data-id="heading-2">1.2 特点</h3>
<h4 data-id="heading-3">1.2.1 只能在 extends ? : 中使用</h4>
<p>不能单独写，比如下边这么写就是错的：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> A = infer T; 
</code></pre>
<h4 data-id="heading-4">1.2.2 右侧的类型结构必须能匹配</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> A&lt;T&gt; = T <span class="hljs-keyword">extends</span> [infer U] ? U : <span class="hljs-built_in">never</span>;

<span class="hljs-keyword">type</span> B = A&lt;[<span class="hljs-built_in">string</span>]&gt;; <span class="hljs-comment">// string</span>
<span class="hljs-keyword">type</span> C = A&lt;<span class="hljs-built_in">string</span>&gt;;   <span class="hljs-comment">// never</span>
</code></pre>
<h2 data-id="heading-5">2 基本用法</h2>
<h3 data-id="heading-6">2.1 提取函数返回值类型</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ReturnType</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> (...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]) =&gt; infer R ? R : <span class="hljs-built_in">never</span>;

<span class="hljs-keyword">type</span> A = <span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">number</span>&gt;;
<span class="hljs-comment">// A = number</span>
</code></pre>
<p><code>infer R</code> 就是 <strong>推断函数的返回值类型</strong>。</p>
<h3 data-id="heading-7">2.2 提取参数类型</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">FirstArg</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> (<span class="hljs-attr">arg</span>: infer P, ...<span class="hljs-attr">args</span>: <span class="hljs-built_in">any</span>[]) =&gt; <span class="hljs-built_in">any</span> ? P : <span class="hljs-built_in">never</span>;

<span class="hljs-keyword">type</span> A = <span class="hljs-title class_">FirstArg</span>&lt;<span class="hljs-function">(<span class="hljs-params">x: <span class="hljs-built_in">string</span>, y: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">void</span>&gt;;
<span class="hljs-comment">// A = string</span>
</code></pre>
<h3 data-id="heading-8">2.3 提取数组元素类型</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">ElementOf</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> (infer U)[] ? U : <span class="hljs-built_in">never</span>;

<span class="hljs-keyword">type</span> A = <span class="hljs-title class_">ElementOf</span>&lt;<span class="hljs-built_in">string</span>[]&gt;; 
<span class="hljs-comment">// A = string</span>
</code></pre>
<h3 data-id="heading-9">2.4 提取 tuple 的某个元素</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">First</span>&lt;T&gt; = T <span class="hljs-keyword">extends</span> [infer F, ...<span class="hljs-built_in">any</span>[]] ? F : <span class="hljs-built_in">never</span>;

<span class="hljs-keyword">type</span> A = <span class="hljs-title class_">First</span>&lt;[<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>, <span class="hljs-built_in">boolean</span>]&gt;;
<span class="hljs-comment">// A = string</span>
</code></pre>
<p>在这个例子中，我们提取的是 tuple 的第一个元素。</p>
<h3 data-id="heading-10">2.5 提取对象中某个 key 的类型</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">PropType</span>&lt;T, K <span class="hljs-keyword">extends</span> keyof T&gt; = 
  T <span class="hljs-keyword">extends</span> { [<span class="hljs-title class_">Key</span> <span class="hljs-keyword">in</span> K]: infer R } 
    ? R 
    : <span class="hljs-built_in">never</span>;

<span class="hljs-keyword">type</span> A = <span class="hljs-title class_">PropType</span>&lt;{<span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>}, <span class="hljs-string">'age'</span>&gt;;
<span class="hljs-comment">// A = number</span>
</code></pre>
<h3 data-id="heading-11">2.6 对象路径提取</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Path</span>&lt;T&gt; = {
    [K <span class="hljs-keyword">in</span> keyof T]: 
        T[K] <span class="hljs-keyword">extends</span> <span class="hljs-built_in">object</span> 
          ? <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">string</span> &amp; K}</span>.<span class="hljs-subst">${Path&lt;T[K]&gt;}</span>`</span>
          : <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-built_in">string</span> &amp; K}</span>`</span>;
}[keyof T];
</code></pre>
<p>假设说我们有这么一个类型：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">User</span> = {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">name</span>: {
    <span class="hljs-attr">first</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">last</span>: <span class="hljs-built_in">string</span>;
  };
  <span class="hljs-attr">address</span>: {
    <span class="hljs-attr">city</span>: <span class="hljs-built_in">string</span>;
    <span class="hljs-attr">location</span>: {
      <span class="hljs-attr">lat</span>: <span class="hljs-built_in">number</span>;
      <span class="hljs-attr">lng</span>: <span class="hljs-built_in">number</span>;
    };
  };
};
</code></pre>
<p>执行 <code>Path</code>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">UserPath</span> = <span class="hljs-title class_">Path</span>&lt;<span class="hljs-title class_">User</span>&gt;;
</code></pre>
<p>之后得到的结果展开就是：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">UserPath</span> =
  | <span class="hljs-string">"id"</span>
  | <span class="hljs-string">"name.first"</span>
  | <span class="hljs-string">"name.last"</span>
  | <span class="hljs-string">"address.city"</span>
  | <span class="hljs-string">"address.location.lat"</span>
  | <span class="hljs-string">"address.location.lng"</span>;
</code></pre>
<h2 data-id="heading-12">3 总结</h2>
<p>本文总结了 TypeScript 中 <code>infer</code> 的常见用法，可以说 <code>infer</code> 是 TypeScript 里各种类型体操的基础，基于它可以实现各种「高级」类型。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[spring boot项目excel导出功能封装——3.图表导出]]></title>    <link>https://juejin.cn/post/7576698454924623878</link>    <guid>https://juejin.cn/post/7576698454924623878</guid>    <pubDate>2025-11-26T06:57:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576698454924623878" data-draft-id="7576841976927027236" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="spring boot项目excel导出功能封装——3.图表导出"/> <meta itemprop="keywords" content="后端,Spring Boot,Excel"/> <meta itemprop="datePublished" content="2025-11-26T06:57:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="allbs"/> <meta itemprop="url" content="https://juejin.cn/user/26044011655437"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            spring boot项目excel导出功能封装——3.图表导出
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/26044011655437/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    allbs
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T06:57:01.000Z" title="Wed Nov 26 2025 06:57:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">说在前面</h2>
<p>封装的easyexcel，基于注解实现excel的导入导出，以场景来说，就是你有一个<strong>现成的分页接口或者一个list接口</strong>，只需要添加几个简单的注解，就可以实现excel的导出，也是为了方便有模板生成代码的情况下直接生成导出功能。</p>
<p>这是封装的依赖库源码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fchenqi92%2Fallbs-excel" target="_blank" title="https://github.com/chenqi92/allbs-excel" ref="nofollow noopener noreferrer">github.com/chenqi92/al…</a></p>
<p>这是这个依赖库的使用示例：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fchenqi92%2Fallbs-excel-test" target="_blank" title="https://github.com/chenqi92/allbs-excel-test" ref="nofollow noopener noreferrer">github.com/chenqi92/al…</a></p>
<p>依赖库运行后在浏览器中打开：<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A8080%2F" target="_blank" title="http://localhost:8080/" ref="nofollow noopener noreferrer">http://localhost:8080/</a> 即可测试各种示例，参照示例进行使用可以不用看后续的使用说明。</p>
<p>这篇比较无聊，主要是导出数据时添加额外的<code>chart</code>属性自动生成图表。实际上数据导出后手动也可以指定生成图表，还更灵活。</p>
<h2 data-id="heading-1">使用说明</h2>
<p>添加maven依赖</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>  
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>cn.allbs<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>  
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>allbs-excel<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>  
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>  
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h3 data-id="heading-2">折线图</h3>
<p>代码示例(视图对象所有都用的同一样，区别只有chat属性设置，所以我后续就不放下面这个<code>ChartDataDTO</code>视图对象了)：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GetMapping("/line")</span>  
<span class="hljs-meta">@ExportExcel(  
    name = "折线图-销售趋势",  
    sheets = @Sheet(sheetName = "Sales Data"),  
    chart = @ExcelChart(  
       title = "Monthly Sales Trend",  
       enabled = true,  
       type = ExcelChart.ChartType.LINE,  
       xAxisField = "Month",  
       yAxisFields = {"Sales", "Cost", "Profit"},  
       startRow = 0,  
       startColumn = 8,  
       endRow = 20,  
       endColumn = 18,  
       xAxisTitle = "Month",  
       yAxisTitle = "Amount (USD)",  
       showLegend = true,  
       legendPosition = ExcelChart.LegendPosition.BOTTOM  
    )  
)</span>  
<span class="hljs-keyword">public</span> List&lt;ChartDataDTO&gt; <span class="hljs-title function_">exportLineChart</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(defaultValue = "12")</span> <span class="hljs-type">int</span> months)</span> {  
    log.info(<span class="hljs-string">"Exporting line chart with {} months of data"</span>, months);  
    <span class="hljs-keyword">return</span> testDataService.generateChartData(Math.min(months, <span class="hljs-number">12</span>));  
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>  
<span class="hljs-meta">@NoArgsConstructor</span>  
<span class="hljs-meta">@AllArgsConstructor</span>  
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChartDataDTO</span> {  
  
    <span class="hljs-meta">@ExcelProperty(value = "Month", index = 0)</span>  
    <span class="hljs-keyword">private</span> String month;  
  
    <span class="hljs-meta">@ExcelProperty(value = "Sales", index = 1)</span>  
    <span class="hljs-keyword">private</span> BigDecimal sales;  
  
    <span class="hljs-meta">@ExcelProperty(value = "Cost", index = 2)</span>  
    <span class="hljs-keyword">private</span> BigDecimal cost;  
  
    <span class="hljs-meta">@ExcelProperty(value = "Profit", index = 3)</span>  
    <span class="hljs-keyword">private</span> BigDecimal profit;  
  
    <span class="hljs-meta">@ExcelProperty(value = "Growth Rate (%)", index = 4)</span>  
    <span class="hljs-keyword">private</span> Double growthRate;  
  
    <span class="hljs-meta">@ExcelProperty(value = "Units Sold", index = 5)</span>  
    <span class="hljs-keyword">private</span> Integer unitsSold;  
}
</code></pre>
<p>生成效果：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1503615704cf4863acca25b93f6fc96b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWxsYnM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764745021&amp;x-signature=bV70AGJ%2Be7pYrPVLpDaOaJqyEVc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-3">柱状图（纵向）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GetMapping("/column")</span>  
<span class="hljs-meta">@ExportExcel(  
    name = "柱状图-销售对比",  
    sheets = @Sheet(sheetName = "Sales Comparison"),  
    chart = @ExcelChart(  
       title = "Monthly Sales vs Cost",  
       enabled = true,  
       type = ExcelChart.ChartType.COLUMN,  
       xAxisField = "Month",  
       yAxisFields = {"Sales", "Cost"},  
       startRow = 0,  
       startColumn = 8,  
       endRow = 20,  
       endColumn = 18,  
       xAxisTitle = "Month",  
       yAxisTitle = "Amount (USD)",  
       showLegend = true,  
       legendPosition = ExcelChart.LegendPosition.TOP  
    )  
)</span>  
<span class="hljs-keyword">public</span> List&lt;ChartDataDTO&gt; <span class="hljs-title function_">exportColumnChart</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(defaultValue = "12")</span> <span class="hljs-type">int</span> months)</span> {  
    log.info(<span class="hljs-string">"Exporting column chart with {} months of data"</span>, months);  
    <span class="hljs-keyword">return</span> testDataService.generateChartData(Math.min(months, <span class="hljs-number">12</span>));  
}
</code></pre>
<p>实际效果：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/962c27b1c1f145969cbebb570a29b5e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWxsYnM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764745021&amp;x-signature=PaM2qnS3%2Ft3838klXJw4k8Id9QY%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">条形图（横向）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GetMapping("/bar")</span>  
<span class="hljs-meta">@ExportExcel(  
    name = "条形图-月度利润",  
    sheets = @Sheet(sheetName = "Monthly Profit"),  
    chart = @ExcelChart(  
       title = "Monthly Profit Analysis",  
       enabled = true,  
       type = ExcelChart.ChartType.BAR,  
       xAxisField = "Month",  
       yAxisFields = {"Profit"},  
       startRow = 0,  
       startColumn = 8,  
       endRow = 20,  
       endColumn = 18,  
       xAxisTitle = "Month",  
       yAxisTitle = "Profit (USD)",  
       showLegend = true,  
       legendPosition = ExcelChart.LegendPosition.RIGHT  
    )  
)</span>  
<span class="hljs-keyword">public</span> List&lt;ChartDataDTO&gt; <span class="hljs-title function_">exportBarChart</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(defaultValue = "12")</span> <span class="hljs-type">int</span> months)</span> {  
    log.info(<span class="hljs-string">"Exporting bar chart with {} months of data"</span>, months);  
    <span class="hljs-keyword">return</span> testDataService.generateChartData(Math.min(months, <span class="hljs-number">12</span>));  
}
</code></pre>
<p>实际效果：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ac1c2f835c94a71af66094bc5bcd5c6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWxsYnM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764745021&amp;x-signature=rPUNr8mFtAqWlVDOsqXoX%2BHg1QI%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">饼图</h3>
<p>代码示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GetMapping("/pie")</span>  
<span class="hljs-meta">@ExportExcel(  
    name = "饼图-销售分布",  
    sheets = @Sheet(sheetName = "Sales Distribution"),  
    chart = @ExcelChart(  
       title = "Sales Distribution by Month",  
       enabled = true,  
       type = ExcelChart.ChartType.PIE,  
       xAxisField = "Month",  
       yAxisFields = {"Sales"},  
       startRow = 0,  
       startColumn = 8,  
       endRow = 20,  
       endColumn = 18,  
       showLegend = true,  
       legendPosition = ExcelChart.LegendPosition.RIGHT  
    )  
)</span>  
<span class="hljs-keyword">public</span> List&lt;ChartDataDTO&gt; <span class="hljs-title function_">exportPieChart</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(defaultValue = "12")</span> <span class="hljs-type">int</span> months)</span> {  
    log.info(<span class="hljs-string">"Exporting pie chart with {} months of data"</span>, months);  
    <span class="hljs-keyword">return</span> testDataService.generateChartData(Math.min(months, <span class="hljs-number">12</span>));  
}
</code></pre>
<p>实际效果：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c751bae3c6144448c4b80eadff6d671~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWxsYnM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764745021&amp;x-signature=lEKq7IskNbW%2Bp1jtz%2FiJQGpTECA%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">面积图</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GetMapping("/area")</span>  
<span class="hljs-meta">@ExportExcel(  
    name = "面积图-累计销售",  
    sheets = @Sheet(sheetName = "Cumulative Sales"),  
    chart = @ExcelChart(  
       title = "Cumulative Sales and Cost",  
       enabled = true,  
       type = ExcelChart.ChartType.AREA,  
       xAxisField = "Month",  
       yAxisFields = {"Sales", "Cost"},  
       startRow = 0,  
       startColumn = 8,  
       endRow = 20,  
       endColumn = 18,  
       xAxisTitle = "Month",  
       yAxisTitle = "Amount (USD)",  
       showLegend = true,  
       legendPosition = ExcelChart.LegendPosition.BOTTOM  
    )  
)</span>  
<span class="hljs-keyword">public</span> List&lt;ChartDataDTO&gt; <span class="hljs-title function_">exportAreaChart</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(defaultValue = "12")</span> <span class="hljs-type">int</span> months)</span> {  
    log.info(<span class="hljs-string">"Exporting area chart with {} months of data"</span>, months);  
    <span class="hljs-keyword">return</span> testDataService.generateChartData(Math.min(months, <span class="hljs-number">12</span>));  
}
</code></pre>
<p>实际效果：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/123ed80f36b5421784a4af976ae6a5b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWxsYnM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764745021&amp;x-signature=n3uEfFpOeI%2Byaga1OXZJgHkIF%2Bk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">多个独立图表导出</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@GetMapping("/layered-analysis")</span>  
<span class="hljs-meta">@ExportExcel(  
    name = "分层分析-多图表",  
    sheets = @Sheet(sheetName = "Layered Analysis"),  
    charts = {  
       @ExcelChart(  
          title = "Revenue Analysis",  
          enabled = true,  
          type = ExcelChart.ChartType.LINE,  
          xAxisField = "Month",  
          yAxisFields = {"Sales"},  
          startRow = 0,  
          startColumn = 8,  
          endRow = 15,  
          endColumn = 17,  
          xAxisTitle = "Month",  
          yAxisTitle = "Sales (USD)",  
          showLegend = true,  
          legendPosition = ExcelChart.LegendPosition.BOTTOM  
       ),  
       @ExcelChart(  
          title = "Cost Analysis",  
          enabled = true,  
          type = ExcelChart.ChartType.AREA,  
          xAxisField = "Month",  
          yAxisFields = {"Cost"},  
          startRow = 17,  
          startColumn = 8,  
          endRow = 32,  
          endColumn = 17,  
          xAxisTitle = "Month",  
          yAxisTitle = "Cost (USD)",  
          showLegend = true,  
          legendPosition = ExcelChart.LegendPosition.TOP  
       ),  
       @ExcelChart(  
          title = "Profit Analysis",  
          enabled = true,  
          type = ExcelChart.ChartType.COLUMN,  
          xAxisField = "Month",  
          yAxisFields = {"Profit"},  
          startRow = 0,  
          startColumn = 19,  
          endRow = 15,  
          endColumn = 27,  
          xAxisTitle = "Month",  
          yAxisTitle = "Profit (USD)",  
          showLegend = true,  
          legendPosition = ExcelChart.LegendPosition.RIGHT  
       )  
    })</span>  
<span class="hljs-keyword">public</span> List&lt;ChartDataDTO&gt; <span class="hljs-title function_">exportLayeredAnalysis</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(defaultValue = "12")</span> <span class="hljs-type">int</span> months)</span> {  
    log.info(<span class="hljs-string">"Exporting layered analysis with {} months of data"</span>, months);  
    <span class="hljs-keyword">return</span> testDataService.generateChartData(Math.min(months, <span class="hljs-number">12</span>));  
}
</code></pre>
<p>实际效果：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d7b5416739f495197bacc239870c4f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgYWxsYnM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764745021&amp;x-signature=7O3eVjuQvIuiqZ1P5ClqPjkqMtE%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[到底原研药，官方发布《Android API 设计指南》]]></title>    <link>https://juejin.cn/post/7576592590948843554</link>    <guid>https://juejin.cn/post/7576592590948843554</guid>    <pubDate>2025-11-26T07:00:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576592590948843554" data-draft-id="7576559408660135988" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="到底原研药，官方发布《Android API 设计指南》"/> <meta itemprop="keywords" content="架构,Android,Android Studio"/> <meta itemprop="datePublished" content="2025-11-26T07:00:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Mr_万能胶"/> <meta itemprop="url" content="https://juejin.cn/user/1644525123284631"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            到底原研药，官方发布《Android API 设计指南》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1644525123284631/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Mr_万能胶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T07:00:06.000Z" title="Wed Nov 26 2025 07:00:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>好久不更新了，说起来自从发现掘金的水文跟 AI 文越来越多，质量直线下降之后，基本也就失去了写作兴趣，每天黑板报看一看，保证自己的技术新鲜度和活跃性也就够了。</p>
<p>今天在逛 source.android.com 的时候，无疑发现 Google 上线了一篇《<a href="https://link.juejin.cn?target=https%3A%2F%2Fsource.android.com%2Fdocs%2Fsetup%2Fcontribute%2Fapi-guidelines" target="_blank" title="https://source.android.com/docs/setup/contribute/api-guidelines" ref="nofollow noopener noreferrer">Android API guidelines</a>》，读完真的觉得干货满满，相见恨晚。然后我瞬间反思了一下，不对啊，这么好的文章，作为我，怎么会才看到的？于是赶忙拿 Web Archine 查了一下，不怪我，从时间上看，确实这个页面也是今年夏天才上线的，想想广东的11月也才算正式入秋，现在读到应该也不算晚。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1e2efff57a10429a85b239767836ee98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTXJf5LiH6IO96IO2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764745352&amp;x-signature=P5nPXtNu9c5FYeFRxQpDXemc1Vg%3D" alt="image.png" loading="lazy"/></p>
<p>哦对了，需要说明的是，这篇文章里面有80%的内容，其实与 AOSP 的 <code>developers/docs</code>下的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fandroid.googlesource.com%2Fplatform%2Fdevelopers%2Fdocs%2F%2B%2F975a589941f728f6c6ce6fbbd7517ca854bc61ba%2Fapi-guidelines%2Findex.md" target="_blank" title="https://android.googlesource.com/platform/developers/docs/+/975a589941f728f6c6ce6fbbd7517ca854bc61ba/api-guidelines/index.md" ref="nofollow noopener noreferrer">index.md</a> 存在重合，但是我已经仔细看过了，android 官方这个版本更新，而且很多内容更面向外部的 framework 开发者，而 <code>developers/docs</code> 下的则更像是 Google 给内部新入职的 framework 开发者看的，毕竟框架有大量的 API 设计工作，写接口想比写业务还是有蛮多要注意的。</p>
<p>好了，字越少事越大，我才不会拿 AI 翻译一下贴过来水文章，强烈建议大家点击上方链接去官方网站阅读，就酱紫~</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【技术干货】DeepSeek-OCR模型在DevPod/FunModel上的全流程工程化实践]]></title>    <link>https://juejin.cn/post/7576571960287625251</link>    <guid>https://juejin.cn/post/7576571960287625251</guid>    <pubDate>2025-11-26T05:10:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576571960287625251" data-draft-id="7576592590947827746" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【技术干货】DeepSeek-OCR模型在DevPod/FunModel上的全流程工程化实践"/> <meta itemprop="keywords" content="云原生"/> <meta itemprop="datePublished" content="2025-11-26T05:10:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云云原生"/> <meta itemprop="url" content="https://juejin.cn/user/3808363977648493"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【技术干货】DeepSeek-OCR模型在DevPod/FunModel上的全流程工程化实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3808363977648493/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云云原生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T05:10:58.000Z" title="Wed Nov 26 2025 05:10:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：西流</p>
<blockquote>
<p>开发调试到生产上线，全流程仅需一个工作区——DevPod 重新定义 AI 工程化标准，当开发与部署不再割裂，模型价值才真正释放。</p>
</blockquote>
<h2 data-id="heading-0">简介</h2>
<p>告别碎片化开发体验，DevPod 打造从代码到服务的一站式闭环。本文手把手演示在<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Ffc%3Fspm%3Da1z389.11499242.0.0.65452413RXCQWs%26utm_content%3Dg_1000408146" target="_blank" title="https://www.aliyun.com/product/fc?spm=a1z389.11499242.0.0.65452413RXCQWs&amp;utm_content=g_1000408146" ref="nofollow noopener noreferrer">函数计算</a> Funmodel 上完成 DeepSeek-OCR 模型从云端开发、本地调试到生产部署的完整工作流，让模型真正走出实验室，实现分钟级服务化，重塑 AI 模型从开发到落地的高效路径。</p>
<h2 data-id="heading-1">回顾：为何 DevPod 让 DeepSeek-OCR 启动如此简单？</h2>
<p>在系列第一篇《<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzUzNzYxNjAzMg%3D%3D%26mid%3D2247578933%26idx%3D1%26sn%3D3ec88789b105d60d11d52ee6e46f238e%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzUzNzYxNjAzMg==&amp;mid=2247578933&amp;idx=1&amp;sn=3ec88789b105d60d11d52ee6e46f238e&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">为什么别人用 DevPod 秒启 DeepSeek-OCR，你还在装环境？</a>》中，我们见证了 DevPod 如何将原本繁琐的环境配置、依赖安装、硬件适配等过程压缩至 60 秒内完成。无需再为 CUDA 版本冲突、Python 环境隔离、模型权重下载缓慢而烦恼，DevPod 通过云端预置环境，让开发者一进入工作区就能立即与 DeepSeek-OCR 大模型进行交互，真正实现了“开箱即用”的 AI 开发体验。</p>
<blockquote>
<p>DevPod 是一款云原生 AI 开发工具，提供统一工作空间与预置环境，实现开发、测试、生产环境一致性，彻底消除“环境漂移”问题。</p>
<p>它能一键调用 GPU 资源，支持代码编写、调试、模型调优、镜像封装与生产部署全流程操作，无需切换多平台工具。</p>
<p>还可与<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.aliyun.com%2Fproduct%2Ffc%3Fspm%3Da1z389.11499242.0.0.65452413RXCQWs%26utm_content%3Dg_1000408146" target="_blank" title="https://www.aliyun.com/product/fc?spm=a1z389.11499242.0.0.65452413RXCQWs&amp;utm_content=g_1000408146" ref="nofollow noopener noreferrer">阿里云函数计算</a> FunModel 深度集成，提供性能监控、日志分析、在线调试与快速迭代能力，让 AI 模型从实验室到服务化落地更高效。</p>
</blockquote>
<h2 data-id="heading-2">从开发到生产：DevPod 全流程闭环工作流</h2>
<p>然而，启动模型仅仅是开始。在实际业务场景中，我们还需要完成模型调优、代码调试、性能测试、服务封装、生产部署等一系列环节。传统方式下，这些步骤往往涉及多个平台和工具的切换，数据和代码在不同环境间流转，极易出现“在我机器上能运行”的尴尬局面。</p>
<p>DevPod 通过统一的工作空间和无缝衔接的部署能力，打通了从代码到服务的最后一公里。下面，我们将通过 DeepSeek-OCR 模型的实战案例，完整演示这一工作流。</p>
<h3 data-id="heading-3">1. 开发调试阶段：VSCode + GPU 加速的云端实验室</h3>
<p>在 DevPod 中启动 DeepSeek-OCR 环境实例后，我们立即获得一个配备 GPU 的云端 VSCode 开发环境。这不仅是一个模型运行的容器，更是一个完整的端到端研究与开发平台。基于 DeepSeek-OCR-vLLM 提供的代码推理示例，我们构建了 server.py 作为推理服务的核心入口，实现了高效、可扩展的推理接口。（完整代码详见附录）</p>
<blockquote>
<p>/workspace/DeepSeek-OCR/DeepSeek-OCR-master/DeepSeek-OCR-vllm/server.py</p>
</blockquote>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> io
<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> uvicorn
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI, HTTPException
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span>, <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>, <span class="hljs-type">List</span>
<span class="hljs-keyword">import</span> tempfile
<span class="hljs-keyword">import</span> fitz
<span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor
<span class="hljs-keyword">import</span> asyncio
<span class="hljs-comment"># Set environment variables</span>
<span class="hljs-keyword">if</span> torch.version.cuda == <span class="hljs-string">'11.8'</span>:
    os.environ[<span class="hljs-string">"TRITON_PTXAS_PATH"</span>] = <span class="hljs-string">"/usr/local/cuda-11.8/bin/ptxas"</span>
os.environ[<span class="hljs-string">'VLLM_USE_V1'</span>] = <span class="hljs-string">'0'</span>
os.environ[<span class="hljs-string">"CUDA_VISIBLE_DEVICES"</span>] = <span class="hljs-string">'0'</span>
<span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> MODEL_PATH, CROP_MODE, MAX_CONCURRENCY, NUM_WORKERS
<span class="hljs-keyword">from</span> vllm <span class="hljs-keyword">import</span> LLM, SamplingParams
<span class="hljs-keyword">from</span> vllm.model_executor.models.registry <span class="hljs-keyword">import</span> ModelRegistry
<span class="hljs-keyword">from</span> deepseek_ocr <span class="hljs-keyword">import</span> DeepseekOCRForCausalLM
<span class="hljs-keyword">from</span> process.ngram_norepeat <span class="hljs-keyword">import</span> NoRepeatNGramLogitsProcessor
<span class="hljs-keyword">from</span> process.image_process <span class="hljs-keyword">import</span> DeepseekOCRProcessor
<span class="hljs-comment"># Register model</span>
ModelRegistry.register_model(<span class="hljs-string">"DeepseekOCRForCausalLM"</span>, DeepseekOCRForCausalLM)
<span class="hljs-comment"># Initialize model</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Loading model..."</span>)
...
<span class="hljs-comment"># Initialize FastAPI app</span>
app = FastAPI(title=<span class="hljs-string">"DeepSeek-OCR API"</span>, version=<span class="hljs-string">"1.0.0"</span>)
...
<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/ocr_batch"</span>, response_model=ResponseData</span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">ocr_batch_inference</span>(<span class="hljs-params">request: RequestData</span>):
    <span class="hljs-string">"""
    Main OCR batch processing endpoint
    Accepts a list of image URLs and/or PDF URLs for OCR processing
    Returns a list of OCR results corresponding to each input document
    Supports both individual image processing and PDF-to-image conversion
    """</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Received request data: <span class="hljs-subst">{request}</span>"</span>)
    <span class="hljs-keyword">try</span>:
        input_data = request.<span class="hljs-built_in">input</span>
        prompt = request.prompt <span class="hljs-comment"># Get the prompt from the request</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> input_data.images <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> input_data.pdfs:
            <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">400</span>, detail=<span class="hljs-string">"Either 'images' or 'pdfs' (or both) must be provided as lists."</span>)
        all_batch_inputs = []
        final_output_parts = []
        <span class="hljs-comment"># Process images if provided</span>
        <span class="hljs-keyword">if</span> input_data.images:
            batch_inputs_images, counts_images = <span class="hljs-keyword">await</span> process_items_async(input_data.images, is_pdf=<span class="hljs-literal">False</span>, prompt=prompt)
            all_batch_inputs.extend(batch_inputs_images)
            final_output_parts.append(counts_images)
        <span class="hljs-comment"># Process PDFs if provided</span>
        <span class="hljs-keyword">if</span> input_data.pdfs:
            batch_inputs_pdfs, counts_pdfs = <span class="hljs-keyword">await</span> process_items_async(input_data.pdfs, is_pdf=<span class="hljs-literal">True</span>, prompt=prompt)
            all_batch_inputs.extend(batch_inputs_pdfs)
            final_output_parts.append(counts_pdfs)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> all_batch_inputs:
             <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">400</span>, detail=<span class="hljs-string">"No valid images or PDF pages were processed from the input URLs."</span>)
        <span class="hljs-comment"># Run inference on the combined batch</span>
        outputs_list = <span class="hljs-keyword">await</span> run_inference(all_batch_inputs)
        <span class="hljs-comment"># Reconstruct final output list based on counts</span>
        final_outputs = []
        output_idx = <span class="hljs-number">0</span>
        <span class="hljs-comment"># Flatten the counts list</span>
        all_counts = [count <span class="hljs-keyword">for</span> sublist <span class="hljs-keyword">in</span> final_output_parts <span class="hljs-keyword">for</span> count <span class="hljs-keyword">in</span> sublist]
        <span class="hljs-keyword">for</span> count <span class="hljs-keyword">in</span> all_counts:
            <span class="hljs-comment"># Get 'count' number of outputs for this input</span>
            input_outputs = outputs_list[output_idx : output_idx + count]
            output_texts = []
            <span class="hljs-keyword">for</span> output <span class="hljs-keyword">in</span> input_outputs:
                content = output.outputs[<span class="hljs-number">0</span>].text
                <span class="hljs-keyword">if</span> <span class="hljs-string">'&lt;｜end▁of▁sentence｜&gt;'</span> <span class="hljs-keyword">in</span> content:
                    content = content.replace(<span class="hljs-string">'&lt;｜end▁of▁sentence｜&gt;'</span>, <span class="hljs-string">''</span>)
                output_texts.append(content)
            <span class="hljs-comment"># Combine pages if it was a multi-page PDF input (or image treated as PDF)</span>
            <span class="hljs-keyword">if</span> count &gt; <span class="hljs-number">1</span>:
                combined_text = <span class="hljs-string">"\n&lt;--- Page Split ---&gt;\n"</span>.join(output_texts)
                final_outputs.append(combined_text)
            <span class="hljs-keyword">else</span>:
                <span class="hljs-comment"># Single image or single-page PDF</span>
                final_outputs.append(output_texts[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> output_texts <span class="hljs-keyword">else</span> <span class="hljs-string">""</span>)
            output_idx += count <span class="hljs-comment"># Move to the next set of outputs</span>
        <span class="hljs-keyword">return</span> ResponseData(output=final_outputs)
    <span class="hljs-keyword">except</span> HTTPException:
        <span class="hljs-keyword">raise</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">500</span>, detail=<span class="hljs-string">f"Internal server error: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
...
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    uvicorn.run(app, host=<span class="hljs-string">"0.0.0.0"</span>, port=<span class="hljs-number">8000</span>, workers=<span class="hljs-number">1</span>)
</code></pre>
<h4 data-id="heading-4">local 测试</h4>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-comment"># 终端启动推理服务</span>
$ python /workspace/DeepSeek-OCR/DeepSeek-OCR-master/DeepSeek-OCR-vllm/server.py
<span class="hljs-comment"># 开启另外一个终端</span>
$ curl -X POST \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d '{
    <span class="hljs-string">"input"</span>: {
      <span class="hljs-string">"pdfs"</span>: [
        <span class="hljs-string">"https://images.devsapp.cn/test/ocr-test.pdf"</span>
      ]
    },
    <span class="hljs-string">"prompt"</span>: <span class="hljs-string">"&lt;image&gt;\nFree OCR."</span>
  }' \
  http://127.0.0.1:8000/ocr_batch
</code></pre>
<p>也可以通过<strong>快速访问</strong> tab 获取代理路径，比如：<code>https://devpod-dbbeddba-ngywxigepn.cn-hangzhou.ide.fc.aliyun.com/proxy/8000/</code>，并通过外部的 Postman 等客户端工具直接调用调试。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bfb08cbdf9c544f8a1e0a5f090410a06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764738658&amp;x-signature=Ar%2FTnuNn85kepP%2FstatEHjf6NKk%3D" alt="图片" loading="lazy"/></p>
<h4 data-id="heading-5">测试 image</h4>
<pre><code class="hljs language-vbnet" lang="vbnet">$ curl -X POST \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-comment">'{</span>
    <span class="hljs-string">"input"</span>: {
      <span class="hljs-string">"images"</span>: [
        <span class="hljs-string">"https://paddle-model-ecology.bj.bcebos.com/paddlex/imgs/demo_image/paddleocr_vl_demo.png"</span>
      ]
    },
    <span class="hljs-string">"prompt"</span>: <span class="hljs-string">"&lt;image&gt;\n&lt;|grounding|&gt;Convert the document to markdown."</span>
  }<span class="hljs-comment">' \</span>
  <span class="hljs-string">"https://devpod-dbbeddba-ngywxigepn.cn-hangzhou.ide.fc.aliyun.com/proxy/8000/ocr_batch"</span>
</code></pre>
<h4 data-id="heading-6">测试 pdf</h4>
<pre><code class="hljs language-vbnet" lang="vbnet">$ curl -X POST \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-comment">'{</span>
    <span class="hljs-string">"input"</span>: {
      <span class="hljs-string">"pdfs"</span>: [
        <span class="hljs-string">"https://images.devsapp.cn/test/ocr-test.pdf"</span>
      ]
    },
    <span class="hljs-string">"prompt"</span>: <span class="hljs-string">"&lt;image&gt;\nFree OCR."</span>
  }<span class="hljs-comment">' \</span>
  <span class="hljs-string">"https://devpod-dbbeddba-ngywxigepn.cn-hangzhou.ide.fc.aliyun.com/proxy/8000/ocr_batch"</span>
</code></pre>
<p>示例：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ffc3fe544b4413db83454dfe3b8fb8b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764738658&amp;x-signature=zqpJ9PRuxzru5Yj9lvW5xKv131o%3D" alt="图片" title="null" loading="lazy"/></p>
<h4 data-id="heading-7">混合</h4>
<pre><code class="hljs language-vbnet" lang="vbnet">$ curl -X POST \
  -H <span class="hljs-string">"Content-Type: application/json"</span> \
  -d <span class="hljs-comment">'{</span>
    <span class="hljs-string">"input"</span>: {
      <span class="hljs-string">"pdfs"</span>: [
        <span class="hljs-string">"https://images.devsapp.cn/test/ocr-test.pdf"</span>
      ],
      <span class="hljs-string">"images"</span>: [
        <span class="hljs-string">"https://paddle-model-ecology.bj.bcebos.com/paddlex/imgs/demo_image/paddleocr_vl_demo.png"</span>
      ]
    },
    <span class="hljs-string">"prompt"</span>: <span class="hljs-string">"&lt;image&gt;\nFree OCR."</span>
  }<span class="hljs-comment">' \</span>
  <span class="hljs-string">"https://devpod-dbbeddba-ngywxigepn.cn-hangzhou.ide.fc.aliyun.com/proxy/8000/ocr_batch"</span>
</code></pre>
<p>DevPod 的优势在于：所有依赖已预装，GPU 资源即开即用，开发者可以专注于算法优化和业务逻辑，而非环境问题。</p>
<h3 data-id="heading-8">2. 服务封装阶段：一键转换为镜像交付物</h3>
<p>当模型在开发环境中验证通过后，下一步是将其封装为镜像交付物。在 FunModel <strong>[</strong> <strong>1]</strong> 的 DevPod 中，这仅需如下操作：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9de909fe4b1140a79d61ac13c8e39bd3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764738658&amp;x-signature=v%2FUUtgORSNnTajh55uvhxEev41Y%3D" alt="图片" title="null" loading="lazy"/></p>
<p>详情请参考 DevPod 镜像构建与 ACR 集成 <strong>[</strong> <strong>2]</strong> 。</p>
<h3 data-id="heading-9">3. 一键部署：从工作区到生产环境</h3>
<p>镜像构建推送完毕后，镜像已经存储到 ACR，此时可以一键部署为 FunModel 模型服务。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95076859cc384b39ad09c66cc452f72f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764738658&amp;x-signature=2Dm%2FPrAncXK%2FuQx4XoPjOiftDjg%3D" alt="图片" title="null" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/438931fb64f64912af8dc3d1820b74b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764738658&amp;x-signature=OwaUxTjjxqLPLAxAAjyNbciW2Rs%3D" alt="图片" title="null" loading="lazy"/></p>
<h3 data-id="heading-10">4. 监控与迭代：闭环的开发运维体验</h3>
<p>部署不是终点。DevPod 与 FunModel 深度集成，提供了完整的监控面板：</p>
<ul>
<li><strong>性能监控：</strong> 实时查看 GPU 利用率、请求延迟、吞吐量</li>
<li><strong>日志分析：</strong> 集中收集所有实例日志，支持关键词检索</li>
<li><strong>变更部署记录：</strong> 每次变更配置（如卡型、扩缩容策略、 timeout 等）的部署都有记录追溯</li>
<li><strong>在线快捷调试：</strong> 快速测试部署后的模型服务</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5cd26f8249454965b3d8d5406c0d8add~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764738658&amp;x-signature=2GU5%2BUIr4E3NY7o8zIOx8PxGPFo%3D" alt="图片" title="null" loading="lazy"/></p>
<p>当需要优化模型或修复问题时，开发者可以：</p>
<ol>
<li>
<p>在监控中发现问题</p>
</li>
<li>
<p>直接打开 DevPod 继续开发调试</p>
</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ce050345739402db39b30bba5820453~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764738658&amp;x-signature=ahR%2BEuK3%2BgjuK251zjO0eKW6TJM%3D" alt="图片" title="null" loading="lazy"/></p>
<ol start="3">
<li>
<p>验证修复方案</p>
</li>
<li>
<p>制作新的镜像，一键部署</p>
</li>
</ol>
<p>整个过程在统一环境中完成，避免了环境不一致导致的问题，真正实现了开发与运维的无缝协作。</p>
<h2 data-id="heading-11">总结</h2>
<p>通过本文的实战演示，我们可以看到 DevPod 不仅解决了“启动难”的问题，更构建了从代码到服务的完整闭环：</p>
<ul>
<li><strong>环境一致性：</strong> 开发、测试、生产环境完全一致，消除“环境漂移”</li>
<li><strong>资源弹性：</strong> 按需分配 GPU 资源，开发时低配，生产时高配</li>
<li><strong>工作流集成：</strong> 无需在多个平台间切换，所有操作在一个工作区完成</li>
<li><strong>部署零学习曲线：</strong> 无需掌握 K8s、Dockerfile 等复杂概念，专注业务价值</li>
</ul>
<h3 data-id="heading-12">DevFlow1：云端开发与部署的无缝闭环</h3>
<p>DevFlow1 描绘了开发者基于 DevPod 实现的高效工作流：</p>
<ol>
<li>
<p>开发者首先启动一个预配置的云端开发环境——已内置所需依赖与 GPU 资源，可即刻进行代码编写与调试。</p>
</li>
<li>
<p>代码修改完成后，无需手动编写 Dockerfile 或管理构建流程，只需一键操作，系统即自动将当前开发环境与代码打包为标准化镜像。</p>
</li>
<li>
<p>该镜像可直接部署为生产级服务，对外提供 API 接口。</p>
</li>
<li>
<p>当需要迭代优化时，开发者可无缝返回开发环境继续修改，再次一键构建并更新线上服务。</p>
</li>
</ol>
<p>整个流程实现了从开发、调试到部署、迭代的全链路自动化，彻底屏蔽了基础设施的复杂性，让开发者真正聚焦于业务逻辑与模型优化本身。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/090bb30ecd354e62911e7c62c142bbe3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764738658&amp;x-signature=ED2d07Etgro6iUE3agwj89rkfSw%3D" alt="图片" title="null" loading="lazy"/></p>
<h3 data-id="heading-13">DevFlow2：面向工程化的开发者工作流</h3>
<p>DevFlow2 适用于熟悉容器化与工程化实践的开发者：</p>
<ol>
<li>
<p>开发者从代码仓库的指定稳定版本（Commit）切入，启动专属开发环境，进行代码迭代、依赖安装及集成测试。</p>
</li>
<li>
<p>一旦测试验证通过且结果符合预期，开发者即可着手准备部署：手动编写或调整 Dockerfile，精确配置镜像构建逻辑，并按需设定函数入口或服务参数。</p>
</li>
<li>
<p>随后，系统依据该 Dockerfile 重建镜像，并执行端到端测试，以确保生产环境中的行为一致性。</p>
</li>
<li>
<p>最终，代码与 Dockerfile 变更一同提交至 Git，完成一次标准、可追溯且可复现的发布流程。</p>
</li>
</ol>
<p>此流程赋予开发者对部署细节的精细控制，契合追求工程规范与长期可维护性的团队需求。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14d42eff8ff84cc8badaa16a27fed154~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764738658&amp;x-signature=bZ4O4i6uqkNBqe9RhokG0EiIzS8%3D" alt="图片" title="null" loading="lazy"/></p>
<p>在阿里云 FunModel 平台，我们正在见证 AI 开发范式的转变：从"先建基础设施，再开发模型"到"先验证想法，再扩展规模"。DevPod 作为这一变革的核心载体，让 AI 开发者真正回归创造本身，而非被工具和环境所束缚。</p>
<h2 data-id="heading-14">了解函数计算模型服务 FunModel</h2>
<p>FunModel 是一个面向 AI 模型开发、部署与运维的全生命周期管理平台。您只需提供模型文件（例如来自 ModelScope、Hugging Face 等社区的模型仓库），即可利用 FunModel 的自动化工具快速完成模型服务的封装与部署，并获得可直接调用的推理 API。平台在设计上旨在提升资源使用效率并简化开发部署流程。</p>
<p>FunModel 依托 Serverless + GPU，天然提供了简单，轻量，0 门槛的模型集成方案，给个人开发者良好的玩转模型的体验，也让企业级开发者快速高效的部署、运维和迭代模型。</p>
<p>在阿里云 FunModel 平台，开发者可以做到：</p>
<ul>
<li><strong>模型的快速部署上线</strong>：从原来的以周为单位的模型接入周期降低到 5 分钟，0 开发，无排期</li>
<li><strong>一键扩缩容，让运维不再是负担</strong>：多种扩缩容策略高度适配业务流量，实现“无痛运维”</li>
</ul>
<h3 data-id="heading-15">技术优势</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b2039e48a874a5da2962c799d156acb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764738658&amp;x-signature=dPvSoJ8d05lIEqsmXnUS5OV3z84%3D" alt="图片" loading="lazy"/></p>
<p>访问模型广场（<a href="https://link.juejin.cn?target=https%3A%2F%2Ffcnext.console.aliyun.com%2Ffun-model%2Fcn-hangzhou%2Ffun-model%2Fmodel-market%25EF%25BC%2589%25E5%25BF%25AB%25E9%2580%259F%25E9%2583%25A8%25E7%25BD%25B2" target="_blank" title="https://fcnext.console.aliyun.com/fun-model/cn-hangzhou/fun-model/model-market%EF%BC%89%E5%BF%AB%E9%80%9F%E9%83%A8%E7%BD%B2" ref="nofollow noopener noreferrer">fcnext.console.aliyun.com/fun-model/c…</a> DeepSeek-OCR。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/66153d65b27c4627ac051cfb81599b48~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5LqR5Y6f55Sf:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764738658&amp;x-signature=9mJFFF99cjUTYjvwrRqJisKVuLw%3D" alt="图片" loading="lazy"/></p>
<p><strong>更多内容请参考：</strong></p>
<ol>
<li>模型服务 FunModel 产品文档</li>
</ol>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Ffunctioncompute%2Ffc%2Fmodel-service-funmodel%2F" target="_blank" title="https://help.aliyun.com/zh/functioncompute/fc/model-service-funmodel/" ref="nofollow noopener noreferrer">help.aliyun.com/zh/function…</a></p>
<ol start="2">
<li>FunModel 快速入门</li>
</ol>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Ffunctioncompute%2Ffc%2Fquick-start" target="_blank" title="https://help.aliyun.com/zh/functioncompute/fc/quick-start" ref="nofollow noopener noreferrer">help.aliyun.com/zh/function…</a></p>
<ol start="3">
<li>FunModel 自定义部署</li>
</ol>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Ffunctioncompute%2Ffc%2Fcustom-model-deployment" target="_blank" title="https://help.aliyun.com/zh/functioncompute/fc/custom-model-deployment" ref="nofollow noopener noreferrer">help.aliyun.com/zh/function…</a></p>
<ol start="4">
<li>FunModel 模型广场</li>
</ol>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ffcnext.console.aliyun.com%2Ffun-model%2Fcn-hangzhou%2Ffun-model%2Fmodel-market" target="_blank" title="https://fcnext.console.aliyun.com/fun-model/cn-hangzhou/fun-model/model-market" ref="nofollow noopener noreferrer">fcnext.console.aliyun.com/fun-model/c…</a></p>
<p><strong>相关链接：</strong></p>
<p>[1] FunModel</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ffcnext.console.aliyun.com%2Ffun-model" target="_blank" title="https://fcnext.console.aliyun.com/fun-model" ref="nofollow noopener noreferrer">fcnext.console.aliyun.com/fun-model</a></p>
<p>[2] DevPod 镜像构建与 ACR 集成</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fhelp.aliyun.com%2Fzh%2Ffunctioncompute%2Ffc%2Fdevpod-development-environment%23491239f1cdujq" target="_blank" title="https://help.aliyun.com/zh/functioncompute/fc/devpod-development-environment#491239f1cdujq" ref="nofollow noopener noreferrer">help.aliyun.com/zh/function…</a></p>
<p><strong>附录</strong></p>
<p><em>完整代码：</em></p>
<blockquote>
<p>/workspace/DeepSeek-OCR/DeepSeek-OCR-master/DeepSeek-OCR-vllm/server.py</p>
</blockquote>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">import</span> io
<span class="hljs-keyword">import</span> torch
<span class="hljs-keyword">import</span> uvicorn
<span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image
<span class="hljs-keyword">from</span> fastapi <span class="hljs-keyword">import</span> FastAPI, HTTPException
<span class="hljs-keyword">from</span> pydantic <span class="hljs-keyword">import</span> BaseModel
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">Optional</span>, <span class="hljs-type">Dict</span>, <span class="hljs-type">Any</span>, <span class="hljs-type">List</span>
<span class="hljs-keyword">import</span> tempfile
<span class="hljs-keyword">import</span> fitz
<span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor
<span class="hljs-keyword">import</span> asyncio
<span class="hljs-comment"># Set environment variables</span>
<span class="hljs-keyword">if</span> torch.version.cuda == <span class="hljs-string">'11.8'</span>:
    os.environ[<span class="hljs-string">"TRITON_PTXAS_PATH"</span>] = <span class="hljs-string">"/usr/local/cuda-11.8/bin/ptxas"</span>
os.environ[<span class="hljs-string">'VLLM_USE_V1'</span>] = <span class="hljs-string">'0'</span>
os.environ[<span class="hljs-string">"CUDA_VISIBLE_DEVICES"</span>] = <span class="hljs-string">'0'</span>
<span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> MODEL_PATH, CROP_MODE, MAX_CONCURRENCY, NUM_WORKERS
<span class="hljs-keyword">from</span> vllm <span class="hljs-keyword">import</span> LLM, SamplingParams
<span class="hljs-keyword">from</span> vllm.model_executor.models.registry <span class="hljs-keyword">import</span> ModelRegistry
<span class="hljs-keyword">from</span> deepseek_ocr <span class="hljs-keyword">import</span> DeepseekOCRForCausalLM
<span class="hljs-keyword">from</span> process.ngram_norepeat <span class="hljs-keyword">import</span> NoRepeatNGramLogitsProcessor
<span class="hljs-keyword">from</span> process.image_process <span class="hljs-keyword">import</span> DeepseekOCRProcessor
<span class="hljs-comment"># Register model</span>
ModelRegistry.register_model(<span class="hljs-string">"DeepseekOCRForCausalLM"</span>, DeepseekOCRForCausalLM)
<span class="hljs-comment"># Initialize model</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Loading model..."</span>)
llm = LLM(
    model=MODEL_PATH,
    hf_overrides={<span class="hljs-string">"architectures"</span>: [<span class="hljs-string">"DeepseekOCRForCausalLM"</span>]},
    block_size=<span class="hljs-number">256</span>,           <span class="hljs-comment"># Memory block size for KV cache</span>
    enforce_eager=<span class="hljs-literal">False</span>,      <span class="hljs-comment"># Use eager mode for better performance with multimodal models</span>
    trust_remote_code=<span class="hljs-literal">True</span>,   <span class="hljs-comment"># Allow execution of code from remote repositories</span>
    max_model_len=<span class="hljs-number">8192</span>,       <span class="hljs-comment"># Maximum sequence length the model can handle</span>
    swap_space=<span class="hljs-number">0</span>,             <span class="hljs-comment"># No swapping to CPU, keeping everything on GPU</span>
    max_num_seqs=<span class="hljs-built_in">max</span>(MAX_CONCURRENCY, <span class="hljs-number">100</span>),  <span class="hljs-comment"># Maximum number of sequences to process concurrently</span>
    tensor_parallel_size=<span class="hljs-number">1</span>,   <span class="hljs-comment"># Number of GPUs for tensor parallelism (1 = single GPU)</span>
    gpu_memory_utilization=<span class="hljs-number">0.9</span>,  <span class="hljs-comment"># Use 90% of GPU memory for model execution</span>
    disable_mm_preprocessor_cache=<span class="hljs-literal">True</span>  <span class="hljs-comment"># Disable cache for multimodal preprocessor to avoid issues</span>
)
<span class="hljs-comment"># Configure sampling parameters</span>
<span class="hljs-comment"># NoRepeatNGramLogitsProcessor prevents repetition in generated text by tracking n-gram patterns</span>
logits_processors = [NoRepeatNGramLogitsProcessor(ngram_size=<span class="hljs-number">20</span>, window_size=<span class="hljs-number">50</span>, whitelist_token_ids={<span class="hljs-number">128821</span>, <span class="hljs-number">128822</span>})]
sampling_params = SamplingParams(
    temperature=<span class="hljs-number">0.0</span>,                    <span class="hljs-comment"># Deterministic output (greedy decoding)</span>
    max_tokens=<span class="hljs-number">8192</span>,                    <span class="hljs-comment"># Maximum number of tokens to generate</span>
    logits_processors=logits_processors, <span class="hljs-comment"># Apply the processor to avoid repetitive text</span>
    skip_special_tokens=<span class="hljs-literal">False</span>,          <span class="hljs-comment"># Include special tokens in the output</span>
    include_stop_str_in_output=<span class="hljs-literal">True</span>,    <span class="hljs-comment"># Include stop strings in the output</span>
)
<span class="hljs-comment"># Initialize FastAPI app</span>
app = FastAPI(title=<span class="hljs-string">"DeepSeek-OCR API"</span>, version=<span class="hljs-string">"1.0.0"</span>)
<span class="hljs-keyword">class</span> <span class="hljs-title class_">InputData</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""
    Input data model to define what types of documents to process
    images: Optional list of image URLs to process
    pdfs: Optional list of PDF URLs to process
    Note: At least one of these fields must be provided in a request
    """</span>
    images: <span class="hljs-type">Optional</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]] = <span class="hljs-literal">None</span>
    pdfs: <span class="hljs-type">Optional</span>[<span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]] = <span class="hljs-literal">None</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestData</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""
    Main request model that defines the input data and optional prompt
    """</span>
    <span class="hljs-built_in">input</span>: InputData
    <span class="hljs-comment"># Add prompt as an optional field with a default value</span>
    prompt: <span class="hljs-built_in">str</span> = <span class="hljs-string">'&lt;image&gt;\nFree OCR.'</span> <span class="hljs-comment"># Default prompt</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ResponseData</span>(<span class="hljs-title class_ inherited__">BaseModel</span>):
    <span class="hljs-string">"""
    Response model that returns OCR results for each input document
    """</span>
    output: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>]
<span class="hljs-keyword">def</span> <span class="hljs-title function_">download_file</span>(<span class="hljs-params">url: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">bytes</span>:
    <span class="hljs-string">"""Download file from URL"""</span>
    <span class="hljs-keyword">try</span>:
        response = requests.get(url, timeout=<span class="hljs-number">30</span>)
        response.raise_for_status()
        <span class="hljs-keyword">return</span> response.content
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">400</span>, detail=<span class="hljs-string">f"Failed to download file from URL: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
<span class="hljs-keyword">def</span> <span class="hljs-title function_">is_pdf_file</span>(<span class="hljs-params">content: <span class="hljs-built_in">bytes</span></span>) -&gt; <span class="hljs-built_in">bool</span>:
    <span class="hljs-string">"""Check if the content is a PDF file"""</span>
    <span class="hljs-keyword">return</span> content.startswith(<span class="hljs-string">b'%PDF'</span>)
<span class="hljs-keyword">def</span> <span class="hljs-title function_">load_image_from_bytes</span>(<span class="hljs-params">image_bytes: <span class="hljs-built_in">bytes</span></span>) -&gt; Image.Image:
    <span class="hljs-string">"""Load image from bytes"""</span>
    <span class="hljs-keyword">try</span>:
        image = Image.<span class="hljs-built_in">open</span>(io.BytesIO(image_bytes))
        <span class="hljs-keyword">return</span> image.convert(<span class="hljs-string">'RGB'</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">400</span>, detail=<span class="hljs-string">f"Failed to load image: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
<span class="hljs-keyword">def</span> <span class="hljs-title function_">pdf_to_images</span>(<span class="hljs-params">pdf_bytes: <span class="hljs-built_in">bytes</span>, dpi: <span class="hljs-built_in">int</span> = <span class="hljs-number">144</span></span>) -&gt; <span class="hljs-built_in">list</span>:
    <span class="hljs-string">"""Convert PDF to images"""</span>
    <span class="hljs-keyword">try</span>:
        images = []
        pdf_document = fitz.<span class="hljs-built_in">open</span>(stream=pdf_bytes, filetype=<span class="hljs-string">"pdf"</span>)
        zoom = dpi / <span class="hljs-number">72.0</span>
        matrix = fitz.Matrix(zoom, zoom)
        <span class="hljs-keyword">for</span> page_num <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(pdf_document.page_count):
            page = pdf_document[page_num]
            pixmap = page.get_pixmap(matrix=matrix, alpha=<span class="hljs-literal">False</span>)
            img_data = pixmap.tobytes(<span class="hljs-string">"png"</span>)
            img = Image.<span class="hljs-built_in">open</span>(io.BytesIO(img_data))
            images.append(img.convert(<span class="hljs-string">'RGB'</span>))
        pdf_document.close()
        <span class="hljs-keyword">return</span> images
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">400</span>, detail=<span class="hljs-string">f"Failed to convert PDF to images: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
<span class="hljs-keyword">def</span> <span class="hljs-title function_">process_single_image_sync</span>(<span class="hljs-params">image: Image.Image, prompt: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-type">Dict</span>: <span class="hljs-comment"># Renamed and made sync</span>
    <span class="hljs-string">"""Process a single image (synchronous function for CPU-bound work)"""</span>
    <span class="hljs-keyword">try</span>:
        cache_item = {
            <span class="hljs-string">"prompt"</span>: prompt,
            <span class="hljs-string">"multi_modal_data"</span>: {
                <span class="hljs-string">"image"</span>: DeepseekOCRProcessor().tokenize_with_images(
                    images=[image],
                    bos=<span class="hljs-literal">True</span>,
                    eos=<span class="hljs-literal">True</span>,
                    cropping=CROP_MODE
                )
            },
        }
        <span class="hljs-keyword">return</span> cache_item
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">500</span>, detail=<span class="hljs-string">f"Failed to process image: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">process_items_async</span>(<span class="hljs-params">items_urls: <span class="hljs-type">List</span>[<span class="hljs-built_in">str</span>], is_pdf: <span class="hljs-built_in">bool</span>, prompt: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">tuple</span>[<span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>], <span class="hljs-type">List</span>[<span class="hljs-built_in">int</span>]]:
    <span class="hljs-string">"""
    Process a list of image or PDF URLs asynchronously.
    Downloads files concurrently, then processes images/PDF pages in a thread pool.
    Returns a tuple: (batch_inputs, num_results_per_input)
    """</span>
    loop = asyncio.get_event_loop()
    <span class="hljs-comment"># 1. Download all files concurrently</span>
    download_tasks = [loop.run_in_executor(<span class="hljs-literal">None</span>, download_file, url) <span class="hljs-keyword">for</span> url <span class="hljs-keyword">in</span> items_urls]
    contents = <span class="hljs-keyword">await</span> asyncio.gather(*download_tasks)
    <span class="hljs-comment"># 2. Prepare arguments for processing (determine if PDF/image, count pages)</span>
    processing_args = []
    num_results_per_input = []
    <span class="hljs-keyword">for</span> idx, (url, content) <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(<span class="hljs-built_in">zip</span>(items_urls, contents)):
        <span class="hljs-keyword">if</span> is_pdf:
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> is_pdf_file(content):
                 <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">400</span>, detail=<span class="hljs-string">f"Provided file is not a PDF: <span class="hljs-subst">{url}</span>"</span>)
            images = pdf_to_images(content)
            num_pages = <span class="hljs-built_in">len</span>(images)
            num_results_per_input.append(num_pages)
            <span class="hljs-comment"># Each page will be processed separately</span>
            processing_args.extend([(img, prompt) <span class="hljs-keyword">for</span> img <span class="hljs-keyword">in</span> images])
        <span class="hljs-keyword">else</span>: <span class="hljs-comment"># is image</span>
            <span class="hljs-keyword">if</span> is_pdf_file(content):
                <span class="hljs-comment"># Handle case where an image URL accidentally points to a PDF</span>
                images = pdf_to_images(content)
                num_pages = <span class="hljs-built_in">len</span>(images)
                num_results_per_input.append(num_pages)
                processing_args.extend([(img, prompt) <span class="hljs-keyword">for</span> img <span class="hljs-keyword">in</span> images])
            <span class="hljs-keyword">else</span>:
                image = load_image_from_bytes(content)
                num_results_per_input.append(<span class="hljs-number">1</span>)
                processing_args.append((image, prompt))
    <span class="hljs-comment"># 3. Process images/PDF pages in parallel using ThreadPoolExecutor</span>
    <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=NUM_WORKERS) <span class="hljs-keyword">as</span> executor:
        <span class="hljs-comment"># Submit all processing tasks</span>
        process_tasks = [
            loop.run_in_executor(executor, process_single_image_sync, img, prompt)
            <span class="hljs-keyword">for</span> img, prompt <span class="hljs-keyword">in</span> processing_args
        ]
        <span class="hljs-comment"># Wait for all to complete</span>
        processed_results = <span class="hljs-keyword">await</span> asyncio.gather(*process_tasks)
    <span class="hljs-keyword">return</span> processed_results, num_results_per_input
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">run_inference</span>(<span class="hljs-params">batch_inputs: <span class="hljs-type">List</span>[<span class="hljs-type">Dict</span>]</span>) -&gt; <span class="hljs-type">List</span>:
    <span class="hljs-string">"""Run inference on batch inputs"""</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> batch_inputs:
        <span class="hljs-keyword">return</span> []
    <span class="hljs-keyword">try</span>:
        <span class="hljs-comment"># Run inference on the entire batch</span>
        outputs_list = llm.generate(
            batch_inputs,
            sampling_params=sampling_params
        )
        <span class="hljs-keyword">return</span> outputs_list
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">500</span>, detail=<span class="hljs-string">f"Failed to run inference: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
<span class="hljs-meta">@app.post(<span class="hljs-params"><span class="hljs-string">"/ocr_batch"</span>, response_model=ResponseData</span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">ocr_batch_inference</span>(<span class="hljs-params">request: RequestData</span>):
    <span class="hljs-string">"""
    Main OCR batch processing endpoint
    Accepts a list of image URLs and/or PDF URLs for OCR processing
    Returns a list of OCR results corresponding to each input document
    Supports both individual image processing and PDF-to-image conversion
    """</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Received request data: <span class="hljs-subst">{request}</span>"</span>)
    <span class="hljs-keyword">try</span>:
        input_data = request.<span class="hljs-built_in">input</span>
        prompt = request.prompt <span class="hljs-comment"># Get the prompt from the request</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> input_data.images <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> input_data.pdfs:
            <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">400</span>, detail=<span class="hljs-string">"Either 'images' or 'pdfs' (or both) must be provided as lists."</span>)
        all_batch_inputs = []
        final_output_parts = []
        <span class="hljs-comment"># Process images if provided</span>
        <span class="hljs-keyword">if</span> input_data.images:
            batch_inputs_images, counts_images = <span class="hljs-keyword">await</span> process_items_async(input_data.images, is_pdf=<span class="hljs-literal">False</span>, prompt=prompt)
            all_batch_inputs.extend(batch_inputs_images)
            final_output_parts.append(counts_images)
        <span class="hljs-comment"># Process PDFs if provided</span>
        <span class="hljs-keyword">if</span> input_data.pdfs:
            batch_inputs_pdfs, counts_pdfs = <span class="hljs-keyword">await</span> process_items_async(input_data.pdfs, is_pdf=<span class="hljs-literal">True</span>, prompt=prompt)
            all_batch_inputs.extend(batch_inputs_pdfs)
            final_output_parts.append(counts_pdfs)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> all_batch_inputs:
             <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">400</span>, detail=<span class="hljs-string">"No valid images or PDF pages were processed from the input URLs."</span>)
        <span class="hljs-comment"># Run inference on the combined batch</span>
        outputs_list = <span class="hljs-keyword">await</span> run_inference(all_batch_inputs)
        <span class="hljs-comment"># Reconstruct final output list based on counts</span>
        final_outputs = []
        output_idx = <span class="hljs-number">0</span>
        <span class="hljs-comment"># Flatten the counts list</span>
        all_counts = [count <span class="hljs-keyword">for</span> sublist <span class="hljs-keyword">in</span> final_output_parts <span class="hljs-keyword">for</span> count <span class="hljs-keyword">in</span> sublist]
        <span class="hljs-keyword">for</span> count <span class="hljs-keyword">in</span> all_counts:
            <span class="hljs-comment"># Get 'count' number of outputs for this input</span>
            input_outputs = outputs_list[output_idx : output_idx + count]
            output_texts = []
            <span class="hljs-keyword">for</span> output <span class="hljs-keyword">in</span> input_outputs:
                content = output.outputs[<span class="hljs-number">0</span>].text
                <span class="hljs-keyword">if</span> <span class="hljs-string">'&lt;｜end▁of▁sentence｜&gt;'</span> <span class="hljs-keyword">in</span> content:
                    content = content.replace(<span class="hljs-string">'&lt;｜end▁of▁sentence｜&gt;'</span>, <span class="hljs-string">''</span>)
                output_texts.append(content)
            <span class="hljs-comment"># Combine pages if it was a multi-page PDF input (or image treated as PDF)</span>
            <span class="hljs-keyword">if</span> count &gt; <span class="hljs-number">1</span>:
                combined_text = <span class="hljs-string">"\n&lt;--- Page Split ---&gt;\n"</span>.join(output_texts)
                final_outputs.append(combined_text)
            <span class="hljs-keyword">else</span>:
                <span class="hljs-comment"># Single image or single-page PDF</span>
                final_outputs.append(output_texts[<span class="hljs-number">0</span>] <span class="hljs-keyword">if</span> output_texts <span class="hljs-keyword">else</span> <span class="hljs-string">""</span>)
            output_idx += count <span class="hljs-comment"># Move to the next set of outputs</span>
        <span class="hljs-keyword">return</span> ResponseData(output=final_outputs)
    <span class="hljs-keyword">except</span> HTTPException:
        <span class="hljs-keyword">raise</span>
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">raise</span> HTTPException(status_code=<span class="hljs-number">500</span>, detail=<span class="hljs-string">f"Internal server error: <span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)}</span>"</span>)
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/health"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">health_check</span>():
    <span class="hljs-string">"""Health check endpoint"""</span>
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"status"</span>: <span class="hljs-string">"healthy"</span>}
<span class="hljs-meta">@app.get(<span class="hljs-params"><span class="hljs-string">"/"</span></span>)</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">root</span>():
    <span class="hljs-string">"""Root endpoint"""</span>
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"message"</span>: <span class="hljs-string">"DeepSeek-OCR API is running (Batch endpoint available at /ocr_batch)"</span>}
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    uvicorn.run(app, host=<span class="hljs-string">"0.0.0.0"</span>, port=<span class="hljs-number">8000</span>, workers=<span class="hljs-number">1</span>)
</code></pre>
<p>点击<a href="https://link.juejin.cn?target=https%3A%2F%2Ffcnext.console.aliyun.com%2Ffun-model%2Fcn-hangzhou%2Ffun-model%2Fmodel-market" target="_blank" title="https://fcnext.console.aliyun.com/fun-model/cn-hangzhou/fun-model/model-market" ref="nofollow noopener noreferrer">此次</a>，进入 FunModel 模型广场。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Data JPA 最佳实践【2/2】：存储库设计指南]]></title>    <link>https://juejin.cn/post/7576669556150091814</link>    <guid>https://juejin.cn/post/7576669556150091814</guid>    <pubDate>2025-11-26T05:32:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576669556150091814" data-draft-id="7576669556150075430" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Data JPA 最佳实践【2/2】：存储库设计指南"/> <meta itemprop="keywords" content="Hibernate"/> <meta itemprop="datePublished" content="2025-11-26T05:32:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="信码由缰"/> <meta itemprop="url" content="https://juejin.cn/user/2110664941509214"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Data JPA 最佳实践【2/2】：存储库设计指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2110664941509214/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    信码由缰
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T05:32:50.000Z" title="Wed Nov 26 2025 05:32:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://cf-blog.icodebuddy.com/image/93/93-0.png" alt="" loading="lazy"/></p>
<p><strong>Spring Data JPA（系列文章共 2 篇）</strong></p>
<ol>
<li>
<p>Spring Data JPA 最佳实践【1/2】：实体设计指南</p>
</li>
<li>
<p>Spring Data JPA 最佳实践【2/2】：存储库设计指南</p>
</li>
</ol>
<blockquote>
<p>在本系列文章中，我将分享我对重构一个采用了大量不良实践的大型遗留代码库的看法。为了解决这些问题并开发出更好的 Spring Data JPA 存储库，我撰写了这份指南，旨在向我之前的同事们推广良好的开发实践。本指南已更新并完全重写，以利用 Spring Data JPA 的最新特性。</p>
</blockquote>
<p>有些例子可能看起来显而易见，但事实并非如此。这只是从你经验丰富的角度来看的。它们都是来自生产代码库的真实案例。</p>
<p>请记住，本系列文章讲解的是最新版本的 Spring Data JPA，因此可能会有一些我特别指出的细微差别。</p>
<h2 data-id="heading-0">1 设计 Spring Data JPA 存储库</h2>
<p>Spring Data JPA 提供了几个带有预定义数据获取方法的存储库接口。我这里只提几个值得关注的：</p>
<ul>
<li>
<p><code>Repository&lt;T, ID&gt;</code> 接口是 Spring Data 接口的父接口，是一个用于发现的标记接口。它没有任何方法。使用时，你只需定义你所需的内容。</p>
</li>
<li>
<p><code>CrudRepository</code> 接口添加了基本的 CRUD 方法以加快开发速度，它的孪生接口 <code>ListCrudRepository</code> 功能相同，但返回 <code>List</code> 而不是 <code>Iterable</code>。</p>
</li>
<li>
<p><code>PagingAndSortingRepository</code> 仅添加了分页和排序功能，它也有一个返回 <code>List</code> 的孪生接口。猜猜它叫什么？等等，你说对了！</p>
</li>
<li>
<p><code>JpaRepository</code> 是我的最爱，它包含了所有返回 <code>List</code> 的先前接口。大多数时候，我只使用这个接口。</p>
</li>
</ul>
<p>你应该在何时使用 <code>Repository</code>、<code>JpaRepository</code> 或者介于两者之间的接口呢？我认为，如果你需要为其他开发者提供严格的 API，可以从 <code>Repository</code> 扩展并仅实现必要的操作，而不是授予访问全部 CRUD 操作的权限，这可能会损害你的业务逻辑。在你没有访问限制并且希望快速开发的情况下，请使用 <code>JpaRepository</code>。</p>
<p>关于 API 限制的例子：有时你可能需要处理存储在数据库中的逻辑。这涉及到大量的存储过程、逻辑中的细微差别等等。作为开发者，在处理表实体时应格外小心，因为这可能导致不可预测的行为。因此，在这种情况下，你只应设计 JPA 实体，并仅实现一个包含指定查询方法的空接口。通过这种方法，你是在向其他开发者强调，他们应该实现你所需的方法，而不是直接操作原始实体。</p>
<p>实际上，Spring Data JPA 存储库还有一个有趣的特点。你从 <code>CrudRepository</code>/<code>JpaRepository</code> 继承的方法默认是事务性的：读取操作使用 <code>@Transactional(readOnly = true)</code>，写入操作使用常规的 <code>@Transactional</code>。</p>
<p>你通常不需要在接口上使用 Spring Framework 的 <code>@Repository</code> 注解（不要与 JPA 的接口混淆）——发现是自动的。对于可重用的基类接口，请使用 <code>@NoRepositoryBean</code> 注解。</p>
<p>扩展这些接口之一会告知 Spring Data JPA 它应该为你的接口生成一个实现。例如：</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CompanyRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaRepository</span>&lt;Company, Long&gt; {

<span class="hljs-comment">// 自定义方法将添加在这里</span>

}

</code></pre>
<h2 data-id="heading-1">2 在存储库中使用查询</h2>
<p>使用 Spring Data JPA 存储库查询数据主要有两种方法。实际上不止两种，但我们先关注更流行的（依我看来）。</p>
<ul>
<li>
<p><strong>从方法名派生查询</strong>。Spring 解析方法名并生成相应的 JPQL。这加快了开发速度，并且对于简单条件来说很直观。</p>
</li>
<li>
<p><strong>使用 <code>@Query</code> 注解显式编写查询</strong>。这种方法更灵活，允许你使用 JPQL 或原生 SQL。在最新版本的 Spring Data 中，你可以使用 <code>@NativeQuery</code> 注解来代替传递 <code>nativeQuery = true</code>。</p>
</li>
</ul>
<p>对于数据修改查询（UPDATE/DELETE），需要添加 <code>@Modifying</code>，并确保存在事务边界——要么在存储库方法或类上使用 <code>@Transactional</code> 注解，要么从 <code>@Transactional</code> 服务中调用它。</p>
<p>使用两种方法的示例：</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">// 派生查询</span>

List&lt;Employee&gt; <span class="hljs-title function_">findByDepartmentIdAndActiveTrue</span><span class="hljs-params">(Long departmentId)</span>;

  


<span class="hljs-comment">// 显式 JPQL 查询</span>

<span class="hljs-meta">@Query("SELECT e FROM Employee e WHERE e.department.id = :deptId AND e.active = true")</span>

List&lt;Employee&gt; <span class="hljs-title function_">findActiveEmployees</span><span class="hljs-params">(<span class="hljs-meta">@Param("deptId")</span> Long departmentId)</span>;

  


<span class="hljs-comment">// 原生 SQL 查询</span>

<span class="hljs-meta">@Modifying</span>

<span class="hljs-meta">@Transactional</span>

<span class="hljs-meta">@NativeQuery(value = "UPDATE employee SET active = false WHERE id = :id")</span>

<span class="hljs-keyword">void</span> <span class="hljs-title function_">deactivateEmployee</span><span class="hljs-params">(<span class="hljs-meta">@Param("id")</span> Long id)</span>;

</code></pre>
<p>在上面的例子中，前两个方法是选择查询。最后一个是更新（停用）操作，其目的与选择查询不同。</p>
<p>第一种方法缩短了开发查询所需的时间并且很直观。第二个例子在创建用于操作数据库的方法时提供了额外的能力，允许你使用 JPQL 和原生 SQL 编写查询。</p>
<p>如前所述，继承的数据修改方法默认标记为 <code>@Transactional</code>。对于自定义的修改查询，请使用 <code>@Modifying</code> 注解，并确保存在事务边界（在方法或类上，或在服务层）。</p>
<h2 data-id="heading-2">3 Spring Data JPA 投影</h2>
<p>对来自数据库的原始实体进行操作可能不切实际或不安全。在应用程序中检索完整实体并进行操作或许可以接受，但更好的做法是调整你的查询，使其仅返回必要的信息。</p>
<p>为了解决这个问题，你应该利用 Spring Data JPA 投影，它能够定义数据库中的数据将如何呈现。在上面描述的示例中，Spring Data JPA 投影仅返回调用者所需的选定属性。</p>
<p>Spring Data JPA 提供以下类型的投影：</p>
<ul>
<li>
<p>通过接口定义的投影，也称为<strong>基于接口的投影</strong></p>
</li>
<li>
<p>到 <strong>DTO 对象</strong>的投影。请阅读关于 Spring Data JPA 的系列文章中关于开发 DTO 的指南。</p>
</li>
<li>
<p><strong>动态投影</strong>。</p>
</li>
</ul>
<p><strong>基于接口的投影</strong>允许你创建只读投影，以便安全地呈现来自数据库的数据。这种方法通常在不需要操作创建的对象，而仅用于显示数据时使用。请注意，访问嵌套属性可能导致连接和额外的查询，因此投影并不总是比获取实体快。务必检查生成的 SQL 以确保最佳性能。</p>
<p>例如，一个基于接口的 Spring Data JPA 投影：</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">EmployeeView</span> {

String <span class="hljs-title function_">getFirstName</span><span class="hljs-params">()</span>;

String <span class="hljs-title function_">getLastName</span><span class="hljs-params">()</span>;

BigDecimal <span class="hljs-title function_">getSalary</span><span class="hljs-params">()</span>;

}

  


List&lt;EmployeeView&gt; <span class="hljs-title function_">findBySalaryGreaterThan</span><span class="hljs-params">(BigDecimal amount)</span>;

</code></pre>
<p><strong>基于 DTO 的投影</strong>允许将数据投影到 Java 类上，使你可以使用具体的 DTO 对象而不是接口。对于派生的查询方法，Spring 可以通过其构造函数将结果映射到 DTO，而对于 <code>@Query</code> JPQL，则需要使用构造函数表达式。基于类的投影需要一个单一的全参数构造函数；如果有多个构造函数，请使用 <code>@PersistenceCreator</code> 注解标记目标构造函数。</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmployeeDto</span> {

<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String firstName;

<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String lastName;

<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> BigDecimal salary;

<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getFirstName</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> firstName; }

<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getLastName</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> lastName; }

<span class="hljs-keyword">public</span> BigDecimal <span class="hljs-title function_">getSalary</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> salary; }

  


<span class="hljs-keyword">public</span> <span class="hljs-title function_">EmployeeDto</span><span class="hljs-params">(String firstName, String lastName, BigDecimal salary)</span> {

<span class="hljs-built_in">this</span>.firstName = firstName;

<span class="hljs-built_in">this</span>.lastName = lastName;

<span class="hljs-built_in">this</span>.salary = salary;

}

}

  


<span class="hljs-meta">@Query("SELECT new com.example.EmployeeDto(e.firstName, e.lastName, e.salary) FROM Employee e WHERE e.salary &gt; :amount")</span>

List&lt;EmployeeDto&gt; <span class="hljs-title function_">findHighEarningEmployees</span><span class="hljs-params">(<span class="hljs-meta">@Param("amount")</span> BigDecimal amount)</span>;

</code></pre>
<p><strong>你可以将动态投影</strong>与存储库一起使用，以公开一个通用方法，允许调用者在运行时选择投影类型。<code>Class</code> 参数用于选择投影类型。如果你需要将 <code>Class</code> 传递到查询本身中，请使用不同的参数，以免它被用作投影选择器。</p>
<p>当将 DTO 类与动态投影一起使用时，请确保查询提供了构造函数参数（例如，通过 JPQL 构造函数表达式）；否则，调用将在运行时失败。</p>
<pre><code class="hljs language-java" lang="java">
&lt;T&gt; List&lt;T&gt; <span class="hljs-title function_">findBySalaryGreaterThan</span><span class="hljs-params">(BigDecimal amount, Class&lt;T&gt; type)</span>;

  


<span class="hljs-comment">// 用法：</span>

  


repo.findBySalaryGreaterThan(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"1000"</span>), EmployeeView.class); <span class="hljs-comment">// 接口投影</span>

  


repo.findBySalaryGreaterThan(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"1000"</span>), EmployeeDto.class); <span class="hljs-comment">// DTO 类投影（需要查询支持）</span>

</code></pre>
<h2 data-id="heading-3">4 有效使用存储库方法</h2>
<p>如前所述，存储库 CRUD 方法默认在事务中运行（读取操作为 <code>readOnly = true</code>，写入操作为常规事务）。关于事务的另一点是避免在调用点手动开启事务。</p>
<p>当对多个实体执行操作时，优先使用批量方法，如 <code>saveAll()</code>，而不是在循环中调用 <code>save()</code>。将操作分组到单个查询中可以减少数据库的往返次数。</p>
<p>优先使用面向批量的写入，但请注意 <code>saveAll()</code> 本身并不会发出单个 SQL 语句。为了实际减少往返次数，需要启用 JDBC 批处理（例如，设置 <code>spring.jpa.properties.hibernate.jdbc.batch_size=50</code>，并且通常设置 <code>hibernate.order_inserts=true</code>/<code>hibernate.order_updates=true</code>）。如果需要插入批处理，请避免使用 <code>GenerationType.IDENTITY</code>，对于非常大的批次，请定期调用 <code>flush()</code>/<code>clear()</code>。</p>
<p>只要可能，将逻辑合并到单个查询中，而不是在 Java 中执行多个查询。在某些情况下，使用 SQL 将部分算法卸载到数据库更高效。</p>
<p>对于大型结果集，使用分页。<code>Page&lt;T&gt;</code> 返回内容加总数，并触发计数查询（对于自定义的 <code>@Query</code>，需要提供 <code>countQuery</code>），<code>Slice&lt;T&gt;</code> 返回内容以及是否有下一个分片（不进行计数查询），而带有 <code>Pageable</code> 参数的 <code>List&lt;T&gt;</code> 应用 limit/offset 但不提供元数据。</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-comment">// 1) 带有 Page 和排序的派生查询</span>

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaRepository</span>&lt;User, Long&gt; {

Page&lt;User&gt; <span class="hljs-title function_">findByActive</span><span class="hljs-params">(<span class="hljs-type">boolean</span> active, Pageable pageable)</span>;

}

  


<span class="hljs-comment">// 用法：</span>

<span class="hljs-type">Pageable</span> <span class="hljs-variable">pageable</span> <span class="hljs-operator">=</span> PageRequest.of(<span class="hljs-number">0</span>, <span class="hljs-number">20</span>, Sort.by(<span class="hljs-string">"createdAt"</span>).descending());

Page&lt;User&gt; page = userRepository.findByActive(<span class="hljs-literal">true</span>, pageable);

List&lt;User&gt; users = page.getContent();

<span class="hljs-type">long</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> page.getTotalElements();

<span class="hljs-type">boolean</span> <span class="hljs-variable">last</span> <span class="hljs-operator">=</span> page.isLast();

  


<span class="hljs-comment">// 2) 使用 Slice 进行无限滚动（无计数查询）</span>

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaRepository</span>&lt;User, Long&gt; {

Slice&lt;User&gt; <span class="hljs-title function_">findByActive</span><span class="hljs-params">(<span class="hljs-type">boolean</span> active, Pageable pageable)</span>;

}

</code></pre>
<h2 data-id="heading-4">5 存储库中的存储过程</h2>
<p>在开发面向数据库的应用程序时，你可以使用 Spring Data JPA 调用数据库中定义的存储过程。有多种方法可以实现。</p>
<p>第一种方法是使用 <code>@NamedStoredProcedureQuery</code>：</p>
<ul>
<li>
<p>在实体上使用 <code>@NamedStoredProcedureQuery</code> 声明它，指定：</p>
</li>
<li>
<p><code>name</code> – JPA 使用的标识符，</p>
</li>
<li>
<p><code>procedureName</code> – 数据库中存储过程的实际名称，</p>
</li>
<li>
<p><code>parameters</code> – <code>@StoredProcedureParameter</code> 对象数组，定义每个参数的模式（IN/OUT）、名称和 Java 类型。</p>
</li>
<li>
<p>在存储库中添加一个方法，并使用 <code>@Procedure</code> 注解，引用声明的名称。</p>
</li>
</ul>
<p>对于多个输出参数，当调用由 <code>@NamedStoredProcedureQuery</code> 支持时，Spring Data JPA 可以返回一个 <code>Map&lt;String,Object&gt;</code>。对于单个输出，可以直接返回该值。<code>@Procedure</code> 上还有一个 <code>outputParameterName</code> 属性用于定位特定的输出参数。</p>
<p>在实体上的声明示例：</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-meta">@NamedStoredProcedureQuery(

name = "Employee.raiseSalary",

procedureName = "raise_employee_salary",

parameters = {

@StoredProcedureParameter(mode = ParameterMode.IN, name = "in_employee_id", type = Long.class),

@StoredProcedureParameter(mode = ParameterMode.IN, name = "in_increase", type = BigDecimal.class),

@StoredProcedureParameter(mode = ParameterMode.OUT, name = "out_new_salary", type = BigDecimal.class)

}

)</span>

<span class="hljs-meta">@Entity</span>

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Employee</span> { … }

</code></pre>
<p>存储库方法：</p>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-meta">@Procedure(name = "Employee.raiseSalary")</span>

BigDecimal <span class="hljs-title function_">raiseSalary</span><span class="hljs-params">(<span class="hljs-meta">@Param("in_employee_id")</span> Long id,

<span class="hljs-meta">@Param("in_increase")</span> BigDecimal increase)</span>;

</code></pre>
<p>第二种方法是不定义 JPA 元数据，直接在存储库方法上使用 <code>@Procedure(procedureName = "…")</code>，甚至通过 <code>@Query(value = "CALL proc(:arg…)", nativeQuery = true)</code> 来调用。</p>
<p>实际上，还有一种方法，但不太规范，就是使用实体管理器调用存储过程，本文不会涵盖这种做法，因为它将在本系列的下一篇文章（也是最后一篇）中讨论。</p>
<h2 data-id="heading-5">6 Spring Data JPA 存储库速查表</h2>
<p>为了简要总结本设计指南，你可以使用以下速查表。</p>
<h3 data-id="heading-6">6.1 选择哪种 Spring Data JPA 存储库？</h3>
<p><strong>要扩展的接口</strong></p>
<ul>
<li>
<p><code>Repository&lt;T, ID&gt;</code> — 仅作为标记；你需要自己定义每个方法。</p>
</li>
<li>
<p><code>CrudRepository&lt;T, ID&gt;</code> — 基本 CRUD；返回 <code>Iterable</code> 集合。</p>
</li>
<li>
<p><code>ListCrudRepository&lt;T, ID&gt;</code> — 类似 <code>CrudRepository</code>，但返回 <code>List</code> 集合。</p>
</li>
<li>
<p><code>PagingAndSortingRepository&lt;T, ID&gt;</code> — 添加分页和排序。</p>
</li>
<li>
<p><code>ListPagingAndSortingRepository&lt;T, ID&gt;</code> — 返回 <code>List</code> 的孪生接口。</p>
</li>
<li>
<p><code>JpaRepository&lt;T, ID&gt;</code> — 包含以上所有功能 + JPA 的便利功能（flush、批量删除等）。大多数应用程序中的默认选择。</p>
</li>
</ul>
<p><strong>何时选择哪个</strong></p>
<ul>
<li>
<p>需要严格、最小化的 API？扩展 <code>Repository</code>（或一个精简的基类）并仅暴露允许的方法。</p>
</li>
<li>
<p>需要开发速度？扩展 <code>JpaRepository</code>。</p>
</li>
</ul>
<p><strong>发现与基础配置</strong></p>
<ul>
<li>
<p>存储库接口上不需要 <code>@Repository</code>；Spring 通过类型检测它们。</p>
</li>
<li>
<p>对于可重用的基类接口，使用 <code>@NoRepositoryBean</code> 注解。</p>
</li>
<li>
<p>默认实现由 <code>SimpleJpaRepository</code> 支持。</p>
</li>
</ul>
<p><strong>事务（默认）</strong></p>
<ul>
<li>
<p>默认值适用于继承的 CRUD 方法：读取使用 <code>@Transactional(readOnly = true)</code>，写入使用常规 <code>@Transactional</code>。</p>
</li>
<li>
<p>你自己的查询方法（派生名称或 <code>@Query</code>）默认不是事务性的；需要注解它们或从事务性服务中调用。</p>
</li>
</ul>
<h3 data-id="heading-7">6.2 如何使用 Spring Data JPA 查询数据？</h3>
<p><strong>两种核心方法</strong></p>
<ul>
<li>
<p><strong>派生查询</strong>（通过方法名）适用于简单条件。</p>
</li>
<li>
<p><strong>显式查询</strong> 使用 <code>@Query</code>（JPQL）或通过 <code>@Query(..., nativeQuery = true)</code> 或 <code>@NativeQuery</code>（现代快捷方式；支持如 <code>sqlResultSetMapping</code> 等额外功能）进行的原生查询。</p>
</li>
</ul>
<p><strong>修改查询</strong></p>
<ul>
<li>
<p>添加 <code>@Modifying</code> 并确保存在事务边界（在方法/类上使用 <code>@Transactional</code> 或从事务性服务中调用）。</p>
</li>
</ul>
<p><strong>使用自定义查询进行分页</strong></p>
<ul>
<li>
<p>对于 <code>Page&lt;T&gt;</code> 和复杂的 JPQL/原生查询，提供一个显式的 <code>countQuery</code>（或 <code>countProjection</code>）以避免脆弱的自动计数。</p>
</li>
</ul>
<h3 data-id="heading-8">6.3 使用 Spring Data JPA 投影的最佳方式</h3>
<p><strong>类型</strong></p>
<ul>
<li>
<p><strong>基于接口的投影</strong> — 用于安全数据呈现的只读视图。</p>
</li>
<li>
<p><strong>DTO/基于类的投影</strong> — 映射到具有单个全参数构造函数的类（如果存在多个构造函数，请使用 <code>@PersistenceCreator</code>）。</p>
</li>
<li>
<p><strong>动态投影</strong> — 公开一个通用方法，让调用者传递 <code>Class&lt;T&gt;</code> 以在运行时选择投影类型。</p>
</li>
</ul>
<p><strong>注意</strong></p>
<ul>
<li>
<p>在投影中访问嵌套属性可能触发连接。投影并不自动比实体快。检查 SQL 和返回的列，并测量查询性能。</p>
</li>
<li>
<p>当将 DTO 与动态投影一起使用时，确保查询提供构造函数参数（例如，通过 JPQL 构造函数表达式）。</p>
</li>
</ul>
<h3 data-id="heading-9">6.4 关于有效使用查询的简要说明</h3>
<p><strong>批处理与往返次数</strong></p>
<ul>
<li>
<p>优先使用 <code>saveAll(...)</code> 而不是重复的 <code>save(...)</code>。</p>
</li>
<li>
<p>如果需要插入批处理，请避免使用 <code>GenerationType.IDENTITY</code>。优先选择序列/池化优化器。</p>
</li>
<li>
<p>对于非常大的批次，定期调用 <code>flush()</code>/<code>clear()</code>。</p>
</li>
</ul>
<p><strong>让数据库工作</strong></p>
<ul>
<li>
<p>尽可能将面向集合的逻辑推入单个查询，而不是多步骤的 Java 循环。</p>
</li>
</ul>
<p><strong>分页选项</strong></p>
<ul>
<li>
<p><code>Page&lt;T&gt;</code> — 内容 + 总数（触发计数查询）。</p>
</li>
<li>
<p><code>Slice&lt;T&gt;</code> — 内容 + "是否有下一页"（无计数查询，适用于无限滚动）。</p>
</li>
<li>
<p><code>List&lt;T&gt;</code> 带 <code>Pageable</code> 参数 — 应用 limit/offset，无元数据。</p>
</li>
</ul>
<h3 data-id="heading-10">6.5 从 Spring Data JPA 调用存储过程</h3>
<p><strong>方法</strong></p>
<ul>
<li>
<p><strong>命名存储过程</strong>：在实体上使用 <code>@NamedStoredProcedureQuery</code> 声明，然后通过使用 <code>@Procedure(name = "...")</code> 注解的存储库方法调用。</p>
</li>
<li>
<p><strong>直接调用</strong>（无实体元数据）：在存储库方法上使用 <code>@Procedure(procedureName = "...")</code>，或使用 <code>@Query(value = "CALL ...", nativeQuery = true)</code> 调用。</p>
</li>
</ul>
<p><strong>输出</strong></p>
<ul>
<li>
<p>多个 OUT 参数（使用命名存储过程）可以作为 <code>Map&lt;String,Object&gt;</code> 返回。</p>
</li>
<li>
<p>单个 OUT 可以直接返回，或者使用 <code>@Procedure</code> 上的 <code>outputParameterName</code> 来定位特定的输出参数。</p>
</li>
</ul>
<p><strong>Spring Data JPA（系列文章共 2 篇）</strong></p>
<ol>
<li>
<p>Spring Data JPA 最佳实践【1/2】：实体设计指南</p>
</li>
<li>
<p>Spring Data JPA 最佳实践【2/2】：存储库设计指南</p>
</li>
</ol>
<hr/>
<p>【注】本文译自：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.to%2Fprotsenko%2Fspring-data-jpa-best-practices-repositories-design-guide-2f6j" target="_blank" title="https://dev.to/protsenko/spring-data-jpa-best-practices-repositories-design-guide-2f6j" ref="nofollow noopener noreferrer">Spring Data JPA Best Practices: Repositories Design Guide</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Spring Boot异步任务实战：优化耗时操作，提升系统性能]]></title>    <link>https://juejin.cn/post/7576559408659464244</link>    <guid>https://juejin.cn/post/7576559408659464244</guid>    <pubDate>2025-11-26T03:32:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576559408659464244" data-draft-id="7576559408659431476" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Spring Boot异步任务实战：优化耗时操作，提升系统性能"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-26T03:32:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CyberShen"/> <meta itemprop="url" content="https://juejin.cn/user/554609587530014"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Spring Boot异步任务实战：优化耗时操作，提升系统性能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/554609587530014/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CyberShen
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T03:32:05.000Z" title="Wed Nov 26 2025 03:32:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在Web开发中，我们经常会遇到一些耗时操作，比如发送邮件、生成报表、调用第三方API等。如果这些操作都在主线程中同步执行，会导致接口响应缓慢，用户体验下降。Spring Boot提供了简洁而强大的异步任务支持，让我们能轻松将耗时操作放到后台执行。本文将全面介绍Spring Boot异步任务的实战技巧。</p>
<h2 data-id="heading-0">一、异步任务的核心价值与基础配置</h2>
<p>异步任务的核心思想是将耗时操作与主线程分离，使用后台线程处理这些任务，从而让主线程快速返回响应，提高系统的吞吐量和响应速度。</p>
<h3 data-id="heading-1">1.1 开启异步支持</h3>
<p>要使用Spring Boot的异步功能，首先需要在配置类或主应用类上添加<code>@EnableAsync</code>注解：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@SpringBootApplication</span>
<span class="hljs-variable">@EnableAsync</span>
public class Application {
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">static</span> <span class="hljs-selector-tag">void</span> <span class="hljs-selector-tag">main</span>(String[] args) {
        <span class="hljs-selector-tag">SpringApplication</span><span class="hljs-selector-class">.run</span>(Application.class, args);
    }
}
</code></pre>
<h3 data-id="heading-2">1.2 配置线程池</h3>
<p>直接使用Spring的默认异步执行器虽然简单，但生产环境中我们需要自定义线程池以获得更好的控制和性能：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-keyword">@Configuration</span>
<span class="hljs-keyword">@EnableAsync</span>
public class AsyncConfig implements AsyncConfigurer {

    <span class="hljs-comment">/**
     * 自定义异步线程池
     */</span>
    <span class="hljs-keyword">@Bean</span>(name = <span class="hljs-string">"taskExecutor"</span>)
    public Executor taskExecutor() {
        ThreadPoolTaskExecutor executor = new <span class="hljs-built_in">ThreadPoolTaskExecutor</span>();
        <span class="hljs-comment">// 核心线程数：线程池维护的最小线程数量</span>
        executor<span class="hljs-selector-class">.setCorePoolSize</span>(<span class="hljs-number">5</span>);
        <span class="hljs-comment">// 最大线程数：线程池允许的最大线程数量</span>
        executor<span class="hljs-selector-class">.setMaxPoolSize</span>(<span class="hljs-number">10</span>);
        <span class="hljs-comment">// 队列容量：任务等待队列的长度</span>
        executor<span class="hljs-selector-class">.setQueueCapacity</span>(<span class="hljs-number">20</span>);
        <span class="hljs-comment">// 线程名前缀：方便日志追踪</span>
        executor<span class="hljs-selector-class">.setThreadNamePrefix</span>("Async-");
        <span class="hljs-comment">// 拒绝策略：当任务太多处理不过来时的处理方式</span>
        <span class="hljs-comment">// CallerRunsPolicy表示让提交任务的线程自己执行</span>
        executor<span class="hljs-selector-class">.setRejectedExecutionHandler</span>(new ThreadPoolExecutor.CallerRunsPolicy());
        <span class="hljs-comment">// 线程空闲时间：超过此时间，多余的线程会被销毁</span>
        executor<span class="hljs-selector-class">.setKeepAliveSeconds</span>(<span class="hljs-number">60</span>);
        <span class="hljs-comment">// 初始化线程池</span>
        executor<span class="hljs-selector-class">.initialize</span>();
        return executor;
    }

    <span class="hljs-keyword">@Override</span>
    public AsyncUncaughtExceptionHandler getAsyncUncaughtExceptionHandler() {
        return new <span class="hljs-built_in">CustomAsyncExceptionHandler</span>();
    }
}
</code></pre>
<p>线程池参数配置需要根据实际业务场景调整：</p>
<ul>
<li><strong>CPU密集型任务</strong>（如复杂计算）：核心线程数设为CPU核心数+1</li>
<li><strong>IO密集型任务</strong>（如网络请求、文件操作）：核心线程数可以设为CPU核心数×2</li>
<li><strong>队列容量</strong>不宜过大或过小，通常设置20-100之间</li>
</ul>
<h2 data-id="heading-3">二、异步任务的实现方式</h2>
<h3 data-id="heading-4">2.1 使用@Async注解</h3>
<p>最简单的异步执行方式是在方法上添加<code>@Async</code>注解：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AsyncTaskService</span> {

    <span class="hljs-comment">/**
     * 发送邮件异步任务
     */</span>
    <span class="hljs-meta">@Async</span>(<span class="hljs-string">"taskExecutor"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">sendEmail</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> to, <span class="hljs-built_in">String</span> content</span>) {
        long startTime = <span class="hljs-title class_">System</span>.<span class="hljs-title function_">currentTimeMillis</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 模拟发送邮件的耗时操作</span>
            <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">sleep</span>(<span class="hljs-number">2000</span>);
            log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"邮件发送成功：{}，内容：{}，耗时：{}ms"</span>, 
                    to, content, <span class="hljs-title class_">System</span>.<span class="hljs-title function_">currentTimeMillis</span>() - startTime);
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">InterruptedException</span> e) {
            <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">currentThread</span>().<span class="hljs-title function_">interrupt</span>();
            log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"邮件发送被中断：{}"</span>, e.<span class="hljs-title function_">getMessage</span>());
        }
    }
    
    <span class="hljs-comment">/**
     * 带返回结果的异步任务
     */</span>
    <span class="hljs-meta">@Async</span>(<span class="hljs-string">"taskExecutor"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">CompletableFuture</span>&lt;<span class="hljs-title class_">String</span>&gt; <span class="hljs-title function_">generateReport</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> reportId</span>) {
        long startTime = <span class="hljs-title class_">System</span>.<span class="hljs-title function_">currentTimeMillis</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 模拟报表生成耗时</span>
            <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">sleep</span>(<span class="hljs-number">3000</span>);
            <span class="hljs-title class_">String</span> result = <span class="hljs-string">"报表["</span> + reportId + <span class="hljs-string">"]生成成功，路径：/reports/"</span> + reportId + <span class="hljs-string">".pdf"</span>;
            log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"报表生成完成，耗时：{}ms"</span>, <span class="hljs-title class_">System</span>.<span class="hljs-title function_">currentTimeMillis</span>() - startTime);
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">CompletableFuture</span>.<span class="hljs-title function_">completedFuture</span>(result);
        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">InterruptedException</span> e) {
            <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">currentThread</span>().<span class="hljs-title function_">interrupt</span>();
            <span class="hljs-keyword">return</span> <span class="hljs-title class_">CompletableFuture</span>.<span class="hljs-title function_">failedFuture</span>(e);
        }
    }
    
    <span class="hljs-comment">/**
     * 批量处理任务
     */</span>
    <span class="hljs-meta">@Async</span>(<span class="hljs-string">"taskExecutor"</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">CompletableFuture</span>&lt;<span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">String</span>&gt;&gt; <span class="hljs-title function_">batchProcess</span>(<span class="hljs-params">List&lt;<span class="hljs-built_in">String</span>&gt; dataList</span>) {
        <span class="hljs-title class_">List</span>&lt;<span class="hljs-title class_">String</span>&gt; results = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        <span class="hljs-keyword">for</span> (<span class="hljs-title class_">String</span> data : dataList) {
            <span class="hljs-comment">// 模拟每个数据的处理耗时</span>
            <span class="hljs-keyword">try</span> {
                <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">sleep</span>(<span class="hljs-number">100</span>);
                results.<span class="hljs-title function_">add</span>(<span class="hljs-string">"已处理："</span> + data);
            } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">InterruptedException</span> e) {
                <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">currentThread</span>().<span class="hljs-title function_">interrupt</span>();
                <span class="hljs-keyword">break</span>;
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">CompletableFuture</span>.<span class="hljs-title function_">completedFuture</span>(results);
    }
}
</code></pre>
<h3 data-id="heading-5">2.2 控制器中调用异步任务</h3>
<p>在Controller中调用异步服务，立即返回响应：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/api/tasks"</span>)
<span class="hljs-variable">@Slf4j</span>
public class TaskController {

    <span class="hljs-variable">@Autowired</span>
    private AsyncTaskService asyncTaskService;

    <span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/email"</span>)
    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-built_in">sendEmail</span>(<span class="hljs-variable">@RequestParam</span> String to, 
                                                       <span class="hljs-variable">@RequestParam</span> String content) {
        <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">startTime</span> = <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.currentTimeMillis</span>();
        
        <span class="hljs-comment">// 异步发送邮件，立即返回</span>
        <span class="hljs-selector-tag">asyncTaskService</span><span class="hljs-selector-class">.sendEmail</span>(to, content);
        
        <span class="hljs-selector-tag">Map</span>&lt;<span class="hljs-selector-tag">String</span>, <span class="hljs-selector-tag">Object</span>&gt; <span class="hljs-selector-tag">response</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">HashMap</span>&lt;&gt;();
        <span class="hljs-selector-tag">response</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"status"</span>, <span class="hljs-string">"success"</span>);
        <span class="hljs-selector-tag">response</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"message"</span>, <span class="hljs-string">"邮件正在后台发送中"</span>);
        <span class="hljs-selector-tag">response</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"timestamp"</span>, System.<span class="hljs-built_in">currentTimeMillis</span>());
        
        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"邮件任务提交成功，耗时：{}ms"</span>, System.<span class="hljs-built_in">currentTimeMillis</span>() - startTime);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.ok</span>(response);
    }
    
    @<span class="hljs-selector-tag">PostMapping</span>(<span class="hljs-string">"/report"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">CompletableFuture</span>&lt;<span class="hljs-selector-tag">ResponseEntity</span>&lt;<span class="hljs-selector-tag">Map</span>&lt;<span class="hljs-selector-tag">String</span>, <span class="hljs-selector-tag">Object</span>&gt;&gt;&gt; <span class="hljs-selector-tag">generateReport</span>(<span class="hljs-variable">@RequestParam</span> String reportId) {
        <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">startTime</span> = <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.currentTimeMillis</span>();
        
        <span class="hljs-comment">// 返回异步结果</span>
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">asyncTaskService</span><span class="hljs-selector-class">.generateReport</span>(reportId)
                <span class="hljs-selector-class">.thenApply</span>(result -&gt; {
                    <span class="hljs-selector-tag">Map</span>&lt;<span class="hljs-selector-tag">String</span>, <span class="hljs-selector-tag">Object</span>&gt; <span class="hljs-selector-tag">response</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">HashMap</span>&lt;&gt;();
                    <span class="hljs-selector-tag">response</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"status"</span>, <span class="hljs-string">"success"</span>);
                    <span class="hljs-selector-tag">response</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"data"</span>, result);
                    <span class="hljs-selector-tag">response</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"processTime"</span>, System.<span class="hljs-built_in">currentTimeMillis</span>() - startTime);
                    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.ok</span>(response);
                })
                <span class="hljs-selector-class">.exceptionally</span>(ex -&gt; {
                    <span class="hljs-selector-tag">Map</span>&lt;<span class="hljs-selector-tag">String</span>, <span class="hljs-selector-tag">Object</span>&gt; <span class="hljs-selector-tag">response</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">HashMap</span>&lt;&gt;();
                    <span class="hljs-selector-tag">response</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"status"</span>, <span class="hljs-string">"error"</span>);
                    <span class="hljs-selector-tag">response</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"message"</span>, <span class="hljs-string">"报表生成失败: "</span> + ex.<span class="hljs-built_in">getMessage</span>());
                    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.status</span>(<span class="hljs-number">500</span>)<span class="hljs-selector-class">.body</span>(response);
                });
    }
}
</code></pre>
<h2 data-id="heading-6">三、异步任务的高级特性与优化</h2>
<h3 data-id="heading-7">3.1 异常处理机制</h3>
<p>异步任务中的异常需要特殊处理，因为异常不会自动传播到调用线程：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomAsyncExceptionHandler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AsyncUncaughtExceptionHandler</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">handleUncaughtException</span>(<span class="hljs-params">Throwable ex, Method method, <span class="hljs-built_in">Object</span>... params</span>) {
        log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"异步任务执行异常，方法：{}，参数：{}，异常信息：{}"</span>, 
                 method.<span class="hljs-title function_">getName</span>(), 
                 <span class="hljs-title class_">Arrays</span>.<span class="hljs-title function_">toString</span>(params), 
                 ex.<span class="hljs-title function_">getMessage</span>(), 
                 ex);
        
        <span class="hljs-comment">// 发送告警通知</span>
        <span class="hljs-title function_">sendAlert</span>(method, ex, params);
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">sendAlert</span>(<span class="hljs-params">Method method, Throwable ex, <span class="hljs-built_in">Object</span>[] params</span>) {
        <span class="hljs-comment">// 实现告警逻辑，可以发送邮件、短信或钉钉通知</span>
        <span class="hljs-title class_">String</span> alertMessage = <span class="hljs-title class_">String</span>.<span class="hljs-title function_">format</span>(
            <span class="hljs-string">"异步任务异常告警\n方法: %s\n参数: %s\n异常: %s\n时间: %s"</span>,
            method.<span class="hljs-title function_">getName</span>(),
            <span class="hljs-title class_">Arrays</span>.<span class="hljs-title function_">toString</span>(params),
            ex.<span class="hljs-title function_">getMessage</span>(),
            <span class="hljs-title class_">LocalDateTime</span>.<span class="hljs-title function_">now</span>()
        );
        
        log.<span class="hljs-title function_">warn</span>(<span class="hljs-string">"发送异步任务异常告警: {}"</span>, alertMessage);
        <span class="hljs-comment">// 实际项目中可以集成邮件发送或消息推送</span>
    }
}

<span class="hljs-comment">// 全局异常处理</span>
<span class="hljs-meta">@ControllerAdvice</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">GlobalExceptionHandler</span> {
    
    <span class="hljs-meta">@ExceptionHandler</span>(<span class="hljs-title class_">Exception</span>.<span class="hljs-property">class</span>)
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">ResponseEntity</span>&lt;<span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt;&gt; <span class="hljs-title function_">handleException</span>(<span class="hljs-params">Exception ex</span>) {
        log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"全局异常捕获: {}"</span>, ex.<span class="hljs-title function_">getMessage</span>(), ex);
        
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Object</span>&gt; response = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        response.<span class="hljs-title function_">put</span>(<span class="hljs-string">"status"</span>, <span class="hljs-string">"error"</span>);
        response.<span class="hljs-title function_">put</span>(<span class="hljs-string">"message"</span>, <span class="hljs-string">"系统繁忙，请稍后重试"</span>);
        response.<span class="hljs-title function_">put</span>(<span class="hljs-string">"timestamp"</span>, <span class="hljs-title class_">System</span>.<span class="hljs-title function_">currentTimeMillis</span>());
        
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">ResponseEntity</span>.<span class="hljs-title function_">status</span>(<span class="hljs-number">500</span>).<span class="hljs-title function_">body</span>(response);
    }
}
</code></pre>
<h3 data-id="heading-8">3.2 任务结果处理</h3>
<p>对于需要处理返回结果的异步任务，可以使用CompletableFuture的链式调用：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReportService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title class_">AsyncTaskService</span> asyncTaskService;

    <span class="hljs-comment">/**
     * 复杂的异步任务处理流程
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title class_">CompletableFuture</span>&lt;<span class="hljs-title class_">Void</span>&gt; <span class="hljs-title function_">complexReportProcess</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> reportId</span>) {
        log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"开始处理报表流程: {}"</span>, reportId);
        
        <span class="hljs-keyword">return</span> asyncTaskService.<span class="hljs-title function_">generateReport</span>(reportId)
                .<span class="hljs-title function_">thenApply</span>(result -&gt; {
                    log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"报表生成成功: {}"</span>, result);
                    <span class="hljs-comment">// 可以在这里进行结果处理</span>
                    <span class="hljs-keyword">return</span> result;
                })
                .<span class="hljs-title function_">thenCompose</span>(result -&gt; {
                    <span class="hljs-comment">// 模拟后续异步操作</span>
                    log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"开始归档报表: {}"</span>, reportId);
                    <span class="hljs-keyword">return</span> <span class="hljs-title class_">CompletableFuture</span>.<span class="hljs-title function_">supplyAsync</span>(() -&gt; {
                        <span class="hljs-keyword">try</span> {
                            <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">sleep</span>(<span class="hljs-number">1000</span>);
                            log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"报表归档完成: {}"</span>, reportId);
                            <span class="hljs-keyword">return</span> <span class="hljs-string">"归档成功"</span>;
                        } <span class="hljs-keyword">catch</span> (<span class="hljs-title class_">InterruptedException</span> e) {
                            <span class="hljs-title class_">Thread</span>.<span class="hljs-title function_">currentThread</span>().<span class="hljs-title function_">interrupt</span>();
                            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"归档被中断"</span>);
                        }
                    });
                })
                .<span class="hljs-title function_">thenAccept</span>(finalResult -&gt; {
                    log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"整个报表处理流程完成: {}"</span>, reportId);
                    <span class="hljs-comment">// 发送通知等后续操作</span>
                    <span class="hljs-title function_">sendNotification</span>(reportId, <span class="hljs-string">"处理完成"</span>);
                })
                .<span class="hljs-title function_">exceptionally</span>(ex -&gt; {
                    log.<span class="hljs-title function_">error</span>(<span class="hljs-string">"报表处理流程异常: {}"</span>, ex.<span class="hljs-title function_">getMessage</span>(), ex);
                    <span class="hljs-title function_">sendNotification</span>(reportId, <span class="hljs-string">"处理失败: "</span> + ex.<span class="hljs-title function_">getMessage</span>());
                    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
                });
    }
    
    <span class="hljs-keyword">private</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">sendNotification</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> reportId, <span class="hljs-built_in">String</span> message</span>) {
        <span class="hljs-comment">// 发送通知的逻辑</span>
        log.<span class="hljs-title function_">info</span>(<span class="hljs-string">"发送通知: {} - {}"</span>, reportId, message);
    }
}
</code></pre>
<h3 data-id="heading-9">3.3 超时控制</h3>
<p>为异步任务设置超时时间，避免长时间阻塞：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TimeoutAsyncService</span> {

    <span class="hljs-comment">/**
     * 带超时控制的异步任务
     */</span>
    <span class="hljs-meta">@Async("taskExecutor")</span>
    <span class="hljs-keyword">public</span> CompletableFuture&lt;String&gt; <span class="hljs-title function_">timeoutTask</span><span class="hljs-params">(String taskId, <span class="hljs-type">int</span> timeoutSeconds)</span> {
        <span class="hljs-keyword">return</span> CompletableFuture.supplyAsync(() -&gt; {
            <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 模拟长时间运行的任务</span>
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; timeoutSeconds * <span class="hljs-number">10</span>; i++) {
                    <span class="hljs-keyword">if</span> (Thread.currentThread().isInterrupted()) {
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"任务被中断"</span>);
                    }
                    Thread.sleep(<span class="hljs-number">100</span>);
                    <span class="hljs-comment">// 检查是否超时</span>
                    <span class="hljs-keyword">if</span> (System.currentTimeMillis() - startTime &gt; timeoutSeconds * <span class="hljs-number">1000L</span>) {
                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"任务执行超时"</span>);
                    }
                }
                <span class="hljs-keyword">return</span> <span class="hljs-string">"任务完成: "</span> + taskId;
            } <span class="hljs-keyword">catch</span> (InterruptedException e) {
                Thread.currentThread().interrupt();
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"任务被中断"</span>, e);
            }
        });
    }
}
</code></pre>
<h2 data-id="heading-10">四、实战案例：完整的邮件发送系统</h2>
<p>下面通过一个完整的邮件发送系统展示异步任务的实际应用：</p>
<h3 data-id="heading-11">4.1 邮件服务类</h3>
<pre><code class="hljs language-vbnet" lang="vbnet">@Service
@Slf4j
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> EmailService {

    @Autowired
    <span class="hljs-keyword">private</span> JavaMailSender mailSender;
    
    @Value(<span class="hljs-string">"${spring.mail.username}"</span>)
    <span class="hljs-keyword">private</span> <span class="hljs-type">String</span> fromEmail;

    /**
     * 发送简单邮件
     */
    @<span class="hljs-keyword">Async</span>(<span class="hljs-string">"taskExecutor"</span>)
    <span class="hljs-keyword">public</span> CompletableFuture&lt;<span class="hljs-type">String</span>&gt; sendSimpleEmail(<span class="hljs-type">String</span> <span class="hljs-keyword">to</span>, <span class="hljs-type">String</span> subject, <span class="hljs-type">String</span> content) {
        <span class="hljs-type">long</span> startTime = System.currentTimeMillis();
        
        <span class="hljs-keyword">try</span> {
            SimpleMailMessage message = <span class="hljs-built_in">new</span> SimpleMailMessage();
            message.setFrom(fromEmail);
            message.setTo(<span class="hljs-keyword">to</span>);
            message.setSubject(subject);
            message.setText(content);
            
            mailSender.send(message);
            
            <span class="hljs-type">long</span> costTime = System.currentTimeMillis() - startTime;
            log.info(<span class="hljs-string">"邮件发送成功: {} -&gt; {}, 耗时: {}ms"</span>, fromEmail, <span class="hljs-keyword">to</span>, costTime);
            
            <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(<span class="hljs-string">"邮件发送成功"</span>);
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.<span class="hljs-keyword">error</span>(<span class="hljs-string">"邮件发送失败: {}"</span>, e.getMessage(), e);
            <span class="hljs-keyword">return</span> CompletableFuture.failedFuture(e);
        }
    }

    /**
     * 发送HTML邮件
     */
    @<span class="hljs-keyword">Async</span>(<span class="hljs-string">"taskExecutor"</span>)
    <span class="hljs-keyword">public</span> CompletableFuture&lt;<span class="hljs-type">String</span>&gt; sendHtmlEmail(<span class="hljs-type">String</span> <span class="hljs-keyword">to</span>, <span class="hljs-type">String</span> subject, <span class="hljs-type">String</span> htmlContent) {
        <span class="hljs-keyword">try</span> {
            MimeMessage message = mailSender.createMimeMessage();
            MimeMessageHelper helper = <span class="hljs-built_in">new</span> MimeMessageHelper(message, <span class="hljs-literal">true</span>, <span class="hljs-string">"UTF-8"</span>);
            
            helper.setFrom(fromEmail);
            helper.setTo(<span class="hljs-keyword">to</span>);
            helper.setSubject(subject);
            helper.setText(htmlContent, <span class="hljs-literal">true</span>);
            
            mailSender.send(message);
            
            log.info(<span class="hljs-string">"HTML邮件发送成功: {}"</span>, <span class="hljs-keyword">to</span>);
            <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(<span class="hljs-string">"HTML邮件发送成功"</span>);
            
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.<span class="hljs-keyword">error</span>(<span class="hljs-string">"HTML邮件发送失败: {}"</span>, e.getMessage(), e);
            <span class="hljs-keyword">return</span> CompletableFuture.failedFuture(e);
        }
    }

    /**
     * 批量发送邮件
     */
    @<span class="hljs-keyword">Async</span>(<span class="hljs-string">"taskExecutor"</span>)
    <span class="hljs-keyword">public</span> CompletableFuture&lt;Map&lt;<span class="hljs-type">String</span>, <span class="hljs-type">Object</span>&gt;&gt; batchSendEmails(List&lt;<span class="hljs-type">String</span>&gt; toList, 
                                                                  <span class="hljs-type">String</span> subject, 
                                                                  <span class="hljs-type">String</span> content) {
        Map&lt;<span class="hljs-type">String</span>, <span class="hljs-type">Object</span>&gt; result = <span class="hljs-built_in">new</span> HashMap&lt;&gt;();
        List&lt;<span class="hljs-type">String</span>&gt; successList = <span class="hljs-built_in">new</span> ArrayList&lt;&gt;();
        List&lt;<span class="hljs-type">String</span>&gt; failList = <span class="hljs-built_in">new</span> ArrayList&lt;&gt;();
        
        <span class="hljs-type">long</span> startTime = System.currentTimeMillis();
        
        <span class="hljs-keyword">for</span> (<span class="hljs-type">String</span> <span class="hljs-keyword">to</span> : toList) {
            <span class="hljs-keyword">try</span> {
                sendSimpleEmail(<span class="hljs-keyword">to</span>, subject, content).<span class="hljs-keyword">get</span>(<span class="hljs-number">10</span>, TimeUnit.SECONDS);
                successList.add(<span class="hljs-keyword">to</span>);
            } <span class="hljs-keyword">catch</span> (Exception e) {
                log.<span class="hljs-keyword">error</span>(<span class="hljs-string">"发送邮件失败: {}, 错误: {}"</span>, <span class="hljs-keyword">to</span>, e.getMessage());
                failList.add(<span class="hljs-keyword">to</span> + <span class="hljs-string">": "</span> + e.getMessage());
            }
        }
        
        <span class="hljs-type">long</span> totalTime = System.currentTimeMillis() - startTime;
        result.put(<span class="hljs-string">"successCount"</span>, successList.size());
        result.put(<span class="hljs-string">"failCount"</span>, failList.size());
        result.put(<span class="hljs-string">"successList"</span>, successList);
        result.put(<span class="hljs-string">"failList"</span>, failList);
        result.put(<span class="hljs-string">"totalTime"</span>, totalTime + <span class="hljs-string">"ms"</span>);
        
        log.info(<span class="hljs-string">"批量邮件发送完成: 成功{}个, 失败{}个, 总耗时: {}ms"</span>, 
                successList.size(), failList.size(), totalTime);
        
        <span class="hljs-keyword">return</span> CompletableFuture.completedFuture(result);
    }
}
</code></pre>
<h3 data-id="heading-12">4.2 邮件控制器</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/api/email"</span>)
<span class="hljs-variable">@Slf4j</span>
public class EmailController {

    <span class="hljs-variable">@Autowired</span>
    private EmailService emailService;

    <span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/send"</span>)
    public ResponseEntity&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-built_in">sendEmail</span>(<span class="hljs-variable">@RequestBody</span> EmailRequest request) {
        <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">startTime</span> = <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.currentTimeMillis</span>();
        
        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-comment">// 参数验证</span>
            <span class="hljs-selector-tag">if</span> (StringUtils.<span class="hljs-built_in">isEmpty</span>(request.<span class="hljs-built_in">getTo</span>()) || StringUtils.<span class="hljs-built_in">isEmpty</span>(request.<span class="hljs-built_in">getContent</span>())) {
                <span class="hljs-selector-tag">throw</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">IllegalArgumentException</span>(<span class="hljs-string">"收件人或邮件内容不能为空"</span>);
            }
            
            <span class="hljs-comment">// 提交异步任务</span>
            <span class="hljs-selector-tag">CompletableFuture</span>&lt;<span class="hljs-selector-tag">String</span>&gt; <span class="hljs-selector-tag">future</span> = <span class="hljs-selector-tag">emailService</span><span class="hljs-selector-class">.sendSimpleEmail</span>(
                request.<span class="hljs-built_in">getTo</span>(), request.<span class="hljs-built_in">getSubject</span>(), request.<span class="hljs-built_in">getContent</span>());
            
            <span class="hljs-selector-tag">Map</span>&lt;<span class="hljs-selector-tag">String</span>, <span class="hljs-selector-tag">Object</span>&gt; <span class="hljs-selector-tag">response</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">HashMap</span>&lt;&gt;();
            <span class="hljs-selector-tag">response</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"status"</span>, <span class="hljs-string">"success"</span>);
            <span class="hljs-selector-tag">response</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"message"</span>, <span class="hljs-string">"邮件发送任务已提交"</span>);
            <span class="hljs-selector-tag">response</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"taskId"</span>, UUID.<span class="hljs-built_in">randomUUID</span>().<span class="hljs-built_in">toString</span>());
            <span class="hljs-selector-tag">response</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"timestamp"</span>, System.<span class="hljs-built_in">currentTimeMillis</span>());
            <span class="hljs-selector-tag">response</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"processTime"</span>, System.<span class="hljs-built_in">currentTimeMillis</span>() - startTime + <span class="hljs-string">"ms"</span>);
            
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.ok</span>(response);
            
        } <span class="hljs-selector-tag">catch</span> (Exception e) {
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.error</span>(<span class="hljs-string">"提交邮件发送任务失败: {}"</span>, e.<span class="hljs-built_in">getMessage</span>());
            
            <span class="hljs-selector-tag">Map</span>&lt;<span class="hljs-selector-tag">String</span>, <span class="hljs-selector-tag">Object</span>&gt; <span class="hljs-selector-tag">response</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">HashMap</span>&lt;&gt;();
            <span class="hljs-selector-tag">response</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"status"</span>, <span class="hljs-string">"error"</span>);
            <span class="hljs-selector-tag">response</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"message"</span>, <span class="hljs-string">"提交失败: "</span> + e.<span class="hljs-built_in">getMessage</span>());
            <span class="hljs-selector-tag">response</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"timestamp"</span>, System.<span class="hljs-built_in">currentTimeMillis</span>());
            
            <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.badRequest</span>()<span class="hljs-selector-class">.body</span>(response);
        }
    }
    
    @<span class="hljs-selector-tag">PostMapping</span>(<span class="hljs-string">"/batch-send"</span>)
    <span class="hljs-selector-tag">public</span> <span class="hljs-selector-tag">CompletableFuture</span>&lt;<span class="hljs-selector-tag">ResponseEntity</span>&lt;<span class="hljs-selector-tag">Map</span>&lt;<span class="hljs-selector-tag">String</span>, <span class="hljs-selector-tag">Object</span>&gt;&gt;&gt; <span class="hljs-selector-tag">batchSendEmails</span>(
            <span class="hljs-variable">@RequestBody</span> BatchEmailRequest request) {
        
        <span class="hljs-selector-tag">long</span> <span class="hljs-selector-tag">startTime</span> = <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.currentTimeMillis</span>();
        
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">emailService</span><span class="hljs-selector-class">.batchSendEmails</span>(request.<span class="hljs-built_in">getToList</span>(), request.<span class="hljs-built_in">getSubject</span>(), request.<span class="hljs-built_in">getContent</span>())
                <span class="hljs-selector-class">.thenApply</span>(result -&gt; {
                    <span class="hljs-selector-tag">Map</span>&lt;<span class="hljs-selector-tag">String</span>, <span class="hljs-selector-tag">Object</span>&gt; <span class="hljs-selector-tag">response</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">HashMap</span>&lt;&gt;();
                    <span class="hljs-selector-tag">response</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"status"</span>, <span class="hljs-string">"success"</span>);
                    <span class="hljs-selector-tag">response</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"data"</span>, result);
                    <span class="hljs-selector-tag">response</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"totalTime"</span>, System.<span class="hljs-built_in">currentTimeMillis</span>() - startTime + <span class="hljs-string">"ms"</span>);
                    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.ok</span>(response);
                })
                <span class="hljs-selector-class">.exceptionally</span>(ex -&gt; {
                    <span class="hljs-selector-tag">Map</span>&lt;<span class="hljs-selector-tag">String</span>, <span class="hljs-selector-tag">Object</span>&gt; <span class="hljs-selector-tag">response</span> = <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">HashMap</span>&lt;&gt;();
                    <span class="hljs-selector-tag">response</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"status"</span>, <span class="hljs-string">"error"</span>);
                    <span class="hljs-selector-tag">response</span><span class="hljs-selector-class">.put</span>(<span class="hljs-string">"message"</span>, <span class="hljs-string">"批量发送失败: "</span> + ex.<span class="hljs-built_in">getMessage</span>());
                    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">ResponseEntity</span><span class="hljs-selector-class">.status</span>(<span class="hljs-number">500</span>)<span class="hljs-selector-class">.body</span>(response);
                });
    }
}

@<span class="hljs-selector-tag">Data</span>
<span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">EmailRequest</span> {
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">to</span>;
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">subject</span>;
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">content</span>;
}

@<span class="hljs-selector-tag">Data</span>
<span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">BatchEmailRequest</span> {
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">List</span>&lt;<span class="hljs-selector-tag">String</span>&gt; <span class="hljs-selector-tag">toList</span>;
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">subject</span>;
    <span class="hljs-selector-tag">private</span> <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">content</span>;
}
</code></pre>
<h2 data-id="heading-13">五、监控与最佳实践</h2>
<h3 data-id="heading-14">5.1 线程池监控</h3>
<p>监控线程池状态，及时发现问题：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Component</span>
<span class="hljs-variable">@Slf4j</span>
public class ThreadPoolMonitor {

    <span class="hljs-variable">@Autowired</span>
    private ThreadPoolTaskExecutor taskExecutor;

    <span class="hljs-variable">@Scheduled</span>(fixedRate = <span class="hljs-number">60000</span>) <span class="hljs-comment">// 每分钟监控一次</span>
    public void <span class="hljs-built_in">monitorThreadPool</span>() {
        <span class="hljs-selector-tag">ThreadPoolExecutor</span> <span class="hljs-selector-tag">threadPoolExecutor</span> = <span class="hljs-selector-tag">taskExecutor</span><span class="hljs-selector-class">.getThreadPoolExecutor</span>();
        
        <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.info</span>(<span class="hljs-string">"线程池状态: 核心线程数={}, 活动线程数={}, 最大线程数={}, 队列大小={}/{}, 完成任务数={}"</span>,
                threadPoolExecutor.<span class="hljs-built_in">getCorePoolSize</span>(),
                threadPoolExecutor.<span class="hljs-built_in">getActiveCount</span>(),
                threadPoolExecutor.<span class="hljs-built_in">getMaximumPoolSize</span>(),
                threadPoolExecutor.<span class="hljs-built_in">getQueue</span>().<span class="hljs-built_in">size</span>(),
                threadPoolExecutor.<span class="hljs-built_in">getQueue</span>().<span class="hljs-built_in">remainingCapacity</span>() + threadPoolExecutor.<span class="hljs-built_in">getQueue</span>().<span class="hljs-built_in">size</span>(),
                threadPoolExecutor.<span class="hljs-built_in">getCompletedTaskCount</span>());
        
        <span class="hljs-comment">// 如果队列使用率超过80%，发出警告</span>
        <span class="hljs-selector-tag">double</span> <span class="hljs-selector-tag">queueUsage</span> = (double) <span class="hljs-selector-tag">threadPoolExecutor</span><span class="hljs-selector-class">.getQueue</span>()<span class="hljs-selector-class">.size</span>() / 
                           (threadPoolExecutor.<span class="hljs-built_in">getQueue</span>().<span class="hljs-built_in">size</span>() + threadPoolExecutor.<span class="hljs-built_in">getQueue</span>().<span class="hljs-built_in">remainingCapacity</span>());
        <span class="hljs-selector-tag">if</span> (queueUsage &gt; <span class="hljs-number">0.8</span>) {
            <span class="hljs-selector-tag">log</span><span class="hljs-selector-class">.warn</span>(<span class="hljs-string">"线程池队列使用率过高: {}%"</span>, String.<span class="hljs-built_in">format</span>(<span class="hljs-string">"%.2f"</span>, queueUsage * <span class="hljs-number">100</span>));
        }
    }
}
</code></pre>
<h3 data-id="heading-15">5.2 最佳实践总结</h3>
<ol>
<li><strong>合理配置线程池参数</strong>：根据业务特点调整核心线程数、最大线程数和队列容量</li>
<li><strong>始终使用自定义线程池</strong>：避免使用Spring默认的简单线程池</li>
<li><strong>做好异常处理</strong>：实现AsyncUncaughtExceptionHandler处理未捕获异常</li>
<li><strong>添加超时控制</strong>：避免任务长时间阻塞导致线程池耗尽</li>
<li><strong>使用有意义的线程名称</strong>：便于日志追踪和问题排查</li>
<li><strong>监控线程池状态</strong>：定期检查线程池健康状态</li>
<li><strong>避免在异步方法中使用ThreadLocal</strong>：因为线程是复用的，可能导致数据混乱</li>
<li><strong>不要在同一类中调用异步方法</strong>：因为@Async基于AOP代理，内部调用会失效</li>
</ol>
<h3 data-id="heading-16">5.3 常见问题排查</h3>
<ol>
<li><strong>异步方法不生效</strong>：检查是否添加了@EnableAsync，方法是否为public，是否在同一个类中调用</li>
<li><strong>线程池资源耗尽</strong>：调整线程池参数或使用有界队列</li>
<li><strong>内存泄漏</strong>：确保异步任务中没有持有大对象的引用</li>
<li><strong>任务执行顺序错乱</strong>：需要顺序执行的任务使用同步方式或任务链</li>
</ol>
<h2 data-id="heading-17">总结</h2>
<p>Spring Boot的异步任务为处理耗时操作提供了强大而简洁的解决方案。通过合理配置线程池、正确处理异常和结果，我们可以构建出高性能、高可靠性的异步处理系统。关键是要根据实际业务场景选择合适的策略，并做好监控和日志记录。异步任务虽然强大，但并不是万能的。在需要保证强一致性、顺序执行或结果依赖复杂的场景下，需要谨慎使用，甚至考虑使用消息队列等更成熟的异步处理方案。希望本文的实战经验能够帮助你在实际项目中更好地使用Spring Boot异步任务，提升系统性能和用户体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java后台定时器导致系统奔溃的原因分析]]></title>    <link>https://juejin.cn/post/7576646142315855913</link>    <guid>https://juejin.cn/post/7576646142315855913</guid>    <pubDate>2025-11-26T04:06:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576646142315855913" data-draft-id="7576575703167008774" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java后台定时器导致系统奔溃的原因分析"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-26T04:06:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏三的开发日记"/> <meta itemprop="url" content="https://juejin.cn/user/4248949048749213"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java后台定时器导致系统奔溃的原因分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4248949048749213/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏三的开发日记
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T04:06:39.000Z" title="Wed Nov 26 2025 04:06:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">✅ <strong>一、常见定时器类型</strong></h2>






























<table><thead><tr><th>定时器类型</th><th>特点</th><th>风险点</th></tr></thead><tbody><tr><td><code>@Scheduled</code>（Spring）</td><td>简单、固定间隔</td><td>单线程、阻塞整个调度器</td></tr><tr><td>ScheduledExecutorService</td><td>可配置线程池</td><td>线程池耗尽</td></tr><tr><td>XXL-JOB、ElasticJob</td><td>分布式调度</td><td>调度过频/单机压力大</td></tr><tr><td>自写 <code>Timer</code></td><td>单线程</td><td>异常导致整个 Timer 线程退出</td></tr></tbody></table>
<p>许多崩溃问题和这些机制有关。</p>
<h2 data-id="heading-1">🚨 <strong>二、系统崩溃的常见根因（按频率排序）</strong></h2>
<h3 data-id="heading-2"><strong>1. 定时任务阻塞/卡死（最常见）</strong></h3>
<h4 data-id="heading-3">❌ 场景举例：</h4>
<p>你用 <code>@Scheduled(fixedRate=5000)</code>，任务执行需要 30 秒。</p>
<p><strong>问题：</strong></p>
<ul>
<li>Spring 的 <code>ScheduledAnnotationBeanPostProcessor</code> 默认是 <strong>单线程执行器</strong></li>
<li>上一次任务还没结束，下一次又来</li>
<li>排队越来越长</li>
<li>CPU 占用飙升</li>
<li>最终线程卡死或 OOM</li>
</ul>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@EnableScheduling</span>
<span class="hljs-variable">@Configuration</span>
public class ScheduleConfig implements SchedulingConfigurer {
    <span class="hljs-variable">@Override</span>
    public void <span class="hljs-built_in">configureTasks</span>(ScheduledTaskRegistrar registrar) {
        <span class="hljs-selector-tag">registrar</span><span class="hljs-selector-class">.setScheduler</span>(Executors.<span class="hljs-built_in">newScheduledThreadPool</span>(<span class="hljs-number">10</span>));
    }
}
</code></pre>
<h3 data-id="heading-4"><strong>2. 定时任务抛异常导致线程退出</strong></h3>
<h4 data-id="heading-5">❌ 如果使用 Timer：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Timer</span> <span class="hljs-variable">timer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Timer</span>();
timer.schedule(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TimerTask</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span> / <span class="hljs-number">0</span>;  <span class="hljs-comment">// 异常</span>
    }
}, <span class="hljs-number">0</span>, <span class="hljs-number">1000</span>);
</code></pre>
<p><strong>结果：</strong></p>
<ul>
<li>Timer 线程会完全退出</li>
<li>之后所有任务都不再执行</li>
<li>某些关键操作失效 → 系统异常甚至宕机</li>
</ul>
<h3 data-id="heading-6"><strong>3. 任务执行时间过长导致资源积压</strong></h3>
<p>例如：</p>
<ul>
<li>定时任务扫描数据库 50W 条记录</li>
<li>每分钟执行一次</li>
<li>查询/锁造成数据库压力过大</li>
<li>系统数据库连接耗尽</li>
<li>业务接口全挂</li>
</ul>
<h4 data-id="heading-7">✔ 真实案例：</h4>
<p>“定时对账任务”每 10 分钟执行，执行一次需要 12 分钟，后来数据库基本 100% CPU，业务查询都 timeout。</p>
<h3 data-id="heading-8">4. 任务中出现死循环 / 无限重试</h3>
<pre><code class="hljs language-ruby" lang="ruby"><span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
   <span class="hljs-regexp">//</span> <span class="hljs-variable constant_">MQ</span> 超时就 <span class="hljs-keyword">retry</span>
}
</code></pre>
<p><strong>结果：</strong></p>
<ul>
<li>CPU 100%</li>
<li>内存不断增加</li>
<li>最终 OOM 直接导致系统崩溃</li>
</ul>
<h3 data-id="heading-9">5. 定时任务并发执行无锁，导致 DB 互相死锁</h3>
<pre><code class="hljs language-ini" lang="ini">update table1 set <span class="hljs-attr">status</span>=<span class="hljs-number">1</span> where status=<span class="hljs-number">0</span><span class="hljs-comment">;</span>
</code></pre>
<p>任务 B 同时执行同一逻辑 → 死锁概率大增，导致：</p>
<ul>
<li>MySQL 大量锁等待</li>
<li>1205 锁等待超时</li>
<li>线程池阻塞</li>
<li>系统吞吐量骤降</li>
<li>最终接口超时、服务假死</li>
</ul>
<h3 data-id="heading-10">6. 任务日志大量输出导致磁盘写满</h3>
<pre><code class="hljs language-arduino" lang="arduino">[INFO] task running...
</code></pre>
<p>大量日志文件导致：</p>
<ul>
<li><code>/var/log</code> 或容器磁盘写满</li>
<li>应用无法写日志 → 报错</li>
<li>MySQL 也可能无法写入 binlog → 崩溃</li>
</ul>
<h3 data-id="heading-11"><strong>7. 定时任务里使用了阻塞 IO（HTTP、Redis、MQ 等）</strong></h3>
<p>如果第三方 API 超时，任务一直卡着，直接阻塞定时线程，导致：</p>
<ul>
<li>定时任务全卡住</li>
<li>所有任务执行延迟</li>
<li>如果线程池只有 1 个，全部任务失效</li>
</ul>
<h3 data-id="heading-12"><strong>8. 定时任务内存泄漏</strong></h3>
<p>特别是你常写类似：</p>
<pre><code class="hljs language-ini" lang="ini">List&lt;Object&gt; <span class="hljs-attr">cache</span> = new ArrayList&lt;&gt;()<span class="hljs-comment">;</span>
</code></pre>
<p>放在静态变量中，每次执行都 append，不清理。</p>
<p>长期运行 → 堆积 → OOM → 服务崩溃</p>
<h2 data-id="heading-13">🚩 <strong>三、常见“定时器导致系统崩溃”的真实场景总结</strong></h2>

































<table><thead><tr><th>场景</th><th>后果</th></tr></thead><tbody><tr><td>定时任务读取大量数据</td><td>数据库压力爆炸</td></tr><tr><td>多个任务同时扫描数据库</td><td>死锁 + 慢 SQL</td></tr><tr><td>任务执行时间 &gt; 调度间隔</td><td>任务排队，线程池耗尽</td></tr><tr><td>一个异常导致整个定时器退出</td><td>关键任务不再执行，系统雪崩</td></tr><tr><td>日志打印过多写满磁盘</td><td>服务无法写日志 → 崩溃</td></tr><tr><td>定时任务中线程未关闭</td><td>线程数爆增，系统挂掉</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用AI这么久了，你知道什么是大模型吗？看这里，3分钟让你入门]]></title>    <link>https://juejin.cn/post/7576698454924132358</link>    <guid>https://juejin.cn/post/7576698454924132358</guid>    <pubDate>2025-11-26T05:35:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576698454924132358" data-draft-id="7576609946190725156" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用AI这么久了，你知道什么是大模型吗？看这里，3分钟让你入门"/> <meta itemprop="keywords" content="Agent,LLM,程序员"/> <meta itemprop="datePublished" content="2025-11-26T05:35:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用AI这么久了，你知道什么是大模型吗？看这里，3分钟让你入门
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T05:35:25.000Z" title="Wed Nov 26 2025 05:35:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p>你是不是也好奇：为啥元宝、豆包、DeepSeek既能写文案又能解数学题？元宝怎么像“活字典”啥都懂？这些AI聊天助手的背后，都藏着同一个“超级大脑”——LLM(Large Language Model，大语言模型)。</p>
<p>今天咱用3分钟拆解，不用公式、不讲术语，零基础也能秒懂。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8959643c0ada46ea88107ea9b7f82512~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764740125&amp;x-signature=njU5CQgUjMRhVpBk20UzPqOR9oo%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">1.  先搞懂：LLM到底是个啥？</h2>
<p>LLM是“大语言模型”的英文缩写，直译过来就是“能听懂、会说话的AI大脑”。它的核心技能就一个：<strong>你用人类语言提问，它用人类语言给你靠谱答案</strong>。</p>
<p>比如你输入“帮我写一封请假条”，它立刻生成模板；问“猫和狗哪个更通人性”，它会摆事实讲区别——这背后不是有人在后台打字，全靠模型自己“思考”。</p>
<p>简单说，LLM就像一个“超级学霸”：读了海量书籍、新闻、论文，把人类语言的规律摸得门儿清，不管你聊生活还是问知识，它都能接得上。</p>
<h2 data-id="heading-1">2.  关键问题：LLM的Large,“大”，藏在哪？</h2>
<p>为啥叫“大”语言模型？不是体积大，而是两个核心维度“超量级”，这也是它比普通AI聪明的关键。</p>
<h4 data-id="heading-2">① 训练数据“大”：读遍互联网的“学霸”</h4>
<p>LLM的学习过程像小孩读书，只不过它的“课本”是整个互联网。以GPT-3为例，训练时它“读”了数千亿个单词，涵盖线上书籍、新闻报道、科学论文，甚至社交媒体的对话。</p>
<p>这就好比你把图书馆所有书都背下来，不管别人问啥，你都能从记忆里调相关知识——LLM的“博学”，全靠“读得多”堆出来。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e025ecf394aa4280b5b6a82e5d329c67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764740125&amp;x-signature=ylak%2BjNyQFjcIF4BdyRvMdhDedo%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-3">② 参数数量“大”：自带超算的“大脑”</h4>
<p>“参数”是LLM的核心，你可以理解成它的“脑细胞”，是模型从数据里学到的知识和规则。普通AI的参数可能只有几百万，而GPT-3的参数高达1750亿个。</p>
<p>用做饭打个比方：普通AI做汤，只能调面粉、糖、蛋这几种料；LLM却有上千亿种“调料”，不仅能做出好喝的汤，还能创新出你没喝过的口味——参数越多，模型的“创造力”和“应变力”就越强。</p>
<p>这也是为啥LLM能同时搞定写文章、做总结、翻译语言等多种任务，堪称AI里的“全能选手”。</p>
<h2 data-id="heading-4">3.  核心秘密：Transformer架构，LLM的“发动机”</h2>
<p>可能你会问：以前的AI也读了不少数据，为啥不如LLM聪明？答案藏在一个2017年的“黑科技”里——谷歌提出的Transformer架构。</p>
<p>在它出现前，AI处理语言像“传话游戏”：逐字逐句读，必须等上一句理解完，才能处理下一句，不仅慢，还容易忘事。比如看到“别忘了给广东的朋友带特产”，它可能早就忘了前面提到的“广东”，没法关联起来。</p>
<p>而Transformer的厉害之处，在于两个“神技能”：</p>
<h4 data-id="heading-5">① 自注意力机制：像人一样“抓重点”</h4>
<p>它处理一句话时，不是逐字读，而是“一眼扫完”，并给每个词标上“重要程度”。比如“我昨天在宠物店看到一只小猫，它毛茸茸的很可爱”，模型会自动把注意力聚焦在“小猫”上，不管词和词隔多远，都能牢牢抓住关联。</p>
<h4 data-id="heading-6">② 位置编码：记住“语序”不糊涂</h4>
<p>人类语言里，语序错了意思就变了，比如“我打你”和“你打我”。Transformer会给每个词加“位置标签”，让模型知道谁在前谁在后，彻底搞懂句子逻辑。</p>
<p>这两个技能让AI处理语言的速度和准确率翻倍，也让训练千亿参数的大模型成为可能——没有Transformer，就没有今天的ChatGPT。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d92fb5d161044b15b987bfd07ff74d21~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764740125&amp;x-signature=Nk%2FhtMEClSFK2DKPPeSGLqClRCw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-7">4.  一句话总结：LLM到底咋来的？</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4612e3513c64e4596e0615d39d4f982~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764740125&amp;x-signature=ucgDDSAkV0woGeG8c2OWMucgaV4%3D" alt="" loading="lazy"/></p>
<p>2017年Transformer架构诞生，为LLM打下基础；2022年ChatGPT上线，用流畅的对话体验让大众认识了这个“超级大脑”。</p>
<p>它的本质就是：<strong>用千亿参数当“大脑”，读遍互联网当“课本”，靠Transformer架构当“发动机”，最终实现和人类顺畅对话</strong>。</p>
<p>看到这，你是不是对ChatGPT的“聪明”不再困惑了？其实LLM的核心逻辑特别简单——就像一个读了万卷书、又特别会聊天的学霸，而我们每个人都能轻松用它帮自己干活。</p>
<p>你用ChatGPT做过最酷的事是什么？评论区聊聊～</p>
<h3 data-id="heading-8">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于Ollama和Spring AI：实现本地大模型对话与 RAG 功能]]></title>    <link>https://juejin.cn/post/7576585511878524954</link>    <guid>https://juejin.cn/post/7576585511878524954</guid>    <pubDate>2025-11-26T03:46:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576585511878524954" data-draft-id="7576555431943847946" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于Ollama和Spring AI：实现本地大模型对话与 RAG 功能"/> <meta itemprop="keywords" content="后端,AI编程,人工智能"/> <meta itemprop="datePublished" content="2025-11-26T03:46:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="remaindertime"/> <meta itemprop="url" content="https://juejin.cn/user/3104676570213447"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于Ollama和Spring AI：实现本地大模型对话与 RAG 功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3104676570213447/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    remaindertime
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T03:46:43.000Z" title="Wed Nov 26 2025 03:46:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>AI 大模型浪潮来势汹汹，各大厂商的API 调用费用也随之水涨船高。对于我们这些靠代码吃饭的程序员来说，每一次 API 调用都在悄悄掏空钱包。与其持续给资本"充值"，不如动手在本地搭建一个属于自己的 AI 大模型——省钱的同时，还能获得更多的掌控权。</p>
<p>特别注意： 本文同时涵盖了<strong>本地大模型对话</strong>和 <strong>RAG 功能</strong>的实现，篇幅较长。如果你只想快速实现本地大模型的基础对话功能，可以直接跳过所有标记为 <strong>"支持 RAG"</strong> 的内容和章节，这样能大幅缩短阅读和实践时间。</p>
<h2 data-id="heading-1">先知道</h2>
<p>前置条件很简单：一台 Linux 服务器 + Docker 环境。这些老生常谈的基础设施我们就不多说了。重点来了——本次的绝对主角是开源框架 <strong>Ollama</strong>，它将成为我们在本地运行大模型的"引擎"。</p>
<p><strong>Ollama 是什么？</strong></p>
<p>Ollama 是一个开源框架，它让你可以轻松地在本地机器（甚至是个人电脑）上运行开源的大语言模型，比如 Llama、Mistral、Neural Chat 等。简单说，它就是一个"大模型运行器"。</p>
<p>Ollama 让在本地跑大模型就像运行一个普通的 Docker 容器一样简单。</p>
<p>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Follama.com%2F" target="_blank" title="https://ollama.com/" ref="nofollow noopener noreferrer">Ollama</a></p>
<p><strong>Pgvector 是什么？</strong></p>
<p>pgvector 是 PostgreSQL 关系数据库的一个扩展插件，它给 PostgreSQL 添加了向量数据类型和向量搜索能力。简单说，它让 PostgreSQL 能够存储、索引和查询高维向量。支持向量的存储、相似度计算和快速向量搜索。你可以用 SQL 语句直接进行向量操作，无需额外的向量数据库。但它不是向量数据库，好处是可以同时存储结构化数据和向量数据，集成度更高</p>
<p><strong>RAG 是什么？</strong></p>
<p>RAG 是 Retrieval-Augmented Generation 的缩写，中文叫"检索增强生成"。它是一种将信息检索和大模型生成相结合的技术。</p>
<p>简单分三步：</p>
<ol>
<li><strong>检索阶段</strong> — 用户提问时，系统从已有的文档库（就是上面 Pgvevtor 向量库中存储的数据）中检索出最相关的信息</li>
<li><strong>增强阶段</strong> — 把检索到的相关文档作为上下文，与用户的问题一起发送给大模型</li>
<li><strong>生成阶段</strong> — 大模型基于这些检索到的信息生成回答，而不是凭空捏造</li>
</ol>
<h2 data-id="heading-2">部署</h2>
<h3 data-id="heading-3">部署 Ollama 平台</h3>
<p>注： Ollama 运行大模型需要大量计算资源。根据模型规模不同，CPU 和内存需求差异很大。即便是最轻量的模型（Qwen 3:0.6b），也需要 2 核 CPU 起步（不然运行后拉爆服务器卡死重启）。建议提前评估服务器配置，预留充足空间哦。</p>
<h4 data-id="heading-4">1: 下载 ollama docker 镜像</h4>
<pre><code class="hljs language-bash" lang="bash">docker pull ollama/ollama:0.12.6
</code></pre>
<h4 data-id="heading-5">2: 如果命令拉去失败了，也可本地上传镜像包到服务器</h4>
<p>镜像包博主已经打包完成可自行下载：链接: <a href="https://link.juejin.cn?target=https%3A%2F%2Fpan.baidu.com%2Fs%2F1y0GQidqvaLej8Fp9mzPWbw" target="_blank" title="https://pan.baidu.com/s/1y0GQidqvaLej8Fp9mzPWbw" ref="nofollow noopener noreferrer">pan.baidu.com/s/1y0GQidqv…</a> 提取码: e7ij</p>
<p>上传到自己服务器后在当前文件夹中执行命令构建</p>
<pre><code class="hljs language-css" lang="css">docker load -<span class="hljs-selector-tag">i</span> ollama_ollama_0.<span class="hljs-number">12.6</span>-amd64<span class="hljs-selector-class">.tar</span><span class="hljs-selector-class">.gz</span> 
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3f4cf75ae9a4217a356a8df1546c49f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVtYWluZGVydGltZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764733603&amp;x-signature=%2Fu6QcjOCyvtvmG%2BGwLU%2Bdp2CnLM%3D" alt="" loading="lazy"/></p>
<p>构建完成，可以看出镜像本身都 3.45G 了，非常吃资源</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4f0f2c328db41208e2a22a639e8823a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVtYWluZGVydGltZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764733603&amp;x-signature=ITupTcvva3Rw83w9jpG%2FuLqxqBM%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-6">3: 构建 ollama 容器</h4>
<p>使用 docker compose 的方式构建,自定义文件夹并创建 docker-compose.yml</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ee49b43a3424e3abaa1fb13185ba5a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVtYWluZGVydGltZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764733603&amp;x-signature=69J7KlizuO8BlNiaqnBFqrRfsCA%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3'</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">ollama:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">ollama/ollama:0.12.6</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">ollama</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">unless-stopped</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">"11434:11434"</span>
</code></pre>
<p>也可在 github 仓库下载对应文件：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FRemainderTime%2Fdocker-dosc" target="_blank" title="https://github.com/RemainderTime/docker-dosc" ref="nofollow noopener noreferrer">GitHub - RemainderTime/docker-dosc: 存储docker相关命令文件</a></p>
<p>在当前文件夹中执行命令构建容器</p>
<pre><code class="hljs">docker compose up -d
</code></pre>
<p>执行完成查看容器</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05acb1df96c548bab08713283cc25f39~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVtYWluZGVydGltZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764733603&amp;x-signature=ypDBhysKhNUni8stcTDKY4ZH8x8%3D" alt="" loading="lazy"/></p>
<p>如果容器启动失败，检查下自己服务器内存或者 cpu 是否足够，或者暂时关闭其他启动容器再试试</p>
<h3 data-id="heading-7">部署 Pgvector 数据库（RAG 支持）</h3>
<h4 data-id="heading-8">1: 拉去镜像</h4>
<pre><code class="hljs language-bash" lang="bash">docker pull pgvector/pgvector:pg18
</code></pre>
<h4 data-id="heading-9">2: 手动安装可参考上面 ollama 教程</h4>
<p>链接: <a href="https://link.juejin.cn?target=https%3A%2F%2Fpan.baidu.com%2Fs%2F1sc6BQ6odiAvhGrYNdpHPwQ" target="_blank" title="https://pan.baidu.com/s/1sc6BQ6odiAvhGrYNdpHPwQ" ref="nofollow noopener noreferrer">pan.baidu.com/s/1sc6BQ6od…</a> 提取码: x2tw</p>
<h4 data-id="heading-10">3: 构建 pgvector 容器</h4>
<p>创建对应文件以及文件夹</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/368ce0af42ff4a4ea3f2fad75b62093f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVtYWluZGVydGltZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764733603&amp;x-signature=mFnPPilsWP91lFmiGpXTCSU9Whg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/840cf40318d447548da5969899ba8141~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVtYWluZGVydGltZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764733603&amp;x-signature=TcrR9TOLUYUeOrKGsyhfNFW8wS4%3D" alt="" loading="lazy"/></p>
<p><strong>pgvector</strong> 文件夹中</p>
<p>data: 用于存储持久化数据库数据</p>
<p>sql:存储启动时需要初始化的 sql 语句，如没有则为空内容就行</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/98ec5fdd0808439b96c6ee4fa976224d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVtYWluZGVydGltZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764733603&amp;x-signature=IPEctsrMNUstTi9%2BGhtA8maLTZI%3D" alt="" loading="lazy"/></p>
<p><strong>docker compose</strong> 方式运行容器</p>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-attr">version:</span> <span class="hljs-string">'3'</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">vector_db:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">pgvector/pgvector:pg18</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">vector_db</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">POSTGRES_USER=postgres</span> <span class="hljs-comment">#用户名</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">POSTGRES_PASSWORD=postgres</span> <span class="hljs-comment">#密码</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">POSTGRES_DB=springai</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">PGPASSWORD=postgres</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./pgvector/data:/var/lib/postgresql/data</span>  <span class="hljs-comment"># 添加这行，保证数据持久化</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./pgvector/sql/init.sql:/docker-entrypoint-initdb.d/init.sql</span>
    <span class="hljs-attr">logging:</span>
      <span class="hljs-attr">options:</span>
        <span class="hljs-attr">max-size:</span> <span class="hljs-string">10m</span>
        <span class="hljs-attr">max-file:</span> <span class="hljs-string">"3"</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">'5432:5432'</span>
    <span class="hljs-attr">healthcheck:</span>
      <span class="hljs-attr">test:</span> <span class="hljs-string">"pg_isready -U postgres -d vector_store"</span>
      <span class="hljs-attr">interval:</span> <span class="hljs-string">2s</span>
      <span class="hljs-attr">timeout:</span> <span class="hljs-string">20s</span>
      <span class="hljs-attr">retries:</span> <span class="hljs-number">10</span>
    <span class="hljs-attr">networks:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">my-network</span>

<span class="hljs-attr">networks:</span>
  <span class="hljs-attr">my-network:</span>
    <span class="hljs-attr">driver:</span> <span class="hljs-string">bridge</span>
</code></pre>
<p>也可在 github 仓库下载对应文件：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FRemainderTime%2Fdocker-dosc" target="_blank" title="https://github.com/RemainderTime/docker-dosc" ref="nofollow noopener noreferrer">GitHub - RemainderTime/docker-dosc: 存储docker相关命令文件</a></p>
<h4 data-id="heading-11">4: 构建命令与上面 ollama 同理</h4>
<p>注：记得在自己服务器上面开发对应的访问端口</p>
<h4 data-id="heading-12">5: 连接数据库</h4>
<p>这里使用 DBeaver 工具软件连接，可在官网下载:<a href="https://link.juejin.cn?target=https%3A%2F%2Fdbeaver.io%2F" target="_blank" title="https://dbeaver.io/" ref="nofollow noopener noreferrer">DBeaver Community | Free Open-Source Database Management Tool</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a052e6373ce44567bddb81635e1141e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVtYWluZGVydGltZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764733603&amp;x-signature=aO4zQizp8cn43%2FAnKHED5h0PrDE%3D" alt="" loading="lazy"/></p>
<p>填入 docker-compose 文件中自定义的账号密码连接即可</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a8ce3ae794284de18a5b952e9379b32d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVtYWluZGVydGltZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764733603&amp;x-signature=M9jLr%2BjWIXImRz7XEt9TFwAmqqI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-13">安装大模型</h2>
<p>大模型需要进入 ollama 容器中安装，所以前面说 ollama 是大模型的“引擎”呢</p>
<h3 data-id="heading-14">安装 LLM 大语言模型</h3>
<h4 data-id="heading-15">1: 选取大模型</h4>
<p>打开浏览器访问 ollama 官网查询</p>
<p>目前开源大模型最好的是 meta 公司的 Llama 模型，但很遗憾排名前三的大模型 openai 的 chatgpt、<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.anthropic.com%2F" target="_blank" title="https://www.anthropic.com/" ref="nofollow noopener noreferrer">Anthropic</a> 的 claude 以及 google 的 gemini 都是闭源的。</p>
<p>我们国内也是有优秀的开源大模型：deepseek、阿里的 qwen 大模型都是很不错的</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60c8c762159941c4815f46d397b3171e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVtYWluZGVydGltZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764733603&amp;x-signature=zUpflwFiUxDGP5S0lKKnJb%2Fb4XI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/58e10e54116242f4b8bdb73b930fb7d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVtYWluZGVydGltZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764733603&amp;x-signature=M%2BFqp2cyR6d4d3VHtTP2gAvddoI%3D" alt="" loading="lazy"/></p>
<p>这里选用阿里 <strong>Qwen 3:0.6b</strong> 模型。"b" 代表 billion（10 亿参数），0.6b 即 6 亿参数，是个轻量级模型。参数数越多模型能力越强，但对资源的要求也越高。0.6b 参数量相对较小，资源占用低，非常适合本地部署学习。</p>
<h4 data-id="heading-16">2： 命令进入 ollama 容器中</h4>
<pre><code class="hljs language-bash" lang="bash">docker <span class="hljs-built_in">exec</span> -it &lt;容器名或容器ID&gt; /bin/bash
</code></pre>
<p>如果你安装了 portainer 容器，可直接通过访问其面板并找到 ollama 容器进入</p>
<p>如果你是 mac 电脑，可安装 docker desktop 桌面软件进入容器内部</p>
<h4 data-id="heading-17">3: 安装大模型</h4>
<p>拉取命令和 docker 命令差不多，只是把 docker 换成了 ollama</p>
<pre><code class="hljs">ollama pull qwen3:0.6b
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ec82b80abf34dc18435af7f5bb82554~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVtYWluZGVydGltZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764733603&amp;x-signature=sILEWbbvYWfkMck1MFDbbxQBM0M%3D" alt="" loading="lazy"/></p>
<p>拉取成功后，查看已有的大模型命令</p>
<pre><code class="hljs">ollama list
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc44e0846a544a46a6fc25102f6105e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVtYWluZGVydGltZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764733603&amp;x-signature=graaiHHXryAG7yKZk3Z9GMB6xoQ%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-18">安装Embedding 嵌入模型（RAG 支持）</h3>
<h4 data-id="heading-19">1： 选取安装模型</h4>
<p>我们选取的嵌入模型是：nomic-embed-text</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/32e6bf4c6ac9443da5edd54ec2010269~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVtYWluZGVydGltZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764733603&amp;x-signature=2a6HuVBpNy4CYHGrXu3MsbVuYMM%3D" alt="" loading="lazy"/></p>
<p>安装流程和上面大模型同理</p>
<pre><code class="hljs language-arduino" lang="arduino">ollama pull nomic-embed-text 
</code></pre>
<h4 data-id="heading-20">2: 嵌入模型作用</h4>
<ol>
<li>专门用来将文本转换成向量（embedding）的模型。你可以理解为一个"文本向量化工具"</li>
</ol>
<p>它就是为了配合上面安装的pgvector 数据库一起使用的</p>
<ol start="2">
<li>pgvector 虽然能存储和搜索向量，但向量本身需要由某个模型生成。nomic-embed-text 就是这个生成向量的模型。它相对轻量级，专业度高，特别适合用在本地 RAG 系统中。</li>
</ol>
<h2 data-id="heading-21">程序实践</h2>
<p>自此准备工作都完成了，现在正式进入 code 时间</p>
<p>完整源码获取：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FRemainderTime%2Fspring-ai-lab%2Ftree%2Fmaster%2Fai-ollama-rag" target="_blank" title="https://github.com/RemainderTime/spring-ai-lab/tree/master/ai-ollama-rag" ref="nofollow noopener noreferrer">spring-ai-lab/ai-ollama-rag at master · RemainderTime/spring-ai-lab</a></p>
<p>本文只给出 ai 相关核心代码，完整功能可查看源码</p>
<p>注：使用 Spring AI 需要 Spring Boot 3.3+ 和 JDK 17+ 的支持。</p>
<h3 data-id="heading-22">配置文件 pom.xml</h3>
<p><strong>1: 根目录 pom.xml 依赖引入</strong></p>
<p>spring-ai-lab 是一个多模型集成项目。我们在<strong>根目录 pom.xml</strong> 中统一配置 Spring AI 的版本控制，以便后续在该仓库中集成和管理各类 AI 模型相关的源码。</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">properties</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">java.version</span>&gt;</span>17<span class="hljs-tag">&lt;/<span class="hljs-name">java.version</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">spring-ai-version</span>&gt;</span>1.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">spring-ai-version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">properties</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 引入 Spring AI bom 统一版本 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-bom<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>${spring-ai-version}<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span>
</code></pre>
<p><strong>2：子目录 pom.xml 引入依赖</strong></p>
<pre><code class="hljs language-xml" lang="xml">    <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 用于ai rag 解析上传的数据文件(RAG支持)--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-tika-document-reader<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 用于ai rag 存储数据向量数据库(RAG支持)--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-pgvector-store<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 集成ollama依赖--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-starter-model-ollama<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<p>如果不需要实现 RAG 功能,那么只需要 ollama 依赖就可以了</p>
<p><strong>3: 设置配置文件 application.yml</strong></p>
<p>由于源码中使用的 nacos 作为配置中心，如果你未使用那就直接放在项目 yml 中即可</p>
<pre><code class="hljs language-yml" lang="yml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">servlet:</span>
    <span class="hljs-attr">multipart:</span>
      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
      <span class="hljs-attr">max-file-size:</span> <span class="hljs-string">10MB</span>      <span class="hljs-comment"># 单个文件最大大小</span>
      <span class="hljs-attr">max-request-size:</span> <span class="hljs-string">50MB</span>   <span class="hljs-comment"># 整个请求最大大小（多文件上传）</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">pgvector:</span>
      <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">org.postgresql.Driver</span>
      <span class="hljs-attr">username:</span> <span class="hljs-string">postgres</span>
      <span class="hljs-attr">password:</span> <span class="hljs-string">postgres</span>
      <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:postgresql://127.0.0.1:5432/postgres</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">com.zaxxer.hikari.HikariDataSource</span>
      <span class="hljs-attr">hikari:</span>
        <span class="hljs-attr">pool-name:</span> <span class="hljs-string">HikariCP</span>
        <span class="hljs-attr">minimum-idle:</span> <span class="hljs-number">5</span>
        <span class="hljs-attr">idle-timeout:</span> <span class="hljs-number">600000</span>
        <span class="hljs-attr">maximum-pool-size:</span> <span class="hljs-number">10</span>
        <span class="hljs-attr">auto-commit:</span> <span class="hljs-literal">true</span>
        <span class="hljs-attr">max-lifetime:</span> <span class="hljs-number">1800000</span>
        <span class="hljs-attr">connection-timeout:</span> <span class="hljs-number">30000</span>
        <span class="hljs-attr">connection-test-query:</span> <span class="hljs-string">SELECT</span> <span class="hljs-number">1</span>
  <span class="hljs-attr">ai:</span>
    <span class="hljs-attr">ollama:</span>
      <span class="hljs-attr">base-url:</span> <span class="hljs-string">http://127.0.0.1:11434</span>
      <span class="hljs-attr">chat:</span>
        <span class="hljs-attr">options:</span>
          <span class="hljs-attr">model:</span> <span class="hljs-string">deepseek-r1:1.5b</span>
          <span class="hljs-attr">temperature:</span> <span class="hljs-number">0.7</span>
      <span class="hljs-attr">embedding:</span>
        <span class="hljs-attr">options:</span>
          <span class="hljs-attr">num-batch:</span> <span class="hljs-number">512</span>
        <span class="hljs-attr">model:</span> <span class="hljs-string">nomic-embed-text</span>
</code></pre>
<p>配置内容也很清晰明了，记得替换为自己服务器 ip 地址</p>
<p><strong>pgvector</strong>：配置pgvector 数据库连接（ rag 支持）</p>
<p><strong>ollama</strong>: 配置 ollama 平台地址</p>
<p><strong>chat</strong>： 配置大模型默认名称</p>
<p><strong>embedding</strong>：配置嵌入式模型（rag 支持）</p>
<h3 data-id="heading-23">配置类实现（RAG 支持）</h3>
<p><strong>1: 配置类实现（rag 支持）</strong></p>
<p>pgvector 数据库连接配置类 PgVectorDataSourceConfig.class</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PgVectorDataSourceConfig</span> {

    <span class="hljs-meta">@Bean(name = "pgvectorDataSource")</span>
    <span class="hljs-meta">@ConfigurationProperties(prefix = "spring.datasource.pgvector")</span>
    <span class="hljs-keyword">public</span> DataSource <span class="hljs-title function_">pgvectorDataSource</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DriverManagerDataSource</span>();
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> JdbcTemplate <span class="hljs-title function_">pgvectorJdbcTemplate</span><span class="hljs-params">(<span class="hljs-meta">@Qualifier("pgvectorDataSource")</span> DataSource dataSource)</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JdbcTemplate</span>(dataSource);
    }
}
</code></pre>
<p><strong>OllamaChatConfig.class</strong></p>
<p>这个配置类负责融合 Embedding 模型和 pgvector 数据库，建立从文本向量化到向量存储、检索的完整链路。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OllamaChatConfig</span> {
    <span class="hljs-comment">/**
     * 注入文本分割器-重点注意配置参数
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> TokenTextSplitter <span class="hljs-title function_">tokenTextSplitter</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">//短文本配置</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TokenTextSplitter</span>(<span class="hljs-number">256</span>, <span class="hljs-number">5</span>, <span class="hljs-number">10</span>, <span class="hljs-number">500</span>, <span class="hljs-literal">true</span>);
    }
    <span class="hljs-comment">/**
     TextSplitter splitter = new TokenTextSplitter(
     500,    // chunkSize: 每块最多 500 tokens
     100,    // minChunkSizeChars: 至少 100 个字符才分块
     50,     // minChunkLengthToEmbed: 小于 50 个字符不进行 embedding
     1000,   // maxNumChunks: 最多 1000 块
     true    // keepSeparator: 保留句号、换行符
     );
     */</span>
    <span class="hljs-comment">/**
     * 使用 Ollama API 将文本等对象转换成向量
     * 存储在 内存中 或者简单实现
     * 小数据量、临时存储
     * <span class="hljs-doctag">@param</span> ollamaApi
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-meta">@Bean("ollamaSimpleVectorStore")</span>
    <span class="hljs-keyword">public</span> SimpleVectorStore <span class="hljs-title function_">vectorStore</span><span class="hljs-params">(OllamaApi ollamaApi)</span> {
        <span class="hljs-type">OllamaEmbeddingModel</span> <span class="hljs-variable">embeddingModel</span> <span class="hljs-operator">=</span> OllamaEmbeddingModel
                .builder()
                .ollamaApi(ollamaApi)
                .defaultOptions(OllamaEmbeddingOptions.builder().model(<span class="hljs-string">"nomic-embed-text"</span>).build())
                .build();
        <span class="hljs-keyword">return</span> SimpleVectorStore.builder(embeddingModel).build();
    }

    <span class="hljs-comment">/**
     * 使用 Ollama API 生成向量
     * 存储在 PostgreSQL 中持久化
     * 支持向量搜索、分页等数据库操作
     * <span class="hljs-doctag">@param</span> ollamaApi
     * <span class="hljs-doctag">@param</span> jdbcTemplate
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-meta">@Bean("ollamaPgVectorStore")</span>
    <span class="hljs-keyword">public</span> PgVectorStore <span class="hljs-title function_">pgVectorStore</span><span class="hljs-params">(OllamaApi ollamaApi, JdbcTemplate jdbcTemplate)</span> {
        <span class="hljs-type">OllamaEmbeddingModel</span> <span class="hljs-variable">embeddingModel</span> <span class="hljs-operator">=</span> OllamaEmbeddingModel
                .builder()
                .ollamaApi(ollamaApi)
                .defaultOptions(OllamaEmbeddingOptions.builder().model(<span class="hljs-string">"nomic-embed-text"</span>).build())
                .build();
        <span class="hljs-keyword">return</span> PgVectorStore.builder(jdbcTemplate, embeddingModel)
                .vectorTableName(<span class="hljs-string">"vector_store_ollama_deepseek"</span>)
                .build();
    }
}
</code></pre>
<p><strong>2： 创建向量表 vector_store_ollama_deepseek</strong></p>
<p>这里创建向量表存储 RAG 知识库。表名以 <code>deepseek</code> 结尾，如果按本文使用 Qwen 模型，可改为 <code>qwen</code> 结尾。这样做是为了在同时部署多个大模型时，将不同模型的知识库隔离到不同表中。本文仅实现单模型场景，多模型配置不赘述。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> public.vector_store_ollama_deepseek (
     id UUID <span class="hljs-keyword">primary</span> key <span class="hljs-keyword">default</span> gen_random_uuid(),
     content TEXT <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>,
     metadata JSONB,
     embedding VECTOR(<span class="hljs-number">768</span>)
     )
</code></pre>
<p>特别注意：<code>VECTOR(768)</code> 中的 768 是<strong>向量维度</strong>。不同 Embedding 模型输出的维度不同——nomic-embed-text 是 768 维，其他模型可能是 384 维、1024 维等。表结构中的维度数必须与实际使用的 Embedding 模型相对应。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f73cffbce574565bcf3c25f7ecd0693~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVtYWluZGVydGltZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764733603&amp;x-signature=PHrWMBpZD1%2FNPBSdoX57Ie0wnx8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-24">Ollama 大模型对话实现</h3>
<p>实现 2 个接口</p>
<p>直接对话：大模型会把回答的内容一次性通过接口返回</p>
<p>流式对话：大模型会逐步将内容返回（和市面上使用的 ai 大模型效果一样）</p>
<p>知识点：流式对话使用的 <strong>SSE 协议</strong>这里采用 SSE（Server-Sent Events）协议实现流式对话。SSE 是服务器推送技术，允许服务器主动向客户端持续发送数据，而不需要客户端反复请求。这样用户可以实时看到大模型的逐字生成过程，而不是等待完整响应后才显示。（因此前端也需要实现 SSE 功能）</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/ai/ollama")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OllamaController</span> {
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> OllamaChatModel ollamaChatModel;

    <span class="hljs-comment">/**
     * ollama 直接应答
     */</span>
    <span class="hljs-meta">@RequestMapping(value = "/generate", method = RequestMethod.GET)</span>
    <span class="hljs-keyword">public</span> ChatResponse <span class="hljs-title function_">generate</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam("model")</span> String model, <span class="hljs-meta">@RequestParam("message")</span> String message)</span> {
        <span class="hljs-keyword">return</span> ollamaChatModel.call(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Prompt</span>(message, OllamaChatOptions.builder()
                .model(model)
                .build()));
    }

    <span class="hljs-comment">/**
     * ollama 流式应答
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-meta">@GetMapping(value = "/generate_stream", produces = MediaType.TEXT_EVENT_STREAM_VALUE)</span>
    <span class="hljs-keyword">public</span> Flux&lt;ServerSentEvent&lt;String&gt;&gt; <span class="hljs-title function_">generateStream</span><span class="hljs-params">(
            <span class="hljs-meta">@RequestParam</span> String model,
            <span class="hljs-meta">@RequestParam</span> String message)</span> {

        <span class="hljs-keyword">return</span> ollamaChatModel.stream(
                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Prompt</span>(message, OllamaChatOptions.builder().model(model).build())
                )
                .map(chatResponse -&gt; {
                    <span class="hljs-type">String</span> <span class="hljs-variable">text</span> <span class="hljs-operator">=</span> chatResponse.getResults()
                            .stream()
                            .filter(r -&gt; r.getOutput().getText() != <span class="hljs-literal">null</span>)
                            .map(r -&gt; r.getOutput().getText())
                            .findFirst()
                            .orElse(<span class="hljs-string">""</span>);

                    <span class="hljs-keyword">return</span> ServerSentEvent.&lt;String&gt;builder()
                            .data(text)
                            .build();
                })
                .concatWith(Flux.just(
                        ServerSentEvent.&lt;String&gt;builder()
                                .data(<span class="hljs-string">"[DONE]"</span>)
                                .build()
                ))
                .doOnError(Throwable::printStackTrace);
    }
</code></pre>
<h3 data-id="heading-25">Ollama 大模型实现 RAG 功能（RAG支持）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/ai/ollama")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OllamaController</span> {
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> OllamaChatModel ollamaChatModel;
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> PgVectorStore pgVectorStore;

    <span class="hljs-comment">/**
     * ollama 带rag的直接应答
     */</span>
    <span class="hljs-meta">@RequestMapping(value = "/generateCallRag", method = RequestMethod.GET, produces = MediaType.TEXT_EVENT_STREAM_VALUE)</span>
    <span class="hljs-keyword">public</span> ChatResponse <span class="hljs-title function_">generateCallRag</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam("model")</span> String model, <span class="hljs-meta">@RequestParam("ragTag")</span> String ragTag, <span class="hljs-meta">@RequestParam("message")</span> String message)</span> {

        <span class="hljs-keyword">return</span> ollamaChatModel.call(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Prompt</span>(
                <span class="hljs-built_in">this</span>.createSystemMessage(message, ragTag),
                OllamaChatOptions.builder()
                        .model(model)
                        .build()));
    }

    <span class="hljs-comment">/**
     * ollama 带rag的流式应答
     */</span>
    <span class="hljs-meta">@RequestMapping(value = "/generate_stream_rag", method = RequestMethod.GET)</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> Flux&lt;ServerSentEvent&lt;String&gt;&gt; <span class="hljs-title function_">generateStreamRag</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam("model")</span> String model, <span class="hljs-meta">@RequestParam("ragTag")</span> String ragTag, <span class="hljs-meta">@RequestParam("message")</span> String message)</span> {
        <span class="hljs-keyword">return</span> ollamaChatModel.stream(
                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">Prompt</span>(
                                <span class="hljs-built_in">this</span>.createSystemMessage(message, ragTag),
                                OllamaChatOptions.builder()
                                        .model(model)
                                        .build())
                ).map(chatResponse -&gt; {
                    <span class="hljs-type">String</span> <span class="hljs-variable">text</span> <span class="hljs-operator">=</span> chatResponse.getResults()
                            .stream()
                            .map(r -&gt; r.getOutput().getText() != <span class="hljs-literal">null</span> ? r.getOutput().getText() : <span class="hljs-string">""</span>)
                            .findFirst()
                            .orElse(<span class="hljs-string">""</span>);

                    <span class="hljs-keyword">return</span> ServerSentEvent.&lt;String&gt;builder()
                            .data(text)
                            .build();
                })
                .concatWith(Flux.just(
                        ServerSentEvent.&lt;String&gt;builder()
                                .data(<span class="hljs-string">"[DONE]"</span>)
                                .build()
                ))
                .doOnError(Throwable::printStackTrace);
    }

    <span class="hljs-comment">/**
     * 获取向量知识库提示
     */</span>
    <span class="hljs-keyword">private</span> ArrayList&lt;Message&gt; <span class="hljs-title function_">createSystemMessage</span><span class="hljs-params">(String message, String ragTag)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">SYSTEM_PROMPT</span> <span class="hljs-operator">=</span> <span class="hljs-string">"""
                Use the information from the DOCUMENTS section to provide accurate answers but act as if you knew this information innately.
                If unsure, simply state that you don't know.
                Another thing you need to note is that your reply must be in Chinese!
                DOCUMENTS:
                    {documents}
                """</span>;
        <span class="hljs-type">SearchRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> SearchRequest.builder()
                .query(message)
                .topK(<span class="hljs-number">5</span>)
                .filterExpression(<span class="hljs-string">"knowledge == '"</span> + ragTag + <span class="hljs-string">"'"</span>)
                .build();

        List&lt;Document&gt; documents = pgVectorStore.similaritySearch(request);

        <span class="hljs-type">String</span> <span class="hljs-variable">documentsCollectors</span> <span class="hljs-operator">=</span> documents.stream().map(Document::getText).collect(Collectors.joining());

        <span class="hljs-type">Message</span> <span class="hljs-variable">ragMessage</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SystemPromptTemplate</span>(SYSTEM_PROMPT).createMessage(Map.of(<span class="hljs-string">"documents"</span>, documentsCollectors));

        ArrayList&lt;Message&gt; messages = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        messages.add(ragMessage);
        messages.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UserMessage</span>(message));
        <span class="hljs-keyword">return</span> messages;
    }
}
</code></pre>
<h3 data-id="heading-26">实现知识库文件上传（RAG 支持）</h3>
<p>需要实现将需要存储的知识库文件容器处理成向量并保存在数据库中</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/ai/ollama/rag")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RAGController</span> {

    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> TokenTextSplitter tokenTextSplitter;
    <span class="hljs-meta">@Resource(name = "ollamaPgVectorStore")</span>
    <span class="hljs-keyword">private</span> PgVectorStore pgVectorStore;
    <span class="hljs-meta">@Resource</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;

    <span class="hljs-comment">/**
     * 查询 rag 标签列表
     *
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-meta">@RequestMapping(value = "query_rag_tag_list", method = RequestMethod.GET)</span>
    <span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title function_">queryRagTagList</span><span class="hljs-params">()</span> {
        List&lt;String&gt; range = redisTemplate.opsForList().range(<span class="hljs-string">"ai:rag:tags"</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
        <span class="hljs-keyword">return</span> range;
    }

    <span class="hljs-comment">/**
     * 上传知识库文件，并传入标签
     *
     * <span class="hljs-doctag">@param</span> ragTag
     * <span class="hljs-doctag">@param</span> files
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-meta">@RequestMapping(value = "file/upload", method = RequestMethod.POST, headers = "content-type=multipart/form-data")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">uploadFile</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> String ragTag, <span class="hljs-meta">@RequestParam("file")</span> List&lt;MultipartFile&gt; files)</span> {
        log.info(<span class="hljs-string">"上传知识库开始 {}"</span>, ragTag);
        <span class="hljs-keyword">for</span> (MultipartFile file : files) {
            <span class="hljs-type">TikaDocumentReader</span> <span class="hljs-variable">documentReader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TikaDocumentReader</span>(file.getResource());
            List&lt;Document&gt; documents = documentReader.get();
            List&lt;Document&gt; documentSplitterList = tokenTextSplitter.apply(documents);

            <span class="hljs-comment">// 添加知识库标签</span>
            documents.forEach(doc -&gt; doc.getMetadata().put(<span class="hljs-string">"knowledge"</span>, ragTag));
            documentSplitterList.forEach(doc -&gt; doc.getMetadata().put(<span class="hljs-string">"knowledge"</span>, ragTag));

            pgVectorStore.accept(documentSplitterList);

            <span class="hljs-comment">// 添加知识库记录</span>
            List&lt;String&gt; elements = redisTemplate.opsForList().range(<span class="hljs-string">"ai:rag:tags"</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>);
            <span class="hljs-keyword">assert</span> elements != <span class="hljs-literal">null</span>;
            <span class="hljs-keyword">if</span> (!elements.contains(ragTag)) {
                redisTemplate.opsForList().leftPush(<span class="hljs-string">"ai:rag:tags"</span>, ragTag);
            }
        }
        log.info(<span class="hljs-string">"上传知识库完成 {}"</span>, ragTag);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"success"</span>;
    }
}
</code></pre>
<p>自此就可以运行项目通过 postman 工具调用接口测试了</p>
<h3 data-id="heading-27">实现简单前端对话功能/上传知识库功能</h3>
<p>这里我们引入<strong>thymeleaf</strong> 依赖实现后端项目访问 html 页面</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!--访问templates文件下的静态资源--&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>在资源文件家中创建 <strong>chat.html</strong> 文件</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c389f2481036469d844037b81f02ce6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVtYWluZGVydGltZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764733603&amp;x-signature=OYP9lROxJk046CPZG910n9BunkI%3D" alt="" loading="lazy"/></p>
<p>实现 <strong>WebCotroller.class</strong> 访问页面</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Controller</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebController</span> {
    <span class="hljs-meta">@GetMapping("/chat")</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">chatPage</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"chat"</span>; <span class="hljs-comment">// 对应 templates/chat.html</span>
    }
}
</code></pre>
<p>chat.html 中的内容过长这里就不贴出来了，可访问上面给的源码地址获取，博主也是交给 AI 实现的。</p>
<h3 data-id="heading-28">访问前端页面</h3>
<h4 data-id="heading-29">简单对话</h4>
<p>访问地址：<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A10001%2Fchat" target="_blank" title="http://localhost:10001/chat" ref="nofollow noopener noreferrer">http://localhost:10001/chat</a></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cebb37d7881d43f0a74d16d7ca5f4297~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVtYWluZGVydGltZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764733603&amp;x-signature=cjbYBPQvZBLmQ%2B4If%2Fub3FW66yg%3D" alt="" loading="lazy"/></p>
<p>如果许久未返回内容，请查看自己服务器 CPU 是不是“爆炸”了</p>
<h4 data-id="heading-30">上传知识库文件</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88e7fe36fe24488999963839ca77361b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVtYWluZGVydGltZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764733603&amp;x-signature=h1LMZ7hty%2BMW84%2BlmxFhk5Ug5SY%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-31">上传成功查看数据库数据</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a4f9b1eb162f451b8723eda5f378da94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVtYWluZGVydGltZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764733603&amp;x-signature=90aB8VU3mX78gI8wKsgktmLRYnE%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-32">实现 rag 对话</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c3c4d388c9434ac4b092970ac6b90309~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgcmVtYWluZGVydGltZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764733603&amp;x-signature=MoIYqGFi5KrmG9GUUklplo%2Fq1xs%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-33">总结</h2>
<p>本地部署大模型通过 Ollama 实现，既能节省持续的 API 调用费用，又能获得数据隐私和完全自主控制；配合 RAG 技术，通过 Embedding 模型和 pgvector 向量库，让大模型基于你的私有文档数据生成答案，彻底解决模型幻觉问题。但这一切的前提是服务器有充足的 CPU、内存和磁盘空间——即便最轻量的模型也需要 2 核 CPU 起步，资源不足会导致性能严重下降甚至崩溃。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[VUE3项目--集成Sass]]></title>    <link>https://juejin.cn/post/7576585511878688794</link>    <guid>https://juejin.cn/post/7576585511878688794</guid>    <pubDate>2025-11-26T04:08:43.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576585511878688794" data-draft-id="7576585511878574106" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="VUE3项目--集成Sass"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-26T04:08:43.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户9381691255360"/> <meta itemprop="url" content="https://juejin.cn/user/3485906645565271"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            VUE3项目--集成Sass
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3485906645565271/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户9381691255360
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T04:08:43.000Z" title="Wed Nov 26 2025 04:08:43 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>项目中集成Sass后，在组件内部就可以使用sass样式，需要加上<strong>lang="scss"</strong>。</p>
<h2 data-id="heading-0">一、安装Sass</h2>
<blockquote>
<p><code>pnpm install sass（或者sass-embedded） sass-loader -D</code></p>
</blockquote>
<h2 data-id="heading-1">二、添加全局样式</h2>
<ol>
<li>src文件夹下新建文件/styles/index.scss</li>
<li>在src/styles下文件文件reset.scss，目的是清除默认样式。复制<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Freset-scss%3FactiveTab%3Dcode" target="_blank" title="https://www.npmjs.com/package/reset-scss?activeTab=code" ref="nofollow noopener noreferrer">npm官网的reset.scss文件内容</a>到该文件中。</li>
<li>在index.scss中引入reset.scss文件。</li>
</ol>
<blockquote>
<p><code>@use './reset.scss';</code></p>
</blockquote>
<ol start="4">
<li>在src/styles下文件文件variable.scss，目的是定义全局样式变量。变量名称以$开头。</li>
</ol>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// variable.scss</span>

<span class="hljs-variable">$color</span>: red;
<span class="hljs-variable">$base</span>-size: <span class="hljs-number">10</span>
</code></pre>
<ol start="5">
<li>在入口文件main.ts中导入样式文件。</li>
</ol>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// main.ts</span>

<span class="hljs-comment">// 引入全局样式</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">'@/styles/index.scss'</span>
</code></pre>
<ol start="6">
<li>在vite.config.ts文件中配置scss。</li>
</ol>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// vite.config.ts</span>

export <span class="hljs-keyword">default</span> <span class="hljs-title function_ invoke__">defineConfig</span>({
  <span class="hljs-attr">css</span>: {
    <span class="hljs-attr">preprocessorOptions</span>: {
      <span class="hljs-attr">scss</span>: {
        <span class="hljs-attr">additionalData</span>: <span class="hljs-string">'@use "@/styles/variable" as *;'</span>
      }
    }
  }
})
</code></pre>
<h2 data-id="heading-2">三、使用全局样式</h2>
<p>上面定义了两个全局样式<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>o</mi><mi>l</mi><mi>o</mi><mi>r</mi><mtext>、</mtext></mrow><annotation encoding="application/x-tex">color、</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6944em;"/><span class="mord mathnormal">co</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal" style="margin-right:0.02778em;">or</span><span class="mord cjk_fallback">、</span></span></span></span></span>base-size，直接在组件中使用即可。</p>
<pre><code class="hljs language-css" lang="css">&lt;style scoped lang="scss"&gt;
<span class="hljs-selector-tag">div</span> {
  <span class="hljs-selector-tag">h1</span> {
    // 使用全局样式变量$<span class="hljs-attribute">color</span>
    <span class="hljs-attribute">color</span>: $color;
  }
}
&lt;/style&gt;
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Bytebot源码学习]]></title>    <link>https://juejin.cn/post/7576573061581094953</link>    <guid>https://juejin.cn/post/7576573061581094953</guid>    <pubDate>2025-11-26T03:48:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576573061581094953" data-draft-id="7576573061581062185" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Bytebot源码学习"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-26T03:48:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倾墨"/> <meta itemprop="url" content="https://juejin.cn/user/2762426987062861"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Bytebot源码学习
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2762426987062861/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倾墨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T03:48:38.000Z" title="Wed Nov 26 2025 03:48:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读19分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文档详细介绍 Bytebot 项目中各个包的功能、原理和实现细节。</p>
<p>仓库地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbytebot-ai%2Fbytebot" target="_blank" title="https://github.com/bytebot-ai/bytebot" ref="nofollow noopener noreferrer">github.com/bytebot-ai/…</a></p>
<h2 data-id="heading-0"><strong>概述</strong></h2>
<blockquote>
<p>Bytebot 是一个开源的自托管 AI 桌面代理系统，通过 LLM 的强大理解能力和桌面自动化的精确执行，Bytebot 实现了"给 AI 一台自己的电脑"的愿景，让 AI 能够像人类一样操作计算机完成复杂任务。</p>
</blockquote>
<p>简洁来说就是，可以通过对话的形式（当然也可以创建任务）让AI自动操作虚拟桌面</p>
<h2 data-id="heading-1"><strong>架构图</strong></h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cb9920cd93d14b759cb6fe9a1164d70d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YC-5aKo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764733718&amp;x-signature=XJUXut%2FKT%2F%2B3YEAcgr2EkE0SHzY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2"><strong>核心概念理解</strong></h2>
<h3 data-id="heading-3">虚拟桌面</h3>
<blockquote>
<p>虚拟桌面是一种在计算机上创建和运行图形化桌面环境的技术，但这个环境并不是直接显示在物理屏幕上，而是运行在内存中或通过网络远程访问。</p>
</blockquote>
<p><strong>物理桌面 vs 虚拟桌面</strong></p>






























<table><thead><tr><th>特性</th><th>物理桌面</th><th>虚拟桌面</th></tr></thead><tbody><tr><td>显示输出</td><td>直接连接显示器</td><td>无物理显示输出</td></tr><tr><td>硬件要求</td><td>需要显卡、显示器</td><td>只需 CPU 和内存</td></tr><tr><td>访问方式</td><td>直接观看</td><td>远程连接、网络访问</td></tr><tr><td>使用场景</td><td>个人日常使用</td><td>服务器、自动化、测试</td></tr></tbody></table>
<h4 data-id="heading-4">如何搭建一个虚拟桌面</h4>
<h5 data-id="heading-5">使用docker</h5>
<ol>
<li>
<h6 data-id="heading-6">创建 Dockerfile</h6>
</li>
</ol>
<p><code>Dockerfile</code></p>
<pre><code class="hljs language-bash" lang="bash">FROM ubuntu:22.04

<span class="hljs-comment"># 设置环境变量</span>
ENV DEBIAN_FRONTEND=noninteractive
ENV DISPLAY=:0

<span class="hljs-comment"># 安装系统依赖</span>
RUN apt-get update &amp;&amp; apt-get install -y \
    <span class="hljs-comment"># 虚拟显示和远程访问</span>
    xvfb x11vnc xauth \
    <span class="hljs-comment"># 桌面环境</span>
    xfce4 xfce4-goodies \
    <span class="hljs-comment"># 工具和应用程序</span>
    firefox-esr gedit mousepad \
    <span class="hljs-comment"># 网络和进程管理</span>
    net-tools supervisor \
    &amp;&amp; apt-get clean \
    &amp;&amp; <span class="hljs-built_in">rm</span> -rf /var/lib/apt/lists/*

<span class="hljs-comment"># 安装 noVNC</span>
RUN apt-get update &amp;&amp; apt-get install -y \
    python3 python3-pip git \
    &amp;&amp; git <span class="hljs-built_in">clone</span> https://github.com/novnc/noVNC.git /opt/noVNC \
    &amp;&amp; git <span class="hljs-built_in">clone</span> https://github.com/novnc/websockify.git /opt/noVNC/utils/websockify

<span class="hljs-comment"># 创建用户</span>
RUN useradd -m -s /bin/bash user &amp;&amp; \
    <span class="hljs-built_in">echo</span> <span class="hljs-string">'user:password'</span> | chpasswd

<span class="hljs-comment"># 复制配置文件</span>
COPY supervisord.conf /etc/supervisor/conf.d/supervisord.conf

<span class="hljs-comment"># 暴露端口</span>
EXPOSE 6080

<span class="hljs-comment"># 启动服务</span>
CMD [<span class="hljs-string">"/usr/bin/supervisord"</span>, <span class="hljs-string">"-c"</span>, <span class="hljs-string">"/etc/supervisor/conf.d/supervisord.conf"</span>, <span class="hljs-string">"-n"</span>]
</code></pre>
<p>通过 noVNC客户端链接在浏览器中查看虚拟桌面</p>
<ol start="2">
<li>
<h6 data-id="heading-7">创建 Supervisor 配置文件</h6>
</li>
</ol>
<blockquote>
<p>Supervisor 进程管理配置文件，用于在 Docker 容器中管理和协调多个服务的启动和运行</p>
</blockquote>
<pre><code class="hljs language-ini" lang="ini">// supervisord.conf
<span class="hljs-section">[supervisord]</span>
<span class="hljs-attr">nodaemon</span>=<span class="hljs-literal">true</span>
<span class="hljs-attr">logfile</span>=/var/log/supervisord.log
<span class="hljs-attr">pidfile</span>=/var/run/supervisord.pid

<span class="hljs-section">[program:xvfb]</span>
<span class="hljs-attr">command</span>=/usr/bin/Xvfb :<span class="hljs-number">0</span> -screen <span class="hljs-number">0</span> <span class="hljs-number">1024</span>x768x24 -ac +extension GLX
<span class="hljs-attr">autorestart</span>=<span class="hljs-literal">true</span>
<span class="hljs-attr">user</span>=user

<span class="hljs-section">[program:xfce4]</span>
<span class="hljs-attr">command</span>=/bin/bash -c <span class="hljs-string">"export DISPLAY=:0 &amp;&amp; /usr/bin/startxfce4"</span>
<span class="hljs-attr">environment</span>=DISPLAY=<span class="hljs-string">":0"</span>
<span class="hljs-attr">autorestart</span>=<span class="hljs-literal">true</span>
<span class="hljs-attr">user</span>=user
<span class="hljs-attr">depends_on</span>=xvfb

<span class="hljs-section">[program:x11vnc]</span>
<span class="hljs-attr">command</span>=/usr/bin/x11vnc -display :<span class="hljs-number">0</span> -forever -shared -noxdamage -passwd password123
<span class="hljs-attr">environment</span>=DISPLAY=<span class="hljs-string">":0"</span>
<span class="hljs-attr">autorestart</span>=<span class="hljs-literal">true</span>
<span class="hljs-attr">user</span>=user
<span class="hljs-attr">depends_on</span>=xfce4

<span class="hljs-section">[program:websockify]</span>
<span class="hljs-attr">command</span>=python3 /opt/noVNC/utils/websockify/websockify.py --web /opt/noVNC <span class="hljs-number">6080</span> localhost:<span class="hljs-number">5900</span>
<span class="hljs-attr">autorestart</span>=<span class="hljs-literal">true</span>
<span class="hljs-attr">user</span>=user
<span class="hljs-attr">depends_on</span>=x11vnc
</code></pre>
<p>3.  ###### 运行和构建</p>

<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 构建镜像</span>
docker build -t <span class="hljs-keyword">virtual</span>-desktop .

<span class="hljs-meta"># 运行容器</span>
docker run -d -p <span class="hljs-number">6080</span>:<span class="hljs-number">6080</span> --name vdesktop <span class="hljs-keyword">virtual</span>-desktop
</code></pre>
<h6 data-id="heading-8">访问虚拟桌面</h6>
<p>打开浏览器访问: <a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A6080%2Fvnc.html" target="_blank" title="http://localhost:6080/vnc.html" ref="nofollow noopener noreferrer">http://localhost:6080/vnc.html</a></p>
<p>密码: password123</p>
<h4 data-id="heading-9"><strong>在 Bytebot 中的具体使用</strong></h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/df6e9c4485f341f3a260abfd0f61a8d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YC-5aKo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764733718&amp;x-signature=6Lwye8fcyevqG3QN1mpZS%2FAoTeM%3D" alt="" loading="lazy"/></p>
<p><strong>前端中使用react-vnc提供的VncComponent组件，可展示虚拟桌面并与其交互</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">VncViewer</span>(<span class="hljs-params">{ viewOnly = <span class="hljs-literal">true</span> }: VncViewerProps</span>) {
  <span class="hljs-comment">// 容器 DOM 引用</span>
  <span class="hljs-keyword">const</span> containerRef = useRef&lt;<span class="hljs-title class_">HTMLDivElement</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-comment">// VNC 组件（动态导入）</span>
  <span class="hljs-comment">// eslint-disable-next-line @typescript-eslint/no-explicit-any</span>
  <span class="hljs-keyword">const</span> [<span class="hljs-title class_">VncComponent</span>, setVncComponent] = useState&lt;<span class="hljs-built_in">any</span>&gt;(<span class="hljs-literal">null</span>);
  <span class="hljs-comment">// WebSocket URL</span>
  <span class="hljs-keyword">const</span> [wsUrl, setWsUrl] = useState&lt;<span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>&gt;(<span class="hljs-literal">null</span>);

  <span class="hljs-comment">// 动态导入 VncScreen 组件（仅在客户端，避免 SSR 问题）</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">import</span>(<span class="hljs-string">"react-vnc"</span>).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">{ VncScreen }</span>) =&gt;</span> {
      <span class="hljs-title function_">setVncComponent</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">VncScreen</span>);
    });
  }, []);

  <span class="hljs-comment">// 构建 WebSocket URL</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// SSR 安全检查</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">window</span> === <span class="hljs-string">"undefined"</span>) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-comment">// 根据当前协议选择 WebSocket 协议（https -&gt; wss, http -&gt; ws）</span>
    <span class="hljs-keyword">const</span> proto = <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">protocol</span> === <span class="hljs-string">"https:"</span> ? <span class="hljs-string">"wss"</span> : <span class="hljs-string">"ws"</span>;
    <span class="hljs-comment">// 构建 WebSocket URL，通过代理路径连接</span>
    <span class="hljs-comment">// wsUrl 后面会被代理到真实的ws路径</span>
    <span class="hljs-title function_">setWsUrl</span>(<span class="hljs-string">'url'</span>, <span class="hljs-string">`<span class="hljs-subst">${proto}</span>://<span class="hljs-subst">${<span class="hljs-variable language_">window</span>.location.host}</span>/api/proxy/websockify`</span>);
  }, []);
  
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">VncComponent</span>
    // <span class="hljs-attr">RFB</span> (<span class="hljs-attr">Remote</span> <span class="hljs-attr">Frame</span> <span class="hljs-attr">Buffer</span>) <span class="hljs-attr">选项</span>
    <span class="hljs-attr">rfbOptions</span>=<span class="hljs-string">{{</span>
    <span class="hljs-attr">secure:</span> <span class="hljs-attr">false</span>, // <span class="hljs-attr">不使用</span> <span class="hljs-attr">TLS</span>
    <span class="hljs-attr">shared:</span> <span class="hljs-attr">true</span>, // <span class="hljs-attr">共享模式</span>（<span class="hljs-attr">多个客户端可以同时连接</span>）
    <span class="hljs-attr">wsProtocols:</span> ["<span class="hljs-attr">binary</span>"], // <span class="hljs-attr">WebSocket</span> <span class="hljs-attr">协议类型</span>
    }}
    // <span class="hljs-attr">autoConnect</span>=<span class="hljs-string">{true}</span> // <span class="hljs-attr">自动连接</span>（<span class="hljs-attr">已注释</span>）
    // <span class="hljs-attr">使用</span> <span class="hljs-attr">key</span> <span class="hljs-attr">来区分只读和交互模式</span>，<span class="hljs-attr">确保组件正确重新渲染</span>
    <span class="hljs-attr">key</span>=<span class="hljs-string">{viewOnly</span> ? "<span class="hljs-attr">view-only</span>" <span class="hljs-attr">:</span> "<span class="hljs-attr">interactive</span>"}
    <span class="hljs-attr">url</span>=<span class="hljs-string">{wsUrl}</span> // <span class="hljs-attr">WebSocket</span> <span class="hljs-attr">URL</span>
    <span class="hljs-attr">scaleViewport</span> // <span class="hljs-attr">缩放视口以适应容器</span>
    <span class="hljs-attr">viewOnly</span>=<span class="hljs-string">{viewOnly}</span> // <span class="hljs-attr">是否只读</span>
    <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">width:</span> "<span class="hljs-attr">100</span>%", <span class="hljs-attr">height:</span> "<span class="hljs-attr">100</span>%" }} // <span class="hljs-attr">全尺寸样式</span>
/&gt;</span></span>
</code></pre>
<p><strong>VncComponent中的url是什么呢？</strong></p>
<p>bytebotd包启动后，会创建桌面端服务，并提供noVNC，因而可通过网页url访问虚拟桌面可视化界面</p>
<p>代码中的url就是指向noVNC链接，因此可以在前端看到虚拟桌面</p>
<p><strong>浏览器远程访问虚拟桌面内部实现</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e875e73a9f6549fe8f83acdbd2448d20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YC-5aKo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764733718&amp;x-signature=AK487m%2F%2FXPfOOMg1l1pnGn%2F9f4U%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>客户端鼠标键盘事件 =》 网络请求 =〉 VNC服务远程执行 =》 VNC传输屏幕画面 =〉 客户端本地显示</p>
</blockquote>
<ul>
<li>
<p><strong>输入传输（客户端 → 服务器）</strong></p>
<ul>
<li>
<pre><code class="hljs language-scss" lang="scss">  用户鼠标/键盘操作
    → react-vnc (编码为 RFB 输入消息)
    → WebSocket 二进制帧
    → 反向代理链
    → websockify (WebSocket → RFB)
    → x11vnc (RFB → X11 输入事件)
    → X11 服务器
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>画面传输（服务器 → 客户端）</strong></p>
<ul>
<li>
<pre><code class="hljs language-scss" lang="scss">  X11 屏幕内容 
    → x11vnc (RFB 协议编码)
    → websockify (RFB → WebSocket 二进制帧)
    → bytebotd (透明转发)
    → Next<span class="hljs-selector-class">.js</span> (透明转发)
    → react-vnc (解码 RFB，渲染到 Canvas)
</code></pre>
</li>
</ul>
</li>
</ul>
<h2 data-id="heading-10"><strong>项目详解</strong></h2>
<h3 data-id="heading-11"><strong>bytebot-ui - 前端用户界面</strong></h3>
<p><strong>描述：</strong> 基于 Next.js 的现代化 Web 界面，提供任务管理和桌面查看功能。</p>
<h4 data-id="heading-12"><strong>技术栈</strong></h4>
<ul>
<li>Next.js 15</li>
<li>React 19</li>
<li>TypeScript</li>
<li>Tailwind CSS</li>
<li>Socket.IO Client</li>
<li>react-vnc: VNC(Virtual Network Computing)客户端组件(让你能在网页上直接显示并操作远程虚拟桌面。)</li>
</ul>
<h4 data-id="heading-13"><strong>页面设计</strong></h4>
<ul>
<li>
<p>首页</p>
<ul>
<li>创建新任务</li>
<li>查看任务列表</li>
<li><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b155746dd4514dc39add872822a2e89c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YC-5aKo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764733718&amp;x-signature=BIAdsQujVnvVjvO9uV7RE%2BSyDzU%3D" alt="" loading="lazy"/></li>
</ul>
</li>
<li>
<p>任务列表、详情页</p>
<ul>
<li><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1ae8d9643764a09946eef58c1f8b201~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YC-5aKo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764733718&amp;x-signature=0QwEfeQSfDtDjN3fhtHe1mQbtuc%3D" alt="" loading="lazy"/></li>
</ul>
</li>
</ul>
<p>可以在右侧与AI的对话界面输入需求，左侧将展示远程桌面的UI</p>
<ul>
<li>
<p>远程桌面</p>
<ul>
<li>可以在线操控远程桌面</li>
<li><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49fa81cff0bb4fa294b25862e70ccafc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YC-5aKo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764733718&amp;x-signature=gWuxPO%2FBWaAKbPpMKDqfsKu%2F2UM%3D" alt="" loading="lazy"/></li>
</ul>
</li>
</ul>
<h4 data-id="heading-14"><strong>接口设计</strong></h4>
<p>server.ts 处理 WebSocket 连接（/api/proxy/tasks 和 /api/proxy/websockify）</p>
<blockquote>
<p>server.ts 第74行把所有请求交给 Next.js，包括 /api/*</p>
</blockquote>
<p>route.ts 处理所有其他 HTTP API 请求（如 /api/tasks/models、/api/tasks 等）</p>
<p><code>server.ts</code></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * Bytebot UI 服务器入口文件
 * 
 * 这个文件负责启动 Next.js 应用服务器，并配置代理中间件来转发请求到后端服务。
 * 主要功能：
 * 1. 启动 Next.js 应用
 * 2. 代理 tasks相关请求 连接到 bytebot-agent
 * 3. 代理 VNC相关请求 连接到 bytebotd
 * 4. 处理所有其他请求到 Next.js
 */</span>

<span class="hljs-keyword">import</span> express <span class="hljs-keyword">from</span> <span class="hljs-string">"express"</span>;
<span class="hljs-keyword">import</span> { createServer } <span class="hljs-keyword">from</span> <span class="hljs-string">"http"</span>;
<span class="hljs-keyword">import</span> { createProxyMiddleware } <span class="hljs-keyword">from</span> <span class="hljs-string">"http-proxy-middleware"</span>;
<span class="hljs-keyword">import</span> { createProxyServer } <span class="hljs-keyword">from</span> <span class="hljs-string">"http-proxy"</span>;
<span class="hljs-keyword">import</span> next <span class="hljs-keyword">from</span> <span class="hljs-string">"next"</span>;
<span class="hljs-keyword">import</span> dotenv <span class="hljs-keyword">from</span> <span class="hljs-string">"dotenv"</span>;

<span class="hljs-comment">// 加载环境变量</span>
dotenv.<span class="hljs-title function_">config</span>();

<span class="hljs-comment">// 获取运行环境配置</span>
<span class="hljs-keyword">const</span> dev = process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> !== <span class="hljs-string">"production"</span>;
<span class="hljs-keyword">const</span> hostname = process.<span class="hljs-property">env</span>.<span class="hljs-property">HOSTNAME</span> || <span class="hljs-string">"localhost"</span>;
<span class="hljs-keyword">const</span> port = <span class="hljs-built_in">parseInt</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span> || <span class="hljs-string">"9992"</span>, <span class="hljs-number">10</span>);

<span class="hljs-comment">// 后端服务 URL 配置</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BYTEBOT_AGENT_BASE_URL</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">BYTEBOT_AGENT_BASE_URL</span>; <span class="hljs-comment">// AI 代理服务地址</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BYTEBOT_DESKTOP_VNC_URL</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">BYTEBOT_DESKTOP_VNC_URL</span>; <span class="hljs-comment">// 桌面 VNC 服务地址</span>

<span class="hljs-comment">// 初始化 Next.js 应用</span>
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">next</span>({ dev, hostname, port });

app
  .<span class="hljs-title function_">prepare</span>()
  .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// HTTP 请求交由 Next.js 的 handle 处理器处理</span>
    <span class="hljs-keyword">const</span> handle = app.<span class="hljs-title function_">getRequestHandler</span>();
    <span class="hljs-comment">// WebSocket 请求交由 nextUpgradeHandler 处理器处理</span>
    <span class="hljs-keyword">const</span> nextUpgradeHandler = app.<span class="hljs-title function_">getUpgradeHandler</span>();

    <span class="hljs-keyword">const</span> expressApp = <span class="hljs-title function_">express</span>();

    <span class="hljs-comment">// 配置 Socket.IO WebSocket 代理（用于连接到 bytebot-agent）</span>
    <span class="hljs-comment">// 将 /api/proxy/tasks 路径重写为 /socket.io，转发到后端 Socket.IO 服务器</span>
    <span class="hljs-keyword">const</span> tasksProxy = <span class="hljs-title function_">createProxyMiddleware</span>({
      <span class="hljs-attr">target</span>: <span class="hljs-variable constant_">BYTEBOT_AGENT_BASE_URL</span>,
      <span class="hljs-attr">ws</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 同时支持 HTTP 和 WebSocket</span>
      <span class="hljs-attr">pathRewrite</span>: { <span class="hljs-string">"^/api/proxy/tasks"</span>: <span class="hljs-string">"/socket.io"</span> },
    });

    <span class="hljs-comment">// 创建 VNC WebSocket 代理服务器</span>
    <span class="hljs-comment">// 使用http-proxy是因为要精细化控制请求和响应的细节</span>
    <span class="hljs-comment">// changeOrigin: true 表示将请求的 Origin头（类似发件人姓名）设置为目标URL</span>
    <span class="hljs-keyword">const</span> vncProxy = <span class="hljs-title function_">createProxyServer</span>({ <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">ws</span>: <span class="hljs-literal">true</span> });

    <span class="hljs-comment">// 应用 HTTP 代理中间件</span>
    expressApp.<span class="hljs-title function_">use</span>(<span class="hljs-string">"/api/proxy/tasks"</span>, tasksProxy);
    
    <span class="hljs-comment">// 代理 VNC WebSocket 连接（用于桌面查看）</span>
    expressApp.<span class="hljs-title function_">use</span>(<span class="hljs-string">"/api/proxy/websockify"</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {
      <span class="hljs-comment">// 重写路径，将 /api/proxy/websockify 转换为目标 VNC 服务的路径</span>
      <span class="hljs-keyword">const</span> targetUrl = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-variable constant_">BYTEBOT_DESKTOP_VNC_URL</span>!);
      req.<span class="hljs-property">url</span> =
        targetUrl.<span class="hljs-property">pathname</span> +
        (req.<span class="hljs-property">url</span>?.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^/</span>api/proxy/websockify/, <span class="hljs-string">""</span>) || <span class="hljs-string">""</span>);
      <span class="hljs-comment">// 使用 http-proxy 转发 HTTP 请求</span>
      vncProxy.<span class="hljs-title function_">web</span>(req, res, {
        <span class="hljs-attr">target</span>: <span class="hljs-string">`<span class="hljs-subst">${targetUrl.protocol}</span>//<span class="hljs-subst">${targetUrl.host}</span>`</span>,
      });
    });

    <span class="hljs-comment">// 处理所有其他请求，交给 Next.js 处理（页面路由、API 路由等）</span>
    expressApp.<span class="hljs-title function_">all</span>(<span class="hljs-string">"*"</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> <span class="hljs-title function_">handle</span>(req, res));

    <span class="hljs-comment">// 为了同时支持 Express 的 HTTP 处理和原生的 WebSocket 升级处理</span>
    <span class="hljs-keyword">const</span> server = <span class="hljs-title function_">createServer</span>(expressApp);

    <span class="hljs-comment">// 处理 WebSocket 连接升级请求</span>
    server.<span class="hljs-title function_">on</span>(<span class="hljs-string">"upgrade"</span>, <span class="hljs-function">(<span class="hljs-params">request, socket, head</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> { pathname } = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(
        request.<span class="hljs-property">url</span>!,
        <span class="hljs-string">`http://<span class="hljs-subst">${request.headers.host}</span>`</span>,
      );

      <span class="hljs-comment">// 如果是任务相关的 WebSocket 连接，升级并转发到 bytebot-agent</span>
      <span class="hljs-keyword">if</span> (pathname.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">"/api/proxy/tasks"</span>)) {
        <span class="hljs-keyword">return</span> tasksProxy.<span class="hljs-title function_">upgrade</span>(request, socket <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>, head);
      }

      <span class="hljs-comment">// 如果是 VNC WebSocket 连接，升级并转发到 bytebotd</span>
      <span class="hljs-keyword">if</span> (pathname.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">"/api/proxy/websockify"</span>)) {
        <span class="hljs-keyword">const</span> targetUrl = <span class="hljs-keyword">new</span> <span class="hljs-title function_">URL</span>(<span class="hljs-variable constant_">BYTEBOT_DESKTOP_VNC_URL</span>!);
        request.<span class="hljs-property">url</span> =
          targetUrl.<span class="hljs-property">pathname</span> +
          (request.<span class="hljs-property">url</span>?.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^/</span>api/proxy/websockify/, <span class="hljs-string">""</span>) || <span class="hljs-string">""</span>);
        <span class="hljs-keyword">return</span> vncProxy.<span class="hljs-title function_">ws</span>(request, socket <span class="hljs-keyword">as</span> <span class="hljs-built_in">any</span>, head, {
          <span class="hljs-attr">target</span>: <span class="hljs-string">`<span class="hljs-subst">${targetUrl.protocol}</span>//<span class="hljs-subst">${targetUrl.host}</span>`</span>,
        });
      }

      <span class="hljs-comment">// 其他 WebSocket 连接交给 Next.js 处理器，比如HMR WebSocket</span>
      <span class="hljs-title function_">nextUpgradeHandler</span>(request, socket, head);
    });

    <span class="hljs-comment">// 启动服务器</span>
    server.<span class="hljs-title function_">listen</span>(port, hostname, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`&gt; Ready on http://<span class="hljs-subst">${hostname}</span>:<span class="hljs-subst">${port}</span>`</span>);
    });
  })
  .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">"Server failed to start:"</span>, err);
    process.<span class="hljs-title function_">exit</span>(<span class="hljs-number">1</span>);
  });
</code></pre>
<p><code>src/app/api/[[...path]]/route.ts</code></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">/**
 * API 路由代理处理器
 * 这个文件实现了 Next.js API 路由的通用代理功能。
 * 所有发送到 /api/* 的请求都会被转发到 bytebot-agent 后端服务。
 * 使用动态路由 [[...path]] 来捕获所有路径段，实现通配符代理。
 */</span>

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NextRequest</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"next/server"</span>;

<span class="hljs-comment">/* -------------------------------------------------------------------- */</span>
<span class="hljs-comment">/* 通用代理辅助函数                                                     */</span>
<span class="hljs-comment">/* -------------------------------------------------------------------- */</span>
<span class="hljs-comment">/**
 * 将请求代理到后端服务
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">req</span> - Next.js 请求对象
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">path</span> - 路径数组（从动态路由捕获）
 * <span class="hljs-doctag">@returns</span> 代理后的响应
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">proxy</span>(<span class="hljs-params">req: NextRequest, path: <span class="hljs-built_in">string</span>[]</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">Response</span>&gt; {
  <span class="hljs-comment">// 获取后端服务的基础 URL</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BASE_URL</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">BYTEBOT_AGENT_BASE_URL</span>!;
  <span class="hljs-comment">// 将路径数组拼接成子路径</span>
  <span class="hljs-keyword">const</span> subPath = path.<span class="hljs-property">length</span> ? path.<span class="hljs-title function_">join</span>(<span class="hljs-string">"/"</span>) : <span class="hljs-string">""</span>;
  <span class="hljs-comment">// 构建完整的目标 URL（包含查询参数）</span>
  <span class="hljs-keyword">const</span> url = <span class="hljs-string">`<span class="hljs-subst">${BASE_URL}</span>/<span class="hljs-subst">${subPath}</span><span class="hljs-subst">${req.nextUrl.search}</span>`</span>;

  <span class="hljs-comment">// 从请求中提取 Cookie（用于身份验证等）</span>
  <span class="hljs-keyword">const</span> cookies = req.<span class="hljs-property">headers</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">"cookie"</span>);

  <span class="hljs-comment">// 构建转发请求的配置</span>
  <span class="hljs-keyword">const</span> <span class="hljs-attr">init</span>: <span class="hljs-title class_">RequestInit</span> = {
    <span class="hljs-attr">method</span>: req.<span class="hljs-property">method</span>,
    <span class="hljs-attr">headers</span>: {
      <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span>,
      <span class="hljs-comment">// 如果有 Cookie，则转发到后端</span>
      ...(cookies &amp;&amp; { <span class="hljs-title class_">Cookie</span>: cookies }),
    },
    <span class="hljs-comment">// GET 和 HEAD 请求不需要请求体</span>
    <span class="hljs-attr">body</span>:
      req.<span class="hljs-property">method</span> === <span class="hljs-string">"GET"</span> || req.<span class="hljs-property">method</span> === <span class="hljs-string">"HEAD"</span>
        ? <span class="hljs-literal">undefined</span>
        : <span class="hljs-keyword">await</span> req.<span class="hljs-title function_">text</span>(),
  };

  <span class="hljs-comment">// 发送请求到后端服务</span>
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(url, init);
  <span class="hljs-keyword">const</span> body = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">text</span>();

  <span class="hljs-comment">// 从后端响应中提取 Set-Cookie 头（用于设置认证 Cookie）</span>
  <span class="hljs-keyword">const</span> setCookieHeaders = res.<span class="hljs-property">headers</span>.<span class="hljs-property">getSetCookie</span>?.() || [];

  <span class="hljs-comment">// 创建响应头</span>
  <span class="hljs-keyword">const</span> responseHeaders = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Headers</span>({
    <span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span>,
  });

  <span class="hljs-comment">// 如果有 Set-Cookie 头，则添加到响应中（保持认证状态）</span>
  setCookieHeaders.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">cookie</span>) =&gt;</span> {
    responseHeaders.<span class="hljs-title function_">append</span>(<span class="hljs-string">"Set-Cookie"</span>, cookie);
  });

  <span class="hljs-comment">// 返回代理后的响应</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Response</span>(body, {
    <span class="hljs-attr">status</span>: res.<span class="hljs-property">status</span>,
    <span class="hljs-attr">headers</span>: responseHeaders,
  });
}

<span class="hljs-comment">/* -------------------------------------------------------------------- */</span>
<span class="hljs-comment">/* 路由处理器                                                           */</span>
<span class="hljs-comment">/* -------------------------------------------------------------------- */</span>
<span class="hljs-comment">/**
 * 路径参数类型
 * 注意：在 Next.js 15+ 中，params 是 Promise 类型
 */</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">PathParams</span> = <span class="hljs-title class_">Promise</span>&lt;{ path?: <span class="hljs-built_in">string</span>[] }&gt;;

<span class="hljs-comment">/**
 * 通用请求处理器
 * 从动态路由中提取路径，然后调用代理函数
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handler</span>(<span class="hljs-params">req: NextRequest, { params }: { params: PathParams }</span>) {
  <span class="hljs-keyword">const</span> { path } = <span class="hljs-keyword">await</span> params;
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">proxy</span>(req, path ?? []);
}

<span class="hljs-comment">// 导出所有 HTTP 方法的处理器</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">GET</span> = handler;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">POST</span> = handler;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PUT</span> = handler;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PATCH</span> = handler;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DELETE</span> = handler;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">OPTIONS</span> = handler;
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">HEAD</span> = handler;
</code></pre>
<h4 data-id="heading-15">执行流程设计</h4>
<h5 data-id="heading-16">任务执行流程</h5>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-number">1</span>. 用户输入任务描述
   ↓
<span class="hljs-number">2</span>. bytebot-ui → HTTP POST → bytebot-agent (创建任务)
   ↓
<span class="hljs-number">3</span>. bytebot-agent → 数据库 (保存任务)
   ↓
<span class="hljs-number">4</span>. bytebot-agent → LLM API (生成操作计划)
   ↓
<span class="hljs-number">5</span>. LLM 返回工具调用 (tool_use)
   ↓
<span class="hljs-number">6</span>. bytebot-agent → bytebotd/computer-use (执行桌面操作)
   ↓
<span class="hljs-number">7</span>. bytebotd → nut-js → 桌面系统 (实际执行)
   ↓
<span class="hljs-number">8</span>. bytebotd → 返回操作结果 → bytebot-agent
   ↓
<span class="hljs-number">9</span>. bytebot-agent → 构建消息 → LLM (继续对话)
   ↓
<span class="hljs-number">10</span>. 循环 <span class="hljs-number">5</span>-<span class="hljs-number">9</span> 直到任务完成
   ↓
<span class="hljs-number">11</span>. bytebot-agent → WebSocket → bytebot-ui (状态更新)
   ↓
<span class="hljs-number">12</span>. 用户看到任务完成
</code></pre>
<h5 data-id="heading-17">实时桌面查看流程</h5>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 用户打开桌面标签
   ↓
<span class="hljs-bullet">2.</span> bytebot-ui → WebSocket → bytebotd/websockify
   ↓
<span class="hljs-bullet">3.</span> bytebotd → 代理 → noVNC (6080)
   ↓
<span class="hljs-bullet">4.</span> noVNC → VNC 服务器 → 桌面画面
   ↓
<span class="hljs-bullet">5.</span> 画面流 → WebSocket → bytebot-ui
   ↓
<span class="hljs-bullet">6.</span> react-vnc 组件渲染画面
</code></pre>
<h5 data-id="heading-18">接管模式流程</h5>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">1.</span> 用户点击"接管"按钮
   ↓
<span class="hljs-bullet">2.</span> bytebot-ui → WebSocket → bytebot-agent (任务暂停)
   ↓
<span class="hljs-bullet">3.</span> bytebot-agent → 事件 → bytebotd (启用输入捕获)
   ↓
<span class="hljs-bullet">4.</span> 用户操作桌面
   ↓
<span class="hljs-bullet">5.</span> bytebotd（uiohook-napi） → 捕获输入事件 =》 发送消息到bytebot-agent
   ↓
<span class="hljs-bullet">6.</span> bytebot-agent → WebSocket → bytebot-ui (实时同步)
   ↓
<span class="hljs-bullet">7.</span> bytebot-ui → VNC → 桌面 (执行操作)
   ↓
<span class="hljs-bullet">8.</span> 用户完成操作，点击"恢复"
   ↓
<span class="hljs-bullet">9.</span> bytebot-agent → 继续任务执行
</code></pre>
<h3 data-id="heading-19"><strong>bytebot-agent - AI 代理服务</strong></h3>
<p><strong>描述：</strong> 系统的"大脑"，负责理解用户任务、制定执行计划、协调桌面操作，并与 LLM 进行交互。</p>
<p><strong>技术栈：</strong></p>
<ul>
<li>NestJS 框架</li>
<li>Prisma ORM: 数据库操作</li>
<li>Socket.IO: 实时通信</li>
<li>支持多种 LLM: Anthropic Claude, OpenAI GPT, Google Gemini</li>
</ul>
<p><strong>目录结构</strong></p>
<pre><code class="hljs language-ini" lang="ini">bytebot-agent/
├── src/
│   ├── agent/              <span class="hljs-comment">###  AI 代理核心模块</span>
│   │   ├── agent.processor.ts      <span class="hljs-comment">###  任务处理器（核心）</span>
│   │   ├── agent.scheduler.ts       <span class="hljs-comment">###  任务调度器</span>
│   │   ├── agent.tools.ts           <span class="hljs-comment">###  工具定义</span>
│   │   ├── agent.computer-use.ts    <span class="hljs-comment">###  计算机操作处理</span>
│   │   ├── agent.analytics.ts       <span class="hljs-comment">###  分析服务</span>
│   │   ├── input-capture.service.ts <span class="hljs-comment">###  输入捕获服务</span>
│   │   ├── agent.module.ts         <span class="hljs-comment">###  代理模块</span>
│   │   ├── agent.types.ts          <span class="hljs-comment">###  类型定义</span>
│   │   └── agent.constants.ts      <span class="hljs-comment">###  常量定义</span>
│   ├── anthropic/         <span class="hljs-comment">###  Anthropic Claude API 服务</span>
│   ├── openai/            <span class="hljs-comment">###  OpenAI API 服务</span>
│   ├── google/            <span class="hljs-comment">###  Google Gemini API 服务</span>
│   ├── proxy/             <span class="hljs-comment">###  LLM 代理服务</span>
│   ├── tasks/             <span class="hljs-comment">###  任务管理模块</span>
│   ├── messages/          <span class="hljs-comment">###  消息管理模块</span>
│   ├── summaries/         <span class="hljs-comment">###  消息摘要模块</span>
│   ├── prisma/            <span class="hljs-comment">###  Prisma ORM 模块</span>
│   ├── app.module.ts      <span class="hljs-comment">###  应用根模块</span>
│   └── main.ts            <span class="hljs-comment">###  应用入口</span>
└── prisma/                <span class="hljs-comment">###  Prisma 数据库模式</span>
    └── schema.prisma
</code></pre>
<h4 data-id="heading-20"><strong>模块化设计</strong></h4>
<p>包采用 NestJS 的模块化架构，主要模块包括：</p>
<ul>
<li><strong>AppModule</strong>: 应用根模块，整合所有功能模块</li>
<li><strong>AgentModule</strong>: AI 代理核心模块，包含处理器、调度器等</li>
<li><strong>TasksModule</strong>: 任务管理模块，提供任务 CRUD 和状态管理</li>
<li><strong>MessagesModule</strong>: 消息管理模块，处理对话消息</li>
<li><strong>SummariesModule</strong>: 摘要模块，管理长对话的摘要</li>
<li><strong>LLM 服务模块</strong>: AnthropicModule、OpenAIModule、GoogleModule、ProxyModule</li>
</ul>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NestFactory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/core'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.module'</span>;
<span class="hljs-keyword">import</span> { webcrypto } <span class="hljs-keyword">from</span> <span class="hljs-string">'crypto'</span>;
<span class="hljs-keyword">import</span> { json, urlencoded } <span class="hljs-keyword">from</span> <span class="hljs-string">'express'</span>;

<span class="hljs-comment">/**
 * 应用程序启动函数
 * 初始化 NestJS 应用，配置中间件和 CORS，并启动服务器
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Starting bytebot-agent application...'</span>);

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">AppModule</span>);

    <span class="hljs-comment">// 配置请求体解析器，增加负载大小限制（50MB），用于处理大文件上传</span>
    app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">json</span>({ <span class="hljs-attr">limit</span>: <span class="hljs-string">'50mb'</span> }));
    app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">urlencoded</span>({ <span class="hljs-attr">limit</span>: <span class="hljs-string">'50mb'</span>, <span class="hljs-attr">extended</span>: <span class="hljs-literal">true</span> }));

    <span class="hljs-comment">// 启用跨域资源共享（CORS），允许所有来源访问</span>
    app.<span class="hljs-title function_">enableCors</span>({
      <span class="hljs-attr">origin</span>: <span class="hljs-string">'*'</span>,
      <span class="hljs-attr">methods</span>: [<span class="hljs-string">'GET'</span>, <span class="hljs-string">'POST'</span>, <span class="hljs-string">'PUT'</span>, <span class="hljs-string">'DELETE'</span>, <span class="hljs-string">'OPTIONS'</span>, <span class="hljs-string">'PATCH'</span>],
    });

    <span class="hljs-comment">// 启动服务器，监听指定端口（默认 9991）</span>
    <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">listen</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">PORT</span> ?? <span class="hljs-number">9991</span>);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Error starting application:'</span>, error);
  }
}
<span class="hljs-title function_">bootstrap</span>();
</code></pre>
<p><code>app.module.ts</code></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.controller'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.service'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AgentModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./agent/agent.module'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TasksModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./tasks/tasks.module'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">MessagesModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./messages/messages.module'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AnthropicModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./anthropic/anthropic.module'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">OpenAIModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./openai/openai.module'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">GoogleModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./google/google.module'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./prisma/prisma.module'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ScheduleModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/schedule'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">EventEmitterModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/event-emitter'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">SummariesModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./summaries/summaries.modue'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ProxyModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./proxy/proxy.module'</span>;

<span class="hljs-comment">/**
 * 应用程序根模块
 * 负责导入和配置所有功能模块
 */</span>
<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [
    <span class="hljs-comment">// 定时任务模块，用于调度任务执行</span>
    <span class="hljs-title class_">ScheduleModule</span>.<span class="hljs-title function_">forRoot</span>(),
    <span class="hljs-comment">// 事件发射器模块，用于模块间事件通信</span>
    <span class="hljs-title class_">EventEmitterModule</span>.<span class="hljs-title function_">forRoot</span>(),
    <span class="hljs-comment">// 配置模块，全局可用，用于读取环境变量</span>
    <span class="hljs-title class_">ConfigModule</span>.<span class="hljs-title function_">forRoot</span>({
      <span class="hljs-attr">isGlobal</span>: <span class="hljs-literal">true</span>,
    }),
    <span class="hljs-comment">// 核心业务模块</span>
    <span class="hljs-title class_">AgentModule</span>,        <span class="hljs-comment">// AI 代理处理模块</span>
    <span class="hljs-title class_">TasksModule</span>,         <span class="hljs-comment">// 任务管理模块</span>
    <span class="hljs-title class_">MessagesModule</span>,      <span class="hljs-comment">// 消息管理模块</span>
    <span class="hljs-title class_">SummariesModule</span>,     <span class="hljs-comment">// 消息摘要模块</span>
    <span class="hljs-comment">// LLM 服务模块</span>
    <span class="hljs-title class_">AnthropicModule</span>,     <span class="hljs-comment">// Anthropic Claude API 服务</span>
    <span class="hljs-title class_">OpenAIModule</span>,        <span class="hljs-comment">// OpenAI API 服务</span>
    <span class="hljs-title class_">GoogleModule</span>,        <span class="hljs-comment">// Google Gemini API 服务</span>
    <span class="hljs-title class_">ProxyModule</span>,         <span class="hljs-comment">// LLM 代理服务</span>
    <span class="hljs-comment">// 数据访问模块</span>
    <span class="hljs-title class_">PrismaModule</span>,        <span class="hljs-comment">// Prisma ORM 数据库访问模块</span>
  ],
  <span class="hljs-attr">controllers</span>: [<span class="hljs-title class_">AppController</span>],
  <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">AppService</span>],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> {}
</code></pre>
<h4 data-id="heading-21">数据库设计</h4>
<pre><code class="hljs language-bash" lang="bash">bytebot-project/
├── .<span class="hljs-built_in">env</span>                    <span class="hljs-comment"># 环境变量文件</span>
├── prisma/
│   ├── schema.prisma       <span class="hljs-comment"># 数据模型定义</span>
│   └── migrations/         <span class="hljs-comment"># 数据库迁移文件</span>
├── src/
│   ├── prisma.service.ts   <span class="hljs-comment"># Prisma 服务</span>
│   └── prisma.module.ts    <span class="hljs-comment"># Prisma </span>
└── package.json
</code></pre>
<ol>
<li><strong>创建 Prisma 配置</strong></li>
</ol>
<p><code>schema.prisma</code></p>
<blockquote>
<p>Prisma 的核心配置文件，它定义了数据模型、数据库连接和生成器配置</p>
</blockquote>
<pre><code class="hljs language-kotlin" lang="kotlin">generator client {
  provider = <span class="hljs-string">"prisma-client-js"</span>
}

datasource db {
  provider = <span class="hljs-string">"postgresql"</span>
  url      = env(<span class="hljs-string">"DATABASE_URL"</span>)
}

<span class="hljs-keyword">enum</span> TaskStatus {
  PENDING
  RUNNING
  NEEDS_HELP
  NEEDS_REVIEW
  COMPLETED
  CANCELLED
  FAILED
}

<span class="hljs-keyword">enum</span> TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

<span class="hljs-keyword">enum</span> Role {
  USER
  ASSISTANT
}

<span class="hljs-keyword">enum</span> TaskType {
  IMMEDIATE
  SCHEDULED
}

model Task {
  id            String        <span class="hljs-meta">@id</span> <span class="hljs-meta">@default(uuid())</span>
  description   String
  type          TaskType      <span class="hljs-meta">@default(IMMEDIATE)</span>
  status        TaskStatus    <span class="hljs-meta">@default(PENDING)</span>
  priority      TaskPriority  <span class="hljs-meta">@default(MEDIUM)</span>
  control       Role          <span class="hljs-meta">@default(ASSISTANT)</span>
  createdAt     DateTime      <span class="hljs-meta">@default(now())</span>
  createdBy     Role          <span class="hljs-meta">@default(USER)</span>
  scheduledFor  DateTime?
  updatedAt     DateTime      <span class="hljs-meta">@updatedAt</span>
  executedAt    DateTime?
  completedAt   DateTime?
  queuedAt      DateTime?
  error         String?
  result        Json?
  <span class="hljs-comment">// Example: </span>
  <span class="hljs-comment">// { "provider": "anthropic", "name": "claude-opus-4-20250514", "title": "Claude Opus 4" }</span>
  model         Json
  messages      Message[]
  summaries     Summary[]
  files         File[]
}

model Summary {
  id             String     <span class="hljs-meta">@id</span> <span class="hljs-meta">@default(uuid())</span>
  content        String
  createdAt      DateTime   <span class="hljs-meta">@default(now())</span>
  updatedAt      DateTime   <span class="hljs-meta">@updatedAt</span>
  messages       Message[]  <span class="hljs-comment">// One-to-many relationship: one Summary has many Messages</span>

  task      Task        <span class="hljs-meta">@relation(fields: [taskId], references: [id], onDelete: Cascade)</span>
  taskId    String
  
  <span class="hljs-comment">// Self-referential relationship</span>
  parentSummary  Summary?   <span class="hljs-meta">@relation(<span class="hljs-string">"SummaryHierarchy"</span>, fields: [parentId], references: [id])</span>
  parentId       String?
  childSummaries Summary[]  <span class="hljs-meta">@relation(<span class="hljs-string">"SummaryHierarchy"</span>)</span>
}

model Message {
  id        String      <span class="hljs-meta">@id</span> <span class="hljs-meta">@default(uuid())</span>
  <span class="hljs-comment">// Content field follows Anthropic's content blocks structure</span>
  <span class="hljs-comment">// Example: </span>
  <span class="hljs-comment">// [</span>
  <span class="hljs-comment">//   {"type": "text", "text": "Hello world"},</span>
  <span class="hljs-comment">//   {"type": "image", "source": {"type": "base64", "media_type": "image/jpeg", "data": "..."}}</span>
  <span class="hljs-comment">// ]</span>
  content   Json
  role      Role <span class="hljs-meta">@default(ASSISTANT)</span>
  createdAt DateTime    <span class="hljs-meta">@default(now())</span>
  updatedAt DateTime    <span class="hljs-meta">@updatedAt</span>
  task      Task        <span class="hljs-meta">@relation(fields: [taskId], references: [id], onDelete: Cascade)</span>
  taskId    String
  summary   Summary?    <span class="hljs-meta">@relation(fields: [summaryId], references: [id])</span>
  summaryId String?     <span class="hljs-comment">// Optional foreign key to Summary</span>
}

model File {
  id            String      <span class="hljs-meta">@id</span> <span class="hljs-meta">@default(uuid())</span>
  name          String
  type          String      <span class="hljs-comment">// MIME type</span>
  size          <span class="hljs-built_in">Int</span>         <span class="hljs-comment">// Size in bytes</span>
  <span class="hljs-keyword">data</span>          String      <span class="hljs-comment">// Base64 encoded file data</span>
  createdAt     DateTime    <span class="hljs-meta">@default(now())</span>
  updatedAt     DateTime    <span class="hljs-meta">@updatedAt</span>
  
  <span class="hljs-comment">// Relations</span>
  task          Task        <span class="hljs-meta">@relation(fields: [taskId], references: [id], onDelete: Cascade)</span>
  taskId        String
}
</code></pre>
<p>2.  <strong>使用 schema.prisma</strong></p>
<ul>
<li>
<p>生成 Prisma Client</p>
<ul>
<li>
<blockquote>
<p>这会生成 @prisma/client，包含类型安全的数据库操作方法</p>
</blockquote>
</li>
<li>
<pre><code class="hljs language-bash" lang="bash">  <span class="hljs-comment"># 根据 schema 生成客户端</span>
  npx prisma generate
</code></pre>
</li>
</ul>
</li>
<li>
<p>创建数据库迁移</p>
<ul>
<li>
<pre><code class="hljs language-bash" lang="bash">  <span class="hljs-comment"># 根据 schema 变化创建迁移文件</span>
  npx prisma migrate dev --name <span class="hljs-string">"add_user_profile"</span>

  <span class="hljs-comment"># 应用迁移到数据库</span>
  npx prisma migrate deploy
</code></pre>
</li>
</ul>
</li>
</ul>
<ol start="3">
<li>
<p><strong>创建 Prisma 服务</strong></p>
<ol>
<li>
<pre><code class="hljs language-scala" lang="scala"> <span class="hljs-comment">// prisma.service.ts</span>
 <span class="hljs-keyword">import</span> { <span class="hljs-type">Injectable</span>, <span class="hljs-type">OnModuleInit</span> } from '<span class="hljs-meta">@nestjs</span>/common';
 <span class="hljs-keyword">import</span> { <span class="hljs-type">PrismaClient</span> } from '<span class="hljs-meta">@prisma</span>/client';

 <span class="hljs-meta">@Injectable</span>()
 <span class="hljs-keyword">export</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PrismaService</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">PrismaClient</span> <span class="hljs-title">implements</span> <span class="hljs-title">OnModuleInit</span> </span>{
   constructor() {
     <span class="hljs-keyword">super</span>();
   }

   async onModuleInit() {
     await <span class="hljs-keyword">this</span>.$connect();
   }
 }
</code></pre>
</li>
</ol>
</li>
<li>
<p><strong>创建 Prisma 模块</strong></p>
<ol>
<li>
<pre><code class="hljs language-typescript" lang="typescript"> <span class="hljs-keyword">import</span> { <span class="hljs-title class_">Global</span>, <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;

 <span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./prisma.service'</span>;

 <span class="hljs-meta">@Global</span>()
 <span class="hljs-meta">@Module</span>({
   <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">PrismaService</span>], <span class="hljs-comment">// 注册服务</span>
   <span class="hljs-attr">exports</span>: [<span class="hljs-title class_">PrismaService</span>], <span class="hljs-comment">// 导出供其他模块使用</span>
 })
 <span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PrismaModule</span> {}
</code></pre>
</li>
</ol>
</li>
<li>
<p>在业务模块中使用</p>
<ol>
<li>
<pre><code class="hljs language-typescript" lang="typescript"> <span class="hljs-comment">// user.module.ts</span>
 <span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
 <span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user.service'</span>;
 <span class="hljs-keyword">import</span> { <span class="hljs-title class_">UserController</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./user.controller'</span>;
 <span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../prisma/prisma.module'</span>;

 <span class="hljs-meta">@Module</span>({
   <span class="hljs-attr">imports</span>: [<span class="hljs-title class_">PrismaModule</span>], <span class="hljs-comment">// 导入 Prisma 模块</span>
   <span class="hljs-attr">controllers</span>: [<span class="hljs-title class_">UserController</span>],
   <span class="hljs-attr">providers</span>: [<span class="hljs-title class_">UserService</span>],
 })
 <span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserModule</span> {}
</code></pre>
</li>
</ol>
</li>
<li>
<p>在服务中使用 Prisma</p>
<ol>
<li>
<pre><code class="hljs language-typescript" lang="typescript"> <span class="hljs-comment">// user.service.ts</span>
 <span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
 <span class="hljs-keyword">import</span> { <span class="hljs-title class_">PrismaService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../prisma/prisma.service'</span>;
 <span class="hljs-keyword">import</span> { <span class="hljs-title class_">CreateUserDto</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./dto/create-user.dto'</span>;
 <span class="hljs-keyword">import</span> { <span class="hljs-title class_">UpdateUserDto</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./dto/update-user.dto'</span>;

 <span class="hljs-meta">@Injectable</span>()
 <span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {
   <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> prisma: PrismaService</span>) {}

   <span class="hljs-comment">// 创建用户</span>
   <span class="hljs-keyword">async</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">createUserDto: CreateUserDto</span>) {
     <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.<span class="hljs-property">user</span>.<span class="hljs-title function_">create</span>({
       <span class="hljs-attr">data</span>: createUserDto,
     });
   }

   <span class="hljs-comment">// 查找所有用户</span>
   <span class="hljs-keyword">async</span> <span class="hljs-title function_">findAll</span>(<span class="hljs-params"/>) {
     <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.<span class="hljs-property">user</span>.<span class="hljs-title function_">findMany</span>({
       <span class="hljs-attr">include</span>: {
         <span class="hljs-attr">posts</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 包含关联的 posts</span>
       },
     });
   }

   <span class="hljs-comment">// 根据 ID 查找用户</span>
   <span class="hljs-keyword">async</span> <span class="hljs-title function_">findOne</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {
     <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.<span class="hljs-property">user</span>.<span class="hljs-title function_">findUnique</span>({
       <span class="hljs-attr">where</span>: { id },
       <span class="hljs-attr">include</span>: { <span class="hljs-attr">posts</span>: <span class="hljs-literal">true</span> },
     });
   }

   <span class="hljs-comment">// 根据邮箱查找用户</span>
   <span class="hljs-keyword">async</span> <span class="hljs-title function_">findByEmail</span>(<span class="hljs-params">email: <span class="hljs-built_in">string</span></span>) {
     <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.<span class="hljs-property">user</span>.<span class="hljs-title function_">findUnique</span>({
       <span class="hljs-attr">where</span>: { email },
     });
   }

   <span class="hljs-comment">// 更新用户</span>
   <span class="hljs-keyword">async</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span>, updateUserDto: UpdateUserDto</span>) {
     <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.<span class="hljs-property">user</span>.<span class="hljs-title function_">update</span>({
       <span class="hljs-attr">where</span>: { id },
       <span class="hljs-attr">data</span>: updateUserDto,
     });
   }

   <span class="hljs-comment">// 删除用户</span>
   <span class="hljs-keyword">async</span> <span class="hljs-title function_">remove</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span></span>) {
     <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">prisma</span>.<span class="hljs-property">user</span>.<span class="hljs-title function_">delete</span>({
       <span class="hljs-attr">where</span>: { id },
     });
   }
 }
</code></pre>
</li>
</ol>
</li>
</ol>
<h4 data-id="heading-22">任务处理流程设计</h4>
<h5 data-id="heading-23">任务调度</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">Logger</span>, <span class="hljs-title class_">OnModuleInit</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Cron</span>, <span class="hljs-title class_">CronExpression</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/schedule'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TasksService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../tasks/tasks.service'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AgentProcessor</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./agent.processor'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TaskStatus</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@prisma/client'</span>;
<span class="hljs-keyword">import</span> { writeFile } <span class="hljs-keyword">from</span> <span class="hljs-string">'./agent.computer-use'</span>;

<span class="hljs-comment">/**
 * 任务调度器
 * 负责定时检查待执行的任务，并将任务提交给 AgentProcessor 处理
 * 主要功能：
 * 1. 检查并激活已到期的定时任务
 * 2. 查找下一个待执行的任务（按优先级排序）
 * 3. 将任务文件写入桌面
 * 4. 启动任务处理
 */</span>
<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AgentScheduler</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OnModuleInit</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> logger = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Logger</span>(<span class="hljs-title class_">AgentScheduler</span>.<span class="hljs-property">name</span>);

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> tasksService: TasksService,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> agentProcessor: AgentProcessor,
  </span>) {}

  <span class="hljs-comment">/**
   * 模块初始化时执行
   * 立即执行一次任务检查，然后由定时任务接管
   */</span>
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">onModuleInit</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'AgentScheduler initialized'</span>);
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleCron</span>();
  }

  <span class="hljs-comment">/**
   * 定时任务处理函数
   * 每 5 秒执行一次，检查并处理待执行的任务
   */</span>
  <span class="hljs-meta">@Cron</span>(<span class="hljs-title class_">CronExpression</span>.<span class="hljs-property">EVERY_5_SECONDS</span>)
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleCron</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> now = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();
    
    <span class="hljs-comment">// 检查所有定时任务，如果到期则加入队列</span>
    <span class="hljs-keyword">const</span> scheduledTasks = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasksService</span>.<span class="hljs-title function_">findScheduledTasks</span>();
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> scheduledTask <span class="hljs-keyword">of</span> scheduledTasks) {
      <span class="hljs-keyword">if</span> (scheduledTask.<span class="hljs-property">scheduledFor</span> &amp;&amp; scheduledTask.<span class="hljs-property">scheduledFor</span> &lt; now) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">debug</span>(
          <span class="hljs-string">`Task ID: <span class="hljs-subst">${scheduledTask.id}</span> is scheduled for <span class="hljs-subst">${scheduledTask.scheduledFor}</span>, queuing it`</span>,
        );
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasksService</span>.<span class="hljs-title function_">update</span>(scheduledTask.<span class="hljs-property">id</span>, {
          <span class="hljs-attr">queuedAt</span>: now,
        });
      }
    }

    <span class="hljs-comment">// 如果处理器正在运行，跳过本次检查</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">agentProcessor</span>.<span class="hljs-title function_">isRunning</span>()) {
      <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 查找下一个待执行的任务（按优先级排序）</span>
    <span class="hljs-keyword">const</span> task = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasksService</span>.<span class="hljs-title function_">findNextTask</span>();
    <span class="hljs-keyword">if</span> (task) {
      <span class="hljs-comment">// 如果任务包含文件，先将文件写入桌面</span>
      <span class="hljs-keyword">if</span> (task.<span class="hljs-property">files</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">debug</span>(
          <span class="hljs-string">`Task ID: <span class="hljs-subst">${task.id}</span> has files, writing them to the desktop`</span>,
        );
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> file <span class="hljs-keyword">of</span> task.<span class="hljs-property">files</span>) {
          <span class="hljs-keyword">await</span> <span class="hljs-title function_">writeFile</span>({
            <span class="hljs-attr">path</span>: <span class="hljs-string">`/home/user/Desktop/<span class="hljs-subst">${file.name}</span>`</span>,
            <span class="hljs-attr">content</span>: file.<span class="hljs-property">data</span>, <span class="hljs-comment">// file.data 在数据库中已经是 base64 编码</span>
          });
        }
      }

      <span class="hljs-comment">// 更新数据库中任务状态为运行中，并记录执行时间</span>
      <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">tasksService</span>.<span class="hljs-title function_">update</span>(task.<span class="hljs-property">id</span>, {
        <span class="hljs-attr">status</span>: <span class="hljs-title class_">TaskStatus</span>.<span class="hljs-property">RUNNING</span>,
        <span class="hljs-attr">executedAt</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(),
      });
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">debug</span>(<span class="hljs-string">`Processing task ID: <span class="hljs-subst">${task.id}</span>`</span>);
      
      <span class="hljs-comment">// 启动任务处理</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">agentProcessor</span>.<span class="hljs-title function_">processTask</span>(task.<span class="hljs-property">id</span>);
    }
  }
}
</code></pre>
<h5 data-id="heading-24">任务处理</h5>
<h6 data-id="heading-25">步骤</h6>
<p>步骤 1: LLM 分析任务和上下文</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 1. 获取任务和消息历史</span>
<span class="hljs-keyword">const</span> task = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.tasksService.findById(taskId);
<span class="hljs-keyword">const</span> latestSummary = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.summariesService.findLatest(taskId);
<span class="hljs-keyword">const</span> unsummarizedMessages = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.messagesService.findUnsummarized(taskId);

<span class="hljs-comment">// 2. 构建消息列表（包含摘要和未摘要的消息）</span>
<span class="hljs-keyword">const</span> messages = [
  ...(latestSummary ? [摘要消息] : []),
  ...unsummarizedMessages,  <span class="hljs-comment">// 包含：用户消息、助手消息、工具结果、用户操作等</span>
];

<span class="hljs-comment">// 3. 调用 LLM 生成响应</span>
agentResponse = <span class="hljs-keyword">await</span> service.generateMessage(
  AGENT_SYSTEM_PROMPT,  <span class="hljs-comment">// 系统提示词，定义 AI 的行为</span>
  messages,              <span class="hljs-comment">// 完整的对话历史</span>
  model.name,
  <span class="hljs-literal">true</span>,                 <span class="hljs-comment">// 启用工具调用</span>
  abortController.signal
);
</code></pre>
<p>步骤 2: 执行工具调用</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// LLM 返回的内容块可能包含工具调用</span>
for (const block of messageContentBlocks) {
  if (isComputerToolUseContentBlock(block)) {
    <span class="hljs-comment">// 执行计算机操作工具</span>
    const result = await <span class="hljs-built_in">handleComputerToolUse</span>(block, this.logger);
    generatedToolResults<span class="hljs-selector-class">.push</span>(result);
  }
  <span class="hljs-comment">// ... 其他工具类型</span>
}
</code></pre>
<p>步骤 3: 虚拟桌面执行操作</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 例如：点击鼠标操作</span>
async <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clickMouse</span>(<span class="hljs-params">input</span>) </span>{
  <span class="hljs-comment">// 通过 REST API 发送到虚拟桌面</span>
  await <span class="hljs-title function_ invoke__">fetch</span>(`${BYTEBOT_DESKTOP_BASE_URL}/computer-<span class="hljs-keyword">use</span>`, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">headers</span>: { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span> },
    <span class="hljs-attr">body</span>: JSON.<span class="hljs-title function_ invoke__">stringify</span>({
      <span class="hljs-attr">action</span>: <span class="hljs-string">'click_mouse'</span>,
      <span class="hljs-attr">coordinates</span>: { <span class="hljs-attr">x</span>: <span class="hljs-number">100</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">200</span> },
      <span class="hljs-attr">button</span>: <span class="hljs-string">'left'</span>,
      <span class="hljs-attr">clickCount</span>: <span class="hljs-number">1</span>
    })
  });
}
</code></pre>
<p>执行流程</p>
<pre><code class="hljs language-scss" lang="scss">Agent (HTTP POST)
    ↓
bytebotd/computer-use (REST API)
    ↓
ComputerUseService<span class="hljs-selector-class">.action</span>()
    ↓
NutService (底层 uiohook-napi)
    ↓
实际桌面操作（鼠标移动、点击、键盘输入）
</code></pre>
<p>步骤 4: 用户操作（可选）</p>
<p>如果用户在此时手动操作桌面：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// bytebotd 端：InputTrackingService 监听用户输入</span>
uIOhook.<span class="hljs-keyword">on</span>(<span class="hljs-string">'mousedown'</span>, (<span class="hljs-keyword">event</span>) =&gt; {
  <span class="hljs-comment">// 捕获鼠标点击</span>
  <span class="hljs-keyword">const</span> action = convertToComputerAction(<span class="hljs-keyword">event</span>);
  gateway.emitScreenshotAndAction(screenshot, action);
});

<span class="hljs-comment">// bytebot-agent 端：InputCaptureService 接收</span>
socket.<span class="hljs-keyword">on</span>(<span class="hljs-string">'screenshotAndAction'</span>, <span class="hljs-keyword">async</span> (shot, action) =&gt; {
  <span class="hljs-comment">// 转换为用户操作消息</span>
  <span class="hljs-keyword">const</span> userActionBlock = {
    type: MessageContentType.UserAction,
    content: [
      { type: MessageContentType.Image, source: { data: shot.image } },
      convertClickMouseActionToToolUseBlock(action, toolUseId)
    ]
  };
  
  <span class="hljs-comment">// 保存为用户消息</span>
  <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.messagesService.create({
    content: [userActionBlock],
    role: Role.USER,
    taskId
  });
});
</code></pre>
<ul>
<li>用户操作通过 WebSocket 实时发送</li>
<li>自动转换为 UserActionContentBlock 并保存</li>
</ul>
<p>步骤 5: 获取操作结果</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 执行工具后，自动获取结果</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">image</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;
<span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">750</span>)); <span class="hljs-comment">// 等待 UI 稳定</span>
  image = <span class="hljs-keyword">await</span> <span class="hljs-title function_">screenshot</span>(); <span class="hljs-comment">// 获取操作后的截图</span>
} <span class="hljs-keyword">catch</span> (error) {
  logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Failed to take screenshot'</span>, error);
}

<span class="hljs-comment">// 构建工具结果</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">toolResult</span>: <span class="hljs-title class_">ToolResultContentBlock</span> = {
  <span class="hljs-attr">type</span>: <span class="hljs-title class_">MessageContentType</span>.<span class="hljs-property">ToolResult</span>,
  <span class="hljs-attr">tool_use_id</span>: block.<span class="hljs-property">id</span>,
  <span class="hljs-attr">content</span>: [
    { <span class="hljs-attr">type</span>: <span class="hljs-title class_">MessageContentType</span>.<span class="hljs-property">Text</span>, <span class="hljs-attr">text</span>: <span class="hljs-string">'Tool executed successfully'</span> },
    { <span class="hljs-attr">type</span>: <span class="hljs-title class_">MessageContentType</span>.<span class="hljs-property">Image</span>, <span class="hljs-attr">source</span>: { <span class="hljs-attr">data</span>: image } } <span class="hljs-comment">// 截图</span>
  ]
};
</code></pre>
<p>步骤 6: 继续下一轮迭代</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 保存工具结果</span>
<span class="hljs-keyword">if</span> (generatedToolResults.length &gt; <span class="hljs-number">0</span>) {
  await <span class="hljs-keyword">this</span>.messagesService.create({
    content: generatedToolResults,
    role: Role.USER,  <span class="hljs-comment">// 工具结果作为用户消息</span>
    taskId
  });
}

<span class="hljs-comment">// 检查任务状态</span>
<span class="hljs-keyword">if</span> (setTaskStatusToolUseBlock) {
  <span class="hljs-comment">// LLM 调用了 set_task_status 工具</span>
  <span class="hljs-keyword">if</span> (status === <span class="hljs-string">'completed'</span>) {
    await <span class="hljs-keyword">this</span>.tasksService.update(taskId, { status: TaskStatus.COMPLETED });
    <span class="hljs-keyword">this</span>.isProcessing = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 停止循环</span>
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (status === <span class="hljs-string">'needs_help'</span>) {
    await <span class="hljs-keyword">this</span>.tasksService.update(taskId, { status: TaskStatus.NEEDS_HELP });
    <span class="hljs-comment">// 触发 takeover 模式，等待用户帮助</span>
  }
}

<span class="hljs-comment">// 如果任务仍在运行，继续下一轮迭代</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isProcessing) {
  setImmediate(() =&gt; <span class="hljs-keyword">this</span>.runIteration(taskId)); <span class="hljs-comment">// 异步调度，不阻塞</span>
}
</code></pre>
<h6 data-id="heading-26">示例</h6>
<pre><code class="hljs language-css" lang="css">示例
迭代 <span class="hljs-number">1</span>:
  LLM: <span class="hljs-string">"我需要先截图看看当前状态"</span>
  → 调用 computer_screenshot
  → 返回截图（显示桌面）

迭代 <span class="hljs-number">2</span>:
  LLM: <span class="hljs-string">"我看到桌面，需要打开浏览器"</span>
  → 调用 <span class="hljs-built_in">computer_application</span>({ application: <span class="hljs-string">'firefox'</span> })
  → 等待 <span class="hljs-number">750ms</span>
  → 截图（显示浏览器打开）
  → 保存工具结果

迭代 <span class="hljs-number">3</span>:
  LLM: <span class="hljs-string">"浏览器已打开，我需要点击地址栏"</span>
  → 调用 <span class="hljs-built_in">computer_click_mouse</span>({ coordinates: {x: <span class="hljs-number">500</span>, y: <span class="hljs-number">50</span>} })
  → 等待 <span class="hljs-number">750ms</span>
  → 截图（显示地址栏被选中）
  → 保存工具结果

迭代 <span class="hljs-number">4</span>:
  LLM: <span class="hljs-string">"现在输入搜索内容"</span>
  → 调用 <span class="hljs-built_in">computer_type_text</span>({ text: <span class="hljs-string">'TypeScript'</span> })
  → 等待 <span class="hljs-number">750ms</span>
  → 截图（显示文本已输入）
  → 保存工具结果

迭代 <span class="hljs-number">5</span>:
  LLM: <span class="hljs-string">"按回车搜索"</span>
  → 调用 <span class="hljs-built_in">computer_type_keys</span>({ keys: [<span class="hljs-string">'Enter'</span>] })
  → 等待 <span class="hljs-number">750ms</span>
  → 截图（显示搜索结果）
  → 保存工具结果

迭代 <span class="hljs-number">6</span>:
  LLM: <span class="hljs-string">"任务完成"</span>
  → 调用 <span class="hljs-built_in">set_task_status</span>({ status: <span class="hljs-string">'completed'</span>, description: <span class="hljs-string">'...'</span> })
  → 更新任务状态为 COMPLETED
  → 停止循环
</code></pre>
<h6 data-id="heading-27">LLM API 服务</h6>
<ul>
<li>Anthropic Claude API 服务（src/anthropic）</li>
<li>Google Gemini API 服务（src/google）</li>
<li>OpenAI API 服务（src/openai）</li>
<li>LLM 代理 API服务（src/proxy）</li>
</ul>
<blockquote>
<p>上述LLM服务，核心功能如下，就是根据传入的模型型号、message、mcp工具等调用模型返回结果并转为task所需的message格式</p>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript">  <span class="hljs-keyword">async</span> <span class="hljs-title function_">generateMessage</span>(
    <span class="hljs-attr">systemPrompt</span>: <span class="hljs-built_in">string</span>,
    <span class="hljs-attr">messages</span>: <span class="hljs-title class_">Message</span>[],
    <span class="hljs-attr">model</span>: <span class="hljs-built_in">string</span> = <span class="hljs-variable constant_">DEFAULT_MODEL</span>.<span class="hljs-property">name</span>,
    <span class="hljs-attr">useTools</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>,
    signal?: <span class="hljs-title class_">AbortSignal</span>,
  ): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">BytebotAgentResponse</span>&gt; {
    <span class="hljs-keyword">const</span> isReasoning = model.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'o'</span>);
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> openaiMessages = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">formatMessagesForOpenAI</span>(messages);

      <span class="hljs-keyword">const</span> maxTokens = <span class="hljs-number">8192</span>;
      <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">openai</span>.<span class="hljs-property">responses</span>.<span class="hljs-title function_">create</span>(
        {
          model,
          <span class="hljs-attr">max_output_tokens</span>: maxTokens,
          <span class="hljs-attr">input</span>: openaiMessages, <span class="hljs-comment">// 将任务的messages转成所需格式的message</span>
          <span class="hljs-attr">instructions</span>: systemPrompt, <span class="hljs-comment">// 系统提示</span>
          <span class="hljs-attr">tools</span>: useTools ? openaiTools : [], <span class="hljs-comment">// 提供的mcp工具</span>
          <span class="hljs-attr">reasoning</span>: isReasoning ? { <span class="hljs-attr">effort</span>: <span class="hljs-string">'medium'</span> } : <span class="hljs-literal">null</span>,
          <span class="hljs-attr">store</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">include</span>: isReasoning ? [<span class="hljs-string">'reasoning.encrypted_content'</span>] : [],
        },
        { signal },
      );

      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">contentBlocks</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">formatOpenAIResponse</span>(response.<span class="hljs-property">output</span>),
        <span class="hljs-attr">tokenUsage</span>: {
          <span class="hljs-attr">inputTokens</span>: response.<span class="hljs-property">usage</span>?.<span class="hljs-property">input_tokens</span> || <span class="hljs-number">0</span>,
          <span class="hljs-attr">outputTokens</span>: response.<span class="hljs-property">usage</span>?.<span class="hljs-property">output_tokens</span> || <span class="hljs-number">0</span>,
          <span class="hljs-attr">totalTokens</span>: response.<span class="hljs-property">usage</span>?.<span class="hljs-property">total_tokens</span> || <span class="hljs-number">0</span>,
        },
      };
    } <span class="hljs-keyword">catch</span> (<span class="hljs-attr">error</span>: <span class="hljs-built_in">any</span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'error'</span>, error);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'error name'</span>, error.<span class="hljs-property">name</span>);

      <span class="hljs-keyword">if</span> (error <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">APIUserAbortError</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'OpenAI API call aborted'</span>);
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BytebotAgentInterrupt</span>();
      }
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">error</span>(
        <span class="hljs-string">`Error sending message to OpenAI: <span class="hljs-subst">${error.message}</span>`</span>,
        error.<span class="hljs-property">stack</span>,
      );
      <span class="hljs-keyword">throw</span> error;
    }
  }
</code></pre>
<p>mcp工具</p>
<p>所有可供 AI 代理使用的工具，包括：</p>
<ul>
<li>鼠标操作工具（移动、点击、拖拽、滚动等）</li>
<li>键盘操作工具（输入文本、按键、快捷键等）</li>
<li>应用程序管理工具</li>
<li>文件操作工具</li>
<li>任务管理工具</li>
</ul>
<p>每个LLM服务需要自定义agentToolToOpenAITool，以转化为所需工具数据格式</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function">function <span class="hljs-title">agentToolToOpenAITool</span><span class="hljs-params">(agentTool: any)</span>: OpenAI.Responses.FunctionTool {</span>
  <span class="hljs-keyword">return</span> {
    type: <span class="hljs-string">'function'</span>,
    name: agentTool.name,
    description: agentTool.description,
    parameters: agentTool.input_schema,
  } as OpenAI.Responses.FunctionTool;
}
</code></pre>
<p>公共提供的工具（agentTool）</p>
<blockquote>
<p>鼠标操作工具、键盘操作工具、应用程序管理工具、文件操作工具 这几个工具都是调用bytebotd虚拟桌面服务提供的api实现的</p>
</blockquote>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/**
 * 通用模式定义，供多个工具复用
 */</span>
const coordinateSchema = {
  type: <span class="hljs-string">'object'</span> as const,
  properties: {
    x: {
      type: <span class="hljs-string">'number'</span> as const,
      description: <span class="hljs-string">'The x-coordinate'</span>,
    },
    y: {
      type: <span class="hljs-string">'number'</span> as const,
      description: <span class="hljs-string">'The y-coordinate'</span>,
    },
  },
  required: [<span class="hljs-string">'x'</span>, <span class="hljs-string">'y'</span>],
};

<span class="hljs-comment">/**
 * 鼠标操作工具定义
 */</span>
export const _moveMouseTool = {
  name: <span class="hljs-string">'computer_move_mouse'</span>,
  description: <span class="hljs-string">'Moves the mouse cursor to the specified coordinates'</span>,
  input_schema: {
    type: <span class="hljs-string">'object'</span> as const,
    properties: {
      coordinates: {
        ..<span class="hljs-selector-class">.coordinateSchema</span>,
        description: <span class="hljs-string">'Target coordinates for mouse movement'</span>,
      },
    },
    required: [<span class="hljs-string">'coordinates'</span>],
  },
};

<span class="hljs-comment">/**
 * 键盘操作工具定义
 */</span>
export const _typeKeysTool = {
  name: <span class="hljs-string">'computer_type_keys'</span>,
  description: <span class="hljs-string">'Types a sequence of keys (useful for keyboard shortcuts)'</span>,
  input_schema: {
    type: <span class="hljs-string">'object'</span> as const,
    properties: {
      keys: {
        type: <span class="hljs-string">'array'</span> as const,
        items: { type: <span class="hljs-string">'string'</span> as const },
        description: <span class="hljs-string">'Array of key names to type in sequence'</span>,
      },
      delay: {
        type: <span class="hljs-string">'number'</span> as const,
        description: <span class="hljs-string">'Optional delay in milliseconds between key presses'</span>,
        nullable: true,
      },
    },
    required: [<span class="hljs-string">'keys'</span>],
  },
};

<span class="hljs-comment">/**
 * 实用工具定义
 */</span>
export const _applicationTool = {
  name: <span class="hljs-string">'computer_application'</span>,
  description: <span class="hljs-string">'Opens or focuses an application and ensures it is fullscreen'</span>,
  input_schema: {
    type: <span class="hljs-string">'object'</span> as const,
    properties: {
      application: {
        type: <span class="hljs-string">'string'</span> as const,
        enum: [
          <span class="hljs-string">'firefox'</span>,
          <span class="hljs-string">'1password'</span>,
          <span class="hljs-string">'thunderbird'</span>,
          <span class="hljs-string">'vscode'</span>,
          <span class="hljs-string">'terminal'</span>,
          <span class="hljs-string">'desktop'</span>,
          <span class="hljs-string">'directory'</span>,
        ],
        description: <span class="hljs-string">'The application to open or focus'</span>,
      },
    },
    required: [<span class="hljs-string">'application'</span>],
  },
};

<span class="hljs-comment">/**
 * 任务管理工具定义
 */</span>
export const _setTaskStatusTool = {
  name: <span class="hljs-string">'set_task_status'</span>,
  description: <span class="hljs-string">'Sets the status of the current task'</span>,
  input_schema: {
    type: <span class="hljs-string">'object'</span> as const,
    properties: {
      status: {
        type: <span class="hljs-string">'string'</span> as const,
        enum: [<span class="hljs-string">'completed'</span>, <span class="hljs-string">'needs_help'</span>],
        description: <span class="hljs-string">'The status of the task'</span>,
      },
      description: {
        type: <span class="hljs-string">'string'</span> as const,
        description:
          <span class="hljs-string">'If the task is completed, a summary of the task. If the task needs help, a description of the issue or clarification needed.'</span>,
      },
    },
    required: [<span class="hljs-string">'status'</span>, <span class="hljs-string">'description'</span>],
  },
};

export const _createTaskTool = {
  name: <span class="hljs-string">'create_task'</span>,
  description: <span class="hljs-string">'Creates a new task'</span>,
  input_schema: {
    type: <span class="hljs-string">'object'</span> as const,
    properties: {
      description: {
        type: <span class="hljs-string">'string'</span> as const,
        description: <span class="hljs-string">'The description of the task'</span>,
      },
      type: {
        type: <span class="hljs-string">'string'</span> as const,
        enum: [<span class="hljs-string">'IMMEDIATE'</span>, <span class="hljs-string">'SCHEDULED'</span>],
        description: <span class="hljs-string">'The type of the task (defaults to IMMEDIATE)'</span>,
      },
      scheduledFor: {
        type: <span class="hljs-string">'string'</span> as const,
        format: <span class="hljs-string">'date-time'</span>,
        description: <span class="hljs-string">'RFC 3339 / ISO 8601 datetime for scheduled tasks'</span>,
      },
      priority: {
        type: <span class="hljs-string">'string'</span> as const,
        enum: [<span class="hljs-string">'LOW'</span>, <span class="hljs-string">'MEDIUM'</span>, <span class="hljs-string">'HIGH'</span>, <span class="hljs-string">'URGENT'</span>],
        description: <span class="hljs-string">'The priority of the task (defaults to MEDIUM)'</span>,
      },
    },
    required: [<span class="hljs-string">'description'</span>],
  },
};

<span class="hljs-comment">/**
 * 文件读取工具定义
 */</span>
export const _readFileTool = {
  name: <span class="hljs-string">'computer_read_file'</span>,
  description:
    <span class="hljs-string">'Reads a file from the specified path and returns it as a document content block with base64 encoded data'</span>,
  input_schema: {
    type: <span class="hljs-string">'object'</span> as const,
    properties: {
      path: {
        type: <span class="hljs-string">'string'</span> as const,
        description: <span class="hljs-string">'The file path to read from'</span>,
      },
    },
    required: [<span class="hljs-string">'path'</span>],
  },
};
</code></pre>
<h3 data-id="heading-28"><strong>bytebot-agent-cc - Claude Code 代理版本</strong></h3>
<p>bytebot-agent-cc 是专门为 Claude Code 优化的简化版本，通过 MCP 协议和流式处理提供更直接的集成。bytebot-agent 是功能更完整的通用版本，支持多提供商、消息摘要和更灵活的任务管理。</p>
<h4 data-id="heading-29">与 bytebot-agent 的主要区别</h4>
<ol>
<li>
<h5 data-id="heading-30">LLM 服务实现方式</h5>
</li>
</ol>
<p>bytebot-agent-cc:</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// 使用 Claude Code 的 query 函数，通过 MCP 连接</span>
import { query } <span class="hljs-keyword">from</span> <span class="hljs-string">'@anthropic-ai/claude-code'</span>;
<span class="hljs-keyword">for</span> <span class="hljs-title function_ invoke__">await</span> (<span class="hljs-keyword">const</span> message of <span class="hljs-title function_ invoke__">query</span>({
  <span class="hljs-attr">prompt</span>: task.description,
  <span class="hljs-attr">options</span>: {
    <span class="hljs-attr">mcpServers</span>: {
      <span class="hljs-attr">desktop</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-string">'sse'</span>,
        <span class="hljs-attr">url</span>: ${BYTEBOT_DESKTOP_BASE_URL}/mcp,
      },
    },
  },
})) {
  <span class="hljs-comment">// 处理流式响应</span>
}
</code></pre>
<p>bytebot-agent:</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 支持多个 LLM 提供商，直接调用 REST API</span>
<span class="hljs-keyword">const</span> service = <span class="hljs-keyword">this</span>.services[model.provider]; <span class="hljs-comment">// anthropic/openai/google/proxy</span>
<span class="hljs-keyword">const</span> agentResponse = await service.generateMessage(
  AGENT_SYSTEM_PROMPT,
  messages,
  model.name,
  <span class="hljs-literal">true</span>,
  <span class="hljs-keyword">this</span>.abortController.signal
);
</code></pre>
<p>2.  ##### 模块结构差异</p>
<p>bytebot-agent-cc 缺少的模块：</p>
<ul>
<li>❌ anthropic/ - 标准 Anthropic 服务</li>
<li>❌ openai/ - OpenAI 服务</li>
<li>❌ google/ - Google Gemini 服务</li>
<li>❌ proxy/ - LLM 代理服务</li>
<li>❌ summaries/ - 消息摘要服务</li>
</ul>
<p>bytebot-agent 包含的模块：</p>
<ul>
<li>✅ 完整的 LLM 服务模块体系</li>
<li>✅ 多提供商支持（Anthropic、OpenAI、Google、Proxy）</li>
<li>✅ 消息摘要服务（用于管理长上下文）</li>
</ul>
<ol start="3">
<li>
<h5 data-id="heading-31">上下文管理</h5>
</li>
</ol>
<p>bytebot-agent-cc:</p>
<ul>
<li>❌ 没有摘要服务</li>
<li>❌ 不管理消息摘要</li>
<li>依赖 Claude Code 自身的上下文管理</li>
</ul>
<p>bytebot-agent:</p>
<ul>
<li>✅ 有完整的摘要服务</li>
<li>✅ 当 token 使用量达到上下文窗口的 75% 时自动生成摘要</li>
<li>✅ 主动管理长对话上下文</li>
</ul>
<h4 data-id="heading-32">使用场景对比</h4>
<ul>
<li>
<p>使用 bytebot-agent-cc 的场景：</p>
<ul>
<li>✅ 代码生成和编程任务</li>
<li>✅ 需要 Claude Code 特定功能</li>
<li>✅ 与 Claude Code 深度集成</li>
<li>✅ 需要更强的代码理解能力</li>
</ul>
</li>
<li>
<p>使用 bytebot-agent 的场景：</p>
<ul>
<li>✅ 需要多 LLM 提供商支持</li>
<li>✅ 需要灵活切换不同模型</li>
<li>✅ 需要消息摘要管理长上下文</li>
<li>✅ 需要更细粒度的任务控制</li>
</ul>
</li>
</ul>
<h3 data-id="heading-33"><strong>bytebot-llm-proxy</strong></h3>
<p>描述： 使用 LiteLLM 实现的统一 LLM 代理服务，提供统一的 API 接口访问多个 LLM 提供商。</p>
<p>技术栈：</p>
<ul>
<li>LiteLLM 框架：统一的 LLM 代理框架</li>
</ul>
<h4 data-id="heading-34"><strong>架构设计</strong></h4>
<p>bytebot-llm-proxy 基于 LiteLLM 框架构建，提供统一的 OpenAI 兼容 API 接口。所有 LLM 请求都通过这个代理服务路由到对应的提供商。</p>
<pre><code class="hljs language-scss" lang="scss">bytebot-agent → bytebot-llm-proxy → LLM 提供商
                (统一 API)         (Anthropic/OpenAI/Gemini/...)
</code></pre>
<h4 data-id="heading-35"><strong>配置文件</strong></h4>
<p><code>litellm-config.yaml</code> 定义了所有可用的 LLM 模型：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">model_list:</span>
  <span class="hljs-comment"># Anthropic Models</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">model_name:</span> <span class="hljs-string">claude-opus-4</span>
    <span class="hljs-attr">litellm_params:</span>
      <span class="hljs-attr">model:</span> <span class="hljs-string">anthropic/claude-opus-4-20250514</span>
      <span class="hljs-attr">api_key:</span> <span class="hljs-string">os.environ/ANTHROPIC_API_KEY</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">model_name:</span> <span class="hljs-string">claude-sonnet-4</span>
    <span class="hljs-attr">litellm_params:</span>
      <span class="hljs-attr">model:</span> <span class="hljs-string">anthropic/claude-sonnet-4-20250514</span>
      <span class="hljs-attr">api_key:</span> <span class="hljs-string">os.environ/ANTHROPIC_API_KEY</span>

  <span class="hljs-comment"># OpenAI Models</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">model_name:</span> <span class="hljs-string">gpt-4.1</span>
    <span class="hljs-attr">litellm_params:</span>
      <span class="hljs-attr">model:</span> <span class="hljs-string">openai/gpt-4.1</span>
      <span class="hljs-attr">api_key:</span> <span class="hljs-string">os.environ/OPENAI_API_KEY</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">model_name:</span> <span class="hljs-string">gpt-4o</span>
    <span class="hljs-attr">litellm_params:</span>
      <span class="hljs-attr">model:</span> <span class="hljs-string">openai/gpt-4o</span>
      <span class="hljs-attr">api_key:</span> <span class="hljs-string">os.environ/OPENAI_API_KEY</span>

  <span class="hljs-comment"># Gemini Models</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">model_name:</span> <span class="hljs-string">gemini-2.5-pro</span>
    <span class="hljs-attr">litellm_params:</span>
      <span class="hljs-attr">model:</span> <span class="hljs-string">gemini/gemini-2.5-pro</span>
      <span class="hljs-attr">api_key:</span> <span class="hljs-string">os.environ/GEMINI_API_KEY</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">model_name:</span> <span class="hljs-string">gemini-2.5-flash</span>
    <span class="hljs-attr">litellm_params:</span>
      <span class="hljs-attr">model:</span> <span class="hljs-string">gemini/gemini-2.5-flash</span>
      <span class="hljs-attr">api_key:</span> <span class="hljs-string">os.environ/GEMINI_API_KEY</span>
</code></pre>
<h4 data-id="heading-36"><strong>主要功能</strong></h4>
<h5 data-id="heading-37"><strong>统一 LLM 接口</strong></h5>
<p>支持的提供商：</p>
<ul>
<li><strong>OpenAI</strong>: GPT-4, GPT-3.5 系列</li>
<li><strong>Anthropic</strong>: Claude Opus, Claude Sonnet 系列</li>
<li><strong>Google Gemini</strong>: Gemini Pro, Gemini Flash 系列</li>
<li><strong>Azure OpenAI</strong>: Azure 托管的 OpenAI 模型</li>
<li><strong>AWS Bedrock</strong>: AWS 托管的多种模型</li>
<li><strong>Ollama</strong>: 本地部署的开源模型</li>
<li><strong>100+ 其他提供商</strong>: 通过 LiteLLM 统一接口访问</li>
</ul>
<h5 data-id="heading-38"><strong>Docker 部署</strong></h5>
<pre><code class="hljs language-bash" lang="bash">FROM ghcr.io/berriai/litellm:main-stable

<span class="hljs-comment"># 复制配置文件</span>
COPY ./bytebot-llm-proxy/litellm-config.yaml /app/config.yaml

<span class="hljs-comment"># 启动 LiteLLM 服务</span>
CMD [<span class="hljs-string">"--config"</span>, <span class="hljs-string">"/app/config.yaml"</span>, <span class="hljs-string">"--port"</span>, <span class="hljs-string">"4000"</span>]
</code></pre>
<h5 data-id="heading-39"><strong>在 bytebot-agent 中的使用</strong></h5>
<p>bytebot-agent 通过 ProxyService 连接到 bytebot-llm-proxy：</p>
<p><code>proxy.service.ts</code></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 初始化 OpenAI 客户端，baseURL 指向 LiteLLM 代理</span>
<span class="hljs-keyword">this</span>.openai = <span class="hljs-keyword">new</span> OpenAI({
  apiKey: <span class="hljs-string">'dummy-key-for-proxy'</span>,
  baseURL: proxyUrl, <span class="hljs-comment">// BYTEBOT_LLM_PROXY_URL</span>
});

<span class="hljs-comment">// 调用时，模型名称会被 LiteLLM 路由到对应的提供商</span>
<span class="hljs-keyword">const</span> completion = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.openai.chat.completions.create({
  model: <span class="hljs-string">'claude-opus-4'</span>, <span class="hljs-comment">// LiteLLM 会路由到 Anthropic</span>
  messages: [...],
  tools: [...]
});
</code></pre>
<p>监听端口： <code>4000</code></p>
<h3 data-id="heading-40"><strong>bytebotd</strong></h3>
<p><strong>描述：</strong> Bytebot 的核心桌面控制服务，负责直接与虚拟桌面环境交互，执行所有的桌面操作。</p>
<p>用途：远程桌面 + 自动化执行平台</p>
<p><strong>技术栈：</strong></p>
<ul>
<li>
<p>NestJS 框架（node服务）</p>
</li>
<li>
<p>@nut-tree-fork/nut-js: 跨平台的桌面自动化库</p>
<ul>
<li>
<blockquote>
<p>跨平台桌面自动化 (截图、控件识别)</p>
</blockquote>
</li>
</ul>
</li>
<li>
<p>uiohook-napi: 输入跟踪库</p>
<ul>
<li>
<blockquote>
<p>用于提供整个操作系统范围内的鼠标和键盘事件监听</p>
</blockquote>
</li>
</ul>
</li>
<li>
<p>Socket.IO: WebSocket 通信</p>
</li>
<li>
<p>@rekog/mcp-nest:</p>
<ul>
<li>
<blockquote>
<p>NestJS 的 MCP 协议集成 (AI 工具调用)</p>
</blockquote>
</li>
</ul>
</li>
<li>
<p>sharp</p>
<ul>
<li>
<blockquote>
<p>图像处理和分析</p>
</blockquote>
</li>
</ul>
</li>
<li>
<p>http-proxy-middleware:</p>
<ul>
<li>
<blockquote>
<p>HTTP 请求代理中间件</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<p><strong>部署时做了什么？</strong></p>
<p><code>Dockerfile</code></p>
<p>在容器中搭建一个带图形界面的 Linux 桌面，可通过浏览器访问，并运行自动化程序。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 基础设置</span>
FROM ubuntu:22.04
ARG DEBIAN_FRONTEND=noninteractive
ENV DISPLAY=:0

<span class="hljs-comment"># 1. 安装桌面环境</span>
RUN apt-get update &amp;&amp; apt-get install -y \
    xvfb x11vnc xfce4 firefox-esr

<span class="hljs-comment"># 2. 安装开发工具  </span>
RUN apt-get install -y \
    nodejs python3-pip git code

<span class="hljs-comment"># 3. 安装 noVNC</span>
RUN git <span class="hljs-built_in">clone</span> https://github.com/novnc/noVNC.git /opt/noVNC

<span class="hljs-comment"># 4. 复制应用代码</span>
COPY ./bytebotd/ /bytebot/bytebotd/
WORKDIR /bytebot/bytebotd
RUN npm install &amp;&amp; npm run build

<span class="hljs-comment"># 5. 创建用户</span>
RUN useradd -ms /bin/bash user

<span class="hljs-comment"># 6. 暴露端口</span>
EXPOSE 9990

<span class="hljs-comment"># 7. 启动服务</span>
CMD [<span class="hljs-string">"/usr/bin/supervisord"</span>, <span class="hljs-string">"-c"</span>, <span class="hljs-string">"/etc/supervisor/conf.d/supervisord.conf"</span>]
</code></pre>
<ul>
<li>VNC 桌面：创建虚拟桌面、安装软件</li>
<li>Web 界面：noVNC 网页客户端，可以通过url访问虚拟桌面并与其交互</li>
<li>自动化 API：启动bytebotd 服务，提供相关接口</li>
</ul>
<h4 data-id="heading-41"><strong>核心功能</strong></h4>
<ul>
<li>
<p>虚拟桌面相关配置</p>
</li>
<li>
<p>虚拟桌面操作模块</p>
<ul>
<li>
<blockquote>
<p>处理鼠标、键盘、截图等自动化操作</p>
</blockquote>
</li>
</ul>
</li>
<li>
<p>虚拟桌面输入跟踪模块</p>
<ul>
<li>
<blockquote>
<p>监听并记录用户在虚拟桌面的鼠标和键盘输入</p>
</blockquote>
</li>
</ul>
</li>
<li>
<p>MCP</p>
<ul>
<li>
<blockquote>
<p>提供 AI 模型上下文协议支持</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h5 data-id="heading-42">虚拟桌面相关配置</h5>
<p>提供了虚拟桌面及其软件相关配置</p>
<p>policies.json</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"policies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-comment">// 用户消息屏蔽</span>
    <span class="hljs-attr">"UserMessaging"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"ExtensionRecommendations"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>      <span class="hljs-comment">// 禁用扩展推荐</span>
      <span class="hljs-attr">"FeatureRecommendations"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>        <span class="hljs-comment">// 禁用功能推荐</span>
      <span class="hljs-attr">"UrlbarInterventions"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>           <span class="hljs-comment">// 禁用地址栏干预提示</span>
      <span class="hljs-attr">"SkipOnboarding"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>                 <span class="hljs-comment">// 跳过新手引导</span>
      <span class="hljs-attr">"MoreFromMozilla"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>               <span class="hljs-comment">// 隐藏 Mozilla 其他产品推广</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>

    <span class="hljs-comment">// 页面重定向（清空默认页面）</span>
    <span class="hljs-attr">"OverrideFirstRunPage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>        <span class="hljs-comment">// 清空首次运行页面（打开空白页）</span>
    <span class="hljs-attr">"OverridePostUpdatePage"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span><span class="hljs-punctuation">,</span>       <span class="hljs-comment">// 清空更新后显示页面</span>

    <span class="hljs-comment">// 应用内通知禁用</span>
    <span class="hljs-attr">"InAppNotification"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"DonationEnabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>     <span class="hljs-comment">// 禁用捐款请求</span>
      <span class="hljs-attr">"SurveyEnabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>       <span class="hljs-comment">// 禁用用户调查</span>
      <span class="hljs-attr">"MessageEnabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>      <span class="hljs-comment">// 禁用所有其他消息</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>

<span class="hljs-punctuation">}</span>
</code></pre>
<p>50-autologin.conf</p>
<p>自动登录配置文件，用于在系统启动时自动登录到指定的用户桌面环境</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-section">[Seat:*]</span>                   
<span class="hljs-attr">autologin-user</span>=user         <span class="hljs-comment"># 自动登录的用户名为 "user"</span>
<span class="hljs-attr">autologin-user-timeout</span>=<span class="hljs-number">0</span>    <span class="hljs-comment"># 超时时间为0秒（立即登录，不显示登录界面）</span>
<span class="hljs-attr">autologin-session</span>=xfce      <span class="hljs-comment"># 自动登录后启动 Xfce 桌面环境</span>
</code></pre>
<h5 data-id="heading-43"><strong>虚拟桌面操作模块 (Computer Use Service)</strong></h5>
<p>负责执行各种桌面操作，将来自 bytebot-agent 的高级指令转换为底层系统调用。</p>
<h6 data-id="heading-44"><strong>支持的操作类型</strong></h6>
<pre><code class="hljs language-diff" lang="diff">// 鼠标操作
<span class="hljs-deletion">- move_mouse: 移动鼠标到指定坐标</span>
<span class="hljs-deletion">- trace_mouse: 鼠标沿路径移动</span>
<span class="hljs-deletion">- click_mouse: 鼠标点击（支持单/双击）</span>
<span class="hljs-deletion">- press_mouse: 鼠标按下/释放</span>
<span class="hljs-deletion">- drag_mouse: 鼠标拖拽</span>
<span class="hljs-deletion">- scroll: 滚轮滚动（上下左右）</span>

// 键盘操作
<span class="hljs-deletion">- type_keys: 按键序列输入（支持快捷键）</span>
<span class="hljs-deletion">- press_keys: 按键按下/释放（用于组合键）</span>
<span class="hljs-deletion">- type_text: 文本逐字符输入</span>
<span class="hljs-deletion">- paste_text: 粘贴文本（通过剪贴板）</span>

// 系统操作
<span class="hljs-deletion">- screenshot: 截屏（返回 base64 图片）</span>
<span class="hljs-deletion">- cursor_position: 获取鼠标当前位置</span>
<span class="hljs-deletion">- application: 应用程序管理（打开/激活/最大化）</span>
<span class="hljs-deletion">- write_file: 写入文件</span>
<span class="hljs-deletion">- read_file: 读取文件（支持多种格式）</span>
</code></pre>
<p><strong>操作执行流程</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// ComputerUseController 接收请求</span>
@Post()
<span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-title">action</span>(<span class="hljs-params">@Body(</span>) <span class="hljs-keyword">params</span>: ComputerActionDto)</span> {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.computerUseService.action(<span class="hljs-keyword">params</span>);
}

<span class="hljs-comment">// ComputerUseService 路由到具体操作</span>
<span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-title">action</span>(<span class="hljs-params"><span class="hljs-keyword">params</span>: ComputerAction</span>): Promise&lt;any&gt;</span> {
  <span class="hljs-keyword">switch</span> (<span class="hljs-keyword">params</span>.action) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'click_mouse'</span>:
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.clickMouse(<span class="hljs-keyword">params</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> <span class="hljs-string">'type_text'</span>:
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.typeText(<span class="hljs-keyword">params</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-comment">// ... 其他操作</span>
  }
}

<span class="hljs-comment">// NutService 执行底层操作</span>
<span class="hljs-function"><span class="hljs-keyword">async</span> <span class="hljs-title">mouseClickEvent</span>(<span class="hljs-params">button: Button</span>): Promise&lt;<span class="hljs-keyword">void</span>&gt;</span> {
  <span class="hljs-keyword">await</span> mouse.click(button);
}
</code></pre>
<p><strong>应用程序管理</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title">application</span>(<span class="hljs-params">action: ApplicationAction</span>): Promise&lt;<span class="hljs-keyword">void</span>&gt;</span> {
  <span class="hljs-comment">// 检查应用是否已打开</span>
  <span class="hljs-keyword">const</span> appOpen = <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.checkApplicationOpen(action.application);
  
  <span class="hljs-keyword">if</span> (appOpen) {
    <span class="hljs-comment">// 激活并最大化窗口</span>
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.activateWindow(action.application);
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.maximizeWindow(action.application);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 启动应用</span>
    <span class="hljs-keyword">await</span> <span class="hljs-keyword">this</span>.launchApplication(action.application);
  }
}

<span class="hljs-comment">// 使用 wmctrl 管理窗口</span>
spawnAndForget(<span class="hljs-string">'sudo'</span>, [
  <span class="hljs-string">'-u'</span>, <span class="hljs-string">'user'</span>,
  <span class="hljs-string">'wmctrl'</span>, <span class="hljs-string">'-x'</span>, <span class="hljs-string">'-a'</span>,  <span class="hljs-comment">// 激活窗口</span>
  processMap[application]
]);
</code></pre>
<p><strong>文件操作</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 写入文件</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">writeFile</span>(<span class="hljs-attr">action</span>: <span class="hljs-title class_">WriteFileAction</span>): <span class="hljs-title class_">Promise</span>&lt;{ <span class="hljs-attr">success</span>: <span class="hljs-built_in">boolean</span>; <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> }&gt; {
  <span class="hljs-comment">// 1. 解码 base64 数据</span>
  <span class="hljs-keyword">const</span> buffer = <span class="hljs-title class_">Buffer</span>.<span class="hljs-title function_">from</span>(action.<span class="hljs-property">data</span>, <span class="hljs-string">'base64'</span>);
  
  <span class="hljs-comment">// 2. 解析路径（相对路径转为绝对路径）</span>
  <span class="hljs-keyword">let</span> targetPath = action.<span class="hljs-property">path</span>;
  <span class="hljs-keyword">if</span> (!path.<span class="hljs-title function_">isAbsolute</span>(targetPath)) {
    targetPath = path.<span class="hljs-title function_">join</span>(<span class="hljs-string">'/home/user/Desktop'</span>, targetPath);
  }
  
  <span class="hljs-comment">// 3. 创建目录（如果不存在）</span>
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">execAsync</span>(<span class="hljs-string">`sudo mkdir -p "<span class="hljs-subst">${path.dirname(targetPath)}</span>"`</span>);
  
  <span class="hljs-comment">// 4. 写入临时文件，然后移动到目标位置</span>
  <span class="hljs-keyword">const</span> tempFile = <span class="hljs-string">`/tmp/bytebot_temp_<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>;
  <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">writeFile</span>(tempFile, buffer);
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">execAsync</span>(<span class="hljs-string">`sudo cp "<span class="hljs-subst">${tempFile}</span>" "<span class="hljs-subst">${targetPath}</span>"`</span>);
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">execAsync</span>(<span class="hljs-string">`sudo chown user:user "<span class="hljs-subst">${targetPath}</span>"`</span>);
  
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">message</span>: <span class="hljs-string">`File written to: <span class="hljs-subst">${targetPath}</span>`</span> };
}

<span class="hljs-comment">// 读取文件</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">readFile</span>(<span class="hljs-attr">action</span>: <span class="hljs-title class_">ReadFileAction</span>): <span class="hljs-title class_">Promise</span>&lt;{
  <span class="hljs-attr">success</span>: <span class="hljs-built_in">boolean</span>;
  data?: <span class="hljs-built_in">string</span>;
  name?: <span class="hljs-built_in">string</span>;
  size?: <span class="hljs-built_in">number</span>;
  mediaType?: <span class="hljs-built_in">string</span>;
}&gt; {
  <span class="hljs-comment">// 1. 解析路径</span>
  <span class="hljs-keyword">let</span> targetPath = action.<span class="hljs-property">path</span>;
  <span class="hljs-keyword">if</span> (!path.<span class="hljs-title function_">isAbsolute</span>(targetPath)) {
    targetPath = path.<span class="hljs-title function_">join</span>(<span class="hljs-string">'/home/user/Desktop'</span>, targetPath);
  }
  
  <span class="hljs-comment">// 2. 复制到临时位置（使用 sudo 权限）</span>
  <span class="hljs-keyword">const</span> tempFile = <span class="hljs-string">`/tmp/bytebot_read_<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>;
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">execAsync</span>(<span class="hljs-string">`sudo cp "<span class="hljs-subst">${targetPath}</span>" "<span class="hljs-subst">${tempFile}</span>"`</span>);
  <span class="hljs-keyword">await</span> <span class="hljs-title function_">execAsync</span>(<span class="hljs-string">`sudo chmod 644 "<span class="hljs-subst">${tempFile}</span>"`</span>);
  
  <span class="hljs-comment">// 3. 读取文件内容</span>
  <span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">await</span> fs.<span class="hljs-title function_">readFile</span>(tempFile);
  <span class="hljs-keyword">const</span> base64Data = buffer.<span class="hljs-title function_">toString</span>(<span class="hljs-string">'base64'</span>);
  
  <span class="hljs-comment">// 4. 确定媒体类型</span>
  <span class="hljs-keyword">const</span> ext = path.<span class="hljs-title function_">extname</span>(targetPath).<span class="hljs-title function_">toLowerCase</span>().<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>);
  <span class="hljs-keyword">const</span> <span class="hljs-attr">mimeTypes</span>: <span class="hljs-title class_">Record</span>&lt;<span class="hljs-built_in">string</span>, <span class="hljs-built_in">string</span>&gt; = {
    <span class="hljs-attr">pdf</span>: <span class="hljs-string">'application/pdf'</span>,
    <span class="hljs-attr">docx</span>: <span class="hljs-string">'application/vnd.openxmlformats-officedocument.wordprocessingml.document'</span>,
    <span class="hljs-attr">txt</span>: <span class="hljs-string">'text/plain'</span>,
    <span class="hljs-attr">png</span>: <span class="hljs-string">'image/png'</span>,
    <span class="hljs-attr">jpg</span>: <span class="hljs-string">'image/jpeg'</span>,
    <span class="hljs-comment">// ... 更多类型</span>
  };
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">success</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">data</span>: base64Data,
    <span class="hljs-attr">name</span>: path.<span class="hljs-title function_">basename</span>(targetPath),
    <span class="hljs-attr">size</span>: buffer.<span class="hljs-property">length</span>,
    <span class="hljs-attr">mediaType</span>: mimeTypes[ext] || <span class="hljs-string">'application/octet-stream'</span>
  };
}
</code></pre>
<p>NutService 执行底层操作</p>
<p>负责调用底层系统操作方法，执行实际的鼠标、键盘和屏幕操作</p>
<p>引用依赖</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// nut.service.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">Logger</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> {
  keyboard,
  mouse,
  <span class="hljs-title class_">Point</span>,
  screen,
  <span class="hljs-title class_">Key</span>,
  <span class="hljs-title class_">Button</span>,
  <span class="hljs-title class_">FileType</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'@nut-tree-fork/nut-js'</span>;
<span class="hljs-keyword">import</span> { spawn } <span class="hljs-keyword">from</span> <span class="hljs-string">'child_process'</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> path <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;

<span class="hljs-meta">@Injectable</span>()  <span class="hljs-comment">// 标记为可注入的服务</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NutService</span> {
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">sendKeys</span>(<span class="hljs-params">x: <span class="hljs-built_in">number</span>, y: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-comment">// 发送按键功能</span>
  }
  
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">pasteText</span>(<span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-comment">// 粘贴文本功能</span>
  }
}
</code></pre>
<p><strong>键盘操作</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 发送按键序列</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">sendKeys</span>(<span class="hljs-attr">keys</span>: <span class="hljs-built_in">string</span>[], <span class="hljs-attr">delay</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">100</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt; {
  <span class="hljs-keyword">const</span> nutKeys = keys.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">key</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">validateKey</span>(key));
  <span class="hljs-keyword">await</span> keyboard.<span class="hljs-title function_">pressKey</span>(...nutKeys);
  <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">delay</span>(delay);
  <span class="hljs-keyword">await</span> keyboard.<span class="hljs-title function_">releaseKey</span>(...nutKeys);
}

<span class="hljs-comment">// 按住/释放按键（用于组合键）</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">holdKeys</span>(<span class="hljs-attr">keys</span>: <span class="hljs-built_in">string</span>[], <span class="hljs-attr">down</span>: <span class="hljs-built_in">boolean</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">any</span>&gt; {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> keys) {
    <span class="hljs-keyword">const</span> nutKey = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">validateKey</span>(key);
    <span class="hljs-keyword">if</span> (down) {
      <span class="hljs-keyword">await</span> keyboard.<span class="hljs-title function_">pressKey</span>(nutKey);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">await</span> keyboard.<span class="hljs-title function_">releaseKey</span>(nutKey);
    }
  }
}

<span class="hljs-comment">// 文本输入（逐字符）</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">typeText</span>(<span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span>, <span class="hljs-attr">delayMs</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; text.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">const</span> char = text[i];
    <span class="hljs-keyword">const</span> keyInfo = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">charToKeyInfo</span>(char);
    <span class="hljs-keyword">if</span> (keyInfo.<span class="hljs-property">withShift</span>) {
      <span class="hljs-keyword">await</span> keyboard.<span class="hljs-title function_">pressKey</span>(<span class="hljs-title class_">Key</span>.<span class="hljs-property">LeftShift</span>, keyInfo.<span class="hljs-property">keyCode</span>);
      <span class="hljs-keyword">await</span> keyboard.<span class="hljs-title function_">releaseKey</span>(<span class="hljs-title class_">Key</span>.<span class="hljs-property">LeftShift</span>, keyInfo.<span class="hljs-property">keyCode</span>);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">await</span> keyboard.<span class="hljs-title function_">pressKey</span>(keyInfo.<span class="hljs-property">keyCode</span>);
      <span class="hljs-keyword">await</span> keyboard.<span class="hljs-title function_">releaseKey</span>(keyInfo.<span class="hljs-property">keyCode</span>);
    }
    <span class="hljs-keyword">if</span> (delayMs &gt; <span class="hljs-number">0</span> &amp;&amp; i &lt; text.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>) {
      <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, delayMs));
    }
  }
}

<span class="hljs-comment">// 粘贴文本（通过剪贴板）</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">pasteText</span>(<span class="hljs-attr">text</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
  <span class="hljs-comment">// 1. 使用 xclip 复制到剪贴板</span>
  <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt;(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> child = <span class="hljs-title function_">spawn</span>(<span class="hljs-string">'xclip'</span>, [<span class="hljs-string">'-selection'</span>, <span class="hljs-string">'clipboard'</span>], {
      <span class="hljs-attr">env</span>: { ...process.<span class="hljs-property">env</span>, <span class="hljs-attr">DISPLAY</span>: <span class="hljs-string">':0.0'</span> },
      <span class="hljs-attr">stdio</span>: [<span class="hljs-string">'pipe'</span>, <span class="hljs-string">'ignore'</span>, <span class="hljs-string">'inherit'</span>],
    });
    child.<span class="hljs-property">stdin</span>.<span class="hljs-title function_">write</span>(text);
    child.<span class="hljs-property">stdin</span>.<span class="hljs-title function_">end</span>();
    child.<span class="hljs-title function_">once</span>(<span class="hljs-string">'close'</span>, <span class="hljs-function">(<span class="hljs-params">code</span>) =&gt;</span> {
      code === <span class="hljs-number">0</span> ? <span class="hljs-title function_">resolve</span>() : <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`xclip exited with code <span class="hljs-subst">${code}</span>`</span>));
    });
  });
  
  <span class="hljs-comment">// 2. 等待剪贴板设置完成</span>
  <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-number">100</span>));
  
  <span class="hljs-comment">// 3. 发送 Ctrl+V</span>
  <span class="hljs-keyword">await</span> keyboard.<span class="hljs-title function_">pressKey</span>(<span class="hljs-title class_">Key</span>.<span class="hljs-property">LeftControl</span>, <span class="hljs-title class_">Key</span>.<span class="hljs-property">V</span>);
  <span class="hljs-keyword">await</span> keyboard.<span class="hljs-title function_">releaseKey</span>(<span class="hljs-title class_">Key</span>.<span class="hljs-property">LeftControl</span>, <span class="hljs-title class_">Key</span>.<span class="hljs-property">V</span>);
}
</code></pre>
<p><strong>鼠标操作</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 移动鼠标</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">mouseMoveEvent</span>(<span class="hljs-attr">coordinates</span>: <span class="hljs-title class_">Coordinates</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
  <span class="hljs-keyword">await</span> mouse.<span class="hljs-title function_">setPosition</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Point</span>(coordinates.<span class="hljs-property">x</span>, coordinates.<span class="hljs-property">y</span>));
}

<span class="hljs-comment">// 点击鼠标</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">mouseClickEvent</span>(<span class="hljs-attr">button</span>: <span class="hljs-title class_">Button</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
  <span class="hljs-keyword">await</span> mouse.<span class="hljs-title function_">click</span>(button);
}

<span class="hljs-comment">// 按下/释放鼠标按钮</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">mouseButtonEvent</span>(<span class="hljs-attr">button</span>: <span class="hljs-title class_">Button</span>, <span class="hljs-attr">down</span>: <span class="hljs-built_in">boolean</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
  <span class="hljs-keyword">if</span> (down) {
    <span class="hljs-keyword">await</span> mouse.<span class="hljs-title function_">pressButton</span>(button);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">await</span> mouse.<span class="hljs-title function_">releaseButton</span>(button);
  }
}

<span class="hljs-comment">// 滚轮滚动</span>
<span class="hljs-keyword">async</span> <span class="hljs-title function_">mouseWheelEvent</span>(<span class="hljs-attr">direction</span>: <span class="hljs-string">'up'</span> | <span class="hljs-string">'down'</span> | <span class="hljs-string">'left'</span> | <span class="hljs-string">'right'</span>, <span class="hljs-attr">amount</span>: <span class="hljs-built_in">number</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
  <span class="hljs-keyword">await</span> mouse.<span class="hljs-title function_">scroll</span>(direction, amount);
}
</code></pre>
<p><strong>截屏</strong></p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-function">async <span class="hljs-title">screendump</span><span class="hljs-params">()</span>: Promise&lt;Buffer&gt; {</span>
  <span class="hljs-type">const</span> image = await screen.<span class="hljs-built_in">capture</span>();
  <span class="hljs-keyword">return</span> image.data;
}
</code></pre>
<h5 data-id="heading-45">虚拟桌面输入跟踪模块</h5>
<p>监控桌面上的用户输入，并发送给<code>bytebot-agent</code></p>
<p><code>input-tracking.service.ts</code></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 启动输入跟踪</span>
startTracking() {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isTracking) <span class="hljs-keyword">return</span>;
  <span class="hljs-keyword">this</span>.registerListeners();
  uIOhook.start();
  <span class="hljs-keyword">this</span>.isTracking = <span class="hljs-literal">true</span>;
}

<span class="hljs-comment">// 注册事件监听器</span>
<span class="hljs-keyword">private</span> registerListeners() {
  <span class="hljs-comment">// 鼠标移动</span>
  uIOhook.on(<span class="hljs-string">'mousemove'</span>, (e: UiohookMouseEvent) =&gt; {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isDragging &amp;&amp; <span class="hljs-keyword">this</span>.dragMouseAction) {
      <span class="hljs-keyword">this</span>.dragMouseAction.path.push({ x: e.x, y: e.y });
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 防抖截屏（延迟 250ms）</span>
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.screenshotTimeout) clearTimeout(<span class="hljs-keyword">this</span>.screenshotTimeout);
      <span class="hljs-keyword">this</span>.screenshotTimeout = setTimeout(async () =&gt; {
        <span class="hljs-keyword">this</span>.screenshot = await <span class="hljs-keyword">this</span>.computerUseService.screenshot();
      }, <span class="hljs-number">250</span>);
    }
  });
  
  <span class="hljs-comment">// 鼠标点击（防抖处理，250ms）</span>
  uIOhook.on(<span class="hljs-string">'click'</span>, (e: UiohookMouseEvent) =&gt; {
    <span class="hljs-keyword">const</span> action: ClickMouseAction = {
      action: <span class="hljs-string">'click_mouse'</span>,
      button: <span class="hljs-keyword">this</span>.mapButton(e.button),
      coordinates: { x: e.x, y: e.y },
      clickCount: e.clicks,
      holdKeys: [
        e.altKey ? <span class="hljs-string">'alt'</span> : undefined,
        e.ctrlKey ? <span class="hljs-string">'ctrl'</span> : undefined,
        e.shiftKey ? <span class="hljs-string">'shift'</span> : undefined,
        e.metaKey ? <span class="hljs-string">'meta'</span> : undefined,
      ].filter((key) =&gt; key !== undefined),
    };
    <span class="hljs-keyword">this</span>.clickMouseActionBuffer.push(action);
    
    <span class="hljs-comment">// 防抖：250ms 内收集所有点击事件，取最大 clickCount</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.clickMouseActionTimeout) clearTimeout(<span class="hljs-keyword">this</span>.clickMouseActionTimeout);
    <span class="hljs-keyword">this</span>.clickMouseActionTimeout = setTimeout(async () =&gt; {
      <span class="hljs-keyword">const</span> <span class="hljs-keyword">final</span> = <span class="hljs-keyword">this</span>.clickMouseActionBuffer.reduce((a, b) =&gt;
        b.clickCount &gt; a.clickCount ? b : a
      );
      await <span class="hljs-keyword">this</span>.logAction(<span class="hljs-keyword">final</span>);
      <span class="hljs-keyword">this</span>.clickMouseActionBuffer = [];
    }, <span class="hljs-number">250</span>);
  });
  
  <span class="hljs-comment">// 键盘输入</span>
  uIOhook.on(<span class="hljs-string">'keydown'</span>, async (e: UiohookKeyboardEvent) =&gt; {
    <span class="hljs-comment">// 可打印字符 → 缓冲为 TypeTextAction</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.isModifierKey(e) &amp;&amp; keyInfoMap[e.keycode].isPrintable) {
      <span class="hljs-keyword">this</span>.bufferChar(
        e.shiftKey
          ? keyInfoMap[e.keycode].shiftString!
          : keyInfoMap[e.keycode].string!
      );
      <span class="hljs-keyword">return</span>;
    }
    
    <span class="hljs-comment">// 修饰键或非打印键 → 刷新缓冲区，发送 TypeKeysAction</span>
    await <span class="hljs-keyword">this</span>.flushTypingBuffer();
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.pressedKeys.has(e.keycode)) {
      <span class="hljs-keyword">this</span>.pressedKeys.add(e.keycode);
    }
  });
  
  uIOhook.on(<span class="hljs-string">'keyup'</span>, async (e: UiohookKeyboardEvent) =&gt; {
    await <span class="hljs-keyword">this</span>.flushTypingBuffer();
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.pressedKeys.size &gt; <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">const</span> action: TypeKeysAction = {
        action: <span class="hljs-string">'type_keys'</span>,
        keys: Array.from(<span class="hljs-keyword">this</span>.pressedKeys.values()).map(
          (key) =&gt; keyInfoMap[key].name
        ),
      };
      <span class="hljs-keyword">this</span>.pressedKeys.clear();
      await <span class="hljs-keyword">this</span>.logAction(action);
    }
  });
}
</code></pre>
<h5 data-id="heading-46">MCP</h5>
<p>注意：bytebot-agent-cc 才会使用这里的MCP服务，bytebot-agent内部有自定义MCP服务</p>
<h6 data-id="heading-47">工具定义位置</h6>
<p>packages/bytebotd/src/mcp/computer-use.tools.ts定义了所有桌面操作的 MCP 工具，包括：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">import</span> { <span class="hljs-selector-tag">Injectable</span> } <span class="hljs-selector-tag">from</span> '@<span class="hljs-selector-tag">nestjs</span>/<span class="hljs-selector-tag">common</span>';
<span class="hljs-selector-tag">import</span> { <span class="hljs-selector-tag">Tool</span> } <span class="hljs-selector-tag">from</span> '@<span class="hljs-selector-tag">rekog</span>/<span class="hljs-selector-tag">mcp-nest</span>';
<span class="hljs-selector-tag">import</span> { <span class="hljs-selector-tag">z</span> } <span class="hljs-selector-tag">from</span> '<span class="hljs-selector-tag">zod</span>';
<span class="hljs-selector-tag">import</span> { <span class="hljs-selector-tag">ComputerUseService</span> } <span class="hljs-selector-tag">from</span> '../<span class="hljs-selector-tag">computer-use</span>/<span class="hljs-selector-tag">computer-use</span><span class="hljs-selector-class">.service</span>';

@<span class="hljs-selector-tag">Injectable</span>()
<span class="hljs-selector-tag">export</span> <span class="hljs-selector-tag">class</span> <span class="hljs-selector-tag">ComputerUseTools</span> {
  <span class="hljs-selector-tag">constructor</span>(private readonly <span class="hljs-attribute">computerUse</span>: ComputerUseService) {}

  <span class="hljs-comment">// 鼠标操作</span>
  <span class="hljs-variable">@Tool</span>({ <span class="hljs-attribute">name</span>: <span class="hljs-string">'computer_move_mouse'</span>, <span class="hljs-attribute">description</span>: <span class="hljs-string">'移动鼠标到指定坐标'</span> })
  async <span class="hljs-built_in">moveMouse</span>({ coordinates }: { <span class="hljs-attribute">coordinates</span>: { <span class="hljs-attribute">x</span>: number; <span class="hljs-attribute">y</span>: number } }) {
    <span class="hljs-selector-tag">await</span> <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.computerUse</span><span class="hljs-selector-class">.action</span>({ action: 'move_mouse', coordinates });
    <span class="hljs-selector-tag">return</span> { <span class="hljs-attribute">content</span>: [{ <span class="hljs-attribute">type</span>: <span class="hljs-string">'text'</span>, <span class="hljs-attribute">text</span>: <span class="hljs-string">'mouse moved'</span> }] };
  }

  <span class="hljs-variable">@Tool</span>({ <span class="hljs-attribute">name</span>: <span class="hljs-string">'computer_click_mouse'</span>, <span class="hljs-attribute">description</span>: <span class="hljs-string">'鼠标点击'</span> })
  async <span class="hljs-built_in">clickMouse</span>({ coordinates, button, clickCount }: {
    coordinates?: { <span class="hljs-attribute">x</span>: number; <span class="hljs-attribute">y</span>: number };
    <span class="hljs-attribute">button</span>: <span class="hljs-string">'left'</span> | <span class="hljs-string">'right'</span> | <span class="hljs-string">'middle'</span>;
    <span class="hljs-attribute">clickCount</span>: number;
  }) {
    <span class="hljs-selector-tag">await</span> <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.computerUse</span><span class="hljs-selector-class">.action</span>({ action: 'click_mouse', coordinates, button, clickCount });
    <span class="hljs-selector-tag">return</span> { <span class="hljs-attribute">content</span>: [{ <span class="hljs-attribute">type</span>: <span class="hljs-string">'text'</span>, <span class="hljs-attribute">text</span>: <span class="hljs-string">'mouse clicked'</span> }] };
  }

  <span class="hljs-comment">// 键盘操作</span>
  <span class="hljs-variable">@Tool</span>({ <span class="hljs-attribute">name</span>: <span class="hljs-string">'computer_type_keys'</span>, <span class="hljs-attribute">description</span>: <span class="hljs-string">'模拟按键序列'</span> })
  async <span class="hljs-built_in">typeKeys</span>({ keys, delay }: { <span class="hljs-attribute">keys</span>: string[]; delay?: number }) {
    <span class="hljs-selector-tag">await</span> <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.computerUse</span><span class="hljs-selector-class">.action</span>({ action: 'type_keys', keys, delay });
    <span class="hljs-selector-tag">return</span> { <span class="hljs-attribute">content</span>: [{ <span class="hljs-attribute">type</span>: <span class="hljs-string">'text'</span>, <span class="hljs-attribute">text</span>: <span class="hljs-string">'keys typed'</span> }] };
  }

  <span class="hljs-variable">@Tool</span>({ <span class="hljs-attribute">name</span>: <span class="hljs-string">'computer_type_text'</span>, <span class="hljs-attribute">description</span>: <span class="hljs-string">'输入文本'</span> })
  async <span class="hljs-built_in">typeText</span>({ text, delay }: { <span class="hljs-attribute">text</span>: string; delay?: number }) {
    <span class="hljs-selector-tag">await</span> <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.computerUse</span><span class="hljs-selector-class">.action</span>({ action: 'type_text', text, delay });
    <span class="hljs-selector-tag">return</span> { <span class="hljs-attribute">content</span>: [{ <span class="hljs-attribute">type</span>: <span class="hljs-string">'text'</span>, <span class="hljs-attribute">text</span>: <span class="hljs-string">'text typed'</span> }] };
  }

  <span class="hljs-comment">// 系统操作</span>
  <span class="hljs-variable">@Tool</span>({ <span class="hljs-attribute">name</span>: <span class="hljs-string">'computer_screenshot'</span>, <span class="hljs-attribute">description</span>: <span class="hljs-string">'截取屏幕截图'</span> })
  async <span class="hljs-built_in">screenshot</span>() {
    <span class="hljs-selector-tag">const</span> <span class="hljs-selector-tag">shot</span> = <span class="hljs-selector-tag">await</span> <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.computerUse</span><span class="hljs-selector-class">.action</span>({ action: 'screenshot' }) <span class="hljs-selector-tag">as</span> { image: string };
    <span class="hljs-selector-tag">return</span> { <span class="hljs-attribute">content</span>: [{ <span class="hljs-attribute">type</span>: <span class="hljs-string">'image'</span>, <span class="hljs-attribute">data</span>: shot.image, <span class="hljs-attribute">mimeType</span>: <span class="hljs-string">'image/png'</span> }] };
  }

  <span class="hljs-variable">@Tool</span>({ <span class="hljs-attribute">name</span>: <span class="hljs-string">'computer_application'</span>, <span class="hljs-attribute">description</span>: <span class="hljs-string">'打开应用程序'</span> })
  async <span class="hljs-built_in">application</span>({ application }: {
    <span class="hljs-attribute">application</span>: <span class="hljs-string">'firefox'</span> | <span class="hljs-string">'1password'</span> | <span class="hljs-string">'vscode'</span> | <span class="hljs-string">'terminal'</span>;
  }) {
    <span class="hljs-selector-tag">await</span> <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.computerUse</span><span class="hljs-selector-class">.action</span>({ action: 'application', application });
    <span class="hljs-selector-tag">return</span> { <span class="hljs-attribute">content</span>: [{ <span class="hljs-attribute">type</span>: <span class="hljs-string">'text'</span>, <span class="hljs-attribute">text</span>: <span class="hljs-string">'application opened'</span> }] };
  }

  <span class="hljs-comment">// 文件操作</span>
  <span class="hljs-variable">@Tool</span>({ <span class="hljs-attribute">name</span>: <span class="hljs-string">'computer_write_file'</span>, <span class="hljs-attribute">description</span>: <span class="hljs-string">'写入文件'</span> })
  async <span class="hljs-built_in">writeFile</span>({ path, data }: { <span class="hljs-attribute">path</span>: string; <span class="hljs-attribute">data</span>: string }) {
    <span class="hljs-selector-tag">await</span> <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.computerUse</span><span class="hljs-selector-class">.action</span>({ action: 'write_file', path, data });
    <span class="hljs-selector-tag">return</span> { <span class="hljs-attribute">content</span>: [{ <span class="hljs-attribute">type</span>: <span class="hljs-string">'text'</span>, <span class="hljs-attribute">text</span>: <span class="hljs-string">'file written'</span> }] };
  }

  <span class="hljs-variable">@Tool</span>({ <span class="hljs-attribute">name</span>: <span class="hljs-string">'computer_read_file'</span>, <span class="hljs-attribute">description</span>: <span class="hljs-string">'读取文件'</span> })
  async <span class="hljs-built_in">readFile</span>({ path }: { <span class="hljs-attribute">path</span>: string }) {
    <span class="hljs-selector-tag">const</span> <span class="hljs-selector-tag">result</span> = <span class="hljs-selector-tag">await</span> <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.computerUse</span><span class="hljs-selector-class">.action</span>({ action: 'read_file', path });
    <span class="hljs-selector-tag">return</span> { <span class="hljs-attribute">content</span>: [{ <span class="hljs-attribute">type</span>: <span class="hljs-string">'document'</span>, <span class="hljs-attribute">source</span>: { <span class="hljs-attribute">type</span>: <span class="hljs-string">'base64'</span>, <span class="hljs-attribute">data</span>: result.data } }] };
  }
}
</code></pre>
<h6 data-id="heading-48">模块注册位置</h6>
<p>packages/bytebotd/src/mcp/bytebot-mcp.module.ts</p>
<pre><code class="hljs language-php" lang="php">import { McpModule } <span class="hljs-keyword">from</span> <span class="hljs-string">'@rekog/mcp-nest'</span>;

@<span class="hljs-title function_ invoke__">Module</span>({
  <span class="hljs-attr">imports</span>: [
    ComputerUseModule,
    McpModule.<span class="hljs-title function_ invoke__">forRoot</span>({
      <span class="hljs-attr">name</span>: <span class="hljs-string">'bytebotd'</span>,
      <span class="hljs-attr">version</span>: <span class="hljs-string">'0.0.1'</span>,
      <span class="hljs-attr">sseEndpoint</span>: <span class="hljs-string">'/mcp'</span>,  // 暴露 MCP SSE 端点
    }),
  ],
  <span class="hljs-attr">providers</span>: [ComputerUseTools],  // 注册工具提供者
})
export <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BytebotMcpModule</span> </span>{}
</code></pre>
<h6 data-id="heading-49">工具使用位置（主要）</h6>
<p>packages/bytebot-agent-cc/src/agent/agent.processor.ts这是 MCP 工具的主要使用位置：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 1. 连接到 MCP 服务器</span>
<span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> message <span class="hljs-keyword">of</span> <span class="hljs-title function_">query</span>({
  <span class="hljs-attr">prompt</span>: task.<span class="hljs-property">description</span>,
  <span class="hljs-attr">options</span>: {
    <span class="hljs-attr">mcpServers</span>: {
      <span class="hljs-attr">desktop</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-string">'sse'</span>,
        <span class="hljs-attr">url</span>: <span class="hljs-string">`<span class="hljs-subst">${BYTEBOT_DESKTOP_BASE_URL}</span>/mcp`</span>,  <span class="hljs-comment">// 连接到 bytebotd 的 MCP 端点</span>
      },
    },
  },
})) {
  <span class="hljs-comment">// 2. 处理工具调用</span>
  <span class="hljs-comment">// Claude Code 会调用工具，工具名称格式为：mcp__desktop__computer_xxx</span>
}

<span class="hljs-comment">// 3. 工具名称转换</span>
<span class="hljs-keyword">private</span> <span class="hljs-title function_">formatAnthropicResponse</span>(<span class="hljs-params">content: Anthropic.ContentBlock[]</span>) {
  <span class="hljs-comment">// 过滤出 MCP 工具调用</span>
  content = content.<span class="hljs-title function_">filter</span>(
    <span class="hljs-function">(<span class="hljs-params">block</span>) =&gt;</span>
      block.<span class="hljs-property">type</span> !== <span class="hljs-string">'tool_use'</span> || block.<span class="hljs-property">name</span>.<span class="hljs-title function_">startsWith</span>(<span class="hljs-string">'mcp__desktop__'</span>),
  );
  
  <span class="hljs-comment">// 移除前缀，转换为标准工具名称</span>
  <span class="hljs-keyword">return</span> content.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">block</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (block.<span class="hljs-property">type</span> === <span class="hljs-string">'tool_use'</span>) {
      <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">name</span>: block.<span class="hljs-property">name</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-string">'mcp__desktop__'</span>, <span class="hljs-string">''</span>),  <span class="hljs-comment">// 移除前缀</span>
        <span class="hljs-comment">// 例如：mcp__desktop__computer_click_mouse → computer_click_mouse</span>
      };
    }
  });
}
</code></pre>
<h6 data-id="heading-50">工具调用流程</h6>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e9c862c74321431d8f341658d5253f93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YC-5aKo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764733718&amp;x-signature=XlxBxFHZLWke4jGIi57enoS8pOU%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-51">shared - 共享类型和工具</h4>
<p>描述： 所有包共享的类型定义和工具函数，确保类型安全和代码复用。</p>
<h5 data-id="heading-52">类型定义</h5>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// ComputerAction Types 桌面操作类型</span>
MoveMouseAction
TraceMouseAction
ClickMouseAction
PressMouseAction
DragMouseAction
ScrollAction
TypeKeysAction
PressKeysAction
TypeTextAction
PasteTextAction
ApplicationAction
WriteFileAction
ReadFileAction

<span class="hljs-comment">// MessageContentBlock 消息内容类型</span>
TextContentBlock
ImageContentBlock
ToolUseContentBlock
ToolResultContentBlock
</code></pre>
<h4 data-id="heading-53">工具函数</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ComputerAction Utils:</span>
isMoveMouseAction
isClickMouseAction
<span class="hljs-comment">// ... 类型守卫函数</span>

<span class="hljs-comment">// MessageContent Utils:</span>
isTextContentBlock
isImageContentBlock
isToolUseContentBlock
<span class="hljs-comment">// ... 类型守卫函数</span>


<span class="hljs-comment">/**
 * 类型守卫：检查对象是否为工具使用内容块（通用）
 * <span class="hljs-doctag">@param</span> <span class="hljs-variable">obj</span> - 要验证的对象
 * <span class="hljs-doctag">@returns</span> 类型谓词，表示 obj 是 ToolUseContentBlock
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">isToolUseContentBlock</span>(<span class="hljs-params">
  obj: unknown
</span>): obj is <span class="hljs-title class_">ToolUseContentBlock</span> {
  <span class="hljs-keyword">if</span> (!obj || <span class="hljs-keyword">typeof</span> obj !== <span class="hljs-string">"object"</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
  }

  <span class="hljs-keyword">const</span> block = obj <span class="hljs-keyword">as</span> <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">ToolUseContentBlock</span>&gt;;
  <span class="hljs-keyword">return</span> (
    block.<span class="hljs-property">type</span> === <span class="hljs-title class_">MessageContentType</span>.<span class="hljs-property">ToolUse</span> &amp;&amp;
    <span class="hljs-keyword">typeof</span> block.<span class="hljs-property">name</span> === <span class="hljs-string">"string"</span> &amp;&amp;
    <span class="hljs-keyword">typeof</span> block.<span class="hljs-property">id</span> === <span class="hljs-string">"string"</span> &amp;&amp;
    block.<span class="hljs-property">input</span> !== <span class="hljs-literal">undefined</span> &amp;&amp;
    <span class="hljs-keyword">typeof</span> block.<span class="hljs-property">input</span> === <span class="hljs-string">"object"</span>
  );
}
</code></pre>
<h2 data-id="heading-54">总结</h2>
<ul>
<li><strong>bytebotd</strong>: 桌面控制的执行层</li>
<li><strong>bytebot-agent</strong>: 任务协调和 AI 交互的核心层</li>
<li><strong>bytebot-ui</strong>: 用户交互的展示层</li>
<li><strong>bytebot-llm-proxy</strong>: LLM 访问的统一入口层</li>
<li><strong>shared</strong>: 类型定义和工具函数的共享层</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS游戏开发入门：用ArkTS打造经典贪吃蛇]]></title>    <link>https://juejin.cn/post/7576689869808877604</link>    <guid>https://juejin.cn/post/7576689869808877604</guid>    <pubDate>2025-11-26T05:16:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576689869808877604" data-draft-id="7576646533614714934" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS游戏开发入门：用ArkTS打造经典贪吃蛇"/> <meta itemprop="keywords" content="HarmonyOS,ArkTS"/> <meta itemprop="datePublished" content="2025-11-26T05:16:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT充电站"/> <meta itemprop="url" content="https://juejin.cn/user/125809758576431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS游戏开发入门：用ArkTS打造经典贪吃蛇
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/125809758576431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT充电站
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T05:16:59.000Z" title="Wed Nov 26 2025 05:16:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>✨家人们记得点个账号关注，会持续发布大前端领域技术文章💕 🍃</p>
<h2 data-id="heading-0">引言</h2>
<p>贪吃蛇，这款承载了无数人童年回忆的经典游戏，不仅是编程入门的绝佳练手项目，也能很好地帮助开发者熟悉一个新的开发环境和其 UI 框架。本文将带你从零开始，一步步使用 HarmonyOS 的 ArkUI 框架（基于 TypeScript）来构建一个功能完整、逻辑清晰的贪吃蛇游戏。我们将从最基础的地图绘制，到最终的面向对象封装，深入探索游戏开发的乐趣和 ArkUI 的强大之处。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/054ace805e374ec498afb5ce9b50feac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTlhYXnlLXnq5k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764739019&amp;x-signature=rBL89nCdCfDFOY%2Fu8KknaN5dKTU%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fharmonyos-projects%2Fcodelabs" title="https://gitee.com/harmonyos-projects/codelabs" target="_blank" ref="nofollow noopener noreferrer">仓库地址（贪吃蛇目录）<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5307b0a76c148d1aeb9dc775a621aa3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTlhYXnlLXnq5k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764739019&amp;x-signature=aoJ32WHi0bxZX69PvZSZFVV5GO4%3D" alt="" loading="lazy"/>https://gitee.com/harmonyos-projects/codelabs</a></p>
<h2 data-id="heading-1">目录</h2>
<ol>
<li><strong>开发准备与环境搭建</strong></li>
<li><strong>第一步：绘制游戏地图</strong></li>
<li><strong>第二步：随机生成食物</strong></li>
<li><strong>第三步：创建并移动蛇</strong></li>
<li><strong>第四步：键盘控制与游戏逻辑</strong></li>
<li><strong>第五步：实现吃食物与计分</strong></li>
<li><strong>第六步：边界碰撞与游戏结束</strong></li>
<li><strong>第七步：游戏重置功能</strong></li>
<li><strong>进阶：面向对象封装</strong></li>
<li><strong>总结与展望</strong></li>
</ol>
<h2 data-id="heading-2">1. 开发准备与环境搭建</h2>
<ul>
<li><strong>工具</strong>：安装最新版的 <strong>DevEco Studio</strong>。</li>
<li><strong>语言</strong>：本项目使用 <strong>ArkTS</strong>。</li>
<li><strong>基础知识</strong>：了解 HarmonyOS 应用开发的基本概念，如 <code>@Entry</code>、<code>@Component</code>、<code>build()</code> 函数以及 <code>State</code> 装饰器等。</li>
</ul>
<h2 data-id="heading-3">2. 第一步：绘制游戏地图</h2>
<p>游戏的舞台是地图。我们将创建一个 20x20 的网格来作为我们的游戏区域。</p>
<p><strong>核心思路</strong>：使用 <code>ForEach</code> 循环嵌套，动态生成一个由小方块组成的二维网格。</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// Index.ets</span>
<span class="hljs-keyword">@Entry</span>
<span class="hljs-keyword">@Component</span>
struct SnakeGame {
  <span class="hljs-comment">// 创建一个 20x20 的二维数组，用于表示地图网格</span>
  private map: number[][] = <span class="hljs-built_in">Array</span>(<span class="hljs-number">20</span>).<span class="hljs-built_in">fill</span>(null).<span class="hljs-built_in">map</span>(() =&gt; <span class="hljs-built_in">Array</span>(<span class="hljs-number">20</span>).<span class="hljs-built_in">fill</span>(<span class="hljs-number">0</span>));

  <span class="hljs-built_in">build</span>() {
    <span class="hljs-built_in">Column</span>() {
      Text('贪吃蛇')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">30</span>)<span class="hljs-selector-class">.fontWeight</span>(FontWeight.Bold)<span class="hljs-selector-class">.margin</span>({ bottom: <span class="hljs-number">10</span> });

      <span class="hljs-comment">// 使用 Stack 来叠加地图、蛇和食物</span>
      <span class="hljs-built_in">Stack</span>() {
        <span class="hljs-comment">// 绘制地图背景</span>
        <span class="hljs-built_in">Column</span>() {
          <span class="hljs-built_in">ForEach</span>(this.map, (row: number[]) =&gt; {
            <span class="hljs-built_in">Row</span>() {
              <span class="hljs-built_in">ForEach</span>(row, () =&gt; {
                <span class="hljs-comment">// 每个小方块代表一个单元格</span>
                <span class="hljs-built_in">Column</span>() {}<span class="hljs-selector-class">.width</span>(<span class="hljs-number">15</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">15</span>)
                  <span class="hljs-selector-class">.backgroundColor</span>('#f0f0f0') <span class="hljs-comment">// 浅灰色背景</span>
                  <span class="hljs-selector-class">.border</span>({ width: <span class="hljs-number">0.5</span>, color: '#dddddd' }); <span class="hljs-comment">// 加上边框，看起来更像网格</span>
              })
            }
          })
        }
      }
      <span class="hljs-selector-class">.margin</span>({ top: <span class="hljs-number">20</span> })
      <span class="hljs-selector-class">.backgroundColor</span>('#ffffff') <span class="hljs-comment">// 地图容器背景</span>
      <span class="hljs-selector-class">.padding</span>(<span class="hljs-number">5</span>)
    }
    <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
    <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')
    <span class="hljs-selector-class">.justifyContent</span>(FlexAlign.Start)
    <span class="hljs-selector-class">.alignItems</span>(ItemAlign.Center)
    <span class="hljs-selector-class">.backgroundColor</span>('#e8e8e8');
  }
}
</code></pre>
<p><strong>代码解析</strong>：</p>
<ul>
<li>我们定义了一个 <code>map</code> 数组，它的唯一目的是提供一个数据源，让 <code>ForEach</code> 能够循环指定的次数（20 行，每行 20 列）。</li>
<li><code>Stack</code> 组件是实现游戏层叠效果的关键，后续的蛇和食物都将作为子组件放在这个 <code>Stack</code> 中。</li>
<li>每个单元格是一个 <code>Column</code>，通过设置固定的 <code>width</code> 和 <code>height</code> 来控制其大小。</li>
</ul>
<h2 data-id="heading-4">3. 第二步：随机生成食物</h2>
<p>食物是蛇的目标。我们需要在地图上随机位置生成一个红色的方块。</p>
<p><strong>核心思路</strong>：在组件初始化时，随机生成食物的 X 和 Y 坐标，并使用 <code>@State</code> 装饰器使其成为响应式数据，以便在位置改变时 UI 能够自动更新。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Index.ets</span>
<span class="hljs-comment">// ... (省略之前的代码)</span>
struct <span class="hljs-title class_">SnakeGame</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">map</span>: <span class="hljs-built_in">number</span>[][] = <span class="hljs-title class_">Array</span>(<span class="hljs-number">20</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-literal">null</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">20</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>));
  <span class="hljs-comment">// 使用 @State 装饰器，让食物位置变化时能刷新UI</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">food</span>: <span class="hljs-built_in">number</span>[] = []; <span class="hljs-comment">// [y, x]</span>

  <span class="hljs-comment">// 封装一个生成食物的函数</span>
  <span class="hljs-keyword">private</span> <span class="hljs-title function_">generateFood</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">food</span> = [
      <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">20</span>), <span class="hljs-comment">// 随机 Y 坐标 (0-19)</span>
      <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">20</span>)  <span class="hljs-comment">// 随机 X 坐标 (0-19)</span>
    ];
  }

  <span class="hljs-comment">// 组件即将出现时调用</span>
  <span class="hljs-title function_">aboutToAppear</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generateFood</span>();
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-comment">// ... (省略标题)</span>
      <span class="hljs-title class_">Stack</span>() {
        <span class="hljs-comment">// ... (省略地图绘制)</span>

        <span class="hljs-comment">// 绘制食物</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">food</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
          <span class="hljs-title class_">Text</span>()
            .<span class="hljs-title function_">width</span>(<span class="hljs-number">15</span>)
            .<span class="hljs-title function_">height</span>(<span class="hljs-number">15</span>)
            .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-title class_">Color</span>.<span class="hljs-property">Red</span>)
            .<span class="hljs-title function_">position</span>({
              <span class="hljs-attr">top</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">food</span>[<span class="hljs-number">0</span>] * <span class="hljs-number">15</span>,  <span class="hljs-comment">// Y坐标 * 单元格高度</span>
              <span class="hljs-attr">left</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">food</span>[<span class="hljs-number">1</span>] * <span class="hljs-number">15</span>  <span class="hljs-comment">// X坐标 * 单元格宽度</span>
            });
        }
      }
      <span class="hljs-comment">// ... (省略其他样式)</span>
    }
    <span class="hljs-comment">// ... (省略外层样式)</span>
  }
}
</code></pre>
<p><strong>代码解析</strong>：</p>
<ul>
<li><code>@State food: number[]</code>：<code>food</code> 数组的第一个元素是 Y 轴坐标，第二个是 X 轴坐标。<code>@State</code> 确保了一旦 <code>food</code> 的值改变，使用它的 UI 组件（这里是食物的 <code>position</code>）会重新渲染。</li>
<li><code>aboutToAppear()</code>：这是一个生命周期回调，在组件即将在界面上显示时执行。我们在这里调用 <code>generateFood()</code>，确保游戏一开始就有食物。</li>
<li><code>position({ top: ..., left: ... })</code>：通过绝对定位将食物放置在计算好的位置上。</li>
</ul>
<h2 data-id="heading-5">4. 第三步：创建并移动蛇</h2>
<p>蛇是游戏的主角。它由多个方块组成，需要根据规则移动。</p>
<p><strong>核心思路</strong>：用一个二维数组 <code>snake</code> 来存储蛇身体每个部分的坐标。移动时，从蛇尾开始，每个身体部分都移动到前一个部分的位置，最后再根据当前方向移动蛇头。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Index.ets</span>
<span class="hljs-comment">// ... (省略之前的代码)</span>
struct SnakeGame {
  <span class="hljs-comment">// ... (省略 map, food)</span>
  <span class="hljs-meta">@State</span> snake: number[][] = [
    [<span class="hljs-number">10</span>, <span class="hljs-number">6</span>], <span class="hljs-comment">// 蛇头 [y, x]</span>
    [<span class="hljs-number">10</span>, <span class="hljs-number">5</span>],
    [<span class="hljs-number">10</span>, <span class="hljs-number">4</span>],
    [<span class="hljs-number">10</span>, <span class="hljs-number">3</span>],
    [<span class="hljs-number">10</span>, <span class="hljs-number">2</span>]  <span class="hljs-comment">// 蛇尾</span>
  ];
  <span class="hljs-keyword">private</span> direction: <span class="hljs-string">'top'</span> | <span class="hljs-string">'left'</span> | <span class="hljs-string">'bottom'</span> | <span class="hljs-string">'right'</span> = <span class="hljs-string">'right'</span>; <span class="hljs-comment">// 初始方向向右</span>
  <span class="hljs-keyword">private</span> timer: number = <span class="hljs-number">0</span>; <span class="hljs-comment">// 定时器ID</span>

  <span class="hljs-comment">// ... (省略 generateFood, aboutToAppear)</span>

  <span class="hljs-comment">// 蛇移动的核心逻辑</span>
  <span class="hljs-keyword">private</span> moveSnake() {
    <span class="hljs-comment">// 从蛇尾开始，依次向前移动</span>
    <span class="hljs-keyword">for</span> (let i = <span class="hljs-keyword">this</span>.snake.length - <span class="hljs-number">1</span>; i &gt; <span class="hljs-number">0</span>; i--) {
      <span class="hljs-keyword">this</span>.snake[i] = [...<span class="hljs-keyword">this</span>.snake[i - <span class="hljs-number">1</span>]]; <span class="hljs-comment">// 复制前一个节点的坐标</span>
    }

    <span class="hljs-comment">// 根据方向移动蛇头</span>
    switch (<span class="hljs-keyword">this</span>.direction) {
      case <span class="hljs-string">'top'</span>:
        <span class="hljs-keyword">this</span>.snake[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]--;
        <span class="hljs-keyword">break</span>;
      case <span class="hljs-string">'bottom'</span>:
        <span class="hljs-keyword">this</span>.snake[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]++;
        <span class="hljs-keyword">break</span>;
      case <span class="hljs-string">'left'</span>:
        <span class="hljs-keyword">this</span>.snake[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]--;
        <span class="hljs-keyword">break</span>;
      case <span class="hljs-string">'right'</span>:
        <span class="hljs-keyword">this</span>.snake[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]++;
        <span class="hljs-keyword">break</span>;
    }
    
    <span class="hljs-comment">// 在 HarmonyOS 中，直接修改数组元素可能无法触发UI更新，</span>
    <span class="hljs-comment">// 因此我们创建一个新数组来触发重新渲染</span>
    <span class="hljs-keyword">this</span>.snake = [...<span class="hljs-keyword">this</span>.snake];
  }

  build() {
    Column() {
      <span class="hljs-comment">// ... (省略标题)</span>
      Stack() {
        <span class="hljs-comment">// ... (省略地图绘制)</span>
        <span class="hljs-comment">// ... (省略食物绘制)</span>

        <span class="hljs-comment">// 绘制蛇</span>
        ForEach(<span class="hljs-keyword">this</span>.snake, (segment: number[], index: number) =&gt; {
          Text()
            .width(<span class="hljs-number">15</span>)
            .height(<span class="hljs-number">15</span>)
            .backgroundColor(index === <span class="hljs-number">0</span> ? Color.Pink : Color.Black) <span class="hljs-comment">// 蛇头用粉色，身体用黑色</span>
            .position({
              top: segment[<span class="hljs-number">0</span>] * <span class="hljs-number">15</span>,
              left: segment[<span class="hljs-number">1</span>] * <span class="hljs-number">15</span>
            });
        })
      }
      <span class="hljs-comment">// ... (省略其他样式)</span>
    }
    <span class="hljs-comment">// ... (省略外层样式)</span>
  }
}
</code></pre>
<p><strong>代码解析</strong>：</p>
<ul>
<li><code>@State snake: number[][]</code>：<code>snake</code> 数组中的每个元素都是一个 <code>[y, x]</code> 坐标对，代表蛇身体的一个部分。数组的第一个元素是蛇头。</li>
<li><code>moveSnake()</code>：这是蛇移动的核心。通过循环，我们让蛇的每一节身体都 “继承” 前一节的位置，从而实现整体移动的效果。最后再单独处理蛇头的位置。</li>
<li><code>this.snake = [...this.snake];</code>：这是一个在 ArkUI 中非常重要的技巧。由于 <code>snake</code> 是一个引用类型（数组），直接修改其内部元素（如 <code>this.snake[0][0]--</code>）并不会触发 UI 的重新渲染。通过创建一个新的数组（使用扩展运算符 <code>...</code>）并赋值给 <code>this.snake</code>，我们可以强制触发 UI 更新。</li>
</ul>
<h2 data-id="heading-6">5. 第四步：键盘控制与游戏逻辑</h2>
<p>现在，我们需要让蛇动起来，并能通过按钮控制它的方向。</p>
<p><strong>核心思路</strong>：</p>
<ol>
<li>添加 “开始”、“暂停”、“重置” 按钮。</li>
<li>使用 <code>setInterval</code> 定时器来周期性地调用 <code>moveSnake</code> 函数，让蛇自动移动。</li>
<li>添加方向控制按钮（上、下、左、右），并在点击时改变 <code>direction</code> 变量的值。</li>
</ol>

<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// Index.ets</span>
<span class="hljs-comment">// ... (省略之前的代码)</span>
struct SnakeGame {
  <span class="hljs-comment">// ... (省略 map, food, snake, direction, timer)</span>
  <span class="hljs-keyword">@State</span> <span class="hljs-attribute">score</span>: number = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">@State</span> <span class="hljs-attribute">gameOverStr</span>: string = <span class="hljs-string">''</span>;

  <span class="hljs-comment">// ... (省略 generateFood, aboutToAppear, moveSnake)</span>

  <span class="hljs-comment">// 开始游戏</span>
  private <span class="hljs-built_in">startGame</span>() {
    this<span class="hljs-selector-class">.pauseGame</span>(); <span class="hljs-comment">// 先停止现有定时器，防止重复启动</span>
    this<span class="hljs-selector-class">.timer</span> = <span class="hljs-built_in">setInterval</span>(() =&gt; {
      this<span class="hljs-selector-class">.moveSnake</span>();
      this<span class="hljs-selector-class">.checkCollisions</span>(); <span class="hljs-comment">// 移动后检查碰撞</span>
    }, <span class="hljs-number">200</span>); <span class="hljs-comment">// 每200毫秒移动一次</span>
  }

  <span class="hljs-comment">// 暂停游戏</span>
  private <span class="hljs-built_in">pauseGame</span>() {
    if (this.timer) {
      <span class="hljs-built_in">clearInterval</span>(this.timer);
      this<span class="hljs-selector-class">.timer</span> = <span class="hljs-number">0</span>;
    }
  }

  <span class="hljs-built_in">build</span>() {
    <span class="hljs-built_in">Column</span>() {
      Text(`分数: ${this.score}`)<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">20</span>)<span class="hljs-selector-class">.margin</span>({ top: <span class="hljs-number">10</span> });

      <span class="hljs-comment">// 游戏控制按钮</span>
      <span class="hljs-built_in">Row</span>() {
        <span class="hljs-selector-tag">Button</span>('开始')<span class="hljs-selector-class">.onClick</span>(() =&gt; this<span class="hljs-selector-class">.startGame</span>());
        <span class="hljs-selector-tag">Button</span>('暂停')<span class="hljs-selector-class">.margin</span>({ left: <span class="hljs-number">10</span> })<span class="hljs-selector-class">.onClick</span>(() =&gt; this<span class="hljs-selector-class">.pauseGame</span>());
        <span class="hljs-selector-tag">Button</span>('重置')<span class="hljs-selector-class">.margin</span>({ left: <span class="hljs-number">10</span> })<span class="hljs-selector-class">.onClick</span>(() =&gt; this<span class="hljs-selector-class">.resetGame</span>());
      }<span class="hljs-selector-class">.margin</span>({ bottom: <span class="hljs-number">10</span> });

      <span class="hljs-comment">// ... (省略 Stack 中的地图、蛇、食物)</span>

      <span class="hljs-comment">// 方向控制按钮</span>
      <span class="hljs-built_in">Column</span>() {
        <span class="hljs-selector-tag">Button</span>('↑')<span class="hljs-selector-class">.onClick</span>(() =&gt; this<span class="hljs-selector-class">.direction</span> = '<span class="hljs-attribute">top</span>');
        <span class="hljs-built_in">Row</span>() {
          <span class="hljs-selector-tag">Button</span>('←')<span class="hljs-selector-class">.onClick</span>(() =&gt; this<span class="hljs-selector-class">.direction</span> = '<span class="hljs-attribute">left</span>');
          <span class="hljs-selector-tag">Button</span>('→')<span class="hljs-selector-class">.margin</span>({ left: <span class="hljs-number">20</span> })<span class="hljs-selector-class">.onClick</span>(() =&gt; this<span class="hljs-selector-class">.direction</span> = '<span class="hljs-attribute">right</span>');
        }<span class="hljs-selector-class">.margin</span>({ top: <span class="hljs-number">5</span>, bottom: <span class="hljs-number">5</span> });
        <span class="hljs-selector-tag">Button</span>('↓')<span class="hljs-selector-class">.onClick</span>(() =&gt; this<span class="hljs-selector-class">.direction</span> = '<span class="hljs-attribute">bottom</span>');
      }
      <span class="hljs-selector-class">.enabled</span>(this.gameOverStr === '') <span class="hljs-comment">// 游戏结束时禁用按钮</span>
      <span class="hljs-selector-class">.margin</span>({ top: <span class="hljs-number">20</span> });
    }
    <span class="hljs-comment">// ... (省略外层样式)</span>
  }
}
</code></pre>
<p><strong>注意</strong>：<code>checkCollisions</code> 和 <code>resetGame</code> 函数我们将在后续步骤中实现。</p>
<h2 data-id="heading-7">6. 第五步：实现吃食物与计分</h2>
<p>当蛇头移动到食物的位置时，蛇的身体应该变长，分数应该增加，并且食物应该在新的位置重新生成。</p>
<p><strong>核心思路</strong>：在 <code>moveSnake</code> 之后，检查蛇头坐标是否与食物坐标重合。如果重合，则在蛇尾添加一个新的身体部分，并重新生成食物。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Index.ets</span>
<span class="hljs-comment">// ... (省略之前的代码)</span>
struct SnakeGame {
  <span class="hljs-comment">// ... (省略所有变量和其他函数)</span>

  <span class="hljs-comment">// 检查碰撞（包括边界、自己、食物）</span>
  <span class="hljs-keyword">private</span> checkCollisions() {
    <span class="hljs-keyword">const</span> head = <span class="hljs-keyword">this</span>.snake[<span class="hljs-number">0</span>];

    <span class="hljs-comment">// 1. 检查是否吃到食物</span>
    <span class="hljs-keyword">if</span> (head[<span class="hljs-number">0</span>] === <span class="hljs-keyword">this</span>.food[<span class="hljs-number">0</span>] &amp;&amp; head[<span class="hljs-number">1</span>] === <span class="hljs-keyword">this</span>.food[<span class="hljs-number">1</span>]) {
      <span class="hljs-keyword">this</span>.score += <span class="hljs-number">10</span>;
      <span class="hljs-keyword">this</span>.snake.push([...<span class="hljs-keyword">this</span>.snake[<span class="hljs-keyword">this</span>.snake.length - <span class="hljs-number">1</span>]]); <span class="hljs-comment">// 在蛇尾添加一节</span>
      <span class="hljs-keyword">this</span>.generateFood();
      <span class="hljs-keyword">return</span>; <span class="hljs-comment">// 吃到食物后，不再检查死亡</span>
    }

    <span class="hljs-comment">// 后续将添加边界和自撞检测...</span>
  }

  <span class="hljs-keyword">private</span> startGame() {
    <span class="hljs-keyword">this</span>.pauseGame();
    <span class="hljs-keyword">this</span>.timer = setInterval(() =&gt; {
      <span class="hljs-keyword">this</span>.moveSnake();
      <span class="hljs-keyword">this</span>.checkCollisions(); <span class="hljs-comment">// 调用检查函数</span>
    }, <span class="hljs-number">200</span>);
  }

  <span class="hljs-comment">// ... (省略 build 方法)</span>
}
</code></pre>
<p><strong>代码解析</strong>：</p>
<ul>
<li><code>checkCollisions</code> 函数被放在 <code>setInterval</code> 中，在每次蛇移动后调用。</li>
<li>通过比较蛇头 <code>head</code> 和食物 <code>food</code> 的坐标来判断是否吃到食物。</li>
<li><code>this.snake.push([...this.snake[this.snake.length - 1]])</code>：当吃到食物时，我们在蛇数组的末尾添加一个新的元素，其坐标与当前蛇尾相同。由于下一次移动时，所有身体部分都会向前移动，这个新的部分就会自然地成为新的蛇尾，从而实现蛇身变长的效果。</li>
</ul>
<h2 data-id="heading-8">7. 第六步：边界碰撞与游戏结束</h2>
<p>游戏需要有结束条件。最常见的就是蛇头撞到地图边界或者撞到自己的身体。</p>
<p><strong>核心思路</strong>：在 <code>checkCollisions</code> 函数中，添加对边界和自身身体的检测。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// Index.ets</span>
<span class="hljs-comment">// ... (省略之前的代码)</span>
struct SnakeGame {
  <span class="hljs-comment">// ... (省略所有变量和其他函数)</span>

  <span class="hljs-comment">// 检查碰撞（包括边界、自己、食物）</span>
  <span class="hljs-keyword">private</span> checkCollisions() {
    <span class="hljs-keyword">const</span> head = <span class="hljs-keyword">this</span>.snake[<span class="hljs-number">0</span>];

    <span class="hljs-comment">// 1. 检查是否吃到食物 (上面已实现)</span>
    <span class="hljs-keyword">if</span> (head[<span class="hljs-number">0</span>] === <span class="hljs-keyword">this</span>.food[<span class="hljs-number">0</span>] &amp;&amp; head[<span class="hljs-number">1</span>] === <span class="hljs-keyword">this</span>.food[<span class="hljs-number">1</span>]) {
      <span class="hljs-comment">// ... (省略吃食物的逻辑)</span>
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 2. 检查边界碰撞</span>
    <span class="hljs-keyword">if</span> (head[<span class="hljs-number">0</span>] &lt; <span class="hljs-number">0</span> || head[<span class="hljs-number">0</span>] &gt;= <span class="hljs-number">20</span> || head[<span class="hljs-number">1</span>] &lt; <span class="hljs-number">0</span> || head[<span class="hljs-number">1</span>] &gt;= <span class="hljs-number">20</span>) {
      <span class="hljs-keyword">this</span>.gameOver(<span class="hljs-string">'游戏结束！撞到墙了！'</span>);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 3. 检查自撞</span>
    <span class="hljs-keyword">for</span> (let i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-keyword">this</span>.snake.length; i++) {
      <span class="hljs-keyword">if</span> (head[<span class="hljs-number">0</span>] === <span class="hljs-keyword">this</span>.snake[i][<span class="hljs-number">0</span>] &amp;&amp; head[<span class="hljs-number">1</span>] === <span class="hljs-keyword">this</span>.snake[i][<span class="hljs-number">1</span>]) {
        <span class="hljs-keyword">this</span>.gameOver(<span class="hljs-string">'游戏结束！撞到自己了！'</span>);
        <span class="hljs-keyword">return</span>;
      }
    }
  }

  <span class="hljs-comment">// 游戏结束</span>
  <span class="hljs-keyword">private</span> gameOver(message: string) {
    <span class="hljs-keyword">this</span>.pauseGame();
    <span class="hljs-keyword">this</span>.gameOverStr = message;
  }

  build() {
    Column() {
      <span class="hljs-comment">// ... (省略其他UI)</span>

      Stack() {
        <span class="hljs-comment">// ... (省略地图、蛇、食物绘制)</span>

        <span class="hljs-comment">// 游戏结束提示</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.gameOverStr) {
          Column() {
            Text(<span class="hljs-keyword">this</span>.gameOverStr).fontSize(<span class="hljs-number">30</span>).fontColor(Color.Red).fontWeight(FontWeight.Bold);
            Text(<span class="hljs-string">'点击重置按钮重新开始'</span>).fontSize(<span class="hljs-number">16</span>).fontColor(Color.Gray).margin({ top: <span class="hljs-number">10</span> });
          }
          .justifyContent(FlexAlign.Center)
          .alignItems(ItemAlign.Center)
          .backgroundColor(<span class="hljs-string">'rgba(255, 255, 255, 0.8)'</span>)
          .width(<span class="hljs-string">'100%'</span>)
          .height(<span class="hljs-string">'100%'</span>);
        }
      }
      <span class="hljs-comment">// ... (省略其他UI)</span>
    }
    <span class="hljs-comment">// ... (省略外层样式)</span>
  }
}
</code></pre>
<h2 data-id="heading-9">8. 第七步：游戏重置功能</h2>
<p>游戏结束后，玩家需要一个可以重新开始的按钮。</p>
<p><strong>核心思路</strong>：创建一个 <code>resetGame</code> 函数，将所有游戏状态（蛇的位置、方向、食物、分数、游戏结束标志等）恢复到初始值。</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// Index.ets</span>
<span class="hljs-comment">// ... (省略之前的代码)</span>
<span class="hljs-keyword">struct</span> SnakeGame {
  <span class="hljs-comment">// ... (省略所有变量和其他函数)</span>

  <span class="hljs-comment">// 重置游戏</span>
  <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-title">resetGame</span>()</span> {
    <span class="hljs-keyword">this</span>.pauseGame();
    <span class="hljs-keyword">this</span>.snake = [
      [<span class="hljs-meta">10, 6</span>],
      [<span class="hljs-meta">10, 5</span>],
      [<span class="hljs-meta">10, 4</span>],
      [<span class="hljs-meta">10, 3</span>],
      [<span class="hljs-meta">10, 2</span>]
    ];
    <span class="hljs-keyword">this</span>.direction = <span class="hljs-string">'right'</span>;
    <span class="hljs-keyword">this</span>.score = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">this</span>.gameOverStr = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">this</span>.generateFood();
  }

  build() {
    Column() {
      <span class="hljs-comment">// ...</span>
      Button(<span class="hljs-string">'重置'</span>).margin({ left: <span class="hljs-number">10</span> }).onClick(() =&gt; <span class="hljs-keyword">this</span>.resetGame());
      <span class="hljs-comment">// ...</span>
    }
  }
}
</code></pre>
<p>至此，一个功能完整的贪吃蛇游戏就已经完成了！你可以将以上代码整合到一个 <code>.ets</code> 文件中直接运行。</p>
<h2 data-id="heading-10">9. 进阶：面向对象封装 (OOP)</h2>
<p>对于简单的应用，将所有逻辑放在一个组件里是可行的。但为了提高代码的可读性、可维护性和可扩展性，我们应该采用面向对象的思想对代码进行重构。</p>
<p><strong>核心思路</strong>：将游戏中的核心元素（如蛇、食物、游戏控制器）抽象成独立的类。</p>
<h3 data-id="heading-11">9.1 创建领域模型 (Models)</h3>
<p><strong><code>Area.ts</code> - 地图模型</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// models/Area.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Area</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">row</span>: <span class="hljs-built_in">number</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">col</span>: <span class="hljs-built_in">number</span>;

    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">row: <span class="hljs-built_in">number</span> = <span class="hljs-number">20</span>, col: <span class="hljs-built_in">number</span> = <span class="hljs-number">20</span></span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">row</span> = row;
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">col</span> = col;
    }

    <span class="hljs-comment">// 创建地图网格数据</span>
    <span class="hljs-title function_">create</span>(): <span class="hljs-built_in">number</span>[][] {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">row</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-literal">null</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Array</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">col</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>));
    }
}
</code></pre>
<p><strong><code>Food.ts</code> - 食物模型</strong></p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// models/Food.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Food</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-attr">data</span>: <span class="hljs-built_in">number</span>[] = []; <span class="hljs-comment">// [y, x]</span>

    <span class="hljs-title function_">constructor</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> area: Area</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">generate</span>();
    }

    <span class="hljs-comment">// 随机生成食物位置</span>
    <span class="hljs-title function_">generate</span>(): <span class="hljs-built_in">void</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">data</span> = [
            <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-variable language_">this</span>.<span class="hljs-property">area</span>.<span class="hljs-property">row</span>),
            <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-variable language_">this</span>.<span class="hljs-property">area</span>.<span class="hljs-property">col</span>)
        ];
    }
}
</code></pre>
<p><strong><code>Snake.ts</code> - 蛇模型</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// models/Snake.ts</span>
export <span class="hljs-keyword">class</span> <span class="hljs-title class_">Snake</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">data</span>: number[][] = []; <span class="hljs-comment">// [ [y, x], [y, x], ... ]</span>
    <span class="hljs-keyword">private</span> direction: <span class="hljs-string">'top'</span> | <span class="hljs-string">'left'</span> | <span class="hljs-string">'bottom'</span> | <span class="hljs-string">'right'</span> = <span class="hljs-string">'right'</span>;

    <span class="hljs-keyword">constructor</span>() {
        <span class="hljs-keyword">this</span>.<span class="hljs-keyword">init</span>();
    }

    <span class="hljs-comment">// 初始化蛇的位置</span>
    <span class="hljs-keyword">init</span>(): void {
        <span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span> = [
            [<span class="hljs-number">10</span>, <span class="hljs-number">6</span>],
            [<span class="hljs-number">10</span>, <span class="hljs-number">5</span>],
            [<span class="hljs-number">10</span>, <span class="hljs-number">4</span>],
            [<span class="hljs-number">10</span>, <span class="hljs-number">3</span>],
            [<span class="hljs-number">10</span>, <span class="hljs-number">2</span>]
        ];
        <span class="hljs-keyword">this</span>.direction = <span class="hljs-string">'right'</span>;
    }

    <span class="hljs-comment">// 改变方向</span>
    changeDirection(newDirection: <span class="hljs-string">'top'</span> | <span class="hljs-string">'left'</span> | <span class="hljs-string">'bottom'</span> | <span class="hljs-string">'right'</span>): void {
        <span class="hljs-comment">// 防止蛇向相反方向移动（例如正在向右，不能直接向左）</span>
        <span class="hljs-keyword">const</span> oppositeDirections = {
            <span class="hljs-string">'top'</span>: <span class="hljs-string">'bottom'</span>,
            <span class="hljs-string">'bottom'</span>: <span class="hljs-string">'top'</span>,
            <span class="hljs-string">'left'</span>: <span class="hljs-string">'right'</span>,
            <span class="hljs-string">'right'</span>: <span class="hljs-string">'left'</span>
        };
        <span class="hljs-keyword">if</span> (newDirection !== oppositeDirections[<span class="hljs-keyword">this</span>.direction]) {
            <span class="hljs-keyword">this</span>.direction = newDirection;
        }
    }

    <span class="hljs-comment">// 移动一步</span>
    move(): void {
        <span class="hljs-comment">// 身体跟随</span>
        <span class="hljs-keyword">for</span> (let i = <span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span>.length - <span class="hljs-number">1</span>; i &gt; <span class="hljs-number">0</span>; i--) {
            <span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span>[i] = [...<span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span>[i - <span class="hljs-number">1</span>]];
        }
        <span class="hljs-comment">// 移动头部</span>
        switch (<span class="hljs-keyword">this</span>.direction) {
            case <span class="hljs-string">'top'</span>: <span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span>[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]--; <span class="hljs-keyword">break</span>;
            case <span class="hljs-string">'bottom'</span>: <span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span>[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]++; <span class="hljs-keyword">break</span>;
            case <span class="hljs-string">'left'</span>: <span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span>[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]--; <span class="hljs-keyword">break</span>;
            case <span class="hljs-string">'right'</span>: <span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span>[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]++; <span class="hljs-keyword">break</span>;
        }
    }

    <span class="hljs-comment">// 吃到食物后增长</span>
    grow(): void {
        <span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span>.push([...<span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span>[<span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span>.length - <span class="hljs-number">1</span>]]);
    }

    <span class="hljs-comment">// 获取蛇头</span>
    getHead(): number[] {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.<span class="hljs-keyword">data</span>[<span class="hljs-number">0</span>];
    }
}
</code></pre>
<h3 data-id="heading-12">9.2 创建游戏控制器 (Controller)</h3>
<p><strong><code>GameController.ts</code> - 游戏核心控制器</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// controller/GameController.ts</span>
<span class="hljs-keyword">import</span> { Area } from <span class="hljs-string">'../models/Area'</span>;
<span class="hljs-keyword">import</span> { Food } from <span class="hljs-string">'../models/Food'</span>;
<span class="hljs-keyword">import</span> { Snake } from <span class="hljs-string">'../models/Snake'</span>;

export <span class="hljs-keyword">class</span> <span class="hljs-title class_">GameController</span> {
    <span class="hljs-keyword">public</span> area: Area;
    <span class="hljs-keyword">public</span> food: Food;
    <span class="hljs-keyword">public</span> snake: Snake;
    <span class="hljs-keyword">public</span> score: number = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">public</span> isGameOver: boolean = <span class="hljs-literal">false</span>;
    <span class="hljs-keyword">public</span> gameOverMessage: string = <span class="hljs-string">''</span>;

    <span class="hljs-keyword">private</span> timer: number = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">private</span> speed: number = <span class="hljs-number">200</span>; <span class="hljs-comment">// 移动速度，毫秒</span>

    <span class="hljs-keyword">constructor</span>(<span class="hljs-keyword">private</span> row: number = <span class="hljs-number">20</span>, <span class="hljs-keyword">private</span> col: number = <span class="hljs-number">20</span>) {
        <span class="hljs-keyword">this</span>.area = new Area(row, col);
        <span class="hljs-keyword">this</span>.snake = new Snake();
        <span class="hljs-keyword">this</span>.food = new Food(<span class="hljs-keyword">this</span>.area);
    }

    <span class="hljs-comment">// 开始游戏</span>
    start(): void {
        <span class="hljs-keyword">this</span>.pause();
        <span class="hljs-keyword">this</span>.isGameOver = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">this</span>.gameOverMessage = <span class="hljs-string">''</span>;
        <span class="hljs-keyword">this</span>.timer = setInterval(() =&gt; {
            <span class="hljs-keyword">this</span>.snake.move();
            <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.checkCollisions()) {
                <span class="hljs-keyword">this</span>.gameLoop();
            }
        }, <span class="hljs-keyword">this</span>.speed);
    }

    <span class="hljs-comment">// 暂停游戏</span>
    pause(): void {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.timer) {
            clearInterval(<span class="hljs-keyword">this</span>.timer);
            <span class="hljs-keyword">this</span>.timer = <span class="hljs-number">0</span>;
        }
    }

    <span class="hljs-comment">// 重置游戏</span>
    reset(): void {
        <span class="hljs-keyword">this</span>.pause();
        <span class="hljs-keyword">this</span>.score = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">this</span>.isGameOver = <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">this</span>.gameOverMessage = <span class="hljs-string">''</span>;
        <span class="hljs-keyword">this</span>.snake.<span class="hljs-keyword">init</span>();
        <span class="hljs-keyword">this</span>.food.generate();
    }

    <span class="hljs-comment">// 游戏主循环逻辑</span>
    <span class="hljs-keyword">private</span> gameLoop(): void {
        <span class="hljs-comment">// 游戏逻辑更新后，可以在这里通知UI刷新</span>
    }

    <span class="hljs-comment">// 检查所有碰撞</span>
    <span class="hljs-keyword">private</span> checkCollisions(): boolean {
        <span class="hljs-keyword">const</span> head = <span class="hljs-keyword">this</span>.snake.getHead();

        <span class="hljs-comment">// 边界碰撞</span>
        <span class="hljs-keyword">if</span> (head[<span class="hljs-number">0</span>] &lt; <span class="hljs-number">0</span> || head[<span class="hljs-number">0</span>] &gt;= <span class="hljs-keyword">this</span>.area.row || head[<span class="hljs-number">1</span>] &lt; <span class="hljs-number">0</span> || head[<span class="hljs-number">1</span>] &gt;= <span class="hljs-keyword">this</span>.area.col) {
            <span class="hljs-keyword">this</span>.endGame(<span class="hljs-string">'撞到墙了！'</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        }

        <span class="hljs-comment">// 自撞</span>
        <span class="hljs-keyword">for</span> (let i = <span class="hljs-number">1</span>; i &lt; <span class="hljs-keyword">this</span>.snake.<span class="hljs-keyword">data</span>.length; i++) {
            <span class="hljs-keyword">if</span> (head[<span class="hljs-number">0</span>] === <span class="hljs-keyword">this</span>.snake.<span class="hljs-keyword">data</span>[i][<span class="hljs-number">0</span>] &amp;&amp; head[<span class="hljs-number">1</span>] === <span class="hljs-keyword">this</span>.snake.<span class="hljs-keyword">data</span>[i][<span class="hljs-number">1</span>]) {
                <span class="hljs-keyword">this</span>.endGame(<span class="hljs-string">'撞到自己了！'</span>);
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
            }
        }

        <span class="hljs-comment">// 食物碰撞</span>
        <span class="hljs-keyword">if</span> (head[<span class="hljs-number">0</span>] === <span class="hljs-keyword">this</span>.food.<span class="hljs-keyword">data</span>[<span class="hljs-number">0</span>] &amp;&amp; head[<span class="hljs-number">1</span>] === <span class="hljs-keyword">this</span>.food.<span class="hljs-keyword">data</span>[<span class="hljs-number">1</span>]) {
            <span class="hljs-keyword">this</span>.score += <span class="hljs-number">10</span>;
            <span class="hljs-keyword">this</span>.snake.grow();
            <span class="hljs-keyword">this</span>.food.generate();
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 没有发生导致游戏结束的碰撞</span>
    }

    <span class="hljs-comment">// 结束游戏</span>
    <span class="hljs-keyword">private</span> endGame(message: string): void {
        <span class="hljs-keyword">this</span>.pause();
        <span class="hljs-keyword">this</span>.isGameOver = <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">this</span>.gameOverMessage = message;
    }
}
</code></pre>
<h3 data-id="heading-13">9.3 重构 UI 组件</h3>
<p><strong><code>Index.ets</code> - 最终的 UI 展示</strong></p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// Index.ets</span>
import { GameController } from '../controller/GameController';

<span class="hljs-keyword">@Entry</span>
<span class="hljs-keyword">@Component</span>
struct SnakeGameUI {
    <span class="hljs-comment">// 实例化游戏控制器</span>
    private gameController: GameController = new <span class="hljs-built_in">GameController</span>();
    
    <span class="hljs-comment">// UI状态</span>
    <span class="hljs-keyword">@State</span> <span class="hljs-attribute">score</span>: number = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">@State</span> <span class="hljs-attribute">gameOverStr</span>: string = <span class="hljs-string">''</span>;
    <span class="hljs-keyword">@State</span> <span class="hljs-attribute">snakeSegments</span>: number[][] = [];
    <span class="hljs-keyword">@State</span> <span class="hljs-attribute">foodPos</span>: number[] = [];

    <span class="hljs-built_in">build</span>() {
        <span class="hljs-built_in">Column</span>() {
            Text('贪吃蛇 (OOP版)')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">30</span>)<span class="hljs-selector-class">.fontWeight</span>(FontWeight.Bold);
            Text(`分数: ${this.score}`)<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">20</span>)<span class="hljs-selector-class">.margin</span>({ top: <span class="hljs-number">5</span> });

            <span class="hljs-comment">// 控制按钮</span>
            <span class="hljs-built_in">Row</span>() {
                <span class="hljs-selector-tag">Button</span>('开始')<span class="hljs-selector-class">.onClick</span>(() =&gt; {
                    this<span class="hljs-selector-class">.gameController</span><span class="hljs-selector-class">.start</span>();
                    this<span class="hljs-selector-class">.updateUI</span>(); <span class="hljs-comment">// 开始后立即更新一次UI</span>
                });
                <span class="hljs-selector-tag">Button</span>('暂停')<span class="hljs-selector-class">.margin</span>({ left: <span class="hljs-number">10</span> })<span class="hljs-selector-class">.onClick</span>(() =&gt; this<span class="hljs-selector-class">.gameController</span><span class="hljs-selector-class">.pause</span>());
                <span class="hljs-selector-tag">Button</span>('重置')<span class="hljs-selector-class">.margin</span>({ left: <span class="hljs-number">10</span> })<span class="hljs-selector-class">.onClick</span>(() =&gt; {
                    this<span class="hljs-selector-class">.gameController</span><span class="hljs-selector-class">.reset</span>();
                    this<span class="hljs-selector-class">.updateUI</span>(); <span class="hljs-comment">// 重置后立即更新UI</span>
                });
            }<span class="hljs-selector-class">.margin</span>({ bottom: <span class="hljs-number">10</span> });

            <span class="hljs-comment">// 游戏区域</span>
            <span class="hljs-built_in">Stack</span>() {
                <span class="hljs-comment">// 地图</span>
                <span class="hljs-built_in">Column</span>() {
                    <span class="hljs-built_in">ForEach</span>(this.gameController.area.create(), (row: number[]) =&gt; {
                        <span class="hljs-built_in">Row</span>() {
                            <span class="hljs-built_in">ForEach</span>(row, () =&gt; {
                                <span class="hljs-built_in">Column</span>() {}<span class="hljs-selector-class">.width</span>(<span class="hljs-number">15</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">15</span>)<span class="hljs-selector-class">.backgroundColor</span>('#f0f0f0')<span class="hljs-selector-class">.border</span>({ width: <span class="hljs-number">0.5</span>, color: '#dddddd' });
                            })
                        }
                    })
                }

                <span class="hljs-comment">// 食物</span>
                Text()<span class="hljs-selector-class">.width</span>(<span class="hljs-number">15</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">15</span>)<span class="hljs-selector-class">.backgroundColor</span>(Color.Red)
                    <span class="hljs-selector-class">.position</span>({ top: this.foodPos[<span class="hljs-number">0</span>] * <span class="hljs-number">15</span>, left: this.foodPos[<span class="hljs-number">1</span>] * <span class="hljs-number">15</span> });

                <span class="hljs-comment">// 蛇</span>
                <span class="hljs-built_in">ForEach</span>(this.snakeSegments, (segment: number[], index: number) =&gt; {
                    Text()<span class="hljs-selector-class">.width</span>(<span class="hljs-number">15</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">15</span>)
                        <span class="hljs-selector-class">.backgroundColor</span>(index === <span class="hljs-number">0</span> ? Color.Pink : Color.Black)
                        <span class="hljs-selector-class">.position</span>({ top: segment[<span class="hljs-number">0</span>] * <span class="hljs-number">15</span>, left: segment[<span class="hljs-number">1</span>] * <span class="hljs-number">15</span> });
                })

                <span class="hljs-comment">// 游戏结束 overlay</span>
                if (this.gameOverStr) {
                    <span class="hljs-built_in">Column</span>() {
                        Text('游戏结束')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">30</span>)<span class="hljs-selector-class">.fontColor</span>(Color.Red)<span class="hljs-selector-class">.fontWeight</span>(FontWeight.Bold);
                        Text(this.gameOverStr)<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">20</span>)<span class="hljs-selector-class">.margin</span>({ top: <span class="hljs-number">10</span> });
                    }
                    <span class="hljs-selector-class">.justifyContent</span>(FlexAlign.Center)
                    <span class="hljs-selector-class">.alignItems</span>(ItemAlign.Center)
                    <span class="hljs-selector-class">.backgroundColor</span>('rgba(<span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">255</span>, <span class="hljs-number">0.7</span>)')
                    <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
                    <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>');
                }
            }
            <span class="hljs-selector-class">.width</span>(this.gameController.area.col * <span class="hljs-number">15</span> + <span class="hljs-number">10</span>) <span class="hljs-comment">// 加上padding</span>
            <span class="hljs-selector-class">.height</span>(this.gameController.area.row * <span class="hljs-number">15</span> + <span class="hljs-number">10</span>)
            <span class="hljs-selector-class">.backgroundColor</span>('#ffffff')
            <span class="hljs-selector-class">.padding</span>(<span class="hljs-number">5</span>)

            <span class="hljs-comment">// 方向键</span>
            <span class="hljs-built_in">Column</span>() {
                <span class="hljs-selector-tag">Button</span>('↑')<span class="hljs-selector-class">.onClick</span>(() =&gt; this<span class="hljs-selector-class">.gameController</span><span class="hljs-selector-class">.snake</span><span class="hljs-selector-class">.changeDirection</span>('top'));
                <span class="hljs-built_in">Row</span>() {
                    <span class="hljs-selector-tag">Button</span>('←')<span class="hljs-selector-class">.onClick</span>(() =&gt; this<span class="hljs-selector-class">.gameController</span><span class="hljs-selector-class">.snake</span><span class="hljs-selector-class">.changeDirection</span>('left'));
                    <span class="hljs-selector-tag">Button</span>('→')<span class="hljs-selector-class">.margin</span>({ left: <span class="hljs-number">20</span> })<span class="hljs-selector-class">.onClick</span>(() =&gt; this<span class="hljs-selector-class">.gameController</span><span class="hljs-selector-class">.snake</span><span class="hljs-selector-class">.changeDirection</span>('right'));
                }<span class="hljs-selector-class">.margin</span>({ top: <span class="hljs-number">5</span>, bottom: <span class="hljs-number">5</span> });
                <span class="hljs-selector-tag">Button</span>('↓')<span class="hljs-selector-class">.onClick</span>(() =&gt; this<span class="hljs-selector-class">.gameController</span><span class="hljs-selector-class">.snake</span><span class="hljs-selector-class">.changeDirection</span>('bottom'));
            }
            <span class="hljs-selector-class">.enabled</span>(!this.gameController.isGameOver)
            <span class="hljs-selector-class">.margin</span>({ top: <span class="hljs-number">20</span> })

        }
        <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
        <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')
        <span class="hljs-selector-class">.justifyContent</span>(FlexAlign.Start)
        <span class="hljs-selector-class">.alignItems</span>(ItemAlign.Center)
        <span class="hljs-selector-class">.backgroundColor</span>('#e8e8e8')
        <span class="hljs-selector-class">.onChange</span>(() =&gt; {
            <span class="hljs-comment">// 这是一个简化的UI刷新机制。在更复杂的应用中，你可能需要使用事件总线或状态管理库。</span>
            <span class="hljs-comment">// 这里假设游戏状态变化时会触发UI的重新渲染，从而调用updateUI</span>
            this<span class="hljs-selector-class">.updateUI</span>();
        })
    }

    <span class="hljs-comment">// 同步游戏状态到UI</span>
    private <span class="hljs-built_in">updateUI</span>() {
        this<span class="hljs-selector-class">.score</span> = this<span class="hljs-selector-class">.gameController</span><span class="hljs-selector-class">.score</span>;
        this<span class="hljs-selector-class">.gameOverStr</span> = this<span class="hljs-selector-class">.gameController</span><span class="hljs-selector-class">.gameOverMessage</span>;
        this<span class="hljs-selector-class">.snakeSegments</span> = <span class="hljs-selector-attr">[...this.gameController.snake.data]</span>;
        this<span class="hljs-selector-class">.foodPos</span> = <span class="hljs-selector-attr">[...this.gameController.food.data]</span>;
    }
}
</code></pre>
<p><strong>注意</strong>：上面的 <code>onChange</code> 是一种简化的模拟。在实际的 HarmonyOS 开发中，更优雅的方式是使用 <code>EventBus</code> 或者让控制器持有一个 UI 的回调接口，当游戏状态改变时主动通知 UI 刷新。这里的重点是展示如何将逻辑与 UI 分离。</p>
<hr/>
<h2 data-id="heading-14">10. 总结与展望</h2>
<p>恭喜你！你已经成功地使用 HarmonyOS ArkUI 框架从零开始构建了一个贪吃蛇游戏，并且还学习了如何使用面向对象的思想来重构代码。</p>
<p><strong>本项目涉及的关键技术点：</strong></p>
<ul>
<li>ArkUI 布局与组件（<code>Column</code>, <code>Row</code>, <code>Stack</code>, <code>ForEach</code>, <code>Button</code>, <code>Text</code>）。</li>
<li>响应式状态管理（<code>@State</code>）。</li>
<li>定时器的使用（<code>setInterval</code>, <code>clearInterval</code>）。</li>
<li>事件处理（<code>onClick</code>）。</li>
<li>游戏开发的基本模式（游戏循环、状态更新、碰撞检测）。</li>
<li>面向对象编程（封装、继承、多态的初步实践）。</li>
</ul>
<p><strong>未来可以扩展的功能：</strong></p>
<ol>
<li><strong>游戏难度选择</strong>：通过调整 <code>speed</code> 变量来实现不同的难度。</li>
<li><strong>记录最高分</strong>：使用 <code>Preferences</code> 存储用户的最高得分。</li>
<li><strong>更丰富的视觉效果</strong>：为蛇和食物添加图片或动画。</li>
<li><strong>使用物理按键或手势控制</strong>：除了屏幕按钮，可以监听设备的物理方向键或滑动手势。</li>
<li><strong>完善的状态管理</strong>：使用 <code>EventBus</code> 或 <code>Redux</code> 等模式，让控制器和 UI 的通信更加解耦和高效。</li>
</ol>
<p>希望这篇详细的教程能帮助你更好地理解 HarmonyOS 应用开发，并激发你开发更多有趣应用的灵感！</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F0a0a956faec348ddaa9b2676a3f19545%3Ftype%3D1%3Fha_source%3Dhmosclass%26ha_sourceId%3D89000248" title="https://developer.huawei.com/consumer/cn/training/classDetail/0a0a956faec348ddaa9b2676a3f19545?type=1?ha_source=hmosclass&amp;ha_sourceId=89000248" target="_blank" ref="nofollow noopener noreferrer">鸿蒙开发者班级</a></p>
<p>✨家人们点个账号关注，会持续发布大前端领域技术文章💕 🍃</p>
<p>✨家人们点个账号关注，会持续发布大前端领域技术文章💕 🍃</p>
<p>✨家人们点个账号关注，会持续发布大前端领域技术文章💕 🍃</p>
<p>   ^_^ 点关注、不迷路、主播带你学技术 (๑′ᴗ‵๑)Ｉ Lᵒᵛᵉᵧₒᵤ❤</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[prototype 是遗产，proto 是族谱：一文吃透 JS 原型链]]></title>    <link>https://juejin.cn/post/7576585511879000090</link>    <guid>https://juejin.cn/post/7576585511879000090</guid>    <pubDate>2025-11-26T05:33:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576585511879000090" data-draft-id="7576486942834835502" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="prototype 是遗产，proto 是族谱：一文吃透 JS 原型链"/> <meta itemprop="keywords" content="JavaScript,前端"/> <meta itemprop="datePublished" content="2025-11-26T05:33:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="xhxxx"/> <meta itemprop="url" content="https://juejin.cn/user/3235201610941578"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            prototype 是遗产，proto 是族谱：一文吃透 JS 原型链
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3235201610941578/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    xhxxx
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T05:33:58.000Z" title="Wed Nov 26 2025 05:33:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">JavaScript 原型系统核心解析</h2>
<h3 data-id="heading-1">引言：JS 面向对象的独特哲学</h3>
<p>在传统的面向对象语言中，对象是基于 <strong>“类”（Class）</strong> 创建的</p>
<ul>
<li><strong>类是模板</strong>，定义了属性和方法；</li>
<li><strong>对象是类的实例</strong>，通过 <code>new Class()</code> 生成；</li>
<li>继承是“血缘关系”——子类继承父类，结构静态且明确。</li>
</ul>
<p>而 JavaScript 采用 <strong>原型式面向对象（Prototype-based OOP）</strong> ：</p>
<ul>
<li><strong>没有“类”的概念</strong>（ES6 的 <code>class</code> 只是语法糖）；</li>
<li>对象直接从 <strong>另一个对象（原型）</strong>  继承属性和方法；</li>
<li>每个对象都有一个内部链接（<code>[[Prototype]]</code>），指向它的原型；</li>
<li>继承是“委托关系”——找不到属性时，自动向原型查找。</li>
</ul>
<h3 data-id="heading-2">构造函数与实例创建</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name,age</span>){
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> =name;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> =age;
}
<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">speci</span> = <span class="hljs-string">'人类'</span>
</code></pre>
<ul>
<li>new 的作用:创建一个新的对象，并返回</li>
<li><code>this</code> 的指向：this会在new这个新对象时绑定到新创建的对象上</li>
<li>实例私有属性的定义：在 JavaScript 中，实例私有属性是指直接定义在对象自身上、不被原型共享的属性。在上面的代码中，name和age是私有的，而speci则是所有对象实例所共有的属性</li>
</ul>
<blockquote>
<p>对象字面量的创建就像是传统工匠<br/>
构造函数就像是一个模具，可以快速的创建的出相同的对象实例</p>
</blockquote>
<h3 data-id="heading-3">prototype 是什么？</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b650f1f910d434781aae9fea42f2951~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGh4eHg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764740038&amp;x-signature=QDBC3tYF8zbPETFvW5208tr7GG4%3D" alt="4f3dc6bb97deaf5cdd9219bbd8316599.png" loading="lazy"/></p>
<ul>
<li>定义：他是所有函数独有的一个特殊属性</li>
<li>作用：用来存储所有实例对象所共有的属性和方法</li>
<li>结构：默认包含<code>constructor</code>，指向该实例原型的构造函数,<code>__proto_</code>_指向对象原型</li>
</ul>
<pre><code class="hljs language-js" lang="js">{
constructor：...
<span class="hljs-attr">__proto__</span>:....
}

</code></pre>
<h3 data-id="heading-4">实例如何访问原型？ __ proto __ 与原型链</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name,age</span>){
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> =name;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> =age;
}
<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">speci</span> = <span class="hljs-string">'人类'</span>
<span class="hljs-keyword">const</span> person1 =<span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'张三'</span>,<span class="hljs-number">18</span>);
<span class="hljs-keyword">const</span> person2 =<span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'李四'</span>,<span class="hljs-number">19</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person1);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(person1.<span class="hljs-property">__proto__</span>);

</code></pre>
<ul>
<li><strong>__ proto__是什么</strong>：是 JavaScript 中<strong>每个对象都具有的一个内部属性</strong>，它指向该对象的<strong>原型（prototype）</strong> ，也就是这个对象“从哪里继承属性和方法”。
等我们通过__proto__去进行访问时，可以得到该实例对象所继承的原型</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1dc9562df92245459784352e6acaa640~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGh4eHg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764740038&amp;x-signature=LLHPGZmkN3WFP1qomIK0ozmwiPU%3D" alt="image.png" loading="lazy"/></p>
<blockquote>
<p>但是,值得注意的是__proto__在现在并不推荐使用，<code>__proto__</code> 是 <code>[[Prototype]]</code> 的 getter/setter。
而在现在的编程当中，我们更推荐使用<code>Object.getPrototypeOf</code>和<code>Object.setPrototypeOf</code> 来取代 <code>__proto__</code> 去 get/set 原型</p>
</blockquote>
<h3 data-id="heading-5">prototype 与 <code>__proto__</code>的本质区别</h3>
<ul>
<li><strong>归属的对象不同</strong>：prototype是只有函数才具有的属性，而__proto__是所有对象都具有的一个内部属性</li>
<li><strong>所代表的含义不同</strong>：prototype是对象的原型，它包含了该构造函数所有实例对象的共有属性和方法，是一个对象，而__proto__ 是指向实例对象原型的链路，指向了实例对象的构造函数的prototype</li>
<li><strong>二者的关系</strong>:如图，实例.<strong>proto</strong> ==构造函数.prototype</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d87385af2d94d44bfe45a2e87af01e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGh4eHg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764740038&amp;x-signature=8Bm6eSlxQVlrGV%2FV5snrcY7btb4%3D" alt="03df9c3aaed1162b6c865b68407aa508.png" loading="lazy"/></p>
<h3 data-id="heading-6">覆盖 prototype 的常见问题</h3>
<ul>
<li><code>constructor</code> 丢失
考虑下面这段代码：</li>
</ul>
<pre><code class="hljs language-js" lang="js">
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name,age</span>){
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> =name;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> =age;
        }
        <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>={
            <span class="hljs-attr">speci</span>:<span class="hljs-string">'人类'</span>,
        }
        <span class="hljs-keyword">var</span> person1 =<span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'张三'</span>,<span class="hljs-number">18</span>);
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> == <span class="hljs-title class_">Person</span>);
        
</code></pre>
<p><strong>打印的结果是什么</strong>？  你以为是ture吗？实际上却是false！！！<br/>
按照一贯的思维来说，Person对象原型的构造函数确实是Person(),但是观察上述代码，我们修改了prototype，并把他赋值了一个普通的对象，但是我们没有<strong>重写构造函数</strong>，这就导致了实际上person.protope已经变成了<strong>Object</strong>的原型，所以才会导致false的结果</p>
<ul>
<li><strong>如何正确重写并修复</strong></li>
<li>
<ul>
<li>方案一：重写构造函数<br/>
在修改prototype时在代码中添加<code>constructor：Person;</code>就能重新告诉引擎当前这个实例的原型依旧是Person</li>
</ul>
</li>
<li>
<ul>
<li>方案二：只添加，不覆盖<br/>
例如：</li>
</ul>
</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">Person.prototype.speci</span>=<span class="hljs-string">'人类'</span><span class="hljs-comment">;</span>
</code></pre>
<p>这样的操作只会在原有的基础上扩展出speci属性，而不会覆盖掉整个的prototype</p>
<h3 data-id="heading-7">函数也是对象：<code>Function</code> 与 <code>Object</code> 的关系</h3>
<ul>
<li><code>Person.__proto__ === Function.prototype</code><br/>
考虑下面这段代码：</li>
</ul>
<pre><code class="hljs language-js" lang="js"> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name, age</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
        }
        <span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = {
            <span class="hljs-attr">speci</span>:<span class="hljs-string">"人类"</span>,
            
        }
        <span class="hljs-comment">// 对象的原型对象是？</span>
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">getPrototypeOf</span>(<span class="hljs-title class_">Person</span>)==<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);<span class="hljs-comment">//flase</span>
        
</code></pre>
<p><strong>我的理解</strong>：<br/>
Person是一个构造函数（所以他是Function的实例），它的__proto__指向的是函数的的原型，也就是Function.prototype<br/>
Function则是Object的一个实例，它的__proto__指向了Object.prototype</p>
<ul>
<li>原型链的完整路径</li>
</ul>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Person</span>
  └─ __proto__ → <span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>
                   └─ __proto__ → <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>
                                    └─ __proto__ → <span class="hljs-literal">null</span>
</code></pre>
<h3 data-id="heading-8">原型链的顶点:<code>Object.prototype</code></h3>
<p><strong>所有对象都沿着原型链最终指向Object.prototype,而Object[[Prototype]]指向的null，这意味着它是所有对象的终点</strong>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f714a4026f844ac9a0a88357ce774a80~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGh4eHg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764740038&amp;x-signature=389Lkvn6F%2BVeGDeJqADkY3%2BCyMM%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-9">理解 JS 原型的关键要点</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/849e2b94652a417a89557aca96365516~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgeGh4eHg=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764740038&amp;x-signature=5TQpwv4VYD62wrioffkvpEdpfaI%3D" alt="lQLPJyCHLn1iTmPNAg3NAk6wOERTvHM11HQJAGwnY_a5AA_590_525.png" loading="lazy"/>
终极记忆法：<br/>
<code>prototype</code>是父亲给后代的实际财富，它代表着所有后代所实际拥有的共有属性和方法<br/>
<code>__proto__</code>更像是一份DNA的鉴定，它指明了实例对象的父亲或者说祖宗是谁，我继承的谁的财富</p>
<blockquote>
<p>虽然在现代的javaScript我们可以使用class语法，但它实际上只是有一个语法糖，它的底层原理依然是<strong>构造函数 + prototype</strong>，清晰的理解prototype和__proto__有助于后面更高效的学习JS</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android15 Framework（2）：应用进程的孵化器 Zygote 进程解析]]></title>    <link>https://juejin.cn/post/7576538234274758666</link>    <guid>https://juejin.cn/post/7576538234274758666</guid>    <pubDate>2025-11-26T03:47:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576538234274758666" data-draft-id="7572095192419172379" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android15 Framework（2）：应用进程的孵化器 Zygote 进程解析"/> <meta itemprop="keywords" content="Android,源码阅读"/> <meta itemprop="datePublished" content="2025-11-26T03:47:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="光光跬步"/> <meta itemprop="url" content="https://juejin.cn/user/1286855157887751"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android15 Framework（2）：应用进程的孵化器 Zygote 进程解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1286855157887751/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    光光跬步
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T03:47:00.000Z" title="Wed Nov 26 2025 03:47:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><h2 data-id="heading-0">前言</h2>
<p>在上一篇文章<a href="https://juejin.cn/post/7571753301898444840" target="_blank" title="https://juejin.cn/post/7571753301898444840">《Android15 Framework（1）：用户空间第一个进程 Init 解析》</a>里面，我们看了Init进程，那么继续看看Zygote进程都做了什么吧。</p>
<blockquote>
<p>注意：本文出现的源码基于Android - 15.0.0_r1。另外本文关注主要逻辑，省略部分代码。</p>
</blockquote>
<h2 data-id="heading-1">一、 Android系统启动流程</h2>
<p>本文是介绍Zygote进程，照例先看下Android系统启动流程：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/09dc027096a64fb7a5e3fe14c6c97433~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764740774&amp;x-signature=i%2B0WPxO9CDT%2B32Ep1T9vTF31AHA%3D" alt="image.png" loading="lazy"/></p>
<p>启动电源及系统启动 -&gt; Bootloader -&gt; Linux内核启动 -&gt; Init -&gt; Zygote -&gt; SystemServer -&gt;  Launcher</p>
<h2 data-id="heading-2">二、Zygote进程</h2>
<p>Zygote是由Init启动，负责孵化所有APP进程，通过预加载机制提升系统效率，下面详细看看Zygote进程相关代码</p>
<h3 data-id="heading-3">2.1 app_main.cpp::main</h3>
<p>Init进程先调用fork方法，再通过execv方法，找到/system/bin/app_process64下的可执行文件，从而启动zygote进程。我们直接看Zygote进程的入口函数：<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fframeworks%2Fbase%2Fcmds%2Fapp_process%2Fapp_main.cpp%23173" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/frameworks/base/cmds/app_process/app_main.cpp#173" ref="nofollow noopener noreferrer">/frameworks/base/cmds/app_process/app_main.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span>* <span class="hljs-type">const</span> argv[])</span>
</span>{
    ...
    <span class="hljs-comment">// 创建AppRuntime</span>
    <span class="hljs-function">AppRuntime <span class="hljs-title">runtime</span><span class="hljs-params">(argv[<span class="hljs-number">0</span>], computeArgBlockSize(argc, argv))</span></span>;
    
    ...
    <span class="hljs-comment">// 定义了zygote变量</span>
    <span class="hljs-type">bool</span> zygote = <span class="hljs-literal">false</span>;
    <span class="hljs-type">bool</span> startSystemServer = <span class="hljs-literal">false</span>;
    <span class="hljs-type">bool</span> application = <span class="hljs-literal">false</span>;
    String8 niceName;
    String8 className;

    ++i;  <span class="hljs-comment">// Skip unused "parent dir" argument.</span>
    <span class="hljs-keyword">while</span> (i &lt; argc) {
        <span class="hljs-type">const</span> <span class="hljs-type">char</span>* arg = argv[i++];
        <span class="hljs-comment">// 如果参数argv中有--zygote, zygote变量为true</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(arg, <span class="hljs-string">"--zygote"</span>) == <span class="hljs-number">0</span>) {
            zygote = <span class="hljs-literal">true</span>;
            niceName = ZYGOTE_NICE_NAME;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(arg, <span class="hljs-string">"--start-system-server"</span>) == <span class="hljs-number">0</span>) {
            startSystemServer = <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(arg, <span class="hljs-string">"--application"</span>) == <span class="hljs-number">0</span>) {
            application = <span class="hljs-literal">true</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(arg, <span class="hljs-string">"--nice-name="</span>, <span class="hljs-number">12</span>) == <span class="hljs-number">0</span>) {
            niceName = (arg + <span class="hljs-number">12</span>);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strncmp</span>(arg, <span class="hljs-string">"--"</span>, <span class="hljs-number">2</span>) != <span class="hljs-number">0</span>) {
            className = arg;
            <span class="hljs-keyword">break</span>;
        } <span class="hljs-keyword">else</span> {
            --i;
            <span class="hljs-keyword">break</span>;
        }
    }
    ...

    <span class="hljs-comment">// zygote为true，执行此处</span>
    <span class="hljs-keyword">if</span> (zygote) {
        runtime.<span class="hljs-built_in">start</span>(<span class="hljs-string">"com.android.internal.os.ZygoteInit"</span>, args, zygote);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!className.<span class="hljs-built_in">empty</span>()) {
        runtime.<span class="hljs-built_in">start</span>(<span class="hljs-string">"com.android.internal.os.RuntimeInit"</span>, args, zygote);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-built_in">fprintf</span>(stderr, <span class="hljs-string">"Error: no class name or --zygote supplied.\n"</span>);
        <span class="hljs-built_in">app_usage</span>();
        <span class="hljs-built_in">LOG_ALWAYS_FATAL</span>(<span class="hljs-string">"app_process: no class name or --zygote supplied."</span>);
    }
}

</code></pre>
<p>此处的参数argv就是init.zygotexxx.rc文件中的-Xzygote /system/bin --zygote --start-system-server --socket-name=zygote。因此strcmp(arg, "--zygote，") == 0 为true，所以zygote变量也是true。<br/>
继续跟runtime.start("com.android.internal.os.ZygoteInit", args, zygote); 而runtime是定义为了AppRuntime, 它本身并没有实现start方法，因此看看它的父类AndroidRuntime</p>
<h3 data-id="heading-4">2.2 AndroidRuntime</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fframeworks%2Fbase%2Fcore%2Fjni%2FAndroidRuntime.cpp%23637" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/frameworks/base/core/jni/AndroidRuntime.cpp#637" ref="nofollow noopener noreferrer">/frameworks/base/core/jni/AndroidRuntime.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">AndroidRuntime::start</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* className, <span class="hljs-type">const</span> Vector&lt;String8&gt;&amp; options, <span class="hljs-type">bool</span> zygote)</span>
</span>{
    ...

    <span class="hljs-comment">// 加载so</span>
    JniInvocation jni_invocation;
    jni_invocation.<span class="hljs-built_in">Init</span>(<span class="hljs-literal">NULL</span>);
    JNIEnv* env;
    <span class="hljs-comment">// 启动虚拟机</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">startVm</span>(&amp;mJavaVM, &amp;env, zygote, primary_zygote) != <span class="hljs-number">0</span>) {
        <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-built_in">onVmCreated</span>(env);

    <span class="hljs-comment">/*
     * Register android functions.
     */</span>
    <span class="hljs-comment">// 注册JNI</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">startReg</span>(env) &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">"Unable to register all android natives\n"</span>);
        <span class="hljs-keyword">return</span>;
    }

    ...
    <span class="hljs-type">char</span>* slashClassName = <span class="hljs-built_in">toSlashClassName</span>(className != <span class="hljs-literal">NULL</span> ? className : <span class="hljs-string">""</span>);
    jclass startClass = env-&gt;<span class="hljs-built_in">FindClass</span>(slashClassName);
    <span class="hljs-keyword">if</span> (startClass == <span class="hljs-literal">NULL</span>) {
        <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">"JavaVM unable to locate class '%s'\n"</span>, slashClassName);
        <span class="hljs-comment">/* keep going */</span>
    } <span class="hljs-keyword">else</span> {
        jmethodID startMeth = env-&gt;<span class="hljs-built_in">GetStaticMethodID</span>(startClass, <span class="hljs-string">"main"</span>,
            <span class="hljs-string">"([Ljava/lang/String;)V"</span>);
        <span class="hljs-keyword">if</span> (startMeth == <span class="hljs-literal">NULL</span>) {
            <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">"JavaVM unable to find main() in '%s'\n"</span>, className);
            <span class="hljs-comment">/* keep going */</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 进入Zygote java</span>
            env-&gt;<span class="hljs-built_in">CallStaticVoidMethod</span>(startClass, startMeth, strArray);

<span class="hljs-meta">#<span class="hljs-keyword">if</span> 0</span>
            <span class="hljs-keyword">if</span> (env-&gt;<span class="hljs-built_in">ExceptionCheck</span>())
                <span class="hljs-built_in">threadExitUncaughtException</span>(env);
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
        }
    }
    ...
}
</code></pre>
<p>在AndroidRuntime::start方法中，主要做了下面几件事</p>
<ul>
<li>加载so</li>
<li>启动Java虚拟机</li>
<li>注册JNI</li>
<li>进入Zygote java</li>
</ul>
<p>我们看看具体都是怎么做的</p>
<h4 data-id="heading-5">2.2.1 加载so</h4>
<p>jni_invocation.Init(NULL) 调用了定义在JniInvocation.h的JniInvocation类的Init方法<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Flibnativehelper%2Finclude_platform%2Fnativehelper%2FJniInvocation.h%23106" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/libnativehelper/include_platform/nativehelper/JniInvocation.h#106" ref="nofollow noopener noreferrer">/libnativehelper/include_platform/nativehelper/JniInvocation.h</a></p>
<pre><code class="hljs language-C++" lang="C++">    <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Init</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* library)</span> </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">JniInvocationInit</span>(impl_, library) != <span class="hljs-number">0</span>;
    }
</code></pre>
<p>这个方法很简单，调用了JniInvocationInit方法，看看它的实现<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Flibnativehelper%2FJniInvocation.c%23168" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/libnativehelper/JniInvocation.c#168" ref="nofollow noopener noreferrer">/libnativehelper/JniInvocation.c</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">JniInvocationInit</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> JniInvocationImpl* instance, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* library_name)</span> </span>{
<span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> __ANDROID__</span>
  <span class="hljs-type">char</span> buffer[PROP_VALUE_MAX];
<span class="hljs-meta">#<span class="hljs-keyword">else</span></span>
  <span class="hljs-type">char</span>* buffer = <span class="hljs-literal">NULL</span>;
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
  library_name = <span class="hljs-built_in">JniInvocationGetLibrary</span>(library_name, buffer);
  DlLibrary library = <span class="hljs-built_in">DlOpenLibrary</span>(library_name);
  ...

  DlSymbol JNI_CreateJavaVM_ = <span class="hljs-built_in">FindSymbol</span>(library, <span class="hljs-string">"JNI_CreateJavaVM"</span>);
  ...
}
</code></pre>
<p>JniInvocationInit方法的实现在JniInvocation.c里，在这个方法中，先调用了JniInvocationGetLibrary获取lib名，再调用DlOpenLibrary加载lib。我们先看看JniInvocationGetLibrary做了什么<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Flibnativehelper%2FJniInvocation.c%23151" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/libnativehelper/JniInvocation.c#151" ref="nofollow noopener noreferrer">/libnativehelper/JniInvocation.c</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">const</span> <span class="hljs-type">char</span>* <span class="hljs-title">JniInvocationGetLibrary</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* library, <span class="hljs-type">char</span>* buffer)</span> </span>{
  <span class="hljs-type">bool</span> debuggable = <span class="hljs-built_in">IsDebuggable</span>(); 
  <span class="hljs-type">const</span> <span class="hljs-type">char</span>* system_preferred_library = <span class="hljs-literal">NULL</span>;
  <span class="hljs-keyword">if</span> (buffer != <span class="hljs-literal">NULL</span> &amp;&amp; (<span class="hljs-built_in">GetLibrarySystemProperty</span>(buffer) &gt; <span class="hljs-number">0</span>)) {
    system_preferred_library = buffer;
  }
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">JniInvocationGetLibraryWith</span>(library, debuggable, system_preferred_library);
}
</code></pre>
<p>JniInvocationGetLibrary先调用了IsDebuggable方法，获取debuggable参数，再调用JniInvocationGetLibraryWith方法，先看看IsDebuggable方法<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Flibnativehelper%2FJniInvocation.c%2367" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/libnativehelper/JniInvocation.c#67" ref="nofollow noopener noreferrer">/libnativehelper/JniInvocation.c</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">IsDebuggable</span><span class="hljs-params">()</span> </span>{
<span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> __ANDROID__</span>
  <span class="hljs-type">char</span> debuggable[PROP_VALUE_MAX] = {<span class="hljs-number">0</span>};
  __system_property_get(<span class="hljs-string">"ro.debuggable"</span>, debuggable);
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">strcmp</span>(debuggable, <span class="hljs-string">"1"</span>) == <span class="hljs-number">0</span>;
<span class="hljs-meta">#<span class="hljs-keyword">else</span></span>
  <span class="hljs-comment">// Host is always treated as debuggable, which allows choice of library to be overridden.</span>
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
}
</code></pre>
<p>IsDebuggable方法里面，先判断是否定义了宏__ANDROID__，如果定义了，获取属性ro.debuggable，如果是1，则为true，否则为false。未定义则直接返回true。这里android系统中会定义为__ANDROID__，并且正式版本ro.debuggable定义为0。因此IsDebuggable会返回false。<br/>
可以通过adb shell getprop ro.xxx来获取系统属性：
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/def54f35b0984141a452a0fbfde866e3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YWJ5YWJ6Les5q2l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764740774&amp;x-signature=4jrnbYtySpgT0K%2FaNFX9peLCM88%3D" alt="image.png" loading="lazy"/></p>
<p>在知道了debuggable为false之后，我们继续跟JniInvocationGetLibrary后续的代码，即JniInvocationGetLibraryWith<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Flibnativehelper%2FJniInvocation.c%23122" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/libnativehelper/JniInvocation.c#122" ref="nofollow noopener noreferrer">/libnativehelper/JniInvocation.c</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">const</span> <span class="hljs-type">char</span>* <span class="hljs-title">JniInvocationGetLibraryWith</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* library,
                                        <span class="hljs-type">bool</span> is_debuggable,
                                        <span class="hljs-type">const</span> <span class="hljs-type">char</span>* system_preferred_library)</span> </span>{
  <span class="hljs-keyword">if</span> (is_debuggable) {
    <span class="hljs-comment">// Debuggable property is set. Allow library providing JNI Invocation API to be overridden.</span>

    <span class="hljs-comment">// Choose the library parameter (if provided).</span>
    <span class="hljs-keyword">if</span> (library != <span class="hljs-literal">NULL</span>) {
      <span class="hljs-keyword">return</span> library;
    }

    <span class="hljs-comment">// If the debug library is installed, use it.</span>
    <span class="hljs-comment">// TODO(b/216099383): Do this in the test harness instead.</span>
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">stat</span> st;
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">stat</span>(kDebugJniInvocationLibraryPath, &amp;st) == <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> kDebugJniInvocationLibrary;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (errno != ENOENT) {
      <span class="hljs-built_in">ALOGW</span>(<span class="hljs-string">"Failed to stat %s: %s"</span>, kDebugJniInvocationLibraryPath, <span class="hljs-built_in">strerror</span>(errno));
    }

    <span class="hljs-comment">// Choose the system_preferred_library (if provided).</span>
    <span class="hljs-keyword">if</span> (system_preferred_library != <span class="hljs-literal">NULL</span>) {
      <span class="hljs-keyword">return</span> system_preferred_library;
    }

  }
  <span class="hljs-keyword">return</span> kDefaultJniInvocationLibrary;
}
</code></pre>
<p>JniInvocationGetLibraryWith的参数is_debuggable为false，因此这里就是kDefaultJniInvocationLibrary的值，它是libart.so<br/>
到现在为止，我们知道了JniInvocationGetLibrary(library_name, buffer)返回了"libart.so", 并赋值给了library_name。继续看看DlOpenLibrary(library_name)是怎么来加载so的<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Flibnativehelper%2FDlHelp.c%2328" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/libnativehelper/DlHelp.c#28" ref="nofollow noopener noreferrer">/libnativehelper/DlHelp.c</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function">DlLibrary <span class="hljs-title">DlOpenLibrary</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* filename)</span> </span>{
<span class="hljs-meta">#<span class="hljs-keyword">ifdef</span> _WIN32</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">LoadLibrary</span>(filename);
<span class="hljs-meta">#<span class="hljs-keyword">else</span></span>
  <span class="hljs-comment">// Load with RTLD_NODELETE in order to ensure that libart.so is not unmapped when it is closed.</span>
  <span class="hljs-comment">// This is due to the fact that it is possible that some threads might have yet to finish</span>
  <span class="hljs-comment">// exiting even after JNI_DeleteJavaVM returns, which can lead to segfaults if the library is</span>
  <span class="hljs-comment">// unloaded.</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">dlopen</span>(filename, RTLD_NOW | RTLD_NODELETE);
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
}
</code></pre>
<p>DlOpenLibrary方法先判断是否定义了宏_WIN32，定义了调用LoadLibrary，否则调用dlopen。_WIN32 是 Windows 平台下常用的预定义宏, 所以此处调用dlopen来加载so文件了。而dlopen里面具体做了什么，此处就不继续跟了。</p>
<p>最后看下JniInvocationInit中的DlSymbol JNI_CreateJavaVM_ = FindSymbol(library, "JNI_CreateJavaVM")，这一句会在找到 VM 提供库中实现的那个函数，也就是 java_vm_ext.cc 中的 JNI_CreateJavaVM。后续会调用JNI_CreateJavaVM函数，这里提一下</p>
<p>小结一下加载so文件，先获取需要加载的so文件名libart.so，然后调用dlopen去加载它。</p>
<h4 data-id="heading-6">2.2.2 创建Java虚拟机</h4>
<p>看完了加载so，继续看看startVm是怎么创建Java虚拟机的<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fframeworks%2Fbase%2Fcore%2Fjni%2FAndroidRuntime.cpp%231191" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/frameworks/base/core/jni/AndroidRuntime.cpp#1191" ref="nofollow noopener noreferrer">/frameworks/base/core/jni/AndroidRuntime.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">AndroidRuntime::startVm</span><span class="hljs-params">(JavaVM** pJavaVM, JNIEnv** pEnv, <span class="hljs-type">bool</span> zygote, <span class="hljs-type">bool</span> primary_zygote)</span>
</span>{
    JavaVMInitArgs initArgs;
    <span class="hljs-comment">// 声明参数缓冲区</span>
    <span class="hljs-type">char</span> propBuf[PROPERTY_VALUE_MAX];
    <span class="hljs-type">char</span> jniOptsBuf[<span class="hljs-built_in">sizeof</span>(<span class="hljs-string">"-Xjniopts:"</span>)<span class="hljs-number">-1</span> + PROPERTY_VALUE_MAX];
    <span class="hljs-type">char</span> heapstartsizeOptsBuf[<span class="hljs-built_in">sizeof</span>(<span class="hljs-string">"-Xms"</span>)<span class="hljs-number">-1</span> + PROPERTY_VALUE_MAX];
    ...
    
    <span class="hljs-comment">// 读取系统属性再拼接之后，添加到mOptions中</span>
    <span class="hljs-built_in">parseRuntimeOption</span>(<span class="hljs-string">"dalvik.vm.heapstartsize"</span>, heapstartsizeOptsBuf, <span class="hljs-string">"-Xms"</span>, <span class="hljs-string">"4m"</span>);
    <span class="hljs-built_in">parseRuntimeOption</span>(<span class="hljs-string">"dalvik.vm.heapsize"</span>, heapsizeOptsBuf, <span class="hljs-string">"-Xmx"</span>, <span class="hljs-string">"16m"</span>);

    <span class="hljs-built_in">parseRuntimeOption</span>(<span class="hljs-string">"dalvik.vm.heapgrowthlimit"</span>, heapgrowthlimitOptsBuf, <span class="hljs-string">"-XX:HeapGrowthLimit="</span>);
    ...
    
    <span class="hljs-comment">// 将解析的属性添加到JavaVMInitArgs中</span>
    initArgs.version = JNI_VERSION_1_4;
    initArgs.options = mOptions.<span class="hljs-built_in">editArray</span>();
    initArgs.nOptions = mOptions.<span class="hljs-built_in">size</span>();
    initArgs.ignoreUnrecognized = JNI_FALSE;

    <span class="hljs-comment">// 调用JNI_CreateJavaVM创建并启动 Java 虚拟机</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">JNI_CreateJavaVM</span>(pJavaVM, pEnv, &amp;initArgs) &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">"JNI_CreateJavaVM failed\n"</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
</code></pre>
<p>在AndroidRuntime::startVm方法中，主要做了4件事</p>
<ul>
<li>声明参数缓冲区</li>
<li>读取系统属性再拼接之后，添加到mOptions中</li>
<li>将解析的属性添加到JavaVMInitArgs中</li>
<li>调用JNI_CreateJavaVM创建并启动 Java 虚拟机</li>
</ul>
<p>这里只看看JNI_CreateJavaVM具体是怎么创建并启动 Java 虚拟机<br/>
在1.2.1小节中，我们知道了JniInvocationInit通过调用FindSymbol(library, "JNI_CreateJavaVM")，在 VM 提供库中找到实现的函数，也就是java_vm_ext.cc 中的 JNI_CreateJavaVM，看看它的代码
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fart%2Fruntime%2Fjni%2Fjava_vm_ext.cc%231212" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/art/runtime/jni/java_vm_ext.cc#1212" ref="nofollow noopener noreferrer">/art/runtime/jni/java_vm_ext.cc</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-keyword">extern</span> <span class="hljs-string">"C"</span> <span class="hljs-function">EXPORT jint <span class="hljs-title">JNI_CreateJavaVM</span><span class="hljs-params">(JavaVM** p_vm, JNIEnv** p_env, <span class="hljs-type">void</span>* vm_args)</span> </span>{
  ...
  <span class="hljs-comment">// 创建虚拟机</span>
  <span class="hljs-keyword">if</span> (!Runtime::<span class="hljs-built_in">Create</span>(options, ignore_unrecognized)) {
    <span class="hljs-keyword">return</span> JNI_ERR;
  }

  ...
  <span class="hljs-comment">// 初始化本地库加载器</span>
  android::<span class="hljs-built_in">InitializeNativeLoader</span>();

  Runtime* runtime = Runtime::<span class="hljs-built_in">Current</span>();
  <span class="hljs-comment">// 启动虚拟机</span>
  <span class="hljs-type">bool</span> started = runtime-&gt;<span class="hljs-built_in">Start</span>();
  ...
  <span class="hljs-keyword">return</span> JNI_OK;
}
</code></pre>
<p>在JNI_CreateJavaVM方法中先调用Runtime::Create去创建虚拟机，再调用runtime-&gt;Start去启动虚拟机，我们先看看创建虚拟机是做了什么<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fart%2Fruntime%2Fjni%2Fjava_vm_ext.cc%23541" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/art/runtime/jni/java_vm_ext.cc#541" ref="nofollow noopener noreferrer">/art/runtime/jni/java_vm_ext.cc</a></p>
<pre><code class="hljs language-C++" lang="C++"> <span class="hljs-function">std::unique_ptr&lt;JavaVMExt&gt; <span class="hljs-title">JavaVMExt::Create</span><span class="hljs-params">(Runtime* runtime, <span class="hljs-type">const</span> RuntimeArgumentMap&amp; runtime_options, std::string* error_msg)</span> </span>{
    <span class="hljs-function">std::unique_ptr&lt;JavaVMExt&gt; <span class="hljs-title">java_vm</span><span class="hljs-params">(<span class="hljs-keyword">new</span> JavaVMExt(runtime, runtime_options))</span></span>;
    <span class="hljs-keyword">if</span> (!java_vm-&gt;<span class="hljs-built_in">Initialize</span>(error_msg)) {
      <span class="hljs-keyword">return</span> <span class="hljs-literal">nullptr</span>;
    }
    <span class="hljs-keyword">return</span> java_vm;
  }
</code></pre>
<p>Runtime::Create调用了JavaVMExt的Initialize，继续跟<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fart%2Fruntime%2Fjni%2Fjava_vm_ext.cc%23532" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/art/runtime/jni/java_vm_ext.cc#532" ref="nofollow noopener noreferrer">/art/runtime/jni/java_vm_ext.cc</a></p>
<pre><code class="hljs language-C++" lang="C++">  <span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">JavaVMExt::Initialize</span><span class="hljs-params">(std::string* error_msg)</span> </span>{
    <span class="hljs-keyword">return</span> globals_.<span class="hljs-built_in">Initialize</span>(kGlobalsMax, error_msg) &amp;&amp;
           weak_globals_.<span class="hljs-built_in">Initialize</span>(kWeakGlobalsMax, error_msg);
  }
</code></pre>
<p>JavaVMExt::Initializ方法很简单，初始化了globals_和weak_globals_，它俩的定义如下：<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fart%2Fruntime%2Fjni%2Fjava_vm_ext.h%23258" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/art/runtime/jni/java_vm_ext.h#258" ref="nofollow noopener noreferrer">/art/runtime/jni/java_vm_ext.h</a></p>
<pre><code class="hljs language-C++" lang="C++">    IndirectReferenceTable globals_;
    IndirectReferenceTable weak_globals_;
</code></pre>
<p>globals_表示强引用对象，不会被GC回收；weak_globals_表示弱引用对象，会被GC回收。<br/>
因此创建虚拟机Runtime::Create 其实就是初始化了globals_和weak_globals_。<br/>
再接着看看启动虚拟机runtime-&gt;Start<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fart%2Fruntime%2Fruntime.cc%231037" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/art/runtime/runtime.cc#1037" ref="nofollow noopener noreferrer">/art/runtime/runtime.cc</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">Runtime::Start</span><span class="hljs-params">()</span> </span>{
  ...
  <span class="hljs-comment">// 将运行时需要的 JNI 本地方法注册好。</span>
  <span class="hljs-built_in">RegisterRuntimeNativeMethods</span>(self-&gt;<span class="hljs-built_in">GetJniEnv</span>());
  class_linker_-&gt;<span class="hljs-built_in">RunEarlyRootClinits</span>(self);
  <span class="hljs-built_in">InitializeIntrinsics</span>();
  self-&gt;<span class="hljs-built_in">TransitionFromRunnableToSuspended</span>(ThreadState::kNative);
  <span class="hljs-built_in">InitNativeMethods</span>();
  …
  <span class="hljs-comment">// 启动守护线程、设置系统类加载器</span>
  <span class="hljs-built_in">StartDaemonThreads</span>();
  …
  finished_starting_ = <span class="hljs-literal">true</span>;
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<h4 data-id="heading-7">2.2.3 注册JNI</h4>
<p>在执行完加载so和启动虚拟机之后，就会注册jni，这部分代码在AndroidRuntime类的startReg方法中，下面详细看看这个方法<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fframeworks%2Fbase%2Fcore%2Fjni%2FAndroidRuntime.cpp%231690" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/frameworks/base/core/jni/AndroidRuntime.cpp#1690" ref="nofollow noopener noreferrer">/frameworks/base/core/jni/AndroidRuntime.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-comment">/*static*/</span> <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">AndroidRuntime::startReg</span><span class="hljs-params">(JNIEnv* env)</span>
</span>{
    <span class="hljs-built_in">ATRACE_NAME</span>(<span class="hljs-string">"RegisterAndroidNatives"</span>);
    <span class="hljs-comment">// 设置线程创建函数</span>
    <span class="hljs-built_in">androidSetCreateThreadFunc</span>((android_create_thread_fn) javaCreateThreadEtc);

    <span class="hljs-built_in">ALOGV</span>(<span class="hljs-string">"--- registering native functions ---\n"</span>);

    env-&gt;<span class="hljs-built_in">PushLocalFrame</span>(<span class="hljs-number">200</span>);
    <span class="hljs-comment">// 注册jni</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">register_jni_procs</span>(gRegJNI, <span class="hljs-built_in">NELEM</span>(gRegJNI), env) &lt; <span class="hljs-number">0</span>) {
        env-&gt;<span class="hljs-built_in">PopLocalFrame</span>(<span class="hljs-literal">NULL</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
    }
    env-&gt;<span class="hljs-built_in">PopLocalFrame</span>(<span class="hljs-literal">NULL</span>);

    <span class="hljs-comment">//createJavaThread("fubar", quickTest, (void*) "hello");</span>

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>在startReg方法中，调用了androidSetCreateThreadFunc，register_jni_procs。首先看看androidSetCreateThreadFunc方法<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fsystem%2Fcore%2Flibutils%2FThreads.cpp%23280" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/system/core/libutils/Threads.cpp#280" ref="nofollow noopener noreferrer">/system/core/libutils/Threads.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-type">static</span> android_create_thread_fn gCreateThreadFn = androidCreateRawThreadEtc;

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">androidCreateThreadEtc</span><span class="hljs-params">(<span class="hljs-type">android_thread_func_t</span> entryFunction,
                            <span class="hljs-type">void</span> *userData,
                            <span class="hljs-type">const</span> <span class="hljs-type">char</span>* threadName,
                            <span class="hljs-type">int32_t</span> threadPriority,
                            <span class="hljs-type">size_t</span> threadStackSize,
                            <span class="hljs-type">android_thread_id_t</span> *threadId)</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">gCreateThreadFn</span>(entryFunction, userData, threadName,
        threadPriority, threadStackSize, threadId);
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">androidSetCreateThreadFunc</span><span class="hljs-params">(android_create_thread_fn func)</span>
</span>{
    gCreateThreadFn = func;
}
</code></pre>
<p>androidSetCreateThreadFunc方法就是将传入的方法赋值给gCreateThreadFn，后续调用创建线程时，就会使用androidSetCreateThreadFunc方法中的传参。看完了androidSetCreateThreadFunc，再看看register_jni_procs做了什么<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fframeworks%2Fbase%2Fcore%2Fjni%2FAndroidRuntime.cpp%231503" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/frameworks/base/core/jni/AndroidRuntime.cpp#1503" ref="nofollow noopener noreferrer">/frameworks/base/core/jni/AndroidRuntime.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title">register_jni_procs</span><span class="hljs-params">(<span class="hljs-type">const</span> RegJNIRec array[], <span class="hljs-type">size_t</span> count, JNIEnv* env)</span>
</span>{
    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; count; i++) {
        <span class="hljs-keyword">if</span> (array[i].<span class="hljs-built_in">mProc</span>(env) &lt; <span class="hljs-number">0</span>) {
<span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> NDEBUG</span>
            <span class="hljs-built_in">ALOGD</span>(<span class="hljs-string">"----------!!! %s failed to load\n"</span>, array[i].mName);
<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
            <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}

<span class="hljs-type">static</span> <span class="hljs-type">const</span> RegJNIRec gRegJNI[] = {
        <span class="hljs-built_in">REG_JNI</span>(register_com_android_internal_os_RuntimeInit),
        <span class="hljs-built_in">REG_JNI</span>(register_com_android_internal_os_ZygoteInit_nativeZygoteInit),
        <span class="hljs-built_in">REG_JNI</span>(register_android_os_SystemClock),
        <span class="hljs-built_in">REG_JNI</span>(register_android_util_CharsetUtils),
        ...
};
</code></pre>
<p>在register_jni_procs方法中，当array[i].mProc(env) &lt; 0，也就是注册失败了，会返回-1，最后会跑到AndroidRuntime::start中，并return。我们找gRegJNI数组中的第一个元素(register_com_android_internal_os_RuntimeInit)，看看做了什么
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fframeworks%2Fbase%2Fcore%2Fjni%2FAndroidRuntime.cpp%23278" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/frameworks/base/core/jni/AndroidRuntime.cpp#278" ref="nofollow noopener noreferrer">/frameworks/base/core/jni/AndroidRuntime.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">register_com_android_internal_os_RuntimeInit</span><span class="hljs-params">(JNIEnv* env)</span>
</span>{
    <span class="hljs-type">const</span> JNINativeMethod methods[] = {
            {<span class="hljs-string">"nativeFinishInit"</span>, <span class="hljs-string">"()V"</span>,
             (<span class="hljs-type">void</span>*)com_android_internal_os_RuntimeInit_nativeFinishInit},
            {<span class="hljs-string">"nativeSetExitWithoutCleanup"</span>, <span class="hljs-string">"(Z)V"</span>,
             (<span class="hljs-type">void</span>*)com_android_internal_os_RuntimeInit_nativeSetExitWithoutCleanup},
    };
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">jniRegisterNativeMethods</span>(env, <span class="hljs-string">"com/android/internal/os/RuntimeInit"</span>,
        methods, <span class="hljs-built_in">NELEM</span>(methods));
}
</code></pre>
<p>register_com_android_internal_os_RuntimeInit方法中调用了jniRegisterNativeMethods去注册了com_android_internal_os_RuntimeInit_nativeFinishInit、com_android_internal_os_RuntimeInit_nativeSetExitWithoutCleanup这2个方法，后续jniRegisterNativeMethods具体怎么注册的，此处就不再跟进了。</p>
<h4 data-id="heading-8">2.2.4 进入Zygote java</h4>
<p>分析完了上面几个之后，我们最后来看看怎么从AndroidRuntime进入到Zygote java的，代码如下:
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fframeworks%2Fbase%2Fcore%2Fjni%2FAndroidRuntime.cpp%231288" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/frameworks/base/core/jni/AndroidRuntime.cpp#1288" ref="nofollow noopener noreferrer">/frameworks/base/core/jni/AndroidRuntime.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++">    <span class="hljs-type">char</span>* slashClassName = <span class="hljs-built_in">toSlashClassName</span>(className != <span class="hljs-literal">NULL</span> ? className : <span class="hljs-string">""</span>);
    jclass startClass = env-&gt;<span class="hljs-built_in">FindClass</span>(slashClassName);
    <span class="hljs-keyword">if</span> (startClass == <span class="hljs-literal">NULL</span>) {
        <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">"JavaVM unable to locate class '%s'\n"</span>, slashClassName);
        <span class="hljs-comment">/* keep going */</span>
    } <span class="hljs-keyword">else</span> {
        jmethodID startMeth = env-&gt;<span class="hljs-built_in">GetStaticMethodID</span>(startClass, <span class="hljs-string">"main"</span>,
            <span class="hljs-string">"([Ljava/lang/String;)V"</span>);
        <span class="hljs-keyword">if</span> (startMeth == <span class="hljs-literal">NULL</span>) {
            <span class="hljs-built_in">ALOGE</span>(<span class="hljs-string">"JavaVM unable to find main() in '%s'\n"</span>, className);
            <span class="hljs-comment">/* keep going */</span>
        } <span class="hljs-keyword">else</span> {
            env-&gt;<span class="hljs-built_in">CallStaticVoidMethod</span>(startClass, startMeth, strArray);

<span class="hljs-meta">#<span class="hljs-keyword">if</span> 0</span>
    }
</code></pre>
<p>先看看toSlashClassName做了什么<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fframeworks%2Fbase%2Fcore%2Fjni%2FAndroidRuntime.cpp%231158" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/frameworks/base/core/jni/AndroidRuntime.cpp#1158" ref="nofollow noopener noreferrer">/frameworks/base/core/jni/AndroidRuntime.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">char</span>* <span class="hljs-title">AndroidRuntime::toSlashClassName</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* className)</span>
</span>{
    <span class="hljs-type">char</span>* result = <span class="hljs-built_in">strdup</span>(className);
    <span class="hljs-keyword">for</span> (<span class="hljs-type">char</span>* cp = result; *cp != <span class="hljs-string">'\0'</span>; cp++) {
        <span class="hljs-keyword">if</span> (*cp == <span class="hljs-string">'.'</span>) {
            *cp = <span class="hljs-string">'/'</span>;
        }
    }
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p>代码很简单，就是把.换成/, 即com.android.internal.os.ZygoteInit 变成了 com/android/internal/os/ZygoteInit<br/>
之后调用env-&gt;FindClass拿到类名，再通过env-&gt;GetStaticMethodID，找到ZygoteInit的静态main方法，且参数是字符串数组，最后通过env-&gt;CallStaticVoidMethod调用这个方法，也就进入到了Zygote java，即ZygoteInit的main方法。</p>
<h3 data-id="heading-9">2.3 ZygoteInit</h3>
<p>入口函数：<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fframeworks%2Fbase%2Fcore%2Fjava%2Fcom%2Fandroid%2Finternal%2Fos%2FZygoteInit.java%23771" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java#771" ref="nofollow noopener noreferrer">/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</a></p>
<pre><code class="hljs language-Java" lang="Java">    <span class="hljs-meta">@UnsupportedAppUsage</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] argv)</span> {
        ...

        Runnable caller;
        <span class="hljs-keyword">try</span> {
            ...

            <span class="hljs-type">boolean</span> <span class="hljs-variable">startSystemServer</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
            <span class="hljs-type">String</span> <span class="hljs-variable">zygoteSocketName</span> <span class="hljs-operator">=</span> <span class="hljs-string">"zygote"</span>;
            <span class="hljs-type">String</span> <span class="hljs-variable">abiList</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
            <span class="hljs-type">boolean</span> <span class="hljs-variable">enableLazyPreload</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>; i &lt; argv.length; i++) {
                <span class="hljs-comment">// 参数中包含start-system-server，所以startSystemServer为true</span>
                <span class="hljs-keyword">if</span> (<span class="hljs-string">"start-system-server"</span>.equals(argv[i])) {
                    startSystemServer = <span class="hljs-literal">true</span>;
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">"--enable-lazy-preload"</span>.equals(argv[i])) {
                    enableLazyPreload = <span class="hljs-literal">true</span>;
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (argv[i].startsWith(ABI_LIST_ARG)) {
                    abiList = argv[i].substring(ABI_LIST_ARG.length());
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (argv[i].startsWith(SOCKET_NAME_ARG)) {
                    zygoteSocketName = argv[i].substring(SOCKET_NAME_ARG.length());
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"Unknown command line argument: "</span> + argv[i]);
                }
            }

            <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isPrimaryZygote</span> <span class="hljs-operator">=</span> zygoteSocketName.equals(Zygote.PRIMARY_SOCKET_NAME);
            ...
            
            <span class="hljs-comment">// 参数中没有--enable-lazy-preload，enableLazyPreload为false，执行此处代码</span>
            <span class="hljs-keyword">if</span> (!enableLazyPreload) {
                bootTimingsTraceLog.traceBegin(<span class="hljs-string">"ZygotePreload"</span>);
                EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_START,
                        SystemClock.uptimeMillis());
                <span class="hljs-comment">// 预加载资源</span>
                preload(bootTimingsTraceLog);
                EventLog.writeEvent(LOG_BOOT_PROGRESS_PRELOAD_END,
                        SystemClock.uptimeMillis());
                bootTimingsTraceLog.traceEnd(); <span class="hljs-comment">// ZygotePreload</span>
            }

            <span class="hljs-comment">// Do an initial gc to clean up after startup</span>
            bootTimingsTraceLog.traceBegin(<span class="hljs-string">"PostZygoteInitGC"</span>);
            gcAndFinalize();
            bootTimingsTraceLog.traceEnd(); <span class="hljs-comment">// PostZygoteInitGC</span>

            bootTimingsTraceLog.traceEnd(); <span class="hljs-comment">// ZygoteInit</span>

            Zygote.initNativeState(isPrimaryZygote);

            ZygoteHooks.stopZygoteNoThreadCreation();

            zygoteServer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZygoteServer</span>(isPrimaryZygote);

            <span class="hljs-keyword">if</span> (startSystemServer) {
                <span class="hljs-comment">// 此处调用了forkSystemServer</span>
                <span class="hljs-type">Runnable</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> forkSystemServer(abiList, zygoteSocketName, zygoteServer);

                <span class="hljs-comment">// {@code r == null} in the parent (zygote) process, and {@code r != null} in the</span>
                <span class="hljs-comment">// child (system_server) process.</span>
                <span class="hljs-keyword">if</span> (r != <span class="hljs-literal">null</span>) {
                    r.run();
                    <span class="hljs-keyword">return</span>;
                }
            }

            Log.i(TAG, <span class="hljs-string">"Accepting command socket connections"</span>);

            <span class="hljs-comment">// 开启循环，等待客户端的请求</span>
            caller = zygoteServer.runSelectLoop(abiList);
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            Log.e(TAG, <span class="hljs-string">"System zygote died with fatal exception"</span>, ex);
            <span class="hljs-keyword">throw</span> ex;
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">if</span> (zygoteServer != <span class="hljs-literal">null</span>) {
                zygoteServer.closeServerSocket();
            }
        }

        <span class="hljs-comment">// We're in the child process and have exited the select loop. Proceed to execute the</span>
        <span class="hljs-comment">// command.</span>
        <span class="hljs-keyword">if</span> (caller != <span class="hljs-literal">null</span>) {
            caller.run();
        }
    }
</code></pre>
<p>在ZygoteInit的main方法中，做了挺多事的，最重要的3个分别是调用了preload、forkSystemServer、runSelectLoop。下面分别来看看它们都做了什么</p>
<h4 data-id="heading-10">2.3.1 preload</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fframeworks%2Fbase%2Fcore%2Fjava%2Fcom%2Fandroid%2Finternal%2Fos%2FZygoteInit.java%23125" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java#125" ref="nofollow noopener noreferrer">/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</a></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">preload</span><span class="hljs-params">(TimingsTraceLog bootTimingsTraceLog)</span> {
        ...
        preloadClasses();<span class="hljs-comment">// 预加载类，比如android.app.Activity</span>
        ...
        Resources.preloadResources(); <span class="hljs-comment">// 预加载系统资源，比如图片</span>
        ...
        nativePreloadAppProcessHALs(); <span class="hljs-comment">// 硬件抽象层</span>
        ...
        preloadSharedLibraries(); <span class="hljs-comment">// 预加载库</span>
        preloadTextResources(); <span class="hljs-comment">// 预加载字体资源</span>
        ...
    }
</code></pre>
<p>在preLoad方法中，预加载类、系统资源等等，这里就不每个方法都跟进了，看看预加载系统资源preloadResources做了什么<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fframeworks%2Fbase%2Fcore%2Fjava%2Fandroid%2Fcontent%2Fres%2FResources.java%232726" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/frameworks/base/core/java/android/content/res/Resources.java#2726" ref="nofollow noopener noreferrer">/frameworks/base/core/java/android/content/res/Resources.java</a></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@UnsupportedAppUsage</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">preloadResources</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">final</span> <span class="hljs-type">Resources</span> <span class="hljs-variable">sysRes</span> <span class="hljs-operator">=</span> Resources.getSystem();
            sysRes.startPreloading();
            <span class="hljs-keyword">if</span> (PRELOAD_RESOURCES) {
                ...
                <span class="hljs-type">TypedArray</span> <span class="hljs-variable">ar</span> <span class="hljs-operator">=</span> sysRes.obtainTypedArray(
                        com.android.internal.R.array.preloaded_drawables);
                <span class="hljs-comment">// 加载图片</span>
                <span class="hljs-type">int</span> <span class="hljs-variable">numberOfEntries</span> <span class="hljs-operator">=</span> preloadDrawables(sysRes, ar);
                ...
                ar = sysRes.obtainTypedArray(
                        com.android.internal.R.array.preloaded_color_state_lists);
                <span class="hljs-comment">// 加载颜色</span>
                numberOfEntries = preloadColorStateLists(sysRes, ar);
                ...
            }
            sysRes.finishPreloading();
        } <span class="hljs-keyword">catch</span> (RuntimeException e) {
            Log.w(TAG, <span class="hljs-string">"Failure preloading resources"</span>, e);
        }
    }
</code></pre>
<p>在preloadResources方法中，调用了preloadDrawables和preloadColorStateLists，R.array.preloaded_drawables和preloadColorStateLists定义如下：<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fframeworks%2Fbase%2Fcore%2Fres%2Fres%2Fvalues%2Farrays.xml" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/frameworks/base/core/res/res/values/arrays.xml" ref="nofollow noopener noreferrer">/frameworks/base/core/res/res/values/arrays.xml</a></p>
<pre><code class="hljs language-.xml" lang=".xml">    &lt;!-- Do not translate. These are all of the drawable resources that should be preloaded by
         the zygote process before it starts forking application processes. --&gt;
    &lt;array name="preloaded_drawables"&gt;
        &lt;item&gt;@drawable/action_bar_item_background_material&lt;/item&gt;
        &lt;item&gt;@drawable/activated_background_material&lt;/item&gt;
        &lt;item&gt;@drawable/btn_borderless_material&lt;/item&gt;
        &lt;item&gt;@drawable/btn_check_material_anim&lt;/item&gt;
        &lt;item&gt;@drawable/btn_colored_material&lt;/item&gt;
        ...
    &lt;/array&gt;
    &lt;!-- Do not translate. These are all of the color state list resources that should be
         preloaded by the zygote process before it starts forking application processes. --&gt;
    &lt;array name="preloaded_color_state_lists"&gt;
        &lt;item&gt;@color/primary_text_dark&lt;/item&gt;
        &lt;item&gt;@color/primary_text_dark_disable_only&lt;/item&gt;
        &lt;item&gt;@color/primary_text_dark_nodisable&lt;/item&gt;
        &lt;item&gt;@color/primary_text_disable_only_holo_dark&lt;/item&gt;
        &lt;item&gt;@color/primary_text_disable_only_holo_light&lt;/item&gt;
        ...
    &lt;/array&gt;
</code></pre>
<p>R.array.preloaded_drawables就是很多张图片，preloaded_color_state_lists则是很多颜色，具体加载逻辑就不跟了，有兴趣可以自己跟进去看看。<br/>
在执行完 preload 之后，就会调用 forkSystemServer 。<strong>这是 Zygote 一个极其重要的职责：它会 fork 出第一个子进程，也就是 system_server 进程</strong> 。system_server 负责启动和管理所有的系统服务（如 AMS, WMS 等）。这里先简要说明system_server的作用，forkSystemServer 内部详细的调用代码，后续相关文章再深入研究吧。<br/>
Zygote 通过 forkSystemServer 完成了它 "孵化" 核心系统进程的使命，之后它就会进入 runSelectLoop 循环去等待孵化普通的APP进程。</p>
<h4 data-id="heading-11">2.3.2 runSelectLoop</h4>
<p>在执行完preload和forkSystemServer之后，会调用runSelectLoop<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fframeworks%2Fbase%2Fcore%2Fjava%2Fcom%2Fandroid%2Finternal%2Fos%2FZygoteServer.java%23394" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/frameworks/base/core/java/com/android/internal/os/ZygoteServer.java#394" ref="nofollow noopener noreferrer">/frameworks/base/core/java/com/android/internal/os/ZygoteServer.java</a></p>
<pre><code class="hljs language-java" lang="java">Runnable <span class="hljs-title function_">runSelectLoop</span><span class="hljs-params">(String abiList)</span> {
        <span class="hljs-comment">// 初始化：Zygote 的 server socket 和 peers 列表</span>
        ArrayList&lt;FileDescriptor&gt; socketFDs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
        ArrayList&lt;ZygoteConnection&gt; peers = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        socketFDs.add(mZygoteSocket.getFileDescriptor());
        peers.add(<span class="hljs-literal">null</span>);

        mUsapPoolRefillTriggerTimestamp = INVALID_TIMESTAMP;

        <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
            <span class="hljs-comment">// 更新 USAP 池策略</span>
            fetchUsapPoolPolicyPropsWithMinInterval();
            mUsapPoolRefillAction = UsapPoolRefillAction.NONE;

            <span class="hljs-type">int</span>[] usapPipeFDs = <span class="hljs-literal">null</span>;
            StructPollfd[] pollFDs;

            <span class="hljs-comment">// 构造 poll 要监听的 FD 列表</span>
            <span class="hljs-keyword">if</span> (mUsapPoolEnabled) { <span class="hljs-comment">// 1</span>
                usapPipeFDs = Zygote.getUsapPipeFDs();
                pollFDs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StructPollfd</span>[socketFDs.size() + <span class="hljs-number">1</span> + usapPipeFDs.length];
            } <span class="hljs-keyword">else</span> {
                pollFDs = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StructPollfd</span>[socketFDs.size()];
            }

            <span class="hljs-type">int</span> <span class="hljs-variable">pollIndex</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
            <span class="hljs-comment">// 将所有 socket FD 加入 poll 监听</span>
            <span class="hljs-keyword">for</span> (FileDescriptor socketFD : socketFDs) { <span class="hljs-comment">// 2</span>
                pollFDs[pollIndex] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StructPollfd</span>();
                pollFDs[pollIndex].fd = socketFD;
                pollFDs[pollIndex].events = (<span class="hljs-type">short</span>) POLLIN;
                ++pollIndex;
            }

            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">usapPoolEventFDIndex</span> <span class="hljs-operator">=</span> pollIndex;

            <span class="hljs-keyword">if</span> (mUsapPoolEnabled) { <span class="hljs-comment">// 3</span>
                pollFDs[pollIndex] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StructPollfd</span>();
                pollFDs[pollIndex].fd = mUsapPoolEventFD;
                pollFDs[pollIndex].events = (<span class="hljs-type">short</span>) POLLIN;
                ++pollIndex;

                <span class="hljs-comment">// The usapPipeFDs array will always be filled in if the USAP Pool is enabled.</span>
                <span class="hljs-keyword">assert</span> usapPipeFDs != <span class="hljs-literal">null</span>;
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> usapPipeFD : usapPipeFDs) {
                    <span class="hljs-type">FileDescriptor</span> <span class="hljs-variable">managedFd</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileDescriptor</span>();
                    managedFd.setInt$(usapPipeFD);

                    pollFDs[pollIndex] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StructPollfd</span>();
                    pollFDs[pollIndex].fd = managedFd;
                    pollFDs[pollIndex].events = (<span class="hljs-type">short</span>) POLLIN;
                    ++pollIndex;
                }
            }

            <span class="hljs-type">int</span> pollTimeoutMs;

            ...

            <span class="hljs-type">int</span> pollReturnValue;
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 等待事件</span>
                pollReturnValue = Os.poll(pollFDs, pollTimeoutMs);
            } <span class="hljs-keyword">catch</span> (ErrnoException ex) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"poll failed"</span>, ex);
            }

            <span class="hljs-keyword">if</span> (pollReturnValue == <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// 超时，没有 fd 可读</span>
                mUsapPoolRefillTriggerTimestamp = INVALID_TIMESTAMP;
                mUsapPoolRefillAction = UsapPoolRefillAction.DELAYED;
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-type">boolean</span> <span class="hljs-variable">usapPoolFDRead</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
                <span class="hljs-comment">// 倒序处理 fd</span>
                <span class="hljs-keyword">while</span> (--pollIndex &gt;= <span class="hljs-number">0</span>) { <span class="hljs-comment">// 4</span>
                    <span class="hljs-keyword">if</span> ((pollFDs[pollIndex].revents &amp; POLLIN) == <span class="hljs-number">0</span>) {
                        <span class="hljs-keyword">continue</span>;
                    }

                    <span class="hljs-keyword">if</span> (pollIndex == <span class="hljs-number">0</span>) {
                        <span class="hljs-comment">// Zygote server socket</span>
                        <span class="hljs-type">ZygoteConnection</span> <span class="hljs-variable">newPeer</span> <span class="hljs-operator">=</span> acceptCommandPeer(abiList);
                        peers.add(newPeer);
                        socketFDs.add(newPeer.getFileDescriptor());
                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pollIndex &lt; usapPoolEventFDIndex) {
                        <span class="hljs-comment">// Session socket accepted from the Zygote server socket</span>
                        <span class="hljs-keyword">try</span> {
                            <span class="hljs-comment">// 已连接的客户端 socket 发来命令</span>
                            <span class="hljs-type">ZygoteConnection</span> <span class="hljs-variable">connection</span> <span class="hljs-operator">=</span> peers.get(pollIndex);
                            <span class="hljs-type">boolean</span> <span class="hljs-variable">multipleForksOK</span> <span class="hljs-operator">=</span> !isUsapPoolEnabled()
                                    &amp;&amp; ZygoteHooks.isIndefiniteThreadSuspensionSafe();
                            <span class="hljs-keyword">final</span> <span class="hljs-type">Runnable</span> <span class="hljs-variable">command</span> <span class="hljs-operator">=</span>
                                    connection.processCommand(<span class="hljs-built_in">this</span>, multipleForksOK);

                            <span class="hljs-comment">// TODO (chriswailes): Is this extra check necessary?</span>
                            <span class="hljs-keyword">if</span> (mIsForkChild) {
                                <span class="hljs-keyword">if</span> (command == <span class="hljs-literal">null</span>) {
                                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"command == null"</span>);
                                }
                                <span class="hljs-comment">// 子进程：返回命令，跳出当前循环</span>
                                <span class="hljs-keyword">return</span> command;
                            } <span class="hljs-keyword">else</span> {
                                <span class="hljs-comment">// We're in the server - we should never have any commands to run.</span>
                                <span class="hljs-keyword">if</span> (command != <span class="hljs-literal">null</span>) {
                                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"command != null"</span>);
                                }
                                <span class="hljs-comment">// 父进程：清理连接并关闭 socket</span>
                                <span class="hljs-keyword">if</span> (connection.isClosedByPeer()) {
                                    connection.closeSocket();
                                    peers.remove(pollIndex);
                                    socketFDs.remove(pollIndex);
                                }
                            }
                        } <span class="hljs-keyword">catch</span> (Exception e) {
                            ...
                        } <span class="hljs-keyword">finally</span> {
                            mIsForkChild = <span class="hljs-literal">false</span>;
                        }

                    } <span class="hljs-keyword">else</span> {
                       ...
                }

                ...
            }
            ...
        }
    }
</code></pre>
<p>runSelectLoop方法代码较长，我们只关注比较重要的几件事。<br/>
我们知道，当启动app时，Zygote会fork一个进程，并在这个进程中执行app代码。为了加快app启动速度，可以预先fork一些进程，当启动app的请求来的时候，直接使用预先fork的进程，而这就是USAP。<br/>
也就是Zygote会先fork一些进程放在<strong>USAP进程池</strong>，要启动app的时候，就从这个池子里拿一个使用。这就是代码1和代码3的作用。代码2处<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fframeworks%2Fbase%2Fcore%2Fjava%2Fcom%2Fandroid%2Finternal%2Fos%2FZygoteServer.java%23429" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/frameworks/base/core/java/com/android/internal/os/ZygoteServer.java#429" ref="nofollow noopener noreferrer">/frameworks/base/core/java/com/android/internal/os/ZygoteServer.java</a></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-type">int</span> <span class="hljs-variable">pollIndex</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
    <span class="hljs-comment">// 将所有 socket FD 加入 poll 监听</span>
    <span class="hljs-keyword">for</span> (FileDescriptor socketFD : socketFDs) { <span class="hljs-comment">// 2</span>
        pollFDs[pollIndex] = <span class="hljs-keyword">new</span> <span class="hljs-title class_">StructPollfd</span>();
        pollFDs[pollIndex].fd = socketFD;
        pollFDs[pollIndex].events = (<span class="hljs-type">short</span>) POLLIN;
        ++pollIndex;
    }
</code></pre>
<p>这里就是构造要监听的 FD 列表，并且马上在后续代码中，调用Os.poll，<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fframeworks%2Fbase%2Fcore%2Fjava%2Fcom%2Fandroid%2Finternal%2Fos%2FZygoteServer.java%23486" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/frameworks/base/core/java/com/android/internal/os/ZygoteServer.java#486" ref="nofollow noopener noreferrer">/frameworks/base/core/java/com/android/internal/os/ZygoteServer.java</a></p>
<pre><code class="hljs language-C++" lang="C++">pollReturnValue = Os.<span class="hljs-built_in">poll</span>(pollFDs, pollTimeoutMs);
</code></pre>
<p>这里实际是调用了poll来等待事件。之后如果没有超时，会进入是代码4里进行倒序处理 fd<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fframeworks%2Fbase%2Fcore%2Fjava%2Fcom%2Fandroid%2Finternal%2Fos%2FZygoteServer.java%23501" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/frameworks/base/core/java/com/android/internal/os/ZygoteServer.java#501" ref="nofollow noopener noreferrer">/frameworks/base/core/java/com/android/internal/os/ZygoteServer.java</a></p>
<pre><code class="hljs language-C++" lang="C++">                boolean usapPoolFDRead = <span class="hljs-literal">false</span>;
                <span class="hljs-comment">// 倒序处理 fd</span>
                <span class="hljs-keyword">while</span> (--pollIndex &gt;= <span class="hljs-number">0</span>) { <span class="hljs-comment">// 4</span>
                    <span class="hljs-keyword">if</span> ((pollFDs[pollIndex].revents &amp; POLLIN) == <span class="hljs-number">0</span>) {
                        <span class="hljs-keyword">continue</span>;
                    }

                    <span class="hljs-keyword">if</span> (pollIndex == <span class="hljs-number">0</span>) {
                        <span class="hljs-comment">// Zygote server socket</span>
                        ZygoteConnection newPeer = <span class="hljs-built_in">acceptCommandPeer</span>(abiList);
                        peers.<span class="hljs-built_in">add</span>(newPeer);
                        socketFDs.<span class="hljs-built_in">add</span>(newPeer.<span class="hljs-built_in">getFileDescriptor</span>());
                    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (pollIndex &lt; usapPoolEventFDIndex) {
                        <span class="hljs-comment">// Session socket accepted from the Zygote server socket</span>
                        <span class="hljs-keyword">try</span> {
                            <span class="hljs-comment">// 已连接的客户端 socket 发来命令</span>
                            ZygoteConnection connection = peers.<span class="hljs-built_in">get</span>(pollIndex);
                            boolean multipleForksOK = !<span class="hljs-built_in">isUsapPoolEnabled</span>()
                                    &amp;&amp; ZygoteHooks.<span class="hljs-built_in">isIndefiniteThreadSuspensionSafe</span>();
                            <span class="hljs-keyword">final</span> Runnable command =
                                    connection.<span class="hljs-built_in">processCommand</span>(<span class="hljs-keyword">this</span>, multipleForksOK);

                            <span class="hljs-comment">// TODO (chriswailes): Is this extra check necessary?</span>
                            <span class="hljs-keyword">if</span> (mIsForkChild) {
                                <span class="hljs-keyword">if</span> (command == null) {
                                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">IllegalStateException</span>(<span class="hljs-string">"command == null"</span>);
                                }
                                <span class="hljs-comment">// 子进程：返回命令，跳出当前循环</span>
                                <span class="hljs-keyword">return</span> command;
                            } <span class="hljs-keyword">else</span> {
                                <span class="hljs-comment">// We're in the server - we should never have any commands to run.</span>
                                <span class="hljs-keyword">if</span> (command != null) {
                                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">IllegalStateException</span>(<span class="hljs-string">"command != null"</span>);
                                }
                                <span class="hljs-comment">// 父进程：清理连接并关闭 socket</span>
                                <span class="hljs-keyword">if</span> (connection.<span class="hljs-built_in">isClosedByPeer</span>()) {
                                    connection.<span class="hljs-built_in">closeSocket</span>();
                                    peers.<span class="hljs-built_in">remove</span>(pollIndex);
                                    socketFDs.<span class="hljs-built_in">remove</span>(pollIndex);
                                }
                            }
                        } <span class="hljs-built_in">catch</span> (Exception e) {
                           ...
                    } <span class="hljs-keyword">else</span> {
                       ...
                }
</code></pre>
<p>在这里的循环中，首先判断(pollFDs[pollIndex].revents &amp; POLLIN) == 0，如果为0，说明没有如果 可读事件发生，就跳过当前 FD，不处理它。<br/>
后续则判断pollIndex == 0, 这是代表
这里的usapPoolEventFDIndex，是代码2处将所有 socket FD 加入 poll 监听后，将pollIndex 给它。如果pollIndex &lt; usapPoolEventFDIndex，这说明新的客户端通过 Zygote 的监听 socket 发起连接<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fframeworks%2Fbase%2Fcore%2Fjava%2Fcom%2Fandroid%2Finternal%2Fos%2FZygoteServer.java%23510" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/frameworks/base/core/java/com/android/internal/os/ZygoteServer.java#510" ref="nofollow noopener noreferrer">/frameworks/base/core/java/com/android/internal/os/ZygoteServer.java</a></p>
<pre><code class="hljs language-C++" lang="C++">        ZygoteConnection newPeer = <span class="hljs-built_in">acceptCommandPeer</span>(abiList);
                        peers.<span class="hljs-built_in">add</span>(newPeer);
                        socketFDs.<span class="hljs-built_in">add</span>(newPeer.<span class="hljs-built_in">getFileDescriptor</span>());
</code></pre>
<p>Zygote会调用acceptCommandPeer(...)创建一个ZygoteConnection来处理该连接，并且将它添加到peers，fd添加到socketFDs中。之后就到重头戏了<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fframeworks%2Fbase%2Fcore%2Fjava%2Fcom%2Fandroid%2Finternal%2Fos%2FZygoteServer.java%23517" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/frameworks/base/core/java/com/android/internal/os/ZygoteServer.java#517" ref="nofollow noopener noreferrer">/frameworks/base/core/java/com/android/internal/os/ZygoteServer.java</a></p>
<pre><code class="hljs language-C++" lang="C++">                         <span class="hljs-keyword">try</span> {
                            <span class="hljs-comment">// 已连接的客户端 socket 发来命令</span>
                            ZygoteConnection connection = peers.<span class="hljs-built_in">get</span>(pollIndex);
                            boolean multipleForksOK = !<span class="hljs-built_in">isUsapPoolEnabled</span>()
                                    &amp;&amp; ZygoteHooks.<span class="hljs-built_in">isIndefiniteThreadSuspensionSafe</span>();
                            <span class="hljs-keyword">final</span> Runnable command =
                                    connection.<span class="hljs-built_in">processCommand</span>(<span class="hljs-keyword">this</span>, multipleForksOK);

                            <span class="hljs-comment">// TODO (chriswailes): Is this extra check necessary?</span>
                            <span class="hljs-keyword">if</span> (mIsForkChild) {
                                <span class="hljs-keyword">if</span> (command == null) {
                                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">IllegalStateException</span>(<span class="hljs-string">"command == null"</span>);
                                }
                                <span class="hljs-comment">// 子进程：返回命令，跳出当前循环</span>
                                <span class="hljs-keyword">return</span> command;
                            } <span class="hljs-keyword">else</span> {
                                <span class="hljs-comment">// We're in the server - we should never have any commands to run.</span>
                                <span class="hljs-keyword">if</span> (command != null) {
                                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">IllegalStateException</span>(<span class="hljs-string">"command != null"</span>);
                                }
                                <span class="hljs-comment">// 父进程：清理连接并关闭 socket</span>
                                <span class="hljs-keyword">if</span> (connection.<span class="hljs-built_in">isClosedByPeer</span>()) {
                                    connection.<span class="hljs-built_in">closeSocket</span>();
                                    peers.<span class="hljs-built_in">remove</span>(pollIndex);
                                    socketFDs.<span class="hljs-built_in">remove</span>(pollIndex);
                                }
                            }
                        } <span class="hljs-built_in">catch</span> (Exception e) {
                           ...
                    }
</code></pre>
<p>首先pollIndex &lt; usapPoolEventFDIndex，这表示客户端发来了命令，调用processCommand来处理这个命令。如果processCommand(...)是在子进程里 (fork 出来) 会返回一个 Runnable，并且这个Runnable会在子进程中被执行 (通常是启动 app 进程的入口逻辑，比如 ActivityThread.main(...))；而如果是父进程则清理连接并关闭 socket，继续这个循环。<br/>
我们详细看看processCommand的代码
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fframeworks%2Fbase%2Fcore%2Fjava%2Fcom%2Fandroid%2Finternal%2Fos%2FZygoteConnection.java%23120" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java#120" ref="nofollow noopener noreferrer">frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java</a></p>
<pre><code class="hljs language-java" lang="java">    Runnable <span class="hljs-title function_">processCommand</span><span class="hljs-params">(ZygoteServer zygoteServer, <span class="hljs-type">boolean</span> multipleOK)</span> {
        ZygoteArguments parsedArgs;

        <span class="hljs-keyword">try</span> (<span class="hljs-type">ZygoteCommandBuffer</span> <span class="hljs-variable">argBuffer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ZygoteCommandBuffer</span>(mSocket)) {
            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {
                ...

                <span class="hljs-keyword">if</span> (parsedArgs.mInvokeWith != <span class="hljs-literal">null</span> || parsedArgs.<span class="hljs-type">mStartChildZygote</span>
                    <span class="hljs-variable">pid</span> <span class="hljs-operator">=</span> Zygote.forkAndSpecialize(parsedArgs.mUid, parsedArgs.mGid,
                            parsedArgs.mGids, parsedArgs.mRuntimeFlags, rlimits,
                            parsedArgs.mMountExternal, parsedArgs.mSeInfo, parsedArgs.mNiceName,
                            fdsToClose, fdsToIgnore, parsedArgs.mStartChildZygote,
                            parsedArgs.mInstructionSet, parsedArgs.mAppDataDir,
                            parsedArgs.mIsTopApp, parsedArgs.mPkgDataInfoList,
                            parsedArgs.mAllowlistedDataInfoList, parsedArgs.mBindMountAppDataDirs,
                            parsedArgs.mBindMountAppStorageDirs,
                            parsedArgs.mBindMountSyspropOverrides);

                    <span class="hljs-keyword">try</span> {
                        <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) {
                            <span class="hljs-comment">// in child</span>
                            zygoteServer.setForkChild();

                            zygoteServer.closeServerSocket();
                            IoUtils.closeQuietly(serverPipeFd);
                            serverPipeFd = <span class="hljs-literal">null</span>;

                            <span class="hljs-keyword">return</span> handleChildProc(parsedArgs, childPipeFd,
                                    parsedArgs.mStartChildZygote);
                        } <span class="hljs-keyword">else</span> {
                            <span class="hljs-comment">// In the parent. A pid &lt; 0 indicates a failure and will be handled in</span>
                            <span class="hljs-comment">// handleParentProc.</span>
                            IoUtils.closeQuietly(childPipeFd);
                            childPipeFd = <span class="hljs-literal">null</span>;
                            handleParentProc(pid, serverPipeFd);
                            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
                        }
                    } <span class="hljs-keyword">finally</span> {
                        IoUtils.closeQuietly(childPipeFd);
                        IoUtils.closeQuietly(serverPipeFd);
                    }
                } <span class="hljs-keyword">else</span> {
                    ...
                }
            }
        }
        ...
    }
</code></pre>
<p>在processCommand方法里面，先调用了forkAndSpecialize，然后再调用zygoteServer.closeServerSocket()去关闭ServerSocket，最后调用handleChildProc<br/>
我们先来看先调用了forkAndSpecialize代码
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fframeworks%2Fbase%2Fcore%2Fjava%2Fcom%2Fandroid%2Finternal%2Fos%2FZygote.java%23365" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/frameworks/base/core/java/com/android/internal/os/Zygote.java#365" ref="nofollow noopener noreferrer">frameworks/base/core/java/com/android/internal/os/Zygote.java</a></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">forkAndSpecialize</span><span class="hljs-params">(<span class="hljs-type">int</span> uid, <span class="hljs-type">int</span> gid, <span class="hljs-type">int</span>[] gids, <span class="hljs-type">int</span> runtimeFlags,
        ...

        <span class="hljs-type">int</span> pid = nativeForkAndSpecialize(
                uid, gid, gids, runtimeFlags, rlimits, mountExternal, seInfo, niceName, fdsToClose,
                fdsToIgnore, startChildZygote, instructionSet, appDataDir, isTopApp,
                pkgDataInfoList, allowlistedDataInfoList, bindMountAppDataDirs,
                bindMountAppStorageDirs, bindMountSyspropOverrides)</span>;
        ...
        <span class="hljs-keyword">return</span> pid;
    }
</code></pre>
<p>在forkAndSpecialize中调用了nativeForkAndSpecialize，它是一个native方法<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fframeworks%2Fbase%2Fcore%2Fjni%2Fcom_android_internal_os_Zygote.cpp%232521" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/frameworks/base/core/jni/com_android_internal_os_Zygote.cpp#2521" ref="nofollow noopener noreferrer">/frameworks/base/core/jni/com_android_internal_os_Zygote.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">static</span> jint <span class="hljs-title">com_android_internal_os_Zygote_nativeForkAndSpecialize</span><span class="hljs-params">(
        JNIEnv* env, jclass, jint uid, jint gid, jintArray gids, jint runtime_flags,
        jobjectArray rlimits, jint mount_external, jstring se_info, jstring nice_name,
        jintArray managed_fds_to_close, jintArray managed_fds_to_ignore, jboolean is_child_zygote,
        jstring instruction_set, jstring app_data_dir, jboolean is_top_app,
        jobjectArray pkg_data_info_list, jobjectArray allowlisted_data_info_list,
        jboolean mount_data_dirs, jboolean mount_storage_dirs, jboolean mount_sysprop_overrides)</span> </span>{
    ...

    <span class="hljs-type">pid_t</span> pid = zygote::<span class="hljs-built_in">ForkCommon</span>(env, <span class="hljs-comment">/* is_system_server= */</span> <span class="hljs-literal">false</span>, fds_to_close, fds_to_ignore,
                                   <span class="hljs-literal">true</span>);

    <span class="hljs-keyword">if</span> (pid == <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">SpecializeCommon</span>(env, uid, gid, gids, runtime_flags, rlimits, capabilities, capabilities,
                         bounding_capabilities, mount_external, se_info, nice_name, <span class="hljs-literal">false</span>,
                         is_child_zygote == JNI_TRUE, instruction_set, app_data_dir,
                         is_top_app == JNI_TRUE, pkg_data_info_list, allowlisted_data_info_list,
                         mount_data_dirs == JNI_TRUE, mount_storage_dirs == JNI_TRUE,
                         mount_sysprop_overrides == JNI_TRUE);
    }
    <span class="hljs-keyword">return</span> pid;
}
</code></pre>
<p>com_android_internal_os_Zygote_nativeForkAndSpecialize方法中就是调用了zygote::ForkCommon，继续跟<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fframeworks%2Fbase%2Fcore%2Fjni%2Fcom_android_internal_os_Zygote.cpp%232414" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/frameworks/base/core/jni/com_android_internal_os_Zygote.cpp#2414" ref="nofollow noopener noreferrer">/frameworks/base/core/jni/com_android_internal_os_Zygote.cpp</a></p>
<pre><code class="hljs language-C++" lang="C++"><span class="hljs-function"><span class="hljs-type">pid_t</span> <span class="hljs-title">zygote::ForkCommon</span><span class="hljs-params">(JNIEnv* env, <span class="hljs-type">bool</span> is_system_server,
                         <span class="hljs-type">const</span> std::vector&lt;<span class="hljs-type">int</span>&gt;&amp; fds_to_close,
                         <span class="hljs-type">const</span> std::vector&lt;<span class="hljs-type">int</span>&gt;&amp; fds_to_ignore,
                         <span class="hljs-type">bool</span> is_priority_fork,
                         <span class="hljs-type">bool</span> purge)</span> </span>{
  ...

  <span class="hljs-comment">// fork客户端请求的进程。</span>
  <span class="hljs-type">pid_t</span> pid = fork();

  ...
  <span class="hljs-keyword">return</span> pid;
}
</code></pre>
<p>在ForkCommon的实现中，就是调用了fork。<br/>
因此可以得出processCommand调用forkAndSpecialize，其实就是调用了fork函数。而后面在子进程中，调用了zygoteServer.closeServerSocket()去关闭ServerSocket, 因为是fork的Zygote进程，需要关闭socket。而后在handleChildProc处理子进程相关，那么就继续跟进代码
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fframeworks%2Fbase%2Fcore%2Fjava%2Fcom%2Fandroid%2Finternal%2Fos%2FZygoteConnection.java%23517" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java#517" ref="nofollow noopener noreferrer">/frameworks/base/core/java/com/android/internal/os/ZygoteConnection.java</a></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">private</span> Runnable <span class="hljs-title function_">handleChildProc</span><span class="hljs-params">(ZygoteArguments parsedArgs,
            FileDescriptor pipeFd, <span class="hljs-type">boolean</span> isZygote)</span> {
        closeSocket();

        Zygote.setAppProcessName(parsedArgs, TAG);

        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);
        <span class="hljs-keyword">if</span> (parsedArgs.mInvokeWith != <span class="hljs-literal">null</span>) {
            WrapperInit.execApplication(parsedArgs.mInvokeWith,
                    parsedArgs.mNiceName, parsedArgs.mTargetSdkVersion,
                    VMRuntime.getCurrentInstructionSet(),
                    pipeFd, parsedArgs.mRemainingArgs);

            <span class="hljs-comment">// Should not get here.</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">"WrapperInit.execApplication unexpectedly returned"</span>);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (!isZygote) {
                <span class="hljs-keyword">return</span> ZygoteInit.zygoteInit(parsedArgs.mTargetSdkVersion,
                        parsedArgs.mDisabledCompatChanges,
                        parsedArgs.mRemainingArgs, <span class="hljs-literal">null</span> <span class="hljs-comment">/* classLoader */</span>);
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> ZygoteInit.childZygoteInit(
                        parsedArgs.mRemainingArgs  <span class="hljs-comment">/* classLoader */</span>);
            }
        }
    }
</code></pre>
<p>在handleChildProc中，先判断parsedArgs.mInvokeWith是否为空，不为空则执行WrapperInit.execApplication。而正常通过 AMS (ActivityManagerService) 启动应用进程时，一般不会使用 --invoke-with 参数。因此这里继续跟else分支，在else分支中，isZygote为false，执行ZygoteInit.zygoteInit,否则，则执行ZygoteInit.childZygoteInit。
继续跟ZygoteInit.zygoteInit<br/>
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fframeworks%2Fbase%2Fcore%2Fjava%2Fcom%2Fandroid%2Finternal%2Fos%2FZygoteInit.java%23930" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java#930" ref="nofollow noopener noreferrer">/frameworks/base/core/java/com/android/internal/os/ZygoteInit.java</a></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Runnable <span class="hljs-title function_">zygoteInit</span><span class="hljs-params">(<span class="hljs-type">int</span> targetSdkVersion, <span class="hljs-type">long</span>[] disabledCompatChanges,
            String[] argv, ClassLoader classLoader)</span> {
        <span class="hljs-keyword">if</span> (RuntimeInit.DEBUG) {
            Slog.d(RuntimeInit.TAG, <span class="hljs-string">"RuntimeInit: Starting application from zygote"</span>);
        }

        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, <span class="hljs-string">"ZygoteInit"</span>);
        RuntimeInit.redirectLogStreams();

        RuntimeInit.commonInit();
        ZygoteInit.nativeZygoteInit();
        <span class="hljs-keyword">return</span> RuntimeInit.applicationInit(targetSdkVersion, disabledCompatChanges, argv,
                classLoader);
    }
</code></pre>
<p>zygoteInit里面调用了RuntimeInit.applicationInit方法，继续跟
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fframeworks%2Fbase%2Fcore%2Fjava%2Fcom%2Fandroid%2Finternal%2Fos%2FRuntimeInit.java%23374" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/frameworks/base/core/java/com/android/internal/os/RuntimeInit.java#374" ref="nofollow noopener noreferrer">/frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</a></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> Runnable <span class="hljs-title function_">applicationInit</span><span class="hljs-params">(<span class="hljs-type">int</span> targetSdkVersion, <span class="hljs-type">long</span>[] disabledCompatChanges,
            String[] argv, ClassLoader classLoader)</span> {
        <span class="hljs-comment">// If the application calls System.exit(), terminate the process</span>
        <span class="hljs-comment">// immediately without running any shutdown hooks.  It is not possible to</span>
        <span class="hljs-comment">// shutdown an Android application gracefully.  Among other things, the</span>
        <span class="hljs-comment">// Android runtime shutdown hooks close the Binder driver, which can cause</span>
        <span class="hljs-comment">// leftover running threads to crash before the process actually exits.</span>
        nativeSetExitWithoutCleanup(<span class="hljs-literal">true</span>);

        VMRuntime.getRuntime().setTargetSdkVersion(targetSdkVersion);
        VMRuntime.getRuntime().setDisabledCompatChanges(disabledCompatChanges);

        <span class="hljs-keyword">final</span> <span class="hljs-type">Arguments</span> <span class="hljs-variable">args</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Arguments</span>(argv);

        <span class="hljs-comment">// The end of of the RuntimeInit event (see #zygoteInit).</span>
        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);

        <span class="hljs-comment">// 根据客户端的参数，找到对应的类，并调用main函数</span>
        <span class="hljs-keyword">return</span> findStaticMain(args.startClass, args.startArgs, classLoader);
    }

    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">static</span> Runnable <span class="hljs-title function_">findStaticMain</span><span class="hljs-params">(String className, String[] argv,
            ClassLoader classLoader)</span> {
        Class&lt;?&gt; cl;

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 根据给定的类名返回一个Class对象</span>
            cl = Class.forName(className, <span class="hljs-literal">true</span>, classLoader);
        } <span class="hljs-keyword">catch</span> (ClassNotFoundException ex) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(
                    <span class="hljs-string">"Missing class when invoking static main "</span> + className,
                    ex);
        }

        Method m;
        <span class="hljs-keyword">try</span> {
           <span class="hljs-comment">// 查找该类里的Main方法</span>
            m = cl.getMethod(<span class="hljs-string">"main"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[] { String[].class });
        } <span class="hljs-keyword">catch</span> (NoSuchMethodException ex) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(
                    <span class="hljs-string">"Missing static main on "</span> + className, ex);
        } <span class="hljs-keyword">catch</span> (SecurityException ex) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(
                    <span class="hljs-string">"Problem getting static main on "</span> + className, ex);
        }

        <span class="hljs-type">int</span> <span class="hljs-variable">modifiers</span> <span class="hljs-operator">=</span> m.getModifiers();
        <span class="hljs-keyword">if</span> (! (Modifier.isStatic(modifiers) &amp;&amp; Modifier.isPublic(modifiers))) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(
                    <span class="hljs-string">"Main method is not public and static on "</span> + className);
        }

        <span class="hljs-comment">/*
         * This throw gets caught in ZygoteInit.main(), which responds
         * by invoking the exception's run() method. This arrangement
         * clears up all the stack frames that were required in setting
         * up the process.
         */</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MethodAndArgsCaller</span>(m, argv);
    }
</code></pre>
<p>在applicationInit通过调用findStaticMain，找到对应类的Main方法。而在findStaticMain先调用Class.forName，根据给定的类名返回一个Class对象，然后再调用cl.getMethod，查找该类里的Main方法，最后返回了MethodAndArgsCaller对象
<a href="https://link.juejin.cn?target=https%3A%2F%2Fxrefandroid.com%2Fandroid-15.0.0_r1%2Fxref%2Fframeworks%2Fbase%2Fcore%2Fjava%2Fcom%2Fandroid%2Finternal%2Fos%2FRuntimeInit.java%23566" target="_blank" title="https://xrefandroid.com/android-15.0.0_r1/xref/frameworks/base/core/java/com/android/internal/os/RuntimeInit.java#566" ref="nofollow noopener noreferrer">/frameworks/base/core/java/com/android/internal/os/RuntimeInit.java</a></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MethodAndArgsCaller</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> {
        <span class="hljs-comment">/** method to call */</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Method mMethod;

        <span class="hljs-comment">/** argument array */</span>
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String[] mArgs;

        <span class="hljs-keyword">public</span> <span class="hljs-title function_">MethodAndArgsCaller</span><span class="hljs-params">(Method method, String[] args)</span> {
            mMethod = method;
            mArgs = args;
        }

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 调用对应类的Main方法</span>
                mMethod.invoke(<span class="hljs-literal">null</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[] { mArgs });
            } <span class="hljs-keyword">catch</span> (IllegalAccessException ex) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(ex);
            } <span class="hljs-keyword">catch</span> (InvocationTargetException ex) {
                <span class="hljs-type">Throwable</span> <span class="hljs-variable">cause</span> <span class="hljs-operator">=</span> ex.getCause();
                <span class="hljs-keyword">if</span> (cause <span class="hljs-keyword">instanceof</span> RuntimeException) {
                    <span class="hljs-keyword">throw</span> (RuntimeException) cause;
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (cause <span class="hljs-keyword">instanceof</span> Error) {
                    <span class="hljs-keyword">throw</span> (Error) cause;
                }
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(ex);
            }
        }
    }
</code></pre>
<p>在MethodAndArgsCaller类中，会执行run方法，调用了mMethod.invoke，也就调用了客户端请求的class类的Main方法。</p>
<h3 data-id="heading-12">2.4 Zygote为何选择Socket而非Binder？</h3>
<p>在上一小节中，文我们看到Zygote通过Socket监听请求，那么为什么不使用Binder呢?</p>
<p>一方面是Zygote进程使用binder会造成死锁： Binder通信机制本质上是为多线程环境设计的。当进程作为Binder服务端时，会自动创建Binder线程池来处理并发请求。这就意味着使用Binder的Zygote进程必然会成为一个多线程进程。<br/>
而Linux的fork()系统调用在复制多线程进程时存在风险：它只会复制调用线程，其他线程持有的锁状态会被子进程继承，但持有锁的线程本身却不存在于子进程中。这会导致子进程中的锁永远无法被释放，从而引发死锁或异常。
因此，选择单线程的Socket通信成为Zygote更好的选择。</p>
<p>另一方面是时序问题，Init进程是先创建ServiceManager，后创建Zygote进程的。但不能保证Zygote进程去注册binder的时候，ServiceManager已经初始化好了。</p>
<blockquote>
<p>注：Binder是一个复杂的机制，后续会专门写Binder相关文章。</p>
</blockquote>
<h2 data-id="heading-13">三、总结</h2>
<p>至此就分析完了Zygote进程，Zygote在系统初始化阶段，执行初始化虚拟机（startVm），预加载公共类、资源和库（preload()），后续Zygote利用 fork 机制复制自身状态来创建新的应用进程，避免了重复初始化虚拟机、加载系统资源的开销，极大加速了应用启动速度。</p>
<p>感谢阅读，希望本文对你有所帮助，<strong>如有任何不对的地方，欢迎大家指出</strong>。</p>
<h2 data-id="heading-14">四、参考资料</h2>
<p>《Android进阶解密》</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《Flutter全栈开发实战指南：从零到高级》- 19 -手势识别]]></title>    <link>https://juejin.cn/post/7576605171771441202</link>    <guid>https://juejin.cn/post/7576605171771441202</guid>    <pubDate>2025-11-26T03:40:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576605171771441202" data-draft-id="7576569518261469184" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《Flutter全栈开发实战指南：从零到高级》- 19 -手势识别"/> <meta itemprop="keywords" content="Flutter,iOS,前端框架"/> <meta itemprop="datePublished" content="2025-11-26T03:40:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="QuantumLeap丶"/> <meta itemprop="url" content="https://juejin.cn/user/1767603104125197"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《Flutter全栈开发实战指南：从零到高级》- 19 -手势识别
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1767603104125197/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    QuantumLeap丶
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T03:40:47.000Z" title="Wed Nov 26 2025 03:40:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<blockquote>
<p>在移动应用开发中，流畅自然的手势交互是提升用户体验的关键。今天我们来深入探讨Flutter中的手势识别，带你从0-1掌握这个强大的交互工具。</p>
</blockquote>
<h3 data-id="heading-1">1. GestureDetector</h3>
<h4 data-id="heading-2">1.1 GestureDetector原理</h4>
<p>下面我们先通过一个架构图来加深理解GestureDetector的工作原理：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[触摸屏幕] --&gt; B[RawPointerEvent事件产生]
    B --&gt; C[GestureDetector接收事件]
    C --&gt; D[手势识别器分析]
    D --&gt; E{匹配手势类型}
    E --&gt;|匹配成功| F[触发对应回调]
    E --&gt;|匹配失败| G[事件传递给其他组件]
    F --&gt; H[更新UI状态]
    G --&gt; I[父组件处理]
</code></pre>
<p><strong>核心原理解析：</strong></p>
<ol>
<li>
<p><strong>事件传递机制</strong></p>
<ul>
<li>Flutter使用<strong>冒泡机制</strong>传递触摸事件</li>
<li>从最内层组件开始，向外层组件传递</li>
<li>每个GestureDetector都可以拦截和处理事件</li>
</ul>
</li>
<li>
<p><strong>多手势竞争</strong></p>
<ul>
<li>多个手势识别器竞争处理同一组触摸事件</li>
<li>通过规则决定哪个识别器获胜</li>
<li>获胜者将处理后续的所有相关事件</li>
</ul>
</li>
<li>
<p><strong>命中测试</strong></p>
<ul>
<li>确定触摸事件发生在哪个组件上</li>
<li>通过<code>HitTestBehavior</code>控制测试行为</li>
</ul>
</li>
</ol>
<h4 data-id="heading-3">1.2 基础手势识别</h4>
<p>下面演示一个基础手势识别案例：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BasicGestureExample</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _BasicGestureExampleState createState() =&gt; _BasicGestureExampleState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_BasicGestureExampleState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">BasicGestureExample</span>&gt; </span>{
  <span class="hljs-built_in">String</span> _gestureStatus = <span class="hljs-string">'等待手势...'</span>;
  Color _boxColor = Colors.blue;

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(title: Text(<span class="hljs-string">'基础手势识别'</span>)),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            <span class="hljs-comment">// 手势检测区域</span>
            GestureDetector(
              onTap: () {
                setState(() {
                  _gestureStatus = <span class="hljs-string">'单击 detected'</span>;
                  _boxColor = Colors.green;
                });
              },
              onDoubleTap: () {
                setState(() {
                  _gestureStatus = <span class="hljs-string">'双击 detected'</span>;
                  _boxColor = Colors.orange;
                });
              },
              onLongPress: () {
                setState(() {
                  _gestureStatus = <span class="hljs-string">'长按 detected'</span>;
                  _boxColor = Colors.red;
                });
              },
              onPanUpdate: (details) {
                setState(() {
                  _gestureStatus = <span class="hljs-string">'拖拽中: <span class="hljs-subst">${details.delta}</span>'</span>;
                  _boxColor = Colors.purple;
                });
              },
              onScaleUpdate: (details) {
                setState(() {
                  _gestureStatus = <span class="hljs-string">'缩放: <span class="hljs-subst">${details.scale.toStringAsFixed(<span class="hljs-number">2</span>)}</span>'</span>;
                  _boxColor = Colors.teal;
                });
              },
              child: Container(
                width: <span class="hljs-number">200</span>,
                height: <span class="hljs-number">200</span>,
                decoration: BoxDecoration(
                  color: _boxColor,
                  borderRadius: BorderRadius.circular(<span class="hljs-number">16</span>),
                  boxShadow: [
                    BoxShadow(
                      color: Colors.black26,
                      blurRadius: <span class="hljs-number">10</span>,
                      offset: Offset(<span class="hljs-number">0</span>, <span class="hljs-number">4</span>),
                    )
                  ],
                ),
                child: Icon(
                  Icons.touch_app,
                  color: Colors.white,
                  size: <span class="hljs-number">50</span>,
                ),
              ),
            ),
            SizedBox(height: <span class="hljs-number">30</span>),
            <span class="hljs-comment">// 状态显示</span>
            Container(
              padding: EdgeInsets.all(<span class="hljs-number">16</span>),
              decoration: BoxDecoration(
                color: Colors.grey[<span class="hljs-number">100</span>],
                borderRadius: BorderRadius.circular(<span class="hljs-number">8</span>),
              ),
              child: Text(
                _gestureStatus,
                style: TextStyle(fontSize: <span class="hljs-number">18</span>, fontWeight: FontWeight.bold),
              ),
            ),
            SizedBox(height: <span class="hljs-number">20</span>),
            <span class="hljs-comment">// 手势说明</span>
            _buildGestureInstructions(),
          ],
        ),
      ),
    );
  }

  Widget _buildGestureInstructions() {
    <span class="hljs-keyword">return</span> Container(
      padding: EdgeInsets.all(<span class="hljs-number">16</span>),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          _buildInstructionItem(<span class="hljs-string">'单击'</span>, <span class="hljs-string">'快速点击一次'</span>),
          _buildInstructionItem(<span class="hljs-string">'双击'</span>, <span class="hljs-string">'快速连续点击两次'</span>),
          _buildInstructionItem(<span class="hljs-string">'长按'</span>, <span class="hljs-string">'按住不放'</span>),
          _buildInstructionItem(<span class="hljs-string">'拖拽'</span>, <span class="hljs-string">'按住并移动'</span>),
          _buildInstructionItem(<span class="hljs-string">'缩放'</span>, <span class="hljs-string">'双指捏合或展开'</span>),
        ],
      ),
    );
  }

  Widget _buildInstructionItem(<span class="hljs-built_in">String</span> gesture, <span class="hljs-built_in">String</span> description) {
    <span class="hljs-keyword">return</span> Padding(
      padding: EdgeInsets.symmetric(vertical: <span class="hljs-number">8</span>),
      child: Row(
        children: [
          Text(gesture, style: TextStyle(fontSize: <span class="hljs-number">16</span>, fontWeight: FontWeight.bold)),
          SizedBox(width: <span class="hljs-number">16</span>),
          Text(description, style: TextStyle(fontSize: <span class="hljs-number">14</span>, color: Colors.grey[<span class="hljs-number">600</span>])),
        ],
      ),
    );
  }
}
</code></pre>
<h4 data-id="heading-4">1.3 手势识别器类型总结</h4>
<p>下面我们总结下手势识别器都包含哪些类型，并了解各种手势识别器的特性：</p>





















































<table><thead><tr><th>手势类型</th><th>识别器</th><th>触发条件</th><th>应用场景</th></tr></thead><tbody><tr><td><strong>点击</strong></td><td>onTap</td><td>快速触摸释放</td><td>按钮点击、项目选择</td></tr><tr><td><strong>双击</strong></td><td>onDoubleTap</td><td>快速连续两次点击</td><td>图片放大/缩小、点赞</td></tr><tr><td><strong>长按</strong></td><td>onLongPress</td><td>长时间按住</td><td>显示上下文菜单、拖拽准备</td></tr><tr><td><strong>拖拽</strong></td><td>onPanUpdate</td><td>按住并移动</td><td>滑动删除、元素拖拽</td></tr><tr><td><strong>缩放</strong></td><td>onScaleUpdate</td><td>双指捏合/展开</td><td>图片缩放、地图缩放</td></tr><tr><td><strong>垂直拖拽</strong></td><td>onVerticalDragUpdate</td><td>垂直方向拖拽</td><td>滚动列表、下拉刷新</td></tr><tr><td><strong>水平拖拽</strong></td><td>onHorizontalDragUpdate</td><td>水平方向拖拽</td><td>页面切换、轮播图</td></tr></tbody></table>
<h4 data-id="heading-5">1.4 多手势间竞争规则</h4>
<p>我们先来演示下不同手势的触发效果
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e5565e2923b4a88b8d5bb89258b70eb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUXVhbnR1bUxlYXDkuLY=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764733246&amp;x-signature=hfJD1Bl1wwXM0fmD7%2Btwg7fwrFE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<ul>
<li><strong>竞争规则</strong></li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/611156b69fe544af92ddfaba116dee7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUXVhbnR1bUxlYXDkuLY=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764733246&amp;x-signature=fkmcbCkSnpDcX623gvkFkYlWQCM%3D" alt="竞争核心规则.png" loading="lazy"/></p>
<h3 data-id="heading-6">2. 拖拽与缩放</h3>
<h4 data-id="heading-7">2.1 实现原理</h4>
<p>拖拽功能的实现基于以下事件序列：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant U as 用户
    participant G as GestureDetector
    participant S as State
    
    U-&gt;&gt;G: 手指按下 (onPanStart)
    G-&gt;&gt;S: 记录起始位置
    Note over S: 设置_dragging = true
    
    loop 拖拽过程
        U-&gt;&gt;G: 手指移动 (onPanUpdate)
        G-&gt;&gt;S: 更新位置数据
        S-&gt;&gt;S: setState() 触发重建
        Note over S: 根据delta更新坐标
    end
    
    U-&gt;&gt;G: 手指抬起 (onPanEnd)
    G-&gt;&gt;S: 结束拖拽状态
    Note over S: 设置_dragging = false
</code></pre>
<h4 data-id="heading-8">2.2 拖拽功能</h4>
<p>下面是拖拽功能核心代码实现：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DraggableBox</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _DraggableBoxState createState() =&gt; _DraggableBoxState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_DraggableBoxState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">DraggableBox</span>&gt; </span>{
  <span class="hljs-comment">// 位置状态</span>
  <span class="hljs-built_in">double</span> _positionX = <span class="hljs-number">0.0</span>;
  <span class="hljs-built_in">double</span> _positionY = <span class="hljs-number">0.0</span>;
  
  <span class="hljs-comment">// 拖拽状态</span>
  <span class="hljs-built_in">bool</span> _isDragging = <span class="hljs-keyword">false</span>;
  <span class="hljs-built_in">double</span> _startX = <span class="hljs-number">0.0</span>;
  <span class="hljs-built_in">double</span> _startY = <span class="hljs-number">0.0</span>;

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(title: Text(<span class="hljs-string">'拖拽盒子'</span>)),
      body: Stack(
        children: [
          <span class="hljs-comment">// 背景网格</span>
          _buildBackgroundGrid(),
          
          <span class="hljs-comment">// 拖拽盒子</span>
          Positioned(
            left: _positionX,
            top: _positionY,
            child: GestureDetector(
              onPanStart: _handlePanStart,
              onPanUpdate: _handlePanUpdate,
              onPanEnd: _handlePanEnd,
              child: AnimatedContainer(
                duration: <span class="hljs-built_in">Duration</span>(milliseconds: <span class="hljs-number">100</span>),
                width: <span class="hljs-number">120</span>,
                height: <span class="hljs-number">120</span>,
                decoration: BoxDecoration(
                  color: _isDragging ? Colors.blue[<span class="hljs-number">700</span>] : Colors.blue[<span class="hljs-number">500</span>],
                  borderRadius: BorderRadius.circular(<span class="hljs-number">12</span>),
                  boxShadow: _isDragging ? [
                    BoxShadow(
                      color: Colors.black.withOpacity(<span class="hljs-number">0.3</span>),
                      blurRadius: <span class="hljs-number">15</span>,
                      offset: Offset(<span class="hljs-number">0</span>, <span class="hljs-number">8</span>),
                    )
                  ] : [
                    BoxShadow(
                      color: Colors.black.withOpacity(<span class="hljs-number">0.2</span>),
                      blurRadius: <span class="hljs-number">8</span>,
                      offset: Offset(<span class="hljs-number">0</span>, <span class="hljs-number">4</span>),
                    )
                  ],
                  border: Border.all(
                    color: Colors.white,
                    width: <span class="hljs-number">2</span>,
                  ),
                ),
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Icon(
                      _isDragging ? Icons.touch_app : Icons.drag_handle,
                      color: Colors.white,
                      size: <span class="hljs-number">40</span>,
                    ),
                    SizedBox(height: <span class="hljs-number">8</span>),
                    Text(
                      _isDragging ? <span class="hljs-string">'拖拽中...'</span> : <span class="hljs-string">'拖拽我'</span>,
                      style: TextStyle(color: Colors.white),
                    ),
                  ],
                ),
              ),
            ),
          ),
          
          <span class="hljs-comment">// 位置信息</span>
          Positioned(
            bottom: <span class="hljs-number">20</span>,
            left: <span class="hljs-number">20</span>,
            child: Container(
              padding: EdgeInsets.all(<span class="hljs-number">12</span>),
              decoration: BoxDecoration(
                color: Colors.black.withOpacity(<span class="hljs-number">0.7</span>),
                borderRadius: BorderRadius.circular(<span class="hljs-number">8</span>),
              ),
              child: Text(
                <span class="hljs-string">'位置: (<span class="hljs-subst">${_positionX.toStringAsFixed(<span class="hljs-number">1</span>)}</span>, '</span>
                    <span class="hljs-string">'<span class="hljs-subst">${_positionY.toStringAsFixed(<span class="hljs-number">1</span>)}</span>)'</span>,
                style: TextStyle(color: Colors.white),
              ),
            ),
          ),
        ],
      ),
    );
  }

  <span class="hljs-keyword">void</span> _handlePanStart(DragStartDetails details) {
    setState(() {
      _isDragging = <span class="hljs-keyword">true</span>;
      _startX = details.globalPosition.dx - _positionX;
      _startY = details.globalPosition.dy - _positionY;
    });
  }

  <span class="hljs-keyword">void</span> _handlePanUpdate(DragUpdateDetails details) {
    setState(() {
      _positionX = details.globalPosition.dx - _startX;
      _positionY = details.globalPosition.dy - _startY;
      
      <span class="hljs-comment">// 限制在屏幕范围内</span>
      <span class="hljs-keyword">final</span> screenWidth = MediaQuery.of(context).size.width;
      <span class="hljs-keyword">final</span> screenHeight = MediaQuery.of(context).size.height;
      
      _positionX = _positionX.clamp(<span class="hljs-number">0.0</span>, screenWidth - <span class="hljs-number">120</span>);
      _positionY = _positionY.clamp(<span class="hljs-number">0.0</span>, screenHeight - <span class="hljs-number">200</span>);
    });
  }

  <span class="hljs-keyword">void</span> _handlePanEnd(DragEndDetails details) {
    setState(() {
      _isDragging = <span class="hljs-keyword">false</span>;
    });
  }

  Widget _buildBackgroundGrid() {
    <span class="hljs-keyword">return</span> Container(
      width: <span class="hljs-built_in">double</span>.infinity,
      height: <span class="hljs-built_in">double</span>.infinity,
      child: CustomPaint(
        painter: _GridPainter(),
      ),
    );
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_GridPainter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">CustomPainter</span> </span>{
  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> paint(Canvas canvas, Size size) {
    <span class="hljs-keyword">final</span> paint = Paint()
      ..color = Colors.grey[<span class="hljs-number">300</span>]!
      ..strokeWidth = <span class="hljs-number">1.0</span>
      ..style = PaintingStyle.stroke;

    <span class="hljs-comment">// 绘制网格</span>
    <span class="hljs-keyword">const</span> step = <span class="hljs-number">40.0</span>;
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">double</span> x = <span class="hljs-number">0</span>; x &lt; size.width; x += step) {
      canvas.drawLine(Offset(x, <span class="hljs-number">0</span>), Offset(x, size.height), paint);
    }
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">double</span> y = <span class="hljs-number">0</span>; y &lt; size.height; y += step) {
      canvas.drawLine(Offset(<span class="hljs-number">0</span>, y), Offset(size.width, y), paint);
    }
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-built_in">bool</span> shouldRepaint(<span class="hljs-keyword">covariant</span> CustomPainter oldDelegate) =&gt; <span class="hljs-keyword">false</span>;
}
</code></pre>
<h4 data-id="heading-9">2.3 缩放功能</h4>
<p>缩放功能涉及到矩阵变换，下面是核心代码实现：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ZoomableImage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> imageUrl;
  
  <span class="hljs-keyword">const</span> ZoomableImage({<span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.imageUrl});

  <span class="hljs-meta">@override</span>
  _ZoomableImageState createState() =&gt; _ZoomableImageState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_ZoomableImageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">ZoomableImage</span>&gt; </span>{
  <span class="hljs-comment">// 变换控制器</span>
  Matrix4 _transform = Matrix4.identity();
  Matrix4 _previousTransform = Matrix4.identity();
  
  <span class="hljs-comment">// 缩放限制</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> _minScale = <span class="hljs-number">0.5</span>;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> _maxScale = <span class="hljs-number">4.0</span>;

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(title: Text(<span class="hljs-string">'可缩放图片'</span>)),
      body: Center(
        child: GestureDetector(
          onScaleStart: _onScaleStart,
          onScaleUpdate: _onScaleUpdate,
          onDoubleTap: _onDoubleTap,
          child: Transform(
            transform: _transform,
            child: Container(
              width: <span class="hljs-number">300</span>,
              height: <span class="hljs-number">300</span>,
              decoration: BoxDecoration(
                borderRadius: BorderRadius.circular(<span class="hljs-number">12</span>),
                boxShadow: [
                  BoxShadow(
                    color: Colors.black26,
                    blurRadius: <span class="hljs-number">10</span>,
                    offset: Offset(<span class="hljs-number">0</span>, <span class="hljs-number">4</span>),
                  )
                ],
                image: DecorationImage(
                  image: NetworkImage(widget.imageUrl),
                  fit: BoxFit.cover,
                ),
              ),
            ),
          ),
        ),
      ),
      floatingActionButton: FloatingActionButton(
        onPressed: _resetTransform,
        child: Icon(Icons.refresh),
      ),
    );
  }

  <span class="hljs-keyword">void</span> _onScaleStart(ScaleStartDetails details) {
    _previousTransform = _transform;
  }

  <span class="hljs-keyword">void</span> _onScaleUpdate(ScaleUpdateDetails details) {
    setState(() {
      <span class="hljs-comment">// 计算新的缩放比例</span>
      <span class="hljs-built_in">double</span> newScale = _getScale(_previousTransform) * details.scale;
      newScale = newScale.clamp(_minScale, _maxScale);
      
      <span class="hljs-comment">// 创建变换矩阵</span>
      _transform = Matrix4.identity()
        ..scale(newScale)
        ..translate(
          details.focalPoint.dx / newScale - details.localFocalPosition.dx,
          details.focalPoint.dy / newScale - details.localFocalPosition.dy,
        );
    });
  }

  <span class="hljs-keyword">void</span> _onDoubleTap() {
    setState(() {
      <span class="hljs-comment">// 双击切换原始大小和放大状态</span>
      <span class="hljs-keyword">final</span> currentScale = _getScale(_transform);
      <span class="hljs-keyword">final</span> targetScale = currentScale == <span class="hljs-number">1.0</span> ? <span class="hljs-number">2.0</span> : <span class="hljs-number">1.0</span>;
      
      _transform = Matrix4.identity()..scale(targetScale);
    });
  }

  <span class="hljs-keyword">void</span> _resetTransform() {
    setState(() {
      _transform = Matrix4.identity();
    });
  }

  <span class="hljs-built_in">double</span> _getScale(Matrix4 matrix) {
    <span class="hljs-comment">// 从变换矩阵中提取缩放值</span>
    <span class="hljs-keyword">return</span> matrix.getMaxScaleOnAxis();
  }
}
</code></pre>
<h3 data-id="heading-10">3. 手势冲突解决</h3>
<h4 data-id="heading-11">3.1 手势冲突类型分析</h4>
<p>手势冲突主要分为三种类型，我们可以用下面的UML图来表示：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">classDiagram
    class GestureConflict {
        &lt;&lt;enumeration&gt;&gt;
        ParentChild
        Sibling
        SameType
    }
    
    class ParentChildConflict {
        +String description
        +Solution solution
    }
    
    class SiblingConflict {
        +String description
        +Solution solution
    }
    
    class SameTypeConflict {
        +String description
        +Solution solution
    }
    
    GestureConflict &lt;|-- ParentChildConflict
    GestureConflict &lt;|-- SiblingConflict
    GestureConflict &lt;|-- SameTypeConflict
</code></pre>
<p><strong>具体冲突类型说明：</strong></p>
<ol>
<li>
<p><strong>父子组件冲突</strong></p>
<ul>
<li>现象：父组件和子组件都有相同类型的手势识别</li>
<li>案例：可点击的卡片中包含可点击的按钮</li>
<li>解决方法：使用<code>HitTestBehavior</code>控制事件传递</li>
</ul>
</li>
<li>
<p><strong>兄弟组件冲突</strong></p>
<ul>
<li>现象：相邻组件的手势区域重叠</li>
<li>案例：两个重叠的可拖拽元素</li>
<li>解决方法：使用<code>Listener</code>精确控制事件处理</li>
</ul>
</li>
<li>
<p><strong>同类型手势冲突</strong></p>
<ul>
<li>现象：同一组件注册了多个相似手势</li>
<li>案例：同时监听点击和双击</li>
<li>解决方法：设置手势识别优先级</li>
</ul>
</li>
</ol>
<h4 data-id="heading-12">3.2 冲突解决具体方案</h4>
<h5 data-id="heading-13">方案1：使用HitTestBehavior</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">HitTestBehaviorExample</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      body: GestureDetector(
        <span class="hljs-comment">// 父组件手势</span>
        onTap: () =&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">'父组件点击'</span>),
        behavior: HitTestBehavior.translucent, <span class="hljs-comment">// 关键设置</span>
        child: Container(
          color: Colors.blue[<span class="hljs-number">100</span>],
          padding: EdgeInsets.all(<span class="hljs-number">50</span>),
          child: GestureDetector(
            <span class="hljs-comment">// 子组件手势</span>
            onTap: () =&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">'子组件点击'</span>),
            child: Container(
              width: <span class="hljs-number">200</span>,
              height: <span class="hljs-number">200</span>,
              color: Colors.red[<span class="hljs-number">100</span>],
              child: Center(child: Text(<span class="hljs-string">'点击测试区域'</span>)),
            ),
          ),
        ),
      ),
    );
  }
}
</code></pre>
<h5 data-id="heading-14">方案2：使用IgnorePointer和AbsorbPointer</h5>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PointerControlExample</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _PointerControlExampleState createState() =&gt; _PointerControlExampleState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_PointerControlExampleState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">PointerControlExample</span>&gt; </span>{
  <span class="hljs-built_in">bool</span> _ignoreChild = <span class="hljs-keyword">false</span>;
  <span class="hljs-built_in">bool</span> _absorbPointer = <span class="hljs-keyword">false</span>;

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(title: Text(<span class="hljs-string">'指针控制案例'</span>)),
      body: Column(
        children: [
          <span class="hljs-comment">// 控制面板</span>
          _buildControlPanel(),
          
          Expanded(
            child: Stack(
              children: [
                <span class="hljs-comment">// 底层组件</span>
                GestureDetector(
                  onTap: () =&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">'底层组件被点击'</span>),
                  child: Container(
                    color: Colors.blue[<span class="hljs-number">200</span>],
                    child: Center(child: Text(<span class="hljs-string">'底层组件'</span>)),
                  ),
                ),
                
                <span class="hljs-comment">// 根据条件包装子组件</span>
                <span class="hljs-keyword">if</span> (_ignoreChild)
                  IgnorePointer(
                    child: _buildTopLayer(<span class="hljs-string">'IgnorePointer'</span>),
                  )
                <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (_absorbPointer)
                  AbsorbPointer(
                    child: _buildTopLayer(<span class="hljs-string">'AbsorbPointer'</span>),
                  )
                <span class="hljs-keyword">else</span>
                  _buildTopLayer(<span class="hljs-string">'正常模式'</span>),
              ],
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildControlPanel() {
    <span class="hljs-keyword">return</span> Container(
      padding: EdgeInsets.all(<span class="hljs-number">16</span>),
      color: Colors.grey[<span class="hljs-number">100</span>],
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceAround,
        children: [
          ElevatedButton(
            onPressed: () =&gt; setState(() {
              _ignoreChild = <span class="hljs-keyword">false</span>;
              _absorbPointer = <span class="hljs-keyword">false</span>;
            }),
            child: Text(<span class="hljs-string">'正常'</span>),
          ),
          ElevatedButton(
            onPressed: () =&gt; setState(() {
              _ignoreChild = <span class="hljs-keyword">true</span>;
              _absorbPointer = <span class="hljs-keyword">false</span>;
            }),
            child: Text(<span class="hljs-string">'IgnorePointer'</span>),
          ),
          ElevatedButton(
            onPressed: () =&gt; setState(() {
              _ignoreChild = <span class="hljs-keyword">false</span>;
              _absorbPointer = <span class="hljs-keyword">true</span>;
            }),
            child: Text(<span class="hljs-string">'AbsorbPointer'</span>),
          ),
        ],
      ),
    );
  }

  Widget _buildTopLayer(<span class="hljs-built_in">String</span> mode) {
    <span class="hljs-keyword">return</span> Positioned(
      bottom: <span class="hljs-number">50</span>,
      right: <span class="hljs-number">50</span>,
      child: GestureDetector(
        onTap: () =&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">'顶层组件被点击 - <span class="hljs-subst">$mode</span>'</span>),
        child: Container(
          width: <span class="hljs-number">200</span>,
          height: <span class="hljs-number">150</span>,
          color: Colors.red[<span class="hljs-number">200</span>],
          child: Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Text(<span class="hljs-string">'顶层组件'</span>),
                Text(<span class="hljs-string">'模式: <span class="hljs-subst">$mode</span>'</span>, style: TextStyle(fontWeight: FontWeight.bold)),
              ],
            ),
          ),
        ),
      ),
    );
  }
}
</code></pre>
<h3 data-id="heading-15">4. 自定义手势识别</h3>
<h4 data-id="heading-16">4.1 架构图</h4>
<p>自定义手势识别器的实现基于以下类结构：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[GestureRecognizer] --&gt; B[OneSequenceGestureRecognizer]
    B --&gt; C[自定义识别器]
    
    C --&gt; D[addPointer]
    C --&gt; E[handleEvent]
    C --&gt; F[resolve]
    
    D --&gt; G[开始跟踪指针]
    E --&gt; H[处理事件序列]
    F --&gt; I[决定竞争结果]
    
    H --&gt; J{Ptr Down}
    H --&gt; K{Ptr Move}
    H --&gt; L{Ptr Up}
    
    J --&gt; M[记录起始状态]
    K --&gt; N[更新手势数据]
    L --&gt; O[触发最终回调]
</code></pre>
<h4 data-id="heading-17">4.2 实现自定义滑动手势</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 自定义滑动手势</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SwipeGestureRecognizer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">OneSequenceGestureRecognizer</span> </span>{
  <span class="hljs-keyword">final</span> VoidCallback? onSwipeLeft;
  <span class="hljs-keyword">final</span> VoidCallback? onSwipeRight;
  <span class="hljs-keyword">final</span> VoidCallback? onSwipeUp;
  <span class="hljs-keyword">final</span> VoidCallback? onSwipeDown;
  
  <span class="hljs-comment">// 配置参数</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">double</span> _minSwipeDistance = <span class="hljs-number">50.0</span>;    <span class="hljs-comment">// 最小滑动距离</span>
  <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-built_in">double</span> _minSwipeVelocity = <span class="hljs-number">100.0</span>;   <span class="hljs-comment">// 最小滑动速度</span>
  
  <span class="hljs-comment">// 状态变量</span>
  Offset? _startPosition;
  Offset? _currentPosition;
  <span class="hljs-built_in">int?</span> _trackedPointer;
  <span class="hljs-built_in">DateTime?</span> _startTime;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> addPointer(PointerDownEvent event) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'跟踪指针: <span class="hljs-subst">${event.pointer}</span>'</span>);
    
    startTrackingPointer(event.pointer);
    _startPosition = event.position;
    _currentPosition = event.position;
    _trackedPointer = event.pointer;
    _startTime = <span class="hljs-built_in">DateTime</span>.now();
    
    <span class="hljs-comment">// 声明参与竞争</span>
    resolve(GestureDisposition.accepted);
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> handleEvent(PointerEvent event) {
    <span class="hljs-keyword">if</span> (event.pointer != _trackedPointer) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">is</span> PointerMoveEvent) {
      _currentPosition = event.position;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">is</span> PointerUpEvent) {
      _evaluateSwipe();
      stopTrackingPointer(event.pointer);
      _reset();
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">is</span> PointerCancelEvent) {
      stopTrackingPointer(event.pointer);
      _reset();
    }
  }

  <span class="hljs-keyword">void</span> _evaluateSwipe() {
    <span class="hljs-keyword">if</span> (_startPosition == <span class="hljs-keyword">null</span> || _currentPosition == <span class="hljs-keyword">null</span> || _startTime == <span class="hljs-keyword">null</span>) {
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">final</span> offset = _currentPosition! - _startPosition!;
    <span class="hljs-keyword">final</span> distance = offset.distance;
    <span class="hljs-keyword">final</span> duration = <span class="hljs-built_in">DateTime</span>.now().difference(_startTime!);
    <span class="hljs-keyword">final</span> velocity = distance / duration.inMilliseconds * <span class="hljs-number">1000</span>;

    <span class="hljs-built_in">print</span>(<span class="hljs-string">'滑动评估 - 距离: <span class="hljs-subst">${distance.toStringAsFixed(<span class="hljs-number">1</span>)}</span>, '</span>
        <span class="hljs-string">'速度: <span class="hljs-subst">${velocity.toStringAsFixed(<span class="hljs-number">1</span>)}</span>, 方向: <span class="hljs-subst">$offset</span>'</span>);

    <span class="hljs-comment">// 检查是否达到滑动阈值</span>
    <span class="hljs-keyword">if</span> (distance &gt;= _minSwipeDistance &amp;&amp; velocity &gt;= _minSwipeVelocity) {
      <span class="hljs-comment">// 判断滑动方向</span>
      <span class="hljs-keyword">if</span> (offset.dx.abs() &gt; offset.dy.abs()) {
        <span class="hljs-comment">// 水平滑动</span>
        <span class="hljs-keyword">if</span> (offset.dx &gt; <span class="hljs-number">0</span>) {
          <span class="hljs-built_in">print</span>(<span class="hljs-string">'向右滑动'</span>);
          onSwipeRight?.call();
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-built_in">print</span>(<span class="hljs-string">'向左滑动'</span>);
          onSwipeLeft?.call();
        }
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 垂直滑动</span>
        <span class="hljs-keyword">if</span> (offset.dy &gt; <span class="hljs-number">0</span>) {
          <span class="hljs-built_in">print</span>(<span class="hljs-string">'向下滑动'</span>);
          onSwipeDown?.call();
        } <span class="hljs-keyword">else</span> {
          <span class="hljs-built_in">print</span>(<span class="hljs-string">'向上滑动'</span>);
          onSwipeUp?.call();
        }
      }
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">print</span>(<span class="hljs-string">'滑动未达到阈值'</span>);
    }
  }

  <span class="hljs-keyword">void</span> _reset() {
    _startPosition = <span class="hljs-keyword">null</span>;
    _currentPosition = <span class="hljs-keyword">null</span>;
    _trackedPointer = <span class="hljs-keyword">null</span>;
    _startTime = <span class="hljs-keyword">null</span>;
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> didStopTrackingLastPointer(<span class="hljs-built_in">int</span> pointer) {
    <span class="hljs-built_in">print</span>(<span class="hljs-string">'停止跟踪指针: <span class="hljs-subst">$pointer</span>'</span>);
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-built_in">String</span> <span class="hljs-keyword">get</span> debugDescription =&gt; <span class="hljs-string">'swipe_gesture'</span>;

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> rejectGesture(<span class="hljs-built_in">int</span> pointer) {
    <span class="hljs-keyword">super</span>.rejectGesture(pointer);
    stopTrackingPointer(pointer);
    _reset();
  }
}

<span class="hljs-comment">// 使用自定义手势的组件</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SwipeDetector</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> Widget child;
  <span class="hljs-keyword">final</span> VoidCallback? onSwipeLeft;
  <span class="hljs-keyword">final</span> VoidCallback? onSwipeRight;
  <span class="hljs-keyword">final</span> VoidCallback? onSwipeUp;
  <span class="hljs-keyword">final</span> VoidCallback? onSwipeDown;

  <span class="hljs-keyword">const</span> SwipeDetector({
    Key? key,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.child,
    <span class="hljs-keyword">this</span>.onSwipeLeft,
    <span class="hljs-keyword">this</span>.onSwipeRight,
    <span class="hljs-keyword">this</span>.onSwipeUp,
    <span class="hljs-keyword">this</span>.onSwipeDown,
  }) : <span class="hljs-keyword">super</span>(key: key);

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> RawGestureDetector(
      gestures: {
        SwipeGestureRecognizer: GestureRecognizerFactoryWithHandlers&lt;
          SwipeGestureRecognizer&gt;(
          () =&gt; SwipeGestureRecognizer(),
          (SwipeGestureRecognizer instance) {
            instance
              ..onSwipeLeft = onSwipeLeft
              ..onSwipeRight = onSwipeRight
              ..onSwipeUp = onSwipeUp
              ..onSwipeDown = onSwipeDown;
          },
        ),
      },
      child: child,
    );
  }
}

<span class="hljs-comment">// 调用规则</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SwipeExample</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _SwipeExampleState createState() =&gt; _SwipeExampleState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_SwipeExampleState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">SwipeExample</span>&gt; </span>{
  <span class="hljs-built_in">String</span> _swipeDirection = <span class="hljs-string">'等待滑动手势...'</span>;
  Color _backgroundColor = Colors.white;

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(title: Text(<span class="hljs-string">'自定义滑动手势'</span>)),
      body: SwipeDetector(
        onSwipeLeft: () =&gt; _handleSwipe(<span class="hljs-string">'左滑'</span>, Colors.red[<span class="hljs-number">100</span>]!),
        onSwipeRight: () =&gt; _handleSwipe(<span class="hljs-string">'右滑'</span>, Colors.blue[<span class="hljs-number">100</span>]!),
        onSwipeUp: () =&gt; _handleSwipe(<span class="hljs-string">'上滑'</span>, Colors.green[<span class="hljs-number">100</span>]!),
        onSwipeDown: () =&gt; _handleSwipe(<span class="hljs-string">'下滑'</span>, Colors.orange[<span class="hljs-number">100</span>]!),
        child: Container(
          color: _backgroundColor,
          width: <span class="hljs-built_in">double</span>.infinity,
          height: <span class="hljs-built_in">double</span>.infinity,
          child: Column(
            mainAxisAlignment: MainAxisAlignment.center,
            children: [
              Icon(Icons.swipe, size: <span class="hljs-number">80</span>, color: Colors.grey),
              SizedBox(height: <span class="hljs-number">20</span>),
              Text(
                _swipeDirection,
                style: TextStyle(fontSize: <span class="hljs-number">24</span>, fontWeight: FontWeight.bold),
              ),
              SizedBox(height: <span class="hljs-number">10</span>),
              Text(
                <span class="hljs-string">'在任意位置滑动试试'</span>,
                style: TextStyle(fontSize: <span class="hljs-number">16</span>, color: Colors.grey),
              ),
              SizedBox(height: <span class="hljs-number">30</span>),
              _buildDirectionIndicators(),
            ],
          ),
        ),
      ),
    );
  }

  <span class="hljs-keyword">void</span> _handleSwipe(<span class="hljs-built_in">String</span> direction, Color color) {
    setState(() {
      _swipeDirection = <span class="hljs-string">'检测到: <span class="hljs-subst">$direction</span>'</span>;
      _backgroundColor = color;
    });
    
    <span class="hljs-comment">// 2秒后恢复初始状态</span>
    Future.delayed(<span class="hljs-built_in">Duration</span>(seconds: <span class="hljs-number">2</span>), () {
      <span class="hljs-keyword">if</span> (mounted) {
        setState(() {
          _swipeDirection = <span class="hljs-string">'等待滑动手势...'</span>;
          _backgroundColor = Colors.white;
        });
      }
    });
  }

  Widget _buildDirectionIndicators() {
    <span class="hljs-keyword">return</span> Container(
      padding: EdgeInsets.all(<span class="hljs-number">20</span>),
      decoration: BoxDecoration(
        color: Colors.black12,
        borderRadius: BorderRadius.circular(<span class="hljs-number">16</span>),
      ),
      child: Column(
        children: [
          Icon(Icons.arrow_upward, size: <span class="hljs-number">40</span>, color: Colors.green),
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceAround,
            children: [
              Icon(Icons.arrow_back, size: <span class="hljs-number">40</span>, color: Colors.red),
              Text(<span class="hljs-string">'滑动方向'</span>, style: TextStyle(fontSize: <span class="hljs-number">16</span>)),
              Icon(Icons.arrow_forward, size: <span class="hljs-number">40</span>, color: Colors.blue),
            ],
          ),
          Icon(Icons.arrow_downward, size: <span class="hljs-number">40</span>, color: Colors.orange),
        ],
      ),
    );
  }
}
</code></pre>
<h3 data-id="heading-18">5. 交互式画板案例</h3>
<h4 data-id="heading-19">5.1 画板应用架构设计</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[DrawingBoard] --&gt; B[Toolbar]
    A --&gt; C[CanvasArea]
    
    B --&gt; D[ColorPicker]
    B --&gt; E[BrushSizeSlider]
    B --&gt; F[ActionButtons]
    
    C --&gt; G[GestureDetector]
    G --&gt; H[CustomPaint]
    
    H --&gt; I[DrawingPainter]
    I --&gt; J[Path数据]
    
    subgraph 状态管理
        K[DrawingState]
        L[Path列表]
        M[当前设置]
    end
    
    J --&gt; L
    D --&gt; M
    E --&gt; M
</code></pre>
<h4 data-id="heading-20">5.2 画板应用实现</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 绘图路径数据类</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DrawingPath</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;Offset&gt; points;
  <span class="hljs-keyword">final</span> Color color;
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">double</span> strokeWidth;
  <span class="hljs-keyword">final</span> PaintMode mode;

  DrawingPath({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.points,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.color,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.strokeWidth,
    <span class="hljs-keyword">this</span>.mode = PaintMode.draw,
  });
}

<span class="hljs-keyword">enum</span> PaintMode { draw, erase }

<span class="hljs-comment">// 主画板组件</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DrawingBoard</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _DrawingBoardState createState() =&gt; _DrawingBoardState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_DrawingBoardState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">DrawingBoard</span>&gt; </span>{
  <span class="hljs-comment">// 绘图状态</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;DrawingPath&gt; _paths = [];
  DrawingPath? _currentPath;
  
  <span class="hljs-comment">// 画笔设置</span>
  Color _selectedColor = Colors.black;
  <span class="hljs-built_in">double</span> _strokeWidth = <span class="hljs-number">3.0</span>;
  PaintMode _paintMode = PaintMode.draw;
  
  <span class="hljs-comment">// 颜色选项</span>
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;Color&gt; _colorOptions = [
    Colors.black,
    Colors.red,
    Colors.blue,
    Colors.green,
    Colors.orange,
    Colors.purple,
    Colors.brown,
  ];

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(
        title: Text(<span class="hljs-string">'交互式画板'</span>),
        backgroundColor: Colors.deepPurple,
        actions: [
          IconButton(
            icon: Icon(Icons.undo),
            onPressed: _undo,
            tooltip: <span class="hljs-string">'撤销'</span>,
          ),
          IconButton(
            icon: Icon(Icons.delete),
            onPressed: _clear,
            tooltip: <span class="hljs-string">'清空'</span>,
          ),
        ],
      ),
      body: Column(
        children: [
          <span class="hljs-comment">// 工具栏</span>
          _buildToolbar(),
          
          <span class="hljs-comment">// 画布区域</span>
          Expanded(
            child: Container(
              decoration: BoxDecoration(
                gradient: LinearGradient(
                  begin: Alignment.topLeft,
                  end: Alignment.bottomRight,
                  colors: [Colors.grey[<span class="hljs-number">100</span>]!, Colors.grey[<span class="hljs-number">200</span>]!],
                ),
              ),
              child: GestureDetector(
                onPanStart: _onPanStart,
                onPanUpdate: _onPanUpdate,
                onPanEnd: _onPanEnd,
                child: CustomPaint(
                  painter: _DrawingPainter(_paths),
                  size: Size.infinite,
                ),
              ),
            ),
          ),
          
          <span class="hljs-comment">// 状态栏</span>
          _buildStatusBar(),
        ],
      ),
    );
  }

  Widget _buildToolbar() {
    <span class="hljs-keyword">return</span> Container(
      padding: EdgeInsets.all(<span class="hljs-number">12</span>),
      color: Colors.white,
      child: Column(
        children: [
          <span class="hljs-comment">// 颜色选择</span>
          Row(
            mainAxisAlignment: MainAxisAlignment.spaceBetween,
            children: [
              Text(<span class="hljs-string">'颜色:'</span>, style: TextStyle(fontWeight: FontWeight.bold)),
              Wrap(
                spacing: <span class="hljs-number">8</span>,
                children: _colorOptions.map((color) {
                  <span class="hljs-keyword">return</span> GestureDetector(
                    onTap: () =&gt; setState(() {
                      _selectedColor = color;
                      _paintMode = PaintMode.draw;
                    }),
                    child: Container(
                      width: <span class="hljs-number">32</span>,
                      height: <span class="hljs-number">32</span>,
                      decoration: BoxDecoration(
                        color: color,
                        shape: BoxShape.circle,
                        border: Border.all(
                          color: _selectedColor == color ? 
                                Colors.black : Colors.transparent,
                          width: <span class="hljs-number">3</span>,
                        ),
                      ),
                    ),
                  );
                }).toList(),
              ),
              <span class="hljs-comment">// 橡皮擦按钮</span>
              GestureDetector(
                onTap: () =&gt; setState(() {
                  _paintMode = PaintMode.erase;
                }),
                child: Container(
                  padding: EdgeInsets.all(<span class="hljs-number">8</span>),
                  decoration: BoxDecoration(
                    color: _paintMode == PaintMode.erase ? 
                          Colors.grey[<span class="hljs-number">300</span>] : Colors.transparent,
                    borderRadius: BorderRadius.circular(<span class="hljs-number">8</span>),
                  ),
                  child: Icon(
                    Icons.auto_fix_high,
                    color: _paintMode == PaintMode.erase ? 
                          Colors.red : Colors.grey,
                  ),
                ),
              ),
            ],
          ),
          
          SizedBox(height: <span class="hljs-number">12</span>),
          
          <span class="hljs-comment">// 笔刷大小</span>
          Row(
            children: [
              Text(<span class="hljs-string">'笔刷大小:'</span>, style: TextStyle(fontWeight: FontWeight.bold)),
              Expanded(
                child: Slider(
                  value: _strokeWidth,
                  min: <span class="hljs-number">1</span>,
                  max: <span class="hljs-number">20</span>,
                  divisions: <span class="hljs-number">19</span>,
                  onChanged: (value) =&gt; setState(() {
                    _strokeWidth = value;
                  }),
                ),
              ),
              Container(
                padding: EdgeInsets.symmetric(horizontal: <span class="hljs-number">12</span>, vertical: <span class="hljs-number">6</span>),
                decoration: BoxDecoration(
                  color: Colors.grey[<span class="hljs-number">200</span>],
                  borderRadius: BorderRadius.circular(<span class="hljs-number">16</span>),
                ),
                child: Text(
                  <span class="hljs-string">'<span class="hljs-subst">${_strokeWidth.toInt()}</span>px'</span>,
                  style: TextStyle(fontWeight: FontWeight.bold),
                ),
              ),
            ],
          ),
        ],
      ),
    );
  }

  Widget _buildStatusBar() {
    <span class="hljs-keyword">return</span> Container(
      padding: EdgeInsets.all(<span class="hljs-number">8</span>),
      color: Colors.black87,
      child: Row(
        mainAxisAlignment: MainAxisAlignment.spaceBetween,
        children: [
          Text(
            _paintMode == PaintMode.draw ? <span class="hljs-string">'绘图模式'</span> : <span class="hljs-string">'橡皮擦模式'</span>,
            style: TextStyle(color: Colors.white),
          ),
          Text(
            <span class="hljs-string">'路径数量: <span class="hljs-subst">${_paths.length}</span>'</span>,
            style: TextStyle(color: Colors.white),
          ),
        ],
      ),
    );
  }

  <span class="hljs-keyword">void</span> _onPanStart(DragStartDetails details) {
    setState(() {
      _currentPath = DrawingPath(
        points: [details.localPosition],
        color: _paintMode == PaintMode.erase ? Colors.white : _selectedColor,
        strokeWidth: _paintMode == PaintMode.erase ? _strokeWidth * <span class="hljs-number">2</span> : _strokeWidth,
        mode: _paintMode,
      );
      _paths.add(_currentPath!);
    });
  }

  <span class="hljs-keyword">void</span> _onPanUpdate(DragUpdateDetails details) {
    setState(() {
      _currentPath?.points.add(details.localPosition);
    });
  }

  <span class="hljs-keyword">void</span> _onPanEnd(DragEndDetails details) {
    _currentPath = <span class="hljs-keyword">null</span>;
  }

  <span class="hljs-keyword">void</span> _undo() {
    <span class="hljs-keyword">if</span> (_paths.isNotEmpty) {
      setState(() {
        _paths.removeLast();
      });
    }
  }

  <span class="hljs-keyword">void</span> _clear() {
    showDialog(
      context: context,
      builder: (context) =&gt; AlertDialog(
        title: Text(<span class="hljs-string">'清空画板'</span>),
        content: Text(<span class="hljs-string">'确定要清空所有绘图吗？'</span>),
        actions: [
          TextButton(
            onPressed: () =&gt; Navigator.pop(context),
            child: Text(<span class="hljs-string">'取消'</span>),
          ),
          TextButton(
            onPressed: () {
              setState(() {
                _paths.clear();
              });
              Navigator.pop(context);
            },
            child: Text(<span class="hljs-string">'清空'</span>),
          ),
        ],
      ),
    );
  }
}

<span class="hljs-comment">// 绘图绘制器</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_DrawingPainter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">CustomPainter</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;DrawingPath&gt; paths;

  _DrawingPainter(<span class="hljs-keyword">this</span>.paths);

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> paint(Canvas canvas, Size size) {
    <span class="hljs-comment">// 绘制背景网格</span>
    _drawBackgroundGrid(canvas, size);
    
    <span class="hljs-comment">// 绘制所有路径</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> path <span class="hljs-keyword">in</span> paths) {
      <span class="hljs-keyword">final</span> paint = Paint()
        ..color = path.color
        ..strokeWidth = path.strokeWidth
        ..strokeCap = StrokeCap.round
        ..strokeJoin = StrokeJoin.round
        ..style = PaintingStyle.stroke;

      <span class="hljs-comment">// 绘制路径</span>
      <span class="hljs-keyword">if</span> (path.points.length &gt; <span class="hljs-number">1</span>) {
        <span class="hljs-keyword">final</span> pathPoints = Path();
        pathPoints.moveTo(path.points[<span class="hljs-number">0</span>].dx, path.points[<span class="hljs-number">0</span>].dy);
        
        <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">1</span>; i &lt; path.points.length; i++) {
          pathPoints.lineTo(path.points[i].dx, path.points[i].dy);
        }
        
        canvas.drawPath(pathPoints, paint);
      }
    }
  }

  <span class="hljs-keyword">void</span> _drawBackgroundGrid(Canvas canvas, Size size) {
    <span class="hljs-keyword">final</span> gridPaint = Paint()
      ..color = Colors.grey[<span class="hljs-number">300</span>]!
      ..strokeWidth = <span class="hljs-number">0.5</span>;
    
    <span class="hljs-keyword">const</span> gridSize = <span class="hljs-number">20.0</span>;
    
    <span class="hljs-comment">// 绘制垂直线</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">double</span> x = <span class="hljs-number">0</span>; x &lt; size.width; x += gridSize) {
      canvas.drawLine(Offset(x, <span class="hljs-number">0</span>), Offset(x, size.height), gridPaint);
    }
    
    <span class="hljs-comment">// 绘制水平线</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">double</span> y = <span class="hljs-number">0</span>; y &lt; size.height; y += gridSize) {
      canvas.drawLine(Offset(<span class="hljs-number">0</span>, y), Offset(size.width, y), gridPaint);
    }
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-built_in">bool</span> shouldRepaint(<span class="hljs-keyword">covariant</span> CustomPainter oldDelegate) =&gt; <span class="hljs-keyword">true</span>;
}
</code></pre>
<h3 data-id="heading-21">6. 性能优化</h3>
<h4 data-id="heading-22">6.1 手势性能优化策略</h4>
<p>下面我们可以详细了解各种优化策略的效果：</p>



































<table><thead><tr><th>优化策略</th><th>解决方法</th><th>应用场景</th></tr></thead><tbody><tr><td><strong>减少GestureDetector嵌套</strong></td><td>合并相邻手势检测器</td><td>复杂布局、列表项</td></tr><tr><td><strong>使用InkWell替代</strong></td><td>简单点击使用InkWell</td><td>按钮、列表项点击</td></tr><tr><td><strong>合理使用HitTestBehavior</strong></td><td>精确控制命中测试范围</td><td>重叠组件、透明区域</td></tr><tr><td><strong>避免频繁setState</strong></td><td>使用TransformController</td><td>拖拽、缩放操作</td></tr><tr><td><strong>列表项手势优化</strong></td><td>使用NotificationListener</td><td>长列表、复杂手势</td></tr></tbody></table>
<h4 data-id="heading-23">6.2 实际案例优化</h4>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OptimizedGestureExample</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-meta">@override</span>
  _OptimizedGestureExampleState createState() =&gt; _OptimizedGestureExampleState();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_OptimizedGestureExampleState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">OptimizedGestureExample</span>&gt; </span>{
  <span class="hljs-keyword">final</span> TransformationController _transformController = TransformationController();
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">List</span>&lt;Widget&gt; _items = [];

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> initState() {
    <span class="hljs-keyword">super</span>.initState();
    <span class="hljs-comment">// 初始化</span>
    _initializeItems();
  }

  <span class="hljs-keyword">void</span> _initializeItems() {
    <span class="hljs-keyword">for</span> (<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">50</span>; i++) {
      _items.add(
        OptimizedListItem(
          index: i,
          onTap: () =&gt; <span class="hljs-built_in">print</span>(<span class="hljs-string">'Item <span class="hljs-subst">$i</span> tapped'</span>),
        ),
      );
    }
  }

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Scaffold(
      appBar: AppBar(title: Text(<span class="hljs-string">'优化手势'</span>)),
      body: Column(
        children: [
          <span class="hljs-comment">// 可缩放拖拽区域</span>
          Expanded(
            flex: <span class="hljs-number">2</span>,
            child: InteractiveViewer(
              transformationController: _transformController,
              boundaryMargin: EdgeInsets.all(<span class="hljs-number">20</span>),
              minScale: <span class="hljs-number">0.1</span>,
              maxScale: <span class="hljs-number">4.0</span>,
              child: Container(
                color: Colors.blue[<span class="hljs-number">50</span>],
                child: Center(
                  child: FlutterLogo(size: <span class="hljs-number">150</span>),
                ),
              ),
            ),
          ),
          
          <span class="hljs-comment">// 优化列表</span>
          Expanded(
            flex: <span class="hljs-number">3</span>,
            child: NotificationListener&lt;ScrollNotification&gt;(
              onNotification: (scrollNotification) {
                <span class="hljs-comment">// 可以在这里处理滚动优化</span>
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">false</span>;
              },
              child: ListView.builder(
                itemCount: _items.length,
                itemBuilder: (context, index) =&gt; _items[index],
              ),
            ),
          ),
        ],
      ),
    );
  }

  <span class="hljs-meta">@override</span>
  <span class="hljs-keyword">void</span> dispose() {
    _transformController.dispose();
    <span class="hljs-keyword">super</span>.dispose();
  }
}

<span class="hljs-comment">// 优化的列表项组件</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OptimizedListItem</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">int</span> index;
  <span class="hljs-keyword">final</span> VoidCallback onTap;

  <span class="hljs-keyword">const</span> OptimizedListItem({
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.index,
    <span class="hljs-keyword">required</span> <span class="hljs-keyword">this</span>.onTap,
  });

  <span class="hljs-meta">@override</span>
  Widget build(BuildContext context) {
    <span class="hljs-keyword">return</span> Container(
      margin: EdgeInsets.symmetric(vertical: <span class="hljs-number">4</span>, horizontal: <span class="hljs-number">8</span>),
      child: Material(
        color: Colors.white,
        borderRadius: BorderRadius.circular(<span class="hljs-number">8</span>),
        elevation: <span class="hljs-number">2</span>,
        child: InkWell(  
          onTap: onTap,
          borderRadius: BorderRadius.circular(<span class="hljs-number">8</span>),
          child: Container(
            padding: EdgeInsets.all(<span class="hljs-number">16</span>),
            child: Row(
              children: [
                Container(
                  width: <span class="hljs-number">40</span>,
                  height: <span class="hljs-number">40</span>,
                  decoration: BoxDecoration(
                    color: Colors.primaries[index % Colors.primaries.length],
                    shape: BoxShape.circle,
                  ),
                  child: Center(
                    child: Text(
                      <span class="hljs-string">'<span class="hljs-subst">$index</span>'</span>,
                      style: TextStyle(color: Colors.white, fontWeight: FontWeight.bold),
                    ),
                  ),
                ),
                SizedBox(width: <span class="hljs-number">16</span>),
                Expanded(
                  child: Text(
                    <span class="hljs-string">'优化列表项 <span class="hljs-subst">$index</span>'</span>,
                    style: TextStyle(fontSize: <span class="hljs-number">16</span>),
                  ),
                ),
                Icon(Icons.chevron_right, color: Colors.grey),
              ],
            ),
          ),
        ),
      ),
    );
  }
}
</code></pre>
<h3 data-id="heading-24">总结</h3>
<p>至此，手势识别相关知识点全部讲完了，通过本节的学习，我们掌握了Flutter手势识别的完整知识体系：<code>GestureDetector</code>，<code>拖拽与缩放</code>，<code>手势冲突解决</code>，<code>自定义手势识别</code></p>
<p>对于不同阶段的开发者，建议按以下路径学习：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[初学者] --&gt; B[基础手势]
    B --&gt; C[拖拽缩放]
    
    C --&gt; D[中级开发者]
    D --&gt; E[手势冲突解决]
    E --&gt; F[性能优化]
    
    F --&gt; G[高级开发者]
    G --&gt; H[自定义手势]
    H --&gt; I[复杂交互系统]
</code></pre>
<p><strong>如果觉得这篇文章对你有帮助，别忘了一键三连（点赞、关注、收藏）！你的支持是我持续创作的最大动力！有任何问题欢迎在评论区留言，我会及时解答！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS游戏开发入门：用ArkTS打造经典五子棋]]></title>    <link>https://juejin.cn/post/7576646142316003369</link>    <guid>https://juejin.cn/post/7576646142316003369</guid>    <pubDate>2025-11-26T05:20:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576646142316003369" data-draft-id="7576646533614747702" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS游戏开发入门：用ArkTS打造经典五子棋"/> <meta itemprop="keywords" content="HarmonyOS,ArkTS"/> <meta itemprop="datePublished" content="2025-11-26T05:20:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT充电站"/> <meta itemprop="url" content="https://juejin.cn/user/125809758576431"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS游戏开发入门：用ArkTS打造经典五子棋
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/125809758576431/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT充电站
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T05:20:54.000Z" title="Wed Nov 26 2025 05:20:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>✨家人们记得点个账号关注，会持续发布大前端领域技术文章💕 🍃</p>
<h2 data-id="heading-0">引言</h2>
<p>五子棋是一款经典的策略游戏，规则简单但乐趣无穷。本文将带你使用 HarmonyOS 的 ArkUI 框架，以组件化的思想快速实现一个双人对战的五子棋游戏。我们将逻辑与 UI 分离，打造一个结构清晰、易于维护的应用。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa75e6311ec747b2990c17965e9c3749~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTlhYXnlLXnq5k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764739254&amp;x-signature=ApGDHqNRJA91CDR1lcKjGlK93T0%3D" alt="" loading="lazy"/></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fharmonyos-projects%2Fcodelabs" title="https://gitee.com/harmonyos-projects/codelabs" target="_blank" ref="nofollow noopener noreferrer">仓库地址（小游戏/五子棋目录)<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da37b6247f9445b48f6c4a9f8befb3a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTlhYXnlLXnq5k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764739254&amp;x-signature=lZHmMYJnzJXNnTLv0ZPr%2B20pZm4%3D" alt="" loading="lazy"/>https://gitee.com/harmonyos-projects/codelabs</a></p>
<h2 data-id="heading-1">1. 棋盘</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7844669fc28440b8684cb245896b862~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTlhYXnlLXnq5k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764739254&amp;x-signature=RGN6l9Cij8Xr7YFdYlx8LMxRevc%3D" alt="" loading="lazy"/></p>
<p>ets/pages/gobang/01-棋盘.ets</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Entry</span>
<span class="hljs-variable">@Component</span>
struct Study {

  <span class="hljs-comment">// 一个15x15的二维数组，表示棋盘，初始值为0表格空位，1表示黑棋，2表示白棋。</span>
  <span class="hljs-variable">@State</span> <span class="hljs-attribute">board</span>: number[][] = <span class="hljs-built_in">Array</span>(<span class="hljs-number">15</span>).<span class="hljs-built_in">fill</span>(null).<span class="hljs-built_in">map</span>(() =&gt; <span class="hljs-built_in">Array</span>(<span class="hljs-number">15</span>).<span class="hljs-built_in">fill</span>(<span class="hljs-number">0</span>))
  <span class="hljs-variable">@State</span> <span class="hljs-attribute">currentPlayer</span>: number = <span class="hljs-number">1</span> <span class="hljs-comment">// 1表示黑棋，2表示白棋。</span>
  <span class="hljs-variable">@State</span> <span class="hljs-attribute">gameOver</span>: boolean = false

  <span class="hljs-built_in">build</span>() {
    <span class="hljs-selector-tag">Column</span>() {
      <span class="hljs-comment">// 游戏标题和状态显示</span>
      <span class="hljs-selector-tag">Row</span>() {
        <span class="hljs-selector-tag">Text</span>(<span class="hljs-string">'五子棋'</span>)<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">24</span>)<span class="hljs-selector-class">.fontWeight</span>(FontWeight.Bold)
        <span class="hljs-selector-tag">Text</span>(<span class="hljs-built_in">`当前:${this.currentPlayer==1?'黑':'白'}棋`</span>)<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">16</span>)<span class="hljs-selector-class">.margin</span>({ <span class="hljs-attribute">left</span>: <span class="hljs-number">20</span> })
      }
      .<span class="hljs-built_in">width</span>(<span class="hljs-string">'100%'</span>)
      .<span class="hljs-built_in">margin</span>({ <span class="hljs-attribute">bottom</span>: <span class="hljs-number">10</span> })
      .<span class="hljs-built_in">justifyContent</span>(FlexAlign.Center)

      <span class="hljs-comment">// 棋盘</span>
      <span class="hljs-built_in">Column</span>() {
        <span class="hljs-comment">// 行</span>
        <span class="hljs-selector-tag">ForEach</span>(this.board, (<span class="hljs-attribute">row</span>: number[], <span class="hljs-attribute">rowIndex</span>:number) =&gt; {
          <span class="hljs-selector-tag">Row</span>() {
            <span class="hljs-selector-tag">ForEach</span>(row, (<span class="hljs-attribute">cell</span>: number, <span class="hljs-attribute">colIndex</span>:number) =&gt; {
              <span class="hljs-comment">// 列</span>
              <span class="hljs-selector-tag">Column</span>() {
                <span class="hljs-selector-tag">if</span> (cell) {
                  <span class="hljs-selector-tag">Text</span>()<span class="hljs-selector-class">.width</span>(<span class="hljs-number">18</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">18</span>)<span class="hljs-selector-class">.backgroundColor</span>(cell === <span class="hljs-number">1</span> ? <span class="hljs-string">'#000'</span> : <span class="hljs-string">'#fff'</span>)<span class="hljs-selector-class">.borderRadius</span>(<span class="hljs-number">9</span>)
                }
              }
              <span class="hljs-selector-class">.width</span>(<span class="hljs-number">20</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">20</span>)<span class="hljs-selector-class">.backgroundColor</span>(<span class="hljs-string">'#DEB887'</span>)
              <span class="hljs-selector-class">.border</span>({ <span class="hljs-attribute">width</span>: <span class="hljs-number">1</span>, <span class="hljs-attribute">color</span>: <span class="hljs-string">'#999'</span> })
            })
          }
        })
      }<span class="hljs-selector-class">.margin</span>(<span class="hljs-number">10</span>)

      <span class="hljs-comment">// 操作按钮</span>
      <span class="hljs-selector-tag">Row</span>() {
        <span class="hljs-selector-tag">Button</span>(<span class="hljs-string">'悔棋'</span>)<span class="hljs-selector-class">.width</span>(<span class="hljs-number">120</span>)
        <span class="hljs-selector-tag">Button</span>(<span class="hljs-string">'重新开始'</span>)<span class="hljs-selector-class">.width</span>(<span class="hljs-number">120</span>)<span class="hljs-selector-class">.margin</span>({ <span class="hljs-attribute">left</span>: <span class="hljs-number">10</span> })
      }
      .<span class="hljs-built_in">width</span>(<span class="hljs-string">'100%'</span>)
      .<span class="hljs-built_in">justifyContent</span>(FlexAlign.Center)
    }.<span class="hljs-built_in">padding</span>(<span class="hljs-number">20</span>)
  }
}
</code></pre>
<h2 data-id="heading-2">2. 棋子</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/027a57f72ee04eeeb5ef9ded89368803~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTlhYXnlLXnq5k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764739254&amp;x-signature=0SxOT3nw1lLNY9W5hhUfy9rfjQY%3D" alt="" loading="lazy"/></p>
<p>ets/pages/gobang/02-棋子.ets</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Entry</span>
<span class="hljs-variable">@Component</span>
struct Study {

  <span class="hljs-comment">// 一个15x15的二维数组，表示棋盘，初始值为0表格空位，1表示黑棋，2表示白棋。</span>
  <span class="hljs-variable">@State</span> <span class="hljs-attribute">board</span>: number[][] = <span class="hljs-built_in">Array</span>(<span class="hljs-number">15</span>).<span class="hljs-built_in">fill</span>(null).<span class="hljs-built_in">map</span>(() =&gt; <span class="hljs-built_in">Array</span>(<span class="hljs-number">15</span>).<span class="hljs-built_in">fill</span>(<span class="hljs-number">0</span>))
  <span class="hljs-variable">@State</span> <span class="hljs-attribute">currentPlayer</span>: number = <span class="hljs-number">1</span> <span class="hljs-comment">// 1表示黑棋，2表示白棋。</span>
  <span class="hljs-variable">@State</span> <span class="hljs-attribute">gameOver</span>: boolean = false

  <span class="hljs-comment">// 下棋</span>
  <span class="hljs-built_in">playChess</span>(<span class="hljs-attribute">row</span>: number, <span class="hljs-attribute">col</span>: number) {
    <span class="hljs-comment">// 1. 过滤数据</span>
    <span class="hljs-selector-tag">if</span> (this.gameOver || this.board[row][col] !== <span class="hljs-number">0</span>) <span class="hljs-selector-tag">return</span>

    <span class="hljs-comment">// 2. 修改状态</span>
    <span class="hljs-comment">// - 棋盘</span>
    <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.board</span><span class="hljs-selector-attr">[row]</span><span class="hljs-selector-attr">[col]</span> = <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.currentPlayer</span>  <span class="hljs-comment">// 修改二维没响应式</span>
    <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.board</span> = <span class="hljs-selector-attr">[...this.board]</span>               <span class="hljs-comment">// 直接覆盖原数据响应式生效</span>
    <span class="hljs-comment">// - next 棋子</span>
    <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.currentPlayer</span> = <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.currentPlayer</span> === <span class="hljs-number">1</span> ? <span class="hljs-number">2</span> : <span class="hljs-number">1</span>
  }

  <span class="hljs-selector-tag">build</span>() {
    <span class="hljs-selector-tag">Column</span>() {
      <span class="hljs-comment">// 游戏标题和状态显示</span>
      <span class="hljs-selector-tag">Row</span>() {
        <span class="hljs-selector-tag">Text</span>(<span class="hljs-string">'五子棋'</span>)<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">24</span>)<span class="hljs-selector-class">.fontWeight</span>(FontWeight.Bold)
        <span class="hljs-selector-tag">Text</span>(<span class="hljs-built_in">`当前:${this.currentPlayer==1?'黑':'白'}棋`</span>)<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">16</span>)<span class="hljs-selector-class">.margin</span>({ <span class="hljs-attribute">left</span>: <span class="hljs-number">20</span> })
      }
      .<span class="hljs-built_in">width</span>(<span class="hljs-string">'100%'</span>)
        .<span class="hljs-built_in">margin</span>({ <span class="hljs-attribute">bottom</span>: <span class="hljs-number">10</span> })
        .<span class="hljs-built_in">justifyContent</span>(FlexAlign.Center)

      <span class="hljs-comment">// 棋盘</span>
      <span class="hljs-built_in">Column</span>() {
        <span class="hljs-comment">// 行</span>
        <span class="hljs-selector-tag">ForEach</span>(this.board, (<span class="hljs-attribute">row</span>: number[], <span class="hljs-attribute">rowIndex</span>:number) =&gt; {
          <span class="hljs-selector-tag">Row</span>() {
            <span class="hljs-selector-tag">ForEach</span>(row, (<span class="hljs-attribute">cell</span>: number, <span class="hljs-attribute">colIndex</span>:number) =&gt; {
              <span class="hljs-comment">// 列</span>
              <span class="hljs-selector-tag">Column</span>() {
                <span class="hljs-selector-tag">if</span> (cell) {
                  <span class="hljs-selector-tag">Text</span>()<span class="hljs-selector-class">.width</span>(<span class="hljs-number">18</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">18</span>)<span class="hljs-selector-class">.backgroundColor</span>(cell === <span class="hljs-number">1</span> ? <span class="hljs-string">'#000'</span> : <span class="hljs-string">'#fff'</span>)<span class="hljs-selector-class">.borderRadius</span>(<span class="hljs-number">9</span>)
                }
              }
              <span class="hljs-selector-class">.width</span>(<span class="hljs-number">20</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">20</span>)<span class="hljs-selector-class">.backgroundColor</span>(<span class="hljs-string">'#DEB887'</span>)
                    <span class="hljs-selector-class">.border</span>({ <span class="hljs-attribute">width</span>: <span class="hljs-number">1</span>, <span class="hljs-attribute">color</span>: <span class="hljs-string">'#999'</span> })
                    <span class="hljs-selector-class">.onClick</span>(() =&gt; this.<span class="hljs-built_in">playChess</span>(rowIndex, colIndex))
                    })
          }
        })
      }<span class="hljs-selector-class">.margin</span>(<span class="hljs-number">10</span>)

      <span class="hljs-comment">// 操作按钮</span>
      <span class="hljs-selector-tag">Row</span>() {
        <span class="hljs-selector-tag">Button</span>(<span class="hljs-string">'悔棋'</span>)<span class="hljs-selector-class">.width</span>(<span class="hljs-number">120</span>)
        <span class="hljs-selector-tag">Button</span>(<span class="hljs-string">'重新开始'</span>)<span class="hljs-selector-class">.width</span>(<span class="hljs-number">120</span>)<span class="hljs-selector-class">.margin</span>({ <span class="hljs-attribute">left</span>: <span class="hljs-number">10</span> })
      }
      .<span class="hljs-built_in">width</span>(<span class="hljs-string">'100%'</span>)
        .<span class="hljs-built_in">justifyContent</span>(FlexAlign.Center)
    }.<span class="hljs-built_in">padding</span>(<span class="hljs-number">20</span>)
  }
}
</code></pre>
<h2 data-id="heading-3">3. 检查胜负</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c10ac8c477d5440287d990137301e8d7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTlhYXnlLXnq5k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764739254&amp;x-signature=L091yO5hWNF9Kux%2F6EoVdfOwhvg%3D" alt="" loading="lazy"/></p>
<p>ets/pages/gobang/03-检查胜负.ets</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Entry</span>
<span class="hljs-variable">@Component</span>
struct Study {

  <span class="hljs-comment">// 一个15x15的二维数组，表示棋盘，初始值为0表格空位，1表示黑棋，2表示白棋。</span>
  <span class="hljs-variable">@State</span> <span class="hljs-attribute">board</span>: number[][] = <span class="hljs-built_in">Array</span>(<span class="hljs-number">15</span>).<span class="hljs-built_in">fill</span>(null).<span class="hljs-built_in">map</span>(() =&gt; <span class="hljs-built_in">Array</span>(<span class="hljs-number">15</span>).<span class="hljs-built_in">fill</span>(<span class="hljs-number">0</span>))
  <span class="hljs-variable">@State</span> <span class="hljs-attribute">currentPlayer</span>: number = <span class="hljs-number">1</span> <span class="hljs-comment">// 1表示黑棋，2表示白棋。</span>
  <span class="hljs-variable">@State</span> <span class="hljs-attribute">gameOver</span>: boolean = false

  <span class="hljs-comment">// 下棋</span>
  <span class="hljs-built_in">playChess</span>(<span class="hljs-attribute">row</span>: number, <span class="hljs-attribute">col</span>: number) {
    <span class="hljs-comment">// 1. 过滤数据</span>
    <span class="hljs-selector-tag">if</span> (this.gameOver || this.board[row][col] !== <span class="hljs-number">0</span>) <span class="hljs-selector-tag">return</span>

    <span class="hljs-comment">// 2. 修改状态</span>
    <span class="hljs-comment">// - 棋盘</span>
    <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.board</span><span class="hljs-selector-attr">[row]</span><span class="hljs-selector-attr">[col]</span> = <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.currentPlayer</span>  <span class="hljs-comment">// 修改二维没响应式</span>
    <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.board</span> = <span class="hljs-selector-attr">[...this.board]</span>               <span class="hljs-comment">// 直接覆盖原数据响应式生效</span>
    <span class="hljs-comment">// - next 棋子</span>
    <span class="hljs-comment">// this.currentPlayer = this.currentPlayer === 1 ? 2 : 1</span>

    <span class="hljs-comment">// 3. 判断下棋后结果</span>
    <span class="hljs-selector-tag">if</span> (this.<span class="hljs-built_in">checkWin</span>(row, col)) {
      <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.gameOver</span> = <span class="hljs-selector-tag">true</span>
      <span class="hljs-selector-tag">AlertDialog</span><span class="hljs-selector-class">.show</span>({ message: `${this.currentPlayer === 1 ? '黑棋' : '白棋'}获胜!` })
    } <span class="hljs-selector-tag">else</span> {
      <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.currentPlayer</span> = <span class="hljs-selector-tag">this</span><span class="hljs-selector-class">.currentPlayer</span> === <span class="hljs-number">1</span> ? <span class="hljs-number">2</span> : <span class="hljs-number">1</span>
    }
  }

  <span class="hljs-comment">// 检查胜负</span>
  <span class="hljs-selector-tag">checkWin</span>(<span class="hljs-attribute">row</span>: number, <span class="hljs-attribute">col</span>: number): <span class="hljs-selector-tag">boolean</span> {
    <span class="hljs-selector-tag">const</span> <span class="hljs-selector-tag">directions</span> = <span class="hljs-selector-attr">[      [[-1, 0]</span>, <span class="hljs-selector-attr">[1, 0]</span>],   <span class="hljs-comment">// 垂直</span>
      <span class="hljs-selector-attr">[[0, -1]</span>, <span class="hljs-selector-attr">[0, 1]</span>],   <span class="hljs-comment">// 水平</span>
      <span class="hljs-selector-attr">[[-1, -1]</span>, <span class="hljs-selector-attr">[1, 1]</span>],  <span class="hljs-comment">// 主对角线</span>
      <span class="hljs-selector-attr">[[-1, 1]</span>, <span class="hljs-selector-attr">[1, -1]</span>]   <span class="hljs-comment">// 副对角线</span>
    ]

    <span class="hljs-selector-tag">for</span> (let direction of directions) {
      <span class="hljs-selector-tag">let</span> <span class="hljs-selector-tag">count</span> = <span class="hljs-number">1</span>
      <span class="hljs-selector-tag">for</span> (let i = <span class="hljs-number">0</span>; i &lt; direction.length; i++) {
        <span class="hljs-selector-tag">let</span> <span class="hljs-selector-tag">dx</span> = <span class="hljs-selector-tag">direction</span><span class="hljs-selector-attr">[i]</span><span class="hljs-selector-attr">[0]</span>
        <span class="hljs-selector-tag">let</span> <span class="hljs-selector-tag">dy</span> = <span class="hljs-selector-tag">direction</span><span class="hljs-selector-attr">[i]</span><span class="hljs-selector-attr">[1]</span>
        <span class="hljs-selector-tag">let</span> <span class="hljs-selector-tag">x</span> = <span class="hljs-selector-tag">row</span> + <span class="hljs-selector-tag">dx</span>
        <span class="hljs-selector-tag">let</span> <span class="hljs-selector-tag">y</span> = <span class="hljs-selector-tag">col</span> + <span class="hljs-selector-tag">dy</span>
        <span class="hljs-selector-tag">while</span> (x &gt;= <span class="hljs-number">0</span> &amp;&amp; x &lt; <span class="hljs-number">15</span> &amp;&amp; y &gt;= <span class="hljs-number">0</span> &amp;&amp; y &lt; <span class="hljs-number">15</span> &amp;&amp;
               this.board[x][y] === this.currentPlayer) {
          <span class="hljs-selector-tag">count</span>++
          <span class="hljs-selector-tag">x</span> += <span class="hljs-selector-tag">dx</span>
          <span class="hljs-selector-tag">y</span> += <span class="hljs-selector-tag">dy</span>
        }
      }
      <span class="hljs-selector-tag">if</span> (count &gt;= <span class="hljs-number">5</span>) <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">true</span>
    }
    <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">false</span>
  }


  <span class="hljs-selector-tag">build</span>() {
    <span class="hljs-selector-tag">Column</span>() {
      <span class="hljs-comment">// 游戏标题和状态显示</span>
      <span class="hljs-selector-tag">Row</span>() {
        <span class="hljs-selector-tag">Text</span>(<span class="hljs-string">'五子棋'</span>)<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">24</span>)<span class="hljs-selector-class">.fontWeight</span>(FontWeight.Bold)
        <span class="hljs-selector-tag">Text</span>(<span class="hljs-built_in">`当前:${this.currentPlayer==1?'黑':'白'}棋`</span>)<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">16</span>)<span class="hljs-selector-class">.margin</span>({ <span class="hljs-attribute">left</span>: <span class="hljs-number">20</span> })
      }
      .<span class="hljs-built_in">width</span>(<span class="hljs-string">'100%'</span>)
        .<span class="hljs-built_in">margin</span>({ <span class="hljs-attribute">bottom</span>: <span class="hljs-number">10</span> })
        .<span class="hljs-built_in">justifyContent</span>(FlexAlign.Center)

      <span class="hljs-comment">// 棋盘</span>
      <span class="hljs-built_in">Column</span>() {
        <span class="hljs-comment">// 行</span>
        <span class="hljs-selector-tag">ForEach</span>(this.board, (<span class="hljs-attribute">row</span>: number[], <span class="hljs-attribute">rowIndex</span>:number) =&gt; {
          <span class="hljs-selector-tag">Row</span>() {
            <span class="hljs-selector-tag">ForEach</span>(row, (<span class="hljs-attribute">cell</span>: number, <span class="hljs-attribute">colIndex</span>:number) =&gt; {
              <span class="hljs-comment">// 列</span>
              <span class="hljs-selector-tag">Column</span>() {
                <span class="hljs-selector-tag">if</span> (cell) {
                  <span class="hljs-selector-tag">Text</span>()<span class="hljs-selector-class">.width</span>(<span class="hljs-number">18</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">18</span>)<span class="hljs-selector-class">.backgroundColor</span>(cell === <span class="hljs-number">1</span> ? <span class="hljs-string">'#000'</span> : <span class="hljs-string">'#fff'</span>)<span class="hljs-selector-class">.borderRadius</span>(<span class="hljs-number">9</span>)
                }
              }
              <span class="hljs-selector-class">.width</span>(<span class="hljs-number">20</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">20</span>)<span class="hljs-selector-class">.backgroundColor</span>(<span class="hljs-string">'#DEB887'</span>)
                    <span class="hljs-selector-class">.border</span>({ <span class="hljs-attribute">width</span>: <span class="hljs-number">1</span>, <span class="hljs-attribute">color</span>: <span class="hljs-string">'#999'</span> })
                    <span class="hljs-selector-class">.onClick</span>(() =&gt; this.<span class="hljs-built_in">playChess</span>(rowIndex, colIndex))
                    })
          }
        })
      }<span class="hljs-selector-class">.margin</span>(<span class="hljs-number">10</span>)

      <span class="hljs-comment">// 操作按钮</span>
      <span class="hljs-selector-tag">Row</span>() {
        <span class="hljs-selector-tag">Button</span>(<span class="hljs-string">'悔棋'</span>)<span class="hljs-selector-class">.width</span>(<span class="hljs-number">120</span>)
        <span class="hljs-selector-tag">Button</span>(<span class="hljs-string">'重新开始'</span>)<span class="hljs-selector-class">.width</span>(<span class="hljs-number">120</span>)<span class="hljs-selector-class">.margin</span>({ <span class="hljs-attribute">left</span>: <span class="hljs-number">10</span> })
      }
      .<span class="hljs-built_in">width</span>(<span class="hljs-string">'100%'</span>)
        .<span class="hljs-built_in">justifyContent</span>(FlexAlign.Center)
    }.<span class="hljs-built_in">padding</span>(<span class="hljs-number">20</span>)
  }
}
</code></pre>
<h2 data-id="heading-4">4. 重新开始</h2>
<p>ets/pages/gobang/04-重新开始.ets</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 重新开发</span>
<span class="hljs-title function_">resetGame</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">board</span> = <span class="hljs-title class_">Array</span>(<span class="hljs-number">15</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-literal">null</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">15</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>))
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentPlayer</span> = <span class="hljs-number">1</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">gameOver</span> = <span class="hljs-literal">false</span>
}
</code></pre>
<h2 data-id="heading-5">5. 悔棋 选写</h2>
<ul>
<li>下棋playChess时，保存row、col索引</li>
<li>点击悔棋修改改索引状态为空格</li>
<li>并且把currentPlayer修改</li>
</ul>
<h2 data-id="heading-6">6. 面向对象封装</h2>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e37e7c61d4c45f1b5b814f9ff4628e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSVTlhYXnlLXnq5k=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764739254&amp;x-signature=2f03v0MA0hmp72oorjEGUH5A01Q%3D" alt="" loading="lazy"/></p>
<p>ets/gobang/Control.ets</p>
<pre><code class="hljs language-typescript" lang="typescript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Control</span> {

  <span class="hljs-keyword">private</span> <span class="hljs-attr">currentPlayer</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">1</span> <span class="hljs-comment">// 1表示黑棋，2表示白棋。</span>
  <span class="hljs-keyword">private</span> <span class="hljs-attr">gameOver</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>

  <span class="hljs-comment">// 下棋</span>
  <span class="hljs-title function_">playChess</span>(<span class="hljs-params">board:<span class="hljs-built_in">number</span>[][], row: <span class="hljs-built_in">number</span>, col: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-comment">// 1. 过滤数据</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">gameOver</span> || board[row][col] !== <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>

    <span class="hljs-comment">// 2. 修改状态</span>
    <span class="hljs-comment">// - 棋盘</span>
    board[row][col] = <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentPlayer</span>
    <span class="hljs-comment">// - next 棋子</span>
    <span class="hljs-comment">// this.currentPlayer = this.currentPlayer === 1 ? 2 : 1</span>

    <span class="hljs-comment">// 3. 判断下棋后结果</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">checkWin</span>(board, row, col)) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">gameOver</span> = <span class="hljs-literal">true</span>
      <span class="hljs-title class_">AlertDialog</span>.<span class="hljs-title function_">show</span>({ <span class="hljs-attr">message</span>: <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.currentPlayer === <span class="hljs-number">1</span> ? <span class="hljs-string">'黑棋'</span> : <span class="hljs-string">'白棋'</span>}</span>获胜!`</span> })
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentPlayer</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentPlayer</span> === <span class="hljs-number">1</span> ? <span class="hljs-number">2</span> : <span class="hljs-number">1</span>
    }

    <span class="hljs-keyword">return</span> [...board]
  }

  <span class="hljs-comment">// 检查胜负</span>
  <span class="hljs-title function_">checkWin</span>(<span class="hljs-attr">board</span>:<span class="hljs-built_in">number</span>[][], <span class="hljs-attr">row</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">col</span>: <span class="hljs-built_in">number</span>): <span class="hljs-built_in">boolean</span> {
    <span class="hljs-keyword">const</span> directions = [
      [[-<span class="hljs-number">1</span>, <span class="hljs-number">0</span>], [<span class="hljs-number">1</span>, <span class="hljs-number">0</span>]],   <span class="hljs-comment">// 垂直</span>
      [[<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>]],   <span class="hljs-comment">// 水平</span>
      [[-<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>], [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>]],  <span class="hljs-comment">// 主对角线</span>
      [[-<span class="hljs-number">1</span>, <span class="hljs-number">1</span>], [<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>]]   <span class="hljs-comment">// 副对角线</span>
    ]

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> direction <span class="hljs-keyword">of</span> directions) {
      <span class="hljs-keyword">let</span> count = <span class="hljs-number">1</span>
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; direction.<span class="hljs-property">length</span>; i++) {
        <span class="hljs-keyword">let</span> dx = direction[i][<span class="hljs-number">0</span>]
        <span class="hljs-keyword">let</span> dy = direction[i][<span class="hljs-number">1</span>]
        <span class="hljs-keyword">let</span> x = row + dx
        <span class="hljs-keyword">let</span> y = col + dy
        <span class="hljs-keyword">while</span> (x &gt;= <span class="hljs-number">0</span> &amp;&amp; x &lt; <span class="hljs-number">15</span> &amp;&amp; y &gt;= <span class="hljs-number">0</span> &amp;&amp; y &lt; <span class="hljs-number">15</span> &amp;&amp;
          board[x][y] === <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentPlayer</span>) {
          count++
          x += dx
          y += dy
        }
      }
      <span class="hljs-keyword">if</span> (count &gt;= <span class="hljs-number">5</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }

  <span class="hljs-comment">// 重新开始</span>
  <span class="hljs-title function_">resetGame</span>():<span class="hljs-built_in">number</span>[][] {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentPlayer</span> = <span class="hljs-number">1</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">gameOver</span> = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">sourceData</span>()
  }

  <span class="hljs-comment">// 数据源</span>
  <span class="hljs-title function_">sourceData</span>():<span class="hljs-built_in">number</span>[][] {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">15</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-literal">null</span>).<span class="hljs-title function_">map</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Array</span>(<span class="hljs-number">15</span>).<span class="hljs-title function_">fill</span>(<span class="hljs-number">0</span>))
  }
}
</code></pre>
<p>ets/pages/gobang/05-封装.ets</p>
<pre><code class="hljs language-scss" lang="scss">import { Control } from './Control'

<span class="hljs-keyword">@Entry</span>
<span class="hljs-keyword">@Component</span>
struct Study {

  private control1 = new <span class="hljs-built_in">Control</span>()
  <span class="hljs-keyword">@State</span> board1: number[][] = this.control1.sourceData()

  private control2 = new Control()
  <span class="hljs-keyword">@State</span> board2: number[][] = this.control2.sourceData()

  build() {
    <span class="hljs-built_in">Column</span>() {
      <span class="hljs-comment">// 棋盘1</span>
      <span class="hljs-built_in">Column</span>() {
        <span class="hljs-comment">// 行</span>
        <span class="hljs-built_in">ForEach</span>(this.board1, (row: number[], rowIndex:number) =&gt; {
          <span class="hljs-built_in">Row</span>() {
            <span class="hljs-built_in">ForEach</span>(row, (cell: number, colIndex:number) =&gt; {
              <span class="hljs-comment">// 列</span>
              <span class="hljs-built_in">Column</span>() {
                if (cell) {
                  Text()<span class="hljs-selector-class">.width</span>(<span class="hljs-number">18</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">18</span>)<span class="hljs-selector-class">.backgroundColor</span>(cell === <span class="hljs-number">1</span> ? '#<span class="hljs-number">000</span>' : '#fff')<span class="hljs-selector-class">.borderRadius</span>(<span class="hljs-number">9</span>)
                }
              }
              <span class="hljs-selector-class">.width</span>(<span class="hljs-number">20</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">20</span>)<span class="hljs-selector-class">.backgroundColor</span>('#DEB887')
              <span class="hljs-selector-class">.border</span>({ width: <span class="hljs-number">1</span>, color: '#<span class="hljs-number">999</span>' })
              <span class="hljs-selector-class">.onClick</span>(() =&gt; {
                const data = this<span class="hljs-selector-class">.control1</span><span class="hljs-selector-class">.playChess</span>(this.board1, rowIndex, colIndex)
                if (data) this<span class="hljs-selector-class">.board1</span> = data
              })
            })
          }
        })
        <span class="hljs-selector-tag">Button</span>('重新开始')<span class="hljs-selector-class">.onClick</span>(() =&gt; this<span class="hljs-selector-class">.board1</span> = this<span class="hljs-selector-class">.control1</span><span class="hljs-selector-class">.resetGame</span>())
      }<span class="hljs-selector-class">.margin</span>(<span class="hljs-number">10</span>)

      <span class="hljs-comment">// 棋盘2</span>
      <span class="hljs-built_in">Column</span>() {
        <span class="hljs-comment">// 行</span>
        <span class="hljs-built_in">ForEach</span>(this.board2, (row: number[], rowIndex:number) =&gt; {
          <span class="hljs-built_in">Row</span>() {
            <span class="hljs-built_in">ForEach</span>(row, (cell: number, colIndex:number) =&gt; {
              <span class="hljs-comment">// 列</span>
              <span class="hljs-built_in">Column</span>() {
                if (cell) {
                  Text()<span class="hljs-selector-class">.width</span>(<span class="hljs-number">18</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">18</span>)<span class="hljs-selector-class">.backgroundColor</span>(cell === <span class="hljs-number">1</span> ? '#<span class="hljs-number">000</span>' : '#fff')<span class="hljs-selector-class">.borderRadius</span>(<span class="hljs-number">9</span>)
                }
              }
              <span class="hljs-selector-class">.width</span>(<span class="hljs-number">20</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">20</span>)<span class="hljs-selector-class">.backgroundColor</span>('#DEB887')
              <span class="hljs-selector-class">.border</span>({ width: <span class="hljs-number">1</span>, color: '#<span class="hljs-number">999</span>' })
              <span class="hljs-selector-class">.onClick</span>(() =&gt; {
                const data = this<span class="hljs-selector-class">.control2</span><span class="hljs-selector-class">.playChess</span>(this.board2, rowIndex, colIndex)
                if (data) this<span class="hljs-selector-class">.board2</span> = data
              })
            })
          }
        })
        <span class="hljs-selector-tag">Button</span>('重新开始')<span class="hljs-selector-class">.onClick</span>(() =&gt; this<span class="hljs-selector-class">.board2</span> = this<span class="hljs-selector-class">.control2</span><span class="hljs-selector-class">.resetGame</span>())
      }<span class="hljs-selector-class">.margin</span>(<span class="hljs-number">10</span>)
    }<span class="hljs-selector-class">.padding</span>(<span class="hljs-number">20</span>)
  }
}
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F0a0a956faec348ddaa9b2676a3f19545%3Ftype%3D1%3Fha_source%3Dhmosclass%26ha_sourceId%3D89000248" title="https://developer.huawei.com/consumer/cn/training/classDetail/0a0a956faec348ddaa9b2676a3f19545?type=1?ha_source=hmosclass&amp;ha_sourceId=89000248" target="_blank" ref="nofollow noopener noreferrer">鸿蒙开发者班级</a></p>
<p>✨家人们点个账号关注，会持续发布大前端领域技术文章💕 🍃</p>
<p>✨家人们点个账号关注，会持续发布大前端领域技术文章💕 🍃</p>
<p>✨家人们点个账号关注，会持续发布大前端领域技术文章💕 🍃</p>
<p>    ^_^ 点关注、不迷路、主播带你学技术 (๑′ᴗ‵๑)Ｉ Lᵒᵛᵉᵧₒᵤ❤</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS 内存管理深度解析：从原理到实践]]></title>    <link>https://juejin.cn/post/7576573061581045801</link>    <guid>https://juejin.cn/post/7576573061581045801</guid>    <pubDate>2025-11-26T03:37:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576573061581045801" data-draft-id="7576646533614403638" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS 内存管理深度解析：从原理到实践"/> <meta itemprop="keywords" content="iOS"/> <meta itemprop="datePublished" content="2025-11-26T03:37:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Sheffi"/> <meta itemprop="url" content="https://juejin.cn/user/1486195449411421"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS 内存管理深度解析：从原理到实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1486195449411421/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Sheffi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T03:37:28.000Z" title="Wed Nov 26 2025 03:37:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>内存管理是 iOS 开发中最核心的知识点之一，理解透彻的内存管理机制不仅能帮助我们写出高质量的代码，还能有效避免内存泄漏、野指针等常见问题。本文将从底层原理到实际应用，全面剖析 iOS 的内存管理机制。</p>
<hr/>
<h2 data-id="heading-1">一、内存管理的演进历程</h2>
<h3 data-id="heading-2">1.1 MRC 时代（Manual Reference Counting）</h3>
<p>在 iOS 5 之前，开发者需要手动管理对象的生命周期：</p>
<pre><code class="hljs language-objc" lang="objc"><span class="hljs-comment">// MRC 时代的内存管理</span>
<span class="hljs-built_in">NSObject</span> *obj = [[<span class="hljs-built_in">NSObject</span> alloc] init]; <span class="hljs-comment">// retainCount = 1</span>
[obj <span class="hljs-keyword">retain</span>];                             <span class="hljs-comment">// retainCount = 2</span>
[obj release];                            <span class="hljs-comment">// retainCount = 1</span>
[obj release];                            <span class="hljs-comment">// retainCount = 0，对象被销毁</span>
</code></pre>
<p><strong>黄金法则</strong>：谁创建（alloc/new/copy/mutableCopy），谁释放（release）。</p>
<h3 data-id="heading-3">1.2 ARC 时代（Automatic Reference Counting）</h3>
<p>iOS 5 引入 ARC 后，编译器自动在适当位置插入 retain/release 代码：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// ARC 时代 - 编译器自动管理</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">createObject</span>() {
    <span class="hljs-keyword">let</span> obj <span class="hljs-operator">=</span> <span class="hljs-type">MyClass</span>()  <span class="hljs-comment">// 编译器插入 retain</span>
    <span class="hljs-comment">// 使用 obj</span>
}  <span class="hljs-comment">// 函数结束，编译器插入 release</span>
</code></pre>
<blockquote>
<p>⚠️ <strong>重要提示</strong>：ARC 不是垃圾回收（GC），它是编译时特性，不会带来运行时开销。</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">二、引用计数的底层实现</h2>
<h3 data-id="heading-5">2.1 isa 指针与 SideTable</h3>
<p>在 64 位系统中，苹果对 isa 指针进行了优化，采用了 <strong>Non-pointer isa</strong> 结构：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">┌─────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                        <span class="hljs-string">isa</span> <span class="hljs-string">指针结构（64位）</span>                       <span class="hljs-string">│</span>
<span class="hljs-string">├─────────────────────────────────────────────────────────────────┤</span>
<span class="hljs-string">│</span> <span class="hljs-number">0</span>      <span class="hljs-string">│</span> <span class="hljs-string">indexed</span>      <span class="hljs-string">│</span> <span class="hljs-attr">0:</span> <span class="hljs-string">纯指针</span>  <span class="hljs-attr">1:</span> <span class="hljs-string">优化的isa</span>              <span class="hljs-string">│</span>
<span class="hljs-string">│</span> <span class="hljs-number">1</span>      <span class="hljs-string">│</span> <span class="hljs-string">has_assoc</span>    <span class="hljs-string">│</span> <span class="hljs-string">是否有关联对象</span>                        <span class="hljs-string">│</span>
<span class="hljs-string">│</span> <span class="hljs-number">2</span>      <span class="hljs-string">│</span> <span class="hljs-string">has_cxx_dtor</span> <span class="hljs-string">│</span> <span class="hljs-string">是否有C++析构函数</span>                     <span class="hljs-string">│</span>
<span class="hljs-string">│</span> <span class="hljs-number">3</span><span class="hljs-number">-35</span>   <span class="hljs-string">│</span> <span class="hljs-string">shiftcls</span>     <span class="hljs-string">│</span> <span class="hljs-string">类指针（33位）</span>                        <span class="hljs-string">│</span>
<span class="hljs-string">│</span> <span class="hljs-number">36</span><span class="hljs-number">-41</span>  <span class="hljs-string">│</span> <span class="hljs-string">magic</span>        <span class="hljs-string">│</span> <span class="hljs-string">用于调试</span>                             <span class="hljs-string">│</span>
<span class="hljs-string">│</span> <span class="hljs-number">42</span>     <span class="hljs-string">│</span> <span class="hljs-string">weakly_ref</span>   <span class="hljs-string">│</span> <span class="hljs-string">是否有弱引用</span>                          <span class="hljs-string">│</span>
<span class="hljs-string">│</span> <span class="hljs-number">43</span>     <span class="hljs-string">│</span> <span class="hljs-string">deallocating</span> <span class="hljs-string">│</span> <span class="hljs-string">是否正在释放</span>                          <span class="hljs-string">│</span>
<span class="hljs-string">│</span> <span class="hljs-number">44</span>     <span class="hljs-string">│</span> <span class="hljs-string">has_sidetable│</span> <span class="hljs-string">引用计数是否存储在SideTable</span>           <span class="hljs-string">│</span>
<span class="hljs-string">│</span> <span class="hljs-number">45</span><span class="hljs-number">-63</span>  <span class="hljs-string">│</span> <span class="hljs-string">extra_rc</span>     <span class="hljs-string">│</span> <span class="hljs-string">额外的引用计数（19位）</span>                 <span class="hljs-string">│</span>
<span class="hljs-string">└─────────────────────────────────────────────────────────────────┘</span>
</code></pre>
<h3 data-id="heading-6">2.2 SideTable 结构</h3>
<p>当引用计数超出 isa 的存储范围时，会使用 SideTable：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">SideTable</span> {
    <span class="hljs-type">spinlock_t</span> slock;           <span class="hljs-comment">// 自旋锁，保证线程安全</span>
    RefcountMap refcnts;        <span class="hljs-comment">// 引用计数表（哈希表）</span>
    <span class="hljs-type">weak_table_t</span> weak_table;    <span class="hljs-comment">// 弱引用表</span>
};
</code></pre>
<p>系统维护了一个 <strong>SideTables 哈希表</strong>，通过对象地址快速定位到对应的 SideTable：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 获取对象的引用计数</span>
<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> RefcountMap::iterator 
<span class="hljs-title">getRefcountMap</span><span class="hljs-params">(objc_object *obj)</span> </span>{
    SideTable&amp; table = <span class="hljs-built_in">SideTables</span>()[obj];
    <span class="hljs-keyword">return</span> table.refcnts.<span class="hljs-built_in">find</span>(obj);
}
</code></pre>
<h3 data-id="heading-7">2.3 retain 和 release 的源码分析</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// objc_object::retain() 简化实现</span>
<span class="hljs-function">id <span class="hljs-title">objc_object::retain</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 1. TaggedPointer 直接返回</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isTaggedPointer</span>()) <span class="hljs-keyword">return</span> (id)<span class="hljs-keyword">this</span>;
    
    <span class="hljs-comment">// 2. 尝试在 isa 的 extra_rc 中增加引用计数</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">fastpath</span>(!<span class="hljs-built_in">ISA</span>()-&gt;<span class="hljs-built_in">hasCustomRR</span>())) {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">fastpath</span>(bits.extra_rc++ &lt; RC_HALF)) {
            <span class="hljs-keyword">return</span> (id)<span class="hljs-keyword">this</span>;
        }
    }
    
    <span class="hljs-comment">// 3. extra_rc 溢出，转移到 SideTable</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">sidetable_retain</span>();
}
</code></pre>
<hr/>
<h2 data-id="heading-8">三、四种引用类型详解</h2>
<h3 data-id="heading-9">3.1 Strong（强引用）</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
    <span class="hljs-keyword">var</span> name: <span class="hljs-type">String</span>
    <span class="hljs-keyword">var</span> apartment: <span class="hljs-type">Apartment</span>?  <span class="hljs-comment">// 强引用</span>
    
    <span class="hljs-keyword">init</span>(<span class="hljs-params">name</span>: <span class="hljs-type">String</span>) {
        <span class="hljs-keyword">self</span>.name <span class="hljs-operator">=</span> name
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"<span class="hljs-subst">\(name)</span> is initialized"</span>)
    }
    
    <span class="hljs-keyword">deinit</span> {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"<span class="hljs-subst">\(name)</span> is deinitialized"</span>)
    }
}
</code></pre>
<h3 data-id="heading-10">3.2 Weak（弱引用）</h3>
<p>弱引用不会增加引用计数，对象释放时自动置为 nil：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Apartment</span> {
    <span class="hljs-keyword">let</span> unit: <span class="hljs-type">String</span>
    <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> tenant: <span class="hljs-type">Person</span>?  <span class="hljs-comment">// 弱引用，避免循环引用</span>
    
    <span class="hljs-keyword">init</span>(<span class="hljs-params">unit</span>: <span class="hljs-type">String</span>) {
        <span class="hljs-keyword">self</span>.unit <span class="hljs-operator">=</span> unit
    }
}
</code></pre>
<p><strong>弱引用的底层实现</strong>：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// weak_table_t 结构</span>
<span class="hljs-keyword">struct</span> <span class="hljs-title class_">weak_table_t</span> {
    <span class="hljs-type">weak_entry_t</span> *weak_entries;  <span class="hljs-comment">// 弱引用入口数组</span>
    <span class="hljs-type">size_t</span>    num_entries;        <span class="hljs-comment">// 弱引用数量</span>
    <span class="hljs-type">uintptr_t</span> mask;               <span class="hljs-comment">// 哈希掩码</span>
    <span class="hljs-type">uintptr_t</span> max_hash_displacement; <span class="hljs-comment">// 最大哈希偏移</span>
};

<span class="hljs-comment">// 当对象被释放时，清理所有弱引用</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">weak_clear_no_lock</span><span class="hljs-params">(<span class="hljs-type">weak_table_t</span> *weak_table, id referent)</span> </span>{
    <span class="hljs-type">weak_entry_t</span> *entry = <span class="hljs-built_in">weak_entry_for_referent</span>(weak_table, referent);
    <span class="hljs-keyword">if</span> (entry == nil) <span class="hljs-keyword">return</span>;
    
    <span class="hljs-comment">// 将所有指向该对象的弱引用置为 nil</span>
    <span class="hljs-type">weak_referrer_t</span> *referrers = entry-&gt;referrers;
    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; entry-&gt;num_refs; i++) {
        *referrers[i] = nil;
    }
    
    <span class="hljs-built_in">weak_entry_remove</span>(weak_table, entry);
}
</code></pre>
<h3 data-id="heading-11">3.3 Unowned（无主引用）</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Customer</span> {
    <span class="hljs-keyword">let</span> name: <span class="hljs-type">String</span>
    <span class="hljs-keyword">var</span> card: <span class="hljs-type">CreditCard</span>?
    
    <span class="hljs-keyword">init</span>(<span class="hljs-params">name</span>: <span class="hljs-type">String</span>) {
        <span class="hljs-keyword">self</span>.name <span class="hljs-operator">=</span> name
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">CreditCard</span> {
    <span class="hljs-keyword">let</span> number: <span class="hljs-type">UInt64</span>
    <span class="hljs-keyword">unowned</span> <span class="hljs-keyword">let</span> customer: <span class="hljs-type">Customer</span>  <span class="hljs-comment">// 无主引用</span>
    
    <span class="hljs-keyword">init</span>(<span class="hljs-params">number</span>: <span class="hljs-type">UInt64</span>, <span class="hljs-params">customer</span>: <span class="hljs-type">Customer</span>) {
        <span class="hljs-keyword">self</span>.number <span class="hljs-operator">=</span> number
        <span class="hljs-keyword">self</span>.customer <span class="hljs-operator">=</span> customer
    }
}
</code></pre>



































<table><thead><tr><th>特性</th><th>weak</th><th>unowned</th></tr></thead><tbody><tr><td>引用计数</td><td>不增加</td><td>不增加</td></tr><tr><td>对象释放时</td><td>自动置 nil</td><td>不处理（悬垂指针）</td></tr><tr><td>声明类型</td><td>Optional</td><td>Non-optional</td></tr><tr><td>性能</td><td>略低（需维护weak表）</td><td>较高</td></tr><tr><td>安全性</td><td>安全</td><td>需保证生命周期</td></tr></tbody></table>
<h3 data-id="heading-12">3.4 闭包中的引用</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">HTMLElement</span> {
    <span class="hljs-keyword">let</span> name: <span class="hljs-type">String</span>
    <span class="hljs-keyword">let</span> text: <span class="hljs-type">String</span>?
    
    <span class="hljs-comment">// ❌ 循环引用</span>
    <span class="hljs-keyword">lazy</span> <span class="hljs-keyword">var</span> asHTML: () -&gt; <span class="hljs-type">String</span> <span class="hljs-operator">=</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"&lt;<span class="hljs-subst">\(<span class="hljs-keyword">self</span>.name)</span>&gt;<span class="hljs-subst">\(<span class="hljs-keyword">self</span>.text <span class="hljs-operator">??</span> <span class="hljs-string">""</span>)</span>&lt;/<span class="hljs-subst">\(<span class="hljs-keyword">self</span>.name)</span>&gt;"</span>
    }
    
    <span class="hljs-comment">// ✅ 使用捕获列表打破循环</span>
    <span class="hljs-keyword">lazy</span> <span class="hljs-keyword">var</span> asHTMLFixed: () -&gt; <span class="hljs-type">String</span> <span class="hljs-operator">=</span> { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">in</span>
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> <span class="hljs-keyword">self</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span> <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> <span class="hljs-string">""</span> }
        <span class="hljs-keyword">return</span> <span class="hljs-string">"&lt;<span class="hljs-subst">\(<span class="hljs-keyword">self</span>.name)</span>&gt;<span class="hljs-subst">\(<span class="hljs-keyword">self</span>.text <span class="hljs-operator">??</span> <span class="hljs-string">""</span>)</span>&lt;/<span class="hljs-subst">\(<span class="hljs-keyword">self</span>.name)</span>&gt;"</span>
    }
    
    <span class="hljs-comment">// ✅ 或使用 unowned（确保闭包执行时 self 存在）</span>
    <span class="hljs-keyword">lazy</span> <span class="hljs-keyword">var</span> asHTMLUnowned: () -&gt; <span class="hljs-type">String</span> <span class="hljs-operator">=</span> { [<span class="hljs-keyword">unowned</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">in</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"&lt;<span class="hljs-subst">\(<span class="hljs-keyword">self</span>.name)</span>&gt;<span class="hljs-subst">\(<span class="hljs-keyword">self</span>.text <span class="hljs-operator">??</span> <span class="hljs-string">""</span>)</span>&lt;/<span class="hljs-subst">\(<span class="hljs-keyword">self</span>.name)</span>&gt;"</span>
    }
    
    <span class="hljs-keyword">init</span>(<span class="hljs-params">name</span>: <span class="hljs-type">String</span>, <span class="hljs-params">text</span>: <span class="hljs-type">String</span>? <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span>) {
        <span class="hljs-keyword">self</span>.name <span class="hljs-operator">=</span> name
        <span class="hljs-keyword">self</span>.text <span class="hljs-operator">=</span> text
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-13">四、常见内存问题与解决方案</h2>
<h3 data-id="heading-14">4.1 循环引用</h3>
<h4 data-id="heading-15">场景一：Delegate 模式</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// ❌ 错误示例</span>
<span class="hljs-keyword">protocol</span> <span class="hljs-title class_">DownloadDelegate</span>: <span class="hljs-title class_">AnyObject</span> {  <span class="hljs-comment">// 注意这里必须用 AnyObject</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">downloadDidComplete</span>()
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DownloadManager</span> {
    <span class="hljs-keyword">var</span> delegate: <span class="hljs-type">DownloadDelegate</span>?  <span class="hljs-comment">// ❌ 强引用导致循环</span>
}

<span class="hljs-comment">// ✅ 正确示例</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">DownloadManager</span> {
    <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> delegate: <span class="hljs-type">DownloadDelegate</span>?  <span class="hljs-comment">// ✅ 弱引用</span>
}
</code></pre>
<h4 data-id="heading-16">场景二：闭包捕获</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">NetworkManager</span> {
    <span class="hljs-keyword">var</span> completionHandler: (() -&gt; <span class="hljs-type">Void</span>)<span class="hljs-operator">?</span>
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">fetchData</span>() {
        <span class="hljs-comment">// ❌ 循环引用</span>
        completionHandler <span class="hljs-operator">=</span> {
            <span class="hljs-keyword">self</span>.handleData()
        }
        
        <span class="hljs-comment">// ✅ 解决方案1：weak</span>
        completionHandler <span class="hljs-operator">=</span> { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.handleData()
        }
        
        <span class="hljs-comment">// ✅ 解决方案2：在不需要时置空</span>
        <span class="hljs-keyword">defer</span> { completionHandler <span class="hljs-operator">=</span> <span class="hljs-literal">nil</span> }
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">handleData</span>() {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"Handle data"</span>)
    }
}
</code></pre>
<h4 data-id="heading-17">场景三：Timer</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">TimerHolder</span> {
    <span class="hljs-keyword">var</span> timer: <span class="hljs-type">Timer</span>?
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">startTimer</span>() {
        <span class="hljs-comment">// ❌ Timer 对 target 强引用</span>
        timer <span class="hljs-operator">=</span> <span class="hljs-type">Timer</span>.scheduledTimer(
            timeInterval: <span class="hljs-number">1.0</span>,
            target: <span class="hljs-keyword">self</span>,
            selector: <span class="hljs-keyword">#selector</span>(tick),
            userInfo: <span class="hljs-literal">nil</span>,
            repeats: <span class="hljs-literal">true</span>
        )
        
        <span class="hljs-comment">// ✅ 解决方案：使用 block API</span>
        timer <span class="hljs-operator">=</span> <span class="hljs-type">Timer</span>.scheduledTimer(withTimeInterval: <span class="hljs-number">1.0</span>, repeats: <span class="hljs-literal">true</span>) { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">_</span> <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">self</span><span class="hljs-operator">?</span>.tick()
        }
    }
    
    <span class="hljs-keyword">@objc</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">tick</span>() {
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"Tick"</span>)
    }
    
    <span class="hljs-keyword">deinit</span> {
        timer<span class="hljs-operator">?</span>.invalidate()
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"TimerHolder deinit"</span>)
    }
}
</code></pre>
<h3 data-id="heading-18">4.2 内存泄漏检测</h3>
<h4 data-id="heading-19">使用 Instruments - Leaks</h4>
<pre><code class="hljs language-markdown" lang="markdown">步骤：
<span class="hljs-bullet">1.</span> Xcode -&gt; Product -&gt; Profile (⌘I)
<span class="hljs-bullet">2.</span> 选择 Leaks
<span class="hljs-bullet">3.</span> 运行并操作 App
<span class="hljs-bullet">4.</span> 查看泄漏点和调用栈
</code></pre>
<h4 data-id="heading-20">使用 Debug Memory Graph</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 在特定点触发内存警告，观察对象是否正确释放</span>
<span class="hljs-keyword">#if</span> <span class="hljs-type">DEBUG</span>
<span class="hljs-keyword">extension</span> <span class="hljs-title class_">UIViewController</span> {
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">checkMemoryLeak</span>() {
        <span class="hljs-type">DispatchQueue</span>.main.asyncAfter(deadline: .now() <span class="hljs-operator">+</span> <span class="hljs-number">2</span>) { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">if</span> <span class="hljs-keyword">self</span> <span class="hljs-operator">!=</span> <span class="hljs-literal">nil</span> {
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"⚠️ 可能存在内存泄漏: <span class="hljs-subst">\(<span class="hljs-built_in">type</span>(of: <span class="hljs-keyword">self</span><span class="hljs-operator">!</span>))</span>"</span>)
            }
        }
    }
}
<span class="hljs-keyword">#endif</span>
</code></pre>
<h4 data-id="heading-21">自定义泄漏检测工具</h4>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LeakDetector</span> {
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> shared <span class="hljs-operator">=</span> <span class="hljs-type">LeakDetector</span>()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> trackedObjects: [<span class="hljs-type">ObjectIdentifier</span>: <span class="hljs-type">WeakBox</span>&lt;<span class="hljs-type">AnyObject</span>&gt;] <span class="hljs-operator">=</span> [:]
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> queue <span class="hljs-operator">=</span> <span class="hljs-type">DispatchQueue</span>(label: <span class="hljs-string">"com.app.leakdetector"</span>)
    
    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">WeakBox</span>&lt;<span class="hljs-title class_">T</span>: <span class="hljs-title class_">AnyObject</span>&gt; {
        <span class="hljs-keyword">weak</span> <span class="hljs-keyword">var</span> value: <span class="hljs-type">T</span>?
        <span class="hljs-keyword">let</span> className: <span class="hljs-type">String</span>
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">track</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">object</span>: <span class="hljs-type">AnyObject</span>, <span class="hljs-params">file</span>: <span class="hljs-type">String</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">#file</span>, <span class="hljs-params">line</span>: <span class="hljs-type">Int</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">#line</span>) {
        <span class="hljs-keyword">let</span> id <span class="hljs-operator">=</span> <span class="hljs-type">ObjectIdentifier</span>(object)
        <span class="hljs-keyword">let</span> className <span class="hljs-operator">=</span> <span class="hljs-type">String</span>(describing: <span class="hljs-built_in">type</span>(of: object))
        
        queue.async {
            <span class="hljs-keyword">self</span>.trackedObjects[id] <span class="hljs-operator">=</span> <span class="hljs-type">WeakBox</span>(value: object, className: className)
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"📍 Tracking: <span class="hljs-subst">\(className)</span> at <span class="hljs-subst">\(file)</span>:<span class="hljs-subst">\(line)</span>"</span>)
        }
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">checkLeaks</span>() {
        queue.async {
            <span class="hljs-keyword">for</span> (id, box) <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.trackedObjects {
                <span class="hljs-keyword">if</span> box.value <span class="hljs-operator">!=</span> <span class="hljs-literal">nil</span> {
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">"⚠️ Potential leak: <span class="hljs-subst">\(box.className)</span>"</span>)
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">self</span>.trackedObjects.removeValue(forKey: id)
                }
            }
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-22">五、Autorelease Pool 深度解析</h2>
<h3 data-id="heading-23">5.1 工作原理</h3>
<pre><code class="hljs language-scss" lang="scss">┌──────────────────────────────────────────────────────────────────┐
│                    Autorelease Pool 结构                          │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐            │
│   │   Page <span class="hljs-number">1</span>    │──&gt;│   Page <span class="hljs-number">2</span>    │──&gt;│   Page <span class="hljs-number">3</span>    │            │
│   │  (<span class="hljs-number">4096</span> B)   │   │  (<span class="hljs-number">4096</span> B)   │   │  (<span class="hljs-number">4096</span> B)   │            │
│   └─────────────┘   └─────────────┘   └─────────────┘            │
│         │                 │                 │                     │
│         ▼                 ▼                 ▼                     │
│   ┌───────────┐     ┌───────────┐     ┌───────────┐              │
│   │  obj1     │     │  obj5     │     │  obj9     │              │
│   │  obj2     │     │  obj6     │     │  obj10    │              │
│   │  obj3     │     │  obj7     │     │  ...      │              │
│   │  obj4     │     │  obj8     │     │           │              │
│   │ SENTINEL  │     │           │     │           │              │
│   └───────────┘     └───────────┘     └───────────┘              │
│                                              ▲                    │
│                                              │                    │
│                                           hotPage                 │
│                                          (当前页)                  │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-24">5.2 源码分析</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">AutoreleasePoolPage</span> {
    <span class="hljs-type">static</span> <span class="hljs-type">size_t</span> <span class="hljs-type">const</span> SIZE = PAGE_MAX_SIZE;  <span class="hljs-comment">// 4096 bytes</span>
    <span class="hljs-type">static</span> <span class="hljs-type">size_t</span> <span class="hljs-type">const</span> COUNT = SIZE / <span class="hljs-built_in">sizeof</span>(id);
    
    <span class="hljs-type">magic_t</span> <span class="hljs-type">const</span> magic;
    id *next;                    <span class="hljs-comment">// 下一个可存放对象的位置</span>
    <span class="hljs-type">pthread_t</span> <span class="hljs-type">const</span> thread;      <span class="hljs-comment">// 所属线程</span>
    AutoreleasePoolPage *parent; <span class="hljs-comment">// 父节点</span>
    AutoreleasePoolPage *child;  <span class="hljs-comment">// 子节点</span>
    <span class="hljs-type">uint32_t</span> depth;              <span class="hljs-comment">// 深度</span>
    
    <span class="hljs-comment">// 添加对象到 pool</span>
    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> id *<span class="hljs-title">autoreleaseFast</span><span class="hljs-params">(id obj)</span> </span>{
        AutoreleasePoolPage *page = <span class="hljs-built_in">hotPage</span>();
        <span class="hljs-keyword">if</span> (page &amp;&amp; !page-&gt;<span class="hljs-built_in">full</span>()) {
            <span class="hljs-keyword">return</span> page-&gt;<span class="hljs-built_in">add</span>(obj);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">autoreleaseFullPage</span>(obj, page);
    }
    
    <span class="hljs-comment">// Pool 的 pop 操作</span>
    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-keyword">inline</span> <span class="hljs-type">void</span> <span class="hljs-title">pop</span><span class="hljs-params">(<span class="hljs-type">void</span> *token)</span> </span>{
        AutoreleasePoolPage *page = <span class="hljs-built_in">pageForPointer</span>(token);
        id *stop = (id *)token;
        
        <span class="hljs-comment">// 释放对象</span>
        page-&gt;<span class="hljs-built_in">releaseUntil</span>(stop);
        
        <span class="hljs-comment">// 删除空页</span>
        <span class="hljs-keyword">if</span> (page-&gt;child) {
            page-&gt;child-&gt;<span class="hljs-built_in">kill</span>();
            page-&gt;child = nil;
        }
    }
};
</code></pre>
<h3 data-id="heading-25">5.3 主线程 RunLoop 与 Autorelease Pool</h3>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">┌──────────────────────────────────────────────────────────────────┐</span>
<span class="hljs-string">│</span>                    <span class="hljs-string">RunLoop</span> <span class="hljs-string">与</span> <span class="hljs-string">AutoreleasePool</span>                     <span class="hljs-string">│</span>
<span class="hljs-string">├──────────────────────────────────────────────────────────────────┤</span>
<span class="hljs-string">│</span>                                                                   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">┌─────────────────────────────────────────────────────────┐</span>    <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>                     <span class="hljs-string">Main</span> <span class="hljs-string">RunLoop</span>                         <span class="hljs-string">│</span>    <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">└─────────────────────────────────────────────────────────┘</span>    <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                              <span class="hljs-string">│</span>                                    <span class="hljs-string">│</span>
<span class="hljs-string">│</span>        <span class="hljs-string">┌─────────────────────┼─────────────────────┐</span>             <span class="hljs-string">│</span>
<span class="hljs-string">│</span>        <span class="hljs-string">▼</span>                     <span class="hljs-string">▼</span>                     <span class="hljs-string">▼</span>             <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">┌─────────┐</span>          <span class="hljs-string">┌─────────┐</span>          <span class="hljs-string">┌─────────┐</span>         <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>  <span class="hljs-string">Entry</span>  <span class="hljs-string">│</span>          <span class="hljs-string">│</span> <span class="hljs-string">Before</span>  <span class="hljs-string">│</span>          <span class="hljs-string">│</span>  <span class="hljs-string">Exit</span>   <span class="hljs-string">│</span>         <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span> <span class="hljs-string">(Push)</span>  <span class="hljs-string">│</span>          <span class="hljs-string">│</span> <span class="hljs-string">Waiting</span> <span class="hljs-string">│</span>          <span class="hljs-string">│</span>  <span class="hljs-string">(Pop)</span>  <span class="hljs-string">│</span>         <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span> <span class="hljs-attr">Order:</span>  <span class="hljs-string">│</span>          <span class="hljs-string">│</span> <span class="hljs-string">(Pop</span> <span class="hljs-string">+</span>  <span class="hljs-string">│</span>          <span class="hljs-string">│</span> <span class="hljs-attr">Order:</span>  <span class="hljs-string">│</span>         <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">│</span>  <span class="hljs-string">高优先</span>  <span class="hljs-string">│</span>          <span class="hljs-string">│</span>  <span class="hljs-string">Push)</span>  <span class="hljs-string">│</span>          <span class="hljs-string">│</span>  <span class="hljs-string">低优先</span>  <span class="hljs-string">│</span>         <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">└─────────┘</span>          <span class="hljs-string">└─────────┘</span>          <span class="hljs-string">└─────────┘</span>         <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-string">时机说明：</span>                                                       <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-attr">1. kCFRunLoopEntry:</span> <span class="hljs-string">创建</span> <span class="hljs-string">AutoreleasePool</span> <span class="hljs-string">(push)</span>                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-attr">2. kCFRunLoopBeforeWaiting:</span> <span class="hljs-string">释放旧pool</span> <span class="hljs-string">(pop)，创建新pool</span> <span class="hljs-string">(push)</span> <span class="hljs-string">│</span>
<span class="hljs-string">│</span>   <span class="hljs-attr">3. kCFRunLoopExit:</span> <span class="hljs-string">释放</span> <span class="hljs-string">AutoreleasePool</span> <span class="hljs-string">(pop)</span>                  <span class="hljs-string">│</span>
<span class="hljs-string">│</span>                                                                   <span class="hljs-string">│</span>
<span class="hljs-string">└──────────────────────────────────────────────────────────────────┘</span>
</code></pre>
<h3 data-id="heading-26">5.4 手动使用 Autorelease Pool</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 场景：大量临时对象的循环</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">processLargeData</span>() {
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span><span class="hljs-operator">..&lt;</span><span class="hljs-number">100000</span> {
        <span class="hljs-comment">// ❌ 不使用 autoreleasepool，临时对象会累积</span>
        <span class="hljs-keyword">let</span> data <span class="hljs-operator">=</span> createTemporaryData(index: i)
        process(data)
    }
    
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-number">0</span><span class="hljs-operator">..&lt;</span><span class="hljs-number">100000</span> {
        <span class="hljs-comment">// ✅ 使用 autoreleasepool，每次迭代后释放临时对象</span>
        autoreleasepool {
            <span class="hljs-keyword">let</span> data <span class="hljs-operator">=</span> createTemporaryData(index: i)
            process(data)
        }
    }
    
    <span class="hljs-comment">// ✅ 更优化的方案：批量处理</span>
    <span class="hljs-keyword">let</span> batchSize <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>
    <span class="hljs-keyword">for</span> batch <span class="hljs-keyword">in</span> <span class="hljs-built_in">stride</span>(from: <span class="hljs-number">0</span>, to: <span class="hljs-number">100000</span>, by: batchSize) {
        autoreleasepool {
            <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> batch<span class="hljs-operator">..&lt;</span><span class="hljs-built_in">min</span>(batch <span class="hljs-operator">+</span> batchSize, <span class="hljs-number">100000</span>) {
                <span class="hljs-keyword">let</span> data <span class="hljs-operator">=</span> createTemporaryData(index: i)
                process(data)
            }
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-27">六、Tagged Pointer 优化</h2>
<h3 data-id="heading-28">6.1 什么是 Tagged Pointer</h3>
<p>对于小对象（如小的 NSNumber、NSDate），苹果使用 Tagged Pointer 直接在指针中存储数据：</p>
<pre><code class="hljs language-scss" lang="scss">┌──────────────────────────────────────────────────────────────────┐
│                    Tagged Pointer 结构                            │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│   普通对象指针：                                                   │
│   ┌─────────────────────────────────────────────────────────┐    │
│   │         <span class="hljs-number">64</span>位地址指向堆中的对象                            │    │
│   └─────────────────────────────────────────────────────────┘    │
│                              │                                    │
│                              ▼                                    │
│   ┌─────────────────────────────────────────────────────────┐    │
│   │                    堆中的对象                             │    │
│   │  ┌──────┬──────────┬──────────┬─────────────────────┐   │    │
│   │  │ isa  │ refCount │ 其他信息  │      实际数据       │   │    │
│   │  └──────┴──────────┴──────────┴─────────────────────┘   │    │
│   └─────────────────────────────────────────────────────────┘    │
│                                                                   │
│   Tagged Pointer：                                                │
│   ┌─────────────────────────────────────────────────────────┐    │
│   │ <span class="hljs-number">1</span> │ 类型标记(<span class="hljs-number">3</span>位) │           数据值(<span class="hljs-number">60</span>位)              │    │
│   └─────────────────────────────────────────────────────────┘    │
│     ↑                                                             │
│   标记位(表明这是Tagged Pointer)                                   │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
</code></pre>
<h3 data-id="heading-29">6.2 判断 Tagged Pointer</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// 通过内存地址判断（仅供理解，实际开发中不需要关心）</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">isTaggedPointer</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">obj</span>: <span class="hljs-type">AnyObject</span>) -&gt; <span class="hljs-type">Bool</span> {
    <span class="hljs-keyword">let</span> pointer <span class="hljs-operator">=</span> <span class="hljs-type">Unmanaged</span>.passUnretained(obj).toOpaque()
    <span class="hljs-keyword">let</span> value <span class="hljs-operator">=</span> <span class="hljs-type">UInt</span>(bitPattern: pointer)
    
    <span class="hljs-comment">// 在 arm64 上，最高位为 1 表示 Tagged Pointer</span>
    <span class="hljs-comment">// 在 x86_64 上，最低位为 1 表示 Tagged Pointer</span>
    <span class="hljs-keyword">#if</span> arch(arm64)
    <span class="hljs-keyword">return</span> (value <span class="hljs-operator">&gt;&gt;</span> <span class="hljs-number">63</span>) <span class="hljs-operator">==</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">#else</span>
    <span class="hljs-keyword">return</span> (value <span class="hljs-operator">&amp;</span> <span class="hljs-number">1</span>) <span class="hljs-operator">==</span> <span class="hljs-number">1</span>
    <span class="hljs-keyword">#endif</span>
}
</code></pre>
<h3 data-id="heading-30">6.3 性能优势</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-comment">// Tagged Pointer 的优势演示</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">performanceTest</span>() {
    <span class="hljs-keyword">let</span> iterations <span class="hljs-operator">=</span> <span class="hljs-number">1_000_000</span>
    
    <span class="hljs-comment">// 小数字 - 使用 Tagged Pointer</span>
    <span class="hljs-keyword">let</span> start1 <span class="hljs-operator">=</span> <span class="hljs-type">CFAbsoluteTimeGetCurrent</span>()
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">_</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span><span class="hljs-operator">..&lt;</span>iterations {
        <span class="hljs-keyword">let</span> num <span class="hljs-operator">=</span> <span class="hljs-type">NSNumber</span>(value: <span class="hljs-number">42</span>)  <span class="hljs-comment">// Tagged Pointer</span>
        <span class="hljs-keyword">_</span> <span class="hljs-operator">=</span> num.intValue
    }
    <span class="hljs-keyword">let</span> time1 <span class="hljs-operator">=</span> <span class="hljs-type">CFAbsoluteTimeGetCurrent</span>() <span class="hljs-operator">-</span> start1
    
    <span class="hljs-comment">// 大数字 - 使用普通对象</span>
    <span class="hljs-keyword">let</span> start2 <span class="hljs-operator">=</span> <span class="hljs-type">CFAbsoluteTimeGetCurrent</span>()
    <span class="hljs-keyword">for</span> <span class="hljs-keyword">_</span> <span class="hljs-keyword">in</span> <span class="hljs-number">0</span><span class="hljs-operator">..&lt;</span>iterations {
        <span class="hljs-keyword">let</span> num <span class="hljs-operator">=</span> <span class="hljs-type">NSNumber</span>(value: <span class="hljs-type">Int64</span>.max)  <span class="hljs-comment">// 普通对象</span>
        <span class="hljs-keyword">_</span> <span class="hljs-operator">=</span> num.int64Value
    }
    <span class="hljs-keyword">let</span> time2 <span class="hljs-operator">=</span> <span class="hljs-type">CFAbsoluteTimeGetCurrent</span>() <span class="hljs-operator">-</span> start2
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Tagged Pointer: <span class="hljs-subst">\(time1)</span>s"</span>)  <span class="hljs-comment">// 明显更快</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"普通对象: <span class="hljs-subst">\(time2)</span>s"</span>)
}
</code></pre>
<hr/>
<h2 data-id="heading-31">七、实战：内存优化最佳实践</h2>
<h3 data-id="heading-32">7.1 图片内存优化</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ImageLoader</span> {
    <span class="hljs-comment">// 使用 NSCache 自动管理内存</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> cache <span class="hljs-operator">=</span> <span class="hljs-type">NSCache</span>&lt;<span class="hljs-type">NSString</span>, <span class="hljs-type">UIImage</span>&gt;()
    
    <span class="hljs-keyword">init</span>() {
        <span class="hljs-comment">// 设置缓存限制</span>
        cache.countLimit <span class="hljs-operator">=</span> <span class="hljs-number">100</span>
        cache.totalCostLimit <span class="hljs-operator">=</span> <span class="hljs-number">50</span> <span class="hljs-operator">*</span> <span class="hljs-number">1024</span> <span class="hljs-operator">*</span> <span class="hljs-number">1024</span>  <span class="hljs-comment">// 50MB</span>
        
        <span class="hljs-comment">// 监听内存警告</span>
        <span class="hljs-type">NotificationCenter</span>.default.addObserver(
            <span class="hljs-keyword">self</span>,
            selector: <span class="hljs-keyword">#selector</span>(handleMemoryWarning),
            name: <span class="hljs-type">UIApplication</span>.didReceiveMemoryWarningNotification,
            object: <span class="hljs-literal">nil</span>
        )
    }
    
    <span class="hljs-comment">// 下采样加载大图</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">loadDownsampledImage</span>(<span class="hljs-params">at</span> <span class="hljs-params">url</span>: <span class="hljs-type">URL</span>, <span class="hljs-params">targetSize</span>: <span class="hljs-type">CGSize</span>) -&gt; <span class="hljs-type">UIImage</span>? {
        <span class="hljs-keyword">let</span> imageSourceOptions <span class="hljs-operator">=</span> [kCGImageSourceShouldCache: <span class="hljs-literal">false</span>] <span class="hljs-keyword">as</span> <span class="hljs-type">CFDictionary</span>
        
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> imageSource <span class="hljs-operator">=</span> <span class="hljs-type">CGImageSourceCreateWithURL</span>(url <span class="hljs-keyword">as</span> <span class="hljs-type">CFURL</span>, imageSourceOptions) <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
        }
        
        <span class="hljs-keyword">let</span> maxDimension <span class="hljs-operator">=</span> <span class="hljs-built_in">max</span>(targetSize.width, targetSize.height) <span class="hljs-operator">*</span> <span class="hljs-type">UIScreen</span>.main.scale
        <span class="hljs-keyword">let</span> downsampledOptions <span class="hljs-operator">=</span> [
            kCGImageSourceCreateThumbnailFromImageAlways: <span class="hljs-literal">true</span>,
            kCGImageSourceShouldCacheImmediately: <span class="hljs-literal">true</span>,
            kCGImageSourceCreateThumbnailWithTransform: <span class="hljs-literal">true</span>,
            kCGImageSourceThumbnailMaxPixelSize: maxDimension
        ] <span class="hljs-keyword">as</span> <span class="hljs-type">CFDictionary</span>
        
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> downsampledImage <span class="hljs-operator">=</span> <span class="hljs-type">CGImageSourceCreateThumbnailAtIndex</span>(imageSource, <span class="hljs-number">0</span>, downsampledOptions) <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
        }
        
        <span class="hljs-keyword">return</span> <span class="hljs-type">UIImage</span>(cgImage: downsampledImage)
    }
    
    <span class="hljs-keyword">@objc</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">handleMemoryWarning</span>() {
        cache.removeAllObjects()
    }
}
</code></pre>
<h3 data-id="heading-33">7.2 大数据处理</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DataProcessor</span> {
    <span class="hljs-comment">// 分批处理大数组，避免内存峰值</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">processBatched</span>&lt;<span class="hljs-type">T</span>&gt;(<span class="hljs-keyword">_</span> <span class="hljs-params">array</span>: [<span class="hljs-type">T</span>], <span class="hljs-params">batchSize</span>: <span class="hljs-type">Int</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>, <span class="hljs-params">handler</span>: ([<span class="hljs-type">T</span>]) -&gt; <span class="hljs-type">Void</span>) {
        <span class="hljs-keyword">let</span> totalCount <span class="hljs-operator">=</span> array.count
        <span class="hljs-keyword">var</span> processedCount <span class="hljs-operator">=</span> <span class="hljs-number">0</span>
        
        <span class="hljs-keyword">while</span> processedCount <span class="hljs-operator">&lt;</span> totalCount {
            autoreleasepool {
                <span class="hljs-keyword">let</span> endIndex <span class="hljs-operator">=</span> <span class="hljs-built_in">min</span>(processedCount <span class="hljs-operator">+</span> batchSize, totalCount)
                <span class="hljs-keyword">let</span> batch <span class="hljs-operator">=</span> <span class="hljs-type">Array</span>(array[processedCount<span class="hljs-operator">..&lt;</span>endIndex])
                handler(batch)
                processedCount <span class="hljs-operator">=</span> endIndex
            }
        }
    }
    
    <span class="hljs-comment">// 使用流式读取大文件</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">processLargeFile</span>(<span class="hljs-params">at</span> <span class="hljs-params">url</span>: <span class="hljs-type">URL</span>, <span class="hljs-params">lineHandler</span>: (<span class="hljs-type">String</span>) -&gt; <span class="hljs-type">Void</span>) {
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> fileHandle <span class="hljs-operator">=</span> <span class="hljs-keyword">try?</span> <span class="hljs-type">FileHandle</span>(forReadingFrom: url) <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }
        <span class="hljs-keyword">defer</span> { <span class="hljs-keyword">try?</span> fileHandle.close() }
        
        <span class="hljs-keyword">let</span> bufferSize <span class="hljs-operator">=</span> <span class="hljs-number">4096</span>
        <span class="hljs-keyword">var</span> buffer <span class="hljs-operator">=</span> <span class="hljs-type">Data</span>()
        
        <span class="hljs-keyword">while</span> autoreleasepool(invoking: {
            <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> chunk <span class="hljs-operator">=</span> <span class="hljs-keyword">try?</span> fileHandle.read(upToCount: bufferSize), <span class="hljs-operator">!</span>chunk.isEmpty <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
            }
            
            buffer.append(chunk)
            
            <span class="hljs-keyword">while</span> <span class="hljs-keyword">let</span> range <span class="hljs-operator">=</span> buffer.range(of: <span class="hljs-type">Data</span>(<span class="hljs-string">"<span class="hljs-subst">\n</span>"</span>.utf8)) {
                <span class="hljs-keyword">let</span> lineData <span class="hljs-operator">=</span> buffer.subdata(in: <span class="hljs-number">0</span><span class="hljs-operator">..&lt;</span>range.lowerBound)
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> line <span class="hljs-operator">=</span> <span class="hljs-type">String</span>(data: lineData, encoding: .utf8) {
                    lineHandler(line)
                }
                buffer.removeSubrange(<span class="hljs-number">0</span><span class="hljs-operator">..&lt;</span>range.upperBound)
            }
            
            <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
        }) {}
        
        <span class="hljs-comment">// 处理最后一行</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> lastLine <span class="hljs-operator">=</span> <span class="hljs-type">String</span>(data: buffer, encoding: .utf8), <span class="hljs-operator">!</span>lastLine.isEmpty {
            lineHandler(lastLine)
        }
    }
}
</code></pre>
<h3 data-id="heading-34">7.3 ViewController 内存管理</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseViewController</span>: <span class="hljs-title class_">UIViewController</span> {
    <span class="hljs-comment">// 所有需要取消的任务</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> cancellables <span class="hljs-operator">=</span> <span class="hljs-type">Set</span>&lt;<span class="hljs-type">AnyCancellable</span>&gt;()
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> tasks <span class="hljs-operator">=</span> [<span class="hljs-type">Task</span>&lt;<span class="hljs-type">Void</span>, <span class="hljs-type">Never</span>&gt;]()
    
    <span class="hljs-keyword">deinit</span> {
        <span class="hljs-comment">// 取消所有订阅</span>
        cancellables.removeAll()
        
        <span class="hljs-comment">// 取消所有 Task</span>
        tasks.forEach { <span class="hljs-variable">$0</span>.cancel() }
        
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"<span class="hljs-subst">\(<span class="hljs-built_in">type</span>(of: <span class="hljs-keyword">self</span>))</span> deinit"</span>)
    }
    
    <span class="hljs-comment">// 安全地添加通知观察者</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">observe</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">name</span>: <span class="hljs-type">Notification</span>.<span class="hljs-type">Name</span>, <span class="hljs-params">handler</span>: <span class="hljs-keyword">@escaping</span> (<span class="hljs-type">Notification</span>) -&gt; <span class="hljs-type">Void</span>) {
        <span class="hljs-type">NotificationCenter</span>.default.publisher(for: name)
            .sink { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] notification <span class="hljs-keyword">in</span>
                <span class="hljs-keyword">guard</span> <span class="hljs-keyword">self</span> <span class="hljs-operator">!=</span> <span class="hljs-literal">nil</span> <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }
                handler(notification)
            }
            .store(in: <span class="hljs-operator">&amp;</span>cancellables)
    }
    
    <span class="hljs-comment">// 安全地执行异步任务</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">performTask</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">operation</span>: <span class="hljs-keyword">@escaping</span> () <span class="hljs-keyword">async</span> -&gt; <span class="hljs-type">Void</span>) {
        <span class="hljs-keyword">let</span> task <span class="hljs-operator">=</span> <span class="hljs-type">Task</span> { [<span class="hljs-keyword">weak</span> <span class="hljs-keyword">self</span>] <span class="hljs-keyword">in</span>
            <span class="hljs-keyword">guard</span> <span class="hljs-keyword">self</span> <span class="hljs-operator">!=</span> <span class="hljs-literal">nil</span> <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }
            <span class="hljs-keyword">await</span> operation()
        }
        tasks.append(task)
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-35">八、调试技巧</h2>
<h3 data-id="heading-36">8.1 LLDB 命令</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看对象引用计数</span>
(lldb) p CFGetRetainCount(obj as CFTypeRef)

<span class="hljs-comment"># 查看对象的弱引用</span>
(lldb) p _objc_rootRetainCount(obj)

<span class="hljs-comment"># 查看所有内存分配</span>
(lldb) memory <span class="hljs-built_in">history</span> &lt;address&gt;

<span class="hljs-comment"># 查看 Autorelease Pool 中的对象</span>
(lldb) po [NSAutoreleasePool showPools]

<span class="hljs-comment"># 查看对象的 isa 信息</span>
(lldb) p/x (uintptr_t)object_getClass(obj)
</code></pre>
<h3 data-id="heading-37">8.2 环境变量</h3>
<p>在 Scheme 的 Environment Variables 中添加：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">MallocStackLogging</span> = <span class="hljs-number">1</span>          <span class="hljs-comment"># 记录内存分配堆栈</span>
<span class="hljs-attr">MallocStackLoggingNoCompact</span> = <span class="hljs-number">1</span> <span class="hljs-comment"># 不压缩堆栈信息</span>
<span class="hljs-attr">OBJC_DEBUG_POOL_ALLOCATION</span> = <span class="hljs-literal">YES</span> <span class="hljs-comment"># 调试 Autorelease Pool</span>
<span class="hljs-attr">NSZombieEnabled</span> = <span class="hljs-literal">YES</span>           <span class="hljs-comment"># 检测野指针</span>
</code></pre>
<h3 data-id="heading-38">8.3 自定义内存追踪</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">#if</span> <span class="hljs-type">DEBUG</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">MemoryTracker</span> {
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">let</span> shared <span class="hljs-operator">=</span> <span class="hljs-type">MemoryTracker</span>()
    
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> allocations: [<span class="hljs-type">String</span>: <span class="hljs-type">Int</span>] <span class="hljs-operator">=</span> [:]
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> queue <span class="hljs-operator">=</span> <span class="hljs-type">DispatchQueue</span>(label: <span class="hljs-string">"memory.tracker"</span>)
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">trackAlloc</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">className</span>: <span class="hljs-type">String</span>) {
        queue.async {
            <span class="hljs-keyword">self</span>.allocations[className, <span class="hljs-keyword">default</span>: <span class="hljs-number">0</span>] <span class="hljs-operator">+=</span> <span class="hljs-number">1</span>
        }
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">trackDealloc</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">className</span>: <span class="hljs-type">String</span>) {
        queue.async {
            <span class="hljs-keyword">self</span>.allocations[className, <span class="hljs-keyword">default</span>: <span class="hljs-number">0</span>] <span class="hljs-operator">-=</span> <span class="hljs-number">1</span>
        }
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">report</span>() {
        queue.async {
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"=== Memory Report ==="</span>)
            <span class="hljs-keyword">for</span> (className, count) <span class="hljs-keyword">in</span> <span class="hljs-keyword">self</span>.allocations <span class="hljs-keyword">where</span> count <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span> {
                <span class="hljs-built_in">print</span>(<span class="hljs-string">"<span class="hljs-subst">\(className)</span>: <span class="hljs-subst">\(count)</span> instances"</span>)
            }
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"===================="</span>)
        }
    }
}

<span class="hljs-comment">// 使用方式</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">TrackedObject</span> {
    <span class="hljs-keyword">init</span>() {
        <span class="hljs-type">MemoryTracker</span>.shared.trackAlloc(<span class="hljs-type">String</span>(describing: <span class="hljs-keyword">Self</span>.<span class="hljs-keyword">self</span>))
    }
    
    <span class="hljs-keyword">deinit</span> {
        <span class="hljs-type">MemoryTracker</span>.shared.trackDealloc(<span class="hljs-type">String</span>(describing: <span class="hljs-keyword">Self</span>.<span class="hljs-keyword">self</span>))
    }
}
<span class="hljs-keyword">#endif</span>
</code></pre>
<hr/>
<h2 data-id="heading-39">总结</h2>
<p>iOS 内存管理是一个深度话题，本文从以下几个方面进行了详细解析：</p>
<ol>
<li><strong>引用计数原理</strong>：从 MRC 到 ARC 的演进，以及底层 SideTable 的实现</li>
<li><strong>四种引用类型</strong>：strong、weak、unowned 的区别和适用场景</li>
<li><strong>循环引用</strong>：常见场景和解决方案</li>
<li><strong>Autorelease Pool</strong>：工作原理和使用时机</li>
<li><strong>Tagged Pointer</strong>：小对象优化机制</li>
<li><strong>实战优化</strong>：图片处理、大数据处理等场景的最佳实践</li>
<li><strong>调试技巧</strong>：常用的调试命令和工具</li>
</ol>
<hr/>
<h2 data-id="heading-40">参考资料</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fdocumentation%2Fswift%2Fmemory_management" target="_blank" title="https://developer.apple.com/documentation/swift/memory_management" ref="nofollow noopener noreferrer">Apple 官方文档 - Memory Management</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fopensource.apple.com%2Fsource%2Fobjc4%2F" target="_blank" title="https://opensource.apple.com/source/objc4/" ref="nofollow noopener noreferrer">objc4 源码</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Fvideos%2Fplay%2Fwwdc2018%2F416%2F" target="_blank" title="https://developer.apple.com/videos/play/wwdc2018/416/" ref="nofollow noopener noreferrer">WWDC - iOS Memory Deep Dive</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.apple.com%2Flibrary%2Farchive%2Fdocumentation%2FDeveloperTools%2FConceptual%2FInstrumentsUserGuide%2F" target="_blank" title="https://developer.apple.com/library/archive/documentation/DeveloperTools/Conceptual/InstrumentsUserGuide/" ref="nofollow noopener noreferrer">Instruments User Guide</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[索引 ≠ 检索！RAG 高手都在用的六种知识表示方法]]></title>    <link>https://juejin.cn/post/7576646533614911542</link>    <guid>https://juejin.cn/post/7576646533614911542</guid>    <pubDate>2025-11-26T05:40:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576646533614911542" data-draft-id="7576689869808943140" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="索引 ≠ 检索！RAG 高手都在用的六种知识表示方法"/> <meta itemprop="keywords" content="LLM,Agent,程序员"/> <meta itemprop="datePublished" content="2025-11-26T05:40:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="AI大模型"/> <meta itemprop="url" content="https://juejin.cn/user/3817967696221534"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            索引 ≠ 检索！RAG 高手都在用的六种知识表示方法
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3817967696221534/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    AI大模型
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T05:40:20.000Z" title="Wed Nov 26 2025 05:40:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<h2 data-id="heading-0">索引 ≠ 检索！RAG 高手都在用的六种知识表示方法！</h2>
<p>检索增强生成（Retrieval-Augmented Generation, RAG）正在改变大型语言模型（LLMs）利用外部知识的方式。问题在于许多开发者误解了 RAG 的实际作用。他们关注存储在向量数据库中的文档，并认为所有的“魔法”始于此、终于此，但这完全是错误的。<strong>索引和检索根本不是一回事。</strong></p>
<p><strong>索引</strong>在于你如何选择<strong>表示</strong>的知识。<strong>检索</strong>在于模型可以<strong>看到</strong>哪些部分的知识。一旦你了解到了这个差异，整个思路就会很清晰，就会明白自己对模型的推理、速度和基础性有多大的控制权。</p>
<h4 data-id="heading-1">什么是 RAG 索引？</h4>
<p>RAG 索引是<strong>检索的基础</strong>。它是将原始知识转化为可经由相似性查询搜索的<strong>数值数据</strong>的过程。这些数值数据被称为 <strong>嵌入（embeddings）</strong> ，嵌入捕获的是<strong>含义</strong>，而不仅仅是表面的文本。<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5e8d2e0d30b4743898dd78e747d54e8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764740420&amp;x-signature=KTohhuw13RHTJ%2Byno5Rn4ErJ9xw%3D" alt="" loading="lazy"/></p>
<p>可以将其视为构建一个<strong>可搜索的知识库语义地图</strong>。每个知识块、摘要或查询变体都成为地图上的一个点。地图组织得越好，当用户提问时，你的检索器就能越好地识别出相关的知识。</p>
<p>如果你的索引出了问题，例如知识块太大、嵌入捕捉到了<strong>噪音</strong>，或者数据的表示没有反映用户的意图，那么再好的 LLM 也帮不了你多少。检索的质量始终取决于数据索引的有效性，而不是你的机器学习模型有多优秀。</p>
<h4 data-id="heading-2">为什么它很重要？</h4>
<p>你检索到的内容并<strong>不一定</strong>是你索引的内容。你的 RAG 系统的力量在于你的索引能否有效地<strong>反映含义而非文本</strong>。索引明确了你的检索器看待知识的<strong>框架</strong>。</p>
<p>当你将索引策略与你的数据和用户需求相匹配时，检索会变得更精确，模型将减少幻觉，用户将获得准确的补全。一个设计良好的索引能将 RAG 从一个检索管道转变为一个真正的<strong>语义推理引擎</strong>。</p>
<h4 data-id="heading-3">真正有效的 RAG 索引策略</h4>
<p>假设我们有一篇关于 Python 编程的文档：</p>
<p>文档是一种多功能编程语言，广泛应用于数据科学、机器学习和开发。它支持多种编程范式，并拥有、和等丰富的库生态系统。</p>
<p>现在，让我们探讨何时有效地使用每种 RAG 索引策略，以及如何为构建高性能检索系统而实现这些策略。</p>
<h5 data-id="heading-4">1. 块索引（Chunk Indexing）</h5>
<p>这是大多数 RAG 管道的起点。你将大型文档拆分成更小的、<strong>语义连贯的块</strong>，并使用某个嵌入模型对每个块进行嵌入。然后，这些嵌入被存储在一个向量数据库中。</p>
<p><strong>示例代码：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 1. Chunk Indexing   </span>
def chunk_indexing(document, <span class="hljs-attr">chunk_size</span>=<span class="hljs-number">100</span>):  
    <span class="hljs-attr">words</span> = document.split()   
    <span class="hljs-attr">chunks</span> = []   
    <span class="hljs-attr">current_chunk</span> = []   
    <span class="hljs-attr">current_len</span> = <span class="hljs-number">0</span>  
      
    for word in words:   
        current_len += len(word) + 1<span class="hljs-comment"># +1 for space   </span>
        current_chunk.append(word)   
          
        if current_len &gt;= chunk_size:   
            chunks.append(" ".join(current_chunk))   
            <span class="hljs-attr">current_chunk</span> = []   
            <span class="hljs-attr">current_len</span> = <span class="hljs-number">0</span>  
      
    if current_chunk:   
        chunks.append(" ".join(current_chunk))   
      
    <span class="hljs-attr">chunk_embeddings</span> = [embed(chunk) for chunk in chunks]   
    return chunks, chunk_embeddings   
  
chunks, <span class="hljs-attr">chunk_embeddings</span> = chunk_indexing(doc_text, chunk_size=<span class="hljs-number">50</span>)   
print("Chunks:\n", chunks)
</code></pre>
<p>核心逻辑是将文档按字数或字符数分割成多个块，然后对每个块生成嵌入向量。<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/865db87e8872492db73b4a59ebbb65e1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764740420&amp;x-signature=norDc9gRYdAEXMD9FTDIuGfDAt0%3D" alt="" loading="lazy"/></p>
<p><strong>最佳实践：</strong></p>
<ul>
<li>对于短篇文本，始终将块保持在 <strong>200-400 个 Token</strong> 左右；对于长篇技术内容，可保持在 <strong>500-800 个 Token</strong>。</li>
<li>确保避免在句中或段落中间进行分割，使用<strong>逻辑性的、语义上的断点</strong>以获得更好的分块效果。</li>
<li>最好使用 <strong>20-30% 的重叠窗口</strong>，以确保在边界处不会丢失上下文。</li>
</ul>
<p><strong>权衡：</strong> 块索引是简单且通用的索引方式。然而，<strong>更大的块</strong>可能会损害检索精度，而<strong>更小的块</strong>可能会分散上下文，并用不连贯的片段使 LLM 感到不知所措。</p>
<h5 data-id="heading-5">2. 子块索引（Sub-chunk Indexing）</h5>
<p>子块索引是<strong>在块索引基础上进行精炼</strong>的一层。在嵌入正常知识块时，你会将知识块进一步划分成<strong>更小的子块</strong>。在进行检索时，你将子块与查询进行比较，一旦子块匹配你的查询，<strong>完整的父块</strong>就会作为输入传递给 LLM。</p>
<p><strong>这种方法有效的原因：</strong> 子块使你能够以一种<strong>更精确、更微妙、更准确</strong>的方式进行搜索，同时保留了你进行推理所需的<strong>大上下文</strong>。例如，你可能有一篇长篇研究文章，而该文章中某一部分内容的子块可能就是长段落中某个公式的解释，从而提高了<strong>精度和可解释性</strong>。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 2. Sub-chunk Indexing  </span>
  
def sub_chunk_indexing(chunk, <span class="hljs-attr">sub_chunk_size</span>=<span class="hljs-number">25</span>):  
    <span class="hljs-attr">words</span> = chunk.split()  
    <span class="hljs-attr">sub_chunks</span> = []  
    <span class="hljs-attr">current_sub_chunk</span> = []  
    <span class="hljs-attr">current_len</span> = <span class="hljs-number">0</span>  
  
    for word in words:  
        current_len += len(word) + 1  
        current_sub_chunk.append(word)  
  
        if current_len &gt;= sub_chunk_size:  
            sub_chunks.append(" ".join(current_sub_chunk))  
            <span class="hljs-attr">current_sub_chunk</span> = []  
            <span class="hljs-attr">current_len</span> = <span class="hljs-number">0</span>  
  
    if current_sub_chunk:  
        sub_chunks.append(" ".join(current_sub_chunk))  
  
    return sub_chunks  
  
<span class="hljs-comment"># Sub-chunks for first chunk (as example)  </span>
<span class="hljs-attr">sub_chunks</span> = sub_chunk_indexing(chunks[<span class="hljs-number">0</span>], sub_chunk_size=<span class="hljs-number">30</span>)  
<span class="hljs-attr">sub_embeddings</span> = [embed(sub_chunk) for sub_chunk in sub_chunks]  
  
print("Sub-chunks:\n", sub_chunks)
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd9cca2883b340499e33de56927471f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764740420&amp;x-signature=0OaLFop4dPnTKGkb9602Gb%2BO7Xw%3D" alt="" loading="lazy"/></p>
<p><strong>何时使用：</strong> 对于每个段落中包含多个不同观点的<strong>数据集</strong>会很有优势；例如，知识库、教科书、研究文章等会是理想的选择。</p>
<p><strong>权衡：</strong> 由于嵌入有所重叠，预处理和存储成本略高，但它在查询和内容之间的<strong>对齐方面有实质性的提升</strong>。</p>
<h5 data-id="heading-6">3. 查询索引（Query Indexing）</h5>
<p>在查询索引的情况下，<strong>原始文本不会被直接嵌入</strong>。相反，我们会生成针对每个知识块的<strong>几个假想问题</strong>，然后嵌入这些问题文本。这样做部分是为了弥合用户提问方式与文档描述事物方式之间的<strong>语义鸿沟</strong>。</p>
<p><strong>例如，如果你的知识块说：</strong> “LangChain 拥有用于构建 RAG 管道的实用工具”</p>
<p><strong>模型会生成类似这样的查询：</strong></p>
<ul>
<li>我如何在 LangChain 中构建 RAG 管道？</li>
<li>LangChain 有哪些用于检索的工具？</li>
</ul>

<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 3. Query Indexing - generate synthetic queries related to the chunk  </span>
def generate_queries(chunk):  
    <span class="hljs-comment"># Simple synthetic queries for demonstration  </span>
    <span class="hljs-attr">queries</span> = [  
        <span class="hljs-string">"What is Python used for?"</span>,  
        <span class="hljs-string">"Which libraries does Python support?"</span>,  
        <span class="hljs-string">"What paradigms does Python support?"</span>  
    ]  
  
    <span class="hljs-attr">query_embeddings</span> = [embed(q) for q in queries]  
    return queries, query_embeddings  
  
queries, <span class="hljs-attr">query_embeddings</span> = generate_queries(doc_text)  
print("Synthetic Queries:\n", queries)
</code></pre>
<p>然后，当任何真实用户提出类似问题时，检索将直接命中其中一个索引的查询。<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/724d44121a9844cbb59a927e404938be~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764740420&amp;x-signature=3oIFu0h6O2J%2F%2FdWG8ivTO9ounIM%3D" alt="" loading="lazy"/></p>
<p><strong>最佳实践：</strong></p>
<ul>
<li>在编写索引查询时，建议使用 LLM 为每个知识块生成 <strong>3-5 个查询</strong>。</li>
<li>你也可以对所有相似的问题进行<strong>去重或聚类</strong>，以缩小实际索引的规模。</li>
</ul>
<p><strong>何时使用：</strong></p>
<ul>
<li><strong>问答系统</strong>或大多数用户交互都由自然语言问题驱动的<strong>聊天机器人</strong>。</li>
<li>用户很可能会询问“是什么”、“如何做”或“为什么”等类型查询的<strong>搜索体验</strong>。</li>
</ul>
<p><strong>权衡：</strong> 虽然合成扩展增加了预处理时间和空间，但它为面向用户的系统提供了<strong>有意义的检索相关性提升</strong>。</p>
<h5 data-id="heading-7">4. 摘要索引（Summary Indexing）</h5>
<p>摘要索引允许你在嵌入之前，将资料片段重构成<strong>更小的摘要</strong>。你将完整的原始内容保留在另一个位置，然后在<strong>摘要版本</strong>上执行检索。</p>
<p><strong>这种方法的好处：</strong> 结构化、密集或重复的源材料（例如电子表格、政策文件、技术手册）通常是<strong>直接从原始文本嵌入会捕获噪音</strong>的材料。摘要<strong>抽象</strong>掉了不那么相关的表面细节，对于嵌入而言<strong>语义上更有意义</strong>。</p>
<p><strong>例如：</strong> 原始文本说：“2020 年至 2025 年的温度读数范围为 22 至 42 摄氏度，异常归因于厄尔尼诺现象。” 摘要将是：“年度温度趋势（2020-2025），涉及厄尔尼诺相关的异常现象。” 摘要表示形式将<strong>焦点集中在概念上</strong>。</p>
<p><strong>示例代码</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 4. Summary Indexing  </span>
  
<span class="hljs-keyword">def</span> <span class="hljs-title function_">summarize</span>(<span class="hljs-params">text</span>):  
    <span class="hljs-comment"># Simple summary for demonstration (replace with an actual summarizer for real use)  </span>
    <span class="hljs-keyword">if</span><span class="hljs-string">"Python"</span><span class="hljs-keyword">in</span> text:  
        <span class="hljs-keyword">return</span><span class="hljs-string">"Python: versatile language, used in data science and web development with many libraries."</span>  
    <span class="hljs-keyword">return</span> text  
  
summary = summarize(doc_text)  
summary_embedding = embed(summary)  
  
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Summary:"</span>, summary)
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fab35aa3ed3e468f832fba0d0edfe106~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764740420&amp;x-signature=5nTa6RPKCrK%2Bus2vAe0a%2BC5mSfg%3D" alt="" loading="lazy"/></p>
<p><strong>何时使用：</strong></p>
<ul>
<li>处理<strong>结构化数据</strong>（表格、CSV、日志文件）。</li>
<li><strong>技术性或冗长</strong>的内容，如果使用原始文本嵌入，嵌入效果会不佳。</li>
</ul>
<p><strong>权衡：</strong> 如果摘要过于抽象，可能会有<strong>损失细微差别/事实准确性</strong>的风险。对于特定领域（尤其是法律、金融等）的关键研究，应链接到<strong>原始文本</strong>进行参考。</p>
<h5 data-id="heading-8">5. 分层索引（Hierarchical Indexing）</h5>
<p>分层索引将信息组织成<strong>多个不同级别</strong>：文档、章节、段落、子段落。你分阶段进行检索，从<strong>广泛的介绍开始</strong>，逐步缩小到<strong>特定的上下文</strong>。顶层组件检索相关文档的<strong>章节</strong>，下一层检索在这些检索到的文档章节内的<strong>特定上下文的段落或子段落</strong>。</p>
<p><strong>这意味着什么？</strong> 分层检索可以<strong>减少系统中的噪音</strong>，并且在你需要控制上下文大小时非常有用。当处理<strong>大量文档</strong>且无法一次性全部拉取时，这尤其有用。它还可以提高后续分析的<strong>可解释性</strong>，因为你可以知道是哪个文档的哪个部分促成了最终答案。<strong>示例代码</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 5. Hierarchical Indexing   </span>
  
<span class="hljs-comment"># Organize document into levels: document -&gt; chunks -&gt; sub-chunks   </span>
  
hierarchical_index = {   
  
<span class="hljs-string">"document"</span>: doc_text,   
  
<span class="hljs-string">"chunks"</span>: chunks,   
  
<span class="hljs-string">"sub_chunks"</span>: {chunk: sub_chunk_indexing(chunk) <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> chunks}   
  
}   
  
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Hierarchical index example:"</span>)   
  
<span class="hljs-built_in">print</span>(hierarchical_index)
</code></pre>
<p><strong>最佳实践：</strong></p>
<ul>
<li>使用<strong>多个嵌入级别</strong>或<strong>嵌入与关键词搜索的组合</strong>。例如，最初仅使用 BM25 检索文档，然后使用嵌入更精确地检索那些相关的块或组件。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/051d4256d802446bbc16968f3b4ed7d1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQUnlpKfmqKHlnos=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764740420&amp;x-signature=LQrwaqGPsVLjbZMr7dr35t48sxw%3D" alt="" loading="lazy"/></p>
<p><strong>何时使用：</strong></p>
<ul>
<li>拥有<strong>数千份文档的企业级 RAG</strong>。</li>
<li>从书籍、法律档案或技术 PDF 等<strong>长篇来源</strong>中检索。</li>
</ul>
<p><strong>权衡：</strong> 由于需要<strong>多个检索级别</strong>，复杂性增加。还需要额外的存储和预处理来进行元数据/摘要。由于多步骤检索，查询延迟增加，<strong>不适合大型非结构化数据</strong>。</p>
<h5 data-id="heading-9">6. 混合索引（Hybrid Indexing / Multi-Modal）</h5>
<p>知识不仅仅存在于文本中。在混合索引形式中，RAG 通过做两件事来处理多种形式的数据或模态：检索器使用<strong>针对每种可能模态专门化或调优的不同编码器</strong>生成的嵌入。然后，它从每个相关的嵌入中获取结果，并使用评分策略或<strong>晚期融合（late-fusion）</strong> 方法将它们结合起来生成响应。</p>
<p><strong>以下是其用法的示例：</strong></p>
<ul>
<li>使用 <strong>CLIP 或 BLIP</strong> 处理图像和文本标题。</li>
<li>使用 <strong>CodeBERT 或 StarCoder</strong> 嵌入来处理代码。</li>
</ul>
<p><strong>示例代码</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 6. Hybrid Indexing (example with text + image)  </span>
  
<span class="hljs-comment"># Example text and dummy image embedding (replace embed_image with actual model)  </span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">embed_image</span>(<span class="hljs-params">image_data</span>):  
    <span class="hljs-comment"># Dummy example: image data represented as length of string (replace with CLIP/BLIP encoder)  </span>
    <span class="hljs-keyword">return</span> [<span class="hljs-built_in">len</span>(image_data) / <span class="hljs-number">1000</span>]  
  
text_embedding = embed(doc_text)  
image_embedding = embed_image(<span class="hljs-string">"image_bytes_or_path_here"</span>)  
  
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Text embedding size:"</span>, <span class="hljs-built_in">len</span>(text_embedding))  
<span class="hljs-built_in">print</span>(<span class="hljs-string">"Image embedding size:"</span>, <span class="hljs-built_in">len</span>(image_embedding))
</code></pre>
<p><strong>何时使用混合索引：</strong></p>
<ul>
<li>处理包含<strong>图像或图表</strong>的技术手册或文档。</li>
<li><strong>多模态</strong>文档或支持文章。</li>
<li>产品目录或电子商务。</li>
</ul>
<p><strong>权衡：</strong> 检索逻辑和存储模型更为复杂，但在响应中能提供<strong>更丰富的上下文理解</strong>，并在领域内具有更高的灵活性。</p>
<p>成功的 RAG 系统取决于<strong>针对数据类型和待回答问题的适当索引策略</strong>。索引指导着检索器找到什么，以及语言模型将以什么为基础进行生成，使其成为超越检索的<strong>关键基础</strong>。你使用的索引类型可能是块、子块、查询、摘要、分层或混合索引，并且该索引应<strong>遵循数据中存在的结构</strong>，这将提高相关性并消除噪音。精心设计的索引过程将<strong>减少幻觉</strong>，并提供一个准确、值得信赖的系统。</p>
<h3 data-id="heading-10">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大模型瘦身术:量化与蒸馏技术全解析]]></title>    <link>https://juejin.cn/post/7576825095134986266</link>    <guid>https://juejin.cn/post/7576825095134986266</guid>    <pubDate>2025-11-26T05:57:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576825095134986266" data-draft-id="7576669556150190118" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大模型瘦身术:量化与蒸馏技术全解析"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-26T05:57:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="居然JuRan"/> <meta itemprop="url" content="https://juejin.cn/user/2524134427858205"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大模型瘦身术:量化与蒸馏技术全解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2524134427858205/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    居然JuRan
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T05:57:07.000Z" title="Wed Nov 26 2025 05:57:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么要给大模型"瘦身"?</h2>
<p>在AI技术飞速发展的今天,大语言模型已经成为各行各业的得力助手。但你是否知道,部署一个大模型的成本有多高?</p>
<p>一个千亿参数级别的模型,不仅需要占用大量的存储空间,在实际运行时更是需要惊人的计算资源。对于企业来说,这意味着高昂的硬件成本和运营开支。因此,如何在保持模型性能的同时降低部署成本,成为了AI工程师们必须面对的挑战。</p>
<p>今天,我们就来聊聊大模型压缩的两大主流技术——<strong>量化(Quantization)和蒸馏(Distillation)</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ceb122be11df49e0b2e47cbda4123427~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGF54S2SnVSYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741427&amp;x-signature=xUqEIgMf6B0xrbulchmQuih2GlY%3D" alt="大模型压缩技术概览" loading="lazy"/></p>
<h2 data-id="heading-1">量化:用更少的位数存储参数</h2>
<h3 data-id="heading-2">什么是量化?</h3>
<p>要理解量化,我们首先需要知道:大模型本质上是由海量参数组成的。比如GPT-3,就包含了1750亿个参数。每个参数都是一个数值,而这些数值的存储方式,直接决定了模型占用的空间大小。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/52330fabeb214786abcfba009f5b1a54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGF54S2SnVSYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741427&amp;x-signature=pSf6HinPuv6%2BzRgb9BBfXvk51ew%3D" alt="量化原理解释" loading="lazy"/></p>
<p>让我们举个简单的例子。假设某个参数的值是1.2768,为了在计算机中存储这个精确的数值,我们需要开辟一定的内存空间。但如果我们做个"四舍五入",把它简化成1或者1.28,所需的存储空间就会大大减少。</p>
<p><strong>这就是量化的核心思想——通过降低数值精度来节省存储空间。</strong></p>
<h3 data-id="heading-3">从Float32到INT8的转变</h3>
<p>在深度学习中,参数通常以Float32的格式存储,也就是说每个参数占用32个bits(4个字节)的空间。但通过量化技术,我们可以将这些参数转换为更低精度的数据类型:</p>
<ul>
<li>
<p><strong>Float32 → Float16</strong>:空间减半,每个参数仅占16个bits</p>
</li>
<li>
<p><strong>Float32 → INT8</strong>:空间压缩至1/4,每个参数仅占8个bits</p>
</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/33d3fcb13a374856b9dcb900473adbce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGF54S2SnVSYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741427&amp;x-signature=QQEPn3g8hMDSsGwBjZrtfFDWChg%3D" alt="数据类型转换示意" loading="lazy"/></p>
<p>这种转换带来的好处是显而易见的:</p>
<ol>
<li>
<p><strong>大幅降低存储需求</strong>:模型文件变小,更容易部署</p>
</li>
<li>
<p><strong>加速推理速度</strong>:计算量减少,响应更快</p>
</li>
<li>
<p><strong>降低成本</strong>:对硬件的要求大幅下降</p>
</li>
</ol>
<p>你可能会担心:精度降低了,模型的准确率会不会受影响?</p>
<p>答案是:**如果量化过程把控得当,模型的准确率是有保障的。**这也是为什么量化成为目前大模型压缩最常用的方法之一。</p>
<h2 data-id="heading-4">蒸馏:让小模型学会"模仿"</h2>
<h3 data-id="heading-5">蒸馏的本质是什么?</h3>
<p>如果说量化是"压缩参数",那么蒸馏则是完全不同的思路——<strong>让一个小模型去模仿大模型的行为</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad612a7432bc401ba6d549483e411cc2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGF54S2SnVSYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741427&amp;x-signature=Selr8ftFG1%2FKCdLwZulvF0z%2BAW0%3D" alt="模型蒸馏原理" loading="lazy"/></p>
<p>想象一个场景:我们已经训练好了一个千亿参数的大模型,但它太大太重,部署成本太高。这时候,我们可以构造一个小得多的模型,然后让这个"学生模型"(Student Model)去学习"教师模型"(Teacher Model)的行为。</p>
<h3 data-id="heading-6">蒸馏是如何工作的?</h3>
<p>具体来说,蒸馏的过程是这样的:</p>
<ol>
<li>
<p>给定一个输入(比如一个prompt)</p>
</li>
<li>
<p>将这个输入同时喂给大模型和小模型</p>
</li>
<li>
<p>观察大模型的输出</p>
</li>
<li>
<p>训练小模型,让它的输出尽可能接近大模型的输出</p>
</li>
</ol>
<p><strong>就像小孩子模仿大人一样,大模型做什么,小模型也学着做什么。</strong></p>
<p>通过这种方式,小模型逐渐学会了大模型的"行为模式",最终能够在保持相似性能的同时,大幅减少模型规模和计算开销。</p>
<h3 data-id="heading-7">蒸馏在实际中的应用</h3>
<p>蒸馏技术不仅用于模型压缩,在训练新模型时也经常使用。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/795d7eabee8d40d7ac4381417456b8f3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bGF54S2SnVSYW4=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741427&amp;x-signature=yuPYq1MLtEck17Uwlt0MCoTUmKQ%3D" alt="蒸馏应用场景" loading="lazy"/></p>
<p>一个典型的例子是:市面上很多开源大模型,都是通过"模仿"GPT-4训练出来的。具体做法是:</p>
<ol>
<li>
<p>收集GPT-4对各种问题的回复</p>
</li>
<li>
<p>将这些输入-输出对作为训练数据</p>
</li>
<li>
<p>用这些数据训练自己的模型</p>
</li>
</ol>
<p>通过这种方式,开源模型能够逐步接近GPT-4的表现,同时保持更低的部署成本。</p>
<h2 data-id="heading-8">量化vs蒸馏:该选哪一个?</h2>
<p>这两种技术各有特点,适用于不同场景:</p>
<p><strong>量化技术</strong>:</p>
<ul>
<li>
<p>优势:实施简单,不需要重新训练,压缩效果明显</p>
</li>
<li>
<p>适用场景:已有模型的快速优化,对精度要求不是特别严格的应用</p>
</li>
<li>
<p>主流方法:目前大模型压缩最常用的手段</p>
</li>
</ul>
<p><strong>蒸馏技术</strong>:</p>
<ul>
<li>
<p>优势:可以获得一个全新的小模型,灵活性更高</p>
</li>
<li>
<p>适用场景:需要大幅度缩小模型规模,或训练新模型时借鉴大模型能力</p>
</li>
<li>
<p>应用广泛:很多开源模型都基于蒸馏思路训练</p>
</li>
</ul>
<p>在实际应用中,这两种技术也可以结合使用,达到更好的压缩效果。</p>
<h2 data-id="heading-9">其他压缩技术</h2>
<p>除了量化和蒸馏,还有一些其他的模型压缩技术,比如<strong>剪枝(Pruning)</strong>——通过移除模型中不重要的参数或连接来减小模型规模。</p>
<p>但在大模型领域,剪枝的实用性相对较弱,量化和蒸馏仍然是最主流、最实用的两种方法。</p>
<h2 data-id="heading-10">写在最后</h2>
<p>随着大模型应用的不断普及,模型压缩技术变得越来越重要。无论是量化还是蒸馏,它们的目标都是在保证模型性能的前提下,让AI技术更加"平民化"——降低部署门槛,让更多人能够用得起、用得好大模型。</p>
<p>对于开发者来说,理解这些技术原理,不仅能帮助我们更好地部署模型,也能在设计AI应用时做出更明智的技术选择。</p>
<p>你在实际项目中使用过这些技术吗?欢迎在评论区分享你的经验!</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[推荐 5 个 yyds 的 Claude Skills 开源项目。]]></title>    <link>https://juejin.cn/post/7576592590948286498</link>    <guid>https://juejin.cn/post/7576592590948286498</guid>    <pubDate>2025-11-26T05:58:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576592590948286498" data-draft-id="7576571960287838243" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="推荐 5 个 yyds 的 Claude Skills 开源项目。"/> <meta itemprop="keywords" content="GitHub"/> <meta itemprop="datePublished" content="2025-11-26T05:58:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="逛逛GitHub"/> <meta itemprop="url" content="https://juejin.cn/user/1442202996186093"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            推荐 5 个 yyds 的 Claude Skills 开源项目。
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1442202996186093/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    逛逛GitHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T05:58:13.000Z" title="Wed Nov 26 2025 05:58:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>前段时间，Anthropic 推出了 Claude Skills 能力。</p>
<p>这是一种模块化能力扩展机制。有了它你不就用给 AI 重复解释了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/670cfce9bf17421c807b3295bb77259d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741493&amp;x-signature=fPQfvesvMTXbR7fOWrl%2FolgfA5k%3D" alt="图片" loading="lazy"/></p>
<p>你可以把所有想让 Claude 吸取的经验都写到一个 Skill.md 文件里面。这个文件可以理解为是一份详细的指令说明书、可执行的脚本或相关资源，专门用于完成某项特定任务 。感兴趣可以看看下面这个文章，有详细描述。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//www.claude.com/blog/skills</span>
</code></pre>
<p>比如你搞了一个 Skill.md 文件，里面放了 AI 生成 PPT 固定流程的指令。你给 Claude 说：帮我生成 PPT，这个 Skill 就能激活。你就不需要每次都把你的要求写出来。今天看看 GitHub 上有哪些实用的 Claude Skills。节省你的时间，直接拿来用，不用自己写了。</p>
<h2 data-id="heading-0">01、Claude Skills 大合集</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00ac9e95034b4c4eae681148b29462c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741493&amp;x-signature=RhEWfxRRDpwReqe9wNEpEpXFx1U%3D" alt="图片" loading="lazy"/></p>
<p>awesome-claude-skills 是一个精心整理的 Claude Skills 精选列表，专门用于定制Claude AI 工作流程。该项目收集了各种实用 Skill，采用模块化设计。比如文档处理、开发、数据分析、营销、写作创意啥的都有。</p>
<pre><code class="hljs language-bash" lang="bash">开源地址：https://github.com/ComposioHQ/awesome-claude-skills
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c09ed9ef88c043bdbb17934fe516bc2a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741493&amp;x-signature=4LOYRx%2FMPrSZaB5H3GXyG9XpMoo%3D" alt="图片" loading="lazy"/></p>
<p>项目结构清晰，每个技能文件夹都包含 SKILL.md 文件，其中详细描述了技能的功能、使用场景和操作指令。部分复杂技能还提供了辅助脚本、文档模板和资源文件，方便你快速上手。比如这个 playwright-skill 是让 Claude 模型调用 Playwright 自动化测试和验证网页应用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05de65ef436540318af221db0b69b5cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741493&amp;x-signature=OPrB0fLBW8wS7iWcYSvPH9VPb3c%3D" alt="图片" loading="lazy"/></p>
<p>然后开发者 @BehiSecc 也开源了一个类似精选列表。大差不差，可以一起对照着看。</p>
<pre><code class="hljs language-bash" lang="bash">开源地址：https://github.com/BehiSecc/awesome-claude-skills
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b88d9813acc44d3b4e4126d66e799a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741493&amp;x-signature=Oy%2BMlqXxUtVCgRszGqih52Zs%2BSY%3D" alt="图片" loading="lazy"/></p>
<h2 data-id="heading-1">02、Claude Code 基础设施</h2>
<p>这个开源项目里面的 Skill 就两个字：实用。因为每个 Skill 都经过了真实项目的严格测试，具有极高的实用价值。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b287ab47b8ab49eda136166623815ba6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741493&amp;x-signature=L4RIRys03tnA4hsMwR94wE47t6c%3D" alt="图片" loading="lazy"/></p>
<p>是开发者经过 6 个月的打磨，经过生产环境检验的 Claude Code 基础设施。</p>
<p>它解决了 Skills 无法自动激活这个问题。</p>
<p>传统的 Claude Code Skill 需要你手动记忆和调用，而这个项目通过创新的钩子机制，实现了 Skill 的智能自动触发。</p>
<p>当你输入提示或操作文件时，系统会自动分析上下文，并建议最相关的技能。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0b2dcbcefa944e328b20fbb5cbe2dd64~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741493&amp;x-signature=hKxDB%2FIuLg1Nfc78miI7C0dEmig%3D" alt="图片" loading="lazy"/></p>
<p>每个主要 Skill 文件控制在 500 行以内，配合多个资源文件实现渐进式披露。这种设计避免了大型技能文件超出上下文限制的问题，同时确保了信息的深度和广度。基础设施包含 5 个 Skills，涵盖后端开发指南、前端开发指南、技能开发元技能、路由测试和错误追踪等领域。</p>
<pre><code class="hljs language-bash" lang="bash">开源地址：https://github.com/diet103/claude-code-infrastructure-showcase
</code></pre>
<h2 data-id="heading-2">03、数据分析 Agent</h2>
<p>开发者 @obra 觉得现在的 AI 写代码太随意了，所以他写了一组 Skills，<strong>强迫</strong> Claude 按照<strong>世界级高级工程师</strong>的标准流程来工作。</p>
<p><strong>superpowers 就像一套专门为程序员打造的高级技能包</strong>。</p>
<p>装了之后，Claude 的模式就是：<strong>收到需求 -&gt; 先头脑风暴 -&gt; 制定详细计划 -&gt; 写测试用例（TDD） -&gt; 写代码通过测试 -&gt; 检查质量</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d492ba110ae4a32bcfc336f07ef304c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741493&amp;x-signature=NJsokv3nGKLhYMKKLHb8XjSux5o%3D" alt="图片" loading="lazy"/></p>
<p>所以不像常规的 AI，直接给你写业务代码，有没有 Bug 全靠运气。</p>
<p>比如，它有 brainstorm（头脑风暴）和 write-plan（写计划）skills。在写任何代码前，它会先生成一份详细的 Markdown 计划书，列出所有步骤，你确认没问题了，它才开始干活。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef083f15b60a44bb870acb69f56434b5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741493&amp;x-signature=%2BYG0rnPn6C%2Fk3ZKbpgg3Wz%2FaDpU%3D" alt="图片" loading="lazy"/></p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/obra/superpowers</span>
</code></pre>
<h2 data-id="heading-3">04、网站转成 Skills</h2>
<p>Skill_Seekers 这个开源项目之前介绍过。</p>
<p>它其实是一个自动化工具，可以把文档网站、GitHub 项目和 PDF 文件转换为 Claude AI Skill 。</p>
<p>不需要你手动阅读总结文档了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2598b1fd7c7b40d59721cb8b14250c0c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YCb6YCbR2l0SHVi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764741493&amp;x-signature=W3j4qj3h1sMNXcG2qN%2BlP3OKoEk%3D" alt="图片" loading="lazy"/></p>
<p>全程无需手动操作，将智能抓取的信息有机整合，最后整理成 Claude 能直接导入的 .zip  技能包。</p>
<p>开发者写了一篇从 0 部署这个开源项目的文章，很详细。</p>
<pre><code class="hljs language-arduino" lang="arduino">开源地址：https:<span class="hljs-comment">//github.com/yusufkaraaslan/Skill_Seekers</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 3.38 + Firebase：2025 年开发者必看的新变化]]></title>    <link>https://juejin.cn/post/7576605171771605042</link>    <guid>https://juejin.cn/post/7576605171771605042</guid>    <pubDate>2025-11-26T04:07:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576605171771605042" data-draft-id="7575367791273852966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 3.38 + Firebase：2025 年开发者必看的新变化"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-26T04:07:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JarvanMo"/> <meta itemprop="url" content="https://juejin.cn/user/2348212565845704"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 3.38 + Firebase：2025 年开发者必看的新变化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2348212565845704/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JarvanMo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T04:07:35.000Z" title="Wed Nov 26 2025 04:07:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Flutter 3.38 和 FlutterFire 的 2025 年更新改进了 Firebase 的集成，提升了类型安全，并简化了身份验证过程，助您构建可扩展的移动后端。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c27f731be734cc7aff344a0ebf18be1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSmFydmFuTW8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764734855&amp;x-signature=ffxplk6eyHKwpbY7zPdiJY95JV8%3D" alt="image.png" loading="lazy"/></p>
<p>如果您正在使用 Firebase 开发 Flutter 应用，2025 年将迎来一些重大的利好变化。通过 <strong>Flutter 3.38</strong> 以及最新、最强大的 <strong>FlutterFire</strong> 库，您可以采用更具<strong>声明式</strong>、更安全且性能更高的<strong>方式</strong>来集成 Firebase。现在，让我们深入了解一下对您的生产应用至关重要的更新。</p>
<h3 data-id="heading-0">改进的 Firebase 初始化</h3>
<p>最大的变化是什么？它是一种更方便、更<strong>健壮</strong>的初始化方法。这种新方法利用了<strong>编译时配置</strong>，从而消除了运行时错误，并显著改善了应用的<strong>冷启动时间</strong>。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">void</span> main() <span class="hljs-keyword">async</span> {
  WidgetsFlutterBinding.ensureInitialized();
  
  <span class="hljs-comment">// New: Single line initialization with better error handling</span>
  <span class="hljs-keyword">await</span> Firebase.initializeApp(
    options: DefaultFirebaseOptions.currentPlatform,
  );
  
  runApp(MyApp());
}
</code></pre>
<p><strong>告别散落在 iOS 和 Android 文件夹中的多平台配置文件！</strong> FlutterFire CLI 现在将所有配置合并到一个 <strong><code>firebase_options.dart</code></strong> 文件中，为每个平台提供类型化配置。仅凭这一点，就能为您节省大量调试新 Firebase 服务的时间。</p>
<h3 data-id="heading-1">Firestore 变得更智能了</h3>
<p><strong>Firestore 查询的类型安全得到改进</strong> Firestore 查询现在将更具可读性，并提供更出色的类型安全。如果说现在代码的灵活性降低了，那绝对是件好事——因为新的<strong>强类型查询构建器</strong>可以在<strong>编译时</strong>而非运行时发现错误！</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 旧的方式 (prone to typos and runtime errors)</span>
FirebaseFirestore.instance
  .collection(<span class="hljs-string">'users'</span>)
  .where(<span class="hljs-string">'age'</span>, isGreaterThan: <span class="hljs-number">18</span>);

<span class="hljs-comment">// 新的: Type-safe with better autocomplete</span>
<span class="hljs-keyword">final</span> usersRef = FirebaseFirestore.instance
  .collection(<span class="hljs-string">'users'</span>)
  .withConverter&lt;User&gt;(
    fromFirestore: (snapshot, _) =&gt; User.fromJson(snapshot.data()!),
    toFirestore: (user, _) =&gt; user.toJson(),
  );

<span class="hljs-keyword">final</span> adults = <span class="hljs-keyword">await</span> usersRef
  .where((user) =&gt; user.age, isGreaterThan: <span class="hljs-number">18</span>)
  .<span class="hljs-keyword">get</span>()
</code></pre>
<p><strong>转换器模式（Converter Pattern）</strong> 并非新概念，但在 Flutter 3.38 中，它成为了<strong>首选方案</strong>。这有助于确保您的数据模型在整个应用中保持无缝一致，为您提供完整的<strong>类型安全</strong>，以及增强的 IDE（集成开发环境）支持。</p>
<h3 data-id="heading-2">身份验证流程简化</h3>
<p><strong>新的辅助方法简化了常见的 Firebase Auth 流程。</strong> 当使用 Google、Apple 或电子邮件登录时，不再需要编写那么多<strong>样板代码</strong>（boilerplate code）。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// 精简的身份验证</span>
<span class="hljs-keyword">final</span> userCredential = <span class="hljs-keyword">await</span> FirebaseAuth.instance
  .signInWithProvider(GoogleAuthProvider());

<span class="hljs-comment">// 优化的状态管理集成</span>
StreamBuilder&lt;User?&gt;(
  stream: FirebaseAuth.instance.authStateChanges(),
  builder: (context, snapshot) {
    <span class="hljs-keyword">if</span> (snapshot.hasData) <span class="hljs-keyword">return</span> HomeScreen();
    <span class="hljs-keyword">return</span> LoginScreen();
  },
);
</code></pre>
<p>这些新的身份验证状态流是为 <strong>Riverpod</strong>、<strong>Bloc</strong> 或您正在使用的任何状态管理方案<strong>内置</strong>的。</p>
<h3 data-id="heading-3">真正起作用的实时更新</h3>
<p><strong>Firebase 实时数据库（Realtime Database）和 Firestore 中的流处理得到了改进。</strong> 即使在网络不稳定的情况下，<strong>连接状态控制</strong>也更加健壮，<strong>离线持久化</strong>功能也能平稳运行。</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-comment">// Automatic offline support with better sync  </span>
<span class="hljs-keyword">final</span> stream = FirebaseFirestore.instance  
.collection(<span class="hljs-string">'messages'</span>)  
.orderBy(<span class="hljs-string">'timestamp'</span>, descending: <span class="hljs-keyword">true</span>)  
.limit(<span class="hljs-number">50</span>)  
.snapshots();
</code></pre>
<h3 data-id="heading-4">💾 离线持久化功能升级</h3>
<blockquote>
<p>离线持久化功能的更新意味着，即使在网络连接中断时，您的用户也能享受到<strong>无缝</strong>的使用体验。一旦恢复在线，它会自动同步数据，<strong>无需任何手动操作</strong>。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">🎯 核心要点 (Key Takeaways)</h3>
<ul>
<li><strong>单一文件配置：</strong> 不再需要在不同平台的 Firebase 配置文件之间来回切换。</li>
<li><strong>Firestore 编译时错误检查（使用转换器）：</strong> 实现<strong>类型安全的查询</strong>。</li>
<li><strong>简化的身份验证：</strong> 减少了最常用身份验证模式的<strong>样板代码</strong>。</li>
<li><strong>更好的离线支持：</strong> 页面同步（Page Syncing Up）以及<strong>连接状态管理</strong>得到增强。</li>
<li><strong>性能改进：</strong> 加快了应用<strong>启动速度</strong>，并<strong>减小了安装包体积</strong>（bundle size）。</li>
</ul>
<hr/>
<h3 data-id="heading-6">🆙 准备升级了吗？</h3>
<blockquote>
<p>如果您已经在 Flutter 应用中使用 Firebase，那么迁移到这些新模式将会<strong>非常简单</strong>。FlutterFire 团队已经准备了迁移指南，而且大多数更改都是<strong>增量式</strong>的，这意味着您可以逐步采用它们，而不会破坏现有代码。</p>
<p>Firebase 仍然是您可以用于 Flutter 应用的最佳后端服务之一，而 2025 年的这些变化表明整个生态系统正在走向<strong>成熟</strong>。请务必尝试这些新模式吧！为更简洁的代码和更少的运行时意外，感谢您未来的自己。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vite 3.0 重磅升级：5个你必须掌握的优化技巧和实战应用]]></title>    <link>https://juejin.cn/post/7576556950332293120</link>    <guid>https://juejin.cn/post/7576556950332293120</guid>    <pubDate>2025-11-26T04:16:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576556950332293120" data-draft-id="7576569518262747136" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vite 3.0 重磅升级：5个你必须掌握的优化技巧和实战应用"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2025-11-26T04:16:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vite 3.0 重磅升级：5个你必须掌握的优化技巧和实战应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T04:16:56.000Z" title="Wed Nov 26 2025 04:16:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>Vite 3.0 重磅升级：5个你必须掌握的优化技巧和实战应用</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>前端构建工具的发展日新月异，而 Vite 作为新一代的前端工具链，凭借其原生 ESM 支持和极速的开发体验，已经成为现代 Web 开发的重要选择。2022年7月，Vite 3.0 正式发布，带来了多项重大改进和性能优化。本文将深入剖析 Vite 3.0 的核心升级点，并分享5个必须掌握的优化技巧及其在实际项目中的应用场景。</p>
<p>对于已经使用或考虑迁移到 Vite 的开发者而言，理解这些优化技巧不仅能提升开发效率，还能显著改善生产环境的构建性能。我们将从底层原理出发，结合具体代码示例，帮助您全面掌握 Vite 3.0 的强大功能。</p>
<h2 data-id="heading-2">Vite 3.0 核心升级概览</h2>
<p>在深入优化技巧之前，让我们先快速了解 Vite 3.0 的主要变化：</p>
<ol>
<li><strong>默认支持现代浏览器</strong>：不再自动为传统浏览器生成 polyfill</li>
<li><strong>改进的 SSR API</strong>：提供更稳定的服务端渲染支持</li>
<li><strong>全新的热模块替换(HMR)架构</strong>：性能提升显著</li>
<li><strong>实验性 Lightning CSS 支持</strong>：替代 PostCSS 的性能怪兽</li>
<li><strong>构建输出优化</strong>：减少约30%的打包体积</li>
</ol>
<p>这些底层改进为我们后续要介绍的优化技巧奠定了基础。现在让我们进入正题。</p>
<h2 data-id="heading-3">技巧一：利用新型依赖预构建策略</h2>
<h3 data-id="heading-4">原理分析</h3>
<p>Vite 的核心优势之一是其创新的依赖预构建机制。在 Vite 3.0 中，这一机制得到了进一步优化：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
 <span class="hljs-attr">optimizeDeps</span>: {
   <span class="hljs-comment">// v3新增选项：控制是否将CommonJS转换为ESM</span>
   <span class="hljs-attr">transformMixedEsModules</span>: <span class="hljs-literal">true</span>,
   <span class="hljs-comment">// v3性能优化：更智能的依赖发现</span>
   <span class="hljs-attr">auto</span>: <span class="hljs-literal">true</span> 
 }
}
</code></pre>
<h3 data-id="heading-5">实战应用</h3>
<ol>
<li>
<p><strong>大型monorepo项目的优化配置</strong>：
对于包含多个子包的monorepo项目，可以精确控制哪些包需要预构建：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">optimizeDeps</span>: {
  <span class="hljs-attr">include</span>: [
    <span class="hljs-string">'@project/components'</span>,
    <span class="hljs-string">'@project/utils'</span>,
    <span class="hljs-string">'lodash-es/debounce'</span>
  ],
  <span class="hljs-attr">exclude</span>: [<span class="hljs-string">'@project/internal'</span>] <span class="hljs-comment">// internal包经常变更，排除避免重复构建</span>
}
</code></pre>
</li>
<li>
<p><strong>动态导入的依赖处理</strong>：
对于按需加载的组件库（如Ant Design Vue），需要确保正确配置：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">optimizeDeps</span>: {
  <span class="hljs-attr">include</span>: [
    <span class="hljs-string">'ant-design-vue/es/button/style/css'</span>, <span class="hljs-comment">// CSS文件也需要预构建！</span>
    <span class="hljs-string">'ant-design-vue/es/modal/style/css'</span>
  ]
}
</code></pre>
</li>
</ol>
<h3 data-id="heading-6">Benchmark对比</h3>
<p>在我们的测试项目中（包含200+依赖项）：</p>
<ul>
<li>Vite 2.x平均冷启动时间：4.2s</li>
<li>Vite 3.0优化配置后：1.8s (提升57%)</li>
</ul>
<p>##技巧二：CSS处理的最佳实践</p>
<h3 data-id="heading-7">Lightning CSS深度集成</h3>
<p>Vite3提供了对Lightning CSS的实验性支持：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
 <span class="hljs-attr">css</span>: {
   <span class="hljs-attr">transformer</span>: <span class="hljs-string">'lightningcss'</span>, <span class="hljs-comment">// v3新增选项</span>
 <span class="hljs-attr">lightningcss</span>: { 
     <span class="hljs-attr">drafts</span>: { <span class="hljs-attr">nesting</span>: <span class="hljs-literal">true</span> }, <span class="hljs-comment">//启用CSS嵌套草案语法 </span>
     <span class="hljs-attr">minify</span>: <span class="hljs-literal">true</span>               <span class="hljs-comment">//生产环境自动压缩 </span>
 }
 }
}
</code></pre>
<h3 data-id="heading-8">PostCSS与Lightning CSS混合方案</h3>
<p>对于现有PostCSS插件生态的项目：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">css</span>: {
 <span class="hljs-attr">transformer</span>: <span class="hljs-string">'mixed'</span>, <span class="hljs-comment">// v3独特功能 </span>
 <span class="hljs-attr">postcss</span>: { plugins [<span class="hljs-built_in">require</span>(<span class="hljs-string">'autoprefixer'</span>)] },
 lightningcss { <span class="hljs-comment">/* lighting特有配置 */</span> } 
}
</code></pre>
<p>###实际效果对比</p>
<p>处理一个包含10,000行CSS的项目：</p>




















<table><thead><tr><th>Processor</th><th>Build Time</th><th>Output Size</th></tr></thead><tbody><tr><td>PostCSS</td><td>~1200ms</td><td>~450KB</td></tr><tr><td>Lightning</td><td>~280ms (-76%)</td><td>~390KB (-13%)</td></tr></tbody></table>
<p>##技巧三：高级HMR调优策略</p>
<p>###新版HMR架构解析</p>
<p>Vite3重新设计了HMR协议：</p>
<ol>
<li><strong>增量更新</strong>：仅发送变更模块的diff
2.<strong>智能失效</strong>：基于ESM依赖图的精确更新范围判断</li>
</ol>
<p>###自定义HMR边界设置</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// component.jsx </span>
<span class="hljs-keyword">import</span> { hot } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite/hmr'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Component</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* ... */</span> }

<span class="hljs-comment">// v3新增API定义HMR边界 </span>
hot.<span class="hljs-title function_">acceptExports</span>([<span class="hljs-string">'render'</span>], <span class="hljs-function">(<span class="hljs-params">{ render }</span>) =&gt;</span> {
 <span class="hljs-keyword">if</span> (render) <span class="hljs-title class_">Component</span>.<span class="hljs-property">render</span> = render 
})
</code></pre>
<p>###大型项目中的实测数据</p>
<p>在500+组件的后台管理系统中：</p>
<ul>
<li>HMR平均响应时间从120ms降至40ms(66%↑)</li>
<li>CPU使用率降低约40%</li>
</ul>
<p>##技巧四：生产环境构建极致优化</p>
<p>###多线程压缩新方案</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { splitVendorChunkPlugin } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
 <span class="hljs-attr">build</span>:{
 <span class="hljs-attr">terserOptions</span>:{
 numWorkers :<span class="hljs-number">4</span>, <span class="hljs-comment">//v3新增多线程支持  </span>
 <span class="hljs-attr">compress</span>:{
 passes :<span class="hljs-number">3</span>      <span class="hljs-comment">//执行多次压缩获得更好效果   </span>
 }
 },
 <span class="hljs-attr">plugins</span>:[<span class="hljs-title function_">splitVendorChunkPlugin</span>()] 
 }}
</code></pre>
<p>###分包策略进阶指南</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-attr">build</span>:{ <span class="hljs-attr">rollupOptions</span>:{ <span class="hljs-attr">output</span>:{ <span class="hljs-title function_">manualChunks</span>(<span class="hljs-params">id</span>){ <span class="hljs-keyword">if</span>(id.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'echarts'</span>)) <span class="hljs-keyword">return</span> <span class="hljs-string">'echarts'</span> <span class="hljs-keyword">if</span>(id.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'monaco-editor'</span>))<span class="hljs-keyword">return</span><span class="hljs-string">'monaco'</span> }}}}
</code></pre>
<p>##技巧五：SSR性能飞跃实践</p>
<p>###同构渲染新范式</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// server-entry.js (v3新API)</span>
<span class="hljs-keyword">import</span> { renderToString } <span class="hljs-keyword">from</span> <span class="hljs-string">'@vue/server-renderer'</span>
<span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">render</span>(<span class="hljs-params">url</span>) <span class="hljs-keyword">return</span>{
 html <span class="hljs-keyword">await</span> <span class="hljs-title function_">renderToString</span>(app),
 <span class="hljs-attr">preloadLinks</span>:vite.<span class="hljs-title function_">getPreloadLinks</span>()<span class="hljs-comment">//v特有功能  </span>
}  
</code></pre>
<p>###流式渲染基准测试</p>
<p>模拟100并发请求:</p>
<pre><code class="hljs language-scss" lang="scss">SSR Mode      TTFB    Memory Usage   
----------    ------ --------------
Traditional   <span class="hljs-number">68ms</span>       <span class="hljs-number">1.2</span>GB     
Vite <span class="hljs-built_in">Streaming32ms</span>(-<span class="hljs-number">53%</span>)<span class="hljs-number">780</span><span class="hljs-built_in">MB</span>(-<span class="hljs-number">35%</span>)
</code></pre>
<p>##总结与展望</p>
<p>通过对这五个核心领域的深度挖掘我们可以清晰地看到Vite如何在前端工具链竞争中持续保持领先地位特别是其对现代Web标准的原生支持和对大规模应用的专注使得它成为企业级应用的理想选择未来随着Bundleless理念的普及相信会有更多突破性的创新出现</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一个可以补充 Mermaid 的可视化组件库 Infographic]]></title>    <link>https://juejin.cn/post/7576592590947926050</link>    <guid>https://juejin.cn/post/7576592590947926050</guid>    <pubDate>2025-11-26T04:26:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576592590947926050" data-draft-id="7576592590947909666" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一个可以补充 Mermaid 的可视化组件库 Infographic"/> <meta itemprop="keywords" content="前端,JavaScript,LLM"/> <meta itemprop="datePublished" content="2025-11-26T04:26:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="蚂蚁集团数据体验技术"/> <meta itemprop="url" content="https://juejin.cn/user/1486195450988471"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一个可以补充 Mermaid 的可视化组件库 Infographic
            <!----> <!----></h1> <div class="container team-follow" data-v-d326b38e="" data-v-61fb5e44=""><div class="left" data-v-d326b38e=""><a href="/team/6944740539795259422/posts" data-v-d326b38e=""><img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b9909c804423411fa9fa1df65b5069d8~tplv-k3u1fbpfcp-watermark.image" class="icon" data-v-d326b38e=""/></a> <div class="content" data-v-d326b38e=""><div style="display: flex" data-v-d326b38e=""><a href="/team/6944740539795259422/posts" data-v-d326b38e=""><p class="title-line" data-v-d326b38e=""><span title="蚂蚁集团数据体验技术团队" class="title" data-v-d326b38e="">蚂蚁集团数据体验技术团队</span> <img src="//lf-web-assets.juejin.cn/obj/juejin-web/xitu_juejin_web/255e400027b783cbad76dc41527e7695.svg" alt="team icon" class="team-icon" data-v-d326b38e=""/></p></a></div> <div class="meta-box team" data-v-d326b38e="" data-v-61fb5e44=""><time datetime="2025-11-26T04:26:01.000Z" title="Wed Nov 26 2025 04:26:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-d326b38e="" data-v-61fb5e44="">
                2025-11-26
              </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-d326b38e="" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-d326b38e="" data-v-61fb5e44=""/></svg> <span class="views-count" style="display:none;" data-v-d326b38e="" data-v-61fb5e44="">
                0
              </span> <span class="read-time" data-v-d326b38e="" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-d326b38e="" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-d326b38e="" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-d326b38e="" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-d326b38e="" data-v-61fb5e44=""/></svg>
                阅读2分钟
              </span> <!----> <!----></div></div></div> <button class="jj-follow-button follow-btn" style="display:none;" data-v-b60b2868="" data-v-d326b38e=""><span data-v-b60b2868="" data-v-d326b38e=""><i class="byte-icon byte-icon--plus" data-v-d326b38e=""><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 48 48"><path fill="none" d="M0 0h48v48H0z"/><path d="M24.7 4c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8V22h16.7c.4 0 .6 0 .8.1.2.1.3.2.4.4.1.2.1.3.1.8v1.4c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1H26v16.7c0 .4 0 .6-.1.8-.1.2-.2.3-.4.4-.2.1-.3.1-.8.1h-1.4c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8V26H5.3c-.4 0-.6 0-.8-.1-.2-.1-.3-.2-.4-.4-.1-.2-.1-.3-.1-.8v-1.4c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1H22V5.3c0-.4 0-.6.1-.8.1-.2.2-.3.4-.4.2-.1.3-.1.8-.1h1.4z"/></svg></i>
        关注
      </span></button></div> <div class="team-user block-hidden" data-v-61fb5e44=""><div class="avatar jj-avatar avatar" data-v-03256cc6="" data-v-61fb5e44=""><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADwAAAA8AQMAAAAAMksxAAAAA1BMVEUAAACnej3aAAAAAXRSTlMAQObYZgAAAA5JREFUKM9jGAWjAAcAAAIcAAE27nY6AAAAAElFTkSuQmCC" alt="avatar" class="lazy avatar-img" data-v-5244ef91="" data-v-03256cc6=""/> </div> <!----> <span class="position ellipsis" data-v-61fb5e44="">
              数据可视化 @蚂蚁集团
            </span></div> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>上周末在 SEE Conf 大会上，由蚂蚁的 AntV 数据可视化团队开源 Infographic 信息图可视化，开源地址见 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fantvis%2Finfographic" title="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fantvis%2Finfographic" target="_blank">antvis/Infographic</a>，官网在<a href="https://link.juejin.cn?target=https%3A%2F%2Finfographic.antv.vision%2F" title="https://link.juejin.cn?target=https%3A%2F%2Finfographic.antv.vision%2F" target="_blank">这里</a>。</p>
<p>大概看了下，功能还是挺强的，和 Mermaid 有点像，可以互补。Mermaid 更多是一些架构图，流程图之类的技术图表，Infographic 更多的是一些文字图表，用于展示文字信息的逻辑，适用于 PPT 和写文章的场景。</p>
<p>两者结合一下，应该能有不错的效果。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/25e94de4c55d4b77837e689abf6196bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqC6JqB6ZuG5Zui5pWw5o2u5L2T6aqM5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764735961&amp;x-signature=NNuHwbnRxT6vGCf13a3Eyn2v44I%3D" alt="1.png" loading="lazy"/></p>
<h2 data-id="heading-0">介绍</h2>
<p>从官网上来看，AntV Infographic 新一代信息图可视化引擎，主要的特性如下：</p>
<ul>
<li>100+ 内置模板与组件，开箱可用；从 0 到 1 构建信息图，从未如此轻松。</li>
<li>让 AI 理解文本，抽取关键信息并生成配置，一键渲染专业信息图。</li>
<li>一键切换风格，满足不同场景需求</li>
<li>无需安装，在浏览器即可创作。丰富示例助你快速上手，轻松打造专业信息图。</li>
</ul>
<p>目标：让信息图成为 AI 时代的视觉语言基础设施。</p>
<h2 data-id="heading-1">使用案例</h2>
<p>对写代码的技术人来说，用法还是很简单的，直接用一个配置就可以渲染出一个流程图</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11c65b1a084d428898fd0e8faabce67f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqC6JqB6ZuG5Zui5pWw5o2u5L2T6aqM5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764735961&amp;x-signature=%2BhbcQmAimdL5UW0Z27ukyBKtPkU%3D" alt="2.png" loading="lazy"/></p>
<p>目前从官网看内置了 100 个信息图模版，看起来都还挺好看的。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fd86d274b504565a56ef65c248505bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqC6JqB6ZuG5Zui5pWw5o2u5L2T6aqM5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764735961&amp;x-signature=829lDaWVgOqTvvz41mU35yJN278%3D" alt="preview.jpg" loading="lazy"/></p>
<p>更多的模版截图，可以去这里看 <a href="https://link.juejin.cn?target=https%3A%2F%2Finfographic.antv.vision%2Fexamples" title="https://link.juejin.cn?target=https%3A%2F%2Finfographic.antv.vision%2Fexamples" target="_blank">Gallery</a>。另外，看文档还可以做一些自定义开发信息图，基于 <a href="https://link.juejin.cn?target=https%3A%2F%2Finfographic.antv.vision%2Freference%2Fjsx" title="https://link.juejin.cn?target=https%3A%2F%2Finfographic.antv.vision%2Freference%2Fjsx" target="_blank">JSX</a> 的语法，看不懂，这里就让技术大佬去看吧。</p>
<h2 data-id="heading-2">AI 应用</h2>
<p>官网还提供了一个 AI 应用，可以输入文字，生成 Infographic 信息可视化图表，点 <a href="https://link.juejin.cn?target=https%3A%2F%2Finfographic.antv.vision%2Fai" title="https://link.juejin.cn?target=https%3A%2F%2Finfographic.antv.vision%2Fai" target="_blank">Chat With AI</a> 体验，只需要填入 LLM Key，就可以链接生成信息图了。功能很简单，也比较清晰，没有广告，但是需要自己填入大模型 Key。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42c3d712ba0c4d86945723367dc04df8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqC6JqB6ZuG5Zui5pWw5o2u5L2T6aqM5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764735961&amp;x-signature=cP8lUsgWTzcweADlvksHtTZIPE4%3D" alt="4.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/955f92d57c0f4a0b9884e7bfcc25674a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqC6JqB6ZuG5Zui5pWw5o2u5L2T6aqM5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764735961&amp;x-signature=mwOryTGS5r6UIvh0cjRkO%2BFL77s%3D" alt="5.png" loading="lazy"/></p>
<p>我自己使用 DeepSeek 试了一下，生成了一个 3D 的图，挺好看的，生成了 10 多次，消耗大概裁 1 分钱，还是挺节省 Token 的；另外也支持一键复制代码，然后用这个开源库进行渲染。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b50aa92e85ce48d6bdf531a8cfa82476~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqC6JqB6ZuG5Zui5pWw5o2u5L2T6aqM5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764735961&amp;x-signature=WWMb0w4gJAdGU3%2F3Pckd4nXMsGM%3D" alt="6.png" loading="lazy"/></p>
<p>不过也有点问题，生成图老是这几种，没有均匀分布到 100 个信息图图表中，也不能推荐多个，可以选择，感觉可以改进一下，一定会更好用。</p>
<h2 data-id="heading-3">最后</h2>
<p>刚刚开源不久，好像都还搜索不到，相比于 picdoc、visdoc、napkin 等，更关注于开源技术迭代，而且官网也很纯粹，没有什么商业感。</p>
<p>如果官网这个 AI Agent 应用推荐更多图表，也能够用户自己选择，个人感觉不会比商业产品差，求技术大佬不要断更。</p>
<p>作者：数据可视化<br/>
链接：<a href="https://juejin.cn/post/7576571960287510563" target="_blank" title="https://juejin.cn/post/7576571960287510563">juejin.cn/post/757657…</a><br/>
来源：稀土掘金<br/>
著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[爆肝2天万字总结，飞书多维表格保姆级教程来了【建议收藏】]]></title>    <link>https://juejin.cn/post/7576646533614583862</link>    <guid>https://juejin.cn/post/7576646533614583862</guid>    <pubDate>2025-11-26T04:29:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576646533614583862" data-draft-id="7576825095134658586" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="爆肝2天万字总结，飞书多维表格保姆级教程来了【建议收藏】"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-26T04:29:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苍何"/> <meta itemprop="url" content="https://juejin.cn/user/588993963763405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            爆肝2天万字总结，飞书多维表格保姆级教程来了【建议收藏】
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993963763405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苍何
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T04:29:39.000Z" title="Wed Nov 26 2025 04:29:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是苍何的第 453 篇原创！</p>
<p>大家好，我是爱吃大饼的苍何。</p>
<p>在年初那会，做了个 DeepSeek+飞书多维表格制作人生管理系统的视频教程。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1dc56847aaa44d1d8880bb2c29ae8ef2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=tbFjzulbJy4v3OnB9%2Bz7XozeAO0%3D" alt="图片" loading="lazy"/></p>
<p>后面又陆陆续续写了很多篇飞书多维表格的文章，做了不少有意思的东西。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41d6ce75355247488e5efad628ed144f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=NBRGMO8bW7Y1TE6pBoBabov1PSI%3D" alt="图片" loading="lazy"/></p>
<p>比如这两天做了基于飞书多维表格搭建的 Nano Banana Pro 案例库和提示词，全网现在也有 30000+人曝光和使用了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe4bc246ce334c88afa670950765ea95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=fwv8eExmwD8c%2FnVm7kq0VvEwZ6k%3D" alt="图片" loading="lazy"/></p>
<p>还有社群我每天都在用的早报系统也是基于飞书多维表格自动化搭建的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40a1379c87cd4d709a739bea6f902365~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=RfVU51y6INsZyaERHwpXEWgTkJU%3D" alt="图片" loading="lazy"/></p>
<p>还有自己公众号的数据分析系统：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/04e63ada35f54cbbb56e37d6e90c4f72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=fPC5S9ScBhlwZYKEY0g8Id5vBOk%3D" alt="图片" loading="lazy"/></p>
<p>太多了，这里就不一一列出了。</p>
<p>但我发现，好像一直没有系统性的来讲讲究竟多维表格该怎么使用，这个事情，我很早就想写了，但一直被事情拖着。</p>
<p>还有我发现，真的蛮多人挺需要这样一份教程来着。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42e1503f3edc4e3cae9e2e19b00a7d61~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=ftE21Sj%2FK20BIK%2Blf3WusZBd2U0%3D" alt="图片" loading="lazy"/></p>
<p>所以我决定花时间，来出一篇保姆级的教程，来好好系统性的讲下飞书多维表格。</p>
<blockquote>
<p>写了很久，不出意外，这一篇又会非常长，可以先点赞收藏起，哈哈哈。不过我推荐你一定要划到文末，测测自己的手速!</p>
</blockquote>
<p>用 Nano Banana Pro 画了一篇本文的信息图。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5759c34abaa94184bbcbfd54b693503b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=dpioKv%2Bzaf0sJawI3fNagNSjMnM%3D" alt="图片" loading="lazy"/></p>
<p>然后用最新的 NotebookLM 做了个 LOL 风格的 PPT，感兴趣的也可以评论区留言，我来发你。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce194a315cbd43b6a3085ffd7bc57984~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=FrM84Ul7gO%2FSScxq%2BEOKmhwHi88%3D" alt="wxv_4266989325486653441" loading="lazy"/></p>
<h2 data-id="heading-0">何为飞书多维表格</h2>
<p>提起表格，大家脑子里蹦出来的第一个画面，肯定还是 Excel。</p>
<p>那问题来了，既然都有 Excel 了，为什么我们还需要飞书多维表格？它俩到底有啥本质区别？</p>
<p>如果不搞懂这个底层逻辑，你用多维表格永远只会觉得它是另一个 Excel。</p>
<p>但实际上，在我看来，<strong>Excel 是一块自由的画布，而飞书多维表格，是一个强大的数据库</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5080a3b7d18d433ea65774697d8cd6bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=kaX0iIOqy8%2F2XbTDoPAW1Pj4%2BEs%3D" alt="图片" loading="lazy"/></p>
<p>我们每天的工作，本质上就是在处理数据：小到今天跟进了几个客户、测评了哪款 AI 工具，大到整个团队的 OKR 进度、上千个项目的排期。</p>
<p>在 Excel 里，你可以在单元格 A1 写日期，在 A2 写文字，甚至在 A3 画个画，它很自由，但也因为太自由，数据是「散」的，很难被机器理解和复用。</p>
<p>而飞书多维表格，它是<strong>结构化</strong>的。</p>
<ul>
<li>字段（Fields）： 这里的列不叫列，叫字段。你必须给每一列定好「规矩」。这一列是「日期」，你就只能选时间；那一列是「单选」，你就不能瞎填文字。</li>
<li>记录（Records）： 每一行不仅仅是一行字，而是一条完整的数据资产。</li>
</ul>
<p>正是因为这种「不自由」的严格限制，才换来了后续处理数据的极大自由。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/363d695232fd45129c10943d830e383e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=O9c58gRBPOUaowJstMcslGwtf98%3D" alt="图片" loading="lazy"/></p>
<p>另外，Excel 是本地的，但飞书多维表格是云原生的，它支持单个表格一千万行数据，能容纳 1000 个人同时在线编辑。</p>
<p>最牛的是它的权限管理，不仅仅是锁住整个表，它能精确到：这一列数据，只有老板能看；那一列数据，只有财务能改。这种颗粒度的控制，传统表格很难做到。</p>
<p>当然了，我觉得非常 nice 的功能有 AI 字段捷径、仪表盘和自动化工作流，甚至可以直接能对接扣子工作流和智能体，可玩性非常多。</p>
<p>总结一下，在我的理解里，飞书多维表格是两样东西：</p>
<ul>
<li><strong>给普通人的「零代码数据库」</strong>： 你不需要懂 SQL，不需要懂编程，就能搭建出一套像 CRM、ERP 那样专业的业务管理系统。</li>
<li><strong>给极客的「AI 生产力引擎」</strong>： 它是一个以「字段」为颗粒度的自动化工厂，帮我们把重复、繁琐的信息处理工作，全部托管给 AI 和系统。</li>
</ul>
<h2 data-id="heading-1">初级玩法</h2>
<p>先说下在哪里使用，第一种是直接在飞书就可以打开：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bf79a27f0984cd2a1e73a1a1536911f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=SINVyoZ2GiGvuwWEneW7lhnudtk%3D" alt="图片" loading="lazy"/></p>
<p>现在飞书多维表格也已经独立了，第二种方式是直接打开以下地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fbase.feishu.cn%2F" target="_blank" title="https://base.feishu.cn/" ref="nofollow noopener noreferrer">base.feishu.cn/</a></p>
<p>注册好后点击新建多维表格。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c09b6702af04f63b25e015c42719df7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=g%2FkDFwXKpJCZDSIS9qaWmtBRRn4%3D" alt="图片" loading="lazy"/></p>
<p>可以基于模板创建，也可以直接新建一个空白的表格。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4263c3c8d964f7ea401b94af287b05c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=WrheL8YQtqP2Bbd1NsCFC9Odzys%3D" alt="图片" loading="lazy"/></p>
<p>这里以新建空白表格为例，点进来后是这样子的。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ffaf25288fc4d05aea3560a03fd44e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=ZAQ8jVkZM%2FPXpP%2B6QGrD3KypBRc%3D" alt="图片" loading="lazy"/></p>
<p>要想玩好多维表格，需要掌握好<strong>字段、视图、仪表盘、字段捷径、工作流、自动化</strong>这几个知识点。</p>
<p><strong>1、字段</strong></p>
<p>当鼠标点首列的剪头下拉，选择修改字段/列。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f3c747d80114a4187cea9fdc4a19a50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=g4O48M%2Bc7kYuh9nbP1S8sD3sY%2Bs%3D" alt="图片" loading="lazy"/></p>
<p>就可以看到很多的字段类型，有文本、日期、数字、超链接等。选择了对应的类型后，该列就会按照当前类型约束来，比如选择了数字，那这一列就只能填数字了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f95722d09f045ef8d4d9ac0bb4123f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=L4VeNBkppnutHtvVmI6XD2vDhAk%3D" alt="图片" loading="lazy"/></p>
<p>这里有个类型公式这个类型，很有意思，就是我选了公式后，就可以像 Excel 里函数一样进行定义公式，最牛逼的是，可以借助 AI 来生成公式。</p>
<p>比如我的公众号数据分析多维表中，赞阅比的计算就可以直接让 AI 生成公式。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02238157ba8f4323b7b76c73d22902c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=UyaqjWbpTehOEheQ4JuEZ9Mhhog%3D" alt="图片" loading="lazy"/></p>
<p>用来做数据分析不要太舒服，关键我再也不用去想复杂的公式或者手动去点点点了，AI 自动帮我就完成了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1821a36596dd47459aca73a95a7138f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=tPaQdv%2Bn%2FaPJgqxNSwV7ohAOmZc%3D" alt="图片" loading="lazy"/></p>
<p>当然在公式中也内置了很多的逻辑函数，可以直接选择使用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0280deafb808493a89a5a0d48adca555~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=v%2Buj%2FMcbVL4mf7ipnRSmiGfGbMc%3D" alt="图片" loading="lazy"/></p>
<blockquote>
<p>小 tips：如果需要上传图片、视频等，字段类型直接选择附件就好了。</p>
</blockquote>
<p><strong>2、视图</strong></p>
<p>视图就是表格数据的一种呈现方式来着，比如默认的是表格视图，也可以添加很多视图，常用的有日历视图和画册视图。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af14bc313e5d41b78a3b81674fb98469~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=ymTvR8wzHlrcBl5%2BGitAtIJmcR8%3D" alt="图片" loading="lazy"/></p>
<p>像这种画册视图，主要是为了好（zhuang）看（bi）用的，看着心情也很舒服来着，所以表格建议可以加上个附件字段搞些图上去。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af21717380874108832d1f7643cb6f63~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=xkZgdzTEgs7qTIh1zvgPsDxoGmU%3D" alt="图片" loading="lazy"/></p>
<p>其中日历视图在涉及一些需要根据日期来看数据的场景就很适合，比如项目待办等。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c19b61df8d3848ca854023abd6762b6f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=EXZSRAdkqAfkW1NM3gTed5%2FYPL8%3D" alt="图片" loading="lazy"/></p>
<p>表单视图主要用来做问卷收集数据，还是比较方便的，比如我们要组织活动问卷，就可以把多维表格数据转为表单视图，然后直接分享出去，别人填了问卷的数据就会自动落到多维表格中来。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8773efe78b240aaaec44c06ab53be3f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=Buuq2BOYJr44yQrjC3q8TB4XrWA%3D" alt="图片" loading="lazy"/></p>
<p>当然如果涉及到项目管理，也可以利用甘特视图，来查看项目整体的甘特图。</p>
<p><strong>3、仪表盘</strong></p>
<p>仪表盘我的理解其实是借助了很多的前端组件来自定义搭建的一个数据看板。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fa32ab95af3e4982b6b6584e89b11b31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=QEFoGRZrkKvWEuLLZUkaGJ%2FFdN0%3D" alt="图片" loading="lazy"/></p>
<p>比如柱状图、折线图、饼图、按钮，指标等，还是比较全的，比如我的公众号数据分析仪表盘看着就很有点击欲望，几乎每天都会在上面看数据，颇有一股当年领导看大屏数据的样子了，只不过，领导是别人，我只有自己，哈哈哈。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cc5bb3edfa4d447cb841ad22144dad38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=S6QwaR7UbrT4EgdmtB9nfgf5FVE%3D" alt="图片" loading="lazy"/></p>
<p>仪表盘的建立其实比较简单，不外乎是以下三个步骤：</p>
<ul>
<li><strong>添加组件</strong>：选择组件类型，就是要呈现啥样子的展示效果，比如折线图</li>
<li><strong>基础配置</strong>：通常需要选择数据源，数据范围、统计方式、选择字段，但也有一些各自组建需要自定义的配置。</li>
<li><strong>自定义配置</strong>：配置组件的背景颜色、标题样式、字体样式等。</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b2e1f4d90954477fbeea3d759bf1efc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=ExFCdfzsfzeRDRpa2haaHMHBHk0%3D" alt="图片" loading="lazy"/></p>
<p>怎么布局和展示完全都是可以自定义的，拖拉拽就行，然后还可以选择自己喜欢的主题。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f437a3d201424a66853323f6ba0619b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=nWuPQ19efhQMn6Jvb%2Fe8FkPKRPY%3D" alt="图片" loading="lazy"/></p>
<p>未来主题我用的比较多，看着会更显得高级科技一些。</p>
<p><strong>4、字段捷径</strong></p>
<p>字段捷径是集成了非常强大的 AI 能力，可以对该列做很多能力拓展，<strong>比如可以自动分类，信息提取、总结、翻译，自动填充，即梦生图等</strong>。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee8cb96466a04a3da96eaaa2d5ffd247~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=tISSLdtWAXulrZ38bQjkCXNdcCA%3D" alt="图片" loading="lazy"/></p>
<p>用法不难，就拿分类这个字段捷径来举例，选择「分类」后，添加好想要进行分类的类别，选择一个字段用来做分类依据，输入参考示例，自定义分类需求。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eeea215bb8944569997c4a8cd5babf85~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=n63MnQ32ZaSuhzX24cDIjWoI78g%3D" alt="图片" loading="lazy"/></p>
<p>其实就是个 AI 的 prompt，写的精准，自动分类就基本不会出错，然后打开「自动更新」按钮，就能新增一条数据就会自动根据要求做好分类。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4eefe978c2cc468e9131bbea34723e78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=TWqKqB8wyoBIeS1%2BVmyiuPLW7Fs%3D" alt="图片" loading="lazy"/></p>
<p>还比如我的 AI 早报系统这里的字段捷径选择了 DeepSeek-R1，专门做格式转换。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1590571e9aa4f56a75242603f85730e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=UrwczdpMO%2FfcVBNgHFrvp%2FUQi%2F0%3D" alt="图片" loading="lazy"/></p>
<p>其实在字段捷径中心中藏了非常多有用的字段捷径，可以直接使用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7441bb400a9d4bb9bc2a789ca13920ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=dtNP9TkGzeJIcHoUm8NRaCDr%2BUc%3D" alt="图片" loading="lazy"/></p>
<p>那如果都不够用，甚至可以自己开发字段捷径，然后发布，来满足自定义需求。</p>
<p>比如我之前在这篇文章中就有详细介绍如何将扣子智能体发布到飞书多维表格字段捷径的教程。</p>
<blockquote>
<p>用AI一键批量制作Labubu手机壁纸，这个Agent太酷啦！</p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9026ba22525d414aacfa0665e461085a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=9q53P7P9o%2B1aH7cBAKSogeLL2G0%3D" alt="图片" loading="lazy"/></p>
<p>其实就是在扣子发布渠道那里选择一下发布到多维表格，然后在多维表格中选择该字段捷径就好了。</p>
<h2 data-id="heading-2">进阶玩法</h2>
<p>说了基础的玩法，下面是进阶玩法，主要是如何做工作流、自动化以及应用模式。</p>
<p>先说下工作流，可以用节点的方式来按顺序执行指定的任务。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2558fc9d96584cf584a1a8980a51c87f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=zzFHEwRjECosf49fHiAWrvATSLU%3D" alt="图片" loading="lazy"/></p>
<p>比如我的 AI 早报可以设定一个工作流，当有记录变更时，自动发送到微信。</p>
<p>在工作流这里可以选择 AI 和节点捷径，比如 AI 读取网页链接，这个还是很实用的功能了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e3d162aceab452094cb485f15be2737~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=WAnZN9rmRnVUx8agyj4NN9ltXZA%3D" alt="图片" loading="lazy"/></p>
<p>然后自动化就是能够自动执行一些任务，比如定时发送消息啊，点击按钮触发消息、新增或修改记录时触发消息等场景。</p>
<p>使用方式，在「分享」按钮旁边。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfa70a742b5a41e3a5cb87daa24b8992~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=baRwxpjfCcJqMErls9nm24KxHfU%3D" alt="图片" loading="lazy"/></p>
<p>点击自动化后，可以选择推荐的流程，也可以自定义流程。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c51673ed6fa44ff974df3fc93ea368b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=5qRI2BUa8cTWrFRg%2BRCBnNre8cY%3D" alt="图片" loading="lazy"/></p>
<p>整个自动化其实就包含 2 大部分：「当以下情况发生时」，「就执行以下操作」。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a446aac780894725ba400378430eefc7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=gqJplSlD4buUDyivMxOjurbRcbk%3D" alt="图片" loading="lazy"/></p>
<p>比如我在 AI 早报系统就设定了非常多的自动化任务。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae20d7c006b14cd4a253b9d458a23305~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=HuiuBtv%2FL4mmBduXp0zdOIbOT28%3D" alt="图片" loading="lazy"/></p>
<p>有每日定时任务，也有按钮触发任务，还有新增修改字段任务触发的任务。</p>
<p>比如拿每天 10 点触发的自动化任务来拆解下。先选择触发条件为：每天早上 10 点。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/740e6f45d845429ea94b83ea11ef7a47~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=bA9b2m3oNcM5dF4OxfG15DUyx7w%3D" alt="图片" loading="lazy"/></p>
<p>然后在执行侧通过 HTTP 请求调用早报爬虫服务去抓取数据。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/176e1664fb0f41379eafcd3c82984c75~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=6btHsfIGp96hAzdyy2Esta22mxY%3D" alt="图片" loading="lazy"/></p>
<p>第三步，就是把抓到的数据写入多维表格。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/560ce3a9670346aa816fcb0a0a6d344e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=k42JMpV1UfC6D2c6WsgGoDx5AFQ%3D" alt="图片" loading="lazy"/></p>
<p>这样，每天 10 点在 AI 早报系统中就会自动有一条 AI 早报数据了。</p>
<p>这个是核心，其他的复杂的自动化流程都逃不开这个原理。</p>
<p>在右侧还可以查看工作流的运行日志，可以看下看下是否每天都按时能够执行。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40843ef70e794b058d18e0f1e14fcfee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=MEMa6N4dqrFMWTzDkuhKjz2bMIA%3D" alt="图片" loading="lazy"/></p>
<p>工作流和自动化的配合几乎能解决以前我们需要在程序中去做的 task 和 workflow。</p>
<p>然后最后一个就是最近新上的多维表格应用模式了。这个感觉可以单独再出一篇文章了，是真的叼，将多维表格拖拉拽就变为一个应用了。</p>
<p>内置了不少模板，像什么CRM、电商管理系统、采购管理系统，生产管理系统等都有。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/652db2d7b0c24ad089eb31836b82306b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=Zon7T8G6fqa9nz2bhMIidnazTMQ%3D" alt="图片" loading="lazy"/></p>
<p>比如这个电商直播管理系统，就是用应用模式搭建的，无敌。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23185f18f7cb443c9a0633e7d82af9ee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=1%2BTqd5HKv8vq%2FWpkl76LvaC1eIg%3D" alt="图片" loading="lazy"/></p>
<p>创建方式也比较简单，就在多维表格左下方有个「应用」，一点击就自动基于该表格创建了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed4db8d0a2c043d1820f669981316091~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=0AWdT%2F7IslL3Y7z7mmOnlSrqNPo%3D" alt="图片" loading="lazy"/></p>
<p>然后可以在这里添加页面和组件。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5b70d47170845299979a95dd4f4f6e6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=sKHipkOCzJToTPPKrQjiTShPyz8%3D" alt="图片" loading="lazy"/></p>
<p>整体导航布局可以选择侧边导航或者顶部导航，可自定义主题和背景色。都在「外观」这里设置。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/310449e83a5d4e27b8e976d413e1e518~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=a%2FLIswk5OFL3ncFpedNlaSvR3B8%3D" alt="图片" loading="lazy"/></p>
<p>点击任意组件右上角的三个小点就可以对组件进行基础配置和自定义配置。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c06f48f4ac3c47bea0212853d08a12b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=vhTVk4A2ogaRR65c5M6ndvzuIzk%3D" alt="图片" loading="lazy"/></p>
<p>比如列表组件就可以自定义字段展示、分组、排序等基础信息，以及配置是否显示筛选、排序等信息。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8583d43489fe4fc48f56459aa19ea24c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=wz8hr5Vp%2BHXwpxGawgjvFFKuhjE%3D" alt="图片" loading="lazy"/></p>
<p>可以通过添加「切片器」组件来做筛选项。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fb4c34903834614aa9c65b6188aa4c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=BzKwdfbZ5UPRfLAldo8IbTHFlZ8%3D" alt="图片" loading="lazy"/></p>
<p>最牛的是，当把多个多维表格放在同一个空间，就可以在应用中直接引用多个多维表格的信息了。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1981dc67d734407dbf1056ad1a27c2ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=tofhkSS1BCYYsMnEIegjCD0xf9o%3D" alt="图片" loading="lazy"/></p>
<p>会很方便。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3f64c592a5714691a973f5682dc01212~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=usT3c95d1n5xJOg7jWWvOa3CRlg%3D" alt="图片" loading="lazy"/></p>
<p>其实应用模式不复杂，但细节比较多，要想玩好，还是要多去试试，最好的办法就是利用应用模式复刻一个你自己想做的系统，来感受下比较好。</p>
<h2 data-id="heading-3">能做什么？</h2>
<p>其实多维表格能做的很多，但用法不同。</p>
<p>我觉得还是需要把自己现阶段一些需要系统化的数据用多维表格来解决。</p>
<p>比如我做公众号，就要用数据分析，所以我搭建了一个基于多维表格的数据分析系统。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b299fd5943a44f368ba383fb28b6ae66~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=VjwiORfcI8z4B4kiaUDK1fJC9mU%3D" alt="图片" loading="lazy"/></p>
<p>然后配合仪表盘分析，每天看自己进步一点点的感觉，就很酷。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/617786fa20c9429cb502f4659a477d93~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=HKb5x0M0mziPlW9SU%2BmOTqZ7e8Q%3D" alt="图片" loading="lazy"/></p>
<p>比如，我想记录人生更多的片段，我就会学着搭建一个人生管理系统，看看自己每天的时间被哪些占用的更多，才能更好的做复盘。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c632e1356cd4b2a9c0ac4e9dacb1433~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=yL1LrcWIm4SchfC4gAZCt4nXkVQ%3D" alt="图片" loading="lazy"/></p>
<p>想要给社群每天定时推送早报消息，我就自己搭建了一个早报系统，也方便每日看最新的 AI 资讯。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f725a0ed979046928c72a24c3302a1b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=VpAu1LOGpGcBQC%2BQrPaz%2Bk7Xt6U%3D" alt="图片" loading="lazy"/></p>
<p>想要给自己的测试 case 做一个汇总然后分享，就搭建了一个 AI case 评测系统。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4e6d0d406a294b6799b11e56b04f334c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=2b8JYOI34kd0x5%2B6iZ8F%2FoeAPL0%3D" alt="图片" loading="lazy"/></p>
<p>我甚至把公司的业务也融入到了多维表格，比如财务收入、记账等。</p>
<p>有了多维表格的各种系统，我感觉自己效率能提升不少，最关键的，我不用再去写代码搭建个系统了，就非常方便。</p>
<p>刚好我看他们现在有注册活动，用我这个邀请码：NewCanghe，</p>
<p>注册后立得 1 个月专业版免费使用，提交后等官方审核后专业版福利将在5个工作日内分批发放，加赠 2个月专业版免费使用名额，每周至少使用一次即可体验。</p>
<p>偷偷看了下专业会员权益还不少，5TB 总存储空间以及多维表格高级能力都可以用，卧槽，免费领取3个月还是很香的，赶紧去白嫖先😄。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a2be9a37e6b462394b9063fef59faee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736179&amp;x-signature=y4EBRkJ4DzlN56JBs3DMx69pN9s%3D" alt="图片" loading="lazy"/></p>
<p>兑换地址在这：<a href="https://link.juejin.cn?target=https%3A%2F%2Ffcna6swh3rtl.feishu.cn%2Fshare%2Fbase%2Fform%2Fshrcn8BkxqoKYeA6XyZZAB7zK73" target="_blank" title="https://fcna6swh3rtl.feishu.cn/share/base/form/shrcn8BkxqoKYeA6XyZZAB7zK73" ref="nofollow noopener noreferrer">fcna6swh3rtl.feishu.cn/share/base/…</a></p>
<h2 data-id="heading-4">写在最后</h2>
<p>写到这里，其实挺感慨的。从年初那个简单的视频教程，到今天这篇几千字的长文，我把自己这么久压箱底的玩法都掏出来了。</p>
<p>说实话，工具再强，终究只是工具。飞书多维表格不是万能药，它不能替你完成工作，但它能帮你<strong>理清</strong>工作。</p>
<p>作为一个曾经习惯敲代码解决一切的人，我现在更享受这种「搭积木」的快感。</p>
<p>我们折腾这些系统的初衷，从来不是为了炫技，而是为了把重复、机械的动作交给机器，把最宝贵的时间留给思考（或者去吃顿大饼）。</p>
<p>别光顾着收藏进「吃灰夹」。</p>
<p>哪怕只从一个简单的记账表或者待办清单开始，去动手试一试。</p>
<p>当你看着杂乱无章的数据，被你亲手驯服成井井有条的仪表盘时，那种对生活的掌控感，真的会上瘾。</p>
<p>如果你在搭建过程中遇到什么坑，或者有啥脑洞大开的创意，欢迎在评论区随时撩我。</p>
<p>这篇写得太久，我要滚去睡觉了，我们下期见。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TRAE SOLO中国版终于来了，完全免费！]]></title>    <link>https://juejin.cn/post/7576580177662132234</link>    <guid>https://juejin.cn/post/7576580177662132234</guid>    <pubDate>2025-11-26T04:34:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576580177662132234" data-draft-id="7576646142315937833" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TRAE SOLO中国版终于来了，完全免费！"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2025-11-26T04:34:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苍何"/> <meta itemprop="url" content="https://juejin.cn/user/588993963763405"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TRAE SOLO中国版终于来了，完全免费！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/588993963763405/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苍何
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T04:34:27.000Z" title="Wed Nov 26 2025 04:34:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这是苍何的第 454 篇原创！</p>
<p>大家好，我是还没秃顶的苍何。</p>
<p>昨晚听了 TRAE SOLO 国内版上线的发布会。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/79a52e09b1f24a669b6039c91d2450ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=0XY9x7d8iNF1Vlt%2BhvEfs9PoZBs%3D" alt="图片" loading="lazy"/></p>
<p>时隔 4 个月，它终于来了。</p>
<p>我也第一时间做了下体验，做了几个 case，录了个视频给大家看看。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46ea2fc4cbe04f63a92a4f3b65840006~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=tFRfXJgCl1EV6%2BCd0RqY8Btf6c0%3D" alt="wxv_4269304641676214281" loading="lazy"/></p>
<p>追溯到 7 月份，那时候国际版刚开 Beta 测试，全网爆火，激活码真是一码难求。我当时废了很大劲，第一时间抢鲜体验了一把，手感确实惊艳，为此还专门写过一篇文章分享。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e3bfebe492740cab632a4b7a26e89d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=wh5d7TvihbfhjeQt6wosEvfCtrk%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>也是从那时起，我和 Trae 算是「杠」上了，关系变得相当微妙。</p>
<p>后来我还成了武汉的 Trae Fellow，在武汉搞了一场黑客松。看着大家在现场用它从 0 到 1 构建项目，我是真切感受到了工具带来的变化。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/250626d7ed844bb0a57773ac8935e4ed~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=ZOAYXNR8s4WiRFhT3SGgg93OuTc%3D" alt="图片" loading="lazy"/></p>
<p>至于为啥我一直盯着 Trae 不放，又为啥觉得这次国内版 SOLO 模式的发布意义非凡？</p>
<p>理由其实很简单。</p>
<p>虽然 Cursor 很强，但网络问题把太多人挡在门外了。我们太缺一款能真正对标甚至超越 Cursor，同时又没有任何网络门槛的 AI IDE 了。</p>
<p>AI 编程不该是少数人的特权。</p>
<p>要想让这种强大的生产力真正铺开，让每个人都能体会到它的强大，就得把门槛踩碎。</p>
<p>这正是 Trae 这段时间一直在默默做的事。</p>
<p>11 月 25 日发布的这个版本，直接同步了国际版最核心的 SOLO Coder 功能，甚至包括 Plan 模式、多任务并行这些硬核能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/87dc3653e8434bfe8a2e91642294e9b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=qjd62r%2FZsZ1sX9yhB4UzN8vVVxk%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>最最关键的是，它目前<strong>完全免费</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6be1518803bd41b898e9a6726b5372a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=1HT2kZ9K6%2F3WlOMEsRiK2pbvqUY%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>可以实时跟随，还会自动打开浏览器页面预览，非常方便。</p>
<p>这就很有意思了。以前我们用 AI 写代码，总感觉像是在「开盲盒」。你给个指令，AI 闷头写，写出来能跑算运气好，不能跑你就得在那对着一堆代码干瞪眼，完全不知道它中间经历了什么心路历程。</p>
<p>但 TRAE SOLO 主打的概念叫「Responsive Coding Agent」。</p>
<p>别被这个英文吓到，我自己上手盘了一下，觉得用大白话解释就是：<strong>它不再是个只会执行命令的死板工具，而是一个能和你「有商有量」的智能队友。</strong></p>
<p>具体强在哪？我挑几个咱们写代码时最感同身受的点聊聊。</p>
<p><strong>第一，它懂得「先思考，再动手」。</strong></p>
<p>以前的 AI 是急性子，你需求还没说完，它代码可能就生成了一半。结果往往是方向错了，还得推倒重来。</p>
<p>TRAE SOLO 有个 <strong>Plan 模式</strong>。当你抛出一个复杂需求时，它不会急着写代码，而是先给你列一个 To-Do List，告诉你它准备分几步走。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28279fd152f94235a5b404a7fd0ebd35~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=CaOfEkZ3AKrNDfoJpmgRhfBExc4%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>这就很像带徒弟了。</p>
<p>你看了计划，觉得没问题，它再开工；觉得逻辑不对，直接在计划阶段就指出来。把错误扼杀在写代码之前，这才是正经的工程思维。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/015f8615e6134b819e7066e3ad68231f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=6u1MWBujjCMpZQGfr90%2FAPtwnow%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p><strong>第二，告别黑盒，代码改了哪一目了然。</strong></p>
<p>这次新增的代码变更（ <strong>DiffView</strong> ）功能我个人非常喜欢。</p>
<p>以前 AI 改代码，经常把好的逻辑也给改坏了。现在，它做了哪些新增、改了哪些逻辑，都在界面上清清楚楚地展示出来。</p>
<p>你可以实时审查（Code Review），就像看同事提交的代码一样。你没点头，它就不敢乱合并。这种「随时可掌控」的感觉，才是我们敢在实际项目里用 AI 的底气。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e79022ae1ff423f9ac7e9215d1d81a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=LLKNsMavSOSm37mOd5xYhWNQB8A%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p><strong>第三，脑子好使，还懂得「断舍离」。</strong></p>
<p>做大项目最怕 AI 聊着聊着就「失忆」，或者因为上下文太长开始胡言乱语。</p>
<p>TRAE SOLO 在这块做得比较聪明。它能支持检索海量的代码文件（据说能扛住 10 万个文件），更重要的是，它有一套自动的上下文压缩机制。</p>
<p>当对话太长时，它会自动触发压缩，保留核心信息；你也可以手动点一下压缩，让它把没用的废话清掉。这样既保留了关键记忆，又不会让模型跑偏。</p>
<p><strong>除此，它还能「分身」。</strong></p>
<p>这玩意儿支持多任务并行 sub agent。你可以开一个线程让它去修 Bug，同时开另一个线程让它去写新功能的接口。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fca08f3fe2b84b6583cd6c0291dd9d3b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=VW8Mrm4rK8LpYaLQ%2FgBVwi46z8g%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>一个人就是一支队伍，这回真不是说说而已。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6242fa3c9ee3409abcd55bc373db269f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=2GrcV1KDXI%2FxENe6DFU1J6SVv98%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>这些智能体也是可以自己创建的，点「创建智能体」就能创建了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b883d8c325084545954e87bf2212da84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=vQEIIt65AKol489Y236CkCZhRPg%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>创建好后就能看到自己拥有的智能体了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c8254192470f4ba191e26e935671b09c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=1hw0UzJ%2Fcv6k%2BVmpNYAOapnHF%2F8%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>目前国内版支持了国内顶尖的代码模型，比如 Doubao-Seed-Code、Kimi K2、GLM 4.6 等。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05f521848b7e4e1eb4a80885117a8918~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=o51GEbXYwKRgRlBQiDJ2lGQZuyk%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>也支持自定义模型。</p>
<p>同样内置不少 MCP。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8bbbf2dcefc24e199bce02b606cf6c67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=lWbEPTx5ANz1qP1IDo6th5kPxLY%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>广场能搜素到非常多好用的 MCP，配置也很简单相对 Cursor 来说。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c251ca0914e406b9c9844c0e9a4419e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6IuN5L2V:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764736467&amp;x-signature=yQ5TLllMOnxrVNqPixWLzzLjVD0%3D" alt="图片" loading="lazy"/><img src="" alt="" loading="lazy"/></p>
<p>体验下来，最大的感受就是「顺滑」。没有网络延迟的焦虑，加上这种透明的协作模式，确实能让人专注于创造本身。</p>
<p>说实话，Trae SOLO 给我的感觉是「瑕不掩瑜」。</p>
<p>如果要吹毛求疵，国内底层的代码模型在处理极度复杂的深层逻辑时，距离国外最顶尖的模型确实还有一些提升空间。这点咱们得认，模型能力的打磨还需要时间。</p>
<p>但 Trae 团队聪明的地方在于，他们用极致的产品细节弥补了这一点。</p>
<p>那种行云流水的交互感，DiffView 带来的掌控感，以及 Plan 模式下的「商量着来」，让你在使用过程中往往会忽略掉模型本身的一点小瑕疵。</p>
<p>更重要的是，它打破了那堵把无数人挡在 AI 编程门外的「墙」。</p>
<p>不用折腾网络，不用担心账单，打开就能用。对于大多数想尝试 AI 编程的朋友来说，这就够了。</p>
<p>国产 IDE 能做到这个细腻程度，值得给点掌声。</p>
<p>去试试吧，也许它就是你期待已久的那个「编程搭子」。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ASIO 定时器完全指南：类型解析、API 用法与实战示例]]></title>    <link>https://juejin.cn/post/7576609946190528548</link>    <guid>https://juejin.cn/post/7576609946190528548</guid>    <pubDate>2025-11-26T04:40:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576609946190528548" data-draft-id="7576646533614633014" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ASIO 定时器完全指南：类型解析、API 用法与实战示例"/> <meta itemprop="keywords" content="后端,C++"/> <meta itemprop="datePublished" content="2025-11-26T04:40:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喵个咪"/> <meta itemprop="url" content="https://juejin.cn/user/1350630784901262"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ASIO 定时器完全指南：类型解析、API 用法与实战示例
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1350630784901262/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喵个咪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T04:40:17.000Z" title="Wed Nov 26 2025 04:40:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">ASIO 定时器完全指南：类型解析、API 用法与实战示例</h2>
<p>ASIO（Boost.Asio 或独立的 Asio）作为高性能异步 IO 库，提供了灵活且高效的定时器组件，适用于网络编程、异步任务调度、定时触发等场景。本文将系统梳理 ASIO 定时器的核心类型、底层实现、核心 API、实战示例及常见问题，帮助开发者快速掌握其使用方法。</p>
<h3 data-id="heading-1">一、ASIO 定时器核心类型解析</h3>
<p>ASIO 提供 4 种常用定时器，均基于底层模板类实现，核心差异在于 <strong>时钟类型</strong>（决定精度、是否受系统时间影响）和 <strong>适用场景</strong>。先纠正一个常见误区：<code>high_resolution_timer</code> 并非 <code>system_timer</code>，二者是 <code>basic_waitable_timer</code> 的不同时钟特例化，属于并列关系。</p>
<h4 data-id="heading-2">1. 底层基类</h4>
<p>ASIO 定时器的底层依赖两个核心模板类：</p>
<ul>
<li><code>basic_waitable_timer&lt;Clock&gt;</code>：C++11 chrono 时钟适配的模板类，支持现代 C++ 时间标准，是 <code>steady_timer</code>、<code>system_timer</code>、<code>high_resolution_timer</code> 的基类；</li>
<li><code>basic_deadline_timer&lt;Time&gt;</code>：兼容旧版 Boost 时间类型（如 <code>boost::posix_time::ptime</code>）的模板类，仅 <code>deadline_timer</code> 基于此类实现。</li>
</ul>
<h4 data-id="heading-3">2. 四种定时器详细说明</h4>













































<table><thead><tr><th>定时器类型</th><th>底层模板与时钟类型</th><th>核心特性</th><th>精度</th><th>受系统时间影响</th><th>适用场景</th></tr></thead><tbody><tr><td><code>deadline_timer</code></td><td><code>basic_deadline_timer&lt;boost::posix_time::ptime&gt;</code></td><td>基于 Boost 旧版时间类型，依赖系统墙钟时间</td><td>毫秒级</td><td>是（修改系统时间会改变到期时间）</td><td>需与实际日历时间绑定的场景（如每天 0 点执行任务）</td></tr><tr><td><code>steady_timer</code></td><td><code>basic_waitable_timer&lt;std::chrono::steady_clock&gt;</code></td><td>基于 “稳定时钟”，时间单调递增，不受系统时间调整影响</td><td>微秒级</td><td>否</td><td>固定间隔执行的场景（如每秒采样、心跳检测）</td></tr><tr><td><code>system_timer</code></td><td><code>basic_waitable_timer&lt;std::chrono::system_clock&gt;</code></td><td>基于系统墙钟时间，与系统时间同步</td><td>微秒级</td><td>是</td><td>需关联系统时间的定时（如 2025-12-31 23:59 执行）</td></tr><tr><td><code>high_resolution_timer</code></td><td><code>basic_waitable_timer&lt;std::chrono::high_resolution_clock&gt;</code></td><td>基于系统最高精度时钟（可能是 steady_clock 或 system_clock 的高精度实现）</td><td>纳秒级（理论）</td><td>视平台而定</td><td>对精度要求极高的场景（如微秒级延迟触发）</td></tr></tbody></table>
<p><strong>关键说明：</strong></p>
<ul>
<li><code>std::chrono::high_resolution_clock</code> 的实现因平台而异：Linux 下通常是 steady_clock（不受系统时间影响），Windows 下可能是 system_clock（受影响），使用时需结合平台特性；</li>
<li><code>deadline_timer</code> 依赖 Boost 旧版时间库，若项目已迁移到 C++11+，建议优先使用 <code>steady_timer</code> / <code>system_timer</code>。</li>
</ul>
<h3 data-id="heading-4">二、核心 API 完全指南</h3>
<p>所有 ASIO 定时器的核心操作围绕 “设置到期时间、等待触发、取消定时” 展开，以下是通用 API 及关键用法（以 <code>high_resolution_timer</code> 为例，其他定时器用法一致）。</p>
<h4 data-id="heading-5">1. 构造函数</h4>
<p>定时器必须关联 <code>io_context</code>（ASIO 异步操作的核心调度器）：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 语法：template &lt;typename Clock&gt;</span>
<span class="hljs-comment">//       basic_waitable_timer&lt;Clock&gt;::basic_waitable_timer(boost::asio::io_context&amp; ctx);</span>

asio::io_context ctx;
<span class="hljs-function">asio::steady_timer <span class="hljs-title">timer1</span><span class="hljs-params">(ctx)</span></span>;          <span class="hljs-comment">// 基于稳定时钟的定时器</span>
<span class="hljs-function">asio::high_resolution_timer <span class="hljs-title">timer2</span><span class="hljs-params">(ctx)</span></span>; <span class="hljs-comment">// 高精度定时器</span>
<span class="hljs-function">asio::deadline_timer <span class="hljs-title">timer3</span><span class="hljs-params">(ctx)</span></span>;        <span class="hljs-comment">// 旧版截止时间定时器</span>
</code></pre>
<h4 data-id="heading-6">2. 设置到期时间</h4>
<p>ASIO 定时器支持两种到期时间设置方式：相对时间（从当前开始延迟多久）和绝对时间（指定具体时间点）。</p>
<h5 data-id="heading-7">（1）相对时间：<code>expires_after()</code></h5>
<p>最常用场景，直接指定延迟时长（依赖 C++11 std::chrono 时间单位）：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 延迟 1 秒到期</span>
timer.<span class="hljs-built_in">expires_after</span>(std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">1</span>));

<span class="hljs-comment">// 支持更精细的时间单位</span>
timer.<span class="hljs-built_in">expires_after</span>(std::chrono::<span class="hljs-built_in">milliseconds</span>(<span class="hljs-number">500</span>));  <span class="hljs-comment">// 500 毫秒</span>
timer.<span class="hljs-built_in">expires_after</span>(std::chrono::<span class="hljs-built_in">microseconds</span>(<span class="hljs-number">100</span>));  <span class="hljs-comment">// 100 微秒</span>
timer.<span class="hljs-built_in">expires_after</span>(std::chrono::<span class="hljs-built_in">nanoseconds</span>(<span class="hljs-number">50</span>));    <span class="hljs-comment">// 50 纳秒（高精度定时器支持）</span>
</code></pre>
<h5 data-id="heading-8">（2）绝对时间：<code>expires_at()</code></h5>
<p>指定具体时间点，需结合对应定时器的时钟类型：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// high_resolution_timer 结合 high_resolution_clock</span>
<span class="hljs-keyword">auto</span> target_time = std::chrono::high_resolution_clock::<span class="hljs-built_in">now</span>() + std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">3</span>);
timer.<span class="hljs-built_in">expires_at</span>(target_time);

<span class="hljs-comment">// steady_timer 结合 steady_clock（不受系统时间影响）</span>
<span class="hljs-keyword">auto</span> steady_target = std::chrono::steady_clock::<span class="hljs-built_in">now</span>() + std::chrono::<span class="hljs-built_in">minutes</span>(<span class="hljs-number">1</span>);
<span class="hljs-function">steady_timer <span class="hljs-title">timer</span><span class="hljs-params">(ctx)</span></span>;
timer.<span class="hljs-built_in">expires_at</span>(steady_target);

<span class="hljs-comment">// deadline_timer 结合 boost::posix_time</span>
<span class="hljs-keyword">auto</span> posix_target = boost::posix_time::second_clock::<span class="hljs-built_in">local_time</span>() + boost::posix_time::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">5</span>);
<span class="hljs-function">deadline_timer <span class="hljs-title">dt</span><span class="hljs-params">(ctx)</span></span>;
dt.<span class="hljs-built_in">expires_at</span>(posix_target);
</code></pre>
<h5 data-id="heading-9">3. 获取到期时间：<code>expiry()</code></h5>
<p>返回定时器的绝对到期时间（返回类型与时钟类型匹配）：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// high_resolution_timer 的到期时间类型：std::chrono::high_resolution_clock::time_point</span>
<span class="hljs-keyword">auto</span> expiry_time = timer.<span class="hljs-built_in">expiry</span>();

<span class="hljs-comment">// 转换为人类可读时间（示例）</span>
<span class="hljs-keyword">auto</span> duration = expiry_time.<span class="hljs-built_in">time_since_epoch</span>();
<span class="hljs-keyword">auto</span> seconds = std::chrono::<span class="hljs-built_in">duration_cast</span>&lt;std::chrono::seconds&gt;(duration).<span class="hljs-built_in">count</span>();
std::cout &lt;&lt; <span class="hljs-string">"到期时间："</span> &lt;&lt; seconds &lt;&lt; <span class="hljs-string">" 秒（自时钟纪元起）\n"</span>;
</code></pre>
<h5 data-id="heading-10">4. 等待方式：同步 vs 异步</h5>
<p>ASIO 定时器支持 <strong>同步等待</strong>（阻塞当前线程）和 <strong>异步等待</strong>（非阻塞，通过回调触发），后者是 ASIO 的核心设计理念。</p>
<h6 data-id="heading-11">（1）同步等待：<code>wait()</code></h6>
<p>阻塞当前线程，直到定时器到期或被取消，返回 error_code 表示结果：</p>
<pre><code class="hljs language-cpp" lang="cpp">asio::io_context ctx;
<span class="hljs-function">asio::steady_timer <span class="hljs-title">timer</span><span class="hljs-params">(ctx, std::chrono::seconds(<span class="hljs-number">2</span>))</span></span>; <span class="hljs-comment">// 直接构造时指定延迟</span>

<span class="hljs-comment">// 同步等待（阻塞 2 秒）</span>
boost::system::error_code ec;
timer.<span class="hljs-built_in">wait</span>(ec);

<span class="hljs-keyword">if</span> (!ec) {
    std::cout &lt;&lt; <span class="hljs-string">"定时器到期（同步等待）\n"</span>;
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ec == asio::error::operation_aborted) {
    std::cout &lt;&lt; <span class="hljs-string">"定时器被取消（同步等待）\n"</span>;
}
</code></pre>
<h6 data-id="heading-12">（2）异步等待：<code>async_wait()</code></h6>
<p>非阻塞调用，定时器到期后触发回调函数（回调在 <code>io_context::run()</code> 所在线程执行）：</p>
<pre><code class="hljs language-cpp" lang="cpp">timer.<span class="hljs-built_in">async_wait</span>([](boost::system::error_code ec) {
    <span class="hljs-keyword">if</span> (!ec) {
        std::cout &lt;&lt; <span class="hljs-string">"定时器到期（异步回调）\n"</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ec == asio::error::operation_aborted) {
        std::cout &lt;&lt; <span class="hljs-string">"定时器被取消（异步回调）\n"</span>;
    }
});

<span class="hljs-comment">// 必须调用 io_context::run()，否则回调无法执行（ASIO 事件循环）</span>
ctx.<span class="hljs-built_in">run</span>();
</code></pre>
<h6 data-id="heading-13">5. 取消定时器：<code>cancel()</code>/<code>cancel_one()</code>/<code>cancel_all()</code></h6>
<ul>
<li><code>cancel()</code>：取消所有未完成的等待操作，所有关联的回调会收到 <code>asio::error::operation_aborted</code> 错误码；</li>
<li><code>cancel_one()</code>：仅取消一个未完成的等待操作；</li>
<li><code>cancel_all()</code>：与 <code>cancel()</code> 功能一致（ASIO 3.0+ 推荐使用）。</li>
</ul>
<p>示例：取消异步定时器</p>
<pre><code class="hljs language-cpp" lang="cpp">asio::io_context ctx;
<span class="hljs-function">asio::high_resolution_timer <span class="hljs-title">timer</span><span class="hljs-params">(ctx)</span></span>;
timer.<span class="hljs-built_in">expires_after</span>(std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">5</span>));

<span class="hljs-comment">// 异步等待</span>
timer.<span class="hljs-built_in">async_wait</span>([](boost::system::error_code ec) {
    <span class="hljs-keyword">if</span> (ec == asio::error::operation_aborted) {
        std::cout &lt;&lt; <span class="hljs-string">"定时器被成功取消\n"</span>;
    }
});

<span class="hljs-comment">// 1 秒后取消定时器</span>
std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">1</span>));
timer.<span class="hljs-built_in">cancel</span>(); <span class="hljs-comment">// 触发回调的取消错误码</span>

ctx.<span class="hljs-built_in">run</span>(); <span class="hljs-comment">// 必须运行事件循环，否则回调无法执行</span>
</code></pre>
<h3 data-id="heading-14">三、实战示例（分场景）</h3>
<h4 data-id="heading-15">示例 1：异步重复定时（固定间隔，不受系统时间影响）</h4>
<p>使用 <code>steady_timer</code> 实现每秒执行一次的重复定时（推荐用于心跳检测、数据采样）：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;boost/asio.hpp&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;chrono&gt;</span></span>

<span class="hljs-keyword">namespace</span> asio = boost::asio;
<span class="hljs-keyword">using</span> error_code = boost::system::error_code;

<span class="hljs-comment">// 重复定时回调函数（递归调用实现循环）</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">repeat_timer</span><span class="hljs-params">(asio::steady_timer&amp; timer, <span class="hljs-type">int</span>&amp; count)</span> </span>{
    <span class="hljs-comment">// 每次等待 1 秒</span>
    timer.<span class="hljs-built_in">expires_after</span>(std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">1</span>));

    timer.<span class="hljs-built_in">async_wait</span>([&amp;](error_code ec) {
        <span class="hljs-keyword">if</span> (ec == asio::error::operation_aborted) {
            std::cout &lt;&lt; <span class="hljs-string">"重复定时器被取消，累计执行 "</span> &lt;&lt; count &lt;&lt; <span class="hljs-string">" 次\n"</span>;
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-comment">// 定时任务：打印计数</span>
        count++;
        std::cout &lt;&lt; <span class="hljs-string">"重复定时执行第 "</span> &lt;&lt; count &lt;&lt; <span class="hljs-string">" 次\n"</span>;

        <span class="hljs-comment">// 递归调用，实现重复定时（ASIO 回调队列执行，无栈溢出风险）</span>
        <span class="hljs-built_in">repeat_timer</span>(timer, count);
    });
}

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    asio::io_context ctx;
    <span class="hljs-function">asio::steady_timer <span class="hljs-title">timer</span><span class="hljs-params">(ctx)</span></span>;
    <span class="hljs-type">int</span> count = <span class="hljs-number">0</span>;

    <span class="hljs-comment">// 启动重复定时</span>
    <span class="hljs-built_in">repeat_timer</span>(timer, count);

    <span class="hljs-comment">// 运行事件循环（阻塞，直到定时器被取消）</span>
    <span class="hljs-function">std::thread <span class="hljs-title">t</span><span class="hljs-params">([&amp;]() { ctx.run(); })</span></span>;

    <span class="hljs-comment">// 主线程等待 5 秒后取消定时器</span>
    std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">5</span>));
    timer.<span class="hljs-built_in">cancel</span>();

    t.<span class="hljs-built_in">join</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-16">示例 2：绝对时间定时（关联系统时间）</h4>
<p>使用 <code>system_timer</code> 实现 “指定系统时间点执行任务”（如 3 秒后执行，受系统时间修改影响）：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;boost/asio.hpp&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;chrono&gt;</span></span>

<span class="hljs-keyword">namespace</span> asio = boost::asio;
<span class="hljs-keyword">using</span> error_code = boost::system::error_code;

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    asio::io_context ctx;
    <span class="hljs-function">asio::system_timer <span class="hljs-title">timer</span><span class="hljs-params">(ctx)</span></span>;

    <span class="hljs-comment">// 设置绝对到期时间：当前系统时间 + 3 秒</span>
    <span class="hljs-keyword">auto</span> target_time = std::chrono::system_clock::<span class="hljs-built_in">now</span>() + std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">3</span>);
    timer.<span class="hljs-built_in">expires_at</span>(target_time);

    <span class="hljs-comment">// 异步等待</span>
    timer.<span class="hljs-built_in">async_wait</span>([](error_code ec) {
        <span class="hljs-keyword">if</span> (!ec) {
            <span class="hljs-comment">// 转换系统时间为可读格式</span>
            <span class="hljs-keyword">auto</span> now = std::chrono::system_clock::<span class="hljs-built_in">to_time_t</span>(std::chrono::system_clock::<span class="hljs-built_in">now</span>());
            std::cout &lt;&lt; <span class="hljs-string">"绝对时间定时触发，当前系统时间："</span> &lt;&lt; <span class="hljs-built_in">ctime</span>(&amp;now);
        }
    });

    ctx.<span class="hljs-built_in">run</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-17">示例 3：多定时器管理与批量取消</h4>
<p>同时管理多个定时器，支持批量取消操作：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;boost/asio.hpp&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;chrono&gt;</span></span>

<span class="hljs-keyword">namespace</span> asio = boost::asio;
<span class="hljs-keyword">using</span> error_code = boost::system::error_code;

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    asio::io_context ctx;
    std::vector&lt;asio::steady_timer&gt; timers; <span class="hljs-comment">// 存储多个定时器</span>

    <span class="hljs-comment">// 创建 3 个定时器，分别延迟 1、2、3 秒</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">3</span>; ++i) {
        timers.<span class="hljs-built_in">emplace_back</span>(ctx);
        <span class="hljs-keyword">auto</span>&amp; timer = timers.<span class="hljs-built_in">back</span>();
        timer.<span class="hljs-built_in">expires_after</span>(std::chrono::<span class="hljs-built_in">seconds</span>(i));

        <span class="hljs-comment">// 每个定时器的回调（打印自身延迟时间）</span>
        timer.<span class="hljs-built_in">async_wait</span>([i](error_code ec) {
            <span class="hljs-keyword">if</span> (!ec) {
                std::cout &lt;&lt; <span class="hljs-string">"定时器 "</span> &lt;&lt; i &lt;&lt; <span class="hljs-string">" 秒到期\n"</span>;
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ec == asio::error::operation_aborted) {
                std::cout &lt;&lt; <span class="hljs-string">"定时器 "</span> &lt;&lt; i &lt;&lt; <span class="hljs-string">" 秒被取消\n"</span>;
            }
        });
    }

    <span class="hljs-comment">// 2.5 秒后批量取消所有定时器</span>
    <span class="hljs-function">std::thread <span class="hljs-title">cancel_thread</span><span class="hljs-params">([&amp;]() {
        std::this_thread::sleep_for(std::chrono::milliseconds(<span class="hljs-number">2500</span>));
        std::cout &lt;&lt; <span class="hljs-string">"\n开始批量取消定时器...\n"</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; timer : timers) {
            timer.cancel();
        }
    })</span></span>;

    ctx.<span class="hljs-built_in">run</span>();
    cancel_thread.<span class="hljs-built_in">join</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h4 data-id="heading-18">示例 4：结合 Strand 保证回调线程安全</h4>
<p>多线程运行 <code>io_context::run()</code> 时，回调可能在不同线程执行，使用 <code>asio::strand</code> 确保回调串行执行：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;boost/asio.hpp&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;chrono&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;thread&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;mutex&gt;</span></span>

<span class="hljs-keyword">namespace</span> asio = boost::asio;
<span class="hljs-keyword">using</span> error_code = boost::system::error_code;

std::mutex cout_mtx; <span class="hljs-comment">// 控制台输出互斥锁</span>

<span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{
    asio::io_context ctx;
    <span class="hljs-function">asio::strand&lt;asio::io_context::executor_type&gt; <span class="hljs-title">strand</span><span class="hljs-params">(ctx.get_executor())</span></span>; <span class="hljs-comment">// 串行执行strand</span>
    <span class="hljs-function">asio::steady_timer <span class="hljs-title">timer</span><span class="hljs-params">(ctx)</span></span>;

    <span class="hljs-comment">// 绑定 strand 到回调，确保回调串行执行</span>
    timer.<span class="hljs-built_in">expires_after</span>(std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">1</span>));
    timer.<span class="hljs-built_in">async_wait</span>(asio::<span class="hljs-built_in">bind_executor</span>(strand, [&amp;](error_code ec) {
        <span class="hljs-keyword">if</span> (!ec) {
            std::lock_guard&lt;std::mutex&gt; <span class="hljs-built_in">lock</span>(cout_mtx);
            std::cout &lt;&lt; <span class="hljs-string">"回调线程 ID: "</span> &lt;&lt; std::this_thread::<span class="hljs-built_in">get_id</span>() &lt;&lt; <span class="hljs-string">"（第一次）\n"</span>;
        }

        <span class="hljs-comment">// 重复定时</span>
        timer.<span class="hljs-built_in">expires_after</span>(std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">1</span>));
        timer.<span class="hljs-built_in">async_wait</span>(asio::<span class="hljs-built_in">bind_executor</span>(strand, [&amp;](error_code ec) {
            <span class="hljs-keyword">if</span> (!ec) {
                std::lock_guard&lt;std::mutex&gt; <span class="hljs-built_in">lock</span>(cout_mtx);
                std::cout &lt;&lt; <span class="hljs-string">"回调线程 ID: "</span> &lt;&lt; std::this_thread::<span class="hljs-built_in">get_id</span>() &lt;&lt; <span class="hljs-string">"（第二次）\n"</span>;
            }
        }));
    }));

    <span class="hljs-comment">// 多线程运行 io_context</span>
    <span class="hljs-function">std::thread <span class="hljs-title">t1</span><span class="hljs-params">([&amp;]() { ctx.run(); })</span></span>;
    <span class="hljs-function">std::thread <span class="hljs-title">t2</span><span class="hljs-params">([&amp;]() { ctx.run(); })</span></span>;

    t1.<span class="hljs-built_in">join</span>();
    t2.<span class="hljs-built_in">join</span>();
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<h3 data-id="heading-19">四、编译与运行说明</h3>
<h4 data-id="heading-20">1. 依赖库</h4>
<ul>
<li>Boost.Asio：需链接 <code>boost_system</code> 库（若使用 Boost 版本）；</li>
<li>线程库：ASIO 异步操作依赖线程支持，需链接 <code>pthread</code>（Linux/macOS）或 <code>ws2_32</code>（Windows）。</li>
</ul>
<h4 data-id="heading-21">2. 编译命令（Linux/macOS）</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># C++11+ 标准（推荐 C++17）</span>
g++ -std=c++17 timer_demo.cpp -o timer_demo -lboost_system -lpthread
</code></pre>
<h4 data-id="heading-22">3. 运行方式</h4>
<pre><code class="hljs language-bash" lang="bash">./timer_demo
</code></pre>
<h3 data-id="heading-23">五、常见问题与注意事项</h3>
<h4 data-id="heading-24">1. 系统时间修改对定时器的影响</h4>
<ul>
<li><code>steady_timer</code>：不受影响（基于单调递增时钟），适合固定间隔任务；</li>
<li><code>system_timer</code>/<code>deadline_timer</code>：受影响（基于系统墙钟时间），修改系统时间可能导致定时器提前 / 延迟到期；</li>
<li><code>high_resolution_timer</code>：视平台而定（Linux 下通常是 <code>steady_clock</code>，Windows 下可能是 <code>system_clock</code>）。</li>
</ul>
<h4 data-id="heading-25">2. 重复定时的正确实现</h4>
<p>避免在回调外重复调用 <code>async_wait()</code>，应在回调内部重新设置到期时间并调用 <code>async_wait()</code>（如示例 1），确保定时间隔准确。</p>
<h4 data-id="heading-26">3. 回调函数的线程安全</h4>
<ul>
<li><code>io_context::run()</code> 在哪条线程执行，回调就在哪条线程执行；</li>
<li>多线程运行 <code>io_context::run()</code> 时，回调可能在不同线程并发执行，需通过 <code>strand</code> 或互斥锁保证共享数据安全。</li>
</ul>
<h4 data-id="heading-27">4. 定时器取消后的复用</h4>
<p>取消定时器后，需重新调用 <code>expires_after()</code>/<code>expires_at()</code> 设置到期时间，才能再次调用 <code>wait()</code>/<code>async_wait()</code>。</p>
<h4 data-id="heading-28">5. 高精度定时的限制</h4>
<ul>
<li><code>high_resolution_timer</code> 的纳秒级精度是 “理论值”，实际精度受操作系统调度、硬件时钟影响（通常能达到微秒级）；</li>
<li>避免过度追求高精度，若无需纳秒级需求，优先使用 <code>steady_timer</code>（兼容性更好）。</li>
</ul>
<h3 data-id="heading-29">六、进阶用法</h3>
<h4 data-id="heading-30">1. 延迟初始化定时器</h4>
<p>先创建定时器，后续根据业务逻辑动态设置到期时间：</p>
<pre><code class="hljs language-cpp" lang="cpp">asio::io_context ctx;
<span class="hljs-function">asio::steady_timer <span class="hljs-title">timer</span><span class="hljs-params">(ctx)</span></span>; <span class="hljs-comment">// 仅初始化，不设置到期时间</span>

<span class="hljs-comment">// 业务逻辑触发后，设置并启动定时器</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">start_timer</span><span class="hljs-params">()</span> </span>{
    timer.<span class="hljs-built_in">expires_after</span>(std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">2</span>));
    timer.<span class="hljs-built_in">async_wait</span>([](error_code ec) {
        <span class="hljs-keyword">if</span> (!ec) {
            std::cout &lt;&lt; <span class="hljs-string">"延迟初始化的定时器到期\n"</span>;
        }
    });
}

<span class="hljs-comment">// 模拟业务触发</span>
<span class="hljs-built_in">start_timer</span>();
ctx.<span class="hljs-built_in">run</span>();
</code></pre>
<h4 data-id="heading-31">2. 定时器超时异常处理</h4>
<p>通过 <code>expiry()</code> 检查定时器是否超时，或在回调中处理异常场景：</p>
<pre><code class="hljs language-cpp" lang="cpp">timer.<span class="hljs-built_in">async_wait</span>([&amp;](error_code ec) {
    <span class="hljs-keyword">if</span> (ec == asio::error::operation_aborted) {
        <span class="hljs-keyword">return</span>;
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ec) {
        std::cerr &lt;&lt; <span class="hljs-string">"定时器异常："</span> &lt;&lt; ec.<span class="hljs-built_in">message</span>() &lt;&lt; <span class="hljs-string">"\n"</span>;
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 检查实际到期时间与预期是否一致（处理超时偏差）</span>
    <span class="hljs-keyword">auto</span> actual_expiry = timer.<span class="hljs-built_in">expiry</span>();
    <span class="hljs-keyword">auto</span> expected_expiry = std::chrono::steady_clock::<span class="hljs-built_in">now</span>() - std::chrono::<span class="hljs-built_in">seconds</span>(<span class="hljs-number">1</span>);
    <span class="hljs-keyword">auto</span>偏差 = std::chrono::<span class="hljs-built_in">duration_cast</span>&lt;std::chrono::milliseconds&gt;(actual_expiry - expected_expiry).<span class="hljs-built_in">count</span>();
    <span class="hljs-keyword">if</span> (std::<span class="hljs-built_in">abs</span>(偏差) &gt; <span class="hljs-number">10</span>) { <span class="hljs-comment">// 偏差超过 10 毫秒</span>
        std::cout &lt;&lt; <span class="hljs-string">"定时器偏差过大："</span> &lt;&lt; 偏差 &lt;&lt; <span class="hljs-string">" 毫秒\n"</span>;
    }
});
</code></pre>
<h3 data-id="heading-32">七、总结</h3>
<p>ASIO 定时器通过灵活的时钟适配和异步设计，满足了不同场景下的定时需求：</p>
<ul>
<li>固定间隔任务：优先使用 <code>steady_timer</code>（不受系统时间影响）；</li>
<li>关联系统时间的任务：使用 <code>system_timer</code> 或 <code>deadline_timer</code>；</li>
<li>高精度需求：使用 <code>high_resolution_timer</code>（注意平台差异）。</li>
</ul>
<p>掌握 <code>expires_after()</code>/<code>expires_at()``、async_wait()</code>、<code>cancel()</code> 等核心 API，结合 <code>io_context</code> 和 <code>strand</code> 进行调度，可实现高效、线程安全的定时逻辑。实际开发中需注意系统时间影响、回调线程安全等问题，根据业务场景选择合适的定时器类型。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[代码特殊注释完整规范：IDE 支持、使用示例与团队协作指南]]></title>    <link>https://juejin.cn/post/7576609946190561316</link>    <guid>https://juejin.cn/post/7576609946190561316</guid>    <pubDate>2025-11-26T04:41:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576609946190561316" data-draft-id="7576609946190544932" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="代码特殊注释完整规范：IDE 支持、使用示例与团队协作指南"/> <meta itemprop="keywords" content="IntelliJ IDEA,Visual Studio Code"/> <meta itemprop="datePublished" content="2025-11-26T04:41:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喵个咪"/> <meta itemprop="url" content="https://juejin.cn/user/1350630784901262"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            代码特殊注释完整规范：IDE 支持、使用示例与团队协作指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1350630784901262/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喵个咪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T04:41:11.000Z" title="Wed Nov 26 2025 04:41:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">代码特殊注释完整规范：IDE 支持、使用示例与团队协作指南</h2>
<h3 data-id="heading-1">一、完整注释表格</h3>



































































































































<table><thead><tr><th>注释名</th><th>核心作用说明</th><th>适用场景细分</th><th>VSC</th><th>VS</th><th>JetBrains</th><th>优先级建议</th></tr></thead><tbody><tr><td>TODO</td><td>功能未实现（尚未启动开发）</td><td>新需求、未动工的模块 / 接口</td><td>[x]</td><td>[x]</td><td>[x]</td><td>中 - 高</td></tr><tr><td>TODO:HIGH/MID/LOW</td><td>带优先级的未实现功能</td><td>需区分紧急程度（如 HIGH = 迭代必做，LOW = 后续优化）</td><td>[]</td><td>[]</td><td>[x]</td><td>自定义</td></tr><tr><td>UNDONE</td><td>功能未完成（已开发部分，待收尾）</td><td>开发中被打断、需补充细节 / 边界处理的功能</td><td>[]</td><td>[x]</td><td>[]</td><td>中</td></tr><tr><td>FIXME</td><td>已发现明确 Bug，需修复</td><td>可复现、定位清晰的缺陷（含潜在风险未复现的问题）</td><td>[]</td><td>[]</td><td>[x]</td><td>高</td></tr><tr><td>FIXME:URGENT</td><td>紧急 Bug 修复</td><td>线上故障、阻塞测试的核心流程缺陷</td><td>[]</td><td>[]</td><td>[x]</td><td>最高</td></tr><tr><td>BUG</td><td>已确认的具体缺陷</td><td>区别于 FIXME：更侧重 “已复现 + 影响范围明确” 的 Bug（如 “用户 ID&gt;1000 时查询失败”）</td><td>[]</td><td>[]</td><td>[]</td><td>高</td></tr><tr><td>HACK</td><td>临时解决方案 / 取巧实现</td><td>功能可用，但代码不优雅（如硬编码、规避框架限制），待重构</td><td>[]</td><td>[x]</td><td>[]</td><td>中</td></tr><tr><td>XXX</td><td>待优化问题（设计 / 实现不规范）</td><td>非紧急缺陷，如命名不规范、冗余代码、逻辑可简化（优先级低于 HACK/FIXME）</td><td>[]</td><td>[]</td><td>[]</td><td>低 - 中</td></tr><tr><td>UnresolvedMergeConflict</td><td>未解决的代码合并冲突</td><td>Git 合并分支时产生的冲突，需手动对比处理</td><td>[]</td><td>[x]</td><td>[]</td><td>最高</td></tr><tr><td>NOTE</td><td>重要说明 / 备注</td><td>记录设计思路、依赖条件、使用限制（如 “依赖第三方 SDK v2.3.0，升级需改签名”）</td><td>[]</td><td>[]</td><td>[x]</td><td>-</td></tr><tr><td>DEPRECATED</td><td>已废弃的代码 / 接口</td><td>不建议继续使用，后续版本会删除（需标注替代方案）</td><td>[]</td><td>[]</td><td>[x]</td><td>-</td></tr><tr><td>REVIEW</td><td>需代码审查 / 复核</td><td>复杂逻辑、高风险模块（如权限控制、支付流程），需团队复核</td><td>[]</td><td>[]</td><td>[]</td><td>中</td></tr><tr><td>OPTIMIZE</td><td>性能 / 结构优化</td><td>代码可运行，但效率低（如 O (n²) 循环）或结构混乱，需重构</td><td>[]</td><td>[]</td><td>[]</td><td>低 - 中</td></tr></tbody></table>
<blockquote>
<p>注：IDE 支持标记说明</p>
<ul>
<li>
<p>[x]：原生自带识别（无需额外配置）</p>
</li>
<li>
<p>[]：需通过插件 / 自定义配置实现识别（下文附配置方法）</p>
</li>
</ul>
</blockquote>
<h3 data-id="heading-2">二、规范使用示例（C++/ 通用语法）</h3>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// <span class="hljs-doctag">TODO:</span>HIGH 实现用户登录的短信验证码校验（截止2025-12-15，依赖短信SDK集成）</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">userLogin</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; phone, <span class="hljs-type">const</span> std::string&amp; code)</span> </span>{
    <span class="hljs-comment">// UNDONE 补充验证码过期时间校验（已实现发送逻辑，待加时效判断）</span>
    <span class="hljs-keyword">if</span> (code.<span class="hljs-built_in">empty</span>()) {
        <span class="hljs-comment">// <span class="hljs-doctag">FIXME:</span>URGENT 空字符串导致崩溃，需添加参数非空校验（线上已反馈3例）</span>
        <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">invalid_argument</span>(<span class="hljs-string">"code is empty"</span>);
    }

    <span class="hljs-comment">// BUG 当phone长度&gt;11位时，数据库查询返回空指针（复现步骤：输入12位手机号）</span>
    <span class="hljs-keyword">auto</span> user = db.<span class="hljs-built_in">queryUser</span>(phone);

    <span class="hljs-comment">// HACK 临时用sleep规避并发问题，后续需改用互斥锁（<span class="hljs-doctag">TODO:</span>MID 优化并发控制）</span>
    std::this_thread::<span class="hljs-built_in">sleep_for</span>(std::chrono::<span class="hljs-built_in">milliseconds</span>(<span class="hljs-number">500</span>));

    <span class="hljs-comment">// XXX 硬编码"admin"，需改为配置项（config.h中添加ADMIN_ROLE常量）</span>
    <span class="hljs-keyword">if</span> (user-&gt;role == <span class="hljs-string">"admin"</span>) {
        <span class="hljs-comment">// NOTE 管理员登录无需二次验证（产品需求：见文档P12）</span>
        <span class="hljs-built_in">skipSecondAuth</span>();
    }

    <span class="hljs-comment">// DEPRECATED 该接口将在v2.0删除，替代方案：UserService::newGetUserInfo(phone)</span>
    <span class="hljs-keyword">auto</span> oldInfo = <span class="hljs-built_in">getUserInfo</span>(phone);

    <span class="hljs-comment">// REVIEW 权限判断逻辑较复杂，需复核是否存在越权风险（涉及用户角色、资源所有权）</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">checkPermission</span>(user, resourceId)) {
        <span class="hljs-keyword">return</span> FORBIDDEN;
    }

    <span class="hljs-comment">// OPTIMIZE 循环遍历全量用户效率低，需添加索引+分页查询（数据量&gt;1万时卡顿）</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; u : allUsers) {
        <span class="hljs-keyword">if</span> (u.id == targetId) { <span class="hljs-comment">/* ... */</span> }
    }
}

<span class="hljs-comment">// UnresolvedMergeConflict 合并feature/pay分支时冲突：支付回调地址配置（需确认用测试/正式地址）</span>
<span class="hljs-comment">// const std::string callbackUrl = "https://test-pay.example.com/callback";</span>
<span class="hljs-comment">// const std::string callbackUrl = "https://pay.example.com/callback";</span>
</code></pre>
<h3 data-id="heading-3">三、各 IDE 高效使用指南（查看 + 自定义配置）</h3>
<h4 data-id="heading-4">1. 原生查看方式（无需配置）</h4>

























<table><thead><tr><th>IDE</th><th>查看入口</th><th>支持的默认注释</th></tr></thead><tbody><tr><td>VS Code</td><td>终端 → 运行任务 → 任务：显示任务</td><td>TODO</td></tr><tr><td>Visual Studio</td><td>视图 → 任务列表（默认 “注释” 分类）</td><td>TODO、UNDONE、HACK、UnresolvedMergeConflict</td></tr><tr><td>JetBrains</td><td>视图 → 工具窗口 → TODO（可筛选优先级）</td><td>TODO、FIXME、NOTE、DEPRECATED、带后缀的 TODO/FIXME</td></tr></tbody></table>
<h4 data-id="heading-5">2. 自定义配置（扩展支持更多注释）</h4>
<h5 data-id="heading-6">（1）VS Code（推荐插件：Todo Tree）</h5>
<ul>
<li>安装插件：搜索 <code>Todo Tree</code>（支持高亮、侧边栏筛选、自定义规则）</li>
<li>配置自定义注释（文件 → 首选项 → 设置 → 搜索 <code>Todo Tree: Pattern</code>）：
<pre><code class="hljs language-json" lang="json"><span class="hljs-attr">"todo-tree.highlights.customHighlight"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
<span class="hljs-attr">"BUG"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"icon"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"bug"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"color"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#ff0000"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"backgroundColor"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#ffebee"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">"REVIEW"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"icon"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"check-circle"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"color"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#ff9900"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"backgroundColor"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#fff3e0"</span> <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
<span class="hljs-attr">"OPTIMIZE"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span> <span class="hljs-attr">"icon"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"rocket"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"color"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#0099ff"</span><span class="hljs-punctuation">,</span> <span class="hljs-attr">"backgroundColor"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"#e3f2fd"</span> <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
</li>
<li>效果：侧边栏生成 Todo Tree 面板，可按注释类型 / 颜色筛选。</li>
</ul>
<h5 data-id="heading-7">（2）Visual Studio（添加自定义任务令牌）</h5>
<ul>
<li>
<p>步骤：工具 → 选项 → 环境 → 任务列表 → 点击 “添加”</p>
</li>
<li>
<p>配置示例：</p>





















<table><thead><tr><th>令牌</th><th>说明</th></tr></thead><tbody><tr><td>BUG</td><td>已确认的具体缺陷</td></tr><tr><td>REVIEW</td><td>需代码审查</td></tr><tr><td>OPTIMIZE</td><td>性能 / 结构优化</td></tr></tbody></table>
</li>
<li>
<p>效果：<code>// BUG xxx</code> 会显示在 “任务列表” 的 “注释” 分类中。</p>
</li>
</ul>
<h5 data-id="heading-8">（3）JetBrains（添加 TODO 模式）</h5>
<ul>
<li>步骤：File → Settings → Tools → TODO → 点击 “+”</li>
<li>配置示例（正则表达式）：

























<table><thead><tr><th>模式</th><th>描述</th><th>颜色</th></tr></thead><tbody><tr><td><code>BUG\s*:</code></td><td>已确认的 Bug</td><td>红色</td></tr><tr><td><code>REVIEW\s*:</code></td><td>需代码审查</td><td>橙色</td></tr><tr><td><code>OPTIMIZE\s*:</code></td><td>性能优化</td><td>蓝色</td></tr></tbody></table>
</li>
<li>效果：<code>// BUG: xxx</code> 会在 TODO 面板中单独分类，支持筛选。</li>
</ul>
<h3 data-id="heading-9">四、团队协作核心规则（避免混乱）</h3>
<h4 data-id="heading-10">1. 明确使用边界：</h4>
<ul>
<li>不混用 <code>TODO</code> 和 <code>UNDONE</code>：未动工用 TODO，开发中未完成用 UNDONE；</li>
<li>不滥用 <code>FIXME</code> 和 <code>BUG</code>：可复现 + 影响明确用 BUG，潜在风险 / 未复现用 FIXME。</li>
<li>注释必须包含 3 要素：</li>
</ul>
<h4 data-id="heading-11">2. 做什么（明确目标）；</h4>
<ul>
<li>优先级 / 截止时间（如 <code>TODO:HIGH 截止2025-12-20</code>）；</li>
<li>依赖条件（如 <code>依赖订单模块接口</code>）。</li>
</ul>
<h4 data-id="heading-12">3. 定期清理注释：</h4>
<ul>
<li>迭代发布前：删除已完成的 TODO/UNDONE，修复所有 FIXME/BUG；</li>
<li>废弃代码：用 <code>DEPRECATED</code> 标记，而非直接删除（便于回滚）。</li>
</ul>
<h4 data-id="heading-13">4. 跨 IDE 兼容：</h4>
<ul>
<li>团队统一使用原生支持的注释（TODO、FIXME、NOTE），或同步自定义配置（如共享 VS Code 的 settings.json、JetBrains 的 TODO 模式导出文件）。</li>
</ul>
<h3 data-id="heading-14">五、补充说明</h3>
<ul>
<li><strong>语言兼容性</strong>：上述注释语法适用于 C++、Java、Python、JavaScript 等大部分编程语言（仅注释符号差异，如 Python 用 <code># TODO</code>）；</li>
<li><strong>工具集成</strong>：可结合项目管理工具（如 Jira），通过插件将 TODO 注释同步为任务（如 VS Code 的Jira Todo插件）；</li>
<li><strong>避免过度注释</strong>：仅标记关键待办 / 问题，代码本身可自解释的逻辑无需额外注释。</li>
</ul>
<p>通过以上规范，可实现 “代码注释→任务跟踪→团队协作” 的闭环，提升项目管理效率。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Apache Geaflow推理框架Geaflow-infer 解析系列（二）整体架构设计]]></title>    <link>https://juejin.cn/post/7576575703167221766</link>    <guid>https://juejin.cn/post/7576575703167221766</guid>    <pubDate>2025-11-26T04:41:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576575703167221766" data-draft-id="7576575703167205382" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Apache Geaflow推理框架Geaflow-infer 解析系列（二）整体架构设计"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-11-26T04:41:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="语落心生"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147955741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Apache Geaflow推理框架Geaflow-infer 解析系列（二）整体架构设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147955741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    语落心生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T04:41:27.000Z" title="Wed Nov 26 2025 04:41:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第2章：整体架构设计</h2>
<h3 data-id="heading-1">章节导读</h3>
<p>本章将从顶层设计的角度，详细阐述 geaflow-infer 的<strong>三层架构</strong>、<strong>核心组件关系</strong>和<strong>Java-Python 进程间通信机制</strong>。</p>
<p>通过本章，你将深刻理解：</p>
<ul>
<li><strong>为什么</strong> 要这样分层设计</li>
<li><strong>如何</strong> 在各层之间协调和通信</li>
<li><strong>核心的权衡</strong> 是什么（性能 vs 可维护性）</li>
</ul>
<hr/>
<h3 data-id="heading-2">2.1 三层架构设计</h3>
<h4 data-id="heading-3">总体架构设计理念</h4>
<p>geaflow-infer 采用了<strong>三层分层架构</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">┌────────────────────────────────────────────────────────────┐
│              应用层 (Application Layer)                     │
│                  InferContext                              │
│  用户通过 InferContext 调用 <span class="hljs-built_in">infer</span>() 进行推理                │
└──────────────────┬─────────────────────────────────────────┘
                   │
                   │ 统一接口（What）
                   ▼
┌────────────────────────────────────────────────────────────┐
│           逻辑层 (Logic Layer)                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ 环境管理     任务运行      数据交换      序列化       │  │
│  │ InferEnv*   InferTask*  DataExchange* Pickle*       │  │
│  └──────────────────────────────────────────────────────┘  │
│  - 初始化虚拟环境、启动Python进程、协调数据流             │
│  - 处理错误、管理状态、记录日志                          │
└──────────────────┬─────────────────────────────────────────┘
                   │
                   │ 系统调用、进程管理、内存操作（How）
                   ▼
┌────────────────────────────────────────────────────────────┐
│          基础层 (Infrastructure Layer)                      │
│  ┌──────────────┐  ┌───────────────┐  ┌──────────────┐   │
│  │ ProcessBuilder│  │ File <span class="hljs-selector-tag">I</span>/O      │  │ Unsafe + mmap│   │
│  │   (进程)      │  │  (文件)        │  │  (内存)      │   │
│  └──────────────┘  └───────────────┘  └──────────────┘   │
│  与操作系统交互，提供底层能力                              │
└────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-4">架构的设计哲学</h4>
<h5 data-id="heading-5">1. 分离关注点（Separation of Concerns）</h5>
<pre><code class="hljs language-markdown" lang="markdown">┌────────────────────────────────────────────────────┐
│ 环境管理层                                         │
│  - 只关心虚拟环境和依赖的准备                      │
│  - 不关心具体的推理逻辑                           │
└────────────────────────────────────────────────────┘
<span class="hljs-code">                      ↓
┌────────────────────────────────────────────────────┐
│ 任务运行层                                         │
│  - 只关心进程的启动和生命周期                      │
│  - 不关心数据如何序列化                           │
└────────────────────────────────────────────────────┘
                      ↓
┌────────────────────────────────────────────────────┐
│ 数据交换层                                         │
│  - 只关心高效传输数据                              │
│  - 不关心数据的业务含义                           │
└────────────────────────────────────────────────────┘
                      ↓
┌────────────────────────────────────────────────────┐
│ 序列化层                                           │
│  - 只关心对象&lt;-&gt;字节流的转换                       │
│  - 不关心数据来自哪里                             │
└────────────────────────────────────────────────────┘
</span></code></pre>
<p><strong>好处</strong>：</p>
<ul>
<li>每一层可以独立开发和测试</li>
<li>修改某一层的实现不会影响其他层</li>
<li>代码易于理解和维护</li>
</ul>
<h5 data-id="heading-6">2. 接口导向设计（Interface-Oriented Design）</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 任务运行接口（隐藏实现细节）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">InferTaskRun</span> {
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">(List&lt;String&gt; script)</span>;
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">()</span>;
}

<span class="hljs-comment">// 数据桥接接口（支持多种实现）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IDataBridge</span>&lt;OUT&gt; <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Closeable</span> {
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">write</span><span class="hljs-params">(Object... obj)</span> <span class="hljs-keyword">throws</span> IOException;
    OUT <span class="hljs-title function_">read</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException;
}

<span class="hljs-comment">// 编解码接口（支持扩展）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">IEncoder</span> {
    <span class="hljs-type">byte</span>[] encode(Object obj);
}
</code></pre>
<p><strong>好处</strong>：</p>
<ul>
<li>支持多种实现（如 HTTP 桥接、WebSocket 桥接）</li>
<li>便于单元测试（Mock 实现）</li>
<li>降低组件间的耦合度</li>
</ul>
<h5 data-id="heading-7">3. 单例 + 懒加载（Singleton + Lazy Initialization）</h5>
<pre><code class="hljs language-css" lang="css">┌─────────────────────────────────────────┐
│ 首次调用 InferContext 时:                 │
│  <span class="hljs-number">1</span>. 创建 InferEnvironmentManager 单例    │
│  <span class="hljs-number">2</span>. 初始化虚拟环境（异步，后台进行）     │
│  <span class="hljs-number">3</span>. 立即返回，不阻塞用户                 │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│ 调用 <span class="hljs-built_in">infer</span>() 时:                         │
│  <span class="hljs-number">1</span>. 检查虚拟环境是否就绪                │
│  <span class="hljs-number">2</span>. 如果就绪，立即启动推理               │
│  <span class="hljs-number">3</span>. 如果未就绪，等待虚拟环境初始化       │
└─────────────────────────────────────────┘
</code></pre>
<p><strong>好处</strong>：</p>
<ul>
<li>减少内存占用（仅创建一个虚拟环境）</li>
<li>加快应用启动速度（虚拟环境初始化异步进行）</li>
<li>避免重复初始化的开销</li>
</ul>
<hr/>
<h3 data-id="heading-8">2.2 核心组件关系</h3>
<h4 data-id="heading-9">完整流程时序图</h4>
<pre><code class="hljs language-css" lang="css">时间轴
│
├─ T0: 应用启动
│   │
│   └─→ InferContext.<span class="hljs-built_in">build</span>(config)
│       │
│       ├─→ InferEnvironmentManager.<span class="hljs-built_in">buildInferEnvironmentManager</span>(config)
│       │   │ (单例)
│       │   └─→ 创建虚拟环境（后台异步）
│       │
│       ├─→ DataExchangeContext.<span class="hljs-built_in">init</span>()
│       │   │
│       │   ├─→ <span class="hljs-built_in">DataExchangeQueue</span>(<span class="hljs-string">"input"</span>, ...)
│       │   └─→ <span class="hljs-built_in">DataExchangeQueue</span>(<span class="hljs-string">"output"</span>, ...)
│       │
│       └─→ <span class="hljs-built_in">InferTaskRunImpl</span>(environmentContext)
│
├─ T1-T100ms: 虚拟环境初始化中...
│   │
│   ├─→ InferDependencyManager.<span class="hljs-built_in">buildInferRuntimeFiles</span>()
│   ├─→ 执行 install-infer-env.sh (Conda)
│   └─→ 写入 _finish 标记文件
│
├─ T100ms: 首次推理调用
│   │
│   └─→ InferContext.<span class="hljs-built_in">infer</span>(features...)
│       │
│       ├─→ [检查虚拟环境状态]
│       │   如果未就绪，等待...
│       │
│       ├─→ InferTaskRunImpl.<span class="hljs-built_in">run</span>([python, infer_server.py, ...])
│       │   │
│       │   └─→ ProcessBuilder.<span class="hljs-built_in">start</span>()
│       │       │
│       │       ├─→ ProcessLoggerManager.<span class="hljs-built_in">startLogging</span>()
│       │       │   │ (后台线程捕获输出)
│       │       │   └─→ Slf4j 日志
│       │       │
│       │       └─→ Python 进程启动
│       │           │
│       │           └─→ infer_server.py
│       │               │
│       │               ├─→ 连接共享内存队列
│       │               ├─→ 加载用户 Transform 类
│       │               └─→ 等待推理请求...
│       │
│       ├─→ InferDataBridgeImpl.<span class="hljs-built_in">write</span>(features)
│       │   │
│       │   ├─→ Pickler.<span class="hljs-built_in">encode</span>(features)
│       │   │   │ Java对象 → Pickle字节流
│       │   │   └─→ OpCode生成
│       │   │
│       │   ├─→ InferDataWriter.<span class="hljs-built_in">write</span>(bytes)
│       │   │   │
│       │   │   └─→ <span class="hljs-built_in">DataExchangeQueue</span>(<span class="hljs-string">"input"</span>).<span class="hljs-built_in">put</span>(bytes)
│       │   │       │ (无锁，Unsafe操作)
│       │   │       └─→ 内存映射文件
│       │   │
│       │   └─→ 触发 Python 进程读取
│       │
│       ├─ [Python进程执行]
│       │   │
│       │   ├─→ 从 <span class="hljs-built_in">Queue</span>(<span class="hljs-string">"input"</span>) 读取字节流
│       │   ├─→ Unpickle 解序列化
│       │   ├─→ 执行用户 Transform 类
│       │   └─→ 写入结果到 <span class="hljs-built_in">Queue</span>(<span class="hljs-string">"output"</span>)
│       │
│       ├─→ InferDataBridgeImpl.<span class="hljs-built_in">read</span>()
│       │   │
│       │   ├─→ InferDataReader.<span class="hljs-built_in">read</span>()
│       │   │   │
│       │   │   └─→ <span class="hljs-built_in">DataExchangeQueue</span>(<span class="hljs-string">"output"</span>).<span class="hljs-built_in">get</span>(bytes)
│       │   │       │ (无锁，轮询)
│       │   │       └─→ 内存映射文件
│       │   │
│       │   ├─→ Unpickler.<span class="hljs-built_in">decode</span>(bytes)
│       │   │   │ Pickle字节流 → Java对象
│       │   │   └─→ 对象构造
│       │   │
│       │   └─→ 返回结果对象
│       │
│       └─→ 返回给用户
│
├─ T200ms-N: 后续推理调用
│   │
│   └─→ [复用 Python 进程，不需要重新初始化]
│       Python 进程持续监听队列...
│
└─ 应用关闭
    │
    └─→ InferContext.<span class="hljs-built_in">close</span>()
        │
        ├─→ InferTaskRunImpl.<span class="hljs-built_in">stop</span>()
        │   │
        │   └─→ process.<span class="hljs-built_in">destroyForcibly</span>()
        │       │ 杀死 Python 进程
        │       └─→ ProcessLoggerManager 停止日志捕获
        │
        └─→ DataExchangeQueue.<span class="hljs-built_in">close</span>()
            │
            └─→ 释放内存映射
</code></pre>
<h4 data-id="heading-10">组件依赖关系图</h4>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────┐
│        InferContext (用户入口)        │
│  + <span class="hljs-built_in">infer</span>(features...)               │
│  + <span class="hljs-built_in">close</span>()                          │
└──────────────────┬──────────────────┘
                   │
         ┌─────────┼─────────┬──────────┐
         │         │         │          │
         ▼         ▼         ▼          ▼
    ┌────────┐ ┌─────────┐ ┌───────┐ ┌──────────┐
    │InferEnv│ │InferTask│ │IDataB │ │InferEnv │
    │Manager │ │RunImpl   │ │ridge  │ │Context  │
    │ (单例)  │ │         │ │       │ │         │
    └────────┘ └─────────┘ └───────┘ └──────────┘
         │         │         │
         │         │         │ 持有
         │    ┌────┴─────────┘
         │    │
         │    ▼
         │ ┌──────────────────────┐
         │ │ProcessLoggerManager  │
         │ │  (后台日志线程)       │
         │ └──────────────────────┘
         │
         ▼
    ┌─────────────────────────┐
    │InferDependencyManager   │
    │ (文件和脚本管理)         │
    └────────┬────────────────┘
             │
             ▼
    ┌──────────────────────┐
    │DataExchangeContext   │
    │ (两个共享内存队列)     │
    │  - <span class="hljs-selector-tag">Input</span> Queue       │
    │  - Output Queue      │
    └────────┬─────────────┘
             │
        ┌────┴────┐
        ▼         ▼
   ┌─────────┐ ┌──────────┐
   │Pickler  │ │Unpickler │
   │(序列化) │ │(反序列化) │
   └─────────┘ └──────────┘
</code></pre>
<h4 data-id="heading-11">关键数据结构关系</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">┌──────────────────────────────────────┐</span>
<span class="hljs-string">│</span>     <span class="hljs-string">InferContext</span> <span class="hljs-string">(门面)</span>               <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">environmentManager:</span> <span class="hljs-string">InferEnviron</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">dataContext:</span> <span class="hljs-string">DataExchangeContext</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">taskRun:</span> <span class="hljs-string">InferTaskRunImpl</span>           <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">dataBridge:</span> <span class="hljs-string">IDataBridge&lt;OUT&gt;</span>       <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">encoder/decoder:</span> <span class="hljs-string">I**</span>               <span class="hljs-string">│</span>
<span class="hljs-string">└──────────────────────────────────────┘</span>

<span class="hljs-string">┌──────────────────────────────────────┐</span>
<span class="hljs-string">│</span>  <span class="hljs-string">DataExchangeContext</span> <span class="hljs-string">(数据上下文)</span>      <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">receiveQueue:</span> <span class="hljs-string">DataExchangeQueue</span>    <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">sendQueue:</span> <span class="hljs-string">DataExchangeQueue</span>       <span class="hljs-string">│</span>
<span class="hljs-string">│</span>    <span class="hljs-string">(双向通信，A-&gt;B</span> <span class="hljs-string">和</span> <span class="hljs-string">B-&gt;A)</span>           <span class="hljs-string">│</span>
<span class="hljs-string">└──────────────────────────────────────┘</span>

<span class="hljs-string">┌──────────────────────────────────────┐</span>
<span class="hljs-string">│</span>  <span class="hljs-string">DataExchangeQueue</span> <span class="hljs-string">(共享内存)</span>         <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">mapAddress:</span> <span class="hljs-string">long</span>                   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">outputAddress:</span> <span class="hljs-string">long</span>                <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">inputNextAddress:</span> <span class="hljs-string">long</span>             <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> [<span class="hljs-string">内存布局详见第6章</span>]                <span class="hljs-string">│</span>
<span class="hljs-string">└──────────────────────────────────────┘</span>

<span class="hljs-string">┌──────────────────────────────────────┐</span>
<span class="hljs-string">│</span>  <span class="hljs-string">InferTaskRunImpl</span> <span class="hljs-string">(进程管理)</span>           <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">inferTask:</span> <span class="hljs-string">Process</span>                 <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">inferTaskStatus:</span> <span class="hljs-string">InferTaskStatus</span>   <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">environmentContext:</span> <span class="hljs-string">InferEnv...</span>    <span class="hljs-string">│</span>
<span class="hljs-string">│</span>  <span class="hljs-bullet">-</span> <span class="hljs-attr">virtualEnvPath:</span> <span class="hljs-string">String</span>             <span class="hljs-string">│</span>
<span class="hljs-string">└──────────────────────────────────────┘</span>
</code></pre>
<hr/>
<h3 data-id="heading-12">2.3 Java-Python 进程间通信机制</h3>
<h4 data-id="heading-13">通信模式选择</h4>
<p>geaflow-infer 采用了<strong>共享内存 + 无锁队列</strong>的通信模式，而不是其他可选方案：</p>
<pre><code class="hljs language-markdown" lang="markdown">┌─────────────────────────────────────────────────────────────┐
│            可选的 IPC (Inter-Process Communication) 方案     │
├─────────────────────────────────────────────────────────────┤
│ 方案          │ 延迟      │ 吞吐   │ 复杂度 │ 跨网络       │
├───────────────┼──────────┼────────┼────────┼──────────────┤
│ HTTP/REST     │ 毫秒级   │ 中等   │ 低     │ 支持         │
│ Socket/RPC    │ 毫秒级   │ 中等   │ 中等   │ 支持         │
│ Named Pipe    │ 微秒级   │ 中等   │ 中等   │ 不支持       │
│ Shared Memory │ 微秒级   │ 高     │ 高     │ 不支持       │
│ (geaflow-infer)          │         │        │              │
└─────────────────────────────────────────────────────────────┘

GeaFlow-Infer 的选择: 共享内存（同机实现）
原因:
<span class="hljs-bullet">  1.</span> 延迟敏感: 推理任务通常要求低延迟
<span class="hljs-bullet">  2.</span> 吞吐量大: 图计算可能产生大量推理请求
<span class="hljs-bullet">  3.</span> 本地通信: Java 和 Python 通常在同一台机器
<span class="hljs-bullet">  4.</span> 零拷贝: 共享内存避免数据复制
</code></pre>
<h4 data-id="heading-14">通信流程详解</h4>
<h5 data-id="heading-15">Phase 1: 初始化（Init Phase）</h5>
<pre><code class="hljs language-scss" lang="scss">Java进程                          Python进程
    │                               │
    │ <span class="hljs-number">1</span>. 创建 <span class="hljs-number">2</span> 个共享内存队列        │
    ├─→ <span class="hljs-built_in">Queue</span>("input_${id}")        │
    ├─→ <span class="hljs-built_in">Queue</span>("output_${id}")       │
    │                               │
    │ <span class="hljs-number">2</span>. 记录 Queue ID               │
    │    作为环境变量                 │
    │                               │
    │ <span class="hljs-number">3</span>. 启动 Python 进程             │
    ├───────────────────────────────→ 启动
    │                               │
    │                               │ <span class="hljs-number">4</span>. 读取环境变量
    │                               ├─→ input_queue_shm_id
    │                               ├─→ output_queue_shm_id
    │                               │
    │                               │ <span class="hljs-number">5</span>. 连接共享内存
    │                               ├─→ mmap<span class="hljs-selector-class">.mmap</span>(input_queue_shm_id)
    │                               ├─→ mmap<span class="hljs-selector-class">.mmap</span>(output_queue_shm_id)
    │                               │
    │                               │ <span class="hljs-number">6</span>. 加载模型，就绪
    │ <span class="hljs-number">7</span>. 检测 Python 进程就绪 ←────────┤
    │                               │
</code></pre>
<p><strong>核心数据结构</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java 侧：环境变量配置</span>
Map&lt;String, String&gt; env = processBuilder.environment();
env.put(<span class="hljs-string">"input_queue_shm_id"</span>, <span class="hljs-string">"input_12345"</span>);  <span class="hljs-comment">// 队列 ID</span>
env.put(<span class="hljs-string">"output_queue_shm_id"</span>, <span class="hljs-string">"output_12345"</span>);
env.put(<span class="hljs-string">"PYTHONPATH"</span>, <span class="hljs-string">"/path/to/infer"</span>);
env.put(<span class="hljs-string">"LD_LIBRARY_PATH"</span>, <span class="hljs-string">"/path/to/lib"</span>);
env.put(<span class="hljs-string">"--tfClassName"</span>, <span class="hljs-string">"my.custom.Transform"</span>);

<span class="hljs-comment">// Python 侧：读取环境变量</span>
input_queue_id = os.environ[<span class="hljs-string">'input_queue_shm_id'</span>]
output_queue_id = os.environ[<span class="hljs-string">'output_queue_shm_id'</span>]
input_queue = DataExchangeQueue(input_queue_id)
output_queue = DataExchangeQueue(output_queue_id)
</code></pre>
<h5 data-id="heading-16">Phase 2: 数据传输（Data Transfer Phase）</h5>
<pre><code class="hljs language-scss" lang="scss">Java进程                    共享内存队列                Python进程
    │                          │                           │
    │ <span class="hljs-number">1</span>. 序列化输入数据         │                           │
    ├──&gt; Pickler<span class="hljs-selector-class">.encode</span>()      │                           │
    │    features → bytes       │                           │
    │                          │                           │
    │ <span class="hljs-number">2</span>. 写入 <span class="hljs-selector-tag">input</span> 队列        │                           │
    ├──&gt; DataExchangeQueue     │                           │
    │    <span class="hljs-selector-class">.put</span>(bytes)           │                           │
    │    <span class="hljs-selector-attr">[内存映射]</span>            │                           │
    │                          │ notify                     │
    │                          ├──────────────────────────→ 读取 <span class="hljs-selector-tag">input</span> 队列
    │                          │                           │
    │                          │                           │ <span class="hljs-number">3</span>. 反序列化
    │                          │                           ├──&gt; Unpickle
    │                          │                           │    bytes → objects
    │                          │                           │
    │                          │                           │ <span class="hljs-number">4</span>. 执行推理
    │                          │                           ├──&gt; <span class="hljs-built_in">user_transform</span>(obj)
    │                          │                           │
    │                          │                           │ <span class="hljs-number">5</span>. 序列化结果
    │                          │                           ├──&gt; Pickler<span class="hljs-selector-class">.encode</span>()
    │                          │                           │    result → bytes
    │                          │                           │
    │                          │                           │ <span class="hljs-number">6</span>. 写入 output 队列
    │                          │ ←─────────────────────────┤
    │                          │ <span class="hljs-selector-attr">[内存映射]</span>                 │
    │                          │ notify                    │
    │ <span class="hljs-number">7</span>. 轮询 output 队列      │                           │
    ├──&gt; DataExchangeQueue     │                           │
    │    <span class="hljs-selector-class">.get</span>(bytes)           │                           │
    │                          │                           │
    │ <span class="hljs-number">8</span>. 反序列化结果           │                           │
    ├──&gt; Unpickler<span class="hljs-selector-class">.decode</span>()    │                           │
    │    bytes → objects       │                           │
    │                          │                           │
    │ <span class="hljs-number">9</span>. 返回结果给用户        │                           │
    ↓                          │                           │
</code></pre>
<h4 data-id="heading-17">内存映射与无锁设计</h4>
<h5 data-id="heading-18">内存映射（mmap）的工作原理</h5>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────┐
│  Linux 文件系统                      │
│  /dev/shm/geaflow_infer_queue_${id} │
│  (共享内存文件，大小：通常 <span class="hljs-number">1</span>MB-<span class="hljs-number">100</span>MB)  │
└─────────────────────────────────────┘
         │                   │
    ┌────┘                   └────┐
    │                             │
    ▼                             ▼
┌───────────────┐         ┌──────────────┐
│ Java进程页表   │         │ Python进程页表│
│  虚拟地址空间  │         │  虚拟地址空间 │
│  <span class="hljs-number">0</span>x1000-<span class="hljs-number">0</span>x2000 ─────────→ <span class="hljs-number">0</span>x5000-<span class="hljs-number">0</span>x6000│
│  (不同地址)              │  (不同地址)   │
│  ↓                       │  ↓           │
│  同一份物理内存            │  同一份物理内存 │
│  (Page Frame <span class="hljs-number">123</span>-<span class="hljs-number">456</span>)    │(Page Frame   │
│                          │ <span class="hljs-number">123</span>-<span class="hljs-number">456</span>)    │
└───────────────┘         └──────────────┘

关键特性：
  <span class="hljs-number">1</span>. 虚拟地址不同，但指向同一物理内存
  <span class="hljs-number">2</span>. 修改内存的一方，另一方立即可见
  <span class="hljs-number">3</span>. 不需要显式的数据复制（零拷贝）
</code></pre>
<h5 data-id="heading-19">无锁队列的并发机制</h5>
<pre><code class="hljs language-ini" lang="ini">┌──────────────────────────────────────────────┐
│  共享内存布局                                 │
├──────────────────────────────────────────────┤
│ <span class="hljs-section">[元数据区]</span>                                     │
│  - outputAddress (8 bytes) ─&gt; 写指针           │
│  - inputNextAddress (8 bytes) ─&gt; 读指针        │
│  - <span class="hljs-section">[缓存行对齐，避免 False Sharing]</span>            │
├──────────────────────────────────────────────┤
│ <span class="hljs-section">[数据区]</span>                                       │
│  <span class="hljs-section">[缓冲区 0]</span> <span class="hljs-section">[缓冲区 1]</span> <span class="hljs-section">[缓冲区 2]</span> ...         │
│   Ring Buffer 结构，大小为 2^n 对齐            │
└──────────────────────────────────────────────┘

时间轴：
  Java:         Python:
   │             │
   ├─ T0:        │
   │ <span class="hljs-attr">write_ptr</span> = <span class="hljs-number">0</span>
   │ 写入数据     │
   │             ├─ T0.5:
   │             │ read_ptr 还是 0
   │             │ (看不到新数据)
   │             │
   ├─ T1:        │
   │ <span class="hljs-attr">write_ptr</span> = <span class="hljs-number">256</span>
   │ 发出内存屏障 │
   │             ├─ T2:
   │             │ 内存屏障保证顺序
   │             │ <span class="hljs-attr">read_ptr</span> = <span class="hljs-number">256</span>
   │             │ 读取新数据
</code></pre>
<p><strong>无锁算法的核心</strong>：</p>
<ol>
<li>使用 <code>Unsafe.putOrderedLong()</code> 写指针（带内存屏障）</li>
<li>使用 <code>Unsafe.getVolatile()</code> 读指针（带内存屏障）</li>
<li>避免使用 <code>synchronized</code> 和 <code>Lock</code></li>
<li>支持多个 reader 和多个 writer 的并发</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 伪代码：写操作</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">write</span><span class="hljs-params">(<span class="hljs-type">byte</span>[] data)</span> {
    <span class="hljs-comment">// 检查可用空间</span>
    <span class="hljs-type">long</span> <span class="hljs-variable">writeIndex</span> <span class="hljs-operator">=</span> getWriteIndex();
    <span class="hljs-type">long</span> <span class="hljs-variable">nextIndex</span> <span class="hljs-operator">=</span> (writeIndex + data.length) &amp; mask;
    <span class="hljs-keyword">if</span> (!canWrite(nextIndex)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferFullException</span>();
    }
    
    <span class="hljs-comment">// 写数据（普通写）</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; data.length; i++) {
        UNSAFE.putByte(data[i]);
    }
    
    <span class="hljs-comment">// 更新指针（带内存屏障）</span>
    UNSAFE.putOrderedLong(<span class="hljs-built_in">this</span>, WRITE_PTR_OFFSET, nextIndex);
}

<span class="hljs-comment">// 伪代码：读操作</span>
<span class="hljs-keyword">public</span> <span class="hljs-type">byte</span>[] read() {
    <span class="hljs-comment">// 读写指针（带内存屏障）</span>
    <span class="hljs-type">long</span> <span class="hljs-variable">writeIndex</span> <span class="hljs-operator">=</span> UNSAFE.getVolatileLong(<span class="hljs-built_in">this</span>, WRITE_PTR_OFFSET);
    <span class="hljs-type">long</span> <span class="hljs-variable">readIndex</span> <span class="hljs-operator">=</span> getReadIndex();
    
    <span class="hljs-keyword">if</span> (writeIndex == readIndex) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;  <span class="hljs-comment">// 无数据可读</span>
    }
    
    <span class="hljs-comment">// 读数据（普通读）</span>
    <span class="hljs-type">byte</span>[] result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[getDataLength()];
    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; result.length; i++) {
        result[i] = UNSAFE.getByte(address + readIndex + i);
    }
    
    <span class="hljs-comment">// 更新指针（带内存屏障）</span>
    UNSAFE.putOrderedLong(<span class="hljs-built_in">this</span>, READ_PTR_OFFSET, 
        (readIndex + result.length) &amp; mask);
    
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<h4 data-id="heading-20">通信性能分析</h4>
<pre><code class="hljs language-markdown" lang="markdown">延迟分解（End-to-End Latency）：
  总延迟 = Java序列化 + 内存写入 + 上下文切换 + Python反序列化 
<span class="hljs-bullet">          +</span> 推理执行 + 结果序列化 + 内存读取 + Java反序列化

  ≈ 1μs (序列化) + 0.1μs (mmap 写) + ~100μs (上下文切换)
<span class="hljs-bullet">    +</span> 1μs (反序列化) + 推理时间 + ...

吞吐量分析：
<span class="hljs-bullet">  -</span> 环形缓冲区大小: 通常 1MB - 100MB
<span class="hljs-bullet">  -</span> 单次推理数据: 通常 KB 级别
<span class="hljs-bullet">  -</span> 吞吐量: 可以达到 Gbps 级别（理论上）

对比 HTTP/RPC：
  HTTP: 毫秒级 (ms) = 1000μs
  共享内存: 微秒级 (μs) 
  性能提升: 1000 倍
</code></pre>
<hr/>
<h3 data-id="heading-21">参考资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fman7.org%2Flinux%2Fman-pages%2Fman2%2Fmmap.2.html" target="_blank" title="https://man7.org/linux/man-pages/man2/mmap.2.html" ref="nofollow noopener noreferrer">Linux mmap() 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fparkour%2Fp%2F8333803.html" target="_blank" title="https://www.cnblogs.com/parkour/p/8333803.html" ref="nofollow noopener noreferrer">Java Unsafe 详解</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fpreshing.com%2F20130922%2Facquire-and-release-semantics%2F" target="_blank" title="https://preshing.com/20130922/acquire-and-release-semantics/" ref="nofollow noopener noreferrer">无锁编程指南</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fen.wikipedia.org%2Fwiki%2FInter-process_communication" target="_blank" title="https://en.wikipedia.org/wiki/Inter-process_communication" ref="nofollow noopener noreferrer">IPC 机制比较</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[人间观察：关于健康、善良与选择的思考]]></title>    <link>https://juejin.cn/post/7576608733611687962</link>    <guid>https://juejin.cn/post/7576608733611687962</guid>    <pubDate>2025-11-26T04:44:23.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576608733611687962" data-draft-id="7576537005133398043" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="人间观察：关于健康、善良与选择的思考"/> <meta itemprop="keywords" content="笔记"/> <meta itemprop="datePublished" content="2025-11-26T04:44:23.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="木西"/> <meta itemprop="url" content="https://juejin.cn/user/2436173496845549"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            人间观察：关于健康、善良与选择的思考
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2436173496845549/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    木西
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T04:44:23.000Z" title="Wed Nov 26 2025 04:44:23 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>写了这么多技术文章，今天不聊技术，想分享几件近年生活中的小事，以及它们带给我的思考。</p>
<h2 data-id="heading-1">故事一：善意</h2>
<p>2019年初，北京某眼科医院。那天我取完号后在候诊区等待，看见花坛旁有个空位，便想过去休息。旁边坐着一位三十多岁的女士，我刚要坐下，她突然厉声说："别坐我旁边。"我一愣，心想这人好奇怪，公共场合为何不能坐？紧接着她又开口："离我远点，我身上有毒。"</p>
<p>短短三句话，却让我看到了人性最纯粹的善良。我并不了解那位姐姐身患何疾、经历过怎样的治疗，但在她如此艰难的时刻，仍不忘保护他人，这份善意何其珍贵。虽然这件事已过去多年，但每每想起，依然感动。</p>
<h2 data-id="heading-2">故事二：选择</h2>
<p>同样发生在医院。一对中年夫妇，职业都是教师。丈夫病情严重，需要做大手术，术后第一晚尤为关键，特别是前六个小时。然而丈夫刚回到病床，妻子便说："我不太方便照顾你。"我当时难以理解：孩子都生了，有什么不方便？最终，她回酒店休息，让随行人员照看，临走还说了句"养兵千日，用兵一时"。</p>
<p>此事让我深思，也影响了我的择偶观。我无意评判这个职业群体，只是作为旁观者的真实记录。疾病考验的不仅是身体，更是人心。</p>
<h2 data-id="heading-3">故事三：冲动</h2>
<p>这是一起因冲动引发的悲剧。一户人家攒了些钱，打算在老家建别墅，采用全包模式。施工方因接单太多，工程拖到一半便迟迟未动工。房主多次理论无果，情急之下扬言再不开工就拒付尾款。最后房主托了一位有势力的亲戚出面协商——按东北话说，算是个"有头有脸"的人物。</p>
<p>三方见面后，这位亲戚竟当场打了中介几个耳光，随后回去召集人马。巧的是中介也非善茬，早有准备。当对方再次返回时，刚下车便被一铁锹砸中头部，接着又中两刀，救护车未到人便没了。警察随后控制了双方，中介这边一名参与者即将升任校长，前途尽毁。</p>
<h2 data-id="heading-4">故事四：因果</h2>
<p>大约二十年前的事。妻子在打麻将时与一名男子发生口角，回家后告诉了丈夫。丈夫不依不饶，此后每次见到那男子都要殴打，持续了很久。终有一日，被打男子忍无可忍，提前藏了刀在身，再次遭殴打时当街将其捅死，随后逃亡。</p>
<p>逃亡期间，他联系了侄子，借了数千元钱。侄子为了不还钱，竟向警方举报了叔叔。最终罪犯伏法，而侄子的做法也令人唏嘘。</p>
<h2 data-id="heading-5">结语</h2>
<p>兄弟姐妹们，请爱惜自己的身体——健康真的不是一句空话，失去它，你连参与人生竞争的资格都没有。</p>
<p>不要介入他人的因果，人性复杂难测。选择另一半，就是选择一种人生。朋友们，若觉前路坎坷，不妨去医院走走看看，那里有最真实的人间百态。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Apache Geaflow推理框架Geaflow-infer 解析系列（三）环境初始化流程]]></title>    <link>https://juejin.cn/post/7576575703167238150</link>    <guid>https://juejin.cn/post/7576575703167238150</guid>    <pubDate>2025-11-26T04:44:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576575703167238150" data-draft-id="7576689869808762916" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Apache Geaflow推理框架Geaflow-infer 解析系列（三）环境初始化流程"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-11-26T04:44:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="语落心生"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147955741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Apache Geaflow推理框架Geaflow-infer 解析系列（三）环境初始化流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147955741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    语落心生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T04:44:34.000Z" title="Wed Nov 26 2025 04:44:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第3章：环境初始化流程</h2>
<h3 data-id="heading-1">章节导读</h3>
<p>"工欲善其事，必先利其器"。在 Java 进程可以调用 Python 推理之前，必须先准备好 Python 的运行环境。本章将深入讲解 <strong>geaflow-infer 如何初始化虚拟环境</strong>、<strong>如何通过文件锁确保并发安全</strong>、以及<strong>如何管理环境的生命周期</strong>。</p>
<p>通过本章，你将理解：</p>
<ul>
<li><strong>为什么</strong> 需要虚拟环境（依赖隔离、版本控制）</li>
<li><strong>如何</strong> 实现单例模式和文件锁机制</li>
<li><strong>如何</strong> 处理初始化失败和状态恢复</li>
</ul>
<hr/>
<h3 data-id="heading-2">3.1 InferEnvironmentManager 单例模式设计</h3>
<h4 data-id="heading-3">设计目标</h4>
<p>InferEnvironmentManager 采用<strong>单例模式</strong>的原因：</p>
<pre><code class="hljs language-bash" lang="bash">问题场景:
  应用启动 10 个线程，都要初始化推理环境
  
没有单例的后果:
  ├─ 线程1: 创建虚拟环境 /env1 (耗时 5 秒)
  ├─ 线程2: 创建虚拟环境 /env2 (重复创建! 浪费时间)
  ├─ 线程3: 创建虚拟环境 /env3 (重复创建! 浪费时间)
  └─ ...
  总耗时: 50 秒，浪费了 45 秒

使用单例的效果:
  ├─ 线程1: 创建虚拟环境 /env (耗时 5 秒)
  ├─ 线程2: 等待线程1完成，复用 /env (0 秒)
  ├─ 线程3: 等待线程1完成，复用 /env (0 秒)
  └─ ...
  总耗时: 5 秒，所有线程共享一个环境
</code></pre>
<h4 data-id="heading-4">实现细节</h4>
<h5 data-id="heading-5">双重检查锁定（Double-Checked Locking）</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InferEnvironmentManager</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">InferEnvironmentManager</span> <span class="hljs-variable">INSTANCE</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">LOCK</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>();
    
    <span class="hljs-comment">// 静态标志：初始化是否完成</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicBoolean</span> <span class="hljs-variable">INITIALIZED</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicBoolean</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicBoolean</span> <span class="hljs-variable">SUCCESS_FLAG</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicBoolean</span>(<span class="hljs-literal">false</span>);
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> AtomicReference&lt;Throwable&gt; ERROR_CASE = 
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicReference</span>&lt;&gt;();
    
    <span class="hljs-comment">// 初始化过程中的虚拟环境上下文</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">InferEnvironmentContext</span> <span class="hljs-variable">environmentContext</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
    
    <span class="hljs-comment">/**
     * 构建并返回单例
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">synchronized</span> InferEnvironmentManager 
        <span class="hljs-title function_">buildInferEnvironmentManager</span><span class="hljs-params">(Configuration config)</span> {
        <span class="hljs-keyword">if</span> (INSTANCE == <span class="hljs-literal">null</span>) {
            <span class="hljs-comment">// 关键: 只有首次调用时才创建实例</span>
            <span class="hljs-comment">// synchronized 关键字保证线程安全</span>
            INSTANCE = <span class="hljs-keyword">new</span> <span class="hljs-title class_">InferEnvironmentManager</span>(config);
        }
        <span class="hljs-keyword">return</span> INSTANCE;
    }
    
    <span class="hljs-comment">/**
     * 私有构造函数，防止外部直接 new
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">InferEnvironmentManager</span><span class="hljs-params">(Configuration config)</span> {
        <span class="hljs-built_in">this</span>.configuration = config;
        <span class="hljs-built_in">this</span>.executorService = Executors.newSingleThreadExecutor();
        <span class="hljs-comment">// 触发异步初始化</span>
        createEnvironment();
    }
    
    <span class="hljs-comment">/**
     * 创建虚拟环境（异步执行）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createEnvironment</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 使用 compareAndSet 确保只初始化一次</span>
        <span class="hljs-keyword">if</span> (INITIALIZED.compareAndSet(<span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>)) {
            <span class="hljs-comment">// 后台线程执行初始化</span>
            executorService.execute(() -&gt; {
                <span class="hljs-keyword">try</span> {
                    environmentContext = constructInferEnvironment(configuration);
                    <span class="hljs-keyword">if</span> (environmentContext.enableFinished()) {
                        SUCCESS_FLAG.set(<span class="hljs-literal">true</span>);
                        LOGGER.info(<span class="hljs-string">"✓ 虚拟环境初始化成功"</span>);
                    }
                } <span class="hljs-keyword">catch</span> (Throwable e) {
                    SUCCESS_FLAG.set(<span class="hljs-literal">false</span>);
                    ERROR_CASE.set(e);
                    LOGGER.error(<span class="hljs-string">"✗ 虚拟环境初始化失败"</span>, e);
                }
            });
        }
    }
}
</code></pre>
<h4 data-id="heading-6">关键特性分析</h4>
<h5 data-id="heading-7">1. 原子性（Atomicity）</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//  错误做法：</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">INITIALIZED</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
<span class="hljs-keyword">if</span> (!INITIALIZED) {  <span class="hljs-comment">// Check</span>
    INITIALIZED = <span class="hljs-literal">true</span>;  <span class="hljs-comment">// Set</span>
    initialize();  <span class="hljs-comment">// 两个操作之间可能被中断</span>
}

<span class="hljs-comment">// ✓ 正确做法：</span>
<span class="hljs-keyword">if</span> (INITIALIZED.compareAndSet(<span class="hljs-literal">false</span>, <span class="hljs-literal">true</span>)) {  <span class="hljs-comment">// 原子操作</span>
    initialize();
}

优势:
  compareAndSet 是单条 CPU 指令，不可中断
  保证即使两个线程同时调用，也只有一个会成功
</code></pre>
<h5 data-id="heading-8">2. 可见性（Visibility）</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// AtomicBoolean 的写操作包含内存屏障</span>
SUCCESS_FLAG.set(<span class="hljs-literal">true</span>);  <span class="hljs-comment">// 写操作，带屏障</span>
<span class="hljs-comment">// ↓ (内存屏障)</span>
<span class="hljs-comment">// 所有线程都能立即看到 true</span>

<span class="hljs-comment">// ✓ 任何线程的读操作都能看到最新值</span>
<span class="hljs-keyword">if</span> (SUCCESS_FLAG.get()) {  <span class="hljs-comment">// 读操作，带屏障</span>
    ...
}
</code></pre>
<hr/>
<h3 data-id="heading-9">3.2 虚拟环境创建流程</h3>
<h4 data-id="heading-10">总流程概览</h4>
<pre><code class="hljs language-scss" lang="scss">用户代码调用
    ↓
InferContext<span class="hljs-selector-class">.build</span>(config)
    ↓
InferEnvironmentManager<span class="hljs-selector-class">.buildInferEnvironmentManager</span>(config)
    ├─→ <span class="hljs-selector-attr">[同步返回单例]</span> (不阻塞用户)
    │
    └─→ <span class="hljs-selector-attr">[后台线程]</span> (异步初始化)
        ↓
        <span class="hljs-built_in">constructInferEnvironment</span>(config)
        ├─→ Step1: 初始化 InferEnvironmentContext
        │   - 获取虚拟环境目录
        │   - 获取 Python 文件目录
        │   - 生成角色标识 (hostname:pid)
        │   - 初始化各种路径
        │   ↓
        ├─→ Step2: 创建 InferDependencyManager
        │   - 从 JAR 提取依赖文件
        │   - 生成 requirements.txt
        │   - 准备初始化脚本路径
        │   ↓
        ├─→ Step3: 使用文件锁，避免重复初始化
        │   - 创建锁文件
        │   - 获取文件锁（阻塞直到获得）
        │   - 检查 _finish 或 _failed 标记文件
        │   ↓
        ├─→ Step4: 执行 Shell 脚本创建虚拟环境
        │   - 调用 install-infer-env.sh
        │   - 创建 Conda 虚拟环境
        │   - 安装 Python 依赖包
        │   ↓
        ├─→ Step5: 标记初始化完成
        │   - 创建 _finish 或 _failed 标记文件
        │   - 释放文件锁
        │   ↓
        └─→ 设置 SUCCESS_FLAG 或 ERROR_CASE
</code></pre>
<h4 data-id="heading-11">分步详解</h4>
<h5 data-id="heading-12">Step1: InferEnvironmentContext 初始化</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> InferEnvironmentContext <span class="hljs-title function_">constructInferEnvironment</span><span class="hljs-params">(
    Configuration configuration)</span> <span class="hljs-keyword">throws</span> Exception {
    
    <span class="hljs-comment">// 获取配置</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">inferEnvDirectory</span> <span class="hljs-operator">=</span> configuration
        .getString(GeaFlowConfigKey.GEAFLOW_INFER_ENV_DIR);
    <span class="hljs-type">String</span> <span class="hljs-variable">inferFilesDirectory</span> <span class="hljs-operator">=</span> configuration
        .getString(GeaFlowConfigKey.GEAFLOW_INFER_FILES_DIR);
    
    <span class="hljs-comment">// 创建上下文</span>
    <span class="hljs-type">InferEnvironmentContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> 
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InferEnvironmentContext</span>(
            inferEnvDirectory,
            inferFilesDirectory,
            configuration
        );
    
    <span class="hljs-comment">// InferEnvironmentContext 中的关键初始化</span>
    <span class="hljs-comment">// - virtualEnvDirectory: 虚拟环境目录</span>
    <span class="hljs-comment">// - inferFilesDirectory: Python 脚本目录</span>
    <span class="hljs-comment">// - pythonExec: Python 可执行文件路径</span>
    <span class="hljs-comment">// - inferScript: infer_server.py 路径</span>
    <span class="hljs-comment">// - roleNameIndex: "hostname:pid" 形式的唯一标识</span>
    
    <span class="hljs-keyword">return</span> context;
}
</code></pre>
<p><strong>关键数据</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">配置示例:
  <span class="hljs-attr">GEAFLOW_INFER_ENV_DIR</span> = <span class="hljs-string">"/tmp/geaflow_infer_env"</span>
  <span class="hljs-attr">GEAFLOW_INFER_FILES_DIR</span> = <span class="hljs-string">"/tmp/geaflow_infer_files"</span>

初始化后:
  <span class="hljs-attr">virtualEnvDirectory</span> = <span class="hljs-string">"/tmp/geaflow_infer_env"</span>
  <span class="hljs-attr">pythonExec</span> = <span class="hljs-string">"/tmp/geaflow_infer_env/conda/bin/python3"</span>
  <span class="hljs-attr">inferScript</span> = <span class="hljs-string">"/tmp/geaflow_infer_files/infer_server.py"</span>
  <span class="hljs-attr">roleNameIndex</span> = <span class="hljs-string">"hostname:12345"</span> (主机名:进程ID)
</code></pre>
<h5 data-id="heading-13">Step2: InferDependencyManager 初始化</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在 Step1 之后</span>
<span class="hljs-type">InferDependencyManager</span> <span class="hljs-variable">dependencyManager</span> <span class="hljs-operator">=</span> 
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">InferDependencyManager</span>(environmentContext);

<span class="hljs-comment">// 内部做了什么？</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InferDependencyManager</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">InferDependencyManager</span><span class="hljs-params">(InferEnvironmentContext context)</span> {
        <span class="hljs-built_in">this</span>.environmentContext = context;
        
        <span class="hljs-comment">// 1. 从 JAR 中提取运行时文件</span>
        List&lt;String&gt; runtimeFiles = buildInferRuntimeFiles();
        <span class="hljs-comment">// 返回: ["infer/infer_server.py", "infer/requirements.txt", ...]</span>
        
        <span class="hljs-comment">// 2. 将文件复制到目标目录</span>
        <span class="hljs-keyword">for</span> (String file : runtimeFiles) {
            copyFileFromJar(file, 
                environmentContext.getInferFilesDirectory());
        }
        
        <span class="hljs-comment">// 3. 准备初始化脚本路径</span>
        <span class="hljs-built_in">this</span>.buildInferEnvShellPath = 
            environmentContext.getInferFilesDirectory() 
            + <span class="hljs-string">"/install-infer-env.sh"</span>;
        
        <span class="hljs-comment">// 4. 准备 requirements.txt 路径</span>
        <span class="hljs-built_in">this</span>.inferEnvRequirementsPath = 
            environmentContext.getInferFilesDirectory() 
            + <span class="hljs-string">"/requirements.txt"</span>;
    }
}
</code></pre>
<p><strong>从 JAR 提取文件的原理</strong>：</p>
<pre><code class="hljs language-markdown" lang="markdown">JAR 结构:
  geaflow-infer.jar
  ├─ META-INF/
  ├─ org/apache/geaflow/...  (编译的 class 文件)
  └─ infer/  (资源文件)
<span class="hljs-code">     ├─ infer_server.py       (Python 服务脚本)
     ├─ requirements.txt       (Python 依赖)
     ├─ install-infer-env.sh   (初始化脚本)
     ├─ env/
     │  └─ install-infer-env.sh
     └─ inferRuntime/
        ├─ some_lib.so
        └─ config.json
</span>
提取流程:
<span class="hljs-bullet">  1.</span> 使用 ClassLoader.getResource("infer/inferRuntime")
<span class="hljs-bullet">  2.</span> 列出所有文件
<span class="hljs-bullet">  3.</span> 使用 InputStream 逐个读取
<span class="hljs-bullet">  4.</span> 写入到目标目录
</code></pre>
<h5 data-id="heading-14">Step3: 文件锁机制（详细见后续小节）</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 关键代码</span>
<span class="hljs-type">File</span> <span class="hljs-variable">lockFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(inferEnvDirectory + <span class="hljs-string">"/"</span> + LOCK_FILE);
<span class="hljs-type">FileLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> InferFileUtils.addLock(lockFile);  <span class="hljs-comment">// 获取锁</span>

<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 检查是否已初始化</span>
    <span class="hljs-type">File</span> <span class="hljs-variable">finishFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(inferEnvDirectory + <span class="hljs-string">"/._finish"</span>);
    <span class="hljs-type">File</span> <span class="hljs-variable">failedFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(inferEnvDirectory + <span class="hljs-string">"/._failed"</span>);
    
    <span class="hljs-keyword">if</span> (failedFile.exists()) {
        <span class="hljs-comment">// 之前初始化失败，这次也会失败</span>
        environmentContext.setFinished(<span class="hljs-literal">false</span>);
        <span class="hljs-keyword">return</span> environmentContext;
    }
    
    <span class="hljs-keyword">if</span> (finishFile.exists()) {
        <span class="hljs-comment">// 已初始化成功，直接返回</span>
        environmentContext.setFinished(<span class="hljs-literal">true</span>);
        <span class="hljs-keyword">return</span> environmentContext;
    }
    
    <span class="hljs-comment">// Step4: 执行初始化脚本</span>
    executeInstallScript(...);
    
    <span class="hljs-comment">// Step5: 创建 _finish 标记</span>
    finishFile.createNewFile();
    
} <span class="hljs-keyword">finally</span> {
    lock.release();  <span class="hljs-comment">// 释放锁</span>
}
</code></pre>
<h5 data-id="heading-15">Step4 &amp; Step5: 执行 Shell 脚本</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-meta">#!/bin/bash</span>
<span class="hljs-comment"># install-infer-env.sh</span>

ENV_DIR=<span class="hljs-variable">$1</span>
REQUIREMENTS_FILE=<span class="hljs-variable">$2</span>

<span class="hljs-comment"># Step 1: 创建 Conda 虚拟环境</span>
conda create -p <span class="hljs-variable">${ENV_DIR}</span>/conda python=3.8 -y

<span class="hljs-comment"># Step 2: 激活虚拟环境</span>
<span class="hljs-built_in">source</span> <span class="hljs-variable">${ENV_DIR}</span>/conda/bin/activate

<span class="hljs-comment"># Step 3: 安装 Python 依赖</span>
pip install -r <span class="hljs-variable">${REQUIREMENTS_FILE}</span>

<span class="hljs-comment"># Step 4: 验证安装</span>
python -c <span class="hljs-string">"import sys; print('OK')"</span>

<span class="hljs-built_in">echo</span> <span class="hljs-string">"虚拟环境初始化成功"</span>
</code></pre>
<p><strong>requirements.txt 示例</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 基础依赖</span>
<span class="hljs-attr">numpy</span>==<span class="hljs-number">1.21</span>.<span class="hljs-number">0</span>
<span class="hljs-attr">scipy</span>==<span class="hljs-number">1.7</span>.<span class="hljs-number">0</span>

<span class="hljs-comment"># ML 库</span>
<span class="hljs-attr">tensorflow</span>==<span class="hljs-number">2.6</span>.<span class="hljs-number">0</span>
<span class="hljs-attr">torch</span>==<span class="hljs-number">1.9</span>.<span class="hljs-number">0</span>
<span class="hljs-attr">scikit-learn</span>==<span class="hljs-number">0.24</span>.<span class="hljs-number">2</span>

<span class="hljs-comment"># 工具</span>
<span class="hljs-attr">pydantic</span>==<span class="hljs-number">1.8</span>.<span class="hljs-number">2</span>
</code></pre>
<hr/>
<h3 data-id="heading-16">3.3 文件锁机制实现</h3>
<h4 data-id="heading-17">设计问题</h4>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">场景: 多个 GeaFlow 应用实例运行在同一台机器，</span>
     共享同一个虚拟环境目录

<span class="hljs-section">问题:</span>
  实例A                    实例B
    │                        │
    └─→ 进程启动             └─→ 进程启动
        ├─→ 检查 _finish  ✗    ├─→ 检查 _finish  ✗
        ├─→ 开始初始化         ├─→ 开始初始化
        │   conda create...    │   conda create...
        │   安装依赖(耗时5s)    │   (重复安装! 可能冲突)
        │   ...                │   ...
        ├─→ 创建 _finish ✓     └─→ 创建 _finish ✓
        │                       
        └─→ 初始化完成          └─→ 初始化完成

<span class="hljs-section">问题: 两个进程都认为虚拟环境还未初始化，</span>
     都开始初始化，导致重复和冲突！
</code></pre>
<h4 data-id="heading-18">文件锁解决方案</h4>
<h5 data-id="heading-19">Java 中的 FileLock</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> FileLock <span class="hljs-title function_">addLock</span><span class="hljs-params">(File lockFile)</span> <span class="hljs-keyword">throws</span> IOException {
    <span class="hljs-comment">// Step 1: 创建锁文件</span>
    <span class="hljs-keyword">if</span> (!lockFile.exists()) {
        lockFile.createNewFile();
    }
    
    <span class="hljs-comment">// Step 2: 打开文件通道</span>
    <span class="hljs-type">RandomAccessFile</span> <span class="hljs-variable">raf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RandomAccessFile</span>(lockFile, <span class="hljs-string">"rw"</span>);
    <span class="hljs-type">FileChannel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> raf.getChannel();
    
    <span class="hljs-comment">// Step 3: 请求文件锁</span>
    <span class="hljs-comment">// 如果锁已被其他进程持有，这里会阻塞</span>
    <span class="hljs-type">FileLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> channel.lock();  <span class="hljs-comment">// 阻塞直到获得锁</span>
    
    <span class="hljs-comment">// 返回后，说明已获得独占锁</span>
    <span class="hljs-keyword">return</span> lock;
}
</code></pre>
<h5 data-id="heading-20">流程图</h5>
<pre><code class="hljs language-scss" lang="scss">实例<span class="hljs-selector-tag">A</span>                        文件系统             实例<span class="hljs-selector-tag">B</span>
  │                             │                  │
  ├─→ 打开 lock 文件             │                  │
  ├─→ 请求锁 lock<span class="hljs-selector-class">.lock</span>()        │                  │
  │   <span class="hljs-selector-attr">[获得锁 ✓]</span> ←──────────────┤                  │
  │                             │ ←─────────────────┤
  │                             │                  ├─→ 打开 lock 文件
  │                             │                  ├─→ 请求锁 lock<span class="hljs-selector-class">.lock</span>()
  │   <span class="hljs-selector-attr">[持有锁中...]</span>              │                  │   <span class="hljs-selector-attr">[阻塞，等待锁]</span> 
  │   ├─→ 检查 _finish  ✗        │                  │
  │   ├─→ 初始化虚拟环境         │                  │   <span class="hljs-selector-attr">[等待...]</span>
  │   │   conda create...        │                  │   <span class="hljs-selector-attr">[等待...]</span>
  │   │   pip install...         │                  │
  │   │   <span class="hljs-selector-attr">[耗时 5 秒]</span>             │                  │
  │   ├─→ 创建 _finish ✓         │                  │
  │   └─→ 释放锁                 │                  │
  │       lock<span class="hljs-selector-class">.release</span>()         │ ────────────────→│
  │                             │                  ├─→ <span class="hljs-selector-attr">[获得锁 ✓]</span>
  │                             │                  ├─→ 检查 _finish ✓
  │                             │                  ├─→ <span class="hljs-selector-attr">[已初始化，跳过]</span>
  │                             │                  └─→ 释放锁
</code></pre>
<h4 data-id="heading-21">完整的初始化流程（带文件锁）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> InferEnvironmentContext <span class="hljs-title function_">constructInferEnvironment</span><span class="hljs-params">(
    Configuration configuration)</span> <span class="hljs-keyword">throws</span> Exception {
    
    <span class="hljs-comment">// Step 1: 创建环境上下文</span>
    <span class="hljs-type">InferEnvironmentContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> 
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InferEnvironmentContext</span>(inferEnvDirectory, ...);
    
    <span class="hljs-comment">// Step 2: 创建依赖管理器</span>
    <span class="hljs-type">InferDependencyManager</span> <span class="hljs-variable">depManager</span> <span class="hljs-operator">=</span> 
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">InferDependencyManager</span>(context);
    
    <span class="hljs-comment">// Step 3: 获取文件锁（关键！）</span>
    <span class="hljs-type">File</span> <span class="hljs-variable">lockFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(inferEnvDirectory + <span class="hljs-string">"/.lock"</span>);
    <span class="hljs-type">FileLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> InferFileUtils.addLock(lockFile);
    
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// Step 4: 检查初始化状态</span>
        <span class="hljs-type">File</span> <span class="hljs-variable">finishFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(inferEnvDirectory + <span class="hljs-string">"/._finish"</span>);
        <span class="hljs-type">File</span> <span class="hljs-variable">failedFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(inferEnvDirectory + <span class="hljs-string">"/._failed"</span>);
        
        <span class="hljs-keyword">if</span> (failedFile.exists()) {
            LOGGER.warn(<span class="hljs-string">"虚拟环境之前初始化失败，本次也可能失败"</span>);
            context.setFinished(<span class="hljs-literal">false</span>);
            <span class="hljs-keyword">return</span> context;
        }
        
        <span class="hljs-keyword">if</span> (finishFile.exists()) {
            LOGGER.info(<span class="hljs-string">"虚拟环境已初始化，直接使用"</span>);
            context.setFinished(<span class="hljs-literal">true</span>);
            <span class="hljs-keyword">return</span> context;
        }
        
        <span class="hljs-comment">// Step 5: 执行初始化脚本</span>
        LOGGER.info(<span class="hljs-string">"开始初始化虚拟环境..."</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">shellPath</span> <span class="hljs-operator">=</span> depManager.getInferEnvShellPath();
        <span class="hljs-type">String</span> <span class="hljs-variable">requirementsPath</span> <span class="hljs-operator">=</span> depManager.getInferEnvRequirementsPath();
        
        <span class="hljs-type">ProcessBuilder</span> <span class="hljs-variable">pb</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProcessBuilder</span>(
            <span class="hljs-string">"bash"</span>, shellPath, inferEnvDirectory, requirementsPath
        );
        pb.redirectErrorStream(<span class="hljs-literal">true</span>);
        <span class="hljs-type">Process</span> <span class="hljs-variable">process</span> <span class="hljs-operator">=</span> pb.start();
        
        <span class="hljs-type">int</span> <span class="hljs-variable">exitCode</span> <span class="hljs-operator">=</span> process.waitFor();
        <span class="hljs-keyword">if</span> (exitCode != <span class="hljs-number">0</span>) {
            failedFile.createNewFile();  <span class="hljs-comment">// 标记失败</span>
            context.setFinished(<span class="hljs-literal">false</span>);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"虚拟环境初始化失败"</span>);
        }
        
        <span class="hljs-comment">// Step 6: 标记成功</span>
        finishFile.createNewFile();
        context.setFinished(<span class="hljs-literal">true</span>);
        LOGGER.info(<span class="hljs-string">"虚拟环境初始化成功"</span>);
        
    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-comment">// 一定要释放锁！</span>
        lock.release();
    }
    
    <span class="hljs-keyword">return</span> context;
}
</code></pre>
<h4 data-id="heading-22">文件锁的细节</h4>
<h5 data-id="heading-23">锁的作用范围</h5>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 同一 JVM 内的不同线程:</span>
  线程A: fileLock1 = channel.<span class="hljs-keyword">lock</span>()
  线程B: fileLock2 = channel.<span class="hljs-keyword">lock</span>()  <span class="hljs-comment">// 会阻塞！</span>

<span class="hljs-comment">// 不同 JVM 进程:</span>
  Java进程A: fileLock1 = channel.<span class="hljs-keyword">lock</span>()
  Java进程B: fileLock2 = channel.<span class="hljs-keyword">lock</span>()  <span class="hljs-comment">// 会阻塞！</span>
  
  C进程: flock() 或 fcntl()  <span class="hljs-comment">// 也会被阻塞</span>

结论: FileLock 是进程级别的，不仅仅是线程级别
</code></pre>
<h5 data-id="heading-24">锁的自动释放</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 自动释放情况:</span>
<span class="hljs-number">1.</span> 显式调用 lock.release()
<span class="hljs-number">2.</span> 持有 Lock 的 FileChannel 关闭
<span class="hljs-number">3.</span> 持有 Lock 的 JVM 进程终止

<span class="hljs-comment">// ❌ 危险做法:</span>
<span class="hljs-type">RandomAccessFile</span> <span class="hljs-variable">raf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RandomAccessFile</span>(file, <span class="hljs-string">"rw"</span>);
<span class="hljs-type">FileChannel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> raf.getChannel();
<span class="hljs-type">FileLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> channel.lock();
<span class="hljs-comment">// ... 忘记释放 ...</span>
<span class="hljs-comment">// 锁会在进程终止时自动释放，但期间会阻塞其他进程</span>

<span class="hljs-comment">// ✓ 正确做法:</span>
<span class="hljs-keyword">try</span> {
    lock = channel.lock();
    <span class="hljs-comment">// ... 关键操作 ...</span>
} <span class="hljs-keyword">finally</span> {
    <span class="hljs-keyword">if</span> (lock != <span class="hljs-literal">null</span>) lock.release();
    <span class="hljs-keyword">if</span> (channel != <span class="hljs-literal">null</span>) channel.close();
    <span class="hljs-keyword">if</span> (raf != <span class="hljs-literal">null</span>) raf.close();
}
</code></pre>
<hr/>
<h3 data-id="heading-25">3.4 环境状态管理与错误处理</h3>
<h4 data-id="heading-26">状态机设计</h4>
<pre><code class="hljs language-scss" lang="scss">┌─────────────┐
│   INITIAL   │  应用刚启动
│  (初始状态)  │
└──────┬──────┘
       │
       │ <span class="hljs-built_in">buildInferEnvironmentManager</span>()
       ▼
┌─────────────┐
│ INITIALIZING│  虚拟环境初始化中
│  (初始化中)  │
└──────┬──────┘
       │
   ┌───┴───┐
   │       │
   ▼       ▼
┌──────┐ ┌──────┐
│SUCCESS │FAILED│  初始化结果
└──────┘ └──────┘
 │        │
 │        │ 后续 <span class="hljs-built_in">infer</span>() 调用
 │        ▼
 │     ┌────────────────┐
 │     │ 抛出异常        │
 │     │(初始化失败)      │
 │     └────────────────┘
 │
 │ 后续 <span class="hljs-built_in">infer</span>() 调用
 ▼
┌────────────────┐
│ RUNNING        │
│ (推理中)        │
└────────────────┘
</code></pre>
<h4 data-id="heading-27">关键状态检查</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InferEnvironmentManager</span> {
    
    <span class="hljs-comment">// 1. 检查初始化是否完成</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Boolean <span class="hljs-title function_">checkInferEnvironmentStatus</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> SUCCESS_FLAG.get();
    }
    
    <span class="hljs-comment">// 2. 获取环境上下文</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> InferEnvironmentContext <span class="hljs-title function_">getEnvironmentContext</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> environmentContext;
    }
    
    <span class="hljs-comment">// 3. 检查并抛出错误</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkError</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">final</span> <span class="hljs-type">Throwable</span> <span class="hljs-variable">exception</span> <span class="hljs-operator">=</span> ERROR_CASE.get();
        <span class="hljs-keyword">if</span> (exception != <span class="hljs-literal">null</span>) {
            <span class="hljs-type">String</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-string">"虚拟环境初始化失败: "</span> 
                + exception.getMessage();
            LOGGER.error(message);
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">GeaflowRuntimeException</span>(message, exception);
        }
    }
}
</code></pre>
<h4 data-id="heading-28">在 InferContext 中的使用</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InferContext</span> {
    
    <span class="hljs-keyword">public</span> &lt;OUT&gt; OUT <span class="hljs-title function_">infer</span><span class="hljs-params">(Object... inputs)</span> <span class="hljs-keyword">throws</span> IOException {
        <span class="hljs-comment">// 1. 检查虚拟环境是否初始化成功</span>
        InferEnvironmentManager.checkError();
        
        <span class="hljs-comment">// 2. 等待虚拟环境就绪（如果还在初始化）</span>
        <span class="hljs-keyword">while</span> (!InferEnvironmentManager.checkInferEnvironmentStatus()) {
            Thread.sleep(<span class="hljs-number">100</span>);  <span class="hljs-comment">// 等待 100ms</span>
            InferEnvironmentManager.checkError();  <span class="hljs-comment">// 检查是否失败</span>
            
            <span class="hljs-keyword">if</span> (System.currentTimeMillis() - startTime &gt; TIMEOUT) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TimeoutException</span>(<span class="hljs-string">"虚拟环境初始化超时"</span>);
            }
        }
        
        <span class="hljs-comment">// 3. 虚拟环境就绪，开始推理</span>
        <span class="hljs-keyword">return</span> dataBridge.read();  <span class="hljs-comment">// 这里已安全</span>
    }
}
</code></pre>
<h4 data-id="heading-29">错误恢复机制</h4>
<h5 data-id="heading-30">场景 1: 初始化脚本失败</h5>
<pre><code class="hljs language-ini" lang="ini">infer() 调用
  ↓
检查虚拟环境状态
  ├─→ <span class="hljs-attr">SUCCESS_FLAG</span> = <span class="hljs-literal">false</span> ✗
  ├─→ <span class="hljs-attr">ERROR_CASE</span> = RuntimeException(<span class="hljs-string">"conda create failed"</span>)
  │
  └─→ 抛出异常给用户
      用户应处理这个异常：
      - 检查网络连接（pip 下载）
      - 检查磁盘空间
      - 检查 requirements.txt 是否有冲突
      - 手动删除虚拟环境目录，重新初始化
</code></pre>
<h5 data-id="heading-31">场景 2: 进程中途崩溃</h5>
<pre><code class="hljs language-arduino" lang="arduino">虚拟环境初始化中...
  → conda create... ✓
  → pip install... ✓
  → 写入 _finish ✓
  → 释放锁
  
此时 process 异常退出

下次启动:
  检查 _finish ✓ 存在
  → 直接使用已初始化的环境
  → 不重复初始化
</code></pre>
<hr/>
<h4 data-id="heading-32">最佳实践</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✓ 正确用法</span>
<span class="hljs-keyword">try</span> {
    <span class="hljs-type">InferContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> InferContext.build(config);
    
    <span class="hljs-comment">// 虚拟环境初始化在后台进行</span>
    <span class="hljs-comment">// 这里立即返回，不会阻塞</span>
    
    <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> context.infer(features);
    <span class="hljs-comment">// 首次 infer() 会等待虚拟环境就绪</span>
    
} <span class="hljs-keyword">catch</span> (GeaflowRuntimeException e) {
    <span class="hljs-comment">// 虚拟环境初始化失败</span>
    <span class="hljs-comment">// 检查日志，修正问题后重新启动应用</span>
    e.printStackTrace();
}
</code></pre>
<hr/>
<h3 data-id="heading-33">参考资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.oracle.com%2Fjavase%2F8%2Fdocs%2Fapi%2Fjava%2Fnio%2Fchannels%2FFileLock.html" target="_blank" title="https://docs.oracle.com/javase/8/docs/api/java/nio/channels/FileLock.html" ref="nofollow noopener noreferrer">Java FileLock 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fstackoverflow.com%2Fquestions%2F21922125%2F" target="_blank" title="https://stackoverflow.com/questions/21922125/" ref="nofollow noopener noreferrer">AtomicBoolean vs synchronized</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.conda.io%2Fprojects%2Fconda%2Fen%2Flatest%2Fuser-guide%2F" target="_blank" title="https://docs.conda.io/projects/conda/en/latest/user-guide/" ref="nofollow noopener noreferrer">Conda 虚拟环境</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Frefactoring.guru%2Fdesign-patterns%2Fsingleton" target="_blank" title="https://refactoring.guru/design-patterns/singleton" ref="nofollow noopener noreferrer">单例模式最佳实践</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Go 接口与代码复用：替代继承的设计哲学]]></title>    <link>https://juejin.cn/post/7576609946190577700</link>    <guid>https://juejin.cn/post/7576609946190577700</guid>    <pubDate>2025-11-26T04:45:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576609946190577700" data-draft-id="7576575703167254534" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Go 接口与代码复用：替代继承的设计哲学"/> <meta itemprop="keywords" content="后端,Go"/> <meta itemprop="datePublished" content="2025-11-26T04:45:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="喵个咪"/> <meta itemprop="url" content="https://juejin.cn/user/1350630784901262"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Go 接口与代码复用：替代继承的设计哲学
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1350630784901262/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    喵个咪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T04:45:44.000Z" title="Wed Nov 26 2025 04:45:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Go 接口与代码复用：替代继承的设计哲学</h2>
<h3 data-id="heading-1">一、前言</h3>
<p>Go 是 Google 设计的类 C 静态类型语言，兼顾底层性能与开发效率。它并非传统意义上的面向对象（OOP）语言 —— 没有 class 关键字，也不支持传统的 “继承” 语法，但通过 <strong>接口的隐式实现</strong> 和 <strong>结构体组合（嵌入）</strong>，Go 能灵活实现 OOP 的核心特性（多态、代码复用），且设计更简洁、无继承带来的耦合问题。
与 C++ 相比，Go 的设计哲学是 “<strong>组合优于继承</strong>”：用接口实现多态，用结构体嵌入实现代码复用，既避免了继承的复杂语法，又解决了多重继承的歧义问题。本文将通过类比 C++ 的接口 / 继承逻辑，详解 Go 如何实现类似效果。</p>
<h3 data-id="heading-2">二、Go 中的 “单一复用”（类似单一继承）</h3>
<p>C++ 的单一继承核心是 “一个子类继承一个父类 / 接口”，Go 中通过两种方式实现类似效果：<strong>仅用接口实现多态</strong>（无代码复用，仅约束行为）、<strong>结构体组合（嵌入）+ 接口</strong>（既有代码复用，又有多态）。</p>
<h4 data-id="heading-3">2.1 仅通过接口实现（隐式多态）</h4>
<p>C++ 的接口是 “纯虚函数集合”，子类需显式声明继承并实现所有接口方法；而 Go 的接口是 “方法签名集合”，<strong>无需显式声明实现</strong>—— 只要结构体实现了接口的所有方法，就自动满足该接口，这就是 “隐式实现”，也是 Go 接口的核心特性。</p>
<h5 data-id="heading-4">类比 C++ 伪代码</h5>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// C++ 需显式声明继承接口</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">IFruit</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> std::string <span class="hljs-title">GetName</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>= <span class="hljs-number">0</span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">SetName</span><span class="hljs-params">(std::string name)</span> </span>= <span class="hljs-number">0</span>;
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> std::string <span class="hljs-title">GetType</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>= <span class="hljs-number">0</span>;
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Apple</span> : <span class="hljs-keyword">public</span> IFruit { <span class="hljs-comment">// 显式继承</span>
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">std::string <span class="hljs-title">GetName</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{ <span class="hljs-comment">/* 实现 */</span> }
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetName</span><span class="hljs-params">(std::string name)</span> <span class="hljs-keyword">override</span> </span>{ <span class="hljs-comment">/* 实现 */</span> }
    <span class="hljs-function">std::string <span class="hljs-title">GetType</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"apple"</span>; }
};
</code></pre>
<h5 data-id="heading-5">Go 实现代码</h5>
<p>首先定义接口（仅约束行为，无实现）：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 定义 Fruit 接口：仅声明方法签名，无实现</span>
<span class="hljs-keyword">type</span> FruitType <span class="hljs-type">string</span> <span class="hljs-comment">// 补充类型定义，使代码可运行</span>
<span class="hljs-keyword">const</span> (
    BananaType FruitType = <span class="hljs-string">"banana"</span>
    AppleType  FruitType = <span class="hljs-string">"apple"</span>
)

<span class="hljs-keyword">type</span> Fruit <span class="hljs-keyword">interface</span> {
    GetName() <span class="hljs-type">string</span>
    SetName(name <span class="hljs-type">string</span>)
    GetType() FruitType <span class="hljs-comment">// 明确类型，避免歧义</span>
}
</code></pre>
<p>定义 Banana 结构体，隐式实现 Fruit 接口：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> Banana <span class="hljs-keyword">struct</span> {
    name   <span class="hljs-type">string</span>
    energy <span class="hljs-type">float32</span> <span class="hljs-comment">// 自定义字段</span>
}

<span class="hljs-comment">// 构造函数：初始化 Banana 实例</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewBanana</span><span class="hljs-params">(name <span class="hljs-type">string</span>)</span></span> *Banana {
    <span class="hljs-keyword">return</span> &amp;Banana{
        name:   name,
        energy: <span class="hljs-number">0</span>,
    }
}

<span class="hljs-comment">// 实现 Fruit 接口的所有方法（隐式满足 Fruit 接口）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Banana)</span></span> GetName() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> b.name
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Banana)</span></span> SetName(name <span class="hljs-type">string</span>) {
    b.name = name
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Banana)</span></span> GetType() FruitType {
    <span class="hljs-keyword">return</span> BananaType
}

<span class="hljs-comment">// Banana 自定义方法（接口未约束，仅自身可用）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Banana)</span></span> SetEnergy(energy <span class="hljs-type">float32</span>) {
    b.energy = energy
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Banana)</span></span> GetEnergy() <span class="hljs-type">float32</span> {
    <span class="hljs-keyword">return</span> b.energy
}
</code></pre>
<h5 data-id="heading-6">接口的两种使用方式（体现多态）</h5>
<h6 data-id="heading-7">1. 赋值给接口变量：通过接口统一调用，屏蔽具体实现</h6>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">var</span> fruit Fruit <span class="hljs-comment">// 接口变量</span>
fruit = NewBanana(<span class="hljs-string">"big banana"</span>) <span class="hljs-comment">// 隐式转换，无需显式声明</span>
fmt.Println(fruit.GetName()) <span class="hljs-comment">// 输出：big banana（调用 Banana 的实现）</span>
fmt.Println(fruit.GetType()) <span class="hljs-comment">// 输出：banana</span>
</code></pre>
<h6 data-id="heading-8">2. 直接使用结构体实例：可调用接口方法 + 自定义方法</h6>
<pre><code class="hljs language-go" lang="go">banana := NewBanana(<span class="hljs-string">"little banana"</span>)
banana.SetEnergy(<span class="hljs-number">100</span>) <span class="hljs-comment">// 调用自定义方法</span>
fmt.Println(banana.GetEnergy()) <span class="hljs-comment">// 输出：100</span>
fmt.Println(banana.GetName()) <span class="hljs-comment">// 输出：little banana（调用接口方法）</span>
</code></pre>
<h6 data-id="heading-9">3. 工厂方法统一创建实例（增强多态灵活性）</h6>
<p>补充 NewFruit 实现，根据类型创建不同 Fruit 实例：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewFruit</span><span class="hljs-params">(fruitType FruitType, name <span class="hljs-type">string</span>)</span></span> Fruit {
    <span class="hljs-keyword">switch</span> fruitType {
    <span class="hljs-keyword">case</span> BananaType:
        <span class="hljs-keyword">return</span> NewBanana(name)
    <span class="hljs-keyword">case</span> AppleType:
        <span class="hljs-keyword">return</span> NewApple(name) <span class="hljs-comment">// 需实现 Apple 结构体（类似 Banana）</span>
    <span class="hljs-keyword">default</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span>
    }
}

<span class="hljs-comment">// 使用工厂方法</span>
apple := NewFruit(AppleType, <span class="hljs-string">"red apple"</span>)
banana := NewFruit(BananaType, <span class="hljs-string">"yellow banana"</span>)
fmt.Println(apple.GetName(), banana.GetName()) <span class="hljs-comment">// 统一调用接口方法`</span>
</code></pre>
<h4 data-id="heading-10">2.2 结构体组合（嵌入）实现代码复用（类似基类继承）</h4>
<p>C++ 中通过 “子类继承基类” 复用基类代码，Go 中通过 “结构体嵌入”（将一个结构体作为另一个结构体的匿名字段）实现代码复用 —— 嵌入的结构体（称为 “嵌入类型”）的方法和字段，会被外层结构体 “继承”（实际是隐式代理），外层结构体可直接调用，也可覆盖这些方法。</p>
<h5 data-id="heading-11">类比 C++ 伪代码</h5>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 基类（含部分实现）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">VehicleBase</span> : <span class="hljs-keyword">public</span> IVehicle {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetWheelCount</span><span class="hljs-params">(<span class="hljs-type">int</span> count)</span> <span class="hljs-keyword">override</span> </span>{ wheelCount = count; }
    <span class="hljs-function"><span class="hljs-type">int</span> <span class="hljs-title">GetWheelCount</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{ <span class="hljs-keyword">return</span> wheelCount; }
    <span class="hljs-function">std::string <span class="hljs-title">ToString</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"vehicle -&gt; "</span>; }
<span class="hljs-keyword">private</span>:
    <span class="hljs-type">int</span> wheelCount;
};

<span class="hljs-comment">// 子类继承基类，复用方法并可覆盖</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Bus</span> : <span class="hljs-keyword">public</span> VehicleBase {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">std::string <span class="hljs-title">GetName</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{ <span class="hljs-keyword">return</span> name; }
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">SetName</span><span class="hljs-params">(std::string n)</span> <span class="hljs-keyword">override</span> </span>{ name = n; }
    <span class="hljs-function">std::string <span class="hljs-title">ToString</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> <span class="hljs-keyword">override</span> </span>{
        <span class="hljs-keyword">return</span> VehicleBase::<span class="hljs-built_in">ToString</span>() + <span class="hljs-string">"Bus -&gt; "</span> + name; <span class="hljs-comment">// 调用基类方法</span>
    }
<span class="hljs-keyword">private</span>:
    std::string name;
};
</code></pre>
<h5 data-id="heading-12">Go 实现代码</h5>
<h6 data-id="heading-13">1. 定义接口（约束核心行为）：</h6>
<pre><code class="hljs language-go" lang="go"><span class="hljs-keyword">type</span> VehicleType <span class="hljs-type">string</span>
<span class="hljs-keyword">const</span> (
    BusType VehicleType = <span class="hljs-string">"bus"</span>
)

<span class="hljs-keyword">type</span> Vehicle <span class="hljs-keyword">interface</span> {
    GetType() VehicleType
    GetName() <span class="hljs-type">string</span>
    SetName(name <span class="hljs-type">string</span>)
    SetWheelCount(count <span class="hljs-type">int</span>)
    GetWheelCount() <span class="hljs-type">int</span>
    ToString() <span class="hljs-type">string</span>
}
</code></pre>
<h6 data-id="heading-14">2. 定义 “嵌入结构体”（类似基类，提供通用实现）：</h6>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// vehicleImpl 是通用实现，作为嵌入类型供其他结构体复用</span>
<span class="hljs-keyword">type</span> vehicleImpl <span class="hljs-keyword">struct</span> {
    wheelCount <span class="hljs-type">int</span> <span class="hljs-comment">// 通用字段</span>
}

<span class="hljs-comment">// 通用方法实现（供嵌入者复用）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(v *vehicleImpl)</span></span> SetWheelCount(count <span class="hljs-type">int</span>) {
    v.wheelCount = count
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(v *vehicleImpl)</span></span> GetWheelCount() <span class="hljs-type">int</span> {
    <span class="hljs-keyword">return</span> v.wheelCount
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(v *vehicleImpl)</span></span> ToString() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"vehicle -&gt; "</span>
}
</code></pre>
<h6 data-id="heading-15">3. 定义外层结构体（嵌入 vehicleImpl，复用代码）：</h6>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Bus 结构体通过嵌入 vehicleImpl，复用其方法和字段</span>
<span class="hljs-keyword">type</span> Bus <span class="hljs-keyword">struct</span> {
    vehicleImpl <span class="hljs-comment">// 匿名嵌入（组合），无需显式调用</span>
    name        <span class="hljs-type">string</span> <span class="hljs-comment">// 自身字段</span>
}

<span class="hljs-comment">// 构造函数：初始化 Bus 实例（需初始化嵌入结构体）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewBus</span><span class="hljs-params">(name <span class="hljs-type">string</span>)</span></span> *Bus {
    <span class="hljs-keyword">return</span> &amp;Bus{
        name: name,
        vehicleImpl: vehicleImpl{ <span class="hljs-comment">// 初始化嵌入结构体</span>
            wheelCount: <span class="hljs-number">4</span>, <span class="hljs-comment">// 公交车默认4个轮子</span>
        },
    }
}

<span class="hljs-comment">// 实现 Vehicle 接口的剩余方法（未被 vehicleImpl 实现的部分）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Bus)</span></span> GetType() VehicleType {
    <span class="hljs-keyword">return</span> BusType
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Bus)</span></span> GetName() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> b.name
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Bus)</span></span> SetName(name <span class="hljs-type">string</span>) {
    b.name = name
}

<span class="hljs-comment">// 覆盖嵌入结构体的 ToString 方法</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(b *Bus)</span></span> ToString() <span class="hljs-type">string</span> {
    <span class="hljs-comment">// 调用嵌入结构体的被覆盖方法：b.vehicleImpl.ToString()</span>
    <span class="hljs-keyword">return</span> b.vehicleImpl.ToString() + fmt.Sprintf(<span class="hljs-string">"Bus -&gt; %s (wheels: %d)"</span>, b.GetName(), b.GetWheelCount())
}
</code></pre>
<h6 data-id="heading-16">核心特性说明</h6>
<ul>
<li>代码复用：<code>Bus</code> 无需重新实现 <code>SetWheelCount</code>、<code>GetWheelCount</code>，直接复用 <code>vehicleImpl</code> 的方法；</li>
<li>方法覆盖：<code>Bus</code> 定义了与 <code>vehicleImpl</code> 同名的 <code>ToString</code> 方法，会覆盖嵌入结构体的方法，优先调用外层方法；</li>
<li>显式调用嵌入方法：通过 <code>b.vehicleImpl.ToString()</code> 可调用被覆盖的嵌入结构体方法；</li>
<li>字段访问：嵌入结构体的字段可直接访问（<code>b.wheelCount</code>），也可显式访问（<code>b.vehicleImpl.wheelCount</code>）。</li>
</ul>
<h3 data-id="heading-17">三、Go 中的 “多组合”（类似多重继承）</h3>
<p>C++ 支持多重继承（一个类继承多个父类），但容易引发 “菱形继承”（多个父类继承自同一基类）的歧义问题。Go 本身<strong>不支持传统多重继承</strong>，但通过 “多嵌入”（一个结构体嵌入多个结构体），可实现类似 “多重继承” 的效果 —— 复用多个嵌入结构体的方法和字段，且无歧义。</p>
<h4 data-id="heading-18">类比 C++ 伪代码</h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Father</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">std::string <span class="hljs-title">GetName</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"Tony"</span>; }
    <span class="hljs-function">std::string <span class="hljs-title">Say</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"I am "</span> + <span class="hljs-built_in">GetName</span>(); }
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Mother</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">std::string <span class="hljs-title">GetName</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"Aurora"</span>; }
    <span class="hljs-function">std::string <span class="hljs-title">Say</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"I am "</span> + <span class="hljs-built_in">GetName</span>(); }
};

<span class="hljs-comment">// 多重继承：同时继承 Father 和 Mother</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Child</span> : <span class="hljs-keyword">public</span> Father, <span class="hljs-keyword">public</span> Mother {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function">std::string <span class="hljs-title">GetName</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">"Jerry"</span>; }
    <span class="hljs-function">std::string <span class="hljs-title">Say</span><span class="hljs-params">()</span> <span class="hljs-type">const</span> </span>{
        <span class="hljs-comment">// 显式调用父类方法，避免歧义</span>
        <span class="hljs-keyword">return</span> <span class="hljs-string">"I am "</span> + <span class="hljs-built_in">GetName</span>() + <span class="hljs-string">", Father: "</span> + Father::<span class="hljs-built_in">Say</span>() + <span class="hljs-string">", Mother: "</span> + Mother::<span class="hljs-built_in">Say</span>();
    }
};
</code></pre>
<h4 data-id="heading-19">Go 实现代码（多嵌入结构体）</h4>
<h5 data-id="heading-20">1. 定义两个 “被组合” 的结构体（类似父类）：</h5>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Father 结构体（提供一组方法）</span>
<span class="hljs-keyword">type</span> Father <span class="hljs-keyword">struct</span>{}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewFather</span><span class="hljs-params">()</span></span> *Father {
    <span class="hljs-keyword">return</span> &amp;Father{}
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f *Father)</span></span> GetName() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Tony"</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(f *Father)</span></span> Say() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"I am "</span> + f.GetName()
}

<span class="hljs-comment">// Mother 结构体（提供另一组方法）</span>
<span class="hljs-keyword">type</span> Mother <span class="hljs-keyword">struct</span>{}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewMother</span><span class="hljs-params">()</span></span> *Mother {
    <span class="hljs-keyword">return</span> &amp;Mother{}
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Mother)</span></span> GetName() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Aurora"</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(m *Mother)</span></span> Say() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"I am "</span> + m.GetName()
}
</code></pre>
<h5 data-id="heading-21">2. 定义 Child 结构体（嵌入 Father 和 Mother）：</h5>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// Child 嵌入两个结构体，复用其方法</span>
<span class="hljs-keyword">type</span> Child <span class="hljs-keyword">struct</span> {
    *Mother <span class="hljs-comment">// 指针嵌入（需初始化指针）</span>
    *Father <span class="hljs-comment">// 指针嵌入</span>
}

<span class="hljs-comment">// 构造函数：初始化 Child 及嵌入的结构体指针</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">NewChild</span><span class="hljs-params">()</span></span> *Child {
    <span class="hljs-keyword">return</span> &amp;Child{
        Mother: NewMother(), <span class="hljs-comment">// 初始化 Mother 指针</span>
        Father: NewFather(), <span class="hljs-comment">// 初始化 Father 指针</span>
    }
}

<span class="hljs-comment">// 覆盖嵌入结构体的同名方法（避免调用歧义）</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Child)</span></span> GetName() <span class="hljs-type">string</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-string">"Jerry"</span>
}

<span class="hljs-comment">// 自定义方法，显式调用嵌入结构体的方法</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(c *Child)</span></span> Say() <span class="hljs-type">string</span> {
    <span class="hljs-comment">// 显式指定嵌入结构体，调用其方法（无歧义）</span>
    fatherSay := c.Father.Say()
    motherSay := c.Mother.Say()
    <span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">"I am %s. Father: %s, Mother: %s"</span>, c.GetName(), fatherSay, motherSay)
}
</code></pre>
<h5 data-id="heading-22">3. 使用示例：</h5>
<pre><code class="hljs language-go" lang="go">child := NewChild()
fmt.Println(child.Say())
<span class="hljs-comment">// 输出：I am Jerry. Father: I am Tony, Mother: I am Aurora</span>
</code></pre>
<h5 data-id="heading-23">核心规则（避免歧义）</h5>
<ul>
<li><strong>嵌入方式</strong>：支持值嵌入（<code>Father</code>）和指针嵌入（<code>*Mother</code>），指针嵌入需在构造时初始化指针；</li>
<li><strong>同名方法处理</strong>：若多个嵌入结构体有同名方法，外层结构体必须定义同名方法覆盖（否则调用时会编译报错，提示歧义）；</li>
<li><strong>显式调用嵌入方法</strong>：通过 <code>c.Father.Say()</code> 显式指定嵌入结构体，避免歧义，这是 Go 处理 “多组合” 冲突的核心方式。</li>
</ul>
<h3 data-id="heading-24">四、Go 与 C++ 核心区别总结</h3>



































<table><thead><tr><th>特性</th><th>C++</th><th>Go</th></tr></thead><tbody><tr><td>接口实现</td><td>显式继承（<code>public</code> 接口）</td><td>隐式实现（无需声明，实现方法即满足）</td></tr><tr><td>代码复用</td><td>继承基类</td><td>结构体嵌入（组合）</td></tr><tr><td>多重继承</td><td>支持（易引发菱形继承歧义）</td><td>不支持，通过多嵌入实现多组合（无歧义）</td></tr><tr><td>方法覆盖</td><td>需 <code>override</code> 关键字</td><td>同名方法自动覆盖（外层优先）</td></tr><tr><td>核心设计哲学</td><td>继承优先</td><td>组合优于继承</td></tr></tbody></table>
<h3 data-id="heading-25">五、完整代码仓库</h3>
<p>本文所有可运行代码已整理至 GitHub，包含接口、组合、多组合的完整示例，可直接克隆运行：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftx7do%2Fgo-inheritance-example" target="_blank" title="https://github.com/tx7do/go-inheritance-example" ref="nofollow noopener noreferrer">github.com/tx7do/go-in…</a></p>
<h3 data-id="heading-26">六、总结</h3>
<p>Go 没有传统 OOP 的 “类” 和 “继承”，但通过 <strong>接口的隐式多态</strong> 和 <strong>结构体的组合（嵌入）</strong>，实现了更灵活、低耦合的代码复用和多态特性：</p>
<ol>
<li>接口负责 “约束行为”，隐式实现让代码更简洁，支持多态；</li>
<li>结构体嵌入负责 “复用代码”，替代传统继承，无耦合问题；</li>
<li>多嵌入实现类似 “多重继承” 的效果，但通过显式调用避免歧义。</li>
</ol>
<p>这种设计既保留了 OOP 的核心优势，又规避了继承带来的复杂问题，是 Go 简洁、高效的关键原因之一。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Apache Geaflow推理框架Geaflow-infer 解析系列（一）Geaflow-Infer 模块简介]]></title>    <link>https://juejin.cn/post/7576646142315970601</link>    <guid>https://juejin.cn/post/7576646142315970601</guid>    <pubDate>2025-11-26T04:37:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576646142315970601" data-draft-id="7576575703167156230" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Apache Geaflow推理框架Geaflow-infer 解析系列（一）Geaflow-Infer 模块简介"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2025-11-26T04:37:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="语落心生"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147955741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Apache Geaflow推理框架Geaflow-infer 解析系列（一）Geaflow-Infer 模块简介
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147955741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    语落心生
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-26T04:37:31.000Z" title="Wed Nov 26 2025 04:37:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第1章：Geaflow-Infer 模块简介</h2>
<h3 data-id="heading-1">章节导读</h3>
<p>本文将从宏观的角度出发，系统地介绍这个模块的<strong>定位</strong>、<strong>应用场景</strong>、<strong>核心功能</strong>和<strong>组织结构</strong>。通过本章的学习，你将对 geaflow-infer 模块有一个全面的认识，为后续深入学习各个细节模块打下坚实的基础。</p>
<h3 data-id="heading-2">架构设计图</h3>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph "用户层"
        A["InferContext&lt;br/&gt;统一调用入口"]
    end
    
    subgraph "环境管理层"
        B["InferEnvironmentManager&lt;br/&gt;环境初始化管理"]
        C["InferDependencyManager&lt;br/&gt;依赖文件管理"]
        D["InferEnvironmentContext&lt;br/&gt;环境上下文"]
    end
    
    subgraph "任务运行层"
        E["InferTaskRunImpl&lt;br/&gt;Python进程管理"]
        F["ProcessLoggerManager&lt;br/&gt;日志管理"]
        G["InferTaskStatus&lt;br/&gt;状态管理"]
    end
    
    subgraph "数据交换层"
        H["InferDataBridgeImpl&lt;br/&gt;数据桥接"]
        I["InferDataWriter&lt;br/&gt;数据写入"]
        J["InferDataReader&lt;br/&gt;数据读取"]
        K["DataExchangeQueue&lt;br/&gt;共享内存队列"]
    end
    
    subgraph "序列化层"
        L["Pickler&lt;br/&gt;序列化器"]
        M["Unpickler&lt;br/&gt;反序列化器"]
        N["IEncoder/IDecoder&lt;br/&gt;编解码接口"]
    end
    
    subgraph "Python进程"
        O["infer_server.py&lt;br/&gt;推理服务"]
        P["用户自定义&lt;br/&gt;Transform类"]
    end
    
    A --&gt; B
    A --&gt; H
    A --&gt; E
    B --&gt; C
    B --&gt; D
    E --&gt; F
    E --&gt; G
    E --&gt; O
    H --&gt; I
    H --&gt; J
    H --&gt; N
    I --&gt; K
    J --&gt; K
    N --&gt; L
    N --&gt; M
    K --&gt; O
    O --&gt; P
    
    style A fill:#e1f5ff
    style B fill:#fff4e1
    style E fill:#ffe1e1
    style H fill:#e1ffe1
    style L fill:#f0e1ff
    style O fill:#ffe1f0
</code></pre>
<h3 data-id="heading-3">核心功能时序图</h3>
<h4 data-id="heading-4">1. 环境初始化时序图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User as 用户代码
    participant IC as InferContext
    participant IEM as InferEnvironmentManager
    participant IDM as InferDependencyManager
    participant Shell as Shell脚本
    
    User-&gt;&gt;IC: new InferContext(config)
    IC-&gt;&gt;IEM: buildInferEnvironmentManager()
    IEM-&gt;&gt;IEM: createEnvironment()
    
    Note over IEM: 使用文件锁确保单次初始化
    
    IEM-&gt;&gt;IEM: 检查 _finish 或 _failed 文件
    
    alt 已初始化
        IEM--&gt;&gt;IC: 返回环境上下文
    else 需要初始化
        IEM-&gt;&gt;IDM: new InferDependencyManager()
        IDM-&gt;&gt;IDM: 复制运行时文件
        IDM-&gt;&gt;IDM: 准备 requirements.txt
        IDM--&gt;&gt;IEM: 返回脚本路径
        
        IEM-&gt;&gt;Shell: 执行 install-infer-env.sh
        Shell-&gt;&gt;Shell: 创建虚拟环境
        Shell-&gt;&gt;Shell: 安装依赖包
        Shell--&gt;&gt;IEM: 安装完成
        
        IEM-&gt;&gt;IEM: 创建 _finish 文件
        IEM--&gt;&gt;IC: 返回环境上下文
    end
    
    IC-&gt;&gt;IC: 初始化完成
</code></pre>
<h4 data-id="heading-5">2. 推理调用时序图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant User as 用户代码
    participant IC as InferContext
    participant ITR as InferTaskRunImpl
    participant IDB as InferDataBridgeImpl
    participant IDW as InferDataWriter
    participant SMQ as 共享内存队列
    participant IDR as InferDataReader
    participant Python as Python进程
    
    User-&gt;&gt;IC: infer(features...)
    
    IC-&gt;&gt;ITR: 启动Python进程
    ITR-&gt;&gt;Python: 启动 infer_server.py
    Python-&gt;&gt;Python: 加载用户Transform类
    Python-&gt;&gt;SMQ: 连接共享内存
    Python--&gt;&gt;ITR: 进程就绪
    
    IC-&gt;&gt;IDB: write(features)
    IDB-&gt;&gt;IDW: 序列化数据
    IDW-&gt;&gt;SMQ: 写入数据到发送队列
    
    Note over Python: Python进程读取数据
    Python-&gt;&gt;SMQ: 从接收队列读取
    Python-&gt;&gt;Python: 反序列化数据
    Python-&gt;&gt;Python: 执行推理
    Python-&gt;&gt;SMQ: 写入结果到发送队列
    
    IC-&gt;&gt;IDB: read()
    IDB-&gt;&gt;IDR: 从接收队列读取
    IDR-&gt;&gt;SMQ: 读取数据
    IDR--&gt;&gt;IDB: 返回字节数组
    IDB-&gt;&gt;IDB: 反序列化结果
    IDB--&gt;&gt;IC: 返回结果对象
    IC--&gt;&gt;User: 返回推理结果
</code></pre>
<h4 data-id="heading-6">3. 共享内存数据交换时序图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Java as Java进程
    participant Encoder as Pickler编码器
    participant Writer as InferDataWriter
    participant Queue as DataExchangeQueue
    participant Reader as InferDataReader
    participant Decoder as Unpickler解码器
    participant Python as Python进程
    
    Note over Java,Python: 数据写入流程
    
    Java-&gt;&gt;Encoder: encode(object)
    Encoder-&gt;&gt;Encoder: 序列化为Pickle格式
    Encoder--&gt;&gt;Java: byte[]
    
    Java-&gt;&gt;Writer: write(bytes)
    Writer-&gt;&gt;Writer: 添加4字节长度头
    Writer-&gt;&gt;Queue: 写入共享内存
    Queue-&gt;&gt;Queue: 更新写指针
    
    Note over Java,Python: 数据读取流程
    
    Python-&gt;&gt;Queue: 检查可读数据
    Queue--&gt;&gt;Python: 数据可用
    Python-&gt;&gt;Reader: read()
    Reader-&gt;&gt;Queue: 从共享内存读取
    Reader-&gt;&gt;Reader: 读取4字节长度头
    Reader-&gt;&gt;Queue: 读取数据体
    Queue-&gt;&gt;Queue: 更新读指针
    Reader--&gt;&gt;Python: byte[]
    
    Python-&gt;&gt;Decoder: decode(bytes)
    Decoder-&gt;&gt;Decoder: 反序列化Pickle数据
    Decoder--&gt;&gt;Python: Python对象
</code></pre>
<h4 data-id="heading-7">4. 进程生命周期管理时序图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant IC as InferContext
    participant ITR as InferTaskRunImpl
    participant PB as ProcessBuilder
    participant Python as Python进程
    participant PLM as ProcessLoggerManager
    
    IC-&gt;&gt;ITR: run(commands)
    ITR-&gt;&gt;PB: 构建进程
    
    Note over PB: 配置环境变量&lt;br/&gt;PATH, LD_LIBRARY_PATH, PYTHONPATH
    
    PB-&gt;&gt;Python: 启动进程
    Python--&gt;&gt;ITR: 进程对象
    
    ITR-&gt;&gt;PLM: startLogging()
    PLM-&gt;&gt;PLM: 启动输出监听线程
    PLM-&gt;&gt;PLM: 启动错误监听线程
    
    ITR-&gt;&gt;ITR: waitFor(timeout)
    
    alt 超时退出
        ITR-&gt;&gt;ITR: 标记状态为FAILED
        ITR-&gt;&gt;Python: destroyForcibly()
    else 正常运行
        ITR-&gt;&gt;ITR: 标记状态为RUNNING
    end
    
    Note over IC,Python: 推理执行中...
    
    IC-&gt;&gt;ITR: stop()
    ITR-&gt;&gt;Python: destroyForcibly()
    Python--&gt;&gt;ITR: 进程终止
    ITR-&gt;&gt;PLM: 停止日志收集
</code></pre>
<hr/>
<h3 data-id="heading-8">1.1 模块定位与应用场景</h3>
<h4 data-id="heading-9">总体定位</h4>
<p><strong>GeaFlow-Infer</strong> 是 Apache GeaFlow 分布式图计算引擎中专门用于 <strong>ML 推理加速</strong> 的模块。它解决的核心问题是：<strong>如何在高性能分布式图计算的过程中，高效地集成机器学习模型进行实时推理</strong>。</p>
<p>从架构的角度看，geaflow-infer 充当了 <strong>Java 图计算引擎</strong> 与 <strong>Python ML 生态</strong> 之间的"桥梁"，使得用户可以：</p>
<ol>
<li>在 GeaFlow 的分布式图计算框架中，使用 Python 的强大 ML 库（TensorFlow、PyTorch、Sklearn 等）</li>
<li>以最小的性能开销进行模型推理</li>
<li>实现图计算与 ML 推理的无缝融合</li>
</ol>
<h4 data-id="heading-10">应用场景</h4>
<h5 data-id="heading-11">场景 1：知识图谱中的实体链接（Entity Linking）</h5>
<pre><code class="hljs language-arduino" lang="arduino">用户查询: <span class="hljs-string">"苹果公司的CEO是谁？"</span>
             ↓
[图计算] 在知识图谱中查找<span class="hljs-string">"苹果"</span>相关实体
             ↓
[推理层] 使用 NLP 模型区分<span class="hljs-string">"苹果"</span>（公司）vs <span class="hljs-string">"苹果"</span>（水果）
             ↓
[返回结果] 准确的实体链接结果
</code></pre>
<p><strong>为什么需要 geaflow-infer？</strong></p>
<ul>
<li>知识图谱本身数据庞大（可能包含数十亿个实体），单纯的图遍历可能返回多个候选实体</li>
<li>需要使用深度学习模型来计算相似度，判断最佳匹配</li>
<li>geaflow-infer 可以在图计算的过程中，批量对候选实体进行 embedding 计算和相似度比对</li>
</ul>
<h5 data-id="heading-12">场景 2：社交网络中的推荐系统</h5>
<pre><code class="hljs language-less" lang="less">用户<span class="hljs-selector-tag">A</span>的图邻域:
    <span class="hljs-selector-tag">-</span> 粉丝列表（万级别）
    <span class="hljs-selector-tag">-</span> 兴趣标签关系（百万级别）
             ↓
<span class="hljs-selector-attr">[图计算]</span> 基于 <span class="hljs-selector-tag">PageRank</span> 算法计算影响力 
             ↓
<span class="hljs-selector-attr">[推理层]</span> 使用协同过滤 + 深度学习模型评分
             ↓
<span class="hljs-selector-attr">[返回结果]</span> <span class="hljs-selector-tag">Top-K</span> 个性化推荐列表
</code></pre>
<p><strong>为什么需要 geaflow-infer？</strong></p>
<ul>
<li>推荐需要通过复杂的图遍历（多跳关系）获取上下文信息</li>
<li>之后基于上下文用 ML 模型进行评分</li>
<li>高并发场景下，频繁调用 Python 推理服务成为性能瓶颈</li>
<li>geaflow-infer 提供进程级别的隔离和共享内存加速，避免频繁的网络调用</li>
</ul>
<h5 data-id="heading-13">场景 3：金融风险控制中的反欺诈</h5>
<pre><code class="hljs language-css" lang="css">交易事件：用户<span class="hljs-selector-tag">A</span>向用户<span class="hljs-selector-tag">B</span>转账 ¥<span class="hljs-number">100</span>,<span class="hljs-number">000</span>
             ↓
<span class="hljs-selector-attr">[图计算]</span> 追踪关联的转账链路、识别异常子图
             ↓
<span class="hljs-selector-attr">[推理层]</span> 使用 GNN 模型计算风险分数
             ↓
<span class="hljs-selector-attr">[决策层]</span> 风险判定：是否冻结账户
</code></pre>
<p><strong>为什么需要 geaflow-infer？</strong></p>
<ul>
<li>反欺诈需要实时处理（毫秒级延迟要求）</li>
<li>需要获取完整的关联关系图（多层次的交易网络）</li>
<li>Python GNN 模型提供更强的特征学习能力</li>
<li>geaflow-infer 通过共享内存和无锁队列，实现零拷贝数据交换，显著降低延迟</li>
</ul>
<h4 data-id="heading-14">核心价值主张</h4>






























<table><thead><tr><th>维度</th><th>传统方案</th><th>GeaFlow-Infer</th></tr></thead><tbody><tr><td><strong>性能</strong></td><td>Python RPC 调用：毫秒级延迟</td><td>共享内存 + 无锁队列：微秒级延迟</td></tr><tr><td><strong>吞吐</strong></td><td>单机单进程：有限</td><td>多进程隔离：充分利用多核</td></tr><tr><td><strong>易用</strong></td><td>需要维护 Web Service</td><td>内嵌在 GeaFlow 中，无需额外基础设施</td></tr><tr><td><strong>可靠</strong></td><td>网络超时、进程崩溃风险</td><td>本地进程管理、自动恢复机制</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-15">1.2 核心功能概述</h3>
<p>从功能的角度，geaflow-infer 主要包含以下几个核心模块：</p>
<h4 data-id="heading-16">总体功能架构</h4>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────────────────────────────┐
│                    用户应用层 (User App)                     │
│                     InferContext API                         │
└───────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│           环境管理层 (Environment Management)                 │
│  ┌──────────────────┐  ┌──────────────────────────────┐     │
│  │InferEnvironment  │  │InferDependencyManager        │     │
│  │Manager           │  │  • 依赖文件管理              │     │
│  │  • Singleton     │  │  • Shell脚本执行             │     │
│  │  • 虚拟环境初始化 │  │  • Conda环境配置             │     │
│  │  • 文件锁机制    │  └──────────────────────────────┘     │
│  └──────────────────┘                                         │
└───────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│         任务运行层 (Task Execution)                           │
│  ┌──────────────────┐  ┌──────────────────────────────┐     │
│  │InferTaskRunImpl   │  │ProcessLoggerManager          │     │
│  │  • 进程启动      │  │  • Stdout/Stderr 捕获        │     │
│  │  • 环境变量配置  │  │  • Slf4j 集成                │     │
│  │  • 超时控制      │  └──────────────────────────────┘     │
│  └──────────────────┘                                         │
└───────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│        数据交换层 (Data Exchange)                             │
│  ┌──────────────────────────────────────────────────────┐   │
│  │         InferDataBridgeImpl                           │   │
│  │  ┌────────────────┐  ┌────────────────┐             │   │
│  │  │ DataWriter     │  │ DataReader     │             │   │
│  │  │  • 编码        │  │  • 解码        │             │   │
│  │  │  • 写入内存    │  │  • 读取内存    │             │   │
│  │  └────────────────┘  └────────────────┘             │   │
│  │          ↓                    ↑                      │   │
│  │     ┌─────────────────────────┐                     │   │
│  │     │  DataExchangeQueue      │                     │   │
│  │     │   (共享内存队列)         │                     │   │
│  │     │  • 无锁算法              │                     │   │
│  │     │  • 内存映射              │                     │   │
│  │     │  • 指针管理              │                     │   │
│  │     └─────────────────────────┘                     │   │
│  └──────────────────────────────────────────────────────┘   │
└───────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│      序列化层 (Serialization)                                 │
│  ┌──────────────────┐  ┌──────────────────────────────┐     │
│  │Pickler           │  │Unpickler                     │     │
│  │  • Java→Pickle   │  │  • Pickle→Python             │     │
│  │  • OpCode生成    │  │  • 对象构造                  │     │
│  │  • 递归深度控制  │  │  • 类型映射                  │     │
│  └──────────────────┘  └──────────────────────────────┘     │
└───────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────┐
│      Python进程 (Python Process)                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  infer_server<span class="hljs-selector-class">.py</span>                                     │   │
│  │    • 监听共享内存队列                                │   │
│  │    • 反序列化输入数据                                │   │
│  │    • 执行用户定义的 <span class="hljs-attribute">Transform</span> 类                    │   │
│  │    • 序列化输出结果                                  │   │
│  └──────────────────────────────────────────────────────┘   │
└───────────────────────────────────────────────────────────────┘
</code></pre>
<h4 data-id="heading-17">功能概览</h4>
<h5 data-id="heading-18">1. 环境管理层（Environment Management）</h5>
<p><strong>目的</strong>：为 Python 推理进程创建独立、隔离的运行环境</p>
<p><strong>核心组件</strong>：</p>
<ul>
<li><code>InferEnvironmentManager</code>：单例模式，负责虚拟环境的初始化。使用文件锁机制确保多进程场景下的初始化只执行一次</li>
<li><code>InferDependencyManager</code>：负责从 JAR 包中提取运行时文件，执行 Shell 脚本创建 Conda 虚拟环境</li>
</ul>
<p><strong>关键特性</strong>：</p>
<ul>
<li>🔒 <strong>文件锁机制</strong>：防止多个 Java 进程同时初始化同一个虚拟环境</li>
<li>🔄 <strong>状态标记文件</strong>：通过 <code>_finish</code> 和 <code>_failed</code> 文件记录初始化状态</li>
<li>📦 <strong>依赖隔离</strong>：每个 GeaFlow 实例拥有独立的 Conda 虚拟环境，避免依赖冲突</li>
</ul>
<h5 data-id="heading-19">2. 任务运行层（Task Execution）</h5>
<p><strong>目的</strong>：启动、管理和监控 Python 推理进程的生命周期</p>
<p><strong>核心组件</strong>：</p>
<ul>
<li><code>InferTaskRunImpl</code>：通过 <code>ProcessBuilder</code> 启动 Python 子进程，配置必要的环境变量（PATH、LD_LIBRARY_PATH、PYTHONPATH）</li>
<li><code>ProcessLoggerManager</code>：监听进程的标准输出和错误输出，并通过 Slf4j 框架集成到 GeaFlow 的日志系统</li>
</ul>
<p><strong>关键特性</strong>：</p>
<ul>
<li>⏱️ <strong>超时控制</strong>：支持配置进程运行的最大时间，超时自动杀死进程</li>
<li>📝 <strong>日志捕获</strong>：完整捕获 Python 进程的输出，便于调试</li>
<li>🛡️ <strong>错误恢复</strong>：进程异常退出时，自动标记状态并提示用户</li>
</ul>
<h5 data-id="heading-20">3. 数据交换层（Data Exchange）</h5>
<p><strong>目的</strong>：在 Java 和 Python 进程之间高效地传输数据</p>
<p><strong>核心组件</strong>：</p>
<ul>
<li><code>DataExchangeQueue</code>：基于 mmap（内存映射）的共享内存队列，实现了无锁算法</li>
<li><code>InferDataWriter</code>：将 Java 对象序列化后写入共享内存</li>
<li><code>InferDataReader</code>：从共享内存读取字节流，交给解序列化器处理</li>
</ul>
<p><strong>关键特性</strong>：</p>
<ul>
<li><strong>零拷贝</strong>：利用内存映射，避免数据在进程间的复制</li>
<li><strong>无锁设计</strong>：使用 <code>sun.misc.Unsafe</code> 和内存屏障，实现高性能并发访问</li>
<li><strong>字节序处理</strong>：统一使用 Little Endian，避免字节序转换的开销</li>
</ul>
<h5 data-id="heading-21">4. 序列化层（Serialization）</h5>
<p><strong>目的</strong>：实现 Java 对象与 Python 对象之间的双向转换</p>
<p><strong>核心组件</strong>：</p>
<ul>
<li><code>Pickler</code>：Java 实现的 Pickle 序列化器，生成 Python Pickle 格式的字节流</li>
<li><code>Unpickler</code>：解析 Pickle 格式的字节流，构建 Java 对象</li>
</ul>
<p><strong>关键特性</strong>：</p>
<ul>
<li><strong>Pickle 协议</strong>：完整实现 Python Pickle Protocol v2，兼容 Python 3</li>
<li><strong>跨语言映射</strong>：处理 Java 的基本类型、集合类型、自定义类型到 Python 的映射</li>
<li><strong>自定义扩展</strong>：支持用户注册自定义的序列化器和反序列化器</li>
</ul>
<hr/>
<h3 data-id="heading-22">1.3 模块依赖关系分析</h3>
<h4 data-id="heading-23">直接依赖</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- geaflow-common 提供基础工具类 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.geaflow<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>geaflow-common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- guava 提供 Joiner、Preconditions 等工具 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.google.guava<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>guava<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- 阿里云 OSS 依赖（用于文件上传下载） --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.aliyun.oss<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>aliyun-sdk-oss<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- JCTools 提供高性能的并发数据结构 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.jctools<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jctools-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
    
    <span class="hljs-comment">&lt;!-- geaflow-file-common 提供文件操作工具 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.geaflow<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>geaflow-file-common<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h4 data-id="heading-24">依赖关系图</h4>
<pre><code class="hljs language-markdown" lang="markdown">┌─────────────────────────────────────────────┐
│      geaflow-infer 模块                      │
└──────────────┬──────────────────────────────┘
<span class="hljs-code">               │
       ┌───────┼───────┬───────────┬──────────┐
       ↓       ↓       ↓           ↓          ↓
    ┌────┐ ┌──────┐ ┌──────┐  ┌──────┐  ┌──────┐
    │com.│ │google│ │alibaba│ │jctools│ │geaflow│
    │aliyun│ │guava│ │oss    │ │       │ │file   │
    │oss  │ │     │ │       │ │       │ │common │
    └────┘ └──────┘ └──────┘  └──────┘  └──────┘
       │       │       │           │          │
       └───────┼───────┴───────────┴──────────┘
               │
       ┌───────↓────────────────┐
       │  geaflow-common         │
       │  (基础工具类库)          │
       └────────────────────────┘
</span></code></pre>
<h4 data-id="heading-25">核心依赖说明</h4>



































<table><thead><tr><th>依赖库</th><th>用途</th><th>关键类</th></tr></thead><tbody><tr><td><strong>geaflow-common</strong></td><td>异常、日志、配置管理</td><td><code>GeaflowRuntimeException</code>, <code>Configuration</code></td></tr><tr><td><strong>guava</strong></td><td>集合操作、字符串处理</td><td><code>Joiner</code>, <code>Lists</code>, <code>Preconditions</code></td></tr><tr><td><strong>jctools-core</strong></td><td>高性能无锁队列基础</td><td>作为参考实现</td></tr><tr><td><strong>geaflow-file-common</strong></td><td>文件操作工具</td><td>文件锁、文件复制、JAR 资源提取</td></tr><tr><td><strong>aliyun-sdk-oss</strong></td><td>云存储集成</td><td>支持大规模依赖文件的云存储</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-26">1.4 目录结构解析</h3>
<h4 data-id="heading-27">源码目录树</h4>
<pre><code class="hljs language-bash" lang="bash">geaflow/geaflow-infer/
├── src/main/java/org/apache/geaflow/infer/
│   ├── InferContext.java                    <span class="hljs-comment"># 门面类，用户主入口</span>
│   ├── InferEnvironmentManager.java         <span class="hljs-comment"># 环境管理器（单例）</span>
│   ├── InferDependencyManager.java          <span class="hljs-comment"># 依赖管理器</span>
│   ├── InferEnvironmentContext.java         <span class="hljs-comment"># 环境上下文</span>
│   ├── InferTaskRun.java                    <span class="hljs-comment"># 任务运行接口</span>
│   ├── InferTaskRunImpl.java                 <span class="hljs-comment"># 任务运行实现</span>
│   ├── InferTaskStatus.java                 <span class="hljs-comment"># 任务状态枚举</span>
│   │
│   ├── exchange/                            <span class="hljs-comment"># 数据交换模块</span>
│   │   ├── DataExchangeQueue.java           <span class="hljs-comment"># 共享内存队列</span>
│   │   ├── DataExchangeContext.java         <span class="hljs-comment"># 数据交换上下文</span>
│   │   ├── InferDataWriter.java             <span class="hljs-comment"># 数据写入器</span>
│   │   ├── InferDataReader.java             <span class="hljs-comment"># 数据读取器</span>
│   │   ├── DataQueueInputStream.java        <span class="hljs-comment"># 队列输入流</span>
│   │   ├── DataQueueOutputStream.java       <span class="hljs-comment"># 队列输出流</span>
│   │   ├── IDataBridge.java                 <span class="hljs-comment"># 数据桥接接口</span>
│   │   │
│   │   ├── impl/
│   │   │   └── InferDataBridgeImpl.java      <span class="hljs-comment"># 数据桥接实现</span>
│   │   │
│   │   └── serialize/                       <span class="hljs-comment"># 序列化模块</span>
│   │       ├── Pickler.java                 <span class="hljs-comment"># Pickle 序列化器</span>
│   │       ├── Unpickler.java               <span class="hljs-comment"># Pickle 反序列化器</span>
│   │       ├── UnpickleStack.java           <span class="hljs-comment"># 反序列化栈</span>
│   │       ├── Opcodes.java                 <span class="hljs-comment"># Pickle OpCode 定义</span>
│   │       ├── IObjectPickler.java          <span class="hljs-comment"># 对象序列化接口</span>
│   │       ├── IObjectConstructor.java      <span class="hljs-comment"># 对象构造接口</span>
│   │       ├── IEncoder.java                <span class="hljs-comment"># 编码器接口</span>
│   │       ├── IDecoder.java                <span class="hljs-comment"># 解码器接口</span>
│   │       │
│   │       ├── impl/
│   │       │   ├── DataExchangeEnCoderImpl.java      <span class="hljs-comment"># 编码实现</span>
│   │       │   ├── DataExchangeDeCoderImpl.java      <span class="hljs-comment"># 解码实现</span>
│   │       │   ├── ComplexNumberConstructor.java    <span class="hljs-comment"># 复数构造器</span>
│   │       │   ├── ArrayConstructor.java            <span class="hljs-comment"># 数组构造器</span>
│   │       │   └── ByteArrayConstructor.java        <span class="hljs-comment"># 字节数组构造器</span>
│   │       │
│   │       └── util/
│   │           ├── BinaryUtils.java         <span class="hljs-comment"># 二进制处理工具</span>
│   │           ├── PickleUtils.java         <span class="hljs-comment"># Pickle 工具类</span>
│   │           └── UnpickleUtils.java       <span class="hljs-comment"># 反Pickle 工具类</span>
│   │
│   ├── <span class="hljs-built_in">log</span>/                                 <span class="hljs-comment"># 日志模块</span>
│   │   ├── ProcessLoggerManager.java        <span class="hljs-comment"># 进程日志管理器</span>
│   │   └── Slf4JProcessOutputConsumer.java  <span class="hljs-comment"># Slf4j 日志消费者</span>
│   │
│   └── util/                                <span class="hljs-comment"># 工具模块</span>
│       ├── InferFileUtils.java              <span class="hljs-comment"># 文件操作工具</span>
│       └── PortableJvmInfo.java             <span class="hljs-comment"># JVM 信息工具</span>
│
└── src/test/java/org/apache/geaflow/infer/ <span class="hljs-comment"># 测试代码</span>
    ├── InferContextTest.java                <span class="hljs-comment"># 完整流程测试</span>
    ├── DataExchangeTest.java                <span class="hljs-comment"># 数据交换测试</span>
    └── SerializationTest.java               <span class="hljs-comment"># 序列化测试</span>
</code></pre>
<h4 data-id="heading-28">模块分层说明</h4>
<pre><code class="hljs language-javascript" lang="javascript">┌──────────────────────────────────────────────────┐
│          用户 <span class="hljs-variable constant_">API</span> 层                              │
│      <span class="hljs-title class_">InferContext</span>                  │
└──────────────────────────────────────────────────┘
         ▲                    ▲
         │                    │
         │ 控制流              │ 数据流
         │                    │
┌────────┴────────────────────┴──────────────────┐
│         环 境 / 任 务 管 理 层                    │
│  <span class="hljs-title class_">InferEnv</span>* <span class="hljs-regexp">/ InferTask* /</span> <span class="hljs-title class_">Log</span>  │
└─────────────┬──────────────────────────────────┘
              │
┌─────────────┴──────────────────────────────────┐
│         数 据 交 换 &amp; 序 列 化 层                 │
│  <span class="hljs-title class_">DataExchange</span>* / <span class="hljs-title class_">Pickle</span>*         │
└──────────────────────────────────────────────────┘
              ▼
         <span class="hljs-title class_">Python</span> 进程
        (infer_server.<span class="hljs-property">py</span>)
</code></pre>
<hr/>
<h3 data-id="heading-29">参考资源</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgeaflow.apache.org%2F" target="_blank" title="https://geaflow.apache.org/" ref="nofollow noopener noreferrer">GeaFlow 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.python.org%2F3%2Flibrary%2Fpickle.html" target="_blank" title="https://docs.python.org/3/library/pickle.html" ref="nofollow noopener noreferrer">Python Pickle 协议</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cnblogs.com%2Fparkour%2Fp%2F8333803.html" target="_blank" title="https://www.cnblogs.com/parkour/p/8333803.html" ref="nofollow noopener noreferrer">Java Unsafe 用法</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fman7.org%2Flinux%2Fman-pages%2Fman2%2Fmmap.2.html" target="_blank" title="https://man7.org/linux/man-pages/man2/mmap.2.html" ref="nofollow noopener noreferrer">Linux 共享内存与 mmap</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[像CAD制图一样，使用Java绘图标注图片的瑕疵]]></title>    <link>https://juejin.cn/post/7576165316250681353</link>    <guid>https://juejin.cn/post/7576165316250681353</guid>    <pubDate>2025-11-25T01:20:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7576165316250681353" data-draft-id="7576158801972592686" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="像CAD制图一样，使用Java绘图标注图片的瑕疵"/> <meta itemprop="keywords" content="后端,Java,程序员"/> <meta itemprop="datePublished" content="2025-11-25T01:20:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SimonKing"/> <meta itemprop="url" content="https://juejin.cn/user/4001878056904584"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            像CAD制图一样，使用Java绘图标注图片的瑕疵
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4001878056904584/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SimonKing
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-25T01:20:33.000Z" title="Tue Nov 25 2025 01:20:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-25
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>关注我的公众号：【编程朝花夕拾】，可获取首发内容。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a2fe0fdf5e148b1a6b967756ac52350~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764638432&amp;x-signature=1PnMmfXpJkxeyErFB9EszDfBe%2F8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">01 引言</h2>
<p>老程序员已经做过使用<code>Java</code>自己编写图片验证码的项目，然而随着技术的发展，三方库的增强。滑动验证码、旋转验证码等更加方便的验证码出现，逐渐取代了传统的验证码。尤其当前12306图片验证码为了防止黄牛刷票，热搜一个接一个......</p>
<p>当然也不乏有很多成熟的传统验证码工具，已经很少自己去写验证码了，重复造轮子完全没有必要。验证码可能不需要了写了，但是这项画图的技术依然有他的用武之地。</p>
<p>我们一起来看看今天的需求！</p>
<h2 data-id="heading-1">02 契机</h2>
<p>这几天一直忙着紧急项目，都没有时间更文。这段时间就是研究了画图这个玩意，主要用来标记图片上的瑕疵点。瑕疵点过多，标注的内容还不能重叠，真实让人想破了头。我们先看看标注的结果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65ad7a5da7524fd2aab8ca59b5e90c6e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764638432&amp;x-signature=eS2uUWf3H4beXX8xgPhMiDePWkk%3D" alt="" loading="lazy"/></p>
<p>怎么来画出这样的标注图呢？我们一步步拆解。</p>
<h2 data-id="heading-2">03 步骤拆解</h2>
<p>我们需要用到的<code>API</code>类：</p>
<ul>
<li><code>BufferedImage</code></li>
<li><code>Graphics2D</code></li>
<li><code>Font</code></li>
<li><code>FontMetrics</code></li>
</ul>
<p>其实说白了就是数学问题，三角函数问题。</p>
<h3 data-id="heading-3">3.1 瑕疵点花圆</h3>
<p>主要用来标注目标点的位置，以坐标点为圆心，画一个适合半径的圆。我的图片尺寸是1600*1200，我取的半径是15。</p>
<p>伪代码：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">BufferedImage</span> <span class="hljs-variable">image</span> <span class="hljs-operator">=</span> ImageIO.read();
<span class="hljs-type">Graphics2D</span> <span class="hljs-variable">g2d</span> <span class="hljs-operator">=</span> image.createGraphics();

<span class="hljs-comment">// 设置画笔颜色</span>
g2d.setColor(Color.ORANGE);
<span class="hljs-comment">// 以目标点（x,y）为圆心画一个指定半径的圆饼填充</span>
g2d.fillOval(x - radius, y - radius, radius * <span class="hljs-number">2</span>, radius * <span class="hljs-number">2</span>);
</code></pre>
<p><code>fillOval()</code>用来填充图形。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5f4ceb28e34f485a8de0bd0b24e6ca42~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764638432&amp;x-signature=UkAsQsrIxtx%2B3wQYr5YCikLxHi8%3D" alt="" loading="lazy"/></p>
<p>参数为左上角的坐标，所以这里都要减去半径才是画笔落笔的地方。宽度和高度分别指直径。</p>
<h3 data-id="heading-4">3.2 箭头辅线</h3>
<p>剑斗分为两种：带辅助线和不带辅助线。我们以带辅助线的为例。</p>
<p>带辅助线的箭头如图上的瑕疵点02。箭头其实也是线，我们需要确定箭头的角度大小，而箭头的方向取决于辅助线的方向。为了计算的方便，我们设定为的辅助线的角度为45°，这样对应的X轴和Y轴的值都相等。</p>
<p>画辅助线，我们需要知道两个坐标即可。标记点坐标（x,y）,向右上方45°延伸，位于第一象限。假如延伸的距离为<code>x0</code>,那么辅助线终点的位置（x+x0, y-x0）。Y轴为什么要减，是因为画布的坐标（0,0）位于左上角，Y轴朝下为正。</p>
<p><strong>绘制辅助线</strong>：</p>
<pre><code class="hljs language-java" lang="java">g2d.draw(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.awt.geom.Line2D.Double(x, y, x+x0, y-x0));
</code></pre>
<p><strong>计算箭头的坐标</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">double</span> <span class="hljs-variable">angle</span> <span class="hljs-operator">=</span> Math.atan2(y1 - y2, x1 - x2);
<span class="hljs-type">double</span> <span class="hljs-variable">x3</span> <span class="hljs-operator">=</span> x1 - arrowSize * Math.cos(angle - Math.PI / <span class="hljs-number">12</span>);
<span class="hljs-type">double</span> <span class="hljs-variable">y3</span> <span class="hljs-operator">=</span> y1 - arrowSize * Math.sin(angle - Math.PI / <span class="hljs-number">12</span>);
<span class="hljs-type">double</span> <span class="hljs-variable">x4</span> <span class="hljs-operator">=</span> x1 - arrowSize * Math.cos(angle + Math.PI / <span class="hljs-number">12</span>);
<span class="hljs-type">double</span> <span class="hljs-variable">y4</span> <span class="hljs-operator">=</span> y1 - arrowSize * Math.sin(angle + Math.PI / <span class="hljs-number">12</span>);
</code></pre>
<p>这里是利用三角函数计算箭头的相对坐标。<code>arrowSize</code>箭头大小，而<code>Math.PI / 12</code>表示15°，因为<code>Math.PI</code>等于180°，表示箭头与辅助线的夹角。</p>
<p><strong>绘制箭头</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 绘制箭头</span>
g2d.draw(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.awt.geom.Line2D.Double(x1, y1, x3, y3));
g2d.draw(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.awt.geom.Line2D.Double(x1, y1, x4, y4));
</code></pre>
<p><strong>填充箭头</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 箭头三个点的坐标</span>
<span class="hljs-type">Polygon</span> <span class="hljs-variable">arrowHead</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Polygon</span>();
arrowHead.addPoint((<span class="hljs-type">int</span>) x1, (<span class="hljs-type">int</span>) y1);
arrowHead.addPoint((<span class="hljs-type">int</span>) x3, (<span class="hljs-type">int</span>) y3);
arrowHead.addPoint((<span class="hljs-type">int</span>) x4, (<span class="hljs-type">int</span>) y4);
<span class="hljs-comment">// 划线填充</span>
g2d.fill(arrowHead);
</code></pre>
<h3 data-id="heading-5">3.3 底色</h3>
<p>绘制内容的底色，防止图片颜色造成干扰。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 标注的内容增加底色</span>
g2d.setColor(Color.GRAY);
g2d.fillRect((<span class="hljs-type">int</span>)dx, (<span class="hljs-type">int</span>)dy, Math.abs(contentWidth), fontHeight);
</code></pre>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/865ffd61e9ef403784593aae36d805a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2ltb25LaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1764638432&amp;x-signature=Wm6Wp5V6KOnnYVQYwvRgfBNqfcY%3D" alt="" loading="lazy"/></p>
<p>我们填充矩形，（dx, dy）依然是左上角的位置。</p>
<h3 data-id="heading-6">3.4 标注内容</h3>
<p>标注内容我们也需要画上底线，我们以辅助线的末端作为起点（x2,y2）,<code>contentWidth</code>为内容的宽度。</p>
<pre><code class="hljs language-java" lang="java">g2d.draw(<span class="hljs-keyword">new</span> <span class="hljs-title class_">java</span>.awt.geom.Line2D.Double(x2, y2, x2 + contentWidth, y2));

g2d.setColor(Color.WHITE);
g2d.setFont(font);
g2d.drawString(content, ltx, lty);
</code></pre>
<p>（ltx，lty）同样为左上角的位置。</p>
<h2 data-id="heading-7">04 完整代码</h2>
<p>这里的代码是我封装的一个小工具。里面简单的画图可以实现了，但是还缺少碰撞检测以及优化避让。先分享给大家。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FastDraw</span> {

    <span class="hljs-comment">/** 图片源 */</span>
    <span class="hljs-keyword">private</span> BufferedImage image;
    <span class="hljs-keyword">private</span> Font font;

    <span class="hljs-comment">/** 画布 */</span>
    <span class="hljs-keyword">private</span> Graphics2D g2d;
    <span class="hljs-comment">/** 画布/边界宽高 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> imageWidth;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> imageHeight;

    <span class="hljs-comment">/** 字体信息和高度 */</span>
    <span class="hljs-keyword">private</span> FontMetrics fontMetrics;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> fontHeight;

    <span class="hljs-comment">/** 标记点半径 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">radius</span> <span class="hljs-operator">=</span> <span class="hljs-number">15</span>;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">FastDraw</span><span class="hljs-params">(BufferedImage image, Font font)</span> {
        Assert.notNull(image, <span class="hljs-string">"image is null"</span>);
        Assert.notNull(font, <span class="hljs-string">"font is null"</span>);

        <span class="hljs-built_in">this</span>.image = image;
        <span class="hljs-built_in">this</span>.font = font;

        <span class="hljs-built_in">this</span>.imageWidth = image.getWidth();
        <span class="hljs-built_in">this</span>.imageHeight = image.getHeight();

        <span class="hljs-built_in">this</span>.g2d = image.createGraphics();
        <span class="hljs-built_in">this</span>.fontMetrics = g2d.getFontMetrics(font);
        <span class="hljs-built_in">this</span>.fontHeight = fontMetrics.getHeight();
    }

    <span class="hljs-comment">/**
     * 绘制标注内容：Callout Content
     *
     * x1, y1 ： 起点坐标
     * x0 ： 辅助斜线X轴长度
     * content ： 标注内容
     * arrowSize ： 箭头大小
     * quadrant ： 象限（默认第一象限：逆时针）
     *
     * 返回值： 辅助线末端坐标
     **/</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">drawArrow</span><span class="hljs-params">(<span class="hljs-type">double</span> x, <span class="hljs-type">double</span> y, <span class="hljs-type">double</span> x0, <span class="hljs-type">double</span> arrowSize, String content, <span class="hljs-type">int</span> quadrant)</span> {
        <span class="hljs-type">double</span> <span class="hljs-variable">x1</span> <span class="hljs-operator">=</span> initBoundaryX(x);
        <span class="hljs-type">double</span> <span class="hljs-variable">y1</span> <span class="hljs-operator">=</span> initBoundaryY(y);

        <span class="hljs-comment">// 绘制箭头的圆点</span>
        g2d.setColor(Color.ORANGE);
        <span class="hljs-comment">// 以损伤点为中心画一个radius为半径的圆</span>
        g2d.fillOval((<span class="hljs-type">int</span>) x1 - radius, (<span class="hljs-type">int</span>) y1 - radius, radius * <span class="hljs-number">2</span>, radius * <span class="hljs-number">2</span>);

        <span class="hljs-comment">// 绘制箭头使用白色</span>
        g2d.setColor(Color.WHITE);
        <span class="hljs-type">int</span> <span class="hljs-variable">contentWidth</span> <span class="hljs-operator">=</span> getWordWidth(content);
        <span class="hljs-comment">// 绘制箭头直线</span>
        <span class="hljs-type">double</span> <span class="hljs-variable">x2</span> <span class="hljs-operator">=</span> <span class="hljs-number">0.0</span>, y2 = <span class="hljs-number">0.0</span>;
        <span class="hljs-comment">// 绘制标注</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">ltx</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">switch</span> (quadrant) {
            <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:
                x2 = x1 + x0;
                y2 = y1 - x0;
                ltx = (<span class="hljs-type">int</span>)x2;
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:
                x2 = x1 - x0;
                y2 = y1 - x0;
                contentWidth = -contentWidth;
                ltx = (<span class="hljs-type">int</span>)x2 + contentWidth;
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-number">3</span>:
                x2 = x1 - x0;
                y2 = y1 + x0;
                contentWidth = -contentWidth;
                ltx = (<span class="hljs-type">int</span>)x2 + contentWidth;
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-number">4</span>:
                x2 = x1 + x0;
                y2 = y1 + x0;
                ltx = (<span class="hljs-type">int</span>)x2;
        }
        <span class="hljs-comment">// 左上y:内容向上字体高度的1/4</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">lty</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) y2 - fontHeight/<span class="hljs-number">4</span>;
        <span class="hljs-comment">// 底色起点坐标</span>
        <span class="hljs-type">double</span> <span class="hljs-variable">dx</span> <span class="hljs-operator">=</span> ltx;
        <span class="hljs-type">double</span> <span class="hljs-variable">dy</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) y2 - fontHeight;

        <span class="hljs-comment">// 绘制直线</span>
        g2d.draw(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Double</span>(x1, y1, x2, y2));
        <span class="hljs-comment">// 计算箭头角度</span>
        <span class="hljs-type">double</span> <span class="hljs-variable">angle</span> <span class="hljs-operator">=</span> Math.atan2(y1 - y2, x1 - x2);
        <span class="hljs-type">double</span> <span class="hljs-variable">x3</span> <span class="hljs-operator">=</span> x1 - arrowSize * Math.cos(angle - Math.PI / <span class="hljs-number">12</span>);
        <span class="hljs-type">double</span> <span class="hljs-variable">y3</span> <span class="hljs-operator">=</span> y1 - arrowSize * Math.sin(angle - Math.PI / <span class="hljs-number">12</span>);
        <span class="hljs-type">double</span> <span class="hljs-variable">x4</span> <span class="hljs-operator">=</span> x1 - arrowSize * Math.cos(angle + Math.PI / <span class="hljs-number">12</span>);
        <span class="hljs-type">double</span> <span class="hljs-variable">y4</span> <span class="hljs-operator">=</span> y1 - arrowSize * Math.sin(angle + Math.PI / <span class="hljs-number">12</span>);

        <span class="hljs-comment">// 绘制箭头</span>
        g2d.draw(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Double</span>(x1, y1, x3, y3));
        g2d.draw(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Double</span>(x1, y1, x4, y4));

        <span class="hljs-comment">// 创建箭头多边形并填充</span>
        <span class="hljs-type">Polygon</span> <span class="hljs-variable">arrowHead</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Polygon</span>();
        arrowHead.addPoint((<span class="hljs-type">int</span>) x1, (<span class="hljs-type">int</span>) y1);
        arrowHead.addPoint((<span class="hljs-type">int</span>) x3, (<span class="hljs-type">int</span>) y3);
        arrowHead.addPoint((<span class="hljs-type">int</span>) x4, (<span class="hljs-type">int</span>) y4);
        g2d.fill(arrowHead);
        g2d.draw(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Double</span>(x2, y2, x2 + contentWidth, y2));

        <span class="hljs-comment">// 标注的内容增加底色</span>
        g2d.setColor(Color.GRAY);
        g2d.fillRect((<span class="hljs-type">int</span>)dx, (<span class="hljs-type">int</span>)dy, Math.abs(contentWidth), fontHeight);

        <span class="hljs-comment">// 绘制标注</span>
        g2d.setColor(Color.WHITE);
        g2d.setFont(font);
        g2d.drawString(content, ltx, lty);
    }

    <span class="hljs-comment">/***
     * 绘制平铺内容
     *
     **/</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">drawTile</span><span class="hljs-params">(<span class="hljs-type">double</span> x1, <span class="hljs-type">double</span> y1, String content)</span> {
        x1 = initBoundaryX(x1);
        y1 = initBoundaryY(y1);

        <span class="hljs-comment">// 绘制箭头的圆点</span>
        g2d.setColor(Color.ORANGE);
        <span class="hljs-comment">// 以损伤点为中心画一个radius为半径的圆</span>
        g2d.fillOval((<span class="hljs-type">int</span>) x1 - radius, (<span class="hljs-type">int</span>) y1 - radius, radius * <span class="hljs-number">2</span>, radius * <span class="hljs-number">2</span>);

        <span class="hljs-comment">// 底色坐标</span>
        <span class="hljs-type">int</span>[] x, y;
        <span class="hljs-type">int</span> <span class="hljs-variable">contentWidth</span> <span class="hljs-operator">=</span> getWordWidth(content);
        <span class="hljs-keyword">if</span> (x1 + contentWidth &lt;= imageWidth) {
            <span class="hljs-comment">// 未超出边界，箭头方向朝左←</span>
            <span class="hljs-comment">// 左上</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">lux</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>)x1 + fontHeight;
            <span class="hljs-type">int</span> <span class="hljs-variable">luy</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>)y1 - fontHeight / <span class="hljs-number">2</span>;
            <span class="hljs-comment">// 左下</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">ldx</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>)x1 + fontHeight;
            <span class="hljs-type">int</span> <span class="hljs-variable">ldy</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>)y1 + fontHeight / <span class="hljs-number">2</span>;
            <span class="hljs-comment">// 右上</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">rux</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>)x1 + fontHeight + contentWidth;
            <span class="hljs-type">int</span> <span class="hljs-variable">ruy</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>)y1 - fontHeight / <span class="hljs-number">2</span>;
            <span class="hljs-comment">// 右下</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">rdx</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>)x1 + fontHeight + contentWidth;
            <span class="hljs-type">int</span> <span class="hljs-variable">rdy</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>)y1 + fontHeight / <span class="hljs-number">2</span>;

            x = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]{(<span class="hljs-type">int</span>) x1, lux, rux, rdx, ldx};
            y = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]{(<span class="hljs-type">int</span>) y1, luy, ruy, rdy, ldy};
        }<span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 超出边界箭头朝右→</span>
            <span class="hljs-comment">// 左上</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">lux</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>)x1 - fontHeight- contentWidth;
            <span class="hljs-type">int</span> <span class="hljs-variable">luy</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>)y1 - fontHeight / <span class="hljs-number">2</span>;

            <span class="hljs-comment">// 左上</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">ldx</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>)x1 - fontHeight - contentWidth;
            <span class="hljs-type">int</span> <span class="hljs-variable">ldy</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>)y1 + fontHeight / <span class="hljs-number">2</span>;

            <span class="hljs-comment">// 左上</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">rux</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>)x1 - fontHeight;
            <span class="hljs-type">int</span> <span class="hljs-variable">ruy</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>)y1 - fontHeight / <span class="hljs-number">2</span>;

            <span class="hljs-comment">// 左上</span>
            <span class="hljs-type">int</span> <span class="hljs-variable">rdx</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>)x1 - fontHeight;
            <span class="hljs-type">int</span> <span class="hljs-variable">rdy</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>)y1 + fontHeight / <span class="hljs-number">2</span>;
            x = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]{lux, rux, (<span class="hljs-type">int</span>) x1, rdx, ldx};
            y = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[]{luy, ruy, (<span class="hljs-type">int</span>) y1, rdy, ldy};
        }
        g2d.setColor(Color.GRAY);
        g2d.fillPolygon(x, y, <span class="hljs-number">5</span>);

        <span class="hljs-comment">// 绘制内容</span>
        g2d.setColor(Color.WHITE);
        g2d.setFont(font);
        g2d.drawString(content, x[<span class="hljs-number">4</span>], y[<span class="hljs-number">4</span>] - fontHeight/<span class="hljs-number">4</span>);
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@Description</span>: 边界检查X
     *
     * <span class="hljs-doctag">@Author</span>: ws
     * <span class="hljs-doctag">@Date</span>: 2025/11/19 11:20
     **/</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> <span class="hljs-title function_">initBoundaryX</span><span class="hljs-params">(<span class="hljs-type">double</span> x)</span> {
        <span class="hljs-keyword">if</span> (x &lt;= <span class="hljs-number">0</span>) {
            x = radius;
        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (x &gt;= imageWidth) {
            x = imageWidth -  radius;
        }
        <span class="hljs-keyword">return</span> x;
    }

    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@Description</span>: 边界检查Y
     *
     * <span class="hljs-doctag">@Author</span>: ws
     * <span class="hljs-doctag">@Date</span>: 2025/11/19 11:20
     **/</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">double</span> <span class="hljs-title function_">initBoundaryY</span><span class="hljs-params">(<span class="hljs-type">double</span> y)</span> {
        <span class="hljs-keyword">if</span> (y &lt;= <span class="hljs-number">0</span>) {
            y = radius;
        }<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (y &gt;= imageHeight) {
            y = imageHeight - radius;
        }
        <span class="hljs-keyword">return</span> y;
    }


    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@Description</span>: 获取文字高度
     *
     * <span class="hljs-doctag">@Author</span>: ws
     * <span class="hljs-doctag">@Date</span>: 2025/11/19 11:20
     **/</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getWordWidth</span><span class="hljs-params">(String content)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">width</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; content.length(); i++) {
            width += fontMetrics.charWidth(content.charAt(i));
        }
        <span class="hljs-keyword">return</span> width;
    }
}
</code></pre>
<p>大家有兴趣可以完善一下碰撞检查。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>