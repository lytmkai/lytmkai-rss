<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[跨域难题终结者：Vue项目中优雅解决跨域问题的完整指南]]></title>    <link>https://juejin.cn/post/7577691061033795630</link>    <guid>https://juejin.cn/post/7577691061033795630</guid>    <pubDate>2025-11-30T02:37:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577691061033795630" data-draft-id="7577691061033762862" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="跨域难题终结者：Vue项目中优雅解决跨域问题的完整指南"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-30T02:37:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="北辰alk"/> <meta itemprop="url" content="https://juejin.cn/user/1772855673241352"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            跨域难题终结者：Vue项目中优雅解决跨域问题的完整指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1772855673241352/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    北辰alk
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T02:37:49.000Z" title="Sun Nov 30 2025 02:37:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">跨域难题终结者：Vue项目中优雅解决跨域问题的完整指南</h2>
<blockquote>
<p>作为前端开发者，跨域问题就像一道绕不过去的坎。今天，就让我们彻底攻克这个难题！</p>
</blockquote>
<h3 data-id="heading-1">什么是跨域？为什么会出现跨域问题？</h3>
<h4 data-id="heading-2">同源策略：安全的守护者</h4>
<p>在深入解决方案之前，我们首先要明白<strong>同源策略</strong>这个概念。浏览器出于安全考虑，实施了同源策略，它限制了不同源之间的资源交互。</p>
<p><strong>什么是"同源"？</strong><br/>
简单来说，当两个URL的<strong>协议、域名、端口</strong>完全相同时，我们称它们为同源。</p>
<p>举个例子：</p>



































<table><thead><tr><th>当前页面URL</th><th>请求URL</th><th>是否同源</th><th>原因</th></tr></thead><tbody><tr><td><code>https://www.example.com/index.html</code></td><td><code>https://www.example.com/api/user</code></td><td>✅ 是</td><td>协议、域名、端口完全相同</td></tr><tr><td><code>https://www.example.com/index.html</code></td><td><code>http://www.example.com/api/user</code></td><td>❌ 否</td><td>协议不同(https vs http)</td></tr><tr><td><code>https://www.example.com/index.html</code></td><td><code>https://api.example.com/user</code></td><td>❌ 否</td><td>域名不同(www vs api)</td></tr><tr><td><code>https://www.example.com:8080/index.html</code></td><td><code>https://www.example.com:3000/api/user</code></td><td>❌ 否</td><td>端口不同(8080 vs 3000)</td></tr></tbody></table>
<h4 data-id="heading-3">跨域的限制范围</h4>
<p>当发生跨域时，以下行为会受到限制：</p>
<ul>
<li>• <strong>AJAX请求</strong>被阻止（核心问题）</li>
<li>• <strong>LocalStorage</strong>、<strong>IndexedDB</strong>等存储无法访问</li>
<li>• <strong>DOM</strong>无法通过JavaScript操作</li>
<li>• <strong>Cookie</strong>读写受限</li>
</ul>
<p>但有些资源是允许跨域加载的：</p>
<ul>
<li>• 图片<code>&lt;img&gt;</code></li>
<li>• 样式表<code>&lt;link&gt;</code></li>
<li>• 脚本<code>&lt;script&gt;</code></li>
<li>• 嵌入框架<code>&lt;iframe&gt;</code>（但内容访问受限）</li>
</ul>
<h3 data-id="heading-4">Vue项目中的跨域解决方案</h3>
<p>在实际的Vue项目中，我们主要有以下几种解决方案：</p>
<h4 data-id="heading-5">方案一：开发环境下的代理配置（最常用）</h4>
<p>这是开发阶段最常用的解决方案，通过Vue CLI或Vite的代理功能实现。</p>
<h5 data-id="heading-6">Vue CLI项目配置</h5>
<p><strong>1. 创建vue.config.js文件</strong></p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// vue.config.js</span>
<span class="hljs-keyword">const</span> { defineConfig } = <span class="hljs-keyword">require</span>(<span class="hljs-string">'@vue/cli-service'</span>)

module.exports = <span class="hljs-title function_ invoke__">defineConfig</span>({
<span class="hljs-attr">  transpileDependencies</span>: <span class="hljs-literal">true</span>,
<span class="hljs-attr">  devServer</span>: {
<span class="hljs-attr">    port</span>: <span class="hljs-number">8080</span>,
<span class="hljs-attr">    proxy</span>: {
      // 简单配置：匹配以/api开头的请求
      <span class="hljs-string">'/api'</span>: {
<span class="hljs-attr">        target</span>: <span class="hljs-string">'http://localhost:3000'</span>, // 后端服务器地址
<span class="hljs-attr">        changeOrigin</span>: <span class="hljs-literal">true</span>, // 改变请求源
<span class="hljs-attr">        pathRewrite</span>: {
          <span class="hljs-string">'^/api'</span>: <span class="hljs-string">''</span> // 重写路径，去掉/api前缀
        }
      }
    }
  }
})
</code></pre>
<p><strong>2. 复杂场景的多代理配置</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// vue.config.js</span>
<span class="hljs-keyword">module</span>.<span class="hljs-keyword">exports</span> = {
  devServer: {
    proxy: {
      <span class="hljs-comment">// 用户服务代理</span>
      <span class="hljs-string">'/user-api'</span>: {
        target: <span class="hljs-string">'http://user-service:3001'</span>,
        changeOrigin: <span class="hljs-literal">true</span>,
        pathRewrite: {
          <span class="hljs-string">'^/user-api'</span>: <span class="hljs-string">'/api'</span>
        },
        logLevel: <span class="hljs-string">'debug'</span> <span class="hljs-comment">// 开启调试日志</span>
      },
      <span class="hljs-comment">// 商品服务代理</span>
      <span class="hljs-string">'/product-api'</span>: {
        target: <span class="hljs-string">'http://product-service:3002'</span>,
        changeOrigin: <span class="hljs-literal">true</span>,
        pathRewrite: {
          <span class="hljs-string">'^/product-api'</span>: <span class="hljs-string">'/api'</span>
        }
      },
      <span class="hljs-comment">// WebSocket代理</span>
      <span class="hljs-string">'/ws-api'</span>: {
        target: <span class="hljs-string">'ws://websocket-service:3003'</span>,
        changeOrigin: <span class="hljs-literal">true</span>,
        ws: <span class="hljs-literal">true</span>
      }
    }
  }
}
</code></pre>
<p><strong>3. 在Vue组件中使用</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/services/api.js</span>
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">'axios'</span>

<span class="hljs-comment">// 创建axios实例</span>
<span class="hljs-keyword">const</span> api = axios.<span class="hljs-title function_">create</span>({
  <span class="hljs-attr">baseURL</span>: <span class="hljs-string">'/api'</span>, <span class="hljs-comment">// 使用代理的前缀</span>
  <span class="hljs-attr">timeout</span>: <span class="hljs-number">10000</span>
})

<span class="hljs-comment">// 请求拦截器</span>
api.<span class="hljs-property">interceptors</span>.<span class="hljs-property">request</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function"><span class="hljs-params">config</span> =&gt;</span> {
    <span class="hljs-comment">// 在发送请求之前做些什么</span>
    <span class="hljs-keyword">const</span> token = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'token'</span>)
    <span class="hljs-keyword">if</span> (token) {
      config.<span class="hljs-property">headers</span>.<span class="hljs-property">Authorization</span> = <span class="hljs-string">`Bearer <span class="hljs-subst">${token}</span>`</span>
    }
    <span class="hljs-keyword">return</span> config
  },
  <span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error)
  }
)

<span class="hljs-comment">// 响应拦截器</span>
api.<span class="hljs-property">interceptors</span>.<span class="hljs-property">response</span>.<span class="hljs-title function_">use</span>(
  <span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
    <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>
  },
  <span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {
    <span class="hljs-comment">// 处理响应错误</span>
    <span class="hljs-keyword">if</span> (error.<span class="hljs-property">response</span>?.<span class="hljs-property">status</span> === <span class="hljs-number">401</span>) {
      <span class="hljs-comment">// 未授权，跳转到登录页</span>
      <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">'/login'</span>
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error)
  }
)

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> api

<span class="hljs-comment">// 在Vue组件中使用</span>
<span class="hljs-comment">// src/components/UserList.vue</span>
&lt;script&gt;
<span class="hljs-keyword">import</span> api <span class="hljs-keyword">from</span> <span class="hljs-string">'@/services/api'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'UserList'</span>,
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">users</span>: [],
      <span class="hljs-attr">loading</span>: <span class="hljs-literal">false</span>
    }
  },
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">created</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fetchUsers</span>()
  },
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">fetchUsers</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 实际请求会发送到代理服务器，然后转发到目标服务器</span>
        <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">get</span>(<span class="hljs-string">'/users'</span>)
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">users</span> = response.<span class="hljs-property">data</span>
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取用户列表失败:'</span>, error)
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'获取用户列表失败'</span>)
      } <span class="hljs-keyword">finally</span> {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">loading</span> = <span class="hljs-literal">false</span>
      }
    },
    
    <span class="hljs-keyword">async</span> <span class="hljs-title function_">createUser</span>(<span class="hljs-params">userData</span>) {
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">await</span> api.<span class="hljs-title function_">post</span>(<span class="hljs-string">'/users'</span>, userData)
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>.<span class="hljs-title function_">success</span>(<span class="hljs-string">'用户创建成功'</span>)
        <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">fetchUsers</span>() <span class="hljs-comment">// 刷新列表</span>
      } <span class="hljs-keyword">catch</span> (error) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'创建用户失败:'</span>, error)
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">$message</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'创建用户失败'</span>)
      }
    }
  }
}
&lt;/script&gt;
</code></pre>
<h5 data-id="heading-7">Vite项目配置</h5>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// vite.config.js</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'vite'</span>
<span class="hljs-keyword">import</span> vue <span class="hljs-keyword">from</span> <span class="hljs-string">'@vitejs/plugin-vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">plugins</span>: [<span class="hljs-title function_">vue</span>()],
  <span class="hljs-attr">server</span>: {
    <span class="hljs-attr">port</span>: <span class="hljs-number">5173</span>,
    <span class="hljs-attr">proxy</span>: {
      <span class="hljs-string">'/api'</span>: {
        <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:3000'</span>,
        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-attr">rewrite</span>: <span class="hljs-function">(<span class="hljs-params">path</span>) =&gt;</span> path.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^/</span>api/, <span class="hljs-string">''</span>),
        <span class="hljs-attr">configure</span>: <span class="hljs-function">(<span class="hljs-params">proxy, options</span>) =&gt;</span> {
          <span class="hljs-comment">// 代理配置回调</span>
          proxy.<span class="hljs-title function_">on</span>(<span class="hljs-string">'error'</span>, <span class="hljs-function">(<span class="hljs-params">err, _req, _res</span>) =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'proxy error'</span>, err)
          })
          proxy.<span class="hljs-title function_">on</span>(<span class="hljs-string">'proxyReq'</span>, <span class="hljs-function">(<span class="hljs-params">proxyReq, req, _res</span>) =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Sending Request:'</span>, req.<span class="hljs-property">method</span>, req.<span class="hljs-property">url</span>)
          })
        }
      }
    }
  }
})
</code></pre>
<h4 data-id="heading-8">代理工作原理流程图</h4>
<pre><code class="hljs language-bash" lang="bash">浏览器发送请求到 Unsupported markdown: linkVue开发服务器代理中间件检测到/api前缀重写请求路径转发到 Unsupported markdown: <span class="hljs-built_in">link</span>后端服务器返回响应数据
</code></pre>
<h4 data-id="heading-9">方案二：生产环境解决方案</h4>
<p>开发环境的代理配置在生产环境是无效的，我们需要其他方案：</p>
<h5 data-id="heading-10">1. Nginx反向代理</h5>
<p><strong>Nginx配置文件示例：</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># nginx.conf</span>
server {
    listen 80<span class="hljs-comment">;</span>
    server_name your-domain.com<span class="hljs-comment">;</span>
    
    <span class="hljs-comment"># 前端静态文件</span>
    location / {
        root /usr/share/nginx/html<span class="hljs-comment">;</span>
        index index.html<span class="hljs-comment">;</span>
        try_files $uri $uri/ /index.html<span class="hljs-comment">;</span>
    }
    
    <span class="hljs-comment"># API代理配置</span>
    location /api/ {
        proxy_pass http://backend-server:3000/<span class="hljs-comment">;</span>
        proxy_set_header Host $host<span class="hljs-comment">;</span>
        proxy_set_header X-Real-IP $remote_addr<span class="hljs-comment">;</span>
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for<span class="hljs-comment">;</span>
        proxy_set_header X-Forwarded-Proto $scheme<span class="hljs-comment">;</span>
        
        <span class="hljs-comment"># CORS头（如果需要）</span>
        add_header Access-Control-Allow-Origin *<span class="hljs-comment">;</span>
        add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS, PUT, DELETE'<span class="hljs-comment">;</span>
        add_header Access-Control-Allow-Headers '*'<span class="hljs-comment">;</span>
        
        <span class="hljs-comment"># 处理预检请求</span>
        if ($<span class="hljs-attr">request_method</span> = <span class="hljs-string">'OPTIONS'</span>) {
            add_header Access-Control-Allow-Origin *<span class="hljs-comment">;</span>
            add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS, PUT, DELETE'<span class="hljs-comment">;</span>
            add_header Access-Control-Allow-Headers '*'<span class="hljs-comment">;</span>
            add_header Access-Control-Max-Age 86400<span class="hljs-comment">;</span>
            return 204<span class="hljs-comment">;</span>
        }
    }
    
    <span class="hljs-comment"># 静态资源缓存</span>
    location ~* .(js|css|png|jpg|jpeg|gif|ico|svg)$ {
        expires 1y<span class="hljs-comment">;</span>
        add_header Cache-Control "public, immutable"<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h5 data-id="heading-11">2. 后端配置CORS</h5>
<p><strong>Node.js Express示例：</strong></p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-comment">// server.js</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">express </span>= <span class="hljs-keyword">require</span>(<span class="hljs-string">'express'</span>)
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">cors </span>= <span class="hljs-keyword">require</span>(<span class="hljs-string">'cors'</span>)

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">app </span>= <span class="hljs-title function_ invoke__">express</span>()

<span class="hljs-comment">// 基础CORS配置</span>
app.<span class="hljs-keyword">use</span>(<span class="hljs-title function_ invoke__">cors</span>())

<span class="hljs-comment">// 自定义CORS配置</span>
app.<span class="hljs-keyword">use</span>(<span class="hljs-title function_ invoke__">cors</span>({
<span class="hljs-attr">  origin</span>: [
    <span class="hljs-string">'http://localhost:8080'</span>,
    <span class="hljs-string">'http://localhost:5173'</span>,
    <span class="hljs-string">'https://your-production-domain.com'</span>
  ],
<span class="hljs-attr">  methods</span>: [<span class="hljs-string">'GET'</span>, <span class="hljs-string">'POST'</span>, <span class="hljs-string">'PUT'</span>, <span class="hljs-string">'DELETE'</span>, <span class="hljs-string">'OPTIONS'</span>],
<span class="hljs-attr">  allowedHeaders</span>: [<span class="hljs-string">'Content-Type'</span>, <span class="hljs-string">'Authorization'</span>, <span class="hljs-string">'X-Requested-With'</span>],
<span class="hljs-attr">  credentials</span>: <span class="hljs-literal">true</span>, // 允许携带cookie
<span class="hljs-attr">  maxAge</span>: <span class="hljs-number">86400</span> // 预检请求缓存时间
}))

<span class="hljs-comment">// 或者针对特定路由配置CORS</span>
app.<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">'/api/data'</span>, <span class="hljs-title function_ invoke__">cors</span>(), (req, res) =&gt; {
  res.<span class="hljs-title function_ invoke__">json</span>({<span class="hljs-attr"> message</span>: <span class="hljs-string">'This route has CORS enabled'</span> })
})

<span class="hljs-comment">// 手动设置CORS头</span>
app.<span class="hljs-keyword">use</span>((req, res, next) =&gt; {
  res.<span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">'Access-Control-Allow-Origin'</span>, <span class="hljs-string">'https://your-domain.com'</span>)
  res.<span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">'Access-Control-Allow-Methods'</span>, <span class="hljs-string">'GET, POST, PUT, DELETE, OPTIONS'</span>)
  res.<span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">'Access-Control-Allow-Headers'</span>, <span class="hljs-string">'Content-Type, Authorization'</span>)
  res.<span class="hljs-title function_ invoke__">header</span>(<span class="hljs-string">'Access-Control-Allow-Credentials'</span>, <span class="hljs-string">'true'</span>)
  
  <span class="hljs-keyword">if</span><span class="hljs-title function_ invoke__"> </span>(req.method === <span class="hljs-string">'OPTIONS'</span>) {
    <span class="hljs-keyword">return</span> res.<span class="hljs-title function_ invoke__">sendStatus</span>(<span class="hljs-number">200</span>)
  }
  
  <span class="hljs-title function_ invoke__">next</span>()
})

app.<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">'/api/users'</span>, (req, res) =&gt; {
  res.<span class="hljs-title function_ invoke__">json</span>([{<span class="hljs-attr"> id</span>: <span class="hljs-number">1</span>,<span class="hljs-attr"> name</span>: <span class="hljs-string">'John'</span> }, {<span class="hljs-attr"> id</span>: <span class="hljs-number">2</span>,<span class="hljs-attr"> name</span>: <span class="hljs-string">'Jane'</span> }])
})

app.<span class="hljs-title function_ invoke__">listen</span>(<span class="hljs-number">3000</span>, () =&gt; {
  console.<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">'Server running on port 3000'</span>)
})
</code></pre>
<h4 data-id="heading-12">方案三：JSONP（适用于老项目）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// JSONP工具函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">jsonp</span>(<span class="hljs-params">url, callbackName = <span class="hljs-string">'callback'</span></span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-comment">// 创建script标签</span>
    <span class="hljs-keyword">const</span> script = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'script'</span>)
    <span class="hljs-keyword">const</span> callbackFunctionName = <span class="hljs-string">`jsonp_<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>_<span class="hljs-subst">${<span class="hljs-built_in">Math</span>.random().toString(<span class="hljs-number">36</span>).substr(<span class="hljs-number">2</span>)}</span>`</span>
    
    <span class="hljs-comment">// 设置全局回调函数</span>
    <span class="hljs-variable language_">window</span>[callbackFunctionName] = <span class="hljs-function">(<span class="hljs-params">data</span>) =&gt;</span> {
      <span class="hljs-comment">// 清理工作</span>
      <span class="hljs-keyword">delete</span> <span class="hljs-variable language_">window</span>[callbackFunctionName]
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(script)
      <span class="hljs-title function_">resolve</span>(data)
    }
    
    <span class="hljs-comment">// 处理URL，添加回调参数</span>
    <span class="hljs-keyword">const</span> separator = url.<span class="hljs-title function_">includes</span>(<span class="hljs-string">'?'</span>) ? <span class="hljs-string">'&amp;'</span> : <span class="hljs-string">'?'</span>
    script.<span class="hljs-property">src</span> = <span class="hljs-string">`<span class="hljs-subst">${url}</span><span class="hljs-subst">${separator}</span><span class="hljs-subst">${callbackName}</span>=<span class="hljs-subst">${callbackFunctionName}</span>`</span>
    
    <span class="hljs-comment">// 错误处理</span>
    script.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">delete</span> <span class="hljs-variable language_">window</span>[callbackFunctionName]
      <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">removeChild</span>(script)
      <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'JSONP request failed'</span>))
    }
    
    <span class="hljs-variable language_">document</span>.<span class="hljs-property">body</span>.<span class="hljs-title function_">appendChild</span>(script)
  })
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">jsonp</span>(<span class="hljs-string">'http://api.example.com/data'</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Received data:'</span>, data)
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Error:'</span>, error)
  }
}
</code></pre>
<h3 data-id="heading-13">环境区分的最佳实践</h3>
<p>在实际项目中，我们需要根据环境使用不同的配置：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// src/config/index.js</span>
<span class="hljs-type">const</span> config = {
  <span class="hljs-comment">// 开发环境</span>
  development: {
    baseURL: <span class="hljs-string">'/api'</span> <span class="hljs-comment">// 使用代理</span>
  },
  <span class="hljs-comment">// 测试环境</span>
  test: {
    baseURL: <span class="hljs-string">'https://test-api.yourcompany.com'</span>
  },
  <span class="hljs-comment">// 生产环境</span>
  production: {
    baseURL: <span class="hljs-string">'https://api.yourcompany.com'</span>
  }
}

<span class="hljs-type">const</span> environment = process.env.NODE_ENV || <span class="hljs-string">'development'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> config[environment]
</code></pre>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">// src/services/api.js</span>
<span class="hljs-keyword">import</span> config from <span class="hljs-string">'@/config'</span>
<span class="hljs-keyword">import</span> axios from <span class="hljs-string">'axios'</span>

<span class="hljs-type">const</span> api = axios.<span class="hljs-built_in">create</span>({
  baseURL: config.baseURL,
  timeout: <span class="hljs-number">10000</span>
})

<span class="hljs-comment">// 环境判断</span>
<span class="hljs-keyword">if</span> (process.env.NODE_ENV === <span class="hljs-string">'development'</span>) {
  <span class="hljs-comment">// 开发环境特殊处理</span>
  api.interceptors.request.<span class="hljs-built_in">use</span>(request =&gt; {
    console.<span class="hljs-built_in">log</span>(<span class="hljs-string">'开发环境请求:'</span>, request)
    <span class="hljs-keyword">return</span> request
  })
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> api
</code></pre>
<h3 data-id="heading-14">完整的工作流程图</h3>
<pre><code class="hljs">开发环境

生产环境

Vue应用发起请求判断当前环境使用开发服务器代理使用生产环境API地址Vue开发服务器接收请求代理中间件处理转发到目标服务器直接请求生产APINginx反向代理后端API服务器返回响应数据
</code></pre>
<h3 data-id="heading-15">常见问题与解决方案</h3>
<h4 data-id="heading-16">1. 代理不生效怎么办？</h4>
<p><strong>检查步骤：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 1. 检查vue.config.js配置是否正确</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">devServer</span>: {
    <span class="hljs-attr">proxy</span>: {
      <span class="hljs-string">'/api'</span>: {
        <span class="hljs-attr">target</span>: <span class="hljs-string">'http://localhost:3000'</span>,
        <span class="hljs-attr">changeOrigin</span>: <span class="hljs-literal">true</span>,
        <span class="hljs-comment">// 添加日志查看代理是否工作</span>
        <span class="hljs-attr">onProxyReq</span>: <span class="hljs-function">(<span class="hljs-params">proxyReq, req, res</span>) =&gt;</span> {
          <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Proxying request:'</span>, req.<span class="hljs-property">url</span>, <span class="hljs-string">'-&gt;'</span>, proxyReq.<span class="hljs-property">path</span>)
        }
      }
    }
  }
}

<span class="hljs-comment">// 2. 检查网络面板，确认请求是否发送到正确地址</span>
<span class="hljs-comment">// 3. 确认后端服务是否正常运行</span>
</code></pre>
<h4 data-id="heading-17">2. 预检请求(OPTIONS)处理</h4>
<pre><code class="hljs language-lua" lang="lua">// 后端需要正确处理OPTIONS请求
app.use(<span class="hljs-string">'/api/*'</span>, (req, res, <span class="hljs-built_in">next</span>) =&gt; {
  <span class="hljs-keyword">if</span> (req.method === <span class="hljs-string">'OPTIONS'</span>) {
    res.header(<span class="hljs-string">'Access-Control-Allow-Origin'</span>, <span class="hljs-string">'*'</span>)
    res.header(<span class="hljs-string">'Access-Control-Allow-Methods'</span>, <span class="hljs-string">'GET, POST, PUT, DELETE, OPTIONS'</span>)
    res.header(<span class="hljs-string">'Access-Control-Allow-Headers'</span>, <span class="hljs-string">'Content-Type, Authorization'</span>)
    res.<span class="hljs-built_in">status</span>(<span class="hljs-number">200</span>).<span class="hljs-keyword">end</span>()
    <span class="hljs-keyword">return</span>
  }
  <span class="hljs-built_in">next</span>()
})
</code></pre>
<h3 data-id="heading-18">总结</h3>
<p>跨域问题是前端开发中的常见挑战，但通过合适的解决方案可以轻松应对：</p>
<ul>
<li>• <strong>开发环境</strong>：使用Vue CLI或Vite的代理功能</li>
<li>• <strong>生产环境</strong>：使用Nginx反向代理或后端配置CORS</li>
<li>• <strong>特殊情况</strong>：考虑JSONP或WebSocket代理</li>
</ul>
<p>记住，<strong>安全始终是首要考虑因素</strong>。在配置CORS时，不要简单地使用<code>*</code>作为允许的源，而应该明确指定可信的域名。</p>
<p>希望这篇详细的指南能帮助你彻底解决Vue项目中的跨域问题！如果你有任何疑问或补充，欢迎在评论区留言讨论。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[拒绝卡顿！小程序图片本地“极速”旋转与格式转换，离屏 Canvas 性能调优实战]]></title>    <link>https://juejin.cn/post/7577689171223248946</link>    <guid>https://juejin.cn/post/7577689171223248946</guid>    <pubDate>2025-11-30T02:43:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577689171223248946" data-draft-id="7577718777481789478" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="拒绝卡顿！小程序图片本地“极速”旋转与格式转换，离屏 Canvas 性能调优实战"/> <meta itemprop="keywords" content="前端,JavaScript,微信小程序"/> <meta itemprop="datePublished" content="2025-11-30T02:43:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小皮虾"/> <meta itemprop="url" content="https://juejin.cn/user/1468603263091623"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            拒绝卡顿！小程序图片本地“极速”旋转与格式转换，离屏 Canvas 性能调优实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1468603263091623/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小皮虾
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T02:43:04.000Z" title="Sun Nov 30 2025 02:43:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 背景与痛点：高清大图的“崩溃”瞬间</h2>
<p>在开发小程序图片工具时，我们经常面临“两难”境地：</p>
<ol>
<li><strong>用户上传原图</strong>：现代手机拍摄的照片动辄 4000x3000 分辨率，在 iOS 设备上 DPR（设备像素比）通常为 3。</li>
<li><strong>内存爆炸</strong>：如果直接按原图渲染，画布像素高达 <code>(4000*3) * (3000*3) ≈ 1亿像素</code>！这远超小程序的 Canvas 内存限制，导致<strong>微信客户端直接闪退</strong>。</li>
<li><strong>传统方案弊端</strong>：上传服务器处理费流量且慢；普通 Canvas 渲染又卡顿界面。</li>
</ol>
<p>为了解决这个问题，我们打磨出了一套基于 <code>OffscreenCanvas</code> 的高性能本地处理方案，核心在于“<strong>智能计算，动态降级</strong>”。</p>
<h2 data-id="heading-1">2. 核心思路：离屏渲染 + 智能防爆</h2>
<p>我们的方案包含两个关键技术点：</p>
<ol>
<li>
<p><strong>OffscreenCanvas（2D 离屏画布）</strong>：
相比传统 Canvas，它在内存中渲染，不占用 DOM，没有任何 UI 开销，绘图指令执行极快。</p>
</li>
<li>
<p><strong>智能 DPR 限制（核心黑科技）</strong>：
这是防止闪退的关键。我们在绘制前计算“目标画布尺寸”。</p>
<ul>
<li><strong>判断</strong>：如果 <code>逻辑尺寸 * 系统DPR</code> 超过了安全阈值（如 4096px）。</li>
<li><strong>降级</strong>：强制降低使用的 DPR 值，确保最终纹理尺寸在安全范围内。</li>
<li><strong>结果</strong>：牺牲肉眼难以察觉的极微小清晰度，换取 <strong>100% 不闪退</strong> 的稳定性。</li>
</ul>
</li>
</ol>
<h2 data-id="heading-2">3. 硬核代码实现</h2>
<p>以下是<code>帮小忙工具箱</code>小程序封装好的 <code>imageUtils.js</code> 核心源代码，包含<strong>格式转换</strong>和<strong>带防爆逻辑的旋转</strong>功能。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// utils/imageUtils.js</span>

<span class="hljs-comment">// 1. 获取系统基础信息</span>
<span class="hljs-keyword">const</span> wxt = {
  <span class="hljs-attr">dpr</span>: wx.<span class="hljs-title function_">getSystemInfoSync</span>().<span class="hljs-property">pixelRatio</span> || <span class="hljs-number">2</span>
};

<span class="hljs-comment">// 2. 图片对象缓存池（避免重复加载同一张图）</span>
<span class="hljs-keyword">const</span> cacheCanvasImageMap = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();

<span class="hljs-comment">/**
 * 内部方法：获取/创建 Canvas Image 对象
 */</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getCanvasImage</span>(<span class="hljs-params">canvas, imageUrl</span>) {
  <span class="hljs-keyword">if</span> (cacheCanvasImageMap.<span class="hljs-title function_">has</span>(imageUrl)) {
    <span class="hljs-keyword">return</span> cacheCanvasImageMap.<span class="hljs-title function_">get</span>(imageUrl);
  }
  
  <span class="hljs-comment">// 兼容 Promise.withResolvers 或使用 new Promise</span>
  <span class="hljs-keyword">const</span> { promise, resolve, reject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();
  <span class="hljs-keyword">const</span> image = canvas.<span class="hljs-title function_">createImage</span>();
  image.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
    cacheCanvasImageMap.<span class="hljs-title function_">set</span>(imageUrl, image);
    <span class="hljs-title function_">resolve</span>(image);
  };
  image.<span class="hljs-property">onerror</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`图片加载失败: <span class="hljs-subst">${e.errMsg}</span>`</span>));
  image.<span class="hljs-property">src</span> = imageUrl;
  <span class="hljs-keyword">await</span> promise;
  <span class="hljs-keyword">return</span> image;
}

<span class="hljs-comment">/**
 * 功能一：离屏 Canvas 转换图片格式 (PNG/HEIC -&gt; JPG)
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} imageUrl 图片路径
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} destFileType 目标类型 'jpg' | 'png'
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} quality 质量 0-1
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">convertImageType</span>(<span class="hljs-params">imageUrl, destFileType = <span class="hljs-string">'jpg'</span>, quality = <span class="hljs-number">1</span></span>) {
  <span class="hljs-keyword">const</span> offscreenCanvas = wx.<span class="hljs-title function_">createOffscreenCanvas</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'2d'</span> });
  <span class="hljs-keyword">const</span> image = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getCanvasImage</span>(offscreenCanvas, imageUrl);
  <span class="hljs-keyword">const</span> { width, height } = image;

  <span class="hljs-comment">// 基础转换：直接使用系统 DPR 保证高清</span>
  offscreenCanvas.<span class="hljs-property">width</span> = width * wxt.<span class="hljs-property">dpr</span>;
  offscreenCanvas.<span class="hljs-property">height</span> = height * wxt.<span class="hljs-property">dpr</span>;

  <span class="hljs-keyword">const</span> ctx = offscreenCanvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
  ctx.<span class="hljs-title function_">scale</span>(wxt.<span class="hljs-property">dpr</span>, wxt.<span class="hljs-property">dpr</span>);
  ctx.<span class="hljs-title function_">drawImage</span>(image, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, width, height);

  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> wx.<span class="hljs-title function_">canvasToTempFilePath</span>({
    <span class="hljs-attr">canvas</span>: offscreenCanvas,
    <span class="hljs-attr">fileType</span>: destFileType,
    <span class="hljs-attr">quality</span>: quality,
  });
  <span class="hljs-keyword">return</span> res.<span class="hljs-property">tempFilePath</span>;
}

<span class="hljs-comment">/**
 * 功能二：极速旋转图片 (含内存保护)
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">string</span>} imageUrl 图片路径
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number</span>} degree 旋转角度 (90, 180, 270...)
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">rotateImage</span>(<span class="hljs-params">imageUrl, degree = <span class="hljs-number">90</span>, destFileType = <span class="hljs-string">'jpg'</span>, quality = <span class="hljs-number">1</span></span>) {
  <span class="hljs-keyword">const</span> offscreenCanvas = wx.<span class="hljs-title function_">createOffscreenCanvas</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'2d'</span> });
  <span class="hljs-keyword">const</span> image = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getCanvasImage</span>(offscreenCanvas, imageUrl);
  <span class="hljs-keyword">const</span> { width, height } = image;

  <span class="hljs-keyword">const</span> radian = (degree * <span class="hljs-title class_">Math</span>.<span class="hljs-property">PI</span>) / <span class="hljs-number">180</span>;
  
  <span class="hljs-comment">// 1. 计算旋转后的逻辑包围盒宽高</span>
  <span class="hljs-keyword">const</span> newWidth = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(width * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(radian)) + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(height * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(radian));
  <span class="hljs-keyword">const</span> newHeight = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(width * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">sin</span>(radian)) + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">abs</span>(height * <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">cos</span>(radian));

  <span class="hljs-comment">// --- ⚡️ 性能优化核心 Start ---</span>
  
  <span class="hljs-comment">// 2. 智能计算 DPR：避免画布过大炸内存</span>
  <span class="hljs-comment">// 设定安全纹理阈值，4096px 是大多数移动端 GPU 的安全线</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">LIMIT_SIZE</span> = <span class="hljs-number">4096</span>; 
  <span class="hljs-keyword">let</span> useDpr = wxt.<span class="hljs-property">dpr</span>;

  <span class="hljs-comment">// 核心判断：如果 (逻辑边长 * dpr) 超过限制，自动计算最大允许的 dpr</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(newWidth, newHeight) * useDpr &gt; <span class="hljs-variable constant_">LIMIT_SIZE</span>) {
    useDpr = <span class="hljs-variable constant_">LIMIT_SIZE</span> / <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(newWidth, newHeight);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`[ImageRotate] 图片过大，触发自动降级，DPR调整为: <span class="hljs-subst">${useDpr.toFixed(<span class="hljs-number">2</span>)}</span>`</span>);
  }

  <span class="hljs-comment">// 3. 设置物理画布尺寸 (使用计算后的安全 DPR)</span>
  offscreenCanvas.<span class="hljs-property">width</span> = newWidth * useDpr;
  offscreenCanvas.<span class="hljs-property">height</span> = newHeight * useDpr;

  <span class="hljs-keyword">const</span> ctx = offscreenCanvas.<span class="hljs-title function_">getContext</span>(<span class="hljs-string">'2d'</span>);
  ctx.<span class="hljs-title function_">scale</span>(useDpr, useDpr); 
  
  <span class="hljs-comment">// --- 性能优化核心 End ---</span>

  <span class="hljs-comment">// 4. 绘图逻辑：平移 -&gt; 旋转 -&gt; 绘制</span>
  ctx.<span class="hljs-title function_">translate</span>(newWidth / <span class="hljs-number">2</span>, newHeight / <span class="hljs-number">2</span>);
  ctx.<span class="hljs-title function_">rotate</span>(radian);
  ctx.<span class="hljs-title function_">drawImage</span>(image, -width / <span class="hljs-number">2</span>, -height / <span class="hljs-number">2</span>, width, height);

  <span class="hljs-comment">// 5. 导出文件 </span>
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> wx.<span class="hljs-title function_">canvasToTempFilePath</span>({
    <span class="hljs-attr">canvas</span>: offscreenCanvas,
    <span class="hljs-attr">fileType</span>: destFileType,
    <span class="hljs-attr">quality</span>: quality,
  });

  <span class="hljs-keyword">return</span> res.<span class="hljs-property">tempFilePath</span>;
}
</code></pre>
<h2 data-id="heading-3">4. 避坑与实战经验</h2>
<ol>
<li><strong>图片转pdf场景经验</strong>
图片转成pdf，在使用<code>pdf-lib</code>插入图片时，只支持jpg、png在插入前先判断一下是否符合，用户可能上传webp等图片（有些人觉得限制上传类型，但图片后缀有可能被篡改过），就需要先转换；另外如果要保证pdf是纵向的，使用canvas提前确保图片为纵向的，就简单很多，无需在<code>pdf-lib</code>做坐标变换</li>
<li><strong>DPR 的取舍艺术</strong>：
很多开发者喜欢写死 <code>offscreenCanvas.width = width</code>，这样导出的图是模糊的。也有人写死 <code>width * systemDpr</code>，这会导致大图闪退。
<strong>最佳实践</strong>就是代码中的 <code>Math.min</code> 逻辑：<strong>在安全范围内，尽可能高清</strong>。</li>
<li><strong>兼容性提示</strong>：
代码中使用了 <code>Promise.withResolvers()</code>，这是 ES2024 新特性。我全局内置兼容代码。</li>
</ol>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * 创建withResolvers函数
 */</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-property">withResolvers</span> =
	<span class="hljs-title class_">Promise</span>.<span class="hljs-property">withResolvers</span> ||
	<span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
		<span class="hljs-keyword">let</span> resolve, reject;
		<span class="hljs-keyword">const</span> promise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">res, rej</span>) =&gt;</span> {
			resolve = res;
			reject = rej;
		});
		<span class="hljs-keyword">return</span> {
			promise,
			resolve,
			reject,
		};
	};
</code></pre>
<h2 data-id="heading-4">写在最后</h2>
<p>通过这一套组合拳，我们成功在小程序中实现了稳定、高效的本地图片处理。无论用户使用几年前的安卓机还是最新的 iPhone，都能流畅地完成图片旋转与转换，再也不用担心内存溢出带来的闪退噩梦了！</p>
<p>希望这篇实战分享能帮你解决 Canvas 开发中的性能难题！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[vue3 Composable介绍]]></title>    <link>https://juejin.cn/post/7577702891273551907</link>    <guid>https://juejin.cn/post/7577702891273551907</guid>    <pubDate>2025-11-30T03:38:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577702891273551907" data-draft-id="7577702891273535523" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="vue3 Composable介绍"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-30T03:38:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="南雨北斗"/> <meta itemprop="url" content="https://juejin.cn/user/4059818590476286"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            vue3 Composable介绍
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4059818590476286/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    南雨北斗
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T03:38:54.000Z" title="Sun Nov 30 2025 03:38:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>好的，我们来深入探讨一下 <strong>Vue 3 的 Composable</strong>。</p>
<h3 data-id="heading-0">1. 什么是 Composable？</h3>
<p><code>Composable</code> 是 Vue 3 中一个核心的概念和功能，它是<strong>可复用的、有状态的逻辑块</strong>，用于封装和提取组件中的重复逻辑，让代码更清晰、更易于维护。</p>
<p>你可以把它理解为：<strong>专门用来存放 “可以被多个组件复用的业务逻辑” 的函数</strong>。</p>
<h3 data-id="heading-1">2. 为什么需要 Composable？</h3>
<p>在 Vue 2 中，我们通常使用 <strong>Mixins</strong> 来复用逻辑。但 Mixins 存在一些问题：</p>
<ul>
<li><strong>命名冲突</strong>：多个 Mixin 可能会定义相同名称的数据或方法，导致覆盖。</li>
<li><strong>来源不清晰</strong>：当一个组件使用了多个 Mixin 后，很难追踪某个数据或方法到底来自哪个 Mixin。</li>
<li><strong>逻辑耦合度高</strong>：Mixins 和组件之间是隐式依赖关系，不易于单独测试和维护。</li>
</ul>
<p>而 Composable 则完美解决了这些问题：</p>
<ul>
<li><strong>明确的依赖关系</strong>：通过函数调用和返回值来显式地传入和获取数据，来源清晰。</li>
<li><strong>无命名冲突</strong>：返回的内容通过解构赋值的方式被组件接收，组件可以自己决定命名。</li>
<li><strong>更好的类型推断</strong>：对于 TypeScript 非常友好，能提供完整的类型提示。</li>
<li><strong>更易于测试</strong>：Composable 本身就是一个函数，可以独立进行单元测试。</li>
</ul>
<h3 data-id="heading-2">3. 如何创建一个 Composable？</h3>
<p>创建一个 Composable 非常简单，它就是一个<strong>以 <code>use</code> 开头的函数</strong>（这是一个约定，便于识别），在函数内部可以使用 Vue 的响应式 API（如 <code>ref</code>, <code>reactive</code>, <code>computed</code>, <code>watch</code> 等），并返回需要暴露给组件使用的状态和方法。</p>
<p><strong>示例：创建一个处理计数器逻辑的 Composable</strong></p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/composables/useCounter.js</span>

<span class="hljs-keyword">import</span> { ref, computed, onMounted } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;

<span class="hljs-comment">// 定义一个 Composable 函数，通常以 use 开头</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useCounter</span>(<span class="hljs-params">initialValue = <span class="hljs-number">0</span></span>) {
  <span class="hljs-comment">// 1. 定义响应式状态</span>
  <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(initialValue);

  <span class="hljs-comment">// 2. 定义基于状态的计算属性</span>
  <span class="hljs-keyword">const</span> doubleCount = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> count.<span class="hljs-property">value</span> * <span class="hljs-number">2</span>);

  <span class="hljs-comment">// 3. 定义修改状态的方法</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; {
    count.<span class="hljs-property">value</span>++;
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">decrement</span> = (<span class="hljs-params"/>) =&gt; {
    count.<span class="hljs-property">value</span>--;
  };

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">reset</span> = (<span class="hljs-params"/>) =&gt; {
    count.<span class="hljs-property">value</span> = initialValue;
  };

  <span class="hljs-comment">// 4. 可以使用生命周期钩子</span>
  <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`计数器已初始化，初始值为: <span class="hljs-subst">${count.value}</span>`</span>);
  });

  <span class="hljs-comment">// 5. 返回需要暴露给组件的内容</span>
  <span class="hljs-keyword">return</span> {
    count,
    doubleCount,
    increment,
    decrement,
    reset
  };
}
</code></pre>
<h3 data-id="heading-3">4. 如何在组件中使用 Composable？</h3>
<p>在组件中，你只需要 <strong>导入并调用</strong> 这个 Composable 函数，然后通过<strong>解构赋值</strong>的方式获取其返回的状态和方法即可。</p>
<p><strong>示例：在组件中使用 <code>useCounter</code></strong></p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/components/CounterDisplay.vue --&gt;
&lt;template&gt;
  &lt;div&gt;
    &lt;p&gt;当前计数: {{ count }}&lt;/p&gt;
    &lt;p&gt;计数的两倍: {{ doubleCount }}&lt;/p&gt;
    &lt;button @click="increment"&gt;+1&lt;/button&gt;
    &lt;button @click="decrement"&gt;-1&lt;/button&gt;
    &lt;button @click="reset"&gt;重置&lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { useCounter } from '@/composables/useCounter';

// 调用 Composable 函数
// 可以传入初始值，如 useCounter(10)
// 通过解构赋值获取返回的状态和方法
const { count, doubleCount, increment, decrement, reset } = useCounter();
&lt;/script&gt;
</code></pre>
<p><strong>关键点</strong>：</p>
<ul>
<li>每次调用 <code>useCounter()</code>，都会创建一个<strong>全新的、独立的</strong>状态实例。这意味着如果两个组件都使用了 <code>useCounter</code>，它们的状态是完全隔离的，互不影响。</li>
<li>组件可以根据需要，只解构自己需要的部分。</li>
</ul>
<h3 data-id="heading-4">5. Composable 的最佳实践</h3>
<ol>
<li>
<p><strong>命名规范</strong>：</p>
<ul>
<li>Composable 函数名<strong>必须以 <code>use</code> 开头</strong>，例如 <code>useCounter</code>, <code>useUser</code>, <code>useCart</code>。</li>
<li>文件名通常与函数名一致，例如 <code>useCounter.js</code>。</li>
</ul>
</li>
<li>
<p><strong>单一职责原则</strong>：</p>
<ul>
<li>一个 Composable 应该只负责一个特定的功能或逻辑。如果一个 Composable 变得过于庞大和复杂，应该考虑将其拆分成多个更小的、职责更单一的 Composable。</li>
</ul>
</li>
<li>
<p><strong>组合与嵌套</strong>：</p>
<ul>
<li>
<p>Composable 可以<strong>相互调用</strong>。这是一个非常强大的特性，允许你构建复杂的逻辑。</p>
</li>
<li>
<p>例如，一个 <code>useCart</code> Composable 内部可以调用 <code>useUser</code> Composable 来获取当前用户信息，以便计算购物车商品的会员价格。</p>
</li>
</ul>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// src/composables/useCart.js</span>
<span class="hljs-keyword">import</span> { useUser } <span class="hljs-keyword">from</span> <span class="hljs-string">'./useUser'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useCart</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { user } = <span class="hljs-title function_">useUser</span>(); <span class="hljs-comment">// 调用另一个 Composable</span>

  <span class="hljs-comment">// ... 购物车相关逻辑，可以使用 user 的信息</span>
  <span class="hljs-keyword">const</span> cartItems = <span class="hljs-title function_">ref</span>([]);
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">calculateDiscountPrice</span> = (<span class="hljs-params">item</span>) =&gt; {
    <span class="hljs-keyword">if</span> (user.<span class="hljs-property">value</span>?.<span class="hljs-property">isVIP</span>) {
      <span class="hljs-keyword">return</span> item.<span class="hljs-property">price</span> * <span class="hljs-number">0.9</span>; <span class="hljs-comment">// VIP 9 折</span>
    }
    <span class="hljs-keyword">return</span> item.<span class="hljs-property">price</span>;
  };

  <span class="hljs-comment">// ...</span>
  <span class="hljs-keyword">return</span> { cartItems, calculateDiscountPrice };
}
</code></pre>
</li>
<li>
<p><strong>避免在 Composable 中访问组件实例</strong>：</p>
<ul>
<li>理想情况下，Composable 应该是<strong>纯逻辑</strong>的封装，不应该直接依赖于 Vue 组件实例 (<code>this</code>)。</li>
<li>如果确实需要使用组件实例的属性（如 <code>$route</code>, <code>$store</code>），应该通过参数的形式从组件中传递进来，或者使用 Vue 提供的 <code>getCurrentInstance()</code> 函数（但这会降低 Composable 的通用性，应谨慎使用）。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-5">总结</h3>
<p><code>Composable</code> 是 Vue 3 中替代 <code>Mixins</code> 的<strong>更优、更现代</strong>的逻辑复用方案。</p>
<ul>
<li>它通过<strong>函数</strong>的形式封装逻辑，通过<strong>返回值</strong>暴露状态和方法。</li>
<li>它实现了<strong>逻辑的复用和隔离</strong>，让组件代码更简洁、更清晰。</li>
<li>它遵循<strong>明确的依赖关系</strong>和<strong>单一职责原则</strong>，极大地提升了代码的可维护性和可测试性。</li>
<li>在 Vue 3 项目中，<strong>任何可复用的逻辑都应该被提取为 Composable</strong>。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript数组去重的多种实现方式]]></title>    <link>https://juejin.cn/post/7577705544875507750</link>    <guid>https://juejin.cn/post/7577705544875507750</guid>    <pubDate>2025-11-30T03:53:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577705544875507750" data-draft-id="7577737385954557962" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript数组去重的多种实现方式"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-30T03:53:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="瓶子in"/> <meta itemprop="url" content="https://juejin.cn/user/3754212287597066"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript数组去重的多种实现方式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3754212287597066/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    瓶子in
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T03:53:17.000Z" title="Sun Nov 30 2025 03:53:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在前端开发中，数组去重是一个常见的需求。无论是处理用户数据、API响应还是进行数据清洗，我们都需要掌握去重方法。本文将详细介绍JavaScript中数组去重的多种实现方式。</p>
<h3 data-id="heading-1">1. 使用Set数据结构（ES6推荐）</h3>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'a'</span>]<span class="hljs-comment">;</span>
const <span class="hljs-attr">uniqueArr</span> = [...new Set(arr)]<span class="hljs-comment">;</span>
console.log(uniqueArr)<span class="hljs-comment">; // [1, 2, 3, 4, 5, "a"]</span>
</code></pre>
<p><strong>Set</strong> 是 ES6 引入的一种新的数据结构，它类似于数组，但是成员的值都是唯一的，没有重复的值。</p>
<p>javascript</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// Set的基本使用</span>
const arr1 = new <span class="hljs-built_in">Set</span>()
arr1<span class="hljs-selector-class">.add</span>(<span class="hljs-number">1</span>)
arr1<span class="hljs-selector-class">.add</span>(<span class="hljs-number">2</span>)
arr1<span class="hljs-selector-class">.add</span>(<span class="hljs-number">3</span>)
arr1<span class="hljs-selector-class">.add</span>(<span class="hljs-number">1</span>)  <span class="hljs-comment">// 重复添加</span>
console<span class="hljs-selector-class">.log</span>(arr1)  <span class="hljs-comment">// {1, 2, 3} - 重复的自动过滤</span>
</code></pre>
<h3 data-id="heading-2">2. 使用filter + indexOf方法</h3>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]<span class="hljs-comment">;</span>
const <span class="hljs-attr">uniqueArr</span> = arr.filter((item, index) =&gt; arr.indexOf(item) === index)<span class="hljs-comment">;</span>
console.log(uniqueArr)<span class="hljs-comment">; // [1, 2, 3, 4, 5]</span>
</code></pre>
<p>这里利用了<code>filter</code>方法和<code>indexOf</code>方法的特性：</p>
<ul>
<li><code>filter</code>会遍历数组，将符合条件的元素组成新数组返回</li>
<li><code>indexOf</code>返回元素在数组中第一次出现的位置索引</li>
<li>只有当元素第一次出现时的索引与当前索引相等时，才保留该元素</li>
</ul>
<h3 data-id="heading-3">3. 使用reduce方法</h3>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]<span class="hljs-comment">;</span>
const <span class="hljs-attr">uniqueArr</span> = arr.reduce((acc, current) =&gt; {
  return acc.includes(current) ? acc : <span class="hljs-section">[...acc, current]</span><span class="hljs-comment">;</span>
}, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>
console.log(uniqueArr)<span class="hljs-comment">; // [1, 2, 3, 4, 5]</span>
</code></pre>
<p><code>reduce</code>方法通过累积器遍历数组，检查当前元素是否已存在于累积器中，不存在则添加。</p>
<h3 data-id="heading-4">4. 使用forEach + includes方法</h3>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]<span class="hljs-comment">;</span>
const <span class="hljs-attr">uniqueArr</span> = []<span class="hljs-comment">;</span>
arr.forEach(<span class="hljs-attr">item</span> =&gt; {
  if (!uniqueArr.includes(item)) {
    uniqueArr.push(item)<span class="hljs-comment">;</span>
  }
})<span class="hljs-comment">;</span>
console.log(uniqueArr)<span class="hljs-comment">; // [1, 2, 3, 4, 5]</span>
</code></pre>
<p>这种方法思路直观：</p>
<ul>
<li>创建空数组存储结果</li>
<li>遍历原数组，检查元素是否已存在</li>
<li>不存在则添加到结果数组</li>
</ul>
<p><strong>方法对比</strong>：</p>
<ul>
<li><code>forEach</code>：遍历数组执行操作，不关心返回值</li>
<li><code>map</code>：将数组转换为新数组（1:1映射）</li>
<li><code>filter</code>：根据条件筛选数组元素</li>
</ul>
<h3 data-id="heading-5">5. 对象数组去重（基于特定属性）</h3>
<p>实际开发中，我们经常需要根据对象属性去重：</p>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">users</span> = [
  {id: <span class="hljs-number">1</span>, name: <span class="hljs-string">'Alice'</span>},
  {id: <span class="hljs-number">2</span>, name: <span class="hljs-string">'Bob'</span>},
  {id: <span class="hljs-number">1</span>, name: <span class="hljs-string">'Alice'</span>},  // 重复
  {id: <span class="hljs-number">3</span>, name: <span class="hljs-string">'Charlie'</span>}
]<span class="hljs-comment">;</span>

// 方法1：使用Map（推荐）
const <span class="hljs-attr">uniqueUsers</span> = [...new Map(users.map(item =&gt; [item.id, item])).values()]<span class="hljs-comment">;</span>

// 方法2：使用reduce
const <span class="hljs-attr">uniqueUsers2</span> = users.reduce((acc, current) =&gt; {
  const <span class="hljs-attr">exists</span> = acc.find(item =&gt; item.id === current.id)<span class="hljs-comment">;</span>
  return exists ? acc : <span class="hljs-section">[...acc, current]</span><span class="hljs-comment">;</span>
}, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>

console.log(uniqueUsers)<span class="hljs-comment">; // 基于id去重后的数组</span>
</code></pre>
<p>Map方法利用键的唯一性，将对象ID作为键，对象本身作为值，最后通过<code>values()</code>获取去重后的对象。</p>
<h3 data-id="heading-6">6. 复杂数据类型去重</h3>
<p>对于包含对象、数组等复杂数据类型的数组：</p>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">complexArr</span> = [{a:<span class="hljs-number">1</span>}, {a:<span class="hljs-number">1</span>}, [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>], [<span class="hljs-number">1</span>,<span class="hljs-number">2</span>], <span class="hljs-string">'hello'</span>, <span class="hljs-string">'hello'</span>]<span class="hljs-comment">;</span>

const <span class="hljs-attr">uniqueComplex</span> = complexArr.reduce((acc, current) =&gt; {
  const <span class="hljs-attr">isDuplicate</span> = acc.some(item =&gt;
    JSON.stringify(item) === JSON.stringify(current)
  )<span class="hljs-comment">;</span>
  return isDuplicate ? acc : <span class="hljs-section">[...acc, current]</span><span class="hljs-comment">;</span>
}, <span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>

console.log(uniqueComplex)<span class="hljs-comment">; // 每个元素都是唯一的</span>
</code></pre>
<p>这种方法通过<code>JSON.stringify</code>将对象转为字符串进行比较，但要注意对象属性顺序必须一致。</p>
<h3 data-id="heading-7">7. 排序后去重（适用于可排序数据）</h3>
<p>javascript</p>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">arr</span> = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>]<span class="hljs-comment">;</span>
const <span class="hljs-attr">uniqueArr</span> = arr
  .sort((a, b) =&gt; a - b)
  .filter((item, index, array) =&gt;
    <span class="hljs-attr">index</span> === <span class="hljs-number">0</span> || item !== array[index - <span class="hljs-number">1</span>]
  )<span class="hljs-comment">;</span>
console.log(uniqueArr)<span class="hljs-comment">; // [1, 2, 3, 4, 5]</span>
</code></pre>
<p>先排序，然后过滤掉与前一元素相同的元素。注意这会改变原数组的顺序。</p>
<h3 data-id="heading-8">性能对比与使用建议</h3>

























<table><thead><tr><th>方法</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>Set</strong></td><td>简单数据类型，现代浏览器</td></tr><tr><td><strong>filter+indexOf</strong></td><td>兼容性要求高</td></tr><tr><td><strong>reduce</strong></td><td>需要自定义逻辑</td></tr><tr><td><strong>Map对象</strong></td><td>对象数组去重</td></tr></tbody></table>
<p><strong>日常开发建议</strong>：</p>
<ul>
<li>简单数组去重：优先使用 <code>[...new Set(arr)]</code></li>
<li>对象数组去重：使用 <code>Map</code> 方法</li>
<li>兼容性要求：使用 <code>filter + indexOf</code></li>
<li>复杂数据：使用 <code>reduce + JSON.stringify</code></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[关于微前端框架wujie的一次企业级应用实践demo？]]></title>    <link>https://juejin.cn/post/7577713754563346484</link>    <guid>https://juejin.cn/post/7577713754563346484</guid>    <pubDate>2025-11-30T05:33:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577713754563346484" data-draft-id="7350181789530374195" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="关于微前端框架wujie的一次企业级应用实践demo？"/> <meta itemprop="keywords" content="前端,Vue.js,React.js"/> <meta itemprop="datePublished" content="2025-11-30T05:33:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="寻找光_sxy"/> <meta itemprop="url" content="https://juejin.cn/user/1495754537711661"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            关于微前端框架wujie的一次企业级应用实践demo？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1495754537711661/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    寻找光_sxy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T05:33:25.000Z" title="Sun Nov 30 2025 05:33:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin:30px 0 10px;color:#cca152;position:relative;padding-left:50px;border-bottom:2px solid rgba(209,163,78,.6);padding-bottom:0}.markdown-body h1{font-size:30px}.markdown-body h1:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:80%;bottom:-10px;left:-2px}.markdown-body h2{font-size:24px}.markdown-body h2:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:70%;bottom:-15px;left:-1px}.markdown-body h3{font-size:18px}.markdown-body h3:before{content:"";width:50px;height:42px;display:block;position:absolute;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACcAAAAhBAMAAACo1K8bAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAACxMAAAsTAQCanBgAAAAnUExURUdwTMyhUsqkUMyhUsyiUcyhUsyhUsyhUcyhUsyhUs2hUtytWNWoVX44si8AAAAKdFJOUwD8Bfcge95QncCWSSDAAAABh0lEQVQoz2WSPUvDQBjHjyPSOB7drh2OUOs36NA6pKAFwaEo4tDFIUWxGYLgKw4BEYUuHaQg7XJ0kccsUmrT2qUUQZp8KO/y1hSfIYEf/5eHu0MoGU1+sIbSw5Bypd92S+dWWrd34b15vuOPY4QxuvtYZp0lIVk3Zgjt+5zkh12AvBHnbW85BOjXySPwhc5CYcY0OdDh5dEUqIEj4cN8Dty3a1MqYJS4MaWU5wzVLwMMxqGSNQgA/VFa4gf50yhxSUW+db8ACa2gBxfnABVDFYHCPYrc7TLwCepJM8/ZoVsRwpxdHEozHUXd6idwVzFFM5BFmIhQVQjrNdnCvdd48wblI2VHtsAZioSsTYVwLoXvjMXH1icuNgPhQE+Ot1+xi8HeA3d1Df1f1JPVUOmsYLujBjuSySqSXYt+yTwbJ0pcyIhqTrxkn0BazRLizJosxRBued+z0jPD6VewOXl5utHRGmMNK3k0iTkzxpq2/oIQO6gLprF12kT/R20eyzlcg7iwK0dPsz/ibpdsCHweWwAAAABJRU5ErkJggg==) 0 0 no-repeat;background-size:60%;bottom:-19px;left:-2px}.markdown-body h4{font-size:16px;padding-left:0;border-bottom:1px solid rgba(209,163,78,.6)}.markdown-body h5{font-size:15px;padding-left:0}.markdown-body em{color:#cca152}.markdown-body del{text-decoration-color:#cca152;text-decoration-thickness:2px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:80%;margin:6px auto;box-shadow:0 6px 15px #8e8e8e;display:block;margin:20px auto!important;object-fit:contain;border-radius:8px}.markdown-body hr{border:none;border-top:2px solid #e0c9a1;margin-top:32px 0}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background:#f6efde;color:#b69454;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Mono,Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;background:#fef6e1;border-radius:4px;box-shadow:0 0 8px hsla(0,0%,47%,.45)}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAOCAMAAABaWb9VAAAABGdBTUEAALGPC/xhBQAAAAFzUkdCAK7OHOkAAAFZaVRYdFhNTDpjb20uYWRvYmUueG1wAAAAAAA8eDp4bXBtZXRhIHhtbG5zOng9ImFkb2JlOm5zOm1ldGEvIiB4OnhtcHRrPSJYTVAgQ29yZSA1LjQuMCI+CiAgIDxyZGY6UkRGIHhtbG5zOnJkZj0iaHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyI+CiAgICAgIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PSIiCiAgICAgICAgICAgIHhtbG5zOnRpZmY9Imh0dHA6Ly9ucy5hZG9iZS5jb20vdGlmZi8xLjAvIj4KICAgICAgICAgPHRpZmY6T3JpZW50YXRpb24+MTwvdGlmZjpPcmllbnRhdGlvbj4KICAgICAgPC9yZGY6RGVzY3JpcHRpb24+CiAgIDwvcmRmOlJERj4KPC94OnhtcG1ldGE+CkzCJ1kAAAAJcEhZcwAADsQAAA7EAZUrDhsAAACHUExURUdwTMxCKdc8NvdYT/9hVyLJPABBAGubKNiIOv+/K+ytJBakH9aZG+5QR5VZDOBDPhmtJ8+VGuGjH/CwJR26MR6+NBq0LPW1KBmwKetNRfJUTONHP92fHuSmIeFEPhu3LR29M/BTS+mqIuqsI5qdHyLKPP++Kv9gVf9lW//KLSXXQCTQP//FLMVm5KQAAAAldFJOUwAlPPz7+woBBPu8Mzu+FlRRKmvnweeG+Wqg6mVNXmuc1OCbmjZJWF/9AAABKklEQVQoz3WS6XaCMBCFRzAM++KGsqhtDwES3//5OtmA2uP9A9zwzRoAgBC0QgQrdA68OZsDr229YGHoIEj7Pl0ZOgjKa5lYJ4Rd1vijn3nuD4Qurjmv48o6RFyfbGDnS6DeEXZfk5ZfuBhdPb9I87ECNMh1EFJKIU6agWzaa01NbmLkxznSmmObJBkkUxrERf3i+ftRiZi7ShPCYY64UhTx1AR5CDYoMXkOKEY7GmTcTzeD/FiER68DfSLgSRqEIBoB3P8h3x8RZhBXGJGusJdD6rfCBl0YqvZNkrV9zej2cWlfJWG6fRpyM41qYH+GTPPi2yFLQYC0Qybm5o96lW77kMbcrBKtgeWTsthVamNXFF4I6x0DTPuugsVRFyYpyxzWqNvHJwed8ws7QyP1UwjNjwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fef6e1}.markdown-body a{text-decoration:none;color:#d8ac5a;border-bottom:1px solid #d8ac5a}.markdown-body a:active,.markdown-body a:hover{color:#93753f;border-color:#93753f}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f4e8c7;border-collapse:collapse}.markdown-body thead{background:rgba(255,227,176,.6588235294);text-align:left;display:table-header-group;border-bottom:1px solid rgba(255,227,176,.6588235294)}.markdown-body tbody{background:rgba(255,247,229,.3882352941)}.markdown-body td,.markdown-body th{padding:7px;line-height:24px;min-width:100px}.markdown-body blockquote{color:#bd954f;padding:1px 23px;margin:22px 0;border-left:4px solid #dcb267;background-color:#fff7e5}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol .task-list-item,.markdown-body ul .task-list-item{list-style:none}.markdown-body ol li{padding-left:6px}.markdown-body::marker{color:#dcb267}.markdown-body .contains-task-list{padding-left:0}.markdown-body .contains-task-list .task-list-item{list-style:none;position:relative}.markdown-body .contains-task-list .task-list-item input[type=checkbox]{position:relative;top:2px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:before{content:"";display:inline-block;height:12px;width:12px;position:absolute;left:-2px;top:-2px;border:2px solid #cda152;border-radius:5px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:checked{position:relative;top:2px}.markdown-body .contains-task-list .task-list-item input[type=checkbox]:checked:before{border:none;content:"";display:inline-block;height:17px;width:17px;position:absolute;left:-2px;top:-2px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAFo9M/3AAAAAXNSR0IArs4c6QAAAYhJREFUOBFjYACC0/MDGsDEiyvr/zOCeUwMJxn/A8HZRUEMYBFGJsZ6kFoQYALiAyAGCgDpA+sFijKeWRj4H1kWpIWBW1SDQcm+BCzOAiK/vr7BcO/gDbAAI4hE1waWgRBnmWCGIwkyKFjnwow0BhsJk9QLncvw5dV1oPE9MCEGmBWrgCKhcFEowyR+PSNYwemFAZ4M/xjMkRWYJm5oAPFB/joDpI1BHHQANgGPDxj+//vfCA4IdJ3GcevgQnAFhlHLwYIgSVA0wABcwY3tFQzokiBFGIEP0wmigW5wZAK5FFkQib0a6NUDcEmgb7AGFpIGZOZqoMFhIAFQknEAJpn9yLLEssFOBCp2IFaDkl0xg6C8FbJyB3gowUS5RdQYBORQYpVB1iwVHIIMwJh///AYTCmYRklNIBFmNi4GeYt0BhnjeIa3dw8wSBlEgDUhxw2yCRgGfHp2geHiqiSwUwUVrFAiFVkjjA1LrjgTHEwhFvosMCZM4NEIUoAtWWNoBGZ70/gN22HiAD2uhAzsYNBZAAAAAElFTkSuQmCC) 0 0 no-repeat;background-size:100%}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>本文将介绍我一种<code>wujie</code>的一次具体的应用，包括使用的场景、方式等等，完成一个具体的demo；</p>
<h2 data-id="heading-1">为什么要用微前端</h2>
<p>事情是这样的，我们之前的业务有一个<code>vue3+ts+vite</code>的后台项目，后来公司决定新开发一个新的业务线，但是由于人力有限，如果重新搭建一个新的后台时间和人力成本较大都，尤其是其中的<code>权限</code>、<code>登录</code>功能的设计都比较复杂，所以我们综合考虑，有没有一种可以直接用旧后台的权限和登录功能，然后其它功能完全隔离的，且旧后台和新后台可用两个部门的人来开发，可以独立开发、测试、部署，甚至技术栈也可以不受影响呢？这里我们想到了微前端方案；</p>
<h2 data-id="heading-2">微前端方案选择</h2>
<p>我们经过调研，目光逐步瞄向了两种微前端的方案:<a href="https://link.juejin.cn?target=https%3A%2F%2Fwujie-micro.github.io%2Fdoc%2F" target="_blank" title="https://wujie-micro.github.io/doc/" ref="nofollow noopener noreferrer">无界</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fqiankun.umijs.org%2Fzh" target="_blank" title="https://qiankun.umijs.org/zh" ref="nofollow noopener noreferrer">乾坤</a>；</p>
<p>对比我们的业务，经过调研发现无界相比于乾坤更有优势:</p>
<ul>
<li>1、对旧后台项目影响较小，侵入程度低：只需要在旧有后台的项目上新起page页，以及新增一个路由即可；</li>
<li>2、可单独开发、部署：子应用可以单独开发、部署，也可以使用一个全新的技术栈，即使生产环境无界挂了，出现问题了，也可以直接访问子应用；</li>
</ul>
<p>综上两种原因，我们决定使用无界的方案；</p>
<h2 data-id="heading-3">怎么用无界（demo演示）</h2>
<p>我们的主应用是<code>vue3</code>，这里将子应用通过菜单栏的形式嵌入到父应用中间，点击菜单即可进入到子应用</p>
<p><strong>登录场景</strong>，在子应用请求时，若发现登录失效，通过子组件通信<code>window.$wujie.bus.$emit('notLogin')</code>向父应用传递未登录消息，父应用执行后续逻辑</p>
<p><strong>权限逻辑</strong>，天然就互通，当子应用的<code>菜单权限</code>在某些角色下不可见时，在父应用下直接隐藏掉菜单就行；如果是子应用下<code>按钮权限</code>等功能权限时，可在子应用单独再次调用权限接口，或通过父子应用通信方式获取权限信息
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9c1e77b2059e49ed8bf24cc1f3ebb356~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a-75om-5YWJX3N4eQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765085605&amp;x-signature=1XXEN7ik87e2t3t3jRdIUJ%2FK5vM%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">具体步骤</h2>
<h3 data-id="heading-5">父应用改造</h3>
<ul>
<li>下载新依赖</li>
<li>wujie相关文件</li>
<li>路由
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cbe03c9176f246e799289572f8820601~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a-75om-5YWJX3N4eQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765085605&amp;x-signature=YS5cSbUIJmQ0DNrIrSWwPlI8%2FOQ%3D" alt="image.png" loading="lazy"/></li>
</ul>
<h4 data-id="heading-6">下载相关依赖</h4>
<pre><code class="hljs language-js" lang="js">pnpm install wujie-vue3
</code></pre>
<h4 data-id="heading-7">创建wujie文件</h4>
<p>用于补充<code>wujie</code>的相关逻辑：</p>
<ul>
<li><code>wujie</code>的<code>template</code>及<code>相关属性</code>
<ul>
<li><code>name</code>: 子应用唯一标识</li>
<li><code>url</code>: 子应用运行地址</li>
<li><code>props</code>：向子应用传递的参数</li>
</ul>
</li>
<li>父子应用通信
<ul>
<li>通知子应用路由发生改变</li>
<li>通知子应用其他数据</li>
<li>子应用告知父应用未登录</li>
<li>子应用告知父应用其他信息
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf33bbea958246a6943ccb1638f33669~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a-75om-5YWJX3N4eQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765085605&amp;x-signature=eNUjHxP%2BsNOsC%2BydBtLw4Hha5AE%3D" alt="image.png" loading="lazy"/></li>
</ul>
</li>
</ul>
<pre><code class="hljs language-js" lang="js">&lt;template&gt;
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"main-app"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Vue3 主应用<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 嵌入 React 子应用 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">WujieVue</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"100%"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"600px"</span> <span class="hljs-attr">:url</span>=<span class="hljs-string">"subAppUrl"</span> <span class="hljs-attr">:name</span>=<span class="hljs-string">"subAppName"</span> <span class="hljs-attr">:props</span>=<span class="hljs-string">"subAppProps"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
&lt;/template&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">setup</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"ts"</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;
<span class="hljs-keyword">import</span> { useRouter } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue-router"</span>;
<span class="hljs-keyword">import</span> { watch } <span class="hljs-keyword">from</span> <span class="hljs-string">"vue"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">WujieVue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"wujie-vue3"</span>;

<span class="hljs-keyword">const</span> { bus } = <span class="hljs-title class_">WujieVue</span>;

<span class="hljs-comment">// 子应用配置（React 子应用的运行地址，后续启动子应用后会用到）</span>
<span class="hljs-keyword">const</span> subAppName = <span class="hljs-title function_">ref</span>(<span class="hljs-string">"react-sub-app"</span>); <span class="hljs-comment">// 子应用唯一标识（必须唯一）</span>
<span class="hljs-keyword">const</span> subAppUrl = <span class="hljs-title function_">ref</span>(<span class="hljs-string">"http://localhost:1074/#/wujieDemo1"</span>); <span class="hljs-comment">// 子应用端口（后续配置 React 子应用为 3001）</span>

<span class="hljs-comment">// 主应用向子应用传递的 props（可选）</span>
<span class="hljs-keyword">const</span> subAppProps = <span class="hljs-title function_">ref</span>({
  <span class="hljs-attr">mainAppName</span>: <span class="hljs-string">"Vue3 主应用"</span>,
  <span class="hljs-attr">token</span>: <span class="hljs-string">"main-app-token-123"</span>,
});

<span class="hljs-keyword">const</span> router = <span class="hljs-title function_">useRouter</span>();
<span class="hljs-comment">/** 监听子应用的数据 */</span>
bus.$on(<span class="hljs-string">"subAppData"</span>, <span class="hljs-function">(<span class="hljs-params">data: { type: string, payload?: any }</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> { type } = data;
  <span class="hljs-keyword">if</span> (type == <span class="hljs-string">"noLogin"</span>) {
    <span class="hljs-title function_">alert</span>(<span class="hljs-string">"未登录"</span>)
  }
});

<span class="hljs-comment">/** 监听子应用的数据 */</span>


<span class="hljs-title function_">watch</span>(
  <span class="hljs-function">() =&gt;</span> router.<span class="hljs-property">currentRoute</span>.<span class="hljs-property">value</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">subAppPath</span>,
  <span class="hljs-function">(<span class="hljs-params">newVal</span>) =&gt;</span> {
    <span class="hljs-keyword">if</span> (newVal === <span class="hljs-literal">undefined</span>) <span class="hljs-keyword">return</span>;
    bus.$emit(<span class="hljs-string">"routeChange"</span>, newVal);
  },
  {
    <span class="hljs-attr">immediate</span>: <span class="hljs-literal">true</span>,
  }
);
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<h4 data-id="heading-8">创建wujie路由</h4>
<p>这里新建了一个路由的文件<code>wujieRouter.ts</code></p>
<p>通过监听<code>subAppPath</code>去判断跳转到子应用对应路由，且这里的<code>subAppPath</code>其实对应的是子应用的路由<code>path</code></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> routerName = <span class="hljs-string">"wujiePage"</span>;

<span class="hljs-keyword">const</span> wujieRouters = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">`/<span class="hljs-subst">${routerName}</span>`</span>,
    <span class="hljs-attr">name</span>: <span class="hljs-string">`<span class="hljs-subst">${routerName}</span>`</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"@/pages/wujie/index.vue"</span>),
    <span class="hljs-attr">meta</span>: {
      <span class="hljs-attr">title</span>: <span class="hljs-string">'新项目-react'</span>, <span class="hljs-comment">// 菜单显示文本</span>
      <span class="hljs-attr">icon</span>: <span class="hljs-string">'CreditCard'</span>, <span class="hljs-comment">// 菜单图标</span>
      <span class="hljs-attr">hidden</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">level</span>: <span class="hljs-number">0</span>,
    },
    <span class="hljs-attr">children</span>: [
      {
        <span class="hljs-attr">path</span>: <span class="hljs-string">"wujieDemo1"</span>, <span class="hljs-comment">// 子路由直接使用相对路径，不要包含父路由名称</span>
        <span class="hljs-attr">name</span>: <span class="hljs-string">`<span class="hljs-subst">${routerName}</span>wujieDemo1`</span>, <span class="hljs-comment">// 名称保持唯一，不要使用斜杠</span>
        <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"@/pages/wujie/wujie.vue"</span>),
        <span class="hljs-attr">meta</span>: {
          <span class="hljs-attr">title</span>: <span class="hljs-string">'wujieDemo1'</span>, <span class="hljs-comment">// 菜单显示文本</span>
          <span class="hljs-attr">icon</span>: <span class="hljs-string">'Present'</span>, <span class="hljs-comment">// 子菜单图标</span>
          <span class="hljs-attr">hidden</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">level</span>: <span class="hljs-number">1</span>,
          <span class="hljs-attr">subAppPath</span>: <span class="hljs-string">"/wujieDemo1"</span>,
        },
      },
      {
        <span class="hljs-attr">path</span>: <span class="hljs-string">"wujieDemo2"</span>, <span class="hljs-comment">// 子路由直接使用相对路径，不要包含父路由名称</span>
        <span class="hljs-attr">name</span>: <span class="hljs-string">`<span class="hljs-subst">${routerName}</span>wujieDemo2`</span>, <span class="hljs-comment">// 名称保持唯一，不要使用斜杠</span>
        <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"@/pages/wujie/wujie.vue"</span>),
        <span class="hljs-attr">meta</span>: {
          <span class="hljs-attr">title</span>: <span class="hljs-string">'wujieDemo2'</span>, <span class="hljs-comment">// 菜单显示文本</span>
          <span class="hljs-attr">icon</span>: <span class="hljs-string">'Present'</span>, <span class="hljs-comment">// 子菜单图标</span>
          <span class="hljs-attr">hidden</span>: <span class="hljs-literal">false</span>,
          <span class="hljs-attr">level</span>: <span class="hljs-number">1</span>,
          <span class="hljs-attr">subAppPath</span>: <span class="hljs-string">"/wujieDemo2"</span>,
        },
      },
    ]
  },

]

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> wujieRouters;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/446f3a755514463ab0de858e42137875~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a-75om-5YWJX3N4eQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765085605&amp;x-signature=WLK9LYrIhROK6f5uG998Vq9i1lc%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-9">子应用改造</h3>
<ul>
<li>运行环境判断</li>
<li>路由通信</li>
<li>嵌入子页面</li>
<li>路由</li>
<li>接口响应拦截器</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aec99d36bd70487d837dfe398a774ea2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5a-75om-5YWJX3N4eQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765085605&amp;x-signature=X8eaaEjF3qPi5IP5dApZtd7bbL4%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-10">运行环境判断</h4>
<p>这里我们在<code>main.tsx</code>文件通过判断<code>window.$wujie</code>属性是否存在，来判断当前的运行环境是独立运行还是微前端环境</p>
<p><strong>原理</strong>：<code>wujie</code>会自动给子应用的<code>window</code>上挂载一个<code>$wujie</code>对象</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">StrictMode</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;
<span class="hljs-keyword">import</span> { createRoot } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-dom/client"</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">HashRouter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router-dom"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./style/index.css"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./App"</span>;

<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Provider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-redux"</span>;
<span class="hljs-keyword">import</span> { store } <span class="hljs-keyword">from</span> <span class="hljs-string">"./model/store"</span>;

<span class="hljs-comment">// Wujie 子应用生命周期：挂载（主应用嵌入时调用）</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">mount</span> = (<span class="hljs-params">container: HTMLElement | ShadowRoot, props: any</span>) =&gt; {
  <span class="hljs-comment">// 将主应用 props 存入 React 上下文（方便子应用内部使用）</span>
  <span class="hljs-title function_">createRoot</span>(container).<span class="hljs-title function_">render</span>(
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">StrictMode</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Provider</span> <span class="hljs-attr">store</span>=<span class="hljs-string">{store}</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">HashRouter</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">App</span> {<span class="hljs-attr">...props</span>} /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">HashRouter</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Provider</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">StrictMode</span>&gt;</span></span>
  );
};

<span class="hljs-comment">// 判断是否在 Wujie 微前端环境中</span>
<span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>) {
  <span class="hljs-title function_">mount</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"root"</span>)!, <span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>.<span class="hljs-property">props</span>);
} <span class="hljs-keyword">else</span> {
  <span class="hljs-comment">// 独立运行环境（正常启动）</span>
  <span class="hljs-title function_">mount</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"root"</span>)!, {
    <span class="hljs-attr">mainAppName</span>: <span class="hljs-string">"独立运行"</span>,
    <span class="hljs-attr">token</span>: <span class="hljs-string">"local-token"</span>,
  });
}

</code></pre>
<h4 data-id="heading-11">路由通信</h4>
<p>在<code>app.tsx</code>文件中修改</p>
<p>子应用监听到父应用的路由发生了改变，立即进行路由跳转</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { router } <span class="hljs-keyword">from</span> <span class="hljs-string">"./router/createRouteConfig"</span>;
<span class="hljs-keyword">import</span> { useNavigate, useRoutes } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router-dom"</span>;
<span class="hljs-keyword">import</span> useLocationChange <span class="hljs-keyword">from</span> <span class="hljs-string">"./router/useLocationChange"</span>;
<span class="hljs-keyword">import</span> routerListener <span class="hljs-keyword">from</span> <span class="hljs-string">"./router/routerListener"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"./style/index.css"</span>;
<span class="hljs-keyword">import</span> { useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>;

<span class="hljs-keyword">const</span> <span class="hljs-title class_">App</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">props: any</span>) {
  <span class="hljs-keyword">const</span> elements = <span class="hljs-title function_">useRoutes</span>(router);
  <span class="hljs-keyword">const</span> navigate = <span class="hljs-title function_">useNavigate</span>();

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> wujieBus = <span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>?.<span class="hljs-property">bus</span>;
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">routeChangeHandler</span> = (<span class="hljs-params">path: string</span>) =&gt; {
      <span class="hljs-title function_">navigate</span>(path);
    };
    wujieBus?.$on(<span class="hljs-string">"routeChange"</span>, routeChangeHandler);
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      wujieBus?.$off(<span class="hljs-string">"routeChange"</span>, routeChangeHandler);
    };                                                                                                                               
  }, [navigate]);

  <span class="hljs-title function_">useLocationChange</span>(<span class="hljs-function">(<span class="hljs-params">to, <span class="hljs-keyword">from</span></span>) =&gt;</span> {
    <span class="hljs-title function_">routerListener</span>(navigate, to, <span class="hljs-keyword">from</span>);
  });
  <span class="hljs-keyword">return</span> elements;
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>;

</code></pre>
<h4 data-id="heading-12">嵌入的子页面</h4>
<p>新建立一个文件用于放嵌入的子页面，且在该子页面中还可以向父应用通信</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title function_">wujieDemo1</span> = (<span class="hljs-params"/>) =&gt; {

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>我是子应用(react)的wujieDemo1<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span>  window.$wujie?.bus.$emit("subAppData", "我是子应用数据")}&gt;向主应用提交数据<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> wujieDemo1;

</code></pre>
<h4 data-id="heading-13">路由</h4>
<p>新建路由用于对应上面的子页面</p>
<p>其中需要注意的是，路由的<code>path</code>需要对应父应用路由上的<code>subAppPath</code></p>
<pre><code class="hljs language-js" lang="js">......
  {
      <span class="hljs-attr">name</span>: <span class="hljs-string">"wujieDemo1"</span>,
      <span class="hljs-attr">path</span>: <span class="hljs-string">"/wujieDemo1"</span>,
      <span class="hljs-attr">component</span>: <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">"../page/wujiePage/wujieDemo1/index"</span>)),
      <span class="hljs-attr">isMenu</span>: <span class="hljs-literal">false</span>,
    },
......
</code></pre>
<h4 data-id="heading-14">接口响应拦截器</h4>
<p>在响应拦截器中，主要是针对<strong>未登录</strong>的场景，在未登录时，告知父应用</p>
<p>这里也做了运行环境的判断，用于<strong>判断</strong>是进入子应用的登录页面还是父应用的登录页面</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 将方法封装成一个函数</span>
<span class="hljs-keyword">const</span> http = <span class="hljs-keyword">async</span> (<span class="hljs-attr">config</span>: <span class="hljs-title class_">IAxiosParam</span>): <span class="hljs-title class_">Promise</span>&lt;any&gt; =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">request</span>(config)
    .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res: IResponse</span>) =&gt;</span> {
      <span class="hljs-keyword">switch</span> (res.<span class="hljs-property">code</span>) {
        <span class="hljs-keyword">case</span> <span class="hljs-title class_">ResCode</span>.<span class="hljs-property">notLogin</span>:
          <span class="hljs-comment">// 未登录</span>
          <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>) {
            <span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>?.<span class="hljs-property">bus</span>.$emit(<span class="hljs-string">"subAppData"</span>, {
              <span class="hljs-attr">type</span>: <span class="hljs-string">"noLogin"</span>
            })
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">href</span> = <span class="hljs-string">"/login"</span>;
          }
          <span class="hljs-keyword">break</span>;
      }

      <span class="hljs-keyword">if</span> (res.<span class="hljs-property">code</span> !== <span class="hljs-number">0</span> &amp;&amp; !config.<span class="hljs-property">noAlert</span>) {
        <span class="hljs-comment">// 异常提示</span>
        <span class="hljs-title function_">alert</span>(res.<span class="hljs-property">msg</span> || <span class="hljs-string">"出现问题啦~"</span>);
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-keyword">return</span> config.<span class="hljs-property">needRes</span> ? res : res.<span class="hljs-property">data</span>;
    })
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(res);
    });
};
</code></pre>
<h2 data-id="heading-15">总结</h2>
<p>这里我完成了一个基础的demo，在时间的应用还有一些需要注意或优化的点：</p>
<ul>
<li>子应用的运行地址可配置化</li>
<li>子应用的预加载与保活</li>
<li>多个子应用的配置</li>
</ul>
<p>后续可根据自己的实际场景来配置</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[类属性公共还是私有]]></title>    <link>https://juejin.cn/post/7577737385954689034</link>    <guid>https://juejin.cn/post/7577737385954689034</guid>    <pubDate>2025-11-30T05:37:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577737385954689034" data-draft-id="7577689171223412786" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="类属性公共还是私有"/> <meta itemprop="keywords" content="TypeScript,JavaScript"/> <meta itemprop="datePublished" content="2025-11-30T05:37:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Robet"/> <meta itemprop="url" content="https://juejin.cn/user/193141028175320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            类属性公共还是私有
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/193141028175320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Robet
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T05:37:33.000Z" title="Sun Nov 30 2025 05:37:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>决定一个类的属性（成员变量）是<strong>公共（public）还是私有（private）</strong> ，是面向对象设计中的核心问题之一。这不仅关乎代码封装性，还直接影响系统的<strong>可维护性、可扩展性和健壮性</strong>。</p>
<p>以下是系统化的思考框架和实用原则，帮助你做出合理决策：</p>
<hr/>
<h2 data-id="heading-0">🔑 核心原则：<strong>最小暴露原则（Principle of Least Exposure）</strong></h2>
<blockquote>
<p><strong>“只暴露必须暴露的内容，其余一律隐藏。”</strong></p>
</blockquote>
<p>换句话说：<br/>
✅ <strong>默认私有</strong>，只有当<strong>确实需要外部访问</strong>时，才设为公共。</p>
<hr/>
<h2 data-id="heading-1">一、判断标准：问自己这几个问题</h2>
<h3 data-id="heading-2">1. <strong>外部是否需要直接读取这个值？</strong></h3>
<ul>
<li>✅ 是 → 考虑 <code>public</code> 或提供 <strong>getter</strong></li>
<li>❌ 否 → <code>private</code></li>
</ul>
<blockquote>
<p>📌 示例：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BankAccount</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">balance</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 外部不应直接读余额（需鉴权/日志）</span>
  <span class="hljs-title function_">getBalance</span>(): <span class="hljs-built_in">number</span> { <span class="hljs-comment">/* ... */</span> } <span class="hljs-comment">// 通过方法控制访问</span>
}
</code></pre>
</blockquote>
<h3 data-id="heading-3">2. <strong>外部是否需要直接修改这个值？</strong></h3>
<ul>
<li>✅ 是 → 考虑 <code>public</code> 或提供 <strong>setter</strong>（但要谨慎！）</li>
<li>❌ 否 → <code>private</code></li>
</ul>
<blockquote>
<p>⚠️ 直接暴露可变状态容易导致 bug：</p>
<pre><code class="hljs language-ini" lang="ini">// 危险！
<span class="hljs-attr">user.profile.settings.darkMode</span> = <span class="hljs-literal">true</span><span class="hljs-comment">; // 绕过校验/事件通知</span>
</code></pre>
<p>更好的方式：</p>
<pre><code class="hljs language-perl" lang="perl">user.setTheme(<span class="hljs-string">'dark'</span>); <span class="hljs-regexp">//</span> 内部可触发 re-render / save / <span class="hljs-keyword">log</span>
</code></pre>
</blockquote>
<h3 data-id="heading-4">3. <strong>这个属性是否属于“内部实现细节”？</strong></h3>
<ul>
<li>如果未来可能<strong>重构、重命名或删除</strong>它 → <strong>必须私有</strong></li>
<li>如果它是<strong>稳定契约的一部分</strong>（如 API 返回结构）→ 可 public</li>
</ul>
<blockquote>
<p>💡 例子：</p>
<ul>
<li>缓存字段（<code>private cache: Map&lt;...&gt;</code>）→ 私有</li>
<li>用户 ID（<code>public id: string</code>）→ 公共（业务标识）</li>
</ul>
</blockquote>
<h3 data-id="heading-5">4. <strong>是否需要保持对象的“不变性”（Invariants）？</strong></h3>
<p>如果属性参与维持对象的<strong>内部一致性</strong>，则必须私有，并通过方法控制变更。</p>
<blockquote>
<p>📌 示例：矩形的宽高不能为负数</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Rectangle</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">_width</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-attr">_height</span>: <span class="hljs-built_in">number</span>;

  <span class="hljs-title function_">setWidth</span>(<span class="hljs-params">w: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-keyword">if</span> (w &lt; <span class="hljs-number">0</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Width must be positive'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">_width</span> = w;
  }
}
</code></pre>
</blockquote>
<hr/>
<h2 data-id="heading-6">二、优先使用 <strong>方法（Method）而非公共属性</strong></h2>
<p>即使需要“读取”或“设置”，也<strong>优先提供方法</strong>而非直接暴露属性：</p>





















<table><thead><tr><th>场景</th><th>推荐做法</th></tr></thead><tbody><tr><td>读取计算值</td><td><code>getFullName()</code> 而非 <code>fullName</code>（除非是简单数据）</td></tr><tr><td>设置需校验</td><td><code>setEmail(email)</code> 而非 <code>email = ...</code></td></tr><tr><td>触发副作用</td><td><code>activate()</code> 而非 <code>isActive = true</code></td></tr></tbody></table>
<blockquote>
<p>✅ 好处：</p>
<ul>
<li>未来可加日志、权限、缓存、事件通知等逻辑</li>
<li>避免“属性被意外覆盖”导致状态不一致</li>
</ul>
</blockquote>
<hr/>
<h2 data-id="heading-7">三、特殊情况处理</h2>
<h3 data-id="heading-8">✅ 可以公开的属性类型</h3>

























<table><thead><tr><th>类型</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><strong>不可变数据</strong></td><td>初始化后永不改变</td><td><code>public readonly id: string</code></td></tr><tr><td><strong>纯数据载体（DTO/POJO）</strong></td><td>仅用于传输，无行为</td><td><code>interface UserDTO { name: string; email: string }</code></td></tr><tr><td><strong>配置对象</strong></td><td>明确设计为可读写的配置</td><td><code>public config: RenderConfig</code>（但建议用 getter/setter 封装）</td></tr></tbody></table>
<h3 data-id="heading-9">❌ 应避免公开的属性</h3>
<ul>
<li>内部状态（如 <code>isLoading</code>, <code>retryCount</code>）</li>
<li>依赖其他属性的派生值（如 <code>fullName = firstName + lastName</code> → 应用 getter）</li>
<li>敏感数据（密码、token、余额）</li>
<li>复杂对象引用（如 <code>private domElement: HTMLElement</code>）</li>
</ul>
<hr/>
<h2 data-id="heading-10">四、TypeScript / JavaScript 中的具体实践</h2>
<h3 data-id="heading-11">方案 1：使用 <strong><code>#</code> 私有字段（推荐，ES2022+）</strong></h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Timer</span> {
  #startTime: number;
  #isRunning = <span class="hljs-literal">false</span>;

  start() {
    <span class="hljs-keyword">this</span>.#startTime = Date.now();
    <span class="hljs-keyword">this</span>.#isRunning = <span class="hljs-literal">true</span>;
  }

  <span class="hljs-keyword">get</span> elapsed() {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.#isRunning ? Date.now() - <span class="hljs-keyword">this</span>.#startTime : <span class="hljs-number">0</span>;
  }
}
</code></pre>
<blockquote>
<p>✅ 真正私有，运行时安全</p>
</blockquote>
<h3 data-id="heading-12">方案 2：TypeScript <code>private</code>（仅开发时保护）</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Logger</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-attr">logs</span>: <span class="hljs-built_in">string</span>[] = [];
  <span class="hljs-title function_">log</span>(<span class="hljs-params">msg: <span class="hljs-built_in">string</span></span>) { <span class="hljs-variable language_">this</span>.<span class="hljs-property">logs</span>.<span class="hljs-title function_">push</span>(msg); }
}
</code></pre>
<blockquote>
<p>⚠️ 注意：编译后仍可被外部访问，仅防“手误”</p>
</blockquote>
<h3 data-id="heading-13">方案 3：<code>readonly</code> + 公共（用于不可变数据）</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Point</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> x: <span class="hljs-built_in">number</span>,
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> y: <span class="hljs-built_in">number</span>
  </span>) {}
}
</code></pre>
<blockquote>
<p>✅ 安全暴露，且不可修改</p>
</blockquote>
<hr/>
<h2 data-id="heading-14">五、团队协作建议</h2>
<ol>
<li><strong>约定优于配置</strong>：团队统一规则，如“所有状态属性默认私有”</li>
<li><strong>代码审查重点</strong>：检查是否有不必要的 <code>public</code> 属性</li>
<li><strong>文档说明</strong>：对 public 属性明确其用途和约束</li>
</ol>
<hr/>
<h2 data-id="heading-15">✅ 快速决策流程图</h2>
<pre><code class="hljs language-csharp" lang="csharp">这个属性需要被外部访问吗？
│
├─ 否 → <span class="hljs-keyword">private</span> / <span class="hljs-meta">#</span>
│
└─ 是 → 
     ├─ 是否需要修改？ 
     │   ├─ 是 → 提供 setter 方法（而非直接 <span class="hljs-keyword">public</span>）
     │   └─ 否 → 
     │        ├─ 是否不可变？ → <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span>
     │        └─ 是否计算值？ → 提供 getter 方法
     │
     └─ 是否属于稳定数据契约？ → 可 <span class="hljs-keyword">public</span>（如 DTO）
</code></pre>
<hr/>
<h2 data-id="heading-16">🎯 总结：黄金法则</h2>
<blockquote>
<p><strong>“属性代表状态，状态应受控。<br/>
暴露行为（方法），而非状态（属性）。”</strong></p>
</blockquote>
<ul>
<li>默认 <strong>私有</strong>（<code>private</code> 或 <code>#</code>）</li>
<li>仅在<strong>必要且安全</strong>时暴露为公共</li>
<li>优先通过 <strong>方法</strong> 控制访问，而非直接暴露字段</li>
<li>对于<strong>纯数据对象</strong>（如 API 响应），可适当放宽</li>
</ul>
<p>这样做，你的类将更健壮、更易测试、更易演进。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[性能优化：从“用户想走”到“愿意留下”的1.8秒]]></title>    <link>https://juejin.cn/post/7577737385954705418</link>    <guid>https://juejin.cn/post/7577737385954705418</guid>    <pubDate>2025-11-30T05:37:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577737385954705418" data-draft-id="7576935292427681834" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="性能优化：从“用户想走”到“愿意留下”的1.8秒"/> <meta itemprop="keywords" content="前端,面试"/> <meta itemprop="datePublished" content="2025-11-30T05:37:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小时前端"/> <meta itemprop="url" content="https://juejin.cn/user/1197805741808339"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            性能优化：从“用户想走”到“愿意留下”的1.8秒
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1197805741808339/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小时前端
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T05:37:44.000Z" title="Sun Nov 30 2025 05:37:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><h2 data-id="heading-0">前言</h2>
<p>"今天，我们来聊聊性能优化。在我们团队看来，性能优化不是简单的'减少加载时间'的技术活，而是<strong>数字世界的'流体力学'工程</strong>。我们试图在有限的带宽的约束下，让用户体验如流水般顺滑自然。"</p>
<p>"因此，当我考察一个候选人对性能优化的理解时，我核心关注的不是他知道多少种优化技巧，而是他是否具备一种 <strong>'性能优化'</strong> 的视角。他是否明白，优化某个指标，不仅是应用某个最佳实践，更是要理解整个<strong>渲染流水线、网络协议栈和运行时环境</strong>。"</p>
<p>"这意味着，你需要去理解每个性能指标背后的运行机制——浏览器是如何构建渲染树的？JavaScript引擎是如何执行代码的？网络请求是如何被调度和处理的？如果对细节不太了解，可以阅读这篇文章<a href="https://juejin.cn/post/7573193563044528182" target="_blank" title="https://juejin.cn/post/7573193563044528182">前端面试经典题：从URL到页面展示，这一次让你彻底搞懂</a>"</p>
<p>"所以，今天的问题不仅仅是关于'如何减少LCP'这些具体技巧，我更想听到的是，你如何<strong>系统性</strong>地思考、诊断和解决性能问题。让我们就从这里开始聊起吧。"</p>
<p>当我问起这个问题时，我不仅仅是想听几个优化技巧。我想考察的是：</p>
<ol>
<li><strong>深度</strong>：你对性能优化的理解是否停留在"用个懒加载"的表面？</li>
<li><strong>广度</strong>：你是否了解从网络到渲染的全链路性能影响因素？</li>
<li><strong>实践</strong>：你是否有过真实的性能优化经验，或者至少深入分析过性能瓶颈？</li>
<li><strong>数据驱动</strong>：你是那个凭感觉优化的人，还是能基于数据做出精准决策的人？</li>
</ol>
<h2 data-id="heading-1">一、核心理念：性能 ≠ 快</h2>
<p>首先要明确，性能优化的核心是在<strong>技术理想</strong>与<strong>用户感知</strong>之间寻找最佳平衡点。</p>
<ul>
<li><strong>技术指标</strong>站在天平的最右端：精确的毫秒数，但可能偏离用户感受</li>
<li><strong>用户感知</strong>站在最左端：主观的"快慢"，但难以量化衡量</li>
<li><strong>现代性能优化</strong>分布在中间的广阔光谱上，每个点代表不同的权衡</li>
</ul>
<p>所以，性能优化的本质是<strong>技术指标与用户体验的匹配游戏</strong>。</p>
<h2 data-id="heading-2">二、性能优化的演进：从"减少字节"到"提升感知"</h2>
<p><strong>性能优化的三次进化</strong></p>
<ul>
<li>
<p><strong>第一代：资源优化时代</strong></p>
<ul>
<li><strong>核心思路</strong>："让文件更小，让请求更少"</li>
<li><strong>关键技术</strong>：Gzip压缩、图片优化、CSS Sprites、减少HTTP请求</li>
<li><strong>突破性</strong>：首次系统性地从资源层面解决性能问题</li>
<li><strong>局限性</strong>：过度聚焦于技术指标，忽略用户感知</li>
</ul>
</li>
<li>
<p><strong>第二代：渲染优化时代</strong></p>
<ul>
<li><strong>核心思路</strong>："让关键内容先出来"</li>
<li><strong>关键技术</strong>：关键CSS内联、异步加载、懒加载、服务端渲染</li>
<li><strong>突破性</strong>：开始关注用户看到内容的时机，而非单纯的技术指标</li>
<li><strong>局限性</strong>：缺乏统一的衡量标准，优化方向分散</li>
</ul>
</li>
<li>
<p><strong>第三代：用户体验量化时代</strong></p>
<ul>
<li><strong>核心思路</strong>："用科学指标衡量用户体验"</li>
<li><strong>关键技术</strong>：Core Web Vitals、Performance API、真实用户监控</li>
<li><strong>突破性</strong>：建立了标准化的用户体验衡量体系</li>
<li><strong>局限性</strong>：指标之间存在权衡，需要业务层面的决策</li>
</ul>
</li>
</ul>
<p><strong>如何回答（展现你的历史观）</strong>
"性能优化的演进本质上是不断重新定义'性能'含义的过程。从早期的关注服务器响应时间，到中期的关注首屏渲染，再到现在的关注用户核心任务完成度，每一次演进都在解决前一代的核心局限。"</p>
<h2 data-id="heading-3">三、现代性能优化深度对比：不只是技术技巧</h2>
<p><strong>核心维度对比</strong></p>
<ul>
<li>
<p><strong>加载性能：用户的第一印象</strong></p>
<ul>
<li><strong>LCP</strong>：衡量主要内容加载，直接影响用户对速度的感知</li>
<li><strong>优化策略</strong>：图片优化、字体优化、服务端渲染、资源预加载</li>
<li><strong>权衡考量</strong>：预加载可能浪费带宽，需要基于用户行为数据决策</li>
</ul>
</li>
<li>
<p><strong>交互响应：使用的流畅度</strong></p>
<ul>
<li><strong>FID/INP</strong>：衡量输入响应，决定用户操作的顺滑程度</li>
<li><strong>优化策略</strong>：代码分割、长任务拆分、Web Worker、优化JavaScript执行</li>
<li><strong>权衡考量</strong>：过度拆分可能增加复杂度，需要平衡可维护性</li>
</ul>
</li>
<li>
<p><strong>视觉稳定性：体验的可靠性</strong></p>
<ul>
<li><strong>CLS</strong>：衡量布局偏移，影响用户的阅读和操作精度</li>
<li><strong>优化策略</strong>：设置尺寸属性、预留空间、避免动态插入内容</li>
<li><strong>权衡考量</strong>：预留空间可能造成空白，需要设计系统配合</li>
</ul>
</li>
</ul>
<p><strong>如何回答（展现你的技术判断力）</strong>
"当我们对比现代性能优化指标时，实际上是在对比不同的用户体验维度。LCP关注的是'什么时候能用'，FID关注的是'用起来卡不卡'，CLS关注的是'用起来准不准'。好的性能优化不是单独优化某个指标，而是找到这些指标在具体业务场景下的最佳平衡点。"</p>
<h2 data-id="heading-4">四、<strong>实战：一个LCP从4.2s到1.8s的优化案例</strong></h2>
<p>"理论总是灰色的，而性能优化的实践之树常青。下面我想分享一个真实的产品详情页优化案例，看看我们如何将一个 <strong>4.2秒的LCP</strong> 优化到 <strong>1.8秒</strong>。"</p>
<h4 data-id="heading-5">问题诊断：拨开迷雾，定位七重瓶颈</h4>
<p>我们发现了完整的"性能问题瀑布链"：</p>
<ol>
<li><strong>LCP元素</strong>：首屏的<strong>主商品图</strong></li>
<li><strong>资源加载</strong>：一张450KB的JPEG图片</li>
<li><strong>渲染阻塞</strong>：800KB的Web字体文件</li>
<li><strong>JavaScript竞争</strong>：分析脚本抢占带宽</li>
<li><strong>服务端延迟</strong>：TTFB达到600ms</li>
<li><strong>缓存失效</strong>：CDN配置不当</li>
<li><strong>布局偏移</strong>：CLS高达0.25</li>
</ol>
<p>"诊断性能问题就像破案，你不能只看到表面的'凶器'（那张大图），而是要还原整个'犯罪现场'（从用户点击到屏幕渲染的完整链条）。"</p>
<h4 data-id="heading-6">优化措施：一套组合拳，拳拳到肉</h4>
<p><strong>第一阶段：资源层面的"瘦身"与"调度"</strong></p>
<p><em>技术说明：这个阶段的核心目标是让关键资源变得更小，并让浏览器优先处理它们</em></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 图片格式优化：为不同浏览器提供最合适的图片格式 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">picture</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 现代浏览器优先使用更小的WebP格式 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">srcset</span>=<span class="hljs-string">"hero-image.webp"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/webp"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 老版本浏览器使用优化后的JPEG作为备选 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">source</span> <span class="hljs-attr">srcset</span>=<span class="hljs-string">"hero-image.jpg"</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"image/jpeg"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 最终回退方案 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"hero-image.jpg"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">"产品主图"</span> <span class="hljs-attr">width</span>=<span class="hljs-string">"800"</span> <span class="hljs-attr">height</span>=<span class="hljs-string">"600"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">picture</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 关键图片预加载：告诉浏览器这个图片最重要，请立即下载 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"preload"</span> <span class="hljs-attr">as</span>=<span class="hljs-string">"image"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"hero-image.webp"</span> <span class="hljs-attr">imagesrcset</span>=<span class="hljs-string">"hero-image.webp 800w, hero-image-mobile.webp 400w"</span>&gt;</span>
</code></pre>
<blockquote>
<p>"这里有个关键洞察：我们发现主图虽然通过<code>&lt;picture&gt;</code>元素做了格式优化，但浏览器仍然需要经过图片发现、请求队列、DNS查找、TCP连接等一系列步骤才能开始下载。通过<code>preload</code>，我们告诉浏览器：'这个资源极其重要，请跳过常规队列，立即开始下载'。"</p>
</blockquote>
<p><strong>Preload的实战细节：</strong></p>
<ul>
<li><strong>时机把握</strong>：将preload链接放在HTML的<code>&lt;head&gt;</code>中，确保浏览器在解析完基本结构后立即处理</li>
<li><strong>格式适配</strong>：预加载WebP格式，因为它是我们为现代浏览器准备的最优解</li>
<li><strong>响应式考虑</strong>：通过<code>imagesrcset</code>告知浏览器不同视口宽度下应该加载的图片版本</li>
</ul>
<p><strong>第二阶段：渲染层面的"清障"与"加速"</strong></p>
<p><em>技术说明：这个阶段的目标是消除阻止页面渲染的障碍，让内容尽快显示</em></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 字体加载优化：避免文字显示空白期 */</span>
<span class="hljs-keyword">@font-face</span> {
  <span class="hljs-attribute">font-family</span>: <span class="hljs-string">'ProductSans'</span>;
  <span class="hljs-attribute">src</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">'product-sans-subset.woff2'</span>) <span class="hljs-built_in">format</span>(<span class="hljs-string">'woff2'</span>);
  <span class="hljs-attribute">font-display</span>: swap; <span class="hljs-comment">/* 关键：先显示系统字体，Web字体加载后再替换 */</span>
}
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 非关键脚本延迟加载：让分析工具等不阻塞页面渲染 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">async</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"analytics.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">defer</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"non-critical.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<blockquote>
<p>"字体优化是另一个战场。原本800KB的字体文件不仅下载慢，还会导致文本内容在字体加载完成前完全不可见（FOIT问题）。通过<code>font-display: swap</code>，我们让浏览器先用系统字体显示文字，等Web字体下载完成后再静默替换——用户能立即看到内容，而不是面对一片空白。"</p>
</blockquote>
<p><strong>第三阶段：服务端与基础设施的"深水区"优化</strong></p>
<p><em>技术说明：这个阶段处理网络层面和服务端响应速度的问题</em></p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 提前建立CDN连接：减少DNS查询和TCP握手时间 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"preconnect"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://cdn.our-platform.com"</span>&gt;</span>
</code></pre>
<blockquote>
<p>"你可能想不到，浏览器在真正开始下载图片前，需要先完成'自我介绍'——DNS查询找到CDN服务器的IP地址，然后TCP三次握手建立连接。通过<code>preconnect</code>，我们在浏览器遇到实际图片URL前就提前完成这些步骤，为后续请求节省了宝贵的几百毫秒。"</p>
</blockquote>
<h4 data-id="heading-7">效果评估：数据是最好的证明</h4>
<p>经过上述优化，我们在下一个发布周期后观察到了显著变化：</p>








































<table><thead><tr><th>指标</th><th>优化前</th><th>优化后</th><th>提升幅度</th><th>用户感知</th></tr></thead><tbody><tr><td><strong>LCP</strong></td><td>4.2s</td><td><strong>1.8s</strong></td><td><strong>57%</strong></td><td>从"等待"到"顺畅"</td></tr><tr><td><strong>TTFB</strong></td><td>600ms</td><td>80ms</td><td>87%</td><td>服务器响应更快</td></tr><tr><td><strong>首屏图片体积</strong></td><td>450KB</td><td>120KB</td><td>73%</td><td>流量节省，加载更快</td></tr><tr><td><strong>跳出率</strong></td><td>45%</td><td>32%</td><td><strong>13个百分点</strong></td><td>更多用户留下</td></tr></tbody></table>
<blockquote>
<p>"最让我们兴奋的不是漂亮的性能图表，而是业务数据的正面反馈：<strong>详情页到购物车的转化率提升了 7%</strong>。这实实在在地证明了，性能优化不是技术团队的自我感动，而是真金白银的商业回报。"</p>
</blockquote>
<h4 data-id="heading-8">经验总结：从一次优化到一种能力</h4>
<p>这个案例给我们的启示远不止于技术点：</p>
<ol>
<li><strong>性能优化是系统工程</strong>：它涉及前端、后端、运维多个环节，需要打破团队壁垒协同作战。</li>
<li><strong>度量是优化的起点和终点</strong>：没有精确的测量，优化就是盲人摸象。我们建立了持续的性能监控仪表盘。</li>
<li><strong>优化需要勇气做减法</strong>：敢于对"历来如此"的设计（如全尺寸大图）和"别人都这么用"的技术（如完整Web字体）提出挑战。</li>
<li><strong>用户体验是最终裁判</strong>：优化的目标不是跑分，而是让用户觉得"快"。即使LCP还有提升空间，但1.8秒的加载速度已经让用户感知从"等待"变成了"顺畅"。</li>
</ol>
<p>"这个案例之后，我们形成了一种肌肉记忆：每当启动一个新项目，<strong>LCP 会作为一项核心验收指标，与功能需求并列进入产品清单</strong>。这或许是一次优化带来的最大价值——将性能意识植入了团队的基因。"</p>
<h3 data-id="heading-9">五、超越技术优化：构建性能工程体系</h3>
<p>一个优秀的候选人，还能聊到性能优化的工程化挑战：</p>
<ol>
<li>
<p><strong>度量和监控体系</strong></p>
<ul>
<li><strong>真实用户监控</strong>：收集真实场景下的性能数据</li>
<li><strong>关键业务路径追踪</strong>：从用户进入到最后转化的全链路分析</li>
</ul>
</li>
<li>
<p><strong>性能文化建设</strong></p>
<ul>
<li><strong>性能预算</strong>：为每个关键指标设置明确的数值目标</li>
<li><strong>代码审核集成</strong>：在代码合并前检查性能影响</li>
</ul>
</li>
<li>
<p><strong>渐进式优化策略</strong></p>
<ul>
<li><strong>基准建立</strong>：首先建立当前的性能基线</li>
<li><strong>快速胜利</strong>：优先实施高影响低成本的优化</li>
<li><strong>长期投资</strong>：规划需要架构层面改变的深度优化</li>
</ul>
</li>
</ol>
<h2 data-id="heading-10">面试官总结：我心目中的理想回答</h2>
<p>一个让我眼前一亮的回答，应该是这样的：</p>
<p>"说实话，性能优化这事儿我踩过不少坑。比如上次我们有个页面LCP一直上不去，我开始也以为是图片太大的问题，后来用Performance面板一分析，发现是字体文件阻塞了渲染。"</p>
<p>"我的思路其实挺简单的——<strong>先测量，再动手</strong>。我不会一上来就说要用什么preload或者WebP，而是先搞清楚瓶颈到底在哪。是网络慢？还是渲染被阻塞？或者是JS执行太耗时？"</p>
<p>"具体到LCP优化，我的经验是分三步走：</p>
<ol>
<li><strong>找到元凶</strong>——用Lighthouse和DevTools确定到底是哪个元素拖慢了LCP</li>
<li><strong>资源优先级</strong>——如果是图片，就用preload提前加载；如果是字体，就用font-display:swap避免阻塞</li>
<li><strong>持续监控</strong>——优化完了不是结束，要盯着真实用户的数据看效果"</li>
</ol>
<p>"而且我现在会特别关注<strong>业务价值</strong>。比如上次我们把LCP从4秒优化到1.8秒后，特意去看了转化率数据，发现确实提升了7%。"</p>
<p>"最重要的是，我觉得性能优化不是一次性的活，而是个持续过程。我们现在会把Core Web Vitals写进需求文档里，就像写功能需求一样自然。"</p>
<p>这样的回答为什么让我印象深刻？因为：</p>
<ul>
<li>有<strong>真实经历</strong>，不是空谈理论</li>
<li>有<strong>具体方法</strong>，不是泛泛而谈</li>
<li>有<strong>业务思维</strong>，不只关注技术指标</li>
<li>有<strong>落地经验</strong>，知道怎么在团队里推动这些事情</li>
</ul>
<p>说白了，我想找的不是一个只会背面试题的人，而是一个真正<strong>解决过问题</strong>的工程师。</p>
<p><strong>思考题：</strong> 当Core Web Vitals要求LCP在2.5秒内时，你是否思考过这在不同网络环境、不同设备配置下的实际意义？当你通过代码分割减少初始包体积时，是否评估过这对后续页面加载的潜在影响？这些，才是性能优化思考的真正深度所在。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[element-plus源码解读2——vue3组件的ref访问与defineExpose暴露机制]]></title>    <link>https://juejin.cn/post/7577958825342025747</link>    <guid>https://juejin.cn/post/7577958825342025747</guid>    <pubDate>2025-11-30T05:54:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577958825342025747" data-draft-id="7577970969394921513" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="element-plus源码解读2——vue3组件的ref访问与defineExpose暴露机制"/> <meta itemprop="keywords" content="Vue.js,JavaScript"/> <meta itemprop="datePublished" content="2025-11-30T05:54:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Joie"/> <meta itemprop="url" content="https://juejin.cn/user/3265984436383947"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            element-plus源码解读2——vue3组件的ref访问与defineExpose暴露机制
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3265984436383947/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Joie
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T05:54:27.000Z" title="Sun Nov 30 2025 05:54:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">vue3组件的ref访问与defineExpose暴露机制</h2>
<p>vue官方文档：</p>
<p><strong>ref</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.vuejs.org%2Fapi%2Freactivity-core.html%23ref" target="_blank" title="https://cn.vuejs.org/api/reactivity-core.html#ref" ref="nofollow noopener noreferrer">cn.vuejs.org/api/reactiv…</a></p>
<p><strong>defineExpose</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.vuejs.org%2Fapi%2Fsfc-script-setup.html%23defineexpose" target="_blank" title="https://cn.vuejs.org/api/sfc-script-setup.html#defineexpose" ref="nofollow noopener noreferrer">cn.vuejs.org/api/sfc-scr…</a></p>
<p>以el-button举例：</p>
<h4 data-id="heading-1">1. 正确的访问方式</h4>
<p>看 Button 组件暴露的内容：</p>
<pre><code class="hljs language-83:94:packages/components/button/src/button.vue" lang="83:94:packages/components/button/src/button.vue">defineExpose({
  /** @description button html element */
  ref: _ref,
  /** @description button size */
  size: _size,
  /** @description button type */
  type: _type,
  /** @description button disabled */
  disabled: _disabled,
  /** @description whether adding space */
  shouldAddSpace,
})
</code></pre>
<h4 data-id="heading-2">2. 实际使用示例</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-button ref="buttonRef" type="primary" size="large"&gt;
    按钮
  &lt;/el-button&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref, onMounted } from 'vue'
import type { ButtonInstance } from 'element-plus'

const buttonRef = ref&lt;ButtonInstance&gt;()

onMounted(() =&gt; {
  // ✅ 正确：访问所有暴露的属性
  console.log('DOM 元素:', buttonRef.value?.ref)        // HTMLButtonElement
  console.log('按钮尺寸:', buttonRef.value?.size)       // ComputedRef&lt;'large'&gt;
  console.log('按钮类型:', buttonRef.value?.type)      // ComputedRef&lt;'primary'&gt;
  console.log('是否禁用:', buttonRef.value?.disabled)   // ComputedRef&lt;boolean&gt;
  console.log('是否加空格:', buttonRef.value?.shouldAddSpace) // ComputedRef&lt;boolean&gt;
  
  // ✅ 打印整个组件实例，可以看到所有暴露的属性
  console.log('组件实例:', buttonRef.value)
})
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-3">3. 打印结果示例</h4>
<p>当你 <code>console.log(buttonRef.value)</code> 时，会看到类似：</p>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-attr">ref</span>: <span class="hljs-title class_">HTMLButtonElement</span>,           <span class="hljs-comment">// DOM 元素</span>
  <span class="hljs-attr">size</span>: <span class="hljs-title class_">ComputedRef</span>&lt;<span class="hljs-string">'large'</span>&gt;,        <span class="hljs-comment">// 尺寸（注意是 ComputedRef）</span>
  <span class="hljs-attr">type</span>: <span class="hljs-title class_">ComputedRef</span>&lt;<span class="hljs-string">'primary'</span>&gt;,      <span class="hljs-comment">// 类型（注意是 ComputedRef）</span>
  <span class="hljs-attr">disabled</span>: <span class="hljs-title class_">ComputedRef</span>&lt;<span class="hljs-literal">false</span>&gt;,      <span class="hljs-comment">// 禁用状态（注意是 ComputedRef）</span>
  <span class="hljs-attr">shouldAddSpace</span>: <span class="hljs-title class_">ComputedRef</span>&lt;<span class="hljs-literal">false</span>&gt; <span class="hljs-comment">// 是否加空格（注意是 ComputedRef）</span>
}
</code></pre>
<h4 data-id="heading-4">4. 重要提示：ComputedRef 的访问</h4>
<p>注意 <code>size</code>、<code>type</code>、<code>disabled</code> 等是 <code>ComputedRef</code>，访问值需要用 <code>.value</code>：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ❌ 错误：这样得到的是 ComputedRef 对象</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(buttonRef.<span class="hljs-property">value</span>?.<span class="hljs-property">size</span>)  <span class="hljs-comment">// ComputedRef { ... }</span>

<span class="hljs-comment">// ✅ 正确：需要 .value 才能拿到实际值</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(buttonRef.<span class="hljs-property">value</span>?.<span class="hljs-property">size</span>.<span class="hljs-property">value</span>)  <span class="hljs-comment">// 'large'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(buttonRef.<span class="hljs-property">value</span>?.<span class="hljs-property">type</span>.<span class="hljs-property">value</span>)  <span class="hljs-comment">// 'primary'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(buttonRef.<span class="hljs-property">value</span>?.<span class="hljs-property">disabled</span>.<span class="hljs-property">value</span>)  <span class="hljs-comment">// false</span>
</code></pre>
<p>说明 Vue 3 的生命周期和 ref 访问时机：</p>
<h4 data-id="heading-5">1. Vue 3 没有 <code>onCreated</code> 钩子</h4>
<p>在 Vue 3 的 Composition API 中：</p>
<ul>
<li>没有 <code>onCreated()</code> 钩子</li>
<li><code>setup()</code> 函数本身就相当于 Vue 2 的 <code>created</code> + <code>beforeCreate</code></li>
<li>如果需要访问 DOM 或组件实例，应该用 <code>onMounted()</code></li>
</ul>
<h4 data-id="heading-6">2. 为什么必须在 <code>onMounted()</code> 中？</h4>
<h5 data-id="heading-7">在 <code>setup()</code> 顶层（组件未挂载）</h5>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref } from 'vue'
import type { ButtonInstance } from 'element-plus'

const buttonRef = ref&lt;ButtonInstance&gt;()

// ❌ 错误：此时 buttonRef.value 是 undefined
// 因为组件还没有挂载，ref 还没有被赋值
console.log(buttonRef.value)  // undefined
&lt;/script&gt;
</code></pre>
<h5 data-id="heading-8">在 <code>onMounted()</code> 中（组件已挂载）</h5>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref, onMounted } from 'vue'
import type { ButtonInstance } from 'element-plus'

const buttonRef = ref&lt;ButtonInstance&gt;()

onMounted(() =&gt; {
  // ✅ 正确：此时组件已经挂载，ref 已经被赋值
  console.log(buttonRef.value)  // ButtonInstance 对象
  console.log(buttonRef.value?.ref)  // HTMLButtonElement
})
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-9">3. Vue 3 生命周期对比</h4>


















































<table><thead><tr><th>Vue 2 Options API</th><th>Vue 3 Composition API</th><th>说明</th></tr></thead><tbody><tr><td><code>beforeCreate</code></td><td><code>setup()</code> 开始执行</td><td>组件创建前</td></tr><tr><td><code>created</code></td><td><code>setup()</code> 执行中</td><td>组件创建后（但未挂载）</td></tr><tr><td><code>beforeMount</code></td><td><code>onBeforeMount()</code></td><td>挂载前</td></tr><tr><td><code>mounted</code></td><td><code>onMounted()</code></td><td>挂载后（DOM 已存在）</td></tr><tr><td><code>beforeUpdate</code></td><td><code>onBeforeUpdate()</code></td><td>更新前</td></tr><tr><td><code>updated</code></td><td><code>onUpdated()</code></td><td>更新后</td></tr><tr><td><code>beforeUnmount</code></td><td><code>onBeforeUnmount()</code></td><td>卸载前</td></tr><tr><td><code>unmounted</code></td><td><code>onUnmounted()</code></td><td>卸载后</td></tr></tbody></table>
<h4 data-id="heading-10">4. 完整示例对比</h4>
<h5 data-id="heading-11">错误示例（在 setup 顶层）</h5>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-button ref="buttonRef"&gt;按钮&lt;/el-button&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref } from 'vue'
import type { ButtonInstance } from 'element-plus'

const buttonRef = ref&lt;ButtonInstance&gt;()

// ❌ 错误：此时 buttonRef.value 是 undefined
console.log('setup 顶层:', buttonRef.value)  // undefined
&lt;/script&gt;
</code></pre>
<h5 data-id="heading-12">正确示例（在 onMounted 中）</h5>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;el-button ref="buttonRef"&gt;按钮&lt;/el-button&gt;
&lt;/template&gt;

&lt;script setup&gt;
import { ref, onMounted, onBeforeMount } from 'vue'
import type { ButtonInstance } from 'element-plus'

const buttonRef = ref&lt;ButtonInstance&gt;()

// 在 setup 顶层
console.log('setup 顶层:', buttonRef.value)  // undefined

// 在 beforeMount 中
onBeforeMount(() =&gt; {
  console.log('beforeMount:', buttonRef.value)  // 可能还是 undefined
})

// 在 mounted 中
onMounted(() =&gt; {
  // ✅ 正确：此时组件已挂载，ref 已赋值
  console.log('mounted:', buttonRef.value)  // ButtonInstance 对象
  console.log('DOM 元素:', buttonRef.value?.ref)  // HTMLButtonElement
})
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-13">5. 为什么 ref 在 onMounted 中才有值？</h4>
<p>Vue 的 ref 赋值时机：</p>
<ol>
<li>模板编译阶段：Vue 识别 <code>ref="buttonRef"</code></li>
<li>组件挂载阶段：创建组件实例，将实例赋值给 <code>buttonRef.value</code></li>
<li>DOM 渲染完成：<code>onMounted()</code> 执行时，ref 已经有值</li>
</ol>
<h4 data-id="heading-14">6. 如果需要在 setup 中访问怎么办？</h4>
<p>可以使用 <code>watchEffect</code> 或 <code>watch</code>：</p>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup&gt;
import { ref, watchEffect } from 'vue'
import type { ButtonInstance } from 'element-plus'

const buttonRef = ref&lt;ButtonInstance&gt;()

// 使用 watchEffect，会在 ref 有值后自动执行
watchEffect(() =&gt; {
  if (buttonRef.value) {
    console.log('ref 有值了:', buttonRef.value)
  }
})
&lt;/script&gt;
</code></pre>
<h4 data-id="heading-15">7. 总结</h4>
<ul>
<li>Vue 3 没有 <code>onCreated()</code>，<code>setup()</code> 本身就相当于 <code>created</code></li>
<li>访问 <code>ref.value</code> 必须在 <code>onMounted()</code> 中，因为此时组件已挂载</li>
<li>在 <code>setup()</code> 顶层访问 <code>ref.value</code> 会是 <code>undefined</code></li>
<li>如果需要响应式监听 ref 的变化，可以用 <code>watchEffect</code> 或 <code>watch</code></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React 中没有 v-model，如何优雅地处理表单输入]]></title>    <link>https://juejin.cn/post/7577970969395003433</link>    <guid>https://juejin.cn/post/7577970969395003433</guid>    <pubDate>2025-11-30T06:11:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577970969395003433" data-draft-id="7577797563853783076" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React 中没有 v-model，如何优雅地处理表单输入"/> <meta itemprop="keywords" content="前端,Vue.js,React.js"/> <meta itemprop="datePublished" content="2025-11-30T06:11:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="凯心"/> <meta itemprop="url" content="https://juejin.cn/user/75186527548462"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React 中没有 v-model，如何优雅地处理表单输入
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/75186527548462/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    凯心
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T06:11:28.000Z" title="Sun Nov 30 2025 06:11:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React 中没有 v-model，如何优雅地处理表单输入</h2>
<p>在 Vue 中，我们可以很方便地使用 <code>v-model</code> 实现数据的双向绑定。但在 React 的世界里，并没有这样的语法糖，我们需要通过不同的方式来处理表单数据。</p>
<h3 data-id="heading-1">Vue 的简洁写法</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
  &lt;input v-model="value" /&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-2">React 的几种实现方案</h3>
<h4 data-id="heading-3">方案一：基础受控组件</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [value, setValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">""</span>);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span> 
      <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setValue(e.target.value)} 
    /&gt;</span>
  );
}
</code></pre>
<p>这是 React 初学者最常用的写法。在简单场景下表现良好，但在复杂表单或大型应用中，每次输入都会触发组件重新渲染，可能导致性能问题。</p>
<h4 data-id="heading-4">方案二：非受控组件 + useRef</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-string">""</span>);
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> (inputRef.current = e.target.value)} 
    /&gt;</span>
  );
}
</code></pre>
<p>这种方案避免了频繁的重新渲染，适合性能敏感的场景。</p>
<h4 data-id="heading-5">方案三：防抖优化</h4>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [value, setValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">""</span>);
  
  <span class="hljs-keyword">const</span> handleChange = <span class="hljs-title function_">useCallback</span>(
    <span class="hljs-title function_">debounce</span>(<span class="hljs-function">(<span class="hljs-params">newValue</span>) =&gt;</span> {
      <span class="hljs-title function_">setValue</span>(newValue);
    }, <span class="hljs-number">300</span>),
    []
  );

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> handleChange(e.target.value)} 
    /&gt;</span>
  );
}
</code></pre>
<p>通过防抖函数减少状态更新的频率，在需要实时搜索等场景下特别有用。</p>
<hr/>
<h2 data-id="heading-6">深入理解：受控组件 vs 非受控组件</h2>
<h3 data-id="heading-7">概念解析</h3>
<p>受控组件和非受控组件是<code>数据驱动框架</code>中的重要概念：</p>
<ul>
<li><strong>表面区别</strong>：值是否只能由用户输入改变，还是也可以由程序逻辑<code>直接</code>改变</li>
<li><strong>本质区别</strong>：数据是由 React 状态托管，还是由 DOM 自身管理</li>
</ul>
<h3 data-id="heading-8">受控组件（Controlled Components）</h3>
<p>表单元素的值完全由 React 状态控制，通过 <code>onChange</code> 事件同步更新。</p>
<p><strong>优点：</strong></p>
<ul>
<li>✅ 符合 React 单向数据流理念，状态完全可控</li>
<li>✅ 便于实现实时验证和输入格式化</li>
<li>✅ 可动态控制表单提交状态</li>
<li>✅ 支持多组件间的数据同步</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>❌ 需要为每个字段编写事件处理逻辑</li>
<li>❌ 表单复杂时可能引发性能问题</li>
</ul>
<p><strong>适用场景：</strong></p>
<ul>
<li>需要实时验证用户输入</li>
<li>需要根据输入动态更新UI</li>
<li>需要强制特定的输入格式</li>
<li>表单数据被多个组件共享</li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">LoginForm</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [formData, setFormData] = <span class="hljs-title function_">useState</span>({
    <span class="hljs-attr">username</span>: <span class="hljs-string">""</span>,
    <span class="hljs-attr">password</span>: <span class="hljs-string">""</span>
  });

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = (<span class="hljs-params">field</span>) =&gt; <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
    <span class="hljs-title function_">setFormData</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> ({
      ...prev,
      [field]: e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>
    }));
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
        <span class="hljs-attr">value</span>=<span class="hljs-string">{formData.username}</span> 
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleChange(</span>"<span class="hljs-attr">username</span>")} 
      /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
        <span class="hljs-attr">type</span>=<span class="hljs-string">"password"</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{formData.password}</span> 
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleChange(</span>"<span class="hljs-attr">password</span>")} 
      /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-9">非受控组件（Uncontrolled Components）</h3>
<p>表单数据由 DOM 自身管理，通过 ref 在需要时获取值。</p>
<p><strong>优点：</strong></p>
<ul>
<li>✅ 代码简洁，减少事件处理逻辑</li>
<li>✅ 性能更优，避免频繁重新渲染</li>
<li>✅ 更接近原生 DOM 操作</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>❌ 不符合 React 数据流最佳实践</li>
<li>❌ 无法实现实时验证和UI反馈</li>
<li>❌ 状态管理不够直观</li>
</ul>
<p><strong>适用场景：</strong></p>
<ul>
<li>简单表单，无需实时验证</li>
<li>只在提交时需要获取数据</li>
<li>性能敏感的大型表单</li>
<li>集成第三方表单库</li>
</ul>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">UncontrolledForm</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> usernameRef = <span class="hljs-title function_">useRef</span>();
  <span class="hljs-keyword">const</span> passwordRef = <span class="hljs-title function_">useRef</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = (<span class="hljs-params">e</span>) =&gt; {
    e.<span class="hljs-title function_">preventDefault</span>();
    <span class="hljs-keyword">const</span> data = {
      <span class="hljs-attr">username</span>: usernameRef.<span class="hljs-property">current</span>.<span class="hljs-property">value</span>,
      <span class="hljs-attr">password</span>: passwordRef.<span class="hljs-property">current</span>.<span class="hljs-property">value</span>
    };
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"表单数据:"</span>, data);
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{handleSubmit}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{usernameRef}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"password"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{passwordRef}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>提交<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
  );
}
</code></pre>
<h3 data-id="heading-10">实践建议</h3>
<ol>
<li>当需要做性能优化时，可以考虑使用非受控组件</li>
<li>非受控组件和受控组件可以混用</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Rect深入学习]]></title>    <link>https://juejin.cn/post/7577691061034041390</link>    <guid>https://juejin.cn/post/7577691061034041390</guid>    <pubDate>2025-11-30T06:37:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577691061034041390" data-draft-id="7577691061033320494" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Rect深入学习"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-30T06:37:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="本地跑没问题"/> <meta itemprop="url" content="https://juejin.cn/user/1632138081101102"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Rect深入学习
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1632138081101102/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    本地跑没问题
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T06:37:10.000Z" title="Sun Nov 30 2025 06:37:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读23分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">React核心机制</h2>
<h3 data-id="heading-1">虚拟 DOM 和 Diff 算法</h3>
<h4 data-id="heading-2">什么是虚拟DOM</h4>
<p>虚拟DOM可以理解为模拟了DOM树的JS对象树</p>
<p>比如</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> element = {
    <span class="hljs-attr">element</span>: <span class="hljs-string">'ul'</span>,
    <span class="hljs-attr">props</span>: {
        <span class="hljs-attr">id</span>:<span class="hljs-string">"ulist"</span>
    },
    <span class="hljs-attr">children</span>: [
    { <span class="hljs-attr">element</span>: <span class="hljs-string">'li'</span>, <span class="hljs-attr">props</span>: { <span class="hljs-attr">id</span>:<span class="hljs-string">"first"</span> }, <span class="hljs-attr">children</span>: [<span class="hljs-string">'这是第一个List元素'</span>] },
    { <span class="hljs-attr">element</span>: <span class="hljs-string">'li'</span>, <span class="hljs-attr">props</span>: { <span class="hljs-attr">id</span>:<span class="hljs-string">"second"</span> }, <span class="hljs-attr">children</span>: [<span class="hljs-string">'这是第二个List元素'</span>] }
    ]
}
</code></pre>
<h4 data-id="heading-3">为什么需要虚拟DOM</h4>
<p>传统DOM更新方式的问题：</p>
<ul>
<li>在原生JS中，更新DOM的方式往往是<strong>粗颗粒度的更新，直接替换整颗子树</strong>，容易造成性能的浪费</li>
<li>如果要做到细颗粒度更新，则需要<strong>自己决定修改哪一部分，但这种手动diff很麻烦</strong></li>
</ul>
<p>虚拟DOM更新的优势：</p>
<ul>
<li>框架自动对新旧虚拟DOM树进行diff算法</li>
<li>然后<strong>精准更新DOM树中变化的部分</strong>，大幅度提升性能</li>
</ul>
<p>举例：</p>
<p>比如有一个列表，我对其进行了修改</p>
<pre><code class="hljs language-html" lang="html">//旧UI
<span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"list"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>苹果<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>香蕉<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>

//新UI
<span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"list"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>苹果<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>橘子<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span> <span class="hljs-comment">&lt;!-- 改动 --&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
</code></pre>
<ul>
<li>
<p>传统DOM更新：</p>
<ul>
<li>
<p><strong>粗暴做法</strong>：<code>list.innerHTML = render(items)</code> → 把整个 <code>&lt;ul&gt;</code> 清空并重建 <code>&lt;li&gt;</code>，即使“苹果”没变也会被销毁重建。</p>
</li>
<li>
<p><strong>精细做法</strong>：你必须写逻辑找到第 2 个 <code>&lt;li&gt;</code> 并替换它的文本</p>
<ul>
<li><code>list.children[1].textContent = '橘子';</code></li>
<li>但这种手动 diff 很麻烦，开发者必须自己维护 UI 和数据的一致性。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>虚拟DOM更新：</p>
<ul>
<li>
<p>框架自动比较新旧虚拟 DOM：</p>
<ul>
<li>第 1 个 <code>&lt;li&gt;</code> 一样 → 复用。</li>
<li>第 2 个 <code>&lt;li&gt;</code> 文本不同 → 只更新文本。</li>
</ul>
</li>
<li>
<p>最终只执行一条 DOM 操作：<code>list.children[1].textContent = '橘子';</code></p>
</li>
</ul>
</li>
</ul>
<h4 data-id="heading-4">diff算法</h4>
<p>传统diff算法的时间复杂度是O(n³)</p>
<ul>
<li>我们要把旧树变成新树，找到最小修改路径</li>
</ul>
<p>为什么时间复杂度是O(n³)？</p>
<ol>
<li>
<p>遍历旧树的每个节点（n次）</p>
</li>
<li>
<p>遍历新树的每个节点（n次）</p>
<ul>
<li>对比每个旧树中的节点，找到新树中可能对应的新节点</li>
</ul>
</li>
<li>
<p>比较两个节点的子结构是否完全相同</p>
<ul>
<li>
<p>因为判断“是否同一个节点”不仅要看标签名，还要看它的整个子结构是否相同。 这就需要再深入进去比较它们的子树。</p>
</li>
<li>
<p>每对匹配节点都可能有一整棵子树；</p>
<p>每棵子树的节点数也可能接近 n；</p>
<p>所以在最坏情况下，每一对匹配都要再递归比较一遍整棵子树。</p>
</li>
</ul>
</li>
</ol>
<p>于是复杂度变成：</p>
<blockquote>
<p>O(n)（旧树） × O(n)（新树） × O(n)（子树递归） = <strong>O(n³)</strong></p>
</blockquote>
<p>第 3 层递归比较子树的复杂度，是因为<strong>每一对匹配节点</strong>都还要<strong>递归地比较它们的子树结构</strong>。</p>
<p>前两层只是找出“候选节点对”，第三层才是深入检查“它们真的一样吗”。</p>
<p>所以整体复杂度是： <strong>旧树节点数 × 新树节点数 × 子树递归 = O(n³)</strong> 。</p>
<hr/>
<p>React的diff算法的时间复杂度是O(n)</p>
<p>React 把问题简化成了三条“经验规则”，正是这三条规则让复杂度从 O(n³) → O(n)。</p>
<ol start="0">
<li>
<p>同层比较，不跨层</p>
<ul>
<li>复杂度就从 <strong>O(n³)</strong> → <strong>O(n²)</strong></li>
</ul>
</li>
<li>
<p>不同类型节点，直接替换整棵子树</p>
<ul>
<li>也就是说，<strong>不同类型的节点永远不去比较子树</strong>。 这避免了对子树的递归匹配，进一步从 <strong>O(n²)</strong> → <strong>O(n)</strong> 。</li>
</ul>
</li>
<li>
<p>通过 <code>key</code> 标识子节点的稳定性</p>
<ul>
<li>对于同一层的子节点列表，React 通过 key 来判断哪些节点是“同一个节点”</li>
</ul>
</li>
</ol>
<pre><code class="hljs language-hmtl" lang="hmtl">//旧
&lt;ul&gt;
  &lt;li key="A"&gt;A&lt;/li&gt;
  &lt;li key="B"&gt;B&lt;/li&gt;
  &lt;li key="C"&gt;C&lt;/li&gt;
&lt;/ul&gt;
//新
&lt;ul&gt;
  &lt;li key="B"&gt;B&lt;/li&gt;
  &lt;li key="A"&gt;A&lt;/li&gt;
  &lt;li key="C"&gt;C&lt;/li&gt;
&lt;/ul&gt;
</code></pre>
<p>React 会通过 <code>key</code> 识别出：</p>
<ul>
<li>A、B、C 都还在；</li>
<li>只是顺序变了；</li>
<li>所以只需调整位置，<strong>不需要删除重建</strong>。</li>
</ul>
<p>这就让 <strong>同层的节点比较只需一次线性扫描</strong>。</p>
<p>👉 因此，同层 diff 的复杂度变为 <strong>O(n)</strong> 。</p>
<h4 data-id="heading-5">key 的作用是什么？</h4>
<ul>
<li>
<p>是React对于列表元素的唯一标识</p>
<ul>
<li>如果key相同，那么认为是同一节点，可以复用DOM元素</li>
<li>如果key不同，则会销毁旧的，创建新的节点</li>
</ul>
</li>
</ul>
<h4 data-id="heading-6">为什么不能用 index 作为 key？</h4>
<p>因为会导致错误的复用和性能问题</p>
<ul>
<li>因为列表内容如果从中间新增或者删除一项，那么index对应的元素将会错误的被复用</li>
</ul>
<h4 data-id="heading-7">React 中 reconciliation 的过程是怎样的？</h4>
<ul>
<li>当组件的 <code>state</code> 或 <code>props</code> 变化时，React 会比较<strong>新旧虚拟 DOM（Fiber 树）</strong> ，找出需要更新的部分并同步到真实 DOM。这个比较与更新过程叫 <strong>Reconciliation</strong></li>
</ul>
<h3 data-id="heading-8">React 更新是同步还是异步的？</h3>
<h4 data-id="heading-9">同步更新</h4>
<p>同步模式下，React一旦开始渲染，就会<strong>一口气渲染完所有组件</strong>，期间不会中断</p>
<ul>
<li>
<p>页面上的表现</p>
<ul>
<li>当你触发一个大型渲染（比如 setState 导致 1000 个组件更新）时，<strong>页面会卡顿一下</strong></li>
<li>浏览器在 React 渲染完成前，<strong>无法响应用户操作（比如滚动、点击）</strong></li>
</ul>
</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10000</span>; i++) {
      <span class="hljs-title function_">setCount</span>(i) <span class="hljs-comment">// 模拟大规模更新</span>
    }
  }

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>count: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
}
</code></pre>
<p>在同步更新下，点击按钮后：</p>
<ul>
<li>UI 会“卡死”几百毫秒；</li>
<li>最后一次性更新成最终结果。</li>
</ul>
<h4 data-id="heading-10">异步（Concurrent）更新（React 18 createRoot）</h4>
<p>在并发模式下，React会把渲染拆分为小任务，在<strong>空闲时间片</strong>执行，可以随时暂停、恢复或丢弃</p>
<ul>
<li>
<p>页面上的表现</p>
<ul>
<li>大型渲染不再卡顿；</li>
<li>页面仍能响应滚动、输入、动画；</li>
<li>React 会优先处理用户交互（高优先级），低优先级任务（如列表渲染）可延后执行。</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { useState, startTransition } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [value, setValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>)
  <span class="hljs-keyword">const</span> [list, setList] = <span class="hljs-title function_">useState</span>([])

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = (<span class="hljs-params">e</span>) =&gt; {
    <span class="hljs-keyword">const</span> val = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>
    <span class="hljs-title function_">setValue</span>(val)
    <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 模拟高开销任务</span>
      <span class="hljs-keyword">const</span> items = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">5000</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> <span class="hljs-string">`<span class="hljs-subst">${val}</span>-<span class="hljs-subst">${i}</span>`</span>)
      <span class="hljs-title function_">setList</span>(items)
    })
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleChange}</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入点东西"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>{list.map((item) =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item}</span>&gt;</span>{item}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>)}<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  )
}
</code></pre>
<p>在异步（Concurrent）模式下：</p>
<ul>
<li>输入框 <strong>不会卡顿</strong>；</li>
<li>React 会<strong>优先更新输入框的值</strong>；</li>
<li>再利用空闲时间慢慢渲染列表；</li>
<li>如果你输入更快，React 会<strong>丢弃旧的渲染任务</strong>，直接开始最新的。</li>
</ul>
<h4 data-id="heading-11">同步场景</h4>
<h5 data-id="heading-12">React17及以前的全部更新，默认同步</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// React 17 写法（使用 ReactDOM.render）</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactDOM</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'render:'</span>, count)

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;
      Click: {count}
    <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
  )
}

<span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">render</span>(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>, <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>))
</code></pre>
<p>💬 说明：</p>
<ul>
<li>在 React 17（及更早版本）中，React <strong>没有并发模式（Concurrent Mode）</strong> 。</li>
<li>所有更新（无论大或小）都是同步执行的。</li>
<li>点击按钮时，会立刻执行所有渲染逻辑。</li>
</ul>
<p>📍<strong>页面效果：</strong></p>
<blockquote>
<p>即使组件很复杂、渲染耗时，React 也会“卡着”把它一次性渲染完。</p>
</blockquote>
<h5 data-id="heading-13">React 18 中的旧 Root（非 Concurrent Root）</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// React 18，但仍使用 ReactDOM.render（旧 Root）</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactDOM</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App'</span>

<span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">render</span>(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>, <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>))
</code></pre>
<ul>
<li>即使你使用 React 18，只要还用旧的 <code>ReactDOM.render</code>， React 就不会启用并发模式（仍是同步更新）。</li>
<li>所以这种 root 下的渲染依然会一次性执行完，期间不能被打断。</li>
</ul>
<p>📍<strong>页面效果：</strong></p>
<blockquote>
<p>和 React 17 完全一样，仍然是同步阻塞渲染。</p>
</blockquote>
<h5 data-id="heading-14">在 React 事件回调中调用的更新</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Before:'</span>, count)
    <span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'After:'</span>, count)
  }

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>Click: {count}<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
}
</code></pre>
<p>即使你在 React 18 并发模式下（使用 <code>createRoot</code>）， <strong>在 React 事件回调中触发的更新仍是同步批量更新</strong>。</p>
<p>React 会立即计算新的 Fiber 树，保证交互即时。</p>
<h4 data-id="heading-15">异步场景</h4>
<h5 data-id="heading-16">使用 createRoot()</h5>
<p>使用 <code>createRoot()</code>（并发 root）—— 开启异步渲染能力</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// React 18 推荐写法（Concurrent Root）</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ReactDOM</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-dom/client'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App'</span>

<span class="hljs-keyword">const</span> root = <span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">createRoot</span>(<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'root'</span>))
root.<span class="hljs-title function_">render</span>(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span> /&gt;</span></span>)
</code></pre>
<ul>
<li><code>createRoot()</code> 会启用 <strong>Concurrent Mode（并发模式）</strong> ；</li>
<li>在这种 root 下，React 的更新<strong>具备可中断、可延迟</strong>的能力；</li>
<li>不代表所有更新都异步，但具备<strong>异步调度的基础条件</strong>。</li>
</ul>
<p>📍<strong>页面效果：</strong></p>
<blockquote>
<p>如果组件渲染量大，React 可以暂停、分段渲染，不会卡死主线程。 用户输入或动画依然流畅。</p>
</blockquote>
<h5 data-id="heading-17">使用 <code>startTransition()</code>（标记低优先级更新）</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { useState, startTransition } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [value, setValue] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>)
  <span class="hljs-keyword">const</span> [list, setList] = <span class="hljs-title function_">useState</span>([])

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleChange</span> = (<span class="hljs-params">e</span>) =&gt; {
    <span class="hljs-keyword">const</span> val = e.<span class="hljs-property">target</span>.<span class="hljs-property">value</span>
    <span class="hljs-title function_">setValue</span>(val)
    <span class="hljs-comment">// 👇 告诉 React：这是低优先级任务，可延迟执行</span>
    <span class="hljs-title function_">startTransition</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">const</span> items = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">5000</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> <span class="hljs-string">`<span class="hljs-subst">${val}</span>-<span class="hljs-subst">${i}</span>`</span>)
      <span class="hljs-title function_">setList</span>(items)
    })
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{value}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{handleChange}</span> <span class="hljs-attr">placeholder</span>=<span class="hljs-string">"输入点东西"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>{list.map((item) =&gt; <span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{item}</span>&gt;</span>{item}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>)}<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  )
}
</code></pre>
<p>说明：</p>
<ul>
<li><code>startTransition()</code> 将内部更新标记为<strong>可中断任务</strong>；</li>
<li>高优先级任务（输入框更新）会<strong>先执行</strong>；</li>
<li>低优先级任务（列表渲染）会在空闲时执行；</li>
<li>若用户继续输入，React 会<strong>丢弃旧任务</strong>、渲染最新的。</li>
</ul>
<p>📍<strong>页面效果：</strong></p>
<blockquote>
<p>输入非常流畅，列表延迟更新但不卡顿。</p>
</blockquote>
<h5 data-id="heading-18">使用 <code>useDeferredValue()</code>（延迟渲染依赖值）</h5>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> { useState, useDeferredValue } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>)
  <span class="hljs-keyword">const</span> deferredText = <span class="hljs-title function_">useDeferredValue</span>(text) <span class="hljs-comment">// 延迟使用 text 的值</span>

  <span class="hljs-keyword">const</span> list = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">5000</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{i}</span>&gt;</span>{deferredText}<span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>
  ))

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{text}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> setText(e.target.value)} /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>{list}<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  )
</code></pre>
<p>说明：</p>
<ul>
<li><code>useDeferredValue()</code> 会在高优先级更新（输入）后，<strong>延迟执行耗时渲染</strong>；</li>
<li>输入流畅；</li>
<li>列表内容更新稍后完成。</li>
</ul>
<p>📍<strong>页面效果：</strong></p>
<blockquote>
<p>输入框立即响应，列表延迟一点点更新。 类似于“防抖 + 并发更新”的效果</p>
</blockquote>
<p><strong>一句话总结：</strong></p>
<blockquote>
<p>在 React 18 中，只要使用 <code>createRoot()</code> 启动应用， 你就进入了并发世界。 再搭配 <code>startTransition()</code> / <code>useDeferredValue()</code>， 就能让 React 的更新更智能、更流畅。</p>
</blockquote>
<h3 data-id="heading-19">Fiber 是为了解决什么问题？</h3>
<ul>
<li>Fiber 是 React 为了解决「同步更新导致的卡顿问题」而引入的「可中断、可恢复的虚拟 DOM 架构」</li>
<li>Fiber 是 React 的底层重构，用于让虚拟 DOM 更新“可中断、可恢复、可调度”，从而提升大规模渲染的流畅度。</li>
</ul>
<h4 data-id="heading-20">背景问题</h4>
<p>React15的缺陷，在React15之前，更新流程是这样的：</p>
<ol start="0">
<li>状态更新后，React 会从根节点开始，<strong>递归遍历整棵虚拟 DOM 树</strong>；</li>
<li>每次更新都同步执行到底（不能中断）</li>
<li>如果组件层级很深、计算复杂，就会<strong>长时间占用主线程</strong>；</li>
<li>主线程被占用时，浏览器无法响应用户操作（如输入、滚动） → <strong>卡顿、掉帧</strong></li>
</ol>
<h4 data-id="heading-21">fiber的核心目标</h4>
<p>React团队为了解决“更新太重，无法中断”的问题，引入了fiber架构</p>
<ol>
<li>可中断更新：react更新可以被中断，让浏览器先去响应用户操作</li>
<li>可分片执行：大任务被拆分为小任务，（每一帧执行一点）</li>
<li>可恢复与重用：被中断后可以从上次中断的地方继续执行</li>
</ol>
<h4 data-id="heading-22">Fiber的设计思路</h4>
<p>React 把每个虚拟 DOM 节点（VNode）包装成一个 <strong>Fiber 对象</strong>， 这个对象包含：</p>
<ul>
<li>节点类型、props、state</li>
<li>指向父节点、子节点、兄弟节点的指针（形成链表结构）</li>
<li>更新优先级信息（lane）</li>
<li>副作用标记（如需插入/删除/更新）</li>
</ul>
<p>➡️ 这样 React 就可以：</p>
<ul>
<li>用「遍历链表」代替「递归函数调用」（可随时暂停）</li>
<li>在空闲时间片中继续工作（用调度器协调）</li>
<li>动态决定哪部分更新优先（配合 Concurrent Mode）</li>
</ul>
<h3 data-id="heading-23">Fiber 是如何实现可中断渲染的？</h3>
<ul>
<li>Fiber 通过把递归改为循环、把组件树改为链表结构、并利用时间片调度机制，使得 React 的渲染可以“暂停—恢复—继续”，从而实现了可中断渲染。</li>
</ul>
<p>在React15中，更新虚拟DOM时使用的是递归遍历整棵树的方式</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">updateComponent</span>(<span class="hljs-params">component</span>) {
  component.<span class="hljs-title function_">render</span>()
  component.<span class="hljs-property">children</span>.<span class="hljs-title function_">forEach</span>(updateComponent)
}
</code></pre>
<p>问题是：</p>
<ul>
<li>JS 是<strong>单线程</strong>的；</li>
<li>一旦进入这段递归逻辑，就无法中途暂停；</li>
<li>如果组件树很大，浏览器主线程会被长期占用；</li>
<li>用户交互、动画、输入都会卡顿。</li>
</ul>
<p>React 16 重写架构为 <strong>Fiber Reconciler</strong>。 目标：让“渲染过程”像执行协程一样 —— <strong>可中断、可恢复、可调度。</strong></p>
<p>Fiber 的关键设计思想是：</p>
<blockquote>
<p>“把每个虚拟 DOM 节点（VNode）变成一个 Fiber 对象，并把组件树改成链表结构。”</p>
</blockquote>
<p>这样 React 就可以：</p>
<ol start="0">
<li>用 <code>while</code> 循环<strong>遍历链表</strong>（而非递归）；</li>
<li>每处理一个 Fiber 节点，都检查当前帧是否超时；</li>
<li>如果时间用完，就<strong>暂停渲染</strong>，把控制权交还浏览器；</li>
<li>下一帧（或空闲时）再从上次中断的 Fiber 继续工作。</li>
</ol>
<h2 data-id="heading-24">React Hooks</h2>
<h3 data-id="heading-25">useState</h3>
<h4 data-id="heading-26">基础概念</h4>
<p><code>useState</code> 是 React 提供的用于在函数组件中声明状态（state）的 Hook。</p>
<p>const [state, setState] = useState(initialValue)</p>
<ul>
<li><code>state</code>：当前状态值。</li>
<li><code>setState</code>：更新状态的函数，会触发组件重新渲染。</li>
<li><code>initialValue</code>：初始状态值，只在组件首次渲染时使用。</li>
</ul>
<h4 data-id="heading-27">运行机制</h4>
<p>当组件执行时（函数重新运行），<code>useState</code> 并不会重新创建新的状态，而是通过 <strong>React 内部的 Hook 链表（Fiber）机制</strong> 取回上一次保存的状态值。</p>
<p>也就是说：</p>
<ul>
<li>虽然函数重新执行了，</li>
<li>但 <code>useState</code> 通过<strong>闭包 + 内部索引</strong>保存并取回之前的状态。</li>
</ul>
<p>👉 因此即使多次调用 <code>useState(0)</code>，<code>state</code> 也不会回到 0。</p>
<p><strong>React 约束：</strong> Hook 调用顺序必须一致，否则状态会错位。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> x = []
<span class="hljs-keyword">let</span> index = <span class="hljs-number">0</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">myUseState</span> = initial =&gt; {
	<span class="hljs-keyword">let</span> currentIndex = index 
	x[currenIndex] = x[currentIndex] === <span class="hljs-literal">undefined</span> ? initial : x[currentIndex]

	<span class="hljs-keyword">const</span> <span class="hljs-title function_">setInitial</span> = value =&gt; {
		x[currentIndex] = value
		<span class="hljs-title function_">render</span>()
	}
}

<span class="hljs-comment">//模拟render函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">render</span> = (<span class="hljs-params"/>) =&gt; {
	index = <span class="hljs-number">0</span>
	<span class="hljs-title class_">ReactDOM</span>.<span class="hljs-title function_">render</span>(<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">App</span>/&gt;</span></span>, <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">"#root"</span>))
}

<span class="hljs-keyword">const</span> <span class="hljs-title function_">App</span> = (<span class="hljs-params"/>) =&gt; {
	<span class="hljs-keyword">const</span> [n, setN] = <span class="hljs-title function_">myUseState</span>(<span class="hljs-number">0</span>)
	<span class="hljs-keyword">const</span> [m, setM] = <span class="hljs-title function_">myUseState</span>(<span class="hljs-number">0</span>)
	<span class="hljs-keyword">return</span> (
		<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
	         <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>n：{n}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
	         <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span>=&gt;</span>setN(n+1)}&gt;+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
	         <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>m：{m}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
	         <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span>=&gt;</span>setM(m+1)}&gt;+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
     	<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
	)
}
</code></pre>
<h4 data-id="heading-28">异步批处理（Batch Update）</h4>
<p>React 会将多个状态更新合并执行（在事件回调中）。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>)

<span class="hljs-title function_">setCount</span>(count + <span class="hljs-number">1</span>)

<span class="hljs-comment">// 实际只增加一次</span>

在 <span class="hljs-title class_">React</span> <span class="hljs-number">18</span> 中，异步任务（如 <span class="hljs-built_in">setTimeout</span>、<span class="hljs-title class_">Promise</span>）中的 setState 不再强制合并。
</code></pre>
<h4 data-id="heading-29">惰性初始化</h4>
<p>初始值可以是一个函数：</p>
<p>const [data, setData] = useState(() =&gt; heavyCalculation())</p>
<p>✅ <code>heavyCalculation()</code> 只在首次渲染时执行，避免每次渲染重复计算。</p>
<h4 data-id="heading-30">更新函数形式</h4>
<p>当新状态依赖旧状态时，用函数式更新：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>)
</code></pre>
<h3 data-id="heading-31">useEffect</h3>
<h4 data-id="heading-32">一、作用</h4>
<p><code>useEffect</code> 用于处理 <strong>副作用（side effects）</strong> ，比如：</p>
<ul>
<li>网络请求</li>
<li>订阅 / 事件监听</li>
<li>操作 DOM</li>
<li>定时器</li>
</ul>
<p>这些逻辑不能直接放在渲染阶段，否则会阻塞或污染渲染。</p>
<ul>
<li>
<p>函数组件需要是纯函数：</p>
<ul>
<li>相同输入 → 永远相同输出</li>
<li>不修改外部变量</li>
<li>不产生额外行为</li>
</ul>
</li>
</ul>

<ul>
<li>
<p>React 设定函数组件必须满足：</p>
<ul>
<li>相同的 props &amp; state → 必须产生完全相同的 UI</li>
</ul>

<ul>
<li>不依赖外部可变环境</li>
</ul>

<ul>
<li>没有无法预测的行为</li>
</ul>

<ul>
<li>渲染阶段必须同步、快速、纯净</li>
</ul>
</li>
</ul>
<p>换句话说：</p>
<blockquote>
<p><strong>组件函数必须像数学函数一样：输入 → 输出 UI</strong></p>
</blockquote>
<h4 data-id="heading-33">二、执行时机</h4>
<ul>
<li><strong>初次渲染后</strong> 执行（不会阻塞渲染）。</li>
<li><strong>依赖项变化</strong> 时重新执行。</li>
<li><strong>组件卸载前</strong> 执行清理函数。</li>
</ul>
<h4 data-id="heading-34">三、依赖数组 <code>[deps]</code></h4>





















<table><thead><tr><th>写法</th><th>执行时机</th></tr></thead><tbody><tr><td><code>useEffect(fn)</code></td><td>每次渲染都执行</td></tr><tr><td><code>useEffect(fn, [])</code></td><td>仅挂载和卸载时执行一次</td></tr><tr><td><code>useEffect(fn, [a, b])</code></td><td>当依赖项 a 或 b 改变时执行</td></tr></tbody></table>
<p>⚠️ React 比较依赖项是<strong>浅比较</strong>，如果依赖对象或数组的引用变了，即使内容没变也会触发。</p>
<h4 data-id="heading-35">四、清理函数</h4>
<p>返回一个函数，用于卸载或重新执行前清理副作用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> id = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'tick'</span>), <span class="hljs-number">1000</span>)
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(id)
}, [])
</code></pre>
<p>执行时机：</p>
<ol start="0">
<li>组件卸载时；</li>
<li>副作用重新执行前。</li>
</ol>
<h4 data-id="heading-36">五、面试常问点</h4>
<ol start="0">
<li>
<p><strong>useEffect 为什么在渲染后执行？</strong> 为了让渲染过程纯净，不被副作用打断。</p>
</li>
<li>
<p><strong>为什么要写依赖数组？</strong> 告诉 React 什么时候重新运行副作用，否则可能死循环。</p>
</li>
<li>
<p><strong>依赖项写错或少写会怎样？</strong> 可能导致状态不同步或逻辑失效（React 会在严格模式下警告）。</p>
</li>
<li>
<p><strong>useLayoutEffect 和 useEffect 的区别？</strong></p>
<ul>
<li><code>useEffect</code>：渲染完成后异步执行，不阻塞绘制。</li>
<li><code>useLayoutEffect</code>：DOM 更新后、浏览器绘制前同步执行，可用于测量 DOM。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-37">useRef</h3>
<h4 data-id="heading-38">核心定义</h4>
<ul>
<li><code>useRef</code> 是一个能在组件整个生命周期内 <strong>保持引用不变</strong> 的 Hook。</li>
<li>它返回一个可变对象 <code>{ current: ... }</code>，这个对象在组件的重新渲染中<strong>不会被重置</strong>。</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> ref = <span class="hljs-title function_">useRef</span>(initialValue)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(ref.<span class="hljs-property">current</span>) <span class="hljs-comment">// ref.current 保存的数据在组件多次渲染之间是持久的</span>
</code></pre>
<h4 data-id="heading-39">应用场景</h4>
<h5 data-id="heading-40">获取DOM节点</h5>
<ul>
<li>在React中使用useRef获取DOM比原生方式获取DOM更可靠</li>
<li><code>inputRef.current</code> 会指向对应的 DOM 元素。</li>
<li>通常用于：聚焦、滚动、测量宽高、绑定第三方库。</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>)

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    inputRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">focus</span>()
  }, [])

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{inputRef}</span> /&gt;</span></span>
}
</code></pre>
<h5 data-id="heading-41">保存 任意可变值（不触发重新渲染）</h5>
<p><code>count.current</code> 的值在组件重渲染时仍然保持；</p>
<p>修改 <code>ref.current</code> <strong>不会引起重新渲染</strong>；</p>
<p>所以它非常适合存储：</p>
<ul>
<li>前一次的值（用于比较）</li>
<li>定时器 id</li>
<li>防抖节流计数器</li>
<li>某个状态的缓存值</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Timer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">useRef</span>(<span class="hljs-number">0</span>)

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleClick</span> = (<span class="hljs-params"/>) =&gt; {
    count.<span class="hljs-property">current</span> += <span class="hljs-number">1</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count.<span class="hljs-property">current</span>)
  }

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span>&gt;</span>Click<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
}
</code></pre>
<h3 data-id="heading-42">useMemo</h3>
<ul>
<li>开发中，我们只要修改了父组件的数据，所有的子组件都会重新渲染，这是十分消耗性能的</li>
<li>如果我们希望子组件不要进行这种没有必要的重新渲染，我们可以将子组件继承PureComponent或者使用memo函数包裹</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { memo, useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">A</span> = (<span class="hljs-params">props</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'A1'</span>)
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'A2'</span>)
  })
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>A<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}

<span class="hljs-keyword">const</span> B = <span class="hljs-title function_">memo</span>(<span class="hljs-function">(<span class="hljs-params">props</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'B1'</span>)
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'B2'</span>)
  })
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>B<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
})

<span class="hljs-keyword">const</span> <span class="hljs-title function_">Home</span> = (<span class="hljs-params">props</span>) =&gt; {
  <span class="hljs-keyword">const</span> [a, setA] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'start'</span>)
    <span class="hljs-title function_">setA</span>(<span class="hljs-number">1</span>)
  }, [])
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">A</span> <span class="hljs-attr">n</span>=<span class="hljs-string">{a}</span> /&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">B</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<ul>
<li>将子组件B使用memo包裹之后，Home组件中的状态a的变化就不会导致B组件的重新渲染</li>
<li>但是在子组件B使用了父组件的<strong>某个引用类型的变量或者函数</strong>时，那么当父组件状态更新之后，这些变量和函数就会重新赋值，导致子组件B还是会重新渲染</li>
<li>想解决这个问题，就需要使用useMemo和useCallback了</li>
</ul>
<h3 data-id="heading-43">useCallback</h3>
<ul>
<li>当函数组件重新渲染时，其中的函数也会被重复定义多次</li>
<li>如果使用useCallBack对函数进行包裹，那么在依赖（第二个参数）不变的情况下，会返回同一个函数 这样子组件就不会因为函数的重新定义而导致重新渲染了</li>
<li>useMemo和useCallBack相似，缓存的是函数的返回值，一般用来优化变量，但是如果将useMemo的返回值定义为返回一个函数就可以实现useCallBack一样的功能</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//用useMemo实现同useCallback一样的效果</span>
   <span class="hljs-keyword">const</span> increment = <span class="hljs-title function_">useCallback</span>(fn,[])
   <span class="hljs-keyword">const</span> increment2 = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">()=&gt;</span>fn,[])
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { memo, useState, useEffect, useMemo } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">Home</span> = (<span class="hljs-params">props</span>) =&gt; {
  <span class="hljs-keyword">const</span> [a, setA] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)
  <span class="hljs-keyword">const</span> [b, setB] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">setA</span>(<span class="hljs-number">1</span>)
  }, [])

  <span class="hljs-keyword">const</span> add = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'b'</span>, b)
  }, [b])

  <span class="hljs-keyword">const</span> name = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> b + <span class="hljs-string">'xuxi'</span>
  }, [b])
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">A</span> <span class="hljs-attr">n</span>=<span class="hljs-string">{a}</span> /&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">B</span> <span class="hljs-attr">add</span>=<span class="hljs-string">{add}</span> <span class="hljs-attr">name</span>=<span class="hljs-string">{name}</span> /&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<h3 data-id="heading-44">useContext</h3>
<h4 data-id="heading-45">useContext 是什么？</h4>
<p><code>useContext</code> 是 React 的一个 Hook，用于：</p>
<ul>
<li>在<strong>函数组件中直接读取</strong>由上层组件 <code>Context.Provider</code> 提供的值。</li>
</ul>
<p>简单理解：</p>
<ul>
<li>不用一层层 props 传递，也能让深层组件拿到共享数据。</li>
</ul>
<h4 data-id="heading-46">语法</h4>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">value</span> = useContext(MyContext)
</code></pre>
<ul>
<li>MyContext 是通过 React.createContext() 创建的上下文对象。</li>
<li>useContext() 返回最近的 &lt;MyContext.Provider&gt; <strong>提供的 value</strong>。</li>
<li>当 Provider 的 value 变化时，所有<strong>使用该 context 的组件都会重新渲染。</strong></li>
</ul>
<h4 data-id="heading-47">使用步骤</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// context.js</span>
<span class="hljs-keyword">import</span> { createContext } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">ThemeContext</span> = <span class="hljs-title function_">createContext</span>(<span class="hljs-string">"light"</span>)

<span class="hljs-comment">// App.jsx</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ThemeContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./context"</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Child</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./Child"</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"dark"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Child</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeContext.Provider</span>&gt;</span></span>
  )
}

<span class="hljs-comment">// Child.jsx</span>
<span class="hljs-keyword">import</span> { useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ThemeContext</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"./context"</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Child</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> theme = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeContext</span>)
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>当前主题：{theme}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<h4 data-id="heading-48">特性</h4>

























<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td><strong>最近优先</strong></td><td>如果组件外层有多个相同类型的 Provider，会取最近一层的 value</td></tr><tr><td><strong>响应式更新</strong></td><td>Provider 的 value 改变，会触发所有消费该 Context 的组件重新渲染</td></tr><tr><td><strong>只能在函数组件或自定义 Hook 中使用</strong></td><td>不能在类组件或普通函数中调用</td></tr><tr><td><strong>不能脱离 Provider 使用</strong></td><td>如果没有 Provider 包裹，会使用 <code>createContext()</code> 时设置的默认值</td></tr></tbody></table>
<h4 data-id="heading-49">应用场景</h4>

























<table><thead><tr><th>场景</th><th>示例</th></tr></thead><tbody><tr><td>✅ 主题切换</td><td>dark / light 模式</td></tr><tr><td>✅ 登录状态</td><td>用户信息、Token</td></tr><tr><td>✅ 多语言切换</td><td>中英文语言包</td></tr><tr><td>✅ 全局配置</td><td>比如分页大小、API地址等</td></tr></tbody></table>
<h4 data-id="heading-50">常见问题</h4>
<p>useContext 和 props 传递的区别？</p>

























<table><thead><tr><th>对比项</th><th>props</th><th>useContext</th></tr></thead><tbody><tr><td>数据传递</td><td>一层层手动传递</td><td>任何层级都可直接拿到</td></tr><tr><td>灵活性</td><td>高（精确控制）</td><td>全局性（可能过度渲染）</td></tr><tr><td>适用场景</td><td>局部数据传递</td><td>全局共享状态</td></tr></tbody></table>
<p>useContext 的缺点是什么？</p>
<ul>
<li>当 <code>Provider</code> 的 value 改变时，<strong>所有消费它的组件都会重新渲染</strong>；</li>
<li>这可能导致<strong>性能问题</strong>（无论组件是否使用了 value 的具体字段）；</li>
<li>因此大型项目中往往结合 <strong><code>useReducer</code> 或 <code>Redux / Zustand</code> 等状态管理库</strong> 一起使用</li>
</ul>
<h3 data-id="heading-51">forwardRef</h3>
<p>在React开发中，有些时候我们需要获取DOM或者组件来进行某些操作</p>
<ul>
<li>
<p>如何使用ref来获取DOM</p>
<ul>
<li>使用createref创建ref对象，并且绑定到DOM元素上</li>
</ul>
</li>
<li>
<p><strong>forwardRef</strong>解决的问题是<strong>ref</strong>不会通<strong>props</strong>传递下去，因为ref和<strong>key</strong>一样被React做了特殊处理</p>
</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { <span class="hljs-title class_">PureComponent</span> ,createRef} <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">PureComponent</span> {
    <span class="hljs-comment">//创建ref</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">titleRef</span> = <span class="hljs-title function_">createRef</span>()
  }
  <span class="hljs-title function_">getNativeDOM</span>(<span class="hljs-params"/>){
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">titleRef</span>.<span class="hljs-property">current</span>)
  }
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{this.titleRef}</span>&gt;</span>hello world<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{e</span>=&gt;</span>this.getNativeDOM()}&gt;获取DOM<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
  }
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>
</code></pre>
<p>ref 的值根据节点的类型有所不同：</p>
<ol start="0">
<li>当<strong>ref</strong>属性作用于HTML属性时，接收底层DOM元素作为其<strong>current</strong>属性</li>
<li>当<strong>ref</strong>属性作用于class组件时，接收组件实例作为其current属性</li>
<li><strong>不能在函数组件上使用ref属性</strong>，因为他们没有实例</li>
</ol>
<p>想将ref挂载到函数组件内部的某个class组件或者HTML元素上时，我们需要使用React.forwardRef将函数组件包裹，从而将ref传递到组件内部</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//获取函数组件的某个DOM</span>
<span class="hljs-comment">//使用forwardRef之后，可以传入两个参数，第二个为ref，我们可以实现ref转发</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Fun</span> = <span class="hljs-title function_">forwardRef</span>(<span class="hljs-keyword">function</span> (<span class="hljs-params">props,ref</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{ref}</span>&gt;</span>hello react<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>
  )
})
</code></pre>
<p>使用ref作用于类组件，并调用类组件实例的方法</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { <span class="hljs-title class_">PureComponent</span>, createRef, forwardRef } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-comment">//类子组件</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloWorld</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">PureComponent</span> {
  <span class="hljs-title function_">test</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"test---"</span>)
  }
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>hello world<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span></span>
    )
  }
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">PureComponent</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">super</span>()
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">state</span> = {}
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">hwRef</span> = <span class="hljs-title function_">createRef</span>()
  }
  <span class="hljs-title function_">getComponent</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">//调用类组件实例的方法</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">hwRef</span>.<span class="hljs-property">current</span>)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">hwRef</span>.<span class="hljs-property">current</span>.<span class="hljs-title function_">test</span>()
  }
  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
      <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">HelloWorld</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{this.hwRef}</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{e</span> =&gt;</span> this.getComponent()}&gt;获取组件实例<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
  }
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">App</span>
</code></pre>
<h3 data-id="heading-52">useImperativeHandle</h3>
<ul>
<li>
<p>forwardRef使用带来的问题</p>
<ul>
<li>直接暴露给父组件，使得某些情况不可控</li>
<li>父组件拿到子组件之后可以进行任意的操作</li>
</ul>
</li>
<li>
<p>通过useImperativeHandle可以暴露固定的操作</p>
</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, {
  useRef,
  forwardRef, useImperativeHandle
} <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">const</span> <span class="hljs-title class_">HYInput</span> = <span class="hljs-title function_">forwardRef</span>(<span class="hljs-function">(<span class="hljs-params">props,ref</span>)=&gt;</span> {
  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>()
  <span class="hljs-title function_">useImperativeHandle</span>(ref,<span class="hljs-function">()=&gt;</span> {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">focus</span>: <span class="hljs-function">() =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">345</span>);
        inputRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">focus</span>()
      }
    } 
  })

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{inputRef}</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>/&gt;</span></span>
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">UseImperativeHandleHookDemo</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>()
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">HYInput</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{inputRef}/</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{e</span>=&gt;</span>inputRef.current.focus()}&gt;聚焦<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h3 data-id="heading-53">原理题</h3>
<h4 data-id="heading-54">React Hooks 为什么不能放在条件判断里？</h4>
<ul>
<li>
<p>React Hooks <strong>不能放在条件判断、循环或嵌套函数中</strong>，必须在组件的<strong>顶层</strong>调用。</p>
<ul>
<li>因为——<strong>React 是通过调用顺序来识别每一个 Hook 的。</strong></li>
</ul>
</li>
</ul>
<p>每个组件渲染时，React 会维护一个“Hook 调用链表”或“数组”， 类似这样（简化理解）：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 第一次渲染</span>
<span class="hljs-title function_">useState</span>(<span class="hljs-string">'A'</span>)   <span class="hljs-comment">// Hook 1</span>
<span class="hljs-title function_">useEffect</span>(...)  <span class="hljs-comment">// Hook 2</span>
<span class="hljs-title function_">useState</span>(<span class="hljs-string">'B'</span>)   <span class="hljs-comment">// Hook 3</span>
</code></pre>
<p>React 会按顺序记下每一个 Hook 对应的状态（存在 Fiber 节点上）。
下一次渲染时，React 会再次按<strong>相同顺序</strong>调用 Hook 来匹配之前的状态。</p>
<hr/>
<p>如果放在条件语句中会发生什么？</p>
<pre><code class="hljs language-scss" lang="scss">if (flag) {
  <span class="hljs-built_in">useState</span>(<span class="hljs-number">1</span>)
}
<span class="hljs-built_in">useEffect</span>(() =&gt; {})
</code></pre>
<ul>
<li>
<p>第一次渲染：</p>
<ul>
<li>flag = true → 执行 <code>useState</code>（Hook 1）</li>
<li>执行 <code>useEffect</code>（Hook 2）</li>
</ul>
</li>
<li>
<p>第二次渲染：</p>
<ul>
<li>flag = false → 跳过 <code>useState</code></li>
<li><code>useEffect</code> 变成了 Hook 1！</li>
</ul>
</li>
</ul>
<blockquote>
<p>🚨 React 内部匹配错位！ 本该给 <code>useEffect</code> 的 Hook 状态，被错误地分配成了之前的 <code>useState</code> 状态。</p>
</blockquote>
<p>结果可能报错：</p>
<pre><code class="hljs language-r" lang="r">Rendered fewer hooks than expected
Invalid hook <span class="hljs-built_in">call</span>
</code></pre>
<h4 data-id="heading-55">Hooks的执行顺序是如何保证的？</h4>
<ul>
<li>React 通过在每个 Fiber 节点上维护一个 <strong>Hook 链表</strong></li>
<li>并在每次渲染时按顺序遍历执行</li>
<li>从而确保每个 Hook 的状态和顺序一致。</li>
</ul>
<h4 data-id="heading-56">自定义 Hook 怎么避免闭包陷阱？</h4>
<ol start="0">
<li>使用函数式更新（最常用）</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prev</span> =&gt;</span> prev + <span class="hljs-number">1</span>)
</code></pre>
<ul>
<li><code>prev</code> 永远是最新 state</li>
<li>无需依赖闭包捕获的旧值</li>
<li>适用于事件回调、定时器、异步请求等</li>
</ul>
<ol start="2">
<li>用 <code>useRef</code> 保存最新值</li>
</ol>
<p>如果你需要在闭包里访问最新状态而不触发重新渲染：
const countRef = useRef(count)
useEffect(() =&gt; {
countRef.current = count
}, [count])</p>
<p>const logCount = () =&gt; {
console.log(countRef.current) // 永远是最新值
}</p>
<ul>
<li>异步函数或事件可以使用 <code>countRef.current</code></li>
<li>不影响 React 渲染流程</li>
</ul>
<h2 data-id="heading-57">组件渲染与性能优化</h2>
<h3 data-id="heading-58">React 组件何时重新渲染？</h3>
<ol start="0">
<li>
<p>state发生变化：只要你调用 <code>setState</code> 产生了<strong>新的值</strong>（引用变化），组件就会重新渲染。</p>
</li>
<li>
<p>props变化：只要<strong>父组件重新渲染</strong>，子组件也会跟着渲染（除非使用 <code>React.memo</code>）。</p>
<p>即使 props 内容没变 —— 只要父组件 render，子组件也会 render。</p>
</li>
<li>
<p>context变化：当某个 Context Provider 的 value 改变，所有消费该 context 的子组件都会重渲染。</p>
</li>
<li>
<p>父组件重新渲染导致子组件渲染（哪怕 props 不变）</p>
</li>
</ol>
<p>浅比较会对比：</p>
<ul>
<li><strong>基本类型值（number / string / boolean / null / undefined）</strong> → 直接比较值是否相等。</li>
<li><strong>引用类型（object / array / function）</strong> → <strong>只比较引用地址是否相同</strong>，不会比较内部的内容。</li>
</ul>
<p>React 在性能优化时会用浅比较，比如：</p>
<ul>
<li><strong>React.memo</strong></li>
<li><strong>PureComponent</strong></li>
<li><strong>shouldComponentUpdate</strong></li>
<li><strong>useMemo / useCallback 的依赖项比较</strong></li>
<li><strong>useEffect / useCallback 的依赖数组</strong></li>
</ul>
<p>因为浅比较非常快，不需要深度遍历对象。</p>
<ul>
<li>
<p>浅比较带来的典型问题</p>
<ul>
<li>使用 inline function 导致子组件重新渲染</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-scss" lang="scss">&lt;Child onClick={() =&gt; <span class="hljs-built_in">setCount</span>(count + <span class="hljs-number">1</span>)} /&gt;
</code></pre>
<p>每次父组件 render 时都会创建新的函数引用 → 浅比较结果：不同 → 子组件重新渲染</p>
<ul>
<li>
<p>解决方法</p>
<ul>
<li>用 <strong>useCallback 固定函数引用</strong></li>
<li>用 <strong>useMemo 固定对象 / 数组引用</strong></li>
<li>子组件用 <strong>React.memo</strong></li>
</ul>
</li>
</ul>
<h3 data-id="heading-59">如何优化一个大表格或长列表的渲染性能？（虚拟列表）</h3>
<ul>
<li>
<p>为什么需要虚拟列表？</p>
<ul>
<li>
<p>当列表有 <strong>成百上千甚至上万条数据</strong>时：</p>
<ul>
<li>浏览器会创建大量 DOM（慢）</li>
<li>布局、重排、重绘消耗巨大（卡）</li>
<li>滚动时频繁触发渲染（卡顿）</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>👉 <strong>核心思路</strong>： 只渲染<strong>可视区域内</strong>的那几十个节点，其余内容用占位高度撑开。</p>
<ul>
<li>
<p>什么时候用虚拟列表</p>
<ul>
<li>
<p>满足任一即可使用虚拟列表：</p>
<ul>
<li>单页表格数据量 &gt; 200 行</li>
<li>单页列表 &gt; 300 行</li>
<li>存在大量复杂 DOM（图片、按钮、操作列）</li>
<li>有频繁更新、滚动操作</li>
</ul>
</li>
</ul>
</li>
<li>
<p>核心原理（一句话版本）</p>
<ul>
<li>只有可视区域 + 缓冲区的元素真实渲染</li>
<li>其他区域只用一个大容器撑开高度</li>
<li>视觉上像完整列表，但实际 DOM 数量永远保持几十个</li>
</ul>
</li>
<li>
<p>虚拟列表关键技术</p>
<ul>
<li>
<p>容器高度：列表容器要<strong>固定高度或可计算高度</strong>，否则无法计算可视范围。</p>
</li>
<li>
<p>每行高度：</p>
<ul>
<li>固定高度：最好实现，可用rowheight直接算</li>
<li>不定高度：需要实时记录高度（难度更高）</li>
</ul>
</li>
<li>
<p>计算可视区域的起止 index</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">startIndex</span> = Math.floor(scrollTop / rowHeight)
<span class="hljs-attr">endIndex</span> = startIndex + 可视区域行数 + buffer
</code></pre>
</li>
<li>
<p>渲染可视区域数据</p>
<ul>
<li>只渲染这一小段数据即可。</li>
</ul>
</li>
<li>
<p><strong>使用 translateY 把渲染的内容“挪”到正确位置</strong></p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">style</span>=<span class="hljs-string">"transform: translateY(startIndex * rowHeight px)"</span>
</code></pre>
</li>
</ul>
</li>
<li>
<p>前端常用虚拟列表方案</p>
<ul>
<li>
<p>React：<code>react-window</code></p>
<ul>
<li>轻量、简单、性能极佳。</li>
<li><code>&lt;FixedSizeList&gt;</code> 固定行高列表</li>
<li><code>&lt;VariableSizeList&gt;</code> 不定高度列表</li>
<li><code>&lt;FixedSizeGrid&gt;</code> 表格（大表格强烈推荐）</li>
</ul>
</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">import { FixedSizeList as List } from "react-window"<span class="hljs-comment">;</span>
​
&lt;List
  <span class="hljs-attr">height</span>={<span class="hljs-number">600</span>}
  <span class="hljs-attr">width</span>={<span class="hljs-number">800</span>}
  <span class="hljs-attr">itemSize</span>={<span class="hljs-number">40</span>}
  <span class="hljs-attr">itemCount</span>={list.length}
&gt;
  {({ index, style }) =&gt; (
    &lt;div <span class="hljs-attr">style</span>={style}&gt;{list[index].name}&lt;/div&gt;
  )}
&lt;/List&gt;
</code></pre>
<ul>
<li>Ant Design v5</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">&lt;Table
  <span class="hljs-attr">scroll</span>={{ y: <span class="hljs-number">600</span> }}
  virtual
  <span class="hljs-attr">columns</span>={columns}
  <span class="hljs-attr">dataSource</span>={data}
/&gt;
</code></pre>
<ul>
<li>自己实现</li>
</ul>
<pre><code class="hljs language-ini" lang="ini">import React, { useRef, useState, useEffect } from "react"<span class="hljs-comment">;</span>
​
export default function VirtualList({ itemHeight, height, data, renderItem }) {
  const <span class="hljs-attr">containerRef</span> = useRef(null)<span class="hljs-comment">;</span>
  const <span class="hljs-section">[startIndex, setStartIndex]</span> = useState(0)<span class="hljs-comment">;</span>
​
  const <span class="hljs-attr">visibleCount</span> = Math.ceil(height / itemHeight)<span class="hljs-comment">; // 可视区域展示多少条</span>
​
  // 滚动事件
  const <span class="hljs-attr">onScroll</span> = () =&gt; {
    const <span class="hljs-attr">scrollTop</span> = containerRef.current.scrollTop<span class="hljs-comment">;</span>
    const <span class="hljs-attr">newStartIndex</span> = Math.floor(scrollTop / itemHeight)<span class="hljs-comment">;</span>
    setStartIndex(newStartIndex)<span class="hljs-comment">;</span>
  }<span class="hljs-comment">;</span>
​
  // 当前需要渲染的数据
  const <span class="hljs-attr">endIndex</span> = startIndex + visibleCount<span class="hljs-comment">;</span>
  const <span class="hljs-attr">visibleData</span> = data.slice(startIndex, endIndex)<span class="hljs-comment">;</span>
​
  // 用两个 padding 占位本来应该存在的高度
  const <span class="hljs-attr">paddingTop</span> = startIndex * itemHeight<span class="hljs-comment">;</span>
  const <span class="hljs-attr">paddingBottom</span> = (data.length - endIndex) * itemHeight<span class="hljs-comment">;</span>
​
  return (
    &lt;div
      <span class="hljs-attr">ref</span>={containerRef}
      <span class="hljs-attr">style</span>={{
        height,
        overflowY: "auto",
        border: "1px solid <span class="hljs-comment">#ccc",</span>
      }}
      <span class="hljs-attr">onScroll</span>={<span class="hljs-literal">on</span>Scroll}
    &gt;
      &lt;div <span class="hljs-attr">style</span>={{ paddingTop, paddingBottom }}&gt;
        {visibleData.map((item, i) =&gt;
          renderItem(item, startIndex + i)
        )}
      &lt;/div&gt;
    &lt;/div&gt;
  )<span class="hljs-comment">;</span>
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一个有趣的CSS题目]]></title>    <link>https://juejin.cn/post/7577702891273977891</link>    <guid>https://juejin.cn/post/7577702891273977891</guid>    <pubDate>2025-11-30T07:01:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577702891273977891" data-draft-id="7577702891273945123" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一个有趣的CSS题目"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-30T07:01:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小熊哥722"/> <meta itemprop="url" content="https://juejin.cn/user/758013551998826"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一个有趣的CSS题目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/758013551998826/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小熊哥722
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T07:01:27.000Z" title="Sun Nov 30 2025 07:01:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p>前几天无意间看到一个有趣的题，题目很简单，但是最终的结果却出人意料，题目是这样的：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"theme-color"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"blue"</span>/&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>Document<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
  <span class="hljs-selector-class">.parent</span>{
    <span class="hljs-attribute">display</span>: flex;
    <span class="hljs-attribute">flex-direction</span>: column;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">600px</span>;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
    <span class="hljs-attribute">background-color</span>: aqua;
  }
  <span class="hljs-selector-class">.header</span>{
    <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
    <span class="hljs-attribute">background-color</span>: red;
  }
  <span class="hljs-selector-class">.fotter</span>{
    <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
    <span class="hljs-attribute">background-color</span>: blue;
  }
  <span class="hljs-selector-class">.content</span>{
    <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  }
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"parent"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"header"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"fotter"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p>这段代码中的content的高度是多少，大家可以自己想一下，稍微思考一下。接下来让我们看一下豆包的回答：
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1079a08e360f4b7088a1ea8ea5df828e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP54aK5ZOlNzIy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765090886&amp;x-signature=X8vqC5v5pPJp9HsAbLY4CXNYoh8%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​
再看一下通义千问的回答：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b63a5c94b0b4a02854b1ba75d5e6eeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP54aK5ZOlNzIy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765090886&amp;x-signature=XjwJ5pkNLCMv8M3r5R5dwSYrUA8%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<p>再看一下deepseek的回答：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6feabc6785084bf7868530bd58ae9a78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP54aK5ZOlNzIy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765090886&amp;x-signature=mIXQk8qkFIKNC1KNOUXXzgFAW9A%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<p>最后再看看Gemini3的回答：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da4d737e7b56446b9c252ccbcc795171~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP54aK5ZOlNzIy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765090886&amp;x-signature=Q%2BLwi83ac8kvRAnvISj34ifpeU4%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<p>大家可能以为content的高度不就是200px吗，但是结果真的是这样的吗？</p>
<p>请大家看一下最终的结果：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/261004008f4e41c8961b0e71dbfedf12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP54aK5ZOlNzIy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765090886&amp;x-signature=rbP%2FoLzZHx4WUjMoRA71SJSsXn8%3D" alt="" loading="lazy"/><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/>​</p>
<p>       大家会看到content的高度为360px,header和footer的高度为120px，是不是感觉不可思议，为啥会这样嘞，这个问题，想问ai就会发现，这咋问啊，ai全是错的，那我来告诉你们答案（当然我说的也不一定对，但是大差不差，结果肯定是对的）：</p>
<blockquote>
<ul>
<li>percent height 会被解析为父容器的绝对值：content 的 height:100% → 600px（父高度）。</li>
<li>每个子项的 flex base size（假设基准）分别是 header=200, content=600, footer=200，总和 = 1000px。</li>
<li>可用主轴空间 = 600px，差额（需要收缩） = 1000 - 600 = 400px。</li>
<li>默认 flex-shrink = 1，按基准尺寸比例收缩：content 收缩量 = 600/1000 * 400 = 240 → 最终 content 高度 = 600 - 240 = 360px。</li>
</ul>
<p>参考（建议重点看 W3C 规范里的算法）：</p>
<ul>
<li>
<p>W3C Flexbox 规范（详细算法）：<a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">www.w3.org/TR/css-flex…</a></p>
</li>
<li>
<p>W3C 解析可伸缩长度（resolve flexible lengths）：<a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">www.w3.org/TR/css-flex…</a></p>
</li>
<li>
<p>MDN（概念与属性）：</p>
<ul>
<li>flex-basis：<a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></li>
<li>flex-shrink：<a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></li>
<li>Flexbox 教程（概览）：<a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer">developer.mozilla.org/zh-CN/docs/…</a></li>
</ul>
</li>
</ul>
</blockquote>
<p>大家可以详细看看理解一下，当然不看也没关系，知道这个计算规则也 可以了，至少比ai强了。</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端转战后端：JavaScript 与 Java 对照学习指南 (第一篇 - 深度进阶版)]]></title>    <link>https://juejin.cn/post/7577905525997584425</link>    <guid>https://juejin.cn/post/7577905525997584425</guid>    <pubDate>2025-11-30T07:24:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577905525997584425" data-draft-id="7577969462860169279" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端转战后端：JavaScript 与 Java 对照学习指南 (第一篇 - 深度进阶版)"/> <meta itemprop="keywords" content="JavaScript,Java"/> <meta itemprop="datePublished" content="2025-11-30T07:24:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="汤姆Tom"/> <meta itemprop="url" content="https://juejin.cn/user/4112607842680478"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端转战后端：JavaScript 与 Java 对照学习指南 (第一篇 - 深度进阶版)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4112607842680478/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    汤姆Tom
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T07:24:20.000Z" title="Sun Nov 30 2025 07:24:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>对于习惯了 JavaScript (JS) 灵活性的前端开发者来说，Java 看起来可能充满了繁琐的定义和样板代码。但实际上，现代 Java (Java 8/11/17+) 已经吸收了很多函数式编程的特性，写起来越来越顺手。</p>
<p>本篇指南将通过 <strong>JS vs Java</strong> 代码对比的方式，深度解析 <strong>类型系统</strong>、<strong>流式处理 (Stream API)</strong> 、<strong>集合操作</strong> 以及 <strong>常见的内存陷阱</strong>。</p>
<h2 data-id="heading-0">1. 核心思维转变：从“自由”到“约束”</h2>
<p>在开始写代码前，需要建立三个核心认知的转变：</p>
<ol>
<li><strong>入口函数</strong>：JS 代码通常从上到下执行；Java 程序必须从一个 <code>main</code> 方法开始。</li>
<li><strong>类型约束</strong>：JS 是 <code>let a = 1</code> (a 随后可以变成字符串)；Java 是 <code>int a = 1</code> (a 永远只能是整数)。</li>
<li><strong>引用与值</strong>：JS 对对象默认是引用传递，Java 也是引用传递（操作内存地址），但 Java 的<strong>字符串是不可变的</strong>，且比较机制完全不同。</li>
</ol>
<h2 data-id="heading-1">2. 变量声明：<code>var</code> 的真相与基本类型</h2>
<p>Java 10 引入了 <code>var</code>，这让前端感到非常亲切，但它和 JS 的 <code>let/var</code> 有本质区别。</p>
<h3 data-id="heading-2">场景：类型推断与作用域</h3>
<h4 data-id="heading-3">JavaScript</h4>
<pre><code class="hljs language-ini" lang="ini">// JS: 动态类型
let <span class="hljs-attr">id</span> = <span class="hljs-number">10</span><span class="hljs-comment">;</span>
<span class="hljs-attr">id</span> = <span class="hljs-string">"User-10"</span><span class="hljs-comment">; // ✅ 合法，类型变了</span>

// 作用域
if (true) {
    var <span class="hljs-attr">oldVar</span> = <span class="hljs-string">"I leak out"</span><span class="hljs-comment">; // var 会提升 (Hoisting)</span>
    let <span class="hljs-attr">newLet</span> = <span class="hljs-string">"I am safe"</span><span class="hljs-comment">;  // 块级作用域</span>
}
console.log(oldVar)<span class="hljs-comment">; // 能打印</span>
</code></pre>
<h4 data-id="heading-4">Java</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">VariableDeepDive</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// --- 1. Java 10+ 的 var (局部变量类型推断) ---</span>
        <span class="hljs-comment">// 看起来像 JS，但实际上编译器在编译时就确定了类型</span>
        <span class="hljs-type">var</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> <span class="hljs-number">10</span>; <span class="hljs-comment">// 编译器推断 id 是 int 类型</span>
        <span class="hljs-comment">// id = "User-10"; // ❌ 报错！一旦推断为 int，就永远是 int</span>
        
        <span class="hljs-comment">// --- 2. 基本数据类型 vs 包装类型 (深度解析) ---</span>
        <span class="hljs-comment">// int: 存数值，占用内存少，默认值 0</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-comment">// Integer: 存对象的地址，默认值 null</span>
        <span class="hljs-comment">// 自动装箱(Autoboxing): Java 自动把 int 5 转为 Integer 对象</span>
        <span class="hljs-type">Integer</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>; 
        
        <span class="hljs-comment">// ⚠️ 坑：空指针异常 (NPE)</span>
        <span class="hljs-type">Integer</span> <span class="hljs-variable">unknownScore</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-comment">// int finalScore = unknownScore; // ❌ 运行时崩溃！拆箱 null 会报错</span>
        
        <span class="hljs-comment">// 最佳实践：</span>
        <span class="hljs-comment">// 数据库实体类、泛型列表用 Integer</span>
        <span class="hljs-comment">// 局部变量循环计数用 int</span>
    }
}
</code></pre>
<h2 data-id="heading-5">3. 字符串：不可变性与内存陷阱</h2>
<p>JS 的字符串很简单，Java 的字符串为了性能做了很多底层优化（字符串常量池），导致比较逻辑不同。</p>
<h3 data-id="heading-6">场景：拼接与比较</h3>
<h4 data-id="heading-7">JavaScript</h4>
<pre><code class="hljs language-ini" lang="ini">let <span class="hljs-attr">a</span> = <span class="hljs-string">"hello"</span><span class="hljs-comment">;</span>
let <span class="hljs-attr">b</span> = <span class="hljs-string">"hello"</span><span class="hljs-comment">;</span>
console.log(<span class="hljs-attr">a</span> === b)<span class="hljs-comment">; // true</span>

// 模板字符串
let <span class="hljs-attr">msg</span> = `Value is <span class="hljs-variable">${a}</span>`<span class="hljs-comment">; </span>
</code></pre>
<h4 data-id="heading-8">Java</h4>
<pre><code class="hljs language-ini" lang="ini">public class StringDeepDive {
    public static void main(String<span class="hljs-section">[]</span> args) {
        // --- 1. 比较陷阱 ---
        String <span class="hljs-attr">s1</span> = <span class="hljs-string">"hello"</span><span class="hljs-comment">; // 存放在常量池</span>
        String <span class="hljs-attr">s2</span> = new String(<span class="hljs-string">"hello"</span>)<span class="hljs-comment">; // 强制在堆内存创建新对象</span>
        
        // ❌ == 比较的是内存地址
        System.out.println(<span class="hljs-attr">s1</span> == s2)<span class="hljs-comment">; // false</span>
        
        // ✅ equals 比较的是字符内容
        System.out.println(s1.equals(s2))<span class="hljs-comment">; // true</span>
        
        // --- 2. 拼接的性能问题 ---
        // 简单的拼接编译器会自动优化
        String <span class="hljs-attr">msg</span> = <span class="hljs-string">"Value is "</span> + s1<span class="hljs-comment">;</span>
        
        // ⚠️ 循环中拼接严禁使用 "+"
        String <span class="hljs-attr">res</span> = <span class="hljs-string">""</span><span class="hljs-comment">;</span>
        // ❌ 性能极差，每次循环都会创建新 String 对象
        // for(int <span class="hljs-attr">i</span>=<span class="hljs-number">0</span><span class="hljs-comment">; i&lt;100; i++) res += i; </span>
        
        // ✅ 正确做法：StringBuilder (类似 JS 数组 join)
        StringBuilder <span class="hljs-attr">sb</span> = new StringBuilder()<span class="hljs-comment">;</span>
        for(int <span class="hljs-attr">i</span>=<span class="hljs-number">0</span><span class="hljs-comment">; i&lt;100; i++) {</span>
            sb.append(i)<span class="hljs-comment">;</span>
        }
        System.out.println(sb.toString())<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h2 data-id="heading-9">4. 数组与列表：Stream API (前端最爱)</h2>
<p>Java 8 引入的 Stream API 简直就是前端 <code>Array.prototype</code> 方法（filter, map, reduce）的亲兄弟。</p>
<h3 data-id="heading-10">场景：筛选大于 10 的数字并翻倍</h3>
<h4 data-id="heading-11">JavaScript</h4>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">numbers</span> = [<span class="hljs-number">5</span>, <span class="hljs-number">12</span>, <span class="hljs-number">8</span>, <span class="hljs-number">20</span>]<span class="hljs-comment">;</span>

// 链式调用：先过滤，再映射
const <span class="hljs-attr">result</span> = numbers
    .filter(<span class="hljs-attr">n</span> =&gt; n &gt; <span class="hljs-number">10</span>)
    .map(<span class="hljs-attr">n</span> =&gt; n * <span class="hljs-number">2</span>)<span class="hljs-comment">;</span>

console.log(result)<span class="hljs-comment">; // [24, 40]</span>
</code></pre>
<h4 data-id="heading-12">Java (使用 Stream)</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;
<span class="hljs-keyword">import</span> java.util.stream.Collectors;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StreamExample</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 快速初始化 List (Java 9+)</span>
        List&lt;Integer&gt; numbers = List.of(<span class="hljs-number">5</span>, <span class="hljs-number">12</span>, <span class="hljs-number">8</span>, <span class="hljs-number">20</span>); 
        <span class="hljs-comment">// 注意：List.of 创建的是"不可变列表"，不能 add/remove</span>
        
        <span class="hljs-comment">// --- Stream API ---</span>
        List&lt;Integer&gt; result = numbers.stream() <span class="hljs-comment">// 1. 开启流</span>
            .filter(n -&gt; n &gt; <span class="hljs-number">10</span>)                <span class="hljs-comment">// 2. 过滤 (Predicate)</span>
            .map(n -&gt; n * <span class="hljs-number">2</span>)                    <span class="hljs-comment">// 3. 映射 (Function)</span>
            .collect(Collectors.toList());      <span class="hljs-comment">// 4. 收集结果回 List</span>
            
        System.out.println(result); <span class="hljs-comment">// [24, 40]</span>
        
        <span class="hljs-comment">// --- 传统遍历 (Enhanced For-Loop) ---</span>
        <span class="hljs-comment">// 类似 JS 的 for (const n of numbers)</span>
        <span class="hljs-keyword">for</span> (Integer n : numbers) {
            System.out.println(n);
        }
    }
}
</code></pre>
<p><strong>🔍 差异点：</strong></p>
<ul>
<li>JS 的数组方法直接作用于数组。Java 必须先调用 <code>.stream()</code> 转换成流，处理完后再 <code>.collect()</code> 回集合。</li>
<li>Java 的 <code>map</code> 必须返回新值，不能像 JS 某些骚操作里那样不返回值只做副作用（虽然 JS 规范也不建议那样做）。</li>
</ul>
<h2 data-id="heading-13">5. 字典与映射：Map 的花式操作</h2>
<p>Map 在后端开发中无处不在，尤其是在处理 JSON 数据时。</p>
<h3 data-id="heading-14">场景：初始化与遍历</h3>
<h4 data-id="heading-15">JavaScript</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> map = {
    <span class="hljs-string">"key1"</span>: <span class="hljs-string">"value1"</span>,
    <span class="hljs-string">"key2"</span>: <span class="hljs-string">"value2"</span>
};

<span class="hljs-comment">// 遍历</span>
<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">entries</span>(map).<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">[k, v]</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(k, v);
});
</code></pre>
<h4 data-id="heading-16">Java</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">HashMap</span>;
<span class="hljs-keyword">import</span> java.<span class="hljs-property">util</span>.<span class="hljs-property">Map</span>;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MapDeepDive</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"><span class="hljs-built_in">String</span>[] args</span>) {
        <span class="hljs-comment">// --- 1. 快速初始化 (Java 9+) ---</span>
        <span class="hljs-comment">// 创建不可变 Map，最多支持 10 对</span>
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; quickMap = <span class="hljs-title class_">Map</span>.<span class="hljs-title function_">of</span>(
            <span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>,
            <span class="hljs-string">"key2"</span>, <span class="hljs-string">"value2"</span>
        );
        
        <span class="hljs-comment">// 常规可变 Map</span>
        <span class="hljs-title class_">Map</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        map.<span class="hljs-title function_">put</span>(<span class="hljs-string">"key1"</span>, <span class="hljs-string">"value1"</span>);
        
        <span class="hljs-comment">// --- 2. 遍历 ---</span>
        <span class="hljs-comment">// 方式 A: forEach + Lambda (最像 JS)</span>
        map.<span class="hljs-title function_">forEach</span>((k, v) -&gt; {
            <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"Key: "</span> + k + <span class="hljs-string">", Val: "</span> + v);
        });
        
        <span class="hljs-comment">// 方式 B: entrySet (性能好，传统方式)</span>
        <span class="hljs-comment">// Map.Entry 相当于 JS 的 [key, value] 元组</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-title class_">Map</span>.<span class="hljs-property">Entry</span>&lt;<span class="hljs-title class_">String</span>, <span class="hljs-title class_">String</span>&gt; entry : map.<span class="hljs-title function_">entrySet</span>()) {
            <span class="hljs-title class_">String</span> k = entry.<span class="hljs-title function_">getKey</span>();
            <span class="hljs-title class_">String</span> v = entry.<span class="hljs-title function_">getValue</span>();
        }
    }
}
</code></pre>
<h2 data-id="heading-17">6. 常见痛点对照表 (Cheatsheet)</h2>


















































<table><thead><tr><th>场景</th><th>JavaScript</th><th>Java (最佳实践)</th></tr></thead><tbody><tr><td><strong>定义不可变常量</strong></td><td><code>const API_URL = "..."</code></td><td><code>static final String API_URL = "...";</code></td></tr><tr><td><strong>模板字符串</strong></td><td><code>`Hello ${name}`</code></td><td><code>String.format("Hello %s", name)</code> 或 <code>"Hello " + name</code></td></tr><tr><td><strong>数组包含</strong></td><td><code>arr.includes(x)</code></td><td><code>list.contains(x)</code></td></tr><tr><td><strong>数组判空</strong></td><td><code>arr.length === 0</code></td><td><code>list.isEmpty()</code></td></tr><tr><td><strong>对象取值防崩</strong></td><td><code>obj?.prop</code></td><td><code>Optional.ofNullable(obj).map(...)</code> (较复杂) 或简单判空 <code>if (obj != null)</code></td></tr><tr><td><strong>JSON 解析</strong></td><td><code>JSON.parse(str)</code></td><td>使用库：Jackson (<code>objectMapper.readValue(...)</code>)</td></tr><tr><td><strong>JSON 序列化</strong></td><td><code>JSON.stringify(obj)</code></td><td>使用库：Jackson (<code>objectMapper.writeValueAsString(...)</code>)</td></tr><tr><td><strong>比较对象</strong></td><td><code>a === b</code> (通常不行)</td><td><code>a.equals(b)</code> (必须重写 equals 方法)</td></tr></tbody></table>
<h3 data-id="heading-18">核心建议</h3>
<ol>
<li><strong>善用 IDE</strong>：IntelliJ IDEA 是 Java 开发的神器。当你不知道方法名时，输入 <code>.</code> 然后停顿，它会列出所有可用方法，这比查文档快得多。</li>
<li><strong>拥抱类型</strong>：不要为了省事全部用 <code>Object</code> 或 <code>Map&lt;String, Object&gt;</code> 模拟 JS 对象。定义一个明确的 <code>User</code> 类（Class）虽然前期麻烦，但在后期维护和重构时，它的优势会碾压动态类型。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么 SVG 能在现代前端中胜出？]]></title>    <link>https://juejin.cn/post/7577691061034172462</link>    <guid>https://juejin.cn/post/7577691061034172462</guid>    <pubDate>2025-11-30T08:14:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577691061034172462" data-draft-id="7577970969395183657" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么 SVG 能在现代前端中胜出？"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-30T08:14:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吹水一流"/> <meta itemprop="url" content="https://juejin.cn/user/993614244613543"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么 SVG 能在现代前端中胜出？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614244613543/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吹水一流
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T08:14:41.000Z" title="Sun Nov 30 2025 08:14:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果你关注前端图标的发展，会发现一个现象：</p>
<p>过去前端图标主要有三种方案：</p>
<ul>
<li>
<p>PNG 小图（配合雪碧图）</p>
</li>
<li>
<p>Iconfont</p>
</li>
<li>
<p>SVG</p>
</li>
</ul>
<p>到了今天，大部分中大型项目都把图标系统全面迁移到 SVG。<br/>
无论 React/Vue 项目、新框架（Next/Remix/Nuxt），还是大厂的设计规范（Ant Design、Material、Carbon），基本都默认 SVG。</p>
<p>为什么是 SVG 胜出？<br/>
为什么不是 Iconfont、不是独立 PNG、不是雪碧图？<br/>
答案不是一句“清晰不失真”这么简单。</p>
<p>下面从前端实际开发的角度，把 SVG 胜出的原因讲透。</p>
<hr/>
<h2 data-id="heading-0"><strong>一、SVG 为什么比位图（PNG/JPG）更强？</strong></h2>
<h3 data-id="heading-1">① <strong>矢量图永不失真（核心优势）</strong></h3>
<p>PNG/JPG 是位图，只能按像素存图。<br/>
移动端倍率屏越来越高（2x、3x、4x……），一张 24px 的 PNG 在 iPhone 高分屏里可能看起来糊成一团。</p>
<p>SVG 是矢量图，数学计算绘制：</p>
<ul>
<li>
<p>任意缩放不糊</p>
</li>
<li>
<p>任意清晰度场景都不怕</p>
</li>
<li>
<p>深色模式也不会变形</p>
</li>
</ul>
<p>这点直接解决了前端图标领域长期存在的一个痛点：<strong>适配成本太高</strong>。</p>
<hr/>
<h3 data-id="heading-2">② <strong>体积小、多级复用不浪费</strong></h3>
<p>同样一个图标：</p>
<ul>
<li>
<p>PNG 做 1x/2x/3x 需要三份资源</p>
</li>
<li>
<p>SVG 只要一份</p>
</li>
</ul>
<p>而且：</p>
<ul>
<li>
<p>SVG 本质是文本</p>
</li>
<li>
<p>gzip 压缩非常有效</p>
</li>
</ul>
<p>在 CDN 下，通常能压到个位数 KB，轻松复用。</p>
<hr/>
<h3 data-id="heading-3">③ <strong>图标换色非常容易</strong></h3>
<p>PNG 改颜色很麻烦：</p>
<ul>
<li>
<p>设计师改</p>
</li>
<li>
<p>重新导出</p>
</li>
<li>
<p>重新上传/构建</p>
</li>
</ul>
<p>Iconfont 的颜色只能统一，只能覆盖轮廓颜色，多色很麻烦。</p>
<p>SVG 则非常灵活：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.icon</span> {
  fill: currentColor;
}
</code></pre>
<p>可以跟随字体颜色变化，支持 hover、active、主题色。</p>
<p><strong>深浅模式切换不需要任何额外资源。</strong></p>
<hr/>
<h3 data-id="heading-4">④ <strong>支持 CSS 动画、交互效果</strong></h3>
<p>SVG 不只是图标文件，它是 DOM，可以直接加动画：</p>
<ul>
<li>
<p>stroke 动画</p>
</li>
<li>
<p>路径绘制动画</p>
</li>
<li>
<p>颜色渐变</p>
</li>
<li>
<p>hover 发光</p>
</li>
<li>
<p>多段路径动态控制</p>
</li>
</ul>
<p>PNG 和 Iconfont 都做不到这种级别的交互。</p>
<p>很多现代 UI 的微动效（Loading、赞、收藏），都是基于 SVG 完成。</p>
<hr/>
<h2 data-id="heading-5"><strong>二、SVG 为什么比 iconfont 更强？</strong></h2>
<p>Iconfont 在 2015~2019 年非常火，但明显已经退潮了。<br/>
原因有以下几个：</p>
<hr/>
<h3 data-id="heading-6">① 字体图标本质是“字符”而不是图形</h3>
<p>这带来大量问题：</p>
<h4 data-id="heading-7">● 不能多色</h4>
<p>只能 monochrome，彩色图标很难实现。</p>
<h4 data-id="heading-8">● 渲染脆弱</h4>
<p>在 Windows 某些字体渲染环境下会出现：</p>
<ul>
<li>
<p>发虚</p>
</li>
<li>
<p>锯齿</p>
</li>
<li>
<p>baseline 不一致</p>
</li>
</ul>
<h4 data-id="heading-9">● 字符冲突</h4>
<p>不同项目的字体图标可能互相覆盖。</p>
<p>相比之下，SVG 是独立图形文件，没有这些问题。</p>
<hr/>
<h3 data-id="heading-10">② iconfont 需要加载字体文件，失败会出现“乱码方块”</h3>
<p>如果字体文件没加载成功，你会看到：</p>
<blockquote>
<p>☐ ☐ ☐ ☐</p>
</blockquote>
<p>这在弱网、支付类页面、海外环境都非常常见。</p>
<p>SVG 就没有这个风险。</p>
<hr/>
<h3 data-id="heading-11">③ iconfont 不利于按需加载</h3>
<p>字体文件通常包含几十甚至几百个图标：<br/>
<strong>一次加载很重，不够精细。</strong></p>
<p>SVG 可以做到按需加载：</p>
<ul>
<li>
<p>一个组件一个 SVG</p>
</li>
<li>
<p>一个页面只引入用到的部分</p>
</li>
<li>
<p>可组合、可动态切换</p>
</li>
</ul>
<p>对于现代构建体系非常友好。</p>
<hr/>
<h2 data-id="heading-12"><strong>三、SVG 为什么比“新版雪碧图”更强？</strong></h2>
<p>即便抛开 iconfont，PNG 雪碧图也完全被淘汰。</p>
<p>原因很简单：</p>
<ul>
<li>
<p>雪碧图文件大</p>
</li>
<li>
<p>缓存粒度差</p>
</li>
<li>
<p>不可按需加载</p>
</li>
<li>
<p>维护复杂</p>
</li>
<li>
<p>retina 适配麻烦</p>
</li>
<li>
<p>颜色不可动态变更</p>
</li>
</ul>
<p>而 SVG 天生具备现代开发所需的一切特性：</p>
<ul>
<li>
<p>轻量化</p>
</li>
<li>
<p>组件化</p>
</li>
<li>
<p>可变色</p>
</li>
<li>
<p>可动画</p>
</li>
<li>
<p>可 inline</p>
</li>
<li>
<p>可自动 tree-shaking</p>
</li>
</ul>
<p>雪碧图本质上是为了“减少请求数”而生的产物，<br/>
但在 HTTP/2/3 中已经没有价值。</p>
<p>而 SVG 不是 hack，而是<strong>自然适配现代 Web 的技术方案</strong>。</p>
<hr/>
<h2 data-id="heading-13"><strong>四、SVG 为什么能在工程体系里更好地落地？</strong></h2>
<p>现代构建工具（Vite / Webpack / Rollup）原生支持 SVG：</p>
<ul>
<li>
<p>转组件</p>
</li>
<li>
<p>优化路径</p>
</li>
<li>
<p>压缩</p>
</li>
<li>
<p>自动雪碧（symbol sprite）</p>
</li>
<li>
<p>Tree-shaking</p>
</li>
<li>
<p>资源分包</p>
</li>
</ul>
<p>这让 SVG 完全融入工程体系，而不是外挂方案。</p>
<p>例如：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Logo</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./logo.svg'</span>
</code></pre>
<p>你可以：</p>
<ul>
<li>
<p>当组件使用</p>
</li>
<li>
<p>当资源下载</p>
</li>
<li>
<p>当背景图</p>
</li>
<li>
<p>动态注入</p>
</li>
</ul>
<p>工程化友好度是它胜出的关键原因之一。</p>
<hr/>
<h2 data-id="heading-14"><strong>五、SVG 胜出的根本原因总结</strong></h2>
<p>不是 SVG “长得好看”，也不是趋势，是整个现代前端生态把它推到了最合适的位置。</p>
<p><strong>1）协议升级：HTTP/2/3 让雪碧图和 Iconfont 的优势全部消失</strong><br/>
<strong>2）设备升级：高分屏让位图模糊问题暴露得更明显</strong><br/>
<strong>3）工程升级：组件化开发需要精细化图标</strong><br/>
<strong>4）体验升级：动画、主题、交互都离不开 SVG</strong></p>
<p>一句话总结：</p>
<blockquote>
<p><strong>SVG 不只是“更清晰”，而是从工程到体验全面适配现代前端的图标方案，因此胜出。</strong></p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[react-native-promise-portal：React Native 弹窗管理的新思路]]></title>    <link>https://juejin.cn/post/7577958825342156819</link>    <guid>https://juejin.cn/post/7577958825342156819</guid>    <pubDate>2025-11-30T08:44:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577958825342156819" data-draft-id="7577797563853996068" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="react-native-promise-portal：React Native 弹窗管理的新思路"/> <meta itemprop="keywords" content="React Native"/> <meta itemprop="datePublished" content="2025-11-30T08:44:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="soul96816"/> <meta itemprop="url" content="https://juejin.cn/user/3843548383556791"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            react-native-promise-portal：React Native 弹窗管理的新思路
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548383556791/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    soul96816
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T08:44:04.000Z" title="Sun Nov 30 2025 08:44:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><div align="center">
     <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f1627a19c8844130811ea1f9d3cad995~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc291bDk2ODE2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765097044&amp;x-signature=yRVe9TtVll2KpfNX7PNJ6GbbEsM%3D" width="160" alt="owjymdk6/f1627a1" loading="lazy"/>
  <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fe85d4ec5c743579cabaca9c358bd38~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc291bDk2ODE2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765097044&amp;x-signature=fBE1sdPpvNwpuOpHVNIqoT%2BZL%2BU%3D" width="160" alt="owjymdk6/f1627a1" loading="lazy"/>
    <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a6aee26fc4e4710b5bbfb41dad6da7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc291bDk2ODE2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765097044&amp;x-signature=MhZwQpDBl6iYahFvL5qu2LIPz5Y%3D" width="160" alt="owjymdk6/f1627a1" loading="lazy"/>
    <img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/88776a87956e4e2ba5114496aa36ab2e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc291bDk2ODE2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765097044&amp;x-signature=vpuOos1XeSAcsf7dSWgjGpBt3cM%3D" width="160" alt="owjymdk6/f1627a1" loading="lazy"/>
</div>
<hr/>
<p>在 React Native 开发中，我们经常需要弹出对话框、提示框、日期选择器或者其他 overlay 组件。传统方式通常依赖 state + conditional rendering + 回调函数，但在复杂场景下，代码会变得分散、难维护，尤其是当多个弹窗同时存在时。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJinYuSha0%2Freact-native-promise-portal" target="_blank" title="https://github.com/JinYuSha0/react-native-promise-portal" ref="nofollow noopener noreferrer">react-native-promise-portal</a> 提供了一种 <strong>Promise + Portal</strong> 的解决方案，让你可以像调用普通异步函数一样调用弹窗，同时保持逻辑线性、易于管理。</p>
<h2 data-id="heading-0">核心特点</h2>
<ol>
<li>
<p><strong>Promise-first 弹窗调用</strong><br/>
弹窗调用返回 Promise，你可以用 <code>await</code> 直接获取用户操作结果。业务逻辑与 UI 逻辑解耦，写出来的代码更直观。</p>
</li>
<li>
<p><strong>支持多重弹窗 &amp; name 去重</strong></p>
<ul>
<li>可以在同一页面同时显示多个弹窗，每个弹窗独立关闭。</li>
<li>通过 <code>index</code> 控制渲染层级，index 越大，显示在最上层。</li>
<li>通过 <code>name</code> 去重，避免重复弹窗触发业务冲突。</li>
</ul>
</li>
<li>
<p><strong>局部 Portal</strong></p>
<ul>
<li>支持在特定页面或模块内管理弹窗，不影响全局 Portal 状态。</li>
<li>跨组件调用弹窗，保证弹窗只在目标页面显示。</li>
<li>避免不同页面弹窗相互覆盖或冲突，提升模块化管理能力。</li>
</ul>
</li>
<li>
<p><strong>脱离 Hook 调用局部 UI</strong></p>
<ul>
<li>使用 <code>PortalManager</code> 可以在 <strong>非组件上下文</strong> 触发局部弹窗。</li>
<li>适用于后台逻辑、网络请求回调、定时任务等场景。</li>
<li>Promise 接口仍然保持逻辑线性。</li>
</ul>
</li>
<li>
<p><strong>基于 Portal 渲染</strong></p>
<ul>
<li>利用 React Native 的 Portal 技术，将弹窗渲染到顶层，解决 z-index 和 clipping 问题。</li>
</ul>
</li>
</ol>
<hr/>
<h2 data-id="heading-1">基本使用</h2>
<h3 data-id="heading-2">1. 设置 PortalProvider</h3>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PortalProvider</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native-promise-portal'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">RootLayout</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">PortalProvider</span>&gt;</span>{/* Your app content */}<span class="hljs-tag">&lt;/<span class="hljs-name">PortalProvider</span>&gt;</span></span>;
}
</code></pre>
<h3 data-id="heading-3">2. 使用 Hook 调用弹窗</h3>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { usePortal } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native-promise-portal'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">MyComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { showWithOverlay } = <span class="hljs-title function_">usePortal</span>();

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleShowDialog</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> showWithOverlay&lt;<span class="hljs-built_in">boolean</span>&gt;({
        <span class="hljs-attr">component</span>: <span class="hljs-function">(<span class="hljs-params">{ close }</span>) =&gt;</span> (
          <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Confirm</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"Confirm"</span> <span class="hljs-attr">subTitle</span>=<span class="hljs-string">"Are you sure?"</span> <span class="hljs-attr">close</span>=<span class="hljs-string">{close}</span> /&gt;</span></span>
        ),
      });
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Result:'</span>, result);
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error);
    }
  };

  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onPress</span>=<span class="hljs-string">{handleShowDialog}</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"Show Dialog"</span> /&gt;</span></span>;
}
</code></pre>
<hr/>
<h2 data-id="heading-4">多重弹窗与 name 去重示例</h2>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> { showWithOverlay } = <span class="hljs-title function_">usePortal</span>();

<span class="hljs-comment">// 弹出第一个弹窗</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">showWithOverlay</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'confirm-delete'</span>,
  <span class="hljs-attr">component</span>: <span class="hljs-function">(<span class="hljs-params">{ close }</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Confirm</span> <span class="hljs-attr">close</span>=<span class="hljs-string">{close}</span> /&gt;</span></span>,
});

<span class="hljs-comment">// 再次调用同名弹窗会抛出 PortalAlreadyExistsError</span>
<span class="hljs-keyword">await</span> <span class="hljs-title function_">showWithOverlay</span>({
  <span class="hljs-attr">name</span>: <span class="hljs-string">'confirm-delete'</span>,
  <span class="hljs-attr">component</span>: <span class="hljs-function">(<span class="hljs-params">{ close }</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Confirm</span> <span class="hljs-attr">close</span>=<span class="hljs-string">{close}</span> /&gt;</span></span>,
});
</code></pre>
<p>通过 <code>index</code> 可以控制层级顺序：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> promise1 = <span class="hljs-title function_">showWithOverlay</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">'Dialog 1'</span>, <span class="hljs-attr">index</span>: <span class="hljs-number">1</span> });
<span class="hljs-keyword">const</span> promise2 = <span class="hljs-title function_">showWithOverlay</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">'Dialog 2'</span>, <span class="hljs-attr">index</span>: <span class="hljs-number">10</span> }); <span class="hljs-comment">// 更高层级</span>
<span class="hljs-keyword">const</span> promise3 = <span class="hljs-title function_">showWithOverlay</span>({ <span class="hljs-attr">title</span>: <span class="hljs-string">'Dialog 3'</span>, <span class="hljs-attr">index</span>: <span class="hljs-number">5</span> });

<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">allSettled</span>([promise1, promise2, promise3]).<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">results</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'All dialogs closed:'</span>, results);
});
</code></pre>
<hr/>
<h2 data-id="heading-5">局部 Portal 解决的业务痛点</h2>
<p>在大型应用中，某些弹窗只在特定页面显示，使用全局 Portal 管理容易导致以下问题：</p>
<ul>
<li>弹窗状态全局混乱</li>
<li>不同页面弹窗可能相互覆盖</li>
<li>逻辑与 UI 耦合，调用分散</li>
</ul>
<p>局部 Portal 通过 <code>PortalManager</code> 提供页面级管理：</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PortalRender</span>, <span class="hljs-title class_">PortalManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native-promise-portal'</span>;
<span class="hljs-keyword">import</span> { useLocalPortals } <span class="hljs-keyword">from</span> <span class="hljs-string">'./helper/LocalPortal'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">HomePage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> homePortalContent = <span class="hljs-title function_">useLocalPortals</span>(<span class="hljs-function">(<span class="hljs-params">state</span>) =&gt;</span> state.<span class="hljs-property">homePortalContent</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleShowLocalPortal</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">HomePagePortalManager</span>.<span class="hljs-property">showWithOverlay</span>&lt;<span class="hljs-built_in">boolean</span>&gt;({
      <span class="hljs-attr">component</span>: <span class="hljs-function">(<span class="hljs-params">{ close }</span>) =&gt;</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Confirm</span>
          <span class="hljs-attr">title</span>=<span class="hljs-string">"Local portal"</span>
          <span class="hljs-attr">subTitle</span>=<span class="hljs-string">"Only on home page"</span>
          <span class="hljs-attr">close</span>=<span class="hljs-string">{close}</span>
        /&gt;</span></span>
      ),
    });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Button</span> <span class="hljs-attr">onPress</span>=<span class="hljs-string">{handleShowLocalPortal}</span> <span class="hljs-attr">title</span>=<span class="hljs-string">"Show Local Portal"</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">PortalRender</span> <span class="hljs-attr">portals</span>=<span class="hljs-string">{homePortalContent}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/&gt;</span></span>
  );
}
</code></pre>
<p><strong>局部 Portal 优势：</strong></p>
<ol>
<li>弹窗只影响特定页面或模块</li>
<li>跨组件 / 跨 Hook 调用更灵活</li>
<li>避免全局冲突，提高模块化和可维护性</li>
</ol>
<hr/>
<h2 data-id="heading-6">脱离 Hook 调用局部 UI</h2>
<p>有些业务场景中，你可能希望在 <strong>非 React 组件上下文</strong> 或 <strong>Hook 不方便使用的地方</strong> 调用弹窗，例如网络请求回调或定时任务。</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">HomePagePortalManager</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./helper/LocalPortal'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleAsyncEvent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title class_">HomePagePortalManager</span>.<span class="hljs-property">showWithOverlay</span>&lt;<span class="hljs-built_in">boolean</span>&gt;({
      <span class="hljs-attr">component</span>: <span class="hljs-function">(<span class="hljs-params">{ close }</span>) =&gt;</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Confirm</span>
          <span class="hljs-attr">title</span>=<span class="hljs-string">"Async Event"</span>
          <span class="hljs-attr">subTitle</span>=<span class="hljs-string">"This dialog is triggered outside React component"</span>
          <span class="hljs-attr">close</span>=<span class="hljs-string">{close}</span>
        /&gt;</span></span>
      ),
      <span class="hljs-attr">overlay</span>: { <span class="hljs-attr">orientation</span>: <span class="hljs-string">'centerMiddle'</span> },
    });
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'User result:'</span>, result);
  } <span class="hljs-keyword">catch</span> (err) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Portal closed or error:'</span>, err);
  }
}
</code></pre>
<p><strong>特点：</strong></p>
<ul>
<li>脱离组件 / Hook，任意业务逻辑可触发</li>
<li>弹窗仅显示在目标页面或模块</li>
<li>Promise 接口保持逻辑线性</li>
</ul>
<hr/>
<h2 data-id="heading-7">更多示例</h2>
<h3 data-id="heading-8">Loading 指示器</h3>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> { showWithOverlay } = <span class="hljs-title function_">usePortal</span>();

<span class="hljs-keyword">const</span> <span class="hljs-title function_">showLoading</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> { close } = showWithOverlay&lt;<span class="hljs-built_in">void</span>&gt;({
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ActivityIndicator</span> /&gt;</span></span>,
    <span class="hljs-attr">overlay</span>: { <span class="hljs-attr">closeable</span>: <span class="hljs-literal">false</span> },
  });

  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">close</span>(), <span class="hljs-number">3000</span>);
};
</code></pre>
<h3 data-id="heading-9">日期选择器（底部弹出）</h3>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">const</span> date = <span class="hljs-keyword">await</span> showWithOverlay&lt;<span class="hljs-built_in">string</span>&gt;({
  <span class="hljs-attr">component</span>: <span class="hljs-function">(<span class="hljs-params">{ close }</span>) =&gt;</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">DatePicker</span>
      <span class="hljs-attr">onSelect</span>=<span class="hljs-string">{(date)</span> =&gt;</span> close(date)}
      onCancel={() =&gt; close(new Error('Cancelled'))}
    /&gt;</span>
  ),
  <span class="hljs-attr">overlay</span>: { <span class="hljs-attr">orientation</span>: <span class="hljs-string">'centerBottom'</span> },
});
</code></pre>
<hr/>
<h2 data-id="heading-10">错误处理</h2>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">PortalError</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-native-promise-portal'</span>;

<span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> showWithOverlay&lt;<span class="hljs-built_in">boolean</span>&gt;({
    <span class="hljs-attr">component</span>: <span class="hljs-function">(<span class="hljs-params">{ close }</span>) =&gt;</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Confirm</span> <span class="hljs-attr">close</span>=<span class="hljs-string">{close}</span> /&gt;</span></span>,
  });
} <span class="hljs-keyword">catch</span> (error) {
  <span class="hljs-keyword">if</span> (error <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">PortalError</span>) {
    <span class="hljs-keyword">if</span> (error.<span class="hljs-title function_">isCloseByOverlayPressError</span>()) <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Closed by overlay'</span>);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-title function_">isCloseByHardwareBackPressError</span>()) <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Closed by back button'</span>);
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (error.<span class="hljs-title function_">isPortalAlreadyExistsError</span>()) <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Portal already exists'</span>);
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-11">总结</h2>
<p><code>react-native-promise-portal</code> 将弹窗调用封装为异步函数，支持：</p>
<ul>
<li>多重弹窗</li>
<li>name 去重机制</li>
<li>局部 Portal</li>
<li>脱离 Hook 调用局部 UI</li>
<li>Promise 异步接口</li>
</ul>
<p>它极大简化了 React Native 弹窗管理，保证 UI 与业务逻辑解耦，调用方式直观、可维护，是复杂页面交互场景下的理想选择。</p>
<hr/>
<h2 data-id="heading-12">安装</h2>
<pre><code class="hljs language-arduino" lang="arduino">npm install react-native-promise-portal
</code></pre>
<hr/>
<p>如果你喜欢这个库，欢迎点个 ⭐️ 支持一下！</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FJinYuSha0%2Freact-native-promise-portal%2Fstargazers" target="_blank" title="https://github.com/JinYuSha0/react-native-promise-portal/stargazers" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8d69498d456a4273919a79c34959e357~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgc291bDk2ODE2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765097044&amp;x-signature=5c7c17HyEztTtyBjuTyiOhLowt8%3D" alt="GitHub stars" loading="lazy"/></a></p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[ts类型工具]]></title>    <link>https://juejin.cn/post/7577691061034188846</link>    <guid>https://juejin.cn/post/7577691061034188846</guid>    <pubDate>2025-11-30T08:54:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577691061034188846" data-draft-id="7577705544875917350" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="ts类型工具"/> <meta itemprop="keywords" content="TypeScript"/> <meta itemprop="datePublished" content="2025-11-30T08:54:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Robet"/> <meta itemprop="url" content="https://juejin.cn/user/193141028175320"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            ts类型工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/193141028175320/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Robet
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T08:54:47.000Z" title="Sun Nov 30 2025 08:54:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>TypeScript 提供了一套强大的<strong>内置工具类型（Utility Types）</strong>，用于从已有类型中派生出新类型，从而提升代码的健壮性、可维护性和开发效率。这些工具类型就像“类型世界的高阶函数”，能对类型进行组合、裁剪、转换等操作。</p>
<hr/>
<h3 data-id="heading-0">🧰 常用 TypeScript 工具类型速查表</h3>
















































































<table><thead><tr><th>分类</th><th>工具类型</th><th>作用</th></tr></thead><tbody><tr><td><strong>基础修饰</strong></td><td><code>Partial&lt;T&gt;</code></td><td>将 <code>T</code> 的所有属性变为<strong>可选</strong></td></tr><tr><td/><td><code>Required&lt;T&gt;</code></td><td>将 <code>T</code> 的所有属性变为<strong>必填</strong>（移除 <code>?</code>）</td></tr><tr><td/><td><code>Readonly&lt;T&gt;</code></td><td>将 <code>T</code> 的所有属性变为<strong>只读</strong></td></tr><tr><td><strong>结构挑选</strong></td><td><code>Pick&lt;T, K&gt;</code></td><td>从 <code>T</code> 中<strong>选取</strong>指定键 <code>K</code> 的属性</td></tr><tr><td/><td><code>Omit&lt;T, K&gt;</code></td><td>从 <code>T</code> 中<strong>剔除</strong>指定键 <code>K</code> 的属性</td></tr><tr><td/><td><code>Record&lt;K, T&gt;</code></td><td>构造一个键为 <code>K</code>、值为 <code>T</code> 的对象类型</td></tr><tr><td><strong>类型过滤</strong></td><td><code>Exclude&lt;T, U&gt;</code></td><td>从联合类型 <code>T</code> 中<strong>排除</strong>可赋值给 <code>U</code> 的类型</td></tr><tr><td/><td><code>Extract&lt;T, U&gt;</code></td><td>从联合类型 <code>T</code> 中<strong>提取</strong>可赋值给 <code>U</code> 的类型</td></tr><tr><td/><td><code>NonNullable&lt;T&gt;</code></td><td>从 <code>T</code> 中移除 <code>null</code> 和 <code>undefined</code></td></tr><tr><td><strong>函数相关</strong></td><td><code>ReturnType&lt;T&gt;</code></td><td>获取函数 <code>T</code> 的<strong>返回值类型</strong></td></tr><tr><td/><td><code>Parameters&lt;T&gt;</code></td><td>获取函数 <code>T</code> 的<strong>参数类型元组</strong></td></tr><tr><td/><td><code>ConstructorParameters&lt;T&gt;</code></td><td>获取构造函数的<strong>参数类型</strong></td></tr><tr><td/><td><code>InstanceType&lt;T&gt;</code></td><td>获取构造函数的<strong>实例类型</strong></td></tr><tr><td/><td><code>ThisParameterType&lt;T&gt;</code> / <code>OmitThisParameter&lt;T&gt;</code></td><td>处理函数中的 <code>this</code> 参数</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-1">🔍 典型示例与应用场景</h3>
<h4 data-id="heading-2">1. <code>Partial&lt;T&gt;</code>：局部更新</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-comment">// 所有字段变为可选</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">UpdateUser</span> = <span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">User</span>&gt;;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">updateUser</span>(<span class="hljs-params">id: <span class="hljs-built_in">number</span>, changes: UpdateUser</span>) {
  <span class="hljs-comment">// 只需传入要修改的字段</span>
}
<span class="hljs-title function_">updateUser</span>(<span class="hljs-number">1</span>, { <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span> }); <span class="hljs-comment">// ✅</span>
</code></pre>
<h4 data-id="heading-3">2. <code>Pick&lt;T, K&gt;</code> / <code>Omit&lt;T, K&gt;</code>：按需选择或排除字段</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">UserPreview</span> = <span class="hljs-title class_">Pick</span>&lt;<span class="hljs-title class_">User</span>, <span class="hljs-string">'id'</span> | <span class="hljs-string">'name'</span>&gt;; <span class="hljs-comment">// { id: number; name: string }</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">UserWithoutId</span> = <span class="hljs-title class_">Omit</span>&lt;<span class="hljs-title class_">User</span>, <span class="hljs-string">'id'</span>&gt;;        <span class="hljs-comment">// { name: string; email: string }</span>
</code></pre>
<h4 data-id="heading-4">3. <code>Record&lt;K, T&gt;</code>：构建配置对象</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Theme</span> = <span class="hljs-string">'light'</span> | <span class="hljs-string">'dark'</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ColorMap</span> = <span class="hljs-title class_">Record</span>&lt;<span class="hljs-title class_">Theme</span>, <span class="hljs-built_in">string</span>&gt;; <span class="hljs-comment">// { light: string; dark: string }</span>
</code></pre>
<h4 data-id="heading-5">4. <code>ReturnType&lt;T&gt;</code>：推导函数返回类型</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUser</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">id</span>: <span class="hljs-number">1</span>, <span class="hljs-attr">name</span>: <span class="hljs-string">"Bob"</span> };
}

<span class="hljs-keyword">type</span> <span class="hljs-title class_">User</span> = <span class="hljs-title class_">ReturnType</span>&lt;<span class="hljs-keyword">typeof</span> fetchUser&gt;; <span class="hljs-comment">// { id: number; name: string }</span>
</code></pre>
<h4 data-id="heading-6">5. <code>Exclude&lt;T, U&gt;</code> / <code>Extract&lt;T, U&gt;</code></h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">Status</span> = <span class="hljs-string">'loading'</span> | <span class="hljs-string">'success'</span> | <span class="hljs-string">'error'</span>;
<span class="hljs-keyword">type</span> <span class="hljs-title class_">ValidStatus</span> = <span class="hljs-title class_">Exclude</span>&lt;<span class="hljs-title class_">Status</span>, <span class="hljs-string">'loading'</span>&gt;; <span class="hljs-comment">// 'success' | 'error'</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">LoadingOnly</span> = <span class="hljs-title class_">Extract</span>&lt;<span class="hljs-title class_">Status</span>, <span class="hljs-string">'loading'</span>&gt;; <span class="hljs-comment">// 'loading'</span>
</code></pre>
<hr/>
<h3 data-id="heading-7">💡 小贴士</h3>
<ul>
<li>这些工具类型基于 <strong>映射类型（Mapped Types）</strong>、<strong>条件类型（Conditional Types）</strong> 和 <strong><code>infer</code></strong> 等高级特性实现。</li>
<li>它们是<strong>不可变的</strong>：不会修改原始类型，而是生成一个新类型。</li>
<li>可<strong>组合使用</strong>，例如：
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">type</span> <span class="hljs-title class_">SafeUser</span> = <span class="hljs-title class_">Readonly</span>&lt;<span class="hljs-title class_">Partial</span>&lt;<span class="hljs-title class_">User</span>&gt;&gt;;
</code></pre>
</li>
</ul>
<hr/>
<p>如需深入某个工具类型的源码实现或更多实战案例，可以告诉我具体类型（如 <code>Omit</code> 或 <code>ReturnType</code>），我可以进一步详解！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[FileProvider 授权方式不当的风险与防护设计]]></title>    <link>https://juejin.cn/post/7577675494068142106</link>    <guid>https://juejin.cn/post/7577675494068142106</guid>    <pubDate>2025-11-30T00:35:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577675494068142106" data-draft-id="7577693903018573850" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="FileProvider 授权方式不当的风险与防护设计"/> <meta itemprop="keywords" content="安全"/> <meta itemprop="datePublished" content="2025-11-30T00:35:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鱼跃新知"/> <meta itemprop="url" content="https://juejin.cn/user/2754692828113043"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            FileProvider 授权方式不当的风险与防护设计
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2754692828113043/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鱼跃新知
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T00:35:35.000Z" title="Sun Nov 30 2025 00:35:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在<a href="https://juejin.cn/post/7575442779038892074" target="_blank" title="https://juejin.cn/post/7575442779038892074">《 Android 文件共享安全指南：为何不能使用 file://》</a>中我们提到：应用间共享文件时，应优先使用 ContentProvider（如 FileProvider）实现受控访问，以提升安全性。但如果在授权过程中处置不当，仍可能引发敏感数据泄露等安全风险。</p>
<p>本文将结合典型业务场景、授权流程、风险模型与最佳实践，系统性解释 FileProvider 授权的安全要点。</p>
<hr/>
<h2 data-id="heading-0"><strong>一、典型业务场景</strong></h2>
<p>应用 A 通过 FileProvider 向应用 B 分享日志文件：</p>
<p><strong>Manifest 配置：</strong> </p>
<pre><code class="hljs language-ini" lang="ini">&lt;meta-data
    android:<span class="hljs-attr">name</span>=<span class="hljs-string">"android.support.FILE_PROVIDER_PATHS"</span>
    android:<span class="hljs-attr">resource</span>=<span class="hljs-string">"@xml/file_paths"</span> /&gt;
</code></pre>

<p><strong>代码授权：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">shareLogFile</span><span class="hljs-params">(File logFile)</span> {
    <span class="hljs-type">Uri</span> <span class="hljs-variable">logUri</span> <span class="hljs-operator">=</span> FileProvider.getUriForFile(
            <span class="hljs-built_in">this</span>,
            <span class="hljs-string">"com.example.myapp.fileprovider"</span>,
            logFile
    );

    <span class="hljs-type">Intent</span> <span class="hljs-variable">shareIntent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>(Intent.ACTION_SEND);
    shareIntent.setType(<span class="hljs-string">"text/plain"</span>);
    shareIntent.putExtra(Intent.EXTRA_STREAM, logUri);

    <span class="hljs-comment">// 关键：授予对方临时读取权限</span>
    shareIntent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);

    startActivity(Intent.createChooser(shareIntent, <span class="hljs-string">"分享日志文件"</span>));
}
</code></pre>
<p>授权行为主要通过以下两种方式触发。</p>
<h2 data-id="heading-1"><strong>二、两类授予权限方式</strong></h2>
<h3 data-id="heading-2"><strong>1.通过 Intent Flag 授权（常用）</strong></h3>
<ul>
<li>授权对象：<strong>目标组件（单个 Activity/Service）</strong>****</li>
<li>权限生效：<strong>启动目标组件时瞬间授予</strong>****</li>
</ul>
<h3 data-id="heading-3"><strong>2.使用 grantUriPermission() 主动授权</strong></h3>
<ul>
<li>授权对象：<strong>目标包（整个 App）</strong>****</li>
<li>权限生效：调用后立即生效</li>
</ul>
<blockquote>
<p>差异点：Intent 授权仅对单个组件生效，而 grantUriPermission() 会让整个 App 获取权限，风险更高</p>
</blockquote>
<p>以下是对两种授权方式及标志位的具体说明：</p>









































<table><thead><tr><th>标志位 / 方法</th><th>示例代码</th><th>授权含义</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>FLAG_GRANT_READ_URI_PERMISSION</strong></td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/135eef53b66745e5b1dc579a28099f60~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG86LeD5paw55-l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765067735&amp;x-signature=pZ5gZF2M1fxM4cVxQinwCB63KnM%3D" alt="image.png" loading="lazy"/></td><td>- 授予目标组件一次性 <strong>读权限</strong><br/>- 权限与对方 Activity 生命周期绑定<br/>- 仅允许读取 <strong>该 URI 指向的单个文件</strong>，不能访问目录或其他文件</td><td>一次性分享图片、文件、日志等「只读」内容</td></tr><tr><td><strong>FLAG_GRANT_WRITE_URI_PERMISSION</strong></td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b16d1225fed2434c941497af9cf6b1f4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG86LeD5paw55-l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765067735&amp;x-signature=ltd4%2BatzDGWxmomSb4gk%2BoXsskQ%3D" alt="image.png" loading="lazy"/></td><td>- 授予目标组件一次性 <strong>写权限</strong>（不自动包含读权限）<br/>- 允许修改 / 删除该 URI 指向的内容</td><td>目标 App 需要对该文件进行一次性编辑、修改或生成输出</td></tr><tr><td><strong>FLAG_GRANT_PREFIX_URI_PERMISSION</strong></td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f063b68a01d43f6907efe92b12c78c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG86LeD5paw55-l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765067735&amp;x-signature=XBsO1U77wH4PurO3e12TEw%2BFoqo%3D" alt="image.png" loading="lazy"/></td><td>- 启用 <strong>目录级别授权</strong>（前缀匹配）<br/>- 对方可访问以该前缀开头的所有子 URI<br/>- 权限范围从单文件扩大到“目录树”，如授权的是content://com.example.demo.files/images，那么-   content://com.example.demo.files/images/123及同目录和下级目录所有内容都可以访问</td><td>明确设计用于“目录级共享”的场景，例如文档管理、下载目录共享；必须严格限制前缀避免越权</td></tr><tr><td><strong>FLAG_GRANT_PERSISTABLE_URI_PERMISSION</strong></td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f64a1320e7224f608fee40c4644df761~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG86LeD5paw55-l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765067735&amp;x-signature=7mGXGWlt60f58CEdNYsoWjWAMvA%3D" alt="image.png" loading="lazy"/></td><td>- 本身并不是“权限”，而是允许当次授权被 <strong>持久化</strong> 的“许可证”<br/>- 需搭配读/写权限使用<br/>- 接收端需调用 <code>takePersistableUriPermission()</code> 才会变为长期授权<br/>- 持久化后权限与 Activity 生命周期脱钩，由系统长期记录</td><td>文档访问、相册选取、文件选取器等长期需要访问某个 URI 的场景</td></tr><tr><td><strong>grantUriPermission() 方法</strong></td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/101414b9b46f4b0ea3622c8d10f6b7d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG86LeD5paw55-l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765067735&amp;x-signature=9%2BjcnU6RsTN%2Fyoxmq8yB5%2FqMsEY%3D" alt="image.png" loading="lazy"/></td><td>- 系统立即将对应 URI 权限授予 <strong>整个包</strong>，无需启动组件<br/>- 支持前缀 / 持久化等所有 flag 组合<br/>- 适合“后台授予”，无需用户交互<br/>- 若希望持久化必须由对方主动调用 <code>takePersistableUriPermission()</code></td><td>对方长期需要访问某文件或配置数据，如导入/导出设置、长期持有的文档、文件型配置等</td></tr></tbody></table>
<h2 data-id="heading-4"><strong>三、风险分析</strong></h2>
<p>上述的标志位或方法设置不当，可能导致超范围、能力、时间的权限共享，存在数据泄露风险，以下分析两种授权模式和授权期限各种组合的风险。</p>


















































<table><thead><tr><th>授权方式</th><th>示例代码</th><th>授权对象</th><th>授权生效时机</th><th>生命周期</th><th>风险</th><th>适用场景</th></tr></thead><tbody><tr><td>intent授权+临时授权标志</td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/769f892879724329a2e2374f28326c07~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG86LeD5paw55-l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765067735&amp;x-signature=OPwcyEZCftiGkLcqbD4ecWPSbjI%3D" alt="image.png" loading="lazy"/></td><td>单个组件实例（最小化）</td><td>需要在intent启动对方组件时才生效，不启动则无效</td><td>随接收方组件销毁即撤销</td><td>最低</td><td>临时打开一个图片、文档</td></tr><tr><td>Intent 授权 +持久化授权标志</td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/168ad4df64314c66bd0abdcc4d1622e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG86LeD5paw55-l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765067735&amp;x-signature=CZTtuPFp4cfG0PM8c8vvoqABCgM%3D" alt="image.png" loading="lazy"/></td><td>单次启动的组件，可持久化<br/>真正是否持久化取决于接收端takePersistableUriPermission</td><td>需要在intent启动对方组件时才生效，不启动则无效</td><td>可长期使用，与组件生命周期无关</td><td>中等</td><td>ACTION_OPEN_DOCUMENT <br/>相册/文件长期访问（安卓官方 SAF）</td></tr><tr><td>grantUriPermission+临时授权</td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5362e952ba14e429812fb033b2ec496~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG86LeD5paw55-l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765067735&amp;x-signature=T%2BePJHBXp4aiNoawDdNMNG7hN%2FI%3D" alt="image.png" loading="lazy"/></td><td>整个包（package-level）</td><td>授权立刻生效，无需启动activity，无需用户交互</td><td>随应用运行或系统回收</td><td>中等（授权范围比 Intent 大很多）<br/>权限范围明显更大，需严格限制使用。</td><td>特定合作方、固定目标包</td></tr><tr><td>grantUriPermission +持久化授权</td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b3242b1b9b884a4a9c6d9d849a0e5003~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG86LeD5paw55-l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765067735&amp;x-signature=wmx9uZF3H1QlMdWOmEpTngQM4ik%3D" alt="image.png" loading="lazy"/></td><td>整个包（package-level）<br/>真正是否持久化取决于接收端takePersistableUriPermission</td><td>授权立刻生效，无需启动activity，无需用户交互</td><td>随应用运行或系统回收</td><td>最高，等同于“长期向一个 App 开放文件”</td><td>非常罕见，仅用于白名单合作方</td></tr></tbody></table>
<h2 data-id="heading-5">四、错误案例</h2>
<ul>
<li>授权类型超限：只应该允许对方读的，同时给了对方不必要的写权限</li>
<li>授权范围超限：只应该授予对方单个组件权限，却给了对方整个包权限；只应该分享具体文件，但是共享了自己的某前缀所代表的目录；</li>
<li>授权时间超限：只应该授予对方临时权限，却给了对方永久权限</li>
</ul>
<h2 data-id="heading-6">五、正确措施</h2>
<p>整体原则就是：最小必要授权。</p>
<ul>
<li>在类型上：只给对方必须得权限类型</li>
<li>在范围上：首选仅给单个组件授权；仅共享必要的具体文件</li>
<li>在期限上：首选临时权限，实在需要持久化授权的，根据应用实际情况，可以调用revokeUriPermission接口撤销授权，如android官方介绍所说</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9eb88330404042f690e2401d50f06734~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6bG86LeD5paw55-l:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765067735&amp;x-signature=5g5Oy2TKWB9e2qtEahNUgf0AM10%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-7">撤销授权的案例</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 授权并立即撤销 URI 权限的示例</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">openEditorWithTempPermission</span><span class="hljs-params">(Context context)</span> {
    <span class="hljs-comment">// 1. 要共享给对方 App 的受保护内容 URI</span>
    <span class="hljs-type">Uri</span> <span class="hljs-variable">secureUri</span> <span class="hljs-operator">=</span> Uri.parse(<span class="hljs-string">"content://com.demo.secureprovider/private/doc/42"</span>);

    <span class="hljs-comment">// 2. 构造显式 Intent，指定目标应用和页面</span>
    <span class="hljs-type">Intent</span> <span class="hljs-variable">editIntent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Intent</span>();
    editIntent.setComponent(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ComponentName</span>(
            <span class="hljs-string">"com.demo.doceditor"</span>,                      <span class="hljs-comment">// 目标包名（第三方/自家 App）</span>
            <span class="hljs-string">"com.demo.doceditor.ui.EditDocumentActivity"</span> <span class="hljs-comment">// 目标 Activity 全类名</span>
    ));

    <span class="hljs-comment">// 声明要操作的资源类型</span>
    editIntent.setDataAndType(secureUri, <span class="hljs-string">"application/pdf"</span>);

    <span class="hljs-comment">// 3. 通过 Intent 临时授予对方读写权限，并新开任务栈打开页面</span>
    editIntent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION
            | Intent.FLAG_GRANT_WRITE_URI_PERMISSION
            | Intent.FLAG_ACTIVITY_NEW_TASK);

    <span class="hljs-comment">// 启动目标编辑页面</span>
    context.startActivity(editIntent);

    <span class="hljs-comment">// 4. 及时撤销上面授予 com.demo.doceditor 的 URI 读写权限</span>
    <span class="hljs-comment">//    后续该应用再尝试通过这个 URI 访问时会因为缺乏权限而失败</span>
    context.revokeUriPermission(
            <span class="hljs-string">"com.demo.doceditor"</span>,                      <span class="hljs-comment">// 被授予过权限的目标包名</span>
            secureUri,                                 <span class="hljs-comment">// 同一个 URI</span>
            Intent.FLAG_GRANT_READ_URI_PERMISSION
                    | Intent.FLAG_GRANT_WRITE_URI_PERMISSION
    );
}
</code></pre>
<h3 data-id="heading-8">六、风险排查思路</h3>
<p><strong>什么情况下会有这种风险?以下几个条件同时满足:</strong></p>
<ul>
<li>使用ContentProvider(无论fileProvider还是自定义provider)</li>
<li>暴露给外部访问（exported=true或grantUriPermmision=true）</li>
<li>访问路径最终到达了provider内部敏感逻辑（query/openFile/call等），也就是这个授权行为会最终导致敏感数据泄露或敏感操作</li>
</ul>
<p>所以可以先找到provider的定义处，在manifest中查看它的配置，是否设置grantUriPermissions="true"</p>
<pre><code class="hljs language-ini" lang="ini">&lt;provider android:<span class="hljs-attr">name</span>=<span class="hljs-string">"com.example.demoContentProvider"</span> android:exported=<span class="hljs-string">"true"</span> android:process=<span class="hljs-string">":temp"</span> android:authorities=<span class="hljs-string">"com.example.demo.contentProvider"</span> android:grantUriPermissions=<span class="hljs-string">"true"</span>/&gt;
</code></pre>
<p>如果怀疑存在授权行为，可检索 Provider 的 authorities 值。若应用确实进行了 URI 授权，该字段必然在相关代码中被引用。进一步确认授权的调用位置、数据流向以及处理逻辑，重点检查是否将 URI 分享给其他组件或外部应用，并核实权限授予是否遵循最小必要原则，避免过度授权。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[16.Kotlin 类：类的形态（三）：密封类 (Sealed Class)]]></title>    <link>https://juejin.cn/post/7577702891273846819</link>    <guid>https://juejin.cn/post/7577702891273846819</guid>    <pubDate>2025-11-30T06:08:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577702891273846819" data-draft-id="7577713754563379252" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="16.Kotlin 类：类的形态（三）：密封类 (Sealed Class)"/> <meta itemprop="keywords" content="Android,后端,Kotlin"/> <meta itemprop="datePublished" content="2025-11-30T06:08:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Android_小雨"/> <meta itemprop="url" content="https://juejin.cn/user/220360279590862"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            16.Kotlin 类：类的形态（三）：密封类 (Sealed Class)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/220360279590862/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Android_小雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T06:08:10.000Z" title="Sun Nov 30 2025 06:08:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>希望帮你在Kotlin进阶路上少走弯路，在技术上稳步提升。当然，由于个人知识储备有限，笔记中难免存在疏漏或表述不当的地方，也非常欢迎大家提出宝贵意见，一起交流进步。 —— Android_小雨</p>
</blockquote>
<p>整体目录：<a href="https://juejin.cn/spost/7573592952242602036" target="_blank" title="https://juejin.cn/spost/7573592952242602036">Kotlin 进阶不迷路：41 个核心知识点，构建完整知识体系</a></p>
<h2 data-id="heading-0">一、前言</h2>
<p>Kotlin 官方对密封类的完整定义（逐句拆解）</p>
<blockquote>
<p>Sealed classes and interfaces represent restricted class hierarchies that provide more control over inheritance.
All direct subclasses of a sealed class are known at compile time.
No other subclasses may appear outside the module and the file where the sealed class is defined.
Sealed classes are, in fact, enumerated classes with super-powers.</p>
</blockquote>
<p>官方强调的 5 个核心点（记住这 5 条就掌握了密封类本质）：</p>
<ol>
<li>密封类 = 受限的类层次结构（restricted hierarchy）</li>
<li>所有直接子类在<strong>编译期</strong>就完全已知</li>
<li>子类必须定义在<strong>同一个文件</strong>中（Kotlin 1.0-1.4）→ Kotlin 1.5+ 放宽到<strong>同一个模块 + 同一个编译单元</strong></li>
<li>不能在密封类外部再添加子类</li>
<li>密封类是“增强版的枚举类”（enum with superpowers）</li>
</ol>
<p>一句话总结：<strong>密封类就是编译器知道所有可能子类型的类</strong>，专为“有限种状态”而生。</p>
<h3 data-id="heading-1">1.1 密封类的核心定位（限制继承范围、规范有限类型集合）</h3>
<p>在面向对象编程中，我们经常面临一个矛盾：<strong>既想要多态的灵活性，又想要枚举的确定性。</strong>
Kotlin 官方对密封类的定义非常精准：“Sealed classes represent restricted class hierarchies”。
翻译成开发者听得懂的话就是：<strong>密封类是专为“有限种状态”而生的受限类层级</strong>。它核心只做一件事——把继承的权利关进笼子里，不让外部随意扩展。</p>
<h3 data-id="heading-2">1.2 Kotlin 密封类的设计价值（兼顾灵活性与安全性，编译时校验类型）</h3>
<p>密封类被称为“增强版的枚举”（Enum with superpowers）。</p>
<ul>
<li><strong>相比枚举</strong>：它更灵活。枚举的每个实例结构都必须一样，而密封类的子类可以是单例（<code>object</code>）、数据类（<code>data class</code>）甚至是普通类，每种状态都能携带自己独有的数据。</li>
<li><strong>相比接口/抽象类</strong>：它更安全。编译器在编译期就知道它所有的子类，这意味着当你用 <code>when</code> 处理它时，编译器能帮你做“穷尽检查”，杜绝逻辑遗漏。</li>
</ul>
<h3 data-id="heading-3">1.3 核心疑问：Kotlin 密封类编译后是什么样？</h3>
<p>很多兄弟好奇：Java 直到 15/17 才引入 <code>sealed</code>，那 Kotlin 早几年是怎么在 JVM 上跑起来的？它是黑科技吗？
<strong>完全不是。</strong> 只要我们扒开字节码（Decompile）看一眼，就会发现它本质上利用了 Java 的访问控制机制。</p>
<h3 data-id="heading-4">1.4 本文核心内容预告</h3>
<p>本文将从底层原理出发，层层递进：</p>
<ol>
<li><strong>Java 映射</strong>：看透它的底层实现。</li>
<li><strong>语法规范</strong>：掌握 2025 年最新的定义方式（如 <code>data object</code>）。</li>
<li><strong>核心特性</strong>：理解为什么它能做编译期检查。</li>
<li><strong>实战场景</strong>：UI 状态、网络请求、导航路由等真实案例。</li>
<li><strong>对比分析</strong>：彻底搞懂它和 Enum 的区别。</li>
</ol>
<h2 data-id="heading-5">二、核心揭秘：Kotlin 密封类 → Java 代码映射</h2>
<p>要真正理解密封类，最直接的方法是看它编译后的字节码对应什么 Java 代码。</p>
<h3 data-id="heading-6">2.1 映射底层原理</h3>
<p>Kotlin 的 <code>sealed class</code> 在编译成 Java 字节码时，主要做了两件事：</p>
<ol>
<li><strong>转变为抽象类</strong>：密封类本身会被编译为一个 <code>abstract class</code>，因此不能直接实例化。</li>
<li><strong>私有化/受限构造函数</strong>：它的构造函数通常是 <code>private</code> 或 <code>protected</code>，并在元数据中标记只允许在特定范围内继承。</li>
</ol>
<h3 data-id="heading-7">2.2 完整示例映射</h3>
<h3 data-id="heading-8">2.2.1 Kotlin 原代码</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span> {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>(<span class="hljs-keyword">val</span> msg: String) : Result()
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">object</span> Error : Result() <span class="hljs-comment">// Kotlin 1.9+ 推荐写法</span>
}

</code></pre>
<h3 data-id="heading-9">2.2.2 对应的 Java 反编译结果（核心逻辑）</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 本质就是个抽象类</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span> {

    <span class="hljs-comment">// 2. 关键点：构造函数是私有的！</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">Result</span><span class="hljs-params">()</span> {}

    <span class="hljs-comment">// 3. Kotlin 生成的合成构造器，用于允许内部子类调用</span>
    <span class="hljs-comment">// 逻辑上就是锁死了外部继承的可能性</span>
    <span class="hljs-keyword">public</span> <span class="hljs-comment">/* synthetic */</span> Result(DefaultConstructorMarker marker) {
        <span class="hljs-built_in">this</span>();
    }

    <span class="hljs-comment">// 子类 1：静态内部类</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Result</span> { ... }

    <span class="hljs-comment">// 子类 2：静态单例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Result</span> { ... }
}

</code></pre>
<h3 data-id="heading-10">2.3 关键细节说明</h3>
<p><strong>结论就一句话</strong>：密封类本质上就是一个“构造函数被私有化”的抽象类。
因为构造函数被锁死了，编译器可以保证除了它允许的“亲儿子”（同文件或同模块内的类），其他任何地方的代码都无法继承它。这就是“有限继承”的底层实现。</p>
<h2 data-id="heading-11">三、密封类基础：定义与语法规范</h2>
<h3 data-id="heading-12">3.1 基本语法</h3>
<p>使用 <code>sealed</code> 关键字修饰类即可。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UiState</span>
</code></pre>
<h3 data-id="heading-13">3.2 子类定义规则</h3>
<p>随着 Kotlin 版本的迭代，规则逐渐放宽：</p>
<ul>
<li><strong>Kotlin 1.0 - 1.4</strong>：子类必须定义在密封类内部，或者同一文件中。</li>
<li><strong>Kotlin 1.5+（当前主流）</strong>：<strong>只要在同一个模块（Module）且同一个包（Package）内</strong>，子类可以写在不同的文件里。
<ul>
<li><em>实战建议</em>：虽然允许分文件写，但为了代码可读性，建议除非类特别大，否则还是写在同一个文件里，一目了然。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-14">3.3 简单示例（包含 2025 年最新语法）</h3>
<p>注意：对于没有数据的状态，Kotlin 1.9+ 强烈推荐使用 <code>data object</code> 替代普通的 <code>object</code>，以便获得更好的 <code>toString</code> 输出。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">// 文件：UiState.kt</span>
<span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UiState</span>&lt;<span class="hljs-type">out T</span>&gt; { <span class="hljs-comment">// 支持泛型</span>
    <span class="hljs-comment">// 1. 纯状态：推荐用 data object</span>
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">object</span> Loading : UiState&lt;<span class="hljs-built_in">Nothing</span>&gt;()

    <span class="hljs-comment">// 2. 带数据：用 data class</span>
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>&lt;<span class="hljs-type">T</span>&gt;(<span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: T) : UiState&lt;T&gt;()

    <span class="hljs-comment">// 3. 带异常：用 data class</span>
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span>(<span class="hljs-keyword">val</span> exception: Throwable) : UiState&lt;<span class="hljs-built_in">Nothing</span>&gt;()
}

</code></pre>
<h3 data-id="heading-15">3.4 关键要求</h3>
<ol>
<li><strong>禁止外部新增子类</strong>：你不能在另一个模块或非同包下定义子类。</li>
<li><strong>子类不可为密封类自身</strong>：这会导致循环继承逻辑错误。</li>
<li><strong>自身抽象</strong>：不能直接 <code>new UiState()</code>。</li>
</ol>
<h2 data-id="heading-16">四、密封类的核心特性</h2>
<h3 data-id="heading-17">4.1 有限继承</h3>
<p>密封类定义了一个<strong>封闭的类型集合</strong>。这不仅仅是代码组织的方式，更是对业务逻辑的强约束。比如“网络请求”只有成功、失败、加载中这三种状态，绝不可能出现第四种未知的状态。</p>
<h3 data-id="heading-18">4.2 不可实例化</h3>
<p>由于编译后是抽象类，你无法创建密封类本身的实例。你只能创建其子类的实例。</p>
<h3 data-id="heading-19">4.3 when 表达式穷尽匹配（官方最强杀器）</h3>
<p>这是密封类存在的最大理由！当你在 <code>when</code> 表达式中使用密封类时：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">handle</span><span class="hljs-params">(state: <span class="hljs-type">UiState</span>&lt;<span class="hljs-type">String</span>&gt;)</span></span> {
    <span class="hljs-keyword">when</span> (state) {
        <span class="hljs-keyword">is</span> UiState.Loading -&gt; showLoading()
        <span class="hljs-keyword">is</span> UiState.Success -&gt; showText(state.<span class="hljs-keyword">data</span>)
        <span class="hljs-keyword">is</span> UiState.Error -&gt; showToast(state.exception.message)
    }
    <span class="hljs-comment">// 注意：这里不需要写 else！</span>
}

</code></pre>
<p><strong>编译期安全</strong>：如果你漏写了 <code>Error</code> 分支，编译器会直接报错 <code>'when' expression must be exhaustive</code>。这比运行时崩溃强一万倍。</p>
<h3 data-id="heading-20">4.4 支持带构造函数</h3>
<p>密封类可以拥有构造函数（默认 <code>protected</code> 或 <code>private</code>），允许你在父类中定义通用的属性，由子类传递进来。</p>
<h3 data-id="heading-21">4.5 子类可多实例</h3>
<ul>
<li><code>data object</code> 子类是单例。</li>
<li><code>data class</code> / <code>class</code> 子类可以创建无数个实例，每个实例携带不同的数据（如不同的错误信息、不同的用户数据）。</li>
</ul>
<h2 data-id="heading-22">五、密封类的使用场景与实战</h2>
<h3 data-id="heading-23">5.1 状态管理（UI State）</h3>
<p>这是 Android Jetpack Compose 或 ViewModel 中最标准的写法。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ScreenState</span> {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">object</span> Loading : ScreenState() <span class="hljs-comment">// 页面加载中</span>
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Content</span>(<span class="hljs-keyword">val</span> userList: List&lt;User&gt;) : ScreenState() <span class="hljs-comment">// 显示内容</span>
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span>(<span class="hljs-keyword">val</span> message: String) : ScreenState() <span class="hljs-comment">// 显示错误页</span>
}

</code></pre>
<h3 data-id="heading-24">5.2 有限类型场景（支付/权限）</h3>
<p>比如处理权限申请结果，这是典型的有限集合：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">sealed</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">PermissionResult</span> {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">object</span> Granted : PermissionResult
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">object</span> Denied : PermissionResult
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Rationale</span>(<span class="hljs-keyword">val</span> shouldShow: <span class="hljs-built_in">Boolean</span>) : PermissionResult
}

</code></pre>
<h3 data-id="heading-25">5.3 when 表达式完美适配</h3>
<p>结合 <code>when</code> 表达式，业务逻辑变得异常清晰，且不用担心遗漏。</p>
<h3 data-id="heading-26">5.4 完整实战示例：页面导航（Navigation）</h3>
<p>在 Compose 或传统路由中，用密封类管理页面参数是最优雅的。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Screen</span>(<span class="hljs-keyword">val</span> route: String) {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">object</span> Home : Screen(<span class="hljs-string">"home"</span>)
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">object</span> Login : Screen(<span class="hljs-string">"login"</span>)
    <span class="hljs-comment">// 携带参数的页面</span>
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Detail</span>(<span class="hljs-keyword">val</span> id: <span class="hljs-built_in">Long</span>) : Screen(<span class="hljs-string">"detail/<span class="hljs-variable">$id</span>"</span>)
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">navigate</span><span class="hljs-params">(screen: <span class="hljs-type">Screen</span>)</span></span> {
    <span class="hljs-keyword">when</span>(screen) {
        Screen.Home -&gt; navigator.push(<span class="hljs-string">"home"</span>)
        <span class="hljs-keyword">is</span> Screen.Detail -&gt; navigator.push(<span class="hljs-string">"detail/<span class="hljs-subst">${screen.id}</span>"</span>)
        <span class="hljs-comment">// 编译器强制检查所有页面</span>
        <span class="hljs-keyword">else</span> -&gt; {}
    }
}
</code></pre>
<h2 data-id="heading-27">六、密封类与枚举 (Enum) 的核心区别</h2>
<h3 data-id="heading-28">6.1 实例特性</h3>
<ul>
<li><strong>枚举 (Enum)</strong>：<strong>单例的</strong>。<code>Color.RED</code> 全局只有一个。</li>
<li><strong>密封类</strong>：<strong>子类实例独立的</strong>。<code>Success(data1)</code> 和 <code>Success(data2)</code> 是两个不同的对象。</li>
</ul>
<h3 data-id="heading-29">6.2 扩展灵活性</h3>
<ul>
<li><strong>枚举</strong>：所有枚举常量的结构必须完全一致。</li>
<li><strong>密封类</strong>：子类可以各玩各的。一个是单例，一个是复杂的数据类，互不干扰。</li>
</ul>
<h3 data-id="heading-30">6.3 适用场景对比表</h3>






























<table><thead><tr><th>特性</th><th>枚举 (Enum Class)</th><th>密封类 (Sealed Class)</th></tr></thead><tbody><tr><td><strong>状态数量</strong></td><td>固定有限</td><td>类型固定，但实例无限</td></tr><tr><td><strong>数据结构</strong></td><td>所有实例结构必须相同</td><td>每个子类可以有完全不同的属性</td></tr><tr><td><strong>内存开销</strong></td><td>最小</td><td>稍大（因为要创建对象）</td></tr><tr><td><strong>典型场景</strong></td><td>星期、颜色、方向</td><td>UI 状态、网络结果、指令集</td></tr></tbody></table>
<h2 data-id="heading-31">七、密封类的进阶用法</h2>
<h3 data-id="heading-32">7.1 子类携带参数与泛型</h3>
<p>配合协变泛型 <code>out T</code> 和 <code>Nothing</code> 类型，可以写出极其通用的结果类。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Result</span>&lt;<span class="hljs-type">out T</span>&gt; {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Success</span>&lt;<span class="hljs-type">T</span>&gt;(<span class="hljs-keyword">val</span> <span class="hljs-keyword">data</span>: T) : Result&lt;T&gt;()
    <span class="hljs-comment">// Error 不带泛型数据，继承 Result&lt;Nothing&gt; 即可兼容所有泛型</span>
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Error</span>(<span class="hljs-keyword">val</span> e: Throwable) : Result&lt;<span class="hljs-built_in">Nothing</span>&gt;()
}
</code></pre>
<h3 data-id="heading-33">7.2 密封类与数据类结合</h3>
<p>99% 的情况下，密封类的子类都应该是 <code>data class</code> 或 <code>data object</code>。
这样你会自动获得 <code>equals()</code>、<code>hashCode()</code>、<code>toString()</code> 和 <code>copy()</code>，在调试和对比状态时非常有用。</p>
<h3 data-id="heading-34">7.3 嵌套子类</h3>
<p>处理层级化的错误码时很有用：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppError</span> : <span class="hljs-type">Exception</span>() {
    <span class="hljs-keyword">data</span> <span class="hljs-keyword">object</span> Unknown : AppError()

    <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Network</span> : <span class="hljs-type">AppError</span>() {
        <span class="hljs-keyword">data</span> <span class="hljs-keyword">object</span> Timeout : Network()
        <span class="hljs-keyword">data</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HostUnreachable</span>(<span class="hljs-keyword">val</span> url: String) : Network()
    }

    <span class="hljs-keyword">sealed</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Database</span> : <span class="hljs-type">AppError</span>() {
        <span class="hljs-keyword">data</span> <span class="hljs-keyword">object</span> DiskFull : Database()
    }
}
</code></pre>
<h2 data-id="heading-35">八、使用注意事项与避坑点</h2>
<h3 data-id="heading-36">8.1 子类必须在同一文件（或同一模块）</h3>
<p>虽然 Kotlin 1.5+ 允许子类定义在同模块的不同文件中，但<strong>强烈建议</strong>对于简单的状态类，仍然写在同一个文件中。这能让维护者一眼看全所有可能的状态，保持代码的“内聚性”。</p>
<h3 data-id="heading-37">8.2 when 匹配需穷尽所有子类</h3>
<p><strong>避坑指南</strong>：在 <code>when</code> 匹配密封类时，<strong>尽量不要写 <code>else</code> 分支</strong>。
如果你写了 <code>else</code>，当你日后新增了一个子类状态（比如新增了 <code>Loading</code>），编译器就不会报错提醒你。这会导致新状态在运行时被忽略，产生隐蔽的 Bug。</p>
<h3 data-id="heading-38">8.3 避免滥用</h3>
<p>密封类适合**类型可枚举（有限）**的场景。如果你的子类数量成百上千，或者需要支持第三方插件动态扩展子类，请使用普通的 <code>interface</code> 或 <code>abstract class</code>。</p>
<h2 data-id="heading-39">九、总结与最佳实践</h2>
<h3 data-id="heading-40">9.1 核心知识点回顾</h3>
<ul>
<li><strong>定义</strong>：<code>sealed class</code> = 编译期已知的受限类层级。</li>
<li><strong>本质</strong>：私有构造函数的抽象类。</li>
<li><strong>杀手锏</strong>：<code>when</code> 表达式的穷尽性检查。</li>
</ul>
<h3 data-id="heading-41">9.2 最佳实践</h3>
<ol>
<li><strong>UI 状态必用</strong>：在 ViewModel 中定义 State 时，Sealed Class 是标准答案。</li>
<li><strong>单例用 data object</strong>：Kotlin 1.9+ 后，无参数状态请使用 <code>data object</code> 而非 <code>object</code>。</li>
<li><strong>拒绝 else</strong>：让编译器做你的僚机，通过报错来提醒你处理新状态。</li>
</ol>
<h3 data-id="heading-42">9.3 选型建议</h3>
<ul>
<li>如果是一组固定的常量（如星期一到星期日）→ <strong>Enum</strong>。</li>
<li>如果是一组固定的类型，且每种类型需要携带不同的数据（如成功带数据，失败带异常）→ <strong>Sealed Class</strong>。</li>
<li>如果类型需要无限扩展 → <strong>Interface / Abstract Class</strong>。</li>
</ul>
<p>掌握了密封类，你就掌握了 Kotlin 类型安全的精髓，从此告别运行时的一脸懵逼，拥抱编译时的稳如泰山。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[17.Kotlin 类：类的形态（四）：枚举类 (Enum Class)]]></title>    <link>https://juejin.cn/post/7577970969394987049</link>    <guid>https://juejin.cn/post/7577970969394987049</guid>    <pubDate>2025-11-30T06:10:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577970969394987049" data-draft-id="7577970969394970665" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="17.Kotlin 类：类的形态（四）：枚举类 (Enum Class)"/> <meta itemprop="keywords" content="后端,Kotlin,Android"/> <meta itemprop="datePublished" content="2025-11-30T06:10:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Android_小雨"/> <meta itemprop="url" content="https://juejin.cn/user/220360279590862"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            17.Kotlin 类：类的形态（四）：枚举类 (Enum Class)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/220360279590862/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Android_小雨
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T06:10:38.000Z" title="Sun Nov 30 2025 06:10:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-dark">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-built_in,.hljs-class .hljs-title{color:#e6c07b}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><blockquote>
<p>希望帮你在Kotlin进阶路上少走弯路，在技术上稳步提升。当然，由于个人知识储备有限，笔记中难免存在疏漏或表述不当的地方，也非常欢迎大家提出宝贵意见，一起交流进步。 —— Android_小雨</p>
</blockquote>
<p>整体目录：<a href="https://juejin.cn/spost/7573592952242602036" target="_blank" title="https://juejin.cn/spost/7573592952242602036">Kotlin 进阶不迷路：41 个核心知识点，构建完整知识体系</a></p>
<h2 data-id="heading-0">一、前言</h2>
<p>Kotlin 官方对枚举类的完整定义 Widest spread（逐句拆解）</p>
<blockquote>
<p>Enum classes in Kotlin are declared using the enum class keyword. Each enum constant is an object (enum constants are separated by commas). Enum constants can have properties and functions just like normal objects. The compiler automatically generates:</p>
<ul>
<li>values() – returns an array of all enum entries</li>
<li>valueOf(name) – returns the enum constant by name (throws IllegalArgumentException if not found)</li>
<li>entries (Kotlin 1.9+) – type-safe EnumEntries list (preferred over values())</li>
</ul>
<p>Enums in Kotlin are <strong>classes</strong>, so they can implement interfaces, have constructors, and even have different properties per constant.</p>
</blockquote>
<p>官方强调的 5 个核心点（记住这 5 条就彻底掌握枚举类）：</p>
<ol>
<li>每个枚举常量都是一个对象（它们是通过 Java 的 static final 字段来引用的，但它们不是简单的 int/String 基本类型常量）。</li>
<li>可以给每个常量<strong>单独传参、实现不同逻辑</strong></li>
<li>自动生成 values() / valueOf() / entries</li>
<li>支持接口实现、匿名类重写方法</li>
<li>Kotlin 1.9+ 推荐使用 entries（类型安全的集合）</li>
</ol>
<p>在 Kotlin 中，不要把枚举看作一组‘常数’，要把它们看作一组‘预定义好的单例对象集合’。</p>
<h3 data-id="heading-1">1.1 枚举类的核心定位</h3>
<p>在日常开发中，我们总会遇到一些“固定且有限”的集合：一周有七天、方向有东南西北、HTTP 状态码有 200/404/500。 如果用 <code>int</code> 或 <code>String</code> 常量来表示（比如 <code>public static final int NORTH = 1</code>），代码中就会充斥着“魔法数字”，既不直观也不安全。</p>
<p><strong>枚举类 (Enum Class)</strong> 的核心定位就是：<strong>定义固定有限的常量集合，保障类型安全</strong>。它强迫你在编译期就确定好所有的可能性，把运行时可能出现的“无效值”错误扼杀在摇篮里。</p>
<h3 data-id="heading-2">1.2 Kotlin 枚举类的设计优势</h3>
<p>相比于 Java，Kotlin 的枚举虽然底层一致，但语法更加简洁，且自带了现代化的工具方法。 它是**“带超能力的枚举”**：</p>
<ul>
<li><strong>不仅是常量</strong>：每个枚举项本质上都是一个完整的对象。</li>
<li><strong>功能丰富</strong>：支持属性、方法、接口实现，甚至匿名类重写。</li>
<li><strong>工具完善</strong>：Kotlin 1.9+ 引入的 <code>entries</code> 属性，让遍历枚举变得无需对象分配且类型安全。</li>
</ul>
<h3 data-id="heading-3">1.3 核心疑问：Kotlin 枚举类与 Java 枚举有何关联？</h3>
<p>很多从 Java 转过来的同学会问：<code>enum class</code> 到底是个什么新物种？ 答案是：<strong>它不是新物种</strong>。Kotlin 枚举在 JVM 层面上，<strong>完全等同于 Java 的 <code>enum</code></strong>。这意味着它们在字节码层面是一致的，互操作性 100%。</p>
<h3 data-id="heading-4">1.4 本文核心内容预告</h3>
<p>本文将从底层开始，层层递进：</p>
<ol>
<li><strong>Java 映射</strong>：看透它的底层实现（继承自 <code>java.lang.Enum</code>）。</li>
<li><strong>基础语法</strong>：掌握 2025 年最新的定义方式。</li>
<li><strong>核心特性</strong>：理解类型安全与单例本质。</li>
<li><strong>实战场景</strong>：状态机、策略模式等真实案例。</li>
<li><strong>对比分析</strong>：彻底搞懂它和密封类（Sealed Class）的区别。</li>
</ol>
<h2 data-id="heading-5">二、核心揭秘：Kotlin 枚举类 → Java 代码映射</h2>
<p>要理解枚举的本质，必须看它编译后的样子。</p>
<h3 data-id="heading-6">2.1 映射底层原理</h3>
<p>Kotlin 的 <code>enum class</code> 在编译后，会生成一个继承自 <code>java.lang.Enum</code> 的类。</p>
<ul>
<li>每个枚举常量，都会变成该类的一个 <code>public static final</code> 实例。</li>
<li>这意味着枚举常量在 JVM 中是<strong>单例</strong>的。</li>
</ul>
<h3 data-id="heading-7">2.2 完整示例映射</h3>
<h3 data-id="heading-8">2.2.1 基础枚举类</h3>
<p><strong>Kotlin 原代码：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Direction</span> {
    NORTH, SOUTH
}
</code></pre>
<p><strong>Java 反编译结果（简化版）：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Direction</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Enum</span>&lt;Direction&gt; {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Direction NORTH;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Direction SOUTH;

    <span class="hljs-comment">// 静态初始化块，创建单例</span>
    <span class="hljs-keyword">static</span> {
        NORTH = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Direction</span>(<span class="hljs-string">"NORTH"</span>, <span class="hljs-number">0</span>);
        SOUTH = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Direction</span>(<span class="hljs-string">"SOUTH"</span>, <span class="hljs-number">1</span>);
    }
}
</code></pre>
<h3 data-id="heading-9">2.2.2 带属性/方法的枚举类</h3>
<p><strong>Kotlin 原代码：</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpStatus</span>(<span class="hljs-keyword">val</span> code: <span class="hljs-built_in">Int</span>) {
    OK(<span class="hljs-number">200</span>);
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isSuccess</span><span class="hljs-params">()</span></span> = code == <span class="hljs-number">200</span>
}
</code></pre>
<p><strong>Java 反编译结果：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">HttpStatus</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Enum</span>&lt;HttpStatus&gt; {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> HttpStatus OK;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> code; <span class="hljs-comment">// 属性变成了 final 字段</span>

    <span class="hljs-comment">// 构造函数私有化</span>
    <span class="hljs-keyword">private</span> <span class="hljs-title function_">HttpStatus</span><span class="hljs-params">(String name, <span class="hljs-type">int</span> ordinal, <span class="hljs-type">int</span> code)</span> {
        <span class="hljs-built_in">super</span>(name, ordinal);
        <span class="hljs-built_in">this</span>.code = code;
    }

    <span class="hljs-comment">// 方法变成普通成员方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSuccess</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.code == <span class="hljs-number">200</span>;
    }
}
</code></pre>
<h3 data-id="heading-10">2.3 关键细节</h3>
<ol>
<li><strong>构造函数</strong>：JVM 自动处理了 <code>name</code> 和 <code>ordinal</code> 参数，我们定义的参数（如 <code>code</code>）被追加在后面。</li>
<li><strong>values() / valueOf()</strong> ：这些静态方法是由编译器自动合成生成的（Synthesized），用于查找和遍历。</li>
</ol>
<h2 data-id="heading-11">三、枚举类基础：定义与语法规范</h2>
<h3 data-id="heading-12">3.1 基本语法</h3>
<p>使用 <code>enum class</code> 关键字（注意是两个词，中间有空格）。</p>
<h3 data-id="heading-13">3.2 基础枚举定义</h3>
<p>适用于不需要携带额外数据的场景。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Gender</span> {
    MALE, FEMALE, OTHER
}
</code></pre>
<h3 data-id="heading-14">3.3 带属性的枚举类</h3>
<p>这是枚举最常用的形态。通过主构造函数定义属性，每个常量必须传入对应的值。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Color</span>(<span class="hljs-keyword">val</span> hex: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> description: String) {
    RED(<span class="hljs-number">0xFF0000</span>, <span class="hljs-string">"红色"</span>),
    GREEN(<span class="hljs-number">0x00FF00</span>, <span class="hljs-string">"绿色"</span>),
    BLUE(<span class="hljs-number">0x0000FF</span>, <span class="hljs-string">"蓝色"</span>); <span class="hljs-comment">// 注意：如果有额外成员，最后一个常量后必须加分号</span>

    <span class="hljs-keyword">val</span> rgbString: String
        <span class="hljs-keyword">get</span>() = <span class="hljs-string">"#"</span> + Integer.toHexString(hex)
}
</code></pre>
<h3 data-id="heading-15">3.4 带方法的枚举类（匿名类实现）</h3>
<p>每个枚举常量不仅可以有属性，还可以有<strong>不同的行为</strong>。这实际上是<strong>策略模式</strong>的一种微型实现。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Operator</span> {
    PLUS {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">apply</span><span class="hljs-params">(x: <span class="hljs-type">Int</span>, y: <span class="hljs-type">Int</span>)</span></span> = x + y
    },
    MINUS {
        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">apply</span><span class="hljs-params">(x: <span class="hljs-type">Int</span>, y: <span class="hljs-type">Int</span>)</span></span> = x - y
    }; <span class="hljs-comment">// 分号必须</span>

    <span class="hljs-comment">// 定义抽象方法，强制每个常量实现</span>
    <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">apply</span><span class="hljs-params">(x: <span class="hljs-type">Int</span>, y: <span class="hljs-type">Int</span>)</span></span>: <span class="hljs-built_in">Int</span>
}
</code></pre>
<h3 data-id="heading-16">3.5 简单示例</h3>
<p>定义一个支付方式枚举：</p>
<pre><code class="hljs language-scss" lang="scss">enum class <span class="hljs-built_in">PayType</span>(val typeId: Int) {
    <span class="hljs-built_in">ALIPAY</span>(<span class="hljs-number">1</span>),
    <span class="hljs-built_in">WECHAT</span>(<span class="hljs-number">2</span>),
    <span class="hljs-built_in">CREDIT_CARD</span>(<span class="hljs-number">3</span>)
}
</code></pre>
<h2 data-id="heading-17">四、枚举类的核心特性</h2>
<h3 data-id="heading-18">4.1 类型安全</h3>
<p>这是枚举存在的最大意义。 <code>fun pay(type: PayType)</code> 当你看到这个函数签名时，你很放心，因为调用者绝对不可能传入一个非法的类型（比如传入 <code>4</code> 或 <code>null</code>）。编译器会帮你看住大门。</p>
<h3 data-id="heading-19">4.2 单例特性</h3>
<p>每个枚举常量（如 <code>PayType.ALIPAY</code>）在整个应用生命周期中<strong>只有一个实例</strong>。你可以直接用 <code>==</code> 或 <code>===</code> 来比较它们，效果完全一样且高效。</p>
<h3 data-id="heading-20">4.3 自带工具方法</h3>
<p>Kotlin 编译器自动生成了以下神器：</p>
<ul>
<li>
<p><strong><code>entries</code> (Kotlin 1.9+ 推荐)</strong> ：返回一个类型安全的、不可变的 <code>List</code>，包含所有常量。</p>
<ul>
<li><em>优势</em>：相比旧的 <code>values()</code>，<code>entries</code> 避免了每次调用都克隆一个新数组，性能更好，且支持集合操作。</li>
</ul>
</li>
<li>
<p><strong><code>values()</code> (旧版，不推荐)</strong> ：返回一个数组 <code>Array</code>。</p>
</li>
<li>
<p><strong><code>valueOf(name: String)</code></strong> ：通过名字查找常量。如果找不到会抛 <code>IllegalArgumentException</code>。</p>
</li>
<li>
<p><strong><code>name</code></strong>: 常量的名称（String）。</p>
</li>
<li>
<p><strong><code>ordinal</code></strong>: 常量的索引（Int，从 0 开始）。</p>
</li>
</ul>
<pre><code class="hljs language-go" lang="go"><span class="hljs-comment">// 遍历 (推荐写法)</span>
PayType.entries.forEach { <span class="hljs-built_in">println</span>(it.name) }

<span class="hljs-comment">// 查找</span>
val <span class="hljs-keyword">type</span> = PayType.valueOf(<span class="hljs-string">"ALIPAY"</span>)
</code></pre>
<h3 data-id="heading-21">4.4 支持属性与方法</h3>
<p>枚举不是死板的常量，它是类。你可以给它加 <code>fun isRecommended()</code>，或者 <code>val label: String</code>，让枚举自己携带业务逻辑，避免到处写 <code>if (type == ALIPAY) ...</code>。</p>
<h3 data-id="heading-22">4.5 可实现接口</h3>
<p>枚举可以实现接口，这让它能融入更复杂的架构中。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Printable</span> { <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">print</span><span class="hljs-params">()</span></span> }

<span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Level</span> : <span class="hljs-type">Printable</span> {
    LOW { <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">print</span><span class="hljs-params">()</span></span> = println(<span class="hljs-string">"Low"</span>) },
    HIGH { <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">print</span><span class="hljs-params">()</span></span> = println(<span class="hljs-string">"High"</span>) }
}
</code></pre>
<h2 data-id="heading-23">五、枚举类的使用场景与实战</h2>
<h3 data-id="heading-24">5.1 固定选项场景</h3>
<p>如下拉框选项、性别、血型。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BloodType</span> { A, B, AB, O }
</code></pre>
<h3 data-id="heading-25">5.2 状态标识场景</h3>
<p>网络请求状态、订单流转状态。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestState</span> {
    IDLE, LOADING, SUCCESS, ERROR
}
</code></pre>
<h3 data-id="heading-26">5.3 与 when 表达式适配（穷尽检查）</h3>
<p>这是枚举最爽的特性。配合 <code>when</code> 表达式，编译器会强制你处理所有情况。</p>
<pre><code class="hljs language-scss" lang="scss">fun <span class="hljs-built_in">handleState</span>(state: RequestState) {
    when (state) {
        RequestState<span class="hljs-selector-class">.IDLE</span> -&gt; <span class="hljs-built_in">init</span>()
        RequestState<span class="hljs-selector-class">.LOADING</span> -&gt; <span class="hljs-built_in">showProgress</span>()
        RequestState<span class="hljs-selector-class">.SUCCESS</span> -&gt; <span class="hljs-built_in">showData</span>()
        RequestState<span class="hljs-selector-class">.ERROR</span> -&gt; <span class="hljs-built_in">showError</span>()
    }
    <span class="hljs-comment">// 不需要 else！如果你漏了一个状态，编译器会报错。</span>
}
</code></pre>
<h3 data-id="heading-27">5.4 完整实战示例</h3>
<p>一个带有逻辑判断的权限枚举：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Permission</span>(<span class="hljs-keyword">val</span> description: String) {
    READ_CONTACTS(<span class="hljs-string">"读取联系人"</span>),
    CAMERA(<span class="hljs-string">"使用相机"</span>),
    LOCATION(<span class="hljs-string">"获取定位"</span>);

    <span class="hljs-comment">// 模拟检查权限的逻辑</span>
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isSensitive</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span> == LOCATION || <span class="hljs-keyword">this</span> == READ_CONTACTS
    }
}

<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">request</span><span class="hljs-params">(p: <span class="hljs-type">Permission</span>)</span></span> {
    <span class="hljs-keyword">if</span> (p.isSensitive()) {
        println(<span class="hljs-string">"正在申请敏感权限: <span class="hljs-subst">${p.description}</span>"</span>)
    }
}
</code></pre>
<h2 data-id="heading-28">六、枚举类与密封类 (Sealed Class) 的核心区别</h2>
<p>这是面试和架构选型的高频问题。</p>
<h3 data-id="heading-29">6.1 实例特性</h3>
<ul>
<li><strong>枚举 (Enum)</strong> ：<strong>单例的</strong>。<code>State.ERROR</code> 全局只有一个对象。你不能创建 <code>State.ERROR("Network error")</code> 和 <code>State.ERROR("Timeout")</code> 两个不同的错误对象。</li>
<li><strong>密封类 (Sealed Class)</strong> ：<strong>子类可以多实例</strong>。你可以创建无数个 <code>Error</code> 对象，每个携带不同的异常信息。</li>
</ul>
<h3 data-id="heading-30">6.2 数据灵活性</h3>
<ul>
<li><strong>枚举</strong>：所有常量的结构必须<strong>完全一致</strong>（都由主构造函数决定）。</li>
<li><strong>密封类</strong>：子类可以各玩各的。一个是 <code>object</code>，一个是 <code>data class</code>，结构互不干扰。</li>
</ul>
<h3 data-id="heading-31">6.3 适用场景对比表</h3>






























<table><thead><tr><th>特性</th><th>枚举类 (Enum)</th><th>密封类 (Sealed Class)</th></tr></thead><tbody><tr><td><strong>状态数量</strong></td><td>固定有限</td><td>固定有限（类型有限）</td></tr><tr><td><strong>数据载荷</strong></td><td><strong>必须相同</strong>（如都有 code, msg）</td><td><strong>可以不同</strong>（A 带 String, B 带 Exception）</td></tr><tr><td><strong>实例数量</strong></td><td><strong>单例</strong> (Singleton)</td><td><strong>多实例</strong> (Instance)</td></tr><tr><td><strong>典型场景</strong></td><td>星期、颜色、固定配置</td><td>UI 状态（需带数据）、网络结果</td></tr></tbody></table>
<p><strong>结论</strong>：如果你的状态不需要携带动态数据（或者所有状态携带的数据结构完全一样），优先用 <strong>枚举</strong>。如果不同状态需要携带不同数据（比如 <code>Success</code> 带 data，<code>Error</code> 带 exception），必须用 <strong>密封类</strong>。</p>
<h2 data-id="heading-32">七、枚举类的进阶用法</h2>
<h3 data-id="heading-33">7.1 枚举常量实现抽象方法</h3>
<p>在 3.4 节已展示。这种写法非常适合<strong>策略模式</strong>，比如计算器应用，加减乘除逻辑不同，但都属于 <code>Operation</code> 类型。</p>
<h3 data-id="heading-34">7.2 枚举类结合伴生对象 (Companion Object)</h3>
<p>通常用于编写“反向查找”逻辑，比如根据 <code>code</code> 找枚举。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ErrorCode</span>(<span class="hljs-keyword">val</span> code: <span class="hljs-built_in">Int</span>) {
    NOT_FOUND(<span class="hljs-number">404</span>), SERVER_ERROR(<span class="hljs-number">500</span>);

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">fromCode</span><span class="hljs-params">(code: <span class="hljs-type">Int</span>)</span></span>: ErrorCode? {
            <span class="hljs-comment">// entries 是 Kotlin 1.9+ 的高效写法</span>
            <span class="hljs-keyword">return</span> entries.find { it.code == code }
        }
    }
}
</code></pre>
<h3 data-id="heading-35">7.3 枚举类用于序列化</h3>
<p>在 Gson 或 Moshi 等库中，枚举通常会被自动序列化为它的 <code>name</code> 字符串。但如果你想序列化为 <code>code</code> (Int)，通常需要配合 <code>@SerializedName</code> (Gson) 或 <code>@Json</code> (Moshi) 注解。</p>
<h3 data-id="heading-36">7.4 枚举类存储配置信息</h3>
<p>有时候可以用枚举来替代复杂的配置类：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">enum</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ThemeConfig</span>(<span class="hljs-keyword">val</span> colorPrimary: <span class="hljs-built_in">Int</span>, <span class="hljs-keyword">val</span> isDark: <span class="hljs-built_in">Boolean</span>) {
    LIGHT(<span class="hljs-number">0xFFFFFF</span>, <span class="hljs-literal">false</span>),
    DARK(<span class="hljs-number">0x000000</span>, <span class="hljs-literal">true</span>)
}
</code></pre>
<h2 data-id="heading-37">八、使用注意事项与避坑点</h2>
<h3 data-id="heading-38">8.1 性能提示</h3>
<p>枚举在 Java/Kotlin 中是完整的对象，比 <code>static final int</code> 常量占用更多的内存（每个实例大概多几十字节）。</p>
<ul>
<li><strong>Android 开发注意</strong>：虽然现在设备性能好了，但如果你有成千上万个状态需要保存，考虑使用 <code>@IntDef</code> (Android 注解) 来替代枚举以节省内存。但在 99% 的业务逻辑中，枚举的内存开销可忽略不计，<strong>优先换取代码可读性和安全性</strong>。</li>
</ul>
<h3 data-id="heading-39">8.2 不可动态扩展</h3>
<p>枚举是编译期常量。你不能在运行时从服务器下载一个 JSON，然后动态往枚举类里添加一个新类型。如果你的类型列表是动态变化的（比如后台配置的活动类型），请使用普通的 <code>data class</code> 或数据库表。</p>
<h3 data-id="heading-40">8.3 valueOf() 风险</h3>
<p><code>enumValueOf&lt;T&gt;("NAME")</code> 或 <code>Enum.valueOf("NAME")</code> 是不安全的。 如果传入的字符串不匹配任何枚举名，应用会<strong>崩溃</strong>（抛出异常）。 <strong>避坑</strong>：自己封装一个 <code>safeValueOf</code>，或者利用 <code>entries.find { ... }</code> 来安全查找。</p>
<h3 data-id="heading-41">8.4 永远不要依赖 ordinal</h3>
<p><code>ordinal</code> 表示枚举声明的顺序（0, 1, 2...）。 <strong>千万不要</strong>把 <code>ordinal</code> 存入数据库！因为如果你哪天心情好，在中间插入了一个新枚举，后面所有枚举的 <code>ordinal</code> 都会变，导致数据库数据错乱。<strong>始终使用自定义的 <code>id</code> 或 <code>code</code> 属性。</strong></p>
<h2 data-id="heading-42">九、总结与最佳实践</h2>
<h3 data-id="heading-43">9.1 核心知识点回顾</h3>
<ul>
<li><strong>本质</strong>：<code>class</code>，继承自 <code>java.lang.Enum</code>，单例对象。</li>
<li><strong>语法</strong>：<code>enum class</code>。</li>
<li><strong>工具</strong>：优先使用 <code>entries</code> (1.9+)，慎用 <code>valueOf</code>。</li>
<li><strong>穷尽</strong>：配合 <code>when</code> 表达式，不写 <code>else</code>。</li>
</ul>
<h3 data-id="heading-44">9.2 最佳实践</h3>
<ol>
<li><strong>优先用枚举</strong>：凡是固定的常量集合，不要用 <code>Interface</code> 定义常量，全部上枚举。</li>
<li><strong>自定义属性</strong>：给枚举加上 <code>code</code>、<code>desc</code> 等属性，让它成为“富模型”，而不是单纯的符号。</li>
<li><strong>伴生对象工厂</strong>：提供 <code>fromCode()</code> 等静态方法，方便业务层调用。</li>
<li><strong>去魔法化</strong>：代码中不应出现 <code>type == 1</code>，而应是 <code>type == UserType.VIP</code>。</li>
</ol>
<h3 data-id="heading-45">9.3 选型建议</h3>
<ul>
<li><strong>无动态数据 + 类型有限</strong>（如性别、星期） → <strong>枚举 (Enum)</strong></li>
<li><strong>带动态数据 + 类型有限</strong>（如 Result.Success(data)） → <strong>密封类 (Sealed Class)</strong></li>
<li><strong>类型无限</strong> → <strong>普通类 / 接口</strong></li>
</ul>
<p>掌握枚举类，是告别“面条代码”和“魔法数字”的第一步。用好它，你的 Kotlin 代码将变得既严谨又优雅。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Promise × 定时器全场景手写]]></title>    <link>https://juejin.cn/post/7577914902430629934</link>    <guid>https://juejin.cn/post/7577914902430629934</guid>    <pubDate>2025-11-30T09:01:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577914902430629934" data-draft-id="7577718777482035238" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Promise × 定时器全场景手写"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-30T09:01:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="二二四一"/> <meta itemprop="url" content="https://juejin.cn/user/2975738274777080"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Promise × 定时器全场景手写
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2975738274777080/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    二二四一
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T09:01:27.000Z" title="Sun Nov 30 2025 09:01:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🥇 01. 并发限制调度器（异步霸榜 No.1）</h2>
<blockquote>
<p>场景：你要发 100 个请求，但后端限流，每次只能发 N 个。</p>
</blockquote>
<blockquote>
<p>交互：可以在中途暂停执行，获取已执行的结果。</p>
</blockquote>
<p>🤔考点：工程思维能力</p>
<hr/>
<p>🌈实现：模拟一个迷你版“浏览器资源调度器”，这个调度器的核心本质，是通过「running 计数」「idx 游标」「runNext 自驱动」三者配合，实现一个动态的任务池。它保证任务源源不断执行，但同时不会超过给定的并发上限。</p>
<ol>
<li>调用方法</li>
</ol>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">MyWork</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 生成调度器</span>
  <span class="hljs-keyword">const</span> scheduler = <span class="hljs-title function_">limitRequests</span>(tasks, <span class="hljs-number">3</span>);

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleStart</span>(<span class="hljs-params"/>) {
    scheduler.<span class="hljs-title function_">start</span>().<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">res</span>) =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"所有任务完成！"</span>);
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"结果:"</span>, res);
    });
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleEnd</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"暂停完成执行～"</span>);
    scheduler.<span class="hljs-title function_">stop</span>();
  }

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleStart}</span>&gt;</span>开始<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleEnd}</span>&gt;</span>暂停<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>2.  自定义调度器</p>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">limitRequests</span>(<span class="hljs-params">tasks, limit</span>) {
  <span class="hljs-keyword">const</span> res = [] <span class="hljs-comment">// 存所有任务返回的 Promise，用来最终 Promise.all</span>
  <span class="hljs-keyword">let</span> idx = <span class="hljs-number">0</span> <span class="hljs-comment">// 当前处理到第几个任务</span>
  <span class="hljs-keyword">let</span> running = <span class="hljs-number">0</span> <span class="hljs-comment">// 当前正在执行的任务数量（关键的并发控制变量）</span>
  <span class="hljs-keyword">let</span> stopped = <span class="hljs-literal">false</span> <span class="hljs-comment">// 用于标识是否已停止</span>

  <span class="hljs-comment">// 暴露的停止执行的方法</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">stop</span>(<span class="hljs-params"/>) {
    stopped = <span class="hljs-literal">true</span>
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">start</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
      <span class="hljs-keyword">function</span> <span class="hljs-title function_">runNext</span>(<span class="hljs-params"/>) {
        <span class="hljs-comment">// 执行队列处理完毕或者已暂停，返回结果</span>
        <span class="hljs-keyword">if</span> (running === <span class="hljs-number">0</span> &amp;&amp; stopped) {
          <span class="hljs-keyword">return</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">all</span>(res))
        }

        <span class="hljs-comment">// 正在执行的任务数量不超过单次限制，存在未执行的任务</span>
        <span class="hljs-keyword">while</span> (running &lt; limit &amp;&amp; idx &lt; tasks.<span class="hljs-property">length</span>) {
          <span class="hljs-comment">// 如果停止标志为 true，阻止新的任务加入</span>
          <span class="hljs-keyword">if</span> (stopped) {
            <span class="hljs-keyword">return</span>
          }
          <span class="hljs-comment">// 获取当前任务并执行</span>
          <span class="hljs-keyword">const</span> cur = tasks[idx++]()
          res.<span class="hljs-title function_">push</span>(cur)
          running++
          cur.<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
            running--
            <span class="hljs-title function_">runNext</span>()
          }).<span class="hljs-keyword">catch</span>(reject)
        }
      }

      <span class="hljs-title function_">runNext</span>()
    })
  }

  <span class="hljs-keyword">return</span> { stop, start }
}
</code></pre>
<p>3.  模拟异步方法、准备数据</p>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建100个任务</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> tasks = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">100</span> }, <span class="hljs-function">(<span class="hljs-params">_, i</span>) =&gt;</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetchData</span>(i))

<span class="hljs-comment">// 模拟异步请求方法</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-params">id: number</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
    <span class="hljs-keyword">const</span> time = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() * <span class="hljs-number">2000</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`开始任务: <span class="hljs-subst">${id}</span>`</span>)

    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`完成任务: <span class="hljs-subst">${id}</span>`</span>)
      <span class="hljs-title function_">resolve</span>(id)
    }, time)
  })
}
</code></pre>
<p>4.  自定义hook</p>

<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">useLimitRequests</span> = (tasks: any[], limit: number)=&gt; {
  const <span class="hljs-attr">resultRef</span> = useRef&lt;number[]&gt;([])<span class="hljs-comment">; // 用 useRef 存储任务结果，避免重新渲染</span>
  const <span class="hljs-attr">isStop</span> = useRef&lt;boolean&gt;(<span class="hljs-literal">false</span>)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">idx</span> = useRef&lt;number&gt;(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">reunning</span> = useRef&lt;number&gt;(<span class="hljs-number">0</span>)<span class="hljs-comment">;</span>

  const <span class="hljs-attr">onStop</span> = useCallback(() =&gt; {
    <span class="hljs-attr">isStop.current</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
  },<span class="hljs-section">[]</span>)<span class="hljs-comment">;</span>

  const <span class="hljs-attr">onStart</span> = useCallback(() =&gt; {
    return new Promise((resolve, reject) =&gt; {
      function nextRun(){
        if(<span class="hljs-attr">reunning.current</span> === <span class="hljs-number">0</span> &amp;&amp; isStop.current) {
          return resolve(Promise.all(resultRef.current))<span class="hljs-comment">;</span>
        }

        while(idx.current &lt; tasks.length &amp;&amp; reunning.current &lt; limit){
          if(isStop.current){
            return<span class="hljs-comment">;</span>
          }

          const <span class="hljs-attr">curTaskRes</span> = tasks[idx.current]()<span class="hljs-comment">;</span>
          idx.current += 1<span class="hljs-comment">;</span>
          resultRef.current.push(curTaskRes)
          reunning.current += 1<span class="hljs-comment">;</span>

          curTaskRes.then(() =&gt; {
            reunning.current <span class="hljs-attr">-</span>= <span class="hljs-number">1</span><span class="hljs-comment">;</span>
            nextRun()<span class="hljs-comment">;</span>
          }).catch((error: any) =&gt; reject(error))
        }
      }

      nextRun()<span class="hljs-comment">;</span>
    })
  },<span class="hljs-section">[isStop, limit, tasks]</span>)<span class="hljs-comment">;</span>

  return { onStop, onStart}<span class="hljs-comment">;</span>
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7e38071875e4ff09dcf63777b48fade~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM5LqM5Zub5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765098087&amp;x-signature=F0PSaYzn7hWn59O4bapyrnjrvCE%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">🥈 02. 支持指数退避的重试（Backoff Retry）</h2>
<blockquote>
<p>场景：接口偶尔报错，你希望自动重试 3 次，每次等待时间翻倍。</p>
</blockquote>
<p>💡 可靠性思维能力</p>
<hr/>
<ol>
<li>自定义重试方法</li>
</ol>

<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">retry</span>(fn, times = <span class="hljs-number">3</span>, delay = <span class="hljs-number">500</span>) {
  return new <span class="hljs-built_in">Promise</span>((resolve, reject) =&gt; {
    const attempt = (n, d) =&gt; {
      <span class="hljs-built_in">fn</span>()<span class="hljs-selector-class">.then</span>(resolve)<span class="hljs-selector-class">.catch</span>(err =&gt; {
        if (n === <span class="hljs-number">0</span>) return <span class="hljs-built_in">reject</span>(err)
        <span class="hljs-built_in">setTimeout</span>(() =&gt; <span class="hljs-built_in">attempt</span>(n - <span class="hljs-number">1</span>, d * <span class="hljs-number">2</span>), d)
      })
    }
    <span class="hljs-built_in">attempt</span>(times, delay)
  })
}
</code></pre>
<p>2.  调用</p>

<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleRetry</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">retry</span>(mockRequest, <span class="hljs-number">3</span>, <span class="hljs-number">500</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result)) <span class="hljs-comment">// 如果请求成功，输出结果</span>
      .<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error)); <span class="hljs-comment">// 如果重试失败，输出错误</span>
  }
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7a6251a15a9246f884f1cd5100b3cc6c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM5LqM5Zub5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765098087&amp;x-signature=Oh0L2qjBBKJyZoBKF%2BmWB0sG38M%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">🥉 03. 带超时控制的 Promise（Timeout Promise）</h2>
<blockquote>
<p>场景：请求超 3 秒自动失败，不等了。</p>
</blockquote>
<p>🕒 超时包装器</p>
<hr/>
<ol>
<li>自定义函数实现</li>
</ol>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">withTimeout</span>(<span class="hljs-params">fn, ms</span>){
  <span class="hljs-comment">// 存放定时器</span>
  <span class="hljs-keyword">let</span> timer = <span class="hljs-literal">null</span>;

  <span class="hljs-comment">// 超时函数</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">timeOut</span> = (<span class="hljs-params"/>) =&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">_, reject</span>) =&gt;</span> {
    timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'超时了'</span>)), ms);
  });

  <span class="hljs-comment">// Promise.race 会返回一个结果， fn 目标函数</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">race</span>([<span class="hljs-title function_">fn</span>(), <span class="hljs-title function_">timeOut</span>()]).<span class="hljs-title function_">finally</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-built_in">clearTimeout</span>(timer);
  })
}
</code></pre>
<p>2.  模拟延迟异步方法</p>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">slowTask</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'Task completed'</span>), <span class="hljs-number">2000</span>); <span class="hljs-comment">// 模拟一个 3 秒的任务</span>
  });
}
</code></pre>
<p>3.  调用</p>

<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleTimeOut</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">withTimeout</span>(slowTask, <span class="hljs-number">1000</span>) <span class="hljs-comment">// 设置 1 秒超时</span>
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result)) <span class="hljs-comment">// 如果任务完成，输出结果</span>
      .<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">error</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(error)); <span class="hljs-comment">// 如果超时，输出超时错误</span>
  }
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1855acce3d2e45f199764f982e644d1f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM5LqM5Zub5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765098087&amp;x-signature=uaUFCr%2BXVu6jjAIp80apf%2BdBOhA%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-3">🚢 04. 串行任务：一步一步稳扎稳打</h2>
<blockquote>
<p>每个任务会按顺序一个接一个地执行，<strong>直到上一个任务完成后，才会开始下一个任务</strong></p>
</blockquote>
<p>📌 场景：分片上传、表单分步骤提交</p>
<hr/>
<ol>
<li>自定义方法</li>
</ol>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">runInSequence</span>(<span class="hljs-params">tasks</span>){
  <span class="hljs-keyword">const</span> result = [];

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> task <span class="hljs-keyword">of</span> tasks) {
    <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">task</span>();
    result.<span class="hljs-title function_">push</span>(res);
  }

  <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p>2.  模拟异步请求</p>

<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title function_">fetchData</span> = (<span class="hljs-params">task: <span class="hljs-built_in">any</span></span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Task <span class="hljs-subst">${task}</span> completed`</span>);
      <span class="hljs-title function_">resolve</span>(<span class="hljs-string">`Result of <span class="hljs-subst">${task}</span>`</span>);
    }, <span class="hljs-number">1000</span>); <span class="hljs-comment">// 每个任务延迟 1 秒</span>
  });
};

<span class="hljs-comment">// 定义任务列表</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> tasks = [
  <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-string">'task1'</span>),
  <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-string">'task2'</span>),
  <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">fetchData</span>(<span class="hljs-string">'task3'</span>)
];
</code></pre>
<p>3.  调用</p>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleEquence</span>(<span class="hljs-params"/>){
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> <span class="hljs-title function_">runInSequence</span>(tasks);
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'All tasks completed'</span>, result);
  }
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/42b31c347ea94793aa1cd6726f22d858~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM5LqM5Zub5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765098087&amp;x-signature=X9Ihy%2B83yMznmbeehOXJCjCm%2Bl4%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-4">⌚️ 05. Promise 版“多方等待 ready”机制</h2>
<blockquote>
<p>这个机制用于让多个任务或组件等待某个条件（如 <code>ready()</code> 方法被调用）满足后再继续执行</p>
</blockquote>
<p><strong>应用场景</strong></p>
<ul>
<li>
<p><strong>多个任务依赖同一个条件</strong>：比如，多个组件在等待某个数据加载完成后再开始执行某个操作</p>
</li>
<li>
<p><strong>等待多个异步任务的准备</strong>：多个异步任务可能依赖某个资源，只有当该资源准备好时，才能继续执行后续操作。</p>
</li>
<li>
<p><strong>协调并发任务的开始</strong>：不同的任务或组件可以等待一个共同的“开始信号”，一旦信号发送，所有等待的任务就可以同时开始。</p>
</li>
</ul>
<hr/>
<ol>
<li>自定义class</li>
</ol>

<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Waiter</span>{
  <span class="hljs-attr">queue</span>: <span class="hljs-built_in">any</span>[];
  <span class="hljs-attr">readyFlag</span>: <span class="hljs-built_in">boolean</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>){
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span> = []; <span class="hljs-comment">// 所有等待的任务</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">readyFlag</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 是否已经准备好</span>
  }

  <span class="hljs-title function_">wait</span>(<span class="hljs-params"/>){
    <span class="hljs-comment">// 条件已经准备好了，直接返回一个已解决的 Promise</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">readyFlag</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>();
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 将该任务的 Promise 放入 queue 队列中，等待</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">r</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span>.<span class="hljs-title function_">push</span>(r));
    }
  }


  <span class="hljs-title function_">ready</span>(<span class="hljs-params"/>){
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">readyFlag</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 设置条件已准备好</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> <span class="hljs-title function_">r</span>()); <span class="hljs-comment">// 遍历队列并触发所有等待的任务</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">queue</span> = []; <span class="hljs-comment">// 清空队列</span>
  }
}
</code></pre>
<p>2.  调用</p>

<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">handleReady</span>() {
    const waiter = new <span class="hljs-built_in">Waiter</span>();

    <span class="hljs-comment">// 任务 1：等待条件准备好后执行</span>
    waiter<span class="hljs-selector-class">.wait</span>()<span class="hljs-selector-class">.then</span>(() =&gt; console<span class="hljs-selector-class">.log</span>("Task <span class="hljs-number">1</span> completed"));

    <span class="hljs-comment">// 任务 2：等待条件准备好后执行</span>
    waiter<span class="hljs-selector-class">.wait</span>()<span class="hljs-selector-class">.then</span>(() =&gt; console<span class="hljs-selector-class">.log</span>("Task <span class="hljs-number">2</span> completed"));

    <span class="hljs-comment">// 任务 3：等待条件准备好后执行</span>
    waiter<span class="hljs-selector-class">.wait</span>()<span class="hljs-selector-class">.then</span>(() =&gt; console<span class="hljs-selector-class">.log</span>("Task <span class="hljs-number">3</span> completed"));

    <span class="hljs-comment">// 在 2 秒后，调用 `ready()`，表示条件准备好，所有任务可以执行</span>
    <span class="hljs-built_in">setTimeout</span>(() =&gt; {
      waiter<span class="hljs-selector-class">.ready</span>(); <span class="hljs-comment">// 调用 ready，触发所有等待的任务</span>
    }, <span class="hljs-number">2000</span>);
  }
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/85e8dc0c19774838afd0065b32db4b17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM5LqM5Zub5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765098087&amp;x-signature=RAAABTMPrGulp5XmjYATqlqtBe8%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-5">06. 可暂停 / 恢复的 setInterval（轮询神器）</h2>
<blockquote>
<p>可以启动、暂停和恢复一个定时任务，而无需重启整个定时器</p>
</blockquote>
<p>🌡️ 场景：页面隐藏暂停轮询，返回恢复</p>
<hr/>
<ol>
<li>自定义class</li>
</ol>

<pre><code class="hljs language-kotlin" lang="kotlin">export <span class="hljs-keyword">class</span> <span class="hljs-title class_">PausableInterval</span>{
  delay: number;
  fn: any;
  timer: any;
  running: boolean;

  <span class="hljs-keyword">constructor</span>(fn: any, delay: number){
    <span class="hljs-keyword">this</span>.fn = fn            <span class="hljs-comment">// 定时任务函数</span>
    <span class="hljs-keyword">this</span>.delay = delay      <span class="hljs-comment">// 定时器的间隔时间（单位：毫秒）</span>
    <span class="hljs-keyword">this</span>.timer = <span class="hljs-literal">null</span>       <span class="hljs-comment">// 存储定时器的标识符</span>
    <span class="hljs-keyword">this</span>.running = <span class="hljs-literal">false</span>    <span class="hljs-comment">// 标记定时器是否正在运行</span>
  }

  start(){
    <span class="hljs-comment">// 如果定时器已经在运行，直接返回，不做重复启动</span>
    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">this</span>.running) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">this</span>.running = <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">const</span> tick = () =&gt; {
      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.running) <span class="hljs-keyword">return</span> <span class="hljs-comment">// 如果定时器已暂停，则不再继续执行</span>
      <span class="hljs-keyword">this</span>.fn(); <span class="hljs-comment">// 执行定时任务</span>
      <span class="hljs-keyword">this</span>.timer = setTimeout(tick, <span class="hljs-keyword">this</span>.delay) <span class="hljs-comment">// 使用 setTimeout 模拟 setInterval</span>
    }

    tick();
  }

  pause() {
    clearTimeout(<span class="hljs-keyword">this</span>.timer);
    <span class="hljs-keyword">this</span>.running = <span class="hljs-literal">false</span>;
  }

  resume(){
    <span class="hljs-keyword">this</span>.start()
  }
}
</code></pre>
<p>2.  模拟请求</p>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">printMessage</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Task is running..."</span>);
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> pausableInterval = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PausableInterval</span>(printMessage, <span class="hljs-number">1000</span>);
</code></pre>
<p>3.  调用</p>

<pre><code class="hljs language-scss" lang="scss">  function <span class="hljs-built_in">handleStartInterval</span>() {
    pausableInterval<span class="hljs-selector-class">.start</span>();

    <span class="hljs-comment">// 停止定时器</span>
    <span class="hljs-built_in">setTimeout</span>(() =&gt; {
      console<span class="hljs-selector-class">.log</span>("Pausing the task...");
      pausableInterval<span class="hljs-selector-class">.pause</span>();
    }, <span class="hljs-number">3000</span>); <span class="hljs-comment">// 3秒后暂停</span>

    <span class="hljs-comment">// 恢复定时器</span>
    <span class="hljs-built_in">setTimeout</span>(() =&gt; {
      console<span class="hljs-selector-class">.log</span>("Resuming the task...");
      pausableInterval<span class="hljs-selector-class">.resume</span>();
    }, <span class="hljs-number">5000</span>); <span class="hljs-comment">// 5秒后恢复</span>
  }
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83277d0956db476894307ed2f449d697~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqM5LqM5Zub5LiA:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765098087&amp;x-signature=KrmmiEK6UKvDhtUqfYUZfa7Zduo%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-6">07. 带最大等待 maxWait 的防抖（搜索框的神）</h2>
<blockquote>
<p>用于优化那些频繁触发的事件，特别是在搜索框、输入框或滚动等高频率操作中，常常用来减少不必要的计算或请求</p>
</blockquote>
<p>💡 场景：搜索请求太多？一招治愈</p>
<hr/>
<ol>
<li>自定义方法</li>
</ol>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">debounce</span>(<span class="hljs-params">fn, delay, { maxWait = <span class="hljs-number">0</span> } = {}</span>) {
  <span class="hljs-keyword">let</span> timer = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 存放定时器</span>
  <span class="hljs-keyword">let</span> start = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 第一次调用时间</span>

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">const</span> now = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>();  <span class="hljs-comment">// 获取当前时间戳</span>
    <span class="hljs-keyword">if</span> (!start) start = now; <span class="hljs-comment">// 记录第一次调用的时间</span>

    <span class="hljs-built_in">clearTimeout</span>(timer);  <span class="hljs-comment">// 清除之前的定时器，避免多次触发</span>

    <span class="hljs-keyword">const</span> <span class="hljs-title function_">run</span> = (<span class="hljs-params"/>) =&gt; { 
      start = <span class="hljs-literal">null</span>;  <span class="hljs-comment">// 重置 `start`，表示已经执行过操作</span>
      fn.<span class="hljs-title function_">apply</span>(<span class="hljs-variable language_">this</span>, args);  <span class="hljs-comment">// 执行函数，并传入当前的 `this` 和参数</span>
    };

    <span class="hljs-comment">// 如果到达 `maxWait` 时间，强制执行 `fn`；否则继续延迟执行</span>
    <span class="hljs-keyword">if</span> (maxWait &amp;&amp; now - start &gt;= maxWait) <span class="hljs-title function_">run</span>(); 
    <span class="hljs-keyword">else</span> timer = <span class="hljs-built_in">setTimeout</span>(run, delay);  <span class="hljs-comment">// 在 `delay` 时间后执行</span>
  };
}
</code></pre>
<p>2.  模拟短期内多次触发</p>
<pre><code class="hljs language-scss" lang="scss">function <span class="hljs-built_in">searchQuery</span>(query) {
  console<span class="hljs-selector-class">.log</span>("Searching for:", query);
}

const debouncedSearch = <span class="hljs-built_in">debounce</span>(searchQuery, <span class="hljs-number">500</span>, { maxWait: <span class="hljs-number">2000</span> });

<span class="hljs-comment">// 模拟用户输入</span>
<span class="hljs-built_in">debouncedSearch</span>("apple");
<span class="hljs-built_in">debouncedSearch</span>("app");
<span class="hljs-built_in">debouncedSearch</span>("appl");
<span class="hljs-built_in">debouncedSearch</span>("apple pie");

</code></pre>
<h2 data-id="heading-7">08. 可取消的异步任务（不要让旧任务留着捣乱）</h2>
<p>场景：页面切换后取消 pending 的 loading。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">cancellable</span>(<span class="hljs-params">fn, delay</span>) {
  <span class="hljs-keyword">let</span> timer
  <span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
    timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-title function_">fn</span>()), delay)
  })
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">promise</span>: p, <span class="hljs-attr">cancel</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearTimeout</span>(timer) }
}
</code></pre>
<h2 data-id="heading-8">9. 时间窗口限流（搜索框请求合并）</h2>
<p>🌈 场景：500ms 内所有输入合并一次请求，节省带宽又快。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createWindowRequester</span>(<span class="hljs-params">fn, ms</span>) {
  <span class="hljs-keyword">let</span> timer = <span class="hljs-literal">null</span>
  <span class="hljs-keyword">let</span> queue = []

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> (<span class="hljs-params">...args</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> {
      queue.<span class="hljs-title function_">push</span>({ args, resolve })

      <span class="hljs-keyword">if</span> (!timer) {
        timer = <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">async</span> () =&gt; {
          <span class="hljs-keyword">const</span> batch = [...queue]
          queue = []
          timer = <span class="hljs-literal">null</span>

          <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fn</span>(batch.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> i.<span class="hljs-property">args</span>))
          batch.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, i</span>) =&gt;</span> item.<span class="hljs-title function_">resolve</span>(res[i]))
        }, ms)
      }
    })
  }
}
</code></pre>
<h2 data-id="heading-9">10. 带优先级任务调度（Mini Scheduler）</h2>
<p>场景：动画、后台任务、预加载策略。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Scheduler</span> {
  <span class="hljs-keyword">constructor</span>() {
    <span class="hljs-keyword">this</span>.queue = []
    <span class="hljs-keyword">this</span>.running = <span class="hljs-literal">false</span>
  }
  add(fn, priority = <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">this</span>.queue.push({ fn, priority })
    <span class="hljs-keyword">this</span>.queue.sort((a, b) =&gt; b.priority - a.priority)
    <span class="hljs-keyword">this</span>.run()
  }
  async run() {
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.running) <span class="hljs-keyword">return</span>
    <span class="hljs-keyword">this</span>.running = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">while</span> (<span class="hljs-keyword">this</span>.queue.length) {
      <span class="hljs-keyword">const</span> job = <span class="hljs-keyword">this</span>.queue.shift()
      await job.fn()
    }
    <span class="hljs-keyword">this</span>.running = <span class="hljs-literal">false</span>
  }
}
</code></pre>
<h2 data-id="heading-10">12. 并行预加载 + 串行渲染（列表加载体验优化）</h2>
<p>🎨 场景：图片墙“先加载、再有序渲染”。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">preloadAndRender</span>(<span class="hljs-params">urls, render</span>) {
  <span class="hljs-keyword">const</span> preloads = urls.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">url</span> =&gt;</span> <span class="hljs-title function_">fetch</span>(url).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">r</span> =&gt;</span> r.<span class="hljs-title function_">blob</span>()))
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = <span class="hljs-number">0</span>; i &lt; preloads.<span class="hljs-property">length</span>; i++) {
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> preloads[i]
    <span class="hljs-title function_">render</span>(data, i)
  }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[iOS 实现微信读书的仿真翻页]]></title>    <link>https://juejin.cn/post/7577705544875737126</link>    <guid>https://juejin.cn/post/7577705544875737126</guid>    <pubDate>2025-11-30T07:35:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577705544875737126" data-draft-id="7577705544875720742" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="iOS 实现微信读书的仿真翻页"/> <meta itemprop="keywords" content="Swift,SwiftUI,iOS"/> <meta itemprop="datePublished" content="2025-11-30T07:35:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="非专业程序员"/> <meta itemprop="url" content="https://juejin.cn/user/1968539883540688"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            iOS 实现微信读书的仿真翻页
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1968539883540688/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    非专业程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T07:35:28.000Z" title="Sun Nov 30 2025 07:35:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">先看效果</h2>
<p>仿真翻页效果：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8311c30834214fc3b6c2ec2da052571f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2e5LiT5Lia56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092928&amp;x-signature=qh7CDoBP93l1Tb3%2FnlJluYJIvgE%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>普通翻页效果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4de85ec3e00e4fccb327e7464964d255~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Z2e5LiT5Lia56iL5bqP5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092928&amp;x-signature=RrivirgEXFpJJRoYQojgHjuk%2BT8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h2 data-id="heading-1">实现方案</h2>
<p>iOS 中实现翻页效果比较简单，直接使用系统提供的 UIPageViewController 即可做到。</p>
<p>UIPageViewController 是 UIKit 中的分页控制器，它允许用户通过横向或纵向滑动手势在多个页面（ViewController）之间切换，主要配置的两个属性如下：</p>
<p>1）<code>UIPageViewControllerTransitionStyle</code></p>
<ul>
<li><code>.pageCurl</code>：仿真翻页</li>
<li><code>.scroll</code>：类似 UIScrollView 自然滑动</li>
</ul>
<p>2）<code>UIPageViewControllerNavigationOrientation</code></p>
<ul>
<li><code>.horizontal</code>：左右翻页</li>
<li><code>.vertical</code>：上下翻页</li>
</ul>
<p>以仿真翻页配置为例子：</p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">BookReaderViewController</span>: <span class="hljs-title class_">UIViewController</span> {

    <span class="hljs-comment">// 模拟书籍数据</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">let</span> bookPages <span class="hljs-operator">=</span> [
        <span class="hljs-string">"第一章：Swift 的起源<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>Swift 是一种由 Apple 开发的强大且直观的编程语言..."</span>,
        <span class="hljs-string">"第二章：UIKit 基础<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>UIKit 提供了构建 iOS 应用程序所需的关键对象..."</span>,
        <span class="hljs-string">"第三章：动画艺术<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>核心动画 (Core Animation) 是 iOS 界面流畅的关键..."</span>,
        <span class="hljs-string">"第四章：高级翻页<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>UIPageViewController 是实现仿真翻页的神器..."</span>,
        <span class="hljs-string">"终章：未来展望<span class="hljs-subst">\n</span><span class="hljs-subst">\n</span>随着 SwiftUI 的普及，声明式 UI 正在改变世界..."</span>
    ]

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> pageViewController: <span class="hljs-type">UIPageViewController</span>!

    <span class="hljs-keyword">override</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">viewDidLoad</span>() {
        <span class="hljs-keyword">super</span>.viewDidLoad()
        setupPageViewController()
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">setupPageViewController</span>() {
        <span class="hljs-comment">// 关键设置：transitionStyle = .pageCurl (仿真翻页效果)</span>
        <span class="hljs-comment">// navigationOrientation = .horizontal (水平翻页)</span>
        pageViewController <span class="hljs-operator">=</span> <span class="hljs-type">UIPageViewController</span>(transitionStyle: .pageCurl,
                                                  navigationOrientation: .horizontal,
                                                  options: <span class="hljs-literal">nil</span>)

        pageViewController.dataSource <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>
        pageViewController.delegate <span class="hljs-operator">=</span> <span class="hljs-keyword">self</span>

        <span class="hljs-comment">// 设置初始页面</span>
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">let</span> firstPage <span class="hljs-operator">=</span> getViewController(at: <span class="hljs-number">0</span>) {
            pageViewController.setViewControllers([firstPage], direction: .forward, animated: <span class="hljs-literal">false</span>, completion: <span class="hljs-literal">nil</span>)
        }

        <span class="hljs-comment">// 将 PageVC 添加到当前 VC</span>
        addChild(pageViewController)
        view.addSubview(pageViewController.view)
        pageViewController.view.frame <span class="hljs-operator">=</span> view.bounds
        pageViewController.didMove(toParent: <span class="hljs-keyword">self</span>)

        <span class="hljs-comment">// 解决仿真翻页背面颜色问题 (让背面也是纸张色，而不是默认的半透明或白色)</span>
        <span class="hljs-comment">// 注意：这是一个比较 Hack 的方法，更完美的做法是自定义背面的 Layer</span>
        pageViewController.view.backgroundColor <span class="hljs-operator">=</span> <span class="hljs-type">UIColor</span>(red: <span class="hljs-number">248</span><span class="hljs-operator">/</span><span class="hljs-number">255</span>, green: <span class="hljs-number">241</span><span class="hljs-operator">/</span><span class="hljs-number">255</span>, blue: <span class="hljs-number">227</span><span class="hljs-operator">/</span><span class="hljs-number">255</span>, alpha: <span class="hljs-number">1.0</span>)
    }

    <span class="hljs-comment">// 辅助方法：根据索引获取 VC</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">func</span> <span class="hljs-title function_">getViewController</span>(<span class="hljs-params">at</span> <span class="hljs-params">index</span>: <span class="hljs-type">Int</span>) -&gt; <span class="hljs-type">BookPageViewController</span>? {
        <span class="hljs-keyword">guard</span> index <span class="hljs-operator">&gt;=</span> <span class="hljs-number">0</span> <span class="hljs-operator">&amp;&amp;</span> index <span class="hljs-operator">&lt;</span> bookPages.count <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span> }
        <span class="hljs-keyword">return</span> <span class="hljs-type">BookPageViewController</span>(index: index, totalPage: bookPages.count, content: bookPages[index])
    }
}

<span class="hljs-comment">// MARK: - 3. DataSource 实现 (核心逻辑)</span>
<span class="hljs-keyword">extension</span> <span class="hljs-title class_">BookReaderViewController</span>: <span class="hljs-title class_">UIPageViewControllerDataSource</span> {

    <span class="hljs-comment">// 获取"上一页"</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">pageViewController</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">pageViewController</span>: <span class="hljs-type">UIPageViewController</span>, <span class="hljs-params">viewControllerBefore</span> <span class="hljs-params">viewController</span>: <span class="hljs-type">UIViewController</span>) -&gt; <span class="hljs-type">UIViewController</span>? {
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> currentVC <span class="hljs-operator">=</span> viewController <span class="hljs-keyword">as?</span> <span class="hljs-type">BookPageViewController</span> <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span> }
        <span class="hljs-keyword">let</span> previousIndex <span class="hljs-operator">=</span> currentVC.pageIndex <span class="hljs-operator">-</span> <span class="hljs-number">1</span>
        <span class="hljs-keyword">return</span> getViewController(at: previousIndex)
    }

    <span class="hljs-comment">// 获取"下一页"</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">pageViewController</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">pageViewController</span>: <span class="hljs-type">UIPageViewController</span>, <span class="hljs-params">viewControllerAfter</span> <span class="hljs-params">viewController</span>: <span class="hljs-type">UIViewController</span>) -&gt; <span class="hljs-type">UIViewController</span>? {
        <span class="hljs-keyword">guard</span> <span class="hljs-keyword">let</span> currentVC <span class="hljs-operator">=</span> viewController <span class="hljs-keyword">as?</span> <span class="hljs-type">BookPageViewController</span> <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> <span class="hljs-literal">nil</span> }
        <span class="hljs-keyword">let</span> nextIndex <span class="hljs-operator">=</span> currentVC.pageIndex <span class="hljs-operator">+</span> <span class="hljs-number">1</span>
        <span class="hljs-keyword">return</span> getViewController(at: nextIndex)
    }
}

<span class="hljs-comment">// MARK: - 4. Delegate (可选，用于处理翻页后的状态)</span>
<span class="hljs-keyword">extension</span> <span class="hljs-title class_">BookReaderViewController</span>: <span class="hljs-title class_">UIPageViewControllerDelegate</span> {
    <span class="hljs-comment">// 这里可以处理 spineLocation，例如横屏时显示双页</span>
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">pageViewController</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">pageViewController</span>: <span class="hljs-type">UIPageViewController</span>, <span class="hljs-params">spineLocationFor</span> <span class="hljs-params">orientation</span>: <span class="hljs-type">UIInterfaceOrientation</span>) -&gt; <span class="hljs-type">UIPageViewController</span>.<span class="hljs-type">SpineLocation</span> {
        <span class="hljs-comment">// 手机竖屏通常是单页 (.min)</span>
        <span class="hljs-keyword">return</span> .min
    }
}
</code></pre>
<p>如上不到百行的代码即可实现仿真翻页效果，手势在 UIPageViewController 中会自动处理，外部不用感知。</p>
<p>和 UITableView 使用类似，需要通过 UIPageViewControllerDataSource 来提供上一页和下一页的数据源，通过 UIPageViewControllerDelegate 来感知翻页时机。</p>
<p>UIPageViewControllerDelegate 主要提供三个时机：</p>
<p>1）<code>willTransitionTo</code>：当用户开始滑动翻页的时候触发，系统已经准备好目标页，通过该回调来告诉你将要显示哪个页面（pendingViewControllers）</p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-comment">/// pendingViewControllers: 将要显示的页面</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">pageViewController</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">pageViewController</span>: <span class="hljs-type">UIPageViewController</span>,
                        <span class="hljs-params">willTransitionTo</span> <span class="hljs-params">pendingViewControllers</span>: [<span class="hljs-type">UIViewController</span>])
</code></pre>
<p>2）<code>didFinishAnimating</code>：当用户的翻页动画结束时回调</p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-comment">/// finished: 动画是否完成</span>
<span class="hljs-comment">/// previousViewControllers: 原来显示的ViewController</span>
<span class="hljs-comment">/// completed: 最终是否翻页成功；比如滑一半又拖回去，不会真正翻页</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">pageViewController</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">pageViewController</span>: <span class="hljs-type">UIPageViewController</span>,
                        <span class="hljs-params">didFinishAnimating</span> <span class="hljs-params">finished</span>: <span class="hljs-type">Bool</span>,
                        <span class="hljs-params">previousViewControllers</span>: [<span class="hljs-type">UIViewController</span>],
                        <span class="hljs-params">transitionCompleted</span> <span class="hljs-params">completed</span>: <span class="hljs-type">Bool</span>)
</code></pre>
<p>3）<code>spineLocationFor</code>：控制仿真书本翻页时 “书脊” 的位置，只在 UIPageViewControllerTransitionStyle 为 pageCurl 时有效</p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-comment">/// SpineLocation:</span>
<span class="hljs-comment">/// - none: 没书脊</span>
<span class="hljs-comment">/// - min: 书脊在左边（单页模式）</span>
<span class="hljs-comment">/// - mid: 书脊在中间（双页模式）</span>
<span class="hljs-comment">/// - max: 书脊在右边（单页模式）</span>
<span class="hljs-keyword">func</span> <span class="hljs-title function_">pageViewController</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">pageViewController</span>: <span class="hljs-type">UIPageViewController</span>,
                        <span class="hljs-params">spineLocationFor</span> <span class="hljs-params">orientation</span>: <span class="hljs-type">UIInterfaceOrientation</span>)
-&gt; <span class="hljs-type">UIPageViewController</span>.<span class="hljs-type">SpineLocation</span>
</code></pre>
<p>如果要配置普通翻页效果，只需要修改 UIPageViewController 的配置即可：</p>
<pre><code class="hljs language-Swift" lang="Swift"><span class="hljs-comment">// Options: 设置页面之间的间距 (微信读书一般有 10-20pt 的间距)</span>
<span class="hljs-keyword">let</span> options: [<span class="hljs-type">UIPageViewController</span>.<span class="hljs-type">OptionsKey</span>: <span class="hljs-keyword">Any</span>] <span class="hljs-operator">=</span> [
    .interPageSpacing: <span class="hljs-number">20</span>
]

<span class="hljs-comment">// 核心修改 1: transitionStyle 改为 .scroll</span>
pageViewController <span class="hljs-operator">=</span> <span class="hljs-type">UIPageViewController</span>(transitionStyle: .scroll,
                                          navigationOrientation: .horizontal,
                                          options: options)
</code></pre>
<p>另外翻页手势通常和系统的侧滑返回手势有冲突，可以手动禁用手势来解决；类似微信读书一样，在导航栏出现时才开启侧滑返回手势，否则禁用侧滑返回：</p>
<pre><code class="hljs language-TypeScript" lang="TypeScript"><span class="hljs-keyword">private</span> func <span class="hljs-title function_">updateGesture</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">if</span> isNaviBarHidden { <span class="hljs-comment">// 导航栏隐藏：禁用侧滑，开启翻页手势</span>
        navigationController?.<span class="hljs-property">interactivePopGestureRecognizer</span>?.<span class="hljs-property">isEnabled</span> = <span class="hljs-literal">false</span>
        <span class="hljs-keyword">for</span> gesture <span class="hljs-keyword">in</span> pageViewController.<span class="hljs-property">gestureRecognizers</span> {
            gesture.<span class="hljs-property">isEnabled</span> = <span class="hljs-literal">true</span>
        }
    } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// 导航栏显示：开启侧滑，禁用翻页手势</span>
        navigationController?.<span class="hljs-property">interactivePopGestureRecognizer</span>?.<span class="hljs-property">isEnabled</span> = <span class="hljs-literal">true</span>
        <span class="hljs-keyword">for</span> gesture <span class="hljs-keyword">in</span> pageViewController.<span class="hljs-property">gestureRecognizers</span> {
            gesture.<span class="hljs-property">isEnabled</span> = <span class="hljs-literal">false</span>
        }
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[优化App启动时间？startup-coroutine是什么？]]></title>    <link>https://juejin.cn/post/7577702891273994275</link>    <guid>https://juejin.cn/post/7577702891273994275</guid>    <pubDate>2025-11-30T07:13:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577702891273994275" data-draft-id="7577713754563428404" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="优化App启动时间？startup-coroutine是什么？"/> <meta itemprop="keywords" content="Kotlin,架构,性能优化"/> <meta itemprop="datePublished" content="2025-11-30T07:13:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="年小个大"/> <meta itemprop="url" content="https://juejin.cn/user/1855631359213688"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            优化App启动时间？startup-coroutine是什么？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1855631359213688/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    年小个大
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T07:13:35.000Z" title="Sun Nov 30 2025 07:13:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">那个让我头疼的启动问题</h2>
<p>事情要从我们公司的新项目说起。那时候我们的应用集成了好多第三方 SDK：推送、统计、地图、IM、广告...你懂的，现在的 App 不接十几个 SDK 都不好意思上线。</p>
<p>由于SDK初始化时间过长，导致Splash Activity首屏一直卡在白屏界面，还需要编写各种xml背景图进行填充，很是头疼。</p>
<p>最开始我的 Application 是这样的：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApp</span> : <span class="hljs-type">Application</span>() {
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onCreate()
        
        <span class="hljs-comment">// 一堆初始化代码</span>
        Push.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>)      <span class="hljs-comment">// 推送</span>
        Analytics.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>) <span class="hljs-comment">// 统计</span>
        Map.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>)       <span class="hljs-comment">// 地图</span>
        IM.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>)        <span class="hljs-comment">// 即时通讯</span>
        Ad.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>)        <span class="hljs-comment">// 广告</span>
        <span class="hljs-comment">// ... 还有更多</span>
        
        <span class="hljs-comment">// 自己的业务初始化</span>
        initDatabase()
        initConfig()
        initUser()
    }
}
</code></pre>
<p><strong>结果就是：</strong></p>
<ul>
<li>用户点开 App 要等 3-5 秒才能看到界面</li>
<li>所有初始化都在主线程排队执行，一个卡住后面全等着</li>
<li>代码越来越乱，新同事根本不敢动这块代码</li>
<li>测试经常报 ANR（应用无响应）</li>
</ul>
<h2 data-id="heading-1">寻找解决方案的折腾过程</h2>
<h3 data-id="heading-2">第一站：多线程方案</h3>
<p>我首先想到的是用多线程：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> thread1 = thread { Push.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>) } <span class="hljs-comment">//kotlin函数</span>
<span class="hljs-keyword">val</span> thread2 = thread { Analytics.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>) }
<span class="hljs-comment">// 启动所有线程...</span>
</code></pre>
<p><strong>结果发现问题更多：</strong></p>
<ul>
<li>线程创建开销大</li>
<li>依赖关系处理起来特别麻烦</li>
<li>异常处理很头疼</li>
<li>代码变得超级复杂</li>
</ul>
<h3 data-id="heading-3">第二站：Jetpack AppStartup</h3>
<p>然后我发现了 Google 的 AppStartup，心想官方出品应该很靠谱吧！</p>
<p>用了一段时间发现：</p>
<ul>
<li>它只是把初始化代码从 Application 移到了各个 Initializer 里</li>
<li><strong>关键问题：所有初始化还是在主线程执行的！</strong></li>
<li>启动时间根本没减少，只是代码看起来整齐了点</li>
<li>复杂的依赖关系写起来还是很麻烦</li>
</ul>
<p>AppStartup 更像是一个代码组织工具，而不是性能优化工具。</p>
<h3 data-id="heading-4">灵光一现：为什么不用协程？</h3>
<p>就在我快要放弃的时候，突然想到：我们项目已经在用 Kotlin 协程了，为什么不用协程来解决这个问题呢？</p>
<p>协程的轻量级、灵活的线程调度、简洁的异步表达，不正是我们需要的吗？</p>
<p>于是，我开始动手写 <code>startup-coroutine</code>。</p>
<h2 data-id="heading-5">框架设计</h2>
<h3 data-id="heading-6">核心想法：把初始化当成有依赖关系的任务</h3>
<p>借鉴App Startup,但是它是串行初始化,我呢允许并行初始化。</p>
<p>我想象中的理想状态是：</p>
<ul>
<li>每个初始化任务都是独立的</li>
<li>可以声明它依赖哪些其他任务</li>
<li>没有依赖关系的任务可以并行执行</li>
<li>使用拓扑排序自动处理依赖关系，按正确顺序执行</li>
</ul>
<p>于是就有了 <code>Initializer</code> 接口：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">Initializer</span>&lt;<span class="hljs-type">T</span>&gt; {
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">init</span><span class="hljs-params">(app: <span class="hljs-type">Application</span>, provider: <span class="hljs-type">DependenciesProvider</span>)</span></span>: T
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dependencies</span><span class="hljs-params">()</span></span>: List&lt;KClass&lt;<span class="hljs-keyword">out</span> Initializer&lt;*&gt;&gt;&gt; = emptyList()
}
</code></pre>
<h3 data-id="heading-7">线程调度的灵活控制</h3>
<p>我提供了几种预设的线程策略：</p>
<ul>
<li><code>AllIO</code>：全在 IO 线程，适合耗时任务</li>
<li><code>ExecuteOnIO</code>：IO 线程执行，主线程创建框架</li>
<li><code>AllMain</code>：全在主线程，只适合轻量任务</li>
<li><code>Default</code>：默认推荐，框架在 IO 线程，任务在主线程</li>
</ul>
<p>这样大家可以根据自己项目的实际情况选择。</p>
<p>由于协程的<code>suspend</code>函数可以灵活的切换调度线程,所以可以全部在Main线程执行,然后具体的处理业务自由使用<code>withContext(Dispatchers.IO){...}</code>来切换.</p>
<h2 data-id="heading-8">BaseActivity 的封装</h2>
<p>这个设计源于我们遇到的一个真实问题：</p>
<p><strong>问题场景：</strong> 用户正在使用 App，突然来了个电话或者切换到其他应用，这时候系统可能因为内存不足把我们的应用进程给杀掉了。当用户再切回来时，系统会重新创建 Application 和用户最后看到的 Activity。</p>
<p><strong>这时候就出问题了：</strong> Application构建完成后,执行Startup的初始化,由于Startup是协程框架,它不阻塞UI,于是还没有等待Startup初始化结束Activity就开始创建了,此时Activity 在 onCreate 时可能会使用那些还没重新初始化的 SDK，结果就是各种空指针异常和崩溃。</p>
<p><strong>我的解决方案：</strong> 在 BaseActivity 里统一监听初始化状态。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">abstract</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BaseActivity</span> : <span class="hljs-type">AppCompatActivity</span>() {
    
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">(savedInstanceState: <span class="hljs-type">Bundle</span>?)</span></span> {
        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState)
        observeStartup() <span class="hljs-comment">// 关键的一行！</span>
    }
    
    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">open</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">observeStartup</span><span class="hljs-params">()</span></span> {
        Startup.observe(<span class="hljs-keyword">this</span>) { result -&gt;
            <span class="hljs-keyword">when</span> (result) {
                StartupResult.Idle -&gt; showLoading() <span class="hljs-comment">// 还没初始化，显示加载</span>
                StartupResult.Success -&gt; {
                    hideLoading()
                    onInitFinished() <span class="hljs-comment">// 初始化完成，继续正常流程</span>
                }
                <span class="hljs-keyword">is</span> StartupResult.Failure -&gt; {
                    hideLoading()
                    <span class="hljs-comment">// 处理初始化失败</span>
                }
            }
        }
    }
}
</code></pre>
<p><strong>这样设计的好处：</strong></p>
<ol>
<li><strong>进程重启无忧</strong>：即使进程被杀死重建，也能保证 SDK 先初始化再使用</li>
<li><strong>统一加载状态</strong>：所有页面都有统一的加载体验</li>
<li><strong>错误统一处理</strong>：初始化失败时有统一的错误处理机制</li>
<li><strong>代码复用</strong>：每个 Activity 都不用自己写初始化监听逻辑</li>
</ol>
<p><code>Startup.observe</code>内部是使用LiveData实现的.目的是为了每个页面监听的时候都可以拿到初始化数据信息.</p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">open</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Startup</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">constructor</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> implementation: IStartup
) : IStartup {
    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {

        <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _isInitialized = MutableLiveData&lt;StartupResult&gt;(StartupResult.Idle)

        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">observe</span><span class="hljs-params">(owner: <span class="hljs-type">LifecycleOwner</span>, observer: <span class="hljs-type">Observer</span>&lt;<span class="hljs-type">StartupResult</span>&gt;)</span></span> {
            _isInitialized.observe(owner, observer)
        }

        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isInitialized</span><span class="hljs-params">()</span></span> = _isInitialized.value != StartupResult.Idle

        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">initializedResult</span><span class="hljs-params">()</span></span> = _isInitialized.value

        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">reset</span><span class="hljs-params">()</span></span> {
            _isInitialized.postValue(StartupResult.Idle)
        }
        <span class="hljs-keyword">internal</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">markInitializedResult</span><span class="hljs-params">(result: <span class="hljs-type">StartupResult</span>)</span></span> {
            _isInitialized.postValue(result)
        }
    }

</code></pre>
<h2 data-id="heading-9">隐私协议处理的巧妙设计</h2>
<p>现在隐私合规要求很严格，很多 SDK 必须在用户同意隐私协议后才能初始化。我的框架也很好的解决了这个问题：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyApp</span> : <span class="hljs-type">Application</span>() {

    <span class="hljs-keyword">companion</span> <span class="hljs-keyword">object</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> startup: Startup

        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">startInit</span><span class="hljs-params">()</span></span> {
            startup.start()
        }
    }

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onCreate</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">super</span>.onCreate()
        <span class="hljs-comment">//轻量级数据存储推荐直接初始化,用于进行判断逻辑.</span>
        SpUtils.<span class="hljs-keyword">init</span>(<span class="hljs-keyword">this</span>)

        <span class="hljs-comment">//构建初始化任务列表.</span>
        <span class="hljs-keyword">val</span> initializer = listOf(
            AdMobInit(),
            AppConfigInit(),
            FlutterEngineInit(),
            FistInitializer(),
            IMInit(),
            MapSdkInit(),
            ExceptionInit()
        )
        <span class="hljs-comment">//构建startup</span>
        startup = Startup.Builder(<span class="hljs-keyword">this</span>)
            .setDispatchers(StartupDispatchers.AllIO)
            .setDebug(<span class="hljs-literal">true</span>)
            .add(initializer)
            .build()

        <span class="hljs-comment">//推荐!!!</span>
        <span class="hljs-comment">//如果App跳过了手动初始化,就必须做判断,只要条件允许第二次初始化的时候</span>
        <span class="hljs-comment">//一定在Application中直接执行.</span>
        <span class="hljs-comment">//这里涉及到了一些进程重启逻辑.</span>
        <span class="hljs-keyword">if</span> (SpUtils.getBoolean(<span class="hljs-string">"isAgreePrivacy"</span>,<span class="hljs-literal">false</span>)) {
            startInit()
        }
    }

}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">SplashActivity</span> : <span class="hljs-type">BaseActivity</span>() {
    
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">checkPrivacy</span><span class="hljs-params">()</span></span> {
        <span class="hljs-keyword">if</span> (用户已同意隐私协议) {
            <span class="hljs-comment">// 开始初始化</span>
            MyApp.startInit()
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 显示隐私协议弹窗</span>
            showPrivacyDialog {
                <span class="hljs-comment">// 用户同意后开始初始化</span>
                MyApp.startInit()
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-10">实际效果怎么样？</h2>
<p>用了 <code>startup-coroutine</code> 之后：</p>
<ul>
<li><strong>启动时间</strong>：从 3-5 秒优化到 1-2 秒</li>
<li><strong>代码可维护性</strong>：新同事也能轻松添加新的初始化任务</li>
<li><strong>稳定性</strong>：再也没有因为进程重启导致的崩溃</li>
<li><strong>开发体验</strong>：调试时可以清楚看到每个任务的执行时间和依赖关系</li>
</ul>
<h2 data-id="heading-11">怎么集成使用？</h2>
<p>集成超级简单：</p>
<ol>
<li><strong>添加依赖：</strong></li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin">implementation(<span class="hljs-string">"com.github.Dboy233:startup-coroutine:最新版本"</span>)
</code></pre>
<ol start="2">
<li><strong>定义初始化任务：</strong></li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MyInitializer</span> : <span class="hljs-type">Initializer</span>&lt;<span class="hljs-type">Unit</span>&gt; {
    <span class="hljs-comment">//如果没有依赖可不重写此方法</span>
    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">dependencies</span><span class="hljs-params">()</span></span> = listOf(OtherInitializer::<span class="hljs-keyword">class</span>)
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">init</span><span class="hljs-params">(app: <span class="hljs-type">Application</span>, provider: <span class="hljs-type">DependenciesProvider</span>)</span></span> {
        <span class="hljs-comment">// 你的初始化代码</span>
    }
}
</code></pre>
<ol start="3">
<li><strong>在 Application 中配置：</strong></li>
</ol>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">val</span> startup = Startup.Builder(<span class="hljs-keyword">this</span>)
    .add(MyInitializer())
    .setDispatchers(StartupDispatchers.ExecuteOnIO)
    .build()
</code></pre>
<ol start="4">
<li><strong>让 Activity 继承 BaseActivity</strong>（或者自己实现初始化监听）</li>
</ol>
<h2 data-id="heading-12">实际应用日志</h2>
<pre><code class="hljs language-text" lang="text">
--- Startup Coroutine Dependency Graph ---
    
    FlutterEngineInit
    FistInitializer
    ExceptionInit
    AppConfigInit
      └─ FistInitializer
    AdMobInit
      └─ AppConfigInit
    IMInit
      └─ AppConfigInit
    MapSdkInit
      └─ AppConfigInit
    
----------------------------------------


--- Startup Coroutine Performance Summary ---

&gt;&gt; Total Time: 2538ms  |  Status: FAILED
&gt;&gt; Dispatchers Mode: All-IO

&gt;&gt; Individual Task Durations:
   - FlutterEngineInit  |  2503ms  |  Thread: DefaultDispatcher-worker-5
   - IMInit             |  2000ms  |  Thread: DefaultDispatcher-worker-5
   - AdMobInit          |  1832ms  |  Thread: DefaultDispatcher-worker-4
   - MapSdkInit         |  601ms   |  Thread: DefaultDispatcher-worker-4
   - AppConfigInit      |  102ms   |  Thread: DefaultDispatcher-worker-5
   - FistInitializer    |  0ms     |  Thread: DefaultDispatcher-worker-4
   - ExceptionInit      |  -1ms    |  Thread: Error
&gt;&gt; Task time is sum  : 7037 ms
</code></pre>
<p>打印初始化结果，可以看到使用协程框架后整体初始化从7秒优化到了1坤秒(2.5秒)。</p>
<p>效果还是立竿见影的，关键是它的初始化不占用UI渲染时间，让UI过度不出现卡顿白屏。</p>
<p>如果你在Log中看到了两次日志输出，不要紧张,它不是执行了两次,而仅仅只是打印两次。</p>
<pre><code class="hljs language-vbscript" lang="vbscript">Log.i(<span class="hljs-string">"StartupCoroutine"</span>, logContent.<span class="hljs-keyword">to</span><span class="hljs-built_in">String</span>())
println(logContent.<span class="hljs-keyword">to</span><span class="hljs-built_in">String</span>())
</code></pre>
<p>因为Test阶段的时候Log是不输出内容的，所以使用println再打印了一遍.你只需要过滤<code>StartupCoroutine</code>日志即可。</p>
<h2 data-id="heading-13">写在最后</h2>
<p>开发 <code>startup-coroutine</code> 的过程让我深刻体会到：好的框架不是凭空想象出来的，而是从真实的业务痛点中生长出来的。</p>
<p>我现在把这个框架开源出来，一方面是希望帮助到有同样问题的开发者，另一方面也是想听听大家的想法，看看能不能一起把它做得更好。</p>
<p>如果你也在为应用启动优化而烦恼，不妨试试 <code>startup-coroutine</code>。如果你有任何建议或者发现了什么问题，欢迎来 GitHub 给我提 Issue 或者 PR。</p>
<p><strong>项目地址：</strong> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FDboy233%2Fstartup-coroutine" target="_blank" title="https://github.com/Dboy233/startup-coroutine" ref="nofollow noopener noreferrer"><code>https://github.com/Dboy233/startup-coroutine</code></a></p>
<p>希望我的这个小工具能帮到你，也期待听到你的使用反馈！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[批量商品信息采集工具获取商品详情的完整方案]]></title>    <link>https://juejin.cn/post/7577690150093570088</link>    <guid>https://juejin.cn/post/7577690150093570088</guid>    <pubDate>2025-11-30T07:26:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577690150093570088" data-draft-id="7577683422878810146" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="批量商品信息采集工具获取商品详情的完整方案"/> <meta itemprop="keywords" content="数据分析,数据挖掘,爬虫"/> <meta itemprop="datePublished" content="2025-11-30T07:26:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户4142929607239"/> <meta itemprop="url" content="https://juejin.cn/user/2579871227198947"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            批量商品信息采集工具获取商品详情的完整方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2579871227198947/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户4142929607239
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T07:26:47.000Z" title="Sun Nov 30 2025 07:26:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99510bb6c4104ed794f17fd42f4a541f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg55So5oi3NDE0MjkyOTYwNzIzOQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092407&amp;x-signature=IQYIBZ%2BzFO3WsyMy8ug9R%2F%2BgmB0%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">一、获取前的准备：官方 API 接入流程</h2>
<h3 data-id="heading-1">1. 平台认证与权限申请</h3>
<ul>
<li>
<p><strong>注册淘宝开放平台账号</strong>：访问<a href="https://link.juejin.cn?target=https%3A%2F%2Fopen.taobao.com%2F" title="https://open.taobao.com/" target="_blank" ref="nofollow noopener noreferrer">open.taobao.com</a>，完成个人 / 企业认证（企业需营业执照）</p>
</li>
<li>
<p><strong>创建应用</strong>：控制台→应用管理→创建应用（选择 "网站应用" 或 "服务器应用"），获取<strong>App Key</strong>和<strong>App Secret</strong>（核心凭证）</p>
</li>
<li>
<p><strong>申请接口权限</strong>：</p>
<ul>
<li><strong>基础详情</strong>：<code>taobao.item.get</code>（单个商品详情）</li>
<li><strong>批量获取</strong>：<code>taobao.item_get_batch</code>（一次最多 50 个商品 ID，需单独申请）</li>
<li><strong>搜索获取 ID</strong>：<code>taobao.items.search</code>（按关键词 / 类目搜索商品）</li>
<li><strong>店铺商品</strong>：<code>taobao.items.onsale.get</code>（获取店铺在售商品列表）</li>
</ul>
</li>
</ul>
<h3 data-id="heading-2">2. 商品 ID 获取策略（批量采集前提）</h3>






























<table><thead><tr><th>获取方式</th><th>适用场景</th><th>实现方法</th></tr></thead><tbody><tr><td><strong>从已有列表获取</strong></td><td>已有商品链接 / ID</td><td>从 URL 提取末尾数字（如<code>https://item.taobao.com/item.htm?id=123456</code>中的<code>123456</code>）</td></tr><tr><td><strong>搜索获取</strong></td><td>按关键词 / 类目采集</td><td>调用<code>taobao.items.search</code>，指定关键词、页码，获取商品 ID 列表</td></tr><tr><td><strong>店铺全量采集</strong></td><td>监控竞品 / 自有店铺</td><td><code>taobao.items.onsale.get</code>获取店铺所有在售商品 ID</td></tr><tr><td><strong>从其他平台同步</strong></td><td>多平台运营商家</td><td>从京东 / 拼多多等平台商品链接提取 ID，再通过 API 获取淘宝详情</td></tr></tbody></table>
<h2 data-id="heading-3">二、核心实现：批量获取商品详情的技术方案</h2>
<h3 data-id="heading-4">1. 接口选择与调用方式</h3>
<p><strong>方案 A：循环调用单商品接口（简单易实现）</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 伪代码示例</span>
<span class="hljs-function">def <span class="hljs-title">batch_get_items</span>(<span class="hljs-params">app_key, app_secret, item_ids</span>):
    results</span> = []
    <span class="hljs-keyword">for</span> item_id <span class="hljs-keyword">in</span> item_ids:
        <span class="hljs-meta"># 构造请求参数</span>
        <span class="hljs-keyword">params</span> = {
            <span class="hljs-string">'method'</span>: <span class="hljs-string">'taobao.item.get'</span>,
            <span class="hljs-string">'app_key'</span>: app_key,
            <span class="hljs-string">'num_iid'</span>: item_id,
            <span class="hljs-string">'fields'</span>: <span class="hljs-string">'num_iid,title,price,pic_url,desc,sales'</span>  <span class="hljs-meta"># 指定返回字段</span>
        }
        <span class="hljs-meta"># 生成签名</span>
        <span class="hljs-keyword">params</span>[<span class="hljs-string">'sign'</span>] = generate_sign(<span class="hljs-keyword">params</span>, app_secret)
        <span class="hljs-meta"># 发送请求</span>
        response = requests.<span class="hljs-keyword">get</span>(<span class="hljs-string">'https://eco.taobao.com/router/rest'</span>, <span class="hljs-keyword">params</span>=<span class="hljs-keyword">params</span>)
        results.append(response.json())
        time.sleep(<span class="hljs-number">0.5</span>)  <span class="hljs-meta"># 控制频率，避免触发风控</span>
    <span class="hljs-keyword">return</span> results
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>方案 B：使用批量接口（效率更高）</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 伪代码示例：taobao.item_get_batch</span>
<span class="hljs-function">def <span class="hljs-title">batch_get_items</span>(<span class="hljs-params">app_key, app_secret, item_ids</span>):
    # 分批处理（每批最多50个）
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-title">range</span>(<span class="hljs-params"><span class="hljs-number">0</span>, len(item_ids</span>), 50):
        batch_ids</span> = item_ids[i:i+<span class="hljs-number">50</span>]
        <span class="hljs-keyword">params</span> = {
            <span class="hljs-string">'method'</span>: <span class="hljs-string">'taobao.item_get_batch'</span>,
            <span class="hljs-string">'app_key'</span>: app_key,
            <span class="hljs-string">'num_iids'</span>: <span class="hljs-string">','</span>.<span class="hljs-keyword">join</span>(batch_ids),  <span class="hljs-meta"># 商品ID用逗号分隔</span>
            <span class="hljs-string">'fields'</span>: <span class="hljs-string">'num_iid,title,price,pic_url,desc,sales'</span>
        }
        <span class="hljs-keyword">params</span>[<span class="hljs-string">'sign'</span>] = generate_sign(<span class="hljs-keyword">params</span>, app_secret)
        response = requests.<span class="hljs-keyword">get</span>(<span class="hljs-string">'https://eco.taobao.com/router/rest'</span>, <span class="hljs-keyword">params</span>=<span class="hljs-keyword">params</span>)
        <span class="hljs-keyword">yield</span> response.json()  <span class="hljs-meta"># 返回分批结果</span>
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-5">2. 性能优化关键技术</h3>
<p><strong>① 异步并发处理</strong>（适合大规模采集）</p>
<ul>
<li>使用<code>aiohttp</code>替代<code>requests</code>，配合<code>asyncio</code>实现异步并发</li>
<li>设置信号量控制并发数（建议 30-50，避免触发平台限流）</li>
<li>随机延迟（0.3-0.8 秒）避免被识别为爬虫</li>
</ul>
<p><strong>② 字段优化</strong></p>
<ul>
<li>只请求必要字段：<code>fields='num_iid,title,price,pic_url,skus'</code>，减少 65% 带宽消耗</li>
<li>排除不需要的字段（如评价详情、物流信息），提升响应速度</li>
</ul>
<p><strong>③ 缓存机制</strong></p>
<ul>
<li>对热门 / 高频访问商品使用 Redis 缓存（设置 1 小时过期），减少重复调用</li>
</ul>
<h2 data-id="heading-6">三、数据解析与结构化处理</h2>
<h3 data-id="heading-7">1. 响应数据解析流程</h3>
<p>plaintext</p>
<pre><code class="hljs language-javascript" lang="javascript">原始<span class="hljs-title class_">JSON</span> → 基础校验 → 字段提取 → 结构化存储
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<p><strong>核心字段提取示例：</strong></p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 从返回结果提取核心信息</span>
<span class="hljs-function">def <span class="hljs-title">parse_item_data</span>(<span class="hljs-params">raw_item</span>):
    <span class="hljs-keyword">return</span></span> {
        <span class="hljs-string">"商品ID"</span>: raw_item.<span class="hljs-keyword">get</span>(<span class="hljs-string">"num_iid"</span>, <span class="hljs-string">""</span>),
        <span class="hljs-string">"标题"</span>: raw_item.<span class="hljs-keyword">get</span>(<span class="hljs-string">"title"</span>, <span class="hljs-string">""</span>),
        <span class="hljs-string">"价格"</span>: raw_item.<span class="hljs-keyword">get</span>(<span class="hljs-string">"price"</span>, <span class="hljs-number">0</span>),
        <span class="hljs-string">"促销价"</span>: raw_item.<span class="hljs-keyword">get</span>(<span class="hljs-string">"promotion_price"</span>, <span class="hljs-number">0</span>),
        <span class="hljs-string">"主图"</span>: raw_item.<span class="hljs-keyword">get</span>(<span class="hljs-string">"pic_url"</span>, <span class="hljs-string">""</span>),
        <span class="hljs-string">"销量"</span>: raw_item.<span class="hljs-keyword">get</span>(<span class="hljs-string">"volume"</span>, <span class="hljs-number">0</span>),
        <span class="hljs-string">"SKU信息"</span>: [sku.<span class="hljs-keyword">get</span>(<span class="hljs-string">"price"</span>, <span class="hljs-number">0</span>) <span class="hljs-keyword">for</span> sku <span class="hljs-keyword">in</span> raw_item.<span class="hljs-keyword">get</span>(<span class="hljs-string">"sku"</span>, {}).<span class="hljs-keyword">get</span>(<span class="hljs-string">"sku_list"</span>, [])]
    }
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-8">2. 特殊情况处理</h3>
<ul>
<li>
<p><strong>HTML 描述处理</strong>：商品描述（desc 字段）含 HTML 标签，需用<code>BeautifulSoup</code>解析提取纯文本或图片 URL</p>
</li>
<li>
<p><strong>嵌套数据处理</strong>：</p>
<p>plaintext</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 解析多级嵌套的卖家信息</span>
seller_info = raw_item.<span class="hljs-keyword">get</span>(<span class="hljs-string">"seller"</span>, {})
<span class="hljs-keyword">return</span> {
    <span class="hljs-string">"店铺名称"</span>: seller_info.<span class="hljs-keyword">get</span>(<span class="hljs-string">"shop_name"</span>, <span class="hljs-string">""</span>),
    <span class="hljs-string">"店铺ID"</span>: seller_info.<span class="hljs-keyword">get</span>(<span class="hljs-string">"user_id"</span>, <span class="hljs-string">""</span>)
}
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
</li>
</ul>
<h2 data-id="heading-9">四、批量采集完整工作流（最佳实践）</h2>
<h3 data-id="heading-10">Step 1：准备阶段</h3>
<ul>
<li>完成 API 权限申请和凭证获取</li>
<li>确定目标商品 ID 列表（通过搜索 / 店铺获取或手动导入）</li>
<li>初始化日志 / 监控系统（记录成功 / 失败案例）</li>
</ul>
<h3 data-id="heading-11">Step 2：批量获取详情（核心环节）</h3>
<p>plaintext</p>
<pre><code class="hljs language-scss" lang="scss">商品ID列表 → 分批(<span class="hljs-number">50</span>个/批) → 调用接口 → 数据解析 → 错误处理 → 存储
</code></pre>
<p><img src="" alt="" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-12">Step 3：错误处理与重试机制（关键保障）</h3>
<p><strong>常见错误及解决方案：</strong></p>



































<table><thead><tr><th>错误类型</th><th>原因</th><th>解决方案</th></tr></thead><tbody><tr><td><strong>API 限流</strong></td><td>调用频率超过限制</td><td>增加延迟 (0.5-1 秒)、降低并发数、分批处理</td></tr><tr><td><strong>签名错误</strong></td><td>参数 / 签名生成错误</td><td>检查签名算法、确保参数有序、URL 编码正确</td></tr><tr><td><strong>商品不存在</strong></td><td>ID 错误 / 已下架</td><td>过滤无效 ID，记录日志</td></tr><tr><td><strong>网络波动</strong></td><td>临时连接问题</td><td>实现指数退避重试 (1→2→4→8 秒)，最多 3 次</td></tr><tr><td><strong>权限不足</strong></td><td>缺少必要权限</td><td>检查应用权限，重新申请</td></tr></tbody></table>
<h3 data-id="heading-13">Step 4：数据存储与后续应用</h3>
<ul>
<li>
<p><strong>结构化存储</strong>：存入 MySQL/MongoDB 数据库或导出 CSV/Excel</p>
</li>
<li>
<p><strong>增量更新</strong>：记录已采集商品的最后更新时间，下次只采集更新商品</p>
</li>
<li>
<p><strong>业务应用</strong>：</p>
<ul>
<li>商品信息同步至其他平台</li>
<li>竞品监控（价格 / 库存 / 销量变化）</li>
<li>数据分析与选品参考</li>
<li>商品信息管理系统（PIM）更新</li>
</ul>
</li>
</ul>
<h2 data-id="heading-14">五、关键注意事项（避免踩坑）</h2>
<h3 data-id="heading-15">1. <strong>平台规则遵守</strong></h3>
<ul>
<li>禁止<strong>未经授权的数据抓取</strong>（必须使用官方 API，禁用爬虫）</li>
<li>商品价格等信息<strong>仅限自用</strong>，不得直接倒卖数据获利</li>
<li>遵循<strong>频率限制</strong>：基础接口 QPS≤2-5，批量接口≤1，违规会触发风控（IP 封禁 / 接口禁用）</li>
</ul>
<h3 data-id="heading-16">2. <strong>性能与稳定性优化建议</strong></h3>
<p><strong>必做优化：</strong></p>
<ul>
<li>控制并发数在<strong>30 以下</strong>（建议 10-20）</li>
<li>批次大小 <strong>≤40</strong>（为<code>item_get_batch</code>上限 50 预留安全空间）</li>
<li>每请求间添加<strong>随机延迟</strong>（0.3-1 秒）</li>
<li>使用<strong>异步 + 信号量</strong>控制（提升效率 3-5 倍）</li>
</ul>
<p><strong>可选优化：</strong></p>
<ul>
<li>分时段采集（避开 API 高峰，如 11:00-13:00、20:00-22:00）</li>
<li>对热门商品使用缓存（Redis/Memcached）</li>
<li>监控 API 响应时间，动态调整请求策略</li>
</ul>
<h2 data-id="heading-17">六、总结：批量采集的核心实施路径</h2>
<p>批量商品信息采集工具获取淘宝商品详情的完整链路是：<strong>官方 API 授权 → 商品 ID 获取 → 批量接口调用 → 数据解析处理 → 结构化存储</strong>。</p>
<p><strong>最佳实践总结：</strong></p>
<ul>
<li>优先使用官方 API（合规稳定），禁用爬虫</li>
<li>采用批量接口 + 异步并发（提升效率 10 倍 +）</li>
<li>严格控制频率（QPS&lt;5），添加随机延迟</li>
<li>按需请求字段，减少数据传输量</li>
<li>实现完善的错误处理与重试机制</li>
</ul>
<h2 data-id="heading-18">附：淘宝商品详情接口返回核心字段</h2>























































<table><thead><tr><th>字段名</th><th>说明</th><th>用途</th></tr></thead><tbody><tr><td><strong>num_iid</strong></td><td>商品 ID（唯一标识）</td><td>数据关联、更新判断</td></tr><tr><td><strong>title</strong></td><td>商品标题</td><td>展示、关键词分析</td></tr><tr><td><strong>price</strong></td><td>商品价格</td><td>价格监控、比价</td></tr><tr><td><strong>promotion_price</strong></td><td>促销价</td><td>促销活动分析</td></tr><tr><td><strong>pic_url</strong></td><td>主图 URL</td><td>图片下载、展示</td></tr><tr><td><strong>desc</strong></td><td>商品详情描述（HTML）</td><td>详情页展示、内容分析</td></tr><tr><td><strong>sku</strong></td><td>SKU 信息（规格 / 价格）</td><td>库存管理、规格分析</td></tr><tr><td><strong>volume</strong></td><td>销量</td><td>热度评估、选品参考</td></tr><tr><td><strong>seller</strong></td><td>卖家信息（店铺名 / ID）</td><td>店铺分析、供应商管理</td></tr></tbody></table>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 epub 在手机快乐阅读]]></title>    <link>https://juejin.cn/post/7577958825342074899</link>    <guid>https://juejin.cn/post/7577958825342074899</guid>    <pubDate>2025-11-30T07:27:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577958825342074899" data-draft-id="7577970969395068969" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 epub 在手机快乐阅读"/> <meta itemprop="keywords" content="JavaScript,deno,科幻"/> <meta itemprop="datePublished" content="2025-11-30T07:27:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="穷人小水滴"/> <meta itemprop="url" content="https://juejin.cn/user/134615944418777"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 epub 在手机快乐阅读
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/134615944418777/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    穷人小水滴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T07:27:51.000Z" title="Sun Nov 30 2025 07:27:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近沉迷 AI 小说 (不可自拔) 玩物丧志 (大雾).</p>
<p>那么假如, 是说假如, 窝自己写了一本小说, 如何愉快的阅读它呢 ?</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9fcd75f986e34ae78af331a3fd4c6d17~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=ZPEEVRD73wOu8rbSx7C78Hp%2BAg0%3D" alt="0-n-1.png" loading="lazy"/></p>
<p>这里是 穷人小水滴, 专注于 穷人友好型 低成本技术. (本文为 86 号作品. )</p>
<hr/>
<p>相关文章:</p>
<ul>
<li>《4 大低成本娱乐方式: 小说, 音乐, 视频, 电子游戏》 <a href="https://juejin.cn/post/7414129923634561035" target="_blank" title="https://juejin.cn/post/7414129923634561035">juejin.cn/post/741412…</a></li>
<li>《在 Android 设备上写代码 (Termux, code-server)》 <a href="https://juejin.cn/post/7510181121205256226" target="_blank" title="https://juejin.cn/post/7510181121205256226">juejin.cn/post/751018…</a></li>
<li>《Android 运行 deno 的新方法 (3): Termux 胖喵安初》 <a href="https://juejin.cn/post/7533510113068761098" target="_blank" title="https://juejin.cn/post/7533510113068761098">juejin.cn/post/753351…</a></li>
<li>《小水滴系列文章目录 (整理)》 <a href="https://juejin.cn/post/7522090635908300838" target="_blank" title="https://juejin.cn/post/7522090635908300838">juejin.cn/post/752209…</a></li>
<li>《自制: 7 天手搓一个拼音输入法》 <a href="https://juejin.cn/post/7343902899095060499" target="_blank" title="https://juejin.cn/post/7343902899095060499">juejin.cn/post/734390…</a></li>
<li>《防误删 (实时) 文件备份系统 (btrfs 快照 + rsync)》 <a href="https://juejin.cn/post/7552509614097924131" target="_blank" title="https://juejin.cn/post/7552509614097924131">juejin.cn/post/755250…</a></li>
<li>《静音键盘简单评测》</li>
<li>《科幻小说计划 (顾雪) (AIGC)》 <a href="https://juejin.cn/post/7577718777481297958" target="_blank" title="https://juejin.cn/post/7577718777481297958">juejin.cn/post/757771…</a></li>
</ul>
<p>参考资料:</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeno.com%2F" target="_blank" title="https://deno.com/" ref="nofollow noopener noreferrer">deno.com/</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ftermux.dev%2Fen%2F" target="_blank" title="https://termux.dev/en/" ref="nofollow noopener noreferrer">termux.dev/en/</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.tuna.tsinghua.edu.cn%2Fhelp%2Ffdroid%2F" target="_blank" title="https://mirrors.tuna.tsinghua.edu.cn/help/fdroid/" ref="nofollow noopener noreferrer">mirrors.tuna.tsinghua.edu.cn/help/fdroid…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwiki.lineageos.org%2Fdevices%2Fviolet%2F" target="_blank" title="https://wiki.lineageos.org/devices/violet/" ref="nofollow noopener noreferrer">wiki.lineageos.org/devices/vio…</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Farchlinux.org%2F" target="_blank" title="https://archlinux.org/" ref="nofollow noopener noreferrer">archlinux.org/</a></li>
</ul>
<h2 data-id="heading-0">目录</h2>
<ul>
<li>1 制作 epub 文件 (deno)
<ul>
<li>1.1 程序代码</li>
<li>1.2 工作原理</li>
</ul>
</li>
<li>2 手机阅读软件推荐 (Android F-Droid)</li>
<li>3 实际测试</li>
<li>4 总结与展望</li>
<li>附录 1 "全开源" 软件体系</li>
</ul>
<h2 data-id="heading-1">1 制作 epub 文件 (deno)</h2>
<p>如果使用最基础的 <code>txt</code> (纯文本) 文件, 由于不含任何有关内容的格式, 阅读体验并不好.</p>
<p><strong>epub</strong> 是一种开放的电子书格式标准, 基于 HTML+CSS (XML) 技术, 简单, 被广泛支持, 功能丰富.</p>
<p>于是窝就写了一个很简单的 txt 转 epub 格式的程序, 主要功能有分章, 字数计算等, 代码如下.</p>
<h3 data-id="heading-2">1.1 程序代码</h3>
<p>文件 <code>txt2epub.js</code>:</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// txt2epub.js</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// deno run -A txt2epub.js 1.txt out1</span>

<span class="hljs-comment">// 计算中文字数: 非 ASCII 字符都算</span>
<span class="hljs-keyword">function</span> 字数(文本) {
  <span class="hljs-keyword">let</span> 计数 = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> i <span class="hljs-keyword">of</span> 文本) {
    <span class="hljs-keyword">if</span> (i.<span class="hljs-title function_">codePointAt</span>(<span class="hljs-number">0</span>) &gt; <span class="hljs-number">127</span>) {
      计数 += <span class="hljs-number">1</span>;
    }
  }
  <span class="hljs-keyword">return</span> 计数;
}

<span class="hljs-comment">// 将输入 txt 文件内容转换成内部数据格式, 并进行分章</span>
<span class="hljs-keyword">function</span> 解析<span class="hljs-title function_">txt</span>(<span class="hljs-params">文本</span>) {
  <span class="hljs-comment">// 全文总字数</span>
  <span class="hljs-keyword">const</span> 总字 = 字数(文本);

  <span class="hljs-comment">// 按 ## 切分章节 (markdown)</span>
  <span class="hljs-keyword">const</span> 部分 = 文本.<span class="hljs-title function_">split</span>(<span class="hljs-string">"\n## "</span>);

  <span class="hljs-comment">// 章节的第 1 行是标题</span>
  <span class="hljs-keyword">const</span> 章 = 部分.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">i</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> 行 = i.<span class="hljs-title function_">split</span>(<span class="hljs-string">"\n"</span>);

    <span class="hljs-comment">// 章节正文字数</span>
    <span class="hljs-keyword">const</span> 字 = 字数(行.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">join</span>(<span class="hljs-string">"\n"</span>));

    <span class="hljs-keyword">return</span> {
      <span class="hljs-comment">// 标题 (字数)</span>
      标题: 行[<span class="hljs-number">0</span>] + <span class="hljs-string">" ("</span> + 字 + <span class="hljs-string">")"</span>,
      段: 行.<span class="hljs-title function_">slice</span>(<span class="hljs-number">1</span>),
    };
  });

  <span class="hljs-comment">// 书名为第 1 行</span>
  <span class="hljs-comment">// 总字数 (k 计数)</span>
  <span class="hljs-keyword">const</span> 总字k = (总字 / <span class="hljs-number">1000</span>).<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">0</span>);
  <span class="hljs-keyword">return</span> {
    标题: 章[<span class="hljs-number">0</span>].标题 + <span class="hljs-string">" ("</span> + 总字k + <span class="hljs-string">"k)"</span>,
    章,
  };
}

<span class="hljs-comment">// 读取 txt 文件并解析</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> 加载<span class="hljs-title function_">txt</span>(<span class="hljs-params">文件</span>) {
  <span class="hljs-keyword">const</span> 文本 = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Deno</span>.<span class="hljs-title function_">readTextFile</span>(文件);
  <span class="hljs-keyword">return</span> 解析<span class="hljs-title function_">txt</span>(文本);
}

<span class="hljs-comment">// 生成 uuid</span>
<span class="hljs-keyword">function</span> 造<span class="hljs-title function_">uuid</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> crypto.<span class="hljs-title function_">randomUUID</span>();
}

<span class="hljs-comment">// 渲染 epub</span>

<span class="hljs-comment">// out/mimetype</span>
<span class="hljs-keyword">function</span> 渲染<span class="hljs-title function_">mimetype</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`application/epub+zip`</span>;
}

<span class="hljs-comment">// out/META-INF/container.xml</span>
<span class="hljs-keyword">function</span> 渲染<span class="hljs-title function_">container_xml</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;container
  version="1.0"
  xmlns="urn:oasis:names:tc:opendocument:xmlns:container"
&gt;
  &lt;rootfiles&gt;
    &lt;rootfile
      full-path="OEBPS/content.opf"
      media-type="application/oebps-package+xml"
    /&gt;
  &lt;/rootfiles&gt;
&lt;/container&gt;
`</span>;
}

<span class="hljs-comment">// out/OEBPS/content.opf</span>
<span class="hljs-keyword">function</span> 渲染<span class="hljs-title function_">content_opf</span>(<span class="hljs-params">数据</span>) {
  <span class="hljs-keyword">const</span> uuid = 造<span class="hljs-title function_">uuid</span>();

  <span class="hljs-keyword">const</span> item = 数据.章.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">_, 序号</span>) =&gt;</span>
    <span class="hljs-string">`    &lt;item id="item<span class="hljs-subst">${序号}</span>" href="xhtml/<span class="hljs-subst">${序号}</span>.xhtml" media-type="application/xhtml+xml" /&gt;`</span>
  );
  <span class="hljs-keyword">const</span> itemref = 数据.章.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">_, 序号</span>) =&gt;</span>
    <span class="hljs-string">`    &lt;itemref idref="item<span class="hljs-subst">${序号}</span>" /&gt;`</span>
  );

  <span class="hljs-keyword">return</span> <span class="hljs-string">`&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;package
  xmlns="http://www.idpf.org/2007/opf"
  version="3.0"
  unique-identifier="pub-id"
&gt;
  &lt;metadata xmlns:dc="http://purl.org/dc/elements/1.1/"&gt;
    &lt;dc:title&gt;<span class="hljs-subst">${数据.标题}</span>&lt;/dc:title&gt;
    &lt;dc:creator&gt;you&lt;/dc:creator&gt;
    &lt;dc:identifier id="pub-id"
    &gt;urn:uuid:<span class="hljs-subst">${uuid}</span>&lt;/dc:identifier&gt;
  &lt;/metadata&gt;

  &lt;manifest&gt;
    &lt;item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml" /&gt;
    &lt;item id="css" href="style.css" media-type="text/css" /&gt;

<span class="hljs-subst">${item.join(<span class="hljs-string">"\n"</span>)}</span>
  &lt;/manifest&gt;

  &lt;spine toc="ncx"&gt;
<span class="hljs-subst">${itemref.join(<span class="hljs-string">"\n"</span>)}</span>
  &lt;/spine&gt;
&lt;/package&gt;
`</span>;
}

<span class="hljs-comment">// out/OEBPS/toc.ncx</span>
<span class="hljs-keyword">function</span> 渲染<span class="hljs-title function_">toc_ncx</span>(<span class="hljs-params">数据</span>) {
  <span class="hljs-keyword">const</span> uuid = 造<span class="hljs-title function_">uuid</span>();

  <span class="hljs-keyword">const</span> navPoint = 数据.章.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">i, 序号</span>) =&gt;</span>
    <span class="hljs-string">`    &lt;navPoint id="navPoint-<span class="hljs-subst">${序号}</span>" playOrder="<span class="hljs-subst">${序号 + <span class="hljs-number">1</span>}</span>"&gt;
      &lt;navLabel&gt;&lt;text&gt;<span class="hljs-subst">${i.标题}</span>&lt;/text&gt;&lt;/navLabel&gt;
      &lt;content src="xhtml/<span class="hljs-subst">${序号}</span>.xhtml" /&gt;
    &lt;/navPoint&gt;
`</span>
  );

  <span class="hljs-keyword">return</span> <span class="hljs-string">`&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;ncx
  xmlns="http://www.daisy.org/z3986/2005/ncx/"
  version="2005-1"
  xml:lang="zh-CN"
&gt;
  &lt;head&gt;
    &lt;meta
      name="dtb:uid"
      content="urn:uuid:<span class="hljs-subst">${uuid}</span>"
    /&gt;
    &lt;meta name="dtb:depth" content="1" /&gt;
    &lt;meta name="dtb:totalPageCount" content="<span class="hljs-subst">${数据.章.length}</span>" /&gt;
  &lt;/head&gt;
  &lt;docTitle&gt;
    &lt;text&gt;<span class="hljs-subst">${数据.标题}</span>&lt;/text&gt;
  &lt;/docTitle&gt;
  &lt;navMap&gt;
<span class="hljs-subst">${navPoint.join(<span class="hljs-string">"\n"</span>)}</span>
  &lt;/navMap&gt;
&lt;/ncx&gt;
`</span>;
}

<span class="hljs-comment">// out/OEBPS/style.css</span>
<span class="hljs-keyword">function</span> 渲染<span class="hljs-title function_">style_css</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`body {

}
`</span>;
}

<span class="hljs-comment">// out/OEBPS/xhtml/0.xhtml</span>
<span class="hljs-keyword">function</span> 渲染<span class="hljs-title function_">xhtml</span>(<span class="hljs-params">章, _序号</span>) {
  <span class="hljs-keyword">const</span> p = 章.段.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">i</span>) =&gt;</span> <span class="hljs-string">`    &lt;p&gt;<span class="hljs-subst">${i}</span>&lt;/p&gt;`</span>);

  <span class="hljs-keyword">return</span> <span class="hljs-string">`&lt;?xml version="1.0" encoding="utf-8"?&gt;
&lt;html xmlns="http://www.w3.org/1999/xhtml" xmlns:epub="http://www.idpf.org/2007/ops"&gt;
  &lt;head&gt;
    &lt;title&gt;<span class="hljs-subst">${章.标题}</span>&lt;/title&gt;
  &lt;/head&gt;
  &lt;body&gt;
    &lt;h2&gt;<span class="hljs-subst">${章.标题}</span>&lt;/h2&gt;

<span class="hljs-subst">${p.join(<span class="hljs-string">"\n"</span>)}</span>

 &lt;/body&gt;
&lt;/html&gt;
`</span>;
}

<span class="hljs-comment">// 递归创建目录: mkdir -p</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> 建目录(路径) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"目录"</span>, 路径);
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Deno</span>.<span class="hljs-title function_">mkdir</span>(路径, {
    <span class="hljs-attr">recursive</span>: <span class="hljs-literal">true</span>,
  });
}

<span class="hljs-comment">// 写文本文件</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> 写(名, 文本) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">" "</span>, 名);
  <span class="hljs-keyword">await</span> <span class="hljs-title class_">Deno</span>.<span class="hljs-title function_">writeTextFile</span>(名, 文本);
}

<span class="hljs-comment">// 生成 epub 文件</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// epub 文件结构 (zip.epub):</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// out/</span>
<span class="hljs-comment">// out/mimetype</span>
<span class="hljs-comment">// out/META-INF/</span>
<span class="hljs-comment">// out/META-INF/container.xml</span>
<span class="hljs-comment">// out/OEBPS/</span>
<span class="hljs-comment">// out/OEBPS/content.opf</span>
<span class="hljs-comment">// out/OEBPS/toc.ncx</span>
<span class="hljs-comment">// out/OEBPS/style.css</span>
<span class="hljs-comment">// out/OEBPS/xhtml/</span>
<span class="hljs-comment">// out/OEBPS/xhtml/0.xhtml</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> 造<span class="hljs-title function_">epub</span>(<span class="hljs-params">数据, 输出目录</span>) {
  <span class="hljs-comment">// epub 元数据</span>
  <span class="hljs-keyword">await</span> 建目录(输出目录);
  <span class="hljs-keyword">await</span> 写(输出目录 + <span class="hljs-string">"/mimetype"</span>, 渲染<span class="hljs-title function_">mimetype</span>());

  <span class="hljs-keyword">await</span> 建目录(输出目录 + <span class="hljs-string">"/META-INF"</span>);
  <span class="hljs-keyword">await</span> 写(输出目录 + <span class="hljs-string">"/META-INF/container.xml"</span>, 渲染<span class="hljs-title function_">container_xml</span>());

  <span class="hljs-keyword">await</span> 建目录(输出目录 + <span class="hljs-string">"/OEBPS/xhtml"</span>);
  <span class="hljs-keyword">await</span> 写(输出目录 + <span class="hljs-string">"/OEBPS/content.opf"</span>, 渲染<span class="hljs-title function_">content_opf</span>(数据));
  <span class="hljs-keyword">await</span> 写(输出目录 + <span class="hljs-string">"/OEBPS/toc.ncx"</span>, 渲染<span class="hljs-title function_">toc_ncx</span>(数据));
  <span class="hljs-keyword">await</span> 写(输出目录 + <span class="hljs-string">"/OEBPS/style.css"</span>, 渲染<span class="hljs-title function_">style_css</span>());

  <span class="hljs-comment">// 生成每一章</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> [序号, 章] <span class="hljs-keyword">of</span> 数据.章.<span class="hljs-title function_">entries</span>()) {
    <span class="hljs-keyword">await</span> 写(
      输出目录 + <span class="hljs-string">"/OEBPS/xhtml/"</span> + 序号 + <span class="hljs-string">".xhtml"</span>,
      渲染<span class="hljs-title function_">xhtml</span>(章, 序号),
    );
  }

  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"完成"</span>);
}

<span class="hljs-comment">// 开始执行</span>
<span class="hljs-keyword">const</span> [输入文件, 输出目录] = <span class="hljs-title class_">Deno</span>.<span class="hljs-property">args</span>;

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"读"</span>, 输入文件);

<span class="hljs-keyword">const</span> 数据 = <span class="hljs-keyword">await</span> 加载<span class="hljs-title function_">txt</span>(输入文件);
<span class="hljs-comment">//console.log("data", 数据);</span>

<span class="hljs-keyword">await</span> 造<span class="hljs-title function_">epub</span>(数据, 输出目录);

<span class="hljs-comment">// txt2epub.js</span>
</code></pre>
<h3 data-id="heading-3">1.2 工作原理</h3>
<p>我们用一个简单的测试文件.</p>
<p>文件 <code>1.txt</code>:</p>
<pre><code class="hljs language-markdown" lang="markdown">(测试) 整本书 的 书名

封面 1

封面 2

<span class="hljs-section">## 第 1 章 标题 1</span>

段落 1
段落 2

<span class="hljs-section">## 第 2 章 标题 2</span>

段落 3

段落 4

TODO end
</code></pre>
<p>内容很简单, 只有 2 章, 格式类似 markdown.</p>
<hr/>
<p>然后运行上面的程序:</p>
<pre><code class="hljs language-sh" lang="sh">&gt; deno run -A txt2epub.js 1.txt out1
读 1.txt
目录 out1
  out1/mimetype
目录 out1/META-INF
  out1/META-INF/container.xml
目录 out1/OEBPS/xhtml
  out1/OEBPS/content.opf
  out1/OEBPS/toc.ncx
  out1/OEBPS/style.css
  out1/OEBPS/xhtml/0.xhtml
  out1/OEBPS/xhtml/1.xhtml
  out1/OEBPS/xhtml/2.xhtml
完成
</code></pre>
<p>运行完毕, 生成了这些文件:</p>
<pre><code class="hljs language-sh" lang="sh">&gt; find out1
out1
out1/mimetype
out1/META-INF
out1/META-INF/container.xml
out1/OEBPS
out1/OEBPS/xhtml
out1/OEBPS/xhtml/0.xhtml
out1/OEBPS/xhtml/1.xhtml
out1/OEBPS/xhtml/2.xhtml
out1/OEBPS/content.opf
out1/OEBPS/toc.ncx
out1/OEBPS/style.css
</code></pre>
<p>文件 <code>out1/mimetype</code>:</p>
<pre><code class="hljs language-txt" lang="txt">application/epub+zip
</code></pre>
<p>文件 <code>out1/META-INF/container.xml</code>:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">container</span>
  <span class="hljs-attr">version</span>=<span class="hljs-string">"1.0"</span>
  <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"urn:oasis:names:tc:opendocument:xmlns:container"</span>
&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">rootfiles</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">rootfile</span>
      <span class="hljs-attr">full-path</span>=<span class="hljs-string">"OEBPS/content.opf"</span>
      <span class="hljs-attr">media-type</span>=<span class="hljs-string">"application/oebps-package+xml"</span>
    /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">rootfiles</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">container</span>&gt;</span>
</code></pre>
<p>文件 <code>out1/OEBPS/content.opf</code>:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">package</span>
  <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.idpf.org/2007/opf"</span>
  <span class="hljs-attr">version</span>=<span class="hljs-string">"3.0"</span>
  <span class="hljs-attr">unique-identifier</span>=<span class="hljs-string">"pub-id"</span>
&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">metadata</span> <span class="hljs-attr">xmlns:dc</span>=<span class="hljs-string">"http://purl.org/dc/elements/1.1/"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:title</span>&gt;</span>(测试) 整本书 的 书名 (4) (0k)<span class="hljs-tag">&lt;/<span class="hljs-name">dc:title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:creator</span>&gt;</span>you<span class="hljs-tag">&lt;/<span class="hljs-name">dc:creator</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dc:identifier</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"pub-id"</span>
    &gt;</span>urn:uuid:b203607a-1ebb-44db-ba21-854dd5dc57b3<span class="hljs-tag">&lt;/<span class="hljs-name">dc:identifier</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">metadata</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">manifest</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"ncx"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"toc.ncx"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"application/x-dtbncx+xml"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"css"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"style.css"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"text/css"</span> /&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"item0"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"xhtml/0.xhtml"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"application/xhtml+xml"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"item1"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"xhtml/1.xhtml"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"application/xhtml+xml"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">item</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"item2"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"xhtml/2.xhtml"</span> <span class="hljs-attr">media-type</span>=<span class="hljs-string">"application/xhtml+xml"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">manifest</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">spine</span> <span class="hljs-attr">toc</span>=<span class="hljs-string">"ncx"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">itemref</span> <span class="hljs-attr">idref</span>=<span class="hljs-string">"item0"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">itemref</span> <span class="hljs-attr">idref</span>=<span class="hljs-string">"item1"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">itemref</span> <span class="hljs-attr">idref</span>=<span class="hljs-string">"item2"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">spine</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">package</span>&gt;</span>
</code></pre>
<p>文件 <code>out1/OEBPS/toc.ncx</code>:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">ncx</span>
  <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.daisy.org/z3986/2005/ncx/"</span>
  <span class="hljs-attr">version</span>=<span class="hljs-string">"2005-1"</span>
  <span class="hljs-attr">xml:lang</span>=<span class="hljs-string">"zh-CN"</span>
&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span>
      <span class="hljs-attr">name</span>=<span class="hljs-string">"dtb:uid"</span>
      <span class="hljs-attr">content</span>=<span class="hljs-string">"urn:uuid:34deb94e-ee02-4db6-b96b-31996f4e8900"</span>
    /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"dtb:depth"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"1"</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"dtb:totalPageCount"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"3"</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">docTitle</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">text</span>&gt;</span>(测试) 整本书 的 书名 (4) (0k)<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">docTitle</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">navMap</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">navPoint</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"navPoint-0"</span> <span class="hljs-attr">playOrder</span>=<span class="hljs-string">"1"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">navLabel</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">text</span>&gt;</span>(测试) 整本书 的 书名 (4)<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">navLabel</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">content</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"xhtml/0.xhtml"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">navPoint</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">navPoint</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"navPoint-1"</span> <span class="hljs-attr">playOrder</span>=<span class="hljs-string">"2"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">navLabel</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">text</span>&gt;</span>第 1 章 标题 1 (4)<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">navLabel</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">content</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"xhtml/1.xhtml"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">navPoint</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">navPoint</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"navPoint-2"</span> <span class="hljs-attr">playOrder</span>=<span class="hljs-string">"3"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">navLabel</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">text</span>&gt;</span>第 2 章 标题 2 (4)<span class="hljs-tag">&lt;/<span class="hljs-name">text</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">navLabel</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">content</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"xhtml/2.xhtml"</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">navPoint</span>&gt;</span>

  <span class="hljs-tag">&lt;/<span class="hljs-name">navMap</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ncx</span>&gt;</span>
</code></pre>
<p>文件 <code>out1/OEBPS/style.css</code>:</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">body</span> {

}
</code></pre>
<p>文件 <code>out1/OEBPS/xhtml/0.xhtml</code>:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.w3.org/1999/xhtml"</span> <span class="hljs-attr">xmlns:epub</span>=<span class="hljs-string">"http://www.idpf.org/2007/ops"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>(测试) 整本书 的 书名 (4)<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>(测试) 整本书 的 书名 (4)<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>封面 1<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>封面 2<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

 <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>文件 <code>out1/OEBPS/xhtml/1.xhtml</code>:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.w3.org/1999/xhtml"</span> <span class="hljs-attr">xmlns:epub</span>=<span class="hljs-string">"http://www.idpf.org/2007/ops"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>第 1 章 标题 1 (4)<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>第 1 章 标题 1 (4)<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>段落 1<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>段落 2<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

 <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p>文件 <code>out1/OEBPS/xhtml/2.xhtml</code>:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"utf-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">"http://www.w3.org/1999/xhtml"</span> <span class="hljs-attr">xmlns:epub</span>=<span class="hljs-string">"http://www.idpf.org/2007/ops"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>第 2 章 标题 2 (4)<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>第 2 章 标题 2 (4)<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>段落 3<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>段落 4<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>TODO end<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

 <span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<hr/>
<p>上面的大部分文件都是 epub 的元数据, 比如标题, 目录什么的.
<code>xhtml</code> 文件是章节内容, 每章一个.</p>
<p>然后, 把这堆文件手动压缩成 <code>zip</code> 包, 再把文件名后缀改成 <code>.epub</code>, 就完成啦 ~</p>
<p>对, epub 格式就是这么朴实无华.</p>
<h2 data-id="heading-4">2 手机阅读软件推荐 (Android F-Droid)</h2>
<p>如何安装 Termux (F-Droid) 详见文章 《在 Android 设备上写代码 (Termux, code-server)》.</p>
<p>此处推荐的 epub 阅读软件有: LxReader, Librera (F-Droid), Anx Reader</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4a3ae19b276b4b468173c804f4365844~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=UolWLKN%2BLEV5v2dxEsSvQGBRwlQ%3D" alt="2-s-1.png" loading="lazy"/></p>
<p>这些软件可以从 F-Droid 下载.</p>
<p>为什么使用 F-Droid 软件呢 ? 因为 F-Droid 的规则要求, 里面的软件必须是 "完全开源" 的, 也就是不能有闭源的依赖组件, 整个软件从源代码从头编译.</p>
<p>这意味着, 最终用户不必受限于任何人, 你可以获取软件的源代码, 自己编译, 或进行修改.</p>
<h2 data-id="heading-5">3 实际测试</h2>
<p>测试手机: 型号 Redmi Note 7 pro (6G+128G) (对, 这只手机来自古老但美好的 MIUI 时代 ~ )</p>
<p>操作系统: LineageOS 23.0</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4653765d930145e2942c918ba7d8ac36~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=KoKPfYtxCDhQ%2BScDWPlUGp3qYSc%3D" alt="3-a-1.png" loading="lazy"/></p>
<p>在 Termux 中安装 <code>deno</code>, 命令:</p>
<pre><code class="hljs language-sh" lang="sh">pkg install deno
</code></pre>
<p>然后就可以在手机上运行上面的程序啦 ~</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f68e35e5cba94959aa9b07d6b0f61152~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=emQ0nELPNU%2FVf3tSvbaIRq%2BVrO8%3D" alt="3-t-2.png" loading="lazy"/></p>
<p>这是制作好的 epub 文件:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6b05d39e92741498251f1ae25cdf08d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=gzoh%2BPrkgJhyoTEKaqhrlSbGZaE%3D" alt="3-f-3.png" loading="lazy"/></p>
<p>这是窝写的一个中篇小说 (初稿).</p>
<hr/>
<p>LxReader 阅读效果:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ada37202e2aa4a41bc75d6044691cb90~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=%2F%2BwnVC5XqgzU%2BRSKuUrod8AywUU%3D" alt="3-x-4.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/087937ff41af4e1981033d80668a9a9a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=11Fv2k1wl%2B9PfVGtzw6WJPRo8r0%3D" alt="3-x-5.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8259992dbb394986b8921773bae382a6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=T99p1%2FPPZqXcqd7WbA7s4C126bY%3D" alt="3-x-6.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4157b46715a24066be0f59c70be24540~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=s9GQOxutwswgC8Cju0p7yGNS2fs%3D" alt="3-x-7.png" loading="lazy"/></p>
<p>Librera 阅读效果:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7807c0bc0e6247f188b5b0d6a92b916c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=rDU3lLBq5sEiOnkj3DNWNrDeD0w%3D" alt="3-r-8.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1718ea26f05c414cb8bb103d5c88e19b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=rMh2mq6jeDBQApvk9Slq3FdyfFc%3D" alt="3-r-9.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/336f5d103e7b4c9c96170a2006fe7c84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=kENiJX%2FE95vVpBPNw0BYHjNQg3k%3D" alt="3-r-10.png" loading="lazy"/></p>
<h2 data-id="heading-6">4 总结与展望</h2>
<p>随着 AI 语言大模型越来越强, 在 AI 的辅助下写小说就越来越容易啦 ~</p>
<p>相比被动的阅读别人写好的小说, 写出自己的小说, 是一种更快乐的娱乐方式. 加油 !</p>
<p>本文只使用了 epub 最简单的功能 (章节标题), epub 还有很多功能可以继续深入挖掘.</p>
<h2 data-id="heading-7">附录 1 "全开源" 软件体系</h2>
<ul>
<li>
<p>操作系统: Android (LineageOS, 手机), ArchLinux GNOME (PC).</p>
</li>
<li>
<p>中文输入法: 胖喵拼音 (自制)</p>
</li>
<li>
<p>AI (语言大模型): deepseek</p>
</li>
<li>
<p>txt 转 epub: 自制 (deno, Termux)</p>
</li>
<li>
<p>手机阅读软件: LxReader, Librera (F-Droid)</p>
</li>
</ul>
<p>从 操作系统 -&gt; 创作 -&gt; 阅读 的 <strong>全链条</strong> 开源软件.</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d25cfcec4f14cd4af54fea88836b518~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56m35Lq65bCP5rC05ru0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765092471&amp;x-signature=YnlmYkbJsS%2BRwitC5LVl1yy0abg%3D" alt="a1-p-1.jpg" loading="lazy"/></p>
<p>如图, 使用胖喵拼音 (和 AI) 在手机上写小说 ~</p>
<hr/>
<p>本文使用 CC-BY-SA 4.0 许可发布.</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何正确使用 Redis 分布式锁（完整技术分享文档）]]></title>    <link>https://juejin.cn/post/7577905525997469737</link>    <guid>https://juejin.cn/post/7577905525997469737</guid>    <pubDate>2025-11-30T06:08:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577905525997469737" data-draft-id="7577905525997092905" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何正确使用 Redis 分布式锁（完整技术分享文档）"/> <meta itemprop="keywords" content="Redis"/> <meta itemprop="datePublished" content="2025-11-30T06:08:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="beata"/> <meta itemprop="url" content="https://juejin.cn/user/1839900247461280"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何正确使用 Redis 分布式锁（完整技术分享文档）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1839900247461280/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    beata
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T06:08:22.000Z" title="Sun Nov 30 2025 06:08:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">如何正确使用 Redis 分布式锁（完整技术分享文档）</h2>
<hr/>
<h3 data-id="heading-1">目录</h3>
<ol>
<li><a href="#1-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5" title="#1-%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5">基础概念</a></li>
<li><a href="#2-%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88%E4%B8%8E%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0" title="#2-%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88%E4%B8%8E%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0">实现方案与代码实现</a>
<ul>
<li><a href="#21-set-%E5%91%BD%E4%BB%A4%E5%AE%9E%E7%8E%B0" title="#21-set-%E5%91%BD%E4%BB%A4%E5%AE%9E%E7%8E%B0">2.1 SET 命令实现</a></li>
<li><a href="#22-stringredistemplate-%E5%AE%9E%E7%8E%B0" title="#22-stringredistemplate-%E5%AE%9E%E7%8E%B0">2.2 StringRedisTemplate 实现</a></li>
<li><a href="#23-redlock-%E7%AE%97%E6%B3%95" title="#23-redlock-%E7%AE%97%E6%B3%95">2.3 Redlock 算法</a></li>
<li><a href="#24-redisson-%E6%A1%86%E6%9E%B6" title="#24-redisson-%E6%A1%86%E6%9E%B6">2.4 Redisson 框架</a></li>
<li><a href="#25-spring-boot-%E6%B3%A8%E8%A7%A3%E6%96%B9%E5%BC%8F%E5%AE%9E%E7%8E%B0" title="#25-spring-boot-%E6%B3%A8%E8%A7%A3%E6%96%B9%E5%BC%8F%E5%AE%9E%E7%8E%B0">2.5 Spring Boot 注解方式实现</a></li>
</ul>
</li>
<li><a href="#3-%E4%BC%98%E7%BC%BA%E7%82%B9%E5%AF%B9%E6%AF%94" title="#3-%E4%BC%98%E7%BC%BA%E7%82%B9%E5%AF%B9%E6%AF%94">优缺点对比</a></li>
<li><a href="#4-%E5%A4%B1%E6%95%88%E6%83%85%E5%86%B5%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" title="#4-%E5%A4%B1%E6%95%88%E6%83%85%E5%86%B5%E5%88%86%E6%9E%90%E4%B8%8E%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">失效情况分析与解决方案</a></li>
<li><a href="#5-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E6%A1%88%E4%BE%8B" title="#5-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5%E6%A1%88%E4%BE%8B">最佳实践案例</a></li>
<li><a href="#6-%E6%80%BB%E7%BB%93" title="#6-%E6%80%BB%E7%BB%93">总结</a></li>
</ol>
<hr/>
<h3 data-id="heading-2">1. 基础概念</h3>
<p><strong>分布式锁</strong>用于协调多个节点对共享资源的互斥访问，常用于秒杀、抢红包、库存扣减等场景。Redis 因其高性能、原子性操作（如 <code>SET NX PX</code>）成为分布式锁的常用实现工具。</p>
<p><strong>核心要求</strong>：</p>
<ul>
<li><strong>互斥性</strong>：任意时刻只有一个客户端持有锁。</li>
<li><strong>锁超时释放</strong>：避免死锁。</li>
<li><strong>安全性</strong>：只能被持有者删除。</li>
<li><strong>高性能与高可用</strong>：低开销、支持多节点容错。</li>
</ul>
<hr/>
<h3 data-id="heading-3">2. 实现方案与代码实现</h3>
<h4 data-id="heading-4">2.1 SET 命令实现（基础方案）</h4>
<p><strong>原理</strong>：<br/>
使用 <code>SET key value NX PX milliseconds</code> 原子命令实现加锁，解锁通过 Lua 脚本校验持有者身份。</p>
<p><strong>代码示例（Java + Jedis）</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;
<span class="hljs-keyword">import</span> java.util.UUID;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisLock</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LOCK_KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">"resource_lock"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">EXPIRE_TIME</span> <span class="hljs-operator">=</span> <span class="hljs-number">30000</span>; <span class="hljs-comment">// 30s</span>

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(Jedis jedis, String lockKey, String uniqueId, <span class="hljs-type">int</span> expireTime)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> jedis.set(lockKey, uniqueId, <span class="hljs-string">"NX"</span>, <span class="hljs-string">"PX"</span>, expireTime);
        <span class="hljs-keyword">return</span> <span class="hljs-string">"OK"</span>.equals(result);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">(Jedis jedis, String lockKey, String uniqueId)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">luaScript</span> <span class="hljs-operator">=</span> <span class="hljs-string">"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end"</span>;
        jedis.eval(luaScript, <span class="hljs-number">1</span>, lockKey, uniqueId);
    }

    <span class="hljs-comment">// 使用示例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Jedis</span> <span class="hljs-variable">jedis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Jedis</span>(<span class="hljs-string">"localhost"</span>);
        <span class="hljs-type">String</span> <span class="hljs-variable">uniqueId</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();
        <span class="hljs-keyword">if</span> (tryLock(jedis, LOCK_KEY, uniqueId, EXPIRE_TIME)) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 业务逻辑</span>
            } <span class="hljs-keyword">finally</span> {
                unlock(jedis, LOCK_KEY, uniqueId);
            }
        }
    }
}
</code></pre>
<hr/>
<h4 data-id="heading-5">2.2 StringRedisTemplate 实现（Spring Boot 推荐）</h4>
<p><strong>原理</strong>：<br/>
使用 Spring Data Redis 提供的 <code>StringRedisTemplate</code> 实现加锁和解锁，结合 Lua 脚本确保安全性。</p>
<p><strong>代码示例（Spring Boot）</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-keyword">import</span> java.util.Collections;
<span class="hljs-keyword">import</span> java.util.UUID;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisLockService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StringRedisTemplate redisTemplate;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RedisLockService</span><span class="hljs-params">(StringRedisTemplate redisTemplate)</span> {
        <span class="hljs-built_in">this</span>.redisTemplate = redisTemplate;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryLock</span><span class="hljs-params">(String lockKey, <span class="hljs-type">long</span> expireTime)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">uniqueId</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue().setIfAbsent(
            lockKey, uniqueId, expireTime, TimeUnit.MILLISECONDS);
        <span class="hljs-keyword">return</span> Boolean.TRUE.equals(result);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unlock</span><span class="hljs-params">(String lockKey, String uniqueId)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">script</span> <span class="hljs-operator">=</span> <span class="hljs-string">"if redis.call('get', KEYS[1]) == ARGV[1] then return redis.call('del', KEYS[1]) else return 0 end"</span>;
        DefaultRedisScript&lt;Long&gt; redisScript = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;(script, Long.class);
        redisTemplate.execute(redisScript, Collections.singletonList(lockKey), uniqueId);
    }

    <span class="hljs-comment">// 使用示例</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processResource</span><span class="hljs-params">()</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> <span class="hljs-string">"resource_lock"</span>;
        <span class="hljs-keyword">if</span> (tryLock(lockKey, <span class="hljs-number">30000</span>)) {
            <span class="hljs-keyword">try</span> {
                <span class="hljs-comment">// 业务逻辑</span>
            } <span class="hljs-keyword">finally</span> {
                unlock(lockKey, redisTemplate.opsForValue().get(lockKey));
            }
        }
    }
}
</code></pre>
<hr/>
<h4 data-id="heading-6">2.3 Redlock 算法（多实例方案）</h4>
<p><strong>原理</strong>：<br/>
通过多个独立 Redis 实例实现高可用锁。</p>
<p><strong>代码示例（伪代码）</strong>：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">acquire_redlock</span>(<span class="hljs-params">lock_name, expire_time</span>):
    instances = [redis.Redis(host=<span class="hljs-string">f'redis<span class="hljs-subst">{i}</span>'</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">5</span>)]
    success_count = <span class="hljs-number">0</span>
    <span class="hljs-keyword">for</span> instance <span class="hljs-keyword">in</span> instances:
        <span class="hljs-keyword">if</span> instance.<span class="hljs-built_in">set</span>(lock_name, <span class="hljs-string">"locked"</span>, nx=<span class="hljs-literal">True</span>, px=expire_time):
            success_count += <span class="hljs-number">1</span>
    <span class="hljs-keyword">return</span> success_count &gt;= <span class="hljs-number">3</span>  <span class="hljs-comment"># 多数成功</span>
</code></pre>
<hr/>
<h4 data-id="heading-7">2.4 Redisson 框架（推荐方案）</h4>
<p><strong>步骤</strong>：</p>
<ol>
<li><strong>添加 Maven 依赖</strong>：</li>
</ol>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.redisson<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>redisson-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.27.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<ol start="2">
<li><strong>配置 Redis（application.yml）</strong>：</li>
</ol>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">redis:</span>
    <span class="hljs-attr">host:</span> <span class="hljs-string">localhost</span>
    <span class="hljs-attr">port:</span> <span class="hljs-number">6379</span>
    <span class="hljs-attr">timeout:</span> <span class="hljs-string">2000ms</span>
</code></pre>
<ol start="3">
<li><strong>使用 RLock</strong>：</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.redisson.api.RLock;
<span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Service;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redissonClient;

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processOrder</span><span class="hljs-params">(String orderId)</span> {
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(<span class="hljs-string">"order_lock:"</span> + orderId);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">boolean</span> <span class="hljs-variable">isLocked</span> <span class="hljs-operator">=</span> lock.tryLock(<span class="hljs-number">30</span>, <span class="hljs-number">30</span>, TimeUnit.SECONDS);
            <span class="hljs-keyword">if</span> (!isLocked) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"获取锁失败"</span>);
            }
            <span class="hljs-comment">// 业务逻辑</span>
        } <span class="hljs-keyword">catch</span> (InterruptedException e) {
            Thread.currentThread().interrupt();
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }
}
</code></pre>
<hr/>
<h4 data-id="heading-8">2.5 Spring Boot 注解方式实现</h4>
<h5 data-id="heading-9">2.5.1 实现原理</h5>
<p>通过 <strong>自定义注解 + AOP 切面</strong> 实现分布式锁的自动加锁/解锁，结合 Redisson 的 <code>RLock</code> 提供可重入锁、自动续期等功能。</p>
<hr/>
<h5 data-id="heading-10">2.5.2 实现步骤</h5>
<h6 data-id="heading-11">1. 定义自定义注解</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.lang.annotation.*;

<span class="hljs-meta">@Target(ElementType.METHOD)</span>
<span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Documented</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> DistributedLock {
    String <span class="hljs-title function_">value</span><span class="hljs-params">()</span>; <span class="hljs-comment">// 锁 key 的 SpEL 表达式（如 #userId）</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">waitTime</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">30</span>; <span class="hljs-comment">// 等待加锁时间（秒）</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">leaseTime</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-number">30</span>; <span class="hljs-comment">// 锁持有时间（秒）</span>
}
</code></pre>
<hr/>
<h6 data-id="heading-12">2. 实现 AOP 切面</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.aspectj.lang.ProceedingJoinPoint;
<span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Around;
<span class="hljs-keyword">import</span> org.aspectj.lang.annotation.Aspect;
<span class="hljs-keyword">import</span> org.redisson.api.RLock;
<span class="hljs-keyword">import</span> org.redisson.api.RedissonClient;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.expression.ExpressionParser;
<span class="hljs-keyword">import</span> org.springframework.expression.spel.standard.SpelExpressionParser;
<span class="hljs-keyword">import</span> org.springframework.expression.spel.support.StandardEvaluationContext;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-meta">@Aspect</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DistributedLockAspect</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redissonClient;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExpressionParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpelExpressionParser</span>();

    <span class="hljs-meta">@Around("@annotation(distributedLock)")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">around</span><span class="hljs-params">(ProceedingJoinPoint pjp, DistributedLock distributedLock)</span> <span class="hljs-keyword">throws</span> Throwable {
        <span class="hljs-comment">// 解析 SpEL 表达式获取锁 key</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">lockKey</span> <span class="hljs-operator">=</span> parseSpEL(distributedLock.value(), pjp.getArgs());
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(lockKey);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 尝试加锁</span>
            <span class="hljs-type">boolean</span> <span class="hljs-variable">isLocked</span> <span class="hljs-operator">=</span> lock.tryLock(distributedLock.waitTime(), distributedLock.leaseTime(), TimeUnit.SECONDS);
            <span class="hljs-keyword">if</span> (!isLocked) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"获取分布式锁超时"</span>);
            }
            <span class="hljs-keyword">return</span> pjp.proceed(); <span class="hljs-comment">// 执行目标方法</span>
        } <span class="hljs-keyword">finally</span> {
            lock.unlock(); <span class="hljs-comment">// 释放锁</span>
        }
    }

    <span class="hljs-comment">// 解析 SpEL 表达式</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">parseSpEL</span><span class="hljs-params">(String expression, Object[] args)</span> {
        <span class="hljs-type">StandardEvaluationContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StandardEvaluationContext</span>();
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; args.length; i++) {
            context.setVariable(<span class="hljs-string">"arg"</span> + i, args[i]);
        }
        <span class="hljs-keyword">return</span> parser.parseExpression(expression).getValue(context, String.class);
    }
}
</code></pre>
<hr/>
<h6 data-id="heading-13">3. 配置 Spring Boot 启用 AOP</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.context.annotation.Configuration;
<span class="hljs-keyword">import</span> org.springframework.context.annotation.EnableAspectJAutoProxy;

<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableAspectJAutoProxy(exposeProxy = true)</span> <span class="hljs-comment">// 必须启用 exposeProxy</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AopConfig</span> {
}
</code></pre>
<hr/>
<h6 data-id="heading-14">4. 使用示例</h6>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-meta">@DistributedLock(value = "#userId", waitTime = 10, leaseTime = 30)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(String userId)</span> {
        <span class="hljs-comment">// 业务逻辑（无需手动加锁）</span>
    }
}
</code></pre>
<hr/>
<h5 data-id="heading-15">2.5.3 注解失效的常见场景</h5>



































<table><thead><tr><th>场景</th><th>原因</th><th>解决方案</th></tr></thead><tbody><tr><td><strong>1. 同类方法调用</strong></td><td>AOP 代理失效（Spring 无法拦截内部调用）</td><td>使用 <code>((OrderService) AopContext.currentProxy()).createOrder(userId)</code></td></tr><tr><td><strong>2. 未启用 AOP</strong></td><td>未配置 <code>@EnableAspectJAutoProxy</code> 或未扫描切面类</td><td>添加 <code>@EnableAspectJAutoProxy</code> 并确保切面类被 Spring 扫描</td></tr><tr><td><strong>3. 事务传播行为不匹配</strong></td><td><code>@Transactional</code> 方法嵌套调用导致锁提前释放</td><td>为分布式锁方法单独开启新事务（<code>@Transactional(propagation = Propagation.REQUIRES_NEW)</code>）</td></tr><tr><td><strong>4. 异常未捕获</strong></td><td>方法抛出异常后未正确释放锁</td><td>在 <code>finally</code> 块中释放锁（Redisson 已自动处理）</td></tr><tr><td><strong>5. SpEL 表达式错误</strong></td><td><code>value</code> 中的 SpEL 表达式解析失败（如 <code>#userId</code> 不存在）</td><td>检查方法参数名是否匹配，或使用 <code>args[0]</code> 代替 <code>#userId</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-16">3. 优缺点对比</h3>



























































<table><thead><tr><th>方案</th><th>互斥性</th><th>自动续期</th><th>可重入</th><th>高可用</th><th>性能</th><th>适用场景</th></tr></thead><tbody><tr><td><strong>SET 命令</strong></td><td>✅</td><td>❌</td><td>❌</td><td>❌</td><td>⭐⭐⭐⭐⭐</td><td>低并发、简单业务</td></tr><tr><td><strong>StringRedisTemplate</strong></td><td>✅</td><td>❌</td><td>❌</td><td>❌</td><td>⭐⭐⭐⭐</td><td>Spring Boot 项目</td></tr><tr><td><strong>Redlock</strong></td><td>✅</td><td>❌</td><td>❌</td><td>✅</td><td>⭐⭐⭐</td><td>高并发、强一致性要求</td></tr><tr><td><strong>Redisson</strong></td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>⭐⭐⭐⭐</td><td>复杂业务、Java 项目</td></tr><tr><td><strong>注解方式</strong></td><td>✅</td><td>✅</td><td>✅</td><td>✅</td><td>⭐⭐⭐⭐</td><td>快速开发、Spring Boot</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-17">4. 失效情况分析与解决方案</h3>
<h4 data-id="heading-18">4.1 死锁（Lock Not Released）</h4>
<ul>
<li><strong>原因</strong>：客户端异常崩溃未释放锁。</li>
<li><strong>解决方案</strong>：设置合理的 TTL（如 30s），或使用 Redisson 的 Watchdog 自动续期。</li>
</ul>
<h4 data-id="heading-19">4.2 误删他人锁（Wrong Unlock）</h4>
<ul>
<li><strong>原因</strong>：未校验锁持有者身份直接 <code>DEL</code>。</li>
<li><strong>解决方案</strong>：加锁时写入唯一标识，解锁时用 Lua 脚本校验。</li>
</ul>
<h4 data-id="heading-20">4.3 主从切换丢锁</h4>
<ul>
<li><strong>原因</strong>：主节点宕机后从节点未同步锁信息。</li>
<li><strong>解决方案</strong>：使用 Redlock 或改用 CP 系统（如 ZooKeeper）。</li>
</ul>
<h4 data-id="heading-21">4.4 业务执行时间 &gt; TTL</h4>
<ul>
<li><strong>原因</strong>：锁自动释放导致重复执行。</li>
<li><strong>解决方案</strong>：引入 Watchdog 自动续期（Redisson 默认支持）。</li>
</ul>
<h4 data-id="heading-22">4.5 注解失效的典型场景</h4>
<h5 data-id="heading-23">场景 1：同类方法调用导致锁失效</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-meta">@DistributedLock(value = "#userId")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(String userId)</span> {
        <span class="hljs-comment">// 业务逻辑</span>
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchCreateOrders</span><span class="hljs-params">(String userId)</span> {
        createOrder(userId); <span class="hljs-comment">// ❌ 同类调用，AOP 代理失效</span>
    }
}
</code></pre>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchCreateOrders</span><span class="hljs-params">(String userId)</span> {
    ((OrderService) AopContext.currentProxy()).createOrder(userId); <span class="hljs-comment">// ✅ 通过代理调用</span>
}
</code></pre>
<h5 data-id="heading-24">场景 2：事务传播行为导致锁提前释放</h5>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-meta">@DistributedLock(value = "#userId")</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(String userId)</span> {
        <span class="hljs-comment">// 业务逻辑</span>
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">processOrder</span><span class="hljs-params">(String userId)</span> {
        createOrder(userId); <span class="hljs-comment">// ❌ 同事务中调用，锁可能提前释放</span>
    }
}
</code></pre>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRES_NEW)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(String userId)</span> {
    <span class="hljs-comment">// 独立事务</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-25">5. 最佳实践案例</h3>
<h4 data-id="heading-26">场景：秒杀系统扣库存（Redisson + Spring Boot）</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SeckillService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedissonClient redissonClient;

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">seckill</span><span class="hljs-params">(String productId, String userId)</span> {
        <span class="hljs-type">RLock</span> <span class="hljs-variable">lock</span> <span class="hljs-operator">=</span> redissonClient.getLock(<span class="hljs-string">"seckill_lock:"</span> + productId);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">boolean</span> <span class="hljs-variable">isLocked</span> <span class="hljs-operator">=</span> lock.tryLock(<span class="hljs-number">3</span>, <span class="hljs-number">30</span>, TimeUnit.SECONDS);
            <span class="hljs-keyword">if</span> (!isLocked) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">"系统繁忙，请稍后"</span>;
            }
            <span class="hljs-comment">// 双重检查库存</span>
            <span class="hljs-type">Integer</span> <span class="hljs-variable">stock</span> <span class="hljs-operator">=</span> stockService.getStock(productId);
            <span class="hljs-keyword">if</span> (stock &lt;= <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">return</span> <span class="hljs-string">"库存不足"</span>;
            }
            stockService.deduct(productId);
            createOrder(productId, userId);
            <span class="hljs-keyword">return</span> <span class="hljs-string">"秒杀成功"</span>;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">"秒杀失败"</span>;
        } <span class="hljs-keyword">finally</span> {
            lock.unlock();
        }
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-27">6. 总结</h3>
<ul>
<li><strong>优先选择 Redisson</strong>：内置自动续期、可重入、高可用，适合复杂业务。</li>
<li><strong>Spring Boot 项目推荐 StringRedisTemplate</strong>：简化配置，兼容性强。</li>
<li><strong>注解方式实现</strong>：通过 AOP 切面 + Redisson 提供开箱即用的分布式锁能力，简化代码逻辑。</li>
<li><strong>避免手写锁</strong>：非原子操作、未校验持有者等常见误区易导致严重问题。</li>
<li><strong>锁粒度要细</strong>：如按商品 ID、用户 ID 维度加锁，提升并发度。</li>
<li><strong>结合幂等性设计</strong>：即使锁失效，业务逻辑也能通过数据库约束、唯一索引兜底。</li>
</ul>
<blockquote>
<p><strong>一句话原则</strong>：<br/>
<strong>“能不用锁就不用锁，能用数据库约束就不用分布式锁。”</strong></p>
</blockquote>
<hr/>
<blockquote>
<p>作者：Beata - 后端服务架构自由人<br/>
最后更新：2025 年 11 月  30 日
版权声明：本文可自由转载，注明出处即可。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MySQL索引设计原则：明明建了索引为什么还是慢？7条实战原则帮你避坑]]></title>    <link>https://juejin.cn/post/7577691061034008622</link>    <guid>https://juejin.cn/post/7577691061034008622</guid>    <pubDate>2025-11-30T06:21:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577691061034008622" data-draft-id="7577718777482002470" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MySQL索引设计原则：明明建了索引为什么还是慢？7条实战原则帮你避坑"/> <meta itemprop="keywords" content="MySQL"/> <meta itemprop="datePublished" content="2025-11-30T06:21:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="是2的10次方啊"/> <meta itemprop="url" content="https://juejin.cn/user/987803531871175"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MySQL索引设计原则：明明建了索引为什么还是慢？7条实战原则帮你避坑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/987803531871175/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    是2的10次方啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T06:21:06.000Z" title="Sun Nov 30 2025 06:21:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读25分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">MySQL索引设计原则：明明建了索引为什么还是慢？7条实战原则帮你避坑</h2>
<blockquote>
<p><strong>MySQL索引系列文章：</strong></p>
<ul>
<li>📖 <a href="https://juejin.cn/post/7564977973259976730" target="_blank" title="https://juejin.cn/post/7564977973259976730">基础篇：图解MySQL索引：从二叉树到B+树的演进之路</a></li>
<li>📖 <a href="https://juejin.cn/post/7567257202194776091" target="_blank" title="https://juejin.cn/post/7567257202194776091">进阶篇：MySQL索引：SQL性能分析工具详解</a></li>
<li>📖 <a href="https://juejin.cn/post/7570271574348038153" target="_blank" title="https://juejin.cn/post/7570271574348038153">实战篇：MySQL索引优化实战：原则速查与踩坑案例</a></li>
<li>📖 <a href="#" title="#">设计原则篇：MySQL索引设计原则：从理论到实践的完整指南</a> （本文）</li>
</ul>
</blockquote>
<p>掌握了索引的创建和使用技巧后，如何设计出高效、合理的索引？本文将从表级别、字段级别、索引级别三个维度，系统梳理7条核心设计原则，并结合真实业务场景，帮你避免" 索引建了但效果不佳"的常见陷阱。</p>
<p>记得刚工作那会儿，我负责优化一个订单查询接口。明明已经给<code>user_id</code> 建了索引，但查询还是慢得要命。我百思不得其解，直到DBA老哥看了一眼执行计划，淡淡地说："你这索引建得不对，字段顺序有问题。"</p>
<p>那一刻我才明白，<strong>索引不是建了就完事了，设计才是关键</strong>。</p>
<p>你是否也遇到过这样的困惑：</p>
<ul>
<li>明明创建了索引，查询依然很慢？</li>
<li>索引建得太多，写入性能反而下降？</li>
<li>不知道什么时候该建索引，什么时候不该建？</li>
</ul>
<p>索引设计就像盖房子，不是砖头越多越好，而是要<strong>在合适的地方用合适的材料</strong>。本文将从<strong>表→字段→索引</strong> 三个层次，分享7条实战中总结的设计原则，帮你建立完整的索引设计思路。</p>
<hr/>
<h3 data-id="heading-1">一、表级别：何时建立索引？</h3>
<h4 data-id="heading-2">原则1：针对于数据量较大，且查询比较频繁的表建立索引</h4>
<p>索引的收益与表的数据量和查询频率成正比。这个道理很简单：<strong>数据量越大，索引的价值越明显；查询越频繁，索引的回报越高</strong>。</p>
<h5 data-id="heading-3">为什么数据量要"较大"？</h5>
<p>索引不是免费的午餐，它需要占用存储空间，每次写入还要维护索引结构。对于小表（比如只有几条记录的配置表、字典表），全表扫描的成本可能比索引查找还低：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 示例：用户状态字典表（只有5条记录）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_status_dict (
    id <span class="hljs-type">INT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    status_name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>)
);

<span class="hljs-comment">-- 这种场景下，建索引反而增加开销</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_status_name <span class="hljs-keyword">ON</span> user_status_dict(status_name); <span class="hljs-comment">-- ❌ 不推荐</span>

<span class="hljs-comment">-- 对于小表，直接全表扫描即可</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> user_status_dict <span class="hljs-keyword">WHERE</span> status_name <span class="hljs-operator">=</span> <span class="hljs-string">'ACTIVE'</span>;
</code></pre>
<p><strong>经验值</strong>：一般表数据量超过<strong>1000行</strong>，才考虑建立索引。但这个数字不是绝对的，还要看查询频率和业务特点。比如一个只有500行的表，如果每秒查询100次，那建索引也是值得的。</p>
<h5 data-id="heading-4">查询频率的重要性</h5>
<p>即使是大表，如果某个字段极少被查询，建立索引也不划算。我见过有人给一个千万级大表的<code>internal_remark</code> 字段建索引，结果这个字段一个月才查一次，完全是浪费：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 订单表（1000万条记录）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    user_id <span class="hljs-type">BIGINT</span>,
    created_at DATETIME,
    <span class="hljs-comment">-- 某个业务字段，但只在后台统计时偶尔查询</span>
    internal_remark TEXT
);

<span class="hljs-comment">-- ❌ 不推荐：查询频率低，但维护成本高</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_internal_remark <span class="hljs-keyword">ON</span> orders(internal_remark);

<span class="hljs-comment">-- ✅ 推荐：高频查询字段建立索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_created <span class="hljs-keyword">ON</span> orders(user_id, created_at);
</code></pre>
<p><strong>建议</strong>：</p>
<ul>
<li>通过慢查询日志统计SQL执行频次，优先为高频SQL涉及的字段建立索引</li>
<li>对于低频查询场景，可以考虑用<code>LIMIT</code>限制查询范围，或者走异步查询+缓存</li>
</ul>
<hr/>
<h3 data-id="heading-5">二、字段级别：哪些字段适合建索引？</h3>
<h4 data-id="heading-6">原则2：针对于常作为查询条件（WHERE）、排序（ORDER BY）、分组（GROUP BY）操作的字段建立索引</h4>
<p>索引主要有三大应用场景：<strong>过滤（WHERE）、排序（ORDER BY）、分组（GROUP BY）</strong> 。记住这三个场景，基本就能判断哪些字段需要建索引了。</p>
<h5 data-id="heading-7">WHERE 条件字段</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 用户表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_profile (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),
    phone <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
    age <span class="hljs-type">INT</span>,
    city <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
    created_at DATETIME
);

<span class="hljs-comment">-- ✅ 高频WHERE条件字段建立索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_email <span class="hljs-keyword">ON</span> user_profile(email);
<span class="hljs-keyword">CREATE</span> INDEX idx_phone <span class="hljs-keyword">ON</span> user_profile(phone);

<span class="hljs-comment">-- 查询示例</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> user_profile <span class="hljs-keyword">WHERE</span> email <span class="hljs-operator">=</span> <span class="hljs-string">'user@example.com'</span>; <span class="hljs-comment">-- 命中索引</span>
</code></pre>
<h5 data-id="heading-8">ORDER BY 排序字段</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 商品表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> products (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    name <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">200</span>),
    price <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    sales_count <span class="hljs-type">INT</span>,
    created_at DATETIME
);

<span class="hljs-comment">-- ✅ 为排序字段建立索引，避免filesort</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_price <span class="hljs-keyword">ON</span> products(price);
<span class="hljs-keyword">CREATE</span> INDEX idx_sales_created <span class="hljs-keyword">ON</span> products(sales_count <span class="hljs-keyword">DESC</span>, created_at <span class="hljs-keyword">DESC</span>);

<span class="hljs-comment">-- 查询示例：避免临时排序</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> products <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> price <span class="hljs-keyword">ASC</span> LIMIT <span class="hljs-number">20</span>; <span class="hljs-comment">-- 可以利用索引顺序</span>
</code></pre>
<p><strong>注意</strong>：如果<code>ORDER BY</code>和<code>WHERE</code>条件结合，需要设计联合索引：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">-- ✅ 联合索引设计：<span class="hljs-keyword">WHERE</span>在前，<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>在后
CREATE INDEX idx_category_price <span class="hljs-keyword">ON</span> products(category_id, price);

-- 这个查询可以利用索引同时完成过滤和排序
<span class="hljs-keyword">SELECT</span> * <span class="hljs-keyword">FROM</span> products 
<span class="hljs-keyword">WHERE</span> category_id = <span class="hljs-number">100</span> 
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> price ASC 
LIMIT <span class="hljs-number">20</span>;
</code></pre>
<h5 data-id="heading-9">GROUP BY 分组字段</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 订单表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    user_id <span class="hljs-type">BIGINT</span>,
    status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
    amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>),
    created_at DATETIME
);

<span class="hljs-comment">-- ✅ 为GROUP BY字段建立索引，避免临时表排序</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_status_created <span class="hljs-keyword">ON</span> orders(status, created_at);

<span class="hljs-comment">-- 查询示例：按状态分组统计每日订单数</span>
<span class="hljs-keyword">SELECT</span> status, <span class="hljs-type">DATE</span>(created_at) <span class="hljs-keyword">as</span> order_date, <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) 
<span class="hljs-keyword">FROM</span> orders 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> status, <span class="hljs-type">DATE</span>(created_at); 
<span class="hljs-comment">-- 如果设计合理，可以利用索引避免filesort</span>
</code></pre>
<p><strong>踩坑案例</strong>：<code>ORDER BY</code>和<code>GROUP BY</code>混合使用时，需要仔细设计索引顺序：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">-- 订单表索引设计
CREATE INDEX idx_user_status_created <span class="hljs-keyword">ON</span> orders(user_id, status, created_at);

-- ❌ 问题查询：<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>和<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>顺序与索引不完全匹配
<span class="hljs-keyword">SELECT</span> user_id, status, COUNT(*) <span class="hljs-keyword">as</span> order_count
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> user_id = <span class="hljs-number">1001</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> status
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> created_at DESC; -- created_at在<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>之后，可能导致filesort

-- ✅ 优化方案<span class="hljs-number">1</span>：调整索引顺序或SQL写法
<span class="hljs-keyword">SELECT</span> user_id, status, COUNT(*) <span class="hljs-keyword">as</span> order_count
<span class="hljs-keyword">FROM</span> orders
<span class="hljs-keyword">WHERE</span> user_id = <span class="hljs-number">1001</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> status
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> status; -- 与<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>一致，可以利用索引

-- ✅ 优化方案<span class="hljs-number">2</span>：使用子查询分离逻辑
<span class="hljs-keyword">SELECT</span> t.* <span class="hljs-keyword">FROM</span> (
    <span class="hljs-keyword">SELECT</span> user_id, status, COUNT(*) <span class="hljs-keyword">as</span> order_count
    <span class="hljs-keyword">FROM</span> orders
    <span class="hljs-keyword">WHERE</span> user_id = <span class="hljs-number">1001</span>
    <span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> status
) t
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> order_count DESC; -- 在子查询结果上排序
</code></pre>
<hr/>
<h4 data-id="heading-10">原则3：尽量选择区分度高的列建立索引，尽量建立唯一索引，区分度越高，使用索引的效率越高</h4>
<p>索引的选择性（Cardinality）决定了索引的查找效率。简单说，<strong>区分度越高，索引效果越好</strong>。</p>
<h5 data-id="heading-11">什么是区分度？</h5>
<p>区分度 = 不重复的索引值数量 / 表中的总记录数</p>
<ul>
<li><strong>区分度越高</strong>（接近1）：索引效果越好，如主键、唯一字段</li>
<li><strong>区分度越低</strong>（接近0）：索引效果越差，如性别字段、状态字段</li>
</ul>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 示例：用户表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">UNIQUE</span>,  <span class="hljs-comment">-- 区分度：100%</span>
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">UNIQUE</span>,    <span class="hljs-comment">-- 区分度：100%</span>
    gender TINYINT,               <span class="hljs-comment">-- 区分度：~2%（只有男/女）</span>
    status TINYINT                <span class="hljs-comment">-- 区分度：~5%（只有几个状态值）</span>
);

<span class="hljs-comment">-- ✅ 高区分度字段：建立唯一索引</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX uk_username <span class="hljs-keyword">ON</span> users(username);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX uk_email <span class="hljs-keyword">ON</span> users(email);

<span class="hljs-comment">-- ❌ 低区分度字段：不建议单独建立索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_gender <span class="hljs-keyword">ON</span> users(gender); <span class="hljs-comment">-- 不推荐</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_status <span class="hljs-keyword">ON</span> users(status); <span class="hljs-comment">-- 不推荐</span>

<span class="hljs-comment">-- ✅ 但如果需要与其他字段组合查询，可以建立联合索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_status_created <span class="hljs-keyword">ON</span> users(status, created_at);
</code></pre>
<h5 data-id="heading-12">如何计算区分度？</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 计算某个字段的区分度</span>
<span class="hljs-keyword">SELECT</span> 
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> status) <span class="hljs-keyword">as</span> distinct_count,  <span class="hljs-comment">-- 不重复值数量</span>
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> total_count,                    <span class="hljs-comment">-- 总记录数</span>
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> status) <span class="hljs-operator">*</span> <span class="hljs-number">1.0</span> <span class="hljs-operator">/</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> selectivity  <span class="hljs-comment">-- 区分度</span>
<span class="hljs-keyword">FROM</span> orders;

<span class="hljs-comment">-- 输出示例：</span>
<span class="hljs-comment">-- distinct_count: 5</span>
<span class="hljs-comment">-- total_count: 1000000</span>
<span class="hljs-comment">-- selectivity: 0.000005  (区分度极低，不建议单独建索引)</span>
</code></pre>
<p><strong>经验值</strong>（仅供参考）：</p>
<ul>
<li><strong>区分度 &gt; 30%</strong> ：适合建立单列索引</li>
<li><strong>区分度 10% - 30%</strong> ：建议建立联合索引</li>
<li><strong>区分度 &lt; 10%</strong> ：不建议单独建立索引，除非与其他字段组合</li>
</ul>
<h5 data-id="heading-13">唯一索引的优势</h5>
<p>唯一索引不仅能保证数据唯一性，还能带来额外的性能优化：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ✅ 唯一索引：查找时可以立即停止（找到一条即停止）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX uk_order_no <span class="hljs-keyword">ON</span> orders(order_no);
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> order_no <span class="hljs-operator">=</span> <span class="hljs-string">'ORDER20251109001'</span>; <span class="hljs-comment">-- 找到即停止</span>

<span class="hljs-comment">-- 普通索引：需要继续查找是否有重复值（虽然已经找到目标）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_id <span class="hljs-keyword">ON</span> orders(user_id);
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span>; <span class="hljs-comment">-- 需要扫描所有匹配行</span>
</code></pre>
<hr/>
<h4 data-id="heading-14">原则4：如果是字符串类型的字段，字段的长度较长，可以针对于字段的特点，建立前缀索引</h4>
<p>长字符串字段如果建立完整索引，占用空间会很大。比如一个<code>VARCHAR(1000)</code>的URL字段，如果完整索引，每个索引项可能占用1000字节。这时候可以用前缀索引， <strong>只索引前N个字符，在查询性能和存储成本之间找平衡</strong>。</p>
<h5 data-id="heading-15">为什么需要前缀索引？</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 示例：文章表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> articles (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    title <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">500</span>),      <span class="hljs-comment">-- 标题可能很长</span>
    content TEXT,            <span class="hljs-comment">-- 内容很长，不适合建索引</span>
    url <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">1000</span>)        <span class="hljs-comment">-- URL很长</span>
);

<span class="hljs-comment">-- ❌ 完整索引：占用空间大</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_url <span class="hljs-keyword">ON</span> articles(url); <span class="hljs-comment">-- 每个索引项可能占用1000字节</span>

<span class="hljs-comment">-- ✅ 前缀索引：节省空间</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_url_prefix <span class="hljs-keyword">ON</span> articles(url(<span class="hljs-number">50</span>)); <span class="hljs-comment">-- 只索引前50个字符</span>
</code></pre>
<h5 data-id="heading-16">如何确定前缀长度？</h5>
<p>通过计算不同前缀长度的区分度，选择最合适的长度：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 方法1：逐步测试不同前缀长度的区分度</span>
<span class="hljs-keyword">SELECT</span> 
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">LEFT</span>(url, <span class="hljs-number">10</span>)) <span class="hljs-operator">/</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> prefix_10_selectivity,
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">LEFT</span>(url, <span class="hljs-number">20</span>)) <span class="hljs-operator">/</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> prefix_20_selectivity,
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">LEFT</span>(url, <span class="hljs-number">50</span>)) <span class="hljs-operator">/</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> prefix_50_selectivity,
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-keyword">DISTINCT</span> <span class="hljs-keyword">LEFT</span>(url, <span class="hljs-number">100</span>)) <span class="hljs-operator">/</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> prefix_100_selectivity
<span class="hljs-keyword">FROM</span> articles;

<span class="hljs-comment">-- 输出示例：</span>
<span class="hljs-comment">-- prefix_10_selectivity: 0.8500  (85%的区分度)</span>
<span class="hljs-comment">-- prefix_20_selectivity: 0.9500  (95%的区分度)</span>
<span class="hljs-comment">-- prefix_50_selectivity: 0.9950  (99.5%的区分度)</span>
<span class="hljs-comment">-- prefix_100_selectivity: 0.9990 (99.9%的区分度，但空间开销大)</span>

<span class="hljs-comment">-- 根据业务需求选择：如果95%的区分度已足够，选择前缀长度20</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_url_prefix <span class="hljs-keyword">ON</span> articles(url(<span class="hljs-number">20</span>));
</code></pre>
<h5 data-id="heading-17">前缀索引的局限性</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ❌ 前缀索引无法用于ORDER BY和GROUP BY</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> articles <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> url; <span class="hljs-comment">-- 无法利用前缀索引完成排序</span>

<span class="hljs-comment">-- ❌ 前缀索引无法用于覆盖索引</span>
<span class="hljs-comment">-- 如果查询需要完整的url值，仍然需要回表</span>
<span class="hljs-keyword">SELECT</span> url <span class="hljs-keyword">FROM</span> articles <span class="hljs-keyword">WHERE</span> url <span class="hljs-keyword">LIKE</span> <span class="hljs-string">'https://example.com%'</span>;
<span class="hljs-comment">-- 即使命中前缀索引，由于索引只存储了前N个字符，仍需回表获取完整url</span>
</code></pre>
<p><strong>建议</strong>：</p>
<ul>
<li>前缀长度选择：区分度达到90%以上即可，不用追求100%</li>
<li>常见场景：邮箱、URL、身份证号等长字符串字段</li>
<li>注意权衡：查询性能 vs 存储空间 vs 索引维护成本，没有标准答案，看业务需求</li>
</ul>
<hr/>
<h3 data-id="heading-18">三、索引级别：如何设计索引结构？</h3>
<h4 data-id="heading-19">原则5：尽量使用联合索引，减少单列索引，查询时，联合索引很多时候可以覆盖索引，节省存储空间，避免回表，提高查询效率</h4>
<p>联合索引可以同时满足多个查询条件，还能实现覆盖索引优化。<strong>一个联合索引往往能顶多个单列索引</strong>，既省空间又提性能。</p>
<h5 data-id="heading-20">联合索引 vs 多个单列索引</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 订单表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    user_id <span class="hljs-type">BIGINT</span>,
    status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
    created_at DATETIME,
    amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>)
);

<span class="hljs-comment">-- ❌ 方案1：多个单列索引（不推荐）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_id <span class="hljs-keyword">ON</span> orders(user_id);
<span class="hljs-keyword">CREATE</span> INDEX idx_status <span class="hljs-keyword">ON</span> orders(status);
<span class="hljs-keyword">CREATE</span> INDEX idx_created_at <span class="hljs-keyword">ON</span> orders(created_at);

<span class="hljs-comment">-- 问题1：存储空间大（每个索引都是独立的B+树）</span>
<span class="hljs-comment">-- 问题2：查询多条件时，可能只使用其中一个索引</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders 
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span> <span class="hljs-keyword">AND</span> created_at <span class="hljs-operator">&gt;</span> <span class="hljs-string">'2025-01-01'</span>;
<span class="hljs-comment">-- 优化器可能只选择其中一个索引，其他条件需要回表过滤</span>

<span class="hljs-comment">-- ✅ 方案2：联合索引（推荐）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_status_created <span class="hljs-keyword">ON</span> orders(user_id, status, created_at);

<span class="hljs-comment">-- 优势1：一次索引查找可以满足多个条件</span>
<span class="hljs-comment">-- 优势2：如果查询字段都在索引中，可以实现覆盖索引</span>
<span class="hljs-keyword">SELECT</span> user_id, status, created_at 
<span class="hljs-keyword">FROM</span> orders 
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span>;
<span class="hljs-comment">-- Extra: Using index（覆盖索引，无需回表）</span>
</code></pre>
<h5 data-id="heading-21">联合索引的覆盖索引优势</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 用户行为表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> user_actions (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    user_id <span class="hljs-type">BIGINT</span>,
    action_type <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
    created_at DATETIME,
    action_detail TEXT  <span class="hljs-comment">-- 大字段，存储在数据页</span>
);

<span class="hljs-comment">-- 联合索引设计</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_action_created <span class="hljs-keyword">ON</span> user_actions(user_id, action_type, created_at);

<span class="hljs-comment">-- ✅ 覆盖索引查询：无需回表</span>
<span class="hljs-keyword">SELECT</span> user_id, action_type, created_at 
<span class="hljs-keyword">FROM</span> user_actions 
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> action_type <span class="hljs-operator">=</span> <span class="hljs-string">'LOGIN'</span>;
<span class="hljs-comment">-- Explain结果：Extra = "Using index"</span>

<span class="hljs-comment">-- ❌ 非覆盖索引查询：需要回表</span>
<span class="hljs-keyword">SELECT</span> user_id, action_type, created_at, action_detail 
<span class="hljs-keyword">FROM</span> user_actions 
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> action_type <span class="hljs-operator">=</span> <span class="hljs-string">'LOGIN'</span>;
<span class="hljs-comment">-- Explain结果：Extra = "Using index condition"（需要回表读取action_detail）</span>
</code></pre>
<p><strong>性能对比</strong>：</p>





























<table><thead><tr><th>场景</th><th>单列索引</th><th>联合索引（覆盖）</th><th>性能提升</th></tr></thead><tbody><tr><td>存储空间</td><td>3个独立索引</td><td>1个联合索引</td><td>节省约60%空间</td></tr><tr><td>查询耗时</td><td>回表读取</td><td>无需回表</td><td>减少50-80%IO</td></tr><tr><td>索引维护</td><td>3次维护</td><td>1次维护</td><td>写入性能提升</td></tr></tbody></table>
<h5 data-id="heading-22">联合索引的设计顺序</h5>
<p>联合索引的列顺序非常重要，遵循<strong>最左前缀原则</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 索引：idx_user_status_created (user_id, status, created_at)</span>

<span class="hljs-comment">-- ✅ 可以利用索引</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span> <span class="hljs-keyword">AND</span> created_at <span class="hljs-operator">&gt;</span> <span class="hljs-string">'2025-01-01'</span>;

<span class="hljs-comment">-- ❌ 无法利用索引（跳过最左列）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span>;
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> created_at <span class="hljs-operator">&gt;</span> <span class="hljs-string">'2025-01-01'</span>;

<span class="hljs-comment">-- ⚠️ 部分利用索引（只能用到user_id）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> created_at <span class="hljs-operator">&gt;</span> <span class="hljs-string">'2025-01-01'</span>;
</code></pre>
<p><strong>设计原则</strong>：</p>
<ol>
<li><strong>WHERE条件频率</strong>：将最常作为查询条件的列放在最前面</li>
<li><strong>选择性高低</strong>：将区分度高的列放在前面</li>
<li><strong>等值 vs 范围</strong>：等值查询列在前，范围查询列在后</li>
<li><strong>排序需求</strong>：如果需要<code>ORDER BY</code>，将排序字段放在索引末尾</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 实战案例：设计一个电商订单查询索引</span>

<span class="hljs-comment">-- 查询场景1：根据用户ID查询（90%的查询）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> created_at <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- 查询场景2：根据用户ID和状态查询（8%的查询）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span>;

<span class="hljs-comment">-- 查询场景3：根据用户ID和日期范围查询（2%的查询）</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> created_at <span class="hljs-keyword">BETWEEN</span> <span class="hljs-string">'2025-01-01'</span> <span class="hljs-keyword">AND</span> <span class="hljs-string">'2025-01-31'</span>;

<span class="hljs-comment">-- ✅ 推荐索引设计</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_status_created <span class="hljs-keyword">ON</span> orders(user_id, status, created_at <span class="hljs-keyword">DESC</span>);

<span class="hljs-comment">-- 理由：</span>
<span class="hljs-comment">-- 1. user_id 放在最前面（最高频查询条件）</span>
<span class="hljs-comment">-- 2. status 放在中间（选择性较高，且常与user_id组合查询）</span>
<span class="hljs-comment">-- 3. created_at 放在最后（支持范围查询和排序，DESC匹配业务需求）</span>
</code></pre>
<hr/>
<h4 data-id="heading-23">原则6：要控制索引的数量，索引并不是多多益善，索引越多，维护索引结构的代价也就越大，会影响增删改的效率</h4>
<p>索引是一把双刃剑。<strong>建多了，查询快但写入慢；建少了，写入快但查询慢</strong>。关键是要找到平衡点。</p>
<h5 data-id="heading-24">索引对写入性能的影响</h5>
<p>每次<code>INSERT</code>、<code>UPDATE</code>、<code>DELETE</code>操作，都需要维护相关索引：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 用户表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">UNIQUE</span>,
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">UNIQUE</span>,
    phone <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),
    age <span class="hljs-type">INT</span>,
    city <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
    status TINYINT,
    created_at DATETIME,
    updated_at DATETIME
);

<span class="hljs-comment">-- ❌ 过度索引：为每个字段都建立索引</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX uk_username <span class="hljs-keyword">ON</span> users(username);
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">UNIQUE</span> INDEX uk_email <span class="hljs-keyword">ON</span> users(email);
<span class="hljs-keyword">CREATE</span> INDEX idx_phone <span class="hljs-keyword">ON</span> users(phone);
<span class="hljs-keyword">CREATE</span> INDEX idx_age <span class="hljs-keyword">ON</span> users(age);
<span class="hljs-keyword">CREATE</span> INDEX idx_city <span class="hljs-keyword">ON</span> users(city);
<span class="hljs-keyword">CREATE</span> INDEX idx_status <span class="hljs-keyword">ON</span> users(status);
<span class="hljs-keyword">CREATE</span> INDEX idx_created <span class="hljs-keyword">ON</span> users(created_at);
<span class="hljs-keyword">CREATE</span> INDEX idx_updated <span class="hljs-keyword">ON</span> users(updated_at);
<span class="hljs-comment">-- 总共8个索引（包括主键）</span>

<span class="hljs-comment">-- 写入性能测试</span>
<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> users (username, email, phone, age, city, status) 
<span class="hljs-keyword">VALUES</span> (<span class="hljs-string">'user1'</span>, <span class="hljs-string">'user1@example.com'</span>, <span class="hljs-string">'13800138000'</span>, <span class="hljs-number">25</span>, <span class="hljs-string">'Beijing'</span>, <span class="hljs-number">1</span>);
<span class="hljs-comment">-- 需要维护：主键索引 + 8个二级索引 = 9次索引更新</span>
<span class="hljs-comment">-- 写入耗时：~15ms</span>
</code></pre>
<p><strong>性能影响分析</strong>：</p>








































<table><thead><tr><th>索引数量</th><th>INSERT耗时</th><th>UPDATE耗时</th><th>DELETE耗时</th><th>索引维护成本</th></tr></thead><tbody><tr><td>1个（主键）</td><td>2ms</td><td>2ms</td><td>2ms</td><td>低</td></tr><tr><td>3个索引</td><td>5ms</td><td>6ms</td><td>5ms</td><td>中</td></tr><tr><td>5个索引</td><td>10ms</td><td>12ms</td><td>10ms</td><td>中高</td></tr><tr><td>8个索引</td><td>15ms</td><td>18ms</td><td>15ms</td><td>高</td></tr></tbody></table>
<h5 data-id="heading-25">如何控制索引数量？</h5>
<p><strong>策略1：合并单列索引为联合索引</strong></p>
<pre><code class="hljs language-scss" lang="scss">-- ❌ 不推荐：多个单列索引
CREATE INDEX idx_user_id ON <span class="hljs-built_in">orders</span>(user_id);
CREATE INDEX idx_status ON <span class="hljs-built_in">orders</span>(status);
CREATE INDEX idx_created_at ON <span class="hljs-built_in">orders</span>(created_at);

-- ✅ 推荐：合并为联合索引（如果经常组合查询）
CREATE INDEX idx_user_status_created ON <span class="hljs-built_in">orders</span>(user_id, status, created_at);
</code></pre>
<p><strong>策略2：删除低频使用的索引</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 查询索引使用情况（MySQL 5.7+）</span>
<span class="hljs-keyword">SELECT</span> 
    OBJECT_SCHEMA,
    OBJECT_NAME,
    INDEX_NAME,
    COUNT_FETCH,
    COUNT_INSERT,
    COUNT_UPDATE,
    COUNT_DELETE
<span class="hljs-keyword">FROM</span> performance_schema.table_io_waits_summary_by_index_usage
<span class="hljs-keyword">WHERE</span> OBJECT_SCHEMA <span class="hljs-operator">=</span> <span class="hljs-string">'your_database'</span>
  <span class="hljs-keyword">AND</span> OBJECT_NAME <span class="hljs-operator">=</span> <span class="hljs-string">'orders'</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> COUNT_FETCH <span class="hljs-keyword">DESC</span>;

<span class="hljs-comment">-- 如果某个索引的COUNT_FETCH为0或很小，考虑删除</span>
<span class="hljs-comment">-- 注意：需要观察一段时间，避免删除季节性查询使用的索引</span>
</code></pre>
<p><strong>策略3：为不同业务场景设计不同索引</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 订单表：同时支持C端用户查询和B端运营查询</span>

<span class="hljs-comment">-- C端查询场景（高频）：用户查看自己的订单</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_status_created <span class="hljs-keyword">ON</span> orders(user_id, status, created_at <span class="hljs-keyword">DESC</span>);

<span class="hljs-comment">-- B端查询场景（低频）：运营按状态查询所有订单</span>
<span class="hljs-comment">-- 如果频率不高，可以不建索引，或使用其他优化手段（如分区表、ES等）</span>
<span class="hljs-comment">-- 如果必须建，考虑建立单独的索引，但需要评估写入性能影响</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_status_created <span class="hljs-keyword">ON</span> orders(status, created_at <span class="hljs-keyword">DESC</span>);
</code></pre>
<p><strong>经验值</strong>（仅供参考）：</p>
<ul>
<li><strong>单表索引数量控制在5-7个以内</strong>，更容易管理和维护</li>
<li><strong>核心业务表</strong>：可以适当放宽到8-10个，但需要严格监控写入性能</li>
<li><strong>配置表/日志表</strong>：建议不超过3个索引，毕竟写入频率高</li>
</ul>
<h5 data-id="heading-26">索引维护成本的量化</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 监控索引维护成本</span>
<span class="hljs-comment">-- 1. 查看表的总索引大小</span>
<span class="hljs-keyword">SELECT</span> 
    table_name,
    ROUND(<span class="hljs-built_in">SUM</span>(index_length) <span class="hljs-operator">/</span> <span class="hljs-number">1024</span> <span class="hljs-operator">/</span> <span class="hljs-number">1024</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> index_size_mb,
    ROUND(<span class="hljs-built_in">SUM</span>(data_length) <span class="hljs-operator">/</span> <span class="hljs-number">1024</span> <span class="hljs-operator">/</span> <span class="hljs-number">1024</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> data_size_mb,
    ROUND(<span class="hljs-built_in">SUM</span>(index_length) <span class="hljs-operator">/</span> <span class="hljs-built_in">SUM</span>(data_length) <span class="hljs-operator">*</span> <span class="hljs-number">100</span>, <span class="hljs-number">2</span>) <span class="hljs-keyword">AS</span> index_ratio_percent
<span class="hljs-keyword">FROM</span> information_schema.tables
<span class="hljs-keyword">WHERE</span> table_schema <span class="hljs-operator">=</span> <span class="hljs-string">'your_database'</span>
  <span class="hljs-keyword">AND</span> table_name <span class="hljs-operator">=</span> <span class="hljs-string">'orders'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> table_name;

<span class="hljs-comment">-- 如果index_ratio_percent &gt; 50%，说明索引占用空间过大，需要优化</span>

<span class="hljs-comment">-- 2. 监控写入性能</span>
<span class="hljs-comment">-- 通过慢查询日志或performance_schema监控INSERT/UPDATE/DELETE的耗时</span>
</code></pre>
<hr/>
<h4 data-id="heading-27">原则7：如果索引列不能存储NULL值，请在创建表时使用NOT NULL约束它。当优化器知道每列是否包含NULL值时，它可以更好地确定哪个索引最有效地用于查询</h4>
<p><code>NOT NULL</code>约束不仅能保证数据完整性，还能帮助优化器做出更好的索引选择决策。**优化器知道字段不会有NULL值，就能更准确地估算查询成本，选择最优索引 **。</p>
<h5 data-id="heading-28">NULL值对索引的影响</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ❌ 允许NULL值的索引</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>),
    phone <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>)  <span class="hljs-comment">-- 允许NULL</span>
);

<span class="hljs-keyword">CREATE</span> INDEX idx_phone <span class="hljs-keyword">ON</span> users(phone);

<span class="hljs-comment">-- 问题1：NULL值在索引中的存储</span>
<span class="hljs-comment">-- B+树索引中，NULL值通常会被特殊处理，可能影响索引的紧凑性</span>

<span class="hljs-comment">-- 问题2：查询时需要额外判断NULL</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> phone <span class="hljs-operator">=</span> <span class="hljs-string">'13800138000'</span>;
<span class="hljs-comment">-- 如果phone字段允许NULL，查询计划可能需要考虑NULL值的情况</span>

<span class="hljs-comment">-- 问题3：统计信息可能不够准确</span>
<span class="hljs-comment">-- NULL值的存在可能影响索引的选择性统计，导致优化器选择错误的索引</span>
</code></pre>
<h5 data-id="heading-29">NOT NULL的优化优势</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- ✅ 使用NOT NULL约束</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    username <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    email <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    phone <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,  <span class="hljs-comment">-- 明确不允许NULL</span>
    age <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
    status TINYINT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span>
);

<span class="hljs-keyword">CREATE</span> INDEX idx_phone <span class="hljs-keyword">ON</span> users(phone);
<span class="hljs-keyword">CREATE</span> INDEX idx_status_age <span class="hljs-keyword">ON</span> users(status, age);

<span class="hljs-comment">-- 优势1：优化器可以更准确地估算索引选择性</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> phone <span class="hljs-operator">=</span> <span class="hljs-string">'13800138000'</span>;
<span class="hljs-comment">-- 优化器知道phone字段不会有NULL值，可以更准确地计算查询成本</span>

<span class="hljs-comment">-- 优势2：索引结构更紧凑</span>
<span class="hljs-comment">-- 不需要为NULL值预留空间或特殊处理</span>

<span class="hljs-comment">-- 优势3：查询可以更简单</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> users <span class="hljs-keyword">WHERE</span> phone <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>; <span class="hljs-comment">-- 如果phone是NOT NULL，这个条件永远为真</span>
</code></pre>
<h5 data-id="heading-30">实战案例：优化器选择索引</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 订单表设计对比</span>

<span class="hljs-comment">-- 方案1：允许NULL（不推荐）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders_v1 (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    user_id <span class="hljs-type">BIGINT</span>,           <span class="hljs-comment">-- 允许NULL</span>
    status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>),       <span class="hljs-comment">-- 允许NULL</span>
    created_at DATETIME,      <span class="hljs-comment">-- 允许NULL</span>
    INDEX idx_user_status (user_id, status)
);

<span class="hljs-comment">-- 查询：优化器需要判断NULL值的影响</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders_v1 
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span>;
<span class="hljs-comment">-- 优化器可能认为：如果user_id或status可能为NULL，索引效果可能不佳</span>

<span class="hljs-comment">-- 方案2：使用NOT NULL（推荐）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders_v2 (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY,
    user_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,      <span class="hljs-comment">-- 明确NOT NULL</span>
    status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,  <span class="hljs-comment">-- 明确NOT NULL</span>
    created_at DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>, <span class="hljs-comment">-- 明确NOT NULL</span>
    INDEX idx_user_status (user_id, status)
);

<span class="hljs-comment">-- 查询：优化器可以更自信地使用索引</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders_v2 
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span>;
<span class="hljs-comment">-- 优化器知道所有行都有user_id和status值，可以更准确地选择索引</span>
</code></pre>
<h5 data-id="heading-31">如何为现有表添加NOT NULL约束？</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 步骤1：检查现有数据是否包含NULL值</span>
<span class="hljs-keyword">SELECT</span> 
    <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">as</span> total_rows,
    <span class="hljs-built_in">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> phone <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">THEN</span> <span class="hljs-number">1</span> <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">as</span> null_count
<span class="hljs-keyword">FROM</span> users;

<span class="hljs-comment">-- 步骤2：如果存在NULL值，先更新为默认值</span>
<span class="hljs-keyword">UPDATE</span> users <span class="hljs-keyword">SET</span> phone <span class="hljs-operator">=</span> <span class="hljs-string">''</span> <span class="hljs-keyword">WHERE</span> phone <span class="hljs-keyword">IS</span> <span class="hljs-keyword">NULL</span>;

<span class="hljs-comment">-- 步骤3：添加NOT NULL约束</span>
<span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> users MODIFY <span class="hljs-keyword">COLUMN</span> phone <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">''</span>;

<span class="hljs-comment">-- 步骤4：验证约束生效</span>
<span class="hljs-keyword">SHOW</span> <span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> users;
</code></pre>
<p><strong>建议</strong>：</p>
<ol>
<li><strong>建表时就定义NOT NULL</strong>：避免后续修改的麻烦（改表结构可能锁表）</li>
<li><strong>为NOT NULL字段设置合理的默认值</strong>：如<code>DEFAULT ''</code>、<code>DEFAULT 0</code>、<code>DEFAULT CURRENT_TIMESTAMP</code></li>
<li><strong>业务层面保证数据完整性</strong>：应用层校验 + 数据库约束双重保障，更稳妥</li>
</ol>
<hr/>
<h3 data-id="heading-32">四、索引设计实战：完整案例</h3>
<h4 data-id="heading-33">案例：电商订单系统的索引设计</h4>
<p>假设我们需要设计一个电商订单表的索引，以下是业务场景和SQL查询模式：</p>
<p><strong>业务场景</strong>：</p>
<ul>
<li>
<p>表数据量：1000万+订单</p>
</li>
<li>
<p>写入频率：每秒1000+订单</p>
</li>
<li>
<p>查询场景：</p>
<ol>
<li>用户查看自己的订单列表（按创建时间倒序） - 80%查询</li>
<li>用户按状态筛选订单 - 15%查询</li>
<li>运营按状态统计订单 - 5%查询</li>
</ol>
</li>
</ul>
<p><strong>表结构设计</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
    id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    order_no <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'订单号'</span>,
    user_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'用户ID'</span>,
    status <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'订单状态'</span>,
    total_amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'订单金额'</span>,
    created_at DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'创建时间'</span>,
    updated_at DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'更新时间'</span>,
    INDEX idx_order_no (order_no),
    INDEX idx_user_created (user_id, created_at <span class="hljs-keyword">DESC</span>),
    INDEX idx_user_status_created (user_id, status, created_at <span class="hljs-keyword">DESC</span>)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4;
</code></pre>
<p><strong>索引设计分析</strong>：</p>
<ol>
<li><strong>主键索引</strong>：<code>id</code> - 必须的，用于唯一标识和聚簇索引</li>
<li><strong>唯一索引</strong>：<code>idx_order_no</code> - 订单号查询，区分度高（100%）</li>
<li><strong>联合索引1</strong>：<code>idx_user_created</code> - 覆盖场景1（用户查看订单列表）</li>
<li><strong>联合索引2</strong>：<code>idx_user_status_created</code> - 覆盖场景2（用户按状态筛选）</li>
</ol>
<p><strong>查询场景验证</strong>：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 场景1：用户查看订单列表（命中idx_user_created）</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders 
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> 
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> created_at <span class="hljs-keyword">DESC</span> 
LIMIT <span class="hljs-number">20</span>;
<span class="hljs-comment">-- type: ref, key: idx_user_created, Extra: Using index condition</span>

<span class="hljs-comment">-- 场景2：用户按状态筛选订单（命中idx_user_status_created）</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders 
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span> 
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> created_at <span class="hljs-keyword">DESC</span>;
<span class="hljs-comment">-- type: ref, key: idx_user_status_created, Extra: Using index condition</span>

<span class="hljs-comment">-- 场景3：运营统计（考虑是否需要单独索引）</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> status, <span class="hljs-built_in">COUNT</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">FROM</span> orders 
<span class="hljs-keyword">WHERE</span> created_at <span class="hljs-operator">&gt;=</span> <span class="hljs-string">'2025-01-01'</span> 
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> status;
<span class="hljs-comment">-- 如果频率不高，可以不建索引；如果频率高，考虑建立idx_status_created</span>
</code></pre>
<p><strong>优化建议</strong>：</p>
<ol>
<li><strong>索引数量控制</strong>：当前4个索引（含主键），符合"5-7个"原则</li>
<li><strong>索引合并优化</strong>：<code>idx_user_created</code>和<code>idx_user_status_created</code>有重叠，但为了覆盖不同查询场景，保留两个索引是合理的</li>
<li><strong>覆盖索引优化</strong>：如果查询只需要部分字段，可以调整索引包含的列，实现覆盖索引：</li>
</ol>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 如果查询只需要id、user_id、status、created_at</span>
<span class="hljs-comment">-- 可以设计覆盖索引</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_user_status_created_covering 
<span class="hljs-keyword">ON</span> orders(user_id, status, created_at <span class="hljs-keyword">DESC</span>, id);

<span class="hljs-comment">-- 查询时可以实现覆盖索引</span>
EXPLAIN <span class="hljs-keyword">SELECT</span> id, user_id, status, created_at 
<span class="hljs-keyword">FROM</span> orders 
<span class="hljs-keyword">WHERE</span> user_id <span class="hljs-operator">=</span> <span class="hljs-number">1001</span> <span class="hljs-keyword">AND</span> status <span class="hljs-operator">=</span> <span class="hljs-string">'PAID'</span>;
<span class="hljs-comment">-- Extra: Using index（无需回表）</span>
</code></pre>
<hr/>
<h3 data-id="heading-34">五、索引设计检查清单</h3>
<p>在实际项目中，建议使用以下检查清单来评估索引设计是否合理：</p>
<h4 data-id="heading-35">✅ 表级别检查</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 表数据量是否足够大（&gt;1000行）？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 表是否高频查询？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否评估过索引对写入性能的影响？</li>
</ul>
<h4 data-id="heading-36">✅ 字段级别检查</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否为WHERE条件的字段建立了索引？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否为ORDER BY的字段建立了索引？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否为GROUP BY的字段建立了索引？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 字段区分度是否足够高（&gt;30%）？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 字符串字段是否考虑使用前缀索引？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 索引字段是否设置为NOT NULL？</li>
</ul>
<h4 data-id="heading-37">✅ 索引级别检查</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否优先使用联合索引而非多个单列索引？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 联合索引的列顺序是否遵循最左前缀原则？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否考虑了覆盖索引优化？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 索引数量是否控制在合理范围（5-7个）？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否定期清理低频使用的索引？</li>
</ul>
<h4 data-id="heading-38">✅ 性能验证</h4>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否使用<code>EXPLAIN</code>验证索引使用情况？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否监控索引的查询命中率？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否评估索引对写入性能的影响？</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 是否定期更新表的统计信息（<code>ANALYZE TABLE</code>）？</li>
</ul>
<hr/>
<h3 data-id="heading-39">六、常见误区与避坑指南</h3>
<h4 data-id="heading-40">误区1：为所有字段都建立索引</h4>
<p><strong>错误做法</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">-- ❌ 为每个字段都建立索引
CREATE <span class="hljs-selector-tag">TABLE</span> users (...);
CREATE INDEX idx_field1 ON <span class="hljs-built_in">users</span>(field1);
CREATE INDEX idx_field2 ON <span class="hljs-built_in">users</span>(field2);
CREATE INDEX idx_field3 ON <span class="hljs-built_in">users</span>(field3);
-- ... <span class="hljs-number">10</span>多个索引
</code></pre>
<p><strong>正确做法</strong>：</p>
<ul>
<li>只为核心查询字段建立索引</li>
<li>通过慢查询日志分析真实查询模式</li>
<li>定期审计索引使用情况，删除无用索引</li>
</ul>
<h4 data-id="heading-41">误区2：忽略索引维护成本</h4>
<p><strong>错误做法</strong>：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-deletion">-- ❌ 只看查询性能，忽略写入性能</span>
<span class="hljs-deletion">-- 某个表有15个索引，查询很快，但写入慢如蜗牛</span>
</code></pre>
<p><strong>正确做法</strong>：</p>
<ul>
<li>建立索引前评估写入频率</li>
<li>对于写多读少的表，严格控制索引数量</li>
<li>监控写入性能指标（TPS、延迟）</li>
</ul>
<h4 data-id="heading-42">误区3：联合索引顺序随意设计</h4>
<p><strong>错误做法</strong>：</p>
<pre><code class="hljs language-ini" lang="ini">-- ❌ 不考虑查询模式，随意设计索引顺序
CREATE INDEX idx_created_user_status ON orders(created_at, user_id, status)<span class="hljs-comment">;</span>
-- 但实际查询是 WHERE <span class="hljs-attr">user_id</span> = ? AND status = ?
</code></pre>
<p><strong>正确做法</strong>：</p>
<ul>
<li>分析所有查询SQL，找出最常用的查询模式</li>
<li>按照查询频率和选择性设计索引顺序</li>
<li>使用<code>EXPLAIN</code>验证索引是否被正确使用</li>
</ul>
<h4 data-id="heading-43">误区4：过度依赖覆盖索引</h4>
<p><strong>错误做法</strong>：</p>
<pre><code class="hljs language-lua" lang="lua"><span class="hljs-comment">-- ❌ 为了覆盖索引，把很多字段都加到索引中</span>
CREATE INDEX idx_user_covering ON orders(user_id, <span class="hljs-built_in">status</span>, created_at, amount, ...);
<span class="hljs-comment">-- 索引变得很大，维护成本高</span>
</code></pre>
<p><strong>正确做法</strong>：</p>
<ul>
<li>覆盖索引只包含高频查询的字段</li>
<li>权衡索引大小和维护成本</li>
<li>对于低频查询，可以接受回表操作</li>
</ul>
<hr/>
<h3 data-id="heading-44">七、总结</h3>
<p>索引设计是一个需要<strong>权衡</strong>的过程，没有银弹，只有最适合的方案。本文从<strong>表→字段→索引</strong>三个层次，系统梳理了7条核心设计原则：</p>
<h4 data-id="heading-45">核心原则回顾</h4>
<ol>
<li><strong>表级别</strong>：数据量大且查询频繁的表才建索引</li>
<li><strong>字段级别</strong>：为WHERE/ORDER BY/GROUP BY字段建索引</li>
<li><strong>区分度优先</strong>：选择区分度高的字段，尽量建唯一索引</li>
<li><strong>前缀索引</strong>：长字符串字段使用前缀索引平衡性能和存储</li>
<li><strong>联合索引</strong>：优先使用联合索引，实现覆盖索引优化</li>
<li><strong>控制数量</strong>：索引数量控制在5-7个，平衡查询和写入性能</li>
<li><strong>NOT NULL约束</strong>：索引字段使用NOT NULL，帮助优化器做出更好决策</li>
</ol>
<h4 data-id="heading-46">设计流程建议</h4>
<ol>
<li><strong>需求分析</strong>：收集所有查询SQL，分析查询模式</li>
<li><strong>优先级排序</strong>：按查询频率和重要性排序</li>
<li><strong>索引设计</strong>：根据7条原则设计索引</li>
<li><strong>性能验证</strong>：使用<code>EXPLAIN</code>和性能测试验证效果</li>
<li><strong>持续优化</strong>：定期审计索引使用情况，优化调整</li>
</ol>
<hr/>
<p><strong>记住</strong>：索引是优化数据库性能的重要手段，但不是唯一手段。在设计索引时，要结合业务场景、数据量、查询模式、写入频率等多个因素综合考虑，才能设计出真正高效的索引方案。</p>
<hr/>
<h3 data-id="heading-47">相关文章</h3>
<p>想要系统学习MySQL索引，可以阅读以下文章：</p>
<ul>
<li><strong>索引基础</strong>：<a href="https://juejin.cn/post/7564977973259976730" target="_blank" title="https://juejin.cn/post/7564977973259976730">图解MySQL索引：从二叉树到B+树的演进之路（基础篇）</a></li>
<li><strong>性能分析</strong>：<a href="https://juejin.cn/post/7567257202194776091" target="_blank" title="https://juejin.cn/post/7567257202194776091">MySQL索引：SQL性能分析工具详解（进阶篇）</a></li>
<li><strong>使用技巧</strong>：<a href="https://juejin.cn/post/7570271574348038153" target="_blank" title="https://juejin.cn/post/7570271574348038153">MySQL索引优化实战：原则速查与踩坑案例（实战篇）</a></li>
<li><strong>设计原则</strong>：<a href="#" title="#">MySQL索引设计原则：从理论到实践的完整指南</a> （本文）</li>
</ul>
<h4 data-id="heading-48">扩展阅读</h4>
<ul>
<li><strong>存储引擎</strong>：<a href="https://juejin.cn/post/7552030609582784522" target="_blank" title="https://juejin.cn/post/7552030609582784522">MySQL存储引擎详解：老王教你如何选择合适的"发动机"</a></li>
</ul>
<p>本文使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmarkdown.com.cn" target="_blank" title="https://markdown.com.cn" ref="nofollow noopener noreferrer">markdown.com.cn</a> 排版</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[goup是一个纯Rust编写的优雅的Go多版本管理工具]]></title>    <link>https://juejin.cn/post/7577713754563461172</link>    <guid>https://juejin.cn/post/7577713754563461172</guid>    <pubDate>2025-11-30T06:32:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577713754563461172" data-draft-id="7577713754563444788" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="goup是一个纯Rust编写的优雅的Go多版本管理工具"/> <meta itemprop="keywords" content="Go"/> <meta itemprop="datePublished" content="2025-11-30T06:32:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="5197"/> <meta itemprop="url" content="https://juejin.cn/user/3186802516829016"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            goup是一个纯Rust编写的优雅的Go多版本管理工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3186802516829016/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    5197
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T06:32:29.000Z" title="Sun Nov 30 2025 06:32:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">goup</h2>
<p><em><strong>注意</strong></em>: <code>goup-rs</code>仍在积极开发中, 因此在达到v1.0.0之前不能保证完全向后兼容</p>
<h3 data-id="heading-1">特性</h3>
<ul>
<li>最小依赖, 依赖于<code>git</code>(仅<code>nightly|tip|gotip</code>版本需要<code>git</code>).</li>
<li>跨平台的能力(Linux, macOS &amp; Windows).</li>
<li>支持使用<code>goup install/remove [TOOLCHAIN]</code> 安装/卸载 Go版本.</li>
<li>支持使用<code>goup install &lt;nightly|tip|gotip&gt;</code> 从源码安装Go, 需要<code>git</code>.</li>
<li>支持列出本地已安装的版本.</li>
<li>支持在多个已安装的版本中切换.</li>
<li>支持搜索可用的Go版本.</li>
<li>✨支持在shell会话中使用特定的Go版本(&gt;= v0.15.x).</li>
<li>✨支持多个下载后端<code>GOUP_GO_REGISTRY_INDEX</code>/<code>GOUP_GO_REGISTRY</code>(&gt;=v0.16.x).</li>
<li>支持管理本地缓存文件(如 <code>*.tar.gz</code>, <code>*.tar.gz.sha256</code>).</li>
<li>支持<code>goup</code>自我更新.</li>
<li>支持自定义<code>GOUP_HOME</code>(默认<code>$HOME/.goup</code>)(&gt;= v0.11.x);</li>
<li>友好的提示.</li>
<li>应该很快.</li>
</ul>
<p><code>goup</code> 是对上述特性的一种尝试, 其灵感主要来自于 <a href="https://link.juejin.cn?target=https%3A%2F%2Frustup.rs%2F" target="_blank" title="https://rustup.rs/" ref="nofollow noopener noreferrer">Rustup</a>, <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgolang%2Fdl" target="_blank" title="https://github.com/golang/dl" ref="nofollow noopener noreferrer">golang/dl</a>, <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fowenthereal%2Fgoup" target="_blank" title="https://github.com/owenthereal/goup" ref="nofollow noopener noreferrer">goup</a>, <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsyndbg%2Fgoenv" target="_blank" title="https://github.com/syndbg/goenv" ref="nofollow noopener noreferrer">goenv</a>, <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fmoovweb%2Fgvm" target="_blank" title="https://github.com/moovweb/gvm" ref="nofollow noopener noreferrer">gvm</a> and <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgolang%2Ftools%2Ftree%2Fmaster%2Fcmd%2Fgetgo" target="_blank" title="https://github.com/golang/tools/tree/master/cmd/getgo" ref="nofollow noopener noreferrer">getgo</a>.</p>
<h3 data-id="heading-2">构建功能标志</h3>
<ul>
<li><code>no-self-update</code> 关闭自我更新.</li>
</ul>
<h3 data-id="heading-3">安装</h3>
<h4 data-id="heading-4">使用Cargo</h4>
<p>或者, 也可以使用<code>cargo</code>安装.</p>
<pre><code class="hljs language-shell" lang="shell">cargo install goup-rs
</code></pre>
<p>或</p>
<pre><code class="hljs language-shell" lang="shell">cargo install goup-rs --git https://github.com/thinkgos/goup-rs
</code></pre>
<ul>
<li>(<em>仅支持 Linux/MacOS</em>) 运行<code>goup init</code>, 获取到shell启动脚本位于<code>$HOME/.goup/env</code>.</li>
<li>(<em>仅支持 Linux/MacOS</em>) 在shell启动脚本中添加Go的bin目录:
<ul>
<li>bash: <code>echo '. "$HOME/.goup/env"' &gt;&gt; ~/.bashrc</code></li>
<li>zsh:  <code>echo '. "$HOME/.goup/env"' &gt;&gt; ~/.zshenv</code></li>
<li>fish: <code>echo 'source ~/.goup/env' &gt;&gt; ~/.config/fish/config.fish</code></li>
</ul>
</li>
</ul>
<h4 data-id="heading-5">手动安装(Linux/MacOS)</h4>
<p>如果您想手动安装, 步骤如下:</p>
<ul>
<li>从<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Freleases" target="_blank" title="https://github.com/thinkgos/goup-rs/releases" ref="nofollow noopener noreferrer">Release Page</a>下载最新的<code>goup</code>.</li>
<li>将<code>goup</code>可执行文件放到<code>PATH</code>中, 并给予可执行权限: <code>mv GOUP_BIN /usr/local/bin/goup &amp;&amp; chmod +x /usr/local/bin/goup</code></li>
<li>运行<code>goup init</code>, 获取到shell启动脚本位于<code>$HOME/.goup/env</code>.</li>
<li>在shell启动脚本中添加Go的bin目录:
<ul>
<li>bash: <code>echo '. "$HOME/.goup/env"' &gt;&gt; ~/.bashrc</code></li>
<li>zsh:  <code>echo '. "$HOME/.goup/env"' &gt;&gt; ~/.zshenv</code></li>
<li>fish: <code>echo 'source ~/.goup/env' &gt;&gt; ~/.config/fish/config.fish</code></li>
</ul>
</li>
</ul>
<h4 data-id="heading-6">手动安装(Windows)</h4>
<h5 data-id="heading-7">MSI安装</h5>
<p>从<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Freleases" target="_blank" title="https://github.com/thinkgos/goup-rs/releases" ref="nofollow noopener noreferrer">Release Page</a>下载最新的<code>goup</code>的MSI安装程序并运行.</p>
<h5 data-id="heading-8">二进制安装</h5>
<ul>
<li>从<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Freleases" target="_blank" title="https://github.com/thinkgos/goup-rs/releases" ref="nofollow noopener noreferrer">Release Page</a>下载最新的<code>goup</code>的二进制程序并解压.</li>
<li>将<code>goup.exe</code>移至<code>$YOUR_PATH</code>.</li>
<li>将<code>$YOUR_PATH</code>加到windows环境变量中.</li>
</ul>
<h3 data-id="heading-9">快速入门</h3>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_">$ </span><span class="bash">goup install</span>
[2024-01-30T00:38:48Z INFO ] Installing go1.21.10 ...
[2024-01-30T00:38:48Z INFO ] Unpacking /home/thinkgo/.goup/go1.21.10/go1.21.10.linux-amd64.tar.gz ...
[2024-01-30T00:38:48Z INFO ] go1.21.10 installed in /home/thinkgo/.goup/go1.21.10
[2024-01-30T00:38:48Z INFO ] Default Go is set to 'go1.21.10'
<span class="hljs-meta prompt_">$ </span><span class="bash">goup list</span>
1.21.10  (active, default)
<span class="hljs-meta prompt_">$ </span><span class="bash">go <span class="hljs-built_in">env</span> GOROOT</span>
/home/thinkgo/.goup/current
<span class="hljs-meta prompt_">$ </span><span class="bash">go version</span>
go version go1.21.10 linux/amd64
<span class="hljs-meta prompt_">$ </span><span class="bash">GOUP_GO_REGISTRY_INDEX=https://golang.google.cn goup install =1.21.10</span>
</code></pre>
<h3 data-id="heading-10">使用方法</h3>
<h4 data-id="heading-11">列出所有可用的go版本</h4>
<p><code>goup search [FILTER]</code>, <code>[FILTER]</code>支持的值: <strong>'stable'</strong>, <strong>'unstable'</strong>, <strong>'beta'</strong> 或 <strong>any regex string</strong>.</p>
<pre><code class="hljs language-bash" lang="bash">$ goup search
1
...
1.21rc4
1.22rc1
$ goup search stable
1
...
1.21.4
1.21.5
1.21.10
</code></pre>
<h4 data-id="heading-12">列出所有位于<code>$HOME/.goup</code>已安装的Go版本</h4>
<pre><code class="hljs language-bash" lang="bash">$ goup list 
1.21.10
1.22.3  (active, default)
tip
</code></pre>
<h4 data-id="heading-13">安装指定Go版本</h4>
<p><code>goup install/update [TOOLCHAIN]</code>, <code>[TOOLCHAIN]</code> 支持的值: <strong>'stable'(default)</strong>, <strong>'nightly'</strong>(<strong>'tip'</strong>, <strong>'gotip'</strong>), <strong>'unstable'</strong>, <strong>'beta'</strong> 或 <strong>'=1.21.4'</strong>, <code>--dry</code> 表示只安装对应版本, 但并不切换使用.</p>
<p><code>[TOOLCHAIN]</code> 支持<a href="https://link.juejin.cn?target=https%3A%2F%2Fsemver.org%2F" target="_blank" title="https://semver.org/" ref="nofollow noopener noreferrer"><code>semver</code></a>语法匹配对应版本, 详情查看<a href="#faq" title="#faq">FAQ</a></p>
<pre><code class="hljs language-bash" lang="bash">$ goup install 1.21.*
[2024-01-30T00:38:48Z INFO ] Installing go1.21.10 ...
[2024-01-30T00:38:48Z INFO ] Unpacking /home/thinkgo/.goup/go1.21.10/go1.21.10.linux-amd64.tar.gz ...
[2024-01-30T00:38:48Z INFO ] go1.21.10 installed <span class="hljs-keyword">in</span> /home/thinkgo/.goup/go1.21.10
[2024-01-30T00:38:48Z INFO ] Default Go is <span class="hljs-built_in">set</span> to <span class="hljs-string">'go1.21.10'</span>
$ goup install =1.21.4 --dry
[2024-01-30T00:38:48Z INFO ] Installing go1.21.4 ...
[2024-01-30T00:38:48Z INFO ] Unpacking /home/thinkgo/.goup/go1.21.4/go1.21.4.linux-amd64.tar.gz ...
[2024-01-30T00:38:48Z INFO ] go1.21.10 installed <span class="hljs-keyword">in</span> /home/thinkgo/.goup/go1.21.4
</code></pre>
<h4 data-id="heading-14">切换到选定的Go版本</h4>
<p><code>goup default/use/set [VERSION]</code>, 设置默认的Go版本.</p>
<pre><code class="hljs language-bash" lang="bash">$ goup default 
? Select a version ›
  1.21.5
❯ 1.21.10
  tip
[2024-01-30T00:38:48Z INFO ] Default Go is <span class="hljs-built_in">set</span> to <span class="hljs-string">'go1.21.10'</span>
</code></pre>
<h4 data-id="heading-15">删除指定的 Go 版本列表</h4>
<p><code>goup remove/rm [VERSION]...</code> 删除指定的 Go 版本列表. 如果没有提供版本, 将提示选择多个已安装的 Go 版本</p>
<pre><code class="hljs language-bash" lang="bash">$ goup <span class="hljs-built_in">rm</span>
? Select multiple version ›
✔ 1.21.5
⬚ 1.21.10
⬚ tip
✔ Select multiple version · 1.21.5
</code></pre>
<h4 data-id="heading-16">在shell会话中使用特定的Go版本</h4>
<p><code>goup shell [VERSION]</code>, 在shell会话中使用特定的Go版本, 如果没有提供版本, 将自动检测执行路径下的<code>go.work</code>/<code>go.mod</code>的Go版本(可以使用<code>--skip-autodetect</code>跳过), 仍旧没有的话将提示用户选择一个已安装的Go版本.</p>
<pre><code class="hljs language-bash" lang="bash">$ goup shell 1.21.10
? Select a version ›
  1.21.5
❯ 1.21.10
  tip
$ go version
go version go1.21.10 linux/amd64
$ goup list 
1.21.10
1.22.3  (active, default)
tip
</code></pre>
<h4 data-id="heading-17">管理缓存归档文件</h4>
<pre><code class="hljs language-bash" lang="bash">$ goup cache show --contain-sha256
go1.21.10.linux-amd64.tar.gz
go1.21.10.linux-amd64.tar.gz.sha256

$ goup cache clean
✔ Do you want to clean cache file? · <span class="hljs-built_in">yes</span>
</code></pre>
<h4 data-id="heading-18">修改<code>goup</code>安装程序</h4>
<pre><code class="hljs language-bash" lang="bash">$ goup self update
Checking target-arch... x86_64-unknown-linux-gnu
Checking current version... v0.9.0
Checking latest released version... v0.9.0
[2024-01-30T00:38:48Z INFO ] Update status: `v0.9.0`!
</code></pre>
<h4 data-id="heading-19">环境变量值</h4>
<pre><code class="hljs language-bash" lang="bash">$ goup <span class="hljs-built_in">env</span>
+------------------------+--------------------------------+--------------------------------------------------------------+
| Key                    | Value                          | Explain                                                      |
+------------------------+--------------------------------+--------------------------------------------------------------+
| GOUP_HOME              | /home/thinkgo/.goup            | Get goup home directory, default: <span class="hljs-string">'$HOME/.goup'</span>              |
| GOUP_GO_VERSION        | current                        | Shell session target go version, default: <span class="hljs-string">'current'</span>          |
| GOUP_GO_REGISTRY_INDEX | https://golang.google.cn       | Registry index of go version                                 |
| GOUP_GO_REGISTRY       | https://dl.google.com/go       | Registry of go archive file                                  |
| GOUP_GO_SOURCE_GIT_URL | https://github.com/golang/go   | Source git url, use by tip|nightly or index of go version    |
| GOUP_GO_SOURCE_GIT_URL | https://go.googlesource.com/go | Source upstream git url, use by tip|nightly                  |
+------------------------+--------------------------------+--------------------------------------------------------------+
</code></pre>
<h4 data-id="heading-20">Shell补全</h4>
<p><code>goup completion &lt;SHELL&gt;</code>  为指定shell生成补全脚本. <code>&lt;SHELL&gt;</code>支持这些值: <code>bash</code>, <code>elvish</code>, <code>fish</code>, <code>powershell</code>, <code>zsh</code>.</p>
<pre><code class="hljs language-bash" lang="bash">goup completion zsh &gt; _goup
</code></pre>
<h4 data-id="heading-21">更多信息</h4>
<p>执行<code>goup -h</code>获取更多信息</p>
<h3 data-id="heading-22">镜像站</h3>
<h4 data-id="heading-23">索引镜像站</h4>





















































<table><thead><tr><th>索引</th><th>地址</th><th>使用选项<code>--registry-index</code>或环境变量</th><th>备注</th></tr></thead><tbody><tr><td>官方1(默认)</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev" target="_blank" title="https://go.dev" ref="nofollow noopener noreferrer">go.dev</a></td><td><code>official</code> 或 <code>official|https://go.dev</code></td><td/></tr><tr><td>官方2</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgolang.google.cn" target="_blank" title="https://golang.google.cn" ref="nofollow noopener noreferrer">golang.google.cn</a></td><td><code>official|https://golang.google.cn</code></td><td/></tr><tr><td>官方git 1</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fgolang%2Fgo" target="_blank" title="https://github.com/golang/go" ref="nofollow noopener noreferrer">github.com/golang/go</a></td><td><code>git</code> 或 <code>git|https://github.com/golang/go</code></td><td>通过git</td></tr><tr><td>官方git 2</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.googlesource.com%2Fgo" target="_blank" title="https://go.googlesource.com/go" ref="nofollow noopener noreferrer">go.googlesource.com/go</a></td><td><code>git|https://go.googlesource.com/go</code></td><td>通过git</td></tr><tr><td>阿里云</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.aliyun.com%2Fgolang" target="_blank" title="https://mirrors.aliyun.com/golang" ref="nofollow noopener noreferrer">mirrors.aliyun.com/golang</a></td><td><code>ngx-fancy-index|https://mirrors.aliyun.com/golang</code></td><td/></tr><tr><td>南京大学</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.nju.edu.cn%2Fgolang" target="_blank" title="https://mirrors.nju.edu.cn/golang" ref="nofollow noopener noreferrer">mirrors.nju.edu.cn/golang</a></td><td><code>ngx-fancy-index|https://mirrors.nju.edu.cn/golang</code></td><td/></tr><tr><td>华中科技大学</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.hust.edu.cn%2Fgolang" target="_blank" title="https://mirrors.hust.edu.cn/golang" ref="nofollow noopener noreferrer">mirrors.hust.edu.cn/golang</a></td><td><code>ngx-fancy-index|https://mirrors.hust.edu.cn/golang</code></td><td/></tr></tbody></table>
<h4 data-id="heading-24">仓库镜像站</h4>





























































<table><thead><tr><th>仓库</th><th>地址</th><th>支持SHA256文件</th><th>支持HTTP获取压缩包长度</th><th>备注</th></tr></thead><tbody><tr><td>官方1(默认)</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fdl.google.com%2Fgo" target="_blank" title="https://dl.google.com/go" ref="nofollow noopener noreferrer">dl.google.com/go</a></td><td>✅</td><td>✅</td><td/></tr><tr><td>官方2</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fdl" target="_blank" title="https://go.dev/dl" ref="nofollow noopener noreferrer">go.dev/dl</a></td><td>❌</td><td>✅</td><td/></tr><tr><td>官方3</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fgolang.org%2Fdl" target="_blank" title="https://golang.org/dl" ref="nofollow noopener noreferrer">golang.org/dl</a></td><td>❌</td><td>✅</td><td/></tr><tr><td>阿里云</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.aliyun.com%2Fgolang" target="_blank" title="https://mirrors.aliyun.com/golang" ref="nofollow noopener noreferrer">mirrors.aliyun.com/golang</a></td><td>❌</td><td>❌</td><td/></tr><tr><td>南京大学</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.nju.edu.cn%2Fgolang" target="_blank" title="https://mirrors.nju.edu.cn/golang" ref="nofollow noopener noreferrer">mirrors.nju.edu.cn/golang</a></td><td>✅</td><td>✅</td><td/></tr><tr><td>华中科技大学</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.hust.edu.cn%2Fgolang" target="_blank" title="https://mirrors.hust.edu.cn/golang" ref="nofollow noopener noreferrer">mirrors.hust.edu.cn/golang</a></td><td>✅</td><td>✅</td><td/></tr><tr><td>中国科学技术大学</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.ustc.edu.cn%2Fgolang" target="_blank" title="https://mirrors.ustc.edu.cn/golang" ref="nofollow noopener noreferrer">mirrors.ustc.edu.cn/golang</a></td><td>✅</td><td>✅</td><td>❌ 不建议使用</td></tr></tbody></table>
<p><em><strong>NOTE</strong></em>: 有些镜像站不提供<strong>SHA256校验文件</strong>, 在下载时需要使用<code>--skip-verify</code>选项.</p>
<h4 data-id="heading-25">设置镜像站环境变量</h4>
<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">推存值</span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-built_in">export</span> GOUP_GO_REGISTRY_INDEX=<span class="hljs-string">'ngx-fancy-index|https://mirrors.nju.edu.cn/golang'</span></span>
<span class="hljs-meta prompt_"># </span><span class="bash"><span class="hljs-built_in">export</span> GOUP_GO_REGISTRY_INDEX=<span class="hljs-string">'git|https://github.com/golang/go'</span></span>
export GOUP_GO_REGISTRY_INDEX=https://go.dev
export GOUP_GO_REGISTRY=https://mirrors.hust.edu.cn/golang
</code></pre>
<h3 data-id="heading-26">工作原理</h3>
<ul>
<li><code>goup completion &lt;SHELL&gt;</code> 为指定shell生成补全脚本.</li>
<li><code>goup [help]</code>  打印此信息或给定子命令的帮助信息.</li>
<li><code>goup install/update/i [TOOLCHAIN]</code> 下载指定的Go版本到<code>$HOME/.goup/go&lt;VERSION|tip&gt;/go</code>并创建一个软链接到<code>$HOME/.goup/current</code>.</li>
<li><code>goup default/use/set [VERSION]</code> 设置默认的Go版本.</li>
<li><code>goup ls/list/show</code> 列出所有位置<code>$HOME/.goup</code>已安装的Go版本.</li>
<li><code>goup remove/rm [VERSION]...</code> 移除指定的Go版本列表.</li>
<li><code>goup search/ls-remote [FILTER]</code> 列出所有可用的Go版本.</li>
<li><code>goup cache [COMMAND]</code> 管理缓存归档文件.</li>
<li><code>goup self &lt;COMMAND&gt;</code> 修改<code>goup</code>安装程序.</li>
<li><code>goup init [SHELL]</code> 将所有必要的环境变量和值写入<code>$HOME/.goup/env</code>.</li>
<li><code>goup env</code>  显示<code>goup</code>的环境变量和值.</li>
<li><code>goup shell [VERSION]</code> 在shell会话中使用特定的Go版本.</li>
</ul>
<h3 data-id="heading-27">How to Debug</h3>
<p>默认日志级别为<code>Info</code>. 你可以使用<code>goup -v &lt;subcommand&gt;</code> 或 <code>goup -vv &lt;subcommand&gt;</code> 来使用 <code>Debug</code> 或 <code>Trace</code> 等级.</p>
<h3 data-id="heading-28">FAQ</h3>
<ul>
<li>
<p>编译和安装源代码失败?<br/>
所需的Go最低版本取决于Go的目标版本, 更多信息请参见<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fdoc%2Finstall%2Fsource" target="_blank" title="https://go.dev/doc/install/source" ref="nofollow noopener noreferrer">source installation instructions</a></p>
</li>
<li>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fsemver.org%2F" target="_blank" title="https://semver.org/" ref="nofollow noopener noreferrer"><code>semver</code></a></p>
<ul>
<li>exact(<code>=</code>):  允许更新到与版本完全一致的最新版本, 因此<code>=1.21.4</code>表示与版本<code>1.21.4</code>完全一致.</li>
<li>greater(<code>&gt;</code>): 允许更新到大于该版本的最新版本, 因此<code>&gt;1.21.4</code>表示大于<code>1.21.4</code>.</li>
<li>greater equal(<code>&gt;=</code>): 允许更新到大于或等于该版本的最新版本, 因此 <code>&gt;1.21.4</code> 表示大于或等于<code>1.21.4</code>.</li>
<li>less(<code>&lt;</code>): 允许更新到小于该版本的最新版本, 因此<code>&gt;1.21.4</code>表示大于<code>1.21.4</code>.</li>
<li>less equal(<code>&lt;=</code>): 允许更新到小于或等于该版本的最新版本, 因此 <code>&gt;1.21.4</code> 表示小于或等于<code>1.21.4</code>.</li>
<li>tilde(<code>~</code>): 允许更新到不改变主,次版本的最新版本, 因此<code>~1.21.4</code>表示大于或等于 <code>1.21.4</code>, 但小于 <code>1.22.0</code>.</li>
<li>caret(<code>^</code>): 允许更新到不改变主要版本的最新版本, 因此 <code>^1.21.4</code> 表示版本必须大于或等于 <code>1.21.4</code>, 但小于 <code>2.0.0</code>.</li>
<li>wildcard(<code>*</code>): 此运算符表示任意版本. 它通常用于允许所有版本号匹配.
<ul>
<li><code>1.21.*</code> 匹配所有<code>1.21.x</code>版本.</li>
<li><code>1.*.*</code> 匹配所有<code>1.x.x</code>版本.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Go版本小于等于1.20.x解压失败.<br/>
大于v0.10.3版本已解决.
看多信息查看issue <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Fissues%2F251" target="_blank" title="https://github.com/thinkgos/goup-rs/issues/251" ref="nofollow noopener noreferrer">#251</a></p>
</li>
<li>
<p>如何自定义 <code>GOUP_HOME</code>? (&gt;= v0.11.x)<br/>
<code>goup</code>使用<code>$HOME/.goup</code>目录作为 <code>GOUP_HOME</code>. 如果需要自定义<code>GOUP_HOME</code>(大多数是Windows用户), 可以设置<code>GOUP_HOME</code>环境变量来使用其他目录, 安装<code>goup</code>之前, 请确保已设置自定义<code>GOUP_HOME</code>环境变量和目标目录权限, 否则可能会导致令人惊讶的结果, 请参阅issue <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Fissues%2F265" target="_blank" title="https://github.com/thinkgos/goup-rs/issues/265" ref="nofollow noopener noreferrer">#265</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Fpull%2F270" target="_blank" title="https://github.com/thinkgos/goup-rs/pull/270" ref="nofollow noopener noreferrer">#270</a></p>
</li>
<li>
<p>有一些版本没有sha256文件, 如何安装这些版本?
<code>goup</code>(&gt;= v0.12.x) 支持 <code>--skip-verify</code> 选项, 如果这些版本没有sha256文件, 你可以尝试添加选项. 请参阅issue <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Fissues%2F300" target="_blank" title="https://github.com/thinkgos/goup-rs/issues/300" ref="nofollow noopener noreferrer">#300</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Fpull%2F301" target="_blank" title="https://github.com/thinkgos/goup-rs/pull/301" ref="nofollow noopener noreferrer">#301</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Fpull%2F305" target="_blank" title="https://github.com/thinkgos/goup-rs/pull/305" ref="nofollow noopener noreferrer">#305</a></p>
</li>
<li>
<p>如何安装特定版本? 为什么会出现错误<code>Error: expected comma after minor version number, found 'r'</code>?
有时, 我们知道确切的版本, 可以使用 <code>goup install =1.24.5</code>, 但有些版本不符合<a href="https://link.juejin.cn?target=https%3A%2F%2Fsemver.org%2F" target="_blank" title="https://semver.org/" ref="nofollow noopener noreferrer"><code>semver</code></a>, 如 <code>1.25rc1</code>, 我们可以使用<code>goup install unstable</code>, 但这只能安装最新的不稳定版本. 所以我添加了一个 <code>--use-raw-version</code> 选项(&gt;= v0.12.x), 这样我们就可以安装任何我们确切知道的版本. 请参阅issue <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Fissues%2F299" target="_blank" title="https://github.com/thinkgos/goup-rs/issues/299" ref="nofollow noopener noreferrer">#299</a> <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Fpull%2F307" target="_blank" title="https://github.com/thinkgos/goup-rs/pull/307" ref="nofollow noopener noreferrer">#307</a></p>
</li>
<li>
<p>如何在shell会话中使用特定的Go版本?
<code>goup</code>(&gt;= v0.15.x) 支持在一个<code>shell</code>会话中指定go版本. 如果你使用<code>goup shell</code>, 在<code>*nix</code>系统上需要先运行<code>goup init</code>, 因为之前的<code>env</code>文件较旧且不包含<code>GOUP_GO_VERSION</code>环境变量. 在<code>Windows</code>系统 上, 仅支持<code>powershell</code>, 如果系统的<code>COMSPEC</code>已经指向 powershell, 可能无需做任何操作. 请参阅issue <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs%2Fissues%2F360" target="_blank" title="https://github.com/thinkgos/goup-rs/issues/360" ref="nofollow noopener noreferrer">#360</a>.</p>
</li>
</ul>
<h3 data-id="heading-29">原文</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fthinkgos%2Fgoup-rs" target="_blank" title="https://github.com/thinkgos/goup-rs" ref="nofollow noopener noreferrer">goup-rs</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 MateChat 构建 AI 编程智能助手的落地实践]]></title>    <link>https://juejin.cn/post/7577691061034025006</link>    <guid>https://juejin.cn/post/7577691061034025006</guid>    <pubDate>2025-11-30T06:31:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577691061034025006" data-draft-id="7577971299742711846" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 MateChat 构建 AI 编程智能助手的落地实践"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-30T06:31:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Se7en2581"/> <meta itemprop="url" content="https://juejin.cn/user/482061108644107"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 MateChat 构建 AI 编程智能助手的落地实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/482061108644107/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Se7en2581
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T06:31:37.000Z" title="Sun Nov 30 2025 06:31:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文围绕 <strong>华为云 DevUI MateChat</strong>，在在线教育中如何用 DevUI 组件 + MateChat 搭建智能问答界面。</p>
<h2 data-id="heading-0">一、需求背景：为什么我需要一个AI 助教？</h2>
<p>最近我开设了一期《AI 编程实战营》，面向零基础学员。教学过程中，两个痛点让我非常头大：</p>
<ol>
<li><strong>复读机式低效：</strong> 学员问题非常琐碎，比如环境变量怎么设？、Key 哪里找？这些问题在群里被反复问，我被迫变成了复读机，无法专注于深度教学。</li>
<li><strong>时差与响应滞后：</strong> 学员常在深夜学习，但我无法 24 小时在线。一旦他们卡在某个报错，往往要等到第二天我醒来才能解决，极大地打击了学习积极性。</li>
</ol>
<p><strong>我想做一个嵌在课程网页里的智能助手。</strong> 但当我调研技术方案时，发现后端接入大模型很简单，<strong>最让人头秃的是前端交互</strong>：</p>
<ul>
<li>Markdown 怎么渲染？</li>
<li>代码块怎么高亮？</li>
<li>流式输出（打字机效果）怎么写？</li>
</ul>
<p>如果要手写这一套，成本太高。直到我发现了 <strong>华为云 DevUI MateChat</strong>（以下简称 MateChat），它提供了开箱即用的 AI 对话 UI 组件，几乎完美治愈了我“前端恐惧症。</p>
<p>于是我尝试用 华为云 DevUI MateChat（以下简称 MateChat） 做一个嵌在课程里的智能问答助手。</p>
<h2 data-id="heading-1">二、搭建开发环境</h2>
<h3 data-id="heading-2">1、安装并检查 Node.js 环境</h3>
<p>Node.js官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2Fen%2Fdownload%2F" target="_blank" title="https://nodejs.org/en/download/" ref="nofollow noopener noreferrer">nodejs.org/en/download…</a></p>
<p>安装后，打开命令提示符（Win+R 输入cmd）或打开windows搜索cmd也行。</p>
<p>输入显示版本号，说明安装成功。</p>
<pre><code class="hljs">node -v
pnpm -v
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12902e0c27ca420e9bdf2efe76bd9038~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=8XbwIm7nK8WZ6gZC9J%2B%2BOCtRkCs%3D" alt="" loading="lazy"/><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b480f2dc0374b419750a5a2fa3cda12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=4TMEORnqQe0%2FH4XIxAWOkgA3FZc%3D" alt="" loading="lazy"/></p>
<p>注意：Vue 官方建议 Node.js 版本至少 18+ 或 20 LTS，这样用 Vite 起项目比较稳。</p>
<h2 data-id="heading-3">三、搭建MateChat + DevUI 聊天页面</h2>
<h3 data-id="heading-4">1、用 MateChat最新CLI创建项目</h3>
<p>在命令行里，切到你想放项目的文件夹，比如 <code>D:\code</code>，然后用MateChat最新CLI来创建项目，非常方便。</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-comment"># 这里我用的npm管理</span>
npm create matechat@latest
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/165e922755ac42e4bde02167dcd1f458~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=gNzlPMSYLIDQUocXa2Z93qCVqlQ%3D" alt="" loading="lazy"/></p>
<p>注意：这一指令在安装并执行<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2FDevCloudFE%2FMateChat%2Ftree%2Fdev%2Fpackages%2Fcreate-matechat" target="_blank" title="https://gitcode.com/DevCloudFE/MateChat/tree/dev/packages/create-matechat" ref="nofollow noopener noreferrer">create-matechat</a> 过程中，需要我们确认两个信息。</p>
<p>1、输入项目名称（Please input the project name），我的项目名称是：matechat-demo。</p>
<p>2、选择模版（Please select the template: Vue Starter），默认用Vue Starter即可。</p>
<h3 data-id="heading-5">2、安装依赖并启动</h3>
<p>根据MateChat使用指南</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5ec54a5cd52046b6b0598c30a3e1f711~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=7QgVlpEn79US1wLuigkWIQkM%2FHM%3D" alt="" loading="lazy"/></p>
<p>先切换到项目的根目录（ cd .\matechat-demo\），然后执行 npm i 安装依赖，最后用npm run dev 启动项目。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7d5658c755ff4099b11f3e179ebb3baa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=oNXRe21CWHaNfM2oBktWlB9Sd5U%3D" alt="" loading="lazy"/></p>
<p>打开浏览器，访问local地址：<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A5173%2Fvue-starter" target="_blank" title="http://localhost:5173/vue-starter" ref="nofollow noopener noreferrer">http://localhost:5173/vue-starter</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd8348ab5fb94f23a856adc11ee40228~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=3WyT1kwOpc8t5ZtDCB90Xc44Dwc%3D" alt="" loading="lazy"/></p>
<p>至此，能看到的默认的应用页面，有历史会话和输入框，就说明基础对话助手已经OK 了。</p>
<h3 data-id="heading-6">3、把模板修改为助手式</h3>
<p>我想收起左侧的对话，在文件src//global-config.ts 把地4行的displayShape，Immersive 改为Assistant</p>
<pre><code class="hljs language-javascript" lang="javascript">  <span class="hljs-comment">// 修改前：</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">displayShape</span>: <span class="hljs-string">"Immersive "</span>,
  <span class="hljs-attr">title</span>: <span class="hljs-string">"MateChat"</span>,
} <span class="hljs-keyword">as</span> <span class="hljs-title class_">IGlobalConfig</span>;

  <span class="hljs-comment">// 修改后：</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">displayShape</span>: <span class="hljs-string">"Assistant"</span>,
  <span class="hljs-attr">title</span>: <span class="hljs-string">"MateChat"</span>,
} <span class="hljs-keyword">as</span> <span class="hljs-title class_">IGlobalConfig</span>;
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7a59dcec0674af68904f74f19aab489~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=aToKUSGpubptS76Nkt358jmEw3k%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-7">4、接入deepseek大模型</h3>
<p>UI 搭好了，现在我们要注入灵魂。我选择用deepseek大模型，这里官方也给了非常详细的对接步骤</p>
<p>（参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fmatechat.gitcode.com%2Fuse-guide%2Fmodel%2Fopenai.html%25EF%25BC%2589" target="_blank" title="https://matechat.gitcode.com/use-guide/model/openai.html%EF%BC%89" ref="nofollow noopener noreferrer">matechat.gitcode.com/use-guide/m…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22a66cb115764b62bc59889317ebd04e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=7PaMm8yoO3obDsNDNm1N2jhCgSU%3D" alt="" loading="lazy"/></p>
<p><strong>1、安装 OpenAI SDK</strong> DeepSeek 兼容 OpenAI 协议，我们可以直接用 OpenAI 的 SDK。</p>
<pre><code class="hljs">npm install openai
</code></pre>
<p><strong>2、获取deepseek的key</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/55d4ab0bd02d4313addfafe348cd3bf9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=RVi8oTMdQ%2BlnNxqdpJk0qUToGBs%3D" alt="" loading="lazy"/></p>
<p><strong>3、基于 MateChat，配置API KEY</strong></p>
<p>MateChat把应用默认接入了<code>DeepSeek</code>，在<code>src/models/config.ts</code>文件的<code>LLM_MODELS</code>配置<code>apiKey</code></p>
<pre><code class="hljs language-vbnet" lang="vbnet">// deepseek
<span class="hljs-symbol">providerKey:</span> LLMProviders.DEEP_SEEK,
<span class="hljs-symbol">apiPath:</span> <span class="hljs-string">"https://api.deepseek.com"</span>,
<span class="hljs-symbol">apiKey:</span> <span class="hljs-string">"这里填写你的KEY"</span>,
<span class="hljs-symbol">models:</span> [
  { name: <span class="hljs-string">"deepseek-chat"</span>, iconPath: DeepSeekIcon },
  { name: <span class="hljs-string">"deepseek-reasoner"</span>, iconPath: DeepSeekIcon },
],
<span class="hljs-symbol">available:</span> <span class="hljs-literal">true</span>,
<span class="hljs-symbol">clientKey:</span> LLMClientKey.openai,
</code></pre>
<p><strong>4、将关闭 Mock 模式，调用 DeepSeek API， 文件： src/models/config.ts</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">  <span class="hljs-comment">// 修改前：</span>
  <span class="hljs-keyword">export</span> <span class="hljs-type">const</span> MODEL_CONFIGS = {
    stream: <span class="hljs-literal">true</span>,
    enableMock: <span class="hljs-literal">true</span>,   <span class="hljs-comment">// ← 原来是 true</span>
  };

  <span class="hljs-comment">// 修改后：</span>
  <span class="hljs-keyword">export</span> <span class="hljs-type">const</span> MODEL_CONFIGS = {
    stream: <span class="hljs-literal">true</span>,
    enableMock: <span class="hljs-literal">false</span>,  <span class="hljs-comment">// ← 改成 false</span>
  };
</code></pre>
<h3 data-id="heading-8">5、最后的运行效果</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b1b53fcf3fac45baa45eb37e004988d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2U3ZW4yNTgx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089097&amp;x-signature=jDqaDogqDfV93VYQ5%2FtMpm%2Bo5BY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9"><strong>四、总结</strong></h2>
<p>如果以前要实现 Markdown 渲染、流式打字机效果、自适应气泡布局，我至少需要写几百行 CSS 和 JS 代码，还要调试各种兼容性。</p>
<p>现在使用 DevUI + MateChat做开发，速度提升了10倍。DevUI 提供了企业级的组件规范，MateChat 封装了复杂的对话交互逻辑，很快就做好了这个在线教育智能助手。</p>
<p>本文完整 Demo 已开源在 GitCode：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitcode.com%2Fgcw_o9lCM1pp%2Fmatechat-demo.git" target="_blank" title="https://gitcode.com/gcw_o9lCM1pp/matechat-demo.git" ref="nofollow noopener noreferrer">gitcode.com/gcw_o9lCM1p…</a> master分支。</p>
<p>本文参考资料：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmatechat.gitcode.com%2Fuse-guide%2Fintroduction.html" target="_blank" title="https://matechat.gitcode.com/use-guide/introduction.html" ref="nofollow noopener noreferrer">matechat.gitcode.com/use-guide/i…</a></p>
<p>本文参考mateChat仓库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmatechat.gitcode.com%2F%25EF%25BC%258C%25E5%258C%2585%25E5%2590%25ABMateChat" target="_blank" title="https://matechat.gitcode.com/%EF%BC%8C%E5%8C%85%E5%90%ABMateChat" ref="nofollow noopener noreferrer">matechat.gitcode.com/，包含MateChat</a> 接入示例、DevUI 组件示例页面、环境配置说明等。</p>
<p>如果这套实践对你有帮助，点个 ⭐ Star，方便后续查阅，一起解锁更多 MateChat / DevUI 场景案例 。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Java 王者修炼手册【Mysql篇 - SQL执行存储流程】：拆解 InnoDB 存储结构与 SQL 执行流程，吃透 Buffer Pool 和 Change]]></title>    <link>https://juejin.cn/post/7577737385954754570</link>    <guid>https://juejin.cn/post/7577737385954754570</guid>    <pubDate>2025-11-30T06:42:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577737385954754570" data-draft-id="7577691061034057774" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Java 王者修炼手册【Mysql篇 - SQL执行存储流程】：拆解 InnoDB 存储结构与 SQL 执行流程，吃透 Buffer Pool 和 Change"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-30T06:42:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="DonaldCen666"/> <meta itemprop="url" content="https://juejin.cn/user/2875978147440264"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Java 王者修炼手册【Mysql篇 - SQL执行存储流程】：拆解 InnoDB 存储结构与 SQL 执行流程，吃透 Buffer Pool 和 Change
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978147440264/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    DonaldCen666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T06:42:09.000Z" title="Sun Nov 30 2025 06:42:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是程序员强子。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fc77e4877bbd46dfb2ab9bd5205a75ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRG9uYWxkQ2VuNjY2:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765089729&amp;x-signature=3gDL3kivLa%2FoAFcOSt2Mn1WTKF8%3D" alt="2001980.jpg" loading="lazy"/></p>
<p>日常开发中，我们很少关注 MySQL 的底层细节：</p>
<ul>
<li>InnoDB 是如何<strong>存储数据</strong>的？</li>
<li><strong>Buffer</strong> <strong>Pool</strong> 和 <strong>Change</strong> <strong>Buffer</strong> 又是如何<strong>优化性能</strong>的？</li>
<li><strong>SQL</strong> <strong>执行</strong>要经过哪些环节？</li>
</ul>
<p>今天，强子就带着大家走进 MySQL 的底层世界 ~</p>
<h2 data-id="heading-0">数据存储机制</h2>
<h3 data-id="heading-1">特点</h3>
<p>InnoDB 的存储结构按 <strong>从大到小</strong> 分为 5 个层级</p>
<p><strong>表空间</strong>（Tablespace）→ <strong>段</strong>（Segment）→ <strong>区</strong>（Extent）→ <strong>页</strong>（Page）→ <strong>行</strong>（Row）</p>
<p>核心就上层负责 <strong>逻辑隔离与资源管理</strong>，下层负责 <strong>物理存储与 IO 交互</strong></p>
<p>比如<strong>表空间</strong>隔离不同表的数据，<strong>页</strong>则作为内存与磁盘的交互单元</p>
<p>最终实现 <strong>按需存储</strong>、<strong>高效读写</strong></p>
<p>接下来，跟着强子的脚步，来拆解每个层次~</p>
<h3 data-id="heading-2">表空间</h3>
<p><strong>表空间</strong>（Tablespace）,是所有数据（<strong>表数据</strong>、<strong>索引</strong>、<strong>元数据</strong>等）的 <strong>总仓库</strong></p>
<p>分为两类核心类型：</p>
<ul>
<li>
<p><strong>系统表空间</strong>（System Tablespace）</p>
<ul>
<li>MySQL 默认的共享表空间，对应磁盘文件<strong>ibdata1</strong>（可多文件）</li>
<li>存储 InnoDB <strong>数据字典</strong>、<strong>回滚日志</strong>（Undo Log）、<strong>临时表</strong>数据等核心元数据；</li>
</ul>
</li>
<li>
<p><strong>独立表空间</strong>（File-per-table Tablespace）</p>
<ul>
<li>MySQL 5.6 及以上默认启用（通过<strong>innodb_file_per_table=ON</strong>控制）</li>
<li>每张表对应一个<strong>独立的ibd文件</strong>（如user.ibd），表数据和索引单独存储</li>
</ul>
</li>
</ul>
<blockquote>
<p>这样设计有什么好处？</p>
</blockquote>
<ul>
<li><strong>数据隔离</strong>：独立表空间下，单表的增删改查、<strong>备份迁移</strong>不影响其他表；</li>
<li><strong>元数据管理</strong>：系统表空间<strong>统一维护</strong> InnoDB 的 “数据字典”（记录表结构、列类型等元信息）</li>
</ul>
<blockquote>
<p>有没有实战案例？</p>
</blockquote>
<p>100G 大表order需要迁移，对比 独立表空间 和 共享表空间：</p>
<ul>
<li>若用<strong>独立表空间</strong>：直接拷贝order.ibd文件，配合ALTER TABLE order DISCARD TABLESPACE/IMPORT TABLESPACE命令，10 分钟内可完成迁移；</li>
<li>若用系统表空间：需备份整个<strong>ibdata1</strong>文件（可能几百 G），迁移效率极低，且恢复时易影响其他表。</li>
</ul>
<p>所以，<strong>生产环境</strong>必须<strong>启用独立表空间</strong></p>
<p>还有，ibdata1文件 有<strong>扩容后无法收缩</strong>的特点！</p>
<ul>
<li>系统表空间的ibdata1文件默认 <strong>自动扩容</strong>，但扩容后无法收缩</li>
<li>即使<strong>删除数据</strong>，空间也不会释放</li>
<li>若ibdata1超过 <strong>50G</strong>，会导致 MySQL 启动变慢、磁盘 IO 负载升高</li>
<li>此时需通过 “导出数据→重建实例→导入数据” 的方式收缩表空间</li>
</ul>
<h3 data-id="heading-3">段</h3>
<p><strong>段</strong>（Segment）用于区分 <strong>数据</strong> 与 <strong>索引</strong> 的存储</p>
<p>段类型有主要有两类，还有一些其他的类型：</p>
<ul>
<li>
<p><strong>数据段</strong>（Data Segment）</p>
<ul>
<li>存储表的<strong>真实业务数据</strong>；</li>
<li>本质是<strong>聚簇索引</strong>的叶子节点段</li>
<li><strong>聚簇索引</strong>的叶子节点直接包含<strong>完整行数据</strong>，数据段就是聚簇索引<strong>叶子节点</strong>的存储空间</li>
</ul>
</li>
<li>
<p><strong>索引段</strong>（Index Segment）</p>
<ul>
<li>存储索引的<strong>非叶子节点</strong>（以及二级索引的叶子节点），用于实现索引的快速查找逻辑</li>
<li>二级索引的叶子节点也存于索引段，这是因为二级索引叶子节点不存实际数据，<strong>只存主键值</strong></li>
</ul>
</li>
</ul>
<p>还有其他类型的段：</p>
<ul>
<li>
<p><strong>回滚段</strong></p>
<ul>
<li>InnoDB 中专门存储<strong>Undo Log</strong>（撤销日志） 的段，默认位于共享表空间（ibdata1）</li>
<li>也可通过配置innodb_undo_tablespaces设置为独立表空间</li>
<li>每个回滚段由多个 <strong>Undo 页</strong>组成</li>
</ul>
</li>
<li>
<p><strong>临时段</strong></p>
<ul>
<li>是 InnoDB 为<strong>临时表</strong>、<strong>临时数据</strong>操作分配的段，</li>
<li>存储于临时表空间（ibtmp1）,独立于普通表空间，仅用于存放临时数据</li>
<li><strong>显式临时表存储:</strong> 用户通过CREATE TEMPORARY TABLE创建的<strong>临时表</strong></li>
<li><strong>隐式临时数据处理: <strong>SQL 执行过程中产生的</strong>临时数据</strong>（如<strong>ORDER BY排序</strong>、<strong>GROUP BY分组</strong>、<strong>DISTINCT去重</strong>、<strong>子查询</strong>等），会先存入临时段，处理完成后销毁</li>
</ul>
</li>
<li>
<p><strong>缓冲段</strong></p>
<ul>
<li><strong>专门存储Change Buffer（插入缓冲） 数据</strong></li>
</ul>
</li>
</ul>
<p>段没有固定大小，会随数据量动态扩展，且扩展的最小单位是 “区”</p>
<p>来来来，详细了解一下 区</p>
<h3 data-id="heading-4">区</h3>
<p>区（Extent）是 InnoDB 中<strong>连续页的集合</strong>，是段扩展的 <strong>最小单位，</strong> 默认配置下：</p>
<ul>
<li>区大小固定为 <strong>1MB</strong>；</li>
<li>因 InnoDB 默认页大小为 <strong>16KB</strong>，故 1 个区包含 1MB / 16KB = 64个连续页</li>
</ul>
<blockquote>
<p>实战案例有哪些？</p>
</blockquote>
<p>电商项目的product表（存储商品信息，高频查询库存字段），当某类商品（如 “<strong>手机</strong>”）成为热点时：</p>
<ul>
<li>为product表的数据段分配多个<strong>连续区</strong>，热点商品的数据集中存储在这些区中；</li>
<li><strong>预读机制</strong>（Read Ahead）会一次性将整个区（1MB）的数据加载到 <strong>Buffer Pool</strong>中；</li>
<li>后续查询该类商品时，直接从内存读取，无需频繁**访问磁盘 **</li>
<li>InnoDB对区分配 有策略： <strong>区翻倍分配</strong></li>
</ul>
<blockquote>
<p>什么是 区翻倍分配 策略？</p>
</blockquote>
<ul>
<li>表刚创建时，数据段仅分配 1 个区；</li>
<li>当数据量达到区容量的 <strong>50</strong>% 时，下次分配 <strong>2</strong> 个区；</li>
<li>再满则分配 4 个区、8 个区…… 以此类推，直到单次分配 64 个区后稳定</li>
</ul>
<p>这种策略能避免 <strong>小数据量时频繁分配区</strong> 的性能开销，同时适配大数据量的扩展需求</p>
<h3 data-id="heading-5">页</h3>
<p>页（Page）InnoDB磁盘操作的<strong>最小单位</strong></p>
<p>无论读还是写，都必须整页操作</p>
<p>默认页大小为 <strong>16</strong>KB,可通过innodb_page_size参数,修改为 4KB、8KB、32KB 等</p>
<p>核心页类型包括：</p>
<ul>
<li><strong>数据页</strong>（Data Page）：存储表数据，是 B + 树的 <strong>叶子节点</strong></li>
<li><strong>索引页</strong>（Index Page）：存储索引条目，是 B + 树的 <strong>非叶子节点</strong></li>
<li><strong>日志页</strong>（Log Page）：存储 redo log、undo log 等日志数据</li>
</ul>
<blockquote>
<p>实战案例是什么？</p>
</blockquote>
<p>我们平常说的<strong>避免全表扫描</strong>，本质就是避免 <strong>加载过多数据页</strong></p>
<ul>
<li>假设user表有 100 万行数据，每行约 1KB，1 个数据页可存 16 行，<strong>全表扫描</strong>需加载 100万 / 16 ≈ 62500个页，需发起数万次磁盘 IO；</li>
<li>若走<strong>主键查询</strong>（select * from user where id=1001）：B + 树索引只需加载 3 个页（根节点→子节点→叶子节点数据页），仅 3 次 IO，效率相差万倍</li>
</ul>
<h3 data-id="heading-6">行</h3>
<p>行是 InnoDB 存储的最小逻辑单位，对应数据表中的<strong>一条记录</strong></p>
<p>InnoDB 支持多种行格式，核心格式有</p>
<ul>
<li><strong>Compact</strong>：MySQL 5.6 默认格式，对短字段紧凑存储，长字段（超过一定长度）会将部分数据存到 “溢出页”；</li>
<li><strong>Dynamic</strong>：MySQL 5.7 及以上默认格式，长字段（如TEXT、BLOB）的所有数据都存到 “溢出页”，数据页仅保留 20 字节的指针</li>
</ul>
<blockquote>
<p>溢出页是什么？</p>
</blockquote>
<p>专门用于存放 <strong>超长字段</strong>（如 TEXT、BLOB、超长 VARCHAR）数据的<strong>独立页面</strong></p>
<p>原数据页里只保留20 字节的指针，这个指针相当于 <strong>地址标签</strong>，记录着溢出页的位置</p>
<blockquote>
<p>有没有可能一条数据太大导致占用超过16k(超过一页)？</p>
</blockquote>
<p>InnoDB有硬性规定：单行数据的实际存储大小不能超过页大小的<strong>一半</strong>（约 8KB）</p>
<p>目的是保证一个数据页至少能容纳<strong>两行数据</strong>，避免存储结构崩溃</p>
<p>如果一行数据包含多个 TEXT/BLOB、超长 VARCHAR，确实会触发 <strong>行溢出</strong></p>
<p><strong>但 InnoDB 通过之前提到的溢出页机制+行拆分逻辑来解决。</strong></p>
<p>在 段中 提到 <strong>Change Buffer</strong> ，和 区中提到 <strong>Buffer Poo</strong>l 到底 是啥来的？来跟强子仔细研究一下~~</p>
<h2 data-id="heading-7">Change Buffer</h2>
<h3 data-id="heading-8">定义</h3>
<p>内存中一块临时存储区域</p>
<p>专门缓存对<strong>非唯一二级索引</strong>的 插入 / 更新 / 删除 操作</p>
<p>不直接刷盘，等<strong>合适时机</strong>一次性合并到磁盘索引页</p>
<h3 data-id="heading-9">作用</h3>
<ul>
<li>把修改非唯一二级索引时的<strong>零散随机</strong> I/O，转化为批量顺序 I/O，大幅提升写入性能</li>
<li>比如<strong>批量插入数据</strong>、<strong>高频更新非唯一索引列</strong>时效果明显</li>
</ul>
<h3 data-id="heading-10">解决的核心问题</h3>
<p>二级索引的索引页在磁盘上<strong>分布零散（非顺序）</strong></p>
<p>若修改时索引页不在内存（<strong>Buffer Pool</strong>），需频繁从磁盘<strong>读取索引页</strong>（随机 I/O 效率极低）</p>
<p>Change Buffer 直接跳过 <strong>频繁读磁盘</strong> 步骤，<strong>先缓存修改操作</strong>，避免了这个痛点</p>
<h3 data-id="heading-11">限制</h3>
<ul>
<li>只适用于<strong>非唯一二级索引</strong>，唯一索引需实时校验唯一性，不能缓冲；</li>
<li><strong>聚簇索引、已在内存</strong>的索引页，不适用（聚簇索引直接操作数据页，内存索引页可直接修改）。</li>
</ul>
<h2 data-id="heading-12">Buffer Pool</h2>
<p>本质是一块从内存中划分出的<strong>缓存空间</strong></p>
<p>专门用来缓存磁盘上的数据页（表数据）和索引页，以及索引变更、行数据等相关信息</p>
<p>核心目标是<strong>减少磁盘 I/O</strong>、<strong>提升读写性能</strong></p>
<h3 data-id="heading-13">作用</h3>
<h4 data-id="heading-14">读缓存</h4>
<p>查询数据时，先从 Buffer Pool 找<strong>数据页</strong> / <strong>索引页</strong>，找到就直接返回（“缓存命中”），不用读磁盘；</p>
<p>没找到才从磁盘加载到 Buffer Pool，后续再查就走内存，速度提升成百上千倍。</p>
<h4 data-id="heading-15">写缓存</h4>
<p>修改数据时，先更新 Buffer Pool 里的<strong>缓存页</strong>（标记为 “脏页”），</p>
<p><strong>不立即</strong>刷到磁盘，而是由后台线程批量异步刷盘</p>
<p>避免频繁磁盘写，提升写入效率</p>
<h3 data-id="heading-16">数据结构</h3>
<p>Buffer Pool 按 <strong>页</strong>（和磁盘数据页大小一致，默认 16KB）划分</p>
<p>每个缓存页对应磁盘上的一个数据页 / 索引页</p>
<p>用 <strong>最近最少使用LRU</strong> 算法管理缓存页</p>
<p>把<strong>常用的页</strong>留在链表前端，<strong>不常用的页</strong>在末端</p>
<p>内存满时淘汰末端页，保证缓存命中率</p>
<h3 data-id="heading-17">机制</h3>
<p>被修改但未刷到磁盘的缓存页叫 <strong>脏页</strong></p>
<p>由后台线程在<strong>空闲时</strong>或<strong>满足阈值时</strong>批量刷到磁盘</p>
<h2 data-id="heading-18">SQL 各子句的执行顺序</h2>
<h3 data-id="heading-19">执行顺序</h3>
<h4 data-id="heading-20">FROM/JOIN</h4>
<ul>
<li>确定<strong>数据来源</strong>：加载 FROM 后的<strong>表</strong>，处理 JOIN（内连接 / 外连接等）<strong>关联的表</strong></li>
<li>生成 <strong>基础数据集</strong>，包含所有关联后的行</li>
</ul>
<h4 data-id="heading-21">WHERE</h4>
<p>对第一步的基础数据集做<strong>行级过滤</strong>：只保留满足 <strong>WHERE</strong> 条件的行</p>
<p>此时还未分组，不能用<strong>聚合函数</strong>如 SUM ()</p>
<h4 data-id="heading-22">GROUP BY</h4>
<p>按指定字段对过滤后的<strong>行分组</strong>：相同字段值的行被合并为一个组</p>
<p>后续<strong>聚合函数</strong>（如 COUNT、AVG）基于组计算</p>
<h4 data-id="heading-23">HAVING</h4>
<p>对分组后的结果做<strong>组级过滤</strong>：只保留满足 HAVING 条件的组</p>
<p>可以用<strong>聚合函数</strong>，比如HAVING AVG(salary) &gt; 5000</p>
<h4 data-id="heading-24">SELECT</h4>
<p>从前面处理后的<strong>结果</strong>中选择<strong>要显示的列</strong></p>
<p>包括字段、聚合函数计算结果、别名等</p>
<h4 data-id="heading-25">DISTINCT</h4>
<p>对 <strong>SELECT</strong> 选出的结果<strong>去重</strong>，<strong>去除重复行</strong></p>
<h4 data-id="heading-26">ORDER BY</h4>
<p>按指定列 / 表达式对<strong>结果集排序</strong></p>
<p>此时可以用 SELECT 里的<strong>别名</strong>，因为 SELECT 已经执行</p>
<h4 data-id="heading-27">LIMIT/OFFSET</h4>
<p>最后限制<strong>结果集</strong>的行数</p>
<ul>
<li>如LIMIT 10取前 10 行</li>
<li>或跳过指定行数（OFFSET 5）</li>
</ul>
<h3 data-id="heading-28">验证</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> dept_id, <span class="hljs-built_in">AVG</span>(salary) <span class="hljs-keyword">AS</span> avg_sal
<span class="hljs-keyword">FROM</span> employee
<span class="hljs-keyword">WHERE</span> dept_id <span class="hljs-operator">&gt;</span> <span class="hljs-number">10</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span> dept_id
<span class="hljs-keyword">HAVING</span> avg_sal <span class="hljs-operator">&gt;</span> <span class="hljs-number">5000</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> avg_sal <span class="hljs-keyword">DESC</span>
LIMIT <span class="hljs-number">5</span>;
</code></pre>
<p>执行顺序对应：</p>
<ul>
<li>先从<strong>employee</strong>表加载数据（<strong>FROM</strong>）；</li>
<li>过滤出<strong>dept_id</strong> &gt; 10的行（<strong>WHERE</strong>）；</li>
<li>按dept_id<strong>分组</strong>（<strong>GROUP BY</strong>）；</li>
<li>保留平均工资 &gt; 5000 的组（<strong>HAVING</strong>）；</li>
<li>选择dept_id和平均工资（<strong>SELECT</strong>，别名<strong>avg_sa</strong>l生效）；</li>
<li>按<strong>avg_sal</strong>降序排序（<strong>ORDER BY</strong>）；</li>
<li>取前 5 组（<strong>LIMIT</strong>）</li>
</ul>
<h2 data-id="heading-29">总结</h2>
<p>今天我们了解了Mysql是怎么<strong>存储数据</strong>的，也知道了sql<strong>子句执行流程</strong>是怎么样的，顺便还了解了一下Mysql的<strong>缓存机制</strong>~</p>
<ul>
<li>InnoDB 靠表空间 - 段 - 区 - 页架构存储数据，搭配数据段、索引段、溢出页等解决存储难题；</li>
<li>SQL 按 “FROM→WHERE→GROUP BY→SELECT→ORDER BY→LIMIT” 的固定顺序执行。</li>
<li>Buffer Pool 缓存数据和索引减磁盘 I/O，Change Buffer 优化非唯一二级索引写入；</li>
</ul>
<p>带着底层视角开发，解决问题会更精准~</p>
<p>熟练度刷不停，知识点吃透稳，下期接着练～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS应用开发基础案例（一）：鸿蒙页面布局入门]]></title>    <link>https://juejin.cn/post/7577689171222937650</link>    <guid>https://juejin.cn/post/7577689171222937650</guid>    <pubDate>2025-11-30T01:44:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577689171222937650" data-draft-id="7577705544875130918" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS应用开发基础案例（一）：鸿蒙页面布局入门"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-11-30T01:44:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Raink"/> <meta itemprop="url" content="https://juejin.cn/user/3843548383566072"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS应用开发基础案例（一）：鸿蒙页面布局入门
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548383566072/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Raink
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T01:44:12.000Z" title="Sun Nov 30 2025 01:44:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>本文以仿猫眼电影M站首页布局为案例，展示ArkUI在实际开发中的应用。内容包括案例效果及相关知识点，深入解析布局框架以及头部、脚部、内容区域的构建思路与代码实现，最后提供完整代码和教程资源，助力你强化实践能力。</p>
<h2 data-id="heading-0">1. 案例效果截图</h2>
<p>如图1-1所示。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfc35d42a0754170a4e6d0ff5a538416~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765071852&amp;x-signature=8jLo7XO%2BBtUctc7TbMNUctZazC8%3D" alt="" loading="lazy"/><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a342b873934f4b1cac11c16acfa55de7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765071852&amp;x-signature=0a9NE1ghSJLQi9jeN5sx%2BIez9Eg%3D" alt="" loading="lazy"/></p>
<p><strong>图1-1</strong> 案例效果截图</p>
<h2 data-id="heading-1">2. 案例运用到的知识点</h2>
<ol>
<li><strong>核心知识点</strong></li>
</ol>
<ul>
<li>UI范式基本语法。</li>
<li>文本显示Text、Span组件。</li>
<li>线性布局Column、Row组件。</li>
<li>层叠布局Stack组件。</li>
<li>按钮Button组件。</li>
<li>显示图片Image组件。</li>
</ul>
<ol start="2">
<li><strong>其他知识点</strong></li>
</ol>
<ul>
<li>DevEco Studio的基本使用。</li>
<li>简单的资源分类访问。</li>
<li>移动端APP布局基本技巧。</li>
</ul>
<h2 data-id="heading-2">3. 布局框架</h2>
<p>可以按照图3-1来思考布局的框架：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0dd2533ada3d46ceacf3a472f8dd8739~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765071852&amp;x-signature=DchyvIeZrS9n6Ud4HQukp%2BVUISE%3D" alt="" loading="lazy"/></p>
<p><strong>图3-1</strong> 布局框架图</p>
<p>框架的代码如下：</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@Entry</span>
<span class="hljs-variable">@Component</span>
struct Index {
  <span class="hljs-selector-tag">build</span>() {
    <span class="hljs-selector-tag">Column</span>() {
      <span class="hljs-selector-tag">Stack</span>() {}
        .<span class="hljs-built_in">width</span>(<span class="hljs-string">'100%'</span>).<span class="hljs-built_in">height</span>(<span class="hljs-number">50</span>).<span class="hljs-built_in">backgroundColor</span>(<span class="hljs-string">'#e54847'</span>)
      
      <span class="hljs-built_in">Column</span>() {
        <span class="hljs-selector-tag">Text</span>(<span class="hljs-string">'content'</span>)
      }<span class="hljs-selector-class">.width</span>(<span class="hljs-string">'100%'</span>)<span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)
      
      <span class="hljs-selector-tag">Row</span>() {}
        .<span class="hljs-built_in">width</span>(<span class="hljs-string">'100%'</span>).<span class="hljs-built_in">height</span>(<span class="hljs-number">50</span>).<span class="hljs-built_in">backgroundColor</span>(<span class="hljs-string">'#fff'</span>)
        .<span class="hljs-built_in">border</span>({<span class="hljs-attribute">width</span>: { <span class="hljs-attribute">top</span>: <span class="hljs-number">1</span>}, <span class="hljs-attribute">color</span>: <span class="hljs-string">'#eee'</span>})
    }
  }
}
</code></pre>
<h2 data-id="heading-3">4. 头部区域</h2>
<p>可以按照图4-1思路来构建布局：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3562829c7a114dc8b181e2ee2e681921~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765071852&amp;x-signature=zpmYtnsWDON7TLTXp9FNAupWMlU%3D" alt="" loading="lazy"/></p>
<p><strong>图4-1</strong> 布局示意图</p>
<p>代码如下：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 头部区域</span>
<span class="hljs-built_in">Stack</span>({ alignContent: Alignment.End }) {
  Text('猫眼电影')
    <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.textAlign</span>(TextAlign.Center)
    <span class="hljs-selector-class">.fontColor</span>('#fff')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">18</span>)
  <span class="hljs-built_in">Image</span>($rawfile('menu.png'))
    <span class="hljs-selector-class">.width</span>(<span class="hljs-number">17</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">16</span>)<span class="hljs-selector-class">.margin</span>({ right: <span class="hljs-number">10</span> })
}<span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.height</span>(<span class="hljs-number">50</span>)<span class="hljs-selector-class">.backgroundColor</span>('#e54847')
</code></pre>
<h2 data-id="heading-4">5. 脚部区域</h2>
<p>可以按照图5-1思路来构建布局：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/109af3e0cee54de8ae3559e0ec30c1db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765071852&amp;x-signature=DuwJj6mDG6kvGYE8k2hzJKnFuzo%3D" alt="" loading="lazy"/></p>
<p><strong>图5-1</strong> 布局示意图</p>
<p>代码如下：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 脚部区域</span>
<span class="hljs-built_in">Row</span>() {
  <span class="hljs-built_in">Column</span>() {
    <span class="hljs-built_in">Image</span>($rawfile('movie.svg'))
      <span class="hljs-selector-class">.width</span>(<span class="hljs-number">25</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">25</span>)<span class="hljs-selector-class">.fillColor</span>('#e54847')
    Text('电影/影院')
      <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">10</span>)<span class="hljs-selector-class">.fontColor</span>('#e54847')
  }<span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)<span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.justifyContent</span>(FlexAlign.SpaceEvenly)

  <span class="hljs-built_in">Column</span>() {
    <span class="hljs-built_in">Image</span>($rawfile('video.png'))
      <span class="hljs-selector-class">.width</span>(<span class="hljs-number">25</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">25</span>)<span class="hljs-selector-class">.fillColor</span>('#<span class="hljs-number">696969</span>')
    Text('视频')
      <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">10</span>)<span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">696969</span>')
  }<span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)<span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.justifyContent</span>(FlexAlign.SpaceEvenly)

  <span class="hljs-built_in">Column</span>() {
    <span class="hljs-built_in">Image</span>($rawfile('perform.svg'))
      <span class="hljs-selector-class">.width</span>(<span class="hljs-number">25</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">25</span>)<span class="hljs-selector-class">.fillColor</span>('#<span class="hljs-number">696969</span>')
    Text('演出')
      <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">10</span>)<span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">696969</span>')
  }<span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)<span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.justifyContent</span>(FlexAlign.SpaceEvenly)

  <span class="hljs-built_in">Column</span>() {
    <span class="hljs-built_in">Image</span>($rawfile('mine.svg'))
      <span class="hljs-selector-class">.width</span>(<span class="hljs-number">25</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">25</span>)<span class="hljs-selector-class">.fillColor</span>('#<span class="hljs-number">696969</span>')
    Text('我的')
      <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">10</span>)<span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">696969</span>')
  }<span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)<span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.justifyContent</span>(FlexAlign.SpaceEvenly)
}
<span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.height</span>(<span class="hljs-number">50</span>)<span class="hljs-selector-class">.border</span>({ width: { top: <span class="hljs-number">1</span> }, color: '#eee' })
<span class="hljs-selector-class">.backgroundColor</span>('#fff')
</code></pre>
<h2 data-id="heading-5">6. 内容区域</h2>
<p>可以参照图6-1思考内容区域的整体框架布局：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e81cb7e910be4a739dc5285ba98dcac9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765071852&amp;x-signature=X6uthT%2ByeC4P6cmmPhPXoEEgWIY%3D" alt="" loading="lazy"/></p>
<p><strong>图6-1</strong> 布局示意图</p>
<p>代码如下：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 内容区域</span>
<span class="hljs-built_in">Column</span>() {
  <span class="hljs-built_in">Row</span>() {}
    <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.height</span>(<span class="hljs-number">44</span>)<span class="hljs-selector-class">.border</span>({width: {bottom: <span class="hljs-number">1</span>}, color: '#e6e6e6'})

  Scroll() {}
    <span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)
}<span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)
</code></pre>
<h3 data-id="heading-6">6.1. 导航区</h3>
<p>内容区域的导航区可以参照图6-2思考布局：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bec5f9d4f9d04ba8ae2abca42bc14491~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765071852&amp;x-signature=7075OJDENp224ocqy1UgLmJZMiE%3D" alt="" loading="lazy"/></p>
<p><strong>图6-2</strong> 布局示意图</p>
<p>代码如下：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 导航区</span>
<span class="hljs-built_in">Row</span>() {
  <span class="hljs-built_in">Row</span>() {
    Text('北京')<span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">666</span>')
    Text('')
      <span class="hljs-selector-class">.width</span>(<span class="hljs-number">0</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">0</span>)
      <span class="hljs-selector-class">.border</span>({
        width: <span class="hljs-number">5</span>,
        color: {
          top: '#b0b0b0',
          left: Color.Transparent,
          right: Color.Transparent,
          bottom: Color.Transparent
        }
      })
      <span class="hljs-selector-class">.margin</span>({top: <span class="hljs-number">6</span>, left: <span class="hljs-number">4</span>})
  }<span class="hljs-selector-class">.offset</span>({x: <span class="hljs-number">15</span>})<span class="hljs-selector-class">.width</span>(<span class="hljs-number">60</span>)

  <span class="hljs-built_in">Row</span>() {
    <span class="hljs-built_in">Stack</span>() {
      Text('热映')
        <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">17</span>)<span class="hljs-selector-class">.fontWeight</span>(FontWeight.Bold)
      Text('')
        <span class="hljs-selector-class">.width</span>(<span class="hljs-number">24</span>)<span class="hljs-selector-class">.border</span>({width: {bottom: <span class="hljs-number">3</span>}, color: '#e54847'})<span class="hljs-selector-class">.offset</span>({y: <span class="hljs-number">18</span>})
    }
    Text('影院')
    Text('待映')
    Text('经典电影')
  }<span class="hljs-selector-class">.justifyContent</span>(FlexAlign.SpaceEvenly)<span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)

  <span class="hljs-built_in">Row</span>() {
    <span class="hljs-built_in">Image</span>($rawfile('search-red.png'))
      <span class="hljs-selector-class">.width</span>(<span class="hljs-number">20</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">20</span>)
  }<span class="hljs-selector-class">.justifyContent</span>(FlexAlign.Center)<span class="hljs-selector-class">.width</span>(<span class="hljs-number">50</span>)
}<span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.height</span>(<span class="hljs-number">44</span>)<span class="hljs-selector-class">.border</span>({width: {bottom: <span class="hljs-number">1</span>}, color: '#e6e6e6'})
</code></pre>
<h3 data-id="heading-7">6.2. 最受好评区</h3>
<p>可以参照图6-3考虑整体布局：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/351a4dfe5ba840f0ba72d8177add0cc0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765071852&amp;x-signature=KxjZlO1BrpnkQRBhJeMKkunh3fk%3D" alt="" loading="lazy"/></p>
<p><strong>图6-3</strong> 布局示意图</p>
<p>代码如下：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 好评和列表区内容</span>
<span class="hljs-built_in">Column</span>() {
  <span class="hljs-comment">// 好评区</span>
  <span class="hljs-built_in">Column</span>() {
    Text('最受好评电影')
      <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">14</span>)<span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">333</span>')
      <span class="hljs-selector-class">.textAlign</span>(TextAlign.Start)<span class="hljs-selector-class">.margin</span>({ bottom: <span class="hljs-number">12</span> })
    Scroll() {
      <span class="hljs-built_in">Row</span>() {
        <span class="hljs-built_in">Column</span>() {
          <span class="hljs-built_in">Stack</span>({ alignContent: Alignment.BottomStart }) {
            <span class="hljs-built_in">Image</span>('https://p0.pipi.cn/basicdata/' 
                  + '<span class="hljs-number">54</span>ecdeddf2a92339dd2c95022e99e5fe27091.jpg?' 
                  + 'imageMogr2/thumbnail/<span class="hljs-number">2500</span>x2500%<span class="hljs-number">3</span>E'
            )<span class="hljs-selector-class">.width</span>(<span class="hljs-number">85</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">115</span>)
            Text('')
              <span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.height</span>(<span class="hljs-number">35</span>)<span class="hljs-selector-class">.linearGradient</span>({
                direction: GradientDirection.Bottom, 
                colors: [['rgba(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>)', <span class="hljs-number">0</span>], <span class="hljs-selector-attr">[0x000000, 1]</span>] 
              })
            Text('观众评分：<span class="hljs-number">9.6</span>')
              <span class="hljs-selector-class">.fontColor</span>('#faaf00')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">11</span>)
              <span class="hljs-selector-class">.fontWeight</span>(<span class="hljs-number">700</span>)<span class="hljs-selector-class">.offset</span>({ x: <span class="hljs-number">4</span>, y: -<span class="hljs-number">4</span> })
          }<span class="hljs-selector-class">.height</span>(<span class="hljs-number">115</span>)<span class="hljs-selector-class">.margin</span>({ bottom: <span class="hljs-number">6</span> })
          Text('出走的决心')
            <span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">13</span>)<span class="hljs-selector-class">.fontWeight</span>(FontWeight.Bold)<span class="hljs-selector-class">.width</span>(<span class="hljs-number">85</span>)
            <span class="hljs-selector-class">.textAlign</span>(TextAlign.Start)<span class="hljs-selector-class">.margin</span>({ bottom: <span class="hljs-number">3</span> })
        }<span class="hljs-selector-class">.width</span>(<span class="hljs-number">85</span>)<span class="hljs-selector-class">.margin</span>({ right: <span class="hljs-number">10</span> })

        <span class="hljs-comment">// ... 其余7个Column与上述结构相同，因篇幅限制已省略，详见本书配套源码。</span>
      }
    }
    <span class="hljs-selector-class">.scrollable</span>(ScrollDirection.Horizontal)<span class="hljs-selector-class">.scrollBar</span>(BarState.Off)
    <span class="hljs-selector-class">.edgeEffect</span>(EdgeEffect.Spring)
  }<span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.padding</span>({ top: <span class="hljs-number">12</span>, bottom: <span class="hljs-number">12</span>, left: <span class="hljs-number">15</span>, right: <span class="hljs-number">15</span> })
}<span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')
</code></pre>
<h3 data-id="heading-8">6.3. 列表区</h3>
<p>列表区整体布局参照图6-4。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02597159af9f4679bf1d0bbf7572804b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765071852&amp;x-signature=HD6Q3CwQU1VIrDJobuO4ug3Ct4k%3D" alt="" loading="lazy"/></p>
<p><strong>图6-4</strong> 布局示意图</p>
<p>代码如下：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 列表区</span>
<span class="hljs-built_in">Column</span>() {
  <span class="hljs-built_in">Row</span>() {
    <span class="hljs-built_in">Image</span>('https://p0.pipi.cn/basicdata/' 
          + '<span class="hljs-number">54</span>ecdedd5377e187a9e7aa5ee9ec15a184b18.jpg?' 
          + 'imageMogr2/thumbnail/<span class="hljs-number">2500</span>x2500%<span class="hljs-number">3</span>E?imageView2/<span class="hljs-number">1</span>/w/<span class="hljs-number">128</span>/h/<span class="hljs-number">180</span>'
    )<span class="hljs-selector-class">.width</span>(<span class="hljs-number">64</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">90</span>)
    
    <span class="hljs-built_in">Stack</span>({ alignContent: Alignment.End }) {
      <span class="hljs-built_in">Column</span>() {
        <span class="hljs-built_in">Row</span>() {
          Text('志愿军：存亡之战')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">17</span>)<span class="hljs-selector-class">.fontWeight</span>(FontWeight.Bold)
          <span class="hljs-built_in">Image</span>($rawfile('v2dimax.png'))<span class="hljs-selector-class">.width</span>(<span class="hljs-number">43</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">14</span>)<span class="hljs-selector-class">.margin</span>({ left: <span class="hljs-number">4</span> })
        }
        Text() {
          <span class="hljs-selector-tag">Span</span>('<span class="hljs-number">274337</span>')<span class="hljs-selector-class">.fontColor</span>('#faaf00')
          <span class="hljs-selector-tag">Span</span>('人想看')<span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">666</span>')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">13</span>)
        }
        Text('主演: 朱一龙,辛柏青,张子枫')<span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">666</span>')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">13</span>)
        Text('<span class="hljs-number">2024</span>-<span class="hljs-number">09</span>-<span class="hljs-number">30</span> 下周一上映')<span class="hljs-selector-class">.fontColor</span>('#<span class="hljs-number">666</span>')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">13</span>)
      }
        <span class="hljs-selector-class">.alignItems</span>(HorizontalAlign.Start)<span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.width</span>('<span class="hljs-number">100%</span>')
        <span class="hljs-selector-class">.justifyContent</span>(FlexAlign.SpaceEvenly)<span class="hljs-selector-class">.padding</span>({ right: <span class="hljs-number">53</span> })
      
      <span class="hljs-selector-tag">Button</span>() {
        Text('预售')<span class="hljs-selector-class">.fontColor</span>('#fff')<span class="hljs-selector-class">.fontSize</span>(<span class="hljs-number">13</span>)<span class="hljs-selector-class">.fontWeight</span>(<span class="hljs-number">500</span>)
      }<span class="hljs-selector-class">.width</span>(<span class="hljs-number">54</span>)<span class="hljs-selector-class">.height</span>(<span class="hljs-number">28</span>)<span class="hljs-selector-class">.backgroundColor</span>('#<span class="hljs-number">3</span>C9FE6')
      
    }
      <span class="hljs-selector-class">.height</span>('<span class="hljs-number">100%</span>')<span class="hljs-selector-class">.layoutWeight</span>(<span class="hljs-number">1</span>)<span class="hljs-selector-class">.margin</span>({ left: <span class="hljs-number">12</span> })
      <span class="hljs-selector-class">.padding</span>({ top: <span class="hljs-number">12</span>, right: <span class="hljs-number">14</span>, bottom: <span class="hljs-number">12</span>, left: <span class="hljs-number">0</span> })
      <span class="hljs-selector-class">.border</span>({ width: { bottom: <span class="hljs-number">1</span> }, color: '#eee' })
  }<span class="hljs-selector-class">.height</span>(<span class="hljs-number">144</span>)

  <span class="hljs-comment">// ... 其余7个Row与上述结构相同，因篇幅限制已省略，详见本书配套源码。</span>
}<span class="hljs-selector-class">.backgroundColor</span>('#fff')<span class="hljs-selector-class">.padding</span>({ left: <span class="hljs-number">15</span> })
</code></pre>
<p><strong>--THE END--</strong></p>
<p>本文配套视频教程观看地址：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fedu.csdn.net%2Flearn%2F40469%2F669240%3Fspm%3D3001.4143" target="_blank" title="https://edu.csdn.net/learn/40469/669240?spm=3001.4143" ref="nofollow noopener noreferrer">11-猫眼电影M站布局实战-布局框架</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fedu.csdn.net%2Flearn%2F40469%2F669241%3Fspm%3D3001.4143" target="_blank" title="https://edu.csdn.net/learn/40469/669241?spm=3001.4143" ref="nofollow noopener noreferrer">12-猫眼电影M站布局实战-头部区域布局</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fedu.csdn.net%2Flearn%2F40469%2F669242%3Fspm%3D3001.4143" target="_blank" title="https://edu.csdn.net/learn/40469/669242?spm=3001.4143" ref="nofollow noopener noreferrer">13-猫眼电影M站布局实战-脚部区域布局</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fedu.csdn.net%2Flearn%2F40469%2F669243%3Fspm%3D3001.4143" target="_blank" title="https://edu.csdn.net/learn/40469/669243?spm=3001.4143" ref="nofollow noopener noreferrer">14-猫眼电影M站布局实战-内容导航区布局</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fedu.csdn.net%2Flearn%2F40469%2F669244%3Fspm%3D3001.4143" target="_blank" title="https://edu.csdn.net/learn/40469/669244?spm=3001.4143" ref="nofollow noopener noreferrer">15-猫眼电影M站布局实战-最受电影区布局</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fedu.csdn.net%2Flearn%2F40469%2F669245%3Fspm%3D3001.4143" target="_blank" title="https://edu.csdn.net/learn/40469/669245?spm=3001.4143" ref="nofollow noopener noreferrer">16-猫眼电影M站布局实战-列表布局</a></p>
<p>✋ 需要参加鸿蒙认证的请点击 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F930c921fb4964857843b5540e7fa5cf3%3Ftype%3D1%253Fha_source%253Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/930c921fb4964857843b5540e7fa5cf3?type=1%3Fha_source%3Dhmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">鸿蒙认证链接</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HarmonyOS 应用开发基础案例（三）：使用DevEco Studio高效开发（篇一）]]></title>    <link>https://juejin.cn/post/7577693903018721306</link>    <guid>https://juejin.cn/post/7577693903018721306</guid>    <pubDate>2025-11-30T01:50:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577693903018721306" data-draft-id="7577693903018704922" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HarmonyOS 应用开发基础案例（三）：使用DevEco Studio高效开发（篇一）"/> <meta itemprop="keywords" content="HarmonyOS"/> <meta itemprop="datePublished" content="2025-11-30T01:50:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Raink"/> <meta itemprop="url" content="https://juejin.cn/user/3843548383566072"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HarmonyOS 应用开发基础案例（三）：使用DevEco Studio高效开发（篇一）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3843548383566072/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Raink
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T01:50:41.000Z" title="Sun Nov 30 2025 01:50:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读17分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>HUAWEI DevEco Studio是基于IntelliJ IDEA Community开源版本打造，为运行在HarmonyOS系统上的应用和元服务提供一站式的开发平台。</p>
<p>作为一款开发工具，除了具有基本的代码开发、编译构建及调测等功能外，DevEco Studio还具有如下特点：</p>
<ul>
<li>高效智能代码编辑：支持ArkTS、JS、C/C++等语言的代码高亮、代码智能补齐、代码错误检查、代码自动跳转、代码格式化、代码查找等功能，提升代码编写效率。</li>
<li>多端双向实时预览：支持UI界面代码的双向预览、实时预览、动态预览、组件预览以及多端设备预览，便于快速查看代码运行效果。</li>
<li>多端设备模拟仿真：提供HarmonyOS本地模拟器，支持Phone等设备的模拟仿真，便捷获取调试环境。</li>
<li>DevEco Profiler性能调优：提供实时监控能力和场景化调优模板，便于全方位的设备资源监测，采集数据覆盖多个维度，为开发者带来高效、直通代码行的调优体验。</li>
</ul>
<h2 data-id="heading-0">1. 工程管理</h2>
<p>DevEco Studio的工程管理涵盖应用和元服务的结构，其中APP Pack由HAP包和pack.info文件组成；支持工程目录的两种视图形式，并展示基于ArkTS Stage模型的目录结构；同时提供多种工程模板及创建新工程的详细流程，帮助开发者高效搭建与管理项目。</p>
<h3 data-id="heading-1">1.1. 工程介绍</h3>
<h4 data-id="heading-2">1.1.1. App包结构</h4>
<p>在进行应用/元服务开发前，我们应该掌握应用/元服务的逻辑结构。</p>
<p>应用/元服务发布形态为APP Pack（Application Package），它是由一个或多个HAP（Harmony Ability Package）包以及描述APP Pack属性的pack.info文件组成。</p>
<p>一个HAP在工程目录中对应一个Module，它是由代码、资源、三方库及应用/元服务配置文件组成，HAP可以分为Entry和Feature两种类型。</p>
<ul>
<li><strong>Entry：</strong> 应用的主模块，作为应用的入口，提供了应用的基础功能。</li>
<li><strong>Feature：</strong> 应用的动态特性模块，作为应用能力的扩展，可以根据用户的需求和设备类型进行选择性安装。</li>
</ul>
<p>Stage模型应用程序包结构如图1所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/618f0c2d3f3e4f34977e1c80769bbb70~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=DiFW6TdqbG4Vpy9TUj7Zg3E0R%2BM%3D" alt="" loading="lazy"/></p>
<p><strong>图1</strong> App包结构</p>
<h4 data-id="heading-3">1.1.2. 切换工程视图</h4>
<p>DevEco Studio工程目录结构提供工程视图和Ohos视图。工程视图（Project）展示工程中实际的文件结构，Ohos视图会隐藏一些编码中不常用到的文件，并将常用到的文件进行重组展示，方便开发者查询或定位所需编辑的模块或文件。</p>
<p>工程创建或打开后，默认显示工程视图，如果要切换到Ohos视图，在左上角单击<strong>Project</strong> &gt; <strong>Ohos</strong>进行切换 <strong>。</strong> 如图2所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/05372fd937044f848470e9242c542d78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=oSpB5kJP7kx9vtTzdcmyT0iYvp8%3D" alt="" loading="lazy"/></p>
<p><strong>图2</strong> 工程视图目录截图</p>
<h3 data-id="heading-4">1.2. 工程目录结构</h3>
<p>ArkTS Stage模型支持API Version 10及以上版本，其工程目录结构如图3所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8961e7d9f8c14cee88102319f29db4bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=OKDhSQvfFY7VrZTNz9UuBUSQCgo%3D" alt="" loading="lazy"/></p>
<p><strong>图3</strong> 某工程目录结构</p>
<ul>
<li><strong>AppScope &gt; app.json5</strong>：应用的全局配置信息。</li>
<li><strong>entry：</strong> 应用/元服务模块，编译构建生成一个HAP。</li>
</ul>

<ul>
<li>
<ul>
<li><strong>src &gt; main &gt; ets</strong>：用于存放ArkTS源码。</li>
<li><strong>src &gt; main &gt; ets &gt; entryability</strong>：应用/元服务的入口。</li>
<li><strong>src &gt; main &gt; ets &gt; pages</strong>：应用/元服务包含的页面。</li>
<li><strong>src &gt; main &gt; resources：</strong> 用于存放应用/元服务模块所用到的资源文件，如图形、多媒体、字符串、布局文件等。如表4-1所示。</li>
</ul>
</li>
</ul>













<table><thead><tr><th><strong>资源目录</strong></th><th><strong>资源文件说明</strong></th></tr></thead><tbody><tr><td>base&gt;element</td><td>包括字符串、整型数、颜色、样式等资源的json文件。每个资源均由json格式进行定义，例如：-   -   -   boolean.json：布尔型</td></tr></tbody></table>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">    -</span>   color.json：颜色
<span class="hljs-bullet">    -</span>   float.json：浮点型
<span class="hljs-bullet">    -</span>   intarray.json：整型数组
<span class="hljs-bullet">    -</span>   integer.json：整型
<span class="hljs-bullet">    -</span>   pattern.json：样式
<span class="hljs-bullet">    -</span>   plural.json：复数形式
<span class="hljs-bullet">    -</span>   strarray.json：字符串数组
<span class="hljs-bullet">    -</span>   string.json：字符串值 |
</code></pre>
<p>| base&gt;media   | 多媒体文件，如图形、视频、音频等文件，支持的文件格式包括： <strong>.png</strong>、 <strong>.gif</strong>、 <strong>.mp3</strong>、 <strong>.mp4</strong>等。                                                                                                                                                                                                                                           |
| rawfile      | 用于存储任意格式的原始资源文件。rawfile不会根据设备的状态去匹配不同的资源，需要指定文件路径和文件名进行引用。                                                                                                                                                                                                                                                       |</p>
<p><strong>表4-1</strong> 资源目录与文件说明</p>
<ul>
<li>
<ul>
<li><strong>src &gt; main &gt; module.json5</strong>：Stage模型模块配置文件，主要包含HAP的配置信息、应用在具体设备上的配置信息以及应用的全局配置信息。</li>
<li><strong>build-profile.json5：</strong> 当前的模块信息、编译信息配置项，包括buildOption、targets配置等。</li>
<li><strong>hvigorfile.ts</strong>：模块级编译构建任务脚本。</li>
<li><strong>oh-package.json5</strong>：描述三方包的包名、版本、入口文件（类型声明文件）和依赖项等信息。</li>
</ul>
</li>
</ul>

<ul>
<li><strong>oh_modules</strong>：用于存放三方库依赖信息，包含应用/元服务所依赖的第三方库文件。</li>
<li><strong>build-profile.json5：</strong> 应用级配置信息，包括签名、产品配置等。</li>
<li><strong>hvigorfile.ts：</strong> 应用级编译构建任务脚本。</li>
<li><strong>oh-package.json5：</strong> 描述全局配置，如：依赖覆盖（overrides）、依赖关系重写（overrideDependencyMap）和参数化配置（parameterFile）等。</li>
</ul>
<h3 data-id="heading-5">1.3. 工程模板介绍</h3>
<p>DevEco Studio支持多种品类的应用/元服务开发，预置丰富的工程模板，可以根据工程向导轻松创建适应于各类设备的工程，并自动生成对应的代码和资源模板。同时，DevEco Studio还提供了多种编程语言供开发者进行应用/元服务开发，包括ArkTS、JS和C/C++。如图4所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2ddcd7e3ba1e4cc6a5548aa317ccc464~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=uZUaXJsMq%2FBe3N7chRuYdonotIQ%3D" alt="" loading="lazy"/></p>
<p><strong>图4</strong> 创建项目</p>
<p>工程模板支持的开发语言及模板说明如表4-2所示：</p>

































<table><thead><tr><th><strong>模板名称</strong></th><th><strong>说明</strong></th></tr></thead><tbody><tr><td>Empty Ability</td><td>用于Phone、Tablet、2in1、Car设备的模板，展示基础的Hello World功能。</td></tr><tr><td>Native C++</td><td>用于Phone、Tablet、2in1、Car设备的模板，作为应用调用C++代码的示例工程，界面显示“Hello World”。</td></tr><tr><td>[CloudDev]Empty Ability</td><td>端云一体化开发通用模板。</td></tr><tr><td>[Lite]Empty Ability</td><td>用于Lite Wearable设备的模板，展示了基础的Hello World功能。可基于此模板，修改设备类型及RuntimeOS，进行小型嵌入式设备开发。</td></tr><tr><td>Flexible Layout Ability</td><td>用于创建跨设备应用开发的三层工程结构模板。三层工程结构包含common（公共能力层）、features（基础特性层）、products（产品定制层）。</td></tr><tr><td>Embeddable Ability</td><td>用于开发支持被其他应用嵌入式运行的元服务的工程模板。</td></tr></tbody></table>
<p><strong>表4-2</strong> 模版说明</p>
<h3 data-id="heading-6">1.4. ****创建一个新的工程</h3>
<p>当您开始开发一个应用/元服务时，首先需要根据工程创建向导，创建一个新的工程，工具会自动生成对应的代码和资源模板。</p>
<ol>
<li>通过如下两种方式，打开工程创建向导界面。</li>
</ol>
<ul>
<li>如果当前未打开任何工程，可以在DevEco Studio的欢迎页，选择<strong>Create Project</strong>开始创建一个新工程。</li>
<li>如果已经打开了工程，可以在菜单栏选择<strong>File &gt; New &gt; Create Project</strong>来创建一个新工程。</li>
</ul>
<ol start="2">
<li>根据工程创建向导，选择创建Application或Atomic Service。再选择需要的Ability工程模板，然后单击<strong>Next</strong>。</li>
<li>在工程配置页面，需要根据向导配置工程的基本信息。</li>
</ol>
<ul>
<li><strong>Project name</strong>：工程的名称，可以自定义，由大小写字母、数字和下划线组成。</li>
<li><strong>Bundle name</strong>：标识应用的包名，用于标识应用的唯一性。</li>
<li><strong>Save location</strong>：工程文件本地存储路径，由大小写字母、数字和下划线等组成，不能包含中文字符。</li>
<li><strong>Compatible SDK</strong>：兼容的最低API Version。</li>
<li><strong>Module name</strong>： 模块的名称。</li>
<li><strong>Device type：</strong> 该工程模板支持的设备类型。</li>
</ul>
<p>如图5所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/624dc014b2814698b09fcf6feee5d7b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=CYC554rm%2Fkq3YwzP2mA0fGom83E%3D" alt="" loading="lazy"/></p>
<p><strong>图5</strong> 配置项目</p>
<ol start="4">
<li>单击<strong>Finish</strong>，工具会自动生成示例代码和相关资源，等待工程创建完成。</li>
</ol>
<h2 data-id="heading-7">2. 代码编辑</h2>
<p>本节介绍代码阅读、生成/补全、实时检查与修复、重构等常用操作。DevEco Studio支持多语言代码的高亮显示、快捷跳转和智能格式化，提供自动补全、构造器快速生成等功能，能够实时检测并修复代码错误，同时支持提取方法、重命名等重构操作，有效提升编码效率。</p>
<h3 data-id="heading-8">2.1. 代码阅读</h3>
<p>DevEco Studio支持使用多种语言进行应用/元服务的开发，包括ArkTS、JS和C/C++。在编写应用/元服务阶段，可以通过掌握代码编写的各种常用技巧，来提升编码效率。</p>
<h4 data-id="heading-9">2.1.1. 代码高亮</h4>
<p>支持对代码关键字、运算符、字符串、类、标识符、注释等进行高亮显示，您可以打开<strong>File &gt; Settings</strong>（macOS为<strong>DevEco Studio &gt; Preferences</strong>）面板，在<strong>Editor &gt; Color Scheme</strong>自定义各字段的高亮显示颜色 <strong>。</strong> 默认情况下，您可以在<strong>Language Defaults</strong>中设置源代码中的各种高亮显示方案，该设置将对所有语言生效；如果您需要针对具体语言的源码高亮显示方案进行定制，可以在左侧边栏选择对应的语言，然后取消“Inherit values from”选项后设置对应的颜色即可。如图6所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b2284f65e0146758eddcd43eaa5a0ec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=PjBIW8p%2B%2BNiAySx4MYcEQUCEm4s%3D" alt="" loading="lazy"/></p>
<p><strong>图6</strong> 代码高亮设置</p>
<h4 data-id="heading-10">2.1.2. 代码跳转</h4>
<p>在编辑器中，可以按住<strong>Ctrl</strong>键（macOS为<strong>Command</strong>键），鼠标单击代码中引用的类、方法、参数、变量等名称，自动跳转到定义处。若单击定义处的类、变量等名称，当仅有一处引用时，可直接跳转到引用位置；若有多处引用，在弹窗中可以选择想要查看的引用位置。</p>
<h4 data-id="heading-11">2.1.3. 代码格式化</h4>
<p>代码格式化功能可以帮助您快速的调整和规范代码格式，提升代码的美观度和可读性。默认情况下，DevEco Studio已预置了代码格式化的规范，您也可以个性化的设置各个文件的格式化规范，设置方式如下：在<strong>File &gt; Settings &gt; Editor &gt; Code Style</strong>（macOS为<strong>DevEco Studio &gt; Preferences &gt;</strong> ****<strong>Editor</strong> ****<strong>&gt;</strong> ****<strong>Code Style</strong>）下，选择需要定制的文件类型，如ArkTS，然后自定义格式化规范即可。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e7e29b80f9774818b9de4efb04675ae4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=k2xtFZLDG5s9LoHMIu9SweJVgJ8%3D" alt="" loading="lazy"/></p>
<p><strong>图7 代码格式化设置</strong></p>
<p>在使用代码格式化功能时，您可以使用快捷键<strong>Ctrl + Alt + L</strong>（macOS为<strong>Option+Command +L</strong>） 可以快速对选定范围的代码进行格式化。</p>
<p>如果在进行格式化时，对于部分代码片段不需要进行自动的格式化处理，可以通过如下方式进行设置：</p>
<ol>
<li>在<strong>File &gt; Settings &gt;Editor &gt; Code Style</strong>（macOS为<strong>DevEco Studio &gt; Preferences &gt; Editor &gt; Code Style</strong>），单击“Formatter”，勾选“Turn formatter on/off with markers in code comments”。如图8所示。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9821d101f16c4988ac79e25b0f761adc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=N8SKN0iIMc%2BHb2T3ciEQAZxaLHc%3D" alt="" loading="lazy"/></p>
<p><strong>图8</strong> 代码样式</p>
<p>在不需要进行格式化操作的代码块前增加“//@formatter:off”，并在该代码块的最后增加“//@formatter:on”，即表示对该范围的代码块不需要进行格式化操作。如图9所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3a35e9f1a72a49eca2386a98a38a1685~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=Ta06O23LwbYLegx5FTEGnmG7U%2BA%3D" alt="" loading="lazy"/></p>
<p><strong>图9</strong> 代码格式化</p>
<h4 data-id="heading-12">2.1.4. 代码折叠</h4>
<p>支持对代码块的快速折叠和展开，既可以单击编辑器左侧边栏的折叠和展开按钮对代码块进行折叠和展开操作，还可以对选中的代码块单击鼠标右键选择折叠方式，包括折叠、递归折叠、全部折叠等操作。如图10所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3c501b9bc1f243248fee75441615c047~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=RDTEOizal4XEQkJZ1YntzlZKzJo%3D" alt="" loading="lazy"/></p>
<p><strong>图10</strong> 代码折叠</p>
<h4 data-id="heading-13">2.1.5. 代码快速注释</h4>
<p>支持对选择的代码块进行快速注释，使用快捷键<strong>Ctrl+/</strong> （macOS为<strong>Command+/</strong> ）进行快速注释。对于已注释的代码块，再次使用快捷键<strong>Ctrl+/</strong> （macOS为<strong>Command+/</strong> ）取消注释。如图11所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5137bc7fbde441918570a4a57e81bbc5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=1sFzQxL8%2Bl7DFpIaNDNpi0UDGB8%3D" alt="" loading="lazy"/></p>
<p><strong>图11</strong> 代码注释</p>
<h4 data-id="heading-14">2.1.6. 代码结构树</h4>
<p>使用快捷键<strong>Alt + 7 / Ctrl + F12</strong>（macOS为<strong>Command+7</strong>）打开代码结构树，快速查看文件代码的结构树，包括全局变量和函数，类成员变量和方法等，并可以跳转到对应代码行。如图12所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bb7c90b8a1640c0a5a90175c323c832~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=xpz%2Fmz7ic6VprZTyife8nrfSsuw%3D" alt="" loading="lazy"/></p>
<p><strong>图12</strong> 代码结构树</p>
<h4 data-id="heading-15">2.1.7. 代码引用查找</h4>
<p>提供Find Usages代码引用查找功能，帮助开发者快速查看某个对象(变量、函数或者类等)被引用的地方，用于后续的代码重构，可以极大的提升开发者的开发效率。</p>
<p>使用方法：在要查找的对象上，单击鼠标<strong>右键 &gt; Find Usages</strong>或使用快捷键<strong>Alt +F7</strong>（macOS为<strong>Option +</strong> <strong>F7</strong>）。可点击<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d7430824fca34fcb96d46a7c316c5605~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=Asnjc33FEaqDayjTcF0gIslELgY%3D" alt="" loading="lazy"/>图标查看变量赋值位置，点击<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e05d4513dfe346ea80ca2e2fa88a3f84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=Ob2wg08s8RKmXM6ypc9jHXnxBuY%3D" alt="" loading="lazy"/>图标查看变量引用情况。如图13所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/945a175dac1c4eab92adb6e79006081f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=Q04RnrzfpD6hqMoo9qCmVZ7K9eA%3D" alt="" loading="lazy"/></p>
<p><strong>图13</strong> 代码引用查找</p>
<h4 data-id="heading-16">2.1.8. 函数注释生成</h4>
<p>DevEco Studio支持在函数定义处，快速生成对应的注释。在函数定义的代码块前，输入 <strong>“/</strong>”+回车键**，快速生成注释信息。如图14所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/748619c8fa6043e8bea8bfc3b779b0f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=kbl8JLZj1PeZId9aaIcBT4Ca3mk%3D" alt="" loading="lazy"/></p>
<p><strong>图14</strong> 函数注释生成</p>
<h4 data-id="heading-17">2.1.9. 代码查找</h4>
<p>通过对符号、类或文件的即时导航来查找代码。检查调用或类型层次结构，轻松地搜索工程里的所有内容。通过连续点击两次Shift快捷键，打开代码查找界面，在搜索框中输入需要查找内容，下方窗口实时展示搜索结果。双击查找的结果可以快速打开所在文件的位置。如图15所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b8dd72af0d846ffa0b30f314794d2b7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=FHPcytkRn48mRW22Zk07a2LChEo%3D" alt="" loading="lazy"/></p>
<p><strong>图15</strong> 代码查找</p>
<h4 data-id="heading-18">2.1.10. 快速查阅API接口及组件参考文档</h4>
<p>在编辑器中调用ArkTS/JS API或组件时，支持在编辑器中快速、精准调取出对应的参考文档。</p>
<p>可在编辑器中，鼠标悬停在需要查阅的接口或组件，弹窗将显示当前接口/组件在不同API版本下的参数等信息，单击弹窗右下角Show in API Reference，或选中接口或组件，右键点击Show in API Reference，可以快速查阅更详细的API文档。如图16、图17所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77241bc48f634c34b156417006de4422~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=O7MsavzQ8jUQvWsCawMKN%2BOs%2BpI%3D" alt="" loading="lazy"/></p>
<p><strong>图16</strong> 查阅API参考入口</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a196218334c54f3085374409f958d5d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=FwI18KlnZXywkyYmtdCgKyNGq0o%3D" alt="" loading="lazy"/></p>
<p><strong>图17</strong> 快速查阅API</p>
<h4 data-id="heading-19">2.1.11. Optimize Imports功能</h4>
<p>使用编辑器提供的Optimize Imports，可以快速清除未使用的import，并根据设置的规则对import进行合并或排序。选择文件或目录，使用快捷键Ctrl+Alt+O（macOS为Control+Option+O），或单击菜单栏Code &gt; Optimize Imports。</p>
<h3 data-id="heading-20">2.2. 代码生成/补全</h3>
<h4 data-id="heading-21">2.2.1. 代码自动补全</h4>
<p>提供代码的自动补全能力，编辑器工具会分析上下文，并根据输入的内容，提示可补全的类、方法、字段和关键字的名称等，支持模糊匹配。</p>
<p>自动补齐功能默认按最短路径进行排序，如仅需按照最近使用过的类、方法、字段和关键字等名称提供补全内容排序，可以在File &gt; Settings（MacOS为DevEco Studio &gt; Preferences） &gt; Editor &gt; General &gt; Code Completion 中勾选“Sort suggestions by recently used”。</p>
<h4 data-id="heading-22">2.2.2. 快速覆写父类</h4>
<p>DevEco Studio提供Override Methods，辅助开发者根据父类模板快速生成子类方法，提升开发效率。将光标放于子类定义位置，使用快捷键Ctrl+O，或右键单击Generate...，选择Override Methods，指定需要覆写的对象（方法、变量等），点击OK将自动生成该对象的覆写代码。</p>
<h4 data-id="heading-23">2.2.3. 快速生成构造器</h4>
<p>编辑器支持为类快速生成一个对应的构造函数。</p>
<p>在类中使用快捷键Alt+Insert，或单击鼠标右键选择Generate...，在弹窗中选择Constructor，选择一个或多个需要生成构造函数的参数，点击OK。若选择Select None，则生成不带参数的构造器。</p>
<h4 data-id="heading-24">2.2.4. 快速生成get/set方法</h4>
<p>编辑器支持为类成员变量或对象属性快速生成get和set方法。</p>
<p>将光标放置在当前类中，单击右键选择Generate...&gt;Getter and Setter，或者使用快捷键Alt+Insert，在菜单中选择Getter and Setter，完成方法快速生成。</p>
<h3 data-id="heading-25">2.3. 代码实时检查及快速修复</h3>
<h4 data-id="heading-26">2.3.1. 实时检查</h4>
<p>编辑器会实时的进行代码分析，如果输入的语法不符合编码规范，或者出现语义语法错误，将在代码中突出显示错误或警告，将鼠标放置在错误代码处，会提示详细的错误信息。如图18所示。</p>
<p>从DevEco Studio 4.0 Release版本开始，当compatibleSdkVersion≥10时，编辑器代码实时检查支持ArkTS性能语法规范检查。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ab36b146abac45138879343dfeb7aaf5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=W2OVltwrGNmRM294PO49LVHhfKQ%3D" alt="" loading="lazy"/></p>
<p><strong>图18</strong> 实时检查</p>
<h4 data-id="heading-27">2.3.2. 代码快速修复</h4>
<p>DevEco Studio支持代码快速修复能力，辅助开发者快速修复ArkTS代码问题。</p>
<p><strong>查看告警信息：</strong> 使用双击<strong>Shift</strong>快捷键打开文件查询框，输入<strong>problems</strong>打开问题工具面板；双击对应告警信息，可以查看告警的具体位置及原因。</p>
<p><strong>快速修复：</strong> 将光标放在错误告警的位置，可在弹出的悬浮窗中查看问题描述和对应修复方式；单击<strong>More actions</strong>可查看更多修复方法。或是在页面出现灯泡图标时，可点击图标并根据相应建议，实现代码快速修复。如图19所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78b896679c34433091ba25dbdb9fd6fc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=WvT0ZzW6Li61%2BEEDiNm9WonmEpU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/95e7fb39a6d545ccbfa1ac5a0e397744~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=wAwsgJL%2BvQfvm%2BtI%2FqoGZIRIKzk%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad47f6169c014186aa19fa954bfb2852~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=77%2FQSaYzXH5kxG6Dx51KoPZrH1w%3D" alt="" loading="lazy"/></p>
<p><strong>图19</strong> 快速修复</p>
<h3 data-id="heading-28">2.4. 代码重构</h3>
<h4 data-id="heading-29">2.4.1. Refactor-Extract代码提取</h4>
<p>在编辑器中支持将函数内、类方法内等区域代码块或表达式，提取为新方法/函数（Method）、常量（Constant）、接口（Interface）、变量（Variable）或类型别名（Type Alias）。准确便捷的将所选区域代码从当前作用域内进行提取，提升编码效率。选中所需要提取的代码块，右键单击<strong>Refactor</strong>，选择需要提取的类型。</p>
<h4 data-id="heading-30">2.4.2. Refactor-Rename代码重命名</h4>
<p>代码编辑支持Rename功能，可以快速更改变量、方法、对象属性等相关标识符及文件、模块的名称，并同步到整个工程中对其进行引用的位置。</p>
<p>使用方式：选中需要重新命名的标识符（变量、类、接口、自定义组件等），右键单击Refactor，选择Rename...（或使用快捷键Shift+F6），在弹框中输入新的标识符名称，并在Scope中选择替换的范围，点击Refactor完成重新命名。</p>
<p>代码编辑支持筛选并过滤不需要rename的引用位置。在Rename...弹窗中点击Preview，在弹出预览窗口中，用户选中无需Rename的选项，单击右键菜单Exclude/Remove进行过滤/删除，完成筛选后点击左下角Do Refactor，重新执行Rename操作。</p>
<h4 data-id="heading-31">2.4.3. Move File</h4>
<p>在文件中单击右键，选择Refactor &gt; Move File...，在弹窗中输入或点击...选择指定的目录，点击Refactor，可将当前文件移动至该目录下。勾选Search for references，可查找并更新工程中对该文件的引用；勾选Open in editor，可在编辑器中查看移动的文件。</p>
<h4 data-id="heading-32">2.4.4. Safe Delete</h4>
<p>编辑器支持Safe Delete功能，帮助您安全地删除代码中的标识符对象（变量、函数或类等）或删除指定文件。在删除前，编辑器将先在代码中搜索对该对象的引用，如果存在引用，编辑器将提示您进行必要的检查和调整。</p>
<p><strong>使用方式</strong>：在编辑器内选中需要删除的标识符对象或在工程目录选择待删除的文件，右键单击Refactor，选择Safe Delete，单击OK将自动检查当前对象在代码中被引用的情况，点击View Usages可查看具体使用的代码内容，点击Delete Anyway将直接删除该对象的定义。</p>
<h3 data-id="heading-33">2.5. 生成ArkTSDoc文档</h3>
<ol>
<li>在菜单栏选择<strong>Tools &gt; Generate ArkTSDoc...</strong> 进入ArkTSDoc生成界面。如图20所示。</li>
<li>设置生成ArkTSDoc的范围，可选择整个工程、某个模块或目录、单个文件进行导出。在Output directory中指定导出ArkTSDoc的存储路径。</li>
</ol>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ea3166929abd490880e632e2400d7420~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=pckdqswKdD%2BltbONF10LVi8vSXE%3D" alt="" loading="lazy"/></p>
<p><strong>图20</strong> 生成ArkTSDoc文档入口</p>
<ol start="3">
<li>若勾选<strong>Open generated documentation in browser</strong>选项，在生成ArkTSDoc后，将自动打开相应页面查看生成的文档。配置完毕后点击Generate，开始扫描并生成ArkTSDoc文档。</li>
</ol>
<p>生成的ArkTSDoc左侧文档目录和原工程目录结构一致，右侧可点击跳转到当前文件包含的某个变量、方法、接口或类的文档位置。如图21所示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8687f3cb957468ea08533d3762cb4c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUmFpbms=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765072241&amp;x-signature=GL%2FYRFHpqdNVaf1pXqe6V7oiyrg%3D" alt="" loading="lazy"/></p>
<p><strong>图21</strong> 生成文档</p>
<p>若没有勾选<strong>Open generated documentation in browser</strong>选项，在生成ArkTSDoc后，DevEco Studio右下角弹出对应提示框，可以点击Go to Folder跳转到生成的ArkTSDoc文件夹，用浏览器打开文件夹中index.html文件即可查看ArkTSDoc文档。</p>
<p><strong>--未完待续--</strong></p>
<p>本文配套视频教程观看地址：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fedu.csdn.net%2Flearn%2F40469%2F669272%3Fspm%3D3001.4143" target="_blank" title="https://edu.csdn.net/learn/40469/669272?spm=3001.4143" ref="nofollow noopener noreferrer">01-工具介绍</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fedu.csdn.net%2Flearn%2F40469%2F669273%3Fspm%3D3001.4143" target="_blank" title="https://edu.csdn.net/learn/40469/669273?spm=3001.4143" ref="nofollow noopener noreferrer">02-工程管理</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fedu.csdn.net%2Flearn%2F40469%2F669274%3Fspm%3D3001.4143" target="_blank" title="https://edu.csdn.net/learn/40469/669274?spm=3001.4143" ref="nofollow noopener noreferrer">03-代码阅读</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fedu.csdn.net%2Flearn%2F40469%2F669275%3Fspm%3D3001.4143" target="_blank" title="https://edu.csdn.net/learn/40469/669275?spm=3001.4143" ref="nofollow noopener noreferrer">04-代码编辑-代码生成补全、代码检查、代码重构和生成ArkTSDoc文档</a></p>
<p>✋ 需要参加鸿蒙认证的请点击 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Ftraining%2FclassDetail%2F930c921fb4964857843b5540e7fa5cf3%3Ftype%3D1%253Fha_source%253Dhmosclass%26ha_sourceId%3D89000248" target="_blank" title="https://developer.huawei.com/consumer/cn/training/classDetail/930c921fb4964857843b5540e7fa5cf3?type=1%3Fha_source%3Dhmosclass&amp;ha_sourceId=89000248" ref="nofollow noopener noreferrer">鸿蒙认证链接</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[淘宝实时商品API接口：采集竞品商品详情页的价格、SKU 规格、库存数量、卖点文案、图文内容、售后政策（运费、退换货规则）、评价核心标签]]></title>    <link>https://juejin.cn/post/7577702891273928739</link>    <guid>https://juejin.cn/post/7577702891273928739</guid>    <pubDate>2025-11-30T06:53:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577702891273928739" data-draft-id="7577713754563657780" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="淘宝实时商品API接口：采集竞品商品详情页的价格、SKU 规格、库存数量、卖点文案、图文内容、售后政策（运费、退换货规则）、评价核心标签"/> <meta itemprop="keywords" content="数据可视化,数据分析,数据挖掘"/> <meta itemprop="datePublished" content="2025-11-30T06:53:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户4142929607239"/> <meta itemprop="url" content="https://juejin.cn/user/2579871227198947"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            淘宝实时商品API接口：采集竞品商品详情页的价格、SKU 规格、库存数量、卖点文案、图文内容、售后政策（运费、退换货规则）、评价核心标签
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2579871227198947/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户4142929607239
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T06:53:00.000Z" title="Sun Nov 30 2025 06:53:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>淘宝商品详情API接口是用来获取淘宝商品详情信息的接口，可以获取到商品的价格、sku规格、商品主图、详情图片、商品视频等。还可以通过评论接口获取商品评论信息。</p>
<p>请求参数为商品的唯一标识，商品id。通过商品链接可以拿到。</p>
<p>item_get_pro-获得淘宝商品详情高级版</p>
<p>item_review 获取商品评论信息</p>
<h3 data-id="heading-0">公共参数 <a href="https://link.juejin.cn?target=https%3A%2F%2Fo0b.cn%2Fijenni" target="_blank" title="https://o0b.cn/ijenni" ref="nofollow noopener noreferrer">点此注册账号获取key测试</a></h3>





















































<table><thead><tr><th>名称</th><th>类型</th><th>必须</th><th>描述</th></tr></thead><tbody><tr><td>key</td><td>String</td><td>是</td><td>调用key（必须以GET方式拼接在URL中）</td></tr><tr><td>secret</td><td>String</td><td>是</td><td>调用密钥</td></tr><tr><td>api_name</td><td>String</td><td>是</td><td>API接口名称（包括在请求地址中）[item_search,item_get,item_search_shop等]</td></tr><tr><td>cache</td><td>String</td><td>否</td><td>[yes,no]默认yes，将调用缓存的数据，速度比较快</td></tr><tr><td>result_type</td><td>String</td><td>否</td><td>[json,jsonu,xml,serialize,var_export]返回数据格式，默认为json，jsonu输出的内容中文可以直接阅读</td></tr><tr><td>lang</td><td>String</td><td>否</td><td>[cn,en,ru]翻译语言，默认cn简体中文</td></tr><tr><td>version</td><td>String</td><td>否</td><td>API版本</td></tr></tbody></table>
<h3 data-id="heading-1">请求参数</h3>
<p>请求参数：num_iid=520813250866 参数说明：num_iid:淘宝商品ID</p>
<h3 data-id="heading-2">请求示例</h3>
<pre><code class="hljs language-lua" lang="lua">	
<span class="hljs-comment">-- 请求示例 url 默认请求参数已经URL编码处理</span>
curl -i <span class="hljs-string">"https://api-服务器.cn/taobao/item_get_pro/?key=&lt;您自己的apiKey&gt;&amp;secret=&lt;您自己的apiSecret&gt;&amp;num_iid=520813250866"</span>
</code></pre>
<h3 data-id="heading-3">响应实例</h3>
<pre><code class="hljs language-ruby" lang="ruby">{
	<span class="hljs-string">"item"</span>: {
		<span class="hljs-string">"num_iid"</span>: <span class="hljs-string">"520813250866"</span>,
		<span class="hljs-string">"title"</span>: <span class="hljs-string">"三刃木折叠刀过安检创意迷你钥匙扣钥匙刀军刀随身多功能小刀包邮"</span>,
		<span class="hljs-string">"desc_short"</span>: <span class="hljs-string">""</span>,
		<span class="hljs-string">"price"</span>: <span class="hljs-string">"25.8"</span>,
		<span class="hljs-string">"total_price"</span>: <span class="hljs-string">""</span>,
		<span class="hljs-string">"suggestive_price"</span>: <span class="hljs-string">""</span>,
		<span class="hljs-string">"orginal_price"</span>: <span class="hljs-string">"25.80"</span>,
		<span class="hljs-string">"nick"</span>: <span class="hljs-string">"欢乐购客栈"</span>,
		<span class="hljs-string">"num"</span>: <span class="hljs-number">16840</span>,
		<span class="hljs-string">"detail_url"</span>: <span class="hljs-string">"https://item.taobao.com/item.htm?id=520813250866"</span>,
		<span class="hljs-string">"pic_url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i4/2596264565/O1CN01mbmuAB1jaogMUWhv8_!!2596264565.jpg"</span>,
		<span class="hljs-string">"brand"</span>: <span class="hljs-string">"三刃木"</span>,
		<span class="hljs-string">"brandId"</span>: <span class="hljs-string">"4036703"</span>,
		<span class="hljs-string">"rootCatId"</span>: <span class="hljs-string">"50013886"</span>,
		<span class="hljs-string">"cid"</span>: <span class="hljs-string">"50014822"</span>,
		<span class="hljs-string">"desc"</span>: <span class="hljs-string">"\n  &lt;p &gt;&lt;span &gt;&lt;span &gt;&lt;strong&gt;小店所有产品都支持刻字，如需刻字，拍之前联系客服即可。&lt;/strong&gt;&lt;/span&gt;&lt;/span&gt;&lt;/p&gt; \n  &lt;p &gt;&lt;span &gt;&lt;strong&gt;炎炎夏日来临，一把随身携带便携式的折叠小刀，&lt;span &gt;带开瓶器功能&lt;/span&gt;，喝酒不用愁。（钥匙刀不带开瓶器功能）&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt; \n  &lt;p &gt;&lt;strong &gt;&lt;span &gt;&lt;span &gt;可以当吊牌项链装饰，也可当钥匙扣挂饰， 水果刀 开瓶器 户外防身.&lt;/span&gt;&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt; \n  &lt;p &gt;&lt;strong &gt;&lt;span &gt;部分客户跟我们反映链子质量还不够好，因此小店已重新订购一批质量更好的链子赠送，&lt;span &gt;加量不加价&lt;/span&gt;，只为让你买的更舒心，戴的更放心。&lt;/span&gt;&lt;/strong&gt;&lt;/p&gt; \n  &lt;p &gt;&lt;span &gt;&lt;strong&gt;购买就送&lt;span &gt;工具刀卡和链子&lt;/span&gt;一条&lt;/strong&gt;&lt;/span&gt;&lt;/p&gt; \n  &lt;p &gt;&lt;span &gt;&lt;strong&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i3/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2Sci2jXXXXXXFXp</span>XXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.png<span class="hljs-string">" /&gt; &lt;/strong&gt;&lt;/span&gt;&lt;/p&gt; \n  &lt;p &gt;&lt;span &gt;&lt;strong&gt;璀璨钻石套餐包含【SK016D钥匙扣+GJ019C折叠刀+GJ017D工具卡】&lt;/strong&gt;&lt;/span&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i3/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2wWohmXXXXXX8</span>XXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg<span class="hljs-string">" /&gt;&lt;/p&gt; \n  &lt;p &gt;&lt;span &gt;&lt;strong&gt;超凡大师套餐包括【304不锈钢钥匙扣+GJ019C折叠刀+GJ017D工具卡】&lt;/strong&gt;&lt;/span&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i4/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2</span>_uiXnFXXXXXBXXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">"  /&gt;&lt;/p&gt; \n  &lt;p &gt;&amp;nbsp;&lt;/p&gt; \n  &lt;p &gt;&lt;span &gt;&lt;strong&gt;最强王者套餐包括【钛钢钥匙扣+GJ019C折叠刀+GJ017D工具卡】&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i4/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2Gm9xnFXXXXbm</span>XXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">"  /&gt; &lt;/strong&gt;&lt;/span&gt;&lt;/p&gt; \n  &lt;p &gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i3/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB28Ox4b77OyuJjSsplXXXqdpXa</span>_!!<span class="hljs-number">2596264565</span>.jpg<span class="hljs-string">" /&gt; &lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i1/</span><span class="hljs-number">2596264565</span>/<span class="hljs-variable constant_">TB2</span>.mTddVXXXXbeXpXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg<span class="hljs-string">"  /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i3/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB21Ro</span>.jl0lpuFjSszdXXcdxFXa_!!<span class="hljs-number">2596264565</span>.jpg<span class="hljs-string">" /&gt; &lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i4/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2q9CelVXXXXc</span>UXXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg<span class="hljs-string">" /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i3/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB21EX9lVXXXXaXXp</span>XXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg<span class="hljs-string">" /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i3/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2udCylVXXXXXg</span>XXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">" /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i1/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2EARxjB8lpuFjSspaXXXJKpXa</span>_!!<span class="hljs-number">2596264565</span>.jpg<span class="hljs-string">" /&gt; &lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i3/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2ssuwlVXXXXaf</span>XXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">" /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i2/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2nAHqgyC9MuFjSZFoXXbUzFXa</span>_!!<span class="hljs-number">2596264565</span>.jpg<span class="hljs-string">" /&gt; &lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i3/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2ahCelVXXXXc</span>_XXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">" /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i3/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2w1JnjwRkpuFjy1zeXXc</span>.6FXa_!!<span class="hljs-number">2596264565</span>.jpg<span class="hljs-string">" /&gt; &lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i3/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2C902lVXXXXbnXp</span>XXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">" /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i1/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2sGR3lVXXXXblXp</span>XXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">" /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i1/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2ZBGxl</span>VXXXXXMXXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">" /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i1/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2MjWklVXXXXca</span>XXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">" /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i2/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2UgV3lVXXXXbdXp</span>XXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">" /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i2/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2ip5XlVXXXXX2Xp</span>XXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">" /&gt; &lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i2/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2sMTBdVXXXXXl</span>XXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">"  /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i3/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2d3HfdVXXXXahXp</span>XXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">"  /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i4/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2AVbBdVXXXXXk</span>XXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">"  /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i2/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2nf</span>_wdVXXXXaMXXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">"  /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i4/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2dLYddVXXXXbtXp</span>XXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">"  /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i2/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2H1</span>_adVXXXXbWXpXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">"  /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i2/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2eBzsdVXXXXbu</span>XXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">"  /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i4/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2dOTndVXXXXc</span>CXXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">"  /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i2/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2fK2tdVXXXXbk</span>XXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">"  /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i2/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB29zjedVXXXXaFXp</span>XXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">"  /&gt;&lt;img align="</span>absmiddle<span class="hljs-string">" src="</span><span class="hljs-symbol">http:</span>/<span class="hljs-regexp">/img.alicdn.com/imgextra</span><span class="hljs-regexp">/i3/</span><span class="hljs-number">2596264565</span>/<span class="hljs-title class_">TB2i7rmdVXXXXc</span>TXXXXXXXXXXXX_!!<span class="hljs-number">2596264565</span>.jpg_q90.jpg<span class="hljs-string">"  /&gt;&lt;/p&gt;\n  "</span>,
		<span class="hljs-string">"item_imgs"</span>: [
			{
				<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i4/2596264565/O1CN01mbmuAB1jaogMUWhv8_!!2596264565.jpg"</span>
			},
			{
				<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i3/2596264565/O1CN01dVHKvp1jaogIQyUBv_!!2596264565.jpg"</span>
			},
			{
				<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i1/2596264565/TB2a.x.lVXXXXXPXpXXXXXXXXXX_!!2596264565.jpg"</span>
			},
			{
				<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i4/2596264565/TB2p30elFXXXXXQXpXXXXXXXXXX_!!2596264565.jpg"</span>
			},
			{
				<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i4/2596264565/TB2j2cTXib_F1JjSZFzXXc6KXXa_!!2596264565.jpg"</span>
			}
		],
		<span class="hljs-string">"item_weight"</span>: <span class="hljs-string">""</span>,
		<span class="hljs-string">"post_fee"</span>: <span class="hljs-string">""</span>,
		<span class="hljs-string">"express_fee"</span>: null,
		<span class="hljs-string">"ems_fee"</span>: <span class="hljs-string">""</span>,
		<span class="hljs-string">"shipping_to"</span>: <span class="hljs-string">""</span>,
		<span class="hljs-string">"sample_id"</span>: <span class="hljs-string">""</span>,
		<span class="hljs-string">"props_name"</span>: <span class="hljs-string">"1627207:1347647754:颜色分类:长方形带开瓶器+送工具刀卡+链子;1627207:1347647753:颜色分类:椭圆形带开瓶器+送工具刀卡+链子;1627207:1195392087:颜色分类:GJ018X钥匙刀+送工具刀卡+链子;1627207:1331112595:颜色分类:超凡大师套餐【送工具卡+链子】;1627207:1331112594:颜色分类:最强王者套餐【送工具卡+链子】;1627207:1331264247:颜色分类:璀璨钻石套餐【送工具卡+链子】"</span>,
		<span class="hljs-string">"prop_imgs"</span>: {
			<span class="hljs-string">"prop_img"</span>: [
				{
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1347647754"</span>,
					<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i3/2596264565/TB2.XeblVXXXXXkXpXXXXXXXXXX_!!2596264565.jpg"</span>
				},
				{
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1347647753"</span>,
					<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i4/2596264565/TB2dTrjdVXXXXXBXpXXXXXXXXXX_!!2596264565.jpg"</span>
				},
				{
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1195392087"</span>,
					<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i2/2596264565/TB2j22kdVXXXXXdXpXXXXXXXXXX_!!2596264565.jpg"</span>
				},
				{
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1331112595"</span>,
					<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i4/2596264565/TB2_uiXnFXXXXXBXXXXXXXXXXXX_!!2596264565.jpg"</span>
				},
				{
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1331112594"</span>,
					<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i4/2596264565/TB2Gm9xnFXXXXbmXXXXXXXXXXXX_!!2596264565.jpg"</span>
				},
				{
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1331264247"</span>,
					<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i3/2596264565/TB2wWohmXXXXXX8XXXXXXXXXXXX_!!2596264565.jpg"</span>
				}
			]
		},
		<span class="hljs-string">"props_imgs"</span>: {
			<span class="hljs-string">"prop_img"</span>: [
				{
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1347647754"</span>,
					<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i3/2596264565/TB2.XeblVXXXXXkXpXXXXXXXXXX_!!2596264565.jpg"</span>
				},
				{
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1347647753"</span>,
					<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i4/2596264565/TB2dTrjdVXXXXXBXpXXXXXXXXXX_!!2596264565.jpg"</span>
				},
				{
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1195392087"</span>,
					<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i2/2596264565/TB2j22kdVXXXXXdXpXXXXXXXXXX_!!2596264565.jpg"</span>
				},
				{
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1331112595"</span>,
					<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i4/2596264565/TB2_uiXnFXXXXXBXXXXXXXXXXXX_!!2596264565.jpg"</span>
				},
				{
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1331112594"</span>,
					<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i4/2596264565/TB2Gm9xnFXXXXbmXXXXXXXXXXXX_!!2596264565.jpg"</span>
				},
				{
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1331264247"</span>,
					<span class="hljs-string">"url"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i3/2596264565/TB2wWohmXXXXXX8XXXXXXXXXXXX_!!2596264565.jpg"</span>
				}
			]
		},
		<span class="hljs-string">"property_alias"</span>: <span class="hljs-string">""</span>,
		<span class="hljs-string">"props"</span>: [
			{
				<span class="hljs-string">"name"</span>: <span class="hljs-string">"品牌"</span>,
				<span class="hljs-string">"value"</span>: <span class="hljs-string">"三刃木"</span>
			},
			{
				<span class="hljs-string">"name"</span>: <span class="hljs-string">"产地"</span>,
				<span class="hljs-string">"value"</span>: <span class="hljs-string">"中国"</span>
			},
			{
				<span class="hljs-string">"name"</span>: <span class="hljs-string">"颜色分类"</span>,
				<span class="hljs-string">"value"</span>: <span class="hljs-string">"长方形带开瓶器+送工具刀卡+链子,椭圆形带开瓶器+送工具刀卡+链子,GJ018X钥匙刀+送工具刀卡+链子,超凡大师套餐【送工具卡+链子】,最强王者套餐【送工具卡+链子】,璀璨钻石套餐【送工具卡+链子】"</span>
			},
			{
				<span class="hljs-string">"name"</span>: <span class="hljs-string">"吊牌价"</span>,
				<span class="hljs-string">"value"</span>: <span class="hljs-string">"46"</span>
			},
			{
				<span class="hljs-string">"name"</span>: <span class="hljs-string">"功能数量"</span>,
				<span class="hljs-string">"value"</span>: <span class="hljs-string">"5个及以下"</span>
			},
			{
				<span class="hljs-string">"name"</span>: <span class="hljs-string">"货号"</span>,
				<span class="hljs-string">"value"</span>: <span class="hljs-string">"GJ019C"</span>
			},
			{
				<span class="hljs-string">"name"</span>: <span class="hljs-string">"附加功能"</span>,
				<span class="hljs-string">"value"</span>: <span class="hljs-string">"开瓶器,刀,螺丝刀,钥匙圈,其他"</span>
			}
		],
		<span class="hljs-string">"total_sold"</span>: <span class="hljs-string">"10"</span>,
		<span class="hljs-string">"skus"</span>: {
			<span class="hljs-string">"sku"</span>: [
				{
					<span class="hljs-string">"price"</span>: <span class="hljs-string">"39"</span>,
					<span class="hljs-string">"total_price"</span>: <span class="hljs-number">0</span>,
					<span class="hljs-string">"orginal_price"</span>: <span class="hljs-string">"39"</span>,
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1347647754"</span>,
					<span class="hljs-string">"properties_name"</span>: <span class="hljs-string">"1627207:1347647754:颜色分类:长方形带开瓶器+送工具刀卡+链子"</span>,
					<span class="hljs-string">"quantity"</span>: <span class="hljs-string">"9579"</span>,
					<span class="hljs-string">"sku_id"</span>: <span class="hljs-string">"3166598625985"</span>
				},
				{
					<span class="hljs-string">"price"</span>: <span class="hljs-string">"39"</span>,
					<span class="hljs-string">"total_price"</span>: <span class="hljs-number">0</span>,
					<span class="hljs-string">"orginal_price"</span>: <span class="hljs-string">"39"</span>,
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1347647753"</span>,
					<span class="hljs-string">"properties_name"</span>: <span class="hljs-string">"1627207:1347647753:颜色分类:椭圆形带开瓶器+送工具刀卡+链子"</span>,
					<span class="hljs-string">"quantity"</span>: <span class="hljs-string">"3699"</span>,
					<span class="hljs-string">"sku_id"</span>: <span class="hljs-string">"3166598625984"</span>
				},
				{
					<span class="hljs-string">"price"</span>: <span class="hljs-string">"25.8"</span>,
					<span class="hljs-string">"total_price"</span>: <span class="hljs-number">0</span>,
					<span class="hljs-string">"orginal_price"</span>: <span class="hljs-string">"25.8"</span>,
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1195392087"</span>,
					<span class="hljs-string">"properties_name"</span>: <span class="hljs-string">"1627207:1195392087:颜色分类:GJ018X钥匙刀+送工具刀卡+链子"</span>,
					<span class="hljs-string">"quantity"</span>: <span class="hljs-string">"3399"</span>,
					<span class="hljs-string">"sku_id"</span>: <span class="hljs-string">"3144644292458"</span>
				},
				{
					<span class="hljs-string">"price"</span>: <span class="hljs-string">"73.8"</span>,
					<span class="hljs-string">"total_price"</span>: <span class="hljs-number">0</span>,
					<span class="hljs-string">"orginal_price"</span>: <span class="hljs-string">"73.8"</span>,
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1331112595"</span>,
					<span class="hljs-string">"properties_name"</span>: <span class="hljs-string">"1627207:1331112595:颜色分类:超凡大师套餐【送工具卡+链子】"</span>,
					<span class="hljs-string">"quantity"</span>: <span class="hljs-string">"0"</span>,
					<span class="hljs-string">"sku_id"</span>: <span class="hljs-string">"3161300228970"</span>
				},
				{
					<span class="hljs-string">"price"</span>: <span class="hljs-string">"91.8"</span>,
					<span class="hljs-string">"total_price"</span>: <span class="hljs-number">0</span>,
					<span class="hljs-string">"orginal_price"</span>: <span class="hljs-string">"91.8"</span>,
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1331112594"</span>,
					<span class="hljs-string">"properties_name"</span>: <span class="hljs-string">"1627207:1331112594:颜色分类:最强王者套餐【送工具卡+链子】"</span>,
					<span class="hljs-string">"quantity"</span>: <span class="hljs-string">"0"</span>,
					<span class="hljs-string">"sku_id"</span>: <span class="hljs-string">"3161300228969"</span>
				},
				{
					<span class="hljs-string">"price"</span>: <span class="hljs-string">"63.8"</span>,
					<span class="hljs-string">"total_price"</span>: <span class="hljs-number">0</span>,
					<span class="hljs-string">"orginal_price"</span>: <span class="hljs-string">"63.8"</span>,
					<span class="hljs-string">"properties"</span>: <span class="hljs-string">"1627207:1331264247"</span>,
					<span class="hljs-string">"properties_name"</span>: <span class="hljs-string">"1627207:1331264247:颜色分类:璀璨钻石套餐【送工具卡+链子】"</span>,
					<span class="hljs-string">"quantity"</span>: <span class="hljs-string">"163"</span>,
					<span class="hljs-string">"sku_id"</span>: <span class="hljs-string">"3161107666655"</span>
				}
			]
		},
		<span class="hljs-string">"seller_id"</span>: <span class="hljs-string">"2596264565"</span>,
		<span class="hljs-string">"sales"</span>: <span class="hljs-number">13</span>,
		<span class="hljs-string">"shop_id"</span>: <span class="hljs-string">"127203758"</span>,
		<span class="hljs-string">"props_list"</span>: {
			<span class="hljs-string">"1627207:1347647754"</span>: <span class="hljs-string">"颜色分类:长方形带开瓶器+送工具刀卡+链子"</span>,
			<span class="hljs-string">"1627207:1347647753"</span>: <span class="hljs-string">"颜色分类:椭圆形带开瓶器+送工具刀卡+链子"</span>,
			<span class="hljs-string">"1627207:1195392087"</span>: <span class="hljs-string">"颜色分类:GJ018X钥匙刀+送工具刀卡+链子"</span>,
			<span class="hljs-string">"1627207:1331112595"</span>: <span class="hljs-string">"颜色分类:超凡大师套餐【送工具卡+链子】"</span>,
			<span class="hljs-string">"1627207:1331112594"</span>: <span class="hljs-string">"颜色分类:最强王者套餐【送工具卡+链子】"</span>,
			<span class="hljs-string">"1627207:1331264247"</span>: <span class="hljs-string">"颜色分类:璀璨钻石套餐【送工具卡+链子】"</span>
		},
		<span class="hljs-string">"seller_info"</span>: {
			<span class="hljs-string">"nick"</span>: <span class="hljs-string">"欢乐购客栈"</span>,
			<span class="hljs-string">"item_score"</span>: <span class="hljs-string">"4.8 "</span>,
			<span class="hljs-string">"score_p"</span>: <span class="hljs-string">"4.8 "</span>,
			<span class="hljs-string">"delivery_score"</span>: <span class="hljs-string">"4.8 "</span>,
			<span class="hljs-string">"shop_type"</span>: <span class="hljs-string">"C"</span>,
			<span class="hljs-string">"user_num_id"</span>: <span class="hljs-string">"2596264565"</span>,
			<span class="hljs-string">"sid"</span>: <span class="hljs-string">"127203758"</span>,
			<span class="hljs-string">"title"</span>: <span class="hljs-string">"欢乐购客栈"</span>,
			<span class="hljs-string">"zhuy"</span>: <span class="hljs-string">"https://shop127203758.taobao.com/"</span>,
			<span class="hljs-string">"shop_name"</span>: <span class="hljs-string">"欢乐购客栈"</span>
		},
		<span class="hljs-string">"tmall"</span>: <span class="hljs-literal">false</span>,
		<span class="hljs-string">"error"</span>: <span class="hljs-string">""</span>,
		<span class="hljs-string">"fav_count"</span>: <span class="hljs-string">"4824"</span>,
		<span class="hljs-string">"fans_count"</span>: <span class="hljs-string">"1462"</span>,
		<span class="hljs-string">"location"</span>: <span class="hljs-string">"广东深圳"</span>,
		<span class="hljs-string">"data_from"</span>: <span class="hljs-string">"server"</span>,
		<span class="hljs-string">"props_img"</span>: {
			<span class="hljs-string">"1627207:1347647754"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i3/2596264565/TB2.XeblVXXXXXkXpXXXXXXXXXX_!!2596264565.jpg"</span>,
			<span class="hljs-string">"1627207:1347647753"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i4/2596264565/TB2dTrjdVXXXXXBXpXXXXXXXXXX_!!2596264565.jpg"</span>,
			<span class="hljs-string">"1627207:1195392087"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i2/2596264565/TB2j22kdVXXXXXdXpXXXXXXXXXX_!!2596264565.jpg"</span>,
			<span class="hljs-string">"1627207:1331112595"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i4/2596264565/TB2_uiXnFXXXXXBXXXXXXXXXXXX_!!2596264565.jpg"</span>,
			<span class="hljs-string">"1627207:1331112594"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i4/2596264565/TB2Gm9xnFXXXXbmXXXXXXXXXXXX_!!2596264565.jpg"</span>,
			<span class="hljs-string">"1627207:1331264247"</span>: <span class="hljs-string">"//img.alicdn.com/imgextra/i3/2596264565/TB2wWohmXXXXXX8XXXXXXXXXXXX_!!2596264565.jpg"</span>
		},
		<span class="hljs-string">"desc_img"</span>: [
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i3/2596264565/TB2Sci2jXXXXXXFXpXXXXXXXXXX_!!2596264565.png"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i3/2596264565/TB2wWohmXXXXXX8XXXXXXXXXXXX_!!2596264565.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i4/2596264565/TB2_uiXnFXXXXXBXXXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i4/2596264565/TB2Gm9xnFXXXXbmXXXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i3/2596264565/TB28Ox4b77OyuJjSsplXXXqdpXa_!!2596264565.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i1/2596264565/TB2.mTddVXXXXbeXpXXXXXXXXXX_!!2596264565.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i3/2596264565/TB21Ro.jl0lpuFjSszdXXcdxFXa_!!2596264565.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i4/2596264565/TB2q9CelVXXXXcUXXXXXXXXXXXX_!!2596264565.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i3/2596264565/TB21EX9lVXXXXaXXpXXXXXXXXXX_!!2596264565.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i3/2596264565/TB2udCylVXXXXXgXXXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i1/2596264565/TB2EARxjB8lpuFjSspaXXXJKpXa_!!2596264565.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i3/2596264565/TB2ssuwlVXXXXafXXXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i2/2596264565/TB2nAHqgyC9MuFjSZFoXXbUzFXa_!!2596264565.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i3/2596264565/TB2ahCelVXXXXc_XXXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i3/2596264565/TB2w1JnjwRkpuFjy1zeXXc.6FXa_!!2596264565.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i3/2596264565/TB2C902lVXXXXbnXpXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i1/2596264565/TB2sGR3lVXXXXblXpXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i1/2596264565/TB2ZBGxlVXXXXXMXXXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i1/2596264565/TB2MjWklVXXXXcaXXXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i2/2596264565/TB2UgV3lVXXXXbdXpXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i2/2596264565/TB2ip5XlVXXXXX2XpXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i2/2596264565/TB2sMTBdVXXXXXlXXXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i3/2596264565/TB2d3HfdVXXXXahXpXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i4/2596264565/TB2AVbBdVXXXXXkXXXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i2/2596264565/TB2nf_wdVXXXXaMXXXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i4/2596264565/TB2dLYddVXXXXbtXpXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i2/2596264565/TB2H1_adVXXXXbWXpXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i2/2596264565/TB2eBzsdVXXXXbuXXXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i4/2596264565/TB2dOTndVXXXXcCXXXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i2/2596264565/TB2fK2tdVXXXXbkXXXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i2/2596264565/TB29zjedVXXXXaFXpXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>,
			<span class="hljs-string">"http://img.alicdn.com/imgextra/i3/2596264565/TB2i7rmdVXXXXcTXXXXXXXXXXXX_!!2596264565.jpg_q90.jpg"</span>
		]
	},
	<span class="hljs-string">"secache"</span>: <span class="hljs-string">"7e721ad79194b06c2a7fea78e07f87be"</span>,
	<span class="hljs-string">"secache_time"</span>: <span class="hljs-number">1608166332</span>,
	<span class="hljs-string">"secache_date"</span>: <span class="hljs-string">"2020-12-17 08:52:12"</span>,
	<span class="hljs-string">"translate_status"</span>: <span class="hljs-string">""</span>,
	<span class="hljs-string">"translate_time"</span>: <span class="hljs-number">0</span>,
	<span class="hljs-string">"language"</span>: {
		<span class="hljs-string">"default_lang"</span>: <span class="hljs-string">"cn"</span>,
		<span class="hljs-string">"current_lang"</span>: <span class="hljs-string">"cn"</span>
	},
	<span class="hljs-string">"error"</span>: <span class="hljs-string">""</span>,
	<span class="hljs-string">"reason"</span>: <span class="hljs-string">""</span>,
	<span class="hljs-string">"error_code"</span>: <span class="hljs-string">"0000"</span>,
	<span class="hljs-string">"cache"</span>: <span class="hljs-number">0</span>,
	<span class="hljs-string">"api_info"</span>: <span class="hljs-string">"today:2 max:10000"</span>,
	<span class="hljs-string">"execution_time"</span>: <span class="hljs-number">0.924</span>,
	<span class="hljs-string">"server_time"</span>: <span class="hljs-string">"Beijing/2020-12-17 08:52:12"</span>,
	<span class="hljs-string">"client_ip"</span>: <span class="hljs-string">"192.168.16.172"</span>,
	<span class="hljs-string">"call_args"</span>: {
		<span class="hljs-string">"num_iid"</span>: <span class="hljs-string">"520813250866"</span>
	},
	<span class="hljs-string">"api_type"</span>: <span class="hljs-string">"taobao"</span>,
	<span class="hljs-string">"translate_language"</span>: <span class="hljs-string">"zh-CN"</span>,
	<span class="hljs-string">"translate_engine"</span>: <span class="hljs-string">"google_cn"</span>,
	<span class="hljs-string">"server_memory"</span>: <span class="hljs-string">"6.83MB"</span>,
	<span class="hljs-string">"request_id"</span>: <span class="hljs-string">"2.5fdaabbb7e07f"</span>
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3 如何实现图片懒加载？其实一个 Intersection Observer 就搞定了]]></title>    <link>https://juejin.cn/post/7577737385954639882</link>    <guid>https://juejin.cn/post/7577737385954639882</guid>    <pubDate>2025-11-30T05:31:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577737385954639882" data-draft-id="7570239631846981666" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3 如何实现图片懒加载？其实一个 Intersection Observer 就搞定了"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-11-30T05:31:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="刘大华"/> <meta itemprop="url" content="https://juejin.cn/user/3507878440995946"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3 如何实现图片懒加载？其实一个 Intersection Observer 就搞定了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3507878440995946/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    刘大华
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T05:31:34.000Z" title="Sun Nov 30 2025 05:31:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，在当今图片密集的网络环境中，优化图片加载已成为前端开发的重要任务。今天我们分享一下怎么使用 Vue3 实现图片的懒加载功能。</p>
<p><strong>什么是图片懒加载？</strong></p>
<p>假如你打开一个有大量图片的页面，如果所有图片同时加载，会导致页面卡顿、流量浪费，特别是对于那些需要滚动才能看到的图片。</p>
<p>懒加载技术就是解决这个问题的方案，<strong>只有当图片进入或即将进入可视区域的时候，才加载它们</strong>。</p>
<p>效果预览：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b34c807c446746928322e16c38034944~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YiY5aSn5Y2O:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765085493&amp;x-signature=FrFPZhp%2BO%2FkwA8tZmh7oUp7ChEA%3D" alt="6vue3图片懒加载3.gif" loading="lazy"/></p>
<p><strong>完整示例代码可在文末获取</strong></p>
<h2 data-id="heading-0">实现原理</h2>
<p>我们的Vue3懒加载实现基于以下核心技术：</p>
<h3 data-id="heading-1">1. Intersection Observer API</h3>
<p>这是现代浏览器提供的强大API，可以<strong>高效监听元素是否进入可视区域</strong>，而无需频繁计算元素位置，性能远优于传统的滚动监听方式。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 创建观察器</span>
observer.<span class="hljs-property">value</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
  entries.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">entry</span> =&gt;</span> {
    <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">isIntersecting</span>) { <span class="hljs-comment">// 元素进入可视区域</span>
      <span class="hljs-title function_">loadImage</span>();
      observer.<span class="hljs-property">value</span>.<span class="hljs-title function_">unobserve</span>(entry.<span class="hljs-property">target</span>); <span class="hljs-comment">// 加载后停止观察</span>
    }
  });
}, {
  <span class="hljs-attr">rootMargin</span>: <span class="hljs-string">'50px 0px'</span>, <span class="hljs-comment">// 提前50px开始加载</span>
  <span class="hljs-attr">threshold</span>: <span class="hljs-number">0.1</span> <span class="hljs-comment">// 元素10%可见时触发</span>
});
</code></pre>
<h3 data-id="heading-2">2. 组件化设计</h3>
<p>我们将懒加载功能封装为独立的 <code>LazyImage</code> 组件，提高代码复用性和可维护性。</p>
<h2 data-id="heading-3">代码实现详解</h2>
<h3 data-id="heading-4">组件模板结构</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lazy-image-container"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"container"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">img</span>
    <span class="hljs-attr">v-if</span>=<span class="hljs-string">"isLoaded &amp;&amp; !hasError"</span>
    <span class="hljs-attr">:src</span>=<span class="hljs-string">"actualSrc"</span>
    <span class="hljs-attr">:alt</span>=<span class="hljs-string">"alt"</span>
    <span class="hljs-attr">class</span>=<span class="hljs-string">"lazy-image"</span>
    <span class="hljs-attr">:style</span>=<span class="hljs-string">"{ opacity: imageOpacity }"</span>
    @<span class="hljs-attr">load</span>=<span class="hljs-string">"onLoad"</span>
    @<span class="hljs-attr">error</span>=<span class="hljs-string">"onError"</span>
  /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else-if</span>=<span class="hljs-string">"hasError"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"image-placeholder"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"error-message"</span>&gt;</span>图片加载失败<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">button</span> @<span class="hljs-attr">click</span>=<span class="hljs-string">"retryLoad"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"margin-top: 10px;"</span>&gt;</span>重试<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">v-else</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"image-placeholder"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"spinner"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>加载中...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>组件包含三种状态：</p>
<ul>
<li><strong>加载中</strong>：显示旋转加载动画</li>
<li><strong>加载完成</strong>：显示实际图片，带有淡入效果</li>
<li><strong>加载失败</strong>：显示错误信息和重试按钮</li>
</ul>
<h3 data-id="heading-5">核心逻辑实现</h3>
<h4 data-id="heading-6">状态管理</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">setup</span>(<span class="hljs-params">props, { emit }</span>) {
  <span class="hljs-keyword">const</span> isLoaded = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);    <span class="hljs-comment">// 是否已加载</span>
  <span class="hljs-keyword">const</span> hasError = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>);    <span class="hljs-comment">// 是否加载失败</span>
  <span class="hljs-keyword">const</span> imageOpacity = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>);    <span class="hljs-comment">// 图片透明度（用于淡入效果）</span>
  <span class="hljs-keyword">const</span> observer = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);     <span class="hljs-comment">// Intersection Observer实例</span>
  <span class="hljs-keyword">const</span> container = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">null</span>);    <span class="hljs-comment">// 容器DOM引用</span>
  <span class="hljs-keyword">const</span> actualSrc = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>);      <span class="hljs-comment">// 实际图片地址</span>
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>使用Vue3的Composition API，我们可以更清晰地组织代码逻辑。</p>
<h4 data-id="heading-7">图片加载控制</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">loadImage</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">if</span> (props.<span class="hljs-property">slowLoad</span>) {
    <span class="hljs-comment">// 模拟慢速网络 - 延迟2秒加载</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      actualSrc.<span class="hljs-property">value</span> = props.<span class="hljs-property">src</span>;
      isLoaded.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
    }, <span class="hljs-number">2000</span>);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 正常加载</span>
    actualSrc.<span class="hljs-property">value</span> = props.<span class="hljs-property">src</span>;
    isLoaded.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
  }
};
</code></pre>
<p>这个函数根据<code>slowLoad</code>属性决定是否模拟慢速网络，便于测试不同网络条件下的表现。</p>
<h4 data-id="heading-8">生命周期管理</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 创建并启动Intersection Observer</span>
  observer.<span class="hljs-property">value</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
    <span class="hljs-comment">// 观察逻辑...</span>
  });
  
  <span class="hljs-keyword">if</span> (container.<span class="hljs-property">value</span>) {
    observer.<span class="hljs-property">value</span>.<span class="hljs-title function_">observe</span>(container.<span class="hljs-property">value</span>);
  }
});

<span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 组件卸载时清理观察器</span>
  <span class="hljs-keyword">if</span> (observer.<span class="hljs-property">value</span>) {
    observer.<span class="hljs-property">value</span>.<span class="hljs-title function_">disconnect</span>();
  }
});
</code></pre>
<p>确保在组件销毁时正确清理资源，避免内存泄漏。</p>
<h3 data-id="heading-9">错误处理与重试机制</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">onError</span> = (<span class="hljs-params"/>) =&gt; {
  hasError.<span class="hljs-property">value</span> = <span class="hljs-literal">true</span>;
  <span class="hljs-title function_">emit</span>(<span class="hljs-string">'error'</span>); <span class="hljs-comment">// 向父组件发送错误事件</span>
};

<span class="hljs-keyword">const</span> <span class="hljs-title function_">retryLoad</span> = (<span class="hljs-params"/>) =&gt; {
  hasError.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  isLoaded.<span class="hljs-property">value</span> = <span class="hljs-literal">false</span>;
  <span class="hljs-comment">// 重新触发观察</span>
  <span class="hljs-keyword">if</span> (observer.<span class="hljs-property">value</span> &amp;&amp; container.<span class="hljs-property">value</span>) {
    observer.<span class="hljs-property">value</span>.<span class="hljs-title function_">observe</span>(container.<span class="hljs-property">value</span>);
  }
};
</code></pre>
<p>良好的错误处理机制可以提升用户体验，让用户在图片加载失败时有机会重试。</p>
<h2 data-id="heading-10">应用该组件</h2>
<h3 data-id="heading-11">在主组件中使用懒加载</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"gallery"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> 
    <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(image, index) in images"</span> 
    <span class="hljs-attr">:key</span>=<span class="hljs-string">"index"</span> 
    <span class="hljs-attr">class</span>=<span class="hljs-string">"image-card"</span>
  &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">lazy-image</span>
      <span class="hljs-attr">:src</span>=<span class="hljs-string">"image.url"</span>
      <span class="hljs-attr">:alt</span>=<span class="hljs-string">"image.title"</span>
      <span class="hljs-attr">:slow-load</span>=<span class="hljs-string">"networkSlow"</span>
      @<span class="hljs-attr">loaded</span>=<span class="hljs-string">"onImageLoaded"</span>
      @<span class="hljs-attr">error</span>=<span class="hljs-string">"onImageError"</span>
    &gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">lazy-image</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"image-info"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"image-title"</span>&gt;</span>{{ image.title }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"image-description"</span>&gt;</span>{{ image.description }}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h3 data-id="heading-12">功能控制与统计</h3>
<p>我们的主组件提供了实用的控制功能：</p>
<ul>
<li><strong>添加更多图片</strong>：动态加载更多图片</li>
<li><strong>重置图片</strong>：恢复初始状态</li>
<li><strong>模拟网络速度</strong>：切换正常/慢速网络模式</li>
<li><strong>加载统计</strong>：实时显示已加载和失败的图片数量</li>
</ul>
<h2 data-id="heading-13">进一步优化</h2>
<p>在实际项目中，还可以考虑以下优化：</p>
<ol>
<li><strong>图片压缩与格式选择</strong>：使用WebP等现代格式，减小文件体积</li>
<li><strong>渐进式加载</strong>：先加载低质量预览图，再加载高清图</li>
<li><strong>预加载关键图片</strong>：对首屏内的关键图片不使用懒加载</li>
<li><strong>使用CDN加速</strong>：通过内容分发网络提高图片加载速度</li>
</ol>
<p><strong>Github示例代码</strong>：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2F1344160559-lch%2Fdh-vue3-component%2Fblob%2Fmain%2FLazyImages%2Findex.html" target="_blank" title="https://github.com/1344160559-lch/dh-vue3-component/blob/main/LazyImages/index.html" ref="nofollow noopener noreferrer">github.com/1344160559-…</a></p>
<h2 data-id="heading-14">总结</h2>
<p>Vue3图片懒加载是一个简单但极其实用的优化技术。通过<code>Intersection Observer API</code>和Vue3的响应式系统，我们可以以少量代码实现高效的懒加载功能，显著提升页面性能和用户体验。</p>
<p>这个实现不仅适用于图片展示类网站，也可以应用于任何需要优化资源加载的Vue3项目。希望本文能帮助你理解和实现这一重要前端优化技术！</p>
<blockquote>
<p>本文首发于公众号：程序员刘大华，专注分享前后端开发的实战笔记。关注我，少走弯路，一起进步！</p>
</blockquote>
<h4 data-id="heading-15">📌往期精彩</h4>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2Fmaq_p_m5vd7KS-xyXt5rcA" target="_blank" title="https://mp.weixin.qq.com/s/maq_p_m5vd7KS-xyXt5rcA" ref="nofollow noopener noreferrer">《SpringBoot+MySQL+Vue实现文件共享系统》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FP7SMincYFKERZbNKAFtzGQ" target="_blank" title="https://mp.weixin.qq.com/s/P7SMincYFKERZbNKAFtzGQ" ref="nofollow noopener noreferrer">《这20条SQL优化方案，让你的数据库查询速度提升10倍》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FgQK9L1TxKL50FUVMcgh6JQ" target="_blank" title="https://mp.weixin.qq.com/s/gQK9L1TxKL50FUVMcgh6JQ" ref="nofollow noopener noreferrer">《SpringBoot 动态菜单权限系统设计的企业级解决方案》</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FPQ_w7CDVoIZPn-CVH2DKJg" target="_blank" title="https://mp.weixin.qq.com/s/PQ_w7CDVoIZPn-CVH2DKJg" ref="nofollow noopener noreferrer">《Vue3和Vue2的核心区别？很多开发者都没完全搞懂的10个细节》</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 如何再工程化项目中提效？]]></title>    <link>https://juejin.cn/post/7577905525997453353</link>    <guid>https://juejin.cn/post/7577905525997453353</guid>    <pubDate>2025-11-30T05:50:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577905525997453353" data-draft-id="7577905525997125673" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 如何再工程化项目中提效？"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-11-30T05:50:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小兵张健"/> <meta itemprop="url" content="https://juejin.cn/user/1257497032405229"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 如何再工程化项目中提效？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1257497032405229/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小兵张健
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T05:50:38.000Z" title="Sun Nov 30 2025 05:50:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在刚开始用 cursor 等工具时，只是用 AI 帮忙生产代码，代码的逻辑、业务流程都在人的脑子里面，这导致 AI 只能在局限的范围内帮一小部分忙，效率很低。而且还经常帮错忙，比如改错了、代码风格不一致等等。</p>
<p>这是最基础的 AI 用法，只用 AI 写代码，于是我想有什么办法可以让 AI 更大程度的接管项目，我把它分为三部分。</p>
<h2 data-id="heading-0">代码风格 Prompt</h2>
<p>用于约束 AI coding 的规范，这一部分就可以分出很多分支，比如按照文件夹的、按照文件后缀、业务模块等等，可以结合 cursor 自带的 .mdc 规范文件一起用。</p>
<p>这里不和业务相关，只和编码规范相关，要遵循 Prompt 编写的常见方法，比如给案例、指令优于限制等。</p>
<p>Prompt 编写的技巧，我准备过两天写一篇文章总结下，感兴趣的可以关注我。</p>
<h2 data-id="heading-1">日志记录文件</h2>
<p>这里记录每一次代码改动，每个文件大致包含变动原因、改动方案、变动结果、测试结果等等，这些文件为 AI 提供整体项目的上下文，把每一次业务场景记录下来。这样 AI 就能理解整个项目，慢慢的从每次迭代中学习，不再犯重复的错误。</p>
<p>AI 编写代码会重复的犯某些特定的错误，原因是我们给的上下文不够，但我们也不可能每次编写代码的时候都把项目从 0 开始讲一遍让 AI 理解整个项目情况，所以这一套文件就是把项目的迭代过程文档化，加载到 AI 的上下文中。</p>
<p>生成日志文件本身也需要一个 Prompt，让生产的文档规范化。</p>
<h2 data-id="heading-2">分步骤执行</h2>
<p>此后写代码之前，先将需求的信息给 AI，使用后退一步的方法加载日记记录文件到上下文，用对话完善此次需求，再生成新的日志记录文件的前半部分和编写代码的大纲文件。</p>
<p>日志记录文件保持只新增。</p>
<p>然后再开启一个新的对话，用后退一步的方法加载代码规范到上下文，根据编写代码的大纲文件开始执行代码。</p>
<p>执行完成后测试，再把最终的结果完善到日志记录文件。</p>
<p>这样每个需求到流程都是规范化和文档化的，AI 会在整个过程中越用越聪明。</p>
<p>当然这样也有个问题，目前我发现的就是文档太多了，有时候会不按照规范执行，我在考虑用 RAG + MCP 的方式，一个项目一个数据库，把整个流程完善成 flow。</p>
<p>这里面会大量用到 Prompt 编写的技巧，我准备下一遍文章详细罗列出来。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[STM32CubeIDE手动移植FreeRTOS-动态创建任务和删除]]></title>    <link>https://juejin.cn/post/7577689171222642738</link>    <guid>https://juejin.cn/post/7577689171222642738</guid>    <pubDate>2025-11-29T15:16:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577689171222642738" data-draft-id="7577691061033107502" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="STM32CubeIDE手动移植FreeRTOS-动态创建任务和删除"/> <meta itemprop="keywords" content="嵌入式"/> <meta itemprop="datePublished" content="2025-11-29T15:16:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="嵌入式大头"/> <meta itemprop="url" content="https://juejin.cn/user/124713977526552"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            STM32CubeIDE手动移植FreeRTOS-动态创建任务和删除
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/124713977526552/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    嵌入式大头
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T15:16:24.000Z" title="Sat Nov 29 2025 15:16:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、引言</h2>
<p>我在学习这个部分的时候遇到了很多问题，但好在搜集了很多资料后得以解决，于是打算在这里演示这个项目的全过程，即当做复习的资料，也希望能够帮助到一些人，话不多说，直接开整！</p>
<h2 data-id="heading-1">二、项目简介</h2>
<p>创建以下三个任务：</p>
<ul>
<li>任务1：LED1每500ms翻转一次</li>
<li>任务2：LED2每500ms翻转一次</li>
<li>任务3：当按下KEY1的时候删除任务1</li>
</ul>
<h2 data-id="heading-2">三、步骤</h2>
<h3 data-id="heading-3">1. 实现基本的工程配置</h3>
<h4 data-id="heading-4">a. 引脚配置：</h4>
<p>PA0为红色LED，PA1为绿色LED，PA5为按键1，PA9和PA10用作串口发送</p>
<ul>
<li>设置<code>PA0</code>为<code>GPIO_Output</code>,添加标签<code>LED_RED</code></li>
<li>设置<code>PA1</code>为<code>GPIO_Output</code>,添加标签<code>LED_Green</code></li>
<li>设置<code>PA5</code>为<code>GPIO_Intput</code>,添加标签<code>KEY1</code></li>
<li>设置<code>PA9</code>为<code>USART1_TX</code>,<code>PA10</code>为<code>USART1_RX</code></li>
</ul>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2888591f6b6343bca5a4621169c24415~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=UYbZASbajgHxej3pTJXs4w%2BZToo%3D" alt="image.png" width="60%" loading="lazy"/>
<p>因为我的按键另一端连接的是正极，所以我的PA5设置为了下拉输入，让PA5默认为低电平，当按键按下时，PA5会表现为高电平：</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0013ea3f4b414e9db17b17011083b41c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=ZoiO8MeDr1LTUcSwn15JM5TNQ68%3D" alt="image.png" width="50%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d9faecef1e7d4e9d8e4f1224b1919f41~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=Sb0TZC9c67V2xEMCORZhXeM7Yt4%3D" alt="image.png" width="30%" loading="lazy"/>
<blockquote>
<p><strong>图片来自B站视频UP:keysking</strong></p>
</blockquote>
<h4 data-id="heading-5">b. 系统配置：</h4>
<ul>
<li>将<code>RCC</code>的时钟来源设置为<code>HSE</code>，调整系统时钟为<code>72MHZ</code>：</li>
</ul>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1eb364f2ed7b418babdcbd1e7ca24bff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=pAY5aIzPZxWr8iW%2BC1Flz9fhsN4%3D" alt="image.png" width="70%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cdfebc1306224f38ac94382f15d1c413~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=ePRhF3888%2BhNvQmsjEnMkqVje0o%3D" alt="image.png" width="80%" loading="lazy"/>
<ul>
<li>设置<code>SYS</code>的<code>Debug</code>为<code>Serial Wire</code>，<code>Timebase Source</code>为<code>TIM4</code>
前者是为了能把代码下载进单片机，后者是因为<code>HAL</code>本身和<code>FreeRTOS</code>都默认依赖<code>SysTick</code>，可能出现卡死的问题，所以为了保险起见，可以考虑在<code>SYS</code>选择<code>HAL</code>时钟源的时候换成其他的，比如<code>TIM4</code></li>
</ul>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/22c30a39ac904b18a30e0028179d8c6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=uWibn3xGhXYd42ybQXPSzwfH3FM%3D" alt="image.png" width="70%" loading="lazy"/>
<ul>
<li>设置<code>Time base: TIM4 global interrupt</code>和<code>System tick timer</code>的优先级都为1</li>
<li>打开USART1的中断，优先级设置为0</li>
</ul>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d771b263dfa44af8c9e64563ba9b6b0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=WF03n83D67hk5AoJBgldRCrYZIM%3D" alt="image.png" width="70%" loading="lazy"/>
<ul>
<li>设置USART为异步模式：</li>
</ul>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fa000a9ac9c4aad9acbde152943ed99~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=8T9FjdW6%2F5pevo%2B4UFiJsaW4DT0%3D" alt="image.png" width="70%" loading="lazy"/>
<ul>
<li>打开<code>Project Manager</code>中的<code>Code Generator</code>，勾选每个外设生成一对“.c/.h文件”初始化</li>
</ul>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ee884df7733460db044732067630ca0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=8V1wCXpcpOOu8En3wlCOQHF5wIY%3D" alt="image.png" width="100%" loading="lazy"/>
<blockquote>
<p><strong>至此，项目基本配置完成，Ctrl+S生成代码，进入代码编辑页面</strong></p>
</blockquote>
<ul>
<li>在根目录下新建Hardware文件夹，新建Key.h和Key.h文件</li>
</ul>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __KEY_H</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> __KEY_H</span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"main.h"</span></span>

<span class="hljs-type">uint8_t</span> <span class="hljs-title function_">Key_Is_Press</span><span class="hljs-params">()</span>;

<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>
</code></pre>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"Key.h"</span></span>

<span class="hljs-type">uint8_t</span> <span class="hljs-title function_">Key_Is_Press</span><span class="hljs-params">()</span>
{
    <span class="hljs-type">uint8_t</span> Key_Is_Press = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">if</span>(HAL_GPIO_ReadPin(KEY1_GPIO_Port, KEY1_Pin) == GPIO_PIN_SET)
    {
        HAL_Delay(<span class="hljs-number">10</span>);
        <span class="hljs-keyword">if</span>(HAL_GPIO_ReadPin(KEY1_GPIO_Port, KEY1_Pin) == GPIO_PIN_SET)
        {
            Key_Is_Press = <span class="hljs-number">1</span>;
        }
}
    <span class="hljs-keyword">return</span> Key_Is_Press;
}
</code></pre>
<h3 data-id="heading-6">2. <code>printf</code>函数重定向</h3>
<blockquote>
<p>参考上一篇文章</p>
</blockquote>
<h3 data-id="heading-7">3. 开始移植</h3>
<h4 data-id="heading-8">1. 文件移植</h4>
<p>在项目根目录下新建FreeRTOS文件夹，复制源码/Source/include文件夹到FreeRTOS文件夹下，FreeRTOS文件夹下新建source文件夹和portable文件夹，复制源码Source文件夹下的7个.c文件到FreeRTOS/source文件夹，把源码/portable/MemMang文件夹复制到FreeRTOS/portable文件夹，只保留heap_4.c文件，把源码/Source/portable/GCC文件夹复制到FreeRTOS/portable文件夹，只保留ARM_CM3文件夹，把源码/Demo/CORTEX_STM32F103_Primer_GCC下的FreeRTOSConfig.h文件复制到项目/Core/Inc文件夹下</p>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99a57766046b45b99ee7eb511ad0b2b4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=5Ash%2Fp2ACRUSlCPGTY8qeY0WZZM%3D" alt="image.png" width="70%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9157166764ad4336af0797aa8bad9455~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=czmlOD%2F8WgUz0o20BkKKOZxTYz0%3D" alt="image.png" width="70%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6744dc8bc4974fb0b870c81306f68108~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=xi%2FD6IwAM2AkMyICnZ2eIh%2FEJjA%3D" alt="image.png" width="50%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c3462ce226b4f33b97ebf91424f1b3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=cHqxBMC2sTRwJhG6Az%2BCk1gztrA%3D" alt="image.png" width="70%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1dd5fd65c9e42da98f7c83c4f70f687~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=P8HZGDKbBABbIyNG6LE0yN8BDUA%3D" alt="image.png" width="70%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4af207e2a8ea48cf8084478f48274feb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=ASDvCLbmxP3ZTzbcgAiQRIpUlTc%3D" alt="image.png" width="70%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a055e45960c044b2b71931ed82062ce4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=2UadRcr7kZDdDLHLxDFqUxS4U4Y%3D" alt="image.png" width="70%" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9430b9b2143a4c4584edd626b7fef26a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=tT9%2FTG%2BPcNdrGHwny25j0Lb8VME%3D" alt="image.png" width="70%" loading="lazy"/>
<h4 data-id="heading-9">2. 工程配置</h4>
<ul>
<li>把Hardware文件夹和FreeRTOS文件夹加入项目编译范围
右键项目名字，点击Properties，进入如下页面：</li>
</ul>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b7e7036aa87b40cca23994ddb25f2bb7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=fulgC59oWklKcInJqn6UVgVRiRc%3D" alt="image.png" width="100%" loading="lazy"/>
<ul>
<li>把include文件夹和ARM_CM3文件夹和Hardware文件夹添加到Include directories目录</li>
<li>把FreeRTOS文件夹和Hardware文件夹添加到Source Location</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e1c29078ad574c1599842d56606f1fd0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=iQmLRlfF7VDSEETcYqnNEo3qEOw%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae5db1d82cd14653bc99bc8370b3701e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bWM5YWl5byP5aSn5aS0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765034184&amp;x-signature=bIpRvq1rWYJWm2otJ90TLigKohg%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-10">3. 系统配置文件修改</h4>
<ul>
<li>FreeRTOSConfig.h中添加如下3个配置：</li>
</ul>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> xPortPendSVHandler  PendSV_Handler</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> vPortSVCHandler     SVC_Handler</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> INCLUDE_xTaskGetSchedulerState   1</span>
</code></pre>
<p>把<code>#define configUSE_TICK_HOOK 1</code>修改为<code>0</code></p>
<ul>
<li>修改stm32f1xx_it.c文件</li>
</ul>
<p>引入头文件：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">/* Private includes ----------------------------------------------------------*/</span>
<span class="hljs-comment">/* USER CODE BEGIN Includes */</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"FreeRTOS.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"task.h"</span></span>
<span class="hljs-comment">/* USER CODE END Includes */</span>
</code></pre>
<p>注释掉2个函数：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// void SVC_Handler(void)</span>
<span class="hljs-comment">// {</span>
<span class="hljs-comment">// }</span>

<span class="hljs-comment">// void PendSV_Handler(void)</span>
<span class="hljs-comment">// {</span>
<span class="hljs-comment">// }</span>
</code></pre>
<p>添加SysTick时钟中断服务函数:</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">/* Private variables ---------------------------------------------------------*/</span>
<span class="hljs-comment">/* USER CODE BEGIN PV */</span>
<span class="hljs-keyword">extern</span> <span class="hljs-type">void</span> <span class="hljs-title function_">xPortSysTickHandler</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;
<span class="hljs-comment">/* USER CODE END PV */</span>

<span class="hljs-type">void</span> <span class="hljs-title function_">SysTick_Handler</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-comment">/* USER CODE BEGIN SysTick_IRQn 0 */</span>
    <span class="hljs-comment">/* USER CODE END SysTick_IRQn 0 */</span>
    <span class="hljs-comment">/* USER CODE BEGIN SysTick_IRQn 1 */</span>
    <span class="hljs-keyword">if</span> (xTaskGetSchedulerState() != taskSCHEDULER_NOT_STARTED)
    {
        xPortSysTickHandler();
    }
    <span class="hljs-comment">/* USER CODE END SysTick_IRQn 1 */</span>
}
</code></pre>
<h4 data-id="heading-11">4. 动态创建任务</h4>
<ul>
<li>FreeRTOSConfig.h文件新加<code>#define configSUPPORT_DYNAMIC_ALLOCATION</code></li>
<li>在Core/Inc下新建FreeRTOS_demo.h,在Core/src下新建FreeRTOS_demo.c</li>
<li>FreeRTOS_demo.c代码：</li>
</ul>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"FreeRTOS_demo.h"</span></span>

<span class="hljs-comment">/* 启动任务函数 */</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> START_TASK_PRIORITY 1</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> START_TASK_STACK_DEPTH 128</span>
TaskHandle_t start_task_handler;
<span class="hljs-type">void</span> <span class="hljs-title function_">Start_Task</span><span class="hljs-params">(<span class="hljs-type">void</span> *pvParameters)</span>;

<span class="hljs-comment">/* Task1 任务 配置 */</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> TASK1_PRIORITY 2</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> TASK1_STACK_DEPTH 128</span>
TaskHandle_t task1_handler;
<span class="hljs-type">void</span> <span class="hljs-title function_">Task1</span><span class="hljs-params">(<span class="hljs-type">void</span> *pvParameters)</span>;

<span class="hljs-comment">/* Task2 任务 配置 */</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> TASK2_PRIORITY 3</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> TASK2_STACK_DEPTH 128</span>
TaskHandle_t task2_handler;
<span class="hljs-type">void</span> <span class="hljs-title function_">Task2</span><span class="hljs-params">(<span class="hljs-type">void</span> *pvParameters)</span>;

<span class="hljs-comment">/* Task3 任务 配置 */</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> TASK3_PRIORITY 4</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> TASK3_STACK_DEPTH 128</span>
TaskHandle_t task3_handler;
<span class="hljs-type">void</span> <span class="hljs-title function_">Task3</span><span class="hljs-params">(<span class="hljs-type">void</span> *pvParameters)</span>;

<span class="hljs-comment">/**
 * @description: FreeRTOS入口函数：创建任务函数并开始调度
 * @return {*}
 */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">FreeRTOS_Start</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    xTaskCreate((TaskFunction_t)Start_Task,
                (<span class="hljs-type">char</span> *)<span class="hljs-string">"Start_Task"</span>,
                (configSTACK_DEPTH_TYPE)START_TASK_STACK_DEPTH,
                (<span class="hljs-type">void</span> *)<span class="hljs-literal">NULL</span>,
                (UBaseType_t)START_TASK_PRIORITY,
                (TaskHandle_t *)&amp;start_task_handler);
    vTaskStartScheduler();
}

<span class="hljs-type">void</span> <span class="hljs-title function_">Start_Task</span><span class="hljs-params">( <span class="hljs-type">void</span> * pvParameters )</span>
{
    taskENTER_CRITICAL();               <span class="hljs-comment">/* 进入临界区 */</span>
    xTaskCreate((TaskFunction_t         )   Task1,
                (<span class="hljs-type">char</span> *                 )   <span class="hljs-string">"Task1"</span>,
                (configSTACK_DEPTH_TYPE )   TASK1_STACK_DEPTH,
                (<span class="hljs-type">void</span> *                 )   <span class="hljs-literal">NULL</span>,
                (UBaseType_t            )   TASK1_PRIORITY,
                (TaskHandle_t *         )   &amp;task1_handler );

    xTaskCreate((TaskFunction_t         )   Task2,
                (<span class="hljs-type">char</span> *                 )   <span class="hljs-string">"Task2"</span>,
                (configSTACK_DEPTH_TYPE )   TASK2_STACK_DEPTH,
                (<span class="hljs-type">void</span> *                 )   <span class="hljs-literal">NULL</span>,
                (UBaseType_t            )   TASK2_PRIORITY,
                (TaskHandle_t *         )   &amp;task2_handler );

    xTaskCreate((TaskFunction_t         )   Task3,
                (<span class="hljs-type">char</span> *                 )   <span class="hljs-string">"Task2"</span>,
                (configSTACK_DEPTH_TYPE )   TASK3_STACK_DEPTH,
                (<span class="hljs-type">void</span> *                 )   <span class="hljs-literal">NULL</span>,
                (UBaseType_t            )   TASK3_PRIORITY,
                (TaskHandle_t *         )   &amp;task3_handler );
    vTaskDelete(<span class="hljs-literal">NULL</span>);
    taskEXIT_CRITICAL();                <span class="hljs-comment">/* 退出临界区 */</span>
}

<span class="hljs-comment">/**
 * @description: LED1每500ms翻转一次
 * @param {void *} pvParameters
 * @return {*}
 */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">Task1</span><span class="hljs-params">(<span class="hljs-type">void</span> * pvParameters)</span>
{
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)
    {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"task1运行....\r\n"</span>);
        HAL_GPIO_TogglePin(LED_RED_GPIO_Port, LED_RED_Pin);
        vTaskDelay(<span class="hljs-number">500</span>);
    }
}


<span class="hljs-comment">/**
 * @description: LED2每500ms翻转一次
 * @param {void *} pvParameters
 * @return {*}
 */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">Task2</span><span class="hljs-params">(<span class="hljs-type">void</span> * pvParameters)</span>
{
    <span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)
    {
        <span class="hljs-built_in">printf</span>(<span class="hljs-string">"task2运行....\r\n"</span>);
        HAL_GPIO_TogglePin(LED_Green_GPIO_Port, LED_Green_Pin);
        vTaskDelay(<span class="hljs-number">500</span>);
    }
}


<span class="hljs-comment">/**
 * @description:
 * @param {void *} pvParameters
 * @return {*}
 */</span>
<span class="hljs-type">void</span> <span class="hljs-title function_">Task3</span><span class="hljs-params">(<span class="hljs-type">void</span> * pvParameters)</span>
{
	<span class="hljs-keyword">while</span>(<span class="hljs-number">1</span>)
	{
		<span class="hljs-built_in">printf</span>(<span class="hljs-string">"task3运行...\r\n"</span>);
		<span class="hljs-keyword">if</span>(Key_Is_Press())
		{
			<span class="hljs-keyword">if</span>(task1_handler != <span class="hljs-literal">NULL</span>)
			{
				<span class="hljs-built_in">printf</span>(<span class="hljs-string">"删除task1任务...\r\n"</span>);
				vTaskDelete(task1_handler);
				task1_handler = <span class="hljs-literal">NULL</span>;
			}
		}
		vTaskDelay(<span class="hljs-number">500</span>);
	}
}

</code></pre>
<ul>
<li>FreeRTOS_demo.h代码：</li>
</ul>
<pre><code class="hljs language-c" lang="c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> __FREERTOS_DEMO_H</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> __FREERTOS_DEMO_H</span>

<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"FreeRTOS.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"task.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"main.h"</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"Key.h"</span></span>

<span class="hljs-type">void</span> <span class="hljs-title function_">FreeRTOS_Start</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>;

<span class="hljs-meta">#<span class="hljs-keyword">endif</span></span>

</code></pre>
<ul>
<li>main.c文件对应位置加入：</li>
</ul>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">/* USER CODE BEGIN Includes */</span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">"FreeRTOS_demo.h"</span></span>
<span class="hljs-comment">/* USER CODE END Includes */</span>

<span class="hljs-comment">/* USER CODE BEGIN 2 */</span>
FreeRTOS_Start();
<span class="hljs-comment">/* USER CODE END 2 */</span>
</code></pre>
<p><strong>至此，所有工作完成，编译并下载代码即可</strong></p>
<h2 data-id="heading-12">四、总结</h2>
<p>才开始写文章，感觉文章写得有点乱，有任何意见或者问题都可以私信我，我也刚开始学这个，大家可以一起交流，希望这篇文章可以帮助到大家，感谢！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Jenkins + Kubernetes 多模块微服务一键流水线：从 Maven 打包到滚动发布完整脚本]]></title>    <link>https://juejin.cn/post/7577722399375376426</link>    <guid>https://juejin.cn/post/7577722399375376426</guid>    <pubDate>2025-11-29T16:14:09.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577722399375376426" data-draft-id="7577722399375048746" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Jenkins + Kubernetes 多模块微服务一键流水线：从 Maven 打包到滚动发布完整脚本"/> <meta itemprop="keywords" content="Jenkins,Kubernetes"/> <meta itemprop="datePublished" content="2025-11-29T16:14:09.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="起风了___"/> <meta itemprop="url" content="https://juejin.cn/user/3298190615395896"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Jenkins + Kubernetes 多模块微服务一键流水线：从 Maven 打包到滚动发布完整脚本
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3298190615395896/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    起风了___
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T16:14:09.000Z" title="Sat Nov 29 2025 16:14:09 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">文章简介</h2>
<ul>
<li>上次写过一篇使用 Jenkins 在远程服务器上部署 docker 镜像的通用脚本，这次这份脚本是基于上次那份脚本修改而来，用于 Kubernetes 部署镜像使用。</li>
<li>Kubernetes 部署相关信息可以查看这篇文章：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FPmae_-DmMGkyA89s6I6xqA" target="_blank" title="https://mp.weixin.qq.com/s/Pmae_-DmMGkyA89s6I6xqA" ref="nofollow noopener noreferrer">Kubernetes 生产入门：Deployment 与 Service 配置实战</a></li>
<li>本文介绍的部署脚本适用于单工程下多 module 的微服务，单工程服务需要阅读脚本自行微调。不过我建议使用本文脚本的每一位朋友都能够阅读所有的代码，确定是否符合自己的需求。</li>
</ul>
<h2 data-id="heading-1">脚本变量</h2>
<ul>
<li>定义、设置变量主要是为了形成一个<strong>通用型脚本</strong>，部署多个服务尤其微服务时，编写好一个流水线脚本，其他流水线可以直接复制使用，复制后只需修改此处变量即可。</li>
<li>此处有部分变量嵌套使用 MODULE_NAME、MODULE_PATH 变量复用相同参数，使用本文脚本的朋友一定要观察此处的变量是否与你们工程一致。</li>
<li>具体参数信息代码中已有注释，不过多赘述</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">environment {
    // 模块信息
    <span class="hljs-attr">MODULE_NAME</span> = <span class="hljs-string">"xxx-service"</span> // 模块名称
    <span class="hljs-attr">MODULE_PATH</span> = <span class="hljs-string">"./${MODULE_NAME}"</span> // 模块路径，适用于微服务多 module
    // Git 仓库配置
    <span class="hljs-attr">GIT_URL</span> = <span class="hljs-string">'git@git.xxx.com:xxx.git'</span> // 替换为你的代码仓库
    <span class="hljs-attr">GIT_KEY_ACR_CRED</span> = <span class="hljs-string">'git-ssh-key'</span>
    <span class="hljs-attr">BRANCH</span> = <span class="hljs-string">'master'</span>
    // Docker 镜像相关配置
    <span class="hljs-attr">DOCKER_IMAGE_REGISTRY</span> = <span class="hljs-string">'registry.xxx.aliyuncs.com'</span>  // 替换为你的镜像仓库
    <span class="hljs-attr">DOCKER_IMAGE_ACR_CRED</span> = <span class="hljs-string">'docker-cred'</span>
    <span class="hljs-attr">IMAGE_PRE_NAME</span> = <span class="hljs-string">'xxxx'</span>  // 镜像名称前缀
    <span class="hljs-attr">IMAGE_NAME</span> = <span class="hljs-string">"${MODULE_NAME}"</span>  // 镜像名称
    <span class="hljs-attr">DOCKERFILE</span> = <span class="hljs-string">"${MODULE_PATH}/Dockerfile"</span> // 用来构建镜像的 dockerfile 文件
    // Kubernetes 相关配置
    <span class="hljs-attr">KUBERNETES_CONFIG</span> = <span class="hljs-string">"kubernetes-config"</span> // Kubernetes 配置文件凭证
    <span class="hljs-attr">RESOURCE_NAME</span> = <span class="hljs-string">"${MODULE_NAME}"</span> // 资源类型名称，这里为 deployment 名称
    <span class="hljs-attr">CONTAINER_NAME</span> = <span class="hljs-string">"${MODULE_NAME}"</span> // 容器名称
}
</code></pre>
<h2 data-id="heading-2">工具设置</h2>
<p>这里设置构建代码的 Maven 工具</p>
<pre><code class="hljs language-groovy" lang="groovy">tools {
    // Install the Maven version configured as "M3" and add it to the path.
    maven "Maven3"
}
</code></pre>
<h2 data-id="heading-3">拉取代码</h2>
<p>拉取仓库中的代码</p>
<ul>
<li>git branch: BRANCH：指定拉取的分支</li>
<li>url: GIT_URL，设置代码仓库地址</li>
<li>credentialsId：仓库访问凭据</li>
</ul>
<pre><code class="hljs language-groovy" lang="groovy">stage('Checkout') {
    steps {
        git branch: BRANCH, 
        url: GIT_URL,
        credentialsId: GIT_KEY_ACR_CRED
    }
}
</code></pre>
<h2 data-id="heading-4">打包</h2>
<p>由于是多 module 多微服务项目，此处使用 mvn 指定模块打包命令，防止构建不相关模块,且指定为 pro 配置</p>
<pre><code class="hljs language-groovy" lang="groovy">stage('Package') {
    steps {
        // 执行 Maven 打包命令，只打包指定模块
        sh "mvn -pl ${MODULE_PATH} -am -B clean package -Ppro -Dfile.encoding=UTF-8 -DskipTests=true"
    }
}
</code></pre>
<h2 data-id="heading-5">构建、推送 Docker 镜像，删除本地镜像</h2>
<ul>
<li>此处使用当前时间为镜像设置 tag</li>
<li>镜像名称格式：&lt;镜像仓库地址&gt;/&lt;镜像名称前缀&gt;/&lt;应用名称&gt;:&lt;当前时间&gt;</li>
<li>sh "docker build -t ${fullImageNameWithTimestamp} ."
<ul>
<li>使用 docker 构建镜像</li>
</ul>
</li>
<li>withCredentials 使用凭据登陆、推送镜像
<ul>
<li>登陆仓库： sh "docker login --username $REG_USER -p $REG_PASS $DOCKER_IMAGE_REGISTRY"</li>
<li>推送镜像：sh "docker push ${fullImageNameWithTimestamp}"</li>
<li>删除本地镜像：sh "docker rmi ${fullImageNameWithTimestamp}"</li>
<li>将镜像名称保存到环境变量，供后续步骤使用：env.BUILT_IMAGE = fullImageNameWithTimestamp</li>
</ul>
</li>
</ul>
<pre><code class="hljs language-groovy" lang="groovy">stage('Build Docker Image') {
    steps {
        script {
    
            // 生成时间戳
            def timestamp = new Date().format('yyyyMMddHHmm', TimeZone.getTimeZone('Asia/Shanghai'))
            def imageTag = "${IMAGE_NAME}:${timestamp}"
            def fullImageNameWithTimestamp = "${DOCKER_IMAGE_REGISTRY}/${IMAGE_PRE_NAME}/${imageTag}"
    
            // 使用 Docker 构建镜像
            echo "Building Docker image: ${fullImageNameWithTimestamp}"
            sh "docker build -t ${fullImageNameWithTimestamp} -f ${DOCKERFILE} ${MODULE_PATH}"
    
            withCredentials([usernamePassword(credentialsId: DOCKER_IMAGE_ACR_CRED, usernameVariable: 'REG_USER', passwordVariable: 'REG_PASS')]) {
                // 登录到镜像仓库
                echo "Login Docker..."
                sh "docker login --username $REG_USER -p $REG_PASS ${DOCKER_IMAGE_REGISTRY}"
                // 推送镜像
                echo "Push Docker Image ${fullImageNameWithTimestamp}"
                sh "docker push ${fullImageNameWithTimestamp}"
                // 推送完成后，删除本地镜像
                echo "Remove Docker Imag ${fullImageNameWithTimestamp}"
                sh "docker rmi ${fullImageNameWithTimestamp}"
            }
            
            // 输出构建信息
            echo "Successfully built and pushed image: ${fullImageNameWithTimestamp}"
            
            // 将镜像名称保存到环境变量，供后续步骤使用
            env.BUILT_IMAGE = fullImageNameWithTimestamp
        }
    }
}
</code></pre>
<h2 data-id="heading-6">部署到远程 Kubernetes 集群</h2>
<ul>
<li>withCredentials：使用凭据连接 Kubernetes 集群</li>
<li>设置集群连接配置：sh "export KUBECONFIG=$KUBECONFIG"</li>
<li>设置集群对应 Deployment 中的镜像信息：sh "kubectl set image deployment/<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>R</mi><mi>E</mi><mi>S</mi><mi>O</mi><mi>U</mi><mi>R</mi><mi>C</mi><msub><mi>E</mi><mi>N</mi></msub><mi>A</mi><mi>M</mi><mi>E</mi></mrow><annotation encoding="application/x-tex">{RESOURCE_NAME} </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">RESO</span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span><span class="mord mathnormal" style="margin-right:0.07153em;">RC</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3283em;"><span style="top:-2.55em;margin-left:-0.0576em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10903em;">N</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord mathnormal">A</span><span class="mord mathnormal" style="margin-right:0.05764em;">ME</span></span></span></span></span></span>{CONTAINER_NAME}=${BUILT_IMAGE}"</li>
<li>备注：Kubernetes 集群中 Deployment 配置内镜像信息修改后，集群会自行拉起新的 Pod，关闭旧的 Pod。</li>
</ul>
<pre><code class="hljs language-groovy" lang="groovy">stage('Deploy to Remote Kubernetes') {
    steps {
        script {
            withCredentials([file(credentialsId: KUBERNETES_CONFIG, variable: 'KUBECONFIG')]) {
                // 设置KUBECONFIG环境变量
                sh "export KUBECONFIG=$KUBECONFIG" 
                // 更新Deployment中的镜像信息
                // kubectl set image &lt;资源类型&gt;/&lt;资源名称&gt; &lt;容器名称&gt;=&lt;新镜像&gt;:&lt;标签&gt;
                sh "kubectl set image deployment/${RESOURCE_NAME} ${CONTAINER_NAME}=${BUILT_IMAGE}" 
            } 
        }
    }
}
</code></pre>
<h2 data-id="heading-7">附源码</h2>
<pre><code class="hljs language-groovy" lang="groovy">pipeline {
    agent any

    environment {
        // 模块信息
        MODULE_NAME = "xxx-servcie" // 模块名称
        MODULE_PATH = "./${MODULE_NAME}" // 模块路径，适用于微服务多 module
        // Git 仓库配置
        GIT_URL = 'git@git.xxx.com:xxx.git' // 替换为你的代码仓库
        GIT_KEY_ACR_CRED = 'git-ssh-key'
        BRANCH = 'master'
        // Docker 镜像相关配置
        DOCKER_IMAGE_REGISTRY = 'registry.xxx.aliyuncs.com'  // 替换为你的镜像仓库
        DOCKER_IMAGE_ACR_CRED = 'docker-cred'
        IMAGE_PRE_NAME = 'xxxx'  // 镜像名称前缀
        IMAGE_NAME = "${MODULE_NAME}"  // 镜像名称
        DOCKERFILE = "${MODULE_PATH}/Dockerfile" // 用来构建镜像的 dockerfile 文件
        // Kubernetes 相关配置
        KUBERNETES_CONFIG = "kubernetes-config" // Kubernetes 配置文件凭证
        RESOURCE_NAME = "${MODULE_NAME}" // 资源类型名称，这里为 deployment 名称
        CONTAINER_NAME = "${MODULE_NAME}" // 容器名称
    }

    tools {
        // Install the Maven version configured as "M3" and add it to the path.
        maven "Maven3"
    }

    stages {

        stage('Checkout') {
            steps {
                git branch: BRANCH, 
                url: GIT_URL,
                credentialsId: GIT_KEY_ACR_CRED
            }
        }

        stage('Package') {
            steps {
                // 执行 Maven 打包命令，只打包指定模块
                sh "mvn -pl ${MODULE_PATH} -am -B clean package -Ppro -Dfile.encoding=UTF-8 -DskipTests=true"
            }
        }

        stage('Build Docker Image') {
            steps {
                script {

                    // 生成时间戳
                    def timestamp = new Date().format('yyyyMMddHHmm', TimeZone.getTimeZone('Asia/Shanghai'))
                    def imageTag = "${IMAGE_NAME}:${timestamp}"
                    def fullImageNameWithTimestamp = "${DOCKER_IMAGE_REGISTRY}/${IMAGE_PRE_NAME}/${imageTag}"

                    // 使用 Docker 构建镜像
                    echo "Building Docker image: ${fullImageNameWithTimestamp}"
                    sh "docker build -t ${fullImageNameWithTimestamp} -f ${DOCKERFILE} ${MODULE_PATH}"

                    withCredentials([usernamePassword(credentialsId: DOCKER_IMAGE_ACR_CRED, usernameVariable: 'REG_USER', passwordVariable: 'REG_PASS')]) {
                        // 登录到镜像仓库
                        echo "Login Docker..."
                        sh "docker login --username $REG_USER -p $REG_PASS ${DOCKER_IMAGE_REGISTRY}"
                        // 推送镜像
                        echo "Push Docker Image ${fullImageNameWithTimestamp}"
                        sh "docker push ${fullImageNameWithTimestamp}"
                        // 推送完成后，删除本地镜像
                        echo "Remove Docker Imag ${fullImageNameWithTimestamp}"
                        sh "docker rmi ${fullImageNameWithTimestamp}"
                    }
                    
                    // 输出构建信息
                    echo "Successfully built and pushed image: ${fullImageNameWithTimestamp}"
                    
                    // 将镜像名称保存到环境变量，供后续步骤使用
                    env.BUILT_IMAGE = fullImageNameWithTimestamp
                }
            }
        }


        stage('Deploy to Remote Kubernetes') {
            steps {
                script {
                    withCredentials([file(credentialsId: KUBERNETES_CONFIG, variable: 'KUBECONFIG')]) {
                        // 设置KUBECONFIG环境变量
                        sh "export KUBECONFIG=$KUBECONFIG" 
                        // 更新Deployment中的镜像
                        // kubectl set image &lt;资源类型&gt;/&lt;资源名称&gt; &lt;容器名称&gt;=&lt;新镜像&gt;:&lt;标签&gt;
                        sh "kubectl set image deployment/${RESOURCE_NAME} ${CONTAINER_NAME}=${BUILT_IMAGE}" 
                    } 
                }
            }
        }


    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[布式事务详解：从理论到实践（RocketMQ + Seata）]]></title>    <link>https://juejin.cn/post/7577675494068027418</link>    <guid>https://juejin.cn/post/7577675494068027418</guid>    <pubDate>2025-11-29T16:16:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577675494068027418" data-draft-id="7577431644069462067" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="布式事务详解：从理论到实践（RocketMQ + Seata）"/> <meta itemprop="keywords" content="RocketMQ,Java"/> <meta itemprop="datePublished" content="2025-11-29T16:16:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            布式事务详解：从理论到实践（RocketMQ + Seata）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T16:16:21.000Z" title="Sat Nov 29 2025 16:16:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">分布式事务详解：从理论到实践（RocketMQ + Seata）</h2>
<h3 data-id="heading-1">前言</h3>
<p>在微服务架构日益普及的今天，分布式事务成为了每个后端开发者必须面对的挑战。本文将从理论到实践，深入探讨分布式事务的解决方案，并结合 RocketMQ 和 Seata 框架给出具体的代码示例。</p>
<hr/>
<h3 data-id="heading-2">一、为什么需要分布式事务？</h3>
<h4 data-id="heading-3">1.1 单体架构 vs 微服务架构</h4>
<pre><code class="hljs language-lua" lang="lua">+<span class="hljs-comment">------------------+          +------------------+</span>
|    单体应用       |          |    微服务架构     |
+<span class="hljs-comment">------------------+          +------------------+</span>
|                  |          |                  |
|  +<span class="hljs-comment">------------+  |          |  +-----------+   |</span>
|  |   订单     |  |          |  | 订单服务  |   |
|  +<span class="hljs-comment">------------+  |          |  +-----------+   |</span>
|        |         |          |       |          |
|  +<span class="hljs-comment">------------+  |          |  +-----------+   |</span>
|  |   库存     |  |          |  | 库存服务  |   |
|  +<span class="hljs-comment">------------+  |          |  +-----------+   |</span>
|        |         |          |       |          |
|  +<span class="hljs-comment">------------+  |          |  +-----------+   |</span>
|  |   账户     |  |          |  | 账户服务  |   |
|  +<span class="hljs-comment">------------+  |          |  +-----------+   |</span>
|        |         |          |       |          |
|  +<span class="hljs-comment">------------+  |          |  +-----------+   |</span>
|  |  单一数据库 |  |          |  | 各自数据库 |   |
|  +<span class="hljs-comment">------------+  |          |  +-----------+   |</span>
+<span class="hljs-comment">------------------+          +------------------+</span>
     本地事务                     分布式事务
</code></pre>
<h4 data-id="heading-4">1.2 典型业务场景</h4>
<p>以电商下单为例，一个完整的下单流程涉及：</p>
<pre><code class="hljs language-diff" lang="diff">用户下单流程：
<span class="hljs-addition">+--------+    +--------+    +--------+    +--------+</span>
|  创建  | -&gt; |  扣减  | -&gt; |  扣减  | -&gt; |  发送  |
|  订单  |    |  库存  |    |  余额  |    |  通知  |
<span class="hljs-addition">+--------+    +--------+    +--------+    +--------+</span>
    |             |             |             |
    v             v             v             v
<span class="hljs-addition">+--------+    +--------+    +--------+    +--------+</span>
| 订单DB |    | 库存DB |    | 账户DB |    | 消息队列|
<span class="hljs-addition">+--------+    +--------+    +--------+    +--------+</span>
</code></pre>
<p><strong>问题来了：</strong> 如果扣减余额失败，但订单已创建、库存已扣减，如何保证数据一致性？</p>
<h4 data-id="heading-5">1.3 分布式事务的核心挑战</h4>
<ol>
<li><strong>网络不可靠</strong>：服务间调用可能超时、失败</li>
<li><strong>服务不可用</strong>：某个服务可能宕机</li>
<li><strong>数据不一致</strong>：部分操作成功，部分失败</li>
<li><strong>并发问题</strong>：多个事务同时操作同一资源</li>
</ol>
<hr/>
<h3 data-id="heading-6">二、分布式事务理论基础</h3>
<h4 data-id="heading-7">2.1 CAP 理论</h4>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-code">                    C (Consistency)
                   一致性
                    /\
                   /  \
                  /    \
                 /      \
                /   CAP  \
               /    定理   \
              /____________\
             /              \
   A (Availability)    P (Partition Tolerance)
      可用性                 分区容错性
</span>
CAP定理：三者只能同时满足两个
<span class="hljs-bullet">-</span> CA：放弃分区容错（单机系统）
<span class="hljs-bullet">-</span> CP：放弃可用性（强一致性系统）
<span class="hljs-bullet">-</span> AP：放弃一致性（高可用系统）
</code></pre>
<h4 data-id="heading-8">2.2 BASE 理论</h4>
<ul>
<li><strong>Basically Available（基本可用）</strong>：允许损失部分可用性</li>
<li><strong>Soft State（软状态）</strong>：允许存在中间状态</li>
<li><strong>Eventually Consistent（最终一致性）</strong>：经过一段时间后达到一致</li>
</ul>
<h4 data-id="heading-9">2.3 常见一致性模型对比</h4>

























<table><thead><tr><th>模型</th><th>描述</th><th>适用场景</th></tr></thead><tbody><tr><td>强一致性</td><td>写入后立即可读</td><td>金融交易</td></tr><tr><td>弱一致性</td><td>不保证何时能读到</td><td>日志记录</td></tr><tr><td>最终一致性</td><td>一段时间后一致</td><td>电商订单</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-10">三、分布式事务解决方案</h3>
<h4 data-id="heading-11">3.1 方案对比</h4>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-addition">+------------------+----------+----------+----------+----------+</span>
|      方案        | 一致性   | 性能     | 复杂度   | 适用场景 |
<span class="hljs-addition">+------------------+----------+----------+----------+----------+</span>
| 2PC/3PC          | 强       | 低       | 中       | 数据库   |
| TCC              | 强       | 中       | 高       | 资金类   |
| 本地消息表       | 最终     | 高       | 中       | 通用     |
| 事务消息         | 最终     | 高       | 低       | 通用     |
| Saga             | 最终     | 高       | 中       | 长事务   |
| Seata AT         | 强       | 中       | 低       | 通用     |
<span class="hljs-addition">+------------------+----------+----------+----------+----------+</span>
</code></pre>
<h4 data-id="heading-12">3.2 两阶段提交（2PC）</h4>
<pre><code class="hljs language-sql" lang="sql">      协调者                    参与者A                  参与者B
        <span class="hljs-operator">|</span>                         <span class="hljs-operator">|</span>                        <span class="hljs-operator">|</span>
        <span class="hljs-operator">|</span>     <span class="hljs-number">1.</span> <span class="hljs-keyword">Prepare</span>请求      <span class="hljs-operator">|</span>                        <span class="hljs-operator">|</span>
        <span class="hljs-operator">|</span><span class="hljs-comment">------------------------&gt;|                        |</span>
        <span class="hljs-operator">|</span>                         <span class="hljs-operator">|</span>                        <span class="hljs-operator">|</span>
        <span class="hljs-operator">|</span>     <span class="hljs-number">1.</span> <span class="hljs-keyword">Prepare</span>请求      <span class="hljs-operator">|</span>                        <span class="hljs-operator">|</span>
        <span class="hljs-operator">|</span><span class="hljs-comment">-------------------------------------------------&gt;|</span>
        <span class="hljs-operator">|</span>                         <span class="hljs-operator">|</span>                        <span class="hljs-operator">|</span>
        <span class="hljs-operator">|</span>     <span class="hljs-number">2.</span> 准备就绪<span class="hljs-operator">/</span>失败    <span class="hljs-operator">|</span>                        <span class="hljs-operator">|</span>
        <span class="hljs-operator">|</span><span class="hljs-operator">&lt;</span><span class="hljs-comment">------------------------|                        |</span>
        <span class="hljs-operator">|</span>                         <span class="hljs-operator">|</span>                        <span class="hljs-operator">|</span>
        <span class="hljs-operator">|</span>     <span class="hljs-number">2.</span> 准备就绪<span class="hljs-operator">/</span>失败    <span class="hljs-operator">|</span>                        <span class="hljs-operator">|</span>
        <span class="hljs-operator">|</span><span class="hljs-operator">&lt;</span><span class="hljs-comment">-------------------------------------------------|</span>
        <span class="hljs-operator">|</span>                         <span class="hljs-operator">|</span>                        <span class="hljs-operator">|</span>
        <span class="hljs-operator">|</span>     <span class="hljs-number">3.</span> <span class="hljs-keyword">Commit</span><span class="hljs-operator">/</span><span class="hljs-keyword">Rollback</span>  <span class="hljs-operator">|</span>                        <span class="hljs-operator">|</span>
        <span class="hljs-operator">|</span><span class="hljs-comment">------------------------&gt;|                        |</span>
        <span class="hljs-operator">|</span>                         <span class="hljs-operator">|</span>                        <span class="hljs-operator">|</span>
        <span class="hljs-operator">|</span>     <span class="hljs-number">3.</span> <span class="hljs-keyword">Commit</span><span class="hljs-operator">/</span><span class="hljs-keyword">Rollback</span>  <span class="hljs-operator">|</span>                        <span class="hljs-operator">|</span>
        <span class="hljs-operator">|</span><span class="hljs-comment">-------------------------------------------------&gt;|</span>
        <span class="hljs-operator">|</span>                         <span class="hljs-operator">|</span>                        <span class="hljs-operator">|</span>
</code></pre>
<p><strong>缺点</strong>：同步阻塞、单点故障、数据不一致风险</p>
<h4 data-id="heading-13">3.3 TCC（Try-Confirm-Cancel）</h4>
<pre><code class="hljs language-lua" lang="lua">+<span class="hljs-comment">----------------------------------------------------------+</span>
|                        TCC 模式                           |
+<span class="hljs-comment">----------------------------------------------------------+</span>
|                                                          |
|   Try阶段          Confirm阶段        Cancel阶段          |
|   (资源预留)       (确认提交)         (回滚释放)           |
|                                                          |
|   +<span class="hljs-comment">----------+     +----------+      +----------+        |</span>
|   | 冻结库存 |     | 扣减库存 |      | 解冻库存 |        |
|   +<span class="hljs-comment">----------+     +----------+      +----------+        |</span>
|        |                |                 |              |
|   +<span class="hljs-comment">----------+     +----------+      +----------+        |</span>
|   | 冻结余额 |     | 扣减余额 |      | 解冻余额 |        |
|   +<span class="hljs-comment">----------+     +----------+      +----------+        |</span>
|                                                          |
+<span class="hljs-comment">----------------------------------------------------------+</span>
</code></pre>
<hr/>
<h3 data-id="heading-14">四、Seata 分布式事务框架</h3>
<h4 data-id="heading-15">4.1 Seata 架构</h4>
<pre><code class="hljs language-lua" lang="lua">+<span class="hljs-comment">------------------------------------------------------------------+</span>
|                         Seata 架构                                |
+<span class="hljs-comment">------------------------------------------------------------------+</span>
|                                                                   |
|                      +<span class="hljs-comment">---------------+                            |</span>
|                      |  TC (Server)  |                            |
|                      | 事务协调者    |                            |
|                      +<span class="hljs-comment">---------------+                            |</span>
|                       /             \                             |
|                      /               \                            |
|            +<span class="hljs-comment">--------+                 +--------+                  |</span>
|            |   TM   |                 |   RM   |                  |
|            | 事务   |                 | 资源   |                  |
|            | 管理器 |                 | 管理器 |                  |
|            +<span class="hljs-comment">--------+                 +--------+                  |</span>
|                |                           |                      |
|           +<span class="hljs-comment">---------+                 +---------+                 |</span>
|           | 业务服务 |                 | 数据库  |                 |
|           +<span class="hljs-comment">---------+                 +---------+                 |</span>
|                                                                   |
+<span class="hljs-comment">------------------------------------------------------------------+</span>

TC (Transaction Coordinator): 事务协调者，维护全局和分支事务状态
TM (Transaction Manager): 事务管理器，定义全局事务范围
RM (Resource Manager): 资源管理器，管理分支事务资源
</code></pre>
<h4 data-id="heading-16">4.2 Seata 四种模式</h4>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-addition">+--------+--------+--------+--------+</span>
|   AT   |  TCC   |  Saga  |   XA   |
<span class="hljs-addition">+--------+--------+--------+--------+</span>
| 自动   | 手动   | 长事务 | 强一致 |
| 补偿   | 补偿   | 补偿   | 两阶段 |
| 简单   | 复杂   | 中等   | 简单   |
| 最常用 | 资金类 | 复杂流程| 数据库 |
<span class="hljs-addition">+--------+--------+--------+--------+</span>
</code></pre>
<h4 data-id="heading-17">4.3 Seata AT 模式实战</h4>
<h5 data-id="heading-18">4.3.1 项目结构</h5>
<pre><code class="hljs language-bash" lang="bash">seata-demo/
├── order-service/          <span class="hljs-comment"># 订单服务</span>
├── storage-service/        <span class="hljs-comment"># 库存服务</span>
├── account-service/        <span class="hljs-comment"># 账户服务</span>
└── business-service/       <span class="hljs-comment"># 业务入口服务</span>
</code></pre>
<h5 data-id="heading-19">4.3.2 Maven 依赖</h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- pom.xml --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Spring Boot --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Seata --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>io.seata<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>seata-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.7.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Seata 与 Spring Cloud Alibaba 集成 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2022.0.0.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- MyBatis Plus --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.baomidou<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.5.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- MySQL --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.33<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h5 data-id="heading-20">4.3.3 配置文件</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># application.yml</span>
<span class="hljs-attr">server:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>

<span class="hljs-attr">spring:</span>
  <span class="hljs-attr">application:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">business-service</span>
  <span class="hljs-attr">datasource:</span>
    <span class="hljs-attr">url:</span> <span class="hljs-string">jdbc:mysql://localhost:3306/seata_order?useUnicode=true&amp;characterEncoding=utf8</span>
    <span class="hljs-attr">username:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">password:</span> <span class="hljs-string">root</span>
    <span class="hljs-attr">driver-class-name:</span> <span class="hljs-string">com.mysql.cj.jdbc.Driver</span>

<span class="hljs-comment"># Seata 配置</span>
<span class="hljs-attr">seata:</span>
  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>
  <span class="hljs-attr">application-id:</span> <span class="hljs-string">${spring.application.name}</span>
  <span class="hljs-attr">tx-service-group:</span> <span class="hljs-string">my_tx_group</span>
  <span class="hljs-attr">service:</span>
    <span class="hljs-attr">vgroup-mapping:</span>
      <span class="hljs-attr">my_tx_group:</span> <span class="hljs-string">default</span>
  <span class="hljs-attr">registry:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">nacos</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span>
      <span class="hljs-attr">namespace:</span> <span class="hljs-string">""</span>
      <span class="hljs-attr">group:</span> <span class="hljs-string">SEATA_GROUP</span>
  <span class="hljs-attr">config:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">nacos</span>
    <span class="hljs-attr">nacos:</span>
      <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span>
      <span class="hljs-attr">namespace:</span> <span class="hljs-string">""</span>
      <span class="hljs-attr">group:</span> <span class="hljs-string">SEATA_GROUP</span>
</code></pre>
<h5 data-id="heading-21">4.3.4 数据库表结构</h5>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 订单数据库</span>
<span class="hljs-keyword">CREATE</span> DATABASE seata_order;
USE seata_order;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `t_order` (
    `id` <span class="hljs-type">BIGINT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,
    `user_id` <span class="hljs-type">BIGINT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'用户ID'</span>,
    `product_id` <span class="hljs-type">BIGINT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'商品ID'</span>,
    `count` <span class="hljs-type">INT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'数量'</span>,
    `money` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">11</span>,<span class="hljs-number">0</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'金额'</span>,
    `status` <span class="hljs-type">INT</span>(<span class="hljs-number">1</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'订单状态：0创建中，1已完成'</span>,
    <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;

<span class="hljs-comment">-- Seata AT 模式需要的 undo_log 表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `undo_log` (
    `id` <span class="hljs-type">BIGINT</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,
    `branch_id` <span class="hljs-type">BIGINT</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    `xid` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    `context` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    `rollback_info` LONGBLOB <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    `log_status` <span class="hljs-type">INT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    `log_created` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    `log_modified` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    <span class="hljs-keyword">PRIMARY</span> KEY (`id`),
    <span class="hljs-keyword">UNIQUE</span> KEY `ux_undo_log` (`xid`,`branch_id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;

<span class="hljs-comment">-- 库存数据库</span>
<span class="hljs-keyword">CREATE</span> DATABASE seata_storage;
USE seata_storage;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `t_storage` (
    `id` <span class="hljs-type">BIGINT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,
    `product_id` <span class="hljs-type">BIGINT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'商品ID'</span>,
    `total` <span class="hljs-type">INT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'总库存'</span>,
    `used` <span class="hljs-type">INT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'已用库存'</span>,
    `residue` <span class="hljs-type">INT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'剩余库存'</span>,
    <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_storage <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">100</span>, <span class="hljs-number">0</span>, <span class="hljs-number">100</span>);

<span class="hljs-comment">-- 账户数据库</span>
<span class="hljs-keyword">CREATE</span> DATABASE seata_account;
USE seata_account;

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `t_account` (
    `id` <span class="hljs-type">BIGINT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,
    `user_id` <span class="hljs-type">BIGINT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'用户ID'</span>,
    `total` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">0</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'总额度'</span>,
    `used` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">0</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'已用额度'</span>,
    `residue` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">0</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'剩余额度'</span>,
    <span class="hljs-keyword">PRIMARY</span> KEY (`id`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8;

<span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> t_account <span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1000</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1000</span>);
</code></pre>
<h5 data-id="heading-22">4.3.5 核心代码实现</h5>
<p><strong>订单实体类</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@TableName("t_order")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Order</span> {
    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> Long userId;
    <span class="hljs-keyword">private</span> Long productId;
    <span class="hljs-keyword">private</span> Integer count;
    <span class="hljs-keyword">private</span> BigDecimal money;
    <span class="hljs-keyword">private</span> Integer status;
}
</code></pre>
<p><strong>订单服务接口</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">OrderService</span> {
    <span class="hljs-comment">/**
     * 创建订单
     */</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Long userId, Long productId, Integer count, BigDecimal money)</span>;
}
</code></pre>
<p><strong>订单服务实现</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">OrderService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StorageClient storageClient;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AccountClient accountClient;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrder</span><span class="hljs-params">(Long userId, Long productId, Integer count, BigDecimal money)</span> {
        log.info(<span class="hljs-string">"========== 开始创建订单 =========="</span>);

        <span class="hljs-comment">// 1. 创建订单</span>
        <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
        order.setUserId(userId);
        order.setProductId(productId);
        order.setCount(count);
        order.setMoney(money);
        order.setStatus(<span class="hljs-number">0</span>);
        orderMapper.insert(order);

        <span class="hljs-comment">// 2. 扣减库存</span>
        log.info(<span class="hljs-string">"========== 订单服务调用库存服务，扣减库存 =========="</span>);
        storageClient.decrease(productId, count);

        <span class="hljs-comment">// 3. 扣减账户余额</span>
        log.info(<span class="hljs-string">"========== 订单服务调用账户服务，扣减余额 =========="</span>);
        accountClient.decrease(userId, money);

        <span class="hljs-comment">// 4. 修改订单状态</span>
        log.info(<span class="hljs-string">"========== 修改订单状态 =========="</span>);
        order.setStatus(<span class="hljs-number">1</span>);
        orderMapper.updateById(order);

        log.info(<span class="hljs-string">"========== 订单创建完成 =========="</span>);
    }
}
</code></pre>
<p><strong>库存服务 Feign 客户端</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@FeignClient(value = "storage-service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">StorageClient</span> {

    <span class="hljs-meta">@PostMapping("/storage/decrease")</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">decrease</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam("productId")</span> Long productId,
                  <span class="hljs-meta">@RequestParam("count")</span> Integer count)</span>;
}
</code></pre>
<p><strong>账户服务 Feign 客户端</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@FeignClient(value = "account-service")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AccountClient</span> {

    <span class="hljs-meta">@PostMapping("/account/decrease")</span>
    <span class="hljs-keyword">void</span> <span class="hljs-title function_">decrease</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam("userId")</span> Long userId,
                  <span class="hljs-meta">@RequestParam("money")</span> BigDecimal money)</span>;
}
</code></pre>
<p><strong>库存服务实现</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">StorageServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">StorageService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StorageMapper storageMapper;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">decrease</span><span class="hljs-params">(Long productId, Integer count)</span> {
        log.info(<span class="hljs-string">"========== 扣减库存开始 =========="</span>);
        storageMapper.decrease(productId, count);
        log.info(<span class="hljs-string">"========== 扣减库存结束 =========="</span>);
    }
}
</code></pre>
<p><strong>账户服务实现</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccountServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AccountService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AccountMapper accountMapper;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">decrease</span><span class="hljs-params">(Long userId, BigDecimal money)</span> {
        log.info(<span class="hljs-string">"========== 扣减账户余额开始 =========="</span>);

        <span class="hljs-comment">// 模拟超时异常，测试分布式事务回滚</span>
        <span class="hljs-comment">// try {</span>
        <span class="hljs-comment">//     TimeUnit.SECONDS.sleep(20);</span>
        <span class="hljs-comment">// } catch (InterruptedException e) {</span>
        <span class="hljs-comment">//     e.printStackTrace();</span>
        <span class="hljs-comment">// }</span>

        accountMapper.decrease(userId, money);
        log.info(<span class="hljs-string">"========== 扣减账户余额结束 =========="</span>);
    }
}
</code></pre>
<p><strong>业务入口 - 使用 @GlobalTransactional 开启全局事务</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/business")</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BusinessController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderService orderService;

    <span class="hljs-comment">/**
     * 下单接口
     * <span class="hljs-doctag">@GlobalTransactional</span> 开启 Seata 全局事务
     */</span>
    <span class="hljs-meta">@PostMapping("/purchase")</span>
    <span class="hljs-meta">@GlobalTransactional(name = "purchase-order", rollbackFor = Exception.class)</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">purchase</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> Long userId,
                           <span class="hljs-meta">@RequestParam</span> Long productId,
                           <span class="hljs-meta">@RequestParam</span> Integer count,
                           <span class="hljs-meta">@RequestParam</span> BigDecimal money)</span> {
        log.info(<span class="hljs-string">"========== 开始全局事务，XID: {} =========="</span>, RootContext.getXID());

        orderService.createOrder(userId, productId, count, money);

        <span class="hljs-keyword">return</span> <span class="hljs-string">"下单成功"</span>;
    }
}
</code></pre>
<h4 data-id="heading-23">4.4 Seata TCC 模式实战</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * TCC 接口定义
 */</span>
<span class="hljs-meta">@LocalTCC</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">AccountTccService</span> {

    <span class="hljs-comment">/**
     * Try: 冻结金额
     */</span>
    <span class="hljs-meta">@TwoPhaseBusinessAction(name = "accountTcc", commitMethod = "confirm", rollbackMethod = "cancel")</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryFreeze</span><span class="hljs-params">(<span class="hljs-meta">@BusinessActionContextParameter(paramName = "userId")</span> Long userId,
                      <span class="hljs-meta">@BusinessActionContextParameter(paramName = "money")</span> BigDecimal money)</span>;

    <span class="hljs-comment">/**
     * Confirm: 确认扣款
     */</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">confirm</span><span class="hljs-params">(BusinessActionContext context)</span>;

    <span class="hljs-comment">/**
     * Cancel: 解冻金额
     */</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">cancel</span><span class="hljs-params">(BusinessActionContext context)</span>;
}

<span class="hljs-comment">/**
 * TCC 实现
 */</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AccountTccServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">AccountTccService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AccountMapper accountMapper;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryFreeze</span><span class="hljs-params">(Long userId, BigDecimal money)</span> {
        log.info(<span class="hljs-string">"========== Try: 冻结金额 userId={}, money={} =========="</span>, userId, money);

        <span class="hljs-comment">// 检查余额是否充足</span>
        <span class="hljs-type">Account</span> <span class="hljs-variable">account</span> <span class="hljs-operator">=</span> accountMapper.selectByUserId(userId);
        <span class="hljs-keyword">if</span> (account.getResidue().compareTo(money) &lt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"余额不足"</span>);
        }

        <span class="hljs-comment">// 冻结金额：residue -= money, frozen += money</span>
        accountMapper.freeze(userId, money);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">confirm</span><span class="hljs-params">(BusinessActionContext context)</span> {
        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> Long.valueOf(context.getActionContext(<span class="hljs-string">"userId"</span>).toString());
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">money</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(context.getActionContext(<span class="hljs-string">"money"</span>).toString());

        log.info(<span class="hljs-string">"========== Confirm: 确认扣款 userId={}, money={} =========="</span>, userId, money);

        <span class="hljs-comment">// 确认扣款：frozen -= money, used += money</span>
        accountMapper.confirmDecrease(userId, money);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">cancel</span><span class="hljs-params">(BusinessActionContext context)</span> {
        <span class="hljs-type">Long</span> <span class="hljs-variable">userId</span> <span class="hljs-operator">=</span> Long.valueOf(context.getActionContext(<span class="hljs-string">"userId"</span>).toString());
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">money</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(context.getActionContext(<span class="hljs-string">"money"</span>).toString());

        log.info(<span class="hljs-string">"========== Cancel: 解冻金额 userId={}, money={} =========="</span>, userId, money);

        <span class="hljs-comment">// 解冻金额：frozen -= money, residue += money</span>
        accountMapper.cancelFreeze(userId, money);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-24">五、RocketMQ 事务消息</h3>
<h4 data-id="heading-25">5.1 事务消息原理</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------------------------------------+</span>
<span class="hljs-operator">|</span>                     RocketMQ 事务消息流程                               <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------------------------------------+</span>
<span class="hljs-operator">|</span>                                                                        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>   生产者                         Broker                    消费者       <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>                              <span class="hljs-operator">|</span>                          <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>  <span class="hljs-number">1.</span> 发送Half消息             <span class="hljs-operator">|</span>                          <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span><span class="hljs-comment">-----------------------------&gt;|                          |        |</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>                              <span class="hljs-operator">|</span>                          <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>  <span class="hljs-number">2.</span> 返回发送结果             <span class="hljs-operator">|</span>                          <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span><span class="hljs-operator">&lt;</span><span class="hljs-comment">-----------------------------|                          |        |</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>                              <span class="hljs-operator">|</span>                          <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>  <span class="hljs-number">3.</span> 执行本地事务             <span class="hljs-operator">|</span>                          <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span><span class="hljs-comment">----+                         |                          |        |</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>    <span class="hljs-operator">|</span>                         <span class="hljs-operator">|</span>                          <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span><span class="hljs-operator">&lt;</span><span class="hljs-comment">---+                         |                          |        |</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>                              <span class="hljs-operator">|</span>                          <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>  <span class="hljs-number">4.</span> 提交<span class="hljs-operator">/</span>回滚事务状态        <span class="hljs-operator">|</span>                          <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span><span class="hljs-comment">-----------------------------&gt;|                          |        |</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>                              <span class="hljs-operator">|</span>                          <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>                              <span class="hljs-operator">|</span>  <span class="hljs-number">5.</span> 投递消息(<span class="hljs-keyword">Commit</span>)     <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>                              <span class="hljs-operator">|</span><span class="hljs-comment">-------------------------&gt;|        |</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>                              <span class="hljs-operator">|</span>                          <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>  回查本地事务状态(超时未确认)  <span class="hljs-operator">|</span>                          <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span><span class="hljs-operator">&lt;</span><span class="hljs-comment">-----------------------------|                          |        |</span>
<span class="hljs-operator">|</span>     <span class="hljs-operator">|</span>                              <span class="hljs-operator">|</span>                          <span class="hljs-operator">|</span>        <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">-----------------------------------------------------------------------+</span>
</code></pre>
<h4 data-id="heading-26">5.2 事务消息状态</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-operator">+</span><span class="hljs-comment">------------------+------------------+------------------+</span>
<span class="hljs-operator">|</span>    <span class="hljs-keyword">COMMIT</span>        <span class="hljs-operator">|</span>    <span class="hljs-keyword">ROLLBACK</span>      <span class="hljs-operator">|</span>    UNKNOW        <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">------------------+------------------+------------------+</span>
<span class="hljs-operator">|</span>  提交消息        <span class="hljs-operator">|</span>  回滚消息        <span class="hljs-operator">|</span>  未知状态        <span class="hljs-operator">|</span>
<span class="hljs-operator">|</span>  消费者可见      <span class="hljs-operator">|</span>  消息被删除      <span class="hljs-operator">|</span>  触发回查        <span class="hljs-operator">|</span>
<span class="hljs-operator">+</span><span class="hljs-comment">------------------+------------------+------------------+</span>
</code></pre>
<h4 data-id="heading-27">5.3 Maven 依赖</h4>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.rocketmq<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>rocketmq-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h4 data-id="heading-28">5.4 配置文件</h4>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">rocketmq:</span>
  <span class="hljs-attr">name-server:</span> <span class="hljs-string">localhost:9876</span>
  <span class="hljs-attr">producer:</span>
    <span class="hljs-attr">group:</span> <span class="hljs-string">tx-producer-group</span>
    <span class="hljs-attr">send-message-timeout:</span> <span class="hljs-number">3000</span>
</code></pre>
<h4 data-id="heading-29">5.5 事务消息生产者</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionProducerService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RocketMQTemplate rocketMQTemplate;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;

    <span class="hljs-comment">/**
     * 发送事务消息
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendTransactionMessage</span><span class="hljs-params">(OrderDTO orderDTO)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">transactionId</span> <span class="hljs-operator">=</span> UUID.randomUUID().toString();

        Message&lt;OrderDTO&gt; message = MessageBuilder
                .withPayload(orderDTO)
                .setHeader(<span class="hljs-string">"transactionId"</span>, transactionId)
                .build();

        <span class="hljs-comment">// 发送事务消息</span>
        <span class="hljs-type">TransactionSendResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> rocketMQTemplate.sendMessageInTransaction(
                <span class="hljs-string">"order-topic:create"</span>,  <span class="hljs-comment">// topic:tag</span>
                message,
                orderDTO  <span class="hljs-comment">// arg 参数，传递给本地事务执行器</span>
        );

        log.info(<span class="hljs-string">"事务消息发送结果: {}, transactionId: {}"</span>,
                result.getLocalTransactionState(), transactionId);
    }
}
</code></pre>
<h4 data-id="heading-30">5.6 事务监听器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RocketMQTransactionListener</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderTransactionListener</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RocketMQLocalTransactionListener</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> TransactionLogMapper transactionLogMapper;

    <span class="hljs-comment">/**
     * 执行本地事务
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> RocketMQLocalTransactionState <span class="hljs-title function_">executeLocalTransaction</span><span class="hljs-params">(Message msg, Object arg)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">transactionId</span> <span class="hljs-operator">=</span> (String) msg.getHeaders().get(<span class="hljs-string">"transactionId"</span>);
        <span class="hljs-type">OrderDTO</span> <span class="hljs-variable">orderDTO</span> <span class="hljs-operator">=</span> (OrderDTO) arg;

        log.info(<span class="hljs-string">"========== 执行本地事务，transactionId: {} =========="</span>, transactionId);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 创建订单</span>
            <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
            order.setUserId(orderDTO.getUserId());
            order.setProductId(orderDTO.getProductId());
            order.setCount(orderDTO.getCount());
            order.setMoney(orderDTO.getMoney());
            order.setStatus(<span class="hljs-number">0</span>);
            orderMapper.insert(order);

            <span class="hljs-comment">// 2. 记录事务日志（用于回查）</span>
            <span class="hljs-type">TransactionLog</span> <span class="hljs-variable">txLog</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TransactionLog</span>();
            txLog.setTransactionId(transactionId);
            txLog.setOrderId(order.getId());
            txLog.setStatus(<span class="hljs-number">1</span>);  <span class="hljs-comment">// 1: 已提交</span>
            transactionLogMapper.insert(txLog);

            log.info(<span class="hljs-string">"本地事务执行成功，提交消息"</span>);
            <span class="hljs-keyword">return</span> RocketMQLocalTransactionState.COMMIT;

        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"本地事务执行失败，回滚消息"</span>, e);
            <span class="hljs-keyword">return</span> RocketMQLocalTransactionState.ROLLBACK;
        }
    }

    <span class="hljs-comment">/**
     * 回查本地事务状态
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> RocketMQLocalTransactionState <span class="hljs-title function_">checkLocalTransaction</span><span class="hljs-params">(Message msg)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">transactionId</span> <span class="hljs-operator">=</span> (String) msg.getHeaders().get(<span class="hljs-string">"transactionId"</span>);

        log.info(<span class="hljs-string">"========== 回查本地事务状态，transactionId: {} =========="</span>, transactionId);

        <span class="hljs-comment">// 查询事务日志</span>
        <span class="hljs-type">TransactionLog</span> <span class="hljs-variable">txLog</span> <span class="hljs-operator">=</span> transactionLogMapper.selectByTransactionId(transactionId);

        <span class="hljs-keyword">if</span> (txLog != <span class="hljs-literal">null</span> &amp;&amp; txLog.getStatus() == <span class="hljs-number">1</span>) {
            log.info(<span class="hljs-string">"本地事务已提交"</span>);
            <span class="hljs-keyword">return</span> RocketMQLocalTransactionState.COMMIT;
        }

        log.info(<span class="hljs-string">"本地事务未提交，回滚消息"</span>);
        <span class="hljs-keyword">return</span> RocketMQLocalTransactionState.ROLLBACK;
    }
}
</code></pre>
<h4 data-id="heading-31">5.7 事务消息消费者</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@RocketMQMessageListener(
        topic = "order-topic",
        selectorExpression = "create",
        consumerGroup = "order-consumer-group"
)</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderTransactionConsumer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RocketMQListener</span>&lt;OrderDTO&gt; {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> StorageService storageService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AccountService accountService;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMessage</span><span class="hljs-params">(OrderDTO orderDTO)</span> {
        log.info(<span class="hljs-string">"========== 收到订单消息: {} =========="</span>, orderDTO);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 扣减库存</span>
            storageService.decrease(orderDTO.getProductId(), orderDTO.getCount());

            <span class="hljs-comment">// 扣减账户余额</span>
            accountService.decrease(orderDTO.getUserId(), orderDTO.getMoney());

            log.info(<span class="hljs-string">"订单处理完成"</span>);

        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"订单处理失败"</span>, e);
            <span class="hljs-comment">// 消费失败会自动重试</span>
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"订单处理失败"</span>, e);
        }
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-32">六、本地消息表方案</h3>
<h4 data-id="heading-33">6.1 架构图</h4>
<pre><code class="hljs language-lua" lang="lua">+<span class="hljs-comment">------------------------------------------------------------------+</span>
|                      本地消息表方案                                |
+<span class="hljs-comment">------------------------------------------------------------------+</span>
|                                                                   |
|   服务A                                      服务B                 |
|   +<span class="hljs-comment">------------------+                      +------------------+  |</span>
|   |    业务操作      |                      |    业务操作      |  |
|   +<span class="hljs-comment">--------+---------+                      +--------+---------+  |</span>
|            |                                         ^            |
|            v                                         |            |
|   +<span class="hljs-comment">------------------+                      +------------------+  |</span>
|   |   本地消息表     |                      |   消息消费       |  |
|   +<span class="hljs-comment">--------+---------+                      +--------+---------+  |</span>
|            |                                         ^            |
|            |         消息队列                        |            |
|            |    +<span class="hljs-comment">-----------------+                  |            |</span>
|            +<span class="hljs-comment">---&gt;|     MQ          |------------------+            |</span>
|                 +<span class="hljs-comment">-----------------+                               |</span>
|                         ^                                         |
|                         |                                         |
|                 +<span class="hljs-comment">-----------------+                               |</span>
|                 |   定时任务      |                               |
|                 |  (扫描未发送)   |                               |
|                 +<span class="hljs-comment">-----------------+                               |</span>
|                                                                   |
+<span class="hljs-comment">------------------------------------------------------------------+</span>
</code></pre>
<h4 data-id="heading-34">6.2 消息表结构</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `local_message` (
    `id` <span class="hljs-type">BIGINT</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,
    `message_id` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'消息ID'</span>,
    `message_body` TEXT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'消息内容'</span>,
    `message_topic` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">128</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'消息主题'</span>,
    `message_tag` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'消息标签'</span>,
    `status` TINYINT(<span class="hljs-number">4</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'状态: 0-待发送, 1-已发送, 2-已确认'</span>,
    `retry_count` <span class="hljs-type">INT</span>(<span class="hljs-number">11</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'0'</span> COMMENT <span class="hljs-string">'重试次数'</span>,
    `create_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    `update_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    <span class="hljs-keyword">PRIMARY</span> KEY (`id`),
    <span class="hljs-keyword">UNIQUE</span> KEY `uk_message_id` (`message_id`),
    KEY `idx_status` (`status`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4;
</code></pre>
<h4 data-id="heading-35">6.3 核心代码实现</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalMessageService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> LocalMessageMapper messageMapper;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RocketMQTemplate rocketMQTemplate;

    <span class="hljs-comment">/**
     * 保存本地消息（与业务操作在同一事务中）
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveMessage</span><span class="hljs-params">(String topic, String tag, Object payload)</span> {
        <span class="hljs-type">LocalMessage</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalMessage</span>();
        message.setMessageId(UUID.randomUUID().toString());
        message.setMessageTopic(topic);
        message.setMessageTag(tag);
        message.setMessageBody(JSON.toJSONString(payload));
        message.setStatus(<span class="hljs-number">0</span>);
        message.setRetryCount(<span class="hljs-number">0</span>);

        messageMapper.insert(message);
    }

    <span class="hljs-comment">/**
     * 发送消息
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessage</span><span class="hljs-params">(LocalMessage message)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">String</span> <span class="hljs-variable">destination</span> <span class="hljs-operator">=</span> message.getMessageTag() != <span class="hljs-literal">null</span>
                    ? message.getMessageTopic() + <span class="hljs-string">":"</span> + message.getMessageTag()
                    : message.getMessageTopic();

            rocketMQTemplate.syncSend(destination, message.getMessageBody());

            <span class="hljs-comment">// 更新状态为已发送</span>
            message.setStatus(<span class="hljs-number">1</span>);
            messageMapper.updateById(message);

            log.info(<span class="hljs-string">"消息发送成功: {}"</span>, message.getMessageId());

        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"消息发送失败: {}"</span>, message.getMessageId(), e);

            <span class="hljs-comment">// 增加重试次数</span>
            message.setRetryCount(message.getRetryCount() + <span class="hljs-number">1</span>);
            messageMapper.updateById(message);
        }
    }

    <span class="hljs-comment">/**
     * 确认消息（消费成功后调用）
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">confirmMessage</span><span class="hljs-params">(String messageId)</span> {
        <span class="hljs-type">LocalMessage</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> messageMapper.selectByMessageId(messageId);
        <span class="hljs-keyword">if</span> (message != <span class="hljs-literal">null</span>) {
            message.setStatus(<span class="hljs-number">2</span>);
            messageMapper.updateById(message);
        }
    }
}
</code></pre>
<h4 data-id="heading-36">6.4 定时任务扫描发送</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageSendTask</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> LocalMessageMapper messageMapper;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> LocalMessageService messageService;

    <span class="hljs-comment">/**
     * 每隔10秒扫描一次待发送消息
     */</span>
    <span class="hljs-meta">@Scheduled(fixedRate = 10000)</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">scanAndSendMessage</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 查询待发送的消息（status=0 且重试次数小于5）</span>
        List&lt;LocalMessage&gt; messages = messageMapper.selectPendingMessages(<span class="hljs-number">5</span>);

        <span class="hljs-keyword">for</span> (LocalMessage message : messages) {
            log.info(<span class="hljs-string">"扫描到待发送消息: {}"</span>, message.getMessageId());
            messageService.sendMessage(message);
        }
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-37">七、最佳实践与选型建议</h3>
<h4 data-id="heading-38">7.1 方案选型决策树</h4>
<pre><code class="hljs language-lua" lang="lua">                        开始选型
                           |
                           v
                    +<span class="hljs-comment">-------------+</span>
                    | 是否需要    |
                    | 强一致性?   |
                    +<span class="hljs-comment">------+------+</span>
                           |
              +<span class="hljs-comment">------------+------------+</span>
              |                         |
              v                         v
             是                        否
              |                         |
              v                         v
      +<span class="hljs-comment">-------+-------+         +-------+-------+</span>
      | 业务能否      |         | 考虑最终      |
      | 接受性能损耗? |         | 一致性方案    |
      +<span class="hljs-comment">-------+-------+         +-------+-------+</span>
              |                         |
      +<span class="hljs-comment">-------+-------+         +-------+-------+</span>
      |               |         |               |
      v               v         v               v
     是              否      事务消息      本地消息表
      |               |         |               |
      v               v         v               v
  Seata AT        Seata TCC   RocketMQ      可靠性要求高
</code></pre>
<h4 data-id="heading-39">7.2 各方案适用场景</h4>



































<table><thead><tr><th>方案</th><th>适用场景</th><th>典型案例</th></tr></thead><tbody><tr><td>Seata AT</td><td>常规业务、对一致性要求高</td><td>订单创建、库存扣减</td></tr><tr><td>Seata TCC</td><td>资金类业务、需要精确控制</td><td>转账、支付</td></tr><tr><td>RocketMQ事务消息</td><td>异步处理、最终一致性</td><td>订单通知、积分发放</td></tr><tr><td>本地消息表</td><td>可靠性要求高、不依赖MQ</td><td>跨系统数据同步</td></tr><tr><td>Saga</td><td>长事务、复杂业务流程</td><td>机票+酒店+租车预订</td></tr></tbody></table>
<h4 data-id="heading-40">7.3 生产环境注意事项</h4>
<pre><code class="hljs language-css" lang="css">+------------------------------------------------------------------+
|                    生产环境 Checklist                             |
+------------------------------------------------------------------+
|                                                                   |
|  <span class="hljs-selector-attr">[ ]</span> TC Server 高可用部署（至少<span class="hljs-number">3</span>节点）                             |
|  <span class="hljs-selector-attr">[ ]</span> 配置合理的事务超时时间                                        |
|  <span class="hljs-selector-attr">[ ]</span> 监控全局事务状态                                              |
|  <span class="hljs-selector-attr">[ ]</span> 处理悬挂事务                                                  |
|  <span class="hljs-selector-attr">[ ]</span> 幂等性设计                                                   |
|  <span class="hljs-selector-attr">[ ]</span> 异常重试机制                                                 |
|  <span class="hljs-selector-attr">[ ]</span> 分布式锁防并发                                               |
|  <span class="hljs-selector-attr">[ ]</span> 日志记录完整                                                 |
|                                                                   |
+------------------------------------------------------------------+
</code></pre>
<h4 data-id="heading-41">7.4 幂等性设计</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IdempotentOrderService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, String&gt; redisTemplate;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> OrderMapper orderMapper;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">IDEMPOTENT_KEY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"order:idempotent:"</span>;

    <span class="hljs-comment">/**
     * 幂等性创建订单
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> Order <span class="hljs-title function_">createOrderIdempotent</span><span class="hljs-params">(String requestId, OrderDTO orderDTO)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> IDEMPOTENT_KEY_PREFIX + requestId;

        <span class="hljs-comment">// 1. 检查是否已处理</span>
        <span class="hljs-type">Boolean</span> <span class="hljs-variable">setResult</span> <span class="hljs-operator">=</span> redisTemplate.opsForValue()
                .setIfAbsent(key, <span class="hljs-string">"processing"</span>, Duration.ofMinutes(<span class="hljs-number">30</span>));

        <span class="hljs-keyword">if</span> (Boolean.FALSE.equals(setResult)) {
            <span class="hljs-comment">// 已存在，查询已有订单返回</span>
            log.info(<span class="hljs-string">"重复请求，requestId: {}"</span>, requestId);
            <span class="hljs-type">Order</span> <span class="hljs-variable">existOrder</span> <span class="hljs-operator">=</span> orderMapper.selectByRequestId(requestId);
            <span class="hljs-keyword">if</span> (existOrder != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">return</span> existOrder;
            }
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"订单处理中，请稍后查询"</span>);
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 2. 创建订单</span>
            <span class="hljs-type">Order</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Order</span>();
            order.setRequestId(requestId);
            order.setUserId(orderDTO.getUserId());
            order.setProductId(orderDTO.getProductId());
            order.setCount(orderDTO.getCount());
            order.setMoney(orderDTO.getMoney());
            order.setStatus(<span class="hljs-number">0</span>);
            orderMapper.insert(order);

            <span class="hljs-comment">// 3. 更新 Redis 状态</span>
            redisTemplate.opsForValue().set(key, <span class="hljs-string">"completed"</span>, Duration.ofHours(<span class="hljs-number">24</span>));

            <span class="hljs-keyword">return</span> order;

        } <span class="hljs-keyword">catch</span> (Exception e) {
            <span class="hljs-comment">// 失败则删除 key，允许重试</span>
            redisTemplate.delete(key);
            <span class="hljs-keyword">throw</span> e;
        }
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-42">八、总结</h3>
<p>分布式事务是微服务架构中的核心难题，没有银弹方案。选择合适的方案需要权衡：</p>
<ol>
<li><strong>一致性要求</strong>：强一致性选 Seata，最终一致性选事务消息</li>
<li><strong>性能要求</strong>：高性能选异步方案，低延迟选 AT 模式</li>
<li><strong>业务复杂度</strong>：简单业务用 AT，复杂业务用 TCC 或 Saga</li>
<li><strong>运维成本</strong>：本地消息表最简单，Seata 需要维护 TC</li>
</ol>
<p>核心原则：</p>
<ul>
<li><strong>能不用分布式事务就不用</strong>：合理拆分服务边界</li>
<li><strong>优先考虑最终一致性</strong>：大多数业务可以接受</li>
<li><strong>做好幂等设计</strong>：分布式环境必备</li>
<li><strong>完善监控告警</strong>：及时发现和处理异常事务</li>
</ul>
<p>希望本文能帮助你在实际项目中更好地应对分布式事务挑战！</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[redis的qps从100飙升到10000的全流程解决方案]]></title>    <link>https://juejin.cn/post/7577715145122037814</link>    <guid>https://juejin.cn/post/7577715145122037814</guid>    <pubDate>2025-11-29T21:22:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577715145122037814" data-draft-id="7577704980855504950" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="redis的qps从100飙升到10000的全流程解决方案"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-29T21:22:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="随风飘的云"/> <meta itemprop="url" content="https://juejin.cn/user/361110952753560"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            redis的qps从100飙升到10000的全流程解决方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/361110952753560/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    随风飘的云
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T21:22:44.000Z" title="Sat Nov 29 2025 21:22:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Redis QPS 从 100 飙升至 10000 属于典型的流量突增场景，核心排查逻辑是<strong>先区分 “合法流量增长” 还是 “异常 / 低效请求导致”，再针对性止血 + 根因修复</strong>，全程需结合 Redis 监控、日志和命令分析，以下是全流程排查与解决方案：</p>
<h3 data-id="heading-0">一、紧急止血：避免 Redis 宕机（0-5 分钟）</h3>
<p>Redis 单实例 QPS 极限约 10 万 - 15 万，但突增到 1 万可能导致 CPU / 内存 / 网络打满，先快速控风险：</p>
<ol>
<li>
<p><strong>临时限流 / 降级</strong></p>
<ul>
<li>若 Redis 接入了网关 / 代理（如 Nginx、Kong、Redis Cluster Proxy），立即配置 Redis QPS 限流阈值（如设为 12000，留缓冲），超出请求返回 “服务繁忙” 或走降级逻辑（如返回本地缓存）。</li>
<li>对非核心业务的 Redis 请求（如统计、日志上报）直接降级，暂停调用，优先保障核心流程（如下单、支付）。</li>
</ul>
</li>
<li>
<p><strong>扩容缓解压力</strong></p>
<ul>
<li>若为单机 Redis，快速切换至 Redis Cluster 并新增节点（如从 3 节点扩至 6 节点），分摊流量；若已为集群，将热点槽位迁移至空闲节点。</li>
<li>检查 Redis 所在服务器的资源（CPU、内存、网卡），若 CPU&gt;90%/ 网卡带宽打满，临时扩容服务器配置（如 CPU 核数翻倍、带宽升级）。</li>
</ul>
</li>
<li>
<p><strong>禁用危险命令</strong></p>
<ul>
<li>临时禁用高开销命令（如<code>KEYS *</code>、<code>FLUSHDB</code>、<code>HGETALL</code>、<code>SMEMBERS</code>），避免雪上加霜（可通过<code>redis.conf</code>或<code>CONFIG SET disable-commands "KEYS,FLUSHDB"</code>配置）。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-1">二、定位根因：明确 QPS 飙升的核心原因（5-30 分钟）</h3>
<p>通过 Redis 自带工具 + 监控平台，从 “请求来源、命令类型、业务场景” 三维度分析：</p>
<h4 data-id="heading-2">步骤 1：基础监控分析（先看宏观指标）</h4>
<p>通过<code>redis-cli info stats</code>/ 监控平台（如 Prometheus+Grafana、Redis Insight、阿里云 Redis 控制台）查看核心指标：</p>



































<table><thead><tr><th>核心指标</th><th>异常表现</th><th>指向问题</th></tr></thead><tbody><tr><td><code>instantaneous_ops_per_sec</code></td><td>稳定 100→突增 10000</td><td>流量真实增长 / 低效请求叠加</td></tr><tr><td><code>used_cpu_sys</code>/<code>used_cpu_user</code></td><td>CPU&gt;80%</td><td>计算密集型命令（如排序、聚合）或高频小命令（如 INCR）</td></tr><tr><td><code>used_memory</code>/<code>used_memory_rss</code></td><td>内存突增</td><td>大 value 写入、缓存过期策略失效</td></tr><tr><td><code>network_input_bytes</code>/<code>network_output_bytes</code></td><td>网卡打满</td><td>大流量请求（如 HGETALL、大字符串 GET）</td></tr><tr><td><code>keyspace_hits</code>/<code>keyspace_misses</code></td><td>缓存命中率骤降（&lt;80%）</td><td>缓存穿透 / 缓存失效，导致大量无效请求</td></tr></tbody></table>
<h4 data-id="heading-3">步骤 2：分析请求来源（找流量入口）</h4>
<ol>
<li>
<p><strong>定位调用方 IP / 服务</strong>：</p>
<ul>
<li>查看 Redis 慢日志 / 访问日志（需提前开启<code>slowlog</code>），执行<code>slowlog get 100</code>，筛选请求来源 IP；</li>
<li>若接入了链路追踪（如 SkyWalking、Pinpoint），直接查看调用 Redis 的服务列表，确认是否某服务 / IP 的调用量突增（如某新上线功能、定时任务）。</li>
</ul>
</li>
<li>
<p><strong>判断流量合法性</strong>：</p>
<ul>
<li>若单 IP 调用量占比 &gt; 50%，大概率是爬虫、恶意攻击或客户端 BUG（如无限重试、循环请求），直接在防火墙 / Redis 端拉黑该 IP；</li>
<li>若调用方为内部服务，检查是否有代码 BUG（如重试逻辑异常、循环查询 Redis）。</li>
</ul>
</li>
</ol>
<h4 data-id="heading-4">步骤 3：分析命令类型（找低效 / 高频命令）</h4>
<p>执行<code>redis-cli --stat</code>（实时统计命令执行次数）或<code>info commandstats</code>（按命令统计），重点关注：</p>
<ol>
<li>
<p><strong>高频小命令</strong>：</p>
<ul>
<li>如<code>INCR</code>/<code>DECR</code>/<code>HSET</code>/<code>GET</code>/<code>SET</code>占比 &gt; 90%，且 QPS=10000，可能是正常业务增长（如秒杀、计数场景），或客户端无缓存直接调用 Redis；</li>
</ul>
</li>
<li>
<p><strong>高开销命令</strong>：</p>
<ul>
<li>若<code>SORT</code>/<code>ZUNIONSTORE</code>/<code>HGETALL</code>/<code>SMEMBERS</code>/<code>KEYS</code>占比高，哪怕单次调用，也会因耗时久导致 QPS “被动升高”（请求堆积）；</li>
<li>若<code>MGET</code>/<code>MSET</code>调用少，但单条命令携带上千个 key，等价于放大了 QPS（如 1 次 MGET 带 1000 个 key=1000 次 GET）；</li>
</ul>
</li>
<li>
<p><strong>无效请求</strong>：</p>
<ul>
<li>缓存穿透：<code>GET</code>不存在的 key 占比高（<code>keyspace_misses</code>高），导致 Redis 空查，QPS 虚高；</li>
<li>缓存雪崩：大量 key 同时过期，导致所有请求直接打 Redis，QPS 突增；</li>
<li>缓存击穿：单个热点 key 过期，大量请求同时访问该 key，瞬间拉高 QPS。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-5">三、分场景解决方案（30 分钟后）</h3>
<p>根据根因针对性修复，从 “临时缓解” 到 “长期优化”：</p>













































<table><thead><tr><th>飙升类型</th><th>临时解决方案</th><th>长期优化方案</th></tr></thead><tbody><tr><td>正常业务增长（如秒杀）</td><td>1. 扩容 Redis Cluster 节点数；2. 热点 key 分片（如将 count:123 拆为 count:123:1~10）；3. 增加本地缓存（如 Guava）分担流量</td><td>1. 配置 Redis 弹性伸缩（QPS 超 8000 自动扩容）；2. 对计数类场景使用 Redis HyperLogLog / 计数器组件；3. 压测验证 Redis 极限 QPS（如模拟 2 万 QPS）</td></tr><tr><td>高频低效命令（如 HGETALL、KEYS）</td><td>1. 临时替换为低开销命令（如 HGETALL→HSCAN 分批获取，KEYS→SCAN）；2. 限制大 key（&gt;100KB）的读写</td><td>1. 规范 Redis 命令使用手册，禁用高开销命令；2. 拆分大 key（如大 Hash 拆为多个小 Hash）；3. 对聚合类查询（如排序）迁移至离线计算（如 Spark）</td></tr><tr><td>缓存穿透</td><td>1. 临时配置空值缓存（如对不存在的 key 设置过期时间 1 分钟）；2. 布隆过滤器拦截无效 key</td><td>1. 接入全局布隆过滤器（如 RedisBloom 模块）；2. 业务层校验请求参数，过滤无效 key</td></tr><tr><td>缓存雪崩</td><td>1. 临时延长过期 key 的 TTL；2. 对过期时间添加随机值（如 TTL=30 分钟 ±5 分钟）</td><td>1. 核心 key 设置永不过期，通过后台异步更新；2. 分级缓存（本地缓存 + Redis）；3. 过期时间错开（按业务维度分批过期）</td></tr><tr><td>缓存击穿</td><td>1. 临时对热点 key 加互斥锁（如 SETNX），只允许 1 个请求更新缓存，其余等待；2. 热点 key 设为永不过期</td><td>1. 接入 Redis 热点 key 探测工具（如 Redis Cluster 的 hot-key-detect）；2. 热点 key 预加载 + 本地缓存；3. 使用 Redisson 分布式锁优化缓存更新逻辑</td></tr><tr><td>恶意攻击 / 客户端 BUG</td><td>1. 拉黑异常 IP / 服务；2. 限制单客户端连接数（CONFIG SET maxclients 1000）；3. 通知调用方修复重试逻辑</td><td>1. Redis 接入 WAF，拦截高频异常请求；2. 客户端添加请求限流（如每秒调用 Redis 不超过 100 次）；3. 完善客户端重试机制（最多 3 次，间隔 100ms）</td></tr><tr><td>大流量请求（网卡打满）</td><td>1. 临时压缩 Redis 传输数据（如使用 Protocol Buffer 代替 JSON）；2. 限制单条请求的 value 大小（&lt;10KB）</td><td>1. 开启 Redis 压缩（CONFIG SET rdbcompression yes）；2. 大文件 / 大数据迁移至对象存储（如 OSS），Redis 仅存索引</td></tr></tbody></table>
<h3 data-id="heading-6">四、复盘与长效防护（问题解决后 1-2 天）</h3>
<ol>
<li>
<p><strong>完善监控告警</strong>：</p>
<ul>
<li>新增告警规则：QPS 5 分钟内增长超 200%、CPU&gt;80%、缓存命中率 &lt; 90%、大 key 数量突增；</li>
<li>监控维度：QPS、CPU、内存、网卡、缓存命中率、慢命令数、大 key 数量。</li>
</ul>
</li>
<li>
<p><strong>规范 Redis 使用</strong>：</p>
<ul>
<li>制定 Redis 开发规范：禁用高开销命令、限制 key/value 大小、强制设置过期时间（核心 key 除外）；</li>
<li>上线前审核：所有 Redis 调用需经过代码评审，避免低效 / 高频请求。</li>
</ul>
</li>
<li>
<p><strong>应急演练</strong>：</p>
<ul>
<li>模拟 Redis QPS 突增到 1 万、2 万的场景，验证限流、扩容、降级方案的有效性；</li>
<li>整理 Redis 应急排查手册，明确责任人、工具（如 slowlog、info 命令）和步骤。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-7">关键工具速查</h3>





























<table><thead><tr><th>排查目标</th><th>核心命令 / 工具</th></tr></thead><tbody><tr><td>实时 QPS / 命令统计</td><td><code>redis-cli --stat</code>、<code>info commandstats</code></td></tr><tr><td>慢请求分析</td><td><code>slowlog get 100</code>、<code>slowlog len</code></td></tr><tr><td>大 key 检测</td><td><code>redis-cli --bigkeys</code>、Redis Insight</td></tr><tr><td>流量来源</td><td>Redis 访问日志、链路追踪平台（SkyWalking）</td></tr><tr><td>资源监控</td><td><code>top</code>（CPU / 内存）、<code>iftop</code>（网卡）、Prometheus+Grafana</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[财务对账系统设计与实现]]></title>    <link>https://juejin.cn/post/7577718777481527334</link>    <guid>https://juejin.cn/post/7577718777481527334</guid>    <pubDate>2025-11-29T16:18:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577718777481527334" data-draft-id="7577599299598827571" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="财务对账系统设计与实现"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2025-11-29T16:18:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="雨中飘荡的记忆"/> <meta itemprop="url" content="https://juejin.cn/user/694547077666606"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            财务对账系统设计与实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/694547077666606/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    雨中飘荡的记忆
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T16:18:20.000Z" title="Sat Nov 29 2025 16:18:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">财务对账系统设计与实现：支付宝、微信、银行流水全渠道对账</h2>
<h3 data-id="heading-1">前言</h3>
<p>在电商、金融等业务场景中，对账系统是保障资金安全的核心环节。本文将详细介绍如何设计和实现一套支持支付宝、微信、银行等多渠道的财务对账系统，涵盖系统架构、核心算法、代码实现等内容。</p>
<hr/>
<h3 data-id="heading-2">一、对账系统概述</h3>
<h4 data-id="heading-3">1.1 什么是对账</h4>
<p>对账是指将企业内部的交易记录与外部渠道（支付宝、微信、银行等）的流水记录进行核对，确保双方数据一致的过程。</p>
<pre><code class="hljs language-lua" lang="lua">+<span class="hljs-comment">------------------------------------------------------------------+</span>
|                        对账核心流程                                |
+<span class="hljs-comment">------------------------------------------------------------------+</span>
|                                                                   |
|   内部系统                                       外部渠道          |
|   +<span class="hljs-comment">------------------+                    +------------------+    |</span>
|   |   交易订单表     |                    |   支付宝账单     |    |
|   |   支付流水表     |      对账核心      |   微信账单       |    |
|   |   退款记录表     |  &lt;<span class="hljs-comment">--------------&gt; |   银行流水       |    |</span>
|   +<span class="hljs-comment">------------------+                    |   自定义流水     |    |</span>
|                                           +<span class="hljs-comment">------------------+    |</span>
|                             |                                     |
|                             v                                     |
|                    +<span class="hljs-comment">------------------+                           |</span>
|                    |    对账结果      |                           |
|                    +<span class="hljs-comment">------------------+                           |</span>
|                    | - 对账成功       |                           |
|                    | - 本地有渠道无   |                           |
|                    | - 渠道有本地无   |                           |
|                    | - 金额不一致     |                           |
|                    +<span class="hljs-comment">------------------+                           |</span>
|                                                                   |
+<span class="hljs-comment">------------------------------------------------------------------+</span>
</code></pre>
<h4 data-id="heading-4">1.2 对账的目的</h4>
<ol>
<li><strong>资金安全</strong>：及时发现异常交易，防止资金损失</li>
<li><strong>账务准确</strong>：确保财务报表数据准确</li>
<li><strong>差错处理</strong>：快速定位和处理对账差异</li>
<li><strong>风险控制</strong>：发现潜在的欺诈和风险</li>
</ol>
<h4 data-id="heading-5">1.3 对账差异类型</h4>
<pre><code class="hljs language-lua" lang="lua">+<span class="hljs-comment">------------------------------------------------------------------+</span>
|                        对账差异分类                                |
+<span class="hljs-comment">------------------------------------------------------------------+</span>
|                                                                   |
|   +<span class="hljs-comment">--------------------+------------------------------------+     |</span>
|   |     差异类型       |              描述                  |     |
|   +<span class="hljs-comment">--------------------+------------------------------------+     |</span>
|   |   本地多（长款）   |  本地有记录，渠道无记录             |     |
|   +<span class="hljs-comment">--------------------+------------------------------------+     |</span>
|   |   渠道多（短款）   |  渠道有记录，本地无记录             |     |
|   +<span class="hljs-comment">--------------------+------------------------------------+     |</span>
|   |   金额不一致       |  双方都有记录，但金额不同           |     |
|   +<span class="hljs-comment">--------------------+------------------------------------+     |</span>
|   |   状态不一致       |  双方金额相同，但交易状态不同       |     |
|   +<span class="hljs-comment">--------------------+------------------------------------+     |</span>
|   |   时间差异         |  交易时间跨天导致的差异             |     |
|   +<span class="hljs-comment">--------------------+------------------------------------+     |</span>
|                                                                   |
+<span class="hljs-comment">------------------------------------------------------------------+</span>
</code></pre>
<hr/>
<h3 data-id="heading-6">二、系统架构设计</h3>
<h4 data-id="heading-7">2.1 整体架构</h4>
<pre><code class="hljs language-lua" lang="lua">+<span class="hljs-comment">------------------------------------------------------------------------+</span>
|                          对账系统整体架构                                |
+<span class="hljs-comment">------------------------------------------------------------------------+</span>
|                                                                         |
|   +<span class="hljs-comment">-------------------+    +-------------------+    +------------------+ |</span>
|   |    定时任务       |    |    手动触发       |    |    文件上传      | |
|   +<span class="hljs-comment">--------+----------+    +--------+----------+    +--------+---------+ |</span>
|            |                        |                        |          |
|            +<span class="hljs-comment">------------------------+------------------------+          |</span>
|                                     |                                   |
|                                     v                                   |
|   +<span class="hljs-comment">---------------------------------------------------------------------+</span>
|   |                          对账调度中心                                |
|   +<span class="hljs-comment">---------------------------------------------------------------------+</span>
|                                     |                                   |
|            +<span class="hljs-comment">------------------------+------------------------+          |</span>
|            |                        |                        |          |
|            v                        v                        v          |
|   +<span class="hljs-comment">----------------+       +----------------+       +----------------+  |</span>
|   | 支付宝对账模块 |       | 微信对账模块   |       | 银行对账模块   |  |
|   +<span class="hljs-comment">----------------+       +----------------+       +----------------+  |</span>
|            |                        |                        |          |
|            +<span class="hljs-comment">------------------------+------------------------+          |</span>
|                                     |                                   |
|                                     v                                   |
|   +<span class="hljs-comment">---------------------------------------------------------------------+</span>
|   |                          对账引擎核心                                |
|   |  +<span class="hljs-comment">-------------+  +-------------+  +-------------+  +-------------+ |</span>
|   |  | 文件解析器  |  | 数据清洗    |  | 匹配算法    |  | 差异处理    | |
|   |  +<span class="hljs-comment">-------------+  +-------------+  +-------------+  +-------------+ |</span>
|   +<span class="hljs-comment">---------------------------------------------------------------------+</span>
|                                     |                                   |
|                                     v                                   |
|   +<span class="hljs-comment">---------------------------------------------------------------------+</span>
|   |                          数据存储层                                  |
|   |  +<span class="hljs-comment">-------------+  +-------------+  +-------------+  +-------------+ |</span>
|   |  | 对账任务表  |  | 渠道流水表  |  | 对账结果表  |  | 差异记录表  | |
|   |  +<span class="hljs-comment">-------------+  +-------------+  +-------------+  +-------------+ |</span>
|   +<span class="hljs-comment">---------------------------------------------------------------------+</span>
|                                     |                                   |
|                                     v                                   |
|   +<span class="hljs-comment">---------------------------------------------------------------------+</span>
|   |                          监控告警层                                  |
|   |  +<span class="hljs-comment">------------------+  +------------------+  +-------------------+  |</span>
|   |  | 对账进度监控     |  | 差异率告警       |  | 异常通知          |  |
|   |  +<span class="hljs-comment">------------------+  +------------------+  +-------------------+  |</span>
|   +<span class="hljs-comment">---------------------------------------------------------------------+</span>
|                                                                         |
+<span class="hljs-comment">------------------------------------------------------------------------+</span>
</code></pre>
<h4 data-id="heading-8">2.2 核心模块说明</h4>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-addition">+------------------------------------------------------------------+</span>
|                        核心模块职责                                |
<span class="hljs-addition">+------------------------------------------------------------------+</span>
|                                                                   |
|   对账调度中心：                                                   |
|   - 管理对账任务的创建、调度、执行                                 |
|   - 支持定时对账和手动触发                                        |
|   - 任务状态管理和失败重试                                        |
|                                                                   |
|   文件解析器：                                                     |
|   - 支持 CSV、Excel、TXT 等格式                                   |
|   - 适配不同渠道的账单格式                                        |
|   - 大文件分片解析                                                |
|                                                                   |
|   匹配算法：                                                       |
|   - 单字段匹配（订单号）                                          |
|   - 多字段联合匹配                                                |
|   - 模糊匹配和容差匹配                                            |
|                                                                   |
|   差异处理：                                                       |
|   - 差异分类和标记                                                |
|   - 自动处理规则                                                  |
|   - 人工审核流程                                                  |
|                                                                   |
<span class="hljs-addition">+------------------------------------------------------------------+</span>
</code></pre>
<hr/>
<h3 data-id="heading-9">三、数据库设计</h3>
<h4 data-id="heading-10">3.1 核心表结构</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 1. 对账任务表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `recon_task` (
    `id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT COMMENT <span class="hljs-string">'主键ID'</span>,
    `task_no` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'任务编号'</span>,
    `channel_type` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'渠道类型：ALIPAY/WECHAT/BANK/CUSTOM'</span>,
    `recon_date` <span class="hljs-type">DATE</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'对账日期'</span>,
    `status` TINYINT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'状态：0-待处理,1-处理中,2-已完成,3-失败'</span>,
    `total_count` <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'总记录数'</span>,
    `success_count` <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'对账成功数'</span>,
    `fail_count` <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'对账失败数'</span>,
    `diff_count` <span class="hljs-type">INT</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'差异数'</span>,
    `file_path` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">500</span>) COMMENT <span class="hljs-string">'账单文件路径'</span>,
    `error_msg` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">1000</span>) COMMENT <span class="hljs-string">'错误信息'</span>,
    `start_time` DATETIME COMMENT <span class="hljs-string">'开始时间'</span>,
    `end_time` DATETIME COMMENT <span class="hljs-string">'结束时间'</span>,
    `create_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    `update_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    <span class="hljs-keyword">UNIQUE</span> KEY `uk_task_no` (`task_no`),
    KEY `idx_channel_date` (`channel_type`, `recon_date`),
    KEY `idx_status` (`status`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'对账任务表'</span>;

<span class="hljs-comment">-- 2. 渠道流水表（支付宝）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `channel_bill_alipay` (
    `id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    `task_id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'任务ID'</span>,
    `trade_no` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'支付宝交易号'</span>,
    `out_trade_no` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) COMMENT <span class="hljs-string">'商户订单号'</span>,
    `trade_type` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) COMMENT <span class="hljs-string">'交易类型'</span>,
    `trade_status` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) COMMENT <span class="hljs-string">'交易状态'</span>,
    `amount` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'交易金额'</span>,
    `fee` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'手续费'</span>,
    `trade_time` DATETIME COMMENT <span class="hljs-string">'交易时间'</span>,
    `subject` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">256</span>) COMMENT <span class="hljs-string">'商品名称'</span>,
    `recon_status` TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'对账状态：0-待对账,1-已对账,2-差异'</span>,
    `create_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    KEY `idx_task_id` (`task_id`),
    KEY `idx_trade_no` (`trade_no`),
    KEY `idx_out_trade_no` (`out_trade_no`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'支付宝账单流水'</span>;

<span class="hljs-comment">-- 3. 渠道流水表（微信）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `channel_bill_wechat` (
    `id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    `task_id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'任务ID'</span>,
    `transaction_id` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'微信支付订单号'</span>,
    `out_trade_no` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) COMMENT <span class="hljs-string">'商户订单号'</span>,
    `trade_type` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) COMMENT <span class="hljs-string">'交易类型'</span>,
    `trade_state` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) COMMENT <span class="hljs-string">'交易状态'</span>,
    `amount` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'交易金额'</span>,
    `fee` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'手续费'</span>,
    `trade_time` DATETIME COMMENT <span class="hljs-string">'交易时间'</span>,
    `body` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">256</span>) COMMENT <span class="hljs-string">'商品描述'</span>,
    `recon_status` TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'对账状态'</span>,
    `create_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    KEY `idx_task_id` (`task_id`),
    KEY `idx_transaction_id` (`transaction_id`),
    KEY `idx_out_trade_no` (`out_trade_no`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'微信账单流水'</span>;

<span class="hljs-comment">-- 4. 渠道流水表（银行）</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `channel_bill_bank` (
    `id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    `task_id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'任务ID'</span>,
    `bank_serial_no` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'银行流水号'</span>,
    `merchant_order_no` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) COMMENT <span class="hljs-string">'商户订单号'</span>,
    `trans_type` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) COMMENT <span class="hljs-string">'交易类型：DEBIT/CREDIT'</span>,
    `trans_status` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) COMMENT <span class="hljs-string">'交易状态'</span>,
    `amount` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'交易金额'</span>,
    `fee` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'手续费'</span>,
    `trans_time` DATETIME COMMENT <span class="hljs-string">'交易时间'</span>,
    `remark` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">256</span>) COMMENT <span class="hljs-string">'备注'</span>,
    `account_no` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>) COMMENT <span class="hljs-string">'账户号'</span>,
    `account_name` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) COMMENT <span class="hljs-string">'账户名'</span>,
    `recon_status` TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'对账状态'</span>,
    `create_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    KEY `idx_task_id` (`task_id`),
    KEY `idx_bank_serial_no` (`bank_serial_no`),
    KEY `idx_merchant_order_no` (`merchant_order_no`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'银行账单流水'</span>;

<span class="hljs-comment">-- 5. 自定义渠道流水表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `channel_bill_custom` (
    `id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    `task_id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'任务ID'</span>,
    `channel_code` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'渠道编码'</span>,
    `channel_trade_no` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'渠道交易号'</span>,
    `merchant_order_no` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) COMMENT <span class="hljs-string">'商户订单号'</span>,
    `trade_type` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) COMMENT <span class="hljs-string">'交易类型'</span>,
    `trade_status` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) COMMENT <span class="hljs-string">'交易状态'</span>,
    `amount` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'交易金额'</span>,
    `fee` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'手续费'</span>,
    `trade_time` DATETIME COMMENT <span class="hljs-string">'交易时间'</span>,
    `ext_data` JSON COMMENT <span class="hljs-string">'扩展数据'</span>,
    `recon_status` TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'对账状态'</span>,
    `create_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    KEY `idx_task_id` (`task_id`),
    KEY `idx_channel_trade_no` (`channel_code`, `channel_trade_no`),
    KEY `idx_merchant_order_no` (`merchant_order_no`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'自定义渠道流水'</span>;

<span class="hljs-comment">-- 6. 本地支付流水表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `local_payment_record` (
    `id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    `order_no` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'商户订单号'</span>,
    `channel_type` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'支付渠道'</span>,
    `channel_trade_no` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) COMMENT <span class="hljs-string">'渠道交易号'</span>,
    `pay_type` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) COMMENT <span class="hljs-string">'支付类型'</span>,
    `pay_status` TINYINT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'支付状态：0-待支付,1-支付成功,2-支付失败,3-已退款'</span>,
    `amount` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'支付金额'</span>,
    `fee` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'手续费'</span>,
    `pay_time` DATETIME COMMENT <span class="hljs-string">'支付时间'</span>,
    `user_id` <span class="hljs-type">BIGINT</span> COMMENT <span class="hljs-string">'用户ID'</span>,
    `product_name` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">256</span>) COMMENT <span class="hljs-string">'商品名称'</span>,
    `recon_status` TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'对账状态：0-待对账,1-已对账,2-差异'</span>,
    `recon_time` DATETIME COMMENT <span class="hljs-string">'对账时间'</span>,
    `create_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    `update_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    <span class="hljs-keyword">UNIQUE</span> KEY `uk_order_no` (`order_no`),
    KEY `idx_channel_trade_no` (`channel_type`, `channel_trade_no`),
    KEY `idx_pay_time` (`pay_time`),
    KEY `idx_recon_status` (`recon_status`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'本地支付流水表'</span>;

<span class="hljs-comment">-- 7. 对账结果表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `recon_result` (
    `id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    `task_id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'任务ID'</span>,
    `order_no` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) COMMENT <span class="hljs-string">'商户订单号'</span>,
    `channel_trade_no` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) COMMENT <span class="hljs-string">'渠道交易号'</span>,
    `result_type` TINYINT <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'结果类型：1-匹配成功,2-本地多,3-渠道多,4-金额不一致,5-状态不一致'</span>,
    `local_amount` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>) COMMENT <span class="hljs-string">'本地金额'</span>,
    `channel_amount` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>) COMMENT <span class="hljs-string">'渠道金额'</span>,
    `diff_amount` <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">12</span>,<span class="hljs-number">2</span>) COMMENT <span class="hljs-string">'差异金额'</span>,
    `local_status` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) COMMENT <span class="hljs-string">'本地状态'</span>,
    `channel_status` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) COMMENT <span class="hljs-string">'渠道状态'</span>,
    `handle_status` TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span> COMMENT <span class="hljs-string">'处理状态：0-待处理,1-已处理,2-忽略'</span>,
    `handle_remark` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">500</span>) COMMENT <span class="hljs-string">'处理备注'</span>,
    `handler` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) COMMENT <span class="hljs-string">'处理人'</span>,
    `handle_time` DATETIME COMMENT <span class="hljs-string">'处理时间'</span>,
    `create_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    KEY `idx_task_id` (`task_id`),
    KEY `idx_order_no` (`order_no`),
    KEY `idx_result_type` (`result_type`),
    KEY `idx_handle_status` (`handle_status`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'对账结果表'</span>;

<span class="hljs-comment">-- 8. 渠道配置表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `recon_channel_config` (
    `id` <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
    `channel_code` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">32</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'渠道编码'</span>,
    `channel_name` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">'渠道名称'</span>,
    `file_type` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) COMMENT <span class="hljs-string">'文件类型：CSV/EXCEL/TXT'</span>,
    `file_encoding` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">20</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-string">'UTF-8'</span> COMMENT <span class="hljs-string">'文件编码'</span>,
    `field_mapping` JSON COMMENT <span class="hljs-string">'字段映射配置'</span>,
    `parser_class` <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">256</span>) COMMENT <span class="hljs-string">'解析器类名'</span>,
    `status` TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">1</span> COMMENT <span class="hljs-string">'状态：0-禁用,1-启用'</span>,
    `create_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    `update_time` DATETIME <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span> <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    <span class="hljs-keyword">UNIQUE</span> KEY `uk_channel_code` (`channel_code`)
) ENGINE<span class="hljs-operator">=</span>InnoDB <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb4 COMMENT<span class="hljs-operator">=</span><span class="hljs-string">'渠道配置表'</span>;
</code></pre>
<h4 data-id="heading-11">3.2 E-R 关系图</h4>
<pre><code class="hljs language-lua" lang="lua">+<span class="hljs-comment">------------------------------------------------------------------+</span>
|                          E-R 关系图                               |
+<span class="hljs-comment">------------------------------------------------------------------+</span>
|                                                                   |
|   +<span class="hljs-comment">-------------+       1:N       +-------------------+           |</span>
|   | recon_task  |<span class="hljs-comment">----------------&gt;| channel_bill_xxx |           |</span>
|   +<span class="hljs-comment">-------------+                 +-------------------+           |</span>
|         |                                                         |
|         | <span class="hljs-number">1</span>:N                                                     |
|         v                                                         |
|   +<span class="hljs-comment">-------------+                 +---------------------+         |</span>
|   | recon_result|&lt;<span class="hljs-comment">---------------&gt;| local_payment_record|         |</span>
|   +<span class="hljs-comment">-------------+      关联       +---------------------+         |</span>
|                                                                   |
|   +<span class="hljs-comment">---------------------+                                         |</span>
|   | recon_channel_config|  渠道配置（独立）                        |
|   +<span class="hljs-comment">---------------------+                                         |</span>
|                                                                   |
+<span class="hljs-comment">------------------------------------------------------------------+</span>
</code></pre>
<hr/>
<h3 data-id="heading-12">四、核心代码实现</h3>
<h4 data-id="heading-13">4.1 基础实体类</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 渠道类型枚举
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ChannelType</span> {
    ALIPAY(<span class="hljs-string">"ALIPAY"</span>, <span class="hljs-string">"支付宝"</span>),
    WECHAT(<span class="hljs-string">"WECHAT"</span>, <span class="hljs-string">"微信支付"</span>),
    BANK(<span class="hljs-string">"BANK"</span>, <span class="hljs-string">"银行"</span>),
    CUSTOM(<span class="hljs-string">"CUSTOM"</span>, <span class="hljs-string">"自定义渠道"</span>);

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String code;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String desc;

    ChannelType(String code, String desc) {
        <span class="hljs-built_in">this</span>.code = code;
        <span class="hljs-built_in">this</span>.desc = desc;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getCode</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> code; }
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDesc</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> desc; }
}

<span class="hljs-comment">/**
 * 对账结果类型枚举
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">ReconResultType</span> {
    MATCHED(<span class="hljs-number">1</span>, <span class="hljs-string">"匹配成功"</span>),
    LOCAL_MORE(<span class="hljs-number">2</span>, <span class="hljs-string">"本地多（长款）"</span>),
    CHANNEL_MORE(<span class="hljs-number">3</span>, <span class="hljs-string">"渠道多（短款）"</span>),
    AMOUNT_MISMATCH(<span class="hljs-number">4</span>, <span class="hljs-string">"金额不一致"</span>),
    STATUS_MISMATCH(<span class="hljs-number">5</span>, <span class="hljs-string">"状态不一致"</span>);

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> code;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String desc;

    ReconResultType(<span class="hljs-type">int</span> code, String desc) {
        <span class="hljs-built_in">this</span>.code = code;
        <span class="hljs-built_in">this</span>.desc = desc;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getCode</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> code; }
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDesc</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> desc; }
}

<span class="hljs-comment">/**
 * 对账任务状态枚举
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">TaskStatus</span> {
    PENDING(<span class="hljs-number">0</span>, <span class="hljs-string">"待处理"</span>),
    PROCESSING(<span class="hljs-number">1</span>, <span class="hljs-string">"处理中"</span>),
    COMPLETED(<span class="hljs-number">2</span>, <span class="hljs-string">"已完成"</span>),
    FAILED(<span class="hljs-number">3</span>, <span class="hljs-string">"失败"</span>);

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> code;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String desc;

    TaskStatus(<span class="hljs-type">int</span> code, String desc) {
        <span class="hljs-built_in">this</span>.code = code;
        <span class="hljs-built_in">this</span>.desc = desc;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getCode</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> code; }
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDesc</span><span class="hljs-params">()</span> { <span class="hljs-keyword">return</span> desc; }
}
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 对账任务实体
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@TableName("recon_task")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReconTask</span> {
    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String taskNo;
    <span class="hljs-keyword">private</span> String channelType;
    <span class="hljs-keyword">private</span> LocalDate reconDate;
    <span class="hljs-keyword">private</span> Integer status;
    <span class="hljs-keyword">private</span> Integer totalCount;
    <span class="hljs-keyword">private</span> Integer successCount;
    <span class="hljs-keyword">private</span> Integer failCount;
    <span class="hljs-keyword">private</span> Integer diffCount;
    <span class="hljs-keyword">private</span> String filePath;
    <span class="hljs-keyword">private</span> String errorMsg;
    <span class="hljs-keyword">private</span> LocalDateTime startTime;
    <span class="hljs-keyword">private</span> LocalDateTime endTime;
    <span class="hljs-keyword">private</span> LocalDateTime createTime;
    <span class="hljs-keyword">private</span> LocalDateTime updateTime;
}

<span class="hljs-comment">/**
 * 统一渠道账单数据模型
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChannelBillDTO</span> {
    <span class="hljs-keyword">private</span> String channelTradeNo;      <span class="hljs-comment">// 渠道交易号</span>
    <span class="hljs-keyword">private</span> String merchantOrderNo;     <span class="hljs-comment">// 商户订单号</span>
    <span class="hljs-keyword">private</span> String tradeType;           <span class="hljs-comment">// 交易类型</span>
    <span class="hljs-keyword">private</span> String tradeStatus;         <span class="hljs-comment">// 交易状态</span>
    <span class="hljs-keyword">private</span> BigDecimal amount;          <span class="hljs-comment">// 交易金额</span>
    <span class="hljs-keyword">private</span> BigDecimal fee;             <span class="hljs-comment">// 手续费</span>
    <span class="hljs-keyword">private</span> LocalDateTime tradeTime;    <span class="hljs-comment">// 交易时间</span>
    <span class="hljs-keyword">private</span> String remark;              <span class="hljs-comment">// 备注</span>
    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; extData;<span class="hljs-comment">// 扩展数据</span>
}

<span class="hljs-comment">/**
 * 本地支付记录实体
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@TableName("local_payment_record")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LocalPaymentRecord</span> {
    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String orderNo;
    <span class="hljs-keyword">private</span> String channelType;
    <span class="hljs-keyword">private</span> String channelTradeNo;
    <span class="hljs-keyword">private</span> String payType;
    <span class="hljs-keyword">private</span> Integer payStatus;
    <span class="hljs-keyword">private</span> BigDecimal amount;
    <span class="hljs-keyword">private</span> BigDecimal fee;
    <span class="hljs-keyword">private</span> LocalDateTime payTime;
    <span class="hljs-keyword">private</span> Long userId;
    <span class="hljs-keyword">private</span> String productName;
    <span class="hljs-keyword">private</span> Integer reconStatus;
    <span class="hljs-keyword">private</span> LocalDateTime reconTime;
    <span class="hljs-keyword">private</span> LocalDateTime createTime;
    <span class="hljs-keyword">private</span> LocalDateTime updateTime;
}

<span class="hljs-comment">/**
 * 对账结果实体
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@TableName("recon_result")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReconResult</span> {
    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> Long taskId;
    <span class="hljs-keyword">private</span> String orderNo;
    <span class="hljs-keyword">private</span> String channelTradeNo;
    <span class="hljs-keyword">private</span> Integer resultType;
    <span class="hljs-keyword">private</span> BigDecimal localAmount;
    <span class="hljs-keyword">private</span> BigDecimal channelAmount;
    <span class="hljs-keyword">private</span> BigDecimal diffAmount;
    <span class="hljs-keyword">private</span> String localStatus;
    <span class="hljs-keyword">private</span> String channelStatus;
    <span class="hljs-keyword">private</span> Integer handleStatus;
    <span class="hljs-keyword">private</span> String handleRemark;
    <span class="hljs-keyword">private</span> String handler;
    <span class="hljs-keyword">private</span> LocalDateTime handleTime;
    <span class="hljs-keyword">private</span> LocalDateTime createTime;
}
</code></pre>
<h4 data-id="heading-14">4.2 文件解析器</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 账单解析器接口
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BillParser</span> {

    <span class="hljs-comment">/**
     * 获取支持的渠道类型
     */</span>
    ChannelType <span class="hljs-title function_">getChannelType</span><span class="hljs-params">()</span>;

    <span class="hljs-comment">/**
     * 解析账单文件
     */</span>
    List&lt;ChannelBillDTO&gt; <span class="hljs-title function_">parse</span><span class="hljs-params">(InputStream inputStream, String fileName)</span> <span class="hljs-keyword">throws</span> Exception;

    <span class="hljs-comment">/**
     * 是否支持该文件
     */</span>
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">supports</span><span class="hljs-params">(String fileName)</span>;
}

<span class="hljs-comment">/**
 * 支付宝账单解析器
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AlipayBillParser</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BillParser</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> ChannelType <span class="hljs-title function_">getChannelType</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> ChannelType.ALIPAY;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">supports</span><span class="hljs-params">(String fileName)</span> {
        <span class="hljs-keyword">return</span> fileName != <span class="hljs-literal">null</span> &amp;&amp; fileName.contains(<span class="hljs-string">"alipay"</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;ChannelBillDTO&gt; <span class="hljs-title function_">parse</span><span class="hljs-params">(InputStream inputStream, String fileName)</span> <span class="hljs-keyword">throws</span> Exception {
        List&lt;ChannelBillDTO&gt; billList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-comment">// 支付宝账单通常是 CSV 格式，GBK 编码</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(inputStream, <span class="hljs-string">"GBK"</span>))) {

            String line;
            <span class="hljs-type">boolean</span> <span class="hljs-variable">isDataSection</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
            <span class="hljs-type">int</span> <span class="hljs-variable">lineNum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

            <span class="hljs-keyword">while</span> ((line = reader.readLine()) != <span class="hljs-literal">null</span>) {
                lineNum++;

                <span class="hljs-comment">// 跳过账单头部信息（支付宝账单前几行是汇总信息）</span>
                <span class="hljs-keyword">if</span> (line.startsWith(<span class="hljs-string">"支付宝交易号"</span>)) {
                    isDataSection = <span class="hljs-literal">true</span>;
                    <span class="hljs-keyword">continue</span>;
                }

                <span class="hljs-comment">// 跳过汇总行</span>
                <span class="hljs-keyword">if</span> (line.startsWith(<span class="hljs-string">"#"</span>) || line.trim().isEmpty()) {
                    <span class="hljs-keyword">continue</span>;
                }

                <span class="hljs-keyword">if</span> (!isDataSection) {
                    <span class="hljs-keyword">continue</span>;
                }

                <span class="hljs-keyword">try</span> {
                    <span class="hljs-type">ChannelBillDTO</span> <span class="hljs-variable">bill</span> <span class="hljs-operator">=</span> parseLine(line);
                    <span class="hljs-keyword">if</span> (bill != <span class="hljs-literal">null</span>) {
                        billList.add(bill);
                    }
                } <span class="hljs-keyword">catch</span> (Exception e) {
                    log.warn(<span class="hljs-string">"解析支付宝账单第{}行失败: {}"</span>, lineNum, e.getMessage());
                }
            }
        }

        log.info(<span class="hljs-string">"支付宝账单解析完成，共{}条记录"</span>, billList.size());
        <span class="hljs-keyword">return</span> billList;
    }

    <span class="hljs-keyword">private</span> ChannelBillDTO <span class="hljs-title function_">parseLine</span><span class="hljs-params">(String line)</span> {
        <span class="hljs-comment">// 支付宝账单字段：支付宝交易号,商户订单号,交易类型,交易状态,金额,手续费,交易时间...</span>
        String[] fields = line.split(<span class="hljs-string">","</span>);
        <span class="hljs-keyword">if</span> (fields.length &lt; <span class="hljs-number">7</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }

        <span class="hljs-type">ChannelBillDTO</span> <span class="hljs-variable">bill</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelBillDTO</span>();
        bill.setChannelTradeNo(fields[<span class="hljs-number">0</span>].trim());
        bill.setMerchantOrderNo(fields[<span class="hljs-number">1</span>].trim());
        bill.setTradeType(fields[<span class="hljs-number">2</span>].trim());
        bill.setTradeStatus(fields[<span class="hljs-number">3</span>].trim());
        bill.setAmount(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(fields[<span class="hljs-number">4</span>].trim()));
        bill.setFee(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(fields[<span class="hljs-number">5</span>].trim()));

        <span class="hljs-comment">// 解析时间</span>
        <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">formatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>);
        bill.setTradeTime(LocalDateTime.parse(fields[<span class="hljs-number">6</span>].trim(), formatter));

        <span class="hljs-keyword">return</span> bill;
    }
}

<span class="hljs-comment">/**
 * 微信账单解析器
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WechatBillParser</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BillParser</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> ChannelType <span class="hljs-title function_">getChannelType</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> ChannelType.WECHAT;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">supports</span><span class="hljs-params">(String fileName)</span> {
        <span class="hljs-keyword">return</span> fileName != <span class="hljs-literal">null</span> &amp;&amp; fileName.contains(<span class="hljs-string">"wechat"</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;ChannelBillDTO&gt; <span class="hljs-title function_">parse</span><span class="hljs-params">(InputStream inputStream, String fileName)</span> <span class="hljs-keyword">throws</span> Exception {
        List&lt;ChannelBillDTO&gt; billList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-comment">// 微信账单是 CSV 格式，UTF-8 编码</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(inputStream, StandardCharsets.UTF_8))) {

            String line;
            <span class="hljs-type">boolean</span> <span class="hljs-variable">isDataSection</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
            <span class="hljs-type">int</span> <span class="hljs-variable">lineNum</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

            <span class="hljs-keyword">while</span> ((line = reader.readLine()) != <span class="hljs-literal">null</span>) {
                lineNum++;

                <span class="hljs-comment">// 微信账单以"交易时间"开头的是表头</span>
                <span class="hljs-keyword">if</span> (line.startsWith(<span class="hljs-string">"交易时间"</span>)) {
                    isDataSection = <span class="hljs-literal">true</span>;
                    <span class="hljs-keyword">continue</span>;
                }

                <span class="hljs-comment">// 跳过汇总部分</span>
                <span class="hljs-keyword">if</span> (line.startsWith(<span class="hljs-string">"总交易单数"</span>) || line.trim().isEmpty()) {
                    isDataSection = <span class="hljs-literal">false</span>;
                    <span class="hljs-keyword">continue</span>;
                }

                <span class="hljs-keyword">if</span> (!isDataSection) {
                    <span class="hljs-keyword">continue</span>;
                }

                <span class="hljs-keyword">try</span> {
                    <span class="hljs-type">ChannelBillDTO</span> <span class="hljs-variable">bill</span> <span class="hljs-operator">=</span> parseLine(line);
                    <span class="hljs-keyword">if</span> (bill != <span class="hljs-literal">null</span>) {
                        billList.add(bill);
                    }
                } <span class="hljs-keyword">catch</span> (Exception e) {
                    log.warn(<span class="hljs-string">"解析微信账单第{}行失败: {}"</span>, lineNum, e.getMessage());
                }
            }
        }

        log.info(<span class="hljs-string">"微信账单解析完成，共{}条记录"</span>, billList.size());
        <span class="hljs-keyword">return</span> billList;
    }

    <span class="hljs-keyword">private</span> ChannelBillDTO <span class="hljs-title function_">parseLine</span><span class="hljs-params">(String line)</span> {
        <span class="hljs-comment">// 微信账单字段：交易时间,公众账号ID,商户号,子商户号,设备号,微信订单号,商户订单号,用户标识,交易类型,交易状态,付款银行,货币种类,总金额,企业红包金额,微信退款单号,商户退款单号,退款金额,企业红包退款金额,退款类型,退款状态,商品名称,商户数据包,手续费,费率</span>
        String[] fields = line.split(<span class="hljs-string">","</span>);
        <span class="hljs-keyword">if</span> (fields.length &lt; <span class="hljs-number">15</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
        }

        <span class="hljs-type">ChannelBillDTO</span> <span class="hljs-variable">bill</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelBillDTO</span>();

        <span class="hljs-comment">// 去除反引号（微信账单中数字字段带反引号）</span>
        bill.setChannelTradeNo(cleanField(fields[<span class="hljs-number">5</span>]));
        bill.setMerchantOrderNo(cleanField(fields[<span class="hljs-number">6</span>]));
        bill.setTradeType(cleanField(fields[<span class="hljs-number">8</span>]));
        bill.setTradeStatus(cleanField(fields[<span class="hljs-number">9</span>]));

        <span class="hljs-comment">// 金额字段需要去除 ¥ 符号</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">amountStr</span> <span class="hljs-operator">=</span> cleanField(fields[<span class="hljs-number">12</span>]).replace(<span class="hljs-string">"¥"</span>, <span class="hljs-string">""</span>);
        bill.setAmount(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(amountStr));

        <span class="hljs-comment">// 手续费</span>
        <span class="hljs-keyword">if</span> (fields.length &gt; <span class="hljs-number">22</span>) {
            <span class="hljs-type">String</span> <span class="hljs-variable">feeStr</span> <span class="hljs-operator">=</span> cleanField(fields[<span class="hljs-number">22</span>]).replace(<span class="hljs-string">"¥"</span>, <span class="hljs-string">""</span>);
            bill.setFee(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(feeStr));
        }

        <span class="hljs-comment">// 解析时间</span>
        <span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">formatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>);
        bill.setTradeTime(LocalDateTime.parse(cleanField(fields[<span class="hljs-number">0</span>]), formatter));

        <span class="hljs-keyword">return</span> bill;
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">cleanField</span><span class="hljs-params">(String field)</span> {
        <span class="hljs-keyword">return</span> field.replace(<span class="hljs-string">"`"</span>, <span class="hljs-string">""</span>).trim();
    }
}

<span class="hljs-comment">/**
 * 银行账单解析器（Excel 格式）
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BankBillParser</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BillParser</span> {

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> ChannelType <span class="hljs-title function_">getChannelType</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> ChannelType.BANK;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">supports</span><span class="hljs-params">(String fileName)</span> {
        <span class="hljs-keyword">return</span> fileName != <span class="hljs-literal">null</span> &amp;&amp;
                (fileName.endsWith(<span class="hljs-string">".xlsx"</span>) || fileName.endsWith(<span class="hljs-string">".xls"</span>));
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;ChannelBillDTO&gt; <span class="hljs-title function_">parse</span><span class="hljs-params">(InputStream inputStream, String fileName)</span> <span class="hljs-keyword">throws</span> Exception {
        List&lt;ChannelBillDTO&gt; billList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-comment">// 使用 EasyExcel 解析</span>
        EasyExcel.read(inputStream, BankBillExcelDTO.class, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReadListener</span>&lt;BankBillExcelDTO&gt;() {

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invoke</span><span class="hljs-params">(BankBillExcelDTO data, AnalysisContext context)</span> {
                <span class="hljs-type">ChannelBillDTO</span> <span class="hljs-variable">bill</span> <span class="hljs-operator">=</span> convertToChannelBill(data);
                <span class="hljs-keyword">if</span> (bill != <span class="hljs-literal">null</span>) {
                    billList.add(bill);
                }
            }

            <span class="hljs-meta">@Override</span>
            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">doAfterAllAnalysed</span><span class="hljs-params">(AnalysisContext context)</span> {
                log.info(<span class="hljs-string">"银行账单解析完成，共{}条记录"</span>, billList.size());
            }
        }).sheet().doRead();

        <span class="hljs-keyword">return</span> billList;
    }

    <span class="hljs-keyword">private</span> ChannelBillDTO <span class="hljs-title function_">convertToChannelBill</span><span class="hljs-params">(BankBillExcelDTO excelDTO)</span> {
        <span class="hljs-type">ChannelBillDTO</span> <span class="hljs-variable">bill</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelBillDTO</span>();
        bill.setChannelTradeNo(excelDTO.getBankSerialNo());
        bill.setMerchantOrderNo(excelDTO.getMerchantOrderNo());
        bill.setTradeType(excelDTO.getTransType());
        bill.setTradeStatus(excelDTO.getTransStatus());
        bill.setAmount(excelDTO.getAmount());
        bill.setFee(excelDTO.getFee());
        bill.setTradeTime(excelDTO.getTransTime());
        bill.setRemark(excelDTO.getRemark());
        <span class="hljs-keyword">return</span> bill;
    }

    <span class="hljs-comment">/**
     * 银行账单 Excel DTO
     */</span>
    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BankBillExcelDTO</span> {
        <span class="hljs-meta">@ExcelProperty("流水号")</span>
        <span class="hljs-keyword">private</span> String bankSerialNo;

        <span class="hljs-meta">@ExcelProperty("商户订单号")</span>
        <span class="hljs-keyword">private</span> String merchantOrderNo;

        <span class="hljs-meta">@ExcelProperty("交易类型")</span>
        <span class="hljs-keyword">private</span> String transType;

        <span class="hljs-meta">@ExcelProperty("交易状态")</span>
        <span class="hljs-keyword">private</span> String transStatus;

        <span class="hljs-meta">@ExcelProperty("交易金额")</span>
        <span class="hljs-keyword">private</span> BigDecimal amount;

        <span class="hljs-meta">@ExcelProperty("手续费")</span>
        <span class="hljs-keyword">private</span> BigDecimal fee;

        <span class="hljs-meta">@ExcelProperty("交易时间")</span>
        <span class="hljs-keyword">private</span> LocalDateTime transTime;

        <span class="hljs-meta">@ExcelProperty("备注")</span>
        <span class="hljs-keyword">private</span> String remark;
    }
}

<span class="hljs-comment">/**
 * 自定义渠道解析器工厂
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CustomBillParserFactory</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ReconChannelConfigMapper channelConfigMapper;

    <span class="hljs-comment">/**
     * 根据渠道配置动态解析账单
     */</span>
    <span class="hljs-keyword">public</span> List&lt;ChannelBillDTO&gt; <span class="hljs-title function_">parse</span><span class="hljs-params">(String channelCode, InputStream inputStream)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">ReconChannelConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> channelConfigMapper.selectByChannelCode(channelCode);
        <span class="hljs-keyword">if</span> (config == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"渠道配置不存在: "</span> + channelCode);
        }

        <span class="hljs-comment">// 解析字段映射配置</span>
        Map&lt;String, String&gt; fieldMapping = JSON.parseObject(
                config.getFieldMapping(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeReference</span>&lt;Map&lt;String, String&gt;&gt;() {});

        List&lt;ChannelBillDTO&gt; billList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-comment">// 根据文件类型解析</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"CSV"</span>.equalsIgnoreCase(config.getFileType())) {
            billList = parseCsv(inputStream, config.getFileEncoding(), fieldMapping);
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-string">"EXCEL"</span>.equalsIgnoreCase(config.getFileType())) {
            billList = parseExcel(inputStream, fieldMapping);
        }

        <span class="hljs-keyword">return</span> billList;
    }

    <span class="hljs-keyword">private</span> List&lt;ChannelBillDTO&gt; <span class="hljs-title function_">parseCsv</span><span class="hljs-params">(InputStream inputStream, String encoding,
                                           Map&lt;String, String&gt; fieldMapping)</span> <span class="hljs-keyword">throws</span> Exception {
        List&lt;ChannelBillDTO&gt; billList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(inputStream, encoding))) {

            <span class="hljs-comment">// 读取表头</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">headerLine</span> <span class="hljs-operator">=</span> reader.readLine();
            String[] headers = headerLine.split(<span class="hljs-string">","</span>);

            <span class="hljs-comment">// 构建列索引映射</span>
            Map&lt;String, Integer&gt; columnIndex = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; headers.length; i++) {
                columnIndex.put(headers[i].trim(), i);
            }

            String line;
            <span class="hljs-keyword">while</span> ((line = reader.readLine()) != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">if</span> (line.trim().isEmpty()) <span class="hljs-keyword">continue</span>;

                String[] fields = line.split(<span class="hljs-string">","</span>);
                <span class="hljs-type">ChannelBillDTO</span> <span class="hljs-variable">bill</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChannelBillDTO</span>();

                <span class="hljs-comment">// 根据字段映射配置填充数据</span>
                <span class="hljs-keyword">for</span> (Map.Entry&lt;String, String&gt; entry : fieldMapping.entrySet()) {
                    <span class="hljs-type">String</span> <span class="hljs-variable">targetField</span> <span class="hljs-operator">=</span> entry.getKey();  <span class="hljs-comment">// ChannelBillDTO 字段名</span>
                    <span class="hljs-type">String</span> <span class="hljs-variable">sourceColumn</span> <span class="hljs-operator">=</span> entry.getValue(); <span class="hljs-comment">// 源文件列名</span>

                    <span class="hljs-type">Integer</span> <span class="hljs-variable">idx</span> <span class="hljs-operator">=</span> columnIndex.get(sourceColumn);
                    <span class="hljs-keyword">if</span> (idx != <span class="hljs-literal">null</span> &amp;&amp; idx &lt; fields.length) {
                        setFieldValue(bill, targetField, fields[idx].trim());
                    }
                }

                billList.add(bill);
            }
        }

        <span class="hljs-keyword">return</span> billList;
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFieldValue</span><span class="hljs-params">(ChannelBillDTO bill, String fieldName, String value)</span> {
        <span class="hljs-keyword">switch</span> (fieldName) {
            <span class="hljs-keyword">case</span> <span class="hljs-string">"channelTradeNo"</span>:
                bill.setChannelTradeNo(value);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">"merchantOrderNo"</span>:
                bill.setMerchantOrderNo(value);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">"tradeType"</span>:
                bill.setTradeType(value);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">"tradeStatus"</span>:
                bill.setTradeStatus(value);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">"amount"</span>:
                bill.setAmount(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(value));
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">"fee"</span>:
                bill.setFee(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(value));
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> <span class="hljs-string">"tradeTime"</span>:
                bill.setTradeTime(LocalDateTime.parse(value,
                        DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>)));
                <span class="hljs-keyword">break</span>;
        }
    }

    <span class="hljs-keyword">private</span> List&lt;ChannelBillDTO&gt; <span class="hljs-title function_">parseExcel</span><span class="hljs-params">(InputStream inputStream,
                                             Map&lt;String, String&gt; fieldMapping)</span> {
        <span class="hljs-comment">// Excel 解析逻辑，类似 CSV</span>
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();
    }
}
</code></pre>
<h4 data-id="heading-15">4.3 对账引擎核心</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 对账引擎接口
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">ReconEngine</span> {

    <span class="hljs-comment">/**
     * 执行对账
     */</span>
    ReconResult <span class="hljs-title function_">reconcile</span><span class="hljs-params">(ChannelBillDTO channelBill, LocalPaymentRecord localRecord)</span>;

    <span class="hljs-comment">/**
     * 批量对账
     */</span>
    List&lt;ReconResult&gt; <span class="hljs-title function_">batchReconcile</span><span class="hljs-params">(List&lt;ChannelBillDTO&gt; channelBills,
                                      List&lt;LocalPaymentRecord&gt; localRecords)</span>;
}

<span class="hljs-comment">/**
 * 对账引擎实现
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DefaultReconEngine</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">ReconEngine</span> {

    <span class="hljs-comment">// 金额容差（分）</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">AMOUNT_TOLERANCE</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.01"</span>);

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> ReconResult <span class="hljs-title function_">reconcile</span><span class="hljs-params">(ChannelBillDTO channelBill, LocalPaymentRecord localRecord)</span> {
        <span class="hljs-type">ReconResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReconResult</span>();
        result.setChannelTradeNo(channelBill.getChannelTradeNo());
        result.setChannelAmount(channelBill.getAmount());
        result.setChannelStatus(channelBill.getTradeStatus());

        <span class="hljs-keyword">if</span> (localRecord != <span class="hljs-literal">null</span>) {
            result.setOrderNo(localRecord.getOrderNo());
            result.setLocalAmount(localRecord.getAmount());
            result.setLocalStatus(String.valueOf(localRecord.getPayStatus()));

            <span class="hljs-comment">// 比对金额</span>
            <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">diff</span> <span class="hljs-operator">=</span> channelBill.getAmount()
                    .subtract(localRecord.getAmount()).abs();

            <span class="hljs-keyword">if</span> (diff.compareTo(AMOUNT_TOLERANCE) &gt; <span class="hljs-number">0</span>) {
                <span class="hljs-comment">// 金额不一致</span>
                result.setResultType(ReconResultType.AMOUNT_MISMATCH.getCode());
                result.setDiffAmount(diff);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!isStatusMatched(channelBill.getTradeStatus(),
                    localRecord.getPayStatus())) {
                <span class="hljs-comment">// 状态不一致</span>
                result.setResultType(ReconResultType.STATUS_MISMATCH.getCode());
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-comment">// 匹配成功</span>
                result.setResultType(ReconResultType.MATCHED.getCode());
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 渠道有，本地无（短款）</span>
            result.setResultType(ReconResultType.CHANNEL_MORE.getCode());
        }

        <span class="hljs-keyword">return</span> result;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> List&lt;ReconResult&gt; <span class="hljs-title function_">batchReconcile</span><span class="hljs-params">(List&lt;ChannelBillDTO&gt; channelBills,
                                             List&lt;LocalPaymentRecord&gt; localRecords)</span> {
        List&lt;ReconResult&gt; results = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-comment">// 构建本地记录索引（按商户订单号）</span>
        Map&lt;String, LocalPaymentRecord&gt; localRecordMap = localRecords.stream()
                .collect(Collectors.toMap(
                        LocalPaymentRecord::getOrderNo,
                        r -&gt; r,
                        (r1, r2) -&gt; r1
                ));

        <span class="hljs-comment">// 构建渠道记录索引</span>
        Map&lt;String, ChannelBillDTO&gt; channelBillMap = channelBills.stream()
                .collect(Collectors.toMap(
                        ChannelBillDTO::getMerchantOrderNo,
                        b -&gt; b,
                        (b1, b2) -&gt; b1
                ));

        Set&lt;String&gt; matchedOrderNos = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashSet</span>&lt;&gt;();

        <span class="hljs-comment">// 遍历渠道账单进行匹配</span>
        <span class="hljs-keyword">for</span> (ChannelBillDTO channelBill : channelBills) {
            <span class="hljs-type">String</span> <span class="hljs-variable">orderNo</span> <span class="hljs-operator">=</span> channelBill.getMerchantOrderNo();
            <span class="hljs-type">LocalPaymentRecord</span> <span class="hljs-variable">localRecord</span> <span class="hljs-operator">=</span> localRecordMap.get(orderNo);

            <span class="hljs-type">ReconResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> reconcile(channelBill, localRecord);
            results.add(result);

            <span class="hljs-keyword">if</span> (localRecord != <span class="hljs-literal">null</span>) {
                matchedOrderNos.add(orderNo);
            }
        }

        <span class="hljs-comment">// 检查本地多的记录（长款）</span>
        <span class="hljs-keyword">for</span> (LocalPaymentRecord localRecord : localRecords) {
            <span class="hljs-keyword">if</span> (!matchedOrderNos.contains(localRecord.getOrderNo())) {
                <span class="hljs-type">ReconResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReconResult</span>();
                result.setOrderNo(localRecord.getOrderNo());
                result.setLocalAmount(localRecord.getAmount());
                result.setLocalStatus(String.valueOf(localRecord.getPayStatus()));
                result.setResultType(ReconResultType.LOCAL_MORE.getCode());
                results.add(result);
            }
        }

        <span class="hljs-keyword">return</span> results;
    }

    <span class="hljs-comment">/**
     * 状态匹配判断
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isStatusMatched</span><span class="hljs-params">(String channelStatus, Integer localStatus)</span> {
        <span class="hljs-comment">// 渠道状态映射到本地状态</span>
        <span class="hljs-comment">// 支付宝：TRADE_SUCCESS -&gt; 1</span>
        <span class="hljs-comment">// 微信：SUCCESS -&gt; 1</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"TRADE_SUCCESS"</span>.equals(channelStatus) || <span class="hljs-string">"SUCCESS"</span>.equals(channelStatus)) {
            <span class="hljs-keyword">return</span> localStatus == <span class="hljs-number">1</span>;  <span class="hljs-comment">// 支付成功</span>
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"TRADE_CLOSED"</span>.equals(channelStatus) || <span class="hljs-string">"CLOSED"</span>.equals(channelStatus)) {
            <span class="hljs-keyword">return</span> localStatus == <span class="hljs-number">2</span>;  <span class="hljs-comment">// 支付失败/关闭</span>
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-string">"REFUND"</span>.equals(channelStatus)) {
            <span class="hljs-keyword">return</span> localStatus == <span class="hljs-number">3</span>;  <span class="hljs-comment">// 已退款</span>
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }
}
</code></pre>
<h4 data-id="heading-16">4.4 对账服务</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 对账任务服务
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReconTaskService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ReconTaskMapper taskMapper;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ReconResultMapper resultMapper;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> LocalPaymentRecordMapper localRecordMapper;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> List&lt;BillParser&gt; billParsers;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DefaultReconEngine reconEngine;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ChannelBillService channelBillService;

    <span class="hljs-comment">/**
     * 创建对账任务
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> ReconTask <span class="hljs-title function_">createTask</span><span class="hljs-params">(String channelType, LocalDate reconDate, String filePath)</span> {
        <span class="hljs-type">ReconTask</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReconTask</span>();
        task.setTaskNo(generateTaskNo());
        task.setChannelType(channelType);
        task.setReconDate(reconDate);
        task.setFilePath(filePath);
        task.setStatus(TaskStatus.PENDING.getCode());

        taskMapper.insert(task);
        <span class="hljs-keyword">return</span> task;
    }

    <span class="hljs-comment">/**
     * 执行对账任务
     */</span>
    <span class="hljs-meta">@Async</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeTask</span><span class="hljs-params">(Long taskId)</span> {
        <span class="hljs-type">ReconTask</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> taskMapper.selectById(taskId);
        <span class="hljs-keyword">if</span> (task == <span class="hljs-literal">null</span>) {
            log.error(<span class="hljs-string">"对账任务不存在: {}"</span>, taskId);
            <span class="hljs-keyword">return</span>;
        }

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 更新任务状态</span>
            task.setStatus(TaskStatus.PROCESSING.getCode());
            task.setStartTime(LocalDateTime.now());
            taskMapper.updateById(task);

            <span class="hljs-comment">// 1. 解析渠道账单</span>
            List&lt;ChannelBillDTO&gt; channelBills = parseBillFile(task);
            task.setTotalCount(channelBills.size());

            <span class="hljs-comment">// 2. 保存渠道账单</span>
            channelBillService.saveBatch(task.getId(), task.getChannelType(), channelBills);

            <span class="hljs-comment">// 3. 查询本地支付记录</span>
            List&lt;LocalPaymentRecord&gt; localRecords = queryLocalRecords(
                    task.getChannelType(), task.getReconDate());

            <span class="hljs-comment">// 4. 执行对账</span>
            List&lt;ReconResult&gt; results = reconEngine.batchReconcile(channelBills, localRecords);

            <span class="hljs-comment">// 5. 保存对账结果</span>
            saveReconResults(task.getId(), results);

            <span class="hljs-comment">// 6. 更新任务统计</span>
            updateTaskStatistics(task, results);

            task.setStatus(TaskStatus.COMPLETED.getCode());
            task.setEndTime(LocalDateTime.now());

        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"对账任务执行失败: {}"</span>, taskId, e);
            task.setStatus(TaskStatus.FAILED.getCode());
            task.setErrorMsg(e.getMessage());
            task.setEndTime(LocalDateTime.now());
        }

        taskMapper.updateById(task);
    }

    <span class="hljs-comment">/**
     * 解析账单文件
     */</span>
    <span class="hljs-keyword">private</span> List&lt;ChannelBillDTO&gt; <span class="hljs-title function_">parseBillFile</span><span class="hljs-params">(ReconTask task)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 获取文件输入流</span>
        <span class="hljs-type">InputStream</span> <span class="hljs-variable">inputStream</span> <span class="hljs-operator">=</span> getFileInputStream(task.getFilePath());

        <span class="hljs-comment">// 查找匹配的解析器</span>
        <span class="hljs-type">BillParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> billParsers.stream()
                .filter(p -&gt; p.getChannelType().getCode().equals(task.getChannelType()))
                .findFirst()
                .orElseThrow(() -&gt; <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"不支持的渠道类型: "</span> + task.getChannelType()));

        <span class="hljs-keyword">return</span> parser.parse(inputStream, task.getFilePath());
    }

    <span class="hljs-comment">/**
     * 查询本地支付记录
     */</span>
    <span class="hljs-keyword">private</span> List&lt;LocalPaymentRecord&gt; <span class="hljs-title function_">queryLocalRecords</span><span class="hljs-params">(String channelType, LocalDate reconDate)</span> {
        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> reconDate.atStartOfDay();
        <span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">endTime</span> <span class="hljs-operator">=</span> reconDate.plusDays(<span class="hljs-number">1</span>).atStartOfDay();

        <span class="hljs-keyword">return</span> localRecordMapper.selectByChannelAndTime(channelType, startTime, endTime);
    }

    <span class="hljs-comment">/**
     * 保存对账结果
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">saveReconResults</span><span class="hljs-params">(Long taskId, List&lt;ReconResult&gt; results)</span> {
        <span class="hljs-comment">// 批量插入</span>
        List&lt;List&lt;ReconResult&gt;&gt; batches = Lists.partition(results, <span class="hljs-number">500</span>);
        <span class="hljs-keyword">for</span> (List&lt;ReconResult&gt; batch : batches) {
            batch.forEach(r -&gt; r.setTaskId(taskId));
            resultMapper.insertBatch(batch);
        }
    }

    <span class="hljs-comment">/**
     * 更新任务统计
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateTaskStatistics</span><span class="hljs-params">(ReconTask task, List&lt;ReconResult&gt; results)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">successCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-type">int</span> <span class="hljs-variable">diffCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

        <span class="hljs-keyword">for</span> (ReconResult result : results) {
            <span class="hljs-keyword">if</span> (result.getResultType() == ReconResultType.MATCHED.getCode()) {
                successCount++;
            } <span class="hljs-keyword">else</span> {
                diffCount++;
            }
        }

        task.setSuccessCount(successCount);
        task.setDiffCount(diffCount);
        task.setFailCount(<span class="hljs-number">0</span>);
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">generateTaskNo</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"RECON"</span> + System.currentTimeMillis() +
                String.format(<span class="hljs-string">"%04d"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(<span class="hljs-number">10000</span>));
    }

    <span class="hljs-keyword">private</span> InputStream <span class="hljs-title function_">getFileInputStream</span><span class="hljs-params">(String filePath)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 支持本地文件和 OSS 文件</span>
        <span class="hljs-keyword">if</span> (filePath.startsWith(<span class="hljs-string">"http"</span>)) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(filePath).openStream();
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(filePath);
    }
}
</code></pre>
<h4 data-id="heading-17">4.5 定时对账任务</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 对账定时任务
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReconScheduleTask</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ReconTaskService taskService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> BillDownloadService billDownloadService;

    <span class="hljs-comment">/**
     * 每天凌晨 1 点执行前一天的对账
     */</span>
    <span class="hljs-meta">@Scheduled(cron = "0 0 1 * * ?")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dailyReconciliation</span><span class="hljs-params">()</span> {
        <span class="hljs-type">LocalDate</span> <span class="hljs-variable">reconDate</span> <span class="hljs-operator">=</span> LocalDate.now().minusDays(<span class="hljs-number">1</span>);
        log.info(<span class="hljs-string">"开始执行 {} 的对账任务"</span>, reconDate);

        <span class="hljs-comment">// 支付宝对账</span>
        executeChannelRecon(ChannelType.ALIPAY, reconDate);

        <span class="hljs-comment">// 微信对账</span>
        executeChannelRecon(ChannelType.WECHAT, reconDate);

        <span class="hljs-comment">// 银行对账</span>
        executeChannelRecon(ChannelType.BANK, reconDate);

        log.info(<span class="hljs-string">"{} 的对账任务创建完成"</span>, reconDate);
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">executeChannelRecon</span><span class="hljs-params">(ChannelType channelType, LocalDate reconDate)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 下载账单文件</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> billDownloadService.downloadBill(channelType, reconDate);

            <span class="hljs-comment">// 2. 创建对账任务</span>
            <span class="hljs-type">ReconTask</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> taskService.createTask(
                    channelType.getCode(), reconDate, filePath);

            <span class="hljs-comment">// 3. 异步执行对账</span>
            taskService.executeTask(task.getId());

        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"{}渠道对账任务创建失败: {}"</span>, channelType.getDesc(), e.getMessage(), e);
        }
    }
}

<span class="hljs-comment">/**
 * 账单下载服务
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BillDownloadService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AlipayClient alipayClient;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> WxPayService wxPayService;

    <span class="hljs-comment">/**
     * 下载渠道账单
     */</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">downloadBill</span><span class="hljs-params">(ChannelType channelType, LocalDate billDate)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">switch</span> (channelType) {
            <span class="hljs-keyword">case</span> ALIPAY:
                <span class="hljs-keyword">return</span> downloadAlipayBill(billDate);
            <span class="hljs-keyword">case</span> WECHAT:
                <span class="hljs-keyword">return</span> downloadWechatBill(billDate);
            <span class="hljs-keyword">case</span> BANK:
                <span class="hljs-keyword">return</span> downloadBankBill(billDate);
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"不支持的渠道类型: "</span> + channelType);
        }
    }

    <span class="hljs-comment">/**
     * 下载支付宝账单
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">downloadAlipayBill</span><span class="hljs-params">(LocalDate billDate)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">AlipayDataDataserviceBillDownloadurlQueryRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span>
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">AlipayDataDataserviceBillDownloadurlQueryRequest</span>();

        Map&lt;String, String&gt; params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        params.put(<span class="hljs-string">"bill_type"</span>, <span class="hljs-string">"trade"</span>);
        params.put(<span class="hljs-string">"bill_date"</span>, billDate.format(DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd"</span>)));
        request.setBizContent(JSON.toJSONString(params));

        <span class="hljs-type">AlipayDataDataserviceBillDownloadurlQueryResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span>
                alipayClient.execute(request);

        <span class="hljs-keyword">if</span> (response.isSuccess()) {
            <span class="hljs-type">String</span> <span class="hljs-variable">downloadUrl</span> <span class="hljs-operator">=</span> response.getBillDownloadUrl();
            <span class="hljs-keyword">return</span> downloadAndSaveFile(downloadUrl, <span class="hljs-string">"alipay"</span>, billDate);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"获取支付宝账单下载地址失败: "</span> + response.getMsg());
        }
    }

    <span class="hljs-comment">/**
     * 下载微信账单
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">downloadWechatBill</span><span class="hljs-params">(LocalDate billDate)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">WxPayDownloadBillRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WxPayDownloadBillRequest</span>();
        request.setBillDate(billDate.format(DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyyMMdd"</span>)));
        request.setBillType(<span class="hljs-string">"ALL"</span>);

        <span class="hljs-type">WxPayDownloadBillResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> wxPayService.downloadBill(request);

        <span class="hljs-comment">// 保存账单内容到文件</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">"wechat_bill_%s.csv"</span>,
                billDate.format(DateTimeFormatter.BASIC_ISO_DATE));
        <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> <span class="hljs-string">"/data/bills/"</span> + fileName;

        Files.write(Paths.get(filePath), result.getBillContent().getBytes(StandardCharsets.UTF_8));

        <span class="hljs-keyword">return</span> filePath;
    }

    <span class="hljs-comment">/**
     * 下载银行账单（通常是 SFTP 方式）
     */</span>
    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">downloadBankBill</span><span class="hljs-params">(LocalDate billDate)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-comment">// 银行账单通常通过 SFTP 获取</span>
        <span class="hljs-comment">// 这里简化处理</span>
        <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">"bank_bill_%s.xlsx"</span>,
                billDate.format(DateTimeFormatter.BASIC_ISO_DATE));
        <span class="hljs-keyword">return</span> <span class="hljs-string">"/data/bills/"</span> + fileName;
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">downloadAndSaveFile</span><span class="hljs-params">(String url, String prefix, LocalDate billDate)</span>
            <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> String.format(<span class="hljs-string">"%s_bill_%s.csv"</span>,
                prefix, billDate.format(DateTimeFormatter.BASIC_ISO_DATE));
        <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> <span class="hljs-string">"/data/bills/"</span> + fileName;

        <span class="hljs-comment">// 下载文件</span>
        <span class="hljs-keyword">try</span> (<span class="hljs-type">InputStream</span> <span class="hljs-variable">in</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">URL</span>(url).openStream()) {
            Files.copy(in, Paths.get(filePath), StandardCopyOption.REPLACE_EXISTING);
        }

        <span class="hljs-keyword">return</span> filePath;
    }
}
</code></pre>
<h4 data-id="heading-18">4.6 差异处理服务</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 差异处理服务
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DiffHandleService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ReconResultMapper resultMapper;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> LocalPaymentRecordMapper localRecordMapper;

    <span class="hljs-comment">/**
     * 查询待处理差异
     */</span>
    <span class="hljs-keyword">public</span> List&lt;ReconResult&gt; <span class="hljs-title function_">queryPendingDiffs</span><span class="hljs-params">(Long taskId)</span> {
        <span class="hljs-keyword">return</span> resultMapper.selectByTaskAndStatus(taskId, <span class="hljs-number">0</span>);
    }

    <span class="hljs-comment">/**
     * 处理差异：标记为已处理
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleDiff</span><span class="hljs-params">(Long resultId, String handleRemark, String handler)</span> {
        <span class="hljs-type">ReconResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> resultMapper.selectById(resultId);
        <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"对账结果不存在"</span>);
        }

        result.setHandleStatus(<span class="hljs-number">1</span>);  <span class="hljs-comment">// 已处理</span>
        result.setHandleRemark(handleRemark);
        result.setHandler(handler);
        result.setHandleTime(LocalDateTime.now());

        resultMapper.updateById(result);

        <span class="hljs-comment">// 更新本地记录的对账状态</span>
        <span class="hljs-keyword">if</span> (result.getOrderNo() != <span class="hljs-literal">null</span>) {
            <span class="hljs-type">LocalPaymentRecord</span> <span class="hljs-variable">localRecord</span> <span class="hljs-operator">=</span> localRecordMapper.selectByOrderNo(result.getOrderNo());
            <span class="hljs-keyword">if</span> (localRecord != <span class="hljs-literal">null</span>) {
                localRecord.setReconStatus(<span class="hljs-number">1</span>);  <span class="hljs-comment">// 已对账</span>
                localRecord.setReconTime(LocalDateTime.now());
                localRecordMapper.updateById(localRecord);
            }
        }
    }

    <span class="hljs-comment">/**
     * 忽略差异
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">ignoreDiff</span><span class="hljs-params">(Long resultId, String reason, String handler)</span> {
        <span class="hljs-type">ReconResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> resultMapper.selectById(resultId);
        <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"对账结果不存在"</span>);
        }

        result.setHandleStatus(<span class="hljs-number">2</span>);  <span class="hljs-comment">// 忽略</span>
        result.setHandleRemark(<span class="hljs-string">"忽略原因: "</span> + reason);
        result.setHandler(handler);
        result.setHandleTime(LocalDateTime.now());

        resultMapper.updateById(result);
    }

    <span class="hljs-comment">/**
     * 批量处理短款（渠道有本地无）
     * 自动创建本地补单记录
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">batchHandleChannelMore</span><span class="hljs-params">(List&lt;Long&gt; resultIds, String handler)</span> {
        <span class="hljs-keyword">for</span> (Long resultId : resultIds) {
            <span class="hljs-type">ReconResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> resultMapper.selectById(resultId);
            <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span> || result.getResultType() != ReconResultType.CHANNEL_MORE.getCode()) {
                <span class="hljs-keyword">continue</span>;
            }

            <span class="hljs-comment">// 创建补单记录</span>
            <span class="hljs-type">LocalPaymentRecord</span> <span class="hljs-variable">record</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LocalPaymentRecord</span>();
            record.setOrderNo(result.getChannelTradeNo());  <span class="hljs-comment">// 使用渠道交易号作为订单号</span>
            record.setChannelTradeNo(result.getChannelTradeNo());
            record.setAmount(result.getChannelAmount());
            record.setPayStatus(<span class="hljs-number">1</span>);  <span class="hljs-comment">// 支付成功</span>
            record.setReconStatus(<span class="hljs-number">1</span>);  <span class="hljs-comment">// 已对账</span>
            record.setReconTime(LocalDateTime.now());

            localRecordMapper.insert(record);

            <span class="hljs-comment">// 更新差异处理状态</span>
            result.setHandleStatus(<span class="hljs-number">1</span>);
            result.setHandleRemark(<span class="hljs-string">"自动补单处理"</span>);
            result.setHandler(handler);
            result.setHandleTime(LocalDateTime.now());
            resultMapper.updateById(result);

            log.info(<span class="hljs-string">"短款自动补单: channelTradeNo={}"</span>, result.getChannelTradeNo());
        }
    }

    <span class="hljs-comment">/**
     * 自动处理规则
     */</span>
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">autoHandleDiffs</span><span class="hljs-params">(Long taskId)</span> {
        List&lt;ReconResult&gt; diffs = queryPendingDiffs(taskId);

        <span class="hljs-keyword">for</span> (ReconResult diff : diffs) {
            <span class="hljs-comment">// 规则1：金额差异小于1分，自动忽略</span>
            <span class="hljs-keyword">if</span> (diff.getResultType() == ReconResultType.AMOUNT_MISMATCH.getCode()) {
                <span class="hljs-keyword">if</span> (diff.getDiffAmount() != <span class="hljs-literal">null</span> &amp;&amp;
                        diff.getDiffAmount().compareTo(<span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"0.01"</span>)) &lt;= <span class="hljs-number">0</span>) {
                    ignoreDiff(diff.getId(), <span class="hljs-string">"金额差异小于1分，系统自动忽略"</span>, <span class="hljs-string">"SYSTEM"</span>);
                }
            }

            <span class="hljs-comment">// 规则2：时间跨天差异，自动忽略（需要额外逻辑判断）</span>
            <span class="hljs-comment">// ...</span>
        }
    }
}
</code></pre>
<h4 data-id="heading-19">4.7 对账报告生成</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 对账报告服务
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReconReportService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ReconTaskMapper taskMapper;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ReconResultMapper resultMapper;

    <span class="hljs-comment">/**
     * 生成对账报告
     */</span>
    <span class="hljs-keyword">public</span> ReconReport <span class="hljs-title function_">generateReport</span><span class="hljs-params">(Long taskId)</span> {
        <span class="hljs-type">ReconTask</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> taskMapper.selectById(taskId);
        <span class="hljs-keyword">if</span> (task == <span class="hljs-literal">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"对账任务不存在"</span>);
        }

        <span class="hljs-type">ReconReport</span> <span class="hljs-variable">report</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReconReport</span>();
        report.setTaskNo(task.getTaskNo());
        report.setChannelType(task.getChannelType());
        report.setReconDate(task.getReconDate());

        <span class="hljs-comment">// 统计数据</span>
        report.setTotalCount(task.getTotalCount());
        report.setSuccessCount(task.getSuccessCount());
        report.setDiffCount(task.getDiffCount());

        <span class="hljs-comment">// 计算对账率</span>
        <span class="hljs-keyword">if</span> (task.getTotalCount() &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-type">double</span> <span class="hljs-variable">successRate</span> <span class="hljs-operator">=</span> (<span class="hljs-type">double</span>) task.getSuccessCount() / task.getTotalCount() * <span class="hljs-number">100</span>;
            report.setSuccessRate(String.format(<span class="hljs-string">"%.2f%%"</span>, successRate));
        }

        <span class="hljs-comment">// 差异分类统计</span>
        Map&lt;Integer, Long&gt; diffTypeCount = resultMapper.countByResultType(taskId);
        report.setLocalMoreCount(diffTypeCount.getOrDefault(ReconResultType.LOCAL_MORE.getCode(), <span class="hljs-number">0L</span>));
        report.setChannelMoreCount(diffTypeCount.getOrDefault(ReconResultType.CHANNEL_MORE.getCode(), <span class="hljs-number">0L</span>));
        report.setAmountMismatchCount(diffTypeCount.getOrDefault(ReconResultType.AMOUNT_MISMATCH.getCode(), <span class="hljs-number">0L</span>));
        report.setStatusMismatchCount(diffTypeCount.getOrDefault(ReconResultType.STATUS_MISMATCH.getCode(), <span class="hljs-number">0L</span>));

        <span class="hljs-comment">// 差异金额统计</span>
        <span class="hljs-type">BigDecimal</span> <span class="hljs-variable">totalDiffAmount</span> <span class="hljs-operator">=</span> resultMapper.sumDiffAmount(taskId);
        report.setTotalDiffAmount(totalDiffAmount);

        <span class="hljs-comment">// 生成时间</span>
        report.setGenerateTime(LocalDateTime.now());

        <span class="hljs-keyword">return</span> report;
    }

    <span class="hljs-comment">/**
     * 导出对账报告 Excel
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exportReportExcel</span><span class="hljs-params">(Long taskId, OutputStream outputStream)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">ReconReport</span> <span class="hljs-variable">report</span> <span class="hljs-operator">=</span> generateReport(taskId);
        List&lt;ReconResult&gt; diffs = resultMapper.selectDiffsByTaskId(taskId);

        <span class="hljs-comment">// 使用 EasyExcel 导出</span>
        <span class="hljs-type">ExcelWriter</span> <span class="hljs-variable">excelWriter</span> <span class="hljs-operator">=</span> EasyExcel.write(outputStream).build();

        <span class="hljs-comment">// Sheet1: 报告摘要</span>
        <span class="hljs-type">WriteSheet</span> <span class="hljs-variable">summarySheet</span> <span class="hljs-operator">=</span> EasyExcel.writerSheet(<span class="hljs-number">0</span>, <span class="hljs-string">"对账摘要"</span>)
                .head(ReportSummary.class).build();
        excelWriter.write(Collections.singletonList(convertToSummary(report)), summarySheet);

        <span class="hljs-comment">// Sheet2: 差异明细</span>
        <span class="hljs-type">WriteSheet</span> <span class="hljs-variable">diffSheet</span> <span class="hljs-operator">=</span> EasyExcel.writerSheet(<span class="hljs-number">1</span>, <span class="hljs-string">"差异明细"</span>)
                .head(DiffDetail.class).build();
        excelWriter.write(convertToDiffDetails(diffs), diffSheet);

        excelWriter.finish();
    }

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReconReport</span> {
        <span class="hljs-keyword">private</span> String taskNo;
        <span class="hljs-keyword">private</span> String channelType;
        <span class="hljs-keyword">private</span> LocalDate reconDate;
        <span class="hljs-keyword">private</span> Integer totalCount;
        <span class="hljs-keyword">private</span> Integer successCount;
        <span class="hljs-keyword">private</span> Integer diffCount;
        <span class="hljs-keyword">private</span> String successRate;
        <span class="hljs-keyword">private</span> Long localMoreCount;
        <span class="hljs-keyword">private</span> Long channelMoreCount;
        <span class="hljs-keyword">private</span> Long amountMismatchCount;
        <span class="hljs-keyword">private</span> Long statusMismatchCount;
        <span class="hljs-keyword">private</span> BigDecimal totalDiffAmount;
        <span class="hljs-keyword">private</span> LocalDateTime generateTime;
    }

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReportSummary</span> {
        <span class="hljs-meta">@ExcelProperty("任务编号")</span>
        <span class="hljs-keyword">private</span> String taskNo;

        <span class="hljs-meta">@ExcelProperty("渠道类型")</span>
        <span class="hljs-keyword">private</span> String channelType;

        <span class="hljs-meta">@ExcelProperty("对账日期")</span>
        <span class="hljs-keyword">private</span> String reconDate;

        <span class="hljs-meta">@ExcelProperty("总记录数")</span>
        <span class="hljs-keyword">private</span> Integer totalCount;

        <span class="hljs-meta">@ExcelProperty("成功数")</span>
        <span class="hljs-keyword">private</span> Integer successCount;

        <span class="hljs-meta">@ExcelProperty("差异数")</span>
        <span class="hljs-keyword">private</span> Integer diffCount;

        <span class="hljs-meta">@ExcelProperty("对账成功率")</span>
        <span class="hljs-keyword">private</span> String successRate;
    }

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DiffDetail</span> {
        <span class="hljs-meta">@ExcelProperty("商户订单号")</span>
        <span class="hljs-keyword">private</span> String orderNo;

        <span class="hljs-meta">@ExcelProperty("渠道交易号")</span>
        <span class="hljs-keyword">private</span> String channelTradeNo;

        <span class="hljs-meta">@ExcelProperty("差异类型")</span>
        <span class="hljs-keyword">private</span> String resultType;

        <span class="hljs-meta">@ExcelProperty("本地金额")</span>
        <span class="hljs-keyword">private</span> BigDecimal localAmount;

        <span class="hljs-meta">@ExcelProperty("渠道金额")</span>
        <span class="hljs-keyword">private</span> BigDecimal channelAmount;

        <span class="hljs-meta">@ExcelProperty("差异金额")</span>
        <span class="hljs-keyword">private</span> BigDecimal diffAmount;

        <span class="hljs-meta">@ExcelProperty("处理状态")</span>
        <span class="hljs-keyword">private</span> String handleStatus;
    }

    <span class="hljs-keyword">private</span> ReportSummary <span class="hljs-title function_">convertToSummary</span><span class="hljs-params">(ReconReport report)</span> {
        <span class="hljs-type">ReportSummary</span> <span class="hljs-variable">summary</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReportSummary</span>();
        summary.setTaskNo(report.getTaskNo());
        summary.setChannelType(report.getChannelType());
        summary.setReconDate(report.getReconDate().toString());
        summary.setTotalCount(report.getTotalCount());
        summary.setSuccessCount(report.getSuccessCount());
        summary.setDiffCount(report.getDiffCount());
        summary.setSuccessRate(report.getSuccessRate());
        <span class="hljs-keyword">return</span> summary;
    }

    <span class="hljs-keyword">private</span> List&lt;DiffDetail&gt; <span class="hljs-title function_">convertToDiffDetails</span><span class="hljs-params">(List&lt;ReconResult&gt; diffs)</span> {
        <span class="hljs-keyword">return</span> diffs.stream().map(d -&gt; {
            <span class="hljs-type">DiffDetail</span> <span class="hljs-variable">detail</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DiffDetail</span>();
            detail.setOrderNo(d.getOrderNo());
            detail.setChannelTradeNo(d.getChannelTradeNo());
            detail.setResultType(ReconResultType.values()[d.getResultType() - <span class="hljs-number">1</span>].getDesc());
            detail.setLocalAmount(d.getLocalAmount());
            detail.setChannelAmount(d.getChannelAmount());
            detail.setDiffAmount(d.getDiffAmount());
            detail.setHandleStatus(d.getHandleStatus() == <span class="hljs-number">0</span> ? <span class="hljs-string">"待处理"</span> :
                    d.getHandleStatus() == <span class="hljs-number">1</span> ? <span class="hljs-string">"已处理"</span> : <span class="hljs-string">"已忽略"</span>);
            <span class="hljs-keyword">return</span> detail;
        }).collect(Collectors.toList());
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-20">五、自定义渠道导入</h3>
<h4 data-id="heading-21">5.1 自定义渠道配置</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 渠道配置实体
 */</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-meta">@TableName("recon_channel_config")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReconChannelConfig</span> {
    <span class="hljs-meta">@TableId(type = IdType.AUTO)</span>
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String channelCode;
    <span class="hljs-keyword">private</span> String channelName;
    <span class="hljs-keyword">private</span> String fileType;
    <span class="hljs-keyword">private</span> String fileEncoding;
    <span class="hljs-keyword">private</span> String fieldMapping;  <span class="hljs-comment">// JSON 格式</span>
    <span class="hljs-keyword">private</span> String parserClass;
    <span class="hljs-keyword">private</span> Integer status;
    <span class="hljs-keyword">private</span> LocalDateTime createTime;
    <span class="hljs-keyword">private</span> LocalDateTime updateTime;
}

<span class="hljs-comment">/**
 * 渠道配置服务
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChannelConfigService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ReconChannelConfigMapper configMapper;

    <span class="hljs-comment">/**
     * 创建自定义渠道配置
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createChannelConfig</span><span class="hljs-params">(ChannelConfigDTO dto)</span> {
        <span class="hljs-comment">// 验证字段映射</span>
        validateFieldMapping(dto.getFieldMapping());

        <span class="hljs-type">ReconChannelConfig</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ReconChannelConfig</span>();
        config.setChannelCode(dto.getChannelCode());
        config.setChannelName(dto.getChannelName());
        config.setFileType(dto.getFileType());
        config.setFileEncoding(dto.getFileEncoding());
        config.setFieldMapping(JSON.toJSONString(dto.getFieldMapping()));
        config.setStatus(<span class="hljs-number">1</span>);

        configMapper.insert(config);
    }

    <span class="hljs-comment">/**
     * 验证字段映射配置
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">validateFieldMapping</span><span class="hljs-params">(Map&lt;String, String&gt; fieldMapping)</span> {
        <span class="hljs-comment">// 必须包含的字段</span>
        List&lt;String&gt; requiredFields = Arrays.asList(
                <span class="hljs-string">"channelTradeNo"</span>, <span class="hljs-string">"merchantOrderNo"</span>, <span class="hljs-string">"amount"</span>, <span class="hljs-string">"tradeStatus"</span>
        );

        <span class="hljs-keyword">for</span> (String field : requiredFields) {
            <span class="hljs-keyword">if</span> (!fieldMapping.containsKey(field)) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"缺少必要字段映射: "</span> + field);
            }
        }
    }

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChannelConfigDTO</span> {
        <span class="hljs-keyword">private</span> String channelCode;
        <span class="hljs-keyword">private</span> String channelName;
        <span class="hljs-keyword">private</span> String fileType;  <span class="hljs-comment">// CSV / EXCEL</span>
        <span class="hljs-keyword">private</span> String fileEncoding;
        <span class="hljs-keyword">private</span> Map&lt;String, String&gt; fieldMapping;
    }
}
</code></pre>
<h4 data-id="heading-22">5.2 文件上传与导入</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 文件上传控制器
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/api/recon")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReconController</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ReconTaskService taskService;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> CustomBillParserFactory parserFactory;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ChannelBillService channelBillService;

    <span class="hljs-comment">/**
     * 上传自定义渠道账单
     */</span>
    <span class="hljs-meta">@PostMapping("/upload/custom")</span>
    <span class="hljs-keyword">public</span> Result&lt;?&gt; uploadCustomBill(
            <span class="hljs-meta">@RequestParam("file")</span> MultipartFile file,
            <span class="hljs-meta">@RequestParam("channelCode")</span> String channelCode,
            <span class="hljs-meta">@RequestParam("reconDate")</span> <span class="hljs-meta">@DateTimeFormat(pattern = "yyyy-MM-dd")</span> LocalDate reconDate) {

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 1. 保存文件</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> saveUploadFile(file);

            <span class="hljs-comment">// 2. 创建对账任务</span>
            <span class="hljs-type">ReconTask</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> taskService.createTask(<span class="hljs-string">"CUSTOM"</span>, reconDate, filePath);

            <span class="hljs-comment">// 3. 解析账单</span>
            List&lt;ChannelBillDTO&gt; bills = parserFactory.parse(channelCode, file.getInputStream());

            <span class="hljs-comment">// 4. 保存账单数据</span>
            channelBillService.saveCustomBills(task.getId(), channelCode, bills);

            <span class="hljs-comment">// 5. 异步执行对账</span>
            taskService.executeTask(task.getId());

            <span class="hljs-keyword">return</span> Result.success(task.getTaskNo());

        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"上传自定义渠道账单失败"</span>, e);
            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">"上传失败: "</span> + e.getMessage());
        }
    }

    <span class="hljs-comment">/**
     * 上传支付宝/微信账单
     */</span>
    <span class="hljs-meta">@PostMapping("/upload/{channelType}")</span>
    <span class="hljs-keyword">public</span> Result&lt;?&gt; uploadBill(
            <span class="hljs-meta">@PathVariable</span> String channelType,
            <span class="hljs-meta">@RequestParam("file")</span> MultipartFile file,
            <span class="hljs-meta">@RequestParam("reconDate")</span> <span class="hljs-meta">@DateTimeFormat(pattern = "yyyy-MM-dd")</span> LocalDate reconDate) {

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 保存文件</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> saveUploadFile(file);

            <span class="hljs-comment">// 创建并执行对账任务</span>
            <span class="hljs-type">ReconTask</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> taskService.createTask(channelType.toUpperCase(), reconDate, filePath);
            taskService.executeTask(task.getId());

            <span class="hljs-keyword">return</span> Result.success(task.getTaskNo());

        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"上传账单失败"</span>, e);
            <span class="hljs-keyword">return</span> Result.fail(<span class="hljs-string">"上传失败: "</span> + e.getMessage());
        }
    }

    <span class="hljs-comment">/**
     * 查询对账任务状态
     */</span>
    <span class="hljs-meta">@GetMapping("/task/{taskNo}")</span>
    <span class="hljs-keyword">public</span> Result&lt;ReconTask&gt; <span class="hljs-title function_">getTaskStatus</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> String taskNo)</span> {
        <span class="hljs-type">ReconTask</span> <span class="hljs-variable">task</span> <span class="hljs-operator">=</span> taskService.getByTaskNo(taskNo);
        <span class="hljs-keyword">return</span> Result.success(task);
    }

    <span class="hljs-comment">/**
     * 查询对账差异列表
     */</span>
    <span class="hljs-meta">@GetMapping("/diff/list")</span>
    <span class="hljs-keyword">public</span> Result&lt;PageInfo&lt;ReconResult&gt;&gt; <span class="hljs-title function_">getDiffList</span><span class="hljs-params">(
            <span class="hljs-meta">@RequestParam</span> Long taskId,
            <span class="hljs-meta">@RequestParam(defaultValue = "1")</span> <span class="hljs-type">int</span> pageNum,
            <span class="hljs-meta">@RequestParam(defaultValue = "20")</span> <span class="hljs-type">int</span> pageSize)</span> {

        PageHelper.startPage(pageNum, pageSize);
        List&lt;ReconResult&gt; diffs = taskService.getDiffList(taskId);

        <span class="hljs-keyword">return</span> Result.success(<span class="hljs-keyword">new</span> <span class="hljs-title class_">PageInfo</span>&lt;&gt;(diffs));
    }

    <span class="hljs-comment">/**
     * 导出对账报告
     */</span>
    <span class="hljs-meta">@GetMapping("/report/export")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exportReport</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam</span> Long taskId, HttpServletResponse response)</span>
            <span class="hljs-keyword">throws</span> Exception {

        response.setContentType(<span class="hljs-string">"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"</span>);
        response.setHeader(<span class="hljs-string">"Content-Disposition"</span>,
                <span class="hljs-string">"attachment;filename=recon_report_"</span> + taskId + <span class="hljs-string">".xlsx"</span>);

        taskService.exportReport(taskId, response.getOutputStream());
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">saveUploadFile</span><span class="hljs-params">(MultipartFile file)</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-type">String</span> <span class="hljs-variable">originalFilename</span> <span class="hljs-operator">=</span> file.getOriginalFilename();
        <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> System.currentTimeMillis() + <span class="hljs-string">"_"</span> + originalFilename;
        <span class="hljs-type">String</span> <span class="hljs-variable">filePath</span> <span class="hljs-operator">=</span> <span class="hljs-string">"/data/bills/upload/"</span> + fileName;

        <span class="hljs-type">File</span> <span class="hljs-variable">destFile</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(filePath);
        <span class="hljs-keyword">if</span> (!destFile.getParentFile().exists()) {
            destFile.getParentFile().mkdirs();
        }

        file.transferTo(destFile);
        <span class="hljs-keyword">return</span> filePath;
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-23">六、监控告警</h3>
<h4 data-id="heading-24">6.1 对账监控指标</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 对账监控服务
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReconMonitorService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ReconTaskMapper taskMapper;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ReconResultMapper resultMapper;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> AlertService alertService;

    <span class="hljs-comment">/**
     * 监控对账任务执行情况
     */</span>
    <span class="hljs-meta">@Scheduled(cron = "0 0/30 * * * ?")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">monitorTaskExecution</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 检查超时任务（处理中超过1小时）</span>
        List&lt;ReconTask&gt; timeoutTasks = taskMapper.selectTimeoutTasks(
                TaskStatus.PROCESSING.getCode(), <span class="hljs-number">60</span>);

        <span class="hljs-keyword">for</span> (ReconTask task : timeoutTasks) {
            log.warn(<span class="hljs-string">"对账任务执行超时: taskNo={}"</span>, task.getTaskNo());
            alertService.sendAlert(AlertLevel.WARNING,
                    <span class="hljs-string">"对账任务执行超时"</span>, <span class="hljs-string">"任务编号: "</span> + task.getTaskNo());
        }

        <span class="hljs-comment">// 检查失败任务</span>
        List&lt;ReconTask&gt; failedTasks = taskMapper.selectTodayFailedTasks();
        <span class="hljs-keyword">if</span> (!failedTasks.isEmpty()) {
            log.error(<span class="hljs-string">"今日存在失败的对账任务: {}"</span>, failedTasks.size());
            alertService.sendAlert(AlertLevel.ERROR,
                    <span class="hljs-string">"对账任务执行失败"</span>, <span class="hljs-string">"失败任务数: "</span> + failedTasks.size());
        }
    }

    <span class="hljs-comment">/**
     * 监控差异率
     */</span>
    <span class="hljs-meta">@Scheduled(cron = "0 0 9 * * ?")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">monitorDiffRate</span><span class="hljs-params">()</span> {
        <span class="hljs-type">LocalDate</span> <span class="hljs-variable">yesterday</span> <span class="hljs-operator">=</span> LocalDate.now().minusDays(<span class="hljs-number">1</span>);

        List&lt;ReconTask&gt; tasks = taskMapper.selectByReconDate(yesterday);

        <span class="hljs-keyword">for</span> (ReconTask task : tasks) {
            <span class="hljs-keyword">if</span> (task.getTotalCount() == <span class="hljs-literal">null</span> || task.getTotalCount() == <span class="hljs-number">0</span>) {
                <span class="hljs-keyword">continue</span>;
            }

            <span class="hljs-comment">// 计算差异率</span>
            <span class="hljs-type">double</span> <span class="hljs-variable">diffRate</span> <span class="hljs-operator">=</span> (<span class="hljs-type">double</span>) task.getDiffCount() / task.getTotalCount() * <span class="hljs-number">100</span>;

            <span class="hljs-comment">// 差异率超过阈值告警</span>
            <span class="hljs-keyword">if</span> (diffRate &gt; <span class="hljs-number">1.0</span>) {  <span class="hljs-comment">// 差异率超过1%</span>
                log.warn(<span class="hljs-string">"对账差异率异常: channel={}, date={}, diffRate={}%"</span>,
                        task.getChannelType(), task.getReconDate(), diffRate);

                alertService.sendAlert(AlertLevel.WARNING,
                        <span class="hljs-string">"对账差异率异常"</span>,
                        String.format(<span class="hljs-string">"渠道: %s, 日期: %s, 差异率: %.2f%%"</span>,
                                task.getChannelType(), task.getReconDate(), diffRate));
            }
        }
    }

    <span class="hljs-comment">/**
     * 获取对账看板数据
     */</span>
    <span class="hljs-keyword">public</span> DashboardData <span class="hljs-title function_">getDashboardData</span><span class="hljs-params">(LocalDate startDate, LocalDate endDate)</span> {
        <span class="hljs-type">DashboardData</span> <span class="hljs-variable">data</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DashboardData</span>();

        <span class="hljs-comment">// 任务统计</span>
        data.setTotalTasks(taskMapper.countByDateRange(startDate, endDate));
        data.setSuccessTasks(taskMapper.countByStatusAndDateRange(
                TaskStatus.COMPLETED.getCode(), startDate, endDate));
        data.setFailedTasks(taskMapper.countByStatusAndDateRange(
                TaskStatus.FAILED.getCode(), startDate, endDate));

        <span class="hljs-comment">// 差异统计</span>
        data.setTotalDiffs(resultMapper.countDiffsByDateRange(startDate, endDate));
        data.setHandledDiffs(resultMapper.countHandledDiffsByDateRange(startDate, endDate));
        data.setPendingDiffs(data.getTotalDiffs() - data.getHandledDiffs());

        <span class="hljs-comment">// 差异金额</span>
        data.setTotalDiffAmount(resultMapper.sumDiffAmountByDateRange(startDate, endDate));

        <span class="hljs-comment">// 渠道统计</span>
        data.setChannelStats(taskMapper.groupByChannel(startDate, endDate));

        <span class="hljs-comment">// 趋势数据</span>
        data.setTrendData(taskMapper.getDailyTrend(startDate, endDate));

        <span class="hljs-keyword">return</span> data;
    }

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DashboardData</span> {
        <span class="hljs-keyword">private</span> Long totalTasks;
        <span class="hljs-keyword">private</span> Long successTasks;
        <span class="hljs-keyword">private</span> Long failedTasks;
        <span class="hljs-keyword">private</span> Long totalDiffs;
        <span class="hljs-keyword">private</span> Long handledDiffs;
        <span class="hljs-keyword">private</span> Long pendingDiffs;
        <span class="hljs-keyword">private</span> BigDecimal totalDiffAmount;
        <span class="hljs-keyword">private</span> List&lt;ChannelStat&gt; channelStats;
        <span class="hljs-keyword">private</span> List&lt;TrendData&gt; trendData;
    }

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChannelStat</span> {
        <span class="hljs-keyword">private</span> String channelType;
        <span class="hljs-keyword">private</span> Long taskCount;
        <span class="hljs-keyword">private</span> Long diffCount;
        <span class="hljs-keyword">private</span> Double diffRate;
    }

    <span class="hljs-meta">@Data</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TrendData</span> {
        <span class="hljs-keyword">private</span> LocalDate date;
        <span class="hljs-keyword">private</span> Long totalCount;
        <span class="hljs-keyword">private</span> Long successCount;
        <span class="hljs-keyword">private</span> Long diffCount;
    }
}
</code></pre>
<h4 data-id="heading-25">6.2 告警服务</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 告警级别
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">AlertLevel</span> {
    INFO, WARNING, ERROR, CRITICAL
}

<span class="hljs-comment">/**
 * 告警服务
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AlertService</span> {

    <span class="hljs-meta">@Value("${alert.dingtalk.webhook}")</span>
    <span class="hljs-keyword">private</span> String dingTalkWebhook;

    <span class="hljs-meta">@Value("${alert.email.to}")</span>
    <span class="hljs-keyword">private</span> String emailTo;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RestTemplate restTemplate;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> JavaMailSender mailSender;

    <span class="hljs-comment">/**
     * 发送告警
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendAlert</span><span class="hljs-params">(AlertLevel level, String title, String content)</span> {
        log.info(<span class="hljs-string">"发送告警: level={}, title={}"</span>, level, title);

        <span class="hljs-comment">// 根据告警级别选择通知方式</span>
        <span class="hljs-keyword">switch</span> (level) {
            <span class="hljs-keyword">case</span> INFO:
                <span class="hljs-comment">// 仅记录日志</span>
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> WARNING:
                sendDingTalkAlert(title, content);
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> ERROR:
            <span class="hljs-keyword">case</span> CRITICAL:
                sendDingTalkAlert(title, content);
                sendEmailAlert(title, content);
                <span class="hljs-keyword">break</span>;
        }
    }

    <span class="hljs-comment">/**
     * 发送钉钉告警
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendDingTalkAlert</span><span class="hljs-params">(String title, String content)</span> {
        <span class="hljs-keyword">try</span> {
            Map&lt;String, Object&gt; message = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
            message.put(<span class="hljs-string">"msgtype"</span>, <span class="hljs-string">"markdown"</span>);

            Map&lt;String, String&gt; markdown = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
            markdown.put(<span class="hljs-string">"title"</span>, title);
            markdown.put(<span class="hljs-string">"text"</span>, String.format(<span class="hljs-string">"### %s\n\n%s\n\n&gt; 时间: %s"</span>,
                    title, content, LocalDateTime.now().format(
                            DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>))));

            message.put(<span class="hljs-string">"markdown"</span>, markdown);

            restTemplate.postForObject(dingTalkWebhook, message, String.class);

        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"发送钉钉告警失败"</span>, e);
        }
    }

    <span class="hljs-comment">/**
     * 发送邮件告警
     */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendEmailAlert</span><span class="hljs-params">(String title, String content)</span> {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">SimpleMailMessage</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleMailMessage</span>();
            message.setTo(emailTo.split(<span class="hljs-string">","</span>));
            message.setSubject(<span class="hljs-string">"[对账系统告警] "</span> + title);
            message.setText(content + <span class="hljs-string">"\n\n时间: "</span> + LocalDateTime.now());

            mailSender.send(message);

        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"发送邮件告警失败"</span>, e);
        }
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-26">七、系统优化</h3>
<h4 data-id="heading-27">7.1 大文件处理优化</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 分片解析大文件
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LargeFileBillParser</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">BATCH_SIZE</span> <span class="hljs-operator">=</span> <span class="hljs-number">10000</span>;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> ChannelBillService channelBillService;

    <span class="hljs-comment">/**
     * 流式解析大文件
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">parseAndSave</span><span class="hljs-params">(Long taskId, String channelType,
                              InputStream inputStream)</span> <span class="hljs-keyword">throws</span> Exception {

        <span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedReader</span> <span class="hljs-variable">reader</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedReader</span>(
                <span class="hljs-keyword">new</span> <span class="hljs-title class_">InputStreamReader</span>(inputStream, StandardCharsets.UTF_8))) {

            String line;
            List&lt;ChannelBillDTO&gt; batch = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(BATCH_SIZE);
            <span class="hljs-type">int</span> <span class="hljs-variable">totalCount</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

            <span class="hljs-comment">// 跳过表头</span>
            reader.readLine();

            <span class="hljs-keyword">while</span> ((line = reader.readLine()) != <span class="hljs-literal">null</span>) {
                <span class="hljs-keyword">if</span> (line.trim().isEmpty()) <span class="hljs-keyword">continue</span>;

                <span class="hljs-type">ChannelBillDTO</span> <span class="hljs-variable">bill</span> <span class="hljs-operator">=</span> parseLine(line);
                <span class="hljs-keyword">if</span> (bill != <span class="hljs-literal">null</span>) {
                    batch.add(bill);
                    totalCount++;
                }

                <span class="hljs-comment">// 批量保存</span>
                <span class="hljs-keyword">if</span> (batch.size() &gt;= BATCH_SIZE) {
                    channelBillService.saveBatch(taskId, channelType, batch);
                    log.info(<span class="hljs-string">"已处理 {} 条记录"</span>, totalCount);
                    batch.clear();
                }
            }

            <span class="hljs-comment">// 保存剩余数据</span>
            <span class="hljs-keyword">if</span> (!batch.isEmpty()) {
                channelBillService.saveBatch(taskId, channelType, batch);
            }

            log.info(<span class="hljs-string">"文件解析完成，共 {} 条记录"</span>, totalCount);
        }
    }

    <span class="hljs-keyword">private</span> ChannelBillDTO <span class="hljs-title function_">parseLine</span><span class="hljs-params">(String line)</span> {
        <span class="hljs-comment">// 解析逻辑</span>
        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
    }
}
</code></pre>
<h4 data-id="heading-28">7.2 并行对账优化</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 并行对账引擎
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ParallelReconEngine</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> DefaultReconEngine reconEngine;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(
            Runtime.getRuntime().availableProcessors());

    <span class="hljs-comment">/**
     * 并行批量对账
     */</span>
    <span class="hljs-keyword">public</span> List&lt;ReconResult&gt; <span class="hljs-title function_">parallelReconcile</span><span class="hljs-params">(List&lt;ChannelBillDTO&gt; channelBills,
                                                 List&lt;LocalPaymentRecord&gt; localRecords)</span> {

        <span class="hljs-comment">// 构建本地记录索引</span>
        Map&lt;String, LocalPaymentRecord&gt; localRecordMap = localRecords.stream()
                .collect(Collectors.toMap(
                        LocalPaymentRecord::getOrderNo,
                        r -&gt; r,
                        (r1, r2) -&gt; r1
                ));

        <span class="hljs-comment">// 分片并行处理</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">partitionSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>;
        List&lt;List&lt;ChannelBillDTO&gt;&gt; partitions = Lists.partition(channelBills, partitionSize);

        List&lt;CompletableFuture&lt;List&lt;ReconResult&gt;&gt;&gt; futures = partitions.stream()
                .map(partition -&gt; CompletableFuture.supplyAsync(() -&gt;
                        processPartition(partition, localRecordMap), executor))
                .collect(Collectors.toList());

        <span class="hljs-comment">// 合并结果</span>
        <span class="hljs-keyword">return</span> futures.stream()
                .map(CompletableFuture::join)
                .flatMap(List::stream)
                .collect(Collectors.toList());
    }

    <span class="hljs-keyword">private</span> List&lt;ReconResult&gt; <span class="hljs-title function_">processPartition</span><span class="hljs-params">(List&lt;ChannelBillDTO&gt; partition,
                                                 Map&lt;String, LocalPaymentRecord&gt; localRecordMap)</span> {
        List&lt;ReconResult&gt; results = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();

        <span class="hljs-keyword">for</span> (ChannelBillDTO channelBill : partition) {
            <span class="hljs-type">LocalPaymentRecord</span> <span class="hljs-variable">localRecord</span> <span class="hljs-operator">=</span> localRecordMap.get(channelBill.getMerchantOrderNo());
            <span class="hljs-type">ReconResult</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> reconEngine.reconcile(channelBill, localRecord);
            results.add(result);
        }

        <span class="hljs-keyword">return</span> results;
    }
}
</code></pre>
<h4 data-id="heading-29">7.3 缓存优化</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 对账缓存服务
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReconCacheService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TASK_KEY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"recon:task:"</span>;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">RESULT_KEY_PREFIX</span> <span class="hljs-operator">=</span> <span class="hljs-string">"recon:result:"</span>;

    <span class="hljs-comment">/**
     * 缓存任务信息
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">cacheTask</span><span class="hljs-params">(ReconTask task)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> TASK_KEY_PREFIX + task.getTaskNo();
        redisTemplate.opsForValue().set(key, task, Duration.ofHours(<span class="hljs-number">24</span>));
    }

    <span class="hljs-comment">/**
     * 获取缓存的任务
     */</span>
    <span class="hljs-keyword">public</span> ReconTask <span class="hljs-title function_">getTaskFromCache</span><span class="hljs-params">(String taskNo)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> TASK_KEY_PREFIX + taskNo;
        <span class="hljs-keyword">return</span> (ReconTask) redisTemplate.opsForValue().get(key);
    }

    <span class="hljs-comment">/**
     * 缓存对账进度
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">updateProgress</span><span class="hljs-params">(String taskNo, <span class="hljs-type">int</span> processedCount, <span class="hljs-type">int</span> totalCount)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> TASK_KEY_PREFIX + taskNo + <span class="hljs-string">":progress"</span>;
        Map&lt;String, Integer&gt; progress = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();
        progress.put(<span class="hljs-string">"processed"</span>, processedCount);
        progress.put(<span class="hljs-string">"total"</span>, totalCount);
        redisTemplate.opsForValue().set(key, progress, Duration.ofHours(<span class="hljs-number">2</span>));
    }

    <span class="hljs-comment">/**
     * 获取对账进度
     */</span>
    <span class="hljs-meta">@SuppressWarnings("unchecked")</span>
    <span class="hljs-keyword">public</span> Map&lt;String, Integer&gt; <span class="hljs-title function_">getProgress</span><span class="hljs-params">(String taskNo)</span> {
        <span class="hljs-type">String</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> TASK_KEY_PREFIX + taskNo + <span class="hljs-string">":progress"</span>;
        <span class="hljs-keyword">return</span> (Map&lt;String, Integer&gt;) redisTemplate.opsForValue().get(key);
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-30">八、最佳实践与总结</h3>
<h4 data-id="heading-31">8.1 对账系统设计要点</h4>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-addition">+------------------------------------------------------------------+</span>
|                    对账系统设计要点                                |
<span class="hljs-addition">+------------------------------------------------------------------+</span>
|                                                                   |
|   1. 可扩展性                                                      |
|   - 支持多渠道接入                                                 |
|   - 解析器插件化                                                  |
|   - 字段映射可配置                                                 |
|                                                                   |
|   2. 可靠性                                                        |
|   - 任务失败重试                                                  |
|   - 断点续传                                                      |
|   - 数据校验                                                      |
|                                                                   |
|   3. 性能                                                         |
|   - 大文件分片处理                                                 |
|   - 批量数据库操作                                                 |
|   - 并行对账                                                      |
|                                                                   |
|   4. 可观测性                                                      |
|   - 任务状态监控                                                  |
|   - 差异率告警                                                    |
|   - 对账报告                                                      |
|                                                                   |
<span class="hljs-addition">+------------------------------------------------------------------+</span>
</code></pre>
<h4 data-id="heading-32">8.2 常见问题处理</h4>



































<table><thead><tr><th>问题类型</th><th>原因分析</th><th>解决方案</th></tr></thead><tbody><tr><td>时间差异</td><td>跨天交易、时区问题</td><td>扩大时间范围查询，统一时区</td></tr><tr><td>金额差异</td><td>手续费计算方式不同</td><td>明确金额口径，分开比对</td></tr><tr><td>订单号不匹配</td><td>格式不一致、前缀差异</td><td>标准化订单号格式</td></tr><tr><td>重复对账</td><td>同一笔交易多次出现</td><td>去重处理，幂等设计</td></tr><tr><td>账单延迟</td><td>渠道账单生成延迟</td><td>延后对账时间，增加容错</td></tr></tbody></table>
<h4 data-id="heading-33">8.3 运维建议</h4>
<ol>
<li><strong>对账时间选择</strong>：建议凌晨执行，避免影响业务</li>
<li><strong>账单保留策略</strong>：至少保留 3 个月，便于追溯</li>
<li><strong>差异处理 SLA</strong>：制定差异处理时效要求</li>
<li><strong>定期巡检</strong>：每周检查对账任务执行情况</li>
<li><strong>容灾备份</strong>：对账数据定期备份</li>
</ol>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[java除了AtomicInteger，还有哪些常用的原子类？]]></title>    <link>https://juejin.cn/post/7577722399375933482</link>    <guid>https://juejin.cn/post/7577722399375933482</guid>    <pubDate>2025-11-30T00:19:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577722399375933482" data-draft-id="7577715145121300534" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="java除了AtomicInteger，还有哪些常用的原子类？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-30T00:19:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户34584828505"/> <meta itemprop="url" content="https://juejin.cn/user/3710177917545754"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            java除了AtomicInteger，还有哪些常用的原子类？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3710177917545754/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户34584828505
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T00:19:37.000Z" title="Sun Nov 30 2025 00:19:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 <code>java.util.concurrent.atomic</code> 包中，除了最常用的 <code>AtomicInteger</code>，还有一系列针对不同场景设计的原子类，涵盖 <strong>基本类型、引用类型、字段更新、复合操作</strong> 等，核心均基于 <code>CAS + volatile</code> 实现无锁原子性。以下是 <strong>常用原子类分类详解</strong>，附功能、场景和示例代码：</p>
<h3 data-id="heading-0">一、基本类型原子类（替代基本类型的原子操作）</h3>
<p>与 <code>AtomicInteger</code> 原理一致，针对 <code>long</code>、<code>boolean</code> 等基本类型，提供原子增减、赋值等操作，避免非原子操作（如 <code>long++</code>）的并发问题。</p>





























<table><thead><tr><th>原子类</th><th>核心功能</th><th>适用场景</th><th>关键方法</th></tr></thead><tbody><tr><td><code>AtomicLong</code></td><td>长整型的原子增减、累加、赋值</td><td>大数值计数器（如接口调用量、流量统计）</td><td><code>incrementAndGet()</code>、<code>addAndGet(long delta)</code>、<code>set(long)</code></td></tr><tr><td><code>AtomicBoolean</code></td><td>布尔值的原子切换（true/false）</td><td>状态标记（如 “是否初始化完成”“是否停止”）</td><td><code>compareAndSet(boolean expect, boolean update)</code>、<code>set(boolean)</code></td></tr><tr><td><code>AtomicByte</code>/<code>AtomicShort</code>/<code>AtomicChar</code></td><td>字节、短整型、字符的原子操作</td><td>小范围数值原子更新（如状态码、字符标识）</td><td><code>incrementAndGet()</code>、<code>getAndSet(byte newValue)</code></td></tr></tbody></table>
<h4 data-id="heading-1">示例：<code>AtomicLong</code> 统计接口调用量</h4>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicLong;

<span class="hljs-comment">// 接口调用量统计（高并发下原子计数）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiCounter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">AtomicLong</span> <span class="hljs-variable">callCount</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicLong</span>(<span class="hljs-number">0</span>);

    <span class="hljs-comment">// 原子自增：每次调用接口时执行</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">incrementCallCount</span><span class="hljs-params">()</span> {
        callCount.incrementAndGet(); <span class="hljs-comment">// 等价于 callCount++（原子操作）</span>
    }

    <span class="hljs-comment">// 原子累加：批量统计时使用</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addCallCount</span><span class="hljs-params">(<span class="hljs-type">long</span> batch)</span> {
        callCount.addAndGet(batch); <span class="hljs-comment">// 等价于 callCount += batch（原子操作）</span>
    }

    <span class="hljs-comment">// 获取当前调用量</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getCallCount</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> callCount.get();
    }
}
</code></pre>
<h4 data-id="heading-2">注意事项：</h4>
<ul>
<li><code>AtomicBoolean</code> 无 <code>incrementAndGet()</code> 方法，需通过 <code>compareAndSet</code> 实现状态切换（如 <code>while (!atomicBoolean.compareAndSet(false, true)) {}</code>）。</li>
<li>基本类型原子类均不支持 <code>null</code> 值，初始值默认是 0（数值类型）、<code>false</code>（<code>AtomicBoolean</code>）。</li>
</ul>
<h3 data-id="heading-3">二、引用类型原子类（原子更新对象引用）</h3>
<p>针对 <strong>对象引用</strong> 的原子操作，解决 “原子替换对象”“避免引用修改冲突” 等问题，支持泛型，灵活适配各类对象。</p>





























<table><thead><tr><th>原子类</th><th>核心功能</th><th>适用场景</th><th>核心解决问题</th></tr></thead><tbody><tr><td><code>AtomicReference&lt;V&gt;</code></td><td>引用类型的原子赋值、比较替换</td><td>原子更新对象实例（如单例对象、配置对象）</td><td>避免多线程同时修改引用导致的对象不一致</td></tr><tr><td><code>AtomicStampedReference&lt;V&gt;</code></td><td>带版本号的引用原子类（版本戳 + 引用）</td><td>避免 CAS 中的 ABA 问题（如链表操作、缓存更新）</td><td>解决 “值被修改后又改回原值” 导致的误判</td></tr><tr><td><code>AtomicMarkableReference&lt;V&gt;</code></td><td>带标记位的引用原子类（布尔标记 + 引用）</td><td>只需判断引用是否被修改过（无需版本号）</td><td>简化版 ABA 问题（仅需 “是否修改” 标记）</td></tr></tbody></table>
<h4 data-id="heading-4">1. <code>AtomicReference</code> 示例：原子更新配置对象</h4>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicReference;

<span class="hljs-comment">// 原子更新配置对象（避免多线程修改配置时出现部分更新）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AtomicConfig</span> {
    <span class="hljs-comment">// 配置对象（不可变类，修改时直接替换整个对象）</span>
    <span class="hljs-type">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span> {
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> url;
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> timeout;

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Config</span><span class="hljs-params">(<span class="hljs-type">String</span> url, <span class="hljs-type">int</span> timeout)</span> </span>{
            <span class="hljs-keyword">this</span>.url = url;
            <span class="hljs-keyword">this</span>.timeout = timeout;
        }

        <span class="hljs-comment">// getter 方法（无 setter，保证不可变）</span>
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">String</span> <span class="hljs-title">getUrl</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> url; }
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title">getTimeout</span><span class="hljs-params">()</span> </span>{ <span class="hljs-keyword">return</span> timeout; }
    }

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AtomicReference&lt;Config&gt; configRef = <span class="hljs-keyword">new</span> AtomicReference&lt;&gt;(
        <span class="hljs-keyword">new</span> <span class="hljs-built_in">Config</span>(<span class="hljs-string">"http://default.com"</span>, <span class="hljs-number">5000</span>) <span class="hljs-comment">// 初始配置</span>
    );

    <span class="hljs-comment">// 原子更新配置（替换整个 Config 对象）</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">void</span> <span class="hljs-title">updateConfig</span><span class="hljs-params">(<span class="hljs-type">String</span> newUrl, <span class="hljs-type">int</span> newTimeout)</span> </span>{
        configRef.<span class="hljs-built_in">set</span>(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Config</span>(newUrl, newTimeout)); <span class="hljs-comment">// 原子赋值</span>
    }

    <span class="hljs-comment">// 比较并替换配置（仅当当前配置是预期值时才更新）</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title">compareAndUpdateConfig</span><span class="hljs-params">(Config expect, Config update)</span> </span>{
        <span class="hljs-keyword">return</span> configRef.<span class="hljs-built_in">compareAndSet</span>(expect, update);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> Config <span class="hljs-title">getConfig</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> configRef.<span class="hljs-built_in">get</span>();
    }
}
</code></pre>
<h4 data-id="heading-5">2. <code>AtomicStampedReference</code> 示例：解决 ABA 问题</h4>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-csharp" lang="csharp">import java.util.concurrent.atomic.AtomicStampedReference;

<span class="hljs-comment">// 用 AtomicStampedReference 避免 ABA 问题</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">ABAExample</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        <span class="hljs-comment">// 初始值："A"，版本戳：0</span>
        AtomicStampedReference&lt;String&gt; stampedRef = <span class="hljs-keyword">new</span> AtomicStampedReference&lt;&gt;(<span class="hljs-string">"A"</span>, <span class="hljs-number">0</span>);

        <span class="hljs-comment">// 线程1：尝试将 "A" 改为 "C"（预期版本 0）</span>
        <span class="hljs-keyword">new</span> Thread(() -&gt; {
            <span class="hljs-built_in">int</span> stamp = stampedRef.getStamp(); <span class="hljs-comment">// 获取当前版本戳：0</span>
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"线程1：当前值="</span> + stampedRef.getReference() + <span class="hljs-string">", 版本="</span> + stamp);

            <span class="hljs-comment">// 模拟延迟（让线程2先执行 ABA 操作）</span>
            <span class="hljs-keyword">try</span> { Thread.sleep(<span class="hljs-number">1000</span>); } <span class="hljs-keyword">catch</span> (InterruptedException e) {}

            <span class="hljs-comment">// 比较并替换：预期值 "A"，预期版本 0，更新值 "C"，新版本 1</span>
            boolean success = stampedRef.compareAndSet(<span class="hljs-string">"A"</span>, <span class="hljs-string">"C"</span>, stamp, stamp + <span class="hljs-number">1</span>);
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"线程1：更新是否成功？"</span> + success); <span class="hljs-comment">// 输出 false（版本已变）</span>
        }).start();

        <span class="hljs-comment">// 线程2：执行 ABA 操作（A → B → A）</span>
        <span class="hljs-keyword">new</span> Thread(() -&gt; {
            <span class="hljs-built_in">int</span> stamp = stampedRef.getStamp(); <span class="hljs-comment">// 版本 0</span>
            <span class="hljs-comment">// 1. A → B（版本 0 → 1）</span>
            stampedRef.compareAndSet(<span class="hljs-string">"A"</span>, <span class="hljs-string">"B"</span>, stamp, stamp + <span class="hljs-number">1</span>);
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"线程2：A → B，新版本="</span> + stampedRef.getStamp());

            <span class="hljs-comment">// 2. B → A（版本 1 → 2）</span>
            stamp = stampedRef.getStamp();
            stampedRef.compareAndSet(<span class="hljs-string">"B"</span>, <span class="hljs-string">"A"</span>, stamp, stamp + <span class="hljs-number">1</span>);
            System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"线程2：B → A，新版本="</span> + stampedRef.getStamp());
        }).start();
    }
}
</code></pre>
<ul>
<li>结果：线程 1 延迟后尝试更新时，版本戳已从 0 变为 2，<code>compareAndSet</code> 失败，避免了 ABA 漏洞。</li>
</ul>
<h4 data-id="heading-6">注意事项：</h4>
<ul>
<li><code>AtomicStampedReference</code> 的版本戳是 <code>int</code> 类型（可循环，但需避免频繁溢出），<code>AtomicMarkableReference</code> 的标记位是 <code>boolean</code>（仅需判断 “是否修改”）。</li>
<li>引用类型原子类更新的是 “引用本身”，而非对象内部的字段（若需更新对象字段，用字段更新器原子类）。</li>
</ul>
<h3 data-id="heading-7">三、字段更新器原子类（原子更新对象字段）</h3>
<p>无需修改原有类的代码（无需让字段成为 <code>volatile</code> 或原子类），通过 <strong>反射机制</strong> 原子更新对象的实例字段或静态字段，适用于 “无法修改原有类” 的场景（如第三方库类）。</p>





























<table><thead><tr><th>原子类</th><th>核心功能</th><th>适用场景</th><th>关键限制</th></tr></thead><tbody><tr><td><code>AtomicIntegerFieldUpdater</code></td><td>原子更新对象的 <code>int</code> 类型字段</td><td>第三方类的 <code>int</code> 字段原子增减</td><td>字段必须是 <code>volatile</code>（否则报错）、非 final</td></tr><tr><td><code>AtomicLongFieldUpdater</code></td><td>原子更新对象的 <code>long</code> 类型字段</td><td>第三方类的 <code>long</code> 字段原子累加</td><td>同上</td></tr><tr><td><code>AtomicReferenceFieldUpdater&lt;V, T&gt;</code></td><td>原子更新对象的引用类型字段</td><td>第三方类的引用字段原子替换</td><td>字段必须是 <code>volatile</code>、非 final、非 private</td></tr></tbody></table>
<h4 data-id="heading-8">示例：<code>AtomicIntegerFieldUpdater</code> 更新第三方类字段</h4>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-csharp" lang="csharp">import java.util.concurrent.atomic.AtomicIntegerFieldUpdater;

<span class="hljs-comment">// 第三方类（无法修改源码，字段是 volatile int）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title">ThirdPartyClass</span> {
    <span class="hljs-keyword">volatile</span> <span class="hljs-built_in">int</span> count; <span class="hljs-comment">// 必须是 volatile（否则更新器无法工作）</span>

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">ThirdPartyClass</span>(<span class="hljs-params"><span class="hljs-built_in">int</span> count</span>)</span> {
        <span class="hljs-keyword">this</span>.count = count;
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-built_in">int</span> <span class="hljs-title">getCount</span>()</span> {
        <span class="hljs-keyword">return</span> count;
    }
}

<span class="hljs-comment">// 用字段更新器原子操作第三方类的 count 字段</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">FieldUpdaterExample</span> {
    <span class="hljs-comment">// 1. 创建字段更新器：指定目标类、字段名</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> final AtomicIntegerFieldUpdater&lt;ThirdPartyClass&gt; COUNT_UPDATER =
        AtomicIntegerFieldUpdater.newUpdater(ThirdPartyClass.<span class="hljs-keyword">class</span>, <span class="hljs-string">"count"</span>);

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span>(<span class="hljs-params">String[] args</span>)</span> {
        ThirdPartyClass obj = <span class="hljs-keyword">new</span> ThirdPartyClass(<span class="hljs-number">10</span>);

        <span class="hljs-comment">// 2. 原子自增（count = 10 → 11）</span>
        COUNT_UPDATER.incrementAndGet(obj);
        System.<span class="hljs-keyword">out</span>.println(obj.getCount()); <span class="hljs-comment">// 输出 11</span>

        <span class="hljs-comment">// 3. 原子累加（count = 11 → 14）</span>
        COUNT_UPDATER.addAndGet(obj, <span class="hljs-number">3</span>);
        System.<span class="hljs-keyword">out</span>.println(obj.getCount()); <span class="hljs-comment">// 输出 14</span>

        <span class="hljs-comment">// 4. 比较并替换（预期 14 → 更新为 20）</span>
        boolean success = COUNT_UPDATER.compareAndSet(obj, <span class="hljs-number">14</span>, <span class="hljs-number">20</span>);
        System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"替换是否成功？"</span> + success); <span class="hljs-comment">// 输出 true</span>
        System.<span class="hljs-keyword">out</span>.println(obj.getCount()); <span class="hljs-comment">// 输出 20</span>
    }
}
</code></pre>
<h4 data-id="heading-9">注意事项：</h4>
<ul>
<li>目标字段必须是 <code>volatile</code>（保证可见性，否则 JVM 会抛出 <code>IllegalArgumentException</code>）。</li>
<li>字段不能是 <code>final</code>（final 字段不可修改，更新器无法操作）。</li>
<li>字段访问权限：若字段是 <code>private</code>，更新器无法通过反射访问（需字段是 <code>public</code>、<code>protected</code> 或同一包下的默认访问权限）。</li>
</ul>
<h3 data-id="heading-10">四、数组类型原子类（原子更新数组元素）</h3>
<p>针对数组元素的原子操作，支持 <code>int</code>、<code>long</code>、<code>reference</code> 类型数组，避免多线程修改数组元素时的并发冲突。</p>





























<table><thead><tr><th>原子类</th><th>核心功能</th><th>适用场景</th><th>关键方法</th></tr></thead><tbody><tr><td><code>AtomicIntegerArray</code></td><td>原子更新 <code>int[]</code> 数组的元素</td><td>原子计数器数组、分布式 ID 生成器数组</td><td><code>getAndIncrement(int index)</code>、<code>compareAndSet(int index, int expect, int update)</code></td></tr><tr><td><code>AtomicLongArray</code></td><td>原子更新 <code>long[]</code> 数组的元素</td><td>大数据量统计数组（如分桶计数）</td><td>同上（参数为 long 类型）</td></tr><tr><td><code>AtomicReferenceArray&lt;V&gt;</code></td><td>原子更新引用类型数组的元素</td><td>原子更新对象数组（如缓存数组）</td><td><code>set(int index, V newValue)</code>、<code>compareAndSet(...)</code></td></tr></tbody></table>
<h4 data-id="heading-11">示例：<code>AtomicIntegerArray</code> 分桶原子计数</h4>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.atomic.AtomicIntegerArray;

<span class="hljs-comment">// 分桶原子计数器（将统计对象按哈希分桶，提升并发性能）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AtomicArrayCounter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AtomicIntegerArray bucketCounts;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> bucketSize; <span class="hljs-comment">// 分桶数量</span>

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">AtomicArrayCounter</span><span class="hljs-params">(<span class="hljs-type">int</span> bucketSize)</span> {
        <span class="hljs-built_in">this</span>.bucketSize = bucketSize;
        <span class="hljs-built_in">this</span>.bucketCounts = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicIntegerArray</span>(bucketSize); <span class="hljs-comment">// 初始值全为 0</span>
    }

    <span class="hljs-comment">// 根据 key 的哈希值选择分桶，原子自增</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">(String key)</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">bucketIndex</span> <span class="hljs-operator">=</span> Math.abs(key.hashCode()) % bucketSize;
        bucketCounts.getAndIncrement(bucketIndex); <span class="hljs-comment">// 原子自增对应桶的计数</span>
    }

    <span class="hljs-comment">// 统计所有桶的总计数</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getTotalCount</span><span class="hljs-params">()</span> {
        <span class="hljs-type">int</span> <span class="hljs-variable">total</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; bucketSize; i++) {
            total += bucketCounts.get(i);
        }
        <span class="hljs-keyword">return</span> total;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">AtomicArrayCounter</span> <span class="hljs-variable">counter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AtomicArrayCounter</span>(<span class="hljs-number">10</span>); <span class="hljs-comment">// 10个分桶</span>

        <span class="hljs-comment">// 多线程并发计数</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; counter.increment(<span class="hljs-string">"key-"</span> + Math.random())).start();
        }

        <span class="hljs-comment">// 等待所有线程执行完成</span>
        <span class="hljs-keyword">try</span> { Thread.sleep(<span class="hljs-number">1000</span>); } <span class="hljs-keyword">catch</span> (InterruptedException e) {}

        System.out.println(<span class="hljs-string">"总计数："</span> + counter.getTotalCount()); <span class="hljs-comment">// 输出约 1000（原子性保证准确）</span>
    }
}
</code></pre>
<h4 data-id="heading-12">注意事项：</h4>
<ul>
<li>数组长度固定（创建后无法扩容），需提前规划分桶数量（如根据并发量设置合理桶数，减少冲突）。</li>
<li>数组元素的原子操作仅针对 “单个索引”，多个索引的操作不保证原子性（如同时修改索引 0 和 1，需额外同步）。</li>
</ul>
<h3 data-id="heading-13">五、复合操作原子类（JDK 8+ 新增，支持复杂原子逻辑）</h3>
<p>JDK 8 引入的 <code>DoubleAccumulator</code>、<code>LongAccumulator</code> 等，支持 <strong>自定义复合原子操作</strong>（如累加、最大值计算、自定义函数），性能比 <code>AtomicLong</code> 更优（高并发下分散竞争）。</p>



































<table><thead><tr><th>原子类</th><th>核心功能</th><th>适用场景</th><th>核心优势</th></tr></thead><tbody><tr><td><code>LongAccumulator</code></td><td>基于函数的长整型原子累加 / 复合操作</td><td>复杂统计（如最大值、最小值、自定义聚合）</td><td>支持自定义 <code>LongBinaryOperator</code>，高并发下性能更优</td></tr><tr><td><code>DoubleAccumulator</code></td><td>基于函数的双精度浮点型原子复合操作</td><td>浮点型数据统计（如平均响应时间）</td><td>同上（支持 <code>DoubleBinaryOperator</code>）</td></tr><tr><td><code>LongAdder</code></td><td>长整型原子累加（<code>AtomicLong</code> 的高性能替代）</td><td>高并发计数器（如 QPS 统计）</td><td>内部分桶存储，减少 CAS 冲突，高并发下性能远超 <code>AtomicLong</code></td></tr><tr><td><code>DoubleAdder</code></td><td>双精度浮点型原子累加</td><td>浮点型计数器（如流量统计）</td><td>同上</td></tr></tbody></table>
<h4 data-id="heading-14">示例：<code>LongAdder</code> 高并发计数器（替代 <code>AtomicLong</code>）</h4>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.atomic.LongAdder;

<span class="hljs-comment">// 高并发计数器：LongAdder 性能优于 AtomicLong（分桶减少冲突）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HighConcurrencyCounter</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">LongAdder</span> <span class="hljs-variable">adder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LongAdder</span>();

    <span class="hljs-comment">// 原子自增（内部分桶，高并发下冲突更少）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">increment</span><span class="hljs-params">()</span> {
        adder.increment();
    }

    <span class="hljs-comment">// 原子累加</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">long</span> delta)</span> {
        adder.add(delta);
    }

    <span class="hljs-comment">// 获取总数（合并所有分桶的计数）</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">getCount</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> adder.sum();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException {
        <span class="hljs-type">HighConcurrencyCounter</span> <span class="hljs-variable">counter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HighConcurrencyCounter</span>();

        <span class="hljs-comment">// 1000 个线程，每个线程自增 1000 次</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; {
                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; j &lt; <span class="hljs-number">1000</span>; j++) {
                    counter.increment();
                }
            }).start();
        }

        Thread.sleep(<span class="hljs-number">2000</span>);
        System.out.println(<span class="hljs-string">"总计数："</span> + counter.getCount()); <span class="hljs-comment">// 输出 1000000（准确）</span>
    }
}
</code></pre>
<h4 data-id="heading-15">示例：<code>LongAccumulator</code> 计算最大值</h4>
<p>java</p>
<p>运行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> java.util.concurrent.atomic.LongAccumulator;

<span class="hljs-comment">// 用 LongAccumulator 原子计算最大值</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MaxValueCalculator</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-comment">// 自定义函数：取两个数的最大值（LongBinaryOperator）</span>
        <span class="hljs-type">LongAccumulator</span> <span class="hljs-variable">maxAccumulator</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LongAccumulator</span>(
            (x, y) -&gt; Math.max(x, y), <span class="hljs-comment">// 累加器函数</span>
            Long.MIN_VALUE <span class="hljs-comment">// 初始值</span>
        );

        <span class="hljs-comment">// 多线程并发更新最大值</span>
        <span class="hljs-type">long</span>[] values = {<span class="hljs-number">10</span>, <span class="hljs-number">20</span>, <span class="hljs-number">5</span>, <span class="hljs-number">30</span>, <span class="hljs-number">15</span>};
        <span class="hljs-keyword">for</span> (<span class="hljs-type">long</span> val : values) {
            <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(() -&gt; maxAccumulator.accumulate(val)).start();
        }

        <span class="hljs-comment">// 等待所有线程执行完成</span>
        <span class="hljs-keyword">try</span> { Thread.sleep(<span class="hljs-number">1000</span>); } <span class="hljs-keyword">catch</span> (InterruptedException e) {}

        System.out.println(<span class="hljs-string">"最大值："</span> + maxAccumulator.get()); <span class="hljs-comment">// 输出 30</span>
    }
}
</code></pre>
<h4 data-id="heading-16">注意事项：</h4>
<ul>
<li><code>LongAdder</code>/<code>DoubleAdder</code> 的 <code>sum()</code> 方法是 “最终一致性”（合并分桶时可能有短暂不一致），适合 “最终统计” 场景（如 QPS 统计），不适合 “实时精确读取”（如事务计数）。</li>
<li>复合操作原子类仅支持 “累加 / 聚合” 类逻辑，复杂复合操作（如 “先判断再更新”）仍需结合锁或其他工具。</li>
</ul>
<h3 data-id="heading-17">六、常用原子类选择总结</h3>













































<table><thead><tr><th>场景类型</th><th>推荐原子类</th><th>替代方案</th></tr></thead><tbody><tr><td>单变量 <code>int</code>/<code>long</code> 计数</td><td><code>AtomicInteger</code>/<code>AtomicLong</code></td><td>高并发用 <code>LongAdder</code>/<code>DoubleAdder</code></td></tr><tr><td>布尔状态标记</td><td><code>AtomicBoolean</code></td><td><code>AtomicReference&lt;Boolean&gt;</code></td></tr><tr><td>原子更新对象引用</td><td><code>AtomicReference</code></td><td>需避免 ABA 用 <code>AtomicStampedReference</code></td></tr><tr><td>第三方类字段原子更新</td><td><code>AtomicIntegerFieldUpdater</code> 等</td><td>无法修改字段时的唯一选择</td></tr><tr><td>数组元素原子操作</td><td><code>AtomicIntegerArray</code> 等</td><td>手动加锁（性能差）</td></tr><tr><td>复杂聚合操作（最大值 / 自定义）</td><td><code>LongAccumulator</code>/<code>DoubleAccumulator</code></td><td>锁 + 普通变量（代码繁琐）</td></tr><tr><td>高并发计数器（QPS / 流量）</td><td><code>LongAdder</code></td><td><code>AtomicLong</code>（低并发可用）</td></tr></tbody></table>
<p><strong>核心原则</strong>：</p>
<ol>
<li>简单计数 / 状态切换：优先用 <code>AtomicInteger</code>/<code>AtomicBoolean</code>（API 简洁，无学习成本）。</li>
<li>高并发计数：用 <code>LongAdder</code>（分桶减少冲突，性能最优）。</li>
<li>引用原子替换：用 <code>AtomicReference</code>（普通场景）或 <code>AtomicStampedReference</code>（ABA 问题）。</li>
<li>第三方类字段更新：用字段更新器原子类（无需修改源码）。</li>
<li>复杂聚合逻辑：用 <code>LongAccumulator</code>/<code>DoubleAccumulator</code>（自定义函数，灵活高效）。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第29篇：99% 的量化新手死在挂单上：Freqtrade 隐藏技能揭秘]]></title>    <link>https://juejin.cn/post/7577797563853094948</link>    <guid>https://juejin.cn/post/7577797563853094948</guid>    <pubDate>2025-11-30T00:23:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577797563853094948" data-draft-id="7577722399375900714" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第29篇：99% 的量化新手死在挂单上：Freqtrade 隐藏技能揭秘"/> <meta itemprop="keywords" content="Python,后端,GitHub"/> <meta itemprop="datePublished" content="2025-11-30T00:23:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端伪大叔"/> <meta itemprop="url" content="https://juejin.cn/user/3702810894146151"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第29篇：99% 的量化新手死在挂单上：Freqtrade 隐藏技能揭秘
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3702810894146151/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端伪大叔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T00:23:19.000Z" title="Sun Nov 30 2025 00:23:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">第29篇：99% 的量化新手死在挂单上：Freqtrade 隐藏技能揭秘</h2>
<p>Freqtrade 在挂单模型中提供了两个关键功能：</p>
<ul>
<li><code>adjust_entry_price</code>：仅在新建订单（首次买入）时，用于修改挂单价格。</li>
<li><code>adjust_order_price</code>：用于控制 <strong>所有挂单</strong> 的价格，包括出场、加仓、减仓</li>
</ul>
<p>合理使用这些控制点，可以最大化降低滑点，控制分段进场，进而提升策略维度和强度。</p>
<h3 data-id="heading-1">🚀 想学量化交易？</h3>
<p>👉 <strong>点击访问：<a href="https://link.juejin.cn?target=https%3A%2F%2Fitrade.icu%2F" target="_blank" title="https://itrade.icu/" ref="nofollow noopener noreferrer">itrade.icu</a></strong>
这里有 <strong>Freqtrade 基础教程</strong>、<strong>策略源码</strong>、<strong>指标解析</strong> 等丰富内容，助你轻松掌握量化交易技巧！</p>
<blockquote>
<p>挂单细节决定胜负：Freqtrade 自定义价格策略完全指南</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">🎯函数作用概览</h3>




















<table><thead><tr><th>函数名</th><th>作用描述</th><th>使用时机</th></tr></thead><tbody><tr><td><code>adjust_entry_price</code></td><td>修改首次建仓时挂单价格（只调用一次）</td><td>✅ <strong>首次买入</strong></td></tr><tr><td><code>adjust_order_price</code></td><td>对所有订单（买入、卖出）统一调整价格</td><td>✅ <strong>每次下单都调用</strong></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-3">🧠 adjust_entry_price - 首次建仓专用</h3>
<p>该函数<strong>只在策略首次生成交易信号并准备下单建仓时被调用一次</strong>，你可以在这里动态调整挂单价格，例如控制滑点、下浮买入价等。</p>
<h4 data-id="heading-4">✅ 使用场景</h4>
<ul>
<li>想让首次买入价格更“谨慎”，例如：
<ul>
<li>向下压一点点再挂单（防止追涨）</li>
<li>基于盘口价做微调</li>
</ul>
</li>
</ul>
<h4 data-id="heading-5">🧪 示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">adjust_entry_price</span>(<span class="hljs-params">self, pair: <span class="hljs-built_in">str</span>, order_type: <span class="hljs-built_in">str</span>, current_rate: <span class="hljs-built_in">float</span>, proposed_rate: <span class="hljs-built_in">float</span>, **kwargs</span>) -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-comment"># 往下调整 0.5% 挂单价格</span>
    adjusted_price = proposed_rate * <span class="hljs-number">0.995</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"[adjust_entry_price] 原始挂单价: <span class="hljs-subst">{proposed_rate}</span>，调整后: <span class="hljs-subst">{adjusted_price}</span>"</span>)
    <span class="hljs-keyword">return</span> adjusted_price
</code></pre>
<h4 data-id="heading-6">⚠️ 注意</h4>
<ul>
<li><strong>只在首次建仓时触发</strong>，不适用于加仓/减仓</li>
<li>返回的是你希望挂出的价格</li>
</ul>
<hr/>
<h3 data-id="heading-7">🛠 adjust_order_price - 全局挂单价格钩子</h3>
<p>这是一个更强大的挂单控制函数，<strong>无论是买入还是卖出，都会经过它</strong>。</p>
<h4 data-id="heading-8">✅ 使用场景</h4>
<ul>
<li>所有挂单统一加/减价格，例如：
<ul>
<li>所有买入挂低一点（滑点保护）</li>
<li>所有卖出挂高一点（套利空间）</li>
</ul>
</li>
<li>卖出时根据当前盘口价动态挂单</li>
</ul>
<h4 data-id="heading-9">🧪 示例代码</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">adjust_order_price</span>(<span class="hljs-params">self, pair: <span class="hljs-built_in">str</span>, is_buy: <span class="hljs-built_in">bool</span>, current_price: <span class="hljs-built_in">float</span>, proposed_price: <span class="hljs-built_in">float</span>, **kwargs</span>) -&gt; <span class="hljs-built_in">float</span>:
    <span class="hljs-keyword">if</span> is_buy:
        <span class="hljs-comment"># 买入时往下压0.3%</span>
        <span class="hljs-keyword">return</span> proposed_price * <span class="hljs-number">0.997</span>
    <span class="hljs-keyword">else</span>:
        <span class="hljs-comment"># 卖出时往上抬0.3%</span>
        <span class="hljs-keyword">return</span> proposed_price * <span class="hljs-number">1.003</span>
</code></pre>
<hr/>
<h3 data-id="heading-10">🔍 两个函数的区别与联系</h3>






























<table><thead><tr><th>比较项</th><th><code>adjust_entry_price</code></th><th><code>adjust_order_price</code></th></tr></thead><tbody><tr><td>被调用时机</td><td>仅首次建仓买入</td><td>所有订单（包括买入和卖出）</td></tr><tr><td>可控制方向</td><td>仅限买入</td><td>买入 + 卖出</td></tr><tr><td>控制范围</td><td>建仓价</td><td>全部订单价格</td></tr><tr><td>推荐组合使用方式</td><td>✔ 首次建仓时：用 <code>adjust_entry_price</code> 控制更细致的入场价格</td><td>✔ 所有订单：用 <code>adjust_order_price</code> 做统一价格控制</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-11">📌 补充说明：你可能以为能用，实际不能的地方</h3>

























<table><thead><tr><th>场景</th><th>是否会调用 <code>adjust_entry_price</code>？</th><th>推荐做法</th></tr></thead><tbody><tr><td>第一次买入建仓</td><td>✅ 会调用</td><td>用来调整初始挂单价</td></tr><tr><td>加仓（已有仓位再买）</td><td>❌ 不会调用</td><td>使用 <code>adjust_trade_position</code></td></tr><tr><td>卖出止盈/止损</td><td>❌ 不会调用</td><td>使用 <code>custom_exit_price</code> 或 <code>adjust_order_price</code></td></tr></tbody></table>
<hr/>
<h3 data-id="heading-12">✅ 最佳实践建议</h3>
<ul>
<li><strong>用 <code>adjust_entry_price</code> 控制首次建仓挂单价</strong></li>
<li><strong>用 <code>adjust_order_price</code> 控制所有订单滑点保护</strong></li>
<li><strong>结合 <code>custom_exit_price</code> 精准控制卖出价格</strong></li>
<li><strong>不要试图在 <code>adjust_entry_price</code> 中实现加仓逻辑，Freqtrade 不会再调用它</strong></li>
</ul>
<h4 data-id="heading-13">📘 最简动量策略案例（适合入门）</h4>
<p>这是一个<strong>基于价格动量的入门策略</strong>，策略核心逻辑：</p>
<blockquote>
<p>📈 当前K线的收盘价高于前一根K线 → 生成买入信号<br/>
📉 当前K线的收盘价低于前一根K线 → 生成卖出信号</p>
</blockquote>
<p>同时结合了 Freqtrade 提供的订单价格控制功能：</p>
<ul>
<li><code>adjust_entry_price</code>：首次建仓时挂单价下调 0.5%</li>
<li><code>adjust_order_price</code>：统一滑点控制（买入 -0.3%，卖出 +0.3%）</li>
<li><code>custom_exit_price</code>：卖出挂比当前价格高 0.2%</li>
</ul>
<hr/>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> freqtrade.strategy.interface <span class="hljs-keyword">import</span> IStrategy
<span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">from</span> pandas <span class="hljs-keyword">import</span> DataFrame

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ExampleStrategy</span>(<span class="hljs-title class_ inherited__">IStrategy</span>):
    <span class="hljs-string">"""
    示例策略：基于收盘价是否上涨来决定是否买入。
    """</span>
    timeframe = <span class="hljs-string">'5m'</span>

    order_types = {
        <span class="hljs-string">'entry'</span>: <span class="hljs-string">'limit'</span>,
        <span class="hljs-string">'exit'</span>: <span class="hljs-string">'limit'</span>,
        <span class="hljs-string">'stoploss'</span>: <span class="hljs-string">'market'</span>,
    }

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">populate_indicators</span>(<span class="hljs-params">self, dataframe: DataFrame, metadata: <span class="hljs-built_in">dict</span></span>) -&gt; DataFrame:
        <span class="hljs-comment"># 没有使用额外指标</span>
        <span class="hljs-keyword">return</span> dataframe

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">populate_entry_trend</span>(<span class="hljs-params">self, dataframe: DataFrame, metadata: <span class="hljs-built_in">dict</span></span>) -&gt; DataFrame:
        <span class="hljs-string">"""
        当当前K线收盘价高于上一根K线 → 生成买入信号
        """</span>
        dataframe[<span class="hljs-string">'enter_long'</span>] = dataframe[<span class="hljs-string">'close'</span>] &gt; dataframe[<span class="hljs-string">'close'</span>].shift(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">return</span> dataframe

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">populate_exit_trend</span>(<span class="hljs-params">self, dataframe: DataFrame, metadata: <span class="hljs-built_in">dict</span></span>) -&gt; DataFrame:
        <span class="hljs-string">"""
        当当前K线收盘价低于上一根K线 → 生成卖出信号
        """</span>
        dataframe[<span class="hljs-string">'exit_long'</span>] = dataframe[<span class="hljs-string">'close'</span>] &lt; dataframe[<span class="hljs-string">'close'</span>].shift(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">return</span> dataframe

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">adjust_entry_price</span>(<span class="hljs-params">self, pair: <span class="hljs-built_in">str</span>, order_type: <span class="hljs-built_in">str</span>, current_rate: <span class="hljs-built_in">float</span>,proposed_rate: <span class="hljs-built_in">float</span>, **kwargs</span>) -&gt; <span class="hljs-built_in">float</span>:
        <span class="hljs-string">"""
        首次建仓时，挂单价格下调 0.5%
        """</span>
        <span class="hljs-keyword">return</span> proposed_rate * <span class="hljs-number">0.995</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">adjust_order_price</span>(<span class="hljs-params">self, pair: <span class="hljs-built_in">str</span>, is_buy: <span class="hljs-built_in">bool</span>, current_price: <span class="hljs-built_in">float</span>,proposed_price: <span class="hljs-built_in">float</span>, **kwargs</span>) -&gt; <span class="hljs-built_in">float</span>:
        <span class="hljs-string">"""
        所有订单统一滑点保护：买入 -0.3%，卖出 +0.3%
        """</span>
        <span class="hljs-keyword">return</span> proposed_price * (<span class="hljs-number">0.997</span> <span class="hljs-keyword">if</span> is_buy <span class="hljs-keyword">else</span> <span class="hljs-number">1.003</span>)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">custom_exit_price</span>(<span class="hljs-params">self, pair: <span class="hljs-built_in">str</span>, trade, current_time, current_rate, **kwargs</span>) -&gt; <span class="hljs-built_in">float</span>:
        <span class="hljs-string">"""
        卖出挂单价格比当前价格高 0.2%
        """</span>
        <span class="hljs-keyword">return</span> current_rate * <span class="hljs-number">1.002</span>
</code></pre>
<hr/>
<h3 data-id="heading-14">🧾 总结</h3>
<ul>
<li><code>adjust_entry_price</code> 和 <code>adjust_order_price</code> 是 Freqtrade 在限价挂单机制中最关键的两个控制钩子：
<ul>
<li><code>adjust_entry_price</code>：只会在首次建仓时调用一次，用于精细控制第一次买入挂单价。</li>
</ul>
</li>
</ul>
<ul>
<li><code>adjust_order_price</code>：每次下单都会调用，适用于买入、卖出、加仓、减仓、止盈、止损等所有订单。</li>
</ul>
<ul>
<li>通过合理组合使用这两个函数，你可以：
<ul>
<li>避免在高位追单、有效防止滑点；</li>
<li>动态挂单、让策略更智能；</li>
<li>精准控制卖出价，提升利润空间。</li>
</ul>
</li>
<li>📌 实战建议：
<ul>
<li>想控制首次入场更稳健：使用 <code>adjust_entry_price</code></li>
<li>想控制所有订单滑点：使用 adjust_order_price</li>
<li>想控制卖出时的目标价格：再配合 <code>custom_exit_price</code> 更完美</li>
<li>当你能熟练运用这三者组合，一个专业级的挂单策略就已具备雏形。</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[别再瞎折腾 LangChain 了：从 0 到 1 搭建 RAG 知识库的架构决策实录]]></title>    <link>https://juejin.cn/post/7577737385954590730</link>    <guid>https://juejin.cn/post/7577737385954590730</guid>    <pubDate>2025-11-30T04:51:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577737385954590730" data-draft-id="7577971299742531622" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="别再瞎折腾 LangChain 了：从 0 到 1 搭建 RAG 知识库的架构决策实录"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-30T04:51:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Java私教"/> <meta itemprop="url" content="https://juejin.cn/user/3394924618197325"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            别再瞎折腾 LangChain 了：从 0 到 1 搭建 RAG 知识库的架构决策实录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3394924618197325/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Java私教
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T04:51:39.000Z" title="Sun Nov 30 2025 04:51:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>前言</strong>：最近在帮一家做医疗器械的客户落地企业级知识库（RAG）。项目初期，团队陷入了严重的“工具崇拜”——上来就想用 LangChain + Pinecone + OpenAI 的全家桶。
结果呢？开发两周，Demo 很酷炫，一上实战（私有化部署、数据合规、成本控制）直接崩盘。
这篇文章不聊那些虚头巴脑的概念，只复盘我们是如何在 <strong>TRAE SOLO</strong> 的辅助下，重新进行架构选型，并最终用极其精简的代码落地一套高可用 RAG 系统的。</p>
</blockquote>
<h2 data-id="heading-0">为什么你的 RAG 系统总是“听不懂人话”？</h2>
<p>做过知识库的同学应该都有过这种绝望时刻：
用户问：“我们公司去年的差旅报销标准是多少？”
你的 RAG 机器人自信地回答：“根据维基百科，差旅费是指...” 或者干脆一本正经地胡说八道。</p>
<p>这不是因为模型笨，而是<strong>架构选型出了大问题</strong>。</p>
<p>传统的 RAG 开发流通常是这样的：</p>
<ol>
<li>写一堆 Python 脚本切分文档（Chunking）。</li>
<li>调 OpenAI API 跑 Embedding。</li>
<li>存入向量数据库。</li>
<li>用 LangChain 拼凑检索链。</li>
</ol>
<p>这个流程最大的痛点在于<strong>割裂</strong>。你写代码的时候不知道文档切分得对不对，调优 Prompt 的时候不知道检索召回率是多少。整个过程像是在盲人摸象。</p>
<p>而在这次重构中，我们尝试引入了 <strong>TRAE SOLO</strong> 这种 AI 原生 IDE，它给我们的架构决策带来了全新的视角：<strong>可视化调试与上下文感知</strong>。</p>
<h2 data-id="heading-1">核心思路：让 IDE 成为你的“架构参谋”</h2>
<p>RAG 的本质其实就三步：<strong>切分（Indexing） -&gt; 检索（Retrieval） -&gt; 生成（Generation）</strong>。</p>
<p>但在企业级落地中，每一步都是坑：</p>
<ul>
<li><strong>切分</strong>：按字符切？按语义切？还是按 Markdown 结构切？</li>
<li><strong>检索</strong>：单纯的向量相似度（Cosine Similarity）够吗？要不要加关键词混合检索（Hybrid Search）？</li>
<li><strong>生成</strong>：Prompt 怎么写才能防止模型产生幻觉？</li>
</ul>
<p>与其我们拍脑袋决策，不如让工具帮我们做实验。我们利用 TRAE SOLO 的 <code>SOLO Coder</code> 模式，快速生成了不同技术方案的对比原型，并通过 <code>DiffView</code> 直观地看到不同切分策略对检索结果的影响。</p>
<p>这种“测试驱动架构”（TDA）的模式，让我们在代码还没写几行的时候，就排除了 80% 的错误路径。</p>
<h2 data-id="heading-2">实战演示：手撸一个极简 RAG 内核</h2>
<p>为了展示核心逻辑，我们抛弃笨重的框架，用纯 Python + ChromaDB + DeepSeek API 实现一个轻量级 RAG。</p>
<h3 data-id="heading-3">1. 环境依赖</h3>
<pre><code class="hljs language-bash" lang="bash">pip install chromadb openai jieba
</code></pre>
<h3 data-id="heading-4">2. 智能文档切分器</h3>
<p>不要迷信 LangChain 的 <code>CharacterTextSplitter</code>。对于中文企业文档，基于<strong>结构化</strong>的切分才是王道。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> re

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MarkdownSplitter</span>:
    <span class="hljs-string">"""
    针对企业 Wiki/文档 优化的 Markdown 切分器
    保留标题层级，防止上下文丢失
    """</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, chunk_size=<span class="hljs-number">500</span></span>):
        self.chunk_size = chunk_size

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">split_text</span>(<span class="hljs-params">self, text</span>):
        <span class="hljs-comment"># 使用正则表达式匹配 Markdown 标题 (##, ###)</span>
        headers = re.split(<span class="hljs-string">r'(^#+ .+$)'</span>, text, flags=re.MULTILINE)
        chunks = []
        current_chunk = <span class="hljs-string">""</span>
        
        <span class="hljs-keyword">for</span> part <span class="hljs-keyword">in</span> headers:
            <span class="hljs-comment"># 如果加上这一段超过了 chunk_size，就先切一刀</span>
            <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(current_chunk) + <span class="hljs-built_in">len</span>(part) &gt; self.chunk_size:
                <span class="hljs-keyword">if</span> current_chunk:
                    chunks.append(current_chunk.strip())
                current_chunk = part
            <span class="hljs-keyword">else</span>:
                current_chunk += <span class="hljs-string">"\n"</span> + part
                
        <span class="hljs-keyword">if</span> current_chunk:
            chunks.append(current_chunk.strip())
            
        <span class="hljs-keyword">return</span> chunks

<span class="hljs-comment"># 模拟一段企业文档</span>
doc_content = <span class="hljs-string">"""
# 差旅报销制度
## 1. 适用范围
本制度适用于全职员工...
## 2. 报销标准
一线城市每日补贴 300 元，二线城市 200 元。
"""</span>

splitter = MarkdownSplitter()
chunks = splitter.split_text(doc_content)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 成功切分为 <span class="hljs-subst">{<span class="hljs-built_in">len</span>(chunks)}</span> 个片段"</span>)
<span class="hljs-comment"># 此时 TRAE SOLO 的变量查看器能让你清晰看到每个 chunk 的内容，避免切断关键语义</span>
</code></pre>
<h3 data-id="heading-5">3. 向量检索与生成</h3>
<p>这里我们使用 <code>chromadb</code> 作为轻量级向量库，它无需 Docker 即可运行，非常适合中小型项目。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> chromadb
<span class="hljs-keyword">from</span> chromadb.utils <span class="hljs-keyword">import</span> embedding_functions

<span class="hljs-comment"># 初始化本地向量库</span>
client = chromadb.PersistentClient(path=<span class="hljs-string">"./knowledge_db"</span>)
<span class="hljs-comment"># 使用开源的 sentence-transformers 模型，免费且效果不错</span>
emb_fn = embedding_functions.SentenceTransformerEmbeddingFunction(
    model_name=<span class="hljs-string">"paraphrase-multilingual-MiniLM-L12-v2"</span>
)

collection = client.get_or_create_collection(
    name=<span class="hljs-string">"policy_docs"</span>,
    embedding_function=emb_fn
)

<span class="hljs-comment"># 1. 写入数据</span>
ids = [<span class="hljs-string">f"doc_<span class="hljs-subst">{i}</span>"</span> <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-built_in">len</span>(chunks))]
collection.add(documents=chunks, ids=ids)

<span class="hljs-comment"># 2. 检索逻辑</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">query_knowledge_base</span>(<span class="hljs-params">question</span>):
    results = collection.query(
        query_texts=[question],
        n_results=<span class="hljs-number">2</span> <span class="hljs-comment"># 只取最相关的 2 条</span>
    )
    <span class="hljs-keyword">return</span> results[<span class="hljs-string">'documents'</span>][<span class="hljs-number">0</span>]

<span class="hljs-comment"># 3. 生成回答 (伪代码，对接 DeepSeek/OpenAI)</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_answer</span>(<span class="hljs-params">question, context</span>):
    prompt = <span class="hljs-string">f"""
    你是一个专业的企业助手。请基于以下上下文回答问题。
    如果上下文中没有答案，请直接说“我不知道”。
    
    上下文：
    <span class="hljs-subst">{context}</span>
    
    问题：<span class="hljs-subst">{question}</span>
    """</span>
    <span class="hljs-comment"># return call_llm_api(prompt) </span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"构建的 Prompt:"</span>, prompt)

<span class="hljs-comment"># --- 测试 ---</span>
q = <span class="hljs-string">"去上海出差每天补多少钱？"</span>
retrieved_docs = query_knowledge_base(q)
generate_answer(q, retrieved_docs)
</code></pre>
<h2 data-id="heading-6">避坑指南：架构师的血泪经验</h2>
<p>代码跑通很简单，但要上生产环境，这三个坑你必须得填：</p>
<h3 data-id="heading-7">1. 脏数据比烂模型更可怕</h3>
<p>很多开发者把精力花在微调模型上，却忽略了<strong>源数据的清洗</strong>。
我们在 TRAE SOLO 中对比发现，PDF 解析出来的乱码、页眉页脚的干扰字符，会让检索准确率下降 30% 以上。
<strong>建议</strong>：在 Embedding 之前，务必增加一个 ETL（Extract, Transform, Load）环节，专门处理换行符、去除无意义的特殊符号。</p>
<h3 data-id="heading-8">2. 警惕“上下文窗口爆炸”</h3>
<p>现在的模型支持 128k 甚至 1M 的 Context，很多人就懒了，直接把检索到的 100 个片段全塞进去。
这不仅费钱，还会导致“迷失中间”（Lost in the Middle）现象——模型记住了开头和结尾，却忘了中间的关键信息。
<strong>建议</strong>：严格控制 <code>n_results</code>，并引入 Re-rank（重排序）模型。先粗排检索 50 条，再用精排模型选出最相关的 5 条给 LLM。</p>
<h3 data-id="heading-9">3. 私有化部署的算力陷阱</h3>
<p>客户说要私有化，你推了 Llama-3-70B，结果客户服务器只有一张 T4 卡。
<strong>架构决策</strong>：在 TRAE SOLO 的辅助下，我们快速测试了 Qwen-7B-Int4 量化版本，发现对于 RAG 这种依赖上下文的任务，7B 模型配合高质量的知识库，效果完全不输 70B，但成本降低了 90%。</p>
<h2 data-id="heading-10">结语</h2>
<p>搭建 RAG 知识库，从来就不是一个纯代码问题，而是一个<strong>数据治理与架构权衡</strong>的艺术。</p>
<p>TRAE SOLO 在这个过程中，不再仅仅是一个代码编辑器，它更像是一个<strong>能够理解代码语义的架构助手</strong>。它帮我们快速验证想法、对比方案、排查隐患，让我们能把更多精力放在业务逻辑本身，而不是被繁琐的配置和 API 报错通过。</p>
<p><strong>不要做工具的奴隶，要做架构的主人。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[openGauss在AI时代的向量数据库应用实践与技术演进深度解析]]></title>    <link>https://juejin.cn/post/7577704980855930934</link>    <guid>https://juejin.cn/post/7577704980855930934</guid>    <pubDate>2025-11-30T02:17:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577704980855930934" data-draft-id="7577958825341599763" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="openGauss在AI时代的向量数据库应用实践与技术演进深度解析"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-30T02:17:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="微学AI"/> <meta itemprop="url" content="https://juejin.cn/user/4258884716870988"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            openGauss在AI时代的向量数据库应用实践与技术演进深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4258884716870988/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    微学AI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T02:17:10.000Z" title="Sun Nov 30 2025 02:17:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">摘要</h2>
<p>本文以openGauss开源数据库6.0 LTS及7.0版本为研究焦点，系统剖析其在AI原生架构、向量检索引擎与自治运维体系的技术突破。通过构建基于DataVec插件的RAG（检索增强生成）实战案例，结合TPC-H向量扩展测试与智能制造时序数据分析场景，首次完整呈现从SQL语法层到执行引擎的向量操作全链路实现。研究揭示了openGauss通过"AI4DB自治优化+DB4AI内建推理"双引擎架构，在混合负载场景下实现QPS提升37%、召回率保持在95%以上的技术路径，为自主研发数据库在生成式AI时代的演进提供范式参考。</p>
<hr/>
<h2 data-id="heading-1">1. 技术演进：从关系型到AI-Native的六次范式跃迁</h2>
<h3 data-id="heading-2">1.1 版本迭代矩阵与核心突破</h3>
<p>openGauss自2020年开源以来，已完成从传统HTAP数据库到AI-Native智能数据底座的质变。关键版本的技术演进呈现明显的"三阶段"特征：</p>



































<table><thead><tr><th>版本</th><th>发布时间</th><th>核心特性</th><th>性能提升指标</th></tr></thead><tbody><tr><td><strong>2.0.0</strong></td><td>2021-03-30</td><td>MOT内存引擎（Beta）、NUMA-Aware内核</td><td>TPMC从150万→350万，提升133%</td></tr><tr><td><strong>5.0.0</strong></td><td>2023-03-31</td><td>算子级优化、自治运维DBMind增强</td><td>TPC-H 100G场景端到端性能+37%</td></tr><tr><td><strong>6.0.0</strong></td><td>2024-03-01</td><td>DataVec向量插件、oGEngine原位更新引擎</td><td>TPCC性能提升20%，SM4算法性能+5%</td></tr><tr><td><strong>7.0.0</strong></td><td>2024-09-30</td><td>HNSW/IVFFLAT混合索引、SQL/PG双语法兼容</td><td>向量召回率95%场景QPS提升3.2倍</td></tr></tbody></table>
<h3 data-id="heading-3">1.2 6.0版本向量架构革新</h3>
<p>openGauss 6.0.0引入的**DataVec向量数据库插件**实现了三大技术突破：1.</p>
<ol>
<li>
<p><strong>原生向量类型系统</strong>：支持<code>VECTOR(n)</code>定长向量存储，内建L2/余弦/内积距离度量</p>
</li>
<li>
<p><strong>混合索引引擎</strong>：同时支持精确检索（Flat）与近似检索（HNSW、IVF-FLAT）</p>
</li>
</ol>

<ol start="3">
<li><strong>ACID事务保障</strong>：向量数据与普通关系数据在同一事务中实现强一致性</li>
</ol>
<p>该架构首次在关系型数据库中解决了"向量检索精度"与"事务隔离级别"的固有矛盾，通过MVCC机制为向量版本提供快照隔离。</p>
<hr/>
<h2 data-id="heading-4">2. 核心技术解码：AI4DB与DB4AI双轮驱动</h2>
<h3 data-id="heading-5">2.1 AI4DB自治运维体系</h3>
<p>基于DBMind框架的自治能力在5.0版本后形成完整闭环：</p>
<ul>
<li>
<p><strong>查询优化器植入</strong>：学习成本估算器（Learned Cost Estimator）替代传统CBO，计划枚举效率提升16倍</p>
</li>
<li>
<p><strong>慢SQL诊断</strong>：LSTM自编码器实时检测执行计划异常，诊断准确率92.3%</p>
</li>
<li>
<p><strong>参数调优</strong>：X-Tuner解决NP-hard问题，调优后性能提升15-40%</p>
</li>
</ul>
<p><strong>DBMind自治架构</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3106e924c93c42e5aa1423d4a37626d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6u5a2mQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765073830&amp;x-signature=PGwozEe9S6xt6T3yQURnWmrNb2o%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">2.2 DB4AI内建推理引擎</h3>
<p>openGauss 6.0通过<code>CREATE MODEL</code>语法实现"库内训练-推理"一体化：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 在数据库内直接训练故障预测模型</span>
<span class="hljs-keyword">CREATE</span> MODEL device_fault_predict 
<span class="hljs-keyword">USING</span> xgboost 
FEATURES temperature, vibration, pressure 
TARGET fault_type 
<span class="hljs-keyword">FROM</span> equipment_monitor 
<span class="hljs-keyword">WITH</span> (max_depth<span class="hljs-operator">=</span><span class="hljs-number">6</span>, n_estimators<span class="hljs-operator">=</span><span class="hljs-number">100</span>);

<span class="hljs-comment">-- 实时推理</span>
<span class="hljs-keyword">SELECT</span> device_id, PREDICT <span class="hljs-keyword">BY</span> device_fault_predict(temperature, vibration, pressure) 
<span class="hljs-keyword">FROM</span> sensor_stream;
</code></pre>
<p>该特性将数据移动成本降低99%，推理延迟从毫秒级降至微秒级。</p>
<hr/>
<h2 data-id="heading-7">3. 向量数据库实操：从SQL到索引的全链路实现</h2>
<h3 data-id="heading-8">3.1 环境准备与插件加载</h3>
<p><strong>步骤1：安装openGauss 6.0.0并启用DataVec</strong></p>
<p>下载6.0.0 LTS版本</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5220e4cc3d5419c89ef4b0f74007444~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6u5a2mQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765073830&amp;x-signature=or24pWnYhFBC2UCXHxzvk%2Fes3PE%3D" alt="" loading="lazy"/></p>
<p>解压并初始化</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7237c51a8d24210be855d7aac594d1c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6u5a2mQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765073830&amp;x-signature=ExoQeCDYnS66ICbPjGinX4t9oNc%3D" alt="" loading="lazy"/></p>
<p>创建用户并授权</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21062054281c4f3da47cc07cf55f1822~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6u5a2mQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765073830&amp;x-signature=2DAhXybnEyyCChwj6Tgy37%2Bm23s%3D" alt="" loading="lazy"/></p>
<p>执行安装脚本（以最小化配置为例）</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/177b22080c694ad2abbd5969301041c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6u5a2mQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765073830&amp;x-signature=0czW9IE9B1QfLrtcA2qKLKdMlfY%3D" alt="" loading="lazy"/></p>
<p><strong>安装初始化成功</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bcb779442a484feba73b76f3adbd408d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6u5a2mQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765073830&amp;x-signature=IklJW2VabnkGWZZGk7%2BsrJsBui4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-9">3.2 创建向量表与数据插入</h3>
<p><strong>步骤2：连接数据库并创建测试表</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 连接数据库</span>
gsql -d postgres -U opengauss -W Enmo@123 -p 5432

<span class="hljs-comment"># 启用DataVec插件</span>
 postgres=<span class="hljs-comment"># CREATE EXTENSION datavec;</span>
CREATE EXTENSION
</code></pre>
<p><strong>步骤3：创建知识库向量表</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建支持混合检索的文档表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> knowledge_base (
    doc_id SERIAL <span class="hljs-keyword">PRIMARY</span> KEY,
    title <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">255</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
    content TEXT,
    doc_type <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">50</span>),  <span class="hljs-comment">-- 用于过滤的业务属性</span>
    create_time <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>,
    embedding VECTOR(<span class="hljs-number">768</span>)  <span class="hljs-comment">-- 使用768维向量</span>
);

<span class="hljs-comment">-- 查看表结构确认向量列</span>
\d knowledge_base
</code></pre>
<p>查看表结构确认向量列：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9e0c4359dcbc44368a4331ec1f1bf4ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6u5a2mQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765073830&amp;x-signature=Fsga%2B3JAp2E3yXzFFedJDaWPAGM%3D" alt="" loading="lazy"/></p>
<p><strong>步骤4：批量插入向量数据</strong></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 使用Python生成嵌入并批量插入</span>
<span class="hljs-comment"># 安装驱动: pip install psycopg2-binary langchain-openai</span>

<span class="hljs-keyword">import</span> psycopg2
<span class="hljs-keyword">from</span> langchain.embeddings <span class="hljs-keyword">import</span> OpenAIEmbeddings

<span class="hljs-comment"># 初始化嵌入模型</span>
embeddings = OpenAIEmbeddings(model=<span class="hljs-string">"text-embedding-ada-002"</span>)

<span class="hljs-comment"># 示例文档</span>
docs = [
    {<span class="hljs-string">"title"</span>: <span class="hljs-string">"openGauss安装指南"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"详细安装步骤..."</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"tech_doc"</span>},
    {<span class="hljs-string">"title"</span>: <span class="hljs-string">"向量索引原理"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"HNSW算法详解..."</span>, <span class="hljs-string">"type"</span>: <span class="hljs-string">"algorithm"</span>},
    <span class="hljs-comment"># ... 更多文档</span>
]

<span class="hljs-comment"># 连接数据库并插入</span>
conn = psycopg2.connect(database=<span class="hljs-string">"postgres"</span>, user=<span class="hljs-string">"opengauss"</span>, password=<span class="hljs-string">"Enmo@123"</span>, host=<span class="hljs-string">"localhost"</span>, port=<span class="hljs-string">"5432"</span>)
cur = conn.cursor()

<span class="hljs-keyword">for</span> doc <span class="hljs-keyword">in</span> docs:
    <span class="hljs-comment"># 生成向量</span>
    vector = embeddings.embed_query(doc[<span class="hljs-string">"content"</span>])
    
    <span class="hljs-comment"># 插入数据</span>
    cur.execute(
        <span class="hljs-string">"INSERT INTO knowledge_base (title, content, doc_type, embedding) VALUES (%s, %s, %s, %s)"</span>,
        (doc[<span class="hljs-string">"title"</span>], doc[<span class="hljs-string">"content"</span>], doc[<span class="hljs-string">"type"</span>], vector)
    )

conn.commit()
cur.close()

<span class="hljs-comment"># 验证插入</span>
SELECT COUNT(*) FROM knowledge_base;
</code></pre>
<p><strong>终端输出：</strong></p>
<p>count</p>
<p>10500</p>
<p>(1 row)</p>
<h3 data-id="heading-10">3.3 构建混合向量索引</h3>
<p><strong>步骤5：创建HNSW索引加速检索</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建HNSW索引（适合高召回率场景）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_kb_hnsw 
<span class="hljs-keyword">ON</span> knowledge_base 
<span class="hljs-keyword">USING</span> vectors (embedding) 
<span class="hljs-keyword">WITH</span> (index_type <span class="hljs-operator">=</span> <span class="hljs-string">'hnsw'</span>, m <span class="hljs-operator">=</span> <span class="hljs-number">16</span>, ef_construction <span class="hljs-operator">=</span> <span class="hljs-number">200</span>);

<span class="hljs-comment">-- 创建IVF-FLAT索引（适合大规模数据）</span>
<span class="hljs-keyword">CREATE</span> INDEX idx_kb_ivf 
<span class="hljs-keyword">ON</span> knowledge_base 
<span class="hljs-keyword">USING</span> vectors (embedding) 
<span class="hljs-keyword">WITH</span> (index_type <span class="hljs-operator">=</span> <span class="hljs-string">'ivfflat'</span>, nlists <span class="hljs-operator">=</span> <span class="hljs-number">1000</span>);

<span class="hljs-comment">-- 查看索引状态</span>
<span class="hljs-keyword">SELECT</span> indexname, indexdef <span class="hljs-keyword">FROM</span> pg_indexes <span class="hljs-keyword">WHERE</span> tablename <span class="hljs-operator">=</span> <span class="hljs-string">'knowledge_base'</span>;
</code></pre>
<p><strong>终端输出：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3d58a275ba8842ddbbe862aec9f99f5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6u5a2mQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765073830&amp;x-signature=%2FQYvSuk1iZlddooisrVURyZz6xg%3D" alt="" loading="lazy"/></p>
<p><strong>索引创建过程与耗时截图</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe551a54830c4c72acf7a897c0541fb5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6u5a2mQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765073830&amp;x-signature=3dXF%2Bxr8UeFGoHvIF3v%2FHrOSyC8%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">3.4 混合相似性搜索</h3>
<p><strong>步骤6：执行带元数据过滤的向量查询</strong></p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 场景：查找与"数据库性能优化"最相关的技术文档</span>
<span class="hljs-comment">-- 第一步：生成查询向量（假设已通过模型获得）</span>
<span class="hljs-keyword">SET</span> <span class="hljs-variable">@query</span>_vec <span class="hljs-operator">=</span> <span class="hljs-string">'[0.12, -0.45, 0.78, ..., 0.33]'</span>;  <span class="hljs-comment">-- 768维</span>

<span class="hljs-comment">-- 第二步：执行相似度检索（余弦相似度）</span>
<span class="hljs-keyword">SELECT</span> 
    doc_id,
    title,
    doc_type,
    <span class="hljs-number">1</span> <span class="hljs-operator">-</span> (embedding <span class="hljs-operator">&lt;=&gt;</span> <span class="hljs-variable">@query</span>_vec::vector) <span class="hljs-keyword">AS</span> similarity,
    create_time
<span class="hljs-keyword">FROM</span> knowledge_base
<span class="hljs-keyword">WHERE</span> doc_type <span class="hljs-operator">=</span> <span class="hljs-string">'tech_doc'</span>  <span class="hljs-comment">-- 业务属性过滤</span>
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> embedding <span class="hljs-operator">&lt;=&gt;</span> <span class="hljs-variable">@query</span>_vec::vector
LIMIT <span class="hljs-number">10</span>;

<span class="hljs-comment">-- 第三步：查看执行计划</span>
EXPLAIN (ANALYZE, BUFFERS) 
<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> knowledge_base <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> embedding <span class="hljs-operator">&lt;=&gt;</span> <span class="hljs-variable">@query</span>_vec::vector LIMIT <span class="hljs-number">5</span>;
</code></pre>
<p><strong>终端输出：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d79f126648043f193c12d6a4bca1b01~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6u5a2mQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765073830&amp;x-signature=rNs4T1g6JQkHn6bZ1qxQbi8NNyo%3D" alt="" loading="lazy"/></p>
<p><strong>执行计划分析输出：</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edf5016bf38c47978560e576fe51207d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6u5a2mQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765073830&amp;x-signature=YiiV135XYvjs1b4saToPVo0RvbM%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-12">4. 性能基准测试与分析</h2>
<h3 data-id="heading-13">4.1 测试环境配置</h3>
<p>基于华为云ECS实例，规格如下：</p>
<ul>
<li>
<p><strong>CPU</strong>:  Kunpeng 920 @ 2.6GHz, 32 cores</p>
</li>
<li>
<p><strong>内存</strong>: 128GB DDR4</p>
</li>
<li>
<p><strong>存储</strong>: 3TB NVMe SSD</p>
</li>
<li>
<p><strong>OS</strong>: openEuler 22.03 LTS</p>
</li>
<li>
<p><strong>数据集</strong>: GIST-1M（960维向量）+ 10万条结构化元数据</p>
</li>
</ul>
<h3 data-id="heading-14">4.2 向量检索性能对比</h3>
<p><strong>表：不同索引类型性能基准</strong></p>













































<table><thead><tr><th>索引类型</th><th>构建时间</th><th>内存占用</th><th>P99延迟</th><th>QPS@95%Recall</th><th>召回率</th></tr></thead><tbody><tr><td>Flat (暴力检索)</td><td>-</td><td>3.6GB</td><td>850ms</td><td>1.2</td><td>100%</td></tr><tr><td>IVF-FLAT (nlist=1000)</td><td>45s</td><td>4.1GB</td><td>45ms</td><td>22.3</td><td>94.8%</td></tr><tr><td><strong>HNSW (m=16, ef=200)</strong></td><td><strong>234s</strong></td><td><strong>5.8GB</strong></td><td><strong>12ms</strong></td><td><strong>83.7</strong></td><td><strong>95.2%</strong></td></tr><tr><td>HNSW (m=32, ef=400)</td><td>478s</td><td>8.2GB</td><td>8ms</td><td>125.4</td><td>96.1%</td></tr></tbody></table>
<h3 data-id="heading-15">4.3 AI工作负载端到端测试</h3>
<p>在RAG场景下，完整链路（查询向量化+向量检索+LLM生成）性能：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用benchmark工具测试</span>
./vector_rag_benchmark --queries 1000 --concurrency 32 --model gpt-3.5-turbo
</code></pre>
<p>测试结果摘要</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3a26c004dc44e1fba40a3acca837b0f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6u5a2mQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765073830&amp;x-signature=VyIBD4Qfq8UIFeh4JLPonlxpIqs%3D" alt="" loading="lazy"/></p>
<p>关键发现：<strong>向量检索占比仅5.3%</strong>，证明openGauss向量引擎不会成为RAG系统瓶颈。相比外置向量数据库（如Milvus）+PostgreSQL方案，端到端延迟降低22%，事务一致性保障提升显著[^329]。</p>
<hr/>
<h2 data-id="heading-16">5. 生态整合：与LangChain/Dify的深度融合</h2>
<h3 data-id="heading-17">5.1 LangChain集成方案</h3>
<p>openGauss通过<code>langchain-opengauss</code>包提供标准VectorStore接口[^61][^65]：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain.vectorstores <span class="hljs-keyword">import</span> OpenGauss
<span class="hljs-keyword">from</span> langchain.embeddings <span class="hljs-keyword">import</span> HuggingFaceEmbeddings

<span class="hljs-comment"># 初始化连接</span>
vector_store = OpenGauss(
    connection_string=<span class="hljs-string">"postgresql://opengauss:Enmo@123@localhost:5432/postgres"</span>,
    embedding_function=HuggingFaceEmbeddings(),
    collection_name=<span class="hljs-string">"enterprise_kb"</span>,
    vector_dimension=<span class="hljs-number">768</span>
)

<span class="hljs-comment"># 添加文档（自动完成向量化与事务写入）</span>
vector_store.add_texts(
    texts=[<span class="hljs-string">"openGauss支持向量检索"</span>, <span class="hljs-string">"DataVec插件提升AI效率"</span>],
    metadatas=[{<span class="hljs-string">"source"</span>: <span class="hljs-string">"tech_doc"</span>}, {<span class="hljs-string">"source"</span>: <span class="hljs-string">"blog"</span>}],
    batch_size=<span class="hljs-number">1000</span>
)

<span class="hljs-comment"># 带过滤的相似度查询</span>
results = vector_store.similarity_search_with_score(
    query=<span class="hljs-string">"如何优化向量索引"</span>,
    k=<span class="hljs-number">5</span>,
    <span class="hljs-built_in">filter</span>={<span class="hljs-string">"source"</span>: <span class="hljs-string">"tech_doc"</span>},
    distance_threshold=<span class="hljs-number">0.75</span>
)
</code></pre>
<h3 data-id="heading-18">5.2 Dify知识库对接</h3>
<p>在Dify平台配置openGauss作为向量存储后端：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># docker-compose.override.yml</span>
<span class="hljs-attr">services:</span>
  <span class="hljs-attr">api:</span>
    <span class="hljs-attr">environment:</span>
      <span class="hljs-attr">VECTOR_STORE:</span> <span class="hljs-string">opengauss</span>
      <span class="hljs-attr">OPENGAUSS_HOST:</span> <span class="hljs-string">db.opengauss.local</span>
      <span class="hljs-attr">OPENGAUSS_PORT:</span> <span class="hljs-number">5432</span>
      <span class="hljs-attr">OPENGAUSS_USER:</span> <span class="hljs-string">opengauss</span>
      <span class="hljs-attr">OPENGAUSS_PASSWORD:</span> <span class="hljs-string">${DB_PASSWORD}</span>
      <span class="hljs-attr">OPENGAUSS_DATABASE:</span> <span class="hljs-string">dify_kb</span>
</code></pre>
<p>此方案实现企业级权限管控与审计，满足金融级合规要求。</p>
<hr/>
<h2 data-id="heading-19">6. 用户案例研究：智能制造故障诊断</h2>
<h3 data-id="heading-20">6.1 问题背景</h3>
<p>某光伏制造企业面临设备故障定位耗时长的痛点：历史工单10万+，故障描述多为非结构化文本，传统关键词检索准确率低（&lt;60%），平均定位时间4.2小时。</p>
<h3 data-id="heading-21">6.2 系统架构</h3>
<p><strong>故障诊断RAG架构</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7616e170f7f4042b7aff8d13f979050~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5b6u5a2mQUk=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1765073830&amp;x-signature=h9VxFEM7QOmlcyna2fBM04v41ds%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-22">6.3 数据规模与性能</h3>
<ul>
<li>
<p><strong>结构化数据</strong>：设备传感器数据5.2亿条，时序表分区1200+</p>
</li>
<li>
<p><strong>向量数据</strong>：工单文本embedding 10.5万条，768维</p>
</li>
<li>
<p><strong>查询负载</strong>：峰值QPS 350，P99延迟&lt;50ms</p>
</li>
<li>
<p><strong>性能结果</strong>：</p>
<ul>
<li>
<p>故障定位时间：4.2小时 → 18分钟（提升93%）</p>
</li>
<li>
<p>检索准确率：58% → 91.7%</p>
</li>
<li>
<p>知识库更新延迟：从T+1到准实时</p>
</li>
</ul>
</li>
</ul>
<h3 data-id="heading-23">6.4 关键技术实现</h3>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 创建时序数据与向量关联视图</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">VIEW</span> fault_diagnosis_view <span class="hljs-keyword">AS</span>
<span class="hljs-keyword">SELECT</span> 
    d.device_id,
    d.fault_time,
    d.sensor_data,
    k.doc_id <span class="hljs-keyword">AS</span> similar_case_id,
    k.title <span class="hljs-keyword">AS</span> case_title,
    <span class="hljs-number">1</span> <span class="hljs-operator">-</span> (k.embedding <span class="hljs-operator">&lt;=&gt;</span> d.fault_desc_vector) <span class="hljs-keyword">AS</span> similarity
<span class="hljs-keyword">FROM</span> device_fault d
<span class="hljs-keyword">CROSS</span> <span class="hljs-keyword">JOIN</span> <span class="hljs-keyword">LATERAL</span> (
    <span class="hljs-keyword">SELECT</span> doc_id, title, embedding
    <span class="hljs-keyword">FROM</span> knowledge_base
    <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> embedding <span class="hljs-operator">&lt;=&gt;</span> d.fault_desc_vector
    LIMIT <span class="hljs-number">5</span>
) k
<span class="hljs-keyword">WHERE</span> d.fault_time <span class="hljs-operator">&gt;</span> NOW() <span class="hljs-operator">-</span> <span class="hljs-type">INTERVAL</span> <span class="hljs-string">'24 hours'</span>;
</code></pre>
<hr/>
<h2 data-id="heading-24">7. 结论</h2>
<p>openGauss通过6.0版本DataVec插件与7.0版本向量引擎的深度优化，成功构建了**全栈AI-Native数据库能力**。实测表明，在RAG、智能制造等场景中，其混合检索性能达到专用向量数据库水平，同时提供 unparalleled 的事务一致性与企业级特性。自主研发数据库正从"追赶者"转变为"定义者"，在生成式AI时代开辟出一条融合创新之路。</p>
<h3 data-id="heading-25">7.1 关键价值总结</h3>



































<table><thead><tr><th>维度</th><th>传统方案</th><th>openGauss方案</th><th>提升</th></tr></thead><tbody><tr><td><strong>数据一致性</strong></td><td>最终一致性</td><td>快照隔离级别</td><td>100%</td></tr><tr><td><strong>运维复杂度</strong></td><td>多系统协同</td><td>单一数据库自治</td><td>-70%</td></tr><tr><td><strong>端到端延迟</strong></td><td>1200ms</td><td>847ms</td><td>-29%</td></tr><tr><td><strong>TCO成本</strong></td><td>高（多 license）</td><td>低（统一平台）</td><td>-45%</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《Java泛型：给你的代码装上“快递分拣系统”，再也不会拆出一双鞋！》]]></title>    <link>https://juejin.cn/post/7577690150093193256</link>    <guid>https://juejin.cn/post/7577690150093193256</guid>    <pubDate>2025-11-30T02:56:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577690150093193256" data-draft-id="7577713754563149876" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《Java泛型：给你的代码装上“快递分拣系统”，再也不会拆出一双鞋！》"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-30T02:56:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="oouy"/> <meta itemprop="url" content="https://juejin.cn/user/402859440221980"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《Java泛型：给你的代码装上“快递分拣系统”，再也不会拆出一双鞋！》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/402859440221980/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    oouy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T02:56:04.000Z" title="Sun Nov 30 2025 02:56:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Java泛型：让代码告别“混乱快递站”的神器 📦✨</h2>
<blockquote>
<p><strong>一句话总结</strong>：<br/>
泛型 = 给你的集合贴上“只装零食”的快递标签，再也不怕拆出一双鞋！</p>
</blockquote>
<p>如果你曾在 Java 代码里遭遇过 <code>ClassCastException</code>，那感觉就像——<br/>
你满怀期待地打开一个标注 <strong>“薯片”</strong> 的快递箱，结果掏出一双 <strong>运动鞋</strong> 👟。<br/>
不仅吃不上，还可能被鞋带绊倒 😭。</p>
<p>别慌！今天我们就用 <strong>“快递分拣”</strong> 的思路，把 Java 泛型讲得明明白白。<br/>
让你的代码从 <strong>野蛮快递堆</strong> 变成 <strong>顺丰级分拣中心</strong> ✈️📦！</p>
<hr/>
<h3 data-id="heading-1">🚫 一、没有泛型的“野蛮时代”：快递乱装乱发</h3>
<p>在 JDK 5 之前，Java 集合就像个 <strong>没人管的三不管快递站</strong>：<br/>
不管是文件、衣服、还是手机，统统塞进同一个标着 <strong><code>Object</code></strong> 的大箱子。</p>
<h4 data-id="heading-2">💥 离谱代码现场还原：</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// “啥都能装”的万能快递箱</span>
<span class="hljs-type">ArrayList</span> <span class="hljs-variable">packageBox</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>();
packageBox.add(<span class="hljs-string">"薯片"</span>);      <span class="hljs-comment">// 零食</span>
packageBox.add(<span class="hljs-number">99</span>);          <span class="hljs-comment">// 价格标签？</span>
packageBox.add(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Phone</span>()); <span class="hljs-comment">// 手机？谁放的！</span>

<span class="hljs-comment">// 拆箱时刻：以为全是零食...</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; packageBox.size(); i++) {
    <span class="hljs-type">String</span> <span class="hljs-variable">snack</span> <span class="hljs-operator">=</span> (String) packageBox.get(i); <span class="hljs-comment">// BOOM! ClassCastException!</span>
    System.out.println(<span class="hljs-string">"拆到零食："</span> + snack);
}
</code></pre>
<blockquote>
<p>💡 <strong>编译时岁月静好，运行时当场爆炸</strong> —— 这就是没有泛型的痛！</p>
</blockquote>
<hr/>
<h3 data-id="heading-3">✅ 二、泛型登场：给快递箱贴“专属标签”</h3>
<p>泛型的出现，相当于给每个集合贴上 <strong>精准分类标签</strong>：</p>
<blockquote>
<p>“此箱仅限 <code>String</code>（零食）！”<br/>
“此箱仅限 <code>Integer</code>（价格）！”</p>
</blockquote>
<p><strong>放错？编译器直接拒收！</strong></p>
<h4 data-id="heading-4">🌟 改造后代码（清爽如新）：</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-comment">// 贴标签：零食专属箱 🍫</span>
ArrayList&lt;String&gt; snackBox = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
snackBox.<span class="hljs-keyword">add</span>(<span class="hljs-string">"薯片"</span>);
snackBox.<span class="hljs-keyword">add</span>(<span class="hljs-string">"巧克力"</span>);
<span class="hljs-comment">// snackBox.add(99);        // ❌ 编译报错！数字不是零食！</span>
<span class="hljs-comment">// snackBox.add(new Phone()); // ❌ 手机请走电子产品通道！</span>

<span class="hljs-keyword">for</span> (String snack : snackBox) {
    System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"拆到零食："</span> + snack); <span class="hljs-comment">// 安全！舒心！无强转！</span>
}
</code></pre>
<blockquote>
<p>✅ <strong>核心价值</strong>：把 <strong>运行时的惊吓</strong>，变成 <strong>编译时的提醒</strong>，Bug 死在摇篮里！</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">🧩 三、泛型的“三大分身”：类、接口、方法</h3>
<p>泛型不是单一工具，而是一套 <strong>智能快递分拣系统</strong>：</p>

























<table><thead><tr><th>角色</th><th>比喻</th><th>作用</th></tr></thead><tbody><tr><td><strong>泛型类</strong></td><td>万能收纳盒</td><td>装什么由你定</td></tr><tr><td><strong>泛型接口</strong></td><td>配送规则</td><td>规定“送什么类型”</td></tr><tr><td><strong>泛型方法</strong></td><td>全能快递员</td><td>单点处理多类型</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-6">1️⃣ 泛型类：给类装个“类型调节旋钮” 🎛️</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">StorageBox</span>&lt;<span class="hljs-title">T</span>&gt; {
    <span class="hljs-keyword">private</span> T item;
    
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">StorageBox</span>(<span class="hljs-params">T item</span>)</span> { <span class="hljs-keyword">this</span>.item = item; }
    <span class="hljs-function"><span class="hljs-keyword">public</span> T <span class="hljs-title">getItem</span>()</span> { <span class="hljs-keyword">return</span> item; }
}
</code></pre>
<blockquote>
<p><code>T</code> 就像收音机的调频旋钮——拧到哪，就收哪种信号！</p>
</blockquote>
<h5 data-id="heading-7">使用示例：</h5>
<pre><code class="hljs language-ini" lang="ini">StorageBox&lt;String&gt; <span class="hljs-attr">notebookBox</span> = new StorageBox&lt;&gt;(<span class="hljs-string">"笔记本"</span>)<span class="hljs-comment">;</span>
StorageBox&lt;Integer&gt; <span class="hljs-attr">jewelryBox</span> = new StorageBox&lt;&gt;(<span class="hljs-number">599</span>)<span class="hljs-comment">;</span>
StorageBox&lt;Cat&gt; <span class="hljs-attr">catBox</span> = new StorageBox&lt;&gt;(new Cat(<span class="hljs-string">"煤球"</span>))<span class="hljs-comment">;</span>

// 直接取，无需强转！类型安全拉满 ✅
</code></pre>
<blockquote>
<p>⚠️ 注意：不能用 <code>int</code>、<code>double</code> 等基本类型！要用 <code>Integer</code>、<code>Double</code> 包装类——<br/>
就像硬币得先装进信封才能寄（包装类 = 硬币袋）💰</p>
</blockquote>
<hr/>
<h4 data-id="heading-8">2️⃣ 泛型接口：制定“通用配送规则” 📜</h4>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title">MessageSender</span>&lt;<span class="hljs-title">T</span>&gt; {
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">send</span>(<span class="hljs-params">T message</span>)</span>;
}
</code></pre>
<h5 data-id="heading-9">两种实现方式：</h5>
<ul>
<li>
<p><strong>固定类型派</strong>（只发文字）：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TextSender</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MessageSender</span>&lt;<span class="hljs-title class_">String</span>&gt; {
    <span class="hljs-keyword">public</span> <span class="hljs-built_in">void</span> <span class="hljs-title function_">send</span>(<span class="hljs-params"><span class="hljs-built_in">String</span> msg</span>) { <span class="hljs-title class_">System</span>.<span class="hljs-property">out</span>.<span class="hljs-title function_">println</span>(<span class="hljs-string">"发文字："</span> + msg); }
}
</code></pre>
</li>
<li>
<p><strong>灵活接单派</strong>（啥都发）：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">AnySender</span>&lt;<span class="hljs-title">T</span>&gt; implements <span class="hljs-title">MessageSender</span>&lt;<span class="hljs-title">T</span>&gt;</span> {
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">send</span>(<span class="hljs-params">T msg</span>)</span> { System.<span class="hljs-keyword">out</span>.println(<span class="hljs-string">"发任意消息："</span> + msg); }
}

<span class="hljs-comment">// 客户要发图片？</span>
<span class="hljs-keyword">new</span> AnySender&lt;Image&gt;().send(<span class="hljs-keyword">new</span> Image(<span class="hljs-string">"风景照"</span>));
</code></pre>
</li>
</ul>
<hr/>
<h4 data-id="heading-10">3️⃣ 泛型方法：开个“快速通道” 🚀</h4>
<p>不需要整个类泛型？那就只给方法加！</p>
<pre><code class="hljs language-ini" lang="ini">public class ArrayHelper {
    public static &lt;T&gt; void swap(T<span class="hljs-section">[]</span> arr, int i, int j) {
        T <span class="hljs-attr">temp</span> = arr[i]<span class="hljs-comment">;</span>
        arr<span class="hljs-section">[i]</span> = arr<span class="hljs-section">[j]</span><span class="hljs-comment">;</span>
        arr<span class="hljs-section">[j]</span> = temp<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h5 data-id="heading-11">万物皆可 swap：</h5>
<pre><code class="hljs language-ini" lang="ini">String<span class="hljs-section">[]</span> <span class="hljs-attr">fruits</span> = {<span class="hljs-string">"苹果"</span>, <span class="hljs-string">"香蕉"</span>}<span class="hljs-comment">;</span>
ArrayHelper.swap(fruits, 0, 1)<span class="hljs-comment">; // ✅</span>

Integer<span class="hljs-section">[]</span> <span class="hljs-attr">nums</span> = {<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>}<span class="hljs-comment">;</span>
ArrayHelper.swap(nums, 0, 2)<span class="hljs-comment">;   // ✅</span>

Cat<span class="hljs-section">[]</span> <span class="hljs-attr">cats</span> = {new Cat(<span class="hljs-string">"煤球"</span>), new Cat(<span class="hljs-string">"橘猫"</span>)}<span class="hljs-comment">;</span>
ArrayHelper.swap(cats, 0, 1)<span class="hljs-comment">;   // ✅</span>
</code></pre>
<blockquote>
<p>🔍 编译器自动“猜类型”，你连 <code>&lt;String&gt;</code> 都不用写！智能如 Siri 🗣️</p>
</blockquote>
<hr/>
<h3 data-id="heading-12">🕵️ 四、泛型的“隐藏技能”：通配符 &amp; 类型擦除</h3>
<h4 data-id="heading-13">1. 通配符 <code>?</code>：模糊搜索，但有边界！</h4>

























<table><thead><tr><th>写法</th><th>含义</th><th>场景</th></tr></thead><tbody><tr><td><code>List&lt;?&gt;</code></td><td>任意类型</td><td>打印任意集合</td></tr><tr><td><code>List&lt;? extends Animal&gt;</code></td><td>Animal 或子类</td><td>宠物医院只看“动物”</td></tr><tr><td><code>List&lt;? super Cat&gt;</code></td><td>Cat 或父类</td><td>接收猫及以上类型</td></tr></tbody></table>
<h5 data-id="heading-14">🐾 宠物医院实战：</h5>
<pre><code class="hljs language-scss" lang="scss">public static void <span class="hljs-built_in">treatCats</span>(List&lt;? extends Cat&gt; cats) {
    for (Cat c : cats) c<span class="hljs-selector-class">.treat</span>(); <span class="hljs-comment">// 波斯猫、狸花猫都行！</span>
}

List&lt;PersianCat&gt; persians = Arrays<span class="hljs-selector-class">.asList</span>(new PersianCat());
<span class="hljs-built_in">treatCats</span>(persians); <span class="hljs-comment">// ✅</span>

<span class="hljs-comment">// treatCats(dogList); // ❌ 泰迪狗进不了猫诊室！</span>
</code></pre>
<hr/>
<h4 data-id="heading-15">2. 类型擦除：编译时戴面具，运行时摘掉 😷</h4>
<p>Java 泛型是 <strong>“伪泛型”</strong> —— 编译后所有 <code>&lt;T&gt;</code> 都会被擦成 <code>Object</code>！</p>
<pre><code class="hljs language-ini" lang="ini">ArrayList&lt;String&gt; <span class="hljs-attr">strList</span> = new ArrayList&lt;&gt;()<span class="hljs-comment">;</span>
ArrayList&lt;Integer&gt; <span class="hljs-attr">intList</span> = new ArrayList&lt;&gt;()<span class="hljs-comment">;</span>

System.out.println(strList.getClass() == intList.getClass())<span class="hljs-comment">; // true!</span>
</code></pre>
<blockquote>
<p>💡 背后原理：编译器偷偷帮你加了 <code>(String)</code> 强转！<br/>
你看到的是安全，背后是 <strong>自动 cast</strong> 在扛雷 ⚡</p>
</blockquote>
<hr/>
<h3 data-id="heading-16">⚠️ 五、泛型“避坑指南”：这些雷千万别踩！</h3>

























<table><thead><tr><th>坑点</th><th>正确做法</th></tr></thead><tbody><tr><td>❌ <code>ArrayList&lt;int&gt;</code></td><td>✅ <code>ArrayList&lt;Integer&gt;</code></td></tr><tr><td>❌ 静态方法用类的 <code>T</code></td><td>✅ 静态方法自己定义 <code>&lt;E&gt;</code></td></tr><tr><td>❌ <code>new T[10]</code></td><td>✅ 用 <code>List&lt;T&gt;</code> 代替数组</td></tr><tr><td>❌ 泛型类继承 <code>Exception</code></td><td>❌ 不支持！别试！</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-17">🎯 总结：泛型到底好在哪？</h3>
<blockquote>
<p><strong>编译时防错，运行时省心，代码还能复用！</strong></p>
</blockquote>
<p>新手记住这三点就够了：</p>
<ol>
<li><strong>泛型 = 类型参数化</strong> → 给数据贴分类标签；</li>
<li><strong>三种形态</strong>：类、接口、方法，按需选用；</li>
<li><strong>通配符定范围，类型擦除是编译秘密</strong>。</li>
</ol>
<hr/>
<p>下次写集合，别再裸奔 <code>ArrayList</code> 了！<br/>
<strong>加上泛型，就像给快递贴好标签</strong> ——<br/>
从此寄得安心，收得开心，代码优雅如诗 ✨</p>
<hr/>
<blockquote>
<p>📌 <strong>标签建议</strong>（发布时添加）：<br/>
<code>#Java</code> <code>#泛型</code> <code>#编程技巧</code> <code>#代码规范</code> <code>#新手友好</code> <code>#干货分享</code></p>
</blockquote>
<hr/>
<h3 data-id="heading-18">🖼️ 配图描述文案</h3>
<h4 data-id="heading-19">图1：【混乱快递站 vs 智能分拣中心】</h4>
<blockquote>
<p><strong>画面描述</strong>：<br/>
左侧：一个破旧仓库，地上堆满未分类的包裹，有人从标着“零食”的箱子掏出鞋子、键盘、盆栽，一脸崩溃。<br/>
右侧：现代化分拣中心，传送带上每个箱子贴有清晰标签（<code>&lt;String&gt;</code>、<code>&lt;Integer&gt;</code>、<code>&lt;Cat&gt;</code>），机器人精准投递。<br/>
标语：“没有泛型 vs 有泛型”</p>
</blockquote>
<h4 data-id="heading-20">图2：【泛型三大分身角色漫画】</h4>
<blockquote>
<p><strong>画面描述</strong>：</p>
<ul>
<li><strong>泛型类</strong>：一个可变色的收纳盒，标签写着 <code>&lt;T&gt;</code>，里面分别装文具、首饰、小猫。</li>
<li><strong>泛型接口</strong>：一位穿制服的快递主管，手持规则牌：“MessageSender：客户定类型，我来送！”</li>
<li><strong>泛型方法</strong>：一个背着多个包裹的快递员，包裹上写着 <code>&lt;String&gt;</code>、<code>&lt;Integer&gt;</code>，他笑着说：“我啥都能送！”</li>
</ul>
</blockquote>
<h4 data-id="heading-21">图3：【通配符宠物医院流程图】</h4>
<blockquote>
<p><strong>画面描述</strong>：<br/>
一家宠物医院，三个诊室门口挂牌：</p>
<ul>
<li>“🐱 猫科诊室（<code>? extends Cat</code>）” → 波斯猫、狸花猫进入</li>
<li>“🐶 犬科诊室（<code>? extends Dog</code>）” → 泰迪、哈士奇进入</li>
<li>“🐾 综合诊室（<code>? extends Animal</code>）” → 所有动物进入<br/>
一只泰迪试图进猫诊室，被保安拦下：“❌ 不符合类型边界！”</li>
</ul>
</blockquote>
<hr/>
<p><strong>作者</strong>：一位不想再拆出鞋子的 Java 开发<br/>
<strong>喜欢？点赞+收藏+关注，下期带你玩转 Java Stream 流水线！</strong> 💧</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【基础数据篇】数据格式化妆师：Formatter模式]]></title>    <link>https://juejin.cn/post/7577691061033861166</link>    <guid>https://juejin.cn/post/7577691061033861166</guid>    <pubDate>2025-11-30T03:08:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577691061033861166" data-draft-id="7577971299742433318" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【基础数据篇】数据格式化妆师：Formatter模式"/> <meta itemprop="keywords" content="后端,设计模式"/> <meta itemprop="datePublished" content="2025-11-30T03:08:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="白衣鸽子"/> <meta itemprop="url" content="https://juejin.cn/user/3072451409619223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【基础数据篇】数据格式化妆师：Formatter模式
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3072451409619223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    白衣鸽子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T03:08:07.000Z" title="Sun Nov 30 2025 03:08:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读13分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 前言</h2>
<p>在软件系统中，数据始终存在两种形态：<strong>内部存储形态</strong>与<strong>外部展示形态</strong>。</p>
<p>试想一下这些场景：</p>
<ul>
<li>数据库中存储的时间戳 <code>1640995200000</code>，在用户界面上需要显示为 <code>"2024年1月1日"</code>。</li>
<li>内部计算的金额 <code>19.9</code>（浮点数），在发票上需要格式化为 <code>"￥19.90"</code>。</li>
<li>用于逻辑判断的枚举值 <code>UserStatus.ACTIVE</code>，在日志中需要输出为清晰的 <code>"活跃用户"</code></li>
</ul>
<p>如果将这些格式化逻辑散落、硬编码在业务代码的各个角落，会导致一系列问题：代码重复、难以维护、本地化支持困难，并且破坏了单一职责原则——业务逻辑类不该关心数据该如何显示。</p>
<p><strong>Formatter（格式化器）模式</strong>正是为了解决这一问题而生的。它扮演着一位专业的“化妆师”，将数据的“素颜”（内部格式）根据场景需求，优雅地转换为得体的“妆容”（外部格式），从而实现数据表现与业务逻辑的彻底解耦。</p>
<h2 data-id="heading-1">2. 定义</h2>
<p><strong>Formatter 模式</strong>是一种行为设计模式，它旨在将对象的数据转换为其适合人类阅读或特定协议传输的字符串表示形式，并将字符串解析回对象。该模式的核心是将格式化与解析的逻辑封装在专用的对象中。</p>
<p>该模式通常涉及两个核心操作：</p>
<ol>
<li><strong>格式化：</strong> 将对象 <code>T</code> 转换为字符串 <code>String</code>。</li>
<li><strong>解析：</strong> 将字符串 <code>String</code> 还原为对象 <code>T</code>。</li>
</ol>
<pre><code class="hljs language-text" lang="text">核心思想： Formatter 模式的精髓在于分离关注点。它承认“数据是什么”和“数据如何展示”是两个截然不同的问题。通过引入一个专门的格式化器角色：
1. 领域对象可以保持纯净，只关注自身的业务属性和行为。
2. 格式化逻辑被集中管理和复用，易于统一修改和扩展。
3. 客户端代码无需关心格式化的细节，只需委托给合适的格式化器即可。
</code></pre>
<h2 data-id="heading-2">3. 应用</h2>
<p>Formatter 模式的应用场景无处不在，特别是在需要与用户交互或进行系统间通信的地方。</p>
<h3 data-id="heading-3">3.1 场景一：日期时间格式化</h3>
<p>这是最经典的应用。根据用户所在的地区显示不同格式的日期。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 内部统一使用 java.time 对象</span>
<span class="hljs-type">LocalDateTime</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> LocalDateTime.now();

<span class="hljs-comment">// 应用不同的“化妆师”</span>
<span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">chinaFormatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy年MM月dd日 HH:mm:ss"</span>, Locale.CHINA);
<span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">usFormatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(<span class="hljs-string">"MM/dd/yyyy hh:mm a"</span>, Locale.US);

<span class="hljs-type">String</span> <span class="hljs-variable">dateForChina</span> <span class="hljs-operator">=</span> now.format(chinaFormatter); <span class="hljs-comment">// "2024年01月01日 14:30:00"</span>
<span class="hljs-type">String</span> <span class="hljs-variable">dateForUS</span> <span class="hljs-operator">=</span> now.format(usFormatter);       <span class="hljs-comment">// "01/01/2024 02:30 PM"</span>
</code></pre>
<h3 data-id="heading-4">3.2 场景二：数字与货币格式化</h3>
<p>自动处理千分位、小数位数和货币符号。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">double</span> <span class="hljs-variable">price</span> <span class="hljs-operator">=</span> <span class="hljs-number">12345.6789</span>;

<span class="hljs-type">NumberFormat</span> <span class="hljs-variable">numberFormat</span> <span class="hljs-operator">=</span> NumberFormat.getNumberInstance(Locale.GERMANY);
<span class="hljs-type">String</span> <span class="hljs-variable">formattedNumber</span> <span class="hljs-operator">=</span> numberFormat.format(price); <span class="hljs-comment">// "12.345,679" - 德国使用点作为千分位，逗号作为小数点</span>

<span class="hljs-type">NumberFormat</span> <span class="hljs-variable">currencyFormat</span> <span class="hljs-operator">=</span> NumberFormat.getCurrencyInstance(Locale.CHINA);
<span class="hljs-type">String</span> <span class="hljs-variable">formattedCurrency</span> <span class="hljs-operator">=</span> currencyFormat.format(price); <span class="hljs-comment">// "￥12,345.68" - 自动四舍五入到两位小数并添加货币符号</span>
</code></pre>
<h3 data-id="heading-5">3.3 场景三：自定义对象格式化</h3>
<p>为领域对象定义专用的格式化器。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Product</span> {
    <span class="hljs-keyword">private</span> String name;
    <span class="hljs-keyword">private</span> BigDecimal price;
    <span class="hljs-comment">// ... getters</span>
}

<span class="hljs-comment">// 自定义格式化器</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ProductFormatter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Formatter</span>&lt;Product&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">print</span><span class="hljs-params">(Product product, Locale locale)</span> {
        <span class="hljs-keyword">return</span> String.format(<span class="hljs-string">"%s - %s"</span>, 
            product.getName(), 
            NumberFormat.getCurrencyInstance(locale).format(product.getPrice()));
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> Product <span class="hljs-title function_">parse</span><span class="hljs-params">(String text, Locale locale)</span> <span class="hljs-keyword">throws</span> ParseException {
        <span class="hljs-comment">// 实现从字符串解析回Product对象的逻辑</span>
        <span class="hljs-comment">// ... </span>
    }
}

<span class="hljs-comment">// 使用</span>
<span class="hljs-type">Product</span> <span class="hljs-variable">product</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Product</span>(<span class="hljs-string">"笔记本电脑"</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"5999.99"</span>));
<span class="hljs-type">ProductFormatter</span> <span class="hljs-variable">formatter</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductFormatter</span>();
<span class="hljs-type">String</span> <span class="hljs-variable">displayText</span> <span class="hljs-operator">=</span> formatter.print(product, Locale.CHINA); <span class="hljs-comment">// "笔记本电脑 - ￥5,999.99"</span>
</code></pre>
<h2 data-id="heading-6">4. 开源代码解析</h2>
<p>Formatter 模式在众多开源框架中有着至关重要且优雅的实现。</p>
<h3 data-id="heading-7">4.1 <code>DateTimeFormatter</code>：时间格式化标准实现</h3>
<p>Java 8 引入的日期时间 API 是 Formatter 模式的典范，<code>DateTimeFormatter</code> 的核心是一个不可变对象，它通过组合模式将格式化的步骤分解为不同的职责单元。</p>
<hr/>
<p><code>DateTimeFormatter</code> 的核心状态由以下几个 <code>final</code> 变量定义，确保了其不可变性和线程安全。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DateTimeFormatter</span> {
	<span class="hljs-comment">// 1. 格式/解析引擎：承载了模式字符串编译后的指令集，是执行格式化和解析操作的核心。</span>
	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> CompositePrinterParser printerParser;
	
	<span class="hljs-comment">// 2. 地域信息：控制文本（如月份、星期）的显示语言和地区相关的计算规则（如一周的第一天）。</span>
	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Locale locale;
	
	<span class="hljs-comment">// 3. 数字样式：控制数字相关符号，如小数点、正负号等。</span>
	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DecimalStyle decimalStyle;
	
	<span class="hljs-comment">// 4. 解析风格：决定解析时的严格程度，如STRICT（严格）、SMART（智能调整）、LENIENT（宽松计算）。</span>
	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ResolverStyle resolverStyle;
	
	<span class="hljs-comment">// 5. 需解析字段集：用于优化性能，指定需要解析和验证的字段集合；为null时表示处理所有字段。</span>
	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Set&lt;TemporalField&gt; resolverFields;
	
	<span class="hljs-comment">// 6. 年表（历法）：定义日期背后的日历系统，如ISO、ThaiBuddhist等；为null时使用默认ISO历法。</span>
	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Chronology chrono;
	
	<span class="hljs-comment">// 7. 默认时区：当被格式化的对象不含时区信息时，使用此时区进行补充；为null则表示不覆盖。</span>
	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ZoneId zone;
}
</code></pre>
<hr/>
<p><strong>第一步：入口方法 <code>format(TemporalAccessor temporal)</code></strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**  
 * Formats a date-time object using this formatter. 
 * This formats the date-time to a String using the rules of the formatter. 
 * <span class="hljs-doctag">@param</span> temporal  the temporal object to format, not null  
 * <span class="hljs-doctag">@return</span> the formatted string, not null 
 * <span class="hljs-doctag">@throws</span> DateTimeException if an error occurs during formatting  
 */</span><span class="hljs-keyword">public</span> String <span class="hljs-title function_">format</span><span class="hljs-params">(TemporalAccessor temporal)</span> {  
    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-number">32</span>);  
    formatTo(temporal, buf);  
    <span class="hljs-keyword">return</span> buf.toString();  
}
</code></pre>
<ul>
<li><strong>目的</strong>：提供最简洁的API，接受一个日期时间对象，返回格式化后的字符串。</li>
<li><strong>动作</strong>：创建一个 <code>StringBuilder</code> 作为结果容器，然后调用重载的 <code>formatTo</code> 方法。</li>
</ul>
<hr/>
<p><strong>第二步：准备上下文 <code>formatTo(TemporalAccessor temporal, Appendable appendable)</code></strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**  
 * Formats a date-time object to an {<span class="hljs-doctag">@code</span> Appendable} using this formatter. 
 * This outputs the formatted date-time to the specified destination. 
 * {<span class="hljs-doctag">@link</span> Appendable} is a general purpose interface that is implemented by all  
 * key character output classes including {<span class="hljs-doctag">@code</span> StringBuffer}, {<span class="hljs-doctag">@code</span> StringBuilder}, 
 * {<span class="hljs-doctag">@code</span> PrintStream} and {<span class="hljs-doctag">@code</span> Writer}. 
 * Although {<span class="hljs-doctag">@code</span> Appendable} methods throw an {<span class="hljs-doctag">@code</span> IOException}, this method does not. 
 * Instead, any {<span class="hljs-doctag">@code</span> IOException} is wrapped in a runtime exception. 
 * <span class="hljs-doctag">@param</span> temporal  the temporal object to format, not null  
 * <span class="hljs-doctag">@param</span> appendable  the appendable to format to, not null  
 * <span class="hljs-doctag">@throws</span> DateTimeException if an error occurs during formatting  
 */</span>
 <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">formatTo</span><span class="hljs-params">(TemporalAccessor temporal, Appendable appendable)</span> {  
    Objects.requireNonNull(temporal, <span class="hljs-string">"temporal"</span>);  
    Objects.requireNonNull(appendable, <span class="hljs-string">"appendable"</span>);  
    <span class="hljs-keyword">try</span> {  
        <span class="hljs-type">DateTimePrintContext</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTimePrintContext</span>(temporal, <span class="hljs-built_in">this</span>);  
        <span class="hljs-keyword">if</span> (appendable <span class="hljs-keyword">instanceof</span> StringBuilder) {  
            printerParser.format(context, (StringBuilder) appendable);  
        } <span class="hljs-keyword">else</span> {  
            <span class="hljs-comment">// buffer output to avoid writing to appendable in case of error  </span>
            <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-number">32</span>);  
            printerParser.format(context, buf);  
            appendable.append(buf);  
        }  
    } <span class="hljs-keyword">catch</span> (IOException ex) {  
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DateTimeException</span>(ex.getMessage(), ex);  
    }  
}
</code></pre>
<ul>
<li><strong>目的</strong>：初始化格式化操作所需的上下文环境。</li>
<li><strong>动作</strong>：创建 <code>DateTimePrintContext</code> 对象
<ul>
<li>要格式化的目标对象 (<code>temporal</code>)</li>
<li>当前格式化器 (<code>this</code>) 的配置信息，如 <code>locale</code>, <code>decimalStyle</code> 等。</li>
</ul>
</li>
</ul>
<hr/>
<p><strong>第三步：引擎执行 <code>printerParser.format(context, appendable)</code></strong></p>
<p>这里的 <code>printerParser</code> 是 <code>CompositePrinterParser</code> 的一个实例。</p>
<p><strong><code>CompositePrinterParser</code> 是什么？</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CompositePrinterParser</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">DateTimePrinterParser</span> {  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DateTimePrinterParser[] printerParsers;  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> optional;
}
</code></pre>
<p>当使用 <code>DateTimeFormatter.ofPattern("yyyy-MM-dd")</code> 时，这个模式字符串会被解析并编译成三个子处理器（<code>PrinterParser</code>）：</p>
<ol>
<li>一个用于处理4位年份的 <code>NumberPrinterParser</code></li>
<li>一个用于输出字面量 <code>'-'</code> 的 <code>StringLiteralPrinterParser</code></li>
<li>一个用于处理2位月份的 <code>NumberPrinterParser</code> ... 以此类推。</li>
</ol>
<p><strong><code>format</code> 方法在组合处理器内部：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>  
<span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">format</span><span class="hljs-params">(DateTimePrintContext context, StringBuilder buf)</span> {  
    <span class="hljs-type">int</span> <span class="hljs-variable">length</span> <span class="hljs-operator">=</span> buf.length();  
    <span class="hljs-keyword">if</span> (optional) {  
        context.startOptional();  
    }  
    <span class="hljs-keyword">try</span> {  
        <span class="hljs-keyword">for</span> (DateTimePrinterParser pp : printerParsers) {  
            <span class="hljs-keyword">if</span> (pp.format(context, buf) == <span class="hljs-literal">false</span>) {  
                buf.setLength(length);  <span class="hljs-comment">// reset buffer  </span>
                <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  
            }  
        }  
    } <span class="hljs-keyword">finally</span> {  
        <span class="hljs-keyword">if</span> (optional) {  
            context.endOptional();  
        }  
    }  
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;  
}
</code></pre>
<ul>
<li><strong>目的</strong>：按顺序执行组合处理器（<code>CompositePrinterParser</code>）中的所有子处理器（<code>printerParsers</code>），并确保在遇到失败时，如果该组合是一个可选节，能够正确地回滚状态，避免输出部分结果。</li>
<li><strong>补充</strong>：如果这个 <code>CompositePrinterParser</code> 被标记为 <code>optional</code>（例如，由 <code>DateTimeFormatterBuilder.optionalStart()</code> 创建），则通知格式化上下文（<code>DateTimePrintContext</code>）开始一个可选节。在“可选节”内，<code>pp.format(context, buf)</code>这段代码当从 <code>TemporalAccessor</code> 查询字段值时，如果该字段不存在，可能会返回一个“失败”状态，而不是直接抛出异常。这为后续的回滚判断提供了依据。</li>
</ul>
<hr/>
<p><strong>第四步：结合代码示例回顾上面的流程</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 1. 创建一个包含可选节的格式化器</span>
<span class="hljs-type">DateTimeFormatter</span> <span class="hljs-variable">formatter</span> <span class="hljs-operator">=</span> DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM['XX']"</span>);
<span class="hljs-comment">// 2. 格式化一个LocalDate（没有"XX"需要的数据）</span>
<span class="hljs-type">String</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> formatter.format(LocalDate.of(<span class="hljs-number">2024</span>, <span class="hljs-number">5</span>, <span class="hljs-number">24</span>));
System.out.println(result); <span class="hljs-comment">// 输出: 2024-05</span>
</code></pre>
<ol>
<li>初始化 <code>printerParsers</code> 列表 模式 <code>"yyyy-MM['XX']"</code> 被编译成如下结构：</li>
</ol>
<pre><code class="hljs language-java" lang="java">printerParsers = [
    NumberPrinterParser(YEAR),    <span class="hljs-comment">// 处理 yyyy</span>
    StringLiteralPrinterParser(<span class="hljs-string">"-"</span>), <span class="hljs-comment">// 处理 -</span>
    NumberPrinterParser(MONTH),   <span class="hljs-comment">// 处理 MM</span>
    CompositePrinterParser([      <span class="hljs-comment">// 处理 ['XX']，标记为 optional=true</span>
        StringLiteralPrinterParser(<span class="hljs-string">"XX"</span>)
    ], optional=<span class="hljs-literal">true</span>)
]
</code></pre>
<ol start="2">
<li>格式化执行过程
<ul>
<li>前三个处理器正常执行，<code>buf</code> 变为 <code>"2024-05"</code>。</li>
<li>执行可选节 <code>['XX']</code>：
<ul>
<li>记录起点：<code>length = 8</code>（"2024-05"的长度）</li>
<li>执行子处理器 <code>StringLiteralPrinterParser("XX")</code>：
<ul>
<li>直接向 <code>buf</code> 追加 <code>"XX"</code>，<code>buf</code> 变为 <code>"2024-05XX"</code></li>
<li>返回 <code>true</code></li>
</ul>
</li>
</ul>
</li>
<li>循环结束，返回 <code>true</code></li>
</ul>
</li>
<li>最终结果：<code>"2024-05XX"</code></li>
</ol>
<h3 data-id="heading-8">4.2 <code>PatternLayout</code>： 日志系统中的Formatter</h3>
<p>在主流日志框架（如 Logback、Log4j 2）中，负责格式化的组件不叫 <code>Formatter</code>，而叫 <code>Layout</code> 或 <code>Formatter</code>，它的职责就是将一个日志事件（Log Event）转换成一条具体的日志字符串。</p>
<hr/>
<p><strong>第一步：SLF4J使用方式</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 典型的SLF4J使用方式</span>
logger.info(<span class="hljs-string">"订单{}创建成功，金额：{}"</span>, orderId, amount);
</code></pre>
<p><code>logger.info(String format, Object arg1, Object arg2)</code> -&gt; 实际调用的是底层实现（如 Logback）的 <code>Logger</code> 实现类。但在此之前，SLF4J 的门面层会先进行一个关键预处理：<strong>消息格式化</strong>。</p>
<hr/>
<p><strong>第二步：SLF4J 的参数化消息格式化</strong></p>
<p>SLF4J 不会直接将原始消息和参数传递给底层实现。它首先使用 <code>org.slf4j.helpers.MessageFormatter</code> 来将模板和参数合并成一个完整的字符串。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在 Logback 的 Logger 实现中（如 ch.qos.logback.classic.Logger）</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">info</span><span class="hljs-params">(String format, Object arg1, Object arg2)</span> {
    <span class="hljs-keyword">if</span> (!isInfoEnabled()) <span class="hljs-keyword">return</span>;
    <span class="hljs-comment">// 关键调用：格式化消息</span>
    <span class="hljs-type">FormattingTuple</span> <span class="hljs-variable">ft</span> <span class="hljs-operator">=</span> MessageFormatter.arrayFormat(format, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Object</span>[]{arg1, arg2});
    <span class="hljs-comment">// 然后调用过滤、追加等核心逻辑</span>
    filterAndLog_0_Or3Plus(<span class="hljs-literal">null</span>, Level.INFO, <span class="hljs-literal">null</span>, ft.getMessage(), ft.getThrowable());
}
</code></pre>
<p> <code>MessageFormatter.arrayFormat</code>：这个方法的核心是循环处理每个 <code>{}</code> 占位符，并将对应的参数值“格式化”成字符串后替换进去。这里的“格式化”非常朴素：对于非空参数，直接调用其 <code>toString()</code> 方法。<code>orderId</code> 和 <code>amount</code> 的 <code>toString()</code> 方法被调用，结果被拼接到字符串中。</p>
<pre><code class="hljs language-java" lang="java"> <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> FormattingTuple <span class="hljs-title function_">arrayFormat</span><span class="hljs-params">(String messagePattern, Object[] argArray)</span> {  
    <span class="hljs-type">Throwable</span> <span class="hljs-variable">throwableCandidate</span> <span class="hljs-operator">=</span> getThrowableCandidate(argArray);  
    Object[] args = argArray;  
    <span class="hljs-keyword">if</span> (throwableCandidate != <span class="hljs-literal">null</span>) {  
        args = trimmedCopy(argArray);  
    }  
  
    <span class="hljs-keyword">return</span> arrayFormat(messagePattern, args, throwableCandidate);  
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> FormattingTuple <span class="hljs-title function_">arrayFormat</span><span class="hljs-params">(String messagePattern, Object[] argArray, Throwable throwable)</span> {  
    <span class="hljs-keyword">if</span> (messagePattern == <span class="hljs-literal">null</span>) {  
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormattingTuple</span>((String)<span class="hljs-literal">null</span>, argArray, throwable);  
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (argArray == <span class="hljs-literal">null</span>) {  
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormattingTuple</span>(messagePattern);  
    } <span class="hljs-keyword">else</span> {  
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;  
        <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">sbuf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(messagePattern.length() + <span class="hljs-number">50</span>);  
  
        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">L</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; L &lt; argArray.length; ++L) {  
            <span class="hljs-type">int</span> <span class="hljs-variable">j</span> <span class="hljs-operator">=</span> messagePattern.indexOf(<span class="hljs-string">"{}"</span>, i);  
            <span class="hljs-keyword">if</span> (j == -<span class="hljs-number">1</span>) {  
                <span class="hljs-keyword">if</span> (i == <span class="hljs-number">0</span>) {  
                    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormattingTuple</span>(messagePattern, argArray, throwable);  
                }  
  
                sbuf.append(messagePattern, i, messagePattern.length());  
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormattingTuple</span>(sbuf.toString(), argArray, throwable);  
            }  
  
            <span class="hljs-keyword">if</span> (isEscapedDelimeter(messagePattern, j)) {  
                <span class="hljs-keyword">if</span> (!isDoubleEscaped(messagePattern, j)) {  
                    --L;  
                    sbuf.append(messagePattern, i, j - <span class="hljs-number">1</span>);  
                    sbuf.append(<span class="hljs-string">'{'</span>);  
                    i = j + <span class="hljs-number">1</span>;  
                } <span class="hljs-keyword">else</span> {  
                    sbuf.append(messagePattern, i, j - <span class="hljs-number">1</span>);  
                    deeplyAppendParameter(sbuf, argArray[L], <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>());  
                    i = j + <span class="hljs-number">2</span>;  
                }  
            } <span class="hljs-keyword">else</span> {  
                sbuf.append(messagePattern, i, j);  
                deeplyAppendParameter(sbuf, argArray[L], <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>());  
                i = j + <span class="hljs-number">2</span>;  
            }  
        }  
  
        sbuf.append(messagePattern, i, messagePattern.length());  
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormattingTuple</span>(sbuf.toString(), argArray, throwable);  
    }  
}
</code></pre>
<hr/>
<p><strong>第三步：构建日志事件 (<code>ILoggingEvent</code>) 并交由 Logback 的 <code>Layout</code></strong></p>
<p>第二步结束时，我们停在了 Logback 的 <code>Logger</code> 实现类中的 <code>filterAndLog_0_Or3Plus</code> 方法。这个方法名看起来很复杂，但它本质上是日志记录的核心路由方法。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在 ch.qos.logback.classic.Logger 中</span>
<span class="hljs-comment">// 这是一个处理日志事件的核心方法</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">filterAndLog_0_Or3Plus</span><span class="hljs-params">(String localFQCN, Level level, Marker marker, String msg, Object[] params, Throwable t)</span> {

    <span class="hljs-comment">// 检查过滤器链，如果被拒绝则直接返回</span>
    <span class="hljs-type">FilterReply</span> <span class="hljs-variable">decision</span> <span class="hljs-operator">=</span> loggerContext.getTurboFilterChainDecision_0_3OrMore(marker, <span class="hljs-built_in">this</span>, level, msg, params, t);
    <span class="hljs-keyword">if</span> (decision == FilterReply.DENY) {
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 最关键的一行：构建日志事件 (ILoggingEvent)</span>
    <span class="hljs-type">LoggingEvent</span> <span class="hljs-variable">loggingEvent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoggingEvent</span>(localFQCN, <span class="hljs-built_in">this</span>, level, msg, t, params);

    <span class="hljs-comment">// 继续后续的日志记录流程</span>
    <span class="hljs-keyword">if</span> (decision != FilterReply.NEUTRAL) {
        <span class="hljs-comment">// 如果过滤器明确接受，则直接记录，跳过级别检查</span>
        log(<span class="hljs-literal">null</span>, localFQCN, level, marker, msg, params, t);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 否则，进行常规的级别检查后记录</span>
        <span class="hljs-keyword">if</span> (isEnabledFor(level, marker)) {
            log(loggingEvent, localFQCN, level, marker, msg, params, t);
        }
    }
}
</code></pre>
<p>在构建 <code>LoggingEvent</code> 时，它存储的是<strong>原始的、未格式化的消息模板</strong> (<code>message</code>) 和<strong>参数数组</strong> (<code>argArray</code>)，而不是第二步中 <code>MessageFormatter</code> 生成的那个完整字符串。在 <code>LoggingEvent</code> 类中，有一个 <code>getFormattedMessage()</code> 方法，可以实现延迟计算获取消息的逻辑。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 在 ch.qos.logback.classic.LoggingEvent 中</span>
<span class="hljs-keyword">public</span> <span class="hljs-title function_">LoggingEvent</span><span class="hljs-params">(String fqcn, Logger logger, Level level, String message, Throwable throwable, Object[] argArray)</span> {
    <span class="hljs-built_in">this</span>.fqcn = fqcn;
    <span class="hljs-built_in">this</span>.logger = logger;
    <span class="hljs-built_in">this</span>.level = level;
    <span class="hljs-built_in">this</span>.message = message;   <span class="hljs-comment">// 注意：这里存的是原始消息模板 "订单{}创建成功，金额：{}"</span>
    <span class="hljs-built_in">this</span>.throwable = throwable;
    <span class="hljs-built_in">this</span>.argArray = argArray; <span class="hljs-comment">// 以及参数数组 [orderId, amount]</span>
    <span class="hljs-built_in">this</span>.timeStamp = System.currentTimeMillis(); <span class="hljs-comment">// 记录时间戳</span>
    <span class="hljs-built_in">this</span>.threadName = Thread.currentThread().getName(); <span class="hljs-comment">// 记录线程名</span>
    <span class="hljs-comment">// ... 其他初始化</span>
}
</code></pre>
<hr/>
<p><strong>第四步：<code>Layout</code> 的格式化 (<code>PatternLayout.doLayout</code>)</strong></p>
<p><code>Layout</code>（通常是 <code>PatternLayout</code>）的职责是将整个 <code>ILoggingEvent</code> 对象格式成一整行有特定格式的日志字符串。假设配置的模式是：<code>%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger - %msg%n</code></p>
<p><strong><code>PatternLayout</code> 的工作流程：</strong></p>
<ol>
<li><strong>解析模式字符串</strong>：将 <code>%d</code>、<code>%thread</code>、<code>%msg</code> 等转换符解析出来。</li>
<li><strong>构建转换器链</strong>：为每个转换符创建一个对应的 <code>Converter</code> 对象，并链接起来。</li>
<li><strong>遍历转换器链</strong>：依次调用每个 <code>Converter</code> 的 <code>write</code> 方法。</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PatternLayout</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AbstractStringLayout</span> {  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_CONVERSION_PATTERN</span> <span class="hljs-operator">=</span> <span class="hljs-string">"%m%n"</span>;  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">TTCC_CONVERSION_PATTERN</span> <span class="hljs-operator">=</span> <span class="hljs-string">"%r [%t] %p %c %notEmpty{%x }- %m%n"</span>;  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SIMPLE_CONVERSION_PATTERN</span> <span class="hljs-operator">=</span> <span class="hljs-string">"%d [%t] %p %c - %m%n"</span>;  
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">KEY</span> <span class="hljs-operator">=</span> <span class="hljs-string">"Converter"</span>;  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String conversionPattern;  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> PatternSelector patternSelector;  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AbstractStringLayout.Serializer eventSerializer;
    
    <span class="hljs-comment">//...</span>
}
</code></pre>
<p><strong>PatternLayoutBase 的核心方法如下：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">protected</span> String <span class="hljs-title function_">writeLoopOnConverters</span><span class="hljs-params">(E event)</span> {
    <span class="hljs-type">StringBuilder</span> <span class="hljs-variable">strBuilder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">StringBuilder</span>(<span class="hljs-number">128</span>);
    Converter&lt;E&gt; c = headConverter;
    <span class="hljs-keyword">while</span> (c != <span class="hljs-literal">null</span>) {
        c.write(strBuilder, event); <span class="hljs-comment">// 委托给每个转换器</span>
        c = c.getNext();
    }
    <span class="hljs-keyword">return</span> strBuilder.toString();
}
</code></pre>
<p><strong>以 <code>%msg</code> 对应的 <code>MessageConverter</code> 为例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageConverter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Converter</span>&lt;ILoggingEvent&gt; {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">write</span><span class="hljs-params">(StringBuilder buf, ILoggingEvent event)</span> {
        <span class="hljs-comment">// 直接追加在第一步中由 MessageFormatter 生成好的消息字符串</span>
        buf.append(event.getFormattedMessage());
    }
}
</code></pre>
<p><strong>以 <code>%d</code> 对应的 <code>DateConverter</code> 为例：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DateConverter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Converter</span>&lt;ILoggingEvent&gt; {
    <span class="hljs-keyword">private</span> DateTimeFormatter dtf; <span class="hljs-comment">// 内部使用 java.time.format.DateTimeFormatter</span>

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">write</span><span class="hljs-params">(StringBuilder buf, ILoggingEvent event)</span> {
        <span class="hljs-keyword">if</span> (dtf == <span class="hljs-literal">null</span>) {
            dtf = DateTimeFormatter.ofPattern(<span class="hljs-string">"yyyy-MM-dd HH:mm:ss"</span>);
        }
        <span class="hljs-type">String</span> <span class="hljs-variable">dateStr</span> <span class="hljs-operator">=</span> dtf.format(<span class="hljs-comment">/* 从event中获取时间戳并转换 */</span>);
        buf.append(dateStr);
    }
}
</code></pre>
<p>最终，所有这些 <code>Converter</code> 的输出被拼接起来，形成最终日志行： <code>2024-05-24 14:30:00 [http-nio-8080-exec-1] INFO c.example.OrderService - 订单12345创建成功，金额：99.99</code></p>
<h2 data-id="heading-9">5. 总结</h2>
<p>Formatter 模式的本质远不止是简单的字符串拼接或类型转换。其核心设计思想是：在数据的内部表示与外部表示之间建立一个双向的“转换层”，从而将格式化和解析的复杂逻辑封装起来，实现对数据表现形式的管理、控制和扩展。</p>
<p>它深刻体现了以下几个经典设计模式的思想：</p>
<ol>
<li><strong>策略模式：</strong> <code>Formatter</code> 接口定义了一个可互换的算法家族。针对同一类型（如 <code>Date</code>），可以有多种格式化策略（如 <code>ISO</code> 格式、中文格式、自定义格式）。系统可以根据上下文（如注解、区域设置）轻松地切换不同的策略，而无需修改客户端代码。</li>
<li><strong>装饰器模式：</strong> 可以将原始的对象到字符串的转换（如 <code>toString()</code>）视作基础功能。而 <code>Formatter</code> 在其之上“装饰”了更强大的能力，如<strong>本地化支持</strong>、<strong>模式化输出</strong>和<strong>异常处理</strong>，从而提供了更丰富、更健壮的转换行为，同时保持了客户端调用接口的简洁性。</li>
<li><strong>工厂模式：</strong> 在注解驱动的场景下（如 <code>@DateTimeFormat</code>），<code>AnnotationFormatterFactory</code> 扮演了<strong>抽象工厂</strong>的角色。它根据字段上的元数据（注解）动态地创建和配置具体的 <code>Formatter</code> 实例，将对象的创建逻辑与使用逻辑彻底解耦，实现了高度的灵活性。</li>
</ol>
<p><strong>核心价值：</strong> 将“数据表示转换”这一常见需求，从一个容易出错、散布各处的过程式代码，提升为一个可复用、可配置、可测试的架构性组件。</p>
<hr/>
<p><strong>思考与探讨</strong></p>
<ol>
<li>
<p><strong>格式化的边界在哪里：</strong> Formatter 应该只负责“表现层”的格式（如日期显示为 <code>yyyy-MM-dd</code>），还是可以包含“业务逻辑”的转换（如将订单状态枚举 <code>PAID</code> 显示为“已支付”）？</p>
</li>
<li>
<p><strong>性能与资源的权衡：</strong> 像 <code>DateTimeFormatter</code> 这样的线程安全、不可变对象，创建成本较高，因此需要复用。在 Web 等高并发场景下，你是如何管理和缓存 Formatter 实例的？</p>
</li>
</ol>
<hr/>
<p><strong>下一篇预告：</strong> 在下一篇文章 《【基础数据篇】数据等价裁判：Comparer模式》中，我们将探讨 <code>equals</code>、<code>hashCode</code> 与 <code>Comparator</code> 如何协同工作，为集合操作、排序和唯一性判断建立可靠的标准，并深入解析其在构建稳定、可预测的软件系统中所扮演的基石角色。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手写Spring事务框架：200行代码揭开@Transactional的神秘面纱（ 附完整源代码）]]></title>    <link>https://juejin.cn/post/7577690150093242408</link>    <guid>https://juejin.cn/post/7577690150093242408</guid>    <pubDate>2025-11-30T03:23:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577690150093242408" data-draft-id="7577690150093226024" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手写Spring事务框架：200行代码揭开@Transactional的神秘面纱（ 附完整源代码）"/> <meta itemprop="keywords" content="Spring,Spring Boot,Spring Cloud"/> <meta itemprop="datePublished" content="2025-11-30T03:23:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手写Spring事务框架：200行代码揭开@Transactional的神秘面纱（ 附完整源代码）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T03:23:57.000Z" title="Sun Nov 30 2025 03:23:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">写在前面</h2>
<p>之前我在项目里写过好几篇关于事务的文章，比如在mall商城里怎么用@Transactional、碰到哪些诡异的坑、事务传播行为REQUIRED和REQUIRES_NEW的区别啥的。但说实话，每次写完都觉得有点虚，总感觉是在"知道怎么用"和"理解为什么"之间打转。</p>
<p>后来我就想，干脆自己手写一个简化版的事务框架吧，把Spring那套@Transactional的核心逻辑剥出来，看看到底是咋回事。这不，花了半天时间（对，就半天），用JDK+JDBC撸了个200来行的事务管理框架，还真就跑通了。</p>
<p>今天这篇文章，就把这个过程和踩的坑分享给大家。</p>
<h2 data-id="heading-1">为什么要手写？看源码不香吗？</h2>
<p>有同学可能会问：Spring源码就在那，为啥不直接看？</p>
<p>我当时也这么想过，但看Spring事务源码有个问题 —— <strong>抽象层太多了</strong>。什么PlatformTransactionManager、TransactionDefinition、TransactionStatus，一层套一层，看着看着就晕了，很难抓住本质。</p>
<p>后来我换了个思路：<strong>先自己实现最简单能跑通的版本，再去对比Spring的实现</strong>。这样反而更清楚哪些是核心逻辑，哪些是为了扩展性做的设计。</p>
<p>就像学做菜，你得先会做个西红柿炒蛋，再去研究米其林大厨的番茄料理，对吧？</p>
<h2 data-id="heading-2">事务的本质到底是啥？</h2>
<p>我们先把Spring那套复杂的东西放一边，想想事务在数据库层面到底是咋回事。</p>
<p>其实就三步：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> dataSource.getConnection();
conn.setAutoCommit(<span class="hljs-literal">false</span>);  <span class="hljs-comment">// 关键：关闭自动提交</span>

<span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 执行你的SQL操作</span>
    insertOrder(...);
    insertOrderItems(...);
    
    conn.commit();  <span class="hljs-comment">// 成功就提交</span>
} <span class="hljs-keyword">catch</span> (Exception e) {
    conn.rollback();  <span class="hljs-comment">// 失败就回滚</span>
} <span class="hljs-keyword">finally</span> {
    conn.setAutoCommit(<span class="hljs-literal">true</span>);  <span class="hljs-comment">// 记得恢复</span>
    conn.close();
}
</code></pre>
<p>看，就这么简单！<strong>事务的本质就是把Connection的自动提交关了，然后你手动控制commit还是rollback</strong>。</p>
<p>那Spring的@Transactional做了啥？无非就是帮你把这个try-catch-finally的模板代码给封装了，你只要打个注解就行。</p>
<p>明白这点之后，我们的目标就清晰了：<strong>用AOP拦截带@Transactional注解的方法，在方法执行前后自动加上这套逻辑</strong>。</p>
<h2 data-id="heading-3">整体设计：分层要清晰</h2>
<p>我当时设计的时候，参考了Spring的思路，把职责分了几层：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    A[业务代码] --&gt; B[动态代理 ProxyFactory]
    B --&gt; C[事务拦截器 TransactionInterceptor]
    C --&gt; D[事务管理器 TransactionManager]
    D --&gt; E[事务上下文 TransactionContext]
    E --&gt; F[数据库连接 Connection]
    
    style C fill:#f9f,stroke:#333,stroke-width:2px
    style E fill:#bbf,stroke:#333,stroke-width:2px
</code></pre>
<p><strong>几个核心组件：</strong></p>
<ol>
<li><strong>@Transactional注解</strong>：标记哪些方法需要事务</li>
<li><strong>ProxyFactory</strong>：用JDK动态代理给你的业务类套一层</li>
<li><strong>TransactionInterceptor</strong>：拦截器，真正干活的地方</li>
<li><strong>TransactionManager</strong>：管理事务的开启、提交、回滚</li>
<li><strong>TransactionContext</strong>：用ThreadLocal保存当前线程的事务信息</li>
</ol>
<p>这个分层其实就是Spring的简化版，但麻雀虽小五脏俱全。</p>
<h2 data-id="heading-4">先从最简单的开始：注解定义</h2>
<p>注解部分很简单，就几个属性：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span>
<span class="hljs-meta">@Target({ElementType.METHOD, ElementType.TYPE})</span>
<span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> Transactional {
    Propagation <span class="hljs-title function_">propagation</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> Propagation.REQUIRED;
    Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Throwable</span>&gt;[] rollbackFor() <span class="hljs-keyword">default</span> {};
    <span class="hljs-type">int</span> <span class="hljs-title function_">timeout</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> -<span class="hljs-number">1</span>;
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">readOnly</span><span class="hljs-params">()</span> <span class="hljs-keyword">default</span> <span class="hljs-literal">false</span>;
}

<span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> <span class="hljs-title class_">Propagation</span> {
    REQUIRED,   <span class="hljs-comment">// 有事务就加入，没有就新建</span>
    SUPPORTS    <span class="hljs-comment">// 有事务就加入，没有就算了</span>
}
</code></pre>
<p>这里我只实现了REQUIRED和SUPPORTS，因为这俩最常用。REQUIRES_NEW、NESTED那些留到第二阶段再说。</p>
<h2 data-id="heading-5">关键中的关键：ThreadLocal管理事务上下文</h2>
<p>这块是我当时花时间最多的地方。为什么要用ThreadLocal？</p>
<p>想想这个场景：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 外层方法</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">outerMethod</span><span class="hljs-params">()</span> {
    insertOrder();
    innerMethod();  <span class="hljs-comment">// 调用内层方法</span>
}

<span class="hljs-comment">// 内层方法</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">innerMethod</span><span class="hljs-params">()</span> {
    insertOrderItems();
}
</code></pre>
<p>外层和内层都有@Transactional，它们应该<strong>共享同一个数据库连接</strong>，要么一起提交，要么一起回滚。怎么做到的？</p>
<p>答案就是ThreadLocal。每个线程持有自己的ConnectionHolder，里面放着Connection和各种状态信息：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TransactionContext</span> {
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> ThreadLocal&lt;ConnectionHolder&gt; CONTEXT = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();
    
    <span class="hljs-comment">// 开启事务：绑定连接到当前线程</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">bindNewConnection</span><span class="hljs-params">(DataSource ds, <span class="hljs-type">boolean</span> readOnly, Integer timeout)</span> {
        <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> ds.getConnection();
        conn.setAutoCommit(<span class="hljs-literal">false</span>);  <span class="hljs-comment">// 关闭自动提交</span>
        conn.setReadOnly(readOnly);
        
        <span class="hljs-type">ConnectionHolder</span> <span class="hljs-variable">holder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ConnectionHolder</span>(conn);
        holder.setActive(<span class="hljs-literal">true</span>);
        CONTEXT.set(holder);  <span class="hljs-comment">// 绑定到ThreadLocal</span>
    }
    
    <span class="hljs-comment">// 获取当前线程的连接</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> Connection <span class="hljs-title function_">getCurrentConnection</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ConnectionHolder</span> <span class="hljs-variable">holder</span> <span class="hljs-operator">=</span> CONTEXT.get();
        <span class="hljs-keyword">return</span> holder != <span class="hljs-literal">null</span> ? holder.getConnection() : <span class="hljs-literal">null</span>;
    }
    
    <span class="hljs-comment">// 清理资源</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> {
        <span class="hljs-type">ConnectionHolder</span> <span class="hljs-variable">holder</span> <span class="hljs-operator">=</span> CONTEXT.get();
        <span class="hljs-keyword">if</span> (holder != <span class="hljs-literal">null</span>) {
            holder.getConnection().setReadOnly(<span class="hljs-literal">false</span>);
            holder.getConnection().setAutoCommit(<span class="hljs-literal">true</span>);  <span class="hljs-comment">// 恢复自动提交</span>
            holder.getConnection().close();
        }
        CONTEXT.remove();  <span class="hljs-comment">// 这个很重要，防止内存泄漏</span>
    }
}
</code></pre>
<p>这里有个坑我当时被折腾惨了：<strong>一定要记得ThreadLocal.remove()</strong>。</p>
<p>我一开始没加这行，在多线程测试的时候，发现有的线程会莫名其妙拿到别的线程的连接，查了半天才发现是因为Tomcat的线程池会复用线程，如果你不remove，上一次的ConnectionHolder就还在那。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant 线程1
    participant ThreadLocal
    participant 线程池
    
    线程1-&gt;&gt;ThreadLocal: set(holder1)
    线程1-&gt;&gt;线程1: 执行业务
    线程1-&gt;&gt;ThreadLocal: 忘记remove()
    线程1-&gt;&gt;线程池: 归还线程
    
    Note over 线程池,ThreadLocal: 线程1被复用执行新任务
    
    线程池-&gt;&gt;线程1: 分配给新任务
    线程1-&gt;&gt;ThreadLocal: get()
    ThreadLocal--&gt;&gt;线程1: 返回holder1 (旧的!)
    
    Note over 线程1: 悲剧：拿到上次的连接
</code></pre>
<p>所以我的建议是：<strong>在finally块里统一清理，无论commit还是rollback</strong>。</p>
<h2 data-id="heading-6">拦截器：整个框架的灵魂</h2>
<p>拦截器是整个框架最复杂的部分，因为它要处理各种情况。我们来看看核心逻辑：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable {
    <span class="hljs-comment">// 1. 解析@Transactional注解</span>
    <span class="hljs-type">TransactionAttribute</span> <span class="hljs-variable">attr</span> <span class="hljs-operator">=</span> parseAnnotation(method, target.getClass());
    <span class="hljs-keyword">if</span> (attr == <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> method.invoke(target, args);  <span class="hljs-comment">// 没注解直接执行</span>
    }
    
    <span class="hljs-comment">// 2. 判断是否已经有事务</span>
    <span class="hljs-type">boolean</span> <span class="hljs-variable">existing</span> <span class="hljs-operator">=</span> TransactionContext.isActive();
    <span class="hljs-type">boolean</span> <span class="hljs-variable">started</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;
    
    <span class="hljs-comment">// 3. REQUIRED传播：没事务就新建</span>
    <span class="hljs-keyword">if</span> (attr.getPropagation() == Propagation.REQUIRED &amp;&amp; !existing) {
        txManager.begin(attr.isReadOnly(), attr.getTimeout());
        started = <span class="hljs-literal">true</span>;
    }
    
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 4. 执行业务方法</span>
        <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> method.invoke(target, args);
        
        <span class="hljs-comment">// 5. 正常返回：提交</span>
        <span class="hljs-keyword">if</span> (started) {
            <span class="hljs-keyword">if</span> (TransactionContext.isRollbackOnly()) {
                txManager.rollback();  <span class="hljs-comment">// 有人标记了回滚</span>
            } <span class="hljs-keyword">else</span> {
                txManager.commit();
            }
        }
        <span class="hljs-keyword">return</span> result;
        
    } <span class="hljs-keyword">catch</span> (InvocationTargetException e) {
        <span class="hljs-type">Throwable</span> <span class="hljs-variable">ex</span> <span class="hljs-operator">=</span> e.getTargetException();
        
        <span class="hljs-comment">// 6. 判断是否要回滚</span>
        <span class="hljs-type">boolean</span> <span class="hljs-variable">shouldRollback</span> <span class="hljs-operator">=</span> (ex <span class="hljs-keyword">instanceof</span> RuntimeException || ex <span class="hljs-keyword">instanceof</span> Error)
            || matchRollbackFor(ex, attr.getRollbackFor());
        
        <span class="hljs-keyword">if</span> (shouldRollback) {
            <span class="hljs-keyword">if</span> (started) {
                txManager.rollback();  <span class="hljs-comment">// 我开启的事务，我负责回滚</span>
            } <span class="hljs-keyword">else</span> {
                TransactionContext.setRollbackOnly();  <span class="hljs-comment">// 标记给外层回滚</span>
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (started) {
                txManager.commit();  <span class="hljs-comment">// 受检异常默认提交</span>
            }
        }
        
        <span class="hljs-keyword">throw</span> ex;
    }
}
</code></pre>
<p>这里面有几个点要注意：</p>
<h3 data-id="heading-7">1. 异常回滚规则</h3>
<p>Spring的默认规则是：</p>
<ul>
<li><strong>RuntimeException和Error</strong>：回滚</li>
<li><strong>受检异常（Exception）</strong>：提交</li>
</ul>
<p>为什么这样设计？我理解是因为受检异常一般是可预期的业务异常，不应该导致整个事务回滚。但你可以通过rollbackFor显式指定：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">placeOrder</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-comment">// 现在所有异常都回滚</span>
}
</code></pre>
<h3 data-id="heading-8">2. 内外层事务的协作</h3>
<p>这是个容易搞混的地方。假设外层开启了事务，内层也有@Transactional，内层抛异常了咋办？</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant 外层方法
    participant 内层方法
    participant TransactionContext
    
    外层方法-&gt;&gt;TransactionContext: begin() 开启事务
    外层方法-&gt;&gt;内层方法: 调用
    内层方法-&gt;&gt;内层方法: 发现已有事务，加入
    内层方法-&gt;&gt;内层方法: 执行SQL
    内层方法--&gt;&gt;外层方法: 抛异常
    内层方法-&gt;&gt;TransactionContext: setRollbackOnly() 打标记
    外层方法-&gt;&gt;外层方法: catch到异常
    外层方法-&gt;&gt;TransactionContext: commit() 时检查标记
    TransactionContext-&gt;&gt;TransactionContext: 发现rollbackOnly=true
    TransactionContext-&gt;&gt;TransactionContext: 执行rollback
</code></pre>
<p>关键点：<strong>内层不能直接rollback，只能打个标记，让外层来统一处理</strong>。否则外层还想commit的时候，连接已经被回滚了，就乱套了。</p>
<h2 data-id="heading-9">一个被我忽略的坑：并发唯一键冲突</h2>
<p>写测试用例的时候，我犯了个低级错误。订单号我用时间戳生成的：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">orderNo</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ORD"</span> + System.currentTimeMillis();
</code></pre>
<p>结果多线程测试的时候，经常报唯一键冲突。后来想想也对，currentTimeMillis()精度才到毫秒，并发一高肯定会重复。</p>
<p>后来改成UUID就好了：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">String</span> <span class="hljs-variable">orderNo</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ORD-"</span> + UUID.randomUUID();
</code></pre>
<p>这个坑虽然简单，但提醒我们：<strong>生产环境的业务主键一定要用分布式ID生成器</strong>，比如雪花算法、号段模式啥的。时间戳这种玩具级别的方案真不能用。</p>
<h2 data-id="heading-10">几个要注意的地方</h2>
<h3 data-id="heading-11">1. 同类方法调用不生效</h3>
<p>这个是Spring事务的经典问题，我这个简化版也一样：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodA</span><span class="hljs-params">()</span> {
        methodB();  <span class="hljs-comment">// 这样调用，methodB的@Transactional不生效</span>
    }
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodB</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// ...</span>
    }
}
</code></pre>
<p>为啥？因为代理只能拦截<strong>从外部进来的调用</strong>，内部调用走的是this，不经过代理。</p>
<p>解决办法：</p>
<ul>
<li>要么拆到不同的类</li>
<li>要么通过注入的方式拿到代理对象自己</li>
</ul>
<h3 data-id="heading-12">2. 资源清理一定要放finally</h3>
<p>我一开始把clear()放在commit()和rollback()里，结果有些异常场景资源没释放，连接池很快就耗尽了。</p>
<p>后来统一放到finally块：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">if</span> (holder.isRollbackOnly()) {
        conn.rollback();
    } <span class="hljs-keyword">else</span> {
        conn.commit();
    }
} <span class="hljs-keyword">finally</span> {
    TransactionContext.clear();  <span class="hljs-comment">// 无论如何都要清理</span>
}
</code></pre>
<h3 data-id="heading-13">3. 注解解析的优先级</h3>
<p>方法级注解 &gt; 类级注解 &gt; 接口方法注解</p>
<p>这个顺序要记住，面试可能会问。</p>
<h2 data-id="heading-14">测试验证：眼见为实</h2>
<p>写完代码，我跑了几个测试场景：</p>
<p><strong>场景1：正常提交</strong></p>
<pre><code class="hljs language-java" lang="java">service.placeOrder(<span class="hljs-string">"U1001"</span>, <span class="hljs-string">"SKU-001"</span>, <span class="hljs-number">2</span>);
<span class="hljs-comment">// 数据库查询：有记录 </span>
</code></pre>
<p><strong>场景2：运行时异常回滚</strong></p>
<pre><code class="hljs language-java" lang="java">service.placeOrder(<span class="hljs-string">"U1002"</span>, <span class="hljs-string">"OUT_OF_STOCK"</span>, <span class="hljs-number">1</span>);  <span class="hljs-comment">// 内部抛RuntimeException</span>
<span class="hljs-comment">// 数据库查询：无记录 </span>
</code></pre>
<p><strong>场景3：受检异常需要rollbackFor</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">placeOrder</span><span class="hljs-params">(...)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-comment">// 抛Exception也会回滚 </span>
}
</code></pre>
<p><strong>场景4：传播行为REQUIRED</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">outerMethod</span><span class="hljs-params">()</span> {
    insertOrder();
    innerMethod();  <span class="hljs-comment">// 共享同一个事务</span>
}

<span class="hljs-comment">// 内层抛异常，外层也回滚 </span>
</code></pre>
<p><strong>场景5：多线程隔离</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 开5个线程并发下单</span>
<span class="hljs-type">ExecutorService</span> <span class="hljs-variable">executor</span> <span class="hljs-operator">=</span> Executors.newFixedThreadPool(<span class="hljs-number">5</span>);
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++) {
    executor.submit(() -&gt; service.placeOrder(...));
}
<span class="hljs-comment">// 每个线程独立的事务，互不影响 </span>
</code></pre>
<p>这几个场景跑下来，基本的事务功能就都验证了。</p>
<h2 data-id="heading-15">和Spring事务的对比</h2>
<p>写完之后，我又回去看了下Spring的源码，发现我这个简化版其实抓住了核心：</p>








































<table><thead><tr><th>功能</th><th>我的实现</th><th>Spring实现</th></tr></thead><tbody><tr><td>注解驱动</td><td>@Transactional</td><td>@Transactional</td></tr><tr><td>代理方式</td><td>JDK动态代理</td><td>JDK + CGLIB</td></tr><tr><td>传播行为</td><td>REQUIRED, SUPPORTS</td><td>7种传播行为</td></tr><tr><td>回滚规则</td><td>RuntimeException/Error + rollbackFor</td><td>同左</td></tr><tr><td>线程隔离</td><td>ThreadLocal</td><td>同左</td></tr><tr><td>资源管理</td><td>手动clear</td><td>TransactionSynchronizationManager</td></tr></tbody></table>
<p>Spring多的那些抽象层，主要是为了：</p>
<ul>
<li>支持更多传播行为（REQUIRES_NEW需要挂起当前事务）</li>
<li>支持JTA分布式事务</li>
<li>支持多种持久化框架（Hibernate、JPA等）</li>
<li>提供编程式事务API</li>
</ul>
<p>但<strong>核心原理是一样的</strong>：ThreadLocal + AOP + Connection控制。</p>
<h2 data-id="heading-16">现在明白了，下一步该干啥？</h2>
<p>现在我对Spring事务的理解，从"会用"升级到了"知道为什么"。下一步我打算：</p>
<ol>
<li><strong>加入CGLIB支持</strong>：现在只能代理接口，无接口的类还不行</li>
<li><strong>实现REQUIRES_NEW</strong>：这个需要挂起当前事务，涉及到事务栈的管理</li>
<li><strong>加入Druid监控</strong>：看看事务执行耗时、连接获取情况</li>
<li><strong>研究分布式事务</strong>：从2PC到TCC到Seata，慢慢啃</li>
</ol>
<p>说实话，分布式事务那块我还没研究透，Seata的AT模式看着有点懵，准备先把原理摸清楚再说。</p>
<h2 data-id="heading-17">写在最后</h2>
<p>这次手写事务框架，最大的收获是：<strong>不要怕造轮子</strong>。</p>
<p>很多时候我们会觉得"Spring都实现了，我还造啥轮子"。但其实，自己动手实现一遍，和只看源码、看文档，理解深度完全不一样。</p>
<p>就像我现在，以后看到@Transactional，脑子里能直接浮现出那个invoke方法、ThreadLocal的上下文、commit和rollback的逻辑，这种感觉还是挺爽的。</p>
<p>而且，这200行代码写完，我对事务相关的面试题基本都能答上来了：</p>
<ul>
<li>事务传播行为是啥？</li>
<li>为什么同类方法调用事务不生效？</li>
<li>受检异常默认不回滚是为啥？</li>
<li>多线程情况下事务怎么隔离？</li>
</ul>
<p>这些问题，以前是靠背，现在是真懂了。</p>
<p>代码我放到gitee了（链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fsh_wangwanbao%2Fsimple-spring-transaction" target="_blank" title="https://gitee.com/sh_wangwanbao/simple-spring-transaction" ref="nofollow noopener noreferrer">gitee.com/sh_wangwanb…</a> )
有兴趣的同学可以clone下来跑跑看。下一篇我打算写REQUIRES_NEW的实现，涉及到事务挂起和恢复，应该会更有意思。</p>
<hr/>
<p><strong>你们在用事务的时候，踩过哪些坑？欢迎评论区聊聊，说不定能帮我避免后面的一些问题。</strong></p>
<p>如果文章对您有帮助，辛苦点个赞支持下呗。您的支持，是我创作的最大动力，谢谢。</p>
<p>下篇文章见！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[5个测试用例带你彻底理解Spring事务传播行为（ 附完整源代码）]]></title>    <link>https://juejin.cn/post/7577690150093291560</link>    <guid>https://juejin.cn/post/7577690150093291560</guid>    <pubDate>2025-11-30T03:35:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577690150093291560" data-draft-id="7577713754563215412" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="5个测试用例带你彻底理解Spring事务传播行为（ 附完整源代码）"/> <meta itemprop="keywords" content="Spring,Spring Boot,Spring Cloud"/> <meta itemprop="datePublished" content="2025-11-30T03:35:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            5个测试用例带你彻底理解Spring事务传播行为（ 附完整源代码）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-30T03:35:27.000Z" title="Sun Nov 30 2025 03:35:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-30
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">5个测试用例带你彻底理解Spring事务传播行为（ 附完整源代码）</h2>
<h3 data-id="heading-1">写在前面</h3>
<p>说实话，Spring事务传播行为这块，我之前一直是半懂不懂的状态。</p>
<p>面试的时候能背出来7种传播行为，REQUIRED、REQUIRES_NEW、NESTED啥的，但要问我"内层方法抛异常，外层会不会回滚"，我就开始心虚了。看网上的文章，要么太理论讲不清楚，要么直接贴Spring源码让人更晕。</p>
<p>后来我干脆自己手写了个简化版的事务框架（上篇文章写过），把核心逻辑剥出来，然后写了5个测试用例，一个个跑一遍。现在可以拍着胸脯说：<strong>事务传播这块，我是真懂了</strong>。</p>
<p>今天这篇文章，就带你通过这5个测试用例，把事务传播行为彻底搞明白。</p>
<h3 data-id="heading-2">为什么传播行为这么难理解？</h3>
<p>我觉得主要是两个原因：</p>
<ol>
<li>
<p><strong>场景太抽象</strong>：文档里说"有事务就加入，没有就新建"，但"加入"到底是啥意思？共享一个连接？还是开个子事务？</p>
</li>
<li>
<p><strong>异常处理复杂</strong>：内层方法抛异常，外层要不要回滚？内层回滚了，外层还能提交吗？这些边界情况很容易搞混。</p>
</li>
</ol>
<p>所以我的思路是：<strong>用实际代码跑一遍，看看数据库里到底有没有数据，比看一万字的文档都管用</strong>。</p>
<h3 data-id="heading-3">测试环境准备</h3>
<p>为了让大家能直接复现，我先说说环境：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 数据库：MySQL 8.x</span>
<span class="hljs-keyword">CREATE</span> DATABASE sst_demo;

<span class="hljs-comment">-- 订单表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> orders (
  id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
  order_no <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">UNIQUE</span>,
  user_id <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  total_amount <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  status TINYINT <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">0</span>,
  created_at <span class="hljs-type">TIMESTAMP</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-built_in">CURRENT_TIMESTAMP</span>
);

<span class="hljs-comment">-- 订单明细表</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> order_items (
  id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">PRIMARY</span> KEY AUTO_INCREMENT,
  order_id <span class="hljs-type">BIGINT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  sku <span class="hljs-type">VARCHAR</span>(<span class="hljs-number">64</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  quantity <span class="hljs-type">INT</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>,
  price <span class="hljs-type">DECIMAL</span>(<span class="hljs-number">10</span>,<span class="hljs-number">2</span>) <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span>
);
</code></pre>
<p>业务场景就是下单：插入订单主表 + 插入明细表，这两步要么都成功，要么都失败。</p>
<h3 data-id="heading-4">测试1：正常提交 - 最基础的场景</h3>
<h4 data-id="heading-5">代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">placeOrder</span><span class="hljs-params">(String userId, String sku, <span class="hljs-type">int</span> quantity)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-type">Connection</span> <span class="hljs-variable">conn</span> <span class="hljs-operator">=</span> TransactionContext.getCurrentConnection();
    
    <span class="hljs-comment">// 1. 插入订单</span>
    <span class="hljs-type">String</span> <span class="hljs-variable">orderNo</span> <span class="hljs-operator">=</span> <span class="hljs-string">"ORD-"</span> + UUID.randomUUID();
    <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps</span> <span class="hljs-operator">=</span> conn.prepareStatement(
        <span class="hljs-string">"INSERT INTO orders(order_no, user_id, total_amount) VALUES(?, ?, ?)"</span>
    );
    ps.setString(<span class="hljs-number">1</span>, orderNo);
    ps.setString(<span class="hljs-number">2</span>, userId);
    ps.setBigDecimal(<span class="hljs-number">3</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"99.99"</span>));
    ps.executeUpdate();
    
    <span class="hljs-comment">// 2. 插入明细</span>
    <span class="hljs-type">long</span> <span class="hljs-variable">orderId</span> <span class="hljs-operator">=</span> getGeneratedId(ps);
    <span class="hljs-type">PreparedStatement</span> <span class="hljs-variable">ps2</span> <span class="hljs-operator">=</span> conn.prepareStatement(
        <span class="hljs-string">"INSERT INTO order_items(order_id, sku, quantity, price) VALUES(?, ?, ?, ?)"</span>
    );
    ps2.setLong(<span class="hljs-number">1</span>, orderId);
    ps2.setString(<span class="hljs-number">2</span>, sku);
    ps2.setInt(<span class="hljs-number">3</span>, quantity);
    ps2.setBigDecimal(<span class="hljs-number">4</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">BigDecimal</span>(<span class="hljs-string">"99.99"</span>));
    ps2.executeUpdate();
    
    System.out.println(<span class="hljs-string">"订单创建成功："</span> + orderNo);
}
</code></pre>
<h4 data-id="heading-6">运行结果</h4>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-comment">========== 测试1：正常提交 ==========</span>
订单创建成功：ORD-xxx
订单创建成功
</code></pre>
<h4 data-id="heading-7">验证</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id<span class="hljs-operator">=</span><span class="hljs-string">'U1001'</span>;
<span class="hljs-comment">-- 结果：有1条记录</span>

<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> order_items <span class="hljs-keyword">WHERE</span> order_id<span class="hljs-operator">=</span>...;
<span class="hljs-comment">-- 结果：有1条记录</span>
</code></pre>
<h4 data-id="heading-8">原理解析</h4>
<p>这个最简单，执行流程是这样的：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Client
    participant Proxy
    participant Interceptor
    participant TxManager
    participant DB
    
    Client-&gt;&gt;Proxy: placeOrder()
    Proxy-&gt;&gt;Interceptor: 拦截调用
    Interceptor-&gt;&gt;TxManager: begin() 开启事务
    TxManager-&gt;&gt;DB: setAutoCommit(false)
    Interceptor-&gt;&gt;DB: INSERT orders
    Interceptor-&gt;&gt;DB: INSERT order_items
    Interceptor-&gt;&gt;TxManager: commit()
    TxManager-&gt;&gt;DB: conn.commit()
    TxManager-&gt;&gt;DB: close()
</code></pre>
<p>关键点：</p>
<ol>
<li>拦截器在方法执行前调用<code>begin()</code>，拿到数据库连接并关闭自动提交</li>
<li>业务代码执行，在同一个连接上执行两条INSERT</li>
<li>方法正常返回，拦截器调用<code>commit()</code></li>
<li>最后清理资源，恢复autoCommit并关闭连接</li>
</ol>
<p>这就是事务的基本流程，没啥特别的。</p>
<h3 data-id="heading-9">测试2：运行时异常回滚 - Spring的默认行为</h3>
<h4 data-id="heading-10">代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 业务代码里模拟库存不足</span>
<span class="hljs-keyword">if</span> (<span class="hljs-string">"OUT_OF_STOCK"</span>.equals(sku)) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"库存不足，订单回滚"</span>);
}
</code></pre>
<h4 data-id="heading-11">运行结果</h4>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-comment">========== 测试2：运行时异常回滚 ==========</span>
捕获运行时异常：库存不足，订单回滚
</code></pre>
<h4 data-id="heading-12">验证</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id<span class="hljs-operator">=</span><span class="hljs-string">'U1002'</span>;
<span class="hljs-comment">-- 结果：无记录</span>

<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> order_items <span class="hljs-keyword">WHERE</span> sku<span class="hljs-operator">=</span><span class="hljs-string">'OUT_OF_STOCK'</span>;
<span class="hljs-comment">-- 结果：无记录</span>
</code></pre>
<h4 data-id="heading-13">原理解析</h4>
<p>这个是Spring的<strong>默认回滚规则</strong>：RuntimeException和Error会导致回滚。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Client
    participant Interceptor
    participant TxManager
    participant DB
    
    Client-&gt;&gt;Interceptor: placeOrder()
    Interceptor-&gt;&gt;TxManager: begin()
    TxManager-&gt;&gt;DB: setAutoCommit(false)
    Interceptor-&gt;&gt;DB: INSERT orders (成功)
    Interceptor-&gt;&gt;DB: INSERT order_items (成功)
    Interceptor-&gt;&gt;Interceptor: 抛RuntimeException
    Interceptor-&gt;&gt;TxManager: rollback()
    TxManager-&gt;&gt;DB: conn.rollback()
    
    Note over DB: orders和order_items都被回滚
</code></pre>
<p>关键点：</p>
<ol>
<li>虽然两条INSERT都执行成功了，但还没commit</li>
<li>抛出RuntimeException后，拦截器捕获异常</li>
<li>判断是运行时异常，调用<code>rollback()</code></li>
<li>数据库回滚，两条记录都不会保存</li>
</ol>
<p>这个很好理解，我之前踩过坑的是下一个场景。</p>
<h3 data-id="heading-14">测试3：受检异常回滚 - 容易被忽略的坑</h3>
<h4 data-id="heading-15">代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 业务代码里抛受检异常</span>
<span class="hljs-keyword">if</span> (<span class="hljs-string">"INVALID_SKU"</span>.equals(sku)) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Exception</span>(<span class="hljs-string">"无效的SKU，订单回滚"</span>);  <span class="hljs-comment">// 注意：这是Exception，不是RuntimeException</span>
}
</code></pre>
<h4 data-id="heading-16">运行结果（如果没加rollbackFor）</h4>
<p>假设我们的@Transactional没有配置rollbackFor：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional</span>  <span class="hljs-comment">// 没有rollbackFor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">placeOrder</span><span class="hljs-params">(...)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-comment">// 抛Exception</span>
}
</code></pre>
<p><strong>悲剧发生了</strong>：数据库里有数据！</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id<span class="hljs-operator">=</span><span class="hljs-string">'U1003'</span>;
<span class="hljs-comment">-- 结果：有1条记录！！！</span>
</code></pre>
<h4 data-id="heading-17">为什么？</h4>
<p>因为Spring的默认规则：<strong>受检异常（Exception）不回滚，只提交</strong>。</p>
<p>我当时第一次遇到这个问题，在生产环境差点出事故。业务代码抛了个自定义的<code>BusinessException</code>（继承自Exception），我以为会回滚，结果数据都入库了。</p>
<h4 data-id="heading-18">正确做法</h4>
<p>必须显式指定rollbackFor：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>  <span class="hljs-comment">// 所有异常都回滚</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">placeOrder</span><span class="hljs-params">(...)</span> <span class="hljs-keyword">throws</span> Exception {
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>现在再跑：</p>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-comment">========== 测试3：受检异常回滚 ==========</span>
捕获受检异常：无效的SKU，订单回滚
</code></pre>
<p>验证：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id<span class="hljs-operator">=</span><span class="hljs-string">'U1003'</span>;
<span class="hljs-comment">-- 结果：无记录 </span>
</code></pre>
<h4 data-id="heading-19">异常回滚规则总结</h4>
<p>这个表建议保存下来，面试常考：</p>






























<table><thead><tr><th>异常类型</th><th>默认行为</th><th>rollbackFor配置后</th></tr></thead><tbody><tr><td>RuntimeException</td><td>回滚</td><td>回滚</td></tr><tr><td>Error</td><td>回滚</td><td>回滚</td></tr><tr><td>Exception（受检异常）</td><td><strong>提交</strong></td><td>回滚</td></tr><tr><td>自定义异常extends Exception</td><td><strong>提交</strong></td><td>需显式配置</td></tr></tbody></table>
<p>我的建议：<strong>生产环境统一加上<code>rollbackFor = Exception.class</code></strong>，避免漏掉受检异常。</p>
<h3 data-id="heading-20">测试4：REQUIRED传播 - 外内层统一提交</h3>
<p>好，前面3个测试都是单方法的，现在进入重点：<strong>方法嵌套调用时的传播行为</strong>。</p>
<h4 data-id="heading-21">场景设计</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 外层服务</span>
<span class="hljs-meta">@Transactional</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">placeOrderWithInner</span><span class="hljs-params">(String userId, String sku, <span class="hljs-type">int</span> quantity)</span> {
    <span class="hljs-comment">// 1. 插入外层订单</span>
    insertOuterOrder(userId, sku);
    
    <span class="hljs-comment">// 2. 调用内层服务</span>
    innerService.createOrderItem(orderId, sku, quantity);
    
    System.out.println(<span class="hljs-string">"外层方法执行完成"</span>);
}

<span class="hljs-comment">// 内层服务</span>
<span class="hljs-meta">@Transactional</span>  <span class="hljs-comment">// 默认REQUIRED</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrderItem</span><span class="hljs-params">(<span class="hljs-type">long</span> orderId, String sku, <span class="hljs-type">int</span> quantity)</span> {
    <span class="hljs-comment">// 插入订单明细</span>
    insertOrderItem(orderId, sku, quantity);
    
    System.out.println(<span class="hljs-string">"内层方法执行完成"</span>);
}
</code></pre>
<h4 data-id="heading-22">关键问题</h4>
<p>外层和内层各有一个@Transactional，这会开几个事务？</p>
<p>很多人会说"两个事务"，<strong>错了</strong>！</p>
<h4 data-id="heading-23">运行结果</h4>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-comment">========== 传播：统一提交 ==========</span>
外层订单创建成功：ORD-xxx
内层明细创建成功
内层方法执行完成
外层方法执行完成
外内层均成功，统一提交
</code></pre>
<p>验证：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id<span class="hljs-operator">=</span><span class="hljs-string">'U2001'</span>;
<span class="hljs-comment">-- 有记录</span>

<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> order_items <span class="hljs-keyword">WHERE</span> order_id<span class="hljs-operator">=</span>...;
<span class="hljs-comment">-- 有记录</span>
</code></pre>
<h4 data-id="heading-24">原理：REQUIRED只有一个事务</h4>
<p>这是REQUIRED传播的核心：<strong>有事务就加入，没有就新建</strong>。</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Outer
    participant OuterInterceptor
    participant Inner
    participant InnerInterceptor
    participant TxContext
    participant DB
    
    Outer-&gt;&gt;OuterInterceptor: placeOrderWithInner()
    OuterInterceptor-&gt;&gt;TxContext: begin() 开启事务
    TxContext-&gt;&gt;DB: 获取连接，setAutoCommit(false)
    OuterInterceptor-&gt;&gt;DB: INSERT orders
    OuterInterceptor-&gt;&gt;Inner: 调用createOrderItem()
    Inner-&gt;&gt;InnerInterceptor: 拦截
    InnerInterceptor-&gt;&gt;TxContext: 检查是否已有事务
    TxContext--&gt;&gt;InnerInterceptor: 有事务，直接加入
    InnerInterceptor-&gt;&gt;DB: INSERT order_items (用同一个conn)
    InnerInterceptor--&gt;&gt;OuterInterceptor: 返回
    OuterInterceptor-&gt;&gt;TxContext: commit()
    TxContext-&gt;&gt;DB: conn.commit() 一次性提交所有操作
</code></pre>
<p>关键点：</p>
<ol>
<li>外层开启事务，把Connection放到ThreadLocal</li>
<li>内层发现ThreadLocal里已经有事务了，<strong>直接复用这个连接</strong></li>
<li>内外层的SQL都在同一个Connection上执行</li>
<li>最后外层统一commit，一次性提交所有操作</li>
</ol>
<p>所以：<strong>REQUIRED传播下，嵌套调用共享一个事务</strong>。</p>
<h3 data-id="heading-25">测试5：REQUIRED传播 - 内层失败整体回滚（难点）</h3>
<p>这个是最容易搞混的场景，面试经常问。</p>
<h4 data-id="heading-26">代码</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 内层服务模拟失败</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">createOrderItem</span><span class="hljs-params">(<span class="hljs-type">long</span> orderId, String sku, <span class="hljs-type">int</span> quantity)</span> {
    insertOrderItem(orderId, sku, quantity);
    
    <span class="hljs-keyword">if</span> (<span class="hljs-string">"FAIL_INNER"</span>.equals(sku)) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">"内层失败"</span>);  <span class="hljs-comment">// 抛异常</span>
    }
}
</code></pre>
<h4 data-id="heading-27">运行结果</h4>
<pre><code class="hljs language-diff" lang="diff"><span class="hljs-comment">========== 传播：内层失败整体回滚 ==========</span>
捕获内层异常：内层失败
</code></pre>
<h4 data-id="heading-28">验证（重点）</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> orders <span class="hljs-keyword">WHERE</span> user_id<span class="hljs-operator">=</span><span class="hljs-string">'U2002'</span>;
<span class="hljs-comment">-- 结果：无记录</span>

<span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> order_items <span class="hljs-keyword">WHERE</span> sku<span class="hljs-operator">=</span><span class="hljs-string">'FAIL_INNER'</span>;
<span class="hljs-comment">-- 结果：无记录</span>
</code></pre>
<p><strong>注意</strong>：外层的订单也回滚了！虽然外层代码没抛异常。</p>
<h4 data-id="heading-29">为什么外层也回滚了？</h4>
<p>很多人会想：内层抛异常，内层回滚就好了，外层继续提交不行吗？</p>
<p><strong>不行！因为它们共享同一个事务（同一个Connection）</strong>。</p>
<p>我们来看具体流程：</p>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Outer
    participant OuterInterceptor
    participant Inner
    participant InnerInterceptor
    participant TxContext
    
    Outer-&gt;&gt;OuterInterceptor: placeOrderWithInner()
    OuterInterceptor-&gt;&gt;TxContext: begin() 外层开启
    OuterInterceptor-&gt;&gt;Outer: INSERT orders
    OuterInterceptor-&gt;&gt;Inner: 调用内层
    Inner-&gt;&gt;InnerInterceptor: 拦截
    InnerInterceptor-&gt;&gt;TxContext: 检查，已有事务，加入
    InnerInterceptor-&gt;&gt;Inner: INSERT order_items
    Inner-&gt;&gt;Inner: 抛RuntimeException
    InnerInterceptor-&gt;&gt;InnerInterceptor: catch到异常
    InnerInterceptor-&gt;&gt;TxContext: setRollbackOnly() 打标记
    InnerInterceptor--&gt;&gt;OuterInterceptor: 异常向上抛
    OuterInterceptor-&gt;&gt;OuterInterceptor: catch到异常
    OuterInterceptor-&gt;&gt;TxContext: commit() 尝试提交
    TxContext-&gt;&gt;TxContext: 检查rollbackOnly=true
    TxContext-&gt;&gt;TxContext: 执行rollback() 整体回滚
    
    Note over TxContext: orders和order_items都回滚
</code></pre>
<p>关键点：</p>
<ol>
<li>内层抛异常后，<strong>不能直接rollback</strong>（因为事务是外层开的）</li>
<li>内层只能打个标记：<code>setRollbackOnly(true)</code></li>
<li>异常继续向上抛，外层捕获</li>
<li>外层尝试commit时，发现有rollbackOnly标记</li>
<li>最终执行rollback，<strong>整个事务回滚</strong></li>
</ol>
<p>这就是REQUIRED的"统一进退"：要么都成功，要么都失败。</p>
<h4 data-id="heading-30">实际代码是怎么实现的？</h4>
<p>我手写框架里的代码是这样的：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 拦截器逻辑</span>
<span class="hljs-keyword">try</span> {
    <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> method.invoke(target, args);
    
    <span class="hljs-keyword">if</span> (started) {  <span class="hljs-comment">// 如果是我开启的事务</span>
        <span class="hljs-keyword">if</span> (TransactionContext.isRollbackOnly()) {
            txManager.rollback();  <span class="hljs-comment">// 有人标记了回滚</span>
        } <span class="hljs-keyword">else</span> {
            txManager.commit();
        }
    }
    <span class="hljs-keyword">return</span> result;
    
} <span class="hljs-keyword">catch</span> (InvocationTargetException e) {
    <span class="hljs-type">Throwable</span> <span class="hljs-variable">ex</span> <span class="hljs-operator">=</span> e.getTargetException();
    
    <span class="hljs-keyword">if</span> (shouldRollback(ex)) {
        <span class="hljs-keyword">if</span> (started) {
            txManager.rollback();  <span class="hljs-comment">// 我开的事务，我负责回滚</span>
        } <span class="hljs-keyword">else</span> {
            TransactionContext.setRollbackOnly();  <span class="hljs-comment">// 不是我开的，打标记</span>
        }
    }
    <span class="hljs-keyword">throw</span> ex;
}
</code></pre>
<p>这个<code>started</code>标志很关键：</p>
<ul>
<li><strong>外层</strong>：started=true（我开的事务）</li>
<li><strong>内层</strong>：started=false（加入的事务）</li>
</ul>
<p>所以：</p>
<ul>
<li>内层抛异常：只打标记，不直接回滚</li>
<li>外层拿到标记：执行回滚</li>
</ul>
<h3 data-id="heading-31">几个容易踩的坑</h3>
<h4 data-id="heading-32">坑1：以为内层可以独立回滚</h4>
<p>错误认知：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">try</span> {
    innerService.createOrderItem();  <span class="hljs-comment">// 内层失败</span>
} <span class="hljs-keyword">catch</span> (Exception e) {
    <span class="hljs-comment">// 以为catch住了就没事</span>
}
<span class="hljs-comment">// 以为外层可以继续提交</span>
</code></pre>
<p>真相：<strong>catch住也没用，事务已经被标记为rollbackOnly</strong>。</p>
<h4 data-id="heading-33">坑2：同类方法调用不生效</h4>
<p>这个是经典问题：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">OrderService</span> {
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodA</span><span class="hljs-params">()</span> {
        methodB();  <span class="hljs-comment">// 直接调用</span>
    }
    
    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">methodB</span><span class="hljs-params">()</span> {
        <span class="hljs-comment">// 这个@Transactional不生效！</span>
    }
}
</code></pre>
<p>为什么？因为代理只能拦截<strong>外部调用</strong>，内部调用走的是this，不经过代理。</p>
<p>解决办法：拆到不同的类，或者通过注入拿到代理对象。</p>
<h4 data-id="heading-34">坑3：忘记配置rollbackFor</h4>
<p>生产环境建议：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Transactional(rollbackFor = Exception.class)</span>  <span class="hljs-comment">// 统一配置</span>
</code></pre>
<p>不要依赖默认行为，否则受检异常会让你抓狂。</p>
<h3 data-id="heading-35">传播行为对比表</h3>
<p>虽然我这个简化版只实现了REQUIRED，但我把7种传播行为总结了下：</p>





















































<table><thead><tr><th>传播行为</th><th>外层有事务</th><th>外层无事务</th><th>使用场景</th></tr></thead><tbody><tr><td>REQUIRED</td><td>加入外层事务</td><td>新建事务</td><td><strong>默认，最常用</strong></td></tr><tr><td>REQUIRES_NEW</td><td>挂起外层，新建事务</td><td>新建事务</td><td>日志记录（独立提交）</td></tr><tr><td>NESTED</td><td>嵌套事务（SavePoint）</td><td>新建事务</td><td>部分回滚场景</td></tr><tr><td>SUPPORTS</td><td>加入外层事务</td><td>非事务执行</td><td>查询方法</td></tr><tr><td>NOT_SUPPORTED</td><td>挂起外层事务</td><td>非事务执行</td><td>不需要事务的操作</td></tr><tr><td>MANDATORY</td><td>加入外层事务</td><td>抛异常</td><td>必须在事务中执行</td></tr><tr><td>NEVER</td><td>抛异常</td><td>非事务执行</td><td>禁止在事务中执行</td></tr></tbody></table>
<p>生产环境99%的场景用REQUIRED就够了，REQUIRES_NEW用在日志记录（即使业务失败也要记日志），其他的基本用不上。</p>
<h3 data-id="heading-36">生产经验总结</h3>
<p>这5个测试跑下来，我总结了几条生产经验：</p>
<ol>
<li><strong>统一加rollbackFor = Exception.class</strong>
<ul>
<li>避免受检异常不回滚的坑</li>
</ul>
</li>
<li><strong>理解REQUIRED的"统一进退"</strong>
<ul>
<li>内层失败 = 整体回滚</li>
<li>不要企图catch住内层异常让外层继续提交</li>
</ul>
</li>
<li><strong>拆分服务要小心</strong>
<ul>
<li>不同类的方法调用才会走代理</li>
<li>同类内部调用事务不生效</li>
</ul>
</li>
<li><strong>数据库连接要复用</strong>
<ul>
<li>REQUIRED传播下，内外层共享一个Connection</li>
<li>所以可以看到彼此未提交的数据</li>
</ul>
</li>
<li><strong>ThreadLocal一定要清理</strong>
<ul>
<li>finally块里统一清理资源</li>
<li>否则线程池复用会出问题</li>
</ul>
</li>
</ol>
<h3 data-id="heading-37">下一步：REQUIRES_NEW</h3>
<p>REQUIRED搞清楚后，下一个要研究的是REQUIRES_NEW。它跟REQUIRED最大的区别：</p>
<ul>
<li><strong>REQUIRED</strong>：有事务就加入（共享Connection）</li>
<li><strong>REQUIRES_NEW</strong>：总是新建事务（挂起外层，新开Connection）</li>
</ul>
<p>这个涉及到事务挂起和恢复，需要维护一个事务栈，实现起来更复杂。我准备下一篇文章专门写这个。</p>
<h3 data-id="heading-38">写在最后</h3>
<p>事务传播行为这块，说实话光看文档真的很难理解。我这次通过手写框架+测试用例，算是彻底搞明白了。</p>
<p>最大的收获是：<strong>不要怕动手实践</strong>。自己写200行代码，比看2000行源码理解得更深。</p>
<p>代码我放Gitee了（链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fsh_wangwanbao%2Fsimple-spring-transaction" target="_blank" title="https://gitee.com/sh_wangwanbao/simple-spring-transaction" ref="nofollow noopener noreferrer">gitee.com/sh_wangwanb…</a> )
有兴趣的同学可以clone下来跑跑看。下一篇我打算写REQUIRES_NEW的实现，涉及到事务挂起和恢复，应该会更有意思。</p>
<hr/>
<p><strong>你们在用事务的时候，有没有遇到过"内层失败外层却提交了"的坑？或者还有哪些传播行为的问题搞不清楚？欢迎评论区聊聊，大家一起交流。</strong></p>
<p>如果文章对您有帮助，辛苦点个赞支持下呗。您的支持，是我创作的最大动力，谢谢。</p>
<p>下篇见！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端性能优化之“代码分割与懒加载”）]]></title>    <link>https://juejin.cn/post/7577722399375818794</link>    <guid>https://juejin.cn/post/7577722399375818794</guid>    <pubDate>2025-11-29T23:03:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577722399375818794" data-draft-id="7577905525996666921" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端性能优化之“代码分割与懒加载”）"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2025-11-29T23:03:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="方法重载"/> <meta itemprop="url" content="https://juejin.cn/user/1443021512522878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端性能优化之“代码分割与懒加载”）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1443021512522878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    方法重载
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T23:03:14.000Z" title="Sat Nov 29 2025 23:03:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在现代前端开发中，随着单页面应用(SPA)的复杂度不断提升，打包后的JavaScript文件体积可能达到几MB甚至更大。这会导致严重的性能问题：用户需要等待整个应用加载完成后才能与页面交互。代码分割(Code Splitting)和懒加载(Lazy Loading)正是解决这一问题的关键技术。</p>
<p>一、代码分割的核心思想</p>
<p>代码分割的核心是将单个大型的打包文件拆分成多个较小的chunk，然后按需加载或并行加载。这类似于图书的章节划分——读者不需要一次性拿到整本书，而是可以根据需要阅读特定章节。</p>
<p>二、实现方式</p>
<ol>
<li>动态import()语法（现代推荐方案）</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 静态导入（传统方式）</span>
<span class="hljs-comment">// import { utils } from './module';</span>

<span class="hljs-comment">// 动态导入（代码分割）</span>
button.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">const</span> <span class="hljs-variable language_">module</span> = <span class="hljs-keyword">await</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./module.js'</span>);
  <span class="hljs-variable language_">module</span>.<span class="hljs-title function_">doSomething</span>();
});
</code></pre>
<p>Webpack等构建工具检测到动态import()时会自动进行代码分割，生成独立的chunk文件。</p>
<ol>
<li>React.lazy + Suspense（React生态）</li>
</ol>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">const</span> <span class="hljs-title class_">LazyComponent</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./LazyComponent'</span>));

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>Loading...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">LazyComponent</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span>
  );
}
</code></pre>
<ol>
<li>路由级分割（最常用的分割场景）</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Vue Router</span>
<span class="hljs-keyword">const</span> routes = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/dashboard'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./views/Dashboard.vue'</span>)
  }
];

<span class="hljs-comment">// React Router</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">Dashboard</span> = <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./Dashboard'</span>));
</code></pre>
<p>三、懒加载的实际应用场景</p>
<ol>
<li>路由级别分割：每个路由对应的组件单独打包</li>
<li>组件级别分割：大型组件（如富文本编辑器、图表库）按需加载</li>
<li>第三方库分割：将不常变化的第三方库单独打包</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// webpack配置示例</span>
<span class="hljs-attr">optimization</span>: {
  <span class="hljs-attr">splitChunks</span>: {
    <span class="hljs-attr">chunks</span>: <span class="hljs-string">'all'</span>,
    <span class="hljs-attr">cacheGroups</span>: {
      <span class="hljs-attr">vendor</span>: {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]node_modules[\\/]/</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">'vendors'</span>,
      }
    }
  }
}
</code></pre>
<p>四、性能收益分析</p>
<p>通过代码分割可以实现：</p>
<p>· 减少初始加载时间：首屏只需加载必要代码
· 提高缓存效率：修改业务代码不会影响vendor chunk
· 优化资源加载：非关键资源可以延迟加载</p>
<p>五、最佳实践建议</p>
<ol>
<li>分割粒度要合理，避免产生过多小文件导致请求频繁</li>
<li>使用预加载(preload/prefetch)优化用户体验</li>
</ol>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"prefetch"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"lazy-component.js"</span>&gt;</span>
</code></pre>
<ol>
<li>注意错误处理，动态导入可能失败</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span>(<span class="hljs-string">'./module'</span>)
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 处理加载失败情况</span>
  });
</code></pre>
<p>代码分割不是银弹，需要结合实际业务场景。过度分割可能导致请求碎片化，而分割不足又无法充分发挥性能优势。通过Chrome DevTools的Coverage工具和Webpack Bundle Analyzer进行分析，找到最适合自己项目的分割策略才是关键。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[HTML 敲击乐 PART--2]]></title>    <link>https://juejin.cn/post/7577704980855275574</link>    <guid>https://juejin.cn/post/7577704980855275574</guid>    <pubDate>2025-11-29T15:56:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577704980855275574" data-draft-id="7576856418470461450" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="HTML 敲击乐 PART--2"/> <meta itemprop="keywords" content="HTML"/> <meta itemprop="datePublished" content="2025-11-29T15:56:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="izx888"/> <meta itemprop="url" content="https://juejin.cn/user/1241762540820323"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            HTML 敲击乐 PART--2
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1241762540820323/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    izx888
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T15:56:16.000Z" title="Sat Nov 29 2025 15:56:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    2
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">HTML5 敲击乐项目 PART-2：从结构到交互的完整实现</h2>
<h3 data-id="heading-1">一、项目概述</h3>
<p>“HTML5 敲击乐”是一个基于现代 Web 技术的交互式音频应用：用户按下键盘上的特定按键（如 A、S、D 等），页面中对应的虚拟“打击乐器键”会高亮显示并播放预设音效，模拟真实的节奏打击体验。</p>
<p>该项目不仅实现了基础的音效触发与视觉反馈，更完整体现了前端开发的核心理念——<strong>结构、样式与行为分离</strong>，并融合了<strong>响应式设计</strong>、<strong>模块化思维</strong>与<strong>用户体验优化</strong>等现代开发实践。代码结构清晰、扩展性强，为后续功能（如节奏录制、音色切换、移动端触控支持等）预留了良好接口，是初学者掌握 HTML5、CSS3 与 JavaScript 协同开发的理想范例。</p>
<blockquote>
<p>跟着本文，你将亲手构建一个既美观又富有交互感的网页乐器！</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">二、HTML5 结构设计：语义化与数据绑定</h3>
<p>HTML 是应用的骨架。我们采用<strong>语义化标签</strong>与<strong>数据属性（data-*）</strong> 构建清晰、可维护的 DOM 结构：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>HTML5 敲击乐<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"style.css"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"keys"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"key"</span> <span class="hljs-attr">data-key</span>=<span class="hljs-string">"65"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>A<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"sound"</span>&gt;</span>Clap<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 更多 .key 元素 --&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">audio</span> <span class="hljs-attr">data-key</span>=<span class="hljs-string">"65"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"sounds/clap.wav"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">audio</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 对应的 audio 元素 --&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"script.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h4 data-id="heading-3">关键设计要点：</h4>
<ul>
<li><strong><code>.keys</code> 容器</strong>：包裹所有虚拟琴键，作为布局根节点；</li>
<li><strong><code>.key</code> 模块</strong>：每个键包含视觉提示（<code>&lt;h3&gt;</code>）与音效名称（<code>.sound</code>），具备独立语义；</li>
<li><strong><code>data-key</code> 属性</strong>：存储键盘事件的 <code>keyCode</code>（如 A 键为 65），实现 UI 元素与物理按键的精准映射；</li>
<li><strong><code>&lt;audio&gt;</code> 预加载</strong>：每个音效通过独立 <code>&lt;audio&gt;</code> 标签预加载，并通过相同的 <code>data-key</code> 与 <code>.key</code> 关联，便于 JavaScript 动态调用。</li>
</ul>
<blockquote>
<p><strong>最佳实践</strong>：</p>
<ul>
<li>HTML 只负责结构，不嵌入样式或逻辑；</li>
<li>CSS 通过外链引入，置于 <code>&lt;head&gt;</code>；</li>
<li>JavaScript 脚本置于 <code>&lt;body&gt;</code> 底部，避免阻塞渲染。</li>
</ul>
</blockquote>
<hr/>
<h3 data-id="heading-4">三、CSS 样式系统：重置、布局与动效</h3>
<h4 data-id="heading-5">1. 统一样式起点：CSS Reset</h4>
<p>不同浏览器对默认元素（如 <code>body</code>、<code>h1</code>）的 margin、padding 等处理不一，易导致布局错乱。为此，项目采用 <strong>Eric Meyer’s Reset CSS</strong>，清除所有默认样式，并补充现代开发规范：</p>
<pre><code class="hljs language-css" lang="css">*, *<span class="hljs-selector-pseudo">::before</span>, *<span class="hljs-selector-pseudo">::after</span> {
  <span class="hljs-attribute">box-sizing</span>: border-box;
}
</code></pre>
<p><code>box-sizing: border-box</code> 确保元素的宽高包含 padding 和 border，使尺寸计算更直观、布局更稳定。</p>
<p>此外，还优化了常用元素：</p>
<ul>
<li><code>img { max-width: 100%; height: auto; }</code>：图片自适应容器；</li>
<li><code>a { text-decoration: none; color: inherit; }</code>：链接样式继承父级，保持视觉统一。</li>
</ul>
<h4 data-id="heading-6">2. 响应式布局：Flexbox + 相对单位</h4>
<p>为适配手机、平板、桌面等多种设备，项目摒弃固定单位（如 <code>px</code>），转而使用：</p>
<ul>
<li><strong><code>vh</code>（视口高度单位）</strong> ：<br/>
<code>min-height: 100vh</code> 确保 <code>.keys</code> 容器始终占满屏幕高度；</li>
<li><strong><code>rem</code>（根字体单位）</strong> ：<br/>
设置 <code>html { font-size: 10px; }</code>，后续所有尺寸（如 <code>font-size: 1.5rem</code>、<code>border: .4rem</code>）均基于此，便于全局缩放。</li>
</ul>
<p>配合 <strong>Flexbox 弹性布局</strong>，实现优雅居中：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.keys</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">justify-content</span>: center; <span class="hljs-comment">/* 水平居中 */</span>
  <span class="hljs-attribute">align-items</span>: center;     <span class="hljs-comment">/* 垂直居中 */</span>
}
</code></pre>
<p>无论屏幕尺寸如何变化，琴键始终居中排列，布局自适应且无需媒体查询干预。</p>
<h4 data-id="heading-7">3. 视觉反馈：动态交互效果</h4>
<p>当用户触发按键时，JavaScript 会为对应 <code>.key</code> 添加 <code>.playing</code> 类，CSS 则定义其动效：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.playing</span> {
  <span class="hljs-attribute">border-color</span>: <span class="hljs-number">#ffc600</span>;
  <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">1rem</span> <span class="hljs-number">#ffc600</span>;
  <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">scale</span>(<span class="hljs-number">1.1</span>);
  <span class="hljs-attribute">transition</span>: all <span class="hljs-number">0.1s</span> ease;
}
</code></pre>
<p>这一组合实现了<strong>边框高亮、发光阴影与轻微放大</strong>的视觉反馈，显著提升交互沉浸感。</p>
<h4 data-id="heading-8">4. 背景与氛围营造</h4>
<p>全屏背景图增强整体氛围：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">body</span> {
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">'./background.jpg'</span>) bottom center no-repeat;
  <span class="hljs-attribute">background-size</span>: cover;
}
</code></pre>
<ul>
<li><code>cover</code>：等比缩放覆盖整个视口（可能裁剪边缘）；</li>
<li><code>contain</code>：完整显示图片（可能留白）；</li>
<li><code>bottom center</code>：确保关键视觉内容（如鼓面）位于底部中央。</li>
</ul>
<hr/>
<h3 data-id="heading-9">四、JavaScript 交互逻辑：事件驱动与 DOM 操作</h3>
<p>JavaScript 是让页面“活起来”的引擎。项目采用<strong>事件监听 + 数据驱动</strong>的方式实现核心交互。</p>
<h4 data-id="heading-10">1. 安全执行时机</h4>
<p>使用 <code>DOMContentLoaded</code> 确保 DOM 加载完成后再执行脚本：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">document</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'DOMContentLoaded'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 初始化逻辑</span>
});
</code></pre>
<p>避免因元素未就绪导致的 <code>null</code> 错误。</p>
<h4 data-id="heading-11">2. 全局键盘监听</h4>
<p>监听 <code>window</code> 的 <code>keydown</code> 事件，捕获用户输入：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'keydown'</span>, playSound);
</code></pre>
<h4 data-id="heading-12">3. 动态匹配与反馈</h4>
<pre><code class="hljs language-ini" lang="ini">function playSound(event) {
  const <span class="hljs-attr">keyCode</span> = event.keyCode<span class="hljs-comment">;</span>
  const <span class="hljs-attr">keyElement</span> = document.querySelector(`.key[data-key=<span class="hljs-string">"${keyCode}"</span>]`)<span class="hljs-comment">;</span>
  const <span class="hljs-attr">audioElement</span> = document.querySelector(`audio[data-key=<span class="hljs-string">"${keyCode}"</span>]`)<span class="hljs-comment">;</span>

  if (keyElement) {
    keyElement.classList.add('playing')<span class="hljs-comment">;</span>
    setTimeout(() =&gt; keyElement.classList.remove('playing'), 150)<span class="hljs-comment">; // 自动移除动效</span>
  }

  if (audioElement) {
    <span class="hljs-attr">audioElement.currentTime</span> = <span class="hljs-number">0</span><span class="hljs-comment">; // 重置播放位置</span>
    audioElement.play()<span class="hljs-comment">;</span>
  }
}
</code></pre>
<ul>
<li>通过 <code>data-key</code> 精准匹配 UI 与音频；</li>
<li>使用 <code>setTimeout</code> 自动清除 <code>.playing</code> 类，避免状态残留；</li>
<li>重置 <code>currentTime</code> 支持快速连按。</li>
</ul>
<hr/>
<h3 data-id="heading-13">五、性能与工程化考量</h3>
<h4 data-id="heading-14">✅ 最佳实践总结：</h4>

























<table><thead><tr><th>方面</th><th>实践</th></tr></thead><tbody><tr><td><strong>脚本加载</strong></td><td><code>&lt;script&gt;</code> 置于 <code>&lt;/body&gt;</code> 前，避免阻塞渲染</td></tr><tr><td><strong>选择器性能</strong></td><td>避免通配符 <code>*</code> 重置，采用明确元素列表（如 Eric Meyer 方案）</td></tr><tr><td><strong>可访问性</strong></td><td>使用语义化标签（<code>&lt;h3&gt;</code>、<code>&lt;p&gt;</code>），提升屏幕阅读器兼容性</td></tr><tr><td><strong>扩展性</strong></td><td><code>data-*</code> 属性天然支持未来功能扩展（如音量控制、音色切换）</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-15">六、结语：小项目，大格局</h3>
<p>“HTML5 敲击乐”虽体量小巧，却完整涵盖了现代 Web 开发的关键要素：</p>
<ul>
<li><strong>结构清晰</strong>：语义化 HTML + 数据绑定；</li>
<li><strong>样式健壮</strong>：CSS Reset + Flexbox + 响应式单位；</li>
<li><strong>交互流畅</strong>：事件驱动 + 动态 DOM 操作 + 视觉反馈；</li>
<li><strong>工程规范</strong>：职责分离、性能优化、可扩展设计。</li>
</ul>
<p>它不仅是一次趣味编程实践，更是通往专业前端开发的坚实一步。掌握其中的设计思想与技术组合，你便已具备构建更复杂交互应用的能力。</p>
<blockquote>
<p>下一步，不妨尝试添加：</p>
<ul>
<li>移动端触控支持</li>
<li>节奏录制与回放</li>
<li>多套音效主题切换<br/>
让你的“敲击乐”真正成为属于你的数字乐器！</li>
</ul>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解内容安全策略（CSP）：原理、作用与实践指南]]></title>    <link>https://juejin.cn/post/7577715145121726518</link>    <guid>https://juejin.cn/post/7577715145121726518</guid>    <pubDate>2025-11-29T16:43:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7577715145121726518" data-draft-id="7577691384943165482" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解内容安全策略（CSP）：原理、作用与实践指南"/> <meta itemprop="keywords" content="前端,浏览器"/> <meta itemprop="datePublished" content="2025-11-29T16:43:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JamesGosling666"/> <meta itemprop="url" content="https://juejin.cn/user/2358921680140899"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解内容安全策略（CSP）：原理、作用与实践指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2358921680140899/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JamesGosling666
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-29T16:43:11.000Z" title="Sat Nov 29 2025 16:43:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-29
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、CSP 是什么？</h2>
<blockquote>
<p>CSP 本质上是一套<strong>由网站开发者定义、浏览器负责执行的 “内容加载规则”</strong> 。它通过明确告诉浏览器 “哪些来源的资源（如脚本、图片、样式表）是安全的，可以加载；哪些来源是危险的，必须拒绝”，从根源上限制恶意代码的执行，弥补传统安全防护（如输入过滤、输出编码）的不足。</p>
</blockquote>
<h3 data-id="heading-1">1. CSP 的核心逻辑：“白名单机制”</h3>
<p>CSP 的核心思想是 “<strong>默认拒绝，例外允许</strong>”—— 除非开发者明确将某个资源来源加入 “白名单”，否则浏览器会默认阻止该资源的加载或执行。这种机制彻底改变了传统网页 “默认允许所有资源” 的宽松模式，大幅降低了恶意资源注入的风险。</p>
<h3 data-id="heading-2">2. CSP 的实现载体：两种部署方式</h3>
<p>CSP 的规则通常通过以下两种方式传递给浏览器，开发者可根据场景选择：</p>
<ul>
<li><strong>HTTP 响应头（推荐）</strong> ：在服务器返回的 HTTP 响应中添加<code>Content-Security-Policy</code>头，例如：<code>Content-Security-Policy: default-src 'self'; script-src https://cdn.example.com</code>。这种方式优先级高、规则覆盖全面，适用于整站或特定页面的安全管控。</li>
<li><strong><code>&lt;meta&gt;</code>标签</strong>：众所周知可以通过 <code>&lt;meta&gt;</code>标签来模拟响应头，例如：<code>&lt;meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src https://img.example.com"&gt;</code>。这种方式无需服务器配置，适合静态页面或无法修改服务器响应头的场景（如静态博客、第三方平台托管页面）。</li>
</ul>
<h2 data-id="heading-3">二、CSP 的核心作用 —— 抵御哪些威胁？解决什么问题？</h2>
<p>CSP 的核心价值在于 “<strong>精准管控资源加载，阻断恶意代码执行</strong>”，具体可拆解为以下 4 个关键作用：</p>
<h3 data-id="heading-4">1. 抵御 XSS 攻击：从 “事后过滤” 到 “事前阻止”</h3>
<p>XSS 攻击的本质是恶意脚本被注入到网页中并执行，而 CSP 通过限制 “脚本的加载来源” 和 “脚本的执行方式”，直接切断恶意脚本的执行路径：</p>
<ul>
<li>禁止加载未知来源的脚本：例如通过<code>script-src 'self' https://cdn.tencent.com</code>，仅允许加载网站自身（<code>'self'</code>）和腾讯 CDN 的脚本，恶意网站的脚本会被直接拦截；</li>
<li>禁止内联脚本（如<code>&lt;script&gt;alert(1)&lt;/script&gt;</code>）和<code>eval()</code>函数：内联脚本是 XSS 攻击的常用载体，CSP 默认拒绝内联脚本（需显式配置<code>'unsafe-inline'</code>才允许，且不推荐），同时禁用<code>eval()</code>等动态执行脚本的函数，彻底杜绝 “动态注入恶意代码” 的可能。</li>
</ul>
<h3 data-id="heading-5">2. 防止数据注入与恶意资源加载</h3>
<p>除了脚本，CSP 还能管控图片、样式表、字体、iframe 等各类资源的加载来源：</p>
<ul>
<li>例如通过<code>img-src https://img.example.com data:</code>，仅允许加载指定域名的图片和<code>data:</code>协议的 Base64 图片，避免攻击者注入恶意图片（如包含恶意代码的 SVG）；</li>
<li>通过<code>frame-src 'none'</code>禁止加载任何 iframe，防止 “点击劫持”（Clickjacking）攻击 —— 即攻击者通过 iframe 嵌套合法网站，诱导用户点击恶意按钮。</li>
</ul>
<h3 data-id="heading-6">3. 增强网站的 “安全透明度”：报告机制</h3>
<p>CSP 支持 “违规报告” 功能：当浏览器检测到违反 CSP 规则的行为时（如尝试加载未授权的脚本），会自动向开发者指定的 “报告地址” 发送 JSON 格式的日志，包含违规资源的 URL、违规类型、触发页面等信息。</p>
<p>这一机制让开发者能实时监控网站的安全风险，例如：</p>
<ul>
<li>发现未被注意的第三方脚本加载（可能存在安全隐患）；</li>
<li>验证 CSP 规则是否配置正确（避免误拦截合法资源）。</li>
</ul>
<h3 data-id="heading-7">4. 兼容 “渐进式安全”：从测试到强制</h3>
<p>为了避免直接启用 CSP 导致合法资源被拦截（影响网站功能），CSP 提供了 “测试模式”：将 HTTP 响应头改为<code>Content-Security-Policy-Report-Only</code>，此时浏览器仅会记录违规行为（发送报告），但不会实际阻止资源加载。</p>
<h2 data-id="heading-8">三、CSP 的具体使用 —— 规则配置、常见场景与注意事项</h2>
<p>CSP 的使用核心是 “配置规则”，而规则由 “指令（Directive）” 和 “源（Source）” 两部分组成。下面从基础配置逻辑、常见场景示例、避坑指南三个方面，讲解 CSP 的实际应用。</p>
<h3 data-id="heading-9">1. 基础：CSP 的 “指令” 与 “源” 详解</h3>
<h4 data-id="heading-10">（1）核心指令：管控不同类型的资源</h4>
<p>CSP 提供了数十种指令，覆盖各类资源和行为，以下是最常用的 8 个指令：</p>


















































<table><thead><tr><th>指令（Directive）</th><th>作用</th><th>示例</th></tr></thead><tbody><tr><td><code>default-src</code></td><td>所有资源的 “默认加载规则”，当其他指令（如<code>script-src</code>）未配置时，会继承<code>default-src</code>的规则</td><td><code>default-src 'self'</code>（默认仅允许加载自身域名资源）</td></tr><tr><td><code>script-src</code></td><td>管控 JavaScript 脚本的加载与执行（最关键的指令之一）</td><td><code>script-src 'self' https://cdn.jsdelivr.net</code></td></tr><tr><td><code>style-src</code></td><td>管控 CSS 样式表的加载与执行</td><td><code>style-src 'self' https://fonts.googleapis.com</code></td></tr><tr><td><code>img-src</code></td><td>管控图片资源（jpg、png、svg 等）的加载</td><td><code>img-src 'self' https://img.baidu.com data:</code></td></tr><tr><td><code>font-src</code></td><td>管控字体文件（woff、ttf 等）的加载</td><td><code>font-src 'self' https://fonts.gstatic.com</code></td></tr><tr><td><code>frame-src</code></td><td>管控 iframe 嵌套的来源</td><td><code>frame-src 'none'</code>（禁止所有 iframe）</td></tr><tr><td><code>report-uri</code> / <code>report-to</code></td><td>指定违规报告的接收地址（<code>report-uri</code>是旧标准，<code>report-to</code>是新标准，建议同时配置）</td><td><code>report-uri /csp-report; report-to csp-endpoint</code></td></tr><tr><td><code>object-src</code></td><td>管控插件资源（如 Flash、Java Applet，现在较少使用）</td><td><code>object-src 'none'</code>（禁止所有插件）</td></tr></tbody></table>
<h4 data-id="heading-11">（2）常见 “源” 值：定义 “安全的资源来源”</h4>
<p>“源” 是指令后紧跟的 “允许加载的资源地址”，支持多种格式，以下是最常用的 5 种：</p>



































<table><thead><tr><th>源（Source）</th><th>含义</th><th>示例</th></tr></thead><tbody><tr><td><code>'self'</code></td><td>允许加载当前网站的同源资源（同协议、同域名、同端口）</td><td><code>default-src 'self'</code></td></tr><tr><td>完整域名</td><td>允许加载指定域名的资源（可带端口，默认 80/443）</td><td><code>script-src https://cdn.example.com:8443</code></td></tr><tr><td>通配符域名</td><td>允许加载指定域名下的所有子域名（如<code>*.example.com</code>）</td><td><code>img-src *.example.com</code></td></tr><tr><td><code>data:</code></td><td>允许加载 Base64 编码的资源（如<code>data:image/png;base64,...</code>）</td><td><code>img-src data:</code></td></tr><tr><td><code>'none'</code></td><td>禁止加载该类型的所有资源</td><td><code>frame-src 'none'</code></td></tr></tbody></table>
<p>⚠️ 注意：<code>'self'</code>、<code>'none'</code>、<code>'unsafe-inline'</code>等带引号的值，<strong>必须使用单引号包裹</strong>，否则浏览器会将其识别为 “域名”（如<code>self</code>会被当作<code>self.com</code>），导致规则失效。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>