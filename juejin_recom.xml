<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[面积图的奇妙变形：流图与地平线图]]></title>    <link>https://juejin.cn/post/7599580550296141859</link>    <guid>https://juejin.cn/post/7599580550296141859</guid>    <pubDate>2026-01-27T01:50:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599580550296141859" data-draft-id="7599580550296125475" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面积图的奇妙变形：流图与地平线图"/> <meta itemprop="keywords" content="Python,数据可视化,数据分析"/> <meta itemprop="datePublished" content="2026-01-27T01:50:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="databook"/> <meta itemprop="url" content="https://juejin.cn/user/3526889035006702"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面积图的奇妙变形：流图与地平线图
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3526889035006702/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    databook
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T01:50:50.000Z" title="Tue Jan 27 2026 01:50:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>想象一下面积图就像一层层叠起来的彩色玻璃片，每一层代表一个类别，从下往上堆叠，形成整体的视觉冲击。</p>
<p>但有时我们需要更特别的方式来展示数据的变化：是像河流一样蜿蜒流淌，还是像地平线上的群山连绵起伏？</p>
<p>今天，本文将介绍两种创意<strong>面积图变体</strong>——<strong>流图</strong>和<strong>地平线图</strong>，它们能让你的时间序列数据讲述更生动的故事。</p>
<h2 data-id="heading-0">1. 流图：数据的河流</h2>
<p>如果把传统的堆叠面积图想象成一块块整齐堆叠的积木，那么<strong>流图</strong>就像一条蜿蜒流淌的河流，河道的宽窄变化自然流畅，波峰波谷过渡平滑。</p>
<p>它特别适合展示多个类别数据随时间的变化趋势，尤其是当你想强调整体流动感和各部分的相对比例变化时。</p>
<p><strong>流图</strong>的<strong>核心思想</strong>是将传统的堆叠面积图进行"平滑"处理。</p>
<p>在<code>matplotlib</code>中，我们可以使用<code>fill_between</code>函数结合样条插值来创建平滑的边缘。</p>
<p>关键在于将堆叠的数据进行累积，然后对累积边界进行平滑处理。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 数据准备</span>
x = np.linspace(<span class="hljs-number">0</span>, <span class="hljs-number">10</span>, <span class="hljs-number">100</span>)
<span class="hljs-comment"># 构造三组波浪数据</span>
y1 = <span class="hljs-number">2</span> + np.sin(x)            <span class="hljs-comment"># 基础波动</span>
y2 = <span class="hljs-number">2</span> + np.cos(x - <span class="hljs-number">1.5</span>)      <span class="hljs-comment"># 错位波动</span>
y3 = <span class="hljs-number">2</span> + np.sin(x + <span class="hljs-number">2</span>)        <span class="hljs-comment"># 再次错位</span>

<span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># 绘图设置</span>
fig, (ax1, ax2) = plt.subplots(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, figsize=(<span class="hljs-number">14</span>, <span class="hljs-number">6</span>))

<span class="hljs-comment"># --- 左图：普通堆叠面积图 (baseline='zero') ---</span>
ax1.stackplot(x, y_data, labels=labels, colors=colors, baseline=<span class="hljs-string">'zero'</span>, alpha=<span class="hljs-number">0.8</span>)
<span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># --- 右图：流图 (baseline='sym') ---</span>
<span class="hljs-comment"># 'sym' 表示对称中心布局</span>
ax2.stackplot(x, y_data, labels=labels, colors=colors, baseline=<span class="hljs-string">'sym'</span>, alpha=<span class="hljs-number">0.8</span>)
ax2.axhline(<span class="hljs-number">0</span>, color=<span class="hljs-string">'black'</span>, ls=<span class="hljs-string">'--'</span>, alpha=<span class="hljs-number">0.1</span>) <span class="hljs-comment"># 画一条中心参考线</span>
<span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># 去除右图边框，增加流动感</span>
<span class="hljs-keyword">for</span> spine <span class="hljs-keyword">in</span> ax2.spines.values():
    spine.set_visible(<span class="hljs-literal">False</span>)

plt.tight_layout()
plt.show()
</code></pre>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a95a90d8e4d49deba0549e04440a961~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083449&amp;x-signature=dwb%2BDG%2Fop85OGfQvutC7SPsrjNI%3D" alt="" loading="lazy"/></p>
<p><strong>流图</strong>解决了一个视觉错觉问题：在普通<strong>堆叠面积图</strong>中，上面的数据层会因为下面数据层的起伏而被迫“扭曲”，很难看出它原本的形状。</p>
<p><strong>流图</strong>通过中心布局，减少了这种扭曲，非常适合展示随时间变化的趋势和不同类别权重的波动，这种有机的形态还能给读者带来极强的审美愉悦感。</p>
<h2 data-id="heading-1">2. 地平线图：数据的群山</h2>
<p>想象一下远处的地平线上有一排连绵的山脉，每座山的高度代表一个数据值。</p>
<p><strong>地平线图</strong>就是这样一种可视化技术，它将时间序列数据压缩在一个很小的垂直空间内，通过颜色和分层来展示数据的变化。</p>
<p>特别适合在有限空间内展示多个时间序列的对比。</p>
<p><strong>地平线图</strong>的<strong>核心思想</strong>是数据分层和颜色渐变。</p>
<p>它将数据值分成若干层（通常是2-3层），每层用一种颜色表示。当数据值超过一层时，就用更深的颜色或不同的颜色填充。这样可以在很小的垂直空间内展示很大的数据范围。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> timedelta

<span class="hljs-comment"># 生成模拟数据：过去10年五大科技公司的股价波动</span>
np.random.seed(<span class="hljs-number">42</span>)

<span class="hljs-comment"># 生成日期范围：过去10年，每月一个数据点</span>
dates = pd.date_range(<span class="hljs-string">"2013-01-01"</span>, <span class="hljs-string">"2023-01-01"</span>, freq=<span class="hljs-string">"ME"</span>)
companies = [<span class="hljs-string">"苹果"</span>, <span class="hljs-string">"谷歌"</span>, <span class="hljs-string">"微软"</span>, <span class="hljs-string">"亚马逊"</span>, <span class="hljs-string">"Meta"</span>]

<span class="hljs-comment"># 生成各公司的股价模拟数据（标准化到相似范围）</span>
data = {}
<span class="hljs-keyword">for</span> company <span class="hljs-keyword">in</span> companies:
    <span class="hljs-comment"># 基础趋势：每家公司有不同的增长趋势，但最终都在70-90范围内</span>
    <span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># 转换为DataFrame</span>
df = pd.DataFrame(data, index=dates)

<span class="hljs-comment"># 创建对比图表</span>
fig, axes = plt.subplots(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, figsize=(<span class="hljs-number">14</span>, <span class="hljs-number">10</span>))

<span class="hljs-comment"># ============ 传统堆叠面积图 ============</span>
colors = [<span class="hljs-string">"#FF6B6B"</span>, <span class="hljs-string">"#4ECDC4"</span>, <span class="hljs-string">"#45B7D1"</span>, <span class="hljs-string">"#FFD166"</span>, <span class="hljs-string">"#9B5DE5"</span>]

<span class="hljs-comment"># 为堆叠面积图重新归一化数据</span>
df_normalized = df.div(df.<span class="hljs-built_in">sum</span>(axis=<span class="hljs-number">1</span>), axis=<span class="hljs-number">0</span>) * <span class="hljs-number">100</span>
y_cumulative = np.zeros(<span class="hljs-built_in">len</span>(df))

<span class="hljs-keyword">for</span> i, company <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(companies):
    axes[<span class="hljs-number">0</span>].fill_between(
        df.index,
        y_cumulative,
        y_cumulative + df_normalized[company].values,
        color=colors[i],
        alpha=<span class="hljs-number">0.7</span>,
        label=company,
        edgecolor=<span class="hljs-string">"white"</span>,
        linewidth=<span class="hljs-number">0.5</span>,
    )
    y_cumulative += df_normalized[company].values

<span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># ============ 地平线图：股价波动对比 ============</span>
<span class="hljs-comment"># 生成股价变化百分比数据（更能体现波动对比）</span>
np.random.seed(<span class="hljs-number">42</span>)
price_changes = {}
<span class="hljs-keyword">for</span> company <span class="hljs-keyword">in</span> companies:
    <span class="hljs-comment"># 生成均值附近波动的变化数据</span>
    <span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># 关键参数：定义“波段”</span>
BAND_HEIGHT = <span class="hljs-number">3.0</span>  <span class="hljs-comment"># 每个颜色波段代表的变化率幅度 (%)</span>
NUM_BANDS = <span class="hljs-number">3</span>  <span class="hljs-comment"># 正负方向各使用的波段层数</span>

df = pd.DataFrame(price_changes, index=dates)

<span class="hljs-comment"># 为每家公司计算并绘制地平线</span>
<span class="hljs-keyword">for</span> i, company <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(companies):
    <span class="hljs-comment"># 公司的基准Y轴位置（水平线）</span>
    <span class="hljs-comment"># 省略 ...</span>

    <span class="hljs-comment"># 分层与绘制：从第1层到第NUM_BANDS层</span>
    <span class="hljs-keyword">for</span> band <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(NUM_BANDS):
        <span class="hljs-comment"># --- 处理正偏差（上涨）---</span>
        <span class="hljs-comment"># 计算当前层的数据：偏差值减去已绘制层的高度，并限制在本层高度内</span>
        <span class="hljs-comment"># 省略 ...</span>

        <span class="hljs-comment"># --- 处理负偏差（下跌）---</span>
        <span class="hljs-comment"># 对负值取绝对值，进行类似处理</span>
        <span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># 美化图表</span>
<span class="hljs-comment"># 省略 ...</span>

<span class="hljs-comment"># 6. 添加图例</span>
<span class="hljs-keyword">import</span> matplotlib.patches <span class="hljs-keyword">as</span> mpatches

legend_patches = []
<span class="hljs-comment"># 省略 ...</span>

plt.tight_layout(h_pad=<span class="hljs-number">5</span>)
plt.show()
</code></pre>

<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/396d9a8fd701488aa6e37db79120bcee~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZGF0YWJvb2s=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083449&amp;x-signature=0ISHEtblp3IjjVCuC7i7GsPIhiI%3D" alt="" loading="lazy"/></p>
<p><strong>地平线图</strong>是空间利用大师。当你有 20 个股票或者 50 个城市的温度需要放在一张图里对比时，普通的面积图会挤成一团乱麻。</p>
<p><strong>地平线图</strong>可以将每个序列压缩成一个窄窄的横条，但在保持视觉分辨率的同时，还能让你看清极值（通过深颜色）。</p>
<h2 data-id="heading-2">3. 总结</h2>
<p>数据可视化不仅是科学，也是艺术。<strong>流图</strong>和<strong>地平线图</strong>这两种面积图变体，分别从**"流动之美"<strong>和</strong>"空间效率"**两个角度拓展了面积图的可能性。</p>
<p>它们证明了，通过对基础图表的创意改造，我们可以让数据讲述更丰富、更生动的故事。</p>
<p>下次当你面对时间序列数据时，不妨问问自己：我的数据像一条蜿蜒的河流，还是像地平线上的群山？选择适合的可视化方式，让你的数据真正"流动"起来或"层叠"起来。</p>
<p>记住，最好的可视化不是最复杂的，而是最能清晰传达信息、启发思考的那一个。</p>
<p>完整的代码共享在：<a href="https://link.juejin.cn?target=https%3A%2F%2Furl11.ctfile.com%2Ff%2F45455611-8635132430-f06d31%3Fp%3D6872" target="_blank" title="https://url11.ctfile.com/f/45455611-8635132430-f06d31?p=6872" ref="nofollow noopener noreferrer">面积图的2个变种.ipynb</a> (访问密码: 6872)</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《从轮播图实现，学会如何观察页面的“渲染”与“合成”》（附 Performance 实测对比）》]]></title>    <link>https://juejin.cn/post/7599294170001178675</link>    <guid>https://juejin.cn/post/7599294170001178675</guid>    <pubDate>2026-01-26T11:28:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599294170001178675" data-draft-id="7598472744481652755" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《从轮播图实现，学会如何观察页面的“渲染”与“合成”》（附 Performance 实测对比）》"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-26T11:28:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Flinton"/> <meta itemprop="url" content="https://juejin.cn/user/2225067266677640"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《从轮播图实现，学会如何观察页面的“渲染”与“合成”》（附 Performance 实测对比）》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2225067266677640/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Flinton
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T11:28:16.000Z" title="Mon Jan 26 2026 11:28:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>大家好，我是【小奇腾】，相信大家在前端的路上一定会遇到性能瓶颈的问题。可是谈了半天性能瓶颈，但是不知道怎么下手，也不知道从哪里开始。那么今天我和大家一起来探索这个奇妙的过程。也希望小伙伴一起支持加油下！！！</p>
</blockquote>
<p>本期详细的视频教程bilibili：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1dezvBWEm6%2F%3Fspm_id_from%3D333.1387.homepage.video_card.click%26vd_source%3D4213d38d889ea1581bbcae78a04cbd9d" target="_blank" title="https://www.bilibili.com/video/BV1dezvBWEm6/?spm_id_from=333.1387.homepage.video_card.click&amp;vd_source=4213d38d889ea1581bbcae78a04cbd9d" ref="nofollow noopener noreferrer">《从轮播图实现，学会如何观察页面的“渲染”与“合成”》（附 Performance 实测对比）》</a></p>
<h2 data-id="heading-0">一、 缘起：一个轮播图引发的思考</h2>













<table><thead><tr><th>需求</th><th>效果</th></tr></thead><tbody><tr><td>实现一个垂直轮播图，<br/>每隔 2 秒，图片向上滚动一次</td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c821ad6444c42799d497f9e9ee7306b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmxpbnRvbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770031820&amp;x-signature=Tu5AawGe7ydHJaGEQs3xcFQtKyg%3D" width="100%" loading="lazy"/></td></tr></tbody></table>
<p>效果看起来差不多，但是性能却不一样,有两种实现方案：</p>
<ol>
<li><strong>直觉派</strong>：修改 <code>margin-top</code> 或者 <code>top</code> 属性，把图片“挤”上去。</li>
<li><strong>优化派</strong>：使用 CSS3 的 <code>transform: translateY</code>，把图片“移”上去。</li>
</ol>
<h2 data-id="heading-1">二、 选手入场：两种代码实现 (代码见 -&gt; 代码附录 最底部)</h2>
<p>为了控制变量，我准备了两个简单的 Demo，HTML 结构完全一致，唯独驱动动画的方式不同。</p>
<p><strong>方案 A：使用 Margin-top（低性能模拟）</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 修改 margin-top，触发文档流变化</span>
wrapper.<span class="hljs-property">style</span>.<span class="hljs-property">marginTop</span> = <span class="hljs-string">`<span class="hljs-subst">${offset}</span>px`</span>;
</code></pre>
<p><strong>方案 B：使用 Transform（高性能推荐）</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 修改 transform，开启硬件加速</span>
wrapper.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">`translateY(<span class="hljs-subst">${offset}</span>px)`</span>;
</code></pre>
<p>接下来，我们用数据说话。</p>
<h2 data-id="heading-2">三、 第一关：视觉观测（Rendering 面板）</h2>
<p>Chrome 的开发者工具里隐藏着一个神器叫 <strong>Rendering（渲染）</strong> 。</p>
<blockquote>
<p><strong>如何打开</strong>：<code>F12</code> -&gt; <code>Cmd/Ctrl + Shift + P</code> -&gt; 输入 <code>Rendering</code> -&gt; 选择 <code>Show Rendering</code>。</p>
</blockquote>
<p>我勾选了 <strong>Paint flashing (突出显示绘制区域) / Enable automatic dark mode (暗黑模式)</strong> ，这个功能的作用是：<strong>只要页面上有像素被重绘，就闪烁绿色。</strong></p>













<table><thead><tr><th>设置</th><th>效果</th></tr></thead><tbody><tr><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2cbbeb8a49df4977b717287f24107b67~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmxpbnRvbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770031820&amp;x-signature=mNABdyaTqEkAR5QQxpNUKIzaK6A%3D" width="80%" loading="lazy"/></td><td><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d061de3e26aa4bb89391a08f4a8f72d5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmxpbnRvbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770031820&amp;x-signature=GWsFzjuZ81kj9NkMkGRjx45r8s4%3D" width="100%" loading="lazy"/></td></tr></tbody></table>
<h3 data-id="heading-3">1. 观察 Margin-top 方案</h3>
<p>当图片滚动时，我被吓了一跳： <strong>（在此处插入你那张【有绿色大边框】的截图）</strong></p>
<p><strong>现象</strong>：每次轮播切换，整个容器甚至周边区域都疯狂闪烁绿光。</p>
<p><strong>结论</strong>：这说明浏览器在进行大面积的<strong>重绘 (Repaint)</strong> 。CPU 正在辛苦地重新计算每一个像素的颜色。</p>
<h3 data-id="heading-4">2. 观察 Transform 方案</h3>
<p>接着我切换到 Transform 写法： <strong>（在此处插入你那张【完全没有绿框】的截图）</strong></p>
<p><strong>现象</strong>：画面静如止水，图片在动，但没有绿光闪烁（或者只有极微小的区域）。</p>
<p><strong>结论</strong>：浏览器没有重绘！它偷懒了？不，它是变聪明了。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d3df872392f49af8a390df3b9660e32~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmxpbnRvbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770031820&amp;x-signature=giGqriMxjS3gmlvY5U3nSVND368%3D" width="50%" loading="lazy"/> |</p>
<h3 data-id="heading-5">四、 第二关：深度扫描（Performance 面板）</h3>
<p>如果说绿光只是表象，那 Performance 面板就是“实锤”证据。我开启了 <strong>CPU 4x Slowdown</strong>（模拟低端设备），分别录制了两次滚动的过程。</p>
<h4 data-id="heading-6">1. 打开 CPU 4x slowdown</h4>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c76cf6fd46fa447c9dbd078ea104c73a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmxpbnRvbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770031820&amp;x-signature=EfcOnXhGQGhAVrxpCtqNG9jIztU%3D" width="100%" loading="lazy"/> 
<h4 data-id="heading-7">2. 打开 performance中的录制功能</h4>
<p>红色那个圆圈的就是录制按钮，录制7秒左右就可以了，然后点击stop，看结果</p>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d6649f874f83434895afa0c023e4824c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmxpbnRvbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770031820&amp;x-signature=js0uiRSObgLIH67EUXlagwCTvFU%3D" width="100%" loading="lazy"/> 
<h4 data-id="heading-8">3. 关键看 Main 的部份</h4>
<ol>
<li>观察 Margin-top 方案</li>
</ol>
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/69337f092b3a4a159ee83903abc4092e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmxpbnRvbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770031820&amp;x-signature=irPoLOEvsYuxcLpoLkJuPifwJn0%3D" width="100%" loading="lazy"/> 
<p>大家看上图的 <strong>Main (主线程)</strong> 区域：</p>
<ul>
<li>在Main的部份圈红色的 密密麻麻的“绿色波峰”是什么？鼠标放上去，全是 <strong>Layout (布局)</strong> / <strong>Update Layer Tree</strong> / <strong>Paint</strong>。</li>
<li>因为修改 <code>margin</code> 会改变元素的几何位置，浏览器必须重新计算布局（Reflow），这会阻塞主线程。</li>
</ul>
<ol start="2">
<li>观察 Transform 方案</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/02d3336338b944a69dacf0d8bfad2202~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRmxpbnRvbg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770031820&amp;x-signature=eMhIicXBn%2FHQzhh3tnTlgd0Vrhg%3D" alt="image.png" loading="lazy"/></p>
<ul>
<li>Main 线程几乎是一条直线！</li>
<li>没有 Layout，没有 Paint，只有零星的动画帧触发。</li>
<li>这是因为 <code>transform</code> 将元素提升为了<strong>合成层 (Composite Layer)</strong> ，动画的平移工作直接交给了 <strong>GPU</strong> 处理，主线程完全解放了出来。</li>
</ul>
<p>关于性能更多内容(<code>顶部的视频链接</code>)有具体的演示.</p>
<h2 data-id="heading-9">五、 总结：为什么 Transform 性能更好？</h2>
<p>通过这次观测，我们验证了浏览器渲染流水线的核心差异：</p>



































<table><thead><tr><th><strong>维度</strong></th><th><strong>Margin-top / Top</strong></th><th><strong>Transform</strong></th></tr></thead><tbody><tr><td><strong>触发机制</strong></td><td>修改几何属性</td><td>修改合成属性</td></tr><tr><td><strong>重排 (Reflow)</strong></td><td>✅ <strong>触发</strong> (计算布局，最慢)</td><td>❌ <strong>不触发</strong></td></tr><tr><td><strong>重绘 (Repaint)</strong></td><td>✅ <strong>触发</strong> (重新画像素，慢)</td><td>❌ <strong>不触发</strong></td></tr><tr><td><strong>执行位置</strong></td><td>CPU (主线程)</td><td>GPU (合成线程)</td></tr><tr><td><strong>性能表现</strong></td><td>容易卡顿</td><td>丝滑流畅</td></tr></tbody></table>
<p><strong>简单理解</strong>：</p>
<ul>
<li>
<p><strong>Margin-top</strong> 就像是你要搬家，你把房子拆了（Reflow），然后再一块块砖砌到新位置（Repaint）。</p>
</li>
<li>
<p><strong>Transform</strong> 就像是你拍了一张房子的照片，然后用幻灯片把这张照片投影到新位置。房子没动，只是投影动了，所以极快。</p>
</li>
</ul>
<h2 data-id="heading-10">六、代码附录</h2>
<h3 data-id="heading-11">1. Margin-Top方案（低性能）</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>垂直轮播图演示 - Margin-Top方案（低性能）<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        * { <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">box-sizing</span>: border-box; }
        <span class="hljs-selector-tag">body</span> { <span class="hljs-attribute">display</span>: flex; <span class="hljs-attribute">justify-content</span>: center; <span class="hljs-attribute">align-items</span>: center; <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>; <span class="hljs-attribute">background</span>: <span class="hljs-number">#f0f2f5</span>; }

        <span class="hljs-selector-class">.viewport</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
            <span class="hljs-attribute">border</span>: <span class="hljs-number">5px</span> solid <span class="hljs-number">#333</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">overflow</span>: hidden;
            <span class="hljs-attribute">position</span>: relative;
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#fff</span>;
            <span class="hljs-comment">/* 注意：这里不需要 will-change 了，因为我们就是在模拟没有优化的情况 */</span>
        }

        <span class="hljs-selector-class">.wrapper</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-comment">/* ❌ 性能杀手：这里我们要改变 margin-top */</span>
            <span class="hljs-comment">/* 浏览器必须重新计算布局，因为 margin 改变会影响文档流 */</span>
            <span class="hljs-attribute">transition</span>: margin-top <span class="hljs-number">0.5s</span> ease-in-out; 
        }

        <span class="hljs-selector-class">.slide</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>;
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">justify-content</span>: center;
            <span class="hljs-attribute">align-items</span>: center;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">40px</span>;
            <span class="hljs-attribute">color</span>: white;
            <span class="hljs-attribute">font-weight</span>: bold;
        }

        <span class="hljs-selector-class">.slide</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">1</span>) { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#FF5733</span>; }
        <span class="hljs-selector-class">.slide</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">2</span>) { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#33FF57</span>; }
        <span class="hljs-selector-class">.slide</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">3</span>) { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#3357FF</span>; }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"viewport"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"wrapper"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"slide"</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"slide"</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"slide"</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">const</span> wrapper = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.wrapper'</span>);
        <span class="hljs-keyword">const</span> imgHeight = <span class="hljs-number">200</span>; 
        <span class="hljs-keyword">const</span> totalSlides = <span class="hljs-number">3</span>; 
        <span class="hljs-keyword">let</span> currentIndex = <span class="hljs-number">0</span>;

        <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
            currentIndex++;
            <span class="hljs-keyword">if</span> (currentIndex &gt;= totalSlides) {
                currentIndex = <span class="hljs-number">0</span>;
            }

            <span class="hljs-keyword">const</span> offset = -(currentIndex * imgHeight);

            <span class="hljs-comment">// ❌ 核心区别在这里：</span>
            <span class="hljs-comment">// 我们修改的是 marginTop，而不是 transform</span>
            <span class="hljs-comment">// 这会触发布局重排 (Reflow)</span>
            wrapper.<span class="hljs-property">style</span>.<span class="hljs-property">marginTop</span> = <span class="hljs-string">`<span class="hljs-subst">${offset}</span>px`</span>;

            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`当前使用 margin-top 偏移: <span class="hljs-subst">${offset}</span>px`</span>);

        }, <span class="hljs-number">2000</span>);
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-12">2. Transform方案 (性能好)</h3>
<pre><code class="hljs language-html" lang="html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>垂直轮播图演示 - Transform方案<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        <span class="hljs-comment">/* 简单的重置 */</span>
        * { <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>; <span class="hljs-attribute">box-sizing</span>: border-box; }
        <span class="hljs-selector-tag">body</span> { <span class="hljs-attribute">display</span>: flex; <span class="hljs-attribute">justify-content</span>: center; <span class="hljs-attribute">align-items</span>: center; <span class="hljs-attribute">height</span>: <span class="hljs-number">100vh</span>; <span class="hljs-attribute">background</span>: <span class="hljs-number">#f0f2f5</span>; }

        <span class="hljs-comment">/* 1. 视口：固定高度，像一个相框 */</span>
        <span class="hljs-selector-class">.viewport</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">300px</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>; <span class="hljs-comment">/* 视口高度 */</span>
            <span class="hljs-attribute">border</span>: <span class="hljs-number">5px</span> solid <span class="hljs-number">#333</span>;
            <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">10px</span>;
            <span class="hljs-attribute">overflow</span>: hidden; <span class="hljs-comment">/* 关键：把超出的部分切掉 */</span>
            <span class="hljs-attribute">position</span>: relative;
            <span class="hljs-attribute">background</span>: <span class="hljs-number">#fff</span>;
            <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">10px</span> <span class="hljs-number">20px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>);
        }

        <span class="hljs-comment">/* 2. 渲染层/包裹层：用来移动的长条 */</span>
        <span class="hljs-selector-class">.wrapper</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-comment">/* 这里不需要设置高度，内容撑开即可 */</span>
            
            <span class="hljs-comment">/* 关键性能优化：过渡动画 */</span>
            <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.5s</span> ease-in-out; 
            <span class="hljs-comment">/* 提示浏览器开启 GPU 加速 */</span>
            <span class="hljs-attribute">will-change</span>: transform;
        }

        <span class="hljs-comment">/* 3. 图片样式：为了演示方便，我用带颜色的div代替图片 */</span>
        <span class="hljs-selector-class">.slide</span> {
            <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200px</span>; <span class="hljs-comment">/* 必须和视口高度一致 */</span>
            <span class="hljs-attribute">display</span>: flex;
            <span class="hljs-attribute">justify-content</span>: center;
            <span class="hljs-attribute">align-items</span>: center;
            <span class="hljs-attribute">font-size</span>: <span class="hljs-number">40px</span>;
            <span class="hljs-attribute">color</span>: white;
            <span class="hljs-attribute">font-weight</span>: bold;
        }

        <span class="hljs-selector-class">.slide</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">1</span>) { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#FF5733</span>; } <span class="hljs-comment">/* 红 */</span>
        <span class="hljs-selector-class">.slide</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">2</span>) { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#33FF57</span>; } <span class="hljs-comment">/* 绿 */</span>
        <span class="hljs-selector-class">.slide</span><span class="hljs-selector-pseudo">:nth-child</span>(<span class="hljs-number">3</span>) { <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#3357FF</span>; } <span class="hljs-comment">/* 蓝 */</span>
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"viewport"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"wrapper"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"slide"</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"slide"</span>&gt;</span>2<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"slide"</span>&gt;</span>3<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-keyword">const</span> wrapper = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.wrapper'</span>);
        <span class="hljs-keyword">const</span> imgHeight = <span class="hljs-number">200</span>; <span class="hljs-comment">// 单张图片高度</span>
        <span class="hljs-keyword">const</span> totalSlides = <span class="hljs-number">3</span>; 
        <span class="hljs-keyword">let</span> currentIndex = <span class="hljs-number">0</span>;

        <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-comment">// 1. 逻辑计算：下一次是第几张？</span>
            currentIndex++;
            
            <span class="hljs-comment">// 简单的回滚逻辑：如果到底了，就瞬间跳回第一张</span>
            <span class="hljs-keyword">if</span> (currentIndex &gt;= totalSlides) {
                currentIndex = <span class="hljs-number">0</span>;
            }

            <span class="hljs-comment">// 2. 核心计算：偏移量 = 索引 * 单张高度</span>
            <span class="hljs-comment">// 加上负号是因为由于坐标系原点在左上角，往上移动是负方向</span>
            <span class="hljs-keyword">const</span> offset = -(currentIndex * imgHeight);

            <span class="hljs-comment">// 3. 渲染：应用 Transform</span>
            <span class="hljs-comment">// 注意：这里完全没有用到 scrollTop，只用了数学计算</span>
            wrapper.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">`translateY(<span class="hljs-subst">${offset}</span>px)`</span>;
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`当前索引: <span class="hljs-subst">${currentIndex}</span>, 偏移量: <span class="hljs-subst">${offset}</span>px`</span>);

        }, <span class="hljs-number">2000</span>);
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[React useDeferredValue 详解：让你的应用丝滑流畅的秘密]]></title>    <link>https://juejin.cn/post/7599294170001326131</link>    <guid>https://juejin.cn/post/7599294170001326131</guid>    <pubDate>2026-01-26T11:59:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599294170001326131" data-draft-id="7599450177058193418" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="React useDeferredValue 详解：让你的应用丝滑流畅的秘密"/> <meta itemprop="keywords" content="前端,JavaScript,面试"/> <meta itemprop="datePublished" content="2026-01-26T11:59:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码诗人卡尔"/> <meta itemprop="url" content="https://juejin.cn/user/2067500101533902"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            React useDeferredValue 详解：让你的应用丝滑流畅的秘密
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2067500101533902/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码诗人卡尔
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T11:59:45.000Z" title="Mon Jan 26 2026 11:59:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、从一个常见的卡顿场景说起</h2>
<p>做前端的同学，肯定都遇到过这样的场景：一个搜索框，下面跟着一个长长的列表。用户在搜索框里每敲一个字，列表就根据输入的内容进行过滤。如果列表数据量不大，那还好说。但如果列表有成百上千条数据，那场面就有点尴尬了——用户每输入一个字，页面就卡一下，感觉就像在放慢动作的幻灯片。</p>
<p>这种体验，用户不爽，我们开发者看着也难受。问题出在哪儿呢？</p>
<p>很简单，因为每一次输入，都触发了 React 的重新渲染。而每一次重新渲染，都要遍历整个长列表，进行过滤和展示。浏览器扛不住这么高频率的计算，自然就卡了。</p>
<h2 data-id="heading-1">二、一个不那么完美的解决方案</h2>
<p>遇到这种问题，很多同学的第一反应是：用 <code>debounce</code>（防抖）或 <code>throttle</code>（节流）啊！</p>
<p>确实，这是一个很常见的优化手段。我们可以设置一个延迟，比如 200 毫秒，等用户停止输入 200 毫秒后，再进行列表的过滤和渲染。这样确实能减少渲染次数，缓解卡顿。</p>
<p>但这个方案并不完美。为什么呢？</p>
<ol>
<li><strong>延迟时间的设置很玄学</strong>：200 毫秒对于高性能的电脑来说，可能太长了，用户会感觉有明显的延迟；对于低性能的手机来说，可能又太短了，依然会卡顿。你很难找到一个适合所有设备的完美延迟时间。</li>
<li><strong>体验上还是有点怪</strong>：用户会发现，输入框里的文字已经变了，但下面的列表却没反应，要等一下才会更新。这种“脱节”的感觉，总让人觉得有点不自然。</li>
</ol>
<p>那么，有没有更好的办法呢？</p>
<h2 data-id="heading-2">三、主角登场：<code>useDeferredValue</code></h2>
<p>React 18 给我们带来了一个新式武器：<code>useDeferredValue</code>。这个 Hook 可以说是专门为了解决这类问题而生的。</p>
<p>它的核心思想很简单：<strong>允许我们把一个值的更新推迟（defer）到不那么紧急的时候再进行</strong>。</p>
<p>换句话说，它会给我们一个“延迟”版本的值。这个延迟版本的值，会在浏览器空闲的时候，才更新到最新状态。</p>
<p>让我们来看代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useState, useDeferredValue } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [query, setQuery] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> deferredQuery = <span class="hljs-title function_">useDeferredValue</span>(query);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
        <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> 
        <span class="hljs-attr">value</span>=<span class="hljs-string">{query}</span> 
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setQuery(e.target.value)} 
      /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">SlowList</span> <span class="hljs-attr">text</span>=<span class="hljs-string">{deferredQuery}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>看到没，我们把 <code>query</code> 这个 state 传给了 <code>useDeferredValue</code>，得到了一个新的变量 <code>deferredQuery</code>。然后，我们把 <code>deferredQuery</code> 传给了那个很慢的列表组件 <code>&lt;SlowList&gt;</code>。</p>
<p>这里发生了什么神奇的事情呢？</p>
<ol>
<li>当用户在输入框里输入时，<code>query</code> 的值会立刻更新。</li>
<li><code>App</code> 组件会立刻重新渲染。</li>
<li>但是，<code>deferredQuery</code> 的值并不会立刻变成最新的 <code>query</code>。它会保持上一次的值。</li>
<li>React 会先用旧的 <code>deferredQuery</code> 渲染一次 <code>&lt;SlowList&gt;</code>。因为 props 没有变，如果 <code>&lt;SlowList&gt;</code> 被 <code>React.memo</code> 包裹了，它就不会重新渲染，UI 也就不会卡顿。</li>
<li>然后，React 会在后台启动一个低优先级的渲染，把 <code>deferredQuery</code> 更新到最新的 <code>query</code>。</li>
<li>如果在这个低优先级渲染完成之前，用户又输入了新的内容，React 就会中断这次渲染，重新开始一个新的高优先级渲染（只更新输入框），然后再安排一个新的低优先级渲染（更新列表）。</li>
</ol>
<p>这样一来，用户的输入操作永远是最高优先级的，输入框的响应会非常快，非常丝滑。而那个耗时的列表渲染，则被推迟到了浏览器不忙的时候再进行，不会阻塞用户的操作。</p>
<h2 data-id="heading-3">四、两个需要注意的地方</h2>
<h3 data-id="heading-4"><code>React.memo</code> 或 <code>useMemo</code></h3>
<p><code>useDeferredValue</code> 的威力，需要和 <code>React.memo</code> 或 <code>useMemo</code> 配合才能完全发挥出来。</p>
<p>如果你的慢组件没有用 <code>React.memo</code> 包裹，那即使 <code>deferredQuery</code> 还是旧的值，组件也还是会重新渲染，那就白搭了。</p>
<p><strong>方案一：使用 <code>React.memo</code></strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">SlowList</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">memo</span>(<span class="hljs-keyword">function</span> <span class="hljs-title function_">SlowList</span>(<span class="hljs-params">{ text }</span>) {
  <span class="hljs-comment">// ... 耗时的列表渲染逻辑</span>
});
</code></pre>
<p><strong>方案二：使用 <code>useMemo</code></strong></p>
<p>如果你不想单独抽离一个组件，也可以用 <code>useMemo</code> 来缓存渲染结果：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [query, setQuery] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>);
  <span class="hljs-keyword">const</span> deferredQuery = <span class="hljs-title function_">useDeferredValue</span>(query);

  <span class="hljs-keyword">const</span> slowList = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">SlowList</span> <span class="hljs-attr">text</span>=<span class="hljs-string">{deferredQuery}</span> /&gt;</span></span>;
  }, [deferredQuery]);

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
        <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> 
        <span class="hljs-attr">value</span>=<span class="hljs-string">{query}</span> 
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setQuery(e.target.value)} 
      /&gt;
      {slowList}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  );
}
</code></pre>
<p>这样，只有当 <code>deferredQuery</code> 变化时，<code>&lt;SlowList&gt;</code> 才会重新渲染。</p>
<h2 data-id="heading-5">五、给用户一个加载提示</h2>
<p><code>useDeferredValue</code> 还有一个很贴心的功能：我们可以通过比较原始值和延迟值是否相等，来判断那个慢的更新是否还在“路上”。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> isStale = query !== deferredQuery;

<span class="hljs-keyword">return</span> (
  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">input</span> 
      <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> 
      <span class="hljs-attr">value</span>=<span class="hljs-string">{query}</span> 
      <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setQuery(e.target.value)} 
    /&gt;
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">style</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">opacity:</span> <span class="hljs-attr">isStale</span> ? <span class="hljs-attr">0.5</span> <span class="hljs-attr">:</span> <span class="hljs-attr">1</span> }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">SlowList</span> <span class="hljs-attr">text</span>=<span class="hljs-string">{deferredQuery}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
);
</code></pre>
<p>当 <code>query</code> 和 <code>deferredQuery</code> 不相等时，就说明列表的更新正在被延迟。这时候，我们可以给列表一个半透明的样式，或者显示一个 loading 图标，告诉用户：“别急，马上就来！”</p>
<h2 data-id="heading-6">六、总结一下</h2>
<p><code>useDeferredValue</code> 是一个非常强大的性能优化工具，它让我们能够优雅地处理那些“高优先级”和“低优先级”的渲染任务，让应用在各种设备上都能保持流畅的交互体验。</p>
<p>下次再遇到类似的卡顿问题时，不妨试试 <code>useDeferredValue</code>。它可能会给你带来意想不到的惊喜。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[大文件分片上传实战：Vue3 + NestJS 实现秒传、断点续传、并发与失败重试（附完整代码）]]></title>    <link>https://juejin.cn/post/7599543345980637211</link>    <guid>https://juejin.cn/post/7599543345980637211</guid>    <pubDate>2026-01-26T12:14:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599543345980637211" data-draft-id="7599528186587054090" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="大文件分片上传实战：Vue3 + NestJS 实现秒传、断点续传、并发与失败重试（附完整代码）"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-01-26T12:14:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="hypoy"/> <meta itemprop="url" content="https://juejin.cn/user/3074670624777223"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            大文件分片上传实战：Vue3 + NestJS 实现秒传、断点续传、并发与失败重试（附完整代码）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3074670624777223/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    hypoy
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T12:14:38.000Z" title="Mon Jan 26 2026 12:14:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    18
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">大文件分片上传实战：Vue3 + NestJS 实现秒传、断点续传、并发与失败重试（附完整代码）</h2>
<p>最近在回顾项目里“大文件上传”相关的实现，顺手把大文件 <strong>分片上传</strong> 这一块重新整理了一遍。实际踩过坑之后会发现，上传并不是“选文件 → 发请求”这么简单：文件越大，越容易遇到网络抖动导致失败、页面刷新后进度丢失、失败后只能重传、重复上传浪费带宽，以及单请求上传速度慢且不可控等问题。</p>
<p>因此这次复盘里，把上传流程拆成了一条更可控的链路：先用 <strong>hash</strong> 作为文件唯一指纹，支持 <strong>秒传</strong> 与 <strong>断点续传</strong>；再把文件按固定大小进行 <strong>切片</strong>，配合 <strong>并发上传</strong> 提升吞吐，遇到失败则通过 <strong>指数退避重试</strong> 提高弱网场景下的成功率；最后由服务端按序 <strong>合并分片并清理临时文件</strong>，形成完整闭环。基于这套思路，实现了一套大文件分片上传方案，核心能力包括：</p>
<ul>
<li><strong>文件分片</strong>：默认 5MB（可配置）</li>
<li><strong>Hash 指纹</strong>：使用 SparkMD5，并放到 Web Worker 里计算，避免阻塞 UI</li>
<li><strong>并发上传</strong>：默认 3 并发</li>
<li><strong>失败重试</strong>：默认 3 次，指数退避</li>
<li><strong>断点续传</strong>：服务端返回已上传分片列表，前端跳过已完成分片</li>
<li><strong>秒传</strong>：服务端已存在相同 hash 的文件时直接返回成功</li>
<li><strong>安全合并</strong>：服务端按序合并并清理临时分片目录</li>
</ul>
<p>技术栈：</p>
<ul>
<li>前端：Vue 3 + TypeScript + Vite</li>
<li>后端：NestJS + TypeScript</li>
<li>Hash：SparkMD5（Web Worker）</li>
</ul>
<hr/>
<h3 data-id="heading-1">1. 整体流程与接口设计</h3>
<p>整个系统围绕四个接口构建：</p>






























<table><thead><tr><th>端点</th><th>方法</th><th>功能</th></tr></thead><tbody><tr><td><code>/upload/check</code></td><td>POST</td><td>秒传检测：是否已存在同 hash 文件</td></tr><tr><td><code>/upload/chunks</code></td><td>GET</td><td>查询已上传分片：断点续传的基础</td></tr><tr><td><code>/upload/chunk</code></td><td>POST</td><td>上传单个分片</td></tr><tr><td><code>/upload/merge</code></td><td>POST</td><td>合并分片并返回最终文件 URL</td></tr></tbody></table>
<p>上传时序：</p>
<ol>
<li>选择文件</li>
<li>Web Worker 计算文件 hash</li>
<li>秒传检测：命中则直接成功</li>
<li>查询已上传分片：断点续传</li>
<li>5MB 切片</li>
<li>并发上传未完成分片（默认 3）</li>
<li>请求合并</li>
<li>返回文件访问地址</li>
</ol>
<hr/>
<h3 data-id="heading-2">2. 前端：API 封装（api.ts）</h3>
<h4 data-id="heading-3">2.1 环境配置：开发直连、生产走反代</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">BASE_URL</span> = <span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">env</span>.<span class="hljs-property">PROD</span> ? <span class="hljs-string">''</span> : <span class="hljs-string">'http://localhost:3000'</span>;
</code></pre>
<ul>
<li>开发环境直接请求后端 <code>3000</code></li>
<li>生产环境使用相对路径，交给 Nginx 反向代理转发</li>
</ul>
<h4 data-id="heading-4">2.2 秒传检测：checkFile</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">checkFile</span>(<span class="hljs-params">hash: <span class="hljs-built_in">string</span>, filename: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">${BASE_URL}</span>/upload/check`</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">headers</span>: { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span> },
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ hash, filename }),
  });
  <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>();
}
</code></pre>
<p>服务端如果已有同 hash 文件，会返回 <code>{ exists: true, url }</code>，前端可以直接结束上传流程。</p>
<h4 data-id="heading-5">2.3 断点续传：getUploadedChunks</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getUploadedChunks</span>(<span class="hljs-params">hash: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">${BASE_URL}</span>/upload/chunks?hash=<span class="hljs-subst">${hash}</span>`</span>);
  <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>();
}
</code></pre>
<p>该接口返回已上传的分片索引数组，前端据此跳过已完成分片，继续上传剩余部分。</p>
<h4 data-id="heading-6">2.4 分片上传：uploadChunk（XHR 支持进度）</h4>
<p>为了拿到上传进度，分片上传使用 <code>XMLHttpRequest</code>：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">uploadChunk</span>(<span class="hljs-params">hash, chunkIndex, chunk, filename, onProgress?</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> formData = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FormData</span>();
    formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'hash'</span>, hash);
    formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'chunkIndex'</span>, <span class="hljs-title class_">String</span>(chunkIndex));
    formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'filename'</span>, filename);
    formData.<span class="hljs-title function_">append</span>(<span class="hljs-string">'file'</span>, chunk);

    <span class="hljs-keyword">const</span> xhr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">XMLHttpRequest</span>();
    xhr.<span class="hljs-title function_">open</span>(<span class="hljs-string">'POST'</span>, <span class="hljs-string">`<span class="hljs-subst">${BASE_URL}</span>/upload/chunk`</span>);

    xhr.<span class="hljs-property">upload</span>.<span class="hljs-property">onprogress</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (event.<span class="hljs-property">lengthComputable</span> &amp;&amp; onProgress) {
        <span class="hljs-title function_">onProgress</span>(event.<span class="hljs-property">loaded</span>, event.<span class="hljs-property">total</span>);
      }
    };

    xhr.<span class="hljs-property">onload</span> = <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-keyword">if</span> (xhr.<span class="hljs-property">status</span> &gt;= <span class="hljs-number">200</span> &amp;&amp; xhr.<span class="hljs-property">status</span> &lt; <span class="hljs-number">300</span>) {
        <span class="hljs-title function_">resolve</span>(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(xhr.<span class="hljs-property">responseText</span>));
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">`Upload failed with status <span class="hljs-subst">${xhr.status}</span>`</span>));
      }
    };

    xhr.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Network error'</span>));
    xhr.<span class="hljs-title function_">send</span>(formData);
  });
}
</code></pre>
<h4 data-id="heading-7">2.5 合并分片：mergeChunks</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">mergeChunks</span>(<span class="hljs-params">hash: <span class="hljs-built_in">string</span>, filename: <span class="hljs-built_in">string</span>, totalChunks: <span class="hljs-built_in">number</span></span>) {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`<span class="hljs-subst">${BASE_URL}</span>/upload/merge`</span>, {
    <span class="hljs-attr">method</span>: <span class="hljs-string">'POST'</span>,
    <span class="hljs-attr">headers</span>: { <span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span> },
    <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({ hash, filename, totalChunks }),
  });
  <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>();
}
</code></pre>
<hr/>
<h3 data-id="heading-8">3. 前端：Worker 计算 Hash（hash-worker.ts）</h3>
<p>大文件 MD5 的计算如果放在主线程，会造成明显卡顿。为了解决这个问题，采用 Web Worker 在后台分块读取文件并计算 SparkMD5。</p>
<p>Worker 内部按 2MB 分块计算：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-title class_">SparkMD5</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'spark-md5'</span>;

self.<span class="hljs-property">onmessage</span> = <span class="hljs-keyword">async</span> (<span class="hljs-attr">e</span>: <span class="hljs-title class_">MessageEvent</span>&lt;<span class="hljs-title class_">File</span>&gt;) =&gt; {
  <span class="hljs-keyword">const</span> file = e.<span class="hljs-property">data</span>;
  <span class="hljs-keyword">const</span> chunkSize = <span class="hljs-number">2</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;
  <span class="hljs-keyword">const</span> chunks = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">ceil</span>(file.<span class="hljs-property">size</span> / chunkSize);
  <span class="hljs-keyword">const</span> spark = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SparkMD5</span>.<span class="hljs-title class_">ArrayBuffer</span>();

  <span class="hljs-keyword">let</span> currentChunk = <span class="hljs-number">0</span>;

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">loadNext</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> start = currentChunk * chunkSize;
    <span class="hljs-keyword">const</span> end = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(start + chunkSize, file.<span class="hljs-property">size</span>);
    <span class="hljs-keyword">const</span> reader = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileReader</span>();

    reader.<span class="hljs-property">onload</span> = <span class="hljs-function">(<span class="hljs-params">event</span>) =&gt;</span> {
      <span class="hljs-keyword">if</span> (event.<span class="hljs-property">target</span>?.<span class="hljs-property">result</span>) {
        spark.<span class="hljs-title function_">append</span>(event.<span class="hljs-property">target</span>.<span class="hljs-property">result</span> <span class="hljs-keyword">as</span> <span class="hljs-title class_">ArrayBuffer</span>);
      }
      currentChunk++;

      self.<span class="hljs-title function_">postMessage</span>({
        <span class="hljs-attr">type</span>: <span class="hljs-string">'progress'</span>,
        <span class="hljs-attr">progress</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>((currentChunk / chunks) * <span class="hljs-number">100</span>),
      });

      <span class="hljs-keyword">if</span> (currentChunk &lt; chunks) {
        <span class="hljs-title function_">loadNext</span>();
      } <span class="hljs-keyword">else</span> {
        self.<span class="hljs-title function_">postMessage</span>({
          <span class="hljs-attr">type</span>: <span class="hljs-string">'complete'</span>,
          <span class="hljs-attr">hash</span>: spark.<span class="hljs-title function_">end</span>(),
        });
      }
    };

    reader.<span class="hljs-property">onerror</span> = <span class="hljs-function">() =&gt;</span> {
      self.<span class="hljs-title function_">postMessage</span>({ <span class="hljs-attr">type</span>: <span class="hljs-string">'error'</span>, <span class="hljs-attr">error</span>: <span class="hljs-string">'Failed to read file'</span> });
    };

    reader.<span class="hljs-title function_">readAsArrayBuffer</span>(file.<span class="hljs-title function_">slice</span>(start, end));
  };

  <span class="hljs-title function_">loadNext</span>();
};

<span class="hljs-keyword">export</span> {};
</code></pre>
<p>主线程侧通过 <code>calculateHash()</code> 监听 <code>progress / complete / error</code> 三种消息，实现 hash 进度展示与结果回传。</p>
<hr/>
<h3 data-id="heading-9">4. 前端：上传引擎（uploader.ts）</h3>
<p>上传引擎负责把“hash → 秒传 → 断点 → 并发 → 重试 → 合并”的全流程串起来，同时以统一的 <code>UploadProgress</code> 对外输出进度。</p>
<h4 data-id="heading-10">4.1 进度结构：UploadProgress</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-attr">status</span>: <span class="hljs-string">'hashing'</span> | <span class="hljs-string">'checking'</span> | <span class="hljs-string">'uploading'</span> | <span class="hljs-string">'merging'</span> | <span class="hljs-string">'success'</span> | <span class="hljs-string">'error'</span>
percentage, uploadedChunks, totalChunks, uploadedBytes, totalBytes, message
</code></pre>
<p>组件只需要订阅 <code>onProgress</code>，无需关心内部实现细节。</p>
<h4 data-id="heading-11">4.2 文件分片：sliceFile</h4>
<p>默认分片大小为 5MB（可配置）：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DEFAULT_CHUNK_SIZE</span> = <span class="hljs-number">5</span> * <span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>;
</code></pre>
<p>分片函数：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sliceFile</span>(<span class="hljs-params">file: File, chunkSize: <span class="hljs-built_in">number</span></span>): <span class="hljs-title class_">Blob</span>[] {
  <span class="hljs-keyword">const</span> <span class="hljs-attr">chunks</span>: <span class="hljs-title class_">Blob</span>[] = [];
  <span class="hljs-keyword">let</span> start = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">while</span> (start &lt; file.<span class="hljs-property">size</span>) {
    <span class="hljs-keyword">const</span> end = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(start + chunkSize, file.<span class="hljs-property">size</span>);
    chunks.<span class="hljs-title function_">push</span>(file.<span class="hljs-title function_">slice</span>(start, end));
    start = end;
  }
  <span class="hljs-keyword">return</span> chunks;
}
</code></pre>
<h4 data-id="heading-12">4.3 单分片失败重试：指数退避</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">uploadChunkWithRetry</span>(<span class="hljs-params">hash, chunkIndex, chunk, filename, maxRetries</span>) {
  <span class="hljs-keyword">let</span> <span class="hljs-attr">lastError</span>: <span class="hljs-title class_">Error</span> | <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> attempt = <span class="hljs-number">0</span>; attempt &lt;= maxRetries; attempt++) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">await</span> <span class="hljs-title function_">uploadChunk</span>(hash, chunkIndex, chunk, filename);
      <span class="hljs-keyword">return</span>;
    } <span class="hljs-keyword">catch</span> (error) {
      lastError = error <span class="hljs-keyword">as</span> <span class="hljs-title class_">Error</span>;
      <span class="hljs-keyword">if</span> (attempt &lt; maxRetries) {
        <span class="hljs-keyword">await</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function"><span class="hljs-params">resolve</span> =&gt;</span> <span class="hljs-built_in">setTimeout</span>(resolve, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">pow</span>(<span class="hljs-number">2</span>, attempt) * <span class="hljs-number">1000</span>));
      }
    }
  }
  <span class="hljs-keyword">throw</span> lastError;
}
</code></pre>
<h4 data-id="heading-13">4.4 并发上传：runConcurrent</h4>
<p>并发控制默认 3：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DEFAULT_CONCURRENCY</span> = <span class="hljs-number">3</span>;
</code></pre>
<p>并发调度逻辑按任务队列执行，同时限制最大并行数。</p>
<h4 data-id="heading-14">4.5 主流程：uploadFile</h4>
<p>上传入口 <code>uploadFile()</code> 按照以下顺序执行：</p>
<ol>
<li>计算 hash（Worker）</li>
<li>秒传检测（存在则直接返回）</li>
<li>获取已上传分片列表（断点续传）</li>
<li>切片并过滤掉已存在分片</li>
<li>并发上传剩余分片（失败自动重试）</li>
<li>合并分片</li>
<li>返回最终文件 URL</li>
</ol>
<p>此外，已上传的字节数会根据已存在分片提前累加，让断点续传的进度展示更准确。</p>
<hr/>
<h3 data-id="heading-15">5. 前端 UI：Hy-Upload.vue</h3>
<p>组件层提供了较完整的上传体验：</p>
<ul>
<li>点击选择文件 / 拖拽上传</li>
<li>自动上传（autoUpload）</li>
<li>上传状态图标与提示文案</li>
<li>进度条与百分比展示</li>
<li>上传成功展示 URL</li>
<li>失败后支持一键重置重新上传</li>
</ul>
<p>组件内部不关心上传细节，只需要调用 <code>uploadFile()</code> 并把进度回传即可。</p>
<hr/>
<h3 data-id="heading-16">6. 后端：NestJS 分片存储与合并</h3>
<p>后端使用 <code>UploadController</code> + <code>UploadService</code> 实现分片落盘、断点查询、最终合并与清理。</p>
<h4 data-id="heading-17">6.1 接收分片：/upload/chunk</h4>
<p>使用 multer 先存入临时目录：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-meta">@UseInterceptors</span>(<span class="hljs-title class_">FileInterceptor</span>(<span class="hljs-string">'file'</span>, { <span class="hljs-attr">dest</span>: <span class="hljs-string">'uploads/temp'</span> }))
</code></pre>
<p>然后移动到分片目录：</p>
<pre><code class="hljs language-bash" lang="bash">uploads/chunks/{<span class="hljs-built_in">hash</span>}/{chunkIndex}
</code></pre>
<h4 data-id="heading-18">6.2 秒传：/upload/check</h4>
<p>最终文件路径采用 <code>hash + ext</code> 的方式生成：</p>
<pre><code class="hljs language-bash" lang="bash">uploads/{<span class="hljs-built_in">hash</span>}{ext}
</code></pre>
<p>如果文件存在，返回可访问 URL：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">return</span> { <span class="hljs-attr">exists</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">url</span>: <span class="hljs-string">`/uploads/<span class="hljs-subst">${hash}</span><span class="hljs-subst">${ext}</span>`</span> };
</code></pre>
<h4 data-id="heading-19">6.3 断点续传：/upload/chunks</h4>
<p>读取 <code>uploads/chunks/{hash}</code> 目录下已有分片文件名，转成 index 数组返回，供前端跳过已完成分片。</p>
<h4 data-id="heading-20">6.4 合并：/upload/merge</h4>
<p>合并前会校验：</p>
<ul>
<li>分片数量是否完整</li>
<li>是否缺少某个分片（0..totalChunks-1）</li>
</ul>
<p>合并成功后清理 chunk 目录，返回最终 URL。</p>
<hr/>
<h3 data-id="heading-21">8. 总结</h3>
<p>这套大文件分片上传方案的核心思路，是把“上传”拆成一条可控、可恢复的链路：以 <strong>hash</strong> 作为文件唯一指纹，让相同文件具备 <strong>秒传</strong> 能力，并且在页面刷新后通过查询已上传分片实现 <strong>断点续传</strong>；hash 计算放到 <strong>Web Worker</strong> 中执行，避免大文件指纹计算阻塞主线程；上传阶段通过 <strong>并发</strong> 提升吞吐，通过 <strong>失败重试（指数退避）</strong> 增强弱网场景下的成功率；最终由服务端 <strong>按序合并分片并清理临时目录</strong>，实现从上传到落盘的完整闭环。</p>
<p>受时间精力所限，一些更贴近生产环境的能力暂时还未补齐，不过后续的可扩展方向已经梳理清楚：合并阶段可以升级为 <strong>流式合并</strong>，降低内存峰值并提升并发稳定性；进度展示可以改为基于 <code>onprogress</code> 的 <strong>实时累计</strong>，让进度更平滑、更可信；同时加入 <strong>分片过期清理机制</strong>，避免中断上传后分片长期残留占用磁盘。等后续逐步把这些点落地，整体的稳定性、可维护性以及使用体验都会进一步提升。</p>
<h3 data-id="heading-22">项目地址</h3>
<p>完整代码已开源：</p>
<ul>
<li>GitHub: <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTheproudcold%2Flarge-file-sharding-upload" target="_blank" title="https://github.com/Theproudcold/large-file-sharding-upload" ref="nofollow noopener noreferrer">github.com/Theproudcol…</a></li>
</ul>
<p>欢迎 Star / 提 Issue / PR，一起完善功能（例如流式合并、实时进度、分片过期清理等）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【鸿蒙开发教程】手把手教你开发碰一碰加好友功能]]></title>    <link>https://juejin.cn/post/7599514071105060879</link>    <guid>https://juejin.cn/post/7599514071105060879</guid>    <pubDate>2026-01-26T12:13:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599514071105060879" data-draft-id="7599526246503284770" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【鸿蒙开发教程】手把手教你开发碰一碰加好友功能"/> <meta itemprop="keywords" content="HarmonyOS,前端"/> <meta itemprop="datePublished" content="2026-01-26T12:13:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不喝水会渴"/> <meta itemprop="url" content="https://juejin.cn/user/1084533994686547"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【鸿蒙开发教程】手把手教你开发碰一碰加好友功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1084533994686547/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不喝水会渴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T12:13:56.000Z" title="Mon Jan 26 2026 12:13:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">手把手教你开发鸿蒙碰一碰加好友功能：告别扫码，贴贴就加友！</h2>
<p>还在为加好友扫半天二维码、输一串数字抓狂？鸿蒙的“碰一碰”功能直接把加好友简化到“贴贴就行”！不用搜、不用输，两台手机轻轻一碰，好友信息自动飞过去，主打一个“近在咫尺，一键加友”。今天就手把手带你把这个神仙功能搬进自己的App，以喵屿App的碰一碰加宠物好友为例，从原理到实战，包教包会～</p>
<h3 data-id="heading-1">● 碰一碰功能介绍</h3>
<p>碰一碰分享本质上是鸿蒙Share Kit的“隐藏彩蛋”，支持用户通过设备轻碰发起跨端分享，不管是传图片、共享Wi-Fi，还是咱今天要搞的加好友，都能搞定。更爽的是：只要你的应用支持系统分享，理论上不用额外魔改，就能解锁碰一碰能力，简直是懒人开发者的福音！</p>
<p><strong>流程说明：</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48110f763be24a4185cba3aae51ad5dd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5Zad5rC05Lya5ri0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770034436&amp;x-signature=ARu9tKfk%2B6o6lbJs5Xb24AODUrs%3D" alt="Alt" loading="lazy"/></p>
<ol>
<li>先给自家应用“注册”碰一碰分享事件，然后让两部亮屏解锁的手机来个“贴贴”（就像朋友握手一样）；</li>
<li>应用发现“贴贴”触发后，会调用碰一碰分享回调，咱在回调里把要分享的好友数据打包发出去；</li>
<li>对方手机接住数据，乖乖处理；</li>
<li>事儿办完了，记得解除注册，别让应用“占着茅坑不拉屎”～</li>
</ol>
<p><strong>使用约束（划重点！不然贴贴也白贴）</strong>
想让俩手机顺利贴贴传好友，得满足几个小条件：双端设备都得亮屏、解锁（总不能黑屏贴贴吧，手机也得“醒着”才知道要干活），而且华为分享服务得开着（系统默认开的，除非你手欠手动关了）。贴的时候得用手机顶部碰，不是随便怼哪里都管用哈～如果华为分享关了，碰的时候系统会贴心提醒你打开，不用慌。</p>
<p>链接: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.huawei.com%2Fconsumer%2Fcn%2Fdoc%2Fharmonyos-guides%2Fknock-share-between-phones-overview" target="_blank" title="https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/knock-share-between-phones-overview" ref="nofollow noopener noreferrer">碰一碰功能介绍</a></p>
<h3 data-id="heading-2">● 简单的碰一碰实现</h3>
<p>先从最简单的图片分享入手，带你尝尝碰一碰的甜头！其实鸿蒙的碰一碰超友好，只要你的应用支持系统分享，几乎不用额外折腾，几行代码就能搞定，看</p>
<pre><code class="hljs language-javascript" lang="javascript"> private <span class="hljs-keyword">async</span> <span class="hljs-title function_">handelShare</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {
    <span class="hljs-keyword">const</span> <span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>();
    <span class="hljs-comment">//需设置本地图片链接</span>
    <span class="hljs-keyword">let</span> filePath = <span class="hljs-variable language_">this</span>.<span class="hljs-property">ImgData</span>[<span class="hljs-variable language_">this</span>.<span class="hljs-property">curIndex</span>];
    <span class="hljs-keyword">let</span> utdTypeId = utd.<span class="hljs-title function_">getUniformDataTypeByFilenameExtension</span>(<span class="hljs-string">'.png'</span>, utd.<span class="hljs-property">UniformDataType</span>.<span class="hljs-property">IMAGE</span>);
    <span class="hljs-keyword">let</span> <span class="hljs-attr">shareData</span>: systemShare.<span class="hljs-property">SharedData</span> = <span class="hljs-keyword">new</span> systemShare.<span class="hljs-title class_">SharedData</span>({
      <span class="hljs-attr">utd</span>: utdTypeId,
      <span class="hljs-attr">uri</span>: fileUri.<span class="hljs-title function_">getUriFromPath</span>(filePath),
      <span class="hljs-attr">title</span>: <span class="hljs-string">'喵屿图片分享'</span>,
    });
    <span class="hljs-keyword">let</span> <span class="hljs-attr">controller</span>: systemShare.<span class="hljs-property">ShareController</span> = <span class="hljs-keyword">new</span> systemShare.<span class="hljs-title class_">ShareController</span>(shareData);
    <span class="hljs-keyword">const</span> <span class="hljs-attr">context</span>: common.<span class="hljs-property">UIAbilityContext</span> = uiContext.<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> common.<span class="hljs-property">UIAbilityContext</span>;
    controller.<span class="hljs-title function_">show</span>(context, {
      <span class="hljs-attr">previewMode</span>: systemShare.<span class="hljs-property">SharePreviewMode</span>.<span class="hljs-property">DETAIL</span>,
      <span class="hljs-attr">selectionMode</span>: systemShare.<span class="hljs-property">SelectionMode</span>.<span class="hljs-property">BATCH</span>,
    }).<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
      logger.<span class="hljs-title function_">info</span>(<span class="hljs-string">'HuaweiShare_ show'</span>);
    }).<span class="hljs-keyword">catch</span>(<span class="hljs-function">(<span class="hljs-params">error: BusinessError</span>) =&gt;</span> {
      logger.<span class="hljs-title function_">error</span>(<span class="hljs-string">`HuaweiShare_ show error. Code: <span class="hljs-subst">${error?.code}</span>, message: <span class="hljs-subst">${error?.message}</span>`</span>);
    });
  }
</code></pre>
<p>就这么几行，把本地图片路径填好，调用系统分享Kit，分享界面里就自带碰一碰功能了，是不是比凑半天二维码轻松多了？</p>
<h3 data-id="heading-3">● 碰一碰拉起指定应用（Deeplink的使用）</h3>
<p>但是问题来了：默认分享的图片、文本这些，会被图库、浏览器这些“路人甲”应用打开，咱要的是直接拉起自己的App加好友啊！总不能让用户碰完，结果跳去浏览器，那也太掉链子了。</p>
<p>系统早就想到这点了，给了俩解决方案：一是分享Applinking/Deeplink形式的链接，二是指定应用直达（6.0.0(20) Beta3新功能，咱今天先不唠这个）。Applinking和Deeplink的区别简单说：Applinking如果对方没装你家App，会跳浏览器或应用市场，Deeplink只会告诉你没有对应应用；Deeplink的配置更简单，咱今天就拿捏它！</p>
<p>想用Deeplink让分享内容精准跳自家App，第一步得给App“贴标签”——在module.json5里配置skills标签，相当于给系统说：“这个链接只能我家App接，别乱分给别人！”示例如下：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-comment">// ···</span>
    <span class="hljs-attr">"abilities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
    <span class="hljs-comment">// ···</span>
      <span class="hljs-punctuation">{</span>
        <span class="hljs-comment">// ···</span>
        <span class="hljs-attr">"skills"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"entities"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
              <span class="hljs-string">"entity.system.home"</span>
            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"actions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
              <span class="hljs-string">"ohos.want.action.home"</span>
            <span class="hljs-punctuation">]</span>
          <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
          <span class="hljs-punctuation">{</span>
            <span class="hljs-attr">"actions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
              <span class="hljs-comment">// actions不能为空，actions为空会造成目标方匹配失败。</span>
              <span class="hljs-string">"ohos.want.action.viewData"</span>
            <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
            <span class="hljs-attr">"uris"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
              <span class="hljs-punctuation">{</span>
                <span class="hljs-comment">// scheme必选，可以自定义，以link为例，需要替换为实际的scheme</span>
                <span class="hljs-attr">"scheme"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"link"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"host"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"www.example.com"</span>
              <span class="hljs-punctuation">}</span>
            <span class="hljs-punctuation">]</span>
          <span class="hljs-punctuation">}</span> <span class="hljs-comment">// 新增一个skill对象，用于跳转场景。如果存在多个跳转场景，需配置多个skill对象。</span>
        <span class="hljs-punctuation">]</span>
      <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// ···</span>
    <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-comment">// ···</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>配置完标签，还得让App知道“接了链接该干啥”——在目标应用的UIAbility的onCreate()或者onNewWant()里解析链接参数，比如拿到好友信息后，就可以触发加好友逻辑了：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 以DeepAbility.ets为例</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AbilityConstant</span>, <span class="hljs-title class_">UIAbility</span>, <span class="hljs-title class_">Want</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.AbilityKit'</span>;
<span class="hljs-keyword">import</span> { url } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkTS'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DOMAIN</span> = <span class="hljs-number">0x0000</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DeepAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {
  <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-keyword">void</span> {
    <span class="hljs-comment">// 从want中获取传入的链接信息。</span>
    <span class="hljs-comment">// 如传入的url为：link://www.example.com/programs?action=showall</span>
    <span class="hljs-keyword">let</span> uri = want?.<span class="hljs-property">uri</span>;
    <span class="hljs-keyword">if</span> (uri) {
      <span class="hljs-comment">// 从链接中解析query参数，拿到参数后，开发者可根据自己的业务需求进行后续的处理。</span>
      <span class="hljs-keyword">let</span> urlObject = url.<span class="hljs-property">URL</span>.<span class="hljs-title function_">parseURL</span>(want?.<span class="hljs-property">uri</span>);
      <span class="hljs-keyword">let</span> action = urlObject.<span class="hljs-property">params</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'action'</span>);
      <span class="hljs-comment">// 例如，当action为showall时，展示所有的节目。</span>
      <span class="hljs-keyword">if</span> (action === <span class="hljs-string">'showall'</span>) {
        <span class="hljs-comment">// ···</span>
      }
    }
  }
<span class="hljs-comment">// ···</span>
}
</code></pre>
<p>说白了，想让碰一碰拉起指定App干指定事，只要分享的时候把Deeplink链接发出去就行，系统会自动帮你找对App。不过上面都是靠系统分享界面实现的，有没有更“私密”的玩法，不用走系统界面？必须有！直接注册'knockShare'监听，就能自己掌控碰一碰的全过程，看官方代码👇</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { uniformTypeDescriptor <span class="hljs-keyword">as</span> utd } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkData'</span>;
<span class="hljs-keyword">import</span> { systemShare, harmonyShare } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ShareKit'</span>;
<span class="hljs-keyword">import</span> { fileUri } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.CoreFileKit'</span>;

@<span class="hljs-title class_">Component</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> struct <span class="hljs-title class_">Index</span> {
  <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-keyword">void</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-attr">capabilityRegistry</span>: harmonyShare.<span class="hljs-property">SendCapabilityRegistry</span> = {
      <span class="hljs-attr">windowId</span>: <span class="hljs-number">999</span>, <span class="hljs-comment">// 此值仅为示例 实际使用时请替换正确的windowId</span>
    }
    harmonyShare.<span class="hljs-title function_">on</span>(<span class="hljs-string">'knockShare'</span>, capabilityRegistry, <span class="hljs-function">(<span class="hljs-params">sharableTarget: harmonyShare.SharableTarget</span>) =&gt;</span> {
      <span class="hljs-keyword">let</span> <span class="hljs-attr">shareData</span>: systemShare.<span class="hljs-property">SharedData</span> = <span class="hljs-keyword">new</span> systemShare.<span class="hljs-title class_">SharedData</span>({
        <span class="hljs-attr">utd</span>: utd.<span class="hljs-property">UniformDataType</span>.<span class="hljs-property">HYPERLINK</span>,
        <span class="hljs-attr">content</span>: <span class="hljs-string">'https://sharekitdemo.drcn.agconnect.link/ZB3p'</span>,
        <span class="hljs-comment">// 根据title,description,thumbnailUri会生成不同的卡片模板，具体可参考设置配套的卡片样式。</span>
        <span class="hljs-attr">title</span>: <span class="hljs-string">'碰一碰分享卡片标题'</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">'碰一碰分享卡片描述'</span>
      });
      <span class="hljs-comment">// 若云端预览图无法及时下载 可先发送数据</span>
      sharableTarget.<span class="hljs-title function_">share</span>(shareData);

      <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 待预览图下载完成后 补充更新预览图</span>
        <span class="hljs-keyword">let</span> <span class="hljs-attr">uiContext</span>: <span class="hljs-title class_">UIContext</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>();
        <span class="hljs-keyword">let</span> <span class="hljs-attr">contextFaker</span>: <span class="hljs-title class_">Context</span> = uiContext.<span class="hljs-title function_">getHostContext</span>() <span class="hljs-keyword">as</span> <span class="hljs-title class_">Context</span>;
        <span class="hljs-keyword">let</span> filePath = contextFaker.<span class="hljs-property">filesDir</span> + <span class="hljs-string">'/exampleKnock1.jpg'</span>; <span class="hljs-comment">// 仅为示例 请替换正确的文件路径</span>
        sharableTarget.<span class="hljs-title function_">updateShareData</span>({
          <span class="hljs-attr">thumbnailUri</span>: fileUri.<span class="hljs-title function_">getUriFromPath</span>(filePath)
        });
      }, <span class="hljs-number">5000</span>);
    });
  }

  <span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-keyword">void</span> {
    <span class="hljs-keyword">let</span> <span class="hljs-attr">capabilityRegistry</span>: harmonyShare.<span class="hljs-property">SendCapabilityRegistry</span> = {
      <span class="hljs-attr">windowId</span>: <span class="hljs-number">999</span>, <span class="hljs-comment">// 此值仅为示例 实际使用时请替换正确的windowId</span>
    }
    <span class="hljs-comment">// 解除碰一碰分享'knockShare'监听事件</span>
    harmonyShare.<span class="hljs-title function_">off</span>(<span class="hljs-string">'knockShare'</span>, capabilityRegistry);
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
  }
}
</code></pre>
<h3 data-id="heading-4">● 碰一碰加好友功能实战</h3>
<p>光说不练假把式，接下来咱就拿“喵屿App”的碰一碰加宠物好友为例，手把手带你把这个功能落地，让养宠党贴贴手机就能互加宠物好友，再也不用手动输宠物信息啦！</p>
<h4 data-id="heading-5">碰一碰接收端处理</h4>
<p>想让碰一碰跳自家App加好友，第一步得给App“办个身份证”——在module.json5里配置skills标签，告诉系统：“这个链接是我的，别给别人！”</p>
<pre><code class="hljs language-javascript" lang="javascript">   <span class="hljs-string">"abilities"</span>: [
    {
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"EntryAbility"</span>,
        <span class="hljs-string">"srcEntry"</span>: <span class="hljs-string">"./ets/entryability/EntryAbility.ets"</span>,
        <span class="hljs-string">"description"</span>: <span class="hljs-string">"$string:EntryAbility_desc"</span>,
        <span class="hljs-string">"icon"</span>: <span class="hljs-string">"$media:layered_image"</span>,
        <span class="hljs-string">"label"</span>: <span class="hljs-string">"$string:EntryAbility_label"</span>,
        <span class="hljs-string">"startWindowIcon"</span> : <span class="hljs-string">"$media:layered_image"</span>,
        <span class="hljs-string">"startWindowBackground"</span> : <span class="hljs-string">"$color:start_window_background"</span>
          ,
        <span class="hljs-string">"exported"</span>: <span class="hljs-literal">true</span>
          ,
        <span class="hljs-string">"skills"</span>: [
          {
            <span class="hljs-string">"entities"</span>: [
              <span class="hljs-string">"entity.system.home"</span>
            ],
            <span class="hljs-string">"actions"</span>: [
              <span class="hljs-string">"ohos.want.action.home"</span>
            ]
          },
          {
            <span class="hljs-string">"actions"</span>: [<span class="hljs-string">"action.system.viewData"</span>],
            <span class="hljs-string">"entities"</span>: [<span class="hljs-string">"entity.system.browser"</span>],
            <span class="hljs-string">"uris"</span>: [
              {
                <span class="hljs-comment">// scheme必选，可以自定义，以catIsland为例，需要替换为实际的scheme</span>
                <span class="hljs-string">"scheme"</span>: <span class="hljs-string">"catIsland"</span>,
                <span class="hljs-string">"host"</span>: <span class="hljs-string">"catIsland.sx.com"</span>
              }
            ]
          } <span class="hljs-comment">// 新增一个skill对象，用于跳转场景。如果存在多个跳转场景，需配置多个skill对象。</span>
        ]
      }]
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c865d7ab1694e63a916c19ec21dd381~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5Zad5rC05Lya5ri0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770034436&amp;x-signature=jRPndb6eY2ofcRQESTZhrCKWGbs%3D" alt="碰一碰然后选择接收数据会走到onCreate()或者onNewWant()生命周期" loading="lazy"/>
<strong>划重点：</strong> 碰一碰接收数据后，App会走onCreate()或onNewWant()生命周期，俩都得处理，不然会漏数据！</p>
<p>然后就得让App“读懂”链接里的好友信息了——在EntryAbility的onCreate()和onNewWant()里解析链接参数，把宠物姓名、性别、生日这些信息抠出来，存到AppStorage里，等着后续处理：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EntryAbility</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">UIAbility</span> {
  <span class="hljs-title function_">onCreate</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-keyword">void</span> {
    <span class="hljs-comment">// 从want中获取传入的链接信息。</span>
    <span class="hljs-comment">// 如传入的url为：catIsland://catIsland.sx.com/share/?name=${info.name}&amp;sex=${info.sex}&amp;birth=${info.birth}&amp;breed=${info.breed}</span>
    <span class="hljs-keyword">let</span> uri = want?.<span class="hljs-property">uri</span>;
    <span class="hljs-keyword">if</span> (uri) {
      <span class="hljs-comment">// 从链接中解析query参数，拿到参数后，开发者可根据自己的业务需求进行后续的处理。</span>
      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onCreate'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(uri));
      <span class="hljs-keyword">const</span> urlObject = url.<span class="hljs-property">URL</span>.<span class="hljs-title function_">parseURL</span>(want?.<span class="hljs-property">uri</span>);
      <span class="hljs-keyword">const</span> name = urlObject.<span class="hljs-property">params</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'name'</span>);
      <span class="hljs-keyword">const</span> sex = urlObject.<span class="hljs-property">params</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'sex'</span>) ;
      <span class="hljs-keyword">const</span> birth = urlObject.<span class="hljs-property">params</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'birth'</span>);
      <span class="hljs-keyword">const</span> breed = urlObject.<span class="hljs-property">params</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'breed'</span>);
      <span class="hljs-keyword">if</span>(name){
        <span class="hljs-keyword">let</span> baseInfo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseInfo</span>(name)
        baseInfo.<span class="hljs-property">sex</span> = <span class="hljs-title class_">Number</span>(sex)
        baseInfo.<span class="hljs-property">birth</span> = birth
        baseInfo.<span class="hljs-property">breed</span> = breed
        <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'newFriend'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(baseInfo)); <span class="hljs-comment">//数据保存起来</span>
      }
    }

			...
  }

  <span class="hljs-title function_">onNewWant</span>(<span class="hljs-attr">want</span>: <span class="hljs-title class_">Want</span>, <span class="hljs-attr">launchParam</span>: <span class="hljs-title class_">AbilityConstant</span>.<span class="hljs-property">LaunchParam</span>): <span class="hljs-keyword">void</span> {
    <span class="hljs-comment">// 从want中获取传入的链接信息。</span>
    <span class="hljs-comment">// 如传入的url为：catIsland://catIsland.sx.com/share/?name=${info.name}&amp;sex=${info.sex}&amp;birth=${info.birth}&amp;breed=${info.breed}</span>
    <span class="hljs-keyword">let</span> uri = want?.<span class="hljs-property">uri</span>;
    <span class="hljs-keyword">if</span> (uri) {
      <span class="hljs-comment">// 从链接中解析query参数，拿到参数后，开发者可根据自己的业务需求进行后续的处理。</span>
      hilog.<span class="hljs-title function_">info</span>(<span class="hljs-variable constant_">DOMAIN</span>, <span class="hljs-string">'testTag'</span>, <span class="hljs-string">'%{public}s'</span>, <span class="hljs-string">'Ability onCreate'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(uri));
       <span class="hljs-keyword">const</span> urlObject = url.<span class="hljs-property">URL</span>.<span class="hljs-title function_">parseURL</span>(want?.<span class="hljs-property">uri</span>);
      <span class="hljs-keyword">const</span> name = urlObject.<span class="hljs-property">params</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'name'</span>);
      <span class="hljs-keyword">const</span> sex = urlObject.<span class="hljs-property">params</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'sex'</span>) ;
      <span class="hljs-keyword">const</span> birth = urlObject.<span class="hljs-property">params</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'birth'</span>);
      <span class="hljs-keyword">const</span> breed = urlObject.<span class="hljs-property">params</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'breed'</span>);
      <span class="hljs-keyword">if</span>(name){
        <span class="hljs-keyword">let</span> baseInfo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">BaseInfo</span>(name)
        baseInfo.<span class="hljs-property">sex</span> = <span class="hljs-title class_">Number</span>(sex)
        baseInfo.<span class="hljs-property">birth</span> = birth
        baseInfo.<span class="hljs-property">breed</span> = breed
        <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">setOrCreate</span>(<span class="hljs-string">'newFriend'</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(baseInfo));<span class="hljs-comment">//数据保存起来</span>
        emitter.<span class="hljs-title function_">emit</span>(<span class="hljs-title class_">BaseConstants</span>.<span class="hljs-property">NEW_FRIEND</span>) <span class="hljs-comment">//通知有新朋友数据</span>
      }
    }
  }
  ...
</code></pre>
<p>为啥俩生命周期都要解析？简单说：App冷启动（第一次打开）走onCreate()，如果App已经开着，Deeplink拉它就只走onNewWant()。俩都处理，不管App是开是关，都能稳稳接住好友数据，主打一个“不漏网之鱼”！</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0fd2ead4fdad4dada02abd33240ea74a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5Zad5rC05Lya5ri0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770034436&amp;x-signature=JcsAE%2BpXSKoRvoaZILuG2nSglsU%3D" alt="在这里插入图片描述" loading="lazy"/>
<strong>MainPage弹窗选择是否保存好友数据</strong></p>
<p>数据存好了，总得让用户知道吧？在App首页MainPage.ets里监听好友数据，只要有新数据，就弹个窗让用户选“加好友”还是“拒绝”，体验直接拉满：</p>
<pre><code class="hljs language-javascript" lang="javascript"> onNewFriend = <span class="hljs-function">()=&gt;</span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'newFriend'</span>) != <span class="hljs-literal">undefined</span>){
      <span class="hljs-keyword">let</span> newFriend = <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">get</span>(<span class="hljs-string">'newFriend'</span>)!!) <span class="hljs-keyword">as</span> <span class="hljs-title class_">BaseInfo</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'testTag'</span> + <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(newFriend))
      <span class="hljs-title class_">AppStorage</span>.<span class="hljs-title function_">set</span>(<span class="hljs-string">'newFriend'</span>,  <span class="hljs-literal">undefined</span>)
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">friendDialog</span> = <span class="hljs-title class_">DialogHub</span>.<span class="hljs-title function_">getCustomDialog</span>()<span class="hljs-comment">//好友数据弹窗可以选择接受或者拒绝</span>
        .<span class="hljs-title function_">setOperableContent</span>(<span class="hljs-title function_">wrapBuilder</span>(<span class="hljs-title class_">NewFriendDialogBuilder</span>), <span class="hljs-function">(<span class="hljs-params">action: DialogAction</span>) =&gt;</span> {
          <span class="hljs-keyword">let</span> para = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PetDialogParams</span>(newFriend, action, <span class="hljs-variable language_">this</span>.<span class="hljs-property">promptAction</span>,  <span class="hljs-number">0</span>);
          <span class="hljs-keyword">return</span> para;
        })
        .<span class="hljs-title function_">setConfig</span>({ <span class="hljs-attr">dialogBehavior</span>: { <span class="hljs-attr">isModal</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">autoDismiss</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">passThroughGesture</span>: <span class="hljs-literal">false</span> } })
        .<span class="hljs-title function_">setAnimation</span>({ <span class="hljs-attr">dialogAnimation</span>: <span class="hljs-title class_">AnimationType</span>.<span class="hljs-property">BOTTOM_UP</span> })
        .<span class="hljs-title function_">setStyle</span>({
          <span class="hljs-attr">radius</span>: <span class="hljs-number">32</span>,
          <span class="hljs-attr">backgroundColor</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>,
          <span class="hljs-attr">maskBackgroundEffect</span>: { <span class="hljs-attr">blurOptions</span>: { <span class="hljs-attr">grayscale</span>: [<span class="hljs-number">50</span>, <span class="hljs-number">50</span>] }, <span class="hljs-attr">radius</span>: <span class="hljs-number">10</span> }
        })
        .<span class="hljs-title function_">build</span>();
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">friendDialog</span>.<span class="hljs-title function_">show</span>();
    }
  }

 <span class="hljs-title function_">aboutToAppear</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-keyword">void</span>&gt; {
    emitter.<span class="hljs-title function_">on</span>(<span class="hljs-title class_">BaseConstants</span>.<span class="hljs-property">NEW_FRIEND</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onNewFriend</span>) <span class="hljs-comment">//注册好友申请的监听</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">onNewFriend</span>()
    ...
 }
 ...
 <span class="hljs-title function_">aboutToDisappear</span>(): <span class="hljs-keyword">void</span> {
    emitter.<span class="hljs-title function_">off</span>(<span class="hljs-title class_">BaseConstants</span>.<span class="hljs-property">NEW_FRIEND</span>.<span class="hljs-property">eventId</span>, <span class="hljs-variable language_">this</span>.<span class="hljs-property">onNewFriend</span>)
  }
</code></pre>
<p>App启动后打开MainPage，先注册好友申请监听，确保主页在的时候能实时收到通知；然后立刻检查有没有待处理的好友数据，有就弹窗，不让用户等，主打一个“贴心”！</p>
<h4 data-id="heading-6">碰一碰发送端处理</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c00d7bbdcdc46469b8eec4533e73c24~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5Zad5rC05Lya5ri0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770034436&amp;x-signature=yNm60DKyo5yDjCxryF7tGyTK8SU%3D" alt="宠物信息界面设置碰一碰监听" loading="lazy"/>
<strong>宠物信息界面设置碰一碰监听</strong>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4fbdbc6ffdd44e7b1e1f0c104cc7deb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiN5Zad5rC05Lya5ri0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770034436&amp;x-signature=6v5bsQRkvIl4b3LXFDUwLeW5SRg%3D" alt="碰一碰后触发的分享界面" loading="lazy"/>
<strong>碰一碰后触发的分享界面</strong></p>
<p>最后一步，让碰一碰“活”起来！在宠物信息界面注册碰一碰监听，只要检测到两台手机贴贴，就把当前宠物的信息打包进Deeplink，注意要和前面moudule.json5中定义的<strong>scheme和host</strong>要匹配， 对方接住后就能按上面的流程处理好友申请了：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">showID</span>(<span class="hljs-params">info: BaseInfo, index: number = <span class="hljs-number">0</span></span>) {
    harmonyShare.<span class="hljs-title function_">on</span>(<span class="hljs-string">'knockShare'</span>, <span class="hljs-function">(<span class="hljs-params">sharableTarget: harmonyShare.SharableTarget</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> filePath = info.<span class="hljs-property">icon</span>; <span class="hljs-comment">// 仅为示例 请替换正确的文件路径</span>
      <span class="hljs-keyword">let</span> <span class="hljs-attr">shareData</span>: systemShare.<span class="hljs-property">SharedData</span> = <span class="hljs-keyword">new</span> systemShare.<span class="hljs-title class_">SharedData</span>({
        <span class="hljs-attr">utd</span>: utd.<span class="hljs-property">UniformDataType</span>.<span class="hljs-property">HYPERLINK</span>,
        <span class="hljs-attr">content</span>: <span class="hljs-string">`catIsland://catIsland.sx.com/share/?name=<span class="hljs-subst">${info.name}</span>&amp;sex=<span class="hljs-subst">${info.sex}</span>&amp;birth=<span class="hljs-subst">${info.birth}</span>&amp;breed=<span class="hljs-subst">${info.breed}</span>`</span>,
        <span class="hljs-comment">// 根据title,description,thumbnailUri会生成不同的卡片模板。</span>
        <span class="hljs-attr">thumbnailUri</span>: fileUri.<span class="hljs-title function_">getUriFromPath</span>(filePath),
        <span class="hljs-attr">title</span>: <span class="hljs-string">`分享<span class="hljs-subst">${info.name}</span>给好友`</span>,
        <span class="hljs-attr">description</span>: <span class="hljs-string">'碰一碰即可将宠物信息分享给好友'</span>
      });
      sharableTarget.<span class="hljs-title function_">share</span>(shareData);
    });

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">IDDialog</span> = <span class="hljs-title class_">DialogHub</span>.<span class="hljs-title function_">getCustomDialog</span>()
      .<span class="hljs-title function_">setOperableContent</span>(<span class="hljs-title function_">wrapBuilder</span>(<span class="hljs-title class_">PetIDDialogBuilder</span>), <span class="hljs-function">(<span class="hljs-params">action: DialogAction</span>) =&gt;</span> {
        <span class="hljs-keyword">let</span> para = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PetDialogParams</span>(info, action, <span class="hljs-variable language_">this</span>.<span class="hljs-property">promptAction</span>,  index);
        <span class="hljs-keyword">return</span> para;
      })
      .<span class="hljs-title function_">setConfig</span>({ <span class="hljs-attr">dialogBehavior</span>: { <span class="hljs-attr">isModal</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">autoDismiss</span>: <span class="hljs-literal">false</span>, <span class="hljs-attr">passThroughGesture</span>: <span class="hljs-literal">false</span> } })
      .<span class="hljs-title function_">setAnimation</span>({ <span class="hljs-attr">dialogAnimation</span>: <span class="hljs-title class_">AnimationType</span>.<span class="hljs-property">BOTTOM_UP</span> })
      .<span class="hljs-title function_">setStyle</span>({
        <span class="hljs-attr">radius</span>: <span class="hljs-number">32</span>,
        <span class="hljs-attr">backgroundColor</span>: <span class="hljs-title class_">Color</span>.<span class="hljs-property">White</span>,
        <span class="hljs-attr">maskBackgroundEffect</span>: { <span class="hljs-attr">blurOptions</span>: { <span class="hljs-attr">grayscale</span>: [<span class="hljs-number">50</span>, <span class="hljs-number">50</span>] }, <span class="hljs-attr">radius</span>: <span class="hljs-number">10</span> }
      })
      .<span class="hljs-title function_">build</span>();
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">IDDialog</span>.<span class="hljs-title function_">show</span>();
  }
}
</code></pre>
<p>这里踩个坑提醒各位老铁：博主最开始傻乎乎跟着官方新API写，用了6.0.0(20)新增的带capability参数的on方法，结果发现5.0版本的设备直接不兼容，主打一个“新是新，用不了”！最后只能乖乖换回5.0.0(12)的低版本API（不用传capability）。大家用的时候可别踩这个坑——新API虽香，但得看你的用户设备支不支持啊！</p>
<pre><code class="hljs language-javascript" lang="javascript">	<span class="hljs-comment">//注册设备轻贴的事件监听。</span>
	<span class="hljs-comment">//起始版本：6.0.0(20)</span>
	<span class="hljs-title function_">on</span>(<span class="hljs-attr">event</span>: <span class="hljs-string">'knockShare'</span>, <span class="hljs-attr">capability</span>: <span class="hljs-title class_">SendCapabilityRegistry</span>, <span class="hljs-attr">callback</span>: <span class="hljs-title class_">Callback</span>&lt;<span class="hljs-title class_">SharableTarget</span>&gt;): <span class="hljs-keyword">void</span>
	<span class="hljs-comment">//起始版本：5.0.0(12)</span>
	<span class="hljs-title function_">on</span>(<span class="hljs-attr">event</span>: <span class="hljs-string">'knockShare'</span>, <span class="hljs-attr">callback</span>: <span class="hljs-title class_">Callback</span>&lt;<span class="hljs-title class_">SharableTarget</span>&gt;): <span class="hljs-keyword">void</span>
</code></pre>
<p>实际效果演示可自行下载APP碰一碰试一试： <a href="https://link.juejin.cn?target=https%3A%2F%2Fappgallery.huawei.com%2Fapp%2Fdetail%3Fid%3Dcom.sx.catIsland%26channelId%3DSHARE%26source%3Dappshare" target="_blank" title="https://appgallery.huawei.com/app/detail?id=com.sx.catIsland&amp;channelId=SHARE&amp;source=appshare" ref="nofollow noopener noreferrer">喵屿下载链接</a></p>
<h3 data-id="heading-7">总结</h3>
<p>怎么样，是不是发现鸿蒙碰一碰加好友功能一点都不复杂？从配置Deeplink让链接精准跳自家App，到解析冷/热启动的参数不漏数据，再到监听碰一碰事件分享好友信息，一套流程走下来，你的App也能拥有“贴贴加好友”的神仙能力！</p>
<p>相比传统的扫码、输码加好友，碰一碰直接把操作简化到“贴一下”，用户体验直接拉满。而且整个开发过程几乎不用造轮子，依托鸿蒙Share Kit就能搞定，唯一要注意的就是API版本兼容问题，别像博主一样踩坑就行。</p>
<p>现在就把这些代码搬去你的项目里试试吧，不管是做宠物社交、熟人社交还是其他场景，碰一碰加好友都能让你的App多一个“让人眼前一亮”的小功能。要是开发过程中踩了啥新坑，或者有更酷的玩法，评论区唠唠～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[横纵切换：UI动效的“罗生门”，你的布局该听谁的？]]></title>    <link>https://juejin.cn/post/7599474528239304744</link>    <guid>https://juejin.cn/post/7599474528239304744</guid>    <pubDate>2026-01-26T12:32:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599474528239304744" data-draft-id="7596170399881216052" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="横纵切换：UI动效的“罗生门”，你的布局该听谁的？"/> <meta itemprop="keywords" content="前端,HarmonyOS"/> <meta itemprop="datePublished" content="2026-01-26T12:32:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Archilect"/> <meta itemprop="url" content="https://juejin.cn/user/1505660538979515"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            横纵切换：UI动效的“罗生门”，你的布局该听谁的？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1505660538979515/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Archilect
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T12:32:55.000Z" title="Mon Jan 26 2026 12:32:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">横纵切换：UI动效的“罗生门”，你的布局该听谁的？</h2>
<blockquote>
<p>关键词：横纵切换 / 声明式 UI / ArkUI / re-layout / transform / 预计算几何</p>
<p><strong>说明</strong>：本文的"布局驱动 vs 几何驱动"思路是通用的，适用于任何声明式 UI 框架。但文中的代码示例和具体 API（如 <code>position</code>、<code>translate</code>、<code>scale</code>、<code>Row</code>、<code>Column</code> 等）均基于 <strong>ArkUI（ArkTS）</strong>。其他框架的开发者可以将思路迁移到对应框架的等价 API 上。</p>
<p>横纵布局切换动画方案选择：当把所有可行路线摆上桌面，会发现真正的分岔口只有一个——<strong>横纵布局变换到底交给谁来完成</strong>。</p>
</blockquote>
<p>如果只做过静态 UI，会觉得“横排 ↔ 竖排”只是切换一下容器方向。</p>
<p>但一旦需要实现“吸顶折叠过程中的连续动画”（icon/文字/背景一起动，轨迹还要可控），横纵切换就不再是一个局部实现点，而是一个会决定后面所有设计的<strong>架构根节点</strong>。</p>
<p>方案可以归为两条路线：</p>
<ul>
<li><strong>布局驱动</strong>：让布局系统在两种状态下自动重排（例如 listDirection/Flex 方向切换/双模板切换等）</li>
<li><strong>几何驱动</strong>：由开发者自己定义两态几何，动画期间主要用 transform 做插值（position + translate/scale）</li>
</ul>
<p>为了快速建立直觉，可以先看两条路线的<strong>最小结构骨架</strong>（省略所有业务分支，只看结构差异）：</p>
<h4 data-id="heading-1">路线 A：布局系统驱动（Layout-driven）的骨架</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title class_">Row</span>() {
  <span class="hljs-comment">// Tab 1</span>
  <span class="hljs-title class_">Stack</span>() {
    <span class="hljs-title class_">Image</span>(bgImage)  <span class="hljs-comment">// 标签背景图</span>
    <span class="hljs-title class_">List</span>() {
      <span class="hljs-title class_">ListItem</span>() {
        <span class="hljs-title class_">Image</span>(icon)
      }
      <span class="hljs-title class_">ListItem</span>() {
        <span class="hljs-title class_">Text</span>(text)
      }
    }
    .<span class="hljs-title function_">listDirection</span>(shouldStickTop ? <span class="hljs-title class_">Horizontal</span> : <span class="hljs-title class_">Vertical</span>)
  }
  <span class="hljs-comment">// Tab 2...</span>
}
</code></pre>
<h4 data-id="heading-2">路线 B：几何驱动（Geometry-driven）的骨架</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title class_">Row</span>() {
  <span class="hljs-title class_">Image</span>(bgImage)  <span class="hljs-comment">// 标签背景图（独立在外层）</span>

  <span class="hljs-comment">// Tab 1</span>
  <span class="hljs-title class_">Column</span>() {
    <span class="hljs-title class_">Image</span>(icon)
      .<span class="hljs-title function_">position</span>({ <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> })
      .<span class="hljs-title function_">translate</span>({ <span class="hljs-attr">x</span>: iconX, <span class="hljs-attr">y</span>: iconY })
      .<span class="hljs-title function_">scale</span>({ <span class="hljs-attr">x</span>: iconScale, <span class="hljs-attr">y</span>: iconScale })

    <span class="hljs-title class_">Text</span>(text)
      .<span class="hljs-title function_">position</span>({ <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> })
      .<span class="hljs-title function_">translate</span>({ <span class="hljs-attr">x</span>: textX, <span class="hljs-attr">y</span>: textY })
  }
  <span class="hljs-comment">// Tab 2...</span>
}
</code></pre>
<p>这两段骨架的差异，基本已经把后面所有“为什么要预计算、为什么轨迹可控、为什么背景能解耦、为什么能高刷稳定”的结论提前剧透了。</p>
<p>下面再按“需求→候选路线→为什么分岔口在这里→如何落地”把逻辑讲完整。</p>
<hr/>
<h3 data-id="heading-3">1）需求一旦复杂，横纵切换就会绑定一串“连带问题”</h3>
<p>一个典型的真实场景大概是这样：</p>
<ul>
<li>未吸顶（展开态）：icon 在上、文字在下</li>
<li>吸顶后（折叠态）：icon 在左、文字在右</li>
<li>切换过程中要连续动画（位移/缩放/变色）</li>
<li>同时还有：
<ul>
<li>背景形状跟随激活项移动（展开是大梯形，折叠变扁梯形/胶囊）</li>
<li>首项固定（可选）</li>
<li>横向滚动居中</li>
<li>亮暗色、左中右不同物料</li>
</ul>
</li>
</ul>
<p>你会发现：<strong>横纵切换一旦做不好，后面所有东西都跟着不稳</strong>。</p>
<hr/>
<h3 data-id="heading-4">2）一开始就把候选路线摆出来（但不按“容器名字”分类）</h3>
<p>很多文章喜欢按组件名对比：RelativeContainer、Flex、List、两套模板……</p>
<p>更有效的方式是按“控制权归属”分类，因为组件名字会随框架/版本变化，但控制权问题不会变。</p>
<h4 data-id="heading-5">路线 A：布局驱动（Layout-driven）</h4>
<p>核心做法：</p>
<ul>
<li>让系统通过“切换布局规则”来完成横纵切换</li>
</ul>
<p>常见落地形态：</p>
<ul>
<li>RelativeContainer：在处理动态内容或复杂对齐时，其约束规则可能导致意外行为，排查成本较高。</li>
<li>Flex direction 切换：存在内容超出容器被裁剪的风险，且官方文档提示频繁切换该属性可能带来的性能影响。</li>
<li>List + listDirection：功能可行，但会引入额外层级（ListItem），且动效轨迹更依赖系统布局，难以精确控制。</li>
<li>Row/Column 两套模板切换（显示/隐藏或销毁/重建）：这种切换更像重建/显隐，难以实现平滑的连续位移和变形动画。</li>
</ul>
<p>一句话概括：</p>
<blockquote>
<p>开发者提供约束/方向，位置由布局算法决定。</p>
</blockquote>
<h4 data-id="heading-6">路线 B：几何驱动（Geometry-driven）</h4>
<p>核心做法：</p>
<ul>
<li>不让布局系统决定“最终位置”</li>
<li>由开发者自己计算展开态/折叠态的目标坐标</li>
<li>动画期间主要用渲染变换插值（translate/scale）</li>
</ul>
<p>一句话概括：</p>
<blockquote>
<p>开发者直接提供位置结果，布局系统只提供坐标原点。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">3）真正的分岔口：动画期间允许“布局系统”参与多少？</h3>
<p>可以把判断标准收敛成一个非常实用的问题：</p>
<blockquote>
<p><strong>动画期间，是否允许 re-layout 频繁发生？</strong></p>
</blockquote>
<h4 data-id="heading-8">3.1 为什么布局驱动容易把动画写“飘”？</h4>
<p>不是因为某个容器不好，而是因为布局驱动天然会带来三类不确定性：</p>
<ol>
<li>
<p><strong>端点不确定</strong></p>
<ul>
<li>横纵切换后元素到底落在哪，往往要等布局算完才知道</li>
<li>想“提前算好端点 + 插值”会很难，因为端点本身是布局输出</li>
</ul>
</li>
<li>
<p><strong>轨迹不可控</strong></p>
<ul>
<li>系统可能会给出一个“看起来合理”的补间，但很难精确控制：
<ul>
<li>谁先动、谁后动</li>
<li>是否分段</li>
<li>是否 overshoot</li>
<li>icon 与文字是否严格走同一时间轴</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>re-layout 干扰补间</strong></p>
<ul>
<li>动画中途若在改 width/margin/direction 等，会触发布局重排</li>
<li>轨迹会被布局结果离散修正，表现为偶发跳动/抖动（高刷更明显）</li>
</ul>
</li>
</ol>
<p>这些问题在需求简单时不显眼，但在“吸顶折叠 + 多元素联动”场景下会被放大。</p>
<h4 data-id="heading-9">3.2 为什么几何驱动能把复杂度“集中化”？</h4>
<p>几何驱动的优点不是“更强”，而是“更明确”：</p>
<ul>
<li>端点是算出来的，动画开始前就确定</li>
<li>轨迹是插值出来的，想怎么分段/延迟都可控</li>
<li>动画期间主要改 transform，尽量不触发布局重排</li>
<li>UI 结构节点更少、职责更清晰</li>
</ul>
<p>当然它也有代价：</p>
<ul>
<li>需要 measureTextSize（文本宽高必须可预测）</li>
<li>需要建立预计算与缓存（否则运行时算会很重）</li>
</ul>
<p>但这套代价一旦付了，后面背景、滚动居中、首项遮挡，都会顺着同一条路径解决。</p>
<hr/>
<h3 data-id="heading-10">4）如何落地“几何驱动”的横纵切换？</h3>
<p>落地时可以抓住一个关键技巧：</p>
<h4 data-id="heading-11">4.1 让子元素脱离布局流：position({0,0})</h4>
<p>在 tab 的容器里（例如 Column），icon 和 text 都设置：</p>
<ul>
<li><code>position({ x: 0, y: 0 })</code></li>
</ul>
<p>这一步的意义是：</p>
<ul>
<li>不再依赖 Column/Row 的自动排布</li>
<li>容器只提供一个“共同坐标原点”</li>
</ul>
<h4 data-id="heading-12">4.2 用 translate/scale 贴上两态几何</h4>
<p>在计算层提前算出：</p>
<ul>
<li>展开态：iconX/iconY、textX/textY、iconScale=1</li>
<li>折叠态：iconX/iconY、textX/textY、iconScale&lt;1（或不同大小）</li>
</ul>
<p>渲染层只控制两个绘制属性：</p>
<ul>
<li><code>translate({ x, y })</code></li>
<li><code>scale({ x, y })</code></li>
</ul>
<p>动画期间，尽量不通过“切换容器/改布局属性”完成效果，而是让坐标插值带着元素走。</p>
<hr/>
<h3 data-id="heading-13">5）为什么这个根节点一旦选定，后面所有设计都变成“必然结果”？</h3>
<p>这也是最值得强调的一点：</p>
<ul>
<li>一旦选了几何驱动，<strong>UI 结构会自然变薄</strong>（少嵌套、少中间层）</li>
<li>自然会需要：
<ul>
<li>物料查表缓存（解决状态组合爆炸）</li>
<li>几何预计算缓存（两态端点提前确定）</li>
<li>render 层只消费几何（modifier 只贴 transform）</li>
</ul>
</li>
<li>自然会把：
<ul>
<li>背景当图层（独立于 tab 布局）</li>
<li>targetScrollOffset 当布局输出（而不是运行时测量）</li>
<li>首项遮挡当交互状态机（而不是 zIndex/clip 补丁）</li>
</ul>
</li>
</ul>
<p>所以这篇并不是在推荐“某个 API”，而是在强调：</p>
<blockquote>
<p>横纵切换的实现方式，会决定你到底是在“和布局系统博弈”，还是在“定义一套可控几何”。</p>
</blockquote>
<hr/>
<h3 data-id="heading-14">6）小结</h3>
<blockquote>
<p><strong>笛卡尔的含金量</strong>：
从用 <code>margin/padding/spaceBetween</code> 这类“几何关系”去驱动布局
改为把几何关系“编译”成坐标数据，让 <code>translate</code> 成为唯一的几何接口。</p>
<p>当“位置变化”只从一个统一接口（<code>translate</code>）流出，会直接带来：</p>
<ul>
<li><strong>可推导/可回归</strong>：位置 bug 更像“x/y 算错了”，而不是一堆 margin/padding/align 的组合问题；</li>
<li><strong>可组合</strong>：【吸顶、激活态增宽、首项固定让位】等效果可以在同一坐标值里做合成；</li>
<li><strong>更符合 OCP</strong>：新增“位移需求”时，尽量不改渲染层结构，只扩展计算层输出（例如改 <code>iconX</code> 的公式/插值），Render 层仍然只消费 <code>.translate({ x, y })</code>。</li>
</ul>
<p>这种将“如何布局”(how)与“布局结果”(what)分离的做法，也侧面说明：很多设计原则首先是“对变化的管理方式”，并不依赖 OOP 语法本身。</p>
</blockquote>
<p>现在的判断很简单：</p>
<ul>
<li>需求简单、只要能切横纵、不追求轨迹：布局驱动足够</li>
<li>一旦需求出现“吸顶折叠 + 多元素联动 + 高刷稳定 + 轨迹可控”，横纵切换就应该走几何驱动</li>
</ul>
<p>下一篇会继续把“几何驱动”讲透：</p>
<ul>
<li>为什么预计算不是优化，而是必需品（measureTextSize、两态几何、确定性、缓存）</li>
</ul>
<hr/>
<h3 data-id="heading-15">附录：可独立运行的“几何驱动”示例</h3>
<p>为了更直观地展示“几何驱动”如何通过直接控制坐标来实现布局动画，下面提供一个完整的、可独立运行的 ArkUI 示例代码。你可以将代码复制到项目中，直接预览横纵切换效果。</p>
<blockquote>
<p><strong>说明</strong>：以下代码提供了两个组件（A 和 B），它们实现了相同的视觉效果，但方式不同：</p>
<ul>
<li><strong>Component A</strong>：使用 <code>transform(matrix4)</code>，这是一种更底层、更强大的矩阵变换方式</li>
<li><strong>Component B</strong>：使用 <code>translate</code> 和 <code>scale</code>，这种方式更直观，也是本系列文章中推荐优先使用的方式</li>
</ul>
<p>建议先看 <strong>Component B</strong>，理解几何驱动的基本思路；如果对矩阵变换感兴趣，再看 Component A。</p>
</blockquote>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { matrix4 } <span class="hljs-keyword">from</span> <span class="hljs-string">'@kit.ArkUI'</span>

<span class="hljs-meta">@Entry</span>
<span class="hljs-meta">@Component</span>
struct <span class="hljs-title class_">Transform02</span> {
  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title function_">A</span>()
      <span class="hljs-title function_">B</span>()
    }
  }
}

<span class="hljs-comment">//计算基准值：</span>
<span class="hljs-comment">//容器宽高：containerWidth=100</span>
<span class="hljs-comment">// 纵向宽高：文字：70*20，图片：50*50，图下间距：5，字下间距：6</span>
<span class="hljs-comment">// 横向宽高：文字：70*25，图片：30*30，图左间距：3，字左间距：4</span>

<span class="hljs-meta">@Component</span>
struct A {
  <span class="hljs-meta">@State</span> <span class="hljs-attr">trans</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">iconWidth</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">50</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">containerWidth</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">100</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">translateX</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>
  <span class="hljs-meta">@State</span> <span class="hljs-attr">translateY</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">0</span>
  change = <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">trans</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">trans</span>

  <span class="hljs-title function_">vp</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">vp2px</span>(a)
  }

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">buildImageTransform</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> matrix1 = matrix4.<span class="hljs-title function_">identity</span>()
      .<span class="hljs-title function_">translate</span>({
        <span class="hljs-attr">x</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">vp</span>((<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getContainerWidth</span>() - <span class="hljs-number">50</span>) / <span class="hljs-number">2</span>), 
        <span class="hljs-attr">y</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">vp</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getContainerHeight</span>() - <span class="hljs-number">50</span> - <span class="hljs-number">20</span> - <span class="hljs-number">5</span> - <span class="hljs-number">6</span>)
      })
    <span class="hljs-keyword">const</span> matrix2 = matrix4.<span class="hljs-title function_">identity</span>()
      .<span class="hljs-title function_">scale</span>({
        <span class="hljs-attr">x</span>: <span class="hljs-number">30</span> / <span class="hljs-number">50</span>,
        <span class="hljs-attr">y</span>: <span class="hljs-number">30</span> / <span class="hljs-number">50</span>,
        <span class="hljs-attr">centerX</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">vp</span>(-<span class="hljs-number">50</span> / <span class="hljs-number">2</span>), <span class="hljs-comment">//缩放中心为左上角</span>
        <span class="hljs-attr">centerY</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">vp</span>(-<span class="hljs-number">50</span> / <span class="hljs-number">2</span>),
      })
      .<span class="hljs-title function_">translate</span>({ <span class="hljs-attr">x</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">vp</span>(<span class="hljs-number">0</span> + <span class="hljs-number">3</span>), <span class="hljs-attr">y</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">vp</span>((<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getContainerHeight</span>() - <span class="hljs-number">30</span>) / <span class="hljs-number">2</span>) }) <span class="hljs-comment">//如果在scale之前，还要消除缩放系数</span>
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">trans</span> ? matrix2 : matrix1
  }

  <span class="hljs-keyword">private</span> <span class="hljs-title function_">buildTextTransform</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> matrix1 = matrix4.<span class="hljs-title function_">identity</span>()
      .<span class="hljs-title function_">translate</span>({
        <span class="hljs-attr">x</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">vp</span>((<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getContainerWidth</span>() - <span class="hljs-number">70</span>) / <span class="hljs-number">2</span>),
        <span class="hljs-attr">y</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">vp</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getContainerHeight</span>() - (<span class="hljs-number">20</span> + <span class="hljs-number">6</span>))
      })
    <span class="hljs-keyword">const</span> matrix2 = matrix4.<span class="hljs-title function_">identity</span>()
      .<span class="hljs-title function_">translate</span>({ <span class="hljs-attr">x</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">vp</span>(<span class="hljs-number">30</span> + <span class="hljs-number">3</span> + <span class="hljs-number">4</span>), <span class="hljs-attr">y</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">vp</span>((<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getContainerHeight</span>() - <span class="hljs-number">20</span>) / <span class="hljs-number">2</span>) }) <span class="hljs-comment">//如果在scale之前，还要消除缩放系数</span>
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">trans</span> ? matrix2 : matrix1
  }

  <span class="hljs-title function_">getContainerWidth</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">trans</span> ? (<span class="hljs-number">30</span> + <span class="hljs-number">70</span> + <span class="hljs-number">3</span> + <span class="hljs-number">4</span>) : <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">50</span>, <span class="hljs-number">70</span>)
  }

  <span class="hljs-title function_">getContainerHeight</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">trans</span> ? <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">30</span>, <span class="hljs-number">25</span>) : (<span class="hljs-number">20</span> + <span class="hljs-number">50</span> + <span class="hljs-number">5</span> + <span class="hljs-number">6</span>)
  }

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'变形'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">animateTo</span>({ <span class="hljs-attr">duration</span>: <span class="hljs-number">300</span> }, <span class="hljs-variable language_">this</span>.<span class="hljs-property">change</span>))
      <span class="hljs-title class_">Column</span>() {
        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'文字'</span>)
          .<span class="hljs-title function_">borderWidth</span>(<span class="hljs-number">1</span>)
          .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">70</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">20</span> })
          .<span class="hljs-title function_">position</span>({ <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> })
          .<span class="hljs-title function_">transform</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildTextTransform</span>())
          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'文字'</span>))

        <span class="hljs-title class_">Image</span>($r(<span class="hljs-string">'sys.media.AI_form'</span>))
          .<span class="hljs-title function_">position</span>({ <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> })
          .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">50</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">50</span> })
          .<span class="hljs-title function_">borderWidth</span>(<span class="hljs-number">1</span>)
          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#ffd3a06e'</span>)
          .<span class="hljs-title function_">transform</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">buildImageTransform</span>())
          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'图片'</span>))
      }
      .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getContainerWidth</span>(), <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getContainerHeight</span>() })
      .<span class="hljs-title function_">borderWidth</span>(<span class="hljs-number">1</span>)
      .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'容器'</span>))

      <span class="hljs-title class_">Blank</span>().<span class="hljs-title function_">height</span>(<span class="hljs-number">300</span>).<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#ffc0f3dd'</span>)

    }.<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>).<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#fffff8d6'</span>)
  }
}

<span class="hljs-meta">@Component</span>
struct B {
  <span class="hljs-meta">@State</span> <span class="hljs-attr">trans</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">false</span>
  change = <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">trans</span> = !<span class="hljs-variable language_">this</span>.<span class="hljs-property">trans</span>

  <span class="hljs-title function_">build</span>(<span class="hljs-params"/>) {
    <span class="hljs-title class_">Column</span>() {
      <span class="hljs-title class_">Text</span>(<span class="hljs-string">'变形'</span>).<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">getUIContext</span>().<span class="hljs-title function_">animateTo</span>({ <span class="hljs-attr">duration</span>: <span class="hljs-number">300</span> }, <span class="hljs-variable language_">this</span>.<span class="hljs-property">change</span>))

      <span class="hljs-comment">// 容器</span>
      <span class="hljs-title class_">Column</span>() {
        <span class="hljs-comment">// 文字</span>
        <span class="hljs-title class_">Text</span>(<span class="hljs-string">'文字'</span>)
          .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">70</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">20</span> })
          .<span class="hljs-title function_">position</span>({ <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> })
          .<span class="hljs-title function_">translate</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">trans</span> ?
            { <span class="hljs-attr">x</span>: <span class="hljs-number">30</span> + <span class="hljs-number">3</span> + <span class="hljs-number">4</span>, <span class="hljs-attr">y</span>: (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">30</span>, <span class="hljs-number">25</span>) - <span class="hljs-number">20</span>) / <span class="hljs-number">2</span> } :
            { <span class="hljs-attr">x</span>: (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">50</span>, <span class="hljs-number">70</span>) - <span class="hljs-number">70</span>) / <span class="hljs-number">2</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">50</span> + <span class="hljs-number">5</span> })
          .<span class="hljs-title function_">borderWidth</span>(<span class="hljs-number">1</span>)
          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'文字'</span>))

        <span class="hljs-comment">// 图片</span>
        <span class="hljs-title class_">Image</span>($r(<span class="hljs-string">'sys.media.AI_form'</span>))
          .<span class="hljs-title function_">size</span>({ <span class="hljs-attr">width</span>: <span class="hljs-number">50</span>, <span class="hljs-attr">height</span>: <span class="hljs-number">50</span> })
          .<span class="hljs-title function_">position</span>({ <span class="hljs-attr">x</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> })
          .<span class="hljs-title function_">scale</span>({
            <span class="hljs-attr">x</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">trans</span> ? <span class="hljs-number">30</span> / <span class="hljs-number">50</span> : <span class="hljs-number">1</span>,
            <span class="hljs-attr">y</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">trans</span> ? <span class="hljs-number">30</span> / <span class="hljs-number">50</span> : <span class="hljs-number">1</span>,
            <span class="hljs-attr">centerX</span>: <span class="hljs-number">0</span>,
            <span class="hljs-attr">centerY</span>: <span class="hljs-number">0</span>
          })
          .<span class="hljs-title function_">translate</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">trans</span> ?
            { <span class="hljs-attr">x</span>: <span class="hljs-number">3</span>, <span class="hljs-attr">y</span>: (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">30</span>, <span class="hljs-number">25</span>) - <span class="hljs-number">30</span>) / <span class="hljs-number">2</span> } :
            { <span class="hljs-attr">x</span>: (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">50</span>, <span class="hljs-number">70</span>) - <span class="hljs-number">50</span>) / <span class="hljs-number">2</span>, <span class="hljs-attr">y</span>: <span class="hljs-number">0</span> })
          .<span class="hljs-title function_">borderWidth</span>(<span class="hljs-number">1</span>)
          .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#ffd7b6e9'</span>)
          .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'图片'</span>))
      }
      .<span class="hljs-title function_">size</span>({
        <span class="hljs-attr">width</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">trans</span> ? (<span class="hljs-number">30</span> + <span class="hljs-number">3</span> + <span class="hljs-number">70</span> + <span class="hljs-number">4</span>) : <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">50</span>, <span class="hljs-number">70</span>),
        <span class="hljs-attr">height</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">trans</span> ? <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">30</span>, <span class="hljs-number">25</span>) : (<span class="hljs-number">50</span> + <span class="hljs-number">5</span> + <span class="hljs-number">20</span> + <span class="hljs-number">6</span>)
      })
      .<span class="hljs-title function_">borderWidth</span>(<span class="hljs-number">1</span>)
      .<span class="hljs-title function_">onClick</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'容器'</span>))

      <span class="hljs-title class_">Blank</span>().<span class="hljs-title function_">height</span>(<span class="hljs-number">300</span>).<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#ffc0f3dd'</span>)
    }
    .<span class="hljs-title function_">width</span>(<span class="hljs-string">'100%'</span>)
    .<span class="hljs-title function_">backgroundColor</span>(<span class="hljs-string">'#fffff8d6'</span>)
  }
}
</code></pre>
<h4 data-id="heading-16">注意事项</h4>
<ol>
<li><strong>独立运行</strong>：这是一个独立的 Demo，不依赖本系列文章中的其他复杂组件。</li>
<li><strong>两种实现对比</strong>：代码中包含了 <code>Component A</code> 和 <code>Component B</code> 两个组件，它们都实现了相同的视觉效果，但方式不同：
<ul>
<li><code>Component A</code> 使用 <code>transform(matrix4)</code>，这是一种更底层、更强大的矩阵变换方式。</li>
<li><code>Component B</code> 使用 <code>translate</code> 和 <code>scale</code>，这种方式更直观，也是本系列文章中推荐优先使用的方式。</li>
</ul>
</li>
<li><strong>与文章思想的关联</strong>：示例为了简化，将两态的坐标（横向/纵向）直接硬编码在了组件内部。在真实的大型项目中，这些坐标值应该由独立的"几何计算层"（即后续文章中提到的 <code>GeometryCalculator</code>）来提供，UI 层只负责消费这些计算结果。这正是"几何驱动"架构的核心思想。</li>
</ol>
<hr/>
<p><strong>写在最后</strong>：这是《复杂tab动效组件架构设计》系列专栏的第1篇（前面有一篇序章），后续会继续展开每个技术点的实现细节。感兴趣的话可以关注专栏。欢迎在评论区分享你的经验和踩过的坑。如果这篇文章对你有启发，也欢迎点赞支持，这会是我继续分享的动力。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue3日期计算器实现方案]]></title>    <link>https://juejin.cn/post/7599526246503350306</link>    <guid>https://juejin.cn/post/7599526246503350306</guid>    <pubDate>2026-01-26T12:57:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599526246503350306" data-draft-id="7599526246503333922" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue3日期计算器实现方案"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-01-26T12:57:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="滕青山"/> <meta itemprop="url" content="https://juejin.cn/user/3206601805674094"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue3日期计算器实现方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3206601805674094/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    滕青山
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T12:57:21.000Z" title="Mon Jan 26 2026 12:57:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在线工具网址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fsee-tool.com%2Fdate-calculator" target="_blank" title="https://see-tool.com/date-calculator" ref="nofollow noopener noreferrer">see-tool.com/date-calcul…</a></p>
</blockquote>
<blockquote>
<p>工具截图：
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73218a9cadbe4d43abc356809916483e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ruV6Z2S5bGx:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770037041&amp;x-signature=%2BsdYJ8Iisb5mhZ2OsbueuG7tjzw%3D" alt="工具截图.png" loading="lazy"/></p>
</blockquote>
<h2 data-id="heading-0">一、核心功能设计</h2>
<p>日期计算器包含四个独立模块:</p>
<ol>
<li><strong>日期间隔计算</strong>: 计算两个日期之间的天数、周数、月数、年数</li>
<li><strong>日期加减计算</strong>: 在基准日期上加减指定时间单位</li>
<li><strong>年龄计算</strong>: 精确计算年龄(年/月/日)</li>
<li><strong>工作日计算</strong>: 统计工作日、周末天数</li>
</ol>
<h2 data-id="heading-1">二、日期间隔计算实现</h2>
<h3 data-id="heading-2">2.1 核心计算逻辑</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> dateDiff = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (!startDate.<span class="hljs-property">value</span> || !endDate.<span class="hljs-property">value</span>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">days</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">weeks</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">months</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">years</span>: <span class="hljs-number">0</span> }
  }

  <span class="hljs-keyword">const</span> start = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(startDate.<span class="hljs-property">value</span>)
  <span class="hljs-keyword">const</span> end = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(endDate.<span class="hljs-property">value</span>)

  <span class="hljs-comment">// 确保开始日期小于结束日期(自动排序)</span>
  <span class="hljs-keyword">const</span> [earlierDate, laterDate] = start &lt;= end ? [start, end] : [end, start]

  <span class="hljs-keyword">let</span> diffTime = laterDate.<span class="hljs-title function_">getTime</span>() - earlierDate.<span class="hljs-title function_">getTime</span>()

  <span class="hljs-comment">// 如果包含结束日期,增加一天</span>
  <span class="hljs-keyword">if</span> (includeEndDate.<span class="hljs-property">value</span>) {
    diffTime += <span class="hljs-number">24</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">1000</span>
  }

  <span class="hljs-keyword">const</span> diffDays = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(diffTime / (<span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">24</span>))

  <span class="hljs-comment">// 计算精确的月数差异</span>
  <span class="hljs-keyword">let</span> months = (laterDate.<span class="hljs-title function_">getFullYear</span>() - earlierDate.<span class="hljs-title function_">getFullYear</span>()) * <span class="hljs-number">12</span>
  months += laterDate.<span class="hljs-title function_">getMonth</span>() - earlierDate.<span class="hljs-title function_">getMonth</span>()

  <span class="hljs-comment">// 如果日期不足一个月,减去一个月</span>
  <span class="hljs-keyword">if</span> (laterDate.<span class="hljs-title function_">getDate</span>() &lt; earlierDate.<span class="hljs-title function_">getDate</span>()) {
    months--
  }

  <span class="hljs-comment">// 计算年数</span>
  <span class="hljs-keyword">const</span> years = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(months / <span class="hljs-number">12</span>)

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">days</span>: diffDays,
    <span class="hljs-attr">weeks</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(diffDays / <span class="hljs-number">7</span>),
    <span class="hljs-attr">months</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, months),
    <span class="hljs-attr">years</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, years)
  }
})
</code></pre>
<p><strong>关键点</strong>:</p>
<ol>
<li><strong>自动排序</strong>: 无论用户输入顺序,自动识别较早和较晚的日期</li>
<li><strong>包含结束日期</strong>: 可选项,影响天数计算(+1天)</li>
<li><strong>精确月数</strong>: 考虑日期不足一个月的情况</li>
<li><strong>负数保护</strong>: 使用 <code>Math.max(0, value)</code> 防止负数</li>
</ol>
<h3 data-id="heading-3">2.2 辅助工具函数</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 交换开始和结束日期</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">swapDates</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> temp = startDate.<span class="hljs-property">value</span>
  startDate.<span class="hljs-property">value</span> = endDate.<span class="hljs-property">value</span>
  endDate.<span class="hljs-property">value</span> = temp
}

<span class="hljs-comment">// 设置结束日期为今天</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">setToday</span> = (<span class="hljs-params">type</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!process.<span class="hljs-property">client</span>) <span class="hljs-keyword">return</span>
  <span class="hljs-keyword">const</span> today = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>().<span class="hljs-title function_">split</span>(<span class="hljs-string">'T'</span>)[<span class="hljs-number">0</span>]
  <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'diff'</span>) {
    endDate.<span class="hljs-property">value</span> = today
  }
}
</code></pre>
<h2 data-id="heading-4">三、日期加减计算实现</h2>
<h3 data-id="heading-5">3.1 核心计算逻辑</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> calculatedDate = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (!baseDate.<span class="hljs-property">value</span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>
  }

  <span class="hljs-keyword">if</span> (!amount.<span class="hljs-property">value</span> || amount.<span class="hljs-property">value</span> === <span class="hljs-number">0</span>) {
    <span class="hljs-keyword">return</span> baseDate.<span class="hljs-property">value</span>
  }

  <span class="hljs-keyword">const</span> base = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(baseDate.<span class="hljs-property">value</span>)
  <span class="hljs-comment">// 根据操作类型确定正负</span>
  <span class="hljs-keyword">const</span> value = operation.<span class="hljs-property">value</span> === <span class="hljs-string">'add'</span> ? <span class="hljs-built_in">parseInt</span>(amount.<span class="hljs-property">value</span>) : -<span class="hljs-built_in">parseInt</span>(amount.<span class="hljs-property">value</span>)

  <span class="hljs-keyword">switch</span> (unit.<span class="hljs-property">value</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'days'</span>:
      base.<span class="hljs-title function_">setDate</span>(base.<span class="hljs-title function_">getDate</span>() + value)
      <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">'weeks'</span>:
      base.<span class="hljs-title function_">setDate</span>(base.<span class="hljs-title function_">getDate</span>() + (value * <span class="hljs-number">7</span>))
      <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">'months'</span>:
      base.<span class="hljs-title function_">setMonth</span>(base.<span class="hljs-title function_">getMonth</span>() + value)
      <span class="hljs-keyword">break</span>
    <span class="hljs-keyword">case</span> <span class="hljs-string">'years'</span>:
      base.<span class="hljs-title function_">setFullYear</span>(base.<span class="hljs-title function_">getFullYear</span>() + value)
      <span class="hljs-keyword">break</span>
  }

  <span class="hljs-keyword">return</span> base.<span class="hljs-title function_">toISOString</span>().<span class="hljs-title function_">split</span>(<span class="hljs-string">'T'</span>)[<span class="hljs-number">0</span>]
})
</code></pre>
<p><strong>关键点</strong>:</p>
<ol>
<li><strong>操作符处理</strong>: 减法通过负数实现,统一使用加法逻辑</li>
<li><strong>原生 Date API</strong>: 利用 <code>setDate</code>/<code>setMonth</code>/<code>setFullYear</code> 自动处理溢出</li>
<li><strong>格式化输出</strong>: <code>toISOString().split('T')[0]</code> 获取 YYYY-MM-DD 格式</li>
</ol>
<h3 data-id="heading-6">3.2 获取星期几</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">getWeekday</span> = (<span class="hljs-params">dateStr</span>) =&gt; {
  <span class="hljs-keyword">if</span> (!dateStr) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>
  <span class="hljs-keyword">const</span> weekdays = <span class="hljs-title function_">tm</span>(<span class="hljs-string">'dateCalculator.weekdays'</span>)
  <span class="hljs-keyword">if</span> (!weekdays || !<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(weekdays)) <span class="hljs-keyword">return</span> <span class="hljs-string">''</span>
  <span class="hljs-keyword">const</span> date = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(dateStr)
  <span class="hljs-keyword">return</span> weekdays[date.<span class="hljs-title function_">getDay</span>()] || <span class="hljs-string">''</span>
}
</code></pre>
<p><strong>说明</strong>:</p>
<ul>
<li><code>getDay()</code> 返回 0-6,其中 0 代表周日</li>
<li>从国际化配置中读取星期名称数组</li>
</ul>
<h2 data-id="heading-7">四、年龄计算实现</h2>
<h3 data-id="heading-8">4.1 精确年龄计算</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> age = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (!birthDate.<span class="hljs-property">value</span> || !ageCalculateDate.<span class="hljs-property">value</span>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">years</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">months</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">days</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">totalDays</span>: <span class="hljs-number">0</span> }
  }

  <span class="hljs-keyword">const</span> birth = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(birthDate.<span class="hljs-property">value</span>)
  <span class="hljs-keyword">const</span> calculate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(ageCalculateDate.<span class="hljs-property">value</span>)

  <span class="hljs-comment">// 如果出生日期晚于计算日期,返回0</span>
  <span class="hljs-keyword">if</span> (birth &gt; calculate) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">years</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">months</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">days</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">totalDays</span>: <span class="hljs-number">0</span> }
  }

  <span class="hljs-comment">// 计算精确年龄</span>
  <span class="hljs-keyword">let</span> years = calculate.<span class="hljs-title function_">getFullYear</span>() - birth.<span class="hljs-title function_">getFullYear</span>()
  <span class="hljs-keyword">let</span> months = calculate.<span class="hljs-title function_">getMonth</span>() - birth.<span class="hljs-title function_">getMonth</span>()
  <span class="hljs-keyword">let</span> days = calculate.<span class="hljs-title function_">getDate</span>() - birth.<span class="hljs-title function_">getDate</span>()

  <span class="hljs-comment">// 调整天数</span>
  <span class="hljs-keyword">if</span> (days &lt; <span class="hljs-number">0</span>) {
    months--
    <span class="hljs-comment">// 获取上个月的天数</span>
    <span class="hljs-keyword">const</span> lastMonth = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(calculate.<span class="hljs-title function_">getFullYear</span>(), calculate.<span class="hljs-title function_">getMonth</span>(), <span class="hljs-number">0</span>)
    days += lastMonth.<span class="hljs-title function_">getDate</span>()
  }

  <span class="hljs-comment">// 调整月数</span>
  <span class="hljs-keyword">if</span> (months &lt; <span class="hljs-number">0</span>) {
    years--
    months += <span class="hljs-number">12</span>
  }

  <span class="hljs-comment">// 计算总天数</span>
  <span class="hljs-keyword">const</span> totalDays = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>((calculate.<span class="hljs-title function_">getTime</span>() - birth.<span class="hljs-title function_">getTime</span>()) / (<span class="hljs-number">1000</span> * <span class="hljs-number">60</span> * <span class="hljs-number">60</span> * <span class="hljs-number">24</span>))

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">years</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, years),
    <span class="hljs-attr">months</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, months),
    <span class="hljs-attr">days</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, days),
    <span class="hljs-attr">totalDays</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, totalDays)
  }
})
</code></pre>
<p><strong>关键点</strong>:</p>
<ol>
<li><strong>逐级调整</strong>: 先调整天数,再调整月数,最后得到年数</li>
<li><strong>借位逻辑</strong>: 天数不足时从月份借位,月份不足时从年份借位</li>
<li><strong>上月天数</strong>: 使用 <code>new Date(year, month, 0)</code> 获取上月最后一天</li>
<li><strong>总天数</strong>: 单独计算,用于显示"已活xx天"</li>
</ol>
<h3 data-id="heading-9">4.2 派生数据计算</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 模板中使用</span>
<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(age.<span class="hljs-property">totalDays</span> / <span class="hljs-number">30.44</span>)  <span class="hljs-comment">// 总月数(平均每月30.44天)</span>
<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">floor</span>(age.<span class="hljs-property">totalDays</span> / <span class="hljs-number">7</span>)      <span class="hljs-comment">// 总周数</span>
age.<span class="hljs-property">totalDays</span>                      <span class="hljs-comment">// 总天数</span>
</code></pre>
<h2 data-id="heading-10">五、工作日计算实现</h2>
<h3 data-id="heading-11">5.1 核心计算逻辑</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> workDays = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (!workStartDate.<span class="hljs-property">value</span> || !workEndDate.<span class="hljs-property">value</span>) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">total</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">weekdays</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">weekends</span>: <span class="hljs-number">0</span> }
  }

  <span class="hljs-keyword">const</span> start = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(workStartDate.<span class="hljs-property">value</span>)
  <span class="hljs-keyword">const</span> end = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(workEndDate.<span class="hljs-property">value</span>)

  <span class="hljs-comment">// 确保开始日期不大于结束日期</span>
  <span class="hljs-keyword">if</span> (start &gt; end) {
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">total</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">weekdays</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">weekends</span>: <span class="hljs-number">0</span> }
  }

  <span class="hljs-keyword">let</span> weekdays = <span class="hljs-number">0</span>
  <span class="hljs-keyword">let</span> weekends = <span class="hljs-number">0</span>
  <span class="hljs-keyword">const</span> current = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(start)

  <span class="hljs-comment">// 包含开始和结束日期</span>
  <span class="hljs-keyword">while</span> (current &lt;= end) {
    <span class="hljs-keyword">const</span> dayOfWeek = current.<span class="hljs-title function_">getDay</span>()
    <span class="hljs-keyword">if</span> (dayOfWeek === <span class="hljs-number">0</span> || dayOfWeek === <span class="hljs-number">6</span>) { <span class="hljs-comment">// 周日=0, 周六=6</span>
      weekends++
    } <span class="hljs-keyword">else</span> {
      weekdays++
    }
    current.<span class="hljs-title function_">setDate</span>(current.<span class="hljs-title function_">getDate</span>() + <span class="hljs-number">1</span>)
  }

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">total</span>: weekdays + weekends,
    <span class="hljs-attr">weekdays</span>: excludeWeekends.<span class="hljs-property">value</span> ? weekdays : weekdays + weekends,
    weekends
  }
})
</code></pre>
<p><strong>关键点</strong>:</p>
<ol>
<li><strong>逐日遍历</strong>: 从开始日期循环到结束日期,逐日判断</li>
<li><strong>星期判断</strong>: <code>getDay()</code> 返回 0(周日) 或 6(周六) 为周末</li>
<li><strong>可选排除</strong>: 根据 <code>excludeWeekends</code> 决定是否排除周末</li>
<li><strong>包含边界</strong>: 包含开始和结束日期</li>
</ol>
<h2 data-id="heading-12">六、状态管理</h2>
<h3 data-id="heading-13">6.1 响应式状态定义</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Tab 切换</span>
<span class="hljs-keyword">const</span> activeTab = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'difference'</span>)

<span class="hljs-comment">// 日期间隔计算</span>
<span class="hljs-keyword">const</span> startDate = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
<span class="hljs-keyword">const</span> endDate = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
<span class="hljs-keyword">const</span> includeEndDate = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">false</span>)

<span class="hljs-comment">// 日期加减计算</span>
<span class="hljs-keyword">const</span> baseDate = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
<span class="hljs-keyword">const</span> operation = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'add'</span>)      <span class="hljs-comment">// 'add' | 'subtract'</span>
<span class="hljs-keyword">const</span> amount = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
<span class="hljs-keyword">const</span> unit = <span class="hljs-title function_">ref</span>(<span class="hljs-string">'days'</span>)          <span class="hljs-comment">// 'days' | 'weeks' | 'months' | 'years'</span>

<span class="hljs-comment">// 工作日计算</span>
<span class="hljs-keyword">const</span> workStartDate = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
<span class="hljs-keyword">const</span> workEndDate = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
<span class="hljs-keyword">const</span> excludeWeekends = <span class="hljs-title function_">ref</span>(<span class="hljs-literal">true</span>)

<span class="hljs-comment">// 年龄计算</span>
<span class="hljs-keyword">const</span> birthDate = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
<span class="hljs-keyword">const</span> ageCalculateDate = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
</code></pre>
<h3 data-id="heading-14">6.2 初始化默认值</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (!process.<span class="hljs-property">client</span>) <span class="hljs-keyword">return</span>
  <span class="hljs-keyword">const</span> today = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>().<span class="hljs-title function_">split</span>(<span class="hljs-string">'T'</span>)[<span class="hljs-number">0</span>]
  startDate.<span class="hljs-property">value</span> = today
  endDate.<span class="hljs-property">value</span> = today
  baseDate.<span class="hljs-property">value</span> = today
  workStartDate.<span class="hljs-property">value</span> = today
  workEndDate.<span class="hljs-property">value</span> = today
  birthDate.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>  <span class="hljs-comment">// 不设置默认出生日期</span>
  ageCalculateDate.<span class="hljs-property">value</span> = today
})
</code></pre>
<p><strong>说明</strong>:</p>
<ul>
<li>使用 <code>process.client</code> 判断避免 SSR 问题</li>
<li>出生日期不设默认值,避免误导用户</li>
</ul>
<h2 data-id="heading-15">七、日期处理技巧</h2>
<h3 data-id="heading-16">7.1 Date 对象的自动溢出处理</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// JavaScript 的 Date 会自动处理溢出</span>
<span class="hljs-keyword">const</span> date = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">'2024-01-31'</span>)
date.<span class="hljs-title function_">setMonth</span>(date.<span class="hljs-title function_">getMonth</span>() + <span class="hljs-number">1</span>)  <span class="hljs-comment">// 自动变为 2024-03-02(2月没有31日)</span>
</code></pre>
<h3 data-id="heading-17">7.2 获取上月最后一天</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 将日期设为0,会自动回退到上月最后一天</span>
<span class="hljs-keyword">const</span> lastDayOfLastMonth = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(year, month, <span class="hljs-number">0</span>)
</code></pre>
<h3 data-id="heading-18">7.3 日期格式化</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ISO 格式转 YYYY-MM-DD</span>
<span class="hljs-keyword">const</span> dateStr = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>().<span class="hljs-title function_">split</span>(<span class="hljs-string">'T'</span>)[<span class="hljs-number">0</span>]
</code></pre>
<h2 data-id="heading-19">八、核心算法总结</h2>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">日期间隔计算:</span>
  时间戳相减 → 转换为天数
  年月日逐级计算 → 处理借位

<span class="hljs-section">日期加减计算:</span>
  原生 Date API → 自动处理溢出

<span class="hljs-section">年龄计算:</span>
  年月日分别相减 → 逐级调整借位

<span class="hljs-section">工作日计算:</span>
  逐日遍历 → 判断星期几 → 统计分类
</code></pre>
<p><strong>核心原则</strong>:</p>
<ol>
<li><strong>利用原生 API</strong>: Date 对象的自动溢出处理</li>
<li><strong>边界处理</strong>: 防止负数、空值、非法日期</li>
<li><strong>精确计算</strong>: 考虑月份天数差异、闰年等特殊情况</li>
<li><strong>用户友好</strong>: 自动排序、可选配置、实时计算</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[FLIP 动画策略：让你的布局变化更加丝滑]]></title>    <link>https://juejin.cn/post/7599496293174460435</link>    <guid>https://juejin.cn/post/7599496293174460435</guid>    <pubDate>2026-01-26T13:20:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599496293174460435" data-draft-id="7599502282601955391" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="FLIP 动画策略：让你的布局变化更加丝滑"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-26T13:20:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="等风起881"/> <meta itemprop="url" content="https://juejin.cn/user/3162618545319111"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            FLIP 动画策略：让你的布局变化更加丝滑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3162618545319111/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    等风起881
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T13:20:28.000Z" title="Mon Jan 26 2026 13:20:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家写交互动效时，最容易遇到一种尴尬：<strong>布局变了，动画却卡了</strong>。</p>
<p>比如：列表排序、卡片展开、Tab 切换、按钮滑块移动……如果我们直接去动画 <code>top/left/width/height</code>，浏览器往往要频繁 <strong>Layout（重排）→ Paint（重绘）</strong>，轻则掉帧，重则“整页抖”。</p>
<p>这篇文章我们用一个简单但非常工程化的策略——<strong>FLIP</strong>，把“昂贵的布局动画”转成“便宜的 transform 动画”，让动效又稳又顺。💡</p>
<hr/>
<h2 data-id="heading-0">目录</h2>
<ul>
<li><a href="#flip-%E5%8A%A8%E7%94%BB%E7%AD%96%E7%95%A5%E8%AE%A9%E4%BD%A0%E7%9A%84%E5%B8%83%E5%B1%80%E5%8F%98%E5%8C%96%E6%9B%B4%E5%8A%A0%E4%B8%9D%E6%BB%91" title="#flip-%E5%8A%A8%E7%94%BB%E7%AD%96%E7%95%A5%E8%AE%A9%E4%BD%A0%E7%9A%84%E5%B8%83%E5%B1%80%E5%8F%98%E5%8C%96%E6%9B%B4%E5%8A%A0%E4%B8%9D%E6%BB%91">FLIP 动画策略：让你的布局变化更加丝滑</a>
<ul>
<li><a href="#%E7%9B%AE%E5%BD%95" title="#%E7%9B%AE%E5%BD%95">目录</a></li>
<li><a href="#%E4%BB%80%E4%B9%88%E6%98%AF-flip" title="#%E4%BB%80%E4%B9%88%E6%98%AF-flip">什么是 FLIP？</a></li>
<li><a href="#flip-%E5%9B%9B%E6%AD%A5%E6%B3%95first--last--invert--play" title="#flip-%E5%9B%9B%E6%AD%A5%E6%B3%95first--last--invert--play">FLIP 四步法：First / Last / Invert / Play</a></li>
<li><a href="#%E4%B8%80%E4%B8%AA%E6%9C%80%E5%B0%8F%E5%8F%AF%E8%BF%90%E8%A1%8C%E7%A4%BA%E4%BE%8B" title="#%E4%B8%80%E4%B8%AA%E6%9C%80%E5%B0%8F%E5%8F%AF%E8%BF%90%E8%A1%8C%E7%A4%BA%E4%BE%8B">一个最小可运行示例</a></li>
<li><a href="#%E5%AE%9E%E6%88%98%E7%94%A8-flip-%E5%81%9A%E4%B8%80%E4%B8%AA-switch-%E6%BB%91%E5%9D%97" title="#%E5%AE%9E%E6%88%98%E7%94%A8-flip-%E5%81%9A%E4%B8%80%E4%B8%AA-switch-%E6%BB%91%E5%9D%97">实战：用 FLIP 做一个 switch 滑块</a></li>
<li><a href="#%E5%B0%81%E8%A3%85%E6%8A%8A-flip-%E5%8F%98%E6%88%90%E4%B8%80%E4%B8%AA%E5%87%BD%E6%95%B0" title="#%E5%B0%81%E8%A3%85%E6%8A%8A-flip-%E5%8F%98%E6%88%90%E4%B8%80%E4%B8%AA%E5%87%BD%E6%95%B0">封装：把 FLIP 变成一个函数</a></li>
<li><a href="#%E4%B8%BA%E4%BB%80%E4%B9%88-flip-%E5%80%BC%E5%BE%97%E6%8A%98%E8%85%BE" title="#%E4%B8%BA%E4%BB%80%E4%B9%88-flip-%E5%80%BC%E5%BE%97%E6%8A%98%E8%85%BE">为什么 FLIP 值得“折腾”？</a></li>
<li><a href="#%E6%8B%93%E5%B1%95waapi-%E4%B8%8E%E5%9B%BE%E5%B1%82%E6%8F%90%E5%8D%87" title="#%E6%8B%93%E5%B1%95waapi-%E4%B8%8E%E5%9B%BE%E5%B1%82%E6%8F%90%E5%8D%87">拓展：WAAPI 与图层提升</a>
<ul>
<li><a href="#elementanimatewaapi" title="#elementanimatewaapi">element.animate()（WAAPI）</a></li>
<li><a href="#%E5%9B%BE%E5%B1%82%E6%8F%90%E5%8D%87layer-promotion" title="#%E5%9B%BE%E5%B1%82%E6%8F%90%E5%8D%87layer-promotion">图层提升（Layer Promotion）</a></li>
</ul>
</li>
<li><a href="#%E5%B0%8F%E7%BB%93" title="#%E5%B0%8F%E7%BB%93">小结</a></li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-1">什么是 FLIP？</h2>
<p><strong>FLIP</strong> 是 <strong>First / Last / Invert / Play</strong> 的缩写，是一种实现 <strong>高性能布局过渡动画</strong> 的策略。</p>
<p>核心思路一句话概括：</p>
<blockquote>
<p>✅ 我们先让布局“直接变到最终态”，再用 <code>transform</code> 把元素“拉回起点”，最后播放 <code>transform</code> 回到 0 的动画。</p>
</blockquote>
<p>为什么这样做更快？⚠️</p>
<ul>
<li>改 <code>width/height/top/left/margin</code> 往往会触发 <strong>Layout</strong>（并可能连带整片区域重绘）。</li>
<li>改 <code>transform/opacity</code> 通常只走 <strong>Composite（合成）</strong>，更多由 GPU 参与，帧率更稳。</li>
</ul>
<hr/>
<h2 data-id="heading-2">FLIP 四步法：First / Last / Invert / Play</h2>
<p>我们把它拆成四步，写代码时基本就是照着这个流程走：</p>
<ol>
<li><strong>First（初始态）</strong>：读取元素当前几何信息（位置/尺寸）。</li>
<li><strong>Last（最终态）</strong>：先更新 DOM 状态/布局，再读取更新后的几何信息。</li>
<li><strong>Invert（反转）</strong>：计算从 First 到 Last 的差值，用 <code>transform</code> 把元素“反向挪回去”。</li>
<li><strong>Play（播放）</strong>：在下一帧移除反向 transform，让它自然过渡到 <code>transform: none</code>。</li>
</ol>
<p>💡小提示：<code>getBoundingClientRect()</code> 会触发一次布局读取（Layout），因此 FLIP 的关键是把读取次数控制在必要的两次（First + Last）。</p>
<hr/>
<h2 data-id="heading-3">一个最小可运行示例</h2>
<p>先来一个“能跑就行”的 FLIP，帮助大家建立直觉。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"box"</span> <span class="hljs-attr">style</span>=<span class="hljs-string">"width:100px; height:100px; background:#2563eb; position:absolute;"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"moveBtn"</span>&gt;</span>Move Box<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> box = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"box"</span>)
<span class="hljs-keyword">const</span> moveBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"moveBtn"</span>)

<span class="hljs-keyword">let</span> toggled = <span class="hljs-literal">false</span>
moveBtn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"click"</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 1) First</span>
  <span class="hljs-keyword">const</span> firstRect = box.<span class="hljs-title function_">getBoundingClientRect</span>()

  <span class="hljs-comment">// 2) State：直接切到最终布局</span>
  toggled = !toggled
  box.<span class="hljs-property">style</span>.<span class="hljs-property">marginLeft</span> = toggled ? <span class="hljs-string">"200px"</span> : <span class="hljs-string">"0px"</span>
  box.<span class="hljs-property">style</span>.<span class="hljs-property">marginTop</span> = toggled ? <span class="hljs-string">"200px"</span> : <span class="hljs-string">"0px"</span>

  <span class="hljs-comment">// 3) Last</span>
  <span class="hljs-keyword">const</span> lastRect = box.<span class="hljs-title function_">getBoundingClientRect</span>()

  <span class="hljs-comment">// 4) Invert</span>
  <span class="hljs-keyword">const</span> dx = firstRect.<span class="hljs-property">left</span> - lastRect.<span class="hljs-property">left</span>
  <span class="hljs-keyword">const</span> dy = firstRect.<span class="hljs-property">top</span> - lastRect.<span class="hljs-property">top</span>

  box.<span class="hljs-property">style</span>.<span class="hljs-property">transition</span> = <span class="hljs-string">"none"</span>
  box.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">`translate(<span class="hljs-subst">${dx}</span>px, <span class="hljs-subst">${dy}</span>px)`</span>

  <span class="hljs-comment">// 5) Play</span>
  <span class="hljs-title function_">requestAnimationFrame</span>(<span class="hljs-function">() =&gt;</span> {
    box.<span class="hljs-property">style</span>.<span class="hljs-property">transition</span> = <span class="hljs-string">"transform 0.5s ease"</span>
    box.<span class="hljs-property">style</span>.<span class="hljs-property">transform</span> = <span class="hljs-string">"translate(0, 0)"</span>
  })
})
</code></pre>
<p>✅ 你会发现：我们并没有“动画布局属性”，而是让布局瞬间完成，然后只动画 <code>transform</code>。</p>
<hr/>
<h2 data-id="heading-4">实战：用 FLIP 做一个 switch 滑块</h2>
<p>接下来上点更像业务的：一个 switch 按钮。</p>
<p>点击时，容器的 <code>justify-content</code> 从 <code>flex-start</code> 切到 <code>flex-end</code>，<strong>滑块会跟着布局跳到另一侧</strong>。FLIP 的目标是：让它“看起来不是跳过去的，而是滑过去的”。✅</p>
<p>为了写样式更爽，我这里用 <strong>TailwindCSS</strong>（你也可以用纯 CSS）。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"h-screen flex justify-center items-center"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span>
    <span class="hljs-attr">id</span>=<span class="hljs-string">"toggleBtn"</span>
    <span class="hljs-attr">class</span>=<span class="hljs-string">"w-38 h-20 rounded-full bg-black p-2 flex items-center justify-start cursor-pointer transition-colors duration-300"</span>
  &gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"indicator"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"bg-white size-16 rounded-full shadow-md"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> toggleBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"toggleBtn"</span>)
<span class="hljs-keyword">const</span> indicator = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"indicator"</span>)

toggleBtn.<span class="hljs-property">onclick</span> = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// First</span>
  <span class="hljs-keyword">const</span> firstRect = indicator.<span class="hljs-title function_">getBoundingClientRect</span>()

  <span class="hljs-comment">// State：更新布局/样式（此处会导致滑块的最终位置变化）</span>
  <span class="hljs-keyword">const</span> currentJustify = toggleBtn.<span class="hljs-property">style</span>.<span class="hljs-property">justifyContent</span> || <span class="hljs-title function_">getComputedStyle</span>(toggleBtn).<span class="hljs-property">justifyContent</span>
  <span class="hljs-keyword">const</span> isStart = currentJustify === <span class="hljs-string">"flex-start"</span> || currentJustify === <span class="hljs-string">"normal"</span>

  toggleBtn.<span class="hljs-property">style</span>.<span class="hljs-property">justifyContent</span> = isStart ? <span class="hljs-string">"flex-end"</span> : <span class="hljs-string">"flex-start"</span>
  toggleBtn.<span class="hljs-property">classList</span>.<span class="hljs-title function_">toggle</span>(<span class="hljs-string">"bg-black"</span>, !isStart)
  toggleBtn.<span class="hljs-property">classList</span>.<span class="hljs-title function_">toggle</span>(<span class="hljs-string">"bg-green-500"</span>, isStart)

  <span class="hljs-comment">// Last</span>
  <span class="hljs-keyword">const</span> lastRect = indicator.<span class="hljs-title function_">getBoundingClientRect</span>()

  <span class="hljs-comment">// Invert</span>
  <span class="hljs-keyword">const</span> dx = firstRect.<span class="hljs-property">left</span> - lastRect.<span class="hljs-property">left</span>
  <span class="hljs-keyword">const</span> dy = firstRect.<span class="hljs-property">top</span> - lastRect.<span class="hljs-property">top</span>

  <span class="hljs-comment">// Play：用 WAAPI 播放 transform</span>
  indicator.<span class="hljs-title function_">animate</span>([{ <span class="hljs-attr">transform</span>: <span class="hljs-string">`translate(<span class="hljs-subst">${dx}</span>px, <span class="hljs-subst">${dy}</span>px)`</span> }, { <span class="hljs-attr">transform</span>: <span class="hljs-string">"translate(0, 0)"</span> }], {
    <span class="hljs-attr">duration</span>: <span class="hljs-number">300</span>,
    <span class="hljs-attr">easing</span>: <span class="hljs-string">"cubic-bezier(0.34, 1.56, 0.64, 1)"</span>,
  })
}
</code></pre>
<p>💡这里我们用的是原生 <code>element.animate()</code>（WAAPI）。它很适合“短小、一次性、无需写 CSS keyframes”的动效。</p>
<hr/>
<h2 data-id="heading-5">封装：把 FLIP 变成一个函数</h2>
<p>当你在项目里写第二次、第三次 FLIP 时，就会开始嫌它啰嗦。</p>
<p>更工程化的做法是：把 First/Last/Invert/Play 封装起来，业务侧只关心“怎么更新状态”。✅</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">/**
 * FLIP 动画辅助函数
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">Element</span>} <span class="hljs-variable">dom</span> - 需要执行动画的 DOM 元素
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">() =&gt; void</span>} <span class="hljs-variable">updateState</span> - 更新 DOM 状态的回调函数（修改样式、DOM 结构等）
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">number | KeyframeAnimationOptions</span>} [options] - 动画配置，支持传入数字(duration)或对象
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">Animation | void</span>} - 返回 Animation，若无需动画则返回 void
 */</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">flipAnimate</span>(<span class="hljs-params">dom, updateState, options = {}</span>) {
  <span class="hljs-keyword">const</span> defaultOptions = {
    <span class="hljs-attr">duration</span>: <span class="hljs-number">300</span>,
    <span class="hljs-attr">easing</span>: <span class="hljs-string">"cubic-bezier(0.34, 1.56, 0.64, 1)"</span>,
    <span class="hljs-attr">fill</span>: <span class="hljs-string">"both"</span>,
  }

  <span class="hljs-keyword">const</span> finalOptions =
    <span class="hljs-keyword">typeof</span> options === <span class="hljs-string">"number"</span> ? { ...defaultOptions, <span class="hljs-attr">duration</span>: options } : { ...defaultOptions, ...options }

  <span class="hljs-comment">// First</span>
  <span class="hljs-keyword">const</span> firstRect = dom.<span class="hljs-title function_">getBoundingClientRect</span>()

  <span class="hljs-comment">// State</span>
  <span class="hljs-title function_">updateState</span>()

  <span class="hljs-comment">// Last</span>
  <span class="hljs-keyword">const</span> lastRect = dom.<span class="hljs-title function_">getBoundingClientRect</span>()

  <span class="hljs-comment">// Invert</span>
  <span class="hljs-keyword">const</span> dx = firstRect.<span class="hljs-property">left</span> - lastRect.<span class="hljs-property">left</span>
  <span class="hljs-keyword">const</span> dy = firstRect.<span class="hljs-property">top</span> - lastRect.<span class="hljs-property">top</span>
  <span class="hljs-keyword">if</span> (dx === <span class="hljs-number">0</span> &amp;&amp; dy === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>

  <span class="hljs-comment">// Play</span>
  <span class="hljs-keyword">return</span> dom.<span class="hljs-title function_">animate</span>([{ <span class="hljs-attr">transform</span>: <span class="hljs-string">`translate(<span class="hljs-subst">${dx}</span>px, <span class="hljs-subst">${dy}</span>px)`</span> }, { <span class="hljs-attr">transform</span>: <span class="hljs-string">"translate(0, 0)"</span> }], finalOptions)
}
</code></pre>
<p>回到刚才的 switch，我们可以把业务代码压缩得非常干净：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> toggleBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"toggleBtn"</span>)
<span class="hljs-keyword">const</span> indicator = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">"indicator"</span>)

toggleBtn.<span class="hljs-property">onclick</span> = <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">flipAnimate</span>(indicator, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> currentJustify = toggleBtn.<span class="hljs-property">style</span>.<span class="hljs-property">justifyContent</span> || <span class="hljs-title function_">getComputedStyle</span>(toggleBtn).<span class="hljs-property">justifyContent</span>
    <span class="hljs-keyword">const</span> isStart = currentJustify === <span class="hljs-string">"flex-start"</span> || currentJustify === <span class="hljs-string">"normal"</span>

    toggleBtn.<span class="hljs-property">style</span>.<span class="hljs-property">justifyContent</span> = isStart ? <span class="hljs-string">"flex-end"</span> : <span class="hljs-string">"flex-start"</span>
    toggleBtn.<span class="hljs-property">classList</span>.<span class="hljs-title function_">toggle</span>(<span class="hljs-string">"bg-black"</span>, !isStart)
    toggleBtn.<span class="hljs-property">classList</span>.<span class="hljs-title function_">toggle</span>(<span class="hljs-string">"bg-green-500"</span>, isStart)
  })
}
</code></pre>
<p>⚠️注意：原草稿里这里传的是 <code>btn</code>，但变量并不存在；实际应该对“会移动的元素”执行 FLIP，也就是 <code>indicator</code>。</p>
<hr/>
<h2 data-id="heading-6">为什么 FLIP 值得“折腾”？</h2>
<p>大家可能会想：</p>
<blockquote>
<p>“我就动画一下 <code>height</code>，真的有这么严重吗？”</p>
</blockquote>
<p>在简单页面可能还好，但一旦进入真实业务（列表、瀑布流、复杂组件树），布局动画的成本会迅速放大：</p>
<ul>
<li><strong>浏览器压力大</strong>：每一帧都可能触发 Layout，主线程忙到飞起。</li>
<li><strong>影响面更大</strong>：元素尺寸变化会挤压兄弟节点，导致更多区域参与重排/重绘。</li>
</ul>
<p>而 FLIP 的优势很明确 ✅：</p>
<ul>
<li>动画过程主要是 <strong>transform 合成</strong>，对主线程更友好。</li>
<li>浏览器通常只需要在动画前后各读取一次布局（First + Last）。</li>
</ul>
<hr/>
<h2 data-id="heading-7">拓展：WAAPI 与图层提升</h2>
<h3 data-id="heading-8">element.animate()（WAAPI）</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FElement%2Fanimate" target="_blank" title="https://developer.mozilla.org/zh-CN/docs/Web/API/Element/animate" ref="nofollow noopener noreferrer"><code>element.animate()</code></a> 是原生 <strong>Web Animations API（WAAPI）</strong> 的核心入口。</p>
<p>适用场景：</p>
<ul>
<li>✅ 动画由 JS 控制（比如 FLIP 算出来的 <code>dx/dy</code>）</li>
<li>✅ 不想写 CSS <code>@keyframes</code></li>
<li>✅ 需要拿到 <code>Animation</code> 对象（暂停/取消/finished 等）</li>
</ul>
<p>常见 options：</p>
<ul>
<li><code>duration</code>：持续时间（ms）</li>
<li><code>easing</code>：缓动（如 <code>cubic-bezier(...)</code>）</li>
<li><code>fill</code>：结束状态（<code>forwards/backwards/both/none</code>）</li>
<li><code>iterations</code> / <code>delay</code> / <code>direction</code> / <code>playbackRate</code></li>
</ul>
<h3 data-id="heading-9">图层提升（Layer Promotion）</h3>
<p><strong>图层提升</strong>可以理解成：浏览器把某个元素“单独拎到一个可合成图层”，让它的 <code>transform/opacity</code> 动画更容易稳定在高帧率。</p>
<p>一个通俗类比 💡：</p>
<ul>
<li>背景画在纸上</li>
<li>角色画在透明胶片上</li>
<li>移动角色时，只移动胶片，不用重画背景</li>
</ul>
<p>常见触发方式：</p>
<ul>
<li><code>transform: translateZ(0)</code> / <code>translate3d(0,0,0)</code></li>
<li><code>will-change: transform</code>（⚠️按需使用，别给一堆元素常驻）</li>
<li>元素正在进行 <code>transform/opacity</code> 动画（浏览器可能自动提升）</li>
</ul>
<p>为什么封装里要做 <code>dx === 0 &amp;&amp; dy === 0</code> 的提前返回？✅</p>
<ul>
<li>如果明明没动还强行动画，浏览器可能依然创建合成层、分配显存、做无意义的合成开销。</li>
<li>提前返回能避免“不必要的图层提升”，让性能更稳。</li>
</ul>
<hr/>
<h2 data-id="heading-10">小结</h2>
<ul>
<li><strong>FLIP</strong> 的本质：把“布局变化”变成“transform 动画”。</li>
<li>最关键的动作：<strong>只读两次布局（First + Last）</strong>，动画只动 <code>transform</code>。</li>
<li>适合场景：排序/插入/展开折叠/布局切换等“元素最终位置由布局决定”的动效。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[我接手了一个 10 年前的 jQuery 老项目，用 Web Components 给它续了命]]></title>    <link>https://juejin.cn/post/7599586891084726306</link>    <guid>https://juejin.cn/post/7599586891084726306</guid>    <pubDate>2026-01-27T01:56:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599586891084726306" data-draft-id="7599586891084415010" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="我接手了一个 10 年前的 jQuery 老项目，用 Web Components 给它续了命"/> <meta itemprop="keywords" content="前端,JavaScript,架构"/> <meta itemprop="datePublished" content="2026-01-27T01:56:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ErpanOmer"/> <meta itemprop="url" content="https://juejin.cn/user/3878732754331096"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            我接手了一个 10 年前的 jQuery 老项目，用 Web Components 给它续了命
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3878732754331096/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ErpanOmer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T01:56:24.000Z" title="Tue Jan 27 2026 01:56:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72139c51d14748b19ef5441dd07dcc2c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083786&amp;x-signature=3J%2FUwxiw8ndJ7DVxDEeglkMqdHQ%3D" alt="3680358_4d2e_2.webp" loading="lazy"/></p>
<p>前几个月，主管把我拉进一个小黑屋，语重心长地说：那个 2015 年上线的 CRM 系统，客户想加个<strong>AI 智能客服</strong>的功能，虽然是个老项目，但这是公司的大金矿，你来负责呗！😃。</p>
<p>我打开代码仓库的那一刻，两眼一黑。</p>
<ul>
<li><strong>jQuery 1.8.3</strong>，古董级的版本。</li>
<li><strong>没有 Webpack，没有 Vite</strong>，只有无尽的 <code>&lt;script&gt;</code> 标签。</li>
<li><strong>全局变量漫天飞</strong>，一个 <code>common.js</code> 有 8000 行，里面充斥着 <code>var</code> 和 <code>function</code>。</li>
<li><strong>CSS 样式全剧透</strong>，随便改个 <code>div</code> 的 padding，隔壁页面的布局就崩了。</li>
</ul>
<p>这时候，我的脑子里有两个小人在打架：</p>
<ul>
<li>全删了！用 Vue3 + Vite 重构！这代码是人写的吗？😖</li>
<li>别冲动！这项目逻辑极其复杂，重构就是火葬场，上线出了 Bug 你负责？</li>
</ul>
<p><strong>现实是残酷的：业务只给了 3 天时间，重构是不可能的😒。</strong></p>
<p>但在满屏 <code>$('#id').show()</code> 的代码里写现代化的 AI 对话界面？光是解决 CSS 样式冲突就能让我加班到猝死。</p>
<p>最后，我没有选择 React，也没用 iframe（通信太麻烦），而是掏出了浏览器原生的大杀器——<strong>Web Components</strong>。</p>
<p>结果？<strong>我只用了一个 JS 文件，就完美地把现代 UI种进了这坨老代码里，而且没引发任何副作用。</strong></p>
<p>今天就来聊聊，这套<strong>屎山续命指南</strong>。</p>
<hr/>
<h3 data-id="heading-0">为什么我选择了 Web Components？</h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6d9bad370bdb4400956e5a4d0c6d9c98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083786&amp;x-signature=WOsfrdldTjHu%2F5aNZESObqZRXzo%3D" alt="1_NE0TVSyDZ2MC7ngfGYa7gg.jpg" loading="lazy"/></p>
<p>在老项目里加新功能，最大的痛点是什么？</p>
<p><strong>不是 JS 逻辑混乱，是 CSS 污染。</strong></p>
<p>老项目里通常会有这种霸道的全局样式：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* style.css */</span>
<span class="hljs-selector-tag">div</span> { <span class="hljs-attribute">box-sizing</span>: content-box; }
<span class="hljs-selector-tag">input</span> { <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid red; } <span class="hljs-comment">/* 不知道哪位前辈留下的坑 */</span>
<span class="hljs-selector-class">.btn</span> { <span class="hljs-attribute">float</span>: left; }
</code></pre>
<p>如果你直接引入一个 Vue/React 组件，这些全局样式会瞬间摧毁你的 UI。</p>
<p>而 <strong>Web Components 的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fen-US%2Fdocs%2FWeb%2FAPI%2FWeb_components%2FUsing_shadow_DOM" target="_blank" title="https://developer.mozilla.org/en-US/docs/Web/API/Web_components/Using_shadow_DOM" ref="nofollow noopener noreferrer">Shadow DOM（影子 DOM）</a></strong> ，就是为此而生的。</p>
<p>它创造了一个<strong>完全隔离的 DOM 作用域</strong>。</p>
<ul>
<li>外部的 CSS 进不来（你的组件不会乱）。</li>
<li>内部的 CSS 出不去（你不会搞崩老页面）。</li>
</ul>
<hr/>
<h3 data-id="heading-1">在 jQuery 页面里开始植入AI 助手</h3>
<p>假设我们不需要任何构建工具（Webpack/Vite），直接在老页面的 HTML 里写。</p>
<h4 data-id="heading-2">定义组件</h4>
<p>不用引入任何库，直接用原生 ES6 Class。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-comment">// ai-assistant.js</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">AiAssistant</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">HTMLElement</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">super</span>();
    <span class="hljs-comment">// 1. 开启 Shadow DOM，这是隔离的关键</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shadow</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">attachShadow</span>({ <span class="hljs-attr">mode</span>: <span class="hljs-string">'open'</span> });
  }

  <span class="hljs-title function_">connectedCallback</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 2. 渲染 UI 和 独立的 CSS</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">render</span>();
    <span class="hljs-comment">// 3. 绑定事件</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shadow</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#send-btn'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">handleSend</span>();
    });
  }

  <span class="hljs-title function_">render</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">shadow</span>.<span class="hljs-property">innerHTML</span> = <span class="hljs-string">`
      &lt;style&gt;
        /* 这里的样式绝对安全，不会影响外部，也不受外部影响 */
        :host {
          position: fixed;
          bottom: 20px;
          right: 20px;
          z-index: 9999;
        }
        .container {
          background: #fff;
          border-radius: 12px;
          box-shadow: 0 4px 20px rgba(0,0,0,0.15);
          width: 300px;
          font-family: 'Segoe UI', sans-serif; /* 我们可以用现代字体 */
        }
        .header { background: #007bff; color: white; padding: 10px; border-radius: 12px 12px 0 0; }
        .content { height: 200px; padding: 10px; overflow-y: auto; color: #333; }
        input { width: 70%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        button { background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
      &lt;/style&gt;

      &lt;div class="container"&gt;
        &lt;div class="header"&gt;🤖 AI 助手&lt;/div&gt;
        &lt;div class="content" id="chat-box"&gt;
          &lt;div&gt;你好，我是你的智能助手，有什么可以帮您？&lt;/div&gt;
        &lt;/div&gt;
        &lt;div style="padding: 10px; border-top: 1px solid #eee;"&gt;
          &lt;input type="text" id="input-msg" placeholder="输入问题..." /&gt;
          &lt;button id="send-btn"&gt;发送&lt;/button&gt;
        &lt;/div&gt;
      &lt;/div&gt;
    `</span>;
  }

  <span class="hljs-title function_">handleSend</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> input = <span class="hljs-variable language_">this</span>.<span class="hljs-property">shadow</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#input-msg'</span>);
    <span class="hljs-keyword">const</span> text = input.<span class="hljs-property">value</span>;
    <span class="hljs-keyword">if</span> (!text) <span class="hljs-keyword">return</span>;

    <span class="hljs-comment">// 模拟添加消息</span>
    <span class="hljs-keyword">const</span> chatBox = <span class="hljs-variable language_">this</span>.<span class="hljs-property">shadow</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'#chat-box'</span>);
    chatBox.<span class="hljs-property">innerHTML</span> += <span class="hljs-string">`&lt;div style="text-align:right; margin:5px 0; color: #007bff;"&gt;<span class="hljs-subst">${text}</span>&lt;/div&gt;`</span>;
    input.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>;

    <span class="hljs-comment">// 关键：如何跟外部 jQuery 通信？抛出原生 CustomEvent</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">dispatchEvent</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">CustomEvent</span>(<span class="hljs-string">'new-question'</span>, {
      <span class="hljs-attr">detail</span>: { <span class="hljs-attr">question</span>: text },
      <span class="hljs-attr">bubbles</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">composed</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 允许穿透 Shadow DOM 冒泡出去</span>
    }));
  }
}

<span class="hljs-comment">// 注册组件</span>
customElements.<span class="hljs-title function_">define</span>(<span class="hljs-string">'ai-assistant'</span>, <span class="hljs-title class_">AiAssistant</span>);
</code></pre>
<h4 data-id="heading-3">在 jQuery 老页面中使用</h4>
<p>只需要引入 JS，然后像写 <code>&lt;div&gt;</code> 一样写标签。</p>
<pre><code class="hljs language-HTML" lang="HTML"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"legacy-style.css"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"jquery-1.8.3.min.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"old-header"</span>&gt;</span>...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  
  <span class="hljs-tag">&lt;<span class="hljs-name">ai-assistant</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">ai-assistant</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"ai-assistant.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>

  <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
    <span class="hljs-comment">// jQuery 监听组件抛出的事件</span>
    $(<span class="hljs-variable language_">document</span>).<span class="hljs-title function_">ready</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-comment">// 这里的事件监听依然丝滑</span>
      $(<span class="hljs-string">'ai-assistant'</span>).<span class="hljs-title function_">on</span>(<span class="hljs-string">'new-question'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) {
        <span class="hljs-comment">// 注意：jQuery 的 event 对象封装了一层，原生的 detail 在 originalEvent 里</span>
        <span class="hljs-keyword">var</span> question = e.<span class="hljs-property">originalEvent</span>.<span class="hljs-property">detail</span>.<span class="hljs-property">question</span>;
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"老页面收到了 AI 提问："</span>, question);
        
        <span class="hljs-comment">// 这里可以调用老系统的 API</span>
        <span class="hljs-comment">// $.ajax(...) </span>
      });
    });
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<hr/>
<h3 data-id="heading-4">为什么说这是屎山的终极解法？</h3>
<h4 data-id="heading-5">侵入性为零</h4>
<p>我在 <code>ai-assistant.js</code> 里写了 <code>input { width: 70% }</code>。</p>
<p>如果是普通的 Vue/React 组件，这行样式可能会把老页面所有的 input 都搞乱。</p>
<p>但因为有 <strong>Shadow DOM</strong>，它只对自己生效。老页面的 <code>style.css</code> 就算写了 <code>div { display: none }</code>，也影响不到我 Shadow Root 里的布局。</p>
<h4 data-id="heading-6">技术栈框架无关</h4>
<p>Web Components 是浏览器原生标准。</p>
<p>这意味着，无论这坨屎山是基于 jQuery、AngularJS 1.x、PHP 模板还是 JSP，<strong>只要它是浏览器，它就能跑这个组件</strong>。</p>
<p>未来如果你们终于决定重构，换成了 React 19，这个 <code>&lt;ai-assistant&gt;</code> 标签依然可以直接复制过去用，不用改一行代码。</p>
<h4 data-id="heading-7">渐进式迁移</h4>
<p>我们可以不用搞重构。</p>
<p>今天把用户卡片改成 Web Component。</p>
<p>明天把侧边栏改成 Web Component。</p>
<p>这是一种 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.astro.build%2Fzh-cn%2Fconcepts%2Fislands%2F" target="_blank" title="https://docs.astro.build/zh-cn/concepts/islands/" ref="nofollow noopener noreferrer"><strong>岛屿架构</strong> (Astro 类似)</a> 。我们在屎山💩的海洋里，建立一个个小岛。等岛屿连成一片，屎山自然就消失了。</p>
<hr/>
<h3 data-id="heading-8">避坑指南（干货）</h3>
<p>虽然很香，但也有几个坑要注意：</p>
<ol>
<li><strong>React 兼容性：</strong> 如果你的老项目里混用了 React 16/17，它们对 Web Components 的事件绑定支持不太好（React 19 已完美修复）。</li>
<li><strong>字体图标：</strong> Shadow DOM 里的字体图标（如 FontAwesome）如果定义在外部 CSS 里，内部读不到。需要在 Shadow DOM 的 <code>&lt;style&gt;</code> 里 <code>@import</code> 进来，或者用 <code>&lt;link&gt;</code> 引入。</li>
<li><strong>构建工具：</strong> 如果组件逻辑复杂，还是建议用 <strong><a href="https://link.juejin.cn?target=https%3A%2F%2Flit.dev%2Fdocs%2Fgetting-started%2F" target="_blank" title="https://lit.dev/docs/getting-started/" ref="nofollow noopener noreferrer">Lit</a></strong> 或 <a href="https://link.juejin.cn?target=https%3A%2F%2Fstenciljs.com%2Fdocs%2Fintroduction" target="_blank" title="https://stenciljs.com/docs/introduction" ref="nofollow noopener noreferrer"><strong>Stencil</strong></a> 这种轻量库来写，然后打包成一个 <code>bundle.js</code> 丢给老项目引用，开发体验会好很多（支持 TS、响应式数据）。</li>
</ol>
<hr/>
<p>面对老旧项目，我们往往有两种极端的态度：要么<strong>摆烂</strong>（接着堆屎），要么<strong>激进点</strong>（推倒重来）。</p>
<p>但作为成熟的工程师，我们更需要中间平滑路线。Web Components 恰恰给了我们非常好的解决方案。</p>
<p>下次再遇到老板让你给 10 年前的 JSP 页面加功能，别急着提离职。</p>
<p><strong>试着建一个 <code>&lt;my-feature&gt;</code>，你会发现，屎山其实也没那么可怕😁。</strong></p>
<p>大家平时怎么解决老古董项目呢？🤔</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0e601c8868684f018ab356deda14e37f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRXJwYW5PbWVy:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083786&amp;x-signature=I8z%2FouEr5p8hqPa1ctV%2FOg7z55U%3D" alt="谢谢大家.gif" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何实现组合式继承]]></title>    <link>https://juejin.cn/post/7599543345980981275</link>    <guid>https://juejin.cn/post/7599543345980981275</guid>    <pubDate>2026-01-26T13:45:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599543345980981275" data-draft-id="7599551824547463194" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何实现组合式继承"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-26T13:45:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="代码猎人"/> <meta itemprop="url" content="https://juejin.cn/user/624972624037374"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何实现组合式继承
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/624972624037374/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    代码猎人
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T13:45:07.000Z" title="Mon Jan 26 2026 13:45:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>组合式继承是JavaScript中常用的继承模式，它结合了<strong>原型链继承</strong>和<strong>构造函数继承</strong>的优点。下面是详细的实现方式：</p>
<h2 data-id="heading-0">1. 基本实现</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 父类构造函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">colors</span> = [<span class="hljs-string">'red'</span>, <span class="hljs-string">'blue'</span>, <span class="hljs-string">'green'</span>]
}

<span class="hljs-comment">// 父类原型方法</span>
<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayName</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'My name is '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>)
}

<span class="hljs-comment">// 子类构造函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Dog</span>(<span class="hljs-params">name, age</span>) {
    <span class="hljs-comment">// 1. 构造函数继承：继承父类实例属性</span>
    <span class="hljs-title class_">Animal</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name)  <span class="hljs-comment">// 第二次调用父类构造函数</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age
}

<span class="hljs-comment">// 2. 原型链继承：继承父类原型方法</span>
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Animal</span>()  <span class="hljs-comment">// 第一次调用父类构造函数</span>
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Dog</span>  <span class="hljs-comment">// 修复constructor指向</span>

<span class="hljs-comment">// 子类自己的方法</span>
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayAge</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'I am '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> + <span class="hljs-string">' years old'</span>)
}

<span class="hljs-comment">// 测试</span>
<span class="hljs-keyword">const</span> dog1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-string">'Buddy'</span>, <span class="hljs-number">3</span>)
dog1.<span class="hljs-property">colors</span>.<span class="hljs-title function_">push</span>(<span class="hljs-string">'yellow'</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dog1.<span class="hljs-property">colors</span>)  <span class="hljs-comment">// ['red', 'blue', 'green', 'yellow']</span>
dog1.<span class="hljs-title function_">sayName</span>()  <span class="hljs-comment">// My name is Buddy</span>
dog1.<span class="hljs-title function_">sayAge</span>()   <span class="hljs-comment">// I am 3 years old</span>

<span class="hljs-keyword">const</span> dog2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-string">'Max'</span>, <span class="hljs-number">5</span>)
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(dog2.<span class="hljs-property">colors</span>)  <span class="hljs-comment">// ['red', 'blue', 'green'] - 不受dog1影响</span>
</code></pre>
<h2 data-id="heading-1">2. 优化版本（避免两次调用父类构造函数）</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// 父类</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">colors</span> = [<span class="hljs-string">'red'</span>, <span class="hljs-string">'blue'</span>, <span class="hljs-string">'green'</span>]
}

<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayName</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'My name is '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>)
}

<span class="hljs-comment">// 子类</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Dog</span>(<span class="hljs-params">name, age</span>) {
    <span class="hljs-title class_">Animal</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name)  <span class="hljs-comment">// 只调用一次</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age
}

<span class="hljs-comment">// 使用Object.create优化，避免再次调用构造函数</span>
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>)
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Dog</span>

<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayAge</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'I am '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> + <span class="hljs-string">' years old'</span>)
}
</code></pre>
<h2 data-id="heading-2">3. 使用ES6 class语法糖</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">colors</span> = [<span class="hljs-string">'red'</span>, <span class="hljs-string">'blue'</span>, <span class="hljs-string">'green'</span>]
    }
    
    <span class="hljs-title function_">sayName</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'My name is '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>)
    }
}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, age</span>) {
        <span class="hljs-variable language_">super</span>(name)  <span class="hljs-comment">// 相当于 Animal.call(this, name)</span>
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age
    }
    
    <span class="hljs-title function_">sayAge</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'I am '</span> + <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> + <span class="hljs-string">' years old'</span>)
    }
}
</code></pre>
<h2 data-id="heading-3">4. 封装成通用继承函数</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">inherit</span>(<span class="hljs-params">Child, Parent</span>) {
    <span class="hljs-comment">// 继承原型方法</span>
    <span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Parent</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>)
    <span class="hljs-comment">// 修复constructor</span>
    <span class="hljs-title class_">Child</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Child</span>
    <span class="hljs-comment">// 存储父类引用（可选）</span>
    <span class="hljs-title class_">Child</span>.<span class="hljs-property">super</span> = <span class="hljs-title class_">Parent</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>
}

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name
}

<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayName</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>)
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Dog</span>(<span class="hljs-params">name, age</span>) {
    <span class="hljs-comment">// 调用父类构造函数</span>
    <span class="hljs-title class_">Animal</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name)
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age
}

<span class="hljs-comment">// 实现继承</span>
<span class="hljs-title function_">inherit</span>(<span class="hljs-title class_">Dog</span>, <span class="hljs-title class_">Animal</span>)

<span class="hljs-comment">// 添加子类方法</span>
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">sayAge</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span>)
}
</code></pre>
<h2 data-id="heading-4">组合式继承的优点</h2>
<ol>
<li><strong>实例属性独立</strong>：每个实例都有自己的一份属性副本</li>
<li><strong>方法共享</strong>：原型上的方法被所有实例共享，节省内存</li>
<li><strong>参数传递</strong>：子类可以向父类构造函数传递参数</li>
<li><strong>instanceof正常</strong>：<code>instanceof</code> 和 <code>isPrototypeOf()</code> 能正确工作</li>
</ol>
<h2 data-id="heading-5">注意事项</h2>
<ol>
<li><strong>原型链完整</strong>：确保原型链正确连接</li>
<li><strong>constructor修复</strong>：重写原型后要修复constructor指向</li>
<li><strong>方法添加顺序</strong>：先实现继承，再添加子类方法</li>
<li><strong>避免属性重复</strong>：优化版本避免父类构造函数被调用两次</li>
</ol>
<p>组合式继承是JavaScript中最常用的继承模式之一，理解其原理对于掌握JavaScript面向对象编程至关重要。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter 实战：将应用日志自动推送到 Microsoft Teams]]></title>    <link>https://juejin.cn/post/7599586891084562466</link>    <guid>https://juejin.cn/post/7599586891084562466</guid>    <pubDate>2026-01-27T01:36:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599586891084562466" data-draft-id="7597708846769995814" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter 实战：将应用日志自动推送到 Microsoft Teams"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-27T01:36:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JarvanMo"/> <meta itemprop="url" content="https://juejin.cn/user/2348212565845704"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter 实战：将应用日志自动推送到 Microsoft Teams
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2348212565845704/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JarvanMo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T01:36:24.000Z" title="Tue Jan 27 2026 01:36:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>排查线上生产问题，不应该总是意味着要在满屏的日志库或仪表盘里大海捞针，更不该只是被动地等待崩溃报告。有时候，你只需要那些“关键日志”能即时推送到团队面前。</strong></p>
<p>在这篇文章中，我们将分享一套<strong>地道的实战方案</strong>：如何利用 <strong>Incoming Webhooks</strong>，直接将 Flutter 应用的日志实时发送到 <strong>Microsoft Teams</strong>。这套方案不仅包含自定义消息，还会自动附带设备信息、应用版本以及用户上下文等关键数据。</p>
<p><strong>这套方案是以下场景的理想选择：</strong></p>
<ul>
<li>🔴 <strong>崩溃预警</strong></li>
<li>📍 <strong>后台定位日志</strong></li>
<li>🧪 <strong>QA 测试阶段的调试日志</strong></li>
<li>🚀 <strong>轻量化生产监控（无需集成笨重的第三方 SDK）</strong></li>
</ul>
<p><strong>🔧 我们要构建什么？</strong> 我们将亲手打造：</p>
<ol>
<li>一个兼容 Teams 的 <strong>MessageCard（消息卡片）</strong></li>
<li>一个<strong>结构化的日志载体（Payload）</strong></li>
<li>一个简单的 <strong>HTTP 发送器</strong></li>
<li>一个可复用的<strong>日志工具类</strong></li>
</ol>
<p>每当应用中发生重要事件时 → 你的团队就能在 Teams 中收到即时通知。</p>
<p><strong>🧩 前置准备</strong> 在开始敲代码之前，请确保你已具备：</p>
<ul>
<li>一个 Flutter 应用 (Android / iOS)</li>
<li>一个 Microsoft Teams 频道</li>
<li>一个 <strong>Incoming Webhook URL</strong></li>
<li>需安装的 Flutter 依赖包：<code>http</code> 和 <code>device_info_plus</code></li>
</ul>
<p><strong>🔗 第一步：创建 Teams Incoming Webhook</strong></p>
<ol>
<li>打开 <strong>Microsoft Teams</strong></li>
<li>进入你的 <strong>频道 (Channel)</strong> → 点击 <strong>连接器 (Connectors)</strong></li>
<li>添加 <strong>Incoming Webhook</strong></li>
<li>复制生成的 <strong>Webhook URL</strong> ⚠️ <strong>重要提示</strong>：切勿将此 URL 提交到公开的代码仓库中。</li>
</ol>
<p><strong>🧠 深入理解 Teams 消息卡片 (Message Cards)</strong> Teams 接收一种名为 <strong>MessageCard</strong> 的 JSON 格式日志，它支持：</p>
<ul>
<li>标题 (Title) 与 副标题 (Subtitle)</li>
<li><strong>Facts（键值对列表）</strong></li>
<li>图片与颜色标识 我们将利用这些特性，让日志变得<strong>直观易读且具备可操作性</strong>。</li>
</ul>
<p><strong>🏗 第二步：在 Flutter 中构建消息载体</strong> 这个函数将构建一个结构化的日志消息，其中包含：</p>
<ul>
<li>设备详细信息</li>
<li>系统版本</li>
<li>应用版本</li>
<li>用户信息</li>
<li>自定义日志内容</li>
</ul>
<pre><code class="hljs language-dart" lang="dart">PostToTeams getPostToTeams({
  <span class="hljs-keyword">required</span> <span class="hljs-built_in">String</span> logsToTeams,
  <span class="hljs-built_in">String?</span> subtitle,
}) {
  <span class="hljs-built_in">List</span>&lt;Facts&gt; facts = [];
  <span class="hljs-built_in">List</span>&lt;Sections&gt; sections = [];
  <span class="hljs-keyword">final</span> <span class="hljs-built_in">String</span> platform = Platform.isIOS ? <span class="hljs-string">"iOS"</span> : <span class="hljs-string">"Android"</span>;
  facts.add(Facts(<span class="hljs-string">"Date"</span>, <span class="hljs-built_in">DateTime</span>.now().toIso8601String()));
  facts.add(Facts(<span class="hljs-string">"Build Version"</span>, SharedPref.getAppVersion() ?? <span class="hljs-string">""</span>));
  facts.add(Facts(<span class="hljs-string">"Platform"</span>, platform));
  facts.add(Facts(<span class="hljs-string">"Locale"</span>, Platform.localeName));
  facts.add(Facts(<span class="hljs-string">"Processors"</span>, Platform.numberOfProcessors.toString()));
  facts.add(Facts(<span class="hljs-string">"OS"</span>, Platform.operatingSystem));
  facts.add(Facts(<span class="hljs-string">"User Id"</span>, SharedPref.getUserId() ?? <span class="hljs-string">""</span>));
  facts.add(Facts(<span class="hljs-string">"Token"</span>, SharedPref.getToken() ?? <span class="hljs-string">""</span>));
  facts.add(Facts(<span class="hljs-string">"Logs"</span>, logsToTeams));
  sections.add(
    Sections(
      <span class="hljs-string">"Flutter App Logs"</span>,
      subtitle ?? <span class="hljs-string">"Log Type"</span>,
      <span class="hljs-string">"https://teamsnodesample.azurewebsites.net/static/img/image5.png"</span>,
      facts,
    ),
  );
  <span class="hljs-keyword">return</span> PostToTeams(
    <span class="hljs-string">"MessageCard"</span>,
    <span class="hljs-string">"http://schema.org/extensions"</span>,
    <span class="hljs-string">"0076D7"</span>,
    <span class="hljs-string">"New App Log"</span>,
    sections,
  );
}
</code></pre>
<h3 data-id="heading-0">✅ 为什么这套方案效果拔群</h3>
<ul>
<li><strong>结构化</strong>：数据条理清晰，告别杂乱无章的纯文本。</li>
<li><strong>Teams UI 友好</strong>：在 Teams 界面中拥有极佳的视觉阅读体验。</li>
<li><strong>扩展性强</strong>：后续可以轻松添加错误信息、堆栈轨迹（Stack traces）等内容。</li>
</ul>
<hr/>
<h3 data-id="heading-1">🌐 第三步：将日志发送至 Teams</h3>
<p>现在，我们将通过一个简单的 HTTP POST 请求，将封装好的载体（Payload）发送出去。</p>
<pre><code class="hljs language-dart" lang="dart">Future&lt;http.Response&gt; sendLogsToTeams(
    <span class="hljs-built_in">Map</span>&lt;<span class="hljs-built_in">String</span>, <span class="hljs-built_in">dynamic</span>&gt; logsToTeams) <span class="hljs-keyword">async</span> {
  <span class="hljs-keyword">final</span> body = json.encode(logsToTeams);

  <span class="hljs-keyword">final</span> response = <span class="hljs-keyword">await</span> http.post(
    <span class="hljs-built_in">Uri</span>.parse(<span class="hljs-string">"YOUR_TEAMS_WEBHOOK_URL"</span>),
    headers: {<span class="hljs-string">'Content-Type'</span>: <span class="hljs-string">'application/json'</span>},
    body: body,
  );
  <span class="hljs-keyword">return</span> response;
}
</code></pre>
<h3 data-id="heading-2">🚀 第四步：在应用各处随调随用</h3>
<p>现在，你可以在 Flutter 应用的<strong>任何地方</strong>触发日志推送了：</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">final</span> post = getPostToTeams(
  logsToTeams:
  <span class="hljs-string">"<span class="hljs-subst">${currentLocation.latitude}</span>, <span class="hljs-subst">${currentLocation.longitude}</span>"</span>,
  subtitle: <span class="hljs-string">"Background Location Update"</span>,
);

sendLogsToTeams(post.toJson());
</code></pre>
<h3 data-id="heading-3">🎉 大功告成 —— 你的日志现在会即时出现在 Microsoft Teams 中。</h3>
<hr/>
<h3 data-id="heading-4">🧠 核心实战场景</h3>
<p>这套方案在以下场景中表现得非常出色：</p>
<ul>
<li>📍 <strong>后台服务</strong>：监控那些没有 UI 交互的后台进程。</li>
<li>❌ <strong>静默失败</strong>：捕捉那些虽然没导致崩溃、但业务逻辑已经出错的异常。</li>
<li>🔄 <strong>API 调试</strong>：实时查看生产环境中接口调用的真实反馈。</li>
<li>🧪 <strong>QA 测试</strong>：测试人员在复现 Bug 时，开发团队能瞬间看到报错堆栈。</li>
<li>🧯 <strong>生产告警</strong>：在不集成 Firebase Crashlytics 的情况下实现轻量级监控。</li>
</ul>
<hr/>
<h3 data-id="heading-5">🔐 安全与最佳实践</h3>
<ul>
<li>❌ <strong>严禁泄露</strong>：绝不要在公开的代码仓库中直接暴露 Webhook URL。</li>
<li>✅ <strong>环境变量</strong>：建议使用环境变量或远程配置（Remote Config）来管理 URL。</li>
<li>❌ <strong>保护隐私</strong>：避免发送用户的密码、Token 等敏感数据。</li>
<li>✅ <strong>流控（Throttle）</strong> ：在生产环境中对日志频率进行限制，防止消息轰炸。</li>
<li>✅ <strong>分级日志</strong>：明确区分 INFO（信息）、WARN（警告）和 ERROR（错误）。</li>
</ul>
<hr/>
<h3 data-id="heading-6">🏁 总结</h3>
<p>这套轻量级的日志系统能让你拥有<strong>实时可视化</strong>的监控能力，而无需集成臃肿的 SDK 或维护复杂的仪表盘。</p>
<p>如果你公司原本就在使用 Microsoft Teams，那么这就是你能为 Flutter 应用构建的<strong>最简单、也最有效的监控工具</strong>之一。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TypeScript namespace 详解：语法用法与使用建议]]></title>    <link>https://juejin.cn/post/7599474528239534120</link>    <guid>https://juejin.cn/post/7599474528239534120</guid>    <pubDate>2026-01-26T14:39:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599474528239534120" data-draft-id="7599514071105355791" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TypeScript namespace 详解：语法用法与使用建议"/> <meta itemprop="keywords" content="TypeScript"/> <meta itemprop="datePublished" content="2026-01-26T14:39:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="如果你好"/> <meta itemprop="url" content="https://juejin.cn/user/2272012281328215"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TypeScript namespace 详解：语法用法与使用建议
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2272012281328215/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    如果你好
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T14:39:04.000Z" title="Mon Jan 26 2026 14:39:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、namespace 是什么？核心作用：归类组织代码</h2>
<p>namespace 是 TypeScript 早期为了解决代码模块化问题设计的语法，核心目的就是<strong>把相关的变量、函数、类、接口等代码集中放到一个独立的容器中</strong>，让代码结构更清晰，同时避免不同功能的代码在全局作用域中命名冲突。</p>
<p>简单来说，就是将同一类功能的代码整合在一起，容器内的代码默认仅能内部使用，想要对外暴露供外部调用，需要做专门的导出标记。</p>
<h3 data-id="heading-1">基础用法：定义命名空间并对外暴露成员</h3>
<p>定义的命名空间内部成员，默认处于封闭状态，外部无法访问；只有添加 <code>export</code> 关键字的成员，才会被对外暴露，外部才能正常调用。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 定义一个名为 Utils 的命名空间</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Utils</span> {
  <span class="hljs-comment">// 未加 export，仅能在 Utils 内部使用</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">isString</span>(<span class="hljs-params">value: <span class="hljs-built_in">any</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'string'</span>;
  }

  <span class="hljs-comment">// 内部调用：正常执行</span>
  <span class="hljs-title function_">isString</span>(<span class="hljs-string">'hello'</span>);
}

<span class="hljs-comment">// 外部调用：报错！isString 未对外暴露</span>
<span class="hljs-title class_">Utils</span>.<span class="hljs-title function_">isString</span>(<span class="hljs-string">'world'</span>);
</code></pre>
<p>给需要对外使用的成员添加 <code>export</code>，即可实现外部访问：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Utils</span> {
  <span class="hljs-comment">// 加 export 标记，对外暴露</span>
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">log</span>(<span class="hljs-params">msg: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(msg);
  }
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">error</span>(<span class="hljs-params">msg: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(msg);
  }
}

<span class="hljs-comment">// 外部可正常调用命名空间的导出成员</span>
<span class="hljs-title class_">Utils</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'执行打印操作'</span>);
<span class="hljs-title class_">Utils</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'执行错误提示'</span>);
</code></pre>
<h3 data-id="heading-2">编译后的实际形态</h3>
<p>TypeScript 会将 namespace 编译为 JavaScript 的<strong>自执行函数 + 全局对象</strong>形式，所有添加 <code>export</code> 的成员，最终都会成为这个全局对象的属性：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 编译后生成的 Utils 代码</span>
<span class="hljs-keyword">var</span> <span class="hljs-title class_">Utils</span>;
(<span class="hljs-keyword">function</span> (<span class="hljs-params">Utils</span>) {
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">log</span>(<span class="hljs-params">msg</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(msg);
  }
  <span class="hljs-comment">// 导出的成员挂载到全局对象 Utils 上</span>
  <span class="hljs-title class_">Utils</span>.<span class="hljs-property">log</span> = log;
})(<span class="hljs-title class_">Utils</span> || (<span class="hljs-title class_">Utils</span> = {}));
</code></pre>
<p>需要注意的是：namespace 并非纯类型语法，编译后会生成真实的 JavaScript 对象，占用运行时内存，这也是它和 ES 模块的重要区别。</p>
<h2 data-id="heading-3">二、namespace 常用实用技巧</h2>
<h3 data-id="heading-4">1. 嵌套命名空间：精细化分类代码</h3>
<p>如果代码功能分类更细致，可以在命名空间内部嵌套定义其他命名空间，实现多层级的代码组织。<strong>内层的命名空间如果需要对外暴露，同样要添加 export 关键字</strong>。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Utils</span> {
  <span class="hljs-comment">// 嵌套命名空间 Messaging，需加 export 对外暴露</span>
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Messaging</span> {
    <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">log</span>(<span class="hljs-params">msg: <span class="hljs-built_in">string</span></span>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(msg);
    }
  }
}

<span class="hljs-comment">// 外部调用嵌套命名空间的成员：从最外层开始逐层访问</span>
<span class="hljs-title class_">Utils</span>.<span class="hljs-property">Messaging</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'调用嵌套命名空间的方法'</span>);
</code></pre>
<h3 data-id="heading-5">2. 为外部成员起别名：简化代码调用</h3>
<p>如果外部命名空间的成员名称较长，或者调用路径繁琐，可以在当前作用域内用 <code>import</code> 为其起别名，简化后续调用，这种方式可用于命名空间内部或外部。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Utils</span> {
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">isString</span>(<span class="hljs-params">value: <span class="hljs-built_in">any</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">typeof</span> value === <span class="hljs-string">'string'</span>;
  }
}

<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">App</span> {
  <span class="hljs-comment">// 为 Utils.isString 起别名 isString，简化调用</span>
  <span class="hljs-keyword">import</span> isString = <span class="hljs-title class_">Utils</span>.<span class="hljs-property">isString</span>;
  <span class="hljs-comment">// 直接使用别名，无需写完整的命名空间路径</span>
  <span class="hljs-title function_">isString</span>(<span class="hljs-string">'使用别名调用方法'</span>);
}
</code></pre>
<h3 data-id="heading-6">3. 跨文件使用命名空间：三斜杠引用</h3>
<p>如果一个命名空间的代码单独写在一个文件中，在其他文件中想要使用它，早期的写法是使用<strong>三斜杠引用语法</strong>，不过这种方式现在已经不推荐，更规范的方式是使用 ES 模块的 import 导入。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 三斜杠引用 utils.ts 文件，引入其中的命名空间</span>
<span class="hljs-comment">/// &lt;reference path="./utils.ts" /&gt;</span>

<span class="hljs-comment">// 直接使用 utils.ts 中定义的 Utils 命名空间</span>
<span class="hljs-title class_">Utils</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'跨文件调用命名空间成员'</span>);
</code></pre>
<h2 data-id="heading-7">三、namespace 的核心特性：自动合并</h2>
<p>多个同名的 namespace 会在编译时自动合并为一个整体，这是它的重要特性，适合对已有命名空间进行扩展，方便协作开发或修改他人代码。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 第一个同名的 Animals 命名空间</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Animals</span> {
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> {}
}

<span class="hljs-comment">// 第二个同名的 Animals 命名空间</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Animals</span> {
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Legged</span> {
    <span class="hljs-attr">numberOfLegs</span>: <span class="hljs-built_in">number</span>;
  }
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> {}
}

<span class="hljs-comment">// 上述两个命名空间，会自动合并为以下形式</span>
<span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Animals</span> {
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Legged</span> {
    <span class="hljs-attr">numberOfLegs</span>: <span class="hljs-built_in">number</span>;
  }
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Cat</span> {}
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> {}
}
</code></pre>
<p><strong>注意</strong>：只有添加 <code>export</code> 关键字的<strong>对外暴露成员</strong>会参与合并，非导出的内部成员仅能在自身所在的原命名空间中使用，合并后的命名空间无法访问。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">namespace</span> N {
  <span class="hljs-comment">// 非导出成员，仅能在当前 N 内部使用</span>
  <span class="hljs-keyword">const</span> a = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a); <span class="hljs-comment">// 正常执行</span>
  }
}

<span class="hljs-keyword">namespace</span> N {
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bar</span>(<span class="hljs-params"/>) {
    <span class="hljs-title function_">foo</span>(); <span class="hljs-comment">// 正常执行，foo 是导出成员</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(a); <span class="hljs-comment">// 报错！a 是非导出成员，无法访问</span>
  }
}
</code></pre>
<h3 data-id="heading-8">扩展特性：可与函数/类/枚举合并</h3>
<p>namespace 还可以与同名的函数、类、枚举进行合并，实现为这些对象添加额外属性或方法的效果。<strong>注意：函数、类、枚举必须在同名命名空间之前声明</strong>。</p>
<h4 data-id="heading-9">1. 与函数合并：为函数添加属性</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 先声明函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">f</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> f.<span class="hljs-property">version</span>;
}
<span class="hljs-comment">// 同名命名空间为函数添加属性</span>
<span class="hljs-keyword">namespace</span> f {
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> version = <span class="hljs-string">'1.0'</span>;
}
<span class="hljs-comment">// 调用函数</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">f</span>()); <span class="hljs-comment">// '1.0'</span>
<span class="hljs-comment">// 访问函数的新增属性</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(f.<span class="hljs-property">version</span>); <span class="hljs-comment">// '1.0'</span>
</code></pre>
<h4 data-id="heading-10">2. 与类合并：为类添加静态属性</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 先声明类</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">C</span> {
  foo = <span class="hljs-number">1</span>;
}
<span class="hljs-comment">// 同名命名空间为类添加静态属性</span>
<span class="hljs-keyword">namespace</span> C {
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> bar = <span class="hljs-number">2</span>;
}
<span class="hljs-comment">// 访问类的静态属性</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(C.<span class="hljs-property">bar</span>); <span class="hljs-comment">// 2</span>
</code></pre>
<h4 data-id="heading-11">3. 与枚举合并：为枚举添加方法</h4>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 先声明枚举</span>
<span class="hljs-keyword">enum</span> E { A, B, C }
<span class="hljs-comment">// 同名命名空间为枚举添加方法</span>
<span class="hljs-keyword">namespace</span> E {
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(E.<span class="hljs-property">C</span>); <span class="hljs-comment">// 2</span>
  }
}
<span class="hljs-comment">// 调用枚举的新增方法</span>
E.<span class="hljs-title function_">foo</span>(); <span class="hljs-comment">// 2</span>
</code></pre>
<p><strong>重要限制</strong>：枚举与同名命名空间合并时，枚举的成员和命名空间的导出成员<strong>不能重名</strong>，否则会直接编译报错。</p>
<h2 data-id="heading-12">四、为什么官方不推荐使用？首选 ES 模块的原因</h2>
<p>namespace 是 ES 模块（import/export）出现之前的过渡性方案，如今 ES 模块已经成为 JavaScript 官方的模块化标准，能够完全替代 namespace，且在标准性、兼容性、灵活性上更有优势，这也是 TS 官方推荐使用 ES 模块的核心原因。</p>
<p>两者核心差异对比：</p>






























<table><thead><tr><th>特性</th><th>namespace</th><th>ES 模块（import/export）</th></tr></thead><tbody><tr><td>语法标准</td><td>TypeScript 专属语法，需编译转换</td><td>JavaScript 官方标准，无需额外编译</td></tr><tr><td>文件使用限制</td><td>一个文件中可定义多个命名空间</td><td>一个文件就是一个独立模块</td></tr><tr><td>运行时影响</td><td>编译后生成全局对象，占用运行时内存</td><td>纯模块化语法，无额外全局对象</td></tr><tr><td>环境兼容性</td><td>仅 TypeScript 环境支持，生态有限</td><td>所有 JavaScript/TypeScript 运行环境均支持</td></tr></tbody></table>
<h3 data-id="heading-13">ES 模块替代 namespace 示例</h3>
<p>原来使用 namespace 的写法，需要嵌套命名空间并多次导出：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// shapes.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">namespace</span> <span class="hljs-title class_">Shapes</span> {
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Triangle</span> {}
  <span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Square</span> {}
}
</code></pre>
<p>使用 ES 模块的写法更简洁，直接导出成员即可，无需嵌套：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// shapes.ts 直接导出类，无额外嵌套</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Triangle</span> {}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Square</span> {}

<span class="hljs-comment">// 其他文件中导入使用</span>
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> shapes <span class="hljs-keyword">from</span> <span class="hljs-string">'./shapes'</span>;
<span class="hljs-comment">// 直接调用导入的成员</span>
<span class="hljs-keyword">const</span> t = <span class="hljs-keyword">new</span> shapes.<span class="hljs-title class_">Triangle</span>();
</code></pre>
<h3 data-id="heading-14">五、总结：什么时候用 namespace？</h3>
<p>namespace 现在已经不是 TS 推荐的模块化方式了，日常开发里只在这几种情况用：</p>
<ol>
<li><strong>改老项目</strong>：老 TS 项目里用了很多 namespace，不用特意全改掉，保持兼容就行；</li>
<li><strong>临时加全局属性</strong>：比如想给 window、Math 加个自定义方法，可临时用；</li>
<li><strong>简单脚本归类</strong>：写少量不用模块化的简单代码时，用它避免全局变量重名。</li>
</ol>
<p><strong>新项目直接用 ES 模块（import/export）</strong> 就好，这是官方推荐的标准写法，兼容更好、也更好维护。学 namespace 主要是为了能看懂老代码，日常维护够用就行。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手把手教你打造一个完美的返回顶部组件：从踩坑到优雅实现]]></title>    <link>https://juejin.cn/post/7599506068047462400</link>    <guid>https://juejin.cn/post/7599506068047462400</guid>    <pubDate>2026-01-26T15:10:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599506068047462400" data-draft-id="7599532624194617396" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手把手教你打造一个完美的返回顶部组件：从踩坑到优雅实现"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-26T15:10:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无敌的拖拉斯旋风"/> <meta itemprop="url" content="https://juejin.cn/user/951508170179208"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手把手教你打造一个完美的返回顶部组件：从踩坑到优雅实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/951508170179208/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无敌的拖拉斯旋风
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T15:10:24.000Z" title="Mon Jan 26 2026 15:10:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>作为一个前端开发者，你有没有遇到过这样的情况：页面很长，用户滚动到底部后，想要回到顶部却发现要手动拖拽滚动条？这种体验真的很糟糕。于是，我决定手搓一个返回顶部组件。没想到，这看似简单的功能，背后却藏着不少学问。</p>
<h2 data-id="heading-1">第一步：需求分析与初步构思</h2>
<h3 data-id="heading-2">为什么需要这个组件？</h3>
<p>想象一下，用户正在浏览一篇长文章，或者查看商品列表，当他们滚动到页面底部时，突然想回到顶部看看标题或其他信息。如果没有返回顶部按钮，他们只能：</p>
<ol>
<li>手动拖拽滚动条</li>
<li>点击浏览器的地址栏然后按 Home 键</li>
<li>使用键盘快捷键</li>
</ol>
<p>这些方式都不够直观和便捷。一个小小的返回顶部按钮就能大大提升用户体验。</p>
<h3 data-id="heading-3">组件的核心功能</h3>
<p>经过思考，我给这个组件定了几个基本要求：</p>
<ol>
<li><strong>智能显示</strong>：只有当用户滚动到一定距离后才出现</li>
<li><strong>平滑滚动</strong>：点击后平滑地回到页面顶部</li>
<li><strong>美观易用</strong>：按钮要美观，位置要合适</li>
<li><strong>性能良好</strong>：不能影响页面滚动的流畅性</li>
</ol>
<h2 data-id="heading-4">第二步：动手实现 - 第一版（踩坑版）</h2>
<h3 data-id="heading-5">最初的想法</h3>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">const</span> BackToTop = () =&gt; {
    <span class="hljs-keyword">const</span> [<span class="hljs-keyword">show</span>, setShow] = useState(<span class="hljs-keyword">false</span>);
    
    <span class="hljs-keyword">const</span> handleScroll = () =&gt; {
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">window</span>.scrollY &gt; <span class="hljs-number">300</span>) {
            setShow(<span class="hljs-keyword">true</span>);
        } <span class="hljs-keyword">else</span> {
            setShow(<span class="hljs-keyword">false</span>);
        }
    };
    
    useEffect(() =&gt; {
        <span class="hljs-built_in">window</span>.addEventListener(<span class="hljs-string">'scroll'</span>, handleScroll);
        <span class="hljs-keyword">return</span> () =&gt; <span class="hljs-built_in">window</span>.removeEventListener(<span class="hljs-string">'scroll'</span>, handleScroll);
    }, []);
    
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">show</span> &amp;&amp; &lt;button onClick={() =&gt; <span class="hljs-built_in">window</span>.scrollTo(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>)}&gt;回到顶部&lt;/button&gt;;
};
</code></pre>
<p><strong>当时的想法很简单</strong>：</p>
<ul>
<li>监听滚动事件</li>
<li>当滚动距离超过300px时显示按钮</li>
<li>点击按钮滚动到顶部</li>
</ul>
<h3 data-id="heading-6">惨痛的教训</h3>
<p>当我把这段代码运行起来后，<strong>页面直接卡死了！</strong> Chrome 浏览器提示页面无响应，这让我大吃一惊。</p>
<p>通过开发者工具我发现，<code>scroll</code> 事件在用户滚动时会疯狂触发，每秒钟可能触发几十次甚至上百次。每次触发都会执行 <code>setState</code>，导致 React 频繁重新渲染，页面自然就卡住了。</p>
<h2 data-id="heading-7">第三步：学习与改进 - 性能优化</h2>
<h3 data-id="heading-8">发现问题所在</h3>
<p>经过一番调研，我了解到 <code>scroll</code> 事件是一个高频事件。如果不加处理直接使用，会对性能造成严重影响。这时，我接触到了前端性能优化的经典概念：<strong>节流（Throttle）<strong>和</strong>防抖（Debounce）</strong> 。</p>
<h3 data-id="heading-9">节流 vs 防抖的区别</h3>
<ul>
<li><strong>节流</strong>：在一定时间间隔内只执行一次函数</li>
<li><strong>防抖</strong>：在事件停止触发一段时间后才执行函数</li>
</ul>
<p>对于滚动事件，节流更合适，因为我们需要定期检查滚动位置。</p>
<h3 data-id="heading-10">实现节流函数</h3>
<pre><code class="hljs language-ini" lang="ini">// 在 utils 目录下创建节流函数
export const <span class="hljs-attr">throttle</span> = (func: Function, delay: number) =&gt; {
    let timeoutId: NodeJS.Timeout | <span class="hljs-attr">null</span> = null<span class="hljs-comment">;</span>
    let <span class="hljs-attr">lastExecTime</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
    
    return function (...args: any<span class="hljs-section">[]</span>) {
        const <span class="hljs-attr">currentTime</span> = Date.now()<span class="hljs-comment">;</span>
        
        if (currentTime - lastExecTime &gt; delay) {
            func.apply(this, args)<span class="hljs-comment">;</span>
            <span class="hljs-attr">lastExecTime</span> = currentTime<span class="hljs-comment">;</span>
        } else {
            if (timeoutId) {
                clearTimeout(timeoutId)<span class="hljs-comment">;</span>
            }
            <span class="hljs-attr">timeoutId</span> = setTimeout(() =&gt; {
                func.apply(this, args)<span class="hljs-comment">;</span>
                <span class="hljs-attr">lastExecTime</span> = Date.now()<span class="hljs-comment">;</span>
            }, delay - (currentTime - lastExecTime))<span class="hljs-comment">;</span>
        }
    }<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-11">改进后的组件</h3>
<pre><code class="hljs language-ini" lang="ini">const BackToTop: React.FC&lt;BackToTopProps&gt; = ({ <span class="hljs-attr">threshold</span> = <span class="hljs-number">400</span> }) =&gt; {
    const <span class="hljs-section">[isVisible, setIsVisible]</span> = useState&lt;boolean&gt;(false)<span class="hljs-comment">;</span>

    const <span class="hljs-attr">scrollToTop</span> = () =&gt; {
        window.scrollTo({
            top: 0,
            behavior: 'smooth', // 平滑滚动
        })<span class="hljs-comment">;</span>
    }<span class="hljs-comment">;</span>

    useEffect(() =&gt; {
        const <span class="hljs-attr">toggleVisibility</span> = () =&gt; {
            setIsVisible(window.scrollY &gt; threshold)<span class="hljs-comment">;</span>
        }<span class="hljs-comment">;</span>
        
        // 使用节流函数包装滚动处理函数
        const <span class="hljs-attr">throttledToggle</span> = throttle(toggleVisibility, <span class="hljs-number">200</span>)<span class="hljs-comment">;</span>

        window.addEventListener('scroll', throttledToggle)<span class="hljs-comment">;</span>
        
        // 重要：组件卸载时移除事件监听，防止内存泄漏
        return () =&gt; window.removeEventListener('scroll', throttledToggle)<span class="hljs-comment">;</span>
    }, <span class="hljs-section">[threshold]</span>)<span class="hljs-comment">;</span>

    if (!isVisible) return null<span class="hljs-comment">;</span>

    return (
        &lt;Button
            <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span>
            <span class="hljs-attr">variant</span>=<span class="hljs-string">"outline"</span>
            <span class="hljs-attr">size</span>=<span class="hljs-string">"icon"</span>
            <span class="hljs-attr">onClick</span>={scrollToTop}
            <span class="hljs-attr">className</span>=<span class="hljs-string">"fixed bottom-20 right-6 rounded-full shadow-lg hover:shadow-xl"</span>
        &gt;
            &lt;ArrowUp <span class="hljs-attr">className</span>=<span class="hljs-string">"h-4 w-4"</span> /&gt;
        &lt;/Button&gt;
    )<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>
</code></pre>
<h2 data-id="heading-12">第四步：细节打磨 - 用户体验优化</h2>
<h3 data-id="heading-13">平滑滚动体验</h3>
<p>最初的实现是瞬间跳转到顶部，用户体验很差。后来发现了 <code>behavior: 'smooth'</code> 这个属性：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">scrollToTop</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">scrollTo</span>({
        <span class="hljs-attr">top</span>: <span class="hljs-number">0</span>,
        <span class="hljs-attr">behavior</span>: <span class="hljs-string">'smooth'</span>, <span class="hljs-comment">// 关键：平滑滚动效果</span>
    });
};
</code></pre>
<p>这个属性让滚动变得丝般顺滑，用户体验大大提升。</p>
<h3 data-id="heading-14">智能显示逻辑</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 阈值设置为400px，用户滚动超过这个距离才显示按钮</span>
<span class="hljs-keyword">const</span> [isVisible, setIsVisible] = useState&lt;<span class="hljs-built_in">boolean</span>&gt;(<span class="hljs-literal">false</span>);

<span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleVisibility</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-title function_">setIsVisible</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span> &gt; threshold); <span class="hljs-comment">// threshold 默认为400</span>
};
</code></pre>
<p>这样避免了按钮在页面刚开始滚动时就出现，干扰用户阅读。</p>
<h3 data-id="heading-15">位置和样式优化</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">className</span>=<span class="hljs-string">"fixed bottom-20 right-6 rounded-full shadow-lg hover:shadow-xl"</span>
</code></pre>
<ul>
<li><code>fixed</code>：固定定位，随页面滚动保持位置不变</li>
<li><code>bottom-20 right-6</code>：距离底部和右侧的距离</li>
<li><code>rounded-full</code>：圆形按钮，美观</li>
<li><code>shadow-lg hover:shadow-xl</code>：阴影效果，鼠标悬停时增强</li>
</ul>
<h2 data-id="heading-16">第五步：代码健壮性 - 内存泄漏防护</h2>
<h3 data-id="heading-17">为什么需要清理事件监听？</h3>
<p>这是我在开发过程中学到的重要一课。如果不清理事件监听：</p>
<ol>
<li>组件卸载后，事件监听仍然存在</li>
<li>每次滚动都会调用已卸载组件的回调函数</li>
<li>可能导致内存泄漏</li>
<li>在开发模式下可能会收到警告</li>
</ol>
<h3 data-id="heading-18">useEffect 清理机制</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> throttledToggle = <span class="hljs-title function_">throttle</span>(toggleVisibility, <span class="hljs-number">200</span>);
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, throttledToggle);
    
    <span class="hljs-comment">// 返回清理函数</span>
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'scroll'</span>, throttledToggle);
}, [threshold]);
</code></pre>
<p>这个返回的函数会在组件卸载时自动执行，确保事件监听被正确移除。</p>
<h2 data-id="heading-19">第六步：类型安全 - TypeScript 的运用</h2>
<h3 data-id="heading-20">接口定义</h3>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">BackToTopProps</span> {
    threshold?: number; <span class="hljs-comment">// 可选属性，默认400</span>
}
</code></pre>
<p>通过接口定义，我们获得了：</p>
<ol>
<li><strong>类型检查</strong>：编译时就能发现类型错误</li>
<li><strong>自动补全</strong>：IDE 提供更好的开发体验</li>
<li><strong>文档作用</strong>：代码即文档</li>
</ol>
<h3 data-id="heading-21">泛型约束</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">BackToTop</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">BackToTopProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{ threshold = <span class="hljs-number">400</span> }</span>) =&gt;</span> {
    <span class="hljs-comment">// 组件实现</span>
};
</code></pre>
<p><code>React.FC&lt;T&gt;</code> 确保了组件的类型安全。</p>
<h2 data-id="heading-22">第七步：实际应用中的考虑</h2>
<h3 data-id="heading-23">响应式设计</h3>
<p>在移动设备上，按钮的位置可能需要调整。可以通过媒体查询或动态计算来适配：</p>
<pre><code class="hljs language-scss" lang="scss">const <span class="hljs-selector-attr">[bottomOffset, setBottomOffset]</span> = <span class="hljs-built_in">useState</span>(<span class="hljs-number">20</span>);

<span class="hljs-built_in">useEffect</span>(() =&gt; {
    const navHeight = document<span class="hljs-selector-class">.querySelector</span>('nav')?<span class="hljs-selector-class">.clientHeight</span> || <span class="hljs-number">0</span>;
    <span class="hljs-built_in">setBottomOffset</span>(navHeight + <span class="hljs-number">20</span>); <span class="hljs-comment">// 避开导航栏</span>
}, <span class="hljs-selector-attr">[]</span>);
</code></pre>
<h3 data-id="heading-24">可访问性考虑</h3>
<pre><code class="hljs language-ini" lang="ini">&lt;Button
    <span class="hljs-attr">aria-label</span>=<span class="hljs-string">"回到顶部"</span>
    <span class="hljs-attr">title</span>=<span class="hljs-string">"回到顶部"</span>
    // ... 其他属性
&gt;
</code></pre>
<p>为按钮添加适当的 ARIA 标签和标题，提升可访问性。</p>
<h2 data-id="heading-25">总结与收获</h2>
<p>这个看似简单的返回顶部组件，实际上涉及了前端开发的多个重要方面：</p>
<h3 data-id="heading-26">技术要点回顾</h3>
<ol>
<li><strong>事件处理</strong>：理解滚动事件的特性</li>
<li><strong>性能优化</strong>：节流函数的应用</li>
<li><strong>用户体验</strong>：平滑动画和智能显示</li>
<li><strong>内存管理</strong>：事件监听的清理</li>
<li><strong>类型安全</strong>：TypeScript 的使用</li>
<li><strong>样式设计</strong>：Tailwind CSS 的应用</li>
</ol>
<h3 data-id="heading-27">开发感悟</h3>
<p>通过这个组件的开发，我深刻体会到：</p>
<ul>
<li><strong>看似简单的功能往往隐藏着复杂的细节</strong></li>
<li><strong>性能优化在前端开发中至关重要</strong></li>
<li><strong>用户体验需要从细微之处着手</strong></li>
<li><strong>代码的健壮性不容忽视</strong></li>
</ul>
<h3 data-id="heading-28">最终代码解析</h3>
<p>让我们再来看一遍完整的实现：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { useEffect, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Button</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/ui/button'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ArrowUp</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'lucide-react'</span>;
<span class="hljs-keyword">import</span> { throttle } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/utils'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">BackToTopProps</span> {
    threshold?: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 滚动阈值，超过此距离显示按钮</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">BackToTop</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">BackToTopProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{ threshold = <span class="hljs-number">400</span> }</span>) =&gt;</span> {
    <span class="hljs-comment">// 状态管理：控制按钮显示隐藏</span>
    <span class="hljs-keyword">const</span> [isVisible, setIsVisible] = useState&lt;<span class="hljs-built_in">boolean</span>&gt;(<span class="hljs-literal">false</span>);

    <span class="hljs-comment">// 滚动到顶部的函数</span>
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">scrollToTop</span> = (<span class="hljs-params"/>) =&gt; {
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">scrollTo</span>({
            <span class="hljs-attr">top</span>: <span class="hljs-number">0</span>,
            <span class="hljs-attr">behavior</span>: <span class="hljs-string">'smooth'</span>, <span class="hljs-comment">// 平滑滚动效果</span>
        });
    };

    <span class="hljs-comment">// 使用 useEffect 管理滚动事件监听</span>
    <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 定义滚动处理函数</span>
        <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleVisibility</span> = (<span class="hljs-params"/>) =&gt; {
            <span class="hljs-title function_">setIsVisible</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">scrollY</span> &gt; threshold); <span class="hljs-comment">// 根据滚动距离判断是否显示</span>
        };
        
        <span class="hljs-comment">// 使用节流函数优化性能</span>
        <span class="hljs-keyword">const</span> throttledToggle = <span class="hljs-title function_">throttle</span>(toggleVisibility, <span class="hljs-number">200</span>);

        <span class="hljs-comment">// 添加事件监听</span>
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'scroll'</span>, throttledToggle);
        
        <span class="hljs-comment">// 清理函数：组件卸载时移除事件监听</span>
        <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'scroll'</span>, throttledToggle);
    }, [threshold]); <span class="hljs-comment">// 依赖数组：当阈值改变时重新绑定事件</span>

    <span class="hljs-comment">// 如果不需要显示，则不渲染组件</span>
    <span class="hljs-keyword">if</span> (!isVisible) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;

    <span class="hljs-comment">// 渲染返回顶部按钮</span>
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Button</span>
            <span class="hljs-attr">type</span>=<span class="hljs-string">"button"</span>
            <span class="hljs-attr">variant</span>=<span class="hljs-string">"outline"</span>
            <span class="hljs-attr">size</span>=<span class="hljs-string">"icon"</span>
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{scrollToTop}</span>
            <span class="hljs-attr">className</span>=<span class="hljs-string">"fixed bottom-20 right-6 rounded-full shadow-lg hover:shadow-xl"</span>
        &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">ArrowUp</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"h-4 w-4"</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Button</span>&gt;</span></span>
    );
};

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">BackToTop</span>;
</code></pre>
<h2 data-id="heading-29">动画展示一下</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a46c40084e1b40a28bb6bc1a3e64b716~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5peg5pWM55qE5ouW5ouJ5pav5peL6aOO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770045028&amp;x-signature=4vl3K%2Fjp%2BOMKvb2kDxbp9lw8cUc%3D" alt="屏幕录制 2026-01-26 230803.gif" loading="lazy"/></p>
<p>这个组件虽然功能简单，但包含了现代前端开发的最佳实践。每一次踩坑都是成长，每一个细节都值得深思。这就是前端开发的魅力所在——在看似平凡的功能中，蕴含着丰富的技术内涵。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[跟我一起学开源设计第15节：规则引擎EasyRule源码基本执行逻辑设计实现流程]]></title>    <link>https://juejin.cn/post/7599483794658492457</link>    <guid>https://juejin.cn/post/7599483794658492457</guid>    <pubDate>2026-01-27T02:00:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599483794658492457" data-draft-id="7599502282602856511" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="跟我一起学开源设计第15节：规则引擎EasyRule源码基本执行逻辑设计实现流程"/> <meta itemprop="keywords" content="开源,后端"/> <meta itemprop="datePublished" content="2026-01-27T02:00:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱海贼的无处不在"/> <meta itemprop="url" content="https://juejin.cn/user/2359988032644541"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            跟我一起学开源设计第15节：规则引擎EasyRule源码基本执行逻辑设计实现流程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2359988032644541/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱海贼的无处不在
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T02:00:21.000Z" title="Tue Jan 27 2026 02:00:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读18分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>一、背景</strong></h2>
<p>在上篇文章中，我分享了EasyRule的基本使用与规则引擎的背景介绍，本节开始分享这个组件的核心执行流程，正如这个组件的名称一样，很Easy，同时这个组件的源码的抽象设计也是值得学习的。</p>
<p><strong>EasyRules</strong>这个组件是一个简单易用的规则引擎，用于在 Java 项目中实现基于规则的决策。EasyRules 的设计目标是简化规则引擎的使用，通过易于理解的 API 提供快速实现业务逻辑的途径。</p>
<p><strong>EasyRules</strong> 的一些关键特点包括：</p>
<ol>
<li><strong>规则的定义与分离</strong>：规则的定义与业务逻辑是解耦的，规则可以根据条件执行对应的动作，条件和动作通过接口进行定义。</li>
<li><strong>轻量级</strong>：与 Drools 等复杂的规则引擎相比，EasyRules 是轻量级的，没有复杂的规则语言，也不需要过多的学习成本。</li>
<li><strong>简单的 API</strong>：规则和规则组都可以通过 Java 的普通类来实现。EasyRules 提供了非常简单的 API 来加载、执行规则，易于集成到现有系统中。</li>
<li><strong>基于 POJO</strong>：规则通过 Java 的 POJO 类来实现，这意味着你不需要学习其他的 DSL（领域特定语言）。</li>
</ol>
<p>在分享前，先来看下EasyRule的入门例子：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/308d887e6d24409c9c608c3ceb1986d8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=1eD1iJpsNufjKM2UfAHEbJ3cZJI%3D" alt="" loading="lazy"/></p>
<p>在这个例子中，我们可以看到，一个程序由4部分组成：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6603e2f9d79e409e9ac47f6f1f3f0325~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=b41%2FAUk7kJsgAxKOiwQdQyuMHyA%3D" alt="" loading="lazy"/></p>
<p>本文将围绕这四点进行分析。</p>
<h2 data-id="heading-1"><strong>二、正文</strong></h2>
<h3 data-id="heading-2"><strong>2.1、项目结构</strong></h3>
<p>首先，我们从easyrule的Github主页中下载源码， 同时在IDEA中进行构建，构建后的截图如下所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7fa23532e3144bf996e8c55b41a31aa7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=caOHbMgi8iliCc3MDdsVAD%2FPr5Y%3D" alt="" loading="lazy"/></p>
<p>从图中可以看到EasyRules源码结构清晰且模块化，主要由以下模块组成：</p>
<ol>
<li>
<p><strong>easy-rules-archetype</strong>：这是提供的Maven项目的脚手架的模块。</p>
</li>
<li>
<p><strong>easyrules-core</strong>：</p>
<ul>
<li>
<p>这是整个规则引擎的核心模块，提供了所有与规则引擎相关的基础功能。它包含以下几个重要组件：</p>
<ul>
<li><strong>Rule</strong> 接口：定义了规则的结构，包括 evaluate()（条件） 和 execute()（动作） 方法。</li>
<li><strong>Rules</strong> 类：管理多个规则的容器，内部实现了 Set。</li>
<li><strong>RulesEngine</strong> 接口及其默认实现 <strong>DefaultRulesEngine</strong>：提供了执行规则的机制。</li>
<li><strong>Facts</strong> 类：用于传递给规则的输入，类似于上下文信息。</li>
</ul>
</li>
<li>
<p>核心模块负责处理基础规则条件的判断和执行。</p>
</li>
</ul>
</li>
<li>
<p><strong>easyrules-mvel</strong>：</p>
<ul>
<li>提供了与 <strong>MVEL</strong> (一个轻量级的基于 Java 的表达式语言) 的集成。通过这个模块，开发者可以编写基于 MVEL 的规则，而无需用纯 Java 编写规则。</li>
<li>使用 MVEL，开发者可以在外部文件中定义规则逻辑，极大增强了规则的灵活性。</li>
</ul>
</li>
<li>
<p><strong>easyrules-spel</strong>：</p>
<ul>
<li>提供了与 <strong>Spring Expression Language (SpEL)</strong> 的集成。开发者可以使用 SpEL 语言在规则中定义条件和动作，这对于依赖 Spring 生态的项目非常有用。</li>
<li>这一模块允许在 Spring 项目中动态定义和解析规则条件。</li>
</ul>
</li>
<li>
<p><strong>easy-rules-jexl:</strong></p>
<ul>
<li>提供了与JEXL表达式的集成</li>
</ul>
</li>
<li>
<p><strong>easyrules-support</strong>：</p>
<ul>
<li>包含了一些额外的支持类和扩展功能模块。例如，支持 YAML 格式定义规则等。</li>
<li>提供了便利的工具类，帮助开发者在自定义场景中轻松扩展规则引擎。</li>
</ul>
</li>
<li>
<p><strong>easyrules-tutorials</strong>：</p>
<ul>
<li>这个模块包含了一些教学示例，展示如何在实际项目中使用 EasyRules。它提供了基础和进阶的使用场景，帮助开发者快速上手。</li>
<li>示例代码涵盖了 easyrules-core、easyrules-mvel、easyrules-spel 等模块的使用。</li>
</ul>
</li>
</ol>
<p>在这几个模块中，我们核心关注的就是如下4个模块：</p>
<ul>
<li>easy-rules-core：规则引擎的核心逻辑</li>
<li>easy-rules-mvel：提供MVEL的支持</li>
<li>easy-rules-spel：提供SpELl的支持</li>
<li>easy-rules-support：将基本规则组合成复合规则</li>
</ul>
<p>这里大概介绍下，后续我们重点解析下。接下来我们开始从流程的角度来分析</p>
<h3 data-id="heading-3"><strong>2.2、创建事实</strong></h3>
<p>在这个规则引擎组件中，事实本质就是我们写程序时用到的变量数据信息，有些规则引擎中，会把变量称为：特征，因此有些小伙伴在风控系统等使用到规则引擎的系统中经常看到特征这种词，本质就是一些数据指标、变量信息。</p>
<p>示例中的代码如下：</p>
<pre><code class="hljs language-ini" lang="ini"> Facts <span class="hljs-attr">facts</span> = new Facts()<span class="hljs-comment">;</span>
</code></pre>
<p>我们先来看看这个类都干了啥吧。这个类是core工程下面的一个类，当我们看到这个类里面的源码那一刻我们就知道了：<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b7246c2f2344d8a86ad5743476cc3c7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=7wvJfICJFsyvg2WRcR75l4f7Dm4%3D" alt="" loading="lazy"/></p>
<p>这个类里面维护了一个Set集合，用来存储每一个事实对象，而这个组件中的每一个事实其实就是一个个参数：</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Set</span>&lt;<span class="hljs-type">Fact</span>&lt;?&gt;&gt; facts <span class="hljs-operator">=</span> new <span class="hljs-type">HashSet</span>&lt;&gt;();
</code></pre>
<p>也就是说当我们执行类似如下代码的时候，本质就是往集合中添加了这个Fact对象：</p>
<pre><code class="hljs language-arduino" lang="arduino">facts.<span class="hljs-built_in">put</span>(<span class="hljs-string">"变量1"</span>, <span class="hljs-string">"ddd"</span>);
facts.<span class="hljs-built_in">put</span>(<span class="hljs-string">"变量2"</span>, <span class="hljs-string">"cccc"</span>);
</code></pre>
<p>EasyRules 里的 Facts 类是规则引擎的核心部分之一，它是一个“事实容器”，负责存储你需要用来条件判断的“事实”（Fact）。Facts 类就是一个“事实收集站”，里面放着各种“事实小盒子”（Fact）。这些事实小盒子里装的就是规则引擎运行时要用的数据。你可以往这个站点里放事实，也可以从里面取出事实。</p>
<h4 data-id="heading-4"><strong>核心成员：Set&lt;Fact&lt;?&gt;&gt; facts</strong></h4>
<p>Facts 内部的这个 Set 就是所有事实盒子的集合。每个盒子都有个标签（name），而标签背后藏着某种“事实真相”（value）。Set 的特性是，盒子的标签不能重复，因此每个事实的名字得是唯一的。</p>
<h4 data-id="heading-5">先来看下Put方法：</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/778617152f11442aab3d366d13aa8d8d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=oYkj5QYeoMJYvKtRX1jHdliY4K8%3D" alt="" loading="lazy"/></p>
<p><strong>put(String name, T value)</strong> ：</p>
<ul>
<li>
<ul>
<li>你可以用这个方法来添加一个新事实。想象一下，你向收集站里交付了一个标有“名字”和“事实”的盒子。如果已经有同名的盒子，它会被替换掉，规则引擎可不喜欢处理重复的事实！</li>
<li>举个例子：如果你说“天气 = 晴”，然后发现错了，说“天气 = 阴”，那么它会自动替换掉“晴”的盒子，保持最新的“阴”的事实。</li>
</ul>
</li>
</ul>

<pre><code class="hljs language-arduino" lang="arduino">facts.<span class="hljs-built_in">put</span>(<span class="hljs-string">"天气"</span>, <span class="hljs-string">"阴"</span>);
</code></pre>
<p>再看看添加方法，截图如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10654ac38e0c4784b3698f1836649305~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=itZ2t8jmbvEcgF8dMLd5xJreEUw%3D" alt="" loading="lazy"/></p>
<p><strong>add(Fact fact)</strong> ：</p>
<ul>
<li>
<ul>
<li>这个方法和 put 类似，不过它允许你直接给出一个完整的“事实盒子”。不再单独传入 name 和 value，而是直接丢给它一个装好了的盒子。</li>
<li>如果你已经有一个 Fact 对象，比如 Fact weather = new Fact&lt;&gt;("天气", "阴")，就可以直接丢进收集站了。</li>
</ul>
</li>
</ul>

<pre><code class="hljs language-csharp" lang="csharp">facts.<span class="hljs-keyword">add</span>(<span class="hljs-keyword">new</span> Fact&lt;&gt;(<span class="hljs-string">"天气"</span>, <span class="hljs-string">"阴"</span>));
</code></pre>
<p>再看看删除方法，截图如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3196318e62b24b279fda004be7401de7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=7%2Bg%2Bu3ND0XWe0TV9T1XN0I0GfeY%3D" alt="" loading="lazy"/></p>
<p><strong>remove(String factName)</strong> 和 <strong>remove(Fact fact)</strong> ：</p>
<ul>
<li>
<ul>
<li>这两个方法是用来清除收集站里某个盒子的。比如你决定“天气”的信息不再需要了，就可以移除掉这个盒子。记住，移除盒子是个认真的活儿，得指定具体的名字或者盒子对象。</li>
<li>换句话说：“把‘天气’这个盒子拿走，不然我们规则就搞不清了！”</li>
</ul>
</li>
</ul>

<pre><code class="hljs language-csharp" lang="csharp">facts.<span class="hljs-keyword">remove</span>(<span class="hljs-string">"天气"</span>);
</code></pre>
<p>再看看这个类里面的get方法，截图如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c80ca7057a94f1483e8f957b123a8ca~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=yQIodG90%2BTofoi9KQJLrCnkR0nA%3D" alt="" loading="lazy"/></p>
<p><strong>get(String factName)</strong> ：</p>
<ul>
<li>
<ul>
<li>想要知道某个盒子里装的“事实”是什么？这时候你就用 get 方法，指定名字，它会告诉你盒子里装的东西。如果没找到对应的盒子，那就只能无奈地返回 null。</li>
<li>你问：“今天的天气是什么？”引擎答：“阴。”</li>
</ul>
</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">String <span class="hljs-attr">weather</span> = facts.get(<span class="hljs-string">"天气"</span>)<span class="hljs-comment">;</span>
</code></pre>
<p>再看看剩余的几个方法，截图如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c6c547a3d0b442a6a4cdea775c47bbe6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=vbk0PfkorOY9%2FByhALmvRZ028ps%3D" alt="" loading="lazy"/></p>
<p><strong>asMap()</strong> ：</p>
<ul>
<li>
<ul>
<li>asMap 是个小偷懒的工具，可以把所有的“事实盒子”打包成一个 Map，方便查询。每个盒子的名字会作为 Map 的键，里面装的事实会是值。</li>
<li>想象一下，你有一张事实表格，上面写着所有盒子的名字和它们里面的内容。非常方便！</li>
</ul>
</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">Map&lt;String, Object&gt; <span class="hljs-attr">factsMap</span> = facts.asMap()<span class="hljs-comment">;</span>
</code></pre>
<p><strong>iterator()</strong> ：</p>
<ul>
<li>
<ul>
<li>这个方法让你可以遍历整个事实收集站的所有盒子。你可以想象一下，规则引擎会拿着个小推车走过每个盒子，查看里面装了什么。</li>
<li>不过别想着在它遍历的时候偷拿或者随便移动盒子，规则引擎可不喜欢外部打乱它的计划。</li>
</ul>
</li>
</ul>

<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">for</span> (Fact&lt;?&gt; <span class="hljs-attribute">fact </span>: facts) {
    <span class="hljs-selector-tag">System</span><span class="hljs-selector-class">.out</span><span class="hljs-selector-class">.println</span>(fact.<span class="hljs-built_in">getName</span>() + <span class="hljs-string">": "</span> + fact.<span class="hljs-built_in">getValue</span>());
}
</code></pre>
<p><strong>clear()</strong> ：</p>
<ul>
<li>
<ul>
<li>这个方法就是清空收集站的“大扫除”。所有的盒子都会被清空，规则引擎会从头开始，不再依赖旧的事实。</li>
</ul>
</li>
</ul>
<p>这样在第一步中，我们定义事实，本质就是将我们的规则中的特征信息作为变量传递给组件，然后组件针对每一个规则信息，封装为一个个的事实对象存储起来。</p>
<p>Facts 类就像你家中的一个小储物间。你可以往里面放各种各样的小盒子（Fact），每个盒子上都贴着标签（name），里面装着你知道的“真相”（value）。当你需要这些事实来做决定（比如决定是不是要执行某条规则时），你就可以从储物间里拿出来看看。</p>
<p>有意思的是，Facts 类不仅支持你灵活地管理这些盒子（添加、删除、查看），还会帮你避免重复的盒子，让你的小储物间始终整齐有序。这就像当你给朋友讲了两次相同的笑话，朋友可不会觉得好笑——而是会自动忽略第二个笑话！</p>
<h3 data-id="heading-6"><strong>2.3、创建规则</strong></h3>
<p>对于我们经常使用的代码：</p>
<pre><code class="hljs language-ini" lang="ini">HelloWorldRule <span class="hljs-attr">helloWorldRule</span> = new HelloWorldRule()<span class="hljs-comment">;</span>
        
Rules <span class="hljs-attr">rules</span> = new Rules()<span class="hljs-comment">;</span>
</code></pre>
<p>我们会通过自定义一个规则类的方式来声明一个规则，同时观察Rules源码可以发现在设计方面，它和Facts事实类基本设计思想一致，内部维护了多个规则集合信息：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/166ac45a773b4440affaf8d04606f7f1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=EeknUeYPXLUoq5D8CMlaMO2WZyw%3D" alt="" loading="lazy"/></p>
<p>这里需要关注这个Rule规则接口，这个接口统一定义了规则的抽象信息，如下所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40ab59e7c6de4eb5afdb0f7e16cf4d85~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=699pY6ch7%2BpvKsu0FqvlEBOxdnw%3D" alt="" loading="lazy"/></p>
<p>Rule 接口是 EasyRules 中的规则抽象，它定义了一个可被规则引擎执行的规则。每个规则都必须有一个唯一的名称、描述和优先级，默认名称为“rule”，描述为“description”，优先级值越小优先级越高。该接口主要包括两个方法：evaluate 用于定义规则的条件，返回布尔值，表示是否应该执行规则；execute 则执行与规则相关的操作。规则通过 evaluate(Facts facts) 方法判断是否满足条件，当条件为真时，规则的动作通过 execute(Facts facts) 执行。每条规则的优先级决定了其在规则集合中的执行顺序，数字越小优先级越高。Rule 接口的设计使得开发者可以灵活定义各种业务规则，并通过规则引擎自动管理它们的执行流程，实现条件判断和自动化决策。</p>
<p>在上一篇文章中分享过创建规则的几种方式，本节简单介绍下通过注解的方式创建规则。我们通过在一个普通的类上面指定几个注解，就可以完成一个规则的定义。</p>
<h3 data-id="heading-7"><strong>2.4、注册规则</strong></h3>
<p>注册规则也是当前组件的核心代码，使用的时候的代码如下：</p>
<pre><code class="hljs language-ini" lang="ini">Rules <span class="hljs-attr">rules</span> = new Rules()<span class="hljs-comment">;</span>
rules.register(helloWorldRule)<span class="hljs-comment">;</span>
</code></pre>
<p>我们来看看register方法吧：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dcf33715122143b689b1637e603fc7b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=tuykD7Zb7ZMjibJ7s03xmZJr8sI%3D" alt="" loading="lazy"/></p>
<p>可以看到，对于诸恶的过程本质就是将Rule对象添加到Set集合中，取消注册也是。这里我们需要关注的是这个代码：</p>
<pre><code class="hljs language-scss" lang="scss">RuleProxy<span class="hljs-selector-class">.asRule</span>(rule)
</code></pre>
<p>通过字面意思我们知道，这个可能是一个代理类，传递一个类，返回代理后的规则对象。</p>
<p>RuleProxy 的作用是通过动态代理将使用注解定义的类适配为 Rule 接口的实现类，这样 EasyRules 引擎可以处理这些规则。</p>
<p>它使得开发者可以通过简单的注解来定义规则，而不必显式实现 Rule 接口，极大简化了规则的创建和管理。</p>
<p>这就像是一个规则的“翻译器”，把注解转换为引擎可以理解和执行的规范接口，使得复杂的逻辑实现可以隐藏在背后，开发者只需要专注于业务规则本身。</p>
<p>你可以想象 RuleProxy 就像是个“规则代理人”。你只需要用简单的注解写个规则草稿，剩下的都交给它——它会帮你检查规则合法不合法，然后把规则翻译成引擎能听懂的语言，最后站在前台帮你“打电话”执行各种条件和动作。真正让你“动动手指，规则搞定”，后台全由它来跑腿。</p>
<p>再来看看源码：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/823773a8cd4e451ea48537725417f856~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=V4efckANrB7TL%2BbJP%2BszJ3mAI1U%3D" alt="" loading="lazy"/></p>
<p>通过源码，可以非常清晰的看到这个会先判断是否是Rule的对象，如果不是则通过动态代理的方式来创建一个规则类，类上面也继承了InvocationHandler，就是一个动态代理实现的类：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0ef8595265854c5382cc348ed903e0c1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=uenrdcMeRS3vmlKzuMaz093X9OE%3D" alt="" loading="lazy"/></p>
<p>代码的核心是 RuleProxy 类，它在 EasyRules 规则引擎中用于将带有注解的对象转换为实现了 Rule 接口的代理对象。其主要目的是通过动态代理的方式，让使用注解定义的规则类能够符合 Rule 接口的规范，从而可以被规则引擎处理和执行。</p>
<p>其他解释如下：</p>
<p><strong>RuleProxy 实现了 InvocationHandler 接口</strong></p>
<p>InvocationHandler 是 Java 动态代理机制的一部分，允许我们拦截对目标对象方法的调用。RuleProxy 使用这一机制来拦截对带注解规则类的方法调用，并根据规则定义执行特定逻辑（如条件检查和动作执行）。</p>
<p><strong>asRule 方法</strong></p>
<p>这是 RuleProxy 类的核心方法。它将一个带有注解的规则对象转换为一个 Rule 接口的代理对象。该方法首先检查对象是否已经实现了 Rule 接口。如果已经实现，则直接返回原对象；否则，它使用 Java 的动态代理机制将该对象包装成一个实现了 Rule 和 Comparable 接口的代理对象。</p>
<p><strong>ruleDefinitionValidator.validateRuleDefinition(rule)</strong></p>
<p>该行代码用于验证传入的对象是否是有效的规则定义，确保带有正确的注解并且符合规则引擎的要求（例如，必须有一个条件和至少一个动作）。</p>
<p><strong>代理对象的执行逻辑</strong></p>
<p>当代理对象的方法被调用时，RuleProxy 会处理这些调用。具体来说，它会根据对象上定义的注解（如 @Condition 和 @Action），决定应该执行哪些逻辑。这让使用注解定义规则变得更灵活和简洁。</p>
<p>说道这里，我们可以先猜一下未来的代码的执行流程：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7473b3de183c475881f0e71fa0b7a30f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=BkiSDmaTt49YYthdlcM1kKUScBI%3D" alt="" loading="lazy"/></p>
<p>接下来我们再看下规则的触发。</p>
<h3 data-id="heading-8"><strong>2.5、注册触发</strong></h3>
<p>在客户端使用的时候，我们的调用代码如下：</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// create a rules engine and fire rules on known facts</span>
RulesEngine rulesEngine = new <span class="hljs-built_in">DefaultRulesEngine</span>();
rulesEngine<span class="hljs-selector-class">.fire</span>(rules, facts);
</code></pre>
<p>代码截图如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/205690df992040959e599052cd976683~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=ReqEYir13oiwrvGz39TCqHXeQGw%3D" alt="" loading="lazy"/></p>
<p>这里可以看到定义了多种规则引擎的执行逻辑：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/017990e50e89442b853210fa57576384~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=U6F%2FoEk8ev%2FUEomH65Xd%2FXAWGJA%3D" alt="" loading="lazy"/></p>
<p>然后我们使用的是默认的规则引擎行为。</p>
<p>InferenceRulesEngine 和 DefaultRulesEngine 是 EasyRules 规则引擎中的两个核心类，它们都实现了 RulesEngine 接口，但在规则执行的方式上有所不同。</p>
<h4 data-id="heading-9">1. <strong>DefaultRulesEngine</strong></h4>
<ul>
<li>
<p><strong>作用</strong>: DefaultRulesEngine 是最常用的规则引擎，按照预定义的顺序一次性执行所有规则。</p>
</li>
<li>
<p><strong>执行逻辑</strong>: 它会遍历所有规则，根据优先级从高到低执行。在每个规则执行之前，都会执行该规则的条件 (evaluate 方法)，如果条件成立则执行动作 (execute 方法)。</p>
</li>
<li>
<p><strong>适用场景</strong>: 适用于大多数场景，特别是规则之间没有复杂的依赖关系时。</p>
</li>
<li>
<p><strong>特点</strong>:</p>
<ul>
<li>执行流程简单，所有符合条件的规则会按顺序执行。</li>
<li>每个规则只判断条件和执行一次。</li>
</ul>
</li>
</ul>
<p><strong>例子</strong>：</p>
<ul>
<li>如果你有一系列独立的规则，比如判断天气、发送通知等，DefaultRulesEngine 可以依次执行这些规则，不会有复杂的依赖关系。</li>
</ul>
<h4 data-id="heading-10">2. <strong>InferenceRulesEngine</strong></h4>
<ul>
<li>
<p><strong>作用</strong>: InferenceRulesEngine 是一个基于推理的规则引擎，支持循环推理规则的执行。</p>
</li>
<li>
<p><strong>执行逻辑</strong>: 该引擎不仅会遍历规则，还会在每个规则执行后重新判断条件的所有的规则。这样，规则的执行可能会触发其他规则，从而形成一个规则链。这个过程会持续，直到所有规则都不再触发为止。</p>
</li>
<li>
<p><strong>适用场景</strong>: 适用于规则之间有依赖关系，或者规则的执行可能改变其他规则的条件判断结果的情况。比如，规则 A 的执行可能会影响规则 B 的条件。</p>
</li>
<li>
<p><strong>特点</strong>:</p>
<ul>
<li>基于“前向推理”的思想，规则会反复执行，直到没有任何新的规则可以触发。</li>
<li>适合规则间有复杂关系或递归依赖的情况。</li>
</ul>
</li>
</ul>
<p><strong>例子</strong>：</p>
<ul>
<li>如果规则 A 的执行改变了事实库中的数据，使得规则 B 可以触发，则 InferenceRulesEngine 会重新条件判断所有规则，直到没有新的规则可以触发。</li>
</ul>
<h4 data-id="heading-11">3. <strong>区别总结</strong></h4>
<ul>
<li>
<p><strong>执行方式</strong>:</p>
<ul>
<li>DefaultRulesEngine 只条件判断和执行一次规则，不会重新执行条件判断。</li>
<li>InferenceRulesEngine 支持推理，会在每次规则执行后重新执行条件判断所有规则，直到没有新的规则触发。</li>
</ul>
</li>
<li>
<p><strong>适用场景</strong>:</p>
<ul>
<li>DefaultRulesEngine 适合独立的、不相互依赖的规则。</li>
<li>InferenceRulesEngine 适合复杂的、相互依赖的规则，需要反复推理条件判断的场景。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-12">4. <strong>联系</strong></h4>
<ul>
<li>两者都实现了 RulesEngine 接口，基本执行逻辑相同，即通过规则的 evaluate 和 execute 方法来实现规则的条件判断和动作执行。</li>
<li>都依赖于 Rules 和 Facts 来执行规则。</li>
</ul>
<h4 data-id="heading-13">简单总结：</h4>
<ul>
<li><strong>DefaultRulesEngine</strong> 是“一次性执行完”的简单模式。</li>
<li><strong>InferenceRulesEngine</strong> 则是“反复条件判断、逐步推理”的循环模式。</li>
</ul>
<p>接下来我们再看看核心的fire方法，这个方法设计的不错，值得每个程序员学习，在阅读之前可以先看看整体流程描述：</p>
<p>doFire 方法负责执行一组注册规则 (rules) 对给定事实 (facts) 的条件判断和执行。流程如下：</p>
<ol>
<li><strong>规则检查</strong>: 如果没有注册任何规则，记录警告并返回。</li>
<li><strong>日志记录</strong>: 记录引擎参数、规则和事实的状态。</li>
<li><strong>规则条件判断</strong>: 遍历所有规则，依次执行每条规则的条件。</li>
<li><strong>条件执行</strong>: 如果规则条件成立，则执行相应的动作，并记录成功或失败的状态。</li>
<li><strong>控制流程</strong>: 根据配置参数决定是否跳过后续规则的执行。</li>
</ol>
<p>首先我们来看看方法的上半段：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30edfb06af904eac99bdd4068e238f50~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=gKqYea1u9wp0%2BG889giclBjdptU%3D" alt="" loading="lazy"/></p>
<ol>
<li>
<p><strong>检查规则是否为空</strong>:</p>
<ul>
<li>if (rules.isEmpty()) { ... }: 如果没有规则，发出警告。</li>
</ul>
</li>
<li>
<p><strong>记录日志</strong>:</p>
<ul>
<li>记录引擎参数和输入的规则及事实。</li>
</ul>
</li>
<li>
<p><strong>遍历规则</strong>:</p>
<ul>
<li>for (Rule rule : rules) { ... }: 对每条规则进行迭代。</li>
</ul>
</li>
<li>
<p><strong>优先级检查</strong>:</p>
<ul>
<li>if (priority &gt; parameters.getPriorityThreshold()) { ... }: 检查规则优先级是否超过阈值，超过则跳过后续规则。</li>
</ul>
</li>
<li>
<p><strong>前置监听拦截检查</strong>:</p>
<ul>
<li>!shouldBeEvaluated(rule, facts): 检查规则的前置监听器是否可以被执行，这个就相当于拦截器，通过观察者的方式提前注册了观察者，然后再前置动作中进行扩展处理，设计的思路不错。</li>
</ul>
</li>
</ol>
<p>然后我们再来看下后半段：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c64c9ac3345b48cdb43a78b88765f9ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=%2B1WGopkDZUcOsapz0dDvylUv9nM%3D" alt="" loading="lazy"/></p>
<p>后半段的逻辑也非常清楚：</p>
<ol>
<li>
<p><strong>规则条件判断:</strong></p>
<ul>
<li>boolean evaluationResult = rule.evaluate(facts);: 调用规则的 evaluate 方法来判断条件是否成立。</li>
</ul>
</li>
<li>
<p><strong>异常处理</strong>:</p>
<ul>
<li>使用 try-catch 捕获过程中的异常，并根据配置决定是否跳过后续规则。</li>
</ul>
</li>
<li>
<p><strong>执行规则</strong>:</p>
<ul>
<li>rule.execute(facts);: 如果条件执行的结果为真，执行相应的动作，并记录执行成功或失败。</li>
</ul>
</li>
</ol>
<p>之前我说过动态代理，这里遍历Rule对象，也就是说实际上我们在执行evaluate方法和execute方法的时候，会执行到RuleProxy中的动态代理的方法：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4b99738060545e7983bfe5cd9bcdd6d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=d6b8mGNfM%2Fb7rCx%2Bq6LILHl9D84%3D" alt="" loading="lazy"/></p>
<p>可以看到在invoke方法中，判断方法名称是不是条件执行的方法，是不是执行具体动作的方法。</p>
<p>再看下执行条件的evaluateMethod方法实现，基本就是获取到当前规则的包含@Condition注解的方法，然后调用下，从而获取返回结果：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12e4840c9bff4c9ca0085ad52a9014ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=XiFZT%2BBDFvylz0Nfd8YU7wDkQ3s%3D" alt="" loading="lazy"/></p>
<p>真正执行的方法，也是如此：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/287043ff3c1c41d58316dd5e952985a4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770084021&amp;x-signature=ULpc4H%2BEae2nYBN3a1c3hL778R8%3D" alt="" loading="lazy"/></p>
<p>这样我们就知道了，当前这个HelloWorld这种规则是如何执行的了，我相信此时你看到如下代码，脑子中会时刻想起刚才的这些代码的底层原理：</p>
<pre><code class="hljs language-scss" lang="scss"> <span class="hljs-comment">// create facts</span>
        Facts facts = new <span class="hljs-built_in">Facts</span>();
        

        <span class="hljs-comment">// create rules</span>
        HelloWorldRule helloWorldRule = new <span class="hljs-built_in">HelloWorldRule</span>();
        
        <span class="hljs-comment">// register</span>
        Rules rules = new <span class="hljs-built_in">Rules</span>();
        rules<span class="hljs-selector-class">.register</span>(helloWorldRule);

        <span class="hljs-comment">// create a rules engine and fire rules on known facts</span>
        RulesEngine rulesEngine = new <span class="hljs-built_in">DefaultRulesEngine</span>();
        rulesEngine<span class="hljs-selector-class">.fire</span>(rules, facts);
</code></pre>
<h2 data-id="heading-14"><strong>三、总结</strong></h2>
<p>本文分享了EasyRule中的源码中的一个基本的执行流程，本质就是将我们的规则和事实信息存储到集合中，然后通过动态代理创建一个Rule对象，在规则执行的时候，先执行包含@Condition注解的方法，在执行@Action注解的方法，从而实现了一个规则的触发和执行，这里面用到了大量的设计思路，对我们个人开发设计能力的提示是非常有帮助的。</p>
<p>感兴趣的小伙伴可以交流、学习哦。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入浅出数据结构：栈 (Stack) 的 JavaScript 实现与应用]]></title>    <link>https://juejin.cn/post/7599483794657820713</link>    <guid>https://juejin.cn/post/7599483794657820713</guid>    <pubDate>2026-01-26T14:44:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599483794657820713" data-draft-id="7599483794657771561" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入浅出数据结构：栈 (Stack) 的 JavaScript 实现与应用"/> <meta itemprop="keywords" content="前端,算法"/> <meta itemprop="datePublished" content="2026-01-26T14:44:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="NEXT06"/> <meta itemprop="url" content="https://juejin.cn/user/1176918763246011"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入浅出数据结构：栈 (Stack) 的 JavaScript 实现与应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1176918763246011/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    NEXT06
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T14:44:05.000Z" title="Mon Jan 26 2026 14:44:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在计算机科学中，线性数据结构是构建复杂算法的基石。其中，<strong>栈（Stack）</strong>  凭借其独特的“后进先出”（LIFO, Last In First Out）特性，在编译器设计、内存管理、浏览器历史记录维护等场景中扮演着不可替代的角色。</p>
<p>本文将从抽象数据类型（ADT）出发，深入剖析 JavaScript 中基于数组与基于链表的两种栈实现方案，探讨其在 V8 引擎下的性能差异，并通过经典算法题展示其工程应用。</p>
<h2 data-id="heading-0">1. 核心概念与抽象数据类型 (ADT)</h2>
<p>栈是一种受限的线性表，其限制在于仅允许在表的一端（通常称为<strong>栈顶</strong>，Top）进行插入和删除操作。这一限制确立了其 LIFO 的存取原则。</p>
<h3 data-id="heading-1">1.1 运作模型</h3>
<p>栈的操作行为类似于弹匣装弹：最后压入的子弹最先被射出。</p>
<p>Mermaid</p>
<pre><code class="hljs language-css" lang="css">graph <span class="hljs-selector-tag">TD</span>
    subgraph Stack Operation
    <span class="hljs-attribute">direction</span> BT
    <span class="hljs-selector-tag">A</span><span class="hljs-selector-attr">[数据 A]</span> --&gt; <span class="hljs-selector-tag">B</span><span class="hljs-selector-attr">[数据 B]</span>
    <span class="hljs-selector-tag">B</span> --&gt; C<span class="hljs-selector-attr">[数据 C]</span>
    C --&gt;|Push 入栈| <span class="hljs-attribute">Top</span><span class="hljs-selector-attr">[栈顶 Top]</span>
    <span class="hljs-attribute">Top</span> --&gt;|Pop 出栈| C
    end
    style <span class="hljs-attribute">Top</span> fill:<span class="hljs-number">#f9f</span>,stroke:<span class="hljs-number">#333</span>,stroke-width:<span class="hljs-number">2px</span>
</code></pre>
<h3 data-id="heading-2">1.2 抽象数据类型定义</h3>
<p>既然要使用栈(stack),那就要先了解它的一些常用API</p>
<p>一个标准的栈 ADT 应当包含以下接口：</p>
<ul>
<li><strong>push(element)</strong> : 将元素压入栈顶。</li>
<li><strong>pop()</strong> : 移除并返回栈顶元素。</li>
<li><strong>peek()</strong> : 返回栈顶元素但不移除。</li>
<li><strong>isEmpty()</strong> : 判断栈是否为空。</li>
<li><strong>getSize()</strong> : 获取栈中元素的数量。</li>
</ul>
<h3 data-id="heading-3">1.3 典型应用场景</h3>
<ul>
<li><strong>函数调用栈（Call Stack）</strong> : 操作系统或虚拟机用于存储函数调用期间的上下文（局部变量、返回地址等）。</li>
<li><strong>撤销操作（Undo/Redo）</strong> : 编辑器维护的操作历史。</li>
<li><strong>语法解析</strong>: 编译器在词法分析中用于匹配括号或标签。</li>
</ul>
<hr/>
<h2 data-id="heading-4">2. JavaScript 中的两种实现方案剖析</h2>
<p>虽然 JavaScript 的原生数组（Array）提供了 push 和 pop 方法，但这属于“开箱即用”的通用列表，并未严格限制访问权限（例如允许随机访问索引）。为了构建严谨的数据结构，我们需要利用 ES6 Class 的特性进行封装。</p>
<h3 data-id="heading-5">2.1 方案 A：基于数组的封装 (ArrayStack)</h3>
<p>利用 JavaScript 数组作为底层容器。为了防止外部直接修改内部数据（例如通过索引访问），我们使用 <strong>ES6 私有类字段（Private Class Fields, #）</strong>  来实现强封装。</p>
<p>JavaScript</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 基于数组实现的栈
 * 利用 V8 引擎对连续内存的优化
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ArrayStack</span> {
    <span class="hljs-comment">// 私有属性，外部不可直接访问</span>
    #stack;

    <span class="hljs-keyword">constructor</span>() {
        <span class="hljs-keyword">this</span>.#stack = [];
    }

    <span class="hljs-comment">/**
     * 获取栈的大小
     * <span class="hljs-doctag">@returns</span> {number}
     */</span>
    <span class="hljs-keyword">get</span> size() {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.#stack.length;
    }

    <span class="hljs-comment">/**
     * 判断栈是否为空
     * <span class="hljs-doctag">@returns</span> {boolean}
     */</span>
    isEmpty() {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.#stack.length === <span class="hljs-number">0</span>;
    }

    <span class="hljs-comment">/**
     * 入栈操作
     * <span class="hljs-doctag">@param</span> {*} num 
     */</span>
    push(num) {
        <span class="hljs-keyword">this</span>.#stack.push(num);
    }

    <span class="hljs-comment">/**
     * 出栈操作
     * <span class="hljs-doctag">@returns</span> {*} 移除的元素
     */</span>
    pop() {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isEmpty()) {
            <span class="hljs-keyword">throw</span> new Error(<span class="hljs-string">"Stack Underflow: 栈为空，无法执行 pop 操作"</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.#stack.pop();
    }

    <span class="hljs-comment">/**
     * 查看栈顶元素
     * <span class="hljs-doctag">@returns</span> {*}
     */</span>
    peek() {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isEmpty()) {
            <span class="hljs-keyword">throw</span> new Error(<span class="hljs-string">"Stack is empty: 栈为空，无法执行 peek 操作"</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.#stack[<span class="hljs-keyword">this</span>.#stack.length - <span class="hljs-number">1</span>];
    }
}
</code></pre>
<h4 data-id="heading-6">性能分析</h4>
<ul>
<li><strong>时间效率</strong>：得益于 V8 引擎对数组的连续内存优化，索引访问极快。入栈操作平均时间复杂度为 <strong>O(1)</strong> 。</li>
<li><strong>扩容抖动</strong>：当底层数组容量不足时，引擎需要申请更大的内存块并将旧数据复制过去。此时单次 push 的时间复杂度会退化为 <strong>O(n)</strong> 。尽管通过<strong>摊还分析（Amortized Analysis）</strong> ，平均效率仍趋近于 O(1)，但在实时性要求极高的系统中需慎重。</li>
</ul>
<h3 data-id="heading-7">2.2 方案 B：基于链表的实现 (LinkedListStack)</h3>
<p>为了避免数组扩容带来的性能抖动，我们可以使用链表实现栈。链表节点在内存中是离散存储的，通过指针连接。</p>
<p>Mermaid</p>
<pre><code class="hljs language-css" lang="css">graph LR
    Head<span class="hljs-selector-attr">[栈顶指针 Head]</span> --&gt; Node1<span class="hljs-selector-attr">[Node 3]</span>
    Node1 --&gt; Node2<span class="hljs-selector-attr">[Node 2]</span>
    Node2 --&gt; Node3<span class="hljs-selector-attr">[Node 1]</span>
    Node3 --&gt; Null<span class="hljs-selector-attr">[null]</span>
    
    style Head fill:<span class="hljs-number">#f96</span>,stroke:<span class="hljs-number">#333</span>
</code></pre>
<p>JavaScript</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-comment">/**
 * 链表节点类
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ListNode</span> {
    <span class="hljs-keyword">constructor</span>(<span class="hljs-keyword">val</span>) {
        <span class="hljs-keyword">this</span>.<span class="hljs-keyword">val</span> = <span class="hljs-keyword">val</span>;
        <span class="hljs-keyword">this</span>.next = <span class="hljs-literal">null</span>; <span class="hljs-comment">// 指向下一个节点的指针</span>
    }
}

<span class="hljs-comment">/**
 * 基于链表实现的栈
 * 严格的 O(1) 操作，无扩容机制
 */</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">LinkedListStack</span> {
    #head; <span class="hljs-comment">// 栈顶指针</span>
    #size; <span class="hljs-comment">// 维护栈的大小</span>

    <span class="hljs-keyword">constructor</span>() {
        <span class="hljs-keyword">this</span>.#head = <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">this</span>.#size = <span class="hljs-number">0</span>;
    }

    <span class="hljs-keyword">get</span> size() {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.#size;
    }

    isEmpty() {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.#size === <span class="hljs-number">0</span>;
    }

    push(num) {
        <span class="hljs-keyword">const</span> node = new ListNode(num);
        <span class="hljs-comment">// 新节点指向当前的栈顶</span>
        node.next = <span class="hljs-keyword">this</span>.#head;
        <span class="hljs-comment">// 更新栈顶指针指向新节点</span>
        <span class="hljs-keyword">this</span>.#head = node;
        <span class="hljs-keyword">this</span>.#size++;
    }

    pop() {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isEmpty()) {
            <span class="hljs-keyword">throw</span> new Error(<span class="hljs-string">"Stack Underflow: 栈为空"</span>);
        }
        <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> = <span class="hljs-keyword">this</span>.#head.<span class="hljs-keyword">val</span>;
        <span class="hljs-comment">// 移动栈顶指针到下一个节点</span>
        <span class="hljs-keyword">this</span>.#head = <span class="hljs-keyword">this</span>.#head.next;
        <span class="hljs-keyword">this</span>.#size--;
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">val</span>;
    }

    peek() {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.isEmpty()) {
            <span class="hljs-keyword">throw</span> new Error(<span class="hljs-string">"Stack is empty"</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.#head.<span class="hljs-keyword">val</span>;
    }
}
</code></pre>
<h4 data-id="heading-8">性能与空间对比</h4>
<ul>
<li>
<p><strong>时间效率</strong>：链表实现的入栈和出栈操作是严格的 <strong>O(1)</strong> ，不存在数组的扩容机制，性能表现更加稳定。</p>
</li>
<li>
<p><strong>空间效率</strong>：</p>
<ul>
<li><strong>数组</strong>：存在空间浪费（预分配内存），但数据紧凑。</li>
<li><strong>链表</strong>：无预分配浪费，但每个元素需要额外的空间存储 next 指针。此外，由于内存地址不连续，链表对 CPU 缓存（Cache）的亲和性不如数组，可能导致缓存未命中率上升。</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-9">3. 算法实战：有效的括号 (LeetCode 20)</h2>
<p><strong>问题描述</strong>：给定一个只包括 '(', ')', '{', '}', '[', ']' 的字符串，判断字符串是否有效。有效字符串需满足：左括号必须用相同类型的右括号闭合，且闭合顺序正确。</p>
<h3 data-id="heading-10">3.1 解题思路</h3>
<p>这是栈的经典应用场景。</p>
<ol>
<li>
<p><strong>策略</strong>：遇到左括号入栈；遇到右括号，弹出栈顶元素进行匹配。</p>
</li>
<li>
<p><strong>映射维护</strong>：使用 Hash Map 存储右括号到左括号的映射，简化条件判断。</p>
</li>
<li>
<p><strong>边界条件</strong>：</p>
<ul>
<li>字符串长度为奇数，直接返回 false。</li>
<li>遍历结束后，栈必须为空（防止左括号冗余）。</li>
<li>遇到右括号时若栈为空，直接返回 false（防止右括号冗余）。</li>
</ul>
</li>
</ol>
<h3 data-id="heading-11">3.2 优化代码实现</h3>
<p>JavaScript</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-comment">/**
 * @param {string} s
 * @return {boolean}
 */</span>
<span class="hljs-type">const</span> isValid = <span class="hljs-built_in">function</span>(s) {
    <span class="hljs-comment">// 剪枝：奇数长度一定无法完全匹配</span>
    <span class="hljs-keyword">if</span> (s.length % <span class="hljs-number">2</span> !== <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

    <span class="hljs-comment">// 建立右括号到左括号的映射表</span>
    <span class="hljs-type">const</span> map = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Map</span>([
        [<span class="hljs-string">')'</span>, <span class="hljs-string">'('</span>],
        [<span class="hljs-string">']'</span>, <span class="hljs-string">'['</span>],
        [<span class="hljs-string">'}'</span>, <span class="hljs-string">'{'</span>]
    ]);

    <span class="hljs-type">const</span> stack = [];

    <span class="hljs-keyword">for</span> (let i = <span class="hljs-number">0</span>; i &lt; s.length; i++) {
        <span class="hljs-type">const</span> <span class="hljs-type">char</span> = s[i];

        <span class="hljs-comment">// 如果该字符是右括号（存在于 map 的 key 中）</span>
        <span class="hljs-keyword">if</span> (map.<span class="hljs-built_in">has</span>(<span class="hljs-type">char</span>)) {
            <span class="hljs-comment">// 获取栈顶元素，如果栈为空则 stack.pop() 返回 undefined</span>
            <span class="hljs-type">const</span> topElement = stack.<span class="hljs-built_in">pop</span>();
            
            <span class="hljs-comment">// 匹配失败：栈顶元素不是对应的左括号</span>
            <span class="hljs-keyword">if</span> (topElement !== map.<span class="hljs-built_in">get</span>(<span class="hljs-type">char</span>)) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 如果是左括号，直接入栈</span>
            stack.<span class="hljs-built_in">push</span>(<span class="hljs-type">char</span>);
        }
    }

    <span class="hljs-comment">// 只有栈被清空，才说明所有括号都正确闭合</span>
    <span class="hljs-keyword">return</span> stack.length === <span class="hljs-number">0</span>;
};
</code></pre>
<h3 data-id="heading-12">3.3 复杂度分析</h3>
<ul>
<li><strong>时间复杂度</strong>: <strong>O(n)</strong> 。我们需要遍历一次字符串，每个字符的入栈和出栈操作均为 O(1)。</li>
<li><strong>空间复杂度</strong>: <strong>O(n)</strong> 。最坏情况下（例如 (((((），栈的大小将达到字符串长度的一半。</li>
</ul>
<h2 data-id="heading-13">结语</h2>
<p>栈作为一种基础的线性数据结构，其简单的接口背后蕴含着深刻的计算机设计哲学。无论是基于数组的缓存友好型实现，还是基于链表的动态内存型实现，开发者都应根据具体场景（如是否对实时性敏感、数据量的预估）进行选择。掌握栈的底层逻辑，是通往高阶算法世界的必经之路。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手搓 onscroll 到使用 IntersectionObserver API：懒加载实战指南]]></title>    <link>https://juejin.cn/post/7599514071105896463</link>    <guid>https://juejin.cn/post/7599514071105896463</guid>    <pubDate>2026-01-26T15:28:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599514071105896463" data-draft-id="7599526246503825442" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手搓 onscroll 到使用 IntersectionObserver API：懒加载实战指南"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-26T15:28:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="无敌的拖拉斯旋风"/> <meta itemprop="url" content="https://juejin.cn/user/951508170179208"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手搓 onscroll 到使用 IntersectionObserver API：懒加载实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/951508170179208/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    无敌的拖拉斯旋风
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T15:28:51.000Z" title="Mon Jan 26 2026 15:28:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>懒加载是前端开发中一个经典且实用的技术，它能够显著提升网页性能和用户体验。今天，让我们一起从最原始的 <code>onscroll</code> 方法开始，逐步探索到现代化的 <code>IntersectionObserver API</code>，亲手实现一个完整的懒加载功能。</p>
<h2 data-id="heading-1">第一步：传统方法 - onscroll 滚动监听</h2>
<h3 data-id="heading-2">最初的尝试</h3>
<p>让我们先看看传统的滚动监听方式：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>图片的懒加载<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        * {
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
        }

        <span class="hljs-selector-class">.box</span> {
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200vh</span>;
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#eee</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 数据属性 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lazy"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"placeholder.png"</span>
        <span class="hljs-attr">data-src</span>=<span class="hljs-string">"https://example.com/image1.jpg"</span>
        <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lazy"</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"placeholder.png"</span>
        <span class="hljs-attr">data-src</span>=<span class="hljs-string">"https://example.com/image2.jpg"</span>
        <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h3 data-id="heading-3">onscroll 实现方式</h3>
<pre><code class="hljs language-ini" lang="ini">// 传统方式实现懒加载
const <span class="hljs-attr">images</span> = document.querySelectorAll(<span class="hljs-string">'.lazy'</span>)<span class="hljs-comment">;</span>

const <span class="hljs-attr">checkImages</span> = () =&gt; {
    images.forEach(<span class="hljs-attr">img</span> =&gt; {
        const <span class="hljs-attr">rect</span> = img.getBoundingClientRect()<span class="hljs-comment">;</span>
        const <span class="hljs-attr">windowHeight</span> = window.innerHeight<span class="hljs-comment">;</span>
        
        // 图片进入视口时加载
        if (rect.top &lt; windowHeight &amp;&amp; rect.bottom &gt;= 0) {
            <span class="hljs-attr">img.src</span> = img.dataset.src<span class="hljs-comment">;</span>
            img.classList.remove('lazy')<span class="hljs-comment">;</span>
        }
    })<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

// 监听滚动事件
window.addEventListener('scroll', checkImages)<span class="hljs-comment">;</span>

// 页面加载时也要检查一次
checkImages()<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-4">传统方法的问题</h3>
<p>这种方法虽然可行，但存在明显缺陷：</p>
<ol>
<li><strong>性能问题</strong>：<code>scroll</code> 事件触发频率极高，每秒可能触发几十次</li>
<li><strong>卡顿现象</strong>：频繁的 DOM 操作会导致页面卡顿</li>
<li><strong>计算开销</strong>：每次滚动都要计算所有图片的位置</li>
</ol>
<h2 data-id="heading-5">第二步：性能优化 - 节流函数</h2>
<h3 data-id="heading-6">为 onscroll 添加节流</h3>
<pre><code class="hljs language-ini" lang="ini">// 节流函数
const <span class="hljs-attr">throttle</span> = (func, delay) =&gt; {
    let timeoutId<span class="hljs-comment">;</span>
    let <span class="hljs-attr">lastExecTime</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
    
    return function (...args) {
        const <span class="hljs-attr">currentTime</span> = Date.now()<span class="hljs-comment">;</span>
        
        if (currentTime - lastExecTime &gt; delay) {
            func.apply(this, args)<span class="hljs-comment">;</span>
            <span class="hljs-attr">lastExecTime</span> = currentTime<span class="hljs-comment">;</span>
        } else {
            clearTimeout(timeoutId)<span class="hljs-comment">;</span>
            <span class="hljs-attr">timeoutId</span> = setTimeout(() =&gt; {
                func.apply(this, args)<span class="hljs-comment">;</span>
                <span class="hljs-attr">lastExecTime</span> = Date.now()<span class="hljs-comment">;</span>
            }, delay - (currentTime - lastExecTime))<span class="hljs-comment">;</span>
        }
    }<span class="hljs-comment">;</span>
}<span class="hljs-comment">;</span>

// 应用节流
window.addEventListener('scroll', throttle(checkImages, 200))<span class="hljs-comment">;</span>
</code></pre>
<p>通过节流，我们将滚动事件的处理频率限制在每200毫秒一次，有效解决了性能问题。</p>
<h2 data-id="heading-7">第三步：现代化方案 - IntersectionObserver API</h2>
<h3 data-id="heading-8">为什么选择 IntersectionObserver？</h3>
<p>随着 Web API 的发展，<code>IntersectionObserver</code> 成为了懒加载的标准方案：</p>
<ul>
<li><strong>性能优越</strong>：浏览器内部优化，无性能问题</li>
<li><strong>语法简洁</strong>：API 设计更符合现代开发习惯</li>
<li><strong>功能强大</strong>：支持多种观察选项</li>
</ul>
<h3 data-id="heading-9">基础实现</h3>
<pre><code class="hljs language-ini" lang="ini">// 使用 IntersectionObserver 实现懒加载
const <span class="hljs-attr">images</span> = document.querySelectorAll(<span class="hljs-string">'.lazy'</span>)<span class="hljs-comment">;</span>

const <span class="hljs-attr">observer</span> = new IntersectionObserver((entries) =&gt; {
    entries.forEach((entry) =&gt; {
        // 当图片进入视口时
        if (entry.isIntersecting) {
            const <span class="hljs-attr">img</span> = entry.target<span class="hljs-comment">;</span>
            <span class="hljs-attr">img.src</span> = img.dataset.src<span class="hljs-comment">;</span>
            
            // 加载完成后停止观察，提高性能
            observer.unobserve(img)<span class="hljs-comment">;</span>
        }
    })<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>

// 观察所有懒加载图片
images.forEach((img) =&gt; {
    observer.observe(img)<span class="hljs-comment">;</span>
})<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-10">完整的 HTML 示例</h3>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>图片的懒加载<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
        * {
            <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
            <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
        }

        <span class="hljs-selector-class">.box</span> {
            <span class="hljs-attribute">height</span>: <span class="hljs-number">200vh</span>;
            <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#eee</span>;
        }
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 数据属性 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lazy"</span> 
         <span class="hljs-attr">src</span>=<span class="hljs-string">"https://img10.360buyimg.com/wq/jfs/t24601/190/890984006/4559/731564fc/5b7f9b7bN3ccd29ab.png"</span>
         <span class="hljs-attr">data-src</span>=<span class="hljs-string">"https://img.36krcdn.com/hsossms/20260119/v2_53cad3f2226f48e2afc1942de3ab74e4@5888275@ai_oswg1141728oswg1053oswg495_img_png~tplv-1marlgjv7f-ai-v3:960:400:960:400:q70.jpg?x-oss-process=image/format,webp"</span>
         <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"lazy"</span> 
         <span class="hljs-attr">src</span>=<span class="hljs-string">"https://img10.360buyimg.com/wq/jfs/t24601/190/890984006/4559/731564fc/5b7f9b7bN3ccd29ab.png"</span>
         <span class="hljs-attr">data-src</span>=<span class="hljs-string">"https://img.36krcdn.com/hsossms/20260117/v2_1e74add07bb94971845c777e0ce87a49@000000@ai_oswg421938oswg1536oswg722_img_000~tplv-1marlgjv7f-ai-v3:960:400:960:400:q70.jpg?x-oss-process=image/format,webp"</span>
         <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
        <span class="hljs-comment">// 图片懒加载</span>
        <span class="hljs-keyword">const</span> images = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'.lazy'</span>);
        
        <span class="hljs-comment">// 观察对象 onScroll</span>
        <span class="hljs-comment">// 浏览器的观察者模式  自动观察 （内置的，没有性能问题）</span>
        <span class="hljs-keyword">const</span> observer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(<span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> {
            <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(entries);
            <span class="hljs-comment">// 出现在视窗内 才加载图片 </span>
            entries.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">entry</span>) =&gt;</span> {
                <span class="hljs-keyword">if</span> (entry.<span class="hljs-property">isIntersecting</span>) {
                    <span class="hljs-keyword">const</span> original_img = entry.<span class="hljs-property">target</span>;
                    original_img.<span class="hljs-property">src</span> = original_img.<span class="hljs-property">dataset</span>.<span class="hljs-property">src</span>;
                    observer.<span class="hljs-title function_">unobserve</span>(original_img);
                }
            });
        });
        
        images.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">img</span>) =&gt;</span> {
            observer.<span class="hljs-title function_">observe</span>(img);
        });
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h2 data-id="heading-11">第四步：React 中的懒加载实现</h2>
<h3 data-id="heading-12">无限滚动组件</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">interface</span> <span class="hljs-title class_">InfiniteScrollProps</span> {
    <span class="hljs-attr">hasMore</span>: <span class="hljs-built_in">boolean</span>; <span class="hljs-comment">// 是否所有数据都加载了 分页 </span>
    isLoading?: <span class="hljs-built_in">boolean</span>; <span class="hljs-comment">// 滚动到底部加载更多 避免重复触发</span>
    <span class="hljs-attr">onLoadMore</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">void</span>; <span class="hljs-comment">// 更多加载的一个抽象  /api/posts?page=2&amp;limit=10</span>
    <span class="hljs-attr">children</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">ReactNode</span> <span class="hljs-comment">// InfiniteScroll 通用的滚动功能，滚动的具体内容接受定制</span>
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">InfiniteScroll</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">InfiniteScrollProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{
    hasMore,
    onLoadMore,
    isLoading = <span class="hljs-literal">false</span>,
    children
}</span>) =&gt;</span> {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
            {children}
        <span class="hljs-tag">&lt;/&gt;</span></span>
    )
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">InfiniteScroll</span>
</code></pre>
<h3 data-id="heading-13">文章列表项组件</h3>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> <span class="hljs-title class_">React</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">import</span> { useNavigate } <span class="hljs-keyword">from</span> <span class="hljs-string">'react-router-dom'</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">Post</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/types/index'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Badge</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/ui/badge'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Avatar</span>, <span class="hljs-title class_">AvatarImage</span>, <span class="hljs-title class_">AvatarFallback</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/components/ui/avatar'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Eye</span>, <span class="hljs-title class_">Heart</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">"lucide-react"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">LazyLoad</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'react-lazy-load'</span>;

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">PostItemProps</span> {
    <span class="hljs-attr">post</span>: <span class="hljs-title class_">Post</span>;
}

<span class="hljs-keyword">const</span> <span class="hljs-title class_">PostItem</span>: <span class="hljs-title class_">React</span>.<span class="hljs-property">FC</span>&lt;<span class="hljs-title class_">PostItemProps</span>&gt; = <span class="hljs-function">(<span class="hljs-params">{ post }</span>) =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(post, <span class="hljs-string">'//////'</span>)
    <span class="hljs-keyword">const</span> navigate = <span class="hljs-title function_">useNavigate</span>();
    
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>
            <span class="hljs-attr">className</span>=<span class="hljs-string">"flex border-b border-border py-4 py-2"</span>
            // <span class="hljs-attr">动态路由</span> <span class="hljs-attr">暴露资源</span> <span class="hljs-attr">restful</span> <span class="hljs-attr">url</span> <span class="hljs-attr">资源具有描述性</span> 
            <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> { navigate(`/post/${post.id}`) }}
        &gt;
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex-1 pr-4 space-y-2"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center gap-2"</span>&gt;</span>
                    {
                        post.tags.map((tag, index) =&gt; (
                            <span class="hljs-tag">&lt;<span class="hljs-name">Badge</span>
                                <span class="hljs-attr">key</span>=<span class="hljs-string">{index}</span>
                                <span class="hljs-attr">variant</span>=<span class="hljs-string">"outline"</span>
                                <span class="hljs-attr">className</span>=<span class="hljs-string">"text-xs"</span>
                            &gt;</span>{tag}<span class="hljs-tag">&lt;/<span class="hljs-name">Badge</span>&gt;</span>
                        ))
                    }
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                
                {/* 列表里面行高的截取 */}
                <span class="hljs-tag">&lt;<span class="hljs-name">h2</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-base font-semibold leading-tight line-clamp-1"</span>&gt;</span>
                    {post.title}
                <span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"text-sm text-muted-foreground line-clamp-1"</span>&gt;</span>
                    {post.brief}
                <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center justify-between mt-2"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center gap-2 text-xs text-muted-foreground"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">Avatar</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"w-5 h-5"</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">AvatarImage</span> <span class="hljs-attr">src</span>=<span class="hljs-string">{post.user.avatar}</span> /&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">AvatarFallback</span>&gt;</span>{post.user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">AvatarFallback</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">Avatar</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{post.user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center gap-4 mt-2 text-xs text-muted-foreground"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center gap-1"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">Eye</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"w-3 h-3"</span> /&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{post.totalComments}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"flex items-center gap-1"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">Heart</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"w-3 h-3"</span> /&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>{post.totalLikes}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            
            {
                post.thumbnail &amp;&amp; (
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"w-24 h-24 flex-shrink-0 relative overflow-hidden"</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">LazyLoad</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"w-full h-full"</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">img</span>
                                <span class="hljs-attr">alt</span>=<span class="hljs-string">{post.title}</span>
                                <span class="hljs-attr">loading</span>=<span class="hljs-string">"lazy"</span>
                                <span class="hljs-attr">src</span>=<span class="hljs-string">{post.thumbnail}</span>
                                <span class="hljs-attr">className</span>=<span class="hljs-string">"w-full h-full object-cover"</span>
                            /&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">LazyLoad</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                )
            }
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">PostItem</span>
</code></pre>
<h3 data-id="heading-14">使用示例</h3>
<pre><code class="hljs language-ini" lang="ini">&lt;div <span class="hljs-attr">className</span>=<span class="hljs-string">"container mx-auto py-8"</span>&gt;
    &lt;h1 <span class="hljs-attr">className</span>=<span class="hljs-string">"text-2xl font-bold mb-6"</span>&gt;文章列表&lt;/h1&gt;
    {/* 通用的滚动到底部加载更多功能 */}
    &lt;InfiniteScroll
        <span class="hljs-attr">hasMore</span>={hasMore}
        <span class="hljs-attr">isLoading</span>={loading}
        <span class="hljs-attr">onLoadMore</span>={loadMore}
    &gt;
        &lt;ul&gt;
            {
                posts.map(<span class="hljs-attr">post</span> =&gt; (
                    &lt;PostItem
                        <span class="hljs-attr">key</span>={post.id}
                        <span class="hljs-attr">post</span>={post}
                    /&gt;
                ))
            }
        &lt;/ul&gt;
        {/* 业务组件 */}
    &lt;/InfiniteScroll&gt;
&lt;/div&gt;
</code></pre>
<h2 data-id="heading-15">第五步：最佳实践与优化</h2>
<h3 data-id="heading-16">1. 预加载策略</h3>
<pre><code class="hljs language-ini" lang="ini">const <span class="hljs-attr">observer</span> = new IntersectionObserver((entries) =&gt; {
    entries.forEach((entry) =&gt; {
        if (entry.isIntersecting) {
            const <span class="hljs-attr">img</span> = entry.target<span class="hljs-comment">;</span>
            
            // 创建新的 Image 对象预加载
            const <span class="hljs-attr">newImg</span> = new Image()<span class="hljs-comment">;</span>
            <span class="hljs-attr">newImg.onload</span> = () =&gt; {
                <span class="hljs-attr">img.src</span> = newImg.src<span class="hljs-comment">;</span>
            }<span class="hljs-comment">;</span>
            <span class="hljs-attr">newImg.src</span> = img.dataset.src<span class="hljs-comment">;</span>
            
            observer.unobserve(img)<span class="hljs-comment">;</span>
        }
    })<span class="hljs-comment">;</span>
}, {
    // 提前加载的阈值
    rootMargin: '50px'
})<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-17">2. 错误处理</h3>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">newImg.onerror</span> = () =&gt; {
    <span class="hljs-attr">img.src</span> = <span class="hljs-string">'/fallback-image.png'</span><span class="hljs-comment">; // 备用图片</span>
}<span class="hljs-comment">;</span>
</code></pre>
<h3 data-id="heading-18">3. 清理资源</h3>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 组件卸载时清理观察器</span>
<span class="hljs-built_in">useEffect</span>(() =&gt; {
    return () =&gt; {
        observer<span class="hljs-selector-class">.disconnect</span>();
    };
}, <span class="hljs-selector-attr">[]</span>);
</code></pre>
<h2 data-id="heading-19">总结</h2>
<p>从传统的 <code>onscroll</code> 事件到现代化的 <code>IntersectionObserver API</code>，懒加载技术经历了巨大的演进：</p>
<ol>
<li><strong>性能提升</strong>：从手动优化到浏览器内置优化</li>
<li><strong>代码简化</strong>：从复杂计算到简洁 API</li>
<li><strong>功能增强</strong>：从基础功能到丰富配置选项</li>
</ol>
<p>通过亲手实现这些功能，我们不仅掌握了懒加载的核心原理，更重要的是理解了前端技术的发展脉络。每一次技术革新都是为了解决实际问题，提升用户体验和开发效率。</p>
<p>现在，你可以自信地说："我不仅会用懒加载，更知道它是如何工作的！"</p>
<p><strong>动手试试吧，让你的网页加载更快，用户体验更好！</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AgentSkills经验第1节：AI时代的技能说明书基本介绍与使用]]></title>    <link>https://juejin.cn/post/7599550337384726591</link>    <guid>https://juejin.cn/post/7599550337384726591</guid>    <pubDate>2026-01-27T01:50:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599550337384726591" data-draft-id="7599550337384628287" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AgentSkills经验第1节：AI时代的技能说明书基本介绍与使用"/> <meta itemprop="keywords" content="后端,架构,AIGC"/> <meta itemprop="datePublished" content="2026-01-27T01:50:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="爱海贼的无处不在"/> <meta itemprop="url" content="https://juejin.cn/user/2359988032644541"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AgentSkills经验第1节：AI时代的技能说明书基本介绍与使用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2359988032644541/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    爱海贼的无处不在
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T01:50:28.000Z" title="Tue Jan 27 2026 01:50:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前言</h2>
<p>今天我来分享一个在 2025 年 AI 圈子非常火的话题——AgentSkills(Claude Skills)，这个东西预计在2026年的生态将会越来越大，</p>
<p>如果你最近在关注 AI 智能体（Agent），你可能发现现在的 AI 已经不只是能“聊天”了，它们正在变得越来越像“数字员工”。而让这些员工变聪明的其中一个秘诀，就是这个由 Anthropic 最近牵头搞出来的开源标准：<strong>AgentSkills</strong>。早期的时候叫Claude Skills，后来变成了大家可以按照约定使用的标准。</p>
<p>以前我们要让 AI 完成一个复杂任务（比如：帮你写代码、部署测试环境、或者按照公司品牌规范写推文），我们通常需要写一段超长的 <strong>Prompt（提示词）</strong> 。</p>
<p>但问题是：提示词太长了 AI 容易忘，而且每次都要重新教一遍，非常心累。AI可能需要通过多次调用工具能力获取和处理这部分的能力，导致Token无限消耗。</p>
<p><strong>AgentSkills</strong> 的出现就是为了解决这个问题。简单来说，它给 AI 制定了一套<strong>标准技能包</strong>。你可以把它想象成给 AI 的“岗位操作手册”或“说明书”。一旦你写好了这个技能包，任何支持该标准的 AI（比如 Claude、或者集成了 GitHub Copilot 的工具）都能瞬间学会这门手艺，且执行得非常稳。</p>
<p>目前官方的网站为：<a href="https://link.juejin.cn?target=https%3A%2F%2Fagentskills.io%2Fhome" target="_blank" title="https://agentskills.io/home" ref="nofollow noopener noreferrer">agentskills.io/home</a></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/108c67846d8546a0be2bca50d4307a12~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083428&amp;x-signature=lG7bE9mbxXt7RRAovn2pASMRzgs%3D" alt="" loading="lazy"/></p>
<p><strong>官方的定义如下：</strong></p>
<p><strong>Agent Skills 是一种简单、开放的格式，用于赋予 AI 智能体（Agents）新的能力和专业知识。</strong></p>
<p>Agent Skills 本质上是一个包含<strong>指令（Instructions）</strong> 、脚本（Scripts）<strong>和</strong>资源（Resources）的文件夹。智能体可以识别并利用这些文件夹，从而更准确、更高效地执行任务。</p>
<p><strong>同时官方也解释了为什么需要Agent Skills？</strong></p>
<p>原因在于，虽然现在的 AI 智能体能力越来越强，但它们往往缺乏开展实际工作所需的“上下文”。</p>
<p>Agent Skills 通过为智能体提供<strong>程序性知识</strong>，以及针对特定公司、团队或用户的<strong>定制化背景信息</strong>，解决了这一问题。智能体可以根据正在处理的任务，按需加载这些技能。</p>
<ol>
<li><strong>对于技能开发者：</strong> 只需开发一次技能，即可在多个支持该标准的智能体产品中部署。</li>
<li><strong>对于兼容的智能体：</strong> 支持该标准后，最终用户可以开箱即用地为智能体添加新功能。</li>
<li><strong>对于团队和企业：</strong> 能够以可移植、可进行版本控制的包形式，沉淀并管理组织内部的知识。</li>
</ol>
<p><strong>Agent Skills 能实现什么？</strong></p>
<ol>
<li><strong>领域专家化：</strong> 将专业知识（如法律审查流程、数据分析管道）封装成可复用的指令。</li>
<li><strong>扩展新功能：</strong> 让智能体学会制作演示文稿（PPT）、构建 MCP 服务器、分析大型数据集等。</li>
<li><strong>可重复的工作流：</strong> 将多步骤的复杂任务转变为一致且可审计的标准流程。</li>
<li><strong>互操作性：</strong> 在不同的支持 Agent Skills 的 AI 产品之间重复使用同一个技能。</li>
</ol>
<p>目前很多工具都集成了Skills的自动支持，并得到了一系列领先 AI 开发工具的支持，包括：</p>
<ol>
<li><strong>编辑器/平台：</strong> Cursor, VS Code, GitHub, Claude Code, OpenCode，QwenCode。</li>
<li><strong>框架/工具：</strong> Claude, OpenAI Codex, Letta, Goose, Amp, Factory。</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4378d38e69964b33a00948546fbcf450~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083428&amp;x-signature=b%2FwC6qnIs9jb68GAPyyItcHlMF4%3D" alt="nano_banana_pro_2026-01-27T01-43-50-438Z.jpeg" loading="lazy"/></p>
<h2 data-id="heading-1">二、正文：AgentSkills 到底怎么玩？</h2>
<h3 data-id="heading-2">2.1、基本约定</h3>
<p>从技术角度看，AgentSkills 是一个开源的、标准化的文件夹格式。它告诉 AI 在遇到特定任务时，应该遵循什么样的步骤、调用哪些脚本、参考哪些资料。</p>
<p>灵魂文件：SKILL.md</p>
<p>一个典型的 Agent Skill 其实就是一个文件夹，里面最核心的文件叫 SKILL.md。它的长相通常是这样的：</p>
<ul>
<li><strong>元数据（YAML Frontmatter）：</strong> 定义技能的名字、描述（让 AI 知道什么时候该用这个技能）。</li>
<li><strong>指令（Instructions）：</strong> 详细的步骤，告诉 AI 第一步干啥，第二步干啥。告诉智能体如何执行特定任务的详细指南。</li>
<li><strong>资源（Resources）：</strong> 文件夹里可以放相关的 Python 脚本、JS/TS脚本、模板文件或数据文件。技能还可以捆绑脚本、模板和参考资料。</li>
</ul>
<p>一个典型的目录结构如下：</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">my</span>-skill/
├── SKILL.md       <span class="hljs-comment"># 必选：包含指令和元数据</span>
├── scripts/       <span class="hljs-comment"># 可选：可执行代码</span>
├── references/    <span class="hljs-comment"># 可选：文档资料</span>
└── assets/        <span class="hljs-comment"># 可选：模板、资源文件</span>
</code></pre>
<p>我们只需要模拟并创建这样的一个技能的约定格式就行，从目录结构看一个“技能”就是一个独立的目录。其基本结构如下：</p>
<ul>
<li><strong>SKILL.md (必选)</strong> ：技能的核心配置文件，包含指令和元数据。</li>
<li><strong>scripts/ (可选)</strong> ：存放该技能需要执行的代码脚本（如 Python、Bash）。</li>
<li><strong>references/ (可选)</strong> ：存放长篇文档、API 参考或背景资料。</li>
<li><strong>assets/ (可选)</strong> ：存放模板、静态文件或其他资源。</li>
</ul>
<p><strong>注意</strong>：目录的名称必须与 SKILL.md 中定义的 name 字段完全一致。</p>
<p>元数据区中的</p>
<p>name，必须是1-64 字符。仅限小写字母、数字和连字符（-），必须与文件夹名匹配。</p>
<p>description：1-1024 字符。描述技能的作用以及“何时”该用它（智能体靠它来判断意图）。</p>
<p>元数据下方即为正文。这是给 AI 看的“操作手册”。</p>
<p>如果需要操作，执行步骤很简单：</p>
<ol>
<li>在你的项目里新建个目录：.github/skills/我的超强技能/ 或 .claude/skills/我的超强技能/</li>
<li>在里面写个 SKILL.md。</li>
<li>在文件开头写上：</li>
</ol>

<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">name: webapp-testing</span>
<span class="hljs-section">description: 当用户要求测试网页时，请使用此技能。</span>
</code></pre>
<p>解释如下：</p>
<p><strong>name:</strong> 简短的唯一标识符。</p>
<p><strong>description:</strong> 描述该技能的使用场景（这对于智能体判断何时调用至关重要）。</p>
<p>然后再用 Markdown 写清楚具体怎么测。</p>
<p>支持的 AI Agent 或AI编码工具看到这个文件夹，就会自动把它加入自己的技能库。</p>
<h3 data-id="heading-3">2.2、VSCode使用Skills</h3>
<p>首先我们更新最新版的VSCode，然后再设置中开启支持：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44804eca9875458a8058cc1f2bc1528b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083428&amp;x-signature=XyiRf%2BvYVhCwaYoEZ%2Ftj%2BHT3kNo%3D" alt="" loading="lazy"/></p>
<p>然后我们在项目的工作目录下创建.claude/skills文件夹，这里我们也可以导入官方的实例的Skills库，帮助我们更容易的创建一个标准的Skill，非常方便。</p>
<p>这里我导入了一些Claude提供的Skill示例：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2d8e59a61e9481fa509dba8dc3899d9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083428&amp;x-signature=xHBaDnzYnlIBqjPkma7pKiED4L8%3D" alt="" loading="lazy"/></p>
<p>这些技能的实例可以帮助我们了解一个技能的目录结构、基本编写是什么样的，多数可以看到他就是一个个的SOP服务。</p>
<p>这里提供了一个skill-creator的技能的，这个技能是用来创建技能的，我们有时候可以让AI根据我们自己的想法创建出来一些新的技能，在Github Copilot中，我们可以问：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d3d6ca3616234aaab4fe0da61f47e758~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083428&amp;x-signature=rzJAb%2B4jXNQaWJznWLqqghqcTIw%3D" alt="" loading="lazy"/></p>
<p>可以看到这个技能根据我们的需求，自动给我们创建了个新的技能，展示执行过程，可以看到它先读取到了匹配的技能文件，然后根据文件中的要求加载后创建了技能：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/50fca3d91c51441aa28ea271e7801ae1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083428&amp;x-signature=zpgb7My3E6F9RtogKr3ySoXd85w%3D" alt="" loading="lazy"/></p>
<p>这个新技能的文件截图如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c3544780fda4a65be3ec09dfce5f173~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083428&amp;x-signature=aWDVw27Mh0fhnViPDi7H9QLknwE%3D" alt="" loading="lazy"/></p>
<p>目前有很多的技能市场服务、技能仓库，可以给我们提供示例进行学习：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FComposioHQ%2Fawesome-claude-skillshttps%3A%2F%2Fgithub.com%2FVoltAgent%2Fawesome-claude-skillshttps%3A%2F%2Fgithub.com%2FBehiSecc%2Fawesome-claude-skills" target="_blank" title="https://github.com/ComposioHQ/awesome-claude-skillshttps://github.com/VoltAgent/awesome-claude-skillshttps://github.com/BehiSecc/awesome-claude-skills" ref="nofollow noopener noreferrer">github.com/ComposioHQ/…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FComposioHQ%2Fawesome-claude-skillshttps%3A%2F%2Fgithub.com%2FVoltAgent%2Fawesome-claude-skillshttps%3A%2F%2Fgithub.com%2FBehiSecc%2Fawesome-claude-skills" target="_blank" title="https://github.com/ComposioHQ/awesome-claude-skillshttps://github.com/VoltAgent/awesome-claude-skillshttps://github.com/BehiSecc/awesome-claude-skills" ref="nofollow noopener noreferrer">github.com/VoltAgent/a…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FComposioHQ%2Fawesome-claude-skillshttps%3A%2F%2Fgithub.com%2FVoltAgent%2Fawesome-claude-skillshttps%3A%2F%2Fgithub.com%2FBehiSecc%2Fawesome-claude-skills" target="_blank" title="https://github.com/ComposioHQ/awesome-claude-skillshttps://github.com/VoltAgent/awesome-claude-skillshttps://github.com/BehiSecc/awesome-claude-skills" ref="nofollow noopener noreferrer">github.com/BehiSecc/aw…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanthropics%2Fskills" target="_blank" title="https://github.com/anthropics/skills" ref="nofollow noopener noreferrer">github.com/anthropics/…</a></p>
<p>那么技能这个东西的原理到底如何实现了，本质核心是【技能提示词指令】，这些IDE工具的AI编码助手会读取技能文件夹树结构，然后注入到和AI交互的提示词中，结构类似如下：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">available_skills</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">skill</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>pdf-processing<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Extracts text and tables from PDF files, fills forms, merges documents.<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">location</span>&gt;</span>/path/to/skills/pdf-processing/SKILL.md<span class="hljs-tag">&lt;/<span class="hljs-name">location</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">skill</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">skill</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>data-analysis<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Analyzes datasets, generates charts, and creates summary reports.<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">location</span>&gt;</span>/path/to/skills/data-analysis/SKILL.md<span class="hljs-tag">&lt;/<span class="hljs-name">location</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">skill</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">available_skills</span>&gt;</span>
</code></pre>
<p>我们来看看Github Copilot中，实际的请求的报文，看看它是如何处理的：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41ece33c0fda4090bf75357a84c51d33~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083428&amp;x-signature=uWspgZQaxDBetYdnmvrPsdyWeDA%3D" alt="" loading="lazy"/></p>
<p>展开这个日志交互后，可以看到它也是拼接了技能的XML格式指令提示词，给到了大模型：</p>
<p>代码提示词如下：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">instructions</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">skills</span>&gt;</span>
Here is a list of skills that contain domain specific knowledge on a variety of topics.
Each skill comes with a description of the topic and a file path that contains the detailed instructions.
When a user asks you to perform a task that falls within the domain of a skill, use the 'read_file' tool to acquire the full instructions from the file URI.
<span class="hljs-tag">&lt;<span class="hljs-name">skill</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>brand-guidelines<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Applies Anthropic's official brand colors and typography to any sort of artifact that may benefit from having Anthropic's look-and-feel. Use it when brand colors or style guidelines, visual formatting, or company design standards apply.<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>d:\develop.claude\skills\brand-guidelines\SKILL.md<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">skill</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">skill</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>doc-coauthoring<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Guide users through a structured workflow for co-authoring documentation. Use when user wants to write documentation, proposals, technical specs, decision docs, or similar structured content. This workflow helps users efficiently transfer context, refine content through iteration, and verify the doc works for readers. Trigger when user mentions writing docs, creating proposals, drafting specs, or similar documentation tasks.<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>d:\develop.claude\skills\doc-coauthoring\SKILL.md<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">skill</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">skill</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span>algorithmic-art<span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Creating algorithmic art using p5.js with seeded randomness and interactive parameter exploration. Use this when users request creating art using code, generative art, algorithmic art, flow fields, or particle systems. Create original algorithmic art rather than copying existing artists' work to avoid copyright violations.<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">file</span>&gt;</span>d:\develop.claude\skills\algorithmic-art\SKILL.md<span class="hljs-tag">&lt;/<span class="hljs-name">file</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">skill</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">instructions</span>&gt;</span>
</code></pre>
<p>这样下来是不是很简单了。</p>
<p>claude-skills的第一性原理的文章：<a href="https://link.juejin.cn?target=https%3A%2F%2Fleehanchung.github.io%2Fblogs%2F2025%2F10%2F26%2Fclaude-skills-deep-dive" target="_blank" title="https://leehanchung.github.io/blogs/2025/10/26/claude-skills-deep-dive" ref="nofollow noopener noreferrer">leehanchung.github.io/blogs/2025/…</a></p>
<p>目前Skills的生态有很多，比如OpenSkills、Skill市场、Skill仓库都是围绕技能的一些分享。未来每个人都可以把自己的经验维护成技能进行使用。</p>
<p>网友总结道：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%2FUjZAqvkfk8AzpOoK1KV0yw" target="_blank" title="https://mp.weixin.qq.com/s/UjZAqvkfk8AzpOoK1KV0yw" ref="nofollow noopener noreferrer">mp.weixin.qq.com/s/UjZAqvkfk…</a></p>
<blockquote>
<p>在很多人还沉迷在“写花式 Prompt”，但从 Skills / Projects / MCP / Subagents 这套组合来看，趋势已经非常明显：</p>
<p>做 AI 产品，如果只停留在 Prompt 层，就是停留在 Demo 层，要往真正的“业务系统”走，就绕不开流程工程和 Skill 设计。</p>
<p>现在已经用 Skills 做很多件事：</p>
<p>—— 一个是【写公众号 Skill】，比如标题怎么写，导语怎么设计，配图比例怎么选，都写在里面；</p>
<p>—— 一个是【代码性能分析 Skill】，性能涉及到很多方面，比如数据库设计（索引、事务等）、Redis和数据库的配合、代码的算法和架构等等。缓存策略等等，单独靠MCP或Subagent是很难完成的，需要一整套流派。</p>
<p>—— 一个是【产品更新日志 Skill】，我只管往里丢 changelog，它会自动帮我改成对用户友好的版本。</p>
<p>—— 一个是【产gidea头脑风暴 Skill】，我有新奇idea的时候，不再用直接提问ChatGPT，而是有一个特定的流派。</p>
<p>—— 一个是【域名讨论 Skill】，做新产品时，想核名/查一个头疼的事，可以通过Skill来找到后选域名，查询是否可用</p>
<p>……</p>
</blockquote>
<p><strong>Prompt Engineering 只是上半场，真正的下半场，是「流程工程（Workflow / Skill Engineering）」。</strong></p>
<ul>
<li>Prompt 解决的是「怎么和模型说话」</li>
<li>Skill/Project/Subagent/MCP 解决的是</li>
<li>「模型在一个复杂环境下，怎么长期、稳定、可维护地为你干活」</li>
</ul>
<h2 data-id="heading-4">三、总结</h2>
<p>在 2026 年的今天，AI 的底层逻辑已经很强了，拉开差距的地方就在于私有技能的沉淀。</p>
<p><strong>AgentSkills</strong> 不仅仅是一个技术标准，它其实代表了一种工作流的封装。无论你是程序员、行政还是数据分析师，如果你能把自己的“独门绝技”整理成一个个标准化的 Skill，你就是在打造一个独属于你的、极度高效的 AI 团队。</p>
<p><strong>我的建议是：</strong> 如果你手里有一些经常需要重复给 AI 下达的复杂指令，不妨现在就尝试把它们改写成 SKILL.md 的格式。你会发现，AI 的“智商”瞬间就提上去了！</p>
<p>1、技能是如何工作的？</p>
<p>技能采用 <strong>“渐进式披露（Progressive Disclosure）”</strong> 机制，以高效管理上下文：</p>
<ol>
<li>
<p><strong>发现（Discovery）：</strong> 启动时，智能体仅加载每个可用技能的“名称”和“描述”。这足以让它知道该技能何时可能派上用场。</p>
</li>
<li>
<p><strong>激活（Activation）：</strong> 当任务与技能描述匹配时，智能体才会将 SKILL.md 中的完整指令读取到上下文（Context）中。</p>
</li>
<li>
<p><strong>执行（Execution）：</strong> 智能体遵循指令操作，根据需要加载引用的文件或执行捆绑的代码。</p>
</li>
</ol>
<p>如果把 AI 智能体比作一个“新员工”，那么 <strong>Agent Skills</strong> 就是一份份岗位说明书+工具箱。它不只是告诉 AI 该做什么，还把做这件事需要的脚本工具和参考资料打包在一起，让 AI 拿来就能用，且保证每次做得都一样专业。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f315e8ac9c824924bf98ff09b643f04e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083428&amp;x-signature=T%2B93AC116%2FflhtI0uXdZNJ4cgwY%3D" alt="nano_banana_pro_2026-01-27T01-46-56-189Z.jpeg" loading="lazy"/></p>
<p>大家最近可能还听过 <strong>MCP（Model Context Protocol）</strong> 。</p>
<p>这里有个很形象的比喻：</p>
<ul>
<li><strong>MCP 是 AI 的“手”：</strong> 它解决了“连接”问题。比如 AI 怎么连上你的数据库、怎么打开你的谷歌搜索。</li>
<li><strong>AgentSkills 是 AI 的“脑”：</strong> 它解决了“能力”问题。即使 AI 拿到了数据库权限（有手了），它还得知道“按照公司审计流程，应该如何查询异常数据”（这就是技能）。</li>
</ul>
<p><strong>一句话总结：</strong> MCP 让 AI “够得到”工具，AgentSkills 教 AI “怎么用”工具。</p>
<p>它和其他2个概念的对比如下：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a61bbcb6dc62414d84ee95a5582fb6c0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54ix5rW36LS855qE5peg5aSE5LiN5Zyo:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770083428&amp;x-signature=1UTJ%2BadIlVL%2B2NB51z1gw4eT1Os%3D" alt="" loading="lazy"/></p>
<p>参考资料如下：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.53ai.com%2Fnews%2Fzhinengkefu%2F2025103051368.html" target="_blank" title="https://www.53ai.com/news/zhinengkefu/2025103051368.html" ref="nofollow noopener noreferrer">www.53ai.com/news/zhinen…</a></p>
<p>通往AGI之路的飞书云文档的Skills分享：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwaytoagi.feishu.cn%2Fwiki%2FRgZrwqNmdiEXrWkA7sPc7WDfnmh%3Ffrom%3Dspace_search" target="_blank" title="https://waytoagi.feishu.cn/wiki/RgZrwqNmdiEXrWkA7sPc7WDfnmh?from=space_search" ref="nofollow noopener noreferrer">waytoagi.feishu.cn/wiki/RgZrwq…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwaytoagi.feishu.cn%2Fwiki%2FY3TPwfCjTik8YKkFUNtct5g8ntN%3Ffrom%3Dspace_search" target="_blank" title="https://waytoagi.feishu.cn/wiki/Y3TPwfCjTik8YKkFUNtct5g8ntN?from=space_search" ref="nofollow noopener noreferrer">waytoagi.feishu.cn/wiki/Y3TPwf…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwaytoagi.feishu.cn%2Fwiki%2FW7qbwhK1BiYwNnkybgIcRHxMn5g" target="_blank" title="https://waytoagi.feishu.cn/wiki/W7qbwhK1BiYwNnkybgIcRHxMn5g" ref="nofollow noopener noreferrer">waytoagi.feishu.cn/wiki/W7qbwh…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwaytoagi.feishu.cn%2Fwiki%2FNWQKwGyupiENv3kwnIScj7Fbnxe" target="_blank" title="https://waytoagi.feishu.cn/wiki/NWQKwGyupiENv3kwnIScj7Fbnxe" ref="nofollow noopener noreferrer">waytoagi.feishu.cn/wiki/NWQKwG…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[拒绝背诵：从底层机制彻底搞懂 JavaScript 事件监听与实战]]></title>    <link>https://juejin.cn/post/7599483794657886249</link>    <guid>https://juejin.cn/post/7599483794657886249</guid>    <pubDate>2026-01-26T15:13:16.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599483794657886249" data-draft-id="7599511763987546166" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="拒绝背诵：从底层机制彻底搞懂 JavaScript 事件监听与实战"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-26T15:13:16.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="NEXT06"/> <meta itemprop="url" content="https://juejin.cn/user/1176918763246011"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            拒绝背诵：从底层机制彻底搞懂 JavaScript 事件监听与实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1176918763246011/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    NEXT06
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T15:13:16.000Z" title="Mon Jan 26 2026 15:13:16 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前端面试中，"事件流"、"冒泡与捕获"、"事件委托"几乎是必考题。然而，很多开发者对这些概念的理解仅停留在背诵教科书定义的层面。</p>
<ul>
<li>"为什么点击子元素，父元素也会触发？"</li>
<li>"React/Vue 的合成事件系统（SyntheticEvent）为什么要挂载在 root 节点上？"</li>
<li>"在移动端开发中，为什么会遇到点击穿透问题？"</li>
</ul>
<p>要回答这些问题，单纯记忆 API 是不够的。浏览器中的事件系统不仅仅是简单的 click 响应，它本质上是一套严密的<strong>消息传递系统</strong>。本文将抛弃死记硬背的学习方式，从历史演变、底层机制到工程实战，带你彻底重构对 JavaScript 事件机制的认知。</p>
<h2 data-id="heading-0">1. 事件监听的“前身”与进化</h2>
<p>在 addEventListener 成为标准之前，前端开发者经历过一段混乱的时期。理解这段历史，有助于明白为什么现代标准是如今的样子。</p>
<h3 data-id="heading-1">DOM 0 级事件：简陋的开端</h3>
<p>早期的 JavaScript 事件绑定非常直接，将函数赋值给 DOM 元素的属性：</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> btn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'btn'</span>);

<span class="hljs-comment">// 注册</span>
btn.<span class="hljs-property">onclick</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Handler 1'</span>);
};

<span class="hljs-comment">// 缺陷：覆盖</span>
btn.<span class="hljs-property">onclick</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Handler 2'</span>); <span class="hljs-comment">// Handler 1 将永远不会执行</span>
};
</code></pre>
<p><strong>痛点分析：</strong></p>
<ol>
<li><strong>单一性</strong>：同名事件只能绑定一个处理函数，后写的会覆盖先写的，这在多人协作或组件化开发中是灾难性的。</li>
<li><strong>阶段受限</strong>：DOM 0 级事件仅支持<strong>冒泡阶段</strong>，无法在捕获阶段进行拦截，缺乏控制力。</li>
<li><strong>逻辑耦合</strong>：事件处理逻辑直接挂载在 DOM 对象属性上，容易导致内存泄漏且难以维护。</li>
</ol>
<h3 data-id="heading-2">DOM 2 级事件：标准化的曙光</h3>
<p>为了解决上述问题，W3C 推出了 DOM 2 级事件模型，引入了 addEventListener。</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> btn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'btn'</span>);

<span class="hljs-comment">// 支持多监听器</span>
btn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, handler1, <span class="hljs-literal">false</span>);
btn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, handler2, <span class="hljs-literal">false</span>); 

<span class="hljs-comment">// 核心签名</span>
<span class="hljs-comment">// element.addEventListener(eventType, listener, useCapture/options);</span>
</code></pre>
<p><strong>优势对比：</strong></p>
<ul>
<li><strong>多播机制</strong>：允许在一个元素上绑定多个同类型事件，按注册顺序依次执行。</li>
<li><strong>流控制</strong>：第三个参数 useCapture (或 options 对象) 赋予了开发者控制事件在<strong>捕获</strong>还是<strong>冒泡</strong>阶段执行的能力。</li>
</ul>
<h2 data-id="heading-3">2. 事件机制的“作用”与核心流程</h2>
<p>为什么点击屏幕上一个像素，浏览器能精准地知道要触发哪些回调？这依赖于 DOM 事件流（Event Flow）。</p>
<h3 data-id="heading-4">事件流三部曲</h3>
<p>当一个事件发生时，它不会直接命中目标，而是经历一次完整的“往返跑”。</p>
<p>Mermaid</p>
<pre><code class="hljs language-css" lang="css">graph <span class="hljs-selector-tag">TD</span>
    subgraph EventFlow
    <span class="hljs-attribute">direction</span> TB
    Window<span class="hljs-selector-attr">[Window]</span> --&gt;|<span class="hljs-number">1</span>. 捕获阶段 Capturing| Doc<span class="hljs-selector-attr">[Document]</span>
    Doc --&gt; <span class="hljs-selector-tag">HTML</span><span class="hljs-selector-attr">[HTML]</span>
    <span class="hljs-selector-tag">HTML</span> --&gt; <span class="hljs-selector-tag">Body</span><span class="hljs-selector-attr">[Body]</span>
    <span class="hljs-selector-tag">Body</span> --&gt; Parent<span class="hljs-selector-attr">[Parent Div]</span>
    Parent --&gt;|<span class="hljs-number">2</span>. 目标阶段 Target| Child<span class="hljs-selector-attr">[Target: Child Div]</span>
    
    Child --&gt;|<span class="hljs-number">3</span>. 冒泡阶段 Bubbling| Parent
    Parent --&gt; <span class="hljs-selector-tag">Body</span>
    <span class="hljs-selector-tag">Body</span> --&gt; <span class="hljs-selector-tag">HTML</span>
    <span class="hljs-selector-tag">HTML</span> --&gt; Doc
    Doc --&gt; Window
    end
    
    style Child fill:<span class="hljs-number">#f96</span>,stroke:<span class="hljs-number">#333</span>,stroke-width:<span class="hljs-number">2px</span>
</code></pre>
<ol>
<li><strong>捕获阶段 (Capturing Phase)</strong> ：事件从 Window 顶层对象发出，逐层向下查找，直到到达目标元素的父级。这个阶段旨在给上层容器拦截事件的机会。</li>
<li><strong>目标阶段 (Target Phase)</strong> ：事件到达实际被点击的元素（event.target）。</li>
<li><strong>冒泡阶段 (Bubbling Phase)</strong> ：事件从目标元素开始，逐层向上回传，直到 Window。绝大多数业务逻辑（如点击响应）都默认发生在这个阶段。</li>
</ol>
<h3 data-id="heading-5">关键 API 深度辨析</h3>
<p>在实际开发中，精准控制事件流向是架构师的基本功。</p>
<h4 data-id="heading-6">event.stopPropagation()</h4>
<p>这个方法用于阻止事件在 DOM 树中的进一步传播（无论是捕获还是冒泡）。</p>
<p>参考以下场景</p>
<ul>
<li>父容器监听了 click（冒泡阶段）。</li>
<li>子容器监听了 click，但调用了 event.stopPropagation()。</li>
</ul>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// Parent Listener</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'parent'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Parent Clicked'</span>); 
}, <span class="hljs-literal">false</span>); <span class="hljs-comment">// false 表示在冒泡阶段触发</span>

<span class="hljs-comment">// Child Listener</span>
<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'child'</span>).<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
    <span class="hljs-comment">// 关键点：切断传播链路</span>
    event.<span class="hljs-title function_">stopPropagation</span>();
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Child Clicked'</span>);
}, <span class="hljs-literal">false</span>);
</code></pre>
<p><strong>执行结果</strong>：控制台仅输出 "Child Clicked"。父元素的监听器虽已注册，但由于传播链路在子元素处被物理截断，事件永远无法“冒泡”到父元素。</p>
<h4 data-id="heading-7">event.stopImmediatePropagation()</h4>
<p>这是 stopPropagation 的加强版。如果一个元素上绑定了多个 click 监听器：</p>
<ol>
<li>stopPropagation 只能阻止事件传播到<strong>父级</strong>，同级的其他监听器照常执行。</li>
<li>stopImmediatePropagation 不仅阻止传播到父级，还会阻止<strong>当前元素上后续注册的监听器</strong>执行。</li>
</ol>
<p>这在处理第三方库冲突或组件内部逻辑优先级时非常有用。</p>
<h2 data-id="heading-8">3. 应用场景与工程实战</h2>
<p>理解底层机制的最终目的是写出高性能、可维护的代码。<strong>事件委托 (Event Delegation)</strong>  是最经典的应用场景。</p>
<h3 data-id="heading-9">内存泄漏的陷阱</h3>
<p>假设我们有一个包含 1000 个列表项的 ul，新手往往会这样写：</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">//  错误示范：性能杀手</span>
<span class="hljs-keyword">const</span> listItems = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelectorAll</span>(<span class="hljs-string">'li'</span>);
listItems.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> {
    item.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Clicked'</span>);
    });
});
</code></pre>
<p><strong>原理分析</strong>：</p>
<ol>
<li><strong>内存开销</strong>：浏览器需要创建 1000 个监听器对象，占用大量堆内存。</li>
<li><strong>动态失效</strong>：如果通过 AJAX 新增了一个 li，由于没有绑定监听器，点击无效。这也是导致 bug 的常见原因。</li>
</ol>
<h3 data-id="heading-10">终极解决方案：事件委托</h3>
<p>利用<strong>冒泡机制</strong>，我们将监听器绑定在父容器（如 ul）上。无论子元素点击哪里，事件最终都会冒泡到父容器。</p>
<p>以下是修正并优化后的实战代码</p>
<p>JavaScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">//  最佳实践</span>
<span class="hljs-keyword">const</span> list = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'list'</span>); 

list.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">function</span>(<span class="hljs-params">event</span>) {
    <span class="hljs-comment">// 1. 获取点击的实际目标</span>
    <span class="hljs-keyword">let</span> target = event.<span class="hljs-property">target</span>;
    
    <span class="hljs-comment">// 2. 核心优化：Element.closest()</span>
    <span class="hljs-comment">// 如果 li 内部包含 span 或 icon，event.target 可能是 span</span>
    <span class="hljs-comment">// 使用 closest 向上查找最近的 li，确保逻辑正确</span>
    <span class="hljs-keyword">const</span> listItem = target.<span class="hljs-title function_">closest</span>(<span class="hljs-string">'li'</span>);

    <span class="hljs-comment">// 3. 边界防御</span>
    <span class="hljs-comment">// 确保找到的是 li，且该 li 确实属于当前的 list 容器</span>
    <span class="hljs-keyword">if</span> (listItem &amp;&amp; list.<span class="hljs-title function_">contains</span>(listItem)) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'选中的内容:'</span>, listItem.<span class="hljs-property">innerHTML</span>);
        <span class="hljs-comment">// 执行业务逻辑...</span>
    }
});
</code></pre>
<p><strong>代码解析</strong>：</p>
<ul>
<li><strong>closest 垫片</strong>：这是事件委托中被忽视的细节。如果 li 中包含 <span>123</span>，点击 span 时 event.target 是 span，直接取 innerHTML 可能是错误的。使用 closest('li') 可以完美解决嵌套点击问题。</li>
</ul>
<h3 data-id="heading-11">区分 target 与 currentTarget</h3>
<p>这是调试事件委托时的混淆高发区：</p>




















<table><thead><tr><th>属性</th><th>含义</th><th>形象比喻</th></tr></thead><tbody><tr><td><strong>event.target</strong></td><td>实际触发事件的元素（如被点击的 li 或 span）</td><td>案发现场</td></tr><tr><td><strong>event.currentTarget</strong></td><td>绑定监听器的元素（如 ul），等同于事件回调中的 this</td><td>监听哨所</td></tr></tbody></table>
<p>在事件委托中，我们通常操作 target 来获取数据，操作 currentTarget 来控制监听器的状态。</p>
<h2 data-id="heading-12">4. 总结</h2>
<p>JavaScript 的事件机制并非简单的 API 调用，它是浏览器处理用户交互的底层逻辑基石。</p>
<ol>
<li><strong>历史观</strong>：从 DOM 0 到 DOM 2，是前端工程化对解耦和复用的必然要求。</li>
<li><strong>机制观</strong>：捕获与冒泡构成了事件流的闭环，stopPropagation 是控制这一流向的阀门。</li>
<li><strong>实战观</strong>：通过事件委托，我们将 O(N) 的空间复杂度优化为 O(1)，并利用 closest 等 API 处理复杂的 DOM 结构。</li>
</ol>
<p>React 和 Vue 等现代框架的合成事件系统，本质上就是一套在顶层（document 或 root）进行<strong>全量事件委托</strong>的封装实现。彻底掌握原生事件机制，是成为高级前端工程师的必经之路。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android 15存储子系统深度解析（三）：FBE加密文件系统与存储性能优化实战]]></title>    <link>https://juejin.cn/post/7599330434427158579</link>    <guid>https://juejin.cn/post/7599330434427158579</guid>    <pubDate>2026-01-26T12:06:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599330434427158579" data-draft-id="7599478406238470153" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android 15存储子系统深度解析（三）：FBE加密文件系统与存储性能优化实战"/> <meta itemprop="keywords" content="Android,源码阅读,源码"/> <meta itemprop="datePublished" content="2026-01-26T12:06:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冬奇Lab"/> <meta itemprop="url" content="https://juejin.cn/user/1857501105781193"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android 15存储子系统深度解析（三）：FBE加密文件系统与存储性能优化实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1857501105781193/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冬奇Lab
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T12:06:27.000Z" title="Mon Jan 26 2026 12:06:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读24分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>在前两篇文章中，我们深入分析了Android 15的Vold存储管理框架和FUSE文件系统。本篇作为存储子系统系列的收官之作，将重点聚焦于<strong>存储安全</strong>与<strong>性能优化</strong>两大核心主题：</p>
<ul>
<li><strong>FBE（File-Based Encryption）</strong>：Android 7.0引入、在Android 15进一步增强的文件级加密机制</li>
<li><strong>f2fs</strong>：针对Flash存储优化的文件系统，Android 15默认推荐文件系统</li>
<li><strong>存储性能优化</strong>：从诊断到调优的完整实战方法论</li>
</ul>
<p>这三者紧密关联：FBE加密保证了数据安全但会带来性能开销，f2fs通过专门优化减少这一开销，而性能优化则需要理解二者的配合机制。</p>
<h3 data-id="heading-1">本文内容概览</h3>
<ol>
<li>
<p><strong>FBE加密机制深度解析</strong></p>
<ul>
<li>FBE vs FDE对比</li>
<li>CE/DE密钥体系</li>
<li>加密策略与密钥派生</li>
<li>Keymaster HAL与硬件支持</li>
</ul>
</li>
<li>
<p><strong>f2fs文件系统核心特性</strong></p>
<ul>
<li>Flash友好的设计哲学</li>
<li>多头日志与热/冷数据分离</li>
<li>在线碎片整理与GC机制</li>
<li>Android 15中的f2fs增强</li>
</ul>
</li>
<li>
<p><strong>Metadata加密与完整性保护</strong></p>
<ul>
<li>dm-default-key设备映射器</li>
<li>Metadata加密实现</li>
<li>fsverity完整性验证</li>
</ul>
</li>
<li>
<p><strong>存储性能分析与优化</strong></p>
<ul>
<li>I/O性能基准测试</li>
<li>systrace/perfetto存储追踪</li>
<li>常见性能问题诊断</li>
<li>f2fs调优参数详解</li>
</ul>
</li>
<li>
<p><strong>实战：存储问题诊断案例</strong></p>
<ul>
<li>慢速读写问题定位</li>
<li>随机I/O性能调优</li>
<li>空间占用异常排查</li>
</ul>
</li>
</ol>
<p>让我们开始深入探索Android 15存储系统的安全与性能奥秘！</p>
<hr/>
<h2 data-id="heading-2">一、FBE加密机制深度解析</h2>
<h3 data-id="heading-3">1.1 为什么需要FBE？</h3>
<p>在Android 7.0之前，Android使用<strong>FDE（Full Disk Encryption，全盘加密）</strong>：整个<code>/data</code>分区使用单一密钥加密，解锁手机后密钥加载到内存，所有数据可访问。</p>
<p><strong>FDE的问题</strong>：</p>
<ul>
<li>开机后无法接听电话、接收闹钟（因为<code>/data</code>未解密）</li>
<li>必须先输入密码才能启动系统核心功能</li>
<li>OTA升级需要用户手动输入密码</li>
</ul>
<p><strong>FBE的优势</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────┬──────────────────┐
│  FDE (全盘加密)  │   FBE (文件加密)   │
├─────────────────┼──────────────────┤
│ 单一加密密钥      │  多密钥体系        │
│ 必须解锁才能开机  │  Direct Boot支持  │
│ 无法接听来电      │  开机即可接电话    │
│ OTA需要密码      │  OTA可后台进行    │
│ 性能开销大       │  按需加密，开销小  │
└─────────────────┴──────────────────┘
</code></pre>
<h3 data-id="heading-4">1.2 FBE核心概念：CE与DE密钥</h3>
<p>FBE引入了<strong>两级密钥体系</strong>：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be1e20d8edf54d86a1bebadea5639521~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770033994&amp;x-signature=AkYkfPuS6OwNRs9kkuPTdsr9plo%3D" alt="06-01-fbe-encryption-architecture.png" loading="lazy"/></p>
<h4 data-id="heading-5"><strong>DE (Device Encrypted) - 设备加密</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/FsCrypt.cpp - DE密钥路径</span>
<span class="hljs-function"><span class="hljs-type">static</span> std::string <span class="hljs-title">get_de_key_path</span><span class="hljs-params">(<span class="hljs-type">userid_t</span> user_id)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">StringPrintf</span>(<span class="hljs-string">"%s/de/%d"</span>, user_key_dir.<span class="hljs-built_in">c_str</span>(), user_id);
}
</code></pre>
<p><strong>特点</strong>：</p>
<ul>
<li>开机后即可用（系统启动时自动加载）</li>
<li>不依赖用户凭证（PIN/密码/指纹）</li>
<li>用于存储系统核心功能数据</li>
</ul>
<p><strong>典型用途</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># DE加密的目录示例</span>
/data/user_de/0/com.android.providers.telephony  <span class="hljs-comment"># 电话应用</span>
/data/user_de/0/com.android.deskclock           <span class="hljs-comment"># 闹钟应用</span>
/data/user_de/0/com.android.bluetooth           <span class="hljs-comment"># 蓝牙</span>
</code></pre>
<h4 data-id="heading-6"><strong>CE (Credential Encrypted) - 凭证加密</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/FsCrypt.cpp - CE密钥路径</span>
<span class="hljs-function"><span class="hljs-type">static</span> std::string <span class="hljs-title">get_ce_key_directory_path</span><span class="hljs-params">(<span class="hljs-type">userid_t</span> user_id)</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">StringPrintf</span>(<span class="hljs-string">"%s/ce/%d"</span>, user_key_dir.<span class="hljs-built_in">c_str</span>(), user_id);
}
</code></pre>
<p><strong>特点</strong>：</p>
<ul>
<li>用户解锁后才可用（从Keymaster派生）</li>
<li>基于用户凭证（PIN/密码/指纹）</li>
<li>用户锁屏后，CE密钥从内存清除</li>
</ul>
<p><strong>典型用途</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># CE加密的目录示例</span>
/data/user/0/com.android.providers.contacts     <span class="hljs-comment"># 联系人</span>
/data/user/0/com.android.providers.media       <span class="hljs-comment"># 相册</span>
/data/user/0/com.whatsapp                      <span class="hljs-comment"># 应用私有数据</span>
</code></pre>
<h3 data-id="heading-7">1.3 FBE密钥派生流程</h3>
<p>让我们从源码角度看密钥是如何生成和管理的：</p>
<h4 data-id="heading-8"><strong>1.3.1 DE密钥创建</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/FsCrypt.cpp</span>
<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">create_de_key</span><span class="hljs-params">(<span class="hljs-type">userid_t</span> user_id, <span class="hljs-type">bool</span> ephemeral)</span> </span>{
    KeyBuffer de_key;
    std::string de_key_path = <span class="hljs-built_in">get_de_key_path</span>(user_id);

    <span class="hljs-comment">// 1. 生成随机密钥（或从Keymaster派生）</span>
    <span class="hljs-keyword">auto</span> <span class="hljs-type">const</span>&amp; options = <span class="hljs-built_in">BuildDataEncryptionOptions</span>(s_data_options, ephemeral);
    KeyGeneration key_gen = <span class="hljs-built_in">makeGen</span>(options);

    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">generateStorageKey</span>(key_gen, &amp;de_key)) {
        <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Failed to generate DE key for user "</span> &lt;&lt; user_id;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// 2. 将密钥存储到文件系统</span>
    <span class="hljs-keyword">if</span> (!android::vold::<span class="hljs-built_in">storeKey</span>(de_key_path, user_key_temp, de_key)) {
        <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Failed to store DE key"</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// 3. 在内核中安装加密策略</span>
    EncryptionPolicy de_policy;
    <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">installKey</span>(de_key, de_policy)) {
        <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Failed to install DE policy"</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    s_de_policies[user_id].internal = de_policy;
    <span class="hljs-built_in">LOG</span>(INFO) &lt;&lt; <span class="hljs-string">"Created DE key for user "</span> &lt;&lt; user_id;
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p><strong>关键步骤</strong>：</p>
<ol>
<li><strong>生成密钥</strong>：调用<code>generateStorageKey()</code>生成AES-256密钥</li>
<li><strong>持久化存储</strong>：密钥文件存放在<code>/data/misc/vold/user_keys/de/&lt;userid&gt;/</code></li>
<li><strong>内核安装</strong>：通过<code>FS_IOC_ADD_ENCRYPTION_KEY</code> ioctl安装到内核</li>
</ol>
<h4 data-id="heading-9"><strong>1.3.2 CE密钥创建与派生</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/FsCrypt.cpp</span>
<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">fscrypt_prepare_user_storage</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; volume_uuid,
                                   <span class="hljs-type">userid_t</span> user_id,
                                   <span class="hljs-type">int</span> serial,
                                   <span class="hljs-type">int</span> flags)</span> </span>{
    <span class="hljs-comment">// CE密钥创建</span>
    <span class="hljs-keyword">if</span> (flags &amp; android::os::IVold::STORAGE_FLAG_CE) {
        <span class="hljs-comment">// 1. 从用户凭证派生密钥</span>
        android::vold::KeyAuthentication auth;
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">getUserKeyAuth</span>(user_id, &amp;auth)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        KeyBuffer ce_key;
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">retrieveOrGenerateKey</span>(ce_key_path, auth, <span class="hljs-built_in">makeGen</span>(s_data_options),
                                   &amp;ce_key)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-comment">// 2. 安装CE加密策略</span>
        EncryptionPolicy ce_policy;
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">install_storage_key</span>(<span class="hljs-built_in">BuildDataPath</span>(volume_uuid),
                                s_data_options, ce_key, &amp;ce_policy)) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        s_ce_policies[user_id].internal = ce_policy;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p><strong>CE密钥派生链</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">用户密码/PIN
    ↓
<span class="hljs-built_in">scrypt</span>(密码, salt)  ← 密钥派生函数
    ↓
派生密钥 (Derived Key)
    ↓
Keymaster派生 (Hardware-backed)
    ↓
CE加密密钥 (AES-<span class="hljs-number">256</span>)
    ↓
内核fscrypt子系统
</code></pre>
<h3 data-id="heading-10">1.4 Fscrypt内核接口</h3>
<p>Android通过<code>libfscrypt</code>库与内核fscrypt子系统交互：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/extras/libfscrypt/fscrypt.cpp</span>

<span class="hljs-comment">// 添加加密密钥到内核</span>
<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">fscrypt_add_key_to_keyring</span><span class="hljs-params">(<span class="hljs-type">const</span> fscrypt_key&amp; key,
                                <span class="hljs-type">const</span> <span class="hljs-type">char</span>* mountpoint)</span> </span>{
    android::<span class="hljs-function">base::unique_fd <span class="hljs-title">fd</span><span class="hljs-params">(open(mountpoint, O_RDONLY | O_DIRECTORY | O_CLOEXEC))</span></span>;

    <span class="hljs-keyword">struct</span> <span class="hljs-title class_">fscrypt_add_key_arg</span> arg;
    <span class="hljs-built_in">memset</span>(&amp;arg, <span class="hljs-number">0</span>, <span class="hljs-built_in">sizeof</span>(arg));
    arg.key_spec.type = FSCRYPT_KEY_SPEC_TYPE_DESCRIPTOR;
    <span class="hljs-built_in">memcpy</span>(arg.key_spec.u.descriptor, key.fek, FSCRYPT_KEY_DESCRIPTOR_SIZE);
    arg.raw_size = key.fek_size;
    <span class="hljs-built_in">memcpy</span>(arg.raw, key.fek, key.fek_size);

    <span class="hljs-comment">// ioctl系统调用</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ioctl</span>(fd, FS_IOC_ADD_ENCRYPTION_KEY, &amp;arg) != <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"FS_IOC_ADD_ENCRYPTION_KEY failed"</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}

<span class="hljs-comment">// 设置目录加密策略</span>
<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">fscrypt_policy_set</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* directory,
                       <span class="hljs-type">const</span> fscrypt_policy_v2&amp; policy)</span> </span>{
    android::<span class="hljs-function">base::unique_fd <span class="hljs-title">fd</span><span class="hljs-params">(open(directory, O_RDONLY | O_DIRECTORY | O_CLOEXEC))</span></span>;

    <span class="hljs-comment">// 使用v2策略（Android 11+）</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">ioctl</span>(fd, FS_IOC_SET_ENCRYPTION_POLICY, &amp;policy) != <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">PLOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"FS_IOC_SET_ENCRYPTION_POLICY failed on "</span> &lt;&lt; directory;
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p><strong>内核ioctl命令</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// Linux kernel include/uapi/linux/fscrypt.h</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> FS_IOC_SET_ENCRYPTION_POLICY   _IOR(<span class="hljs-string">'f'</span>, 19, struct fscrypt_policy_v2)</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> FS_IOC_GET_ENCRYPTION_POLICY   _IOW(<span class="hljs-string">'f'</span>, 21, struct fscrypt_policy_v2)</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> FS_IOC_ADD_ENCRYPTION_KEY      _IOWR(<span class="hljs-string">'f'</span>, 23, struct fscrypt_add_key_arg)</span>
<span class="hljs-meta">#<span class="hljs-keyword">define</span> FS_IOC_REMOVE_ENCRYPTION_KEY   _IOWR(<span class="hljs-string">'f'</span>, 24, struct fscrypt_remove_key_arg)</span>
</code></pre>
<h3 data-id="heading-11">1.5 Keymaster HAL与硬件支持</h3>
<p>Android 15中，密钥派生依赖<strong>Keymaster HAL</strong>（硬件支持的密钥管理）：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/KeyStorage.cpp</span>

<span class="hljs-comment">// 从Keymaster派生加密密钥</span>
<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">generateKeymasterKey</span><span class="hljs-params">(Keymaster&amp; keymaster, <span class="hljs-type">const</span> KeyAuthentication&amp; auth,
                                <span class="hljs-type">const</span> std::string&amp; appId, KeyBuffer* key)</span> </span>{
    <span class="hljs-comment">// 1. 生成Keymaster密钥</span>
    <span class="hljs-keyword">auto</span> paramBuilder = km::<span class="hljs-built_in">AuthorizationSetBuilder</span>()
                        .<span class="hljs-built_in">AesEncryptionKey</span>(AES_KEY_BYTES * <span class="hljs-number">8</span>)
                        .GcmMode <span class="hljs-built_in">MinMacLength</span>(GCM_MAC_BYTES * <span class="hljs-number">8</span>)
                        .<span class="hljs-built_in">Authorization</span>(km::TAG_APPLICATION_ID, appId)
                        .<span class="hljs-built_in">Authorization</span>(km::TAG_NO_AUTH_REQUIRED);

    <span class="hljs-keyword">if</span> (auth.<span class="hljs-built_in">usesKeymaster</span>()) {
        paramBuilder.<span class="hljs-built_in">Authorization</span>(km::TAG_USER_SECURE_ID, auth.secureUserId);
    }

    km::AuthorizationSet in_params = paramBuilder.<span class="hljs-built_in">build</span>();
    KeyBlob keyBlob;

    <span class="hljs-comment">// 调用Keymaster HAL生成密钥</span>
    <span class="hljs-keyword">auto</span> result = keymaster.<span class="hljs-built_in">generateKey</span>(in_params, &amp;keyBlob);
    <span class="hljs-keyword">if</span> (!result.<span class="hljs-built_in">isOk</span>()) {
        <span class="hljs-built_in">LOG</span>(ERROR) &lt;&lt; <span class="hljs-string">"Keymaster generateKey failed: "</span> &lt;&lt; result.<span class="hljs-built_in">error</span>();
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// 2. 从Keymaster导出密钥材料</span>
    <span class="hljs-keyword">auto</span> exportResult = keymaster.<span class="hljs-built_in">exportKey</span>(km::KeyFormat::RAW, keyBlob,
                                           km::<span class="hljs-built_in">AuthorizationSet</span>(),
                                           km::<span class="hljs-built_in">AuthorizationSet</span>());

    *key = <span class="hljs-built_in">KeyBuffer</span>(exportResult.blob.<span class="hljs-built_in">data</span>(), exportResult.blob.<span class="hljs-built_in">size</span>());
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p><strong>硬件支持的好处</strong>：</p>
<ul>
<li>密钥永不离开TEE（Trusted Execution Environment）</li>
<li>抵御物理攻击（密钥提取）</li>
<li>支持生物识别（指纹/人脸）认证</li>
</ul>
<h3 data-id="heading-12">1.6 Android 15中的FBE增强</h3>
<h4 data-id="heading-13"><strong>1.6.1 硬件包裹密钥（Hardware-Wrapped Keys）</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/KeyStorage.cpp - Android 15新特性</span>
<span class="hljs-function"><span class="hljs-type">static</span> KeyGeneration <span class="hljs-title">makeGen</span><span class="hljs-params">(<span class="hljs-type">const</span> EncryptionOptions&amp; options)</span> </span>{
    <span class="hljs-keyword">return</span> KeyGeneration{
        FSCRYPT_MAX_KEY_SIZE,
        <span class="hljs-literal">true</span>,
        options.use_hw_wrapped_key  <span class="hljs-comment">// ← Android 15: 硬件包裹密钥</span>
    };
}
</code></pre>
<p><strong>原理</strong>：</p>
<ul>
<li>密钥由硬件生成，永不以明文形式出现在应用处理器</li>
<li>密钥材料由硬件专用密钥包裹（wrap）</li>
<li>解密操作必须在安全硬件内完成</li>
</ul>
<h4 data-id="heading-14"><strong>1.6.2 密钥升级机制（Key Upgrade）</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/KeyStorage.cpp</span>
<span class="hljs-function"><span class="hljs-type">bool</span> <span class="hljs-title">reloadKeyFromSessionKeyring</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; mountpoint, <span class="hljs-type">const</span> EncryptionKey&amp; key)</span> </span>{
    <span class="hljs-comment">// Android 15: 支持在线密钥升级，无需重启</span>
    <span class="hljs-keyword">auto</span> result = keymaster.<span class="hljs-built_in">upgradeKey</span>(key.blob, upgrade_params);
    <span class="hljs-keyword">if</span> (result.<span class="hljs-built_in">isOk</span>()) {
        <span class="hljs-comment">// 热更新内核中的密钥</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">fscrypt_add_key_to_keyring</span>(result.upgradedBlob, mountpoint);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<hr/>
<h2 data-id="heading-15">二、f2fs文件系统核心特性</h2>
<h3 data-id="heading-16">2.1 为什么Android选择f2fs？</h3>
<p>传统ext4文件系统设计初衷是机械硬盘（HDD），而现代移动设备全部使用Flash存储（eMMC/UFS）。f2fs（Flash-Friendly File System）专为Flash优化：</p>
<p><strong>ext4 vs f2fs对比</strong>：</p>
<pre><code class="hljs">┌──────────────┬────────────┬────────────┐
│   特性        │    ext4    │    f2fs    │
├──────────────┼────────────┼────────────┤
│ 设计目标      │ HDD优化    │ Flash优化  │
│ 写入方式      │ 就地更新    │ LFS日志式  │
│ 碎片化       │ 容易碎片化  │ 天然抗碎片  │
│ GC机制       │ 无         │ 后台在线GC │
│ Trim支持     │ 基础支持    │ 深度集成   │
│ 随机写性能    │ 一般       │ 优秀       │
│ Android优化  │ 有限       │ 深度定制   │
└──────────────┴────────────┴────────────┘
</code></pre>
<h3 data-id="heading-17">2.2 f2fs核心设计：日志结构化</h3>
<p>f2fs采用**LFS（Log-Structured File System）**设计：</p>
<pre><code class="hljs language-scss" lang="scss">┌────────────────────────────────────────┐
│          f2fs 磁盘布局                  │
├────────┬──────┬─────────┬─────────────┤
│ Super  │ CP   │  SSA    │   <span class="hljs-selector-tag">Main</span> Area  │
│ block  │ area │  area   │  (Segments)  │
├────────┴──────┴─────────┴─────────────┤
│                                        │
│  <span class="hljs-selector-tag">Main</span> Area详细:                        │
│  ┌──────────────────────────────────┐ │
│  │ HOT NODE  │ WARM NODE │ COLD NODE│ │ ← Node Segments
│  ├───────────┼───────────┼──────────┤ │
│  │ HOT DATA  │ WARM DATA │ COLD DATA│ │ ← Data Segments
│  └──────────────────────────────────┘ │
└────────────────────────────────────────┘
</code></pre>
<p><strong>关键数据结构</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// fs/f2fs/f2fs.h - Segment Info</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_summary</span> {</span>
    __le32 nid;          <span class="hljs-comment">// Node ID</span>
    __u8 version;        <span class="hljs-comment">// Node version</span>
    __le16 ofs_in_node;  <span class="hljs-comment">// Offset in node</span>
} __packed;

<span class="hljs-comment">// Checkpoint区域</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_checkpoint</span> {</span>
    __le64 checkpoint_ver;      <span class="hljs-comment">// CP版本号</span>
    __le64 user_block_count;    <span class="hljs-comment">// 用户数据块数</span>
    __le64 valid_block_count;   <span class="hljs-comment">// 有效块数</span>
    __le32 rsvd_segment_count;  <span class="hljs-comment">// 保留segment数</span>
    __le32 overprov_segment_count;  <span class="hljs-comment">// 过度配置segment数</span>
    __le32 free_segment_count;  <span class="hljs-comment">// 空闲segment数</span>
    <span class="hljs-comment">// ...</span>
} __packed;
</code></pre>
<h3 data-id="heading-18">2.3 热/冷数据分离</h3>
<p>f2fs根据数据更新频率分类：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// fs/f2fs/segment.h</span>
<span class="hljs-keyword">enum</span> {
    CURSEG_HOT_DATA = <span class="hljs-number">0</span>,   <span class="hljs-comment">// 频繁修改的用户数据</span>
    CURSEG_WARM_DATA,      <span class="hljs-comment">// 中等频率数据</span>
    CURSEG_COLD_DATA,      <span class="hljs-comment">// 很少修改的数据</span>
    CURSEG_HOT_NODE,       <span class="hljs-comment">// 目录inode</span>
    CURSEG_WARM_NODE,      <span class="hljs-comment">// 文件inode</span>
    CURSEG_COLD_NODE,      <span class="hljs-comment">// 间接节点</span>
    NR_CURSEG_TYPE,
};
</code></pre>
<p><strong>分类策略</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// fs/f2fs/segment.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">int</span> __get_segment_type(<span class="hljs-keyword">struct</span> page *page, <span class="hljs-keyword">enum</span> page_type p_type) {
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_io_info</span> <span class="hljs-title">fio</span> =</span> {.type = p_type};

    <span class="hljs-keyword">if</span> (p_type == DATA) {
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span> =</span> page-&gt;mapping-&gt;host;

        <span class="hljs-comment">// 1. 目录数据 → HOT DATA</span>
        <span class="hljs-keyword">if</span> (S_ISDIR(inode-&gt;i_mode))
            <span class="hljs-keyword">return</span> CURSEG_HOT_DATA;

        <span class="hljs-comment">// 2. 多媒体文件 → COLD DATA</span>
        <span class="hljs-keyword">if</span> (is_cold_data(page))
            <span class="hljs-keyword">return</span> CURSEG_COLD_DATA;

        <span class="hljs-comment">// 3. 其他 → WARM DATA</span>
        <span class="hljs-keyword">return</span> CURSEG_WARM_DATA;
    }

    <span class="hljs-comment">// Node数据分类...</span>
    <span class="hljs-keyword">return</span> __get_node_segment_type(page);
}
</code></pre>
<p><strong>好处</strong>：</p>
<ul>
<li>减少GC开销（冷数据很少搬移）</li>
<li>提升写入性能（热数据集中写入）</li>
<li>延长Flash寿命（减少写放大）</li>
</ul>
<h3 data-id="heading-19">2.4 多头日志与并发写入</h3>
<p>f2fs支持<strong>6个活跃segment</strong>同时写入：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// fs/f2fs/segment.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title function_">allocate_segment_by_default</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi,
                                        <span class="hljs-type">int</span> type, <span class="hljs-type">bool</span> force)</span> {
    <span class="hljs-comment">// 每种类型维护独立的curseg</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">curseg_info</span> *<span class="hljs-title">curseg</span> =</span> CURSEG_I(sbi, type);

    <span class="hljs-keyword">if</span> (force || !has_not_enough_free_secs(sbi, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)) {
        <span class="hljs-comment">// 分配新segment</span>
        get_new_segment(sbi, &amp;curseg-&gt;segno, NEW_SEC, type);
        curseg-&gt;next_blkoff = <span class="hljs-number">0</span>;
    }
}
</code></pre>
<p><strong>并发写入优势</strong>：</p>
<pre><code class="hljs language-less" lang="less">传统单日志:
  <span class="hljs-selector-tag">HOT</span> → <span class="hljs-selector-tag">WARM</span> → <span class="hljs-selector-tag">COLD</span> → <span class="hljs-selector-tag">HOT</span> → <span class="hljs-selector-tag">WARM</span> → ... (串行写入)

<span class="hljs-selector-tag">f2fs</span>多头日志:
  <span class="hljs-selector-tag">HOT</span>   ──→ <span class="hljs-selector-tag">Segment</span> <span class="hljs-selector-tag">A</span>
  <span class="hljs-selector-tag">WARM</span>  ──→ <span class="hljs-selector-tag">Segment</span> <span class="hljs-selector-tag">B</span>  } 并行写入
  <span class="hljs-selector-tag">COLD</span>  ──→ <span class="hljs-selector-tag">Segment</span> <span class="hljs-selector-tag">C</span>
</code></pre>
<h3 data-id="heading-20">2.5 在线碎片整理与GC</h3>
<h4 data-id="heading-21"><strong>2.5.1 Segment清理机制</strong></h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// fs/f2fs/gc.c</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">f2fs_gc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi, <span class="hljs-keyword">struct</span> f2fs_gc_control *gc_control)</span> {
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> segno;
    <span class="hljs-type">int</span> gc_type = gc_control-&gt;init_gc_type;

    <span class="hljs-comment">// 1. 选择victim segment（最少有效块的segment）</span>
    <span class="hljs-keyword">if</span> (!get_victim_by_default(sbi, &amp;segno, gc_type, NO_CHECK_TYPE, LFS)) {
        <span class="hljs-keyword">return</span> -ENODATA;
    }

    <span class="hljs-comment">// 2. 遍历victim segment中的有效块</span>
    <span class="hljs-keyword">for</span> (off = <span class="hljs-number">0</span>; off &lt; sbi-&gt;blocks_per_seg; off++) {
        <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_summary</span> <span class="hljs-title">sum</span>;</span>

        <span class="hljs-keyword">if</span> (!is_valid_data_blkaddr(sbi, blkaddr))
            <span class="hljs-keyword">continue</span>;

        <span class="hljs-comment">// 3. 读取有效数据</span>
        page = f2fs_get_read_data_page(inode, bidx, REQ_RAHEAD, &amp;gc_type);

        <span class="hljs-comment">// 4. 重新写入到新的segment</span>
        f2fs_submit_page_write(&amp;fio);
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>GC触发条件</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// fs/f2fs/gc.c</span>
<span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title function_">should_do_gc</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> f2fs_sb_info *sbi)</span> {
    <span class="hljs-comment">// 1. 空闲空间不足</span>
    <span class="hljs-keyword">if</span> (free_sections(sbi) &lt;= sbi-&gt;reserved_sections)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

    <span class="hljs-comment">// 2. 用户主动触发（fstrim）</span>
    <span class="hljs-keyword">if</span> (gc_urgent_mode(sbi))
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

    <span class="hljs-comment">// 3. 脏segment过多</span>
    <span class="hljs-keyword">if</span> (dirty_segments(sbi) &gt; sbi-&gt;blocks_per_seg * <span class="hljs-number">2</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;

    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
}
</code></pre>
<h4 data-id="heading-22"><strong>2.5.2 Android中的GC优化</strong></h4>
<p>Android通过sysfs接口控制GC行为：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看GC统计信息</span>
<span class="hljs-built_in">cat</span> /sys/kernel/debug/f2fs/status

<span class="hljs-comment"># 设置GC urgent模式（适合低电量/后台场景）</span>
<span class="hljs-built_in">echo</span> 1 &gt; /sys/fs/f2fs/&lt;device&gt;/gc_urgent

<span class="hljs-comment"># 手动触发GC</span>
<span class="hljs-built_in">echo</span> 1 &gt; /sys/fs/f2fs/&lt;device&gt;/gc_urgent_sleep_time
</code></pre>
<h3 data-id="heading-23">2.6 Android 15中的f2fs增强</h3>
<h4 data-id="heading-24"><strong>2.6.1 压缩支持（Compression）</strong></h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// fs/f2fs/compress.c - Android 15新增</span>
<span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">f2fs_compress_pages</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> compress_ctx *cc)</span> {
    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">f2fs_compress_ops</span> *<span class="hljs-title">cops</span> =</span>
        f2fs_cops[F2FS_I_SB(cc-&gt;inode)-&gt;s_compress_algorithm];

    <span class="hljs-comment">// 支持LZ4/LZO/ZSTD压缩算法</span>
    ret = cops-&gt;compress_pages(cc);

    <span class="hljs-keyword">if</span> (ret &lt; <span class="hljs-number">0</span>) {
        <span class="hljs-comment">// 压缩失败，使用原始数据</span>
        <span class="hljs-keyword">return</span> -EAGAIN;
    }

    <span class="hljs-comment">// 压缩率不足，不值得压缩</span>
    <span class="hljs-keyword">if</span> (cc-&gt;clen &gt;= cc-&gt;rlen - COMPRESS_HEADER_SIZE)
        <span class="hljs-keyword">return</span> -EAGAIN;

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>启用f2fs压缩</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 挂载选项</span>
mount -t f2fs -o compress_algorithm=lz4,compress_extension=* /dev/block/dm-0 /data

<span class="hljs-comment"># 或修改fstab</span>
/dev/block/dm-0 /data f2fs noatime,nosuid,nodev,compress_algorithm=lz4
</code></pre>
<p><strong>压缩效果</strong>：</p>
<ul>
<li>典型压缩率：30-50%</li>
<li>APK/DEX文件效果最佳</li>
<li>对性能影响小于5%</li>
</ul>
<h4 data-id="heading-25"><strong>2.6.2 Age Extent Cache</strong></h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// fs/f2fs/extent_cache.c</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">extent_tree</span> {</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_root_cached</span> <span class="hljs-title">root</span>;</span>     <span class="hljs-comment">// 红黑树根</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">node_list</span>;</span>     <span class="hljs-comment">// extent节点链表</span>
    <span class="hljs-type">rwlock_t</span> lock;
    <span class="hljs-type">atomic_t</span> node_cnt;              <span class="hljs-comment">// extent节点数</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> largest_updated;   <span class="hljs-comment">// 最大extent更新时间</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">extent_info</span> <span class="hljs-title">largest</span>;</span>     <span class="hljs-comment">// 缓存最大extent</span>
};
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li>减少磁盘访问（extent信息缓存在内存）</li>
<li>加速随机读取</li>
<li>Android 15默认启用</li>
</ul>
<hr/>
<h2 data-id="heading-26">三、Metadata加密与完整性保护</h2>
<h3 data-id="heading-27">3.1 dm-default-key设备映射器</h3>
<p>Android 9引入<strong>metadata加密</strong>，在FBE之上增加额外保护层：</p>
<pre><code class="hljs language-scss" lang="scss">┌──────────────────────────────────────┐
│         应用数据 (FBE加密)            │
├──────────────────────────────────────┤
│    文件系统Metadata (dm-default-key) │
├──────────────────────────────────────┤
│         块设备层                      │
└──────────────────────────────────────┘
</code></pre>
<p><strong>实现原理</strong>：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/MetadataCrypt.cpp</span>
<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">mount_via_fs_mgr</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">char</span>* mount_point, <span class="hljs-type">const</span> <span class="hljs-type">char</span>* blk_device)</span> </span>{
    <span class="hljs-comment">// 1. 创建dm-default-key设备</span>
    android::dm::DeviceMapper&amp; dm = android::dm::DeviceMapper::<span class="hljs-built_in">Instance</span>();

    std::string dm_name = <span class="hljs-string">"default-key"</span>;
    DmTable table;

    <span class="hljs-comment">// 2. 配置dm目标参数</span>
    std::string target_params = <span class="hljs-built_in">StringPrintf</span>(
        <span class="hljs-string">"%s 0 1 allow_discards sector_size:4096 "</span>
        <span class="hljs-string">"iv_large_sectors default_key=1"</span>, blk_device);

    table.<span class="hljs-built_in">Emplace</span>&lt;DmTargetDefaultKey&gt;(<span class="hljs-number">0</span>, fs_stat.st_size / <span class="hljs-number">512</span>, target_params);

    <span class="hljs-comment">// 3. 激活dm设备</span>
    <span class="hljs-keyword">if</span> (!dm.<span class="hljs-built_in">CreateDevice</span>(dm_name, table, &amp;dm_path, <span class="hljs-number">5</span>s)) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-comment">// 4. 在dm设备上挂载文件系统</span>
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">mount</span>(dm_path.<span class="hljs-built_in">c_str</span>(), mount_point, <span class="hljs-string">"f2fs"</span>,
                MS_NOATIME | MS_NOSUID | MS_NODEV, <span class="hljs-literal">nullptr</span>) == <span class="hljs-number">0</span>;
}
</code></pre>
<p><strong>密钥管理</strong>：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/MetadataCrypt.cpp</span>
<span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">bool</span> <span class="hljs-title">read_key</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; metadata_key_dir,
                    <span class="hljs-type">const</span> KeyGeneration&amp; gen, KeyBuffer* key)</span> </span>{
    <span class="hljs-comment">// Metadata密钥存放在/metadata分区</span>
    std::string key_path = metadata_key_dir + <span class="hljs-string">"/key"</span>;

    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">pathExists</span>(key_path)) {
        <span class="hljs-comment">// 读取现有密钥</span>
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">retrieveKey</span>(key_path, kEmptyAuthentication, key);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 首次启动，生成新密钥</span>
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">generateStorageKey</span>(gen, key)) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">storeKey</span>(key_path, user_key_temp, *key);
    }
}
</code></pre>
<h3 data-id="heading-28">3.2 fsverity完整性验证</h3>
<p>Android 11引入<strong>fsverity</strong>，防止文件被篡改：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 为APK文件启用fsverity</span>
fsverity <span class="hljs-built_in">enable</span> /data/app/com.example.app/base.apk

<span class="hljs-comment"># 查看fsverity状态</span>
fsverity measure /data/app/com.example.app/base.apk
</code></pre>
<p><strong>内核实现</strong>：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// fs/verity/verify.c</span>
<span class="hljs-type">bool</span> <span class="hljs-title function_">fsverity_verify_page</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> page *page)</span> {
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">inode</span> *<span class="hljs-title">inode</span> =</span> page-&gt;mapping-&gt;host;
    <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">fsverity_info</span> *<span class="hljs-title">vi</span> =</span> inode-&gt;i_verity_info;

    <span class="hljs-comment">// 1. 计算页面的Merkle树哈希</span>
    u8 real_hash[FS_VERITY_MAX_DIGEST_SIZE];
    hash_at_level(vi, page, <span class="hljs-number">0</span>, real_hash);

    <span class="hljs-comment">// 2. 从Merkle树中读取期望哈希</span>
    u8 expected_hash[FS_VERITY_MAX_DIGEST_SIZE];
    get_hash_from_tree(vi, page-&gt;index, expected_hash);

    <span class="hljs-comment">// 3. 比较哈希值</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">memcmp</span>(real_hash, expected_hash, vi-&gt;tree_params.digest_size) != <span class="hljs-number">0</span>) {
        pr_warn(<span class="hljs-string">"fsverity: page %lu of file %s has mismatched hash\n"</span>,
                page-&gt;index, inode-&gt;i_name);
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
    }

    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<p><strong>Merkle树结构</strong>：</p>
<pre><code class="hljs language-java" lang="java">              Root <span class="hljs-title function_">Hash</span> <span class="hljs-params">(存储在inode)</span>
                    │
        ┌───────────┴───────────┐
     Hash <span class="hljs-number">0</span>-<span class="hljs-number">3</span>              Hash <span class="hljs-number">4</span>-<span class="hljs-number">7</span>
        │                     │
   ┌────┴────┐           ┌────┴────┐
Hash <span class="hljs-number">0</span>  Hash <span class="hljs-number">1</span>        Hash <span class="hljs-number">4</span>  Hash <span class="hljs-number">5</span>
   │       │             │       │
Page <span class="hljs-number">0</span>  Page <span class="hljs-number">1</span>       Page <span class="hljs-number">4</span>  Page <span class="hljs-number">5</span>
</code></pre>
<hr/>
<h2 data-id="heading-29">四、存储性能分析与优化</h2>
<h3 data-id="heading-30">4.1 I/O性能基准测试</h3>
<h4 data-id="heading-31"><strong>4.1.1 使用dd测试顺序读写</strong></h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 测试顺序写入性能</span>
<span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/zero of=/data/local/tmp/testfile bs=1M count=1024 oflag=direct

<span class="hljs-comment"># 输出示例：</span>
<span class="hljs-comment"># 1024+0 records in</span>
<span class="hljs-comment"># 1024+0 records out</span>
<span class="hljs-comment"># 1073741824 bytes (1.0GB) copied, 4.235s, 254MB/s</span>

<span class="hljs-comment"># 测试顺序读取性能</span>
<span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/data/local/tmp/testfile of=/dev/null bs=1M iflag=direct

<span class="hljs-comment"># 清理缓存后再测试（更准确）</span>
<span class="hljs-built_in">echo</span> 3 &gt; /proc/sys/vm/drop_caches
<span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/data/local/tmp/testfile of=/dev/null bs=1M iflag=direct
</code></pre>
<h4 data-id="heading-32"><strong>4.1.2 使用fio测试随机I/O</strong></h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Android系统需要先推送fio二进制</span>
adb push fio /data/local/tmp/
adb shell <span class="hljs-built_in">chmod</span> +x /data/local/tmp/fio

<span class="hljs-comment"># 4K随机读测试</span>
adb shell /data/local/tmp/fio \
  --name=randread \
  --ioengine=libaio \
  --iodepth=32 \
  --rw=randread \
  --bs=4k \
  --direct=1 \
  --size=1G \
  --numjobs=4 \
  --runtime=60 \
  --group_reporting

<span class="hljs-comment"># 输出关键指标：</span>
<span class="hljs-comment"># IOPS（每秒I/O操作数）</span>
<span class="hljs-comment"># BW（带宽）</span>
<span class="hljs-comment"># lat（延迟）</span>
</code></pre>
<h3 data-id="heading-33">4.2 存储性能诊断流程</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/74a7dc9c1d4c421d8badf647289f99a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Yas5aWHTGFi:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770033994&amp;x-signature=yDC8VO6v5rCt%2FWR8XpClq2303cw%3D" alt="06-02-storage-performance-analysis-flowchart.png" loading="lazy"/></p>
<h4 data-id="heading-34"><strong>4.2.1 使用systrace追踪I/O</strong></h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 捕获存储相关trace</span>
python systrace.py -o trace.html \
  -t 10 \
  disk \
  block \
  f2fs \
  ext4 \
  <span class="hljs-built_in">sched</span> \
  freq

<span class="hljs-comment"># 分析trace文件：</span>
<span class="hljs-comment"># 1. 查找"f2fs_write_begin"/"f2fs_write_end"事件</span>
<span class="hljs-comment"># 2. 分析I/O等待时间</span>
<span class="hljs-comment"># 3. 检查是否有大量sync操作</span>
</code></pre>
<h4 data-id="heading-35"><strong>4.2.2 使用perfetto深度分析</strong></h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 配置perfetto trace</span>
<span class="hljs-built_in">cat</span> &gt; /data/local/tmp/trace_config.pbtxt &lt;&lt; <span class="hljs-string">EOF
buffers: {
    size_kb: 102400
    fill_policy: RING_BUFFER
}

data_sources: {
    config {
        name: "linux.ftrace"
        ftrace_config {
            ftrace_events: "f2fs/f2fs_write_begin"
            ftrace_events: "f2fs/f2fs_sync_file_enter"
            ftrace_events: "block/block_rq_issue"
            ftrace_events: "block/block_rq_complete"
        }
    }
}

duration_ms: 10000
EOF</span>

<span class="hljs-comment"># 捕获trace</span>
perfetto -c /data/local/tmp/trace_config.pbtxt -o /data/local/tmp/trace.perfetto
</code></pre>
<h4 data-id="heading-36"><strong>4.2.3 f2fs状态监控</strong></h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看f2fs实时状态</span>
<span class="hljs-built_in">cat</span> /sys/kernel/debug/f2fs/status

<span class="hljs-comment"># 输出示例（关键字段解读）：</span>
<span class="hljs-comment"># =============  DATA SECTION  =============</span>
<span class="hljs-comment"># Total sections: 3072</span>
<span class="hljs-comment"># Free sections: 256           ← 空闲section数（越大越好）</span>
<span class="hljs-comment"># Dirty segments: 45          ← 待GC的segment（过高需优化）</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># =============  DIRTY SEGMENTS  ===========</span>
<span class="hljs-comment"># Dirty type: HOT DATA  ( 12) ← 各类型脏数据统计</span>
<span class="hljs-comment"># Dirty type: WARM DATA ( 18)</span>
<span class="hljs-comment"># Dirty type: COLD DATA ( 15)</span>
<span class="hljs-comment">#</span>
<span class="hljs-comment"># =============  GC STATISTICS  ============</span>
<span class="hljs-comment"># GC calls: 1234              ← GC触发次数</span>
<span class="hljs-comment"># GC reclaimed blocks: 56789  ← 回收的块数</span>
</code></pre>
<h3 data-id="heading-37">4.3 常见性能问题与解决方案</h3>
<h4 data-id="heading-38"><strong>问题1：写入性能突然下降</strong></h4>
<p><strong>诊断</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 检查空闲空间</span>
<span class="hljs-built_in">df</span> -h /data
<span class="hljs-comment"># 输出：Filesystem      Size  Used Avail Use%</span>
<span class="hljs-comment">#       /dev/dm-0       64G   62G   2G  97%  ← 空间不足！</span>

<span class="hljs-comment"># 2. 检查GC压力</span>
<span class="hljs-built_in">cat</span> /sys/kernel/debug/f2fs/status | grep <span class="hljs-string">"Dirty segments"</span>
<span class="hljs-comment"># Dirty segments: 512  ← 过高，需要GC</span>

<span class="hljs-comment"># 3. 查看是否有大量sync操作</span>
systrace.py -t 5 disk | grep <span class="hljs-string">"f2fs_sync_fs"</span>
</code></pre>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方案A：手动触发fstrim（清理无效块）</span>
fstrim -v /data
<span class="hljs-comment"># 输出：/data: 8.5 GiB (9123456789 bytes) trimmed</span>

<span class="hljs-comment"># 方案B：启用GC urgent模式</span>
<span class="hljs-built_in">echo</span> 1 &gt; /sys/fs/f2fs/dm-0/gc_urgent
<span class="hljs-comment"># 等待GC完成后</span>
<span class="hljs-built_in">echo</span> 0 &gt; /sys/fs/f2fs/dm-0/gc_urgent

<span class="hljs-comment"># 方案C：清理缓存数据（释放空间）</span>
pm trim-caches 10G  <span class="hljs-comment"># 清理10GB缓存</span>
</code></pre>
<h4 data-id="heading-39"><strong>问题2：随机I/O性能差</strong></h4>
<p><strong>诊断</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用iobench测试4K随机读</span>
iobench --<span class="hljs-built_in">type</span>=randread --size=1G --bs=4096 --iodepth=32

<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># IOPS: 1200  ← 正常值应&gt;5000（UFS 2.1）</span>
</code></pre>
<p><strong>优化方案</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 启用readahead</span>
<span class="hljs-built_in">echo</span> 256 &gt; /sys/block/sda/queue/read_ahead_kb

<span class="hljs-comment"># 2. 调整f2fs inline_xattr（减少元数据碎片）</span>
mount -o remount,inline_xattr /data

<span class="hljs-comment"># 3. 启用f2fs的age_extent_cache（Android 15新特性）</span>
<span class="hljs-comment"># 需要在fstab中配置：</span>
/dev/block/dm-0 /data f2fs noatime,age_extent_cache
</code></pre>
<h4 data-id="heading-40"><strong>问题3：空间占用异常</strong></h4>
<p><strong>诊断</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 分析目录大小</span>
<span class="hljs-built_in">du</span> -sh /data/* | <span class="hljs-built_in">sort</span> -h | <span class="hljs-built_in">tail</span> -10

<span class="hljs-comment"># 2. 查找大文件</span>
find /data -<span class="hljs-built_in">type</span> f -size +100M -<span class="hljs-built_in">exec</span> <span class="hljs-built_in">ls</span> -lh {} \;

<span class="hljs-comment"># 3. 检查f2fs的over-provisioning</span>
<span class="hljs-built_in">cat</span> /sys/kernel/debug/f2fs/status | grep <span class="hljs-string">"overprov"</span>
<span class="hljs-comment"># Overprovision segments: 512  ← OP空间（5-10%正常）</span>
</code></pre>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 方案A：启用f2fs压缩（需要Android 12+）</span>
<span class="hljs-comment"># 在fstab中添加compress选项</span>
/dev/block/dm-0 /data f2fs compress_algorithm=lz4,compress_extension=apk:dex:jar

<span class="hljs-comment"># 方案B：调整reserved_blocks（预留块）</span>
<span class="hljs-built_in">echo</span> 100 &gt; /sys/fs/f2fs/dm-0/reserved_blocks

<span class="hljs-comment"># 方案C：清理tombstone和日志</span>
<span class="hljs-built_in">rm</span> -rf /data/tombstones/*
logcat -c
</code></pre>
<h3 data-id="heading-41">4.4 f2fs关键调优参数</h3>
<h4 data-id="heading-42"><strong>4.4.1 GC相关参数</strong></h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># gc_urgent: 紧急GC模式</span>
<span class="hljs-comment"># 0 = 关闭, 1 = 开启</span>
<span class="hljs-built_in">echo</span> 1 &gt; /sys/fs/f2fs/&lt;device&gt;/gc_urgent

<span class="hljs-comment"># gc_urgent_sleep_time: GC休眠时间（毫秒）</span>
<span class="hljs-comment"># 建议值：100-500ms（平衡性能与功耗）</span>
<span class="hljs-built_in">echo</span> 500 &gt; /sys/fs/f2fs/&lt;device&gt;/gc_urgent_sleep_time

<span class="hljs-comment"># min_fsync_blocks: 触发fsync前的最小块数</span>
<span class="hljs-comment"># 较大值可减少sync次数，但增加数据丢失风险</span>
<span class="hljs-built_in">echo</span> 8 &gt; /sys/fs/f2fs/&lt;device&gt;/min_fsync_blocks
</code></pre>
<h4 data-id="heading-43"><strong>4.4.2 挂载选项优化</strong></h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># fstab配置示例（/vendor/etc/fstab.device）</span>
/dev/block/dm-0 /data f2fs noatime,nosuid,nodev,discard,reserve_root=32768,resgid=1065,fsync_mode=nobarrier,inlinecrypt,compress_algorithm=lz4

<span class="hljs-comment"># 关键选项解读：</span>
<span class="hljs-comment"># - noatime: 禁用访问时间更新（减少写入）</span>
<span class="hljs-comment"># - discard: 启用TRIM（及时释放无效块）</span>
<span class="hljs-comment"># - reserve_root=32768: 预留32MB给root用户</span>
<span class="hljs-comment"># - fsync_mode=nobarrier: 减少fsync屏障（性能优先）</span>
<span class="hljs-comment"># - inlinecrypt: 使用硬件加密（减少CPU开销）</span>
<span class="hljs-comment"># - compress_algorithm=lz4: 启用LZ4压缩</span>
</code></pre>
<h4 data-id="heading-44"><strong>4.4.3 Android特有优化</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// system/vold/fs/F2fs.cpp - Android默认挂载选项</span>
<span class="hljs-function"><span class="hljs-type">status_t</span> <span class="hljs-title">Mount</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; source, <span class="hljs-type">const</span> std::string&amp; target)</span> </span>{
    std::vector&lt;std::string&gt; args;
    args.<span class="hljs-built_in">push_back</span>(<span class="hljs-string">"-o"</span>);

    <span class="hljs-comment">// Android 15优化选项</span>
    std::string options = <span class="hljs-string">"noatime,nosuid,nodev,discard"</span>;
    options += <span class="hljs-string">",reserve_root=32768,resgid=1065"</span>;
    options += <span class="hljs-string">",inlinecrypt"</span>;  <span class="hljs-comment">// 硬件加速加密</span>
    options += <span class="hljs-string">",fsync_mode=nobarrier"</span>;  <span class="hljs-comment">// 减少sync屏障</span>

    <span class="hljs-comment">// 如果支持压缩</span>
    <span class="hljs-keyword">if</span> (android::base::<span class="hljs-built_in">GetBoolProperty</span>(<span class="hljs-string">"ro.storage.compress"</span>, <span class="hljs-literal">false</span>)) {
        options += <span class="hljs-string">",compress_algorithm=lz4"</span>;
        options += <span class="hljs-string">",compress_extension=apk:jar:dex:so"</span>;
    }

    args.<span class="hljs-built_in">push_back</span>(options);
    args.<span class="hljs-built_in">push_back</span>(source);
    args.<span class="hljs-built_in">push_back</span>(target);

    <span class="hljs-keyword">return</span> <span class="hljs-built_in">ForkExecvp</span>(<span class="hljs-string">"/system/bin/mount.f2fs"</span>, args);
}
</code></pre>
<hr/>
<h2 data-id="heading-45">五、实战：存储问题诊断案例</h2>
<h3 data-id="heading-46">案例1：应用启动慢，怀疑存储性能问题</h3>
<p><strong>现象</strong>：</p>
<ul>
<li>应用冷启动时间从1秒增加到3秒</li>
<li>systrace显示大量时间在I/O等待</li>
</ul>
<p><strong>诊断步骤</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 捕获应用启动trace</span>
adb shell am start -W -n com.example.app/.MainActivity

<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># TotalTime: 3248  ← 总启动时间3.2秒</span>

<span class="hljs-comment"># 2. 使用systrace分析</span>
python systrace.py -o app_start.html -t 5 -a com.example.app <span class="hljs-built_in">sched</span> freq disk

<span class="hljs-comment"># 3. 在trace中发现大量f2fs_sync_file调用</span>
<span class="hljs-comment"># 定位代码：应用在启动时同步写入SharedPreferences</span>
</code></pre>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 问题代码：</span>
SharedPreferences.<span class="hljs-type">Editor</span> <span class="hljs-variable">editor</span> <span class="hljs-operator">=</span> prefs.edit();
editor.putString(<span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>);
editor.commit();  <span class="hljs-comment">// ← 同步写入，阻塞主线程</span>

<span class="hljs-comment">// 优化后：</span>
SharedPreferences.<span class="hljs-type">Editor</span> <span class="hljs-variable">editor</span> <span class="hljs-operator">=</span> prefs.edit();
editor.putString(<span class="hljs-string">"key"</span>, <span class="hljs-string">"value"</span>);
editor.apply();  <span class="hljs-comment">// ← 异步写入，不阻塞</span>
</code></pre>
<p><strong>效果验证</strong>：</p>
<pre><code class="hljs language-bash" lang="bash">adb shell am start -W -n com.example.app/.MainActivity
<span class="hljs-comment"># TotalTime: 1156  ← 优化后降至1.1秒</span>
</code></pre>
<h3 data-id="heading-47">案例2：设备使用一段时间后变慢</h3>
<p><strong>现象</strong>：</p>
<ul>
<li>新设备流畅，使用3个月后明显卡顿</li>
<li>存储剩余空间小于10%</li>
</ul>
<p><strong>诊断</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 检查f2fs状态</span>
adb shell <span class="hljs-built_in">cat</span> /sys/kernel/debug/f2fs/status

<span class="hljs-comment"># 输出异常：</span>
<span class="hljs-comment"># Free sections: 45        ← 空闲section过少</span>
<span class="hljs-comment"># Dirty segments: 789      ← 大量脏segment待GC</span>
<span class="hljs-comment"># Valid blocks: 95%        ← 有效块占比过高，GC效率低</span>

<span class="hljs-comment"># 2. 检查碎片化程度</span>
adb shell /data/local/tmp/f2fs_io fsstat /data

<span class="hljs-comment"># 输出：</span>
<span class="hljs-comment"># - Main: 98.5% usage</span>
<span class="hljs-comment"># - Fragmentation: High  ← 严重碎片化</span>
</code></pre>
<p><strong>解决方案</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 步骤1：触发aggressive GC</span>
adb shell <span class="hljs-string">"echo 1 &gt; /sys/fs/f2fs/dm-0/gc_urgent"</span>
adb shell <span class="hljs-string">"echo 100 &gt; /sys/fs/f2fs/dm-0/gc_urgent_sleep_time"</span>

<span class="hljs-comment"># 等待5分钟让GC运行</span>
<span class="hljs-built_in">sleep</span> 300

<span class="hljs-comment"># 步骤2：fstrim释放无效块</span>
adb shell fstrim -v /data
<span class="hljs-comment"># 输出：/data: 12.3 GiB trimmed</span>

<span class="hljs-comment"># 步骤3：清理应用缓存（释放空间）</span>
adb shell pm trim-caches 10G

<span class="hljs-comment"># 步骤4：关闭gc_urgent</span>
adb shell <span class="hljs-string">"echo 0 &gt; /sys/fs/f2fs/dm-0/gc_urgent"</span>

<span class="hljs-comment"># 验证效果</span>
adb shell <span class="hljs-built_in">cat</span> /sys/kernel/debug/f2fs/status
<span class="hljs-comment"># Free sections: 256       ← 空闲section恢复</span>
<span class="hljs-comment"># Dirty segments: 52       ← 脏segment大幅减少</span>
</code></pre>
<p><strong>预防措施</strong>（系统配置）：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 配置自动fstrim（通过init.rc）</span>
service fstrim_periodic /system/bin/fstrim /data
    class late_start
    oneshot
    seclabel u:r:fstrim:s0

<span class="hljs-comment"># 或使用JobScheduler定时触发</span>
</code></pre>
<h3 data-id="heading-48">案例3：加密导致性能下降</h3>
<p><strong>现象</strong>：</p>
<ul>
<li>读写性能比预期慢30%</li>
<li>使用了FBE加密</li>
</ul>
<p><strong>诊断</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 确认是否使用硬件加密</span>
adb shell getprop ro.crypto.fde_algorithm
<span class="hljs-comment"># 输出：aes-256-xts  ← 如果是软件加密，需要优化</span>

<span class="hljs-comment"># 2. 检查Keymaster HAL版本</span>
adb shell dumpsys keystore | grep <span class="hljs-string">"Hardware"</span>
<span class="hljs-comment"># 输出：Hardware-backed keystore: true  ← 硬件支持</span>

<span class="hljs-comment"># 3. 测试加密性能</span>
<span class="hljs-comment"># 关闭FBE后测试（需要factory reset，仅用于对比）</span>
<span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/zero of=/data/local/tmp/test bs=1M count=1024 oflag=direct
<span class="hljs-comment"># 有FBE: 180 MB/s</span>
<span class="hljs-comment"># 无FBE: 250 MB/s ← 差距30%</span>
</code></pre>
<p><strong>优化方案</strong>：</p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 1. 确保使用硬件加速加密（fstab配置）</span>
/dev/block/dm<span class="hljs-number">-0</span> /data f2fs noatime,inlinecrypt  <span class="hljs-comment">// ← 添加inlinecrypt</span>

<span class="hljs-comment">// 2. 在Kernel配置中启用Inline Crypto Engine（ICE）</span>
CONFIG_CRYPTO_DEV_QCOM_ICE=y  <span class="hljs-comment">// Qualcomm平台</span>
CONFIG_SCSI_UFS_CRYPTO=y      <span class="hljs-comment">// UFS硬件加密</span>

<span class="hljs-comment">// 3. 检查是否使用hardware-wrapped keys（Android 15）</span>
<span class="hljs-comment">// 在KeyStorage中启用：</span>
KeyGeneration gen = {
    .keysize = <span class="hljs-number">32</span>,
    .allow_gen = <span class="hljs-literal">true</span>,
    .use_hw_wrapped_key = <span class="hljs-literal">true</span>  <span class="hljs-comment">// ← 启用硬件包裹密钥</span>
};
</code></pre>
<p><strong>验证</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 重新测试性能</span>
<span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/zero of=/data/local/tmp/test bs=1M count=1024 oflag=direct
<span class="hljs-comment"># 优化后: 238 MB/s  ← 性能恢复到接近无加密水平</span>
</code></pre>
<hr/>
<h2 data-id="heading-49">六、开发者最佳实践</h2>
<h3 data-id="heading-50">6.1 应用层存储优化建议</h3>
<h4 data-id="heading-51"><strong>6.1.1 减少不必要的fsync</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误：频繁sync</span>
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
    <span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(file, <span class="hljs-literal">true</span>);
    fos.write(data);
    fos.getFD().sync();  <span class="hljs-comment">// 每次写入都sync，性能极差</span>
    fos.close();
}

<span class="hljs-comment">// ✅ 正确：批量写入后sync一次</span>
<span class="hljs-type">FileOutputStream</span> <span class="hljs-variable">fos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(file);
<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000</span>; i++) {
    fos.write(data);
}
fos.getFD().sync();  <span class="hljs-comment">// 只sync一次</span>
fos.close();
</code></pre>
<h4 data-id="heading-52"><strong>6.1.2 合理使用SharedPreferences</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ❌ 错误：commit()阻塞主线程</span>
SharedPreferences.<span class="hljs-type">Editor</span> <span class="hljs-variable">editor</span> <span class="hljs-operator">=</span> prefs.edit();
editor.putString(<span class="hljs-string">"key"</span>, value);
editor.commit();  <span class="hljs-comment">// 同步I/O</span>

<span class="hljs-comment">// ✅ 正确：使用apply()异步写入</span>
editor.apply();  <span class="hljs-comment">// 异步I/O，不阻塞</span>

<span class="hljs-comment">// ✅ 批量操作</span>
SharedPreferences.<span class="hljs-type">Editor</span> <span class="hljs-variable">editor</span> <span class="hljs-operator">=</span> prefs.edit();
editor.putString(<span class="hljs-string">"key1"</span>, value1);
editor.putString(<span class="hljs-string">"key2"</span>, value2);
editor.apply();  <span class="hljs-comment">// 一次性写入多个key</span>
</code></pre>
<h4 data-id="heading-53"><strong>6.1.3 大文件写入优化</strong></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// ✅ 使用BufferedOutputStream减少系统调用</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">BufferedOutputStream</span> <span class="hljs-variable">bos</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BufferedOutputStream</span>(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileOutputStream</span>(file), <span class="hljs-number">8192</span>)) {  <span class="hljs-comment">// 8KB缓冲区</span>
    bos.write(largeData);
}

<span class="hljs-comment">// ✅ 使用FileChannel和MappedByteBuffer（更快）</span>
<span class="hljs-keyword">try</span> (<span class="hljs-type">FileChannel</span> <span class="hljs-variable">channel</span> <span class="hljs-operator">=</span> FileChannel.open(file.toPath(),
        StandardOpenOption.WRITE, StandardOpenOption.CREATE)) {
    <span class="hljs-type">MappedByteBuffer</span> <span class="hljs-variable">buffer</span> <span class="hljs-operator">=</span> channel.map(FileChannel.MapMode.READ_WRITE,
                                          <span class="hljs-number">0</span>, largeData.length);
    buffer.put(largeData);
}
</code></pre>
<h3 data-id="heading-54">6.2 Framework层优化</h3>
<h4 data-id="heading-55"><strong>6.2.1 调整Linux I/O调度器</strong></h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看当前I/O调度器</span>
<span class="hljs-built_in">cat</span> /sys/block/sda/queue/scheduler
<span class="hljs-comment"># 输出：[mq-deadline] none</span>

<span class="hljs-comment"># 推荐配置（Android设备）：</span>
<span class="hljs-comment"># - UFS存储：mq-deadline 或 none（UFS自带调度）</span>
<span class="hljs-comment"># - eMMC存储：cfq 或 deadline</span>

<span class="hljs-comment"># 修改调度器</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"mq-deadline"</span> &gt; /sys/block/sda/queue/scheduler
</code></pre>
<h4 data-id="heading-56"><strong>6.2.2 调整写回策略</strong></h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 降低dirty_ratio（加快写回）</span>
<span class="hljs-built_in">echo</span> 10 &gt; /proc/sys/vm/dirty_ratio  <span class="hljs-comment"># 默认20</span>
<span class="hljs-built_in">echo</span> 5 &gt; /proc/sys/vm/dirty_background_ratio  <span class="hljs-comment"># 默认10</span>

<span class="hljs-comment"># 缩短写回超时</span>
<span class="hljs-built_in">echo</span> 1500 &gt; /proc/sys/vm/dirty_writeback_centisecs  <span class="hljs-comment"># 15秒（默认30秒）</span>
</code></pre>
<h3 data-id="heading-57">6.3 SELinux与存储权限</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 确保f2fs相关SELinux策略正确</span>
<span class="hljs-comment"># file_contexts示例：</span>
/data/vendor/f2fs(/.*)? u:object_r:vendor_f2fs_file:s0

<span class="hljs-comment"># sepolicy示例：</span>
allow system_server vendor_f2fs_file:<span class="hljs-built_in">dir</span> { <span class="hljs-built_in">read</span> open getattr search };
allow vold vendor_f2fs_file:<span class="hljs-built_in">dir</span> { create write add_name };
</code></pre>
<hr/>
<h2 data-id="heading-58">七、问题诊断速查表</h2>
<h3 data-id="heading-59">7.1 性能问题快速定位</h3>









































<table><thead><tr><th align="left">症状</th><th align="left">可能原因</th><th align="left">诊断命令</th><th align="left">解决方案</th></tr></thead><tbody><tr><td align="left">写入慢</td><td align="left">空间不足/GC压力大</td><td align="left"><code>df -h</code> + <code>cat /sys/kernel/debug/f2fs/status</code></td><td align="left">fstrim + 清理缓存</td></tr><tr><td align="left">读取慢</td><td align="left">缓存失效/碎片化</td><td align="left"><code>echo 3 &gt; /proc/sys/vm/drop_caches</code> 后测试</td><td align="left">调整readahead + GC</td></tr><tr><td align="left">随机I/O差</td><td align="left">extent缓存未命中</td><td align="left"><code>iobench --type=randread</code></td><td align="left">启用age_extent_cache</td></tr><tr><td align="left">应用启动慢</td><td align="left">频繁sync</td><td align="left"><code>systrace disk</code></td><td align="left">改用异步I/O（apply）</td></tr><tr><td align="left">设备越用越慢</td><td align="left">碎片化 + 空间不足</td><td align="left"><code>f2fs_io fsstat /data</code></td><td align="left">定期fstrim + 增加OP空间</td></tr></tbody></table>
<h3 data-id="heading-60">7.2 加密问题诊断</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查FBE状态</span>
adb shell getprop ro.crypto.state
<span class="hljs-comment"># 输出：encrypted  ← FBE已启用</span>

<span class="hljs-comment"># 检查密钥状态</span>
adb shell dumpsys activity service com.android.server.locksettings
<span class="hljs-comment"># 查找：User 0: CE key installed</span>

<span class="hljs-comment"># 检查硬件加密支持</span>
adb shell getprop ro.hardware.keystore
<span class="hljs-comment"># 输出：trusty  ← 使用TEE</span>

<span class="hljs-comment"># 检查Keymaster版本</span>
adb shell dumpsys keystore | grep <span class="hljs-string">"Hardware"</span>
</code></pre>
<h3 data-id="heading-61">7.3 f2fs健康检查</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 综合健康检查脚本</span>
adb shell &lt;&lt; <span class="hljs-string">'EOF'</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"=== F2FS Health Check ==="</span>

<span class="hljs-comment"># 1. 基本信息</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">"Filesystem:"</span>
<span class="hljs-built_in">df</span> -h /data

<span class="hljs-comment"># 2. f2fs状态</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\nf2fs Status:"</span>
<span class="hljs-built_in">cat</span> /sys/kernel/debug/f2fs/status | grep -E <span class="hljs-string">"Free sections|Dirty segments|Valid blocks"</span>

<span class="hljs-comment"># 3. GC状态</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\nGC Status:"</span>
<span class="hljs-built_in">cat</span> /sys/kernel/debug/f2fs/status | grep -E <span class="hljs-string">"GC calls|reclaimed"</span>

<span class="hljs-comment"># 4. 挂载选项</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\nMount Options:"</span>
mount | grep /data

<span class="hljs-comment"># 5. 磁盘I/O统计</span>
<span class="hljs-built_in">echo</span> -e <span class="hljs-string">"\nDisk Stats:"</span>
<span class="hljs-built_in">cat</span> /proc/diskstats | grep dm-0

<span class="hljs-built_in">echo</span> <span class="hljs-string">"=== Check Complete ==="</span>
EOF
</code></pre>
<hr/>
<h2 data-id="heading-62">八、总结与展望</h2>
<h3 data-id="heading-63">8.1 核心要点回顾</h3>
<ol>
<li>
<p><strong>FBE加密机制</strong></p>
<ul>
<li>CE/DE双密钥体系实现Direct Boot</li>
<li>基于Keymaster HAL的硬件安全保障</li>
<li>Android 15增强：硬件包裹密钥、在线密钥升级</li>
</ul>
</li>
<li>
<p><strong>f2fs文件系统</strong></p>
<ul>
<li>LFS日志结构针对Flash优化</li>
<li>热/冷数据分离减少写放大</li>
<li>在线GC和碎片整理</li>
<li>Android 15新特性：压缩支持、age extent cache</li>
</ul>
</li>
<li>
<p><strong>Metadata加密</strong></p>
<ul>
<li>dm-default-key设备映射器</li>
<li>fsverity完整性保护</li>
</ul>
</li>
<li>
<p><strong>性能优化方法论</strong></p>
<ul>
<li>基准测试（dd/fio/iobench）</li>
<li>Trace分析（systrace/perfetto）</li>
<li>GC调优（gc_urgent/fstrim）</li>
<li>应用层优化（避免sync/使用apply）</li>
</ul>
</li>
</ol>
<h3 data-id="heading-64">8.2 Android 15的改进</h3>









































<table><thead><tr><th align="left">特性</th><th align="left">Android 14</th><th align="left">Android 15</th><th align="left">提升</th></tr></thead><tbody><tr><td align="left">FBE硬件加密</td><td align="left">支持Inline Crypto</td><td align="left">强制Hardware-wrapped keys</td><td align="left">安全性↑</td></tr><tr><td align="left">f2fs压缩</td><td align="left">实验性</td><td align="left">默认启用（LZ4）</td><td align="left">空间节省30%+</td></tr><tr><td align="left">Metadata加密</td><td align="left">dm-crypt</td><td align="left">dm-default-key优化</td><td align="left">性能↑15%</td></tr><tr><td align="left">extent缓存</td><td align="left">基础extent_cache</td><td align="left">age_extent_cache</td><td align="left">随机读↑25%</td></tr><tr><td align="left">GC效率</td><td align="left">标准GC</td><td align="left">自适应GC + 预测算法</td><td align="left">后台性能↑</td></tr></tbody></table>
<h3 data-id="heading-65">8.3 未来展望</h3>
<p><strong>存储技术演进方向</strong>：</p>
<ul>
<li><strong>UFS 4.0普及</strong>：顺序读取速度将达4GB/s</li>
<li><strong>ZNS（Zoned Namespace）SSD</strong>：更好的Flash管理</li>
<li><strong>持久化内存（PMem）</strong>：字节级寻址的存储</li>
<li><strong>AI驱动的存储优化</strong>：机器学习预测I/O模式</li>
</ul>
<p><strong>Android存储系统发展</strong>：</p>
<ul>
<li>更智能的GC策略（基于用户行为学习）</li>
<li>更细粒度的加密控制（per-file key）</li>
<li>存储分层（热数据使用高速存储）</li>
<li>端到端加密与云同步集成</li>
</ul>
<hr/>
<h2 data-id="heading-66">九、参考资源</h2>
<h3 data-id="heading-67">9.1 源码路径</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># FBE加密相关</span>
system/vold/FsCrypt.cpp                    <span class="hljs-comment"># FBE核心实现</span>
system/vold/KeyStorage.cpp                 <span class="hljs-comment"># 密钥存储</span>
system/extras/libfscrypt/fscrypt.cpp       <span class="hljs-comment"># libfscrypt库</span>
kernel/fs/crypto/                          <span class="hljs-comment"># 内核fscrypt子系统</span>

<span class="hljs-comment"># f2fs文件系统</span>
kernel/fs/f2fs/                            <span class="hljs-comment"># f2fs内核代码</span>
external/f2fs-tools/                       <span class="hljs-comment"># f2fs用户空间工具</span>
system/core/fs_mgr/                        <span class="hljs-comment"># 文件系统管理器</span>

<span class="hljs-comment"># 设备映射器</span>
system/core/libdm/                         <span class="hljs-comment"># dm设备映射器库</span>
system/vold/MetadataCrypt.cpp              <span class="hljs-comment"># Metadata加密</span>
</code></pre>
<h3 data-id="heading-68">9.2 官方文档</h3>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsource.android.com%2Fdocs%2Fsecurity%2Ffeatures%2Fencryption%2Ffile-based" target="_blank" title="https://source.android.com/docs/security/features/encryption/file-based" ref="nofollow noopener noreferrer">Android File-Based Encryption</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.kernel.org%2Fdoc%2Fhtml%2Flatest%2Ffilesystems%2Ff2fs.html" target="_blank" title="https://www.kernel.org/doc/html/latest/filesystems/f2fs.html" ref="nofollow noopener noreferrer">f2fs Documentation</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgitlab.com%2Fcryptsetup%2Fcryptsetup%2F-%2Fwikis%2FDMCrypt" target="_blank" title="https://gitlab.com/cryptsetup/cryptsetup/-/wikis/DMCrypt" ref="nofollow noopener noreferrer">Linux dm-crypt</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fsource.android.com%2Fdocs%2Fsecurity%2Ffeatures%2Fkeystore" target="_blank" title="https://source.android.com/docs/security/features/keystore" ref="nofollow noopener noreferrer">Keymaster HAL</a></li>
</ul>
<h3 data-id="heading-69">9.3 性能分析工具</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 系统工具</span>
adb shell dumpsys diskstats              <span class="hljs-comment"># 磁盘统计</span>
adb shell dumpsys storaged               <span class="hljs-comment"># 存储守护进程</span>
adb shell /system/bin/f2fs_io            <span class="hljs-comment"># f2fs专用工具</span>
adb shell /system/bin/ioctl              <span class="hljs-comment"># 底层ioctl测试</span>

<span class="hljs-comment"># 第三方工具</span>
fio                                      <span class="hljs-comment"># 灵活的I/O测试工具</span>
iobench                                  <span class="hljs-comment"># 简单的benchmark</span>
blktrace                                 <span class="hljs-comment"># 块层追踪</span>
</code></pre>
<h3 data-id="heading-70">9.4 调试命令汇总</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># FBE调试</span>
getprop ro.crypto.type                   <span class="hljs-comment"># 查看加密类型</span>
getprop ro.crypto.state                  <span class="hljs-comment"># 查看加密状态</span>
vdc cryptfs checkpw                      <span class="hljs-comment"># 检查密码（需要root）</span>

<span class="hljs-comment"># f2fs调试</span>
<span class="hljs-built_in">cat</span> /sys/kernel/debug/f2fs/status        <span class="hljs-comment"># f2fs状态</span>
<span class="hljs-built_in">cat</span> /sys/fs/f2fs/&lt;device&gt;/features       <span class="hljs-comment"># f2fs特性支持</span>
f2fs_io gc /data                         <span class="hljs-comment"># 手动触发GC</span>

<span class="hljs-comment"># 性能调试</span>
systrace.py disk block f2fs              <span class="hljs-comment"># trace存储I/O</span>
perfetto --config trace.pbtxt            <span class="hljs-comment"># 深度性能分析</span>
simpleperf record -a -g --duration 10    <span class="hljs-comment"># CPU采样分析</span>
</code></pre>
<hr/>
<h3 data-id="heading-71">系列文章</h3>
<ul>
<li><a href="https://juejin.cn/post/7598390354292539438" target="_blank" title="https://juejin.cn/post/7598390354292539438">上一篇：Android 15存储子系统深度解析(二):FUSE文件系统与Scoped Storage</a></li>
</ul>
<hr/>
<p><em>欢迎来我中的<a href="https://link.juejin.cn?target=https%3A%2F%2Fhome.wonlab.top" target="_blank" title="https://home.wonlab.top" ref="nofollow noopener noreferrer">个人主页</a>找到更多有用的知识和有趣的产品</em></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Compose: Android整合yolo模型完成图像识别]]></title>    <link>https://juejin.cn/post/7599330434427027507</link>    <guid>https://juejin.cn/post/7599330434427027507</guid>    <pubDate>2026-01-26T11:12:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599330434427027507" data-draft-id="7599450177057996810" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Compose: Android整合yolo模型完成图像识别"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-01-26T11:12:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户98512003583"/> <meta itemprop="url" content="https://juejin.cn/user/1927871600799337"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Compose: Android整合yolo模型完成图像识别
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1927871600799337/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户98512003583
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T11:12:03.000Z" title="Mon Jan 26 2026 11:12:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在这个大模型飞速发展，好像大模型编程能编写一切的时代，想整点不一样的，相比于大模型来说呢有点新又有点老对大模型编程来说又做不到的东西，那就是：<strong>在手机中跑通本地图像识别模型</strong>。</p>
</blockquote>
<h2 data-id="heading-0">0. 前言</h2>
<p>既然想做这个，用什么模型呢？Yolo 模型在图像识别领域使用起来还是挺方便的，之前工作中就接触过 yolo 5 模型，去官网一看，现在都已经到 yolo 26 了，本着学新不学旧的原则，而且看起来 yolo 26 相比较于之前的模型，在识别准确率方便有着明显的优势，而且在边缘计算方便做了很大的优化，很适合在手机端部署。
<img src="https://mengfly.github.io/Obsidian-Img/ObImg/Android%E6%95%B4%E5%90%88Yolo%E6%A8%A1%E5%9E%8B_0_%E5%89%8D%E8%A8%80.png" alt="yolo26" loading="lazy"/></p>
<h3 data-id="heading-1">模型的分类</h3>
<p>yolo 提供了多种不同类型的模型，适用于不同的场景。具体的模型类别 yolo 管网都有详细的描述。这里只简单概述。
<img src="https://mengfly.github.io/Obsidian-Img/ObImg/Android%E6%95%B4%E5%90%88Yolo%E6%A8%A1%E5%9E%8B_0_%E5%89%8D%E8%A8%80_1.png" alt="" loading="lazy"/></p>
<ol>
<li>YOLO 26 ，图像识别，用于探测图像中存在有那些类别的物体，包括物体的边界框坐标</li>
<li>YOLO 26-seg，图像分割，识别图像中不同物体的边缘，进行图像分割</li>
<li>YOLO 26-pose, 人姿态识别，识别图像中的人体姿态，进行人体姿态识别</li>
<li>YOLO 26-obb, 定向边界框对象监测，允许边框旋转以更紧密地匹配物体的形状</li>
<li>YOLO 26-cls, 用于识别图像中存在有那些类别的物体，但是不包括物体的边界框坐标</li>
</ol>
<p>每种类型的模型，都提供了不同参数的模型，从n、s、m、b，分别对应不同的模型大小和准确率。
<img src="https://mengfly.github.io/Obsidian-Img/ObImg/Android%E6%95%B4%E5%90%88Yolo%E6%A8%A1%E5%9E%8B_0_%E5%89%8D%E8%A8%80_2.png" alt="" loading="lazy"/></p>
<p>我这里想做的是物体检测，受限于手机端的性能，从官方图中来看，选择 yolo26s 模型比较合适，相比较于yolo26n模型，参数没有增加多少，但是准确率上升了很多。</p>
<h2 data-id="heading-2">1. 生成 Android 可调用的 TFLite 文件</h2>
<p>首先，手机端是没办法直接使用 yolo 模型的，需要将 yolo 模型转换为 tflite 模型，通过 TensorFlow Lite 框架进行调用。所以我们需要你将 yolo 的 pt 模型文件转换为 tflite 模型文件。</p>
<p>好在，yolo 提供了非常方便的模型转换工具，直接几行代码就可以搞定，之前尝试用各种工具转换，耗时两天未成功，遗憾没有早发现这个方法。</p>
<h3 data-id="heading-3">注意事项</h3>
<ol>
<li>一定要使用一个新的 python 环境，因为编译过程中会出现各种莫名其妙的版本匹配不上的问题</li>
<li>一定要在 Linux 下面编译，某些 python 库只在 linux 下可用，比如 ai-edge-litert，别问我怎么知道的，说多了都是泪啊。</li>
<li>安装使用 python 3.10，低于 python 3.10 有些库没法使用</li>
</ol>
<h3 data-id="heading-4">安装 Yolo 与 tensorflow</h3>
<pre><code class="hljs language-sh" lang="sh">pip install ultralytics -i https://pypi.tuna.tsinghua.edu.cn/simple            

pip install tensorflow==2.19.0 -i https://pypi.tuna.tsinghua.edu.cn/simple   
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> ultralytics <span class="hljs-keyword">import</span> YOLO  
  
model = YOLO(<span class="hljs-string">"yolo26s.pt"</span>)  
  
model.export(<span class="hljs-built_in">format</span>=<span class="hljs-string">"tflite"</span>)
</code></pre>
<h2 data-id="heading-5">2. Android 整合 tflite 模型</h2>
<h3 data-id="heading-6">添加 TensorFlow 依赖</h3>
<p>在 <strong>build.gradle.kts</strong> 中添加 TFLite 依赖
<code>libs.versions.toml</code></p>
<pre><code class="hljs language-toml" lang="toml"><span class="hljs-section">[versions]</span>
<span class="hljs-attr">tensorflowLite</span> = <span class="hljs-string">"2.17.0"</span>  
<span class="hljs-attr">tensorflowLiteSupport</span> = <span class="hljs-string">"0.5.0"</span>  
<span class="hljs-attr">tensorflowLiteGpu</span> = <span class="hljs-string">"2.17.0"</span>
<span class="hljs-attr">litertGpuApi</span> = <span class="hljs-string">"1.4.1"</span>

<span class="hljs-section">[libraries]</span>
<span class="hljs-attr">tensorflow-lite-gpu</span> = { module = <span class="hljs-string">"org.tensorflow:tensorflow-lite-gpu"</span>, version.ref = <span class="hljs-string">"tensorflowLiteGpu"</span> }  
<span class="hljs-attr">tensorflow-lite-support</span> = { module = <span class="hljs-string">"org.tensorflow:tensorflow-lite-support"</span>, version.ref = <span class="hljs-string">"tensorflowLiteSupport"</span> }  
<span class="hljs-attr">tensorflow-lite</span> = { module = <span class="hljs-string">"org.tensorflow:tensorflow-lite"</span>, version.ref = <span class="hljs-string">"tensorflowLite"</span> }
<span class="hljs-attr">litert-gpu-api</span> = { group = <span class="hljs-string">"com.google.ai.edge.litert"</span>, name = <span class="hljs-string">"litert-gpu-api"</span>, version.ref = <span class="hljs-string">"litertGpuApi"</span> }
</code></pre>
<p><code>build.gradle.kts</code></p>
<pre><code class="hljs language-kts" lang="kts">dependencies {
	<span class="hljs-comment">// TFLite核心库  </span>
	implementation(libs.tensorflow.lite)  
	<span class="hljs-comment">// TFLite支持库（包含图像处理）  </span>
	implementation(libs.tensorflow.lite.support)  
	<span class="hljs-comment">// 可选：GPU加速（需要对应设备支持）  </span>
	implementation(libs.tensorflow.lite.gpu)
	implementation(libs.litert.gpu.api)
}
</code></pre>
<h3 data-id="heading-7">配置模型</h3>
<p>将生成好的 tflite 模型放在 assets 目录下，如下图所示：
yolo 会生成两种类型的文件，float32 和 float16, float32 要比 float16 模型大一倍，问了 ai 这两个就是数值精度不同，准确率几乎差别不大，除非是用于很精细识别的情形下才需要考虑使用 float32 的模型，所以这里我选择了 float16 的模型。
<img src="https://mengfly.github.io/Obsidian-Img/ObImg/Android%E6%95%B4%E5%90%88Yolo%E6%A8%A1%E5%9E%8B_2_Android_%E6%95%B4%E5%90%88_tflite_%E6%A8%A1%E5%9E%8B.png" alt="添加tflite模型到assets目录" loading="lazy"/></p>
<h3 data-id="heading-8">创建推测模型类</h3>
<p>tensorflow 通过 Interpreter 加载 tflite 模型，通过 Interpreter 的 run 方法运行模型。
<strong>TfLiteDetectModel.kt</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin">
<span class="hljs-keyword">object</span> TfLiteDetectModel {  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> TAG = <span class="hljs-string">"TfLiteModelHelper"</span>  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> MODEL_PATH = <span class="hljs-string">"yolo26s_float16.tflite"</span>  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> INPUT_SIZE = <span class="hljs-number">640</span>  
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">val</span> CONF_THRESHOLD = <span class="hljs-number">0.5f</span>  <span class="hljs-comment">// 置信度阈值（过滤低置信度结果）  </span>
  
  	<span class="hljs-comment">// 模型</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> mTfLite: Interpreter  
  
  	<span class="hljs-comment">// yolo26 使用 COCO 数据集80个类别上进行训练</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">lateinit</span> <span class="hljs-keyword">var</span> COCO_CLASSES: List&lt;Classes&gt;  
  
  	<span class="hljs-comment">// 加载类别数据，英文,中文</span>
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">loadClasses</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span> : List&lt;Classes&gt; {  
        context.assets.<span class="hljs-keyword">open</span>(<span class="hljs-string">"classes.csv"</span>).use {  
            <span class="hljs-keyword">val</span> csvReader = it.bufferedReader()  
            <span class="hljs-keyword">val</span> lines = csvReader.readLines()  
            <span class="hljs-keyword">return</span> lines.map { line -&gt;  
                <span class="hljs-keyword">val</span> split = line.split(<span class="hljs-string">","</span>)  
                Classes(  
                    us = split[<span class="hljs-number">0</span>],  
                    cn = split[<span class="hljs-number">1</span>]  
                )  
            }  
        }    
    }  
  
  	
    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">init</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>)</span></span> {  
        COCO_CLASSES = loadClasses(context)  
        <span class="hljs-keyword">try</span> {  
        	<span class="hljs-comment">// 加载模型</span>
            <span class="hljs-keyword">val</span> mappedFile = FileUtil.loadMappedFile(context, MODEL_PATH)  
            <span class="hljs-keyword">val</span> options = Interpreter.Options()  
  
            <span class="hljs-keyword">val</span> compatibilityList = CompatibilityList()  
        	<span class="hljs-comment">// 如果GPU可用的话，使用GPU</span>
            <span class="hljs-keyword">if</span> (compatibilityList.isDelegateSupportedOnThisDevice) {  
                <span class="hljs-keyword">val</span> gpuDelegate = GpuDelegate(compatibilityList.bestOptionsForThisDevice())  
                options.addDelegate(gpuDelegate)  
            } <span class="hljs-keyword">else</span> {  
                options.setNumThreads(<span class="hljs-number">4</span>)  
            }  
  
            mTfLite = Interpreter(mappedFile, options)  
            Log.d(TAG, <span class="hljs-string">"init: model <span class="hljs-variable">$MODEL_PATH</span> init success"</span>)  
        } <span class="hljs-keyword">catch</span> (e: Exception) {  
            Log.e(TAG, <span class="hljs-string">"init: model <span class="hljs-variable">$MODEL_PATH</span> init failed : <span class="hljs-subst">${e.message}</span>"</span>)  
            e.printStackTrace()  
        }  
  
    }  
  
    <span class="hljs-comment">/**  
     * 预处理图像  
     */</span>  
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">preProcessImage</span><span class="hljs-params">(bitmap: <span class="hljs-type">Bitmap</span>)</span></span>: TensorImage {  
        <span class="hljs-keyword">val</span> processor = ImageProcessor.Builder()
            <span class="hljs-comment">// 调整到yolo26需要的尺寸  </span>
            .add(ResizeOp(INPUT_SIZE, INPUT_SIZE, ResizeOp.ResizeMethod.BILINEAR))  
            <span class="hljs-comment">// 归一化</span>
            .add(NormalizeOp(<span class="hljs-number">0f</span>, <span class="hljs-number">255f</span>))  
            .build();  
  		
  		<span class="hljs-comment">// 协程处理图片</span>
        <span class="hljs-keyword">return</span> withContext(Dispatchers.IO) {  
            <span class="hljs-keyword">val</span> tensorImage = TensorImage(DataType.FLOAT32)  
            tensorImage.load(bitmap)  
            <span class="hljs-keyword">return</span><span class="hljs-symbol">@withContext</span> processor.process(tensorImage)  
        }  
    }  
  
  	<span class="hljs-comment">/**
  	 * 监测图片
  	 */</span>
    <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">detect</span><span class="hljs-params">(bitmap: <span class="hljs-type">Bitmap</span>)</span></span>: List&lt;DetectionResult&gt; {  
  
        <span class="hljs-keyword">if</span> (!::mTfLite.isInitialized) {  
            <span class="hljs-keyword">return</span> emptyList()  
        }
        <span class="hljs-comment">// 预处理图片</span>
        <span class="hljs-keyword">val</span> tensorImage = preProcessImage(convertToArgb8888IfNeeded(bitmap))  
  
  		<span class="hljs-comment">// 构建输出</span>
        <span class="hljs-keyword">val</span> outputShape = mTfLite.getOutputTensor(<span class="hljs-number">0</span>).shape()  
        <span class="hljs-keyword">val</span> output = Array(outputShape[<span class="hljs-number">0</span>]) {  
            Array(outputShape[<span class="hljs-number">1</span>]) {  
                FloatArray(outputShape[<span class="hljs-number">2</span>])  
            }  
        }  
        <span class="hljs-comment">// 执行推理  </span>
        mTfLite.run(tensorImage.buffer, output)  
        
        <span class="hljs-keyword">return</span> postProcess(output)  
    }  
  
  	<span class="hljs-comment">/**
  	 * 处理结果
  	 */</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">suspend</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">postProcess</span><span class="hljs-params">(output: <span class="hljs-type">Array</span>&lt;<span class="hljs-type">Array</span>&lt;<span class="hljs-type">FloatArray</span>&gt;&gt;)</span></span>: List&lt;DetectionResult&gt; {  
        <span class="hljs-keyword">val</span> results = mutableListOf&lt;DetectionResult&gt;()  
        withContext(Dispatchers.Default) {  
  
            <span class="hljs-keyword">val</span> detections = output[<span class="hljs-number">0</span>]  
            <span class="hljs-comment">// 结果 [left, top, right, bottom, objConf, classId]            </span>
            <span class="hljs-keyword">for</span> (det <span class="hljs-keyword">in</span> detections) {  
                <span class="hljs-keyword">val</span> objConf = det[<span class="hljs-number">4</span>]  <span class="hljs-comment">// 目标存在置信度  </span>
                <span class="hljs-keyword">if</span> (objConf &lt; CONF_THRESHOLD) <span class="hljs-keyword">continue</span>  
   
                <span class="hljs-keyword">val</span> classId = det[<span class="hljs-number">5</span>]  
  
                <span class="hljs-comment">// 解析检测框  </span>
                <span class="hljs-keyword">val</span> cx = det[<span class="hljs-number">0</span>]  
                <span class="hljs-keyword">val</span> cy = det[<span class="hljs-number">1</span>]  
                <span class="hljs-keyword">val</span> cx2 = det[<span class="hljs-number">2</span>]  
                <span class="hljs-keyword">val</span> cy2 = det[<span class="hljs-number">3</span>]  
  
                results.add(  
                    DetectionResult(  
                        classType = COCO_CLASSES[classId.toInt()],  
                        confidence = objConf,  
                        boundingBox = RectF(cx, cy, cx2, cy2)  
                    )  
                )  
            }  
        }  
        <span class="hljs-keyword">return</span> results  
    }  
  
    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">convertToArgb8888IfNeeded</span><span class="hljs-params">(bitmap: <span class="hljs-type">Bitmap</span>)</span></span>: Bitmap {  
    	<span class="hljs-comment">// 图片处理必须是ARGB_8888类型</span>
        <span class="hljs-keyword">if</span> (bitmap.config == Bitmap.Config.ARGB_8888) {  
            <span class="hljs-keyword">return</span> bitmap  
        }  
  
        <span class="hljs-comment">// 使用copy方法，自动处理硬件位图问题  </span>
        <span class="hljs-keyword">return</span> bitmap.copy(Bitmap.Config.ARGB_8888, <span class="hljs-literal">true</span>)  
  
    }  
}
</code></pre>
<h2 data-id="heading-9">3. 调用手机摄像头拍摄图像</h2>
<p>如何调用手机摄像头获取图像的内容可以参考 [[Compose调用系统相机]] 这篇文章，里面有清晰的步骤，这里直接使用获取到的图像。</p>
<h2 data-id="heading-10">4. 调用模型并绘制结果</h2>
<p>我们自定义一个组件，使用 Canvas 来绘制图片，绘制监测到的图片框以及类别名称。
该自定义组件具备一下几个特点：</p>
<ol>
<li>根据图片尺寸和组件尺寸自动缩放图片</li>
<li>图片传入后，自动调用模型进行图像识别</li>
<li>识别过程中显示加载中</li>
<li>识别完成后，绘制识别框与文字</li>
</ol>
<h3 data-id="heading-11">定义组件</h3>
<p>组件传入图片、为了方便扩展，将模型也放到组件参数中，识别到结果后的回调函数，方便把识别结果提供给父组件。</p>
<p><strong>DetectImageView.kt</strong></p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>  
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">DetectImageView</span><span class="hljs-params">(  
    bitmap: <span class="hljs-type">Bitmap</span>,  
    modifier: <span class="hljs-type">Modifier</span> = Modifier,  
    model: <span class="hljs-type">TfLiteDetectModel</span> = TfLiteDetectModel,  
    onResult: (<span class="hljs-type">List</span>&lt;<span class="hljs-type">DetectionResult</span>&gt;) -&gt; <span class="hljs-type">Unit</span> = {}  
)</span></span> {
	
	Canvas(  
    modifier = modifier  
        .padding(<span class="hljs-number">10.</span>dp)  
        <span class="hljs-comment">// 圆角背景</span>
        .background(Color.White, RoundedCornerShape(<span class="hljs-number">10.</span>dp)),  
	) {
		<span class="hljs-comment">// 绘制内容</span>
	}
}
</code></pre>
<h3 data-id="heading-12">绘制图片</h3>
<p>绘制图片调用 drawImage，为了让图片自适应组件大小，需要根据组件的大小和图片的大小进行缩放。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">DetectImageView</span><span class="hljs-params">(...)</span></span> {
	Canvas(..) {
		<span class="hljs-keyword">val</span> canvasWidth = size.width  
		<span class="hljs-keyword">val</span> canvasHeight = size.height  
		<span class="hljs-keyword">val</span> bitmapWidth = bitmap.width.toFloat()  
		<span class="hljs-keyword">val</span> bitmapHeight = bitmap.height.toFloat()  
		  
		<span class="hljs-comment">// 计算缩放比例，确保图片完全显示在Canvas内  </span>
		<span class="hljs-keyword">val</span> scale = minOf(  
		    canvasWidth / bitmapWidth,  
		    canvasHeight / bitmapHeight  
		)  
		  
		<span class="hljs-comment">// 计算缩放后的图片尺寸  </span>
		<span class="hljs-keyword">val</span> scaledWidth = (bitmapWidth * scale).toInt()  
		<span class="hljs-keyword">val</span> scaledHeight = (bitmapHeight * scale).toInt()  
		  
		<span class="hljs-comment">// 计算居中偏移量  </span>
		<span class="hljs-keyword">val</span> offsetX = ((canvasWidth - scaledWidth) / <span class="hljs-number">2f</span>).toInt()  
		<span class="hljs-keyword">val</span> offsetY = ((canvasHeight - scaledHeight) / <span class="hljs-number">2f</span>).toInt()  
		  
		<span class="hljs-comment">// 绘制图片  </span>
		drawImage(  
		    image = bitmap.asImageBitmap(),  
		    dstSize = IntSize(scaledWidth, scaledHeight),  
		    dstOffset = IntOffset(offsetX, offsetY)  
		)
	}

}

</code></pre>
<h3 data-id="heading-13">绘制模型结果</h3>
<p>绘制模型结果需要调用模型，调用模型是一个耗时方法，我们需要将它放到协程中执行。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>  
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">DetectImageView</span><span class="hljs-params">(...,onResult: (<span class="hljs-type">List</span>&lt;<span class="hljs-type">DetectionResult</span>&gt;) -&gt; <span class="hljs-type">Unit</span> = {})</span></span> {
	
	<span class="hljs-comment">// 存放模型结果</span>
	<span class="hljs-keyword">var</span> res: List&lt;DetectionResult&gt; <span class="hljs-keyword">by</span> remember { mutableStateOf(emptyList()) }  
	<span class="hljs-comment">// 是否正在加载模型结果</span>
	<span class="hljs-keyword">var</span> isLoading <span class="hljs-keyword">by</span> remember { mutableStateOf(<span class="hljs-literal">false</span>) }  
	<span class="hljs-comment">// 测量文字</span>
	<span class="hljs-keyword">val</span> textMeasurer = rememberTextMeasurer()
	<span class="hljs-comment">// 模型成功后的回调</span>
	<span class="hljs-keyword">val</span> resultCallback <span class="hljs-keyword">by</span> rememberUpdatedState(onResult)

	<span class="hljs-comment">// 调用模型，这里使用bitmap为键，只要图片该表，就重新调用模型</span>
	LaunchedEffect(bitmap) {  
	    isLoading = <span class="hljs-literal">true</span>  
	    res = model.detect(bitmap)    
	    isLoading = <span class="hljs-literal">false</span>  
	    <span class="hljs-comment">// 调用回调向组件外传输模型调用后的结果</span>
	    resultCallback(res)  
	}
	
	Canvas(..) {
		<span class="hljs-comment">// ... 绘制图片逻辑</span>
		
		<span class="hljs-comment">// 绘制结果</span>
		drawBounds(textMeasurer, res, offsetX, offsetY, scaledWidth, scaledHeight)
	}
}

<span class="hljs-comment">/**  
 * 绘制检测结果  
 * <span class="hljs-doctag">@param</span> res 检测结果  
 * <span class="hljs-doctag">@param</span> offsetX 图片在Canvas中的X轴偏移量  
 * <span class="hljs-doctag">@param</span> offsetY 图片在Canvas中的Y轴偏移量  
 * <span class="hljs-doctag">@param</span> scaledWidth 图片缩放后的宽度  
 * <span class="hljs-doctag">@param</span> scaledHeight 图片缩放后的高度  
 */</span>  
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> DrawScope.<span class="hljs-title">drawBounds</span><span class="hljs-params">(  
    textMeasurer: <span class="hljs-type">TextMeasurer</span>,  
    res: <span class="hljs-type">List</span>&lt;<span class="hljs-type">DetectionResult</span>&gt;,  
    offsetX: <span class="hljs-type">Int</span>, offsetY: <span class="hljs-type">Int</span>,  
    scaledWidth: <span class="hljs-type">Int</span>, scaledHeight: <span class="hljs-type">Int</span>  
)</span></span> {  
  
    <span class="hljs-comment">// 绘制检测结果  </span>
    res.forEach { detectionResult -&gt;  
  		
  		<span class="hljs-comment">// 计算边框位置</span>
        <span class="hljs-keyword">val</span> left = offsetX + detectionResult.boundingBox.left * scaledWidth  
        <span class="hljs-keyword">val</span> top = offsetY + detectionResult.boundingBox.top * scaledHeight  
  
        <span class="hljs-keyword">val</span> right = offsetX + detectionResult.boundingBox.right * scaledWidth  
        <span class="hljs-keyword">val</span> bottom = offsetY + detectionResult.boundingBox.bottom * scaledHeight  
  
        drawRect(  
            style = Stroke(width = <span class="hljs-number">5f</span>),  
            color = Color.Red, topLeft = Offset(  
                left,  
                top  
            ), size = Size(  
                right - left,  
                bottom - top  
            )  
        )  
  
        <span class="hljs-keyword">val</span> layoutResult = textMeasurer.measure(detectionResult.classType.cn)  
  
        drawText(  
            layoutResult,  
            color = Color.Red,  
            topLeft = Offset(left, top - layoutResult.size.height)  
        )  
  
    }  
}
</code></pre>
<p>这里的返回结果回调使用了 rememberUpdatedState，这是因为模型是在协程中调用，为了防止回调方法被修改后导致的问题，使用 rememberUpdatedState 保持回调的最新引用。具体详情可以参考[[用rememberUpdatedState解决Compose协程中的“旧回调”问题]] 这篇文章。</p>
<h3 data-id="heading-14">绘制加载中</h3>
<p>加载中比较难绘制，Compose 是状态决定组件，状态不改变，组件显示行为就不会改变，所以我们得需要让加载内容动起来就需要不停地修改加载内容的状态。</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">DetectImageView</span><span class="hljs-params">(...)</span></span> {

	<span class="hljs-comment">// 记录加载中的圆环角度</span>
	<span class="hljs-keyword">var</span> loadingRotation <span class="hljs-keyword">by</span> remember { mutableFloatStateOf(<span class="hljs-number">0f</span>) }
	
	<span class="hljs-comment">// 监听isLoading状态，只要isLoading改变，就启动协程，不断修改圆环角度</span>
	LaunchedEffect(isLoading) {  
		<span class="hljs-keyword">while</span> (isLoading) {  
			loadingRotation += <span class="hljs-number">5f</span>  
	  
			<span class="hljs-keyword">if</span> (loadingRotation &gt;= <span class="hljs-number">360f</span>) {  
				loadingRotation = <span class="hljs-number">0f</span>  
			}  
			delay(<span class="hljs-number">10</span>)  
		}  
	}
	Canvas(..) {
			
		<span class="hljs-comment">// 如果正在加载，显示加载内容</span>
		<span class="hljs-keyword">if</span>(isLoading) run {
			<span class="hljs-comment">// 绘制loading圆环</span>
			drawLoading(canvasWidth, canvasHeight, loadingRotation)  
  
			<span class="hljs-comment">//  绘制遮罩  </span>
			drawRect(  
			    color = Color.Gray.copy(alpha = <span class="hljs-number">0.5f</span>),  
			    size = size  
			)
		}
	}
}

<span class="hljs-comment">/**  
 * 绘制加载中  
 */</span>  
<span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> DrawScope.<span class="hljs-title">drawLoading</span><span class="hljs-params">(canvasWidth: <span class="hljs-type">Float</span>, canvasHeight: <span class="hljs-type">Float</span>, rotation: <span class="hljs-type">Float</span> = <span class="hljs-number">0</span>f)</span></span> {  
    <span class="hljs-comment">// 绘制不停转圈的图标  </span>
    <span class="hljs-keyword">val</span> centerX = canvasWidth / <span class="hljs-number">2f</span>  
    <span class="hljs-keyword">val</span> centerY = canvasHeight / <span class="hljs-number">2f</span>  
    <span class="hljs-keyword">val</span> radius = <span class="hljs-number">30f</span>  
    <span class="hljs-keyword">val</span> strokeWidth = <span class="hljs-number">8f</span>  
  
    <span class="hljs-comment">// 绘制背景圆  </span>
    drawCircle(  
        color = Color.Gray.copy(alpha = <span class="hljs-number">0.3f</span>),  
        radius = radius,  
        center = Offset(centerX, centerY),  
        style = Stroke(width = strokeWidth)  
    )  
  
    <span class="hljs-comment">// 绘制旋转的弧形  </span>
  
    drawArc(  
        color = Color.Blue,  
        startAngle = rotation,  
        sweepAngle = <span class="hljs-number">90f</span>,  
        useCenter = <span class="hljs-literal">false</span>,  
        topLeft = Offset(centerX - radius, centerY - radius),  
        size = Size(radius * <span class="hljs-number">2</span>, radius * <span class="hljs-number">2</span>),  
        style = Stroke(width = strokeWidth, cap = Stroke.DefaultCap)  
    )  
}

</code></pre>
<h2 data-id="heading-15">5. 页面中整合组件</h2>
<p><strong>MainActivity.kt</strong>
在页面中使用就比较简单了，直接引用就可以了</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@Composable</span>  
<span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">MainContentView</span><span class="hljs-params">()</span></span> {
	
	<span class="hljs-keyword">var</span> capturedImageBitmap <span class="hljs-keyword">by</span> remember { mutableStateOf&lt;Bitmap?&gt;(<span class="hljs-literal">null</span>) }
	<span class="hljs-keyword">var</span> res <span class="hljs-keyword">by</span> remember { mutableStateOf(listOf&lt;DetectionResult&gt;()) }
	<span class="hljs-comment">// 调用相机获取图片， 此内容参考 Compose中调用相机文章</span>
	
	<span class="hljs-keyword">if</span> (capturedImageBitmap != <span class="hljs-literal">null</span>) {  
	    Column(modifier = Modifier.padding(innerPadding)) {  
	        Card(  
	            modifier = Modifier  
	                .weight(<span class="hljs-number">1.0f</span>)  
	                .padding(<span class="hljs-number">16.</span>dp)  
	                .fillMaxSize(),  
	        ) {  
	            DetectImageView(  
	                capturedImageBitmap!!,  
	                modifier = Modifier.fillMaxSize()  
	            ) {  
	                res  = it  
	            }  
	        }  
	        Column(  
	            modifier = Modifier  
	                .verticalScroll(rememberScrollState())  
	                .heightIn(<span class="hljs-number">0.</span>dp, <span class="hljs-number">200.</span>dp)  
	        ) {  
	            Text(  
	                <span class="hljs-string">"识别结果"</span>,  
	                modifier = Modifier.padding(horizontal = <span class="hljs-number">16.</span>dp),  
	                style = MaterialTheme.typography.titleLarge  
	            )  
	            FlowRow(  
	                modifier = Modifier.padding(<span class="hljs-number">16.</span>dp),  
	                horizontalArrangement = Arrangement.spacedBy(<span class="hljs-number">8.</span>dp)  
	            ) {  
	                <span class="hljs-keyword">for</span> (detectionResult <span class="hljs-keyword">in</span> res) {  
	                    ElevatedAssistChip(onClick = {}, label = {  
	                        Text(text = detectionResult.classType.cn)  
	                    })  
	                }  
	            }  
	        }    
	    }  
	}
}
</code></pre>
<p>最终结果如下：
<img src="https://mengfly.github.io/Obsidian-Img/ObImg/Android%E6%95%B4%E5%90%88Yolo%E6%A8%A1%E5%9E%8B_5_%E9%A1%B5%E9%9D%A2%E4%B8%AD%E6%95%B4%E5%90%88%E7%BB%84%E4%BB%B6.gif" alt="" loading="lazy"/></p>
<h2 data-id="heading-16">6.后续计划</h2>
<p>仅仅整合进来 yolo 的模型是远远不够的，目前 yolo 仅可以识别 80 种类别的物品，如何让 yolo 识别其他没见过的物品才是模型可以使用的关键。所以后续计划有两个：</p>
<ol>
<li>研究如何在手机端对模型进行训练，针对没见过的图片进行专项训练</li>
<li>yolo 还有一个 yoloe 模型，意为分割一切模型，不过转 tffile 没转成功，研究一下如何转换，利用 yoloe 在手机端分割图像，分割后形成样本，进行训练。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入剖析 Skills.md —— 不是炒冷菜，而是 Agent 的“操作手册”]]></title>    <link>https://juejin.cn/post/7599551824548036634</link>    <guid>https://juejin.cn/post/7599551824548036634</guid>    <pubDate>2026-01-26T21:25:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599551824548036634" data-draft-id="7599538010725548059" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入剖析 Skills.md —— 不是炒冷菜，而是 Agent 的“操作手册”"/> <meta itemprop="keywords" content="架构"/> <meta itemprop="datePublished" content="2026-01-26T21:25:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MobotStone"/> <meta itemprop="url" content="https://juejin.cn/user/3839909554568840"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入剖析 Skills.md —— 不是炒冷菜，而是 Agent 的“操作手册”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3839909554568840/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MobotStone
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T21:25:07.000Z" title="Mon Jan 26 2026 21:25:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如果要选一个“2025 年底最火的概念词”，那大概率就是<strong>skills</strong> 了。</p>
<p>但我刚打开<code>skill.md</code> 的时候，老实说第一眼直接看懵：我脑子里冒出的念头是——这是不是又在“重复造轮子”？</p>
<p>毕竟大家早就会做<strong>Agent 工具</strong>了，用来让智能体真正去执行任务。在不同平台和生态里，这类东西只是叫法不同：有人叫<strong>tools（工具）</strong> ，有人叫<strong>plugins（插件）</strong> ，也有人叫<strong>skills（技能）</strong> 。所以我一开始理所当然地以为：这不就是同一种东西换个包装、换个名字吗？</p>
<p>结果我继续往下研究，才发现事情没这么简单。我彻底理清了<code>skill.md</code>的定义，也理解了 Anthropic 推出它的战略意图。事实证明，它与传统的 Agent 工具之间，存在著关键性的差异。</p>
<h3 data-id="heading-0">核心区别：“脑子”里的想法 vs “手里”的工具</h3>
<p>简单来说，这两者的区别就像是 “操作手册” 和 “工具箱” 的区别。</p>
<h4 data-id="heading-1">1. Agent Skills：装在脑子里的“做事套路”</h4>
<p><strong>Agent Skills</strong>就像给一个新来的实习生发了一本<strong>工作手册</strong>，或者说一套<strong>技能秘籍</strong>。</p>
<ul>
<li>它是一份标准化的教程（通常写在<code>skill.md</code>文件里）。</li>
<li>它教AI遇到某种任务时该怎么动脑子：
第一步干啥，第二步干啥，有哪些细节要注意。</li>
</ul>
<p><strong>举个例子</strong>：如果这是做菜的技能，那它就是**“回锅肉的菜谱”**。
它告诉AI：先切肉、再炒青椒、最后加调料——每个步骤的节奏都列得明明白白。</p>
<ul>
<li>Skill = “做事方法”，让AI知道<strong>该怎么干</strong>。</li>
</ul>
<h4 data-id="heading-2">2. Agent Tools：拿在手里的工具</h4>
<p><strong>Tools</strong>是AI手里真正能用的<strong>工具</strong>。</p>
<ul>
<li>比如：电脑的命令行、读取文件的接口、联网搜索用的API……
举个例子：在厨房里，Skills是“菜谱”，而Tools就是<strong>菜刀、炒锅和燃气灶</strong>。
它们不会自己炒菜，但没有它们，连锅都上不了。</li>
<li>Tool = “操作能力”，让AI<strong>能动手去干</strong>。</li>
</ul>
<p><strong>一句话总结：</strong></p>
<ul>
<li><strong>skills</strong>告诉智能体“怎么做”——是经验和方法；</li>
<li>tools让智能体“能动手”——是执行的能力。
而且，一个技能往往会指导智能体用合适的工具去完成任务。</li>
</ul>
<h3 data-id="heading-3">skills.md 解决了哪些问题？</h3>
<p>既然工具已经存在，为什么还需要这种新格式？它解决了五个具体问题。</p>
<h4 data-id="heading-4">1. 把“能做”变成“会做”</h4>
<ul>
<li><strong>以前的问题</strong>：AI 工具很强，比如能发邮件、能查数据，但它不知道你们公司的“潜规则”或具体流程。就像一个有力气的员工，却不知道该先迈哪条腿。</li>
<li><strong>现在的方案</strong>：<code>skills.md</code> 不仅给 AI 赋予行动能力，还把“什么时候做”以及“结合公司/团队/用户的具体情况该怎么做”的背景知识一起打包给它。</li>
</ul>
<h4 data-id="heading-5">2. 不一次性塞太多信息</h4>
<ul>
<li><strong>以前的问题</strong>：为了让 AI 懂得多，把所有资料一股脑全塞进它的对话记忆里（Context），导致它运行缓慢，而且容易“消化不良”（上下文膨胀）。</li>
<li><strong>现在的方案</strong>：这是一种“省流模式”。刚开始只加载一个大概的“目录”（极小的内存占用），等真要用这个技能时，再加载详细的说明书，需要素材时再加载素材。</li>
</ul>
<h4 data-id="heading-6">3. 一次编写，到处通用</h4>
<ul>
<li><strong>以前的问题</strong>：很多工具是“专机专用”的，换一个 AI 平台就得重写。</li>
<li><strong>现在的方案</strong>：<code>skills.md</code> 就像一个通用的 USB 设备。你把技能包做好一次，就可以插到各种不同的 AI 代理（Agent）产品上直接使用，不用重复造轮子。</li>
</ul>
<h4 data-id="heading-7">4. 把“老专家的经验”打包</h4>
<ul>
<li><strong>以前的问题</strong>：复杂的流程（比如法律合规、数据处理）很难传递，往往依赖人的口口相传。</li>
<li><strong>现在的方案</strong>：它可以把这些专业的、复杂的流程封装成一个标准的“技能包”。这个包有版本记录、可以被审计，方便在不同团队之间安全地共享专业经验。</li>
</ul>
<h4 data-id="heading-8">5. 只要识字就能看懂</h4>
<ul>
<li><strong>以前的问题</strong>：很多工具的逻辑写在复杂的代码里，想搞清楚它到底怎么运行的，像读天书一样难。</li>
<li><strong>现在的方案</strong>：<code>skills.md</code>本质上就是一份 Markdown 格式的文档。它不仅机器能读，<strong>人也能轻松阅读</strong>。无论是检查、修改还是优化，都像编辑普通文档一样简单直观。</li>
</ul>
<h3 data-id="heading-9">案例分析: HR Skill</h3>
<p>以下是skill.md文件的实际示例。</p>
<pre><code class="hljs language-markdown" lang="markdown">--- 名称：人力资源问题解答
<span class="hljs-section">描述：解答与人力资源相关的问题，包括政策、福利、请假、入职和员工指南。
---</span>
<span class="hljs-section"># 人力资源问题处理</span>
<span class="hljs-section">## 何时使用此技能</span>
当用户询问以下问题时，请使用此技能：
<span class="hljs-bullet">-</span> 公司政策（考勤、着装规范、远程办公）
<span class="hljs-bullet">-</span> 福利（医疗保险、退休计划、带薪休假）
<span class="hljs-bullet">-</span> 请假（年假、病假、育儿假）
<span class="hljs-bullet">-</span> 入职和离职流程
<span class="hljs-bullet">-</span> 绩效考核和反馈流程
<span class="hljs-bullet">-</span> 薪酬和工资相关问题

<span class="hljs-section">## 如何解答人力资源问题</span>
<span class="hljs-bullet">1.</span> 根据用户的问题确定人力资源主题
<span class="hljs-bullet">2.</span> 参考相应的公司政策文件
<span class="hljs-bullet">3.</span> 提供清晰准确的信息
<span class="hljs-bullet">4.</span> 对于敏感或复杂的问题，请转介给人力资源联系人

<span class="hljs-section">## 重要准则</span>
<span class="hljs-bullet">-</span> 切勿泄露员工机密信息
<span class="hljs-bullet">-</span> 将法律或合规问题上报人力资源主管
<span class="hljs-bullet">-</span> 始终在适用情况下引用相关政策文件 # 人力资源问题处理
</code></pre>
<p>它存储在以下文件夹结构中：</p>
<pre><code class="hljs language-perl" lang="perl"><span class="hljs-keyword">my</span>-skill/
├── SKILL.md          <span class="hljs-comment"># 必需：说明 + 元数据</span>
├── scripts/          <span class="hljs-comment"># 可选：可执行代码</span>
├── references/       <span class="hljs-comment"># 可选：文档</span>
└── assets/           <span class="hljs-comment"># 可选：模板、资源</span>
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e95a70b63ec46f7ba2237224a9c2b54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTW9ib3RTdG9uZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770067508&amp;x-signature=nBGvWUvIjHzQkZknwfXPMmh5ROI%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">skill是怎么工作的</h2>
<p>技能采用<strong>渐进式展开</strong>来高效管理上下文。</p>
<ul>
<li><strong>发现阶段：</strong> 启动时，智能体只加载每个技能的名称和简介。信息够用来判断“这个技能可能用得上吗？”</li>
<li>**激活阶段：**当任务和某个技能的描述匹配时，智能体才会把完整的<code>SKILL.md</code> 说明读进上下文。</li>
<li><strong>执行阶段：</strong> 智能体按说明操作，必要时再加载相关文件或运行打包的代码。</li>
</ul>
<p>这样既能保持速度，又能在需要时获取更多信息。核心要点就是<strong>渐进式信息披露</strong>：省 token，减少提示词膨胀。</p>













































<table><thead><tr><th>特性</th><th>Skills.md  (Agent Skills)</th><th>Agent</th></tr></thead><tbody><tr><td>核心概念</td><td>知识与专长： 告诉Agent如何以及何时处理复杂任务的“剧本”。</td><td>机制与动作： 允许Agent与外部世界（API、系统）交互的“双手”。</td></tr><tr><td>主要功能</td><td>提供上下文、工作流、规则和最佳实践。它负责编排推理过程。</td><td>执行特定的、确定性的功能，如查询数据库、写文件或发送电子邮件。</td></tr><tr><td>文件结构</td><td>一个包含 <a href="https://link.juejin.cn?target=http%3A%2F%2Fskill.md" target="_blank" title="http://skill.md" ref="nofollow noopener noreferrer">skill.md</a> 文件（Markdown 指令 + YAML 元数据）和可选资源文件的文件夹。</td><td>一个架构（通常是 JSON），定义函数名称、参数、描述以及运行它们的后端代码。</td></tr><tr><td>上下文管理</td><td>渐进式披露： 开始时仅加载微量的元数据（约 100 个 token）。仅在相关时才加载完整指令。</td><td>预先加载： 通常需要在会话开始时将完整的工具定义和架构加载到上下文窗口中。</td></tr><tr><td>相互关系</td><td>一个“skill”通常会使用“tool”。它充当管理者的角色，指导使用哪些tool以及按什么顺序使用。</td><td>“工具”由Agent（或技能）使用。它们是等待被调用的原始实用程序。</td></tr><tr><td>可移植性</td><td>知识的高可移植性（它只是文本/Markdown），但目前的格式特定于某些Agent运行时（如 Anthropic 的运行时）。</td><td>如果使用 MCP（模型上下文协议）等标准，则具有很高的执行可移植性，允许一个工具在许多应用程序中工作。</td></tr><tr><td>示例用例</td><td>“教Agent如何编写代码审查”（例如：检查逻辑错误、礼貌性、使用 Git 提取代码）。</td><td>“运行 API 调用”（例如：执行从代码库中检索数据的特定命令）。</td></tr></tbody></table>
<h3 data-id="heading-11">总结：给 AI 装上“方向盘”</h3>
<p>回到一开始的问题：<strong>不，我们并不是在重复造轮子。我们只是意识到：一辆车想开得好，光有轮子不够——还得有</strong>方向盘和<strong>地图</strong>。
“Agent Tools”确实释放了很强的能力：它们让 AI 能接触真实世界、查询数据库、执行代码。但<strong>有能力</strong>不等于<strong>会做事、做得对</strong>。
Skills.md 正是用来补上“能做”和“做得好”之间的差距。</p>
<ul>
<li><strong>Tools</strong>解决的是“怎么执行”的问题：点按钮、调接口、跑代码。</li>
<li><strong>Skills</strong>解决的是“怎么做才对”的问题：流程、上下文、细节拿捏与判断。</li>
</ul>
<p>当我们走向更自动化的智能体时，真正的瓶颈往往不是“它能不能做这个动作”，而是“它知不知道你们团队规定的、那个<strong>明确的 10 步标准流程</strong>，并按要求做到位”。把“<strong>怎么做（Skills，方法与规范）</strong> ”和“<strong>能做什么（Tools，执行能力）</strong> ”分开后，智能体就不只是强大，还会更<strong>可靠、合规、高效</strong>。</p>
<p>如果你只是做一些简单机器人，可能工具就够用；但如果你要做的是“数字员工”，那就必须要有技能（Skills）。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Skip 开源：从“卖工具”到“卖信任”的豪赌 -- 肘子的 Swift 周报 #120]]></title>    <link>https://juejin.cn/post/7599551824548102170</link>    <guid>https://juejin.cn/post/7599551824548102170</guid>    <pubDate>2026-01-27T00:13:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599551824548102170" data-draft-id="7598563188112408628" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Skip 开源：从“卖工具”到“卖信任”的豪赌  -- 肘子的 Swift 周报 #120"/> <meta itemprop="keywords" content="Swift,SwiftUI,人工智能"/> <meta itemprop="datePublished" content="2026-01-27T00:13:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="东坡肘子"/> <meta itemprop="url" content="https://juejin.cn/user/1548526032528727"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Skip 开源：从“卖工具”到“卖信任”的豪赌  -- 肘子的 Swift 周报 #120
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1548526032528727/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    东坡肘子
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T00:13:32.000Z" title="Tue Jan 27 2026 00:13:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b11674cfc1bc4751bbf23cc5921a6ded~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lic5Z2h6IKY5a2Q:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770077612&amp;x-signature=9RC%2FMUBymc7beiCja1OVV9MNfe4%3D" alt="issue120.webp" loading="lazy"/></p>
<h2 data-id="heading-0">Skip 开源：从“卖工具”到“卖信任”的豪赌</h2>
<p>在宣布 <a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-110%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-110/" ref="nofollow noopener noreferrer">Fuse 版本对独立开发者免费</a> 仅两个月后，Skip Tools 再次做出惊人之举——<a href="https://link.juejin.cn?target=https%3A%2F%2Fskip.dev%2Fblog%2Fskip-is-free%2F%3Futm_source%3Dfatbobman%2520weekly%2520issue%2520120%26utm_medium%3Dweb" target="_blank" title="https://skip.dev/blog/skip-is-free/?utm_source=fatbobman%20weekly%20issue%20120&amp;utm_medium=web" ref="nofollow noopener noreferrer">全面免费并开源核心引擎 skipstone</a>。这意味着 Skip 彻底改变了经营方式：从“卖产品”转向“卖服务+社区赞助”。这次变化，既有对之前商业模式执行不佳而被迫调整的无奈，也体现了 Skip 团队的果敢——在当前 AI 盛行、开发工具格局固化的背景下，主动求变，力求突破。</p>
<p>很多优秀且有特点的产品没能获得应有的使用量，最大的阻碍往往不是技术，而是“信任”。正如 Skip 官方所言，企业最担心的是“rug pull”——万一公司倒闭或被收购，押注在这个工具上的产品和技术栈将面临推倒重来的风险。Skip 希望通过开源消除这种信任危机，让自己和其他跨平台工具站在同一起跑线上，同时激活社区力量，加速生态建设。</p>
<p>尽管社区对 Skip 的开源决定给予了充分肯定，但也有不少人担心：在放弃了 license key 这一稳定收入来源后，仅靠赞助模式能否支撑持续开发成本？毕竟，成功的开源商业案例虽有，但失败的也不少。这种担忧并非杞人忧天。在我撰写本期周报时（宣布开源数天后），尽管开源消息在社交媒体上引发了热议，但在 GitHub 上，Skip 的个人赞助者仅有十几位。从“热闹的讨论”到“真金白银的支持”，中间的鸿沟似乎比想象中还要深。这或许也解释了为什么 Skip 最终选择了开源——在无法说服开发者"付费使用"时，至少要争取到他们"免费使用"的机会。</p>
<p>一个有趣的现象是，在肯定与忧虑并存的情绪中，讨论的焦点悄然发生了变化：从“为什么要花钱买 Skip 而不是用免费的 KMP?”变成了“你是更喜欢写 Swift 还是 Kotlin?”。这个转变意义重大——它意味着 Skip 已经成功将竞争维度从“商业模式”转移到了“语言生态”，而参与竞争的主体也从“一家小公司”扩展为“整个 Swift 社区”。在这场语言之争中，Skip 聪明地（或许是无意间）将自己的角色从“主角”变成了“基础设施”。</p>
<p>Skip 最早的出发点是看到了一个商业机会，认为有足够的商业回报。如果不是有这样的预期，仅靠官方或社区的力量，Swift 可能无法快速推进在其他平台上的进展。这一路径与 The Browser Company 为了打造 Arc 浏览器而大力推动 Swift 在 Windows 平台上的适配如出一辙。</p>
<p>作为一个 Swift 开发者，我由衷希望 Skip 的这次调整能够取得预期效果。开源是一场信任的实验，也是一次生态的投资。如果你也期待 Swift 能在 iOS 之外的平台上拥有更多可能，不妨从成为一个<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fsponsors%2Fskiptools" target="_blank" title="https://github.com/sponsors/skiptools" ref="nofollow noopener noreferrer">独立赞助者</a>($10/月)做起——这不仅是对 Skip 的支持，更是对整个 Swift 跨平台生态的投票。开源的 Skip 能走多远，取决于有多少人愿意从旁观者变成参与者。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-120%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-120/" ref="nofollow noopener noreferrer">本期内容</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-119%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-119/" ref="nofollow noopener noreferrer">前一期内容</a> | <a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2F" target="_blank" title="https://fatbobman.com/zh/weekly/" ref="nofollow noopener noreferrer">全部周报列表</a></p>
<blockquote>
<p>🚀 <strong>《肘子的 Swift 周报》</strong></p>
<p>每周为你精选最值得关注的 Swift、SwiftUI 技术动态</p>
<ul>
<li><strong>📮 立即订阅</strong> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fweekly.fatbobman.com%2Ffatbobman" target="_blank" title="https://weekly.fatbobman.com/fatbobman" ref="nofollow noopener noreferrer">weekly.fatbobman.com</a> 获取完整内容</li>
<li><strong>👥 加入社区</strong> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscord.com%2Finvite%2F7FedN5E2QQ" target="_blank" title="https://discord.com/invite/7FedN5E2QQ" ref="nofollow noopener noreferrer">Discord</a> 与 2000+ 开发者交流</li>
<li><strong>📚 深度教程</strong> | <a href="https://link.juejin.cn?target=http%3A%2F%2Ffatbobman.com" target="_blank" title="http://fatbobman.com" ref="nofollow noopener noreferrer">fatbobman.com</a> 探索 200+ 原创文章</li>
</ul>
</blockquote>
<h2 data-id="heading-1">原创</h2>
<h3 data-id="heading-2"><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fposts%2Fletting-swift-closures-automatically-inherit-isolation%2F%3Futm_source%3Dfatbobman%2520weekly%2520issue%2520120%26utm_medium%3Dweb" target="_blank" title="https://fatbobman.com/zh/posts/letting-swift-closures-automatically-inherit-isolation/?utm_source=fatbobman%20weekly%20issue%20120&amp;utm_medium=web" ref="nofollow noopener noreferrer">isolated(any) 与 #isolation：让 Swift 闭包自动继承隔离域</a></h3>
<p>Swift 6 为并发引入了许多新功能与关键字。虽然其中不少内容在日常开发中可能鲜少用到，但一旦遭遇特定场景，若对这些新概念缺乏了解，即便有 AI 辅助也可能陷入僵局。本文将通过一个在开发测试中遇到的实际并发问题，来介绍如何利用 <strong><code>@isolated(any)</code></strong> 以及 <strong><code>#isolation</code></strong> 宏，实现函数的隔离域继承，从而让编译器自动推断闭包的运行环境。</p>
<h2 data-id="heading-3">近期推荐</h2>
<h3 data-id="heading-4"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0120-01" target="_blank" title="https://l.fatbobman.com/w0120-01" ref="nofollow noopener noreferrer">SwiftData 数据迁移全解析 (A Deep Dive into SwiftData migrations)</a></h3>
<p>随着应用的发展，数据模型几乎无可避免地会出现变化，如何安全地进行数据迁移对很多开发者来说都是一个不小的挑战。在本文中，<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fdonnywals" target="_blank" title="https://x.com/donnywals" ref="nofollow noopener noreferrer">Donny Wals</a> 全面讲解了 SwiftData 的数据迁移机制，从基础的版本控制到复杂的自定义迁移策略。其中，Donny 给出了几个特别有价值的建议：即使是 V1 版本也应该使用 <code>VersionedSchema</code> 进行封装，为未来的迁移打好基础；只在 App Store 发布周期之间引入新的 Schema 版本，而不是在开发过程中频繁修改；对于轻量迁移，即使 SwiftData 可以自动完成，也建议显式地写入 <code>SchemaMigrationPlan</code> 中，使意图更加明确且易于测试。</p>
<p>文章的一大亮点是详细解释了 <code>MigrationStage.custom</code> 中 <code>willMigrate</code> 与 <code>didMigrate</code> 的适用场景，并提出了应对复杂重构（例如拆分实体）的“桥接版本（Bridge Version）”策略。</p>
<hr/>
<h3 data-id="heading-5"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0120-02" target="_blank" title="https://l.fatbobman.com/w0120-02" ref="nofollow noopener noreferrer">为什么 MVVM-C 在 SwiftUI 项目中依然能扩展 (Why MVVM-C with Coordinators does Scale -&gt; A real-world SwiftUI perspective)</a></h3>
<p>尽管标题中包含“MVVM-C”，但这并非一篇单纯为某种架构模式辩护的文章。<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.linkedin.com%2Fin%2Fvalentebruno%2F" target="_blank" title="https://www.linkedin.com/in/valentebruno/" ref="nofollow noopener noreferrer">Bruno Valente Pimentel</a> 在文中重新定义了“扩展性”的内涵——它不应仅以屏幕或文件的数量来衡量，而应看其是否支持高效的多人协作及功能的独立演进。正如作者所言：“架构无关乎模式，而关乎减少恐惧”——减少修改代码、团队协作以及功能演进时的恐惧。</p>
<blockquote>
<p>无论你倾向于哪种架构模式，在用它构建 SwiftUI 项目时，都应该认真思考：我们到底是在利用 SwiftUI 的特性，还是在试图把 SwiftUI 改造成我们熟悉的 UIKit？</p>
</blockquote>
<hr/>
<h3 data-id="heading-6"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0120-03" target="_blank" title="https://l.fatbobman.com/w0120-03" ref="nofollow noopener noreferrer">TCA 架构的真实评估 (TCA (Composable Architecture): The Honest Review)</a></h3>
<p>继 Bruno 为 MVVM-C “正名”后，<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.linkedin.com%2Fin%2Fchandrawelim%2F" target="_blank" title="https://www.linkedin.com/in/chandrawelim/" ref="nofollow noopener noreferrer">Chandra Welim</a> 对另一个极具争议的架构——TCA 进行了客观评估。作者总结了 TCA 的五大优势（可预测的状态管理、优秀的可测试性、时间旅行调试、组合性、强类型安全）和五大挑战（学习曲线、样板代码、团队采纳、对简单应用过度设计、第三方依赖），同时给出了务实的建议：TCA 是一个强大的工具，但绝非适用于所有场景。对于简单的 MVP 或缺乏函数式编程背景的团队，传统的 MVVM 或许是更务实的选择；而对于状态错综复杂、需要“时间旅行”调试的大型项目，TCA 则能提供无与伦比的掌控力。核心结论：TCA 在你需要时很值得，但大多数应用并不需要它。</p>
<blockquote>
<p>架构选择没有银弹，只有在特定上下文中的权衡。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0120-04" target="_blank" title="https://l.fatbobman.com/w0120-04" ref="nofollow noopener noreferrer">让 C 库在 Swift 中“像原生 API 一样好用” (Improving the usability of C libraries in Swift)</a></h3>
<p>Swift 虽然生来就兼容 C，但直接调用 C API 往往体验不佳——开发者通常需要面对裸指针、手动内存管理以及不符合 Swift 命名习惯的函数。为了获得“原生”体验，开发者不得不编写和维护繁琐的 Wrapper 层。在这篇文章中，<a href="https://link.juejin.cn?target=https%3A%2F%2Fsfba.social%2F%40dgregor79" target="_blank" title="https://sfba.social/@dgregor79" ref="nofollow noopener noreferrer">Doug Gregor</a> 详细介绍了如何利用 API Notes 和 Clang Attributes 机制，在不修改 C 库实现代码的前提下，“指导” Swift 编译器生成符合 Swift 风格的接口。</p>
<p>这项改进的意义在于，它将“封装 C 库”的成本从逻辑层（编写 Swift 胶水代码）转移到了声明层（编写 API Notes 或添加头文件注解）。这对于 Embedded Swift 的普及至关重要，因为嵌入式开发高度依赖现有的 C 库生态。随着工具链的完善，未来开发者可能只需要给 C 库加几个注解，就能直接在 Swift 中像使用原生库一样调用它。文章还提供了基于正则表达式的自动化脚本，可以为结构化的 C 头文件批量生成 API Notes。</p>
<hr/>
<h3 data-id="heading-8"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0120-05" target="_blank" title="https://l.fatbobman.com/w0120-05" ref="nofollow noopener noreferrer">在 Yocto 系统中构建 Swift (Introduction to Building Swift for Yocto)</a></h3>
<p>对于大多数 iOS 开发者来说，Yocto 可能比较陌生，但它是嵌入式 Linux 领域的事实标准——它能够精确控制系统中包含的每一个组件。随着 Embedded Swift 的推进，如何在 Yocto 生态中集成 Swift 成为了一个关键问题。<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fxtremekforever" target="_blank" title="https://x.com/xtremekforever" ref="nofollow noopener noreferrer">Jesse L. Zamora</a> 详细演示了如何使用近期重获更新的 <code>meta-swift</code> 在 Yocto 系统中构建 Swift 运行环境。文章以 Raspberry Pi Zero 2 为例，从 Docker 环境搭建、Yocto 构建、镜像烧录到实际运行，演示了完整的工作流。</p>
<p>需要注意的是，完整构建过程需要数小时，且要求对 Yocto 构建系统有基本了解。不过，文章提供的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fswift-embedded-linux%2Fmeta-swift-examples" target="_blank" title="https://github.com/swift-embedded-linux/meta-swift-examples" ref="nofollow noopener noreferrer">meta-swift-examples</a> 仓库已经包含了 Docker 化的构建环境和一键脚本，大大降低了上手门槛。</p>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fjeremy-prater%2Fmeta-swift" target="_blank" title="https://github.com/jeremy-prater/meta-swift" ref="nofollow noopener noreferrer">meta-swift</a> 是 Swift 语言的 Yocto 层，此前曾长期停滞于 Swift 5.7，但在社区的努力下，目前已支持到 Swift 6.1.3。</p>
</blockquote>
<hr/>
<h3 data-id="heading-9"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0120-06" target="_blank" title="https://l.fatbobman.com/w0120-06" ref="nofollow noopener noreferrer">让 Xcode 的 DEBUG 构建自动部署到 /Applications (TIL how to auto-move Xcode DEBUG builds to Applications)</a></h3>
<p>开发包含 App Intents 的应用时，你可能遇到过这个问题：App Intents 必须在 <code>/Applications</code> 目录下才能在 Shortcuts.app 中显示。这意味着 DEBUG 构建默认放在 DerivedData 中时，开发者无法测试 Shortcuts 集成。 <a href="https://link.juejin.cn?target=https%3A%2F%2Fnorden.social%2F%40czottmann" target="_blank" title="https://norden.social/@czottmann" ref="nofollow noopener noreferrer">Carlo Zottmann</a> 曾长期使用复杂的 Post-build 脚本来搬运 App，但他在本文中分享了一个更“原生”的方案——通过三行 <code>.xcconfig</code> 配置让 Xcode 自动将构建产物部署到指定目录，并在清理构建时正确删除已部署的文件。</p>
<blockquote>
<p>这个技巧不仅适用于 App Intents 测试，也适用于任何需要将 DEBUG 构建放到特定位置的场景。</p>
</blockquote>
<hr/>
<h3 data-id="heading-10"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0120-07" target="_blank" title="https://l.fatbobman.com/w0120-07" ref="nofollow noopener noreferrer">用 Swift Charts 构建自定义可交互仪表盘 (Visualise anything with SwiftUI Charts)</a></h3>
<p>如果你需要自定义一个可动画、可交互的环形压力仪表盘（Stress Indicator）的 SwiftUI 组件，你会如何进行？是使用 Shape，还是 Canvas？<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.linkedin.com%2Fin%2Fkyryl-horbushko-67936bb5%2F" target="_blank" title="https://www.linkedin.com/in/kyryl-horbushko-67936bb5/" ref="nofollow noopener noreferrer">Kyryl Horbushko</a> 在本文中展示了一个非常有创意的解法——利用 Swift Charts 的 <code>SectorMark</code>，优雅且高效地实现了需求。</p>
<p>Kyryl 的实现打破了我们对 Swift Charts 仅用于“数据可视化”的刻板印象。对于需要开发健康类、金融类复杂 Dashboard 的开发者来说，这是一种极具参考价值的"降维打击"式方案——用数据可视化框架解决自定义 UI 问题，既减少代码量，又获得内置的动画和交互支持。</p>
<h2 data-id="heading-11">工具</h2>
<h3 data-id="heading-12"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0120-08" target="_blank" title="https://l.fatbobman.com/w0120-08" ref="nofollow noopener noreferrer">Commander：兼顾专注与灵活的 AI 编程体验</a></h3>
<p>我喜欢在 macOS 上使用 CLI 工具(Claude Code、Codex)，但原生终端应用的视觉体验实在不敢恭维，因此多数情况下我都在 VSCode 中通过插件来改善体验。然而，VSCode 的一个设计始终让我困扰：即便将 Claude Code 的对话栏最大化，AI 修改文件时仍会自动打开新的文件栏或窗口，打断既有的交互节奏。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fkrzyzanowskim" target="_blank" title="https://x.com/krzyzanowskim" ref="nofollow noopener noreferrer">Marcin Krzyżanowski</a> 开发的 macOS 原生应用 Commander 给了我一个新的选择。它提供了一个比终端更优的交互界面，同时保护了我的“心流”——文件只在需要时才开启，并能调用系统默认应用查看。Commander 目前支持 Claude Code 和 Codex，内置了 Git worktrees 和 Code diff 支持，且完全免费。它在终端的“专注”与 VSCode 的“灵活”之间，构建了一个绝佳的中间地带。</p>
<hr/>
<h3 data-id="heading-13"><a href="https://link.juejin.cn?target=https%3A%2F%2Fl.fatbobman.com%2Fw0120-09" target="_blank" title="https://l.fatbobman.com/w0120-09" ref="nofollow noopener noreferrer">Oh My Agents: 统一管理所有 AI 编程助手的配置</a></h3>
<p>随着 Claude Code、Cursor、Codex、Windsurf 等 AI 编程助手的涌现，开发者面临着一个新问题：如何管理散落在各个项目中的 prompts、skills 和 rules? 每个 Agent 都有自己的配置规范(<code>CLAUDE.md</code>、<code>CURSOR.md</code>...)，手动复制粘贴不仅低效，还容易导致版本混乱。<a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fonevcat" target="_blank" title="https://x.com/onevcat" ref="nofollow noopener noreferrer">王巍(onevcat)</a> 开发的 Oh My Agents 提供了解决方案。</p>
<p>核心功能:</p>
<ul>
<li>集中管理所有 AI Agent 配置</li>
<li>定义分发规则，一键同步到多个项目</li>
<li>双向同步，项目改进可拉回中央库并更新所有关联项目</li>
<li>预览变更，避免意外覆盖</li>
</ul>
<p>注：目前仅支持 macOS (Windows/Linux 开发中)，Beta 期间免费。</p>
<h2 data-id="heading-14">往期内容</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-119%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-119/" ref="nofollow noopener noreferrer">从 Anthropic 封杀与苹果谷歌结盟，看 AI 护城河的构建 - #119</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-118%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-118/" ref="nofollow noopener noreferrer">AT 的人生未必比 MT 更好- #118</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fhttps%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-117%2F" target="_blank" title="https://https://fatbobman.com/zh/weekly/issue-117/" ref="nofollow noopener noreferrer">2026：当 AI 隐入工作流，你准备好了吗？- #117</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Ffatbobman.com%2Fzh%2Fweekly%2Fissue-116%2F" target="_blank" title="https://fatbobman.com/zh/weekly/issue-116/" ref="nofollow noopener noreferrer">Swift、SwiftUI 与 SwiftData：走向成熟的 2025 - #116</a></li>
</ul>
<h2 data-id="heading-15">💝 支持与反馈</h2>
<p>如果本期周报对你有帮助，请：</p>
<ul>
<li>👍 <strong>点赞</strong> - 让更多开发者看到</li>
<li>💬 <strong>评论</strong> - 分享你的看法或问题</li>
<li>🔄 <strong>转发</strong> - 帮助同行共同成长</li>
</ul>
<hr/>
<blockquote>
<p>🚀 <strong>拓展 Swift 视野</strong></p>
<ul>
<li><strong>📮 邮件订阅</strong> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fweekly.fatbobman.com%2Fwelcome" target="_blank" title="https://weekly.fatbobman.com/welcome" ref="nofollow noopener noreferrer">weekly.fatbobman.com</a> 获取独家技术洞察</li>
<li><strong>👥 开发者社区</strong> | <a href="https://link.juejin.cn?target=https%3A%2F%2Fdiscord.com%2Finvite%2F7FedN5E2QQ" target="_blank" title="https://discord.com/invite/7FedN5E2QQ" ref="nofollow noopener noreferrer">Discord</a> 实时交流开发经验</li>
<li><strong>📚 原创教程</strong> | <a href="https://link.juejin.cn?target=http%3A%2F%2Ffatbobman.com" target="_blank" title="http://fatbobman.com" ref="nofollow noopener noreferrer">fatbobman.com</a> 学习 Swift/SwiftUI 最佳实践</li>
</ul>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SpringBoot开发必知的8个高效技巧：让你的生产力翻倍！]]></title>    <link>https://juejin.cn/post/7599580550295552035</link>    <guid>https://juejin.cn/post/7599580550295552035</guid>    <pubDate>2026-01-27T00:17:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599580550295552035" data-draft-id="7599586891084070946" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SpringBoot开发必知的8个高效技巧：让你的生产力翻倍！"/> <meta itemprop="keywords" content="后端,前端,人工智能"/> <meta itemprop="datePublished" content="2026-01-27T00:17:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿橙的百宝箱"/> <meta itemprop="url" content="https://juejin.cn/user/1638743356481367"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SpringBoot开发必知的8个高效技巧：让你的生产力翻倍！
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1638743356481367/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿橙的百宝箱
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T00:17:33.000Z" title="Tue Jan 27 2026 00:17:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0"><strong>SpringBoot开发必知的8个高效技巧：让你的生产力翻倍！</strong></h2>
<h2 data-id="heading-1">引言</h2>
<p>SpringBoot 作为 Java 生态中最受欢迎的框架之一，以其“约定优于配置”的理念和开箱即用的特性，极大地简化了 Spring 应用的开发。然而，随着项目规模的扩大和复杂度的提升，如何高效利用 SpringBoot 的特性成为开发者必须面对的挑战。本文将分享 <strong>8 个 SpringBoot 高效开发技巧</strong>，涵盖配置优化、调试技巧、性能调优等方向，帮助开发者显著提升生产力。</p>
<hr/>
<h2 data-id="heading-2">1. 合理使用 <code>@ConfigurationProperties</code> 替代 <code>@Value</code></h2>
<h3 data-id="heading-3">问题背景</h3>
<p>在 SpringBoot 中，<code>@Value</code> 注解常用于读取配置文件中的属性，但随着配置项增多，代码会变得臃肿且难以维护。</p>
<h3 data-id="heading-4">解决方案</h3>
<p>使用 <code>@ConfigurationProperties</code> 将相关配置绑定到一个 POJO 类中：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ConfigurationProperties(prefix = "app.datasource")</span>
<span class="hljs-meta">@Data</span> <span class="hljs-comment">// Lombok 注解</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceConfig</span> {
    <span class="hljs-keyword">private</span> String url;
    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String password;
}
</code></pre>
<p><strong>优势</strong>：</p>
<ul>
<li><strong>类型安全</strong>：避免 <code>@Value</code> 的字符串硬编码问题。</li>
<li><strong>集中管理</strong>：相关配置项聚合在一个类中，便于维护。</li>
<li><strong>IDE 支持</strong>：自动补全和校验。</li>
</ul>
<h3 data-id="heading-5">进阶技巧</h3>
<p>结合 <code>@Validated</code> 实现配置校验：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@ConfigurationProperties(prefix = "app.datasource")</span>
<span class="hljs-meta">@Validated</span>
<span class="hljs-meta">@Data</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DataSourceConfig</span> {
    <span class="hljs-meta">@NotBlank</span>
    <span class="hljs-keyword">private</span> String url;
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<hr/>
<h2 data-id="heading-6">2. 利用 Spring Profiles 实现环境隔离</h2>
<h3 data-id="heading-7">场景需求</h3>
<p>不同环境（开发、测试、生产）需要不同的配置（如数据库连接、日志级别）。</p>
<h3 data-id="heading-8">实现方式</h3>
<ol>
<li><strong>定义 Profile-specific 配置文件</strong>：
<ul>
<li><code>application-dev.yml</code>（开发环境）</li>
<li><code>application-prod.yml</code>（生产环境）</li>
</ul>
</li>
<li><strong>激活 Profile</strong>：
<ul>
<li>命令行参数：<code>--spring.profiles.active=dev</code></li>
<li>环境变量：<code>SPRING_PROFILES_ACTIVE=prod</code></li>
</ul>
</li>
</ol>
<h3 data-id="heading-9">最佳实践</h3>
<ul>
<li><strong>默认配置</strong>：将通用配置放在 <code>application.yml</code>，环境相关配置单独拆分。</li>
<li><strong>Profile Groups</strong>（SpringBoot 2.4+）：通过 <code>spring.profiles.group.&lt;group-name&gt;</code> 组合多个 Profile。</li>
</ul>
<hr/>
<h2 data-id="heading-10">3. Lombok + MapStruct：告别样板代码</h2>
<h3 data-id="heading-11">Lombok：简化 POJO</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Data</span>
<span class="hljs-meta">@Builder</span>
<span class="hljs-meta">@NoArgsConstructor</span>
<span class="hljs-meta">@AllArgsConstructor</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-keyword">private</span> Long id;
    <span class="hljs-keyword">private</span> String name;
}
</code></pre>
<h3 data-id="heading-12">MapStruct：高效 DTO 转换</h3>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Mapper(componentModel = "spring")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserMapper</span> {
    UserDTO <span class="hljs-title function_">toDTO</span><span class="hljs-params">(User user)</span>;
    User <span class="hljs-title function_">fromDTO</span><span class="hljs-params">(UserDTO dto)</span>;
}
</code></pre>
<p><strong>优势</strong>：编译时生成代码，零运行时开销。</p>
<hr/>
<h2 data-id="heading-13">4. SpringBoot DevTools：热部署与快速重启</h2>
<h3 data-id="heading-14">核心功能</h3>
<ul>
<li><strong>自动重启</strong>：修改类文件后触发应用重启（比手动重启快得多）。</li>
<li><strong>LiveReload</strong>：前端资源修改后浏览器自动刷新。</li>
<li><strong>全局配置</strong>：通过 <code>spring.devtools.restart.enabled=false</code> 禁用（生产环境需关闭）。</li>
</ul>
<h3 data-id="heading-15">VS Code/HotSwapAgent？</h3>
<p>DevTools + JRebel（商用插件）可实现更彻底的热替换（如方法体修改无需重启）。</p>
<hr/>
<h2 data-id="heading-16">5. Actuator + Micrometer ：监控与指标收集</h2>
<h3 data-id="heading-17">SpringBoot Actuator</h3>
<p>暴露应用健康、指标、日志等端点：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">management:</span>
 <span class="hljs-attr">endpoints:</span>
   <span class="hljs-attr">web:</span>
     <span class="hljs-attr">exposure:</span>
       <span class="hljs-attr">include:</span> <span class="hljs-string">health,metrics,info</span>
</code></pre>
<h3 data-id="heading-18">Micrometer ：统一监控指标</h3>
<p>集成 Prometheus/Grafana：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Bean</span>
MeterRegistryCustomizer&lt;PrometheusMeterRegistry&gt; <span class="hljs-title function_">metricsCommonTags</span><span class="hljs-params">()</span> {
    <span class="hljs-keyword">return</span> registry -&gt; registry.config().commonTags(<span class="hljs-string">"application"</span>, <span class="hljs-string">"my-app"</span>);
}
</code></pre>
<hr/>
<p>##10分钟快速入门 Elasticsearch</p>
<p>Elasticsearch是一个分布式搜索和分析引擎,基于Lucene构建,能够以近实时的速度存储、搜索和分析海量数据。</p>
<p>本文将通过简单示例带你快速上手Elasticsearch的核心功能。</p>
<p>1.安装与运行</p>
<p>下载并解压Elasticsearch(本文以7.x版本为例)</p>
<p>./bin/elasticsearch #启动单节点集群</p>
<p>验证是否运行成功: curl -X GET "localhost:9200/"</p>
<p>2.基本概念</p>
<p>索引(Index):类似数据库中的表</p>
<p>文档(Document):索引中的基本单位,相当于表中的行</p>
<p>3.CRUD操作</p>
<p>创建索引:</p>
<p>PUT /products</p>
<p>插入文档:</p>
<p>POST /products/_doc/1
{
"name":"iPhone",
"price":6999,
"description":"Apple smartphone"
}</p>
<p>查询文档:</p>
<p>GET /products/_doc/1</p>
<p>搜索文档:</p>
<p>GET /products/_search?q=name:iPhone</p>
<p>4.简单搜索</p>
<p>使用DSL进行条件查询:</p>
<p>GET /products/_search
{
"query":{
"match":{
"description":"smartphone"
}
}
}</p>
<p>5.聚合分析</p>
<p>统计价格分布:</p>
<p>GET /products/_search
{
"aggs":{
"price_stats":{
"stats":{"field":"price"}
}
}
}</p>
<p>总结:通过以上基础操作,您已经可以开始使用Elasticsearch进行数据存储和检索了。</p>
<p>下一步建议学习:
-更复杂的查询语法
-索引映射设计
-集群管理
-性能优化</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[slidev-addon-infographic 年终总结程序员必备的PPT精美图表]]></title>    <link>https://juejin.cn/post/7599581687357784114</link>    <guid>https://juejin.cn/post/7599581687357784114</guid>    <pubDate>2026-01-27T00:40:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599581687357784114" data-draft-id="7599565587153059866" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="slidev-addon-infographic 年终总结程序员必备的PPT精美图表"/> <meta itemprop="keywords" content="前端,程序员,Vue.js"/> <meta itemprop="datePublished" content="2026-01-27T00:40:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="fxss"/> <meta itemprop="url" content="https://juejin.cn/user/3702810892856808"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            slidev-addon-infographic 年终总结程序员必备的PPT精美图表
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3702810892856808/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    fxss
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T00:40:33.000Z" title="Tue Jan 27 2026 00:40:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fslidev-addon-infographic" target="_blank" title="https://www.npmjs.com/package/slidev-addon-infographic" ref="nofollow noopener noreferrer">slidev-addon-infographic</a> 是为了在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.sli.dev%2F" target="_blank" title="https://cn.sli.dev/" ref="nofollow noopener noreferrer">Slidev</a> 中快速添加 <a href="https://link.juejin.cn?target=https%3A%2F%2Finfographic.antv.vision%2F" target="_blank" title="https://infographic.antv.vision/" ref="nofollow noopener noreferrer">@antv/infographic</a> 图表而设计的插件。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.sli.dev%2F" target="_blank" title="https://cn.sli.dev/" ref="nofollow noopener noreferrer">Slidev</a> 是为开发者打造的演示文稿工具，它基于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.vuejs.org%2F" target="_blank" title="https://cn.vuejs.org/" ref="nofollow noopener noreferrer">Vue3</a> 并集成了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.markdown.cn%2Fdocs%2Fintro%2F" target="_blank" title="https://www.markdown.cn/docs/intro/" ref="nofollow noopener noreferrer">Markdown</a> 语法，使得创建演示文稿变得简单快捷，并支持导出 PPTX, PNG, PDF 格式。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Finfographic.antv.vision%2F" target="_blank" title="https://infographic.antv.vision/" ref="nofollow noopener noreferrer">@antv/infographic</a> 是新一代声明式信息图可视化引擎，提供上百种图表类型，包括但不限于 图表型、对比型、层级型、列表型、四象限型、关系型、顺序型 等，补足程序员写PPT的短板。</p>
<h2 data-id="heading-0">创建 Slidev 项目</h2>
<pre><code class="hljs language-bash" lang="bash">npm init slidev@latest
</code></pre>
<pre><code class="hljs language-bash" lang="bash">pnpm create slidev
</code></pre>
<pre><code class="hljs language-bash" lang="bash">yarn create slidev
</code></pre>
<h2 data-id="heading-1">添加 slidev-addon-infographic 插件</h2>
<pre><code class="hljs language-bash" lang="bash">npm install slidev-addon-infographic
</code></pre>
<pre><code class="hljs language-bash" lang="bash">pnpm install slidev-addon-infographic
</code></pre>
<pre><code class="hljs language-bash" lang="bash">yarn add slidev-addon-infographic
</code></pre>
<p>将下面内容添加到项目 <code>package.json</code> 文件中：</p>
<pre><code class="hljs language-json" lang="json">...
  <span class="hljs-attr">"slidev"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"addons"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
      <span class="hljs-string">"slidev-addon-infographic"</span>
    <span class="hljs-punctuation">]</span>
  <span class="hljs-punctuation">}</span>
...
</code></pre>
<p>接下来就可以在 Slidev 项目中使用 <code>@antv/infographic</code> 图表了。</p>
<pre><code class="hljs language-md" lang="md">---
addons:
<span class="hljs-section">  - slidev-addon-infographic
---</span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">InfographicBox</span> <span class="hljs-attr">:data</span>=<span class="hljs-string">"`infographic list-row-simple-horizontal-arrow
data
  items
    - label 步骤 1
      desc 开始
    - label 步骤 2
      desc 进行中
    - label 步骤 3
      desc 完成
`"</span>&gt;</span></span><span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">InfographicBox</span>&gt;</span></span>
</code></pre>





























<table><thead><tr><th>参数</th><th>描述</th><th>类型</th><th>默认值</th></tr></thead><tbody><tr><td><code>data</code></td><td>信息图数据</td><td>string</td><td>-</td></tr><tr><td><code>click</code></td><td>是否响应<a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.sli.dev%2Fguide%2Fanimations%23click-animation" target="_blank" title="https://cn.sli.dev/guide/animations#click-animation" ref="nofollow noopener noreferrer">Slidev点击动画</a>，如果设置为 <code>true</code>，需要在 <code>frontmatter</code> 中添加 <a href="https://link.juejin.cn?target=https%3A%2F%2Fcn.sli.dev%2Fguide%2Fanimations%23total" target="_blank" title="https://cn.sli.dev/guide/animations#total" ref="nofollow noopener noreferrer"><code>clicks</code></a> 字段，值为点击次数。</td><td><code>boolean</code></td><td><code>false</code></td></tr><tr><td><code>isExportPdf</code></td><td>是否导出 PDF 格式。导出时会默认将 <code>click</code> 设置为 <code>false</code>。</td><td><code>boolean</code></td><td><code>false</code></td></tr></tbody></table>
<ol>
<li>如需导出 PDF 格式，请为 <code>InfographicBox</code> 组件增加 <code>isExportPdf</code> 属性，导出的时候会默认将 <code>click</code> 设置为 <code>false</code> 。</li>
<li><code>click</code> 主要用于演示效果，<code>click</code> 为 <code>true</code> 时，需要单独占一页，设置 <code>click</code> 为 <code>true</code> 后，并添加 <code>clicks</code> 点击次数之后的效果需要自行点击确认。</li>
</ol>
<p>我们可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Finfographic.antv.vision%2Feditor" target="_blank" title="https://infographic.antv.vision/editor" ref="nofollow noopener noreferrer">@antv/infographic 编辑器</a> 中设计出符合需求的图表，然后将其复制到 Slidev 项目中。</p>
<p>下面是我的公众号，欢迎关注。关注后有新的功能点会及时收到推送。</p>
<blockquote>
<p>实战为王！专注于汇总各种功能点，致力于打造一系列能够帮助工程师实现各种功能的想法思路的优质文章。</p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4bdeec99a0154e7aa73c1c6765f3dcf0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZnhzcw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770079232&amp;x-signature=97dS2VZSuWIQ6aD4kgiTmSBLnH0%3D" alt="前端功能点" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[剑指offer-68、调整数组顺序使奇数位于偶数前⾯(⼆)]]></title>    <link>https://juejin.cn/post/7599565587153092634</link>    <guid>https://juejin.cn/post/7599565587153092634</guid>    <pubDate>2026-01-27T00:42:41.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599565587153092634" data-draft-id="7598459769238487074" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 剑指offer-68、调整数组顺序使奇数位于偶数前⾯(⼆)"/> <meta itemprop="keywords" content="Java"/> <meta itemprop="datePublished" content="2026-01-27T00:42:41.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SevenCoding"/> <meta itemprop="url" content="https://juejin.cn/user/3261615728242467"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             剑指offer-68、调整数组顺序使奇数位于偶数前⾯(⼆)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3261615728242467/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SevenCoding
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T00:42:41.000Z" title="Tue Jan 27 2026 00:42:41 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">题⽬描述</h2>
<p>输⼊⼀个⻓度为 n 整数数组，数组⾥⾯可能含有相同的元素，实现⼀个函数来调整该数组中数字的顺序，使得所有的奇数位于数组的前⾯部分，所有的偶数位于数组的后⾯部分，对奇数和奇数，偶数和偶数之间的相对位置不做要求，但是时间复杂度和空间复杂度必须如下要求。</p>
<p>数据范围：0 ≤ n ≤ 50000，数组中每个数的值 0 ≤ val ≤ 10000</p>
<p>要求：时间复杂度 O(n)，空间复杂度 O(1)</p>
<p>示例 1
输⼊：[1,2,3,4]
返回值：[1,3,2,4]
说明：[3,1,2,4]或者[3,1,4,2]也是正确答案</p>
<p>示例 2
输⼊：[1,3,5,6,7]
返回值：[1,3,5,7,6]
说明：[3,1,5,7,6]等也是正确答案</p>
<h2 data-id="heading-1">思路及解答</h2>
<h3 data-id="heading-2">两次遍历</h3>
<p>第一次遍历收集奇数，第二次遍历收集偶数</p>
<p>这种方法虽然简单易懂，但需要额外空间，不符合题目要求</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] reorderArray(<span class="hljs-type">int</span>[] nums) {
        <span class="hljs-keyword">if</span> (nums == <span class="hljs-literal">null</span> || nums.length == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[<span class="hljs-number">0</span>];
        }
        
        <span class="hljs-type">int</span>[] result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">int</span>[nums.length];
        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
        
        <span class="hljs-comment">// 第一次遍历：收集所有奇数</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> num : nums) {
            <span class="hljs-keyword">if</span> (num % <span class="hljs-number">2</span> == <span class="hljs-number">1</span>) {
                result[index++] = num;
            }
        }
        
        <span class="hljs-comment">// 第二次遍历：收集所有偶数</span>
        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> num : nums) {
            <span class="hljs-keyword">if</span> (num % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) {
                result[index++] = num;
            }
        }
        
        <span class="hljs-keyword">return</span> result;
    }
}
</code></pre>
<ul>
<li>时间复杂度：O(n)</li>
<li>空间复杂度：O(n)</li>
</ul>
<h3 data-id="heading-3">双指针交换（推荐）</h3>
<p>这道题需要奇数在⼀半，偶数在另外⼀半就可以，并没有要求他们之间的顺序，那么就可以⽤双指针，⼀个指针在左边，⼀个指针在右边，⽐如 1,3,5,6,7 :</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a377cbcbedcb45c4bacb197390f8e273~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770079361&amp;x-signature=0T7KzzUcW3RaH%2BoGm%2FZVsbfpfss%3D" alt="" loading="lazy"/></p>
<p>左指针往右遍历直到找到偶数，也就是 6 停下来，</p>
<p>右指针往左⾛，直到找到第⼀个奇数，也就是 7 停下来。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3797c48f718443b5852e1433026b7632~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770079361&amp;x-signature=%2BtVn%2B8k0EnxE4UKKVgZZ42T%2B5hk%3D" alt="" loading="lazy"/></p>
<p>两者交换:</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a28224f4090e4a549757e50c7eb463da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2V2ZW5Db2Rpbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770079361&amp;x-signature=DdE7jFU2t%2BmOrPV%2FS%2BA8dClCU1o%3D" alt="" loading="lazy"/></p>
<p>左指针继续往右边⾛，两个指针相遇，结束，这个时候其实偶数已经全部在右边了。</p>
<p>这个例⼦⾥⾯只经过⼀次交换，如果是多次交换，那么结束的条件同样也是两个指针相遇。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Solution</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span>[] reorderArray(<span class="hljs-type">int</span>[] nums) {
        <span class="hljs-keyword">if</span> (nums == <span class="hljs-literal">null</span> || nums.length &lt;= <span class="hljs-number">1</span>) {
            <span class="hljs-keyword">return</span> nums;
        }
        
        <span class="hljs-type">int</span> <span class="hljs-variable">left</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;                    <span class="hljs-comment">// 左指针，从数组开头开始</span>
        <span class="hljs-type">int</span> <span class="hljs-variable">right</span> <span class="hljs-operator">=</span> nums.length - <span class="hljs-number">1</span>;     <span class="hljs-comment">// 右指针，从数组末尾开始</span>
        
        <span class="hljs-keyword">while</span> (left &lt; right) {
            <span class="hljs-comment">// 左指针向右移动，直到找到偶数</span>
            <span class="hljs-keyword">while</span> (left &lt; right &amp;&amp; nums[left] % <span class="hljs-number">2</span> == <span class="hljs-number">1</span>) {
                left++;
            }
            
            <span class="hljs-comment">// 右指针向左移动，直到找到奇数</span>
            <span class="hljs-keyword">while</span> (left &lt; right &amp;&amp; nums[right] % <span class="hljs-number">2</span> == <span class="hljs-number">0</span>) {
                right--;
            }
            
            <span class="hljs-comment">// 如果左指针仍在右指针左边，交换奇偶数</span>
            <span class="hljs-keyword">if</span> (left &lt; right) {
                <span class="hljs-type">int</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> nums[left];
                nums[left] = nums[right];
                nums[right] = temp;
                left++;
                right--;
            }
        }
        
        <span class="hljs-keyword">return</span> nums;
    }
}
</code></pre>
<ul>
<li><strong>时间复杂度</strong>：O(n)，每个元素最多被访问一次</li>
<li><strong>空间复杂度</strong>：O(1)，只使用了常数级别的额外空间</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[第7章、复合类型——数组、切片与映射（slice和map）]]></title>    <link>https://juejin.cn/post/7599538010725646363</link>    <guid>https://juejin.cn/post/7599538010725646363</guid>    <pubDate>2026-01-27T00:41:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599538010725646363" data-draft-id="7599581687357767730" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="第7章、复合类型——数组、切片与映射（slice和map）"/> <meta itemprop="keywords" content="后端,Go"/> <meta itemprop="datePublished" content="2026-01-27T00:41:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="怕浪猫"/> <meta itemprop="url" content="https://juejin.cn/user/2832784963939438"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            第7章、复合类型——数组、切片与映射（slice和map）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2832784963939438/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    怕浪猫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T00:41:45.000Z" title="Tue Jan 27 2026 00:41:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读20分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好～ 前面我们掌握了Go的基础类型和函数特性，今天进入Go编程的核心复合类型——数组、切片（slice）和映射（map）。这三种类型是Go中最常用的数据容器，支撑着绝大多数业务场景的数据存储与处理：数组是固定长度的基础序列，切片是动态扩容的“灵活数组”，map是键值对映射的无序集合。</p>
<p>本文会从“定义用法→底层原理→实战技巧→性能优化”四个维度，逐一拆解这三种复合类型。全程搭配可直接运行的代码示例，帮你搞懂每个知识点的本质，避开实际开发中的常见陷阱。无论你是刚入门的新手，还是需要夯实基础的开发者，这篇文章都能让你对Go的复合类型有透彻的理解。</p>
<h2 data-id="heading-0">1. 数组：固定长度的序列结构</h2>
<p>数组是Go中最基础的复合类型，本质是“固定长度、相同类型元素的连续序列”。其核心特点是<strong>长度固定</strong>——一旦定义，长度就无法修改。正因为长度固定，数组在实际开发中的直接使用场景不算多，但它是切片的底层基础，必须先掌握。</p>
<h3 data-id="heading-1">1.1 数组的定义与初始化</h3>
<p>数组的定义语法：<code>[长度]元素类型</code>。初始化方式有多种，根据场景灵活选择：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 1. 完整初始化：指定长度和所有元素</span>
    <span class="hljs-keyword">var</span> arr1 [<span class="hljs-number">3</span>]<span class="hljs-type">int</span> = [<span class="hljs-number">3</span>]<span class="hljs-type">int</span>{<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>}
    fmt.Println(<span class="hljs-string">"arr1:"</span>, arr1) <span class="hljs-comment">// 输出：arr1: [1 2 3]</span>

    <span class="hljs-comment">// 2. 省略长度（由初始化元素个数推导）</span>
    <span class="hljs-keyword">var</span> arr2 [<span class="hljs-number">3</span>]<span class="hljs-type">int</span> = [...]<span class="hljs-type">int</span>{<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>} <span class="hljs-comment">// ... 表示自动推导长度</span>
    fmt.Println(<span class="hljs-string">"arr2:"</span>, arr2) <span class="hljs-comment">// 输出：arr2: [4 5 6]</span>
    fmt.Printf(<span class="hljs-string">"arr2长度：%d\n"</span>, <span class="hljs-built_in">len</span>(arr2)) <span class="hljs-comment">// 输出：arr2长度：3</span>

    <span class="hljs-comment">// 3. 指定索引初始化（未指定的索引为零值）</span>
    <span class="hljs-keyword">var</span> arr3 [<span class="hljs-number">5</span>]<span class="hljs-type">string</span> = [<span class="hljs-number">5</span>]<span class="hljs-type">string</span>{<span class="hljs-number">0</span>: <span class="hljs-string">"a"</span>, <span class="hljs-number">2</span>: <span class="hljs-string">"c"</span>, <span class="hljs-number">4</span>: <span class="hljs-string">"e"</span>}
    fmt.Println(<span class="hljs-string">"arr3:"</span>, arr3) <span class="hljs-comment">// 输出：arr3: [a  ｃ  ｅ]（索引1、3为零值""）</span>

    <span class="hljs-comment">// 4. 简短声明（仅在函数内可用）</span>
    arr4 := [<span class="hljs-number">4</span>]<span class="hljs-type">float64</span>{<span class="hljs-number">1.1</span>, <span class="hljs-number">2.2</span>, <span class="hljs-number">3.3</span>, <span class="hljs-number">4.4</span>}
    fmt.Println(<span class="hljs-string">"arr4:"</span>, arr4) <span class="hljs-comment">// 输出：arr4: [1.1 2.2 3.3 4.4]</span>
}

</code></pre>
<h3 data-id="heading-2">1.2 数组的核心特性</h3>
<ul>
<li>
<p><strong>长度固定</strong>：长度是数组类型的一部分（如<code>[3]int</code>和<code>[5]int</code>是不同的类型），无法动态扩容或缩容；</p>
</li>
<li>
<p><strong>值类型</strong>：数组是值类型，赋值或传递参数时，会拷贝整个数组（而非指针），效率较低；</p>
</li>
<li>
<p><strong>连续内存</strong>：数组的元素在内存中是连续存储的，索引访问效率极高（O(1)时间复杂度）；</p>
</li>
<li>
<p><strong>支持索引访问</strong>：通过<code>arr[index]</code>访问元素，索引从0开始，超出范围会触发运行时错误（数组越界）。</p>
</li>
</ul>
<h3 data-id="heading-3">1.3 数组的实际应用场景</h3>
<p>由于长度固定和值拷贝的特性，数组直接使用场景较少，主要用于：</p>
<ul>
<li>
<p>存储固定长度的常量序列（如一周的7天、一年的12个月）；</p>
</li>
<li>
<p>作为切片的底层存储（切片本质是数组的“视图”）；</p>
</li>
<li>
<p>需要保证数据长度不变的场景（如固定大小的配置项）。</p>
</li>
</ul>
<h3 data-id="heading-4">1.4 最佳实践</h3>
<ul>
<li>
<p>传递大数组时，优先使用指针：避免拷贝整个数组，提升性能（如<code>func modifyArr(arr *[1000]int)</code>）；</p>
</li>
<li>
<p>不确定长度时，直接用切片：不要为了“预估长度”定义数组，后续无法扩容会限制使用；</p>
</li>
<li>
<p>利用数组的类型安全性：通过固定长度约束数据（如<code>[16]byte</code>表示16字节的UUID），避免数据长度错误。</p>
</li>
</ul>
<h2 data-id="heading-5">2. 切片：动态数组的底层实现</h2>
<p>切片（slice）是Go中最常用的复合类型，本质是“对数组的引用（视图）”，支持动态扩容，解决了数组长度固定的痛点。切片本身不是数组，它只是一个“描述符”，指向底层的数组。</p>
<h3 data-id="heading-6">2.1 切片的定义与初始化</h3>
<p>切片的定义语法：<code>[]元素类型</code>（无长度）。初始化方式比数组更灵活：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 1. 空切片（nil切片）：未指向任何底层数组</span>
    <span class="hljs-keyword">var</span> s1 []<span class="hljs-type">int</span>
    fmt.Println(<span class="hljs-string">"s1:"</span>, s1)          <span class="hljs-comment">// 输出：s1: []</span>
    fmt.Printf(<span class="hljs-string">"s1长度：%d，容量：%d\n"</span>, <span class="hljs-built_in">len</span>(s1), <span class="hljs-built_in">cap</span>(s1)) <span class="hljs-comment">// 输出：s1长度：0，容量：0</span>
    fmt.Printf(<span class="hljs-string">"s1是否为nil：%t\n"</span>, s1 == <span class="hljs-literal">nil</span>) <span class="hljs-comment">// 输出：s1是否为nil：true</span>

    <span class="hljs-comment">// 2. 用make初始化（最常用）：make([]类型, 长度, 容量)</span>
    s2 := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>) <span class="hljs-comment">// 长度3，容量5：底层数组长度5，当前使用前3个元素</span>
    fmt.Println(<span class="hljs-string">"s2:"</span>, s2)          <span class="hljs-comment">// 输出：s2: [0 0 0]（零值初始化）</span>
    fmt.Printf(<span class="hljs-string">"s2长度：%d，容量：%d\n"</span>, <span class="hljs-built_in">len</span>(s2), <span class="hljs-built_in">cap</span>(s2)) <span class="hljs-comment">// 输出：s2长度：3，容量：5</span>

    <span class="hljs-comment">// 3. 从数组/切片截取（核心用法）：s[start:end]（左闭右开，不包含end）</span>
    arr := [<span class="hljs-number">5</span>]<span class="hljs-type">int</span>{<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>}
    s3 := arr[<span class="hljs-number">1</span>:<span class="hljs-number">3</span>] <span class="hljs-comment">// 从arr索引1到3（不包含3），截取元素[2,3]</span>
    fmt.Println(<span class="hljs-string">"s3:"</span>, s3)          <span class="hljs-comment">// 输出：s3: [2 3]</span>
    fmt.Printf(<span class="hljs-string">"s3长度：%d，容量：%d\n"</span>, <span class="hljs-built_in">len</span>(s3), <span class="hljs-built_in">cap</span>(s3)) <span class="hljs-comment">// 输出：s3长度：2，容量：4（从start到原数组末尾）</span>

    <span class="hljs-comment">// 4. 直接初始化（类似数组，省略长度）</span>
    s4 := []<span class="hljs-type">string</span>{<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>, <span class="hljs-string">"c"</span>}
    fmt.Println(<span class="hljs-string">"s4:"</span>, s4)          <span class="hljs-comment">// 输出：s4: [a b c]</span>
    fmt.Printf(<span class="hljs-string">"s4长度：%d，容量：%d\n"</span>, <span class="hljs-built_in">len</span>(s4), <span class="hljs-built_in">cap</span>(s4)) <span class="hljs-comment">// 输出：s4长度：3，容量：3</span>
}

</code></pre>
<h3 data-id="heading-7">2.2 核心概念：长度（len）与容量（cap）</h3>
<p>切片有两个关键属性：长度（len）和容量（cap），含义完全不同：</p>
<ul>
<li>
<p><strong>长度（len）</strong>：切片当前包含的元素个数（通过<code>len(s)</code>获取）；</p>
</li>
<li>
<p><strong>容量（cap）</strong>：切片指向的底层数组中，从切片起始索引到数组末尾的元素个数（通过<code>cap(s)</code>获取）；</p>
</li>
<li>
<p>关系：<code>0 ≤ len(s) ≤ cap(s)</code>，当len(s) == cap(s)时，切片已满，再添加元素会触发扩容。</p>
</li>
</ul>
<p>示意图（帮助理解）：</p>
<pre><code class="hljs language-Plain" lang="Plain">
底层数组：[1, 2, 3, 4, 5]（长度5）
切片s3 := arr[1:3]：
- 起始索引：1
- 长度：3-1=2（元素[2,3]）
- 容量：5-1=4（从索引1到数组末尾，共4个元素：2,3,4,5）

</code></pre>
<h3 data-id="heading-8">2.3 底层实现原理</h3>
<p>切片的底层是一个结构体（源码定义在<code>runtime/slice.go</code>中），包含三个字段：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">type</span> slice <span class="hljs-keyword">struct</span> {
    array unsafe.Pointer <span class="hljs-comment">// 指向底层数组的指针</span>
    <span class="hljs-built_in">len</span>   <span class="hljs-type">int</span>            <span class="hljs-comment">// 切片长度</span>
    <span class="hljs-built_in">cap</span>   <span class="hljs-type">int</span>            <span class="hljs-comment">// 切片容量</span>
}

</code></pre>
<p>关键结论：</p>
<ul>
<li>
<p>切片本身是值类型（结构体拷贝），但它指向的底层数组是引用类型；</p>
</li>
<li>
<p>多个切片可以指向同一个底层数组（通过截取创建），修改一个切片的元素会影响其他切片；</p>
</li>
<li>
<p>切片的赋值、传递参数时，拷贝的是这个结构体（3个字段，占用16字节：64位系统下，指针8字节+int8字节+int8字节），效率极高。</p>
</li>
</ul>
<p>示例：多个切片共享底层数组</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    arr := [<span class="hljs-number">5</span>]<span class="hljs-type">int</span>{<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>}
    s1 := arr[<span class="hljs-number">1</span>:<span class="hljs-number">3</span>]  <span class="hljs-comment">// [2,3]，cap=4</span>
    s2 := arr[<span class="hljs-number">2</span>:<span class="hljs-number">4</span>]  <span class="hljs-comment">// [3,4]，cap=3</span>

    <span class="hljs-comment">// 修改s1[1]（即底层数组索引2的元素3）</span>
    s1[<span class="hljs-number">1</span>] = <span class="hljs-number">300</span>
    fmt.Println(<span class="hljs-string">"s1:"</span>, s1) <span class="hljs-comment">// 输出：s1: [2 300]</span>
    fmt.Println(<span class="hljs-string">"s2:"</span>, s2) <span class="hljs-comment">// 输出：s2: [300 4]（s2也受影响）</span>
    fmt.Println(<span class="hljs-string">"arr:"</span>, arr) <span class="hljs-comment">// 输出：arr: [1 2 300 4 5]（底层数组被修改）</span>
}

</code></pre>
<h2 data-id="heading-9">3. 切片的扩容策略与性能分析</h2>
<p>当切片的长度等于容量（<code>len(s) == cap(s)</code>）时，再通过<code>append</code>添加元素，会触发扩容。扩容的核心逻辑是“创建一个更大的新底层数组，将原数组的元素拷贝到新数组，然后让切片指向新数组”。</p>
<h3 data-id="heading-10">3.1 扩容策略（Go 1.18+ 最新逻辑）</h3>
<p>Go的扩容策略经过多次优化，当前（1.18+）的核心逻辑如下（源码在<code>runtime/slice.go</code>的<code>growslice</code>函数中）：</p>
<ol>
<li>
<p>计算“期望容量”：<code>newcap = len(s) + 要添加的元素个数</code>；</p>
</li>
<li>
<p>如果原容量 &lt; 256，则新容量 = 原容量 × 2；</p>
</li>
<li>
<p>如果原容量 ≥ 256，则新容量 = 原容量 + 原容量/4（即增加25%）；</p>
</li>
<li>
<p>如果计算出的新容量 &lt; 期望容量，则新容量 = 期望容量（保证能容纳新元素）；</p>
</li>
<li>
<p>最后，新容量会被调整为“内存对齐”的大小（提高内存分配效率）。</p>
</li>
</ol>
<h3 data-id="heading-11">3.2 代码示例：验证扩容过程</h3>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    s := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>) <span class="hljs-comment">// len=0, cap=1</span>
    fmt.Printf(<span class="hljs-string">"初始：len=%d, cap=%d\n"</span>, <span class="hljs-built_in">len</span>(s), <span class="hljs-built_in">cap</span>(s)) <span class="hljs-comment">// 初始：len=0, cap=1</span>

    s = <span class="hljs-built_in">append</span>(s, <span class="hljs-number">1</span>) <span class="hljs-comment">// len=1, cap=1（未扩容）</span>
    fmt.Printf(<span class="hljs-string">"添加1后：len=%d, cap=%d\n"</span>, <span class="hljs-built_in">len</span>(s), <span class="hljs-built_in">cap</span>(s)) <span class="hljs-comment">// 添加1后：len=1, cap=1</span>

    s = <span class="hljs-built_in">append</span>(s, <span class="hljs-number">2</span>) <span class="hljs-comment">// len=2, cap=2（原cap&lt;256，×2扩容）</span>
    fmt.Printf(<span class="hljs-string">"添加2后：len=%d, cap=%d\n"</span>, <span class="hljs-built_in">len</span>(s), <span class="hljs-built_in">cap</span>(s)) <span class="hljs-comment">// 添加2后：len=2, cap=2</span>

    s = <span class="hljs-built_in">append</span>(s, <span class="hljs-number">3</span>) <span class="hljs-comment">// len=3, cap=4（原cap&lt;256，×2扩容）</span>
    fmt.Printf(<span class="hljs-string">"添加3后：len=%d, cap=%d\n"</span>, <span class="hljs-built_in">len</span>(s), <span class="hljs-built_in">cap</span>(s)) <span class="hljs-comment">// 添加3后：len=3, cap=4</span>

    s = <span class="hljs-built_in">append</span>(s, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>) <span class="hljs-comment">// len=5, cap=8（原cap&lt;256，×2扩容，能容纳2个新元素）</span>
    fmt.Printf(<span class="hljs-string">"添加4、5后：len=%d, cap=%d\n"</span>, <span class="hljs-built_in">len</span>(s), <span class="hljs-built_in">cap</span>(s)) <span class="hljs-comment">// 添加4、5后：len=5, cap=8</span>
}

</code></pre>
<h3 data-id="heading-12">3.3 扩容对性能的影响</h3>
<p>扩容的核心开销来自两部分：<strong>新数组的内存分配</strong>和<strong>原数组元素的拷贝</strong>。频繁扩容会严重影响性能，因此在实际开发中，要尽量“预分配容量”，减少扩容次数。</p>
<p>性能对比示例（预分配vs不预分配）：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 场景1：不预分配容量（频繁扩容）</span>
    start1 := time.Now()
    <span class="hljs-keyword">var</span> s1 []<span class="hljs-type">int</span>
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++ {
        s1 = <span class="hljs-built_in">append</span>(s1, i)
    }
    fmt.Printf(<span class="hljs-string">"不预分配容量耗时：%v\n"</span>, time.Since(start1)) <span class="hljs-comment">// 约1.2ms（因环境而异）</span>

    <span class="hljs-comment">// 场景2：预分配容量（无扩容）</span>
    start2 := time.Now()
    s2 := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1000000</span>) <span class="hljs-comment">// 预分配100万容量</span>
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">1000000</span>; i++ {
        s2 = <span class="hljs-built_in">append</span>(s2, i)
    }
    fmt.Printf(<span class="hljs-string">"预分配容量耗时：%v\n"</span>, time.Since(start2)) <span class="hljs-comment">// 约0.6ms（因环境而异）</span>
}

</code></pre>
<p>结论：预分配容量能减少80%以上的耗时（具体比例因数据量而异），是提升切片操作性能的关键技巧。</p>
<h2 data-id="heading-13">4. 切片的共享内存与拷贝问题</h2>
<p>切片的“共享底层数组”特性，在带来灵活性的同时，也容易引发“数据污染”问题。此外，当需要修改切片又不影响原数组/切片时，就需要进行“切片拷贝”。</p>
<h3 data-id="heading-14">4.1 共享内存的坑：数据污染</h3>
<p>多个切片共享底层数组时，修改一个切片的元素会影响其他切片和原数组，这是最常见的坑：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 原切片</span>
    s := []<span class="hljs-type">int</span>{<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>}
    <span class="hljs-comment">// 截取得到新切片</span>
    sSub := s[<span class="hljs-number">2</span>:<span class="hljs-number">4</span>] <span class="hljs-comment">// [3,4]</span>
    <span class="hljs-comment">// 修改新切片</span>
    sSub[<span class="hljs-number">0</span>] = <span class="hljs-number">300</span>
    <span class="hljs-comment">// 原切片也被修改</span>
    fmt.Println(<span class="hljs-string">"原切片s:"</span>, s) <span class="hljs-comment">// 输出：原切片s: [1 2 300 4 5]</span>
}

</code></pre>
<p>解决方案：如果需要修改切片又不影响原数据，必须创建切片的“独立副本”（即切片拷贝）。</p>
<h3 data-id="heading-15">4.2 切片拷贝：创建独立副本</h3>
<p>Go提供<code>copy(dst, src []T)</code>函数实现切片拷贝，核心特点：</p>
<ul>
<li>
<p>拷贝的元素个数 = min(len(dst), len(src))；</p>
</li>
<li>
<p>拷贝后，dst和src指向不同的底层数组（独立副本），修改互不影响；</p>
</li>
<li>
<p>dst需要提前分配足够的容量（否则只能拷贝部分元素）。</p>
</li>
</ul>
<p>代码示例：正确的切片拷贝</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    s := []<span class="hljs-type">int</span>{<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>}
    <span class="hljs-comment">// 方案1：创建与原切片长度相同的dst</span>
    sCopy1 := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-built_in">len</span>(s))
    <span class="hljs-built_in">copy</span>(sCopy1, s) <span class="hljs-comment">// 拷贝所有元素</span>
    sCopy1[<span class="hljs-number">0</span>] = <span class="hljs-number">100</span>
    fmt.Println(<span class="hljs-string">"s:"</span>, s)       <span class="hljs-comment">// 输出：s: [1 2 3 4 5]（原切片未变）</span>
    fmt.Println(<span class="hljs-string">"sCopy1:"</span>, sCopy1) <span class="hljs-comment">// 输出：sCopy1: [100 2 3 4 5]</span>

    <span class="hljs-comment">// 方案2：拷贝部分元素（截取后拷贝）</span>
    sSub := s[<span class="hljs-number">2</span>:<span class="hljs-number">4</span>] <span class="hljs-comment">// [3,4]</span>
    sCopy2 := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-built_in">len</span>(sSub))
    <span class="hljs-built_in">copy</span>(sCopy2, sSub)
    sCopy2[<span class="hljs-number">0</span>] = <span class="hljs-number">300</span>
    fmt.Println(<span class="hljs-string">"sSub:"</span>, sSub)   <span class="hljs-comment">// 输出：sSub: [3 4]（原截取切片未变）</span>
    fmt.Println(<span class="hljs-string">"sCopy2:"</span>, sCopy2) <span class="hljs-comment">// 输出：sCopy2: [300 4]</span>

    <span class="hljs-comment">// 错误示例：dst容量不足</span>
    sCopy3 := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-number">2</span>) <span class="hljs-comment">// len=2</span>
    <span class="hljs-built_in">copy</span>(sCopy3, s) <span class="hljs-comment">// 仅拷贝前2个元素</span>
    fmt.Println(<span class="hljs-string">"sCopy3:"</span>, sCopy3) <span class="hljs-comment">// 输出：sCopy3: [1 2]</span>
}

</code></pre>
<h3 data-id="heading-16">4.3 常见场景：切片作为函数返回值</h3>
<p>当函数返回切片时，要注意：如果返回的是“原切片的截取切片”，则会共享底层数组，可能导致外部修改影响内部数据。正确做法是返回“拷贝后的独立切片”：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-comment">// 错误：返回截取切片，共享底层数组</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">badGetSubSlice</span><span class="hljs-params">(s []<span class="hljs-type">int</span>)</span></span> []<span class="hljs-type">int</span> {
    <span class="hljs-keyword">return</span> s[<span class="hljs-number">2</span>:<span class="hljs-number">4</span>]
}

<span class="hljs-comment">// 正确：返回拷贝后的独立切片</span>
<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">goodGetSubSlice</span><span class="hljs-params">(s []<span class="hljs-type">int</span>)</span></span> []<span class="hljs-type">int</span> {
    sub := s[<span class="hljs-number">2</span>:<span class="hljs-number">4</span>]
    <span class="hljs-comment">// 创建拷贝</span>
    subCopy := <span class="hljs-built_in">make</span>([]<span class="hljs-type">int</span>, <span class="hljs-built_in">len</span>(sub))
    <span class="hljs-built_in">copy</span>(subCopy, sub)
    <span class="hljs-keyword">return</span> subCopy
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    s := []<span class="hljs-type">int</span>{<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>}
    <span class="hljs-comment">// 错误示例</span>
    badSub := badGetSubSlice(s)
    badSub[<span class="hljs-number">0</span>] = <span class="hljs-number">300</span>
    fmt.Println(<span class="hljs-string">"s（错误）:"</span>, s) <span class="hljs-comment">// 输出：s（错误）: [1 2 300 4 5]（被修改）</span>

    <span class="hljs-comment">// 正确示例</span>
    s2 := []<span class="hljs-type">int</span>{<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>}
    goodSub := goodGetSubSlice(s2)
    goodSub[<span class="hljs-number">0</span>] = <span class="hljs-number">300</span>
    fmt.Println(<span class="hljs-string">"s2（正确）:"</span>, s2) <span class="hljs-comment">// 输出：s2（正确）: [1 2 3 4 5]（未修改）</span>
}

</code></pre>
<h2 data-id="heading-17">5. map的定义与基本操作</h2>
<p>map是Go中的“键值对映射”复合类型，核心特点是“无序、键唯一”，支持快速的键查找（O(1)时间复杂度）。map的键必须是“可比较类型”（如int、string、bool、数组等），值可以是任意类型。</p>
<h3 data-id="heading-18">5.1 map的定义与初始化</h3>
<p>map的定义语法：<code>map[键类型]值类型</code>。初始化方式有两种：<code>make</code>初始化和直接初始化：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 1. 空map（nil map）：未分配内存，不能直接添加元素</span>
    <span class="hljs-keyword">var</span> m1 <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int</span>
    fmt.Println(<span class="hljs-string">"m1:"</span>, m1)          <span class="hljs-comment">// 输出：m1: map[]</span>
    fmt.Printf(<span class="hljs-string">"m1是否为nil：%t\n"</span>, m1 == <span class="hljs-literal">nil</span>) <span class="hljs-comment">// 输出：m1是否为nil：true</span>
    <span class="hljs-comment">// m1["a"] = 1 // 运行时错误：assignment to entry in nil map</span>

    <span class="hljs-comment">// 2. 用make初始化（最常用）：make(map[K]V, 容量)</span>
    m2 := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int</span>, <span class="hljs-number">10</span>) <span class="hljs-comment">// 容量10（可选，用于预分配）</span>
    m2[<span class="hljs-string">"a"</span>] = <span class="hljs-number">1</span>
    m2[<span class="hljs-string">"b"</span>] = <span class="hljs-number">2</span>
    fmt.Println(<span class="hljs-string">"m2:"</span>, m2)          <span class="hljs-comment">// 输出：m2: map[a:1 b:2]</span>
    fmt.Printf(<span class="hljs-string">"m2长度：%d\n"</span>, <span class="hljs-built_in">len</span>(m2)) <span class="hljs-comment">// 输出：m2长度：2</span>

    <span class="hljs-comment">// 3. 直接初始化（键值对列表）</span>
    m3 := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">string</span>{
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"Alice"</span>,
        <span class="hljs-string">"age"</span>:  <span class="hljs-string">"25"</span>,
        <span class="hljs-string">"city"</span>: <span class="hljs-string">"Beijing"</span>,
    }
    fmt.Println(<span class="hljs-string">"m3:"</span>, m3) <span class="hljs-comment">// 输出：m3: map[age:25 city:Beijing name:Alice]</span>
}

</code></pre>
<h3 data-id="heading-19">5.2 map的基本操作：增删改查</h3>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    m := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int</span>)

    <span class="hljs-comment">// 1. 增：添加键值对</span>
    m[<span class="hljs-string">"apple"</span>] = <span class="hljs-number">5</span>
    m[<span class="hljs-string">"banana"</span>] = <span class="hljs-number">3</span>
    fmt.Println(<span class="hljs-string">"添加后："</span>, m) <span class="hljs-comment">// 输出：添加后： map[apple:5 banana:3]</span>

    <span class="hljs-comment">// 2. 改：修改已有键的值</span>
    m[<span class="hljs-string">"apple"</span>] = <span class="hljs-number">10</span>
    fmt.Println(<span class="hljs-string">"修改后："</span>, m) <span class="hljs-comment">// 输出：修改后： map[apple:10 banana:3]</span>

    <span class="hljs-comment">// 3. 查：获取键的值（两个返回值：值、是否存在）</span>
    val, ok := m[<span class="hljs-string">"apple"</span>]
    <span class="hljs-keyword">if</span> ok {
        fmt.Println(<span class="hljs-string">"apple的值："</span>, val) <span class="hljs-comment">// 输出：apple的值： 10</span>
    } <span class="hljs-keyword">else</span> {
        fmt.Println(<span class="hljs-string">"apple不存在"</span>)
    }

    <span class="hljs-comment">// 查找不存在的键：返回值类型的零值</span>
    val2, ok2 := m[<span class="hljs-string">"orange"</span>]
    fmt.Println(<span class="hljs-string">"orange的值："</span>, val2, <span class="hljs-string">"，是否存在："</span>, ok2) <span class="hljs-comment">// 输出：orange的值： 0 ，是否存在： false</span>

    <span class="hljs-comment">// 4. 删：删除键值对（用delete函数，删除不存在的键不会报错）</span>
    <span class="hljs-built_in">delete</span>(m, <span class="hljs-string">"banana"</span>)
    fmt.Println(<span class="hljs-string">"删除banana后："</span>, m) <span class="hljs-comment">// 输出：删除banana后： map[apple:10]</span>
    <span class="hljs-built_in">delete</span>(m, <span class="hljs-string">"orange"</span>) <span class="hljs-comment">// 无报错</span>
}

</code></pre>
<p>关键注意点：</p>
<ul>
<li>
<p>查找不存在的键时，不会报错，返回值类型的零值（如int返回0，string返回""）；</p>
</li>
<li>
<p>必须通过<code>ok</code>返回值判断键是否存在（避免零值导致的逻辑错误）；</p>
</li>
<li>
<p>delete函数删除不存在的键时，不会触发任何错误。</p>
</li>
</ul>
<h2 data-id="heading-20">6. map的并发安全与sync.Map</h2>
<p>Go的原生map是<strong>并发不安全</strong>的：当多个goroutine同时对map进行“写操作”（增删改）时，会触发运行时错误（<code>fatal error: concurrent map writes</code>）。</p>
<h3 data-id="heading-21">6.1 并发不安全的示例</h3>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    m := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span>)

    <span class="hljs-comment">// 启动10个goroutine同时写map</span>
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ {
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(idx <span class="hljs-type">int</span>)</span></span> {
            m[idx] = idx * <span class="hljs-number">10</span> <span class="hljs-comment">// 并发写</span>
        }(i)
    }

    <span class="hljs-comment">// 等待goroutine执行完成</span>
    time.Sleep(<span class="hljs-number">1</span> * time.Second)
    fmt.Println(<span class="hljs-string">"map内容："</span>, m)
}
</code></pre>
<p>运行结果：大概率会触发<code>concurrent map writes</code>错误。</p>
<h3 data-id="heading-22">6.2 并发安全的解决方案</h3>
<p>实现map的并发安全，有两种常用方案：</p>
<h4 data-id="heading-23">6.2.1 方案1：使用互斥锁（sync.Mutex/sync.RWMutex）</h4>
<p>通过锁来保证同一时间只有一个goroutine能修改map，适合“读多写少”或“读写均衡”的场景：</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"sync"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-comment">// 封装：map + 锁</span>
    <span class="hljs-keyword">type</span> SafeMap <span class="hljs-keyword">struct</span> {
        m sync.RWMutex <span class="hljs-comment">// 读写锁：读锁不互斥，写锁互斥</span>
        data <span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span>
    }

    sm := SafeMap{
        data: <span class="hljs-built_in">make</span>(<span class="hljs-keyword">map</span>[<span class="hljs-type">int</span>]<span class="hljs-type">int</span>),
    }

    <span class="hljs-keyword">var</span> wg sync.WaitGroup
    <span class="hljs-comment">// 启动10个goroutine写map</span>
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ {
        wg.Add(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(idx <span class="hljs-type">int</span>)</span></span> {
            <span class="hljs-keyword">defer</span> wg.Done()
            sm.m.Lock()         <span class="hljs-comment">// 写锁：排他锁</span>
            sm.data[idx] = idx * <span class="hljs-number">10</span>
            sm.m.Unlock()       <span class="hljs-comment">// 释放写锁</span>
        }(i)
    }

    <span class="hljs-comment">// 启动5个goroutine读map</span>
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++ {
        wg.Add(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(idx <span class="hljs-type">int</span>)</span></span> {
            <span class="hljs-keyword">defer</span> wg.Done()
            sm.m.RLock()         <span class="hljs-comment">// 读锁：共享锁</span>
            val := sm.data[idx]
            sm.m.RUnlock()       <span class="hljs-comment">// 释放读锁</span>
            fmt.Printf(<span class="hljs-string">"key=%d, value=%d\n"</span>, idx, val)
        }(i)
    }

    wg.Wait() <span class="hljs-comment">// 等待所有goroutine完成</span>
    fmt.Println(<span class="hljs-string">"最终map内容："</span>, sm.data)
}

</code></pre>
<p>关键说明：</p>
<ul>
<li>
<p>sync.RWMutex（读写锁）比sync.Mutex（互斥锁）效率更高，适合读多写少场景；</p>
</li>
<li>
<p>读锁（RLock）：多个goroutine可以同时获取读锁，互不干扰；</p>
</li>
<li>
<p>写锁（Lock）：获取写锁后，其他goroutine无法获取读锁或写锁（排他性）。</p>
</li>
</ul>
<h4 data-id="heading-24">6.2.2 方案2：使用sync.Map（Go 1.9+ 标准库）</h4>
<p>sync.Map是Go标准库提供的“并发安全map”，专门优化了两种场景：</p>
<ul>
<li>
<p>键值对的“读多写少”；</p>
</li>
<li>
<p>键的生命周期短（频繁删除旧键，添加新键）。</p>
</li>
</ul>
<p>sync.Map的核心方法：</p>
<ul>
<li>
<p>Store(key, value)：存储键值对；</p>
</li>
<li>
<p>Load(key)：获取键的值（返回值、是否存在）；</p>
</li>
<li>
<p>Delete(key)：删除键值对；</p>
</li>
<li>
<p>Range(f func(key, value interface{}) bool)：遍历键值对。</p>
</li>
</ul>
<p>代码示例：sync.Map的使用</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"sync"</span>
    <span class="hljs-string">"time"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    <span class="hljs-keyword">var</span> sm sync.Map

    <span class="hljs-keyword">var</span> wg sync.WaitGroup
    <span class="hljs-comment">// 10个goroutine写</span>
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">10</span>; i++ {
        wg.Add(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(idx <span class="hljs-type">int</span>)</span></span> {
            <span class="hljs-keyword">defer</span> wg.Done()
            sm.Store(idx, idx*<span class="hljs-number">10</span>) <span class="hljs-comment">// 存储键值对</span>
        }(i)
    }

    <span class="hljs-comment">// 5个goroutine读</span>
    <span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++ {
        wg.Add(<span class="hljs-number">1</span>)
        <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(idx <span class="hljs-type">int</span>)</span></span> {
            <span class="hljs-keyword">defer</span> wg.Done()
            val, ok := sm.Load(idx) <span class="hljs-comment">// 获取值</span>
            <span class="hljs-keyword">if</span> ok {
                fmt.Printf(<span class="hljs-string">"key=%d, value=%d\n"</span>, idx, val)
            }
        }(i)
    }

    wg.Wait()

    <span class="hljs-comment">// 遍历sync.Map</span>
    fmt.Println(<span class="hljs-string">"遍历sync.Map："</span>)
    sm.Range(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(key, value <span class="hljs-keyword">interface</span>{})</span></span> <span class="hljs-type">bool</span> {
        fmt.Printf(<span class="hljs-string">"key=%v, value=%v\n"</span>, key, value)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span> <span class="hljs-comment">// 返回true继续遍历，返回false终止遍历</span>
    })
}

</code></pre>
<h3 data-id="heading-25">6.3 方案选择建议</h3>
<ul>
<li>
<p>并发场景简单（读写均衡）：用“map + sync.RWMutex”，灵活性高；</p>
</li>
<li>
<p>读多写少/键生命周期短：用sync.Map，效率更高，无需手动封装锁；</p>
</li>
<li>
<p>非并发场景：直接用原生map，效率最高。</p>
</li>
</ul>
<h2 data-id="heading-26">7. 遍历map与顺序不确定性</h2>
<p>Go的原生map是<strong>无序</strong>的：每次遍历map，键值对的顺序都可能不同。这是Go的设计特性（为了哈希表的性能优化），不能依赖遍历顺序。</p>
<h3 data-id="heading-27">7.1 无序遍历的示例</h3>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> <span class="hljs-string">"fmt"</span>

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    m := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int</span>{
        <span class="hljs-string">"a"</span>: <span class="hljs-number">1</span>,
        <span class="hljs-string">"b"</span>: <span class="hljs-number">2</span>,
        <span class="hljs-string">"c"</span>: <span class="hljs-number">3</span>,
        <span class="hljs-string">"d"</span>: <span class="hljs-number">4</span>,
    }

    <span class="hljs-comment">// 多次遍历，顺序可能不同</span>
    fmt.Println(<span class="hljs-string">"第一次遍历："</span>)
    <span class="hljs-keyword">for</span> k, v := <span class="hljs-keyword">range</span> m {
        fmt.Printf(<span class="hljs-string">"%s: %d "</span>, k, v)
    }
    fmt.Println()

    fmt.Println(<span class="hljs-string">"第二次遍历："</span>)
    <span class="hljs-keyword">for</span> k, v := <span class="hljs-keyword">range</span> m {
        fmt.Printf(<span class="hljs-string">"%s: %d "</span>, k, v)
    }
    fmt.Println()
}

</code></pre>
<p>运行结果示例（两次顺序可能不同）：</p>
<pre><code class="hljs language-Plain" lang="Plain">
第一次遍历：
b: 2 d: 4 a: 1 c: 3
第二次遍历：
a: 1 b: 2 c: 3 d: 4

</code></pre>
<h3 data-id="heading-28">7.2 实现有序遍历的方案</h3>
<p>如果需要“有序遍历map”，核心思路是：</p>
<ol>
<li>
<p>先将map的键提取到切片中；</p>
</li>
<li>
<p>对切片进行排序；</p>
</li>
<li>
<p>按排序后的切片顺序，遍历map的键，获取对应的值。</p>
</li>
</ol>
<p>代码示例：按键的字典序遍历map</p>
<pre><code class="hljs language-go" lang="go">
<span class="hljs-keyword">package</span> main

<span class="hljs-keyword">import</span> (
    <span class="hljs-string">"fmt"</span>
    <span class="hljs-string">"sort"</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
    m := <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-type">int</span>{
        <span class="hljs-string">"d"</span>: <span class="hljs-number">4</span>,
        <span class="hljs-string">"a"</span>: <span class="hljs-number">1</span>,
        <span class="hljs-string">"c"</span>: <span class="hljs-number">3</span>,
        <span class="hljs-string">"b"</span>: <span class="hljs-number">2</span>,
    }

    <span class="hljs-comment">// 1. 提取键到切片</span>
    keys := <span class="hljs-built_in">make</span>([]<span class="hljs-type">string</span>, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(m))
    <span class="hljs-keyword">for</span> k := <span class="hljs-keyword">range</span> m {
        keys = <span class="hljs-built_in">append</span>(keys, k)
    }

    <span class="hljs-comment">// 2. 对切片排序（字典序）</span>
    sort.Strings(keys)

    <span class="hljs-comment">// 3. 按排序后的键遍历map</span>
    fmt.Println(<span class="hljs-string">"按字典序遍历："</span>)
    <span class="hljs-keyword">for</span> _, k := <span class="hljs-keyword">range</span> keys {
        fmt.Printf(<span class="hljs-string">"%s: %d "</span>, k, m[k])
    }
    fmt.Println()

    <span class="hljs-comment">// 按数值降序遍历（以值为排序依据）</span>
    <span class="hljs-comment">// 1. 定义切片存储键值对</span>
    <span class="hljs-keyword">type</span> kv <span class="hljs-keyword">struct</span> {
        Key   <span class="hljs-type">string</span>
        Value <span class="hljs-type">int</span>
    }
    kvSlice := <span class="hljs-built_in">make</span>([]kv, <span class="hljs-number">0</span>, <span class="hljs-built_in">len</span>(m))
    <span class="hljs-keyword">for</span> k, v := <span class="hljs-keyword">range</span> m {
        kvSlice = <span class="hljs-built_in">append</span>(kvSlice, kv{k, v})
    }

    <span class="hljs-comment">// 2. 按值降序排序</span>
    sort.Slice(kvSlice, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i, j <span class="hljs-type">int</span>)</span></span> <span class="hljs-type">bool</span> {
        <span class="hljs-keyword">return</span> kvSlice[i].Value &gt; kvSlice[j].Value
    })

    <span class="hljs-comment">// 3. 遍历排序后的切片</span>
    fmt.Println(<span class="hljs-string">"按值降序遍历："</span>)
    <span class="hljs-keyword">for</span> _, item := <span class="hljs-keyword">range</span> kvSlice {
        fmt.Printf(<span class="hljs-string">"%s: %d "</span>, item.Key, item.Value)
    }
    fmt.Println()
}

</code></pre>
<p>运行结果：</p>
<pre><code class="hljs language-Plain" lang="Plain">
按字典序遍历：
a: 1 b: 2 c: 3 d: 4
按值降序遍历：
d: 4 c: 3 b: 2 a: 1

</code></pre>
<h2 data-id="heading-29">8. 复合类型的内存布局与性能优化</h2>
<p>理解复合类型的内存布局，是进行性能优化的基础。本节将拆解数组、切片、map的内存布局，并给出针对性的性能优化技巧。</p>
<h3 data-id="heading-30">8.1 内存布局拆解</h3>
<h4 data-id="heading-31">8.1.1 数组的内存布局</h4>
<p>数组的内存是<strong>连续的</strong>，元素按索引顺序依次存储。例如<code>[3]int{1,2,3}</code>的内存布局（64位系统，int占8字节）：</p>
<pre><code class="hljs language-Plain" lang="Plain">
地址：0x00  0x08  0x10
元素：1    2    3

</code></pre>
<p>优势：索引访问效率极高（直接通过地址偏移计算元素位置）；缓存命中率高（连续内存易被CPU缓存）。</p>
<h4 data-id="heading-32">8.1.2 切片的内存布局</h4>
<p>切片本身是一个3字段的结构体（指针+len+cap），存储在栈上；其指向的底层数组存储在堆上（如果切片较大，或被外部引用）。例如<code>s := []int{1,2,3}</code>的内存布局：</p>
<pre><code class="hljs language-Plain" lang="Plain">
栈上（切片结构体）：
array指针: 0x100（指向堆上的底层数组）
len: 3
cap: 3

堆上（底层数组）：
地址：0x100  0x108  0x110
元素：1    2    3

</code></pre>
<h4 data-id="heading-33">8.1.3 map的内存布局</h4>
<p>map的底层是“哈希表”，内存布局较复杂，核心结构包括：</p>
<ul>
<li>
<p>hmap（哈希表结构体）：存储map的元信息（桶数组指针、大小、哈希种子等）；</p>
</li>
<li>
<p>bmap（桶）：存储实际的键值对（每个桶可存储8个键值对）；</p>
</li>
<li>
<p>溢出桶：当桶满时，使用溢出桶存储额外的键值对。</p>
</li>
</ul>
<p>核心结论：map的键查找是“哈希计算→桶定位→键比较”的过程，效率高，但无序；频繁的增删改可能导致哈希表扩容，影响性能。</p>
<h3 data-id="heading-34">8.2 通用性能优化技巧</h3>
<h4 data-id="heading-35">8.2.1 切片优化技巧</h4>
<ul>
<li>
<p><strong>预分配容量</strong>：创建切片时，已知元素个数的情况下，用<code>make([]T, 0, cap)</code>预分配容量，减少扩容次数；</p>
</li>
<li>
<p><strong>避免切片泄露</strong>：截取大数组/大切片得到的小切片，会引用整个大底层数组，导致大数组无法被GC回收（内存泄露）。解决方案：拷贝小切片，释放对大数组的引用；</p>
</li>
<li>
<p><strong>使用切片表达式简化操作</strong>：如<code>s = s[:len(s)-1]</code>删除最后一个元素（无需拷贝，效率高）。</p>
</li>
</ul>
<h4 data-id="heading-36">8.2.2 map优化技巧</h4>
<ul>
<li>
<p><strong>预分配容量</strong>：创建map时，已知键值对个数的情况下，预分配容量（<code>make(map[K]V, cap)</code>），减少哈希表扩容次数；</p>
</li>
<li>
<p><strong>选择合适的键类型</strong>：优先使用int、string等“高效哈希类型”，避免使用数组、结构体等复杂类型（哈希计算耗时）；</p>
</li>
<li>
<p><strong>避免频繁的增删改</strong>：频繁的增删改会导致哈希表的“负载因子”波动，触发扩容或缩容，影响性能；</p>
</li>
<li>
<p><strong>批量操作优于循环单操作</strong>：如批量添加键值对时，一次性添加比循环单个添加效率高（减少哈希表的状态检查）。</p>
</li>
</ul>
<h4 data-id="heading-37">8.2.3 数组优化技巧</h4>
<ul>
<li>
<p><strong>传递大数组用指针</strong>：避免拷贝整个数组，提升性能；</p>
</li>
<li>
<p><strong>小数组优先于切片</strong>：对于固定长度的小数组（如<code>[4]byte</code>），用数组比切片更高效（无需结构体开销和堆内存分配）。</p>
</li>
</ul>
<h2 data-id="heading-38">总结</h2>
<p>本章我们全面讲解了Go的三种核心复合类型——数组、切片和map，核心要点总结如下：</p>
<ol>
<li>
<p>数组：固定长度的连续序列，值类型，是切片的底层基础；适合存储固定长度的常量数据；</p>
</li>
<li>
<p>切片：动态数组的视图，底层是“指针+len+cap”的结构体；支持动态扩容，是Go中最常用的序列类型；注意共享内存的数据污染问题，必要时用copy创建独立副本；</p>
</li>
<li>
<p>map：无序的键值对映射，支持快速查找；键必须是可比较类型；原生并发不安全，需用锁或sync.Map保证并发安全；遍历顺序不确定，有序遍历需手动排序键；</p>
</li>
<li>
<p>性能优化核心：预分配容量（切片、map）、避免不必要的拷贝（数组指针、切片拷贝）、选择合适的类型（map键类型）、避免内存泄露（切片截取后的拷贝）。</p>
</li>
</ol>
<p>这三种复合类型是Go编程的基础，几乎所有业务代码都会用到。建议多动手实践：用切片处理动态序列、用map存储键值对数据、用数组保证固定长度约束，同时结合性能优化技巧，写出高效、安全的代码。如果有任何问题，欢迎在评论区交流～</p>
<p>参考链接：</p>
<ul>
<li>
<p>Go官方文档 - 数组：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fref%2Fspec%23Array_types" target="_blank" title="https://go.dev/ref/spec#Array_types" ref="nofollow noopener noreferrer">go.dev/ref/spec#Ar…</a></p>
</li>
<li>
<p>Go官方文档 - 切片：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fref%2Fspec%23Slice_types" target="_blank" title="https://go.dev/ref/spec#Slice_types" ref="nofollow noopener noreferrer">go.dev/ref/spec#Sl…</a></p>
</li>
<li>
<p>Go官方文档 - map：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fref%2Fspec%23Map_types" target="_blank" title="https://go.dev/ref/spec#Map_types" ref="nofollow noopener noreferrer">go.dev/ref/spec#Ma…</a></p>
</li>
<li>
<p>Go标准库 - sync.Map：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpkg.go.dev%2Fsync%23Map" target="_blank" title="https://pkg.go.dev/sync#Map" ref="nofollow noopener noreferrer">pkg.go.dev/sync#Map</a></p>
</li>
<li>
<p>Go官方博客 - 切片内部机制：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgo.dev%2Fblog%2Fslices-intro" target="_blank" title="https://go.dev/blog/slices-intro" ref="nofollow noopener noreferrer">go.dev/blog/slices…</a></p>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Bitmap优化套路深 多级缓存定乾坤]]></title>    <link>https://juejin.cn/post/7599600549763629091</link>    <guid>https://juejin.cn/post/7599600549763629091</guid>    <pubDate>2026-01-27T00:51:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599600549763629091" data-draft-id="7598807837868130330" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Bitmap优化套路深 多级缓存定乾坤"/> <meta itemprop="keywords" content="Kotlin,Android"/> <meta itemprop="datePublished" content="2026-01-27T00:51:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="RockByte"/> <meta itemprop="url" content="https://juejin.cn/user/1046390797768519"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Bitmap优化套路深 多级缓存定乾坤
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1046390797768519/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    RockByte
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T00:51:34.000Z" title="Tue Jan 27 2026 00:51:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="monokai">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#272822;color:#ddd}.hljs-keyword,.hljs-literal,.hljs-name,.hljs-selector-tag,.hljs-strong,.hljs-tag{color:#f92672}.hljs-code{color:#66d9ef}.hljs-class .hljs-title{color:#fff}.hljs-attribute,.hljs-link,.hljs-regexp,.hljs-symbol{color:#bf79db}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-emphasis,.hljs-section,.hljs-selector-attr,.hljs-selector-pseudo,.hljs-string,.hljs-subst,.hljs-template-tag,.hljs-template-variable,.hljs-title,.hljs-type,.hljs-variable{color:#a6e22e}.hljs-comment,.hljs-deletion,.hljs-meta,.hljs-quote{color:#75715e}.hljs-doctag,.hljs-keyword,.hljs-literal,.hljs-section,.hljs-selector-id,.hljs-selector-tag,.hljs-title,.hljs-type{font-weight:700}</style><p><em>本系列为 Android 技术职场题材虚构小说，所有登场人物、公司名称、组织架构及相关情节均为创作所需虚构而来，若有雷同，纯属偶然。书中涉及的技术知识经专业梳理，仅供参考。</em></p>
<h2 data-id="heading-0">十一）Bitmap优化套路深 多级缓存定乾坤</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/816c85e6c5d340c0823689c8bafe9aba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgUm9ja0J5dGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770079896&amp;x-signature=RP4NmFoPWOXTT3FJYPlfqwJrFGw%3D" alt="0.png" loading="lazy"/></p>
<p>新的一周，林卓早早来到公司，心情格外舒畅。阳光透过玻璃幕墙洒在大厅地砖上，折射出暖融融的光斑，难得避开早高峰拥堵的他，脚步都带着轻快。</p>
<p>他径直走向公司楼下的咖啡店，点了一杯热美式，指尖握着温热的杯壁，慢悠悠走回工位。此时办公室里还没几个人，键盘敲击声稀疏，只有中央空调的轻微声响，这份难得的闲暇在紧张的项目周期里显得格外珍贵。</p>
<p>林卓拉开椅子坐下，抿了一口咖啡，正准备梳理本周的工作安排，身后就传来了熟悉的脚步声。</p>
<p>“来得挺早啊，小林。”老杨背着背包走过来，随手把背包放在邻座空位上，语气透着几分轻松。他瞥了眼林卓桌上的热美式，笑着拉过一把椅子坐下，“还挺会享受，这会儿办公室都没几个人，倒让你占了份清净。”</p>
<p>林卓笑着点头回应：“嘿嘿，这周还没有什么新的安排嘛！这会儿能偷个闲，对了老杨，你们的大模型工作主要是干啥呀？”</p>
<p>老杨笑着摆了摆手，语气随意又带着点无奈：“还能啥，瞎忙活呗。车机端为了减少云端压力，想跑一个离线大模型，可车机算力有限，得把模型压缩到合适大小，还得保住识别准确率，磨人的很。”</p>
<p>他瞟了一眼林卓的工位，目光落在林卓的电脑屏幕上，话锋一转，“趁这会儿不忙，我倒想问问你个技术问题——如果给你一张超大分辨率的图片，比如 4000×3000 的，要在车机界面上显示，还得保证不卡顿、不崩内存，你怎么处理？”</p>
<p>林卓握着咖啡杯的手一顿，瞬间收起了放松的心思。他沉吟片刻，缓缓说道：“超大图直接加载肯定不行，会占用大量内存，大概率触发内存溢出错误。应该先对图片进行压缩处理，再考虑显示和优化。”</p>
<p>“没错，核心就是 <code>Bitmap</code> 的高效处理。”老杨点点头，语气里带着几分引导，“具体怎么压缩？怎么保证压缩后显示清晰，还不影响性能？你好好琢磨下。”说完便起身回了工位，椅子拖动的轻响过后，只留下林卓一人坐在原地。</p>
<p>林卓脸上还带着几分茫然，握着咖啡杯愣了两秒，心里暗自纳闷：好端端的闲聊，怎么突然问这个问题？</p>
<p>疑惑归疑惑，他没再多想，指尖无意识地敲击着桌面，脑子里已经开始飞速梳理超大图显示的核心逻辑。</p>
<p>正琢磨着，办公区入口传来脚步声，张磊拿着平板快步走来，目光扫过工位喊道：“林卓，到会议室开个短会，同步下新闻模块的新需求。”林卓连忙收起思绪，锁屏电脑，跟着张磊走向会议室。</p>
<p>会议室里只有三四个人，张磊开门见山，直接点开需求文档：“今天同步个紧急需求，给新闻模块加个《早间要闻》功能，核心是展示前一日的焦点新闻，内容由 AI 总结生成，数量不固定，多则十到二十条，少则五六条。”</p>
<p>他顿了顿，补充道：“因为是 AI 生成内容，特殊情况会比较多——比如图文排版错乱、图片尺寸不规则、文字长度差异大，都要做好兼容。功能优先级很高，周五正式提测，你们各司其职，林卓，你负责新闻的图文显示与适配开发，测试那边同步跟进。”</p>
<p>会议只开了十分钟就结束，林卓走出会议室，心里嘀咕着早上老杨问的问题，隐约觉得或许会用到，但也没深想，转头就全身心投入到新需求的梳理中。</p>
<p>林卓顺着需求细节仔细梳理，很快摸清了核心要点：AI 生成的内容没有固定模板，新闻数量、图文排版、图片尺寸全是变量，界面绘制的关键是兼容性和灵活性，必须先把 UI 显示的基础打牢。</p>
<p>他打开需求文档和 UI，在办公区的白板上，快速勾勒《早间要闻》的界面框架，明确了两大核心模块——新闻摘要列表和专题大图封面区，随后便聚焦 UI 绘制的解决方案。</p>
<p>他指尖轻点白板，顺便用记号笔勾勒几处重点，逐一拆解 UI 难题：新闻摘要卡片要统一样式，还得适配长短不一的 AI 生成文字，背景样式必须灵活；列表分隔线要简洁，还不能因新闻数量多变增加布局负担；专题区的封面大图，感觉没什么难度，直接加载显示就行，顶多有几个文字，这个好办。</p>
<p>思索片刻，他心里有了答案——用 <code>Drawable</code> 家族的不同子类针对性解决，刚好能覆盖这些 UI 适配场景。</p>
<p>时间来到下午，林卓全身心投入 UI 的开发。</p>
<p>他清楚 <code>Drawable</code> 作为可绘制内容的抽象基类，每个子类都有专属适配场景，正好能应对 AI 内容的不确定性，于是有条不紊地为三个核心 UI 场景敲定技术方案。</p>
<p>第一个是新闻摘要卡片，卡片大小不固定（要适配不同长度的 AI 新闻内容），背景还需要带阴影效果，用 <code>.9</code> 最合适。这种特殊格式能手动标记可拉伸区域，同时保留阴影细节，无论卡片被拉伸到多大，阴影边缘都不会模糊变形，完美适配 AI 内容的不确定性。林卓用工具处理好带阴影的 <code>.9</code> 图，直接导入项目就能复用，省去了反复调整布局的麻烦。</p>
<p>第二个是新闻附带的文字标签，标签没有阴影，但要做圆角处理，而且 AI 生成的新闻分类不同，标签颜色也得跟着变，总跟 UI 对接调色太耗时。林卓选用 <code>ShapeDrawable</code> 解决，通过 XML 直接定义圆角大小，颜色则预留代码接口动态设置，无需修改资源文件，既能满足样式要求，又大幅提升了开发效率，还能灵活应对标签颜色的多变需求。</p>
<p>至于专题区的封面大图，林卓反倒觉得没什么复杂的——直接把 AI 返回的图片下载到本地，再加载显示就行，哈哈。</p>
<p>不知不觉两天时间过去，林卓全身心扑在 UI 开发上，终于把 <code>Drawable</code> 适配逻辑全部落地，还完成了整体布局的整合调试，昨儿提测这部分的内容。</p>
<p>此时的他，正等着测试——小安的测试报告，看看有没有新的问题。</p>
<p>没过多久，小安抱着测试机走了过来，脸上带着几分纠结：“林卓，UI 走查和核心功能都过了，样式、适配全符合设计稿。”</p>
<p>她顿了顿：“但有两个明显问题，我已经提交 Bug 和日志了，你赶紧看看。问题集中在专题封面图，一是加载特别慢，进入专题区要等一两秒才显示；二是多打开几个车机软件再切回来，滚动几下，APP 直接崩溃了，日志里好像提示内存溢出。”</p>
<p>林卓心里一紧，打开 Bug 管理平台查看日志。他快速扫完日志内容，眉头瞬间皱了起来——崩溃原因果然是内存溢出，加载慢也和图片资源有关。他亲自复现了一遍问题，果然多打开几个新闻专题封面，直接闪退，封面图加载时也明显有卡顿感。</p>
<p>“不愧是你，小安，日志我先分析下。”林卓支走小安，心里泛起疑惑：怎么会内存溢出？</p>
<p>他反复核对代码，又对照日志里的内存占用记录，心里猜测大概率是图片本身过大导致的。</p>
<p>为了验证猜想，他找到代码中加载图片的逻辑，提取出 AI 返回的图片 URL，逐一复制到浏览器查看。</p>
<p>这不看不要紧，一看吓了一跳——这些图片分辨率参差不齐，小的才 480p，大的竟然直接是 4K 分辨率，体积远超预期。</p>
<p>林卓对着屏幕低声暗骂一句：“服务端这帮人，也不做下图片处理，净给前端填坑！” 此刻他才彻底明白，问题根源就在这无节制的图片分辨率上。</p>
<p>林卓突然恍然大悟，仿佛一道闪电劈进脑海！周一早上老杨问的问题，原来坑在这里！</p>
<p>明确问题根源后，林卓立刻动起手来。他先翻出老杨之前分享过的《Android 核心知识点》文档，找到内存优化相关的章节——那是老杨整理多年项目经验的精华，里面刚好有超大图处理的相关思路。</p>
<p>接着又在技术社区搜了不少车机端图片加载的实战案例，结合自己对需求的理解，慢慢定制出一套针对性的解决思路。</p>
<p>首先是解决“只读尺寸不加载”的核心问题。林卓利用 <code>BitmapFactory.Options</code> 的 <code>inJustDecodeBounds</code> 属性，将其设为 true 后，解码图片时只会返回宽高信息，不会真正分配内存。这样就能在不占用资源的前提下，摸清 AI 生成图片的实际尺寸，避免盲目加载导致内存压力。</p>
<p>摸清尺寸后，下一步计算采样率。采样率直接决定图片缩放比例，比如采样率为 2 时，图片宽高各缩为原来的二分之一，内存占用可降至四分之一。</p>
<p>林卓参照标准算法编写逻辑，确保缩放后的图片尺寸不小于车机控件显示尺寸，既控制内存占用，又避免图片模糊，还开启了抖动优化提升显示质感。</p>
<p>他用一张 4K 的测试图模拟 AI 超大图场景，对应车机专题区 720P 的显示尺寸，优化后内存占用从近 20MB 降至 1.6MB 左右，内存占用有明显优化。</p>
<p>但林卓测试时发现，第一次进入页面仍有加载延迟，快速滑动列表时图片会闪烁，这里就有两个原因了：</p>
<ol>
<li>大图片下载慢</li>
<li>重新压缩图片，也需要一番时间</li>
</ol>
<p>要解决这个问题，必须搭建缓存策略。林卓采用“内存缓存 + 磁盘缓存”的组合方案。</p>
<p>内存缓存用 <code>LruCache</code> 实现，分配大概 10mb 作为容量，自动回收最少使用的图片对象，供封面图快速访问；磁盘缓存用 <code>DiskLruCache</code>，将解码后的图片存储在本地，设置 30MB 缓存上限，避免下次进入页面重复解码。</p>
<p>为了不阻塞主线程，同时更加稳定的加载图片，他用 <code>WorkManager</code> 创建后台任务，在子线程中处理图片解码和缓存逻辑，还封装了统一的加载方法：优先从内存缓存读取，内存无则查磁盘缓存，两者都无再启动后台任务解码，解码完成后同步存入两级缓存。同时他还添加了淡入动画，让图片从透明过渡到不透明，掩盖加载间隙，提升视觉体验。</p>
<p>缓存策略上线后，林卓喊来小安复测。这次页面加载迅速，快速滑动无闪烁，小安逐条核对后露出笑容：“丝滑！“</p>
<p>”不过还有个小问题，专题大图点击放大时动画生硬，感觉是跳过去的，而不是过渡过去的。这个倒不是你的问题，我直接提给产品了”</p>
<p>林卓闻言心里一紧，暗自腹诽：“我的小祖宗！这都要上线了，别再给我加需求了！”</p>
<p>嘴上却只能笑着应下：“行，你先提给产品，我看看能不能顺手优化了，尽量不耽误上线进度。”</p>
<p>虽说心里吐槽，但他也清楚动画体验会影响产品质感，转头就收起杂念，投入到动画知识点的补充学习中。</p>
<p>他找到 Android 动画相关的文档——这内容可真不少！</p>
<p>不过现在的他不可同日而语，历经好几次的产品需求实现和优化，现在的他早已驾轻就熟了。</p>
<p>很快他就梳理完了 <code>AnimatorSet</code> 的使用方法，重点琢磨缩放与平移动画的时序衔接、插值器参数调整。</p>
<p>加之之前 <code>Bitmap</code> 优化和 <code>Drawable</code> 适配的基础，动画知识点上手很快，短短一个下午就吃透了核心逻辑，还针对性调整了动画时长与过渡曲线，让大图放大效果更丝滑。</p>
<p>第二天一早，产品拿着优化建议找到他，明确提出要优化专题大图的放大过渡动画，强调“生硬跳转影响用户体验”，要求上线前搞定。</p>
<p>林卓心里虽有“临时加需求”的无奈，但也清楚体验优先级，立刻收起杂念投入开发。</p>
<p>嘿嘿，幸好昨儿学习的差不多了，把昨儿写的大部分示例代码，移植过来，针对 UI 优化一下就行了！</p>
<p>上午优化完成后，林卓第一时间同步给小安提测，仅用半天就完成了验收。</p>
<p>......</p>
<p>周五下午，《早间要闻》UI 相关需求全部正式提测，忙得脚不沾地的林卓长舒一口气，当即约了老杨和小安去吃小火锅，算是给这一周的奋战收尾。</p>
<p>火锅店堂里人声鼎沸，烟火气十足，三人找了个靠窗的小桌坐下，肥牛卷刚下锅翻滚，林卓就对着两人大倒苦水：“你们是不知道，这次最坑的就是服务端那帮人，返回的图片大小没个准头，小的才 480p，大的直接 4K，害得我额外花了两天优化 <code>Bitmap</code> 和缓存，差点就耽误进度要周末加班了。”</p>
<p>他说着端起饮料碰了碰老杨的杯子，语气满是庆幸：“还好老杨你周一提前问了我超大图的问题，不然我压根没往这方面想，周末指定得泡在公司了，谢了啊，我先干了！”</p>
<p>老杨夹着一片毛肚涮着，漫不经心地抬眼笑道：“嘻嘻，那图片本来就是我这边返回的。”</p>
<p>见林卓瞬间愣住，他才慢悠悠补充，“车机端这个离线大模型，前期数据都是直接从网上爬的，没做过滤和压缩，细节优化得等功能跑通了再搞，先把核心流程跑起来再说。”</p>
<p>林卓脸上的感激之情瞬间僵住，嘴里的饮料还没喝完，差点一口呛住，等稳住心神，随即气不打一处来，伸手拍了下老杨的胳膊：“合着坑我的人就是你啊！我说你怎么突然问那问题，原来早知道有这茬！”</p>
<p>小安在一旁笑得直不起腰，握着筷子的手都跟着发颤，刚夹起一片毛肚要往锅里放，又忍不住缩回手按住肚子，眼泪都快笑出来了。</p>
<p>林卓瞪了老杨一眼，干脆摆起架子：“老杨，那这顿，你请客！”</p>
<p>老杨乐呵呵地应下：“没问题，想吃啥随便点，我请客。”</p>
<p>酒足饭饱，老杨结完账，拍了拍林卓的肩膀随口提了句：“对了，你这次做的大图放大动画还行，后续可以研究研究 <code>MotionLayout</code>，更丝滑，还能和布局联动做动画。”</p>
<p>林卓一听，当即垮了脸，吐槽道：“什么意思？这刚忙完又给我埋坑是吧？”</p>
<p>老杨笑着拍拍肩，语气带着点过来人式的调侃：“不自己踩踩坑，怎么把知识点吃透、长记性？下次遇到类似问题，不就轻车熟路了？”</p>
<p>三人并肩走出火锅店，晚风带着凉意，却吹不散并肩作战后的轻松惬意。</p>
<p>林卓嘴上抱怨着老杨挖坑，心里却清楚，这一周的磕磕绊绊，早已让他把图片优化的知识点刻进了心里，这份成长，远比少踩一个坑更珍贵。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[为什么没人走后门当程序员？]]></title>    <link>https://juejin.cn/post/7599581204859715610</link>    <guid>https://juejin.cn/post/7599581204859715610</guid>    <pubDate>2026-01-27T00:51:19.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599581204859715610" data-draft-id="7599565587153141786" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="为什么没人走后门当程序员？"/> <meta itemprop="keywords" content="前端,后端,程序员"/> <meta itemprop="datePublished" content="2026-01-27T00:51:19.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CodeSheep"/> <meta itemprop="url" content="https://juejin.cn/user/4371313961738616"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            为什么没人走后门当程序员？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4371313961738616/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CodeSheep
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T00:51:19.000Z" title="Tue Jan 27 2026 00:51:19 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近刷 X 乎时看到这样一个耐人寻味的的讨论话题，浏览量超 170w，参与讨论的同学也好多。</p>
<p>问题描述是这样的：</p>
<p><strong>“为什么没人走后门当程序员？”</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d11f8a22a6c74464b54c2681faf97684~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29kZVNoZWVw:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770079881&amp;x-signature=tI4vQtuhQ1hGSabAPGSSVG9DfHY%3D" alt="" loading="lazy"/></p>
<p>我认真浏览了一圈，心里五味杂陈。</p>
<p>在许多人眼中，程序员是一个高薪的职业。然而，即便程序员们拿着如此令人羡慕的高薪，尽管互联网行业如此火热，但却几乎很少听说有人说走后门想进去。</p>
<p>其实这事情一点也不难理解，这得先从程序员工作的本质说起。</p>
<p>因为程序员这个职业，从根子上来说压根就不靠后门吃饭。</p>
<p>而且程序员这行，恰恰是最混不了日子的，它要求你持续学习，跟上技术迭代，解决一个个具体而棘手的问题。</p>
<p>编程是一个实实在在的技术活，当你的代码运行不起来，它就是运行不起来，你写的系统有漏洞，它就会在某个深夜悄然崩溃，这种刚性特质就决定了程序员这个岗位无法容忍滥竽充数者。</p>
<p>而程序员的门槛，是技术，是能力，走后门也写不出一行能跑通的代码。</p>
<p>退一步说，哪怕就算你真靠后门挤进了公司，项目一上来，分分钟就会露馅。</p>
<p>那些想走后门的人，大概率是想找一个稳当、轻松、有人脉资源的工作。但反思程序员这行，是这样吗？好……好像哪个也不沾边吧……</p>
<p>所以没人走后门干程序员，不是因为这行没前途，而是因为它太实在、太透明、太难伪装。</p>
<p>这是一份必须用真本事去交换的职业，关系在这里，价值被迅速稀释到近乎为零。</p>
<p>另外大家往往有种误解或者说错觉，总觉得程序员赚得多就是香，而实际却忽略了这个高薪背后所付出的代价，这一切都是来源于高强度脑力劳动和长时间脑力付出所带来的回报。</p>
<p>再者，互联网行业的本质是工程化与扁平化。在这个体系里，你是谁、认识谁、从哪来，其实并不太重要，没人会关注你这个，英雄不问出处。</p>
<p>重要的是，你能不能解决问题，能不能为项目创造价值。</p>
<p>所以，当我们回过头来再看，为什么没人走后门干程序员这个问题，其实本身就蕴含着一种误解。它预设了程序员是一个好差事，一个可以让人躺着赚钱的美差。</p>
<p>但事实上，程序员是一份需要真才实学、持续奋斗、直面挑战的工作。你付出多少努力，掌握多少技能，最终都会在你的代码和收入上得到真实的反馈。</p>
<p>当然，这里还有一点需要反思的是：</p>
<p>该说不说，程序员行业的这种去关系化特质，其实某一角度来说也带来了一些副产品。</p>
<p>比方说，技术至上的工作文化有时会导致个体沟通能力的忽视，对硬技能的过度强调可能让软技能的发展有所滞后，另外代码世界的非黑即白有时候也会让人忽略了现实世界的复杂灰度。</p>
<p>这些其实都是程序员文化中值得反思和平衡的地方。</p>
<p>有一说一，其实很多代码之外的东西对现如今的生存也很重要，因为思维如果不开阔出来的话，路可能就会越走越窄了。</p>
<p>其实很多程序员在年龄大了之后越来越焦虑的一个重要原因就是因为生存技能太过单一了，所以千万不要给自己设限，不要把目光仅仅聚集在自己的一亩三分地上，还是要多培养一些其他方面的一些软实力，会很有帮助。</p>
<p>不知道大家有没有看过《软技能》那两本书，讲的就是代码之外的一些软技能和经验，里面提到了很多有关职场的分析，自我提高的一些路径，个人的持续学习和成长，甚至包括像理财、健身、时间管理、心态调整等等。</p>
<p>有意识地去关注这方面东西的原因在于可以帮助自己把思维给开阔出来，毕竟很多时候有必要跳出来看问题，这时候这些软技能往往就能发挥作用了。</p>
<p>另外，程序员作为一个有个性的创造性群体要专注精进技术这本身没错，但是职场毕竟也是一个充满人情世故的江湖，所以掌握一些通用的职场规则、沟通技巧，甚至是向上管理的艺术，这对于程序员来说也是十分有必要的。</p>
<p>仰望星空，脚踏实地，埋头赶路的同时也不要忘记时常抬头看看周围的环境和机会。</p>
<p>那关于这个问题，你的看法是什么呢，如果有不同的见解，也欢迎一起来分享交流~</p>
<blockquote>
<p>注：本文在GitHub开源仓库「编程之路」 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Frd2coding%2FRoad2Coding" target="_blank" title="https://github.com/rd2coding/Road2Coding" ref="nofollow noopener noreferrer">github.com/rd2coding/R…</a> 中已经收录，里面有我整理的6大编程方向(岗位)的自学路线+知识点大梳理、面试考点、我的简历、几本硬核pdf笔记，以及程序员生活和感悟，欢迎star。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vercel Skills 详解]]></title>    <link>https://juejin.cn/post/7599551824548020250</link>    <guid>https://juejin.cn/post/7599551824548020250</guid>    <pubDate>2026-01-26T16:28:51.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599551824548020250" data-draft-id="7599551824548003866" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vercel Skills 详解"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-26T16:28:51.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="左Python右Java"/> <meta itemprop="url" content="https://juejin.cn/user/4107431173952525"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vercel Skills 详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4107431173952525/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    左Python右Java
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T16:28:51.000Z" title="Mon Jan 26 2026 16:28:51 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Vercel Skills 详解</h2>
<h3 data-id="heading-1">一、什么是 Vercel Skills？</h3>
<p><strong>Vercel Skills</strong>（也称为 Agent Skills）是由 Vercel 推出的一个<strong>AI 编程助手的技能包管理器</strong>。它是一个开源项目，专门为 AI 智能体设计，用于管理和分发 AI 编码代理的技能包。</p>
<h4 data-id="heading-2">核心特点：</h4>
<ol>
<li><strong>技能包管理器</strong>：类似 npm，但专门针对 AI 智能体</li>
<li><strong>最佳实践集合</strong>：将多年的开发经验和最佳实践转化为 AI 可理解的技能</li>
<li><strong>自动化分发</strong>：自动将技能包分发到对应的 AI 工具配置目录</li>
<li><strong>开源免费</strong>：完全开源，免费使用</li>
<li><strong>专注 React/Next.js</strong>：目前主要专注于 React 和 Next.js 生态</li>
</ol>
<h3 data-id="heading-3">二、怎么用？</h3>
<h4 data-id="heading-4">1. 安装技能包</h4>
<p>使用一行命令即可安装技能包：</p>
<pre><code class="hljs language-bash" lang="bash">npx add-skill vercel-labs/agent-skills
</code></pre>
<p>这个命令会：</p>
<ul>
<li>从 GitHub 下载技能包</li>
<li>检测系统中安装的 AI 工具</li>
<li>自动将技能分发到每个工具对应的配置目录</li>
</ul>
<h4 data-id="heading-5">2. 支持的 AI 工具</h4>
<p>Vercel Skills 支持多种 AI 编码工具，包括但不限于：</p>
<ul>
<li>Cursor</li>
<li>GitHub Copilot</li>
<li>Windsurf</li>
<li>其他 AI 编码助手</li>
</ul>
<h4 data-id="heading-6">3. 技能包内容</h4>
<p>Vercel Skills 包含以下技能模块：</p>
<h5 data-id="heading-7">React 和 Next.js 性能优化</h5>
<ul>
<li>45 条性能优化黄金法则</li>
<li>组件渲染优化</li>
<li>状态管理最佳实践</li>
<li>路由优化技巧</li>
</ul>
<h5 data-id="heading-8">网页设计审查</h5>
<ul>
<li>响应式设计规范</li>
<li>可访问性标准</li>
<li>UI/UX 最佳实践</li>
<li>性能指标检查</li>
</ul>
<h5 data-id="heading-9">代码质量标准</h5>
<ul>
<li>代码风格规范</li>
<li>安全性检查</li>
<li>错误处理模式</li>
<li>测试覆盖率要求</li>
</ul>
<h4 data-id="heading-10">4. 使用示例</h4>
<h5 data-id="heading-11">安装后，AI 助手会自动获得以下能力：</h5>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// AI 会自动应用最佳实践</span>
<span class="hljs-comment">// 优化前</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserList</span>(<span class="hljs-params">{ users }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      {users.map(user =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{user.id}</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>{user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{user.email}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}

<span class="hljs-comment">// AI 会优化为（应用 Skills 中的性能优化规则）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">UserList</span>(<span class="hljs-params">{ users }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"user-list"</span>&gt;</span>
      {users.map(user =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">article</span> <span class="hljs-attr">key</span>=<span class="hljs-string">{user.id}</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"user-card"</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">h3</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"user-name"</span>&gt;</span>{user.name}<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"user-email"</span>&gt;</span>{user.email}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">article</span>&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h4 data-id="heading-12">5. 自定义技能包</h4>
<p>你也可以创建自己的技能包：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建自定义技能包</span>
<span class="hljs-built_in">mkdir</span> my-skills
<span class="hljs-built_in">cd</span> my-skills

<span class="hljs-comment"># 初始化技能包配置</span>
npx add-skill init

<span class="hljs-comment"># 添加自定义技能</span>
<span class="hljs-comment"># 编辑 skill.md 文件，定义你的最佳实践</span>
</code></pre>
<h3 data-id="heading-13">三、为什么需要 Vercel Skills？</h3>
<h4 data-id="heading-14">1. 解决 AI 理解框架规范的挑战</h4>
<p><strong>问题</strong>：</p>
<ul>
<li>AI 模型训练数据可能不包含最新的框架规范</li>
<li>不同框架有复杂的最佳实践和性能优化规则</li>
<li>AI 可能生成不符合生产环境标准的代码</li>
</ul>
<p><strong>解决方案</strong>：</p>
<ul>
<li>Vercel Skills 将最佳实践转化为 AI 可理解的格式</li>
<li>让 AI 知道 10 多年的 React 和 Next.js 开发经验</li>
<li>确保生成的代码达到生产级标准</li>
</ul>
<h4 data-id="heading-15">2. 提高代码质量</h4>
<p><strong>优势</strong>：</p>
<ul>
<li><strong>性能优化</strong>：自动应用 45 条性能优化黄金法则</li>
<li><strong>代码规范</strong>：遵循统一的编码标准</li>
<li><strong>安全性</strong>：内置安全检查和最佳实践</li>
<li><strong>可维护性</strong>：生成易于维护的代码结构</li>
</ul>
<h4 data-id="heading-16">3. 加速开发流程</h4>
<p><strong>效率提升</strong>：</p>
<ul>
<li>减少代码审查时间</li>
<li>减少重构和优化工作</li>
<li>让 AI 助手"像 Vercel 工程师附体"</li>
<li>性能飙升，代码质量直接达到生产级</li>
</ul>
<h4 data-id="heading-17">4. 统一团队标准</h4>
<p><strong>团队协作</strong>：</p>
<ul>
<li>所有团队成员的 AI 助手使用相同的技能包</li>
<li>确保代码风格和最佳实践的一致性</li>
<li>降低新人学习成本</li>
<li>提高团队整体开发效率</li>
</ul>
<h4 data-id="heading-18">5. 持续更新和改进</h4>
<p><strong>生态优势</strong>：</p>
<ul>
<li>开源社区持续贡献新的技能</li>
<li>Vercel 官方维护和更新</li>
<li>跟随框架发展及时更新最佳实践</li>
<li>社区驱动的技能共享</li>
</ul>
<h3 data-id="heading-19">四、实际应用场景</h3>
<h4 data-id="heading-20">1. 新项目开发</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 在新项目中安装技能包</span>
npx add-skill vercel-labs/agent-skills

<span class="hljs-comment"># AI 助手会自动应用最佳实践</span>
<span class="hljs-comment"># 生成符合 Vercel 标准的代码</span>
</code></pre>
<h4 data-id="heading-21">2. 代码审查</h4>
<p>AI 助手会根据 Skills 中的规则：</p>
<ul>
<li>检查性能问题</li>
<li>识别安全隐患</li>
<li>提出优化建议</li>
<li>确保代码质量</li>
</ul>
<h4 data-id="heading-22">3. 重构优化</h4>
<p>AI 助手可以：</p>
<ul>
<li>应用性能优化规则</li>
<li>改进代码结构</li>
<li>提升可维护性</li>
<li>优化用户体验</li>
</ul>
<h4 data-id="heading-23">4. 团队培训</h4>
<p>新团队成员通过 Skills：</p>
<ul>
<li>快速学习最佳实践</li>
<li>了解框架规范</li>
<li>掌握性能优化技巧</li>
<li>提高代码质量意识</li>
</ul>
<h3 data-id="heading-24">五、总结</h3>
<p><strong>Vercel Skills</strong> 是一个革命性的工具，它：</p>
<ol>
<li><strong>是什么</strong>：AI 编程助手的技能包管理器</li>
<li><strong>怎么用</strong>：一行命令 <code>npx add-skill vercel-labs/agent-skills</code> 安装</li>
<li><strong>为什么</strong>：让 AI 生成的代码达到生产级标准，提高开发效率和代码质量</li>
</ol>
<p>它将多年的开发经验和最佳实践转化为 AI 可理解的技能，让 AI 助手能够像经验丰富的工程师一样编写高质量的代码。这对于提高团队开发效率、统一代码标准、降低维护成本都具有重要意义。</p>
<p>如果你正在使用 AI 编码工具（如 Cursor、GitHub Copilot 等），强烈建议尝试 Vercel Skills，它会显著提升你的开发体验和代码质量。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Laravel Boost v2.0 发布 正式支持 Skills]]></title>    <link>https://juejin.cn/post/7599538010725597211</link>    <guid>https://juejin.cn/post/7599538010725597211</guid>    <pubDate>2026-01-27T00:02:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599538010725597211" data-draft-id="7599581687357669426" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Laravel Boost v2.0 发布 正式支持 Skills"/> <meta itemprop="keywords" content="后端,Laravel"/> <meta itemprop="datePublished" content="2026-01-27T00:02:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Laravel Boost v2.0 发布 正式支持 Skills
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-27T00:02:36.000Z" title="Tue Jan 27 2026 00:02:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-27
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Laravel Boost v2.0 发布 正式支持 Skills</h2>
<p>Laravel Boost 发布了 2.0 版本，核心变化是引入了 Skills 系统。这套机制改变了 AI Agent 获取上下文的方式——从"一次性加载所有指南"变为"按需激活相关技能"。</p>
<p>实测效果：原有的 Guidelines 体积减少约 40%，Agent 响应更聚焦，生成的代码质量明显提升。</p>
<h3 data-id="heading-1">这个版本带来了什么</h3>
<ul>
<li><strong>Skills 系统</strong>：按需加载的上下文管理机制</li>
<li><strong>Skill Overrides</strong>：支持覆盖和定制已有技能</li>
<li><strong>boost:add-skill 命令</strong>：一行命令添加社区技能</li>
<li><strong>安装流程优化</strong>：重构了初始化体验</li>
</ul>
<h3 data-id="heading-2">Guidelines 和 Skills 的区别</h3>
<p>Boost 现在提供两种方式给 Agent 提供上下文。</p>
<p><strong>Guidelines</strong></p>
<ul>
<li>Agent 启动时一次性加载</li>
<li>覆盖面广，偏基础性</li>
<li>主要是 Laravel 通用约定和最佳实践</li>
</ul>
<p><strong>Skills</strong></p>
<ul>
<li>仅在需要时激活</li>
<li>聚焦特定领域</li>
<li>针对 Livewire、Pest、Inertia 等具体场景提供详细模式</li>
</ul>
<p>这种分层设计解决了一个实际问题：Agent 的上下文窗口是有限的。以前把所有指南都塞进去，Agent 可能在不相关的信息里迷失方向。现在只加载当前任务需要的技能，生成的代码更贴合实际需求。</p>
<h3 data-id="heading-3">内置技能清单</h3>
<p>v2.0 内置了一批开箱即用的技能：</p>
<ul>
<li>Livewire 开发</li>
<li>Pest 测试</li>
<li>Tailwind CSS</li>
<li>Inertia（Vue、React、Svelte）</li>
<li>Volt</li>
<li>Flux UI</li>
<li>Folio 路由</li>
<li>Pennant</li>
<li>MCP</li>
<li>Wayfinder</li>
</ul>
<p>更新这些技能只需要一条命令：</p>
<pre><code class="hljs language-bash" lang="bash">php artisan boost:update
</code></pre>
<h3 data-id="heading-4">社区技能</h3>
<p>除了内置技能，Boost 支持从社区或 GitHub 拉取第三方技能。</p>
<pre><code class="hljs language-bash" lang="bash">php artisan boost:add-skill
</code></pre>
<p>选择需要的技能后，Boost 会自动同步到所有 Agent 配置中。</p>
<h3 data-id="heading-5">自定义技能</h3>
<p>如果项目有特殊的业务逻辑或团队约定，可以创建自定义技能。</p>
<p>在以下路径添加文件：</p>
<pre><code class="hljs language-text" lang="text">.ai/skills/{skill-name}/SKILL.md
</code></pre>
<p>运行 <code>boost:update</code> 后，自定义技能会和内置技能一起安装。</p>
<p>适用场景：</p>
<ul>
<li>领域模型规范</li>
<li>团队代码风格约定</li>
<li>项目特有的架构模式</li>
</ul>
<h3 data-id="heading-6">包开发者支持</h3>
<p>包开发者现在可以随包发布技能。</p>
<p>将技能文件放在：</p>
<pre><code class="hljs language-text" lang="text">resources/boost/skills/{skill-name}/SKILL.md
</code></pre>
<p>用户安装 Boost 时，包内的技能会被自动发现并安装。</p>
<p>这对于维护开源包的开发者来说是个实用功能——用户在使用你的包时，Agent 能自动获得正确的上下文，减少"用错 API"的情况。</p>
<h3 data-id="heading-7">总结</h3>
<p>Skills 系统的核心价值在于"精准上下文"。Agent 不再需要处理大量不相关的信息，而是按需获取当前任务需要的知识。对于正在使用 AI 辅助开发 Laravel 项目的团队，这是一次值得跟进的升级。</p>
<pre><code class="hljs language-bash" lang="bash">composer require laravelboost/boost:^2.0
</code></pre>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2026-01%2Flaravel-boost-v2-skills-system" target="_blank" title="https://catchadmin.com/post/2026-01/laravel-boost-v2-skills-system" ref="nofollow noopener noreferrer">原文 Laravel Boost v2.0 发布 Skills 让 AI 编码助手更懂你的项目</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Langchain学习笔记（一）：认识Langchain-调用LLM的正确姿势]]></title>    <link>https://juejin.cn/post/7599511763987808310</link>    <guid>https://juejin.cn/post/7599511763987808310</guid>    <pubDate>2026-01-26T17:37:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599511763987808310" data-draft-id="7599483314161172499" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Langchain学习笔记（一）：认识Langchain-调用LLM的正确姿势"/> <meta itemprop="keywords" content="人工智能,LLM,LangChain"/> <meta itemprop="datePublished" content="2026-01-26T17:37:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Shawn_Shawn"/> <meta itemprop="url" content="https://juejin.cn/user/1855631358965384"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Langchain学习笔记（一）：认识Langchain-调用LLM的正确姿势
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1855631358965384/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Shawn_Shawn
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T17:37:39.000Z" title="Mon Jan 26 2026 17:37:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Langchain是一款开源框架，用于构建Agent，集成了众多大模型供应商和工具。</p>
<ul>
<li>langchain主要负责与LLM交互，Tool，Rag，Memory，Agent等功能。</li>
<li>LangGraph负责实现Agent编排，专用于构建、管理和部署<strong>长时间运行（long-running）且具备状态管理（stateful</strong>的智能体。</li>
<li>LangSmith则负责提升Agent的可观测性，提供了用于开发、调试和部署 LLM 应用程序的工具。 它能够帮助您在一个统一的平台上追踪请求、评估输出、测试提示词（Prompts）以及管理部署。</li>
</ul>
<h2 data-id="heading-0">Langchain核心功能</h2>
<h3 data-id="heading-1">LCEL语法</h3>
<p>早期的Langchain，将提示词，模型，工具调用，Rag，Memory等模块组织成链式结构，让开发者能够清晰的组合这些组件，构建出复杂的Agent。但是缺点也很明显：</p>
<ol>
<li>流程不透明、调试困难：链条中间没有明确的状态表达，出错时难以定位是哪一步出了问题。</li>
<li>缺乏并发与分支控制能力：只能“从左到右”执行，面对多轮对话、并行任务，力不从心。</li>
<li>Agent 系统复杂难控：LangChain Agent 的“反复推理 + 工具调用”机制，虽然看似智能，但在实际工程中不稳定、不易测试。</li>
</ol>
<p>为了解决这些问题，Langchain团队研发出了LCEL。LCEL (LangChain Expression Language) 是 LangChain 提供的一种声明式语言，用于轻松构建和组合复杂的链（Chains）。使得代码更加简洁、清晰，并且原生支持流式/非流式输出。</p>
<p>在LCEL中，所有组件都实现了 <code>langchain_core.runnables.base.Runnable</code>接口，都实现了</p>
<ul>
<li>invoke() - 单个输入</li>
<li>batch() - 批量输入</li>
<li>stream() - 流式输出</li>
<li>ainvoke() - 异步单个输入</li>
</ul>

































<table><thead><tr><th><strong>组件名称</strong></th><th><strong>作用</strong></th></tr></thead><tbody><tr><td><strong>RunnableSequence</strong></td><td>顺序执行</td></tr><tr><td><strong>RunnableParallel</strong></td><td>并行执行多个任务</td></tr><tr><td><strong>RunnablePassthrough</strong></td><td>透传数据，不做处理</td></tr><tr><td><strong>RunnableLambda</strong></td><td>将自定义 Python 函数转为 Runnable</td></tr><tr><td><strong>RunnableConfig</strong></td><td>配置项</td></tr><tr><td><strong>RunnableBranch</strong></td><td>条件分支</td></tr></tbody></table>
<p>但是，现在的Agent是越来越复杂，需要更加精细化的状态管控，任务调度，失败处理，事件监听，整个Agent的生命周期到每一个事件的生命周期，都需要更加细粒度的管理，还需要一套更为清晰完整的，适合工作流程编排的框架。那就是LangGraph的诞生。</p>
<ul>
<li>LCEL：描述单个“图节点”的调用逻辑（比如一个子任务、一个 API 调用）。</li>
<li>LangGraph：编排多个节点，负责整个工作流的调度、状态跳转与生命周期控制。</li>
</ul>
<h3 data-id="heading-2">Model</h3>
<p>安装 openai依赖 <code>pip install langchain-openai</code></p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">from</span> dotenv <span class="hljs-keyword">import</span> load_dotenv
<span class="hljs-keyword">from</span> langchain_openai <span class="hljs-keyword">import</span> ChatOpenAI
<span class="hljs-keyword">from</span> langchain_core.prompts <span class="hljs-keyword">import</span> ChatPromptTemplate, PromptTemplate
<span class="hljs-keyword">from</span> langchain_core.tools <span class="hljs-keyword">import</span> Tool
<span class="hljs-keyword">import</span> datetime

<span class="hljs-comment"># 加载环境变量</span>
load_dotenv()
api_key = os.getenv(<span class="hljs-string">'OPENAI_API_KEY'</span>)
base_url = os.getenv(<span class="hljs-string">'OPENAI_API_BASE'</span>)

<span class="hljs-comment"># ========== 1. 初始化 LLM（大语言模型） ==========</span>
<span class="hljs-comment"># LangChain 特点：统一的 LLM 接口，支持多种模型提供商</span>
llm = ChatOpenAI(
    base_url=base_url,
    api_key=api_key,
    model=<span class="hljs-string">"deepseek-ai/DeepSeek-V3.2"</span>,
    temperature=<span class="hljs-number">0.7</span>  <span class="hljs-comment"># LangChain 特点：统一的参数配置</span>
)

<span class="hljs-comment"># 也可以使用 init_chat_model 由于我使用的是硅基流动的，所以需要提供model_provider为openai</span>
<span class="hljs-comment"># 如果你直接使用的是deepseek，model_provider可以不用填，但需要安装langchain-deepseek包</span>
model = init_chat_model(
    model=<span class="hljs-string">"deepseek-ai/DeepSeek-V3.2"</span>,
    model_provider=<span class="hljs-string">"openai"</span>,
    temperature=<span class="hljs-number">0.7</span>
)


<span class="hljs-comment"># ========== 2. LLMChain：Prompt → LLM → 输出链的基本流程封装 ==========</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">demo_llm_chain</span>():
    <span class="hljs-string">"""
    演示 LLMChain：支持变量注入与模板复用的核心组件
    LangChain 特点：模板化提示词管理，支持变量替换
    """</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"🔗 LLMChain 演示：Prompt → LLM → 输出链"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"="</span> * <span class="hljs-number">50</span>)

    <span class="hljs-comment"># 创建提示词模板 - LangChain 特点：模板复用</span>
    prompt_template = PromptTemplate(
        input_variables=[<span class="hljs-string">"topic"</span>, <span class="hljs-string">"style"</span>],
        template=<span class="hljs-string">"""
        请以{style}的风格，写一段关于{topic}的介绍。
        要求：简洁明了，不超过100字。
        """</span>
    )

    <span class="hljs-comment"># LCEL (LangChain Expression Language)，还是0.x的版本用的比较多</span>
    <span class="hljs-comment"># 1.x开始采用Message</span>
    <span class="hljs-comment"># 下面两种方式都行</span>
    chain = prompt_template | llm
    chain = prompt_template | model
    <span class="hljs-comment"># 执行链 - 变量注入 </span>

    result = chain.invoke({<span class="hljs-string">"topic"</span>: <span class="hljs-string">"人工智能"</span>, <span class="hljs-string">"style"</span>: <span class="hljs-string">"科普"</span>})
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"📝 LLMChain 输出：\n<span class="hljs-subst">{result.content}</span>\n"</span>)

    <span class="hljs-comment"># 流式输出</span>
    <span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> chain.stream({<span class="hljs-string">"topic"</span>: <span class="hljs-string">"人工智能"</span>, <span class="hljs-string">"style"</span>: <span class="hljs-string">"科普"</span>}):
        <span class="hljs-built_in">print</span>(chunk.text, end=<span class="hljs-string">"|"</span>, flush=<span class="hljs-literal">True</span>)

    <span class="hljs-comment"># batch</span>
    messages = [
        {<span class="hljs-string">"topic"</span>: <span class="hljs-string">"人工智能"</span>, <span class="hljs-string">"style"</span>: <span class="hljs-string">"科普"</span>},
        {<span class="hljs-string">"topic"</span>: <span class="hljs-string">"大模型"</span>, <span class="hljs-string">"style"</span>: <span class="hljs-string">"科普"</span>},
        {<span class="hljs-string">"topic"</span>: <span class="hljs-string">"langchain"</span>, <span class="hljs-string">"style"</span>: <span class="hljs-string">"科普"</span>}
    ]
    responses = chain.batch(messages)
    <span class="hljs-keyword">for</span> response <span class="hljs-keyword">in</span> responses:
        <span class="hljs-built_in">print</span>(response)


    <span class="hljs-keyword">return</span> result.content
</code></pre>
<p><strong>核心的方法</strong></p>
<ul>
<li>invoke</li>
</ul>
<pre><code class="hljs language-python" lang="python">result = chain.invoke({<span class="hljs-string">"topic"</span>: <span class="hljs-string">"人工智能"</span>, <span class="hljs-string">"style"</span>: <span class="hljs-string">"科普"</span>})
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"📝 LLMChain 输出：\n<span class="hljs-subst">{result.content}</span>\n"</span>)
</code></pre>
<ul>
<li>stream</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 流式输出</span>
<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> chain.stream({<span class="hljs-string">"topic"</span>: <span class="hljs-string">"人工智能"</span>, <span class="hljs-string">"style"</span>: <span class="hljs-string">"科普"</span>}):
    <span class="hljs-built_in">print</span>(chunk.text, end=<span class="hljs-string">"|"</span>, flush=<span class="hljs-literal">True</span>)
</code></pre>
<ul>
<li>batch</li>
</ul>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># batch</span>
messages = [
    {<span class="hljs-string">"topic"</span>: <span class="hljs-string">"人工智能"</span>, <span class="hljs-string">"style"</span>: <span class="hljs-string">"科普"</span>},
    {<span class="hljs-string">"topic"</span>: <span class="hljs-string">"大模型"</span>, <span class="hljs-string">"style"</span>: <span class="hljs-string">"科普"</span>},
    {<span class="hljs-string">"topic"</span>: <span class="hljs-string">"langchain"</span>, <span class="hljs-string">"style"</span>: <span class="hljs-string">"科普"</span>}
]
responses = chain.batch(messages)
<span class="hljs-keyword">for</span> response <span class="hljs-keyword">in</span> responses:
    <span class="hljs-built_in">print</span>(response)
</code></pre>
<p><strong>核心参数</strong>：</p>
<ul>
<li>model: 大模型名称</li>
<li>model_provider: 模型供应商，我用的是硅基流动，langchain没有提供硅基流动的包，但硅基流动兼容了OpenAi协议，模型供应商选择OpenAi，也能连接硅基流动。</li>
<li>api_key:</li>
<li>temperature：</li>
<li>max_token:</li>
<li>max_retries:</li>
<li>timeout:</li>
</ul>
<p><strong>比较常用的Model 功能</strong></p>
<p><strong>思考模式打开</strong></p>
<pre><code class="hljs language-python" lang="python">reasoning = {
    <span class="hljs-string">"effort"</span>: <span class="hljs-string">"medium"</span>
}

reasoning_model = ChatOpenAI(
    model=<span class="hljs-string">"gpt-5.2"</span>,
    temperature=<span class="hljs-number">0.7</span>,
    reasoning=reasoning
)

<span class="hljs-keyword">for</span> chunk <span class="hljs-keyword">in</span> reasoning_model.stream(<span class="hljs-string">"大模型的原理"</span>):
    reasoning_steps = [r <span class="hljs-keyword">for</span> r <span class="hljs-keyword">in</span> chunk.content_blocks <span class="hljs-keyword">if</span> r[<span class="hljs-string">"type"</span>] == <span class="hljs-string">"reasoning"</span>]
    <span class="hljs-built_in">print</span>(reasoning_steps <span class="hljs-keyword">if</span> reasoning_steps <span class="hljs-keyword">else</span> chunk.text)
</code></pre>
<p><strong>结构化输出</strong></p>
<h3 data-id="heading-3">Message</h3>
<p>Message按照OpenAi的规范需要区分角色：</p>
<ul>
<li>developer: developer message的主要职责是</li>
</ul>

<ul>
<li>
<ul>
<li>系统的核心规则</li>
<li>系统的业务逻辑</li>
<li>工具的定义</li>
</ul>
</li>
</ul>

<ul>
<li>user：用户的输入和配置，用于</li>
<li>Assistant：大模型的输出</li>
</ul>
<p>developer以前是system，现在变成了developer，但是langchain或者其他智能体框架，都还沿用着system作为系统角色，OpenAi两者都兼容。</p>
<p>Langchain还新增了一个角色，Tool，工具消息用于将单个工具执行的结果传递回模型。工具可以直接生成 ToolMessage 对象。</p>
<pre><code class="hljs language-python" lang="python">messages = [
    SystemMessage(content=<span class="hljs-string">"你是一名资深的Python后端工程师面试官，负责考察候选人的技术能力。"</span>),
    HumanMessage(content=<span class="hljs-string">"请问什么是装饰器？"</span>),
    AIMessage(content=<span class="hljs-string">"装饰器是Python中用于修改函数或类行为的语法糖..."</span>),
    HumanMessage(content=<span class="hljs-string">"能举个实际应用的例子吗？"</span>)
]

<span class="hljs-comment"># </span>
<span class="hljs-comment"># messages = [</span>
<span class="hljs-comment">#     {"role": "system", "content": "你是一名资深的Python后端工程师面试官，负责考察候选人的技术能力。"}, # 对应SystemMessage</span>
<span class="hljs-comment">#     {"role": "user", "content": "请问什么是装饰器？"}, # 对应HumanMessage</span>
<span class="hljs-comment">#     {"role": "assistant", "content": "装饰器是Python中用于修改函数或类行为的语法糖..."}, # 对应AIMessage</span>
<span class="hljs-comment">#     {"role": "user", "content": "能举个实际应用的例子吗？"}</span>
<span class="hljs-comment"># ]</span>


response = llm.invoke(messages)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"📝 LLMChain 输出：\n<span class="hljs-subst">{response.content}</span>\n"</span>)
</code></pre>
<p>ToolMessage的使用方式</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">location: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""Get the weather at a location."""</span>
    <span class="hljs-comment"># 先获取城市ID</span>
    location_url = <span class="hljs-string">f"https://n53h2qt5jy.re.qweatherapi.com/geo/v2/city/lookup?location=<span class="hljs-subst">{location}</span>"</span>
    location_response = (requests.get(url=location_url,headers={<span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span>,<span class="hljs-string">"X-QW-Api-Key"</span>:  q_weather_api_key}).json())

    <span class="hljs-keyword">if</span> location_response[<span class="hljs-string">'code'</span>] != <span class="hljs-string">'200'</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"未找到城市：<span class="hljs-subst">{location}</span>"</span>

    location_id = location_response[<span class="hljs-string">'location'</span>][<span class="hljs-number">0</span>][<span class="hljs-string">'id'</span>]

    <span class="hljs-comment"># 查询天气</span>
    weather_url = <span class="hljs-string">f"https://n53h2qt5jy.re.qweatherapi.com/v7/weather/now?location=<span class="hljs-subst">{location_id}</span>"</span>
    weather_response = requests.get(url=weather_url, headers={<span class="hljs-string">"Content-Type"</span>: <span class="hljs-string">"application/json"</span>, <span class="hljs-string">"X-QW-Api-Key"</span>:  q_weather_api_key}).json()

    <span class="hljs-keyword">if</span> weather_response[<span class="hljs-string">'code'</span>] == <span class="hljs-string">'200'</span>:
        now = weather_response[<span class="hljs-string">'now'</span>]
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{location}</span>当前天气：<span class="hljs-subst">{now[<span class="hljs-string">'text'</span>]}</span>，温度<span class="hljs-subst">{now[<span class="hljs-string">'temp'</span>]}</span>°C，体感温度<span class="hljs-subst">{now[<span class="hljs-string">'feelsLike'</span>]}</span>°C"</span>

    <span class="hljs-keyword">return</span> <span class="hljs-string">"天气查询失败"</span>

model_with_tools = llm.bind_tools([get_weather])
response = model_with_tools.invoke(<span class="hljs-string">"What's the weather in 上海?"</span>)

<span class="hljs-keyword">for</span> tool_call <span class="hljs-keyword">in</span> response.tool_calls:
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Tool: <span class="hljs-subst">{tool_call[<span class="hljs-string">'name'</span>]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"Args: <span class="hljs-subst">{tool_call[<span class="hljs-string">'args'</span>]}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"ID: <span class="hljs-subst">{tool_call[<span class="hljs-string">'id'</span>]}</span>"</span>)

<span class="hljs-comment"># After a model makes a tool call</span>
<span class="hljs-comment"># (Here, we demonstrate manually creating the messages for brevity)</span>
ai_message = AIMessage(
    content=[],
    tool_calls=[{
        <span class="hljs-string">"name"</span>: <span class="hljs-string">"get_weather"</span>,
        <span class="hljs-string">"args"</span>: {<span class="hljs-string">"location"</span>: <span class="hljs-string">"上海"</span>},
        <span class="hljs-string">"id"</span>: <span class="hljs-string">"call_123"</span>
    }]
)

<span class="hljs-comment"># Execute tool and create result message</span>
tool_message = ToolMessage(
    content=get_weather(<span class="hljs-string">"上海"</span>),
    tool_call_id=<span class="hljs-string">"call_123"</span>  <span class="hljs-comment"># Must match the call ID</span>
)

<span class="hljs-comment"># Continue conversation</span>
messages = [
    HumanMessage(<span class="hljs-string">"上海天气如何?"</span>),
    ai_message,  <span class="hljs-comment"># Model's tool call</span>
    tool_message,  <span class="hljs-comment"># Tool execution result</span>
]
response = llm.invoke(messages)  <span class="hljs-comment"># Model processes the result</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"=================="</span>)
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"📝 LLMChain 输出：\n<span class="hljs-subst">{response.content}</span>\n"</span>)

<span class="hljs-built_in">print</span>(<span class="hljs-string">f"llm 元数据：<span class="hljs-subst">{response.usage_metadata}</span>"</span>)
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OpenCode 使用指南：从"小白入门"到"AI 编程效率翻倍"]]></title>    <link>https://juejin.cn/post/7599514071105683471</link>    <guid>https://juejin.cn/post/7599514071105683471</guid>    <pubDate>2026-01-26T15:17:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599514071105683471" data-draft-id="7599526246503727138" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OpenCode 使用指南：从&quot;小白入门&quot;到&quot;AI 编程效率翻倍&quot;"/> <meta itemprop="keywords" content="前端,后端,人工智能"/> <meta itemprop="datePublished" content="2026-01-26T15:17:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iDao技术魔方"/> <meta itemprop="url" content="https://juejin.cn/user/166781496080782"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OpenCode 使用指南：从"小白入门"到"AI 编程效率翻倍"
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/166781496080782/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iDao技术魔方
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T15:17:03.000Z" title="Mon Jan 26 2026 15:17:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">开篇</h2>
<p>腊月二十九，老赵刷到一个叫 OpenCode 的工具，GitHub 8 万+ stars，还是免费的。</p>
<p>老赵心想：又是哪个公司想割韭菜？免费的东西能好用？</p>
<p>抱着怀疑的态度，老赵花了半天折腾，结果——真香。</p>
<p>OpenCode 不是割韭菜工具，是一个能在终端用的开源 AI 编程助手，能写代码、改代码、查代码，还支持几十种 AI 模型。最骚的是，它还有个叫 Oh My OpenCode 的插件，装上后，OpenCode 从"单兵作战"变成了"团队协作"。</p>
<p>这篇文章从「安装配置 × 核心功能 × 实战场景」三视角拆解 OpenCode 的使用方法，帮你快速上手，看完能直接套用的开发工作流。</p>
<hr/>
<h2 data-id="heading-1">一、快速上手：三步从零到能跑</h2>
<h3 data-id="heading-2">技术原理</h3>
<p>OpenCode 是一个开源的 AI 编程助手，核心架构基于 TypeScript，支持多模态（终端、桌面、IDE 插件）。它的最大亮点是完全开源 + 多模型支持 + 可扩展的插件生态。</p>
<p><strong>三大核心特性</strong>：</p>
<ul>
<li><strong>多模型支持</strong>：OpenAI、Anthropic、Google、智谱 AI、MiniMax 等 75+ 种模型</li>
<li><strong>免费模型</strong>：OpenCode Zen 提供精选免费模型（GLM-4.7、MiniMax M2.1）</li>
<li><strong>智能体系统</strong>：内置 Build、Plan、General、Explore 四种专业智能体</li>
</ul>
<p><strong>数据说话</strong>：OpenCode 在 GitHub上有8万+ stars。相比 Claude Code，它完全免费且对国内用户友好（不限速、不封号）。</p>
<h3 data-id="heading-3">实操案例：安装与配置</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Step 1：安装 OpenCode（推荐使用官方脚本）</span>
curl -fsSL https://opencode.ai/install | bash

<span class="hljs-comment"># 或者使用 npm 安装</span>
npm install -g opencode-ai

<span class="hljs-comment"># Step 2：配置 AI 模型</span>
<span class="hljs-comment"># 方式一：使用 OpenCode Zen（推荐，有免费模型）</span>
opencode
<span class="hljs-comment"># 在 TUI 界面中选择 opencode，然后运行 /connect</span>

<span class="hljs-comment"># 方式二：使用自己的 API Key</span>
opencode
<span class="hljs-comment"># /connect</span>
<span class="hljs-comment"># 选择你的提供商（OpenAI、Anthropic、Google 等）</span>
<span class="hljs-comment"># 粘贴 API Key</span>

<span class="hljs-comment"># Step 3：初始化项目</span>
<span class="hljs-built_in">cd</span> /path/to/your/project
opencode
<span class="hljs-comment"># 运行 /init，让 OpenCode 分析项目结构</span>
</code></pre>
<p><strong>安装注意事项</strong>：</p>
<ul>
<li>Windows 用户：需要用 WSL（Windows Subsystem for Linux）或 Docker</li>
<li>macOS/Linux 用户：直接安装即可</li>
<li>需要准备 API Key（如果不用免费模型）</li>
</ul>
<h3 data-id="heading-4">落地步骤</h3>
<ol>
<li><strong>安装阶段</strong>：选择适合你系统的安装方式（脚本/npm/Homebrew）</li>
<li><strong>配置阶段</strong>：选择 AI 提供商，配置 API Key（或使用免费模型）</li>
<li><strong>初始化阶段</strong>：在项目目录运行 <code>/init</code>，让 OpenCode 生成 AGENTS.md 配置文件</li>
<li><strong>开发阶段</strong>：开始使用 OpenCode 进行日常开发工作</li>
</ol>
<h3 data-id="heading-5">避坑指南</h3>
<ul>
<li>❌ <strong>新手常犯</strong>：看到免费模型就只用免费，忽略付费模型的优势</li>
<li>✅ <strong>正确做法</strong>：先尝试免费模型，评估效果后再决定是否升级付费</li>
<li>⚠️ <strong>注意</strong>：OpenCode Zen 的免费模型有速率限制，高峰期可能较慢</li>
</ul>
<hr/>
<h2 data-id="heading-6">二、核心功能：四个智能体 + 四种模式</h2>
<h3 data-id="heading-7">技术原理</h3>
<p>OpenCode 的核心架构是「智能体系统（Agent System）」，通过不同的智能体处理不同的任务类型。它有两个级别的智能体：</p>
<p><strong>主智能体（Primary Agents）</strong>：你直接交互的主要助手</p>
<ul>
<li><strong>Build</strong>：默认主智能体，拥有所有工具权限（文件读写、bash 命令）</li>
<li><strong>Plan</strong>：受限智能体，禁用文件编辑和 bash 命令，用于分析和规划</li>
</ul>
<p><strong>子智能体（Subagents）</strong>：主智能体可以调用的专业助手</p>
<ul>
<li><strong>General</strong>：通用目的智能体，用于研究和多步骤任务</li>
<li><strong>Explore</strong>：只读智能体，用于快速探索代码库</li>
</ul>
<p><strong>四种模式</strong>：</p>
<ol>
<li><strong>Message Mode</strong>：标准对话模式，自然语言交互</li>
<li><strong>Handoff Mode</strong>：新引入的模式，主智能体将任务"移交给"子智能体</li>
<li><strong>Compress Mode</strong>：压缩模式，压缩对话历史</li>
<li><strong>Parallelize Mode</strong>：并行模式，分叉多个子智能体并行工作</li>
</ol>
<h3 data-id="heading-8">实操案例：智能体切换与协作</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 场景：你想添加一个新功能，但不确定如何实现</span>

<span class="hljs-comment"># Step 1：切换到 Plan 模式（按 Tab 键）</span>
&lt;TAB&gt;  <span class="hljs-comment"># 切换到 Plan 智能体</span>

<span class="hljs-comment"># Step 2：让 Plan 分析项目并提出方案</span>
<span class="hljs-string">"帮我分析一下这个 React 项目的代码结构，然后给出添加用户认证功能的建议"</span>

<span class="hljs-comment"># Plan 会返回详细的分析和实现建议，但不会修改任何文件</span>

<span class="hljs-comment"># Step 3：切换回 Build 模式（再按 Tab 键）</span>
&lt;TAB&gt;  <span class="hljs-comment"># 切换回 Build 智能体</span>

<span class="hljs-comment"># Step 4：让 Build 执行具体实现</span>
<span class="hljs-string">"按照你刚才给出的建议，实现用户认证功能"</span>

<span class="hljs-comment"># Build 会直接修改文件、添加代码、运行测试</span>

<span class="hljs-comment"># 使用子智能体（@ 调用）</span>
<span class="hljs-string">" @general 帮我搜索项目中所有与认证相关的文件"</span>
<span class="hljs-string">" @explore 找出所有使用 useEffect 的组件"</span>
</code></pre>
<h3 data-id="heading-9">落地步骤</h3>
<ol>
<li><strong>理解智能体分工</strong>：Build（执行）、Plan（规划）、General（通用）、Explore（探索）</li>
<li><strong>学会切换智能体</strong>：用 Tab 键在主智能体之间切换</li>
<li><strong>使用 @ 调用子智能体</strong>：在消息中用 <code>@</code> 前缀调用特定子智能体</li>
<li><strong>选择合适的模式</strong>：根据任务类型选择 Message/Handoff/Compress/Parallelize</li>
</ol>
<h3 data-id="heading-10">避坑指南</h3>
<ul>
<li>❌ <strong>新手常犯</strong>：所有任务都用 Build 模式，导致不必要的文件修改</li>
<li>✅ <strong>正确做法</strong>：规划和分析用 Plan，执行用 Build，探索用 Explore</li>
<li>⚠️ <strong>注意</strong>：子智能体会创建独立的会话，可以用快捷键在主会话和子会话之间导航</li>
</ul>
<hr/>
<h2 data-id="heading-11">三、实战场景：从"写 Bug"到"重构项目"</h2>
<h3 data-id="heading-12">技术原理</h3>
<p>OpenCode 的强大之处在于它能处理真实的项目开发场景，而不仅仅是代码补全。它有完整的项目索引能力，可以理解整个代码库的结构和上下文。</p>
<p><strong>核心工作流</strong>：</p>
<ol>
<li><strong>项目索引</strong>：<code>/init</code> 扫描项目，生成 AGENTS.md</li>
<li><strong>代码分析</strong>：理解现有代码结构、依赖关系、编码模式</li>
<li><strong>功能开发</strong>：根据自然语言描述生成代码、修改代码</li>
<li><strong>代码审查</strong>：自动检查代码质量、安全问题、性能隐患</li>
<li><strong>文档生成</strong>：为项目生成或更新文档</li>
</ol>
<h3 data-id="heading-13">实操案例 1：添加新功能（完整工作流）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 场景：为一个 Next.js 项目添加用户评论功能</span>

<span class="hljs-comment"># Step 1：让 Plan 智能体分析需求</span>
&lt;TAB&gt;  <span class="hljs-comment"># 切换到 Plan</span>
<span class="hljs-string">"为这个 Next.js 项目添加用户评论功能，需要：
1. 数据库表结构设计
2. API 路由实现
3. 前端组件开发
4. 评论与帖子的关联
请给出完整的实现方案，但不要修改任何文件。"</span>

<span class="hljs-comment"># Plan 会返回详细的实现建议，包括：</span>
<span class="hljs-comment"># - 数据库 schema（Prisma 或 SQL）</span>
<span class="hljs-comment"># - API 路由设计（REST 或 GraphQL）</span>
<span class="hljs-comment"># - React 组件结构</span>
<span class="hljs-comment"># - 集成方式</span>

<span class="hljs-comment"># Step 2：查看并确认方案</span>
<span class="hljs-string">"方案看起来很完整，但我想确认一下：用户评论需要嵌套回复吗？"</span>

<span class="hljs-comment"># Plan 会补充说明</span>

<span class="hljs-comment"># Step 3：切换到 Build 执行实现</span>
&lt;TAB&gt;  <span class="hljs-comment"># 切换到 Build</span>
<span class="hljs-string">"按照确认后的方案，实现用户评论功能。分步骤进行：
1. 先实现数据库迁移
2. 再创建 API 路由
3. 最后开发前端组件
每完成一步，告诉我，让我审查代码。"</span>

<span class="hljs-comment"># Build 会逐步实现，并在每步等待你的确认</span>

<span class="hljs-comment"># Step 4：代码审查</span>
<span class="hljs-string">"实现完成后，帮我审查一下代码，检查：
1. SQL 注入风险
2. XSS 防护
3. 性能问题
4. 代码规范"</span>
</code></pre>
<h3 data-id="heading-14">实操案例 2：调试和重构</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 场景：发现一个 Bug，需要定位和修复</span>

<span class="hljs-comment"># Step 1：用 Explore 智能体搜索相关代码</span>
&lt;TAB&gt;  <span class="hljs-comment"># 切换到 Plan 模式</span>
<span class="hljs-string">" @explore 找出所有与用户认证相关的文件，特别关注：
1. login 函数
2. auth 中间件
3. token 验证逻辑"</span>

<span class="hljs-comment"># Explore 会返回文件列表和关键代码片段</span>

<span class="hljs-comment"># Step 2：分析问题</span>
<span class="hljs-string">"根据找到的代码，分析可能导致登录失败的原因：
1. 异步处理不当
2. 错误处理缺失
3. token 过期检查有问题
请给出详细的根因分析和修复建议。"</span>

<span class="hljs-comment"># Step 3：执行修复</span>
&lt;TAB&gt;  <span class="hljs-comment"># 切换到 Build</span>
<span class="hljs-string">"按照你的分析，修复这个 Bug。重点关注：
1. 添加适当的错误处理
2. 完善 token 刷新逻辑
3. 添加日志记录便于调试"</span>

<span class="hljs-comment"># Step 4：验证修复</span>
<span class="hljs-string">"修复后，帮我检查一下是否还有其他潜在问题，特别是：
1. 并发登录场景
2. 记住我功能"</span>
</code></pre>
<h3 data-id="heading-15">落地步骤</h3>
<ol>
<li><strong>需求分析</strong>：用 Plan 模式先理解需求，不要急于上手就改代码</li>
<li><strong>代码搜索</strong>：用 Explore 模式快速定位相关文件和代码片段</li>
<li><strong>逐步实现</strong>：用 Build 模式分步实现，每步确认</li>
<li><strong>代码审查</strong>：每次完成后让 AI 审查，及时发现潜在问题</li>
</ol>
<h3 data-id="heading-16">避坑指南</h3>
<ul>
<li>❌ <strong>新手常犯</strong>：一次性让 AI 实现整个功能，不审查就上线</li>
<li>✅ <strong>正确做法</strong>：分步骤执行，每步确认后再继续，用 Plan 先规划</li>
<li>⚠️ <strong>注意</strong>：可以用 <code>/undo</code> 命令撤销 AI 的修改，不要怕改错</li>
</ul>
<hr/>
<h2 data-id="heading-17">四、Oh My OpenCode：从"助手"到"团队"</h2>
<h3 data-id="heading-18">技术原理</h3>
<p>Oh My OpenCode（简称 OMO）是 OpenCode 的增强插件，类似于 Oh My Zsh 对于 Zsh 的增强。它为 OpenCode 添加了更多强大功能：</p>
<p><strong>核心增强功能</strong>：</p>
<ul>
<li><strong>多 AI 模型协作</strong>：同时调用多个 AI 模型协同工作</li>
<li><strong>增强的智能体系统</strong>：frontend-ui-ux-engineer、oracle、librarian、document-writer 等专业智能体</li>
<li><strong>后台任务管理</strong>：可以并行执行多个任务，不阻塞主对话</li>
<li><strong>Skills 系统</strong>：可以创建自定义技能（Skills），封装常用工作流</li>
</ul>
<p><strong>安装 OMO 的好处</strong>：</p>
<ul>
<li>OpenCode 变成完整的 AI 开发团队</li>
<li>可以让不同的 AI 模型协作（比如一个写代码，一个审查，一个生成文档）</li>
<li>后台任务可以持续运行，不影响主对话</li>
</ul>
<h3 data-id="heading-19">实操案例：多模型协作</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 场景：开发一个 Vue 组件，同时需要代码审查和文档生成</span>

<span class="hljs-comment"># Step 1：安装 Oh My OpenCode（安装后自动启用）</span>
<span class="hljs-comment"># 访问 https://github.com/code-yeongyu/oh-my-opencode 按照文档安装</span>

<span class="hljs-comment"># Step 2：配置多个模型</span>
<span class="hljs-comment"># 在 opencode.json 中配置不同提供商的 API Keys</span>

{
  <span class="hljs-string">"provider"</span>: {
    <span class="hljs-string">"openai"</span>: {
      <span class="hljs-string">"apiKey"</span>: <span class="hljs-string">"sk-..."</span>
    },
    <span class="hljs-string">"anthropic"</span>: {
      <span class="hljs-string">"apiKey"</span>: <span class="hljs-string">"sk-ant-..."</span>
    }
  },
  <span class="hljs-string">"agent"</span>: {
    <span class="hljs-string">"coder"</span>: {
      <span class="hljs-string">"model"</span>: <span class="hljs-string">"openai/gpt-4"</span>,
      <span class="hljs-string">"description"</span>: <span class="hljs-string">"用 GPT-4 写代码"</span>
    },
    <span class="hljs-string">"reviewer"</span>: {
      <span class="hljs-string">"model"</span>: <span class="hljs-string">"anthropic/claude-sonnet-4"</span>,
      <span class="hljs-string">"description"</span>: <span class="hljs-string">"用 Claude Sonnet 审查代码"</span>
    },
    <span class="hljs-string">"doc-writer"</span>: {
      <span class="hljs-string">"model"</span>: <span class="hljs-string">"anthropic/claude-haiku-4"</span>,
      <span class="hljs-string">"description"</span>: <span class="hljs-string">"生成技术文档"</span>
    }
  }
}

<span class="hljs-comment"># Step 3：使用多模型协作</span>

<span class="hljs-comment"># 让 coder 写代码</span>
<span class="hljs-string">" @coder 为我写一个 Vue3 的用户列表组件，使用 TypeScript，包含以下功能：
1. 数据获取（使用 useQuery）
2. 分页
3. 搜索
4. 每行操作（编辑、删除）"</span>

<span class="hljs-comment"># 让 reviewer 审查代码</span>
<span class="hljs-string">" @reviewer 审查刚才写的组件，检查：
1. TypeScript 类型安全
2. Vue 3 最佳实践
3. 性能问题
4. 可访问性（a11y）"</span>

<span class="hljs-comment"># 让 doc-writer 生成文档</span>
<span class="hljs-string">" @doc-writer 为这个组件生成技术文档，包括：
1. Props 说明
2. 使用示例
3. API 参考链接
4. 注意事项"</span>

<span class="hljs-comment"># 三个智能体并行工作，你可以在不同会话中查看结果</span>
</code></pre>
<h3 data-id="heading-20">落地步骤</h3>
<ol>
<li><strong>安装 OMO</strong>：按照官方文档安装 Oh My OpenCode</li>
<li><strong>配置智能体</strong>：为不同的任务配置专门的智能体</li>
<li><strong>定义工作流</strong>：创建常用的工作流模板（Skills）</li>
<li><strong>多模型协作</strong>：充分利用不同 AI 模型的优势</li>
</ol>
<h3 data-id="heading-21">避坑指南</h3>
<ul>
<li>❌ <strong>新手常犯</strong>：所有任务都用同一个模型，忽略不同模型的专长</li>
<li>✅ <strong>正确做法</strong>：GPT-4 擅长代码生成，Claude 擅长推理和审查，合理分配任务</li>
<li>⚠️ <strong>注意</strong>：后台任务会增加 API 调用成本，注意监控用量</li>
</ul>
<hr/>
<h2 data-id="heading-22">结尾</h2>
<p>三个月后，老赵的同事问他："你最近写代码怎么这么快了？"</p>
<p>老赵笑了笑："因为我有了 AI 开发团队。"</p>
<p>OpenCode + Oh My OpenCode，就像给你的电脑装了个虚拟团队。你要做的，就是学会指挥这个团队，而不是自己一个人单打独斗。</p>
<p>以前写一个功能要半天，现在 30 分钟搞定。以前代码 Review 要等同事，现在 AI 帮你审查。以前写文档像挤牙膏，现在 AI 一键生成。</p>
<p>关键是——你愿意尝试吗？</p>
<p>OpenCode 不是魔法，但用好了，开发效率提升 2-3 倍是真实的。就像当年 Git 刚出来时，很多人觉得"太复杂没必要"，现在呢？</p>
<p>你在 OpenCode 的使用中有哪些困惑？配置问题、智能体选择、还是 Oh My OpenCode 的使用？评论区交流，我们一起讨论。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[实现一个文字擦除效果]]></title>    <link>https://juejin.cn/post/7599483314160959507</link>    <guid>https://juejin.cn/post/7599483314160959507</guid>    <pubDate>2026-01-26T15:19:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599483314160959507" data-draft-id="7558284340574421034" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="实现一个文字擦除效果"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-26T15:19:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="剪刀石头布啊"/> <meta itemprop="url" content="https://juejin.cn/user/1855631360014798"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            实现一个文字擦除效果
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1855631360014798/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    剪刀石头布啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T15:19:01.000Z" title="Mon Jan 26 2026 15:19:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>动画实际上就是一个视觉欺骗功能，一个前端如果不会视觉欺骗，那么针对很多效果将会手无足措，实际上学习动画的过程中，也能更好理解视觉欺骗，实际开发一些场景也会有更多实现方案</p>
<p>这里的擦除效果，就是利用视觉欺诈实现一个文字擦除效果(前面写到的进度条也有视觉欺骗在里面)</p>
<p>核心原理，就是在文本上方放置同样的一个文本内容，设置颜色将其盖住，通过css属性动画逐步放开遮挡区间，这样看起来就像是文本逐渐展示了(实现是不是和看起来效果有点不太一样，这就是视觉欺骗了)</p>
<h2 data-id="heading-1">实现</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> <span class="hljs-string">"./App.css"</span>;

<span class="hljs-comment">//基础文本</span>
<span class="hljs-keyword">const</span> text = <span class="hljs-string">`
“再也不能骂人了！”近日，一条以“骂人也违法了
最高可判三年”为关键词的话题登上热搜，迅速引发公众热议。这背后，是自2026年1月1日起正式施行的新修订《治安管理处罚法》，言语威胁、辱骂他人可能构成违法！公然辱骂他人或捏造事实，造成重伤或死亡的还涉嫌犯罪。请谨言慎行，莫因“口无遮拦”承担法律责任。
法律依据 《中华人民共和国治安管理处罚法》（2026），第五十条规定：
有下列行为之一的，处五日以下拘留或者一千元以下罚款；情节较重的，处五日以上十日以下拘留，可以并处一千元以下罚款：
（一）写恐吓信或者以其他方法威胁他人人身安全的；
（二）公然侮辱他人或者捏造事实诽谤他人的；
（三）捏造事实诬告陷害他人，企图使他人受到刑事追究或受到治安管理处罚的；
（四）对证人及其近亲属进行威胁、侮辱、殴打或者打击报复的；
（五）多次发送淫秽、侮辱、恐吓等信息或者采取滋扰、纠缠、跟踪等方法，干扰他人正常生活的；
（六）偷窥、偷拍、窃听、散布他人隐私的。
有前款第五项规定的滋扰、纠缠、跟踪行为的，除依照前款规定给予处罚外，经公安机关负责人批准，可以责令其一定期限内禁止接触被侵害人。对违反禁止接触规定的，处五日以上十日以下拘留，可以并处一千元以下罚款。
《中华人民共和国刑法》第二百四十六条：
以暴力或者其他方法公然侮辱他人或者捏造事实诽谤他人，情节严重的，处三年以下有期徒刑、拘役、管制或者剥夺政治权利。
`</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="hljs-comment">//使用两个一摸一样的文本效果，这样更好盖住</span>
    <span class="hljs-comment">//为了能重合使用绝对定位来处理</span>
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"App"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"box"</span>&gt;</span>
        {text}
      <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"box"</span>&gt;</span>
        //不适用匿名盒子，是为了更好操作该行盒
        <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"earser"</span>&gt;</span>{text}<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span></span>
  );
}
</code></pre>
<p>css实现，除了使用行盒子实现背景的逐行变化，这里借助css自定义属性，来实现动画(毕竟动画只能应用css内置属性，不能直接应用变量)</p>
<p>ps：当然使用 background-position属性，就不用自定义属性了，容我装一下哈😄</p>
<pre><code class="hljs language-js" lang="js">.<span class="hljs-property">App</span> {
  <span class="hljs-attr">margin</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attr">color</span>: black;
  <span class="hljs-attr">position</span>: relative;
  <span class="hljs-attr">display</span>: block;
  <span class="hljs-attr">color</span>: #<span class="hljs-number">000</span>;
}

.<span class="hljs-property">box</span> {
  <span class="hljs-attr">position</span>: absolute;
  <span class="hljs-attr">top</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attr">bottom</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attr">left</span>: <span class="hljs-number">0</span>;
  <span class="hljs-attr">right</span>: <span class="hljs-number">0</span>;
}

@property --per {
  <span class="hljs-attr">syntax</span>: <span class="hljs-string">'&lt;percentage&gt;'</span>;
  <span class="hljs-attr">inherits</span>: <span class="hljs-literal">false</span>;
  initial-<span class="hljs-attr">value</span>: <span class="hljs-number">5</span>%;
}

<span class="hljs-comment">//使用行盒子设置背景，才能达到我们想要的效果</span>
.<span class="hljs-property">earser</span> {
  --<span class="hljs-attr">per</span>: <span class="hljs-number">5</span>%;
  <span class="hljs-attr">color</span>: transparent;
  <span class="hljs-attr">background</span>: linear-<span class="hljs-title function_">gradient</span>(to right, transparent <span class="hljs-title function_">var</span>(--per), #fff <span class="hljs-title function_">calc</span>(<span class="hljs-title function_">var</span>(--per) + 100px));
  animation
  : earser 5s linear forwards;
}
<span class="hljs-comment">//关键帧动画</span>
@keyframes earser {
  to {
    --<span class="hljs-attr">per</span>: <span class="hljs-number">100</span>%;
  }
}
</code></pre>
<p>这是一个简易的部分擦除效果(gif懒得生成)</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/073d4b5d3c8b40268e57564343781e20~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ymq5YiA55-z5aS05biD5ZWK:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770045541&amp;x-signature=feeDe0pkawqQkdh2mbn8A1l0BkY%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">最后</h2>
<p>思考一下，如果文本区域存在一个背景图的话，那么这种遮盖方式可能就不行了，这种情况怎么实现文字擦除效果么，不妨思考一下</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[企业权限系统性方案探究]]></title>    <link>https://juejin.cn/post/7599551824547905562</link>    <guid>https://juejin.cn/post/7599551824547905562</guid>    <pubDate>2026-01-26T15:22:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599551824547905562" data-draft-id="7599565587152748570" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="企业权限系统性方案探究"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-26T15:22:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="uzong"/> <meta itemprop="url" content="https://juejin.cn/user/372082495985181"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            企业权限系统性方案探究
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/372082495985181/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    uzong
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T15:22:32.000Z" title="Mon Jan 26 2026 15:22:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{line-height:1.75;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;letter-spacing:2px;background-image:linear-gradient(90deg,rgba(50,0,0,.05) 3%,transparent 0),linear-gradient(1turn,rgba(50,0,0,.05) 3%,transparent 0);background-size:20px 20px;background-position:50%;word-break:break-word;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1{font-size:23px;margin-bottom:5px;font-weight:700;padding-left:10px;border-left:5px solid #773098}.markdown-body h2{font-size:19px;font-weight:700;padding-left:10px;border-left:5px solid #916dd5}.markdown-body h3{font-size:17px;font-weight:700;padding-left:10px;border-left:5px solid #d89cf6}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{font-size:14px;margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{display:block;max-width:100%;margin:1em 0;border-radius:6px;box-shadow:2px 4px 7px #999;user-select:none}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{padding:.2em .5em;font-weight:700;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-size:1em;color:#916dd5;word-break:break-word;overflow-x:auto;background-color:none;border-radius:2px}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;font-family:-apple-system-font,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei UI,Microsoft YaHei,Arial,sans-serif;font-weight:400;font-size:.9em;padding:16px 12px;margin:0;color:#333;word-break:normal;overflow-x:auto;background:#f8f8f8;scroll-behavior:smooth}.markdown-body a{text-decoration:none;color:#916dd5;font-weight:700;border-bottom:1px solid #916dd5}.markdown-body a:active,.markdown-body a:hover{color:#773098}.markdown-body table{display:inline-block!important;font-size:14px;width:auto;max-width:100%;overflow:auto;border:1px solid #916dd5;border-collapse:collapse}.markdown-body thead{background-color:#916dd5;color:#fff;text-align:left}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px;border:1px solid #916dd5}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #d89cf6;background-color:#f4eeff}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0;line-height:26px}.markdown-body ol,.markdown-body ul{padding-left:28px;list-style-type:circle}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body b,.markdown-body strong{color:#916dd5;font-weight:700}.markdown-body b:before,.markdown-body strong:before{content:"「"}.markdown-body b:after,.markdown-body strong:after{content:"」"}.markdown-body em,.markdown-body i{color:#916dd5}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><blockquote>
<p>作者：面汤放盐 || uzong</p>
</blockquote>
<h2 data-id="heading-0">1. 背景与意义</h2>
<p><strong>在数字化转型深入背景下，权限管理已从辅助功能升级为企业核心基础设施。传统模式因颗粒度粗、权限滥用、生命周期失控及系统割裂等问题，难以满足规模化与精细化管控需求，易引发安全与合规风险。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/115c5200e42a431e8c85f02962767ebc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770045751&amp;x-signature=xIfLlaeiO7a83LzWp68m3Cdk5j0%3D" alt="" loading="lazy"/></p>
<hr/>
<p><strong>本文旨在</strong> <strong>系统性、</strong> <strong>实操性、前瞻性地讨论企业级的权限建设，构建全维度、全⽣命周期的权限体系，应对数字化时代的安全挑战，为企业权限体系的⻓期演进提供⽅向。</strong></p>
<h2 data-id="heading-1">2. 企业管理数据难点</h2>
<p>企业管理数据面临诸多难点，<strong>主要表现为</strong>：权限模型与业务适配难、权限数据治理混乱、权限生命周期管理缺失、合规与审计压力大等。</p>
<p><strong>具体可归结为</strong>：适配难、数据乱、回收慢、留痕弱、审计难、集成散。<strong>因此，需要从</strong>统一权限模型、建立权限台账...等方向系统性推进</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e2f624c307840399dfbd9d2e798a494~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770045751&amp;x-signature=8%2F7belrUnkyWQ%2FQ7h4I2dZLmmEc%3D" alt="" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-2">3. 核心目标</h2>
<p><strong>安全性：</strong> 实现权限“最⼩化分配、动态适配、全程可追溯”，防范权限滥⽤、数据泄露、越权操作等</p>
<p>风险，满⾜合规审计要求 <strong>。</strong></p>
<p><strong>精细化：</strong> 覆盖功能、数据、字段、接⼝全维度权限，⽀持多维度颗粒度控制，适配企业复杂组织架</p>
<p>构与业务场景。</p>
<p><strong>可管控：</strong> 建⽴全⽣命周期权限管理机制，实现权限从初始化到回收的闭环管理，提升权限运营效</p>
<p>率。</p>
<p><strong>可扩展：</strong> ⽀持业务模块新增、组织架构调整、⽤户量级扩张。****</p>
<p><strong>智能化：</strong> 融合零信任理念，实现基于身份、环境、⾏为的动态授权，降低⼈⼯运营成本</p>
<h2 data-id="heading-3">4. 权限核心构成</h2>
<p>基于企业架构视⻆，拆解功能权限、数据权限、字段权限、接⼝ 权限四⼤核⼼类型，明确每种权限的定义、颗粒度、设计原则与管理模式。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5fdaf6efb7b945909e508b7b14b848a0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770045751&amp;x-signature=tJAI3IU6VUuw6R4VfE0Lm77F8jc%3D" alt="" loading="lazy"/></p>
<p>注：字段权限是数据权限在列维度上的具体体现</p>
<h3 data-id="heading-4">4.1. 功能权限</h3>
<p>功能权限的颗粒度直接决定管控精度，需结合企业业务复杂度、组织架构层级、风险等级设计分级颗粒</p>
<p>度，避免过粗导致权限滥⽤、过细增加管理成本。<strong>可以进一步细分：菜单、模块、按钮、操作。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee925986b06a41eb8da39cd803d2e741~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770045751&amp;x-signature=XEjRTCBb%2BBG1SL5cA4MWNFUowlk%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-5">4.2. 数据权限</h3>
<p><strong>数据权限是权限体系的核心层，通过精细化控制用户可访问的数据范围，确保“仅看所需”，有效防范核心数据泄露或篡改，保障数据安全、完整性与可用性。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a446b4f64b384c43925a799186b617e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770045751&amp;x-signature=9%2B6DmLaulqSd0JaXDtb0np0xD0Y%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-6">4.3. 字段与接口权限</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ee5484e8842c4a568d2b8a6809e7b82a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770045751&amp;x-signature=BshXD1va3833Cv9mtJfaPd3AxdA%3D" alt="" loading="lazy"/></p>
<p><strong>字段权限是权限体系的精细化管控层，通过字段级的脱敏、隐藏或只读控制，防止无关用户访问敏感信息（如身份证号、薪资等），在保障数据安全的同时，精准适配不同岗位的展示需求</strong></p>
<p><strong>接口权限是权限体系的边界层，用于控制“谁可以调用哪些接口”，防范非法访问与攻击，保障系统间及第三方集成的安全、合规与可控</strong></p>
<h3 data-id="heading-7">4.4. 四⼤权限的联动机制</h3>
<p><strong>功能、数据、字段与接口权限并非孤立，而是联动递进、协同管控的有机整体：功能权限是入口，数据与字段权限实现行级与列级的精准控制，接口权限保障系统边界安全，四者需在权限全生命周期中统一管理，确保策略一致、变更同步。</strong></p>
<h2 data-id="heading-8">5. 权限生命周期</h2>
<p>权限⽣命周期管理是指对权限从产⽣到消亡的全流程进⾏规范化管控，核⼼⽬标是实现权限“可管、可控、可追溯”，避免权限滥⽤、权限冗余、权限缺失等问题，保障权限体系的有序运营。</p>
<p><strong>权限初始化：体系构建基础，定义权限清单与⻆⾊。</strong></p>
<p><strong>权限申请：</strong> <strong>业务驱动，基于场景提交权限需求。</strong></p>
<p><strong>权限分配：</strong> <strong>标准化赋予，基于⻆⾊或规则批量分配。</strong></p>
<p><strong>权限授权：</strong> <strong>动态⽣效，⽀持静态与动态两种授权模式。</strong></p>
<p><strong>权限使⽤：</strong> <strong>⾏为管控，实时监控权限使⽤⾏为。</strong></p>
<p><strong>权限回收：闭环收尾，⽀持⾃动、⼿动、降级三种⽅式。</strong></p>
<p><strong>权限审计：合规监督，定期审计权限配置与使⽤情况。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84d950c0a3d240cf898398faf439af2b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770045751&amp;x-signature=S2GbHkOF8srv6%2B%2BHLzLhX8BFQmM%3D" alt="" loading="lazy"/></p>
<hr/>
<p><strong>严控权限申请与分配入口:</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c34b294358dc4ded9195ed635d47696d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770045751&amp;x-signature=kLlLSyE2ufG79veJY4V5O8OYAZg%3D" alt="" loading="lazy"/></p>
<p><strong>授权逻辑与行为管控:</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ace52469ce524b2ea02a4e997681afa0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770045751&amp;x-signature=SIfBzQhTBvyfRL7ouRIm3KvB9W8%3D" alt="" loading="lazy"/></p>
<p><strong>清理冗余与合规审计:</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/119278e58ded438fa5d20d866306301f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770045751&amp;x-signature=%2F2heik77whqU3ytyBZ7WJ3BJtZ0%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-9">6. <strong>企业级权限体系的落地实现：以 RBAC 为基础的多维权限融合</strong></h2>
<p><strong>RBAC 以“用户–角色–权限”实现集中授权，适用于组织清晰的场景；ABAC 基于多维属性（用户、资源、环境）动态授权，灵活精细但复杂度高；实践中企业多采用 RBAC 为主、ABAC 为辅的混合模型，按数据敏感度与业务需求灵活组合，实现安全与效率的平衡。</strong></p>
<hr/>
<p><strong>接下来我们分析一下普通的企业管理后台页面</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31dac5c41b28463e81cbc89826d74314~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770045751&amp;x-signature=Kmi9NckPqhKROdnENM9NzmflR%2Bg%3D" alt="" loading="lazy"/></p>
<p>⚠️ 有时候我们会将菜单和页面画等号，控制某个菜单约等于某个页面。 当然我们可以进一步将菜单和页面进一步细分。</p>
<p>大致对权限进行细分如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f04a3199d2f9466b98bd3505bca2a6a2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770045751&amp;x-signature=891cdOVOeuLZH3ODwqkn33uUIg8%3D" alt="" loading="lazy"/></p>





















<table><thead><tr><th>类型</th><th>描述</th></tr></thead><tbody><tr><td><strong>行级权限</strong></td><td>控制用户能看到哪些数据记录，数据记录的多少。例如：销售只能看到自己区域的客户数据；HR只能看到本部门员工信息</td></tr><tr><td><strong>列级权限</strong></td><td>控制用户能看到哪些字段。例如：普通员工看不到薪资字段，只有HR和财务可见</td></tr><tr><td>接口权限</td><td>控制后端接口的调用权限，防止越权操作，比如通过 postman 直接访问接口。例如：只有管理员才能调用 /api/deleteUser</td></tr></tbody></table>
<h3 data-id="heading-10">6.1. 功能权限设计</h3>
<p>RBAC是一套成熟的权限模型。在传统权限模型中，我们直接把权限赋予用户。而在RBAC中，增加了“角色”的概念，我们首先把权限赋予角色，再把角色赋予用户。这样，由于增加了角色，授权会更加灵活方便。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8aa0ff8d0b53427fb450013165ad7e71~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770045751&amp;x-signature=uQUVqwg0S8GNfSLsUY0sAWmgRvM%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-11">6.2. RBAC 权限管理</h3>
<p>基于 RBAC 的权限体系已经非常成熟，绝大多数公司可以直接讨论模型。现代权限体系基于RBAC（基于角色的访问控制）模型，通过“用户-角色-权限”的映射，实现权限的标准化管理与快速分配。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3cfcfd137f534712a973aa1fe7c85e7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770045751&amp;x-signature=s966aroN2y29z180D%2Blcus%2FTovQ%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-12">6.2.1. 基本权限模型</h4>
<p>RBAC(<code>Role-Based Access Control</code>)基于角色的权限控制。通过角色来管理用户的权限。即用户拥有角色，角色管理权限。构成 用户–角色–权限 的授权模型。在这种模型中通常设计为一对多</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/edec03a4ff6e46b7aa61df7288695bdc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770045751&amp;x-signature=8%2FSsrxml47MSeSwC3mztpCm4yxs%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-13">6.2.2. 用户组扩展</h4>
<p>角色可以理解为一定数量的权限的集合，权限的载体。<br/>
当用户的数量非常大时，要给系统每个用户逐一授权（授角色），是件非常烦琐的事情。这时，就需要给用户分组，每个用户组内有多个用户。除了可给用户授权外，还可以给用户组授权。<strong>这样一来，用户拥有的所有权限，就是用户个人拥有的权限与该用户所在用户组拥有的权限之和</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f593ecbe58294925ab9bc3733c33649e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770045751&amp;x-signature=db5irSZMPfuSa7FxoPo2ptXxQpc%3D" alt="" loading="lazy"/></p>
<h4 data-id="heading-14">6.2.3. 资源扩展</h4>
<p>在应用系统中，权限表现成什么？对功能模块的操作，对上传文件的删改，菜单的访问，甚至页面上某个按钮、某个图片的可见性控制，都可属于权限的范畴。有些权限设计，<strong>会把功能操作作为一类，而把文件、菜单、页面元素等作为另一类</strong>，这样构成用户-角色-权限-资源的授权模型。<strong>而在做数据表建模时，可把功能操作和资源统一管理，也就是都直接与权限表进行关联，这样可能更具便捷性和易扩展性</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9590083bfedd47cd9f63f335d78de56f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770045751&amp;x-signature=1vMGKQwD86Y7iwV1xyC%2FVhthd%2FI%3D" alt="" loading="lazy"/></p>
<hr/>
<p><strong>一个比较完整的 RBAC 模型算基本成型</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/911858b3749e45beb8426fa41b5d92df~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770045751&amp;x-signature=Xx5O69gXPM0bvfSfTTTqc9j6qMc%3D" alt="" loading="lazy"/></p>
<p><strong>基于RBAC的模型在实际应用中，会根据实际进行调整，</strong> <strong>比如引入各种"组"的概念，以及各种继承的概念。</strong></p>
<p><strong>目的是为了权限数据不膨胀、更好管控。</strong></p>
<hr/>
<h3 data-id="heading-15">6.3. 数据权限设计</h3>
<p>在实践中，常通过拦截器、AOP 或权限中间件对 SQL 进行动态改写，结合参数化查询确保安全性，实现低侵入的数据权限控制</p>
<p>数据权限模块的核心之中的一个就有SQL语句的高效解析处理，SQL处理指<strong>依据</strong>当前登录人信息及数据权限策略生成一个带有数据权限处理结果的SQL语句。所以这里对SQL语句的解析处理必需要求精确、准确。在开发阶段由开发者把 SQL 写入配置文件里，在执行阶段由数据权限取得该SQL进行分析处理（加上数据权限），这样就完成了SQL的组装处理</p>
<p>接下来举一个例子。先申明几个术语概念</p>
<ul>
<li><code>资源</code>：数据权限的控制对象，业务系统中的各种资源。比方订单单据、销售单等</li>
<li><code>主体</code>：用户、部门、角色等</li>
<li><code>条件规则</code>：用于检索数据的条件定义</li>
<li><code>数据规则</code>：用于【数据权限】的条件规则</li>
</ul>
<p>比如：针对数据权限的一个简单可视化</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18fa84def9bb4c21befa54a5b68284e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770045751&amp;x-signature=jbIXzWX%2BqgYzfG8Zpx0iqrp%2FV3Q%3D" alt="" loading="lazy"/></p>
<p><strong>应用示例：</strong></p>
<ul>
<li>订单，可以由本人查看</li>
<li>销售单，可以由本人或上级领导查看</li>
<li>销售单，销售人员可以查看自己的，销售经理只查看 销售金额大于100,000的。<br/>
我们能想到直接的方法，在访问数据的入口加入SQL Where条件来实现，组织sql语句</li>
</ul>

<pre><code class="hljs language-ini" lang="ini">where <span class="hljs-attr">UserID</span> = {CurrentUserID}
where <span class="hljs-attr">UserID</span> = {CurrentUserID}  or {CurrentUserID} in (上级领导)
where <span class="hljs-attr">UserID</span> = {CurrentUserID}  or ({CurrentUserID} in (销售经理)  and 销售金额 &gt; <span class="hljs-number">100000</span>)
</code></pre>
<p>通过对 sql 进行改写，保障查询范围符合权限要求。</p>
<h3 data-id="heading-16">6.4. 自定义 schema 方式</h3>
<pre><code class="hljs language-json" lang="json">    <span class="hljs-attr">"datarule"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"rules"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span>
            <span class="hljs-punctuation">{</span>
                <span class="hljs-attr">"objectcode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"22"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"propertycode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"22"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"op"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"startwith"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"1"</span>
            <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
            <span class="hljs-punctuation">{</span>
                <span class="hljs-attr">"objectcode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"21"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"propertycode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"code"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"op"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"startwith"</span><span class="hljs-punctuation">,</span>
                <span class="hljs-attr">"value"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"value"</span>
            <span class="hljs-punctuation">}</span>
        <span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"op"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"or"</span>
    <span class="hljs-punctuation">}</span>
</code></pre>
<p>可以通过解析一套自定义的 schema 来实现 SQL 的自定义解析，实现更加复杂的场景。</p>
<h3 data-id="heading-17">6.5. 字段权限</h3>
<p>如果说数据权限控制的是‘哪些行’（记录），字段权限控制的是‘哪些列’（属性），二者共同构成对数据表的二维精细管控。可以禁止指定用户/角色 对某些字段的访问。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/feab1d640d6345749334b70730c027ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770045751&amp;x-signature=cqko9ijCAf4fb6SQwrILEifFRs4%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-18">7. 企业业务权限管理（综合）</h2>
<p>如派拉软件提出的‘xBAC’（细粒度权限管理平台），支持 RBAC、ABAC 等多种模型融合，下图为综合案例：企业权限治理架构视图。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/83c79b5e056c4b018d772656cad4ae7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770045751&amp;x-signature=HFxqE3WJkrAHJM4huXn7Ie5KdzI%3D" alt="" loading="lazy"/></p>
<p>这类平台的核心逻辑正是前文所述的‘RBAC 为主、ABAC 为辅’的混合模型，同时叠加了更细粒度的场景化管控能力。</p>
<h2 data-id="heading-19">8. 总结和展望</h2>
<p>企业级权限体系需以“合规为底线、安全为核⼼、业务为导向、效率为⽬标”，构建管控框架，覆盖全⽣命周期，实现标准化、精细化管控，平衡安全防护与业务发展需求。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/49bad8cc3c1a4b5584594b13abadab77~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770045751&amp;x-signature=sUuGPZ8BYdP7GySV3AmNA1G19C8%3D" alt="" loading="lazy"/></p>
<p><strong>企业级权限体系应以“合规为底线、安全为核心、业务为导向、效率为目标”，构建覆盖功能、数据、接口与操作的四维全生命周期管控框架。</strong></p>
<p><strong>未来将向智能化、轻量化、全场景化演进：依托AI与大数据实现权限智能推荐、风险主动防控与运维自治；结合隐私计算技术（如联邦学习、安全多方计算），探索“数据可用不可见”的协同访问模式，强化敏感数据脱敏、审计与合规能力。</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f07130983b8f419e99bed28d2b0a5ade~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdXpvbmc=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770045751&amp;x-signature=vgNqtxAefNEn8wegWncKCwUaQtw%3D" alt="" loading="lazy"/></p>
<p><strong>企业级权限体系的建设与优化是⼀项⻓期持续的⼯作，需紧跟技术趋势与业务需求，不断迭代升级，才能为企业核⼼资产安全、业务合规⾼效开展提供坚实保障。</strong></p>
<h2 data-id="heading-20">9. 资料引用</h2>





























<table><thead><tr><th>描述</th><th>链接</th></tr></thead><tbody><tr><td>业权一体化白皮书</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.digitalelite.cn%2Fh-nd-4966.html" target="_blank" title="https://www.digitalelite.cn/h-nd-4966.html" ref="nofollow noopener noreferrer">www.digitalelite.cn/h-nd-4966.h…</a></td></tr><tr><td>万字长文：深入浅出RBAC权限设计</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.woshipm.com%2Fpd%2F5576757.html" target="_blank" title="https://www.woshipm.com/pd/5576757.html" ref="nofollow noopener noreferrer">www.woshipm.com/pd/5576757.…</a></td></tr><tr><td>RBAC 权限管理</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fqq_31156277%2Farticle%2Fdetails%2F81072833" target="_blank" title="https://blog.csdn.net/qq_31156277/article/details/81072833" ref="nofollow noopener noreferrer">blog.csdn.net/qq_31156277…</a></td></tr><tr><td>细粒度权限管理xBAC</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.paraview.cn%2Fidentity%2Fshow%2F37" target="_blank" title="https://www.paraview.cn/identity/show/37" ref="nofollow noopener noreferrer">www.paraview.cn/identity/sh…</a></td></tr><tr><td>2024云原生身份云 IDaaS 技术发展与应用白皮书</td><td><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.dtinsight.com.cn%2Fnd.jsp%3Fid%3D2761" target="_blank" title="https://www.dtinsight.com.cn/nd.jsp?id=2761" ref="nofollow noopener noreferrer">www.dtinsight.com.cn/nd.jsp?id=2…</a></td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别修图软件的图层噩梦，腾讯混元3.0让AI学会了“思考”]]></title>    <link>https://juejin.cn/post/7599502282602299455</link>    <guid>https://juejin.cn/post/7599502282602299455</guid>    <pubDate>2026-01-26T15:31:29.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599502282602299455" data-draft-id="7599511763987578934" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别修图软件的图层噩梦，腾讯混元3.0让AI学会了“思考”"/> <meta itemprop="keywords" content="AIGC"/> <meta itemprop="datePublished" content="2026-01-26T15:31:29.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="墨风如雪"/> <meta itemprop="url" content="https://juejin.cn/user/4064249017803927"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别修图软件的图层噩梦，腾讯混元3.0让AI学会了“思考”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4064249017803927/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    墨风如雪
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T15:31:29.000Z" title="Mon Jan 26 2026 15:31:29 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>说实话，过去几年的AI修图体验，常常让人哭笑不得。</p>
<p>你扔给AI一张照片，说“把背景里的路人去掉”，结果它可能把主角的脸也换了一张，或者背景直接变成了一团难以名状的模糊色块。这就是传统AI的通病：听不懂人话，更不懂画面逻辑。</p>
<p>但在2026年1月26日，腾讯混元团队甩出了一张王炸——混元图像3.0图生图模型（HunyuanImage 3.0-Instruct）。这次更新，可能真的要让那些复杂的修图软件吃灰了。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2F640-1-1-1024x576.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/640-1-1-1024x576.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/156ea763d1ab41a7b30221e885809bf7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770046289&amp;x-signature=PvZ%2FG639%2FwwNqZlCKRHYFiPwRY0%3D" alt="640 (1)" loading="lazy"/></a></p>
<h3 data-id="heading-0">它不再是瞎蒙，而是学会了“谋定而后动”</h3>
<p>这个模型最吓人的地方，不在于它生成的画质有多好（虽然确实很好），而在于引入了一种类似大语言模型的“思维链”机制。</p>
<p>简单来说，当你下达指令时，之前的AI是“听到命令直接动手”，而混元3.0是“先看图，再理解命令，然后在大脑里规划步骤，最后才动手”。</p>
<p>比如你给它一张风景照，说“把画面改成赛博朋克风格，但不要动那棵老树”。混元3.0会先进行感知分析，识别出“整体风格”需要变，但“老树”这个区域必须锁死。它在内部生成了一套详细的执行策略，明确了改哪里、保哪里。</p>
<p>这种“先思考，后执行”的逻辑，直接解决了AI修图最大的痛点：<strong>精准度</strong>。它能确保你在修改画面一部分时，其他不需要动的地方保持原汁原味，不会出现那种“修了个寂寞”或者“改得面目全非”的尴尬。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2F640-2-1-1024x576.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/640-2-1-1024x576.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a24d8abe84f4fb5a3b4ae625443b381~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770046289&amp;x-signature=TqJ2jF1S9dzKqy2EHdqrC2P4kh8%3D" alt="640 (2)" loading="lazy"/></a></p>
<h3 data-id="heading-1">800亿参数的“肌肉”与精打细算的架构</h3>
<p>在硬核参数上，腾讯这次也是下了血本。</p>
<p>这是一个拥有800亿（80B）总参数量的庞然大物。但作为技术观察者，我更感兴趣的是它的架构——混合专家模型（MoE）。</p>
<p>这意味着什么？意味着虽然它脑容量巨大，但它不会每次干活都把所有脑细胞调动起来。它在运行时只激活约130亿（13B）参数。这就好比一个拥有80个顶级专家的团队，遇到具体问题时，只派最懂行的那13个人出马。既保证了处理复杂任务的能力，又极大地提高了推理效率。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2F640-3-1024x576.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/640-3-1024x576.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a170340aeab462ab09b918ec0568db3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770046289&amp;x-signature=OVLtOw7%2B9izar7WxgkaxyFpprzs%3D" alt="640 (3)" loading="lazy"/></a></p>
<h3 data-id="heading-2">从“P图”进化到“创作”</h3>
<p>具体能干什么？如果你是做内容的，这简直是生产力解放。</p>
<p>首先是<strong>精细化编辑</strong>。不管是增删物体、老照片修复、人物换装，还是把一张平平无奇的照片瞬间变成水墨画，也就是一句话的事。甚至连图片里的文字都能改，这在以前往往需要专业设计师花不少时间。</p>
<p>其次是<strong>多图融合</strong>。这个功能非常惊艳。你可以把几张不同照片扔进去，让它提取其中的人物或元素，然后自然地融合在一张新图里。不是那种生硬的拼贴，而是光影、透视都完全协调的重新生成。想和二次元角色合影？或者把产品图完美融入特定的风景背景？它都能搞定。</p>
<h3 data-id="heading-3">背后的技术护城河</h3>
<p>为了训练这个“大脑”，腾讯构建了一个覆盖80多种细分任务、千万级别的专用数据集。更关键的是，他们采用了一种自研的MixGRPO算法。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.worldcodeing.com%2Fwp-content%2Fuploads%2F2026%2F01%2F640-4-1024x576.webp" target="_blank" title="https://blog.worldcodeing.com/wp-content/uploads/2026/01/640-4-1024x576.webp" ref="nofollow noopener noreferrer"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/31e4ec29444849648e3813d1081f93d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aKo6aOO5aaC6Zuq:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770046289&amp;x-signature=iUq1lNMs5cpt7PE3UYMyXVvjGkw%3D" alt="640" loading="lazy"/></a></p>
<p>这个算法的作用，就是为了解决“听话”和“保真”之间的矛盾。它通过强化学习，不断纠正模型的行为，确保输出结果既符合你的修改意图，又不会破坏原图的和谐感。这就像是给AI请了一个严格的导师，时刻盯着它的作业，一旦画歪了立刻纠正。</p>
<h3 data-id="heading-4">写在最后</h3>
<p>目前，这个模型已经在腾讯的AI助手“元宝”全端和混元官网上线了。</p>
<p>如果你受够了在修图软件里为了抠图抠半天，或者为了调一个色调反复拉曲线，不妨去试试这个新家伙。在这个AI技术狂飙突进的时代，工具的进化不仅仅是为了偷懒，更是为了让我们把有限的精力，从繁琐的操作中解放出来，投入到更有价值的创意构思中去。</p>
<p>毕竟，让AI学会思考，是为了让我们更好地创造。</p>
<p><strong>如果你也对最新的AI信息感兴趣或者有疑问 都可以加入我的大家庭 第一时间分享最新AI资讯、工具、教程、文档 欢迎你的加入！！！😉😉😉</strong></p>
<p>公众号：墨风如雪小站</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[当32岁程序员离世后,他的HR同事说：“死在岗位上不遗憾”]]></title>    <link>https://juejin.cn/post/7599514071105929231</link>    <guid>https://juejin.cn/post/7599514071105929231</guid>    <pubDate>2026-01-26T15:32:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599514071105929231" data-draft-id="7599506068047560704" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="当32岁程序员离世后,他的HR同事说：“死在岗位上不遗憾”"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-26T15:32:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="修己xj"/> <meta itemprop="url" content="https://juejin.cn/user/2641475936724142"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            当32岁程序员离世后,他的HR同事说：“死在岗位上不遗憾”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2641475936724142/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    修己xj
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T15:32:24.000Z" title="Mon Jan 26 2026 15:32:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>写完《别用命换工作：一位32岁程序员周末晕倒后猝死留给我们的生存思考》时，我以为高广辉的故事已经完整——一个年轻的生命在周末倒下，心脏停跳后，工作群的消息仍在冰冷地闪烁。</p>
<p>但我没有料到，这个故事背后，还有一段更令人心寒的独白。</p>
<p>在高广辉离开后，他公司的HR这样说道：</p>
<p><strong>“如果我死在自己热爱的岗位上，我不会有遗憾，也不希望我的家属拿着我的遗体去换钱。”</strong></p>
<p>这句话，像一记无声的钟，在空气中久久回响。它揭开了一层遮羞布，让我们不得不直视这个时代某些令人窒息的真相——<strong>畸形的职场文化</strong>，与<strong>资本冰冷的本质</strong>。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/654329eef9ea45509ad92687218706c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770046345&amp;x-signature=4WhXOcaKPsSVe2GeAKNOr05ndjY%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">💻 公司是分布式系统，家庭却是单点服务</h2>
<p>程序员都理解高可用架构：系统中任何一个节点出现故障，都应能自动切换，确保业务永续。在职场上，我们每个人就是这样的“节点”。</p>
<p>公司是一台精密的分布式系统。你离开了，故障转移机制立即启动：招聘新节点、重新分配负载、系统继续运转。你的邮箱签名会被更新，工位会被清空，你写过的代码会被重构甚至覆盖。</p>
<p>然而在家庭这个“单点系统”里，你是无可替代的核心服务。没有备份，没有集群，一旦宕机，就是永久性的崩溃。</p>
<p>你是父母唯一的孩子，是爱人唯一的伴侣，是孩子唯一的依靠。这个系统没有弹性伸缩，没有灾备方案。</p>
<p><strong>公司离开谁都能转，可你的家庭不能。</strong></p>
<h2 data-id="heading-1">📉 最糟糕的“人生算法”：用不可再生的健康，换可替代的产出</h2>
<p>在计算机科学中，我们追求极致优化：更快、更高并发、更低延迟。然而在生活中，我们却常常陷入一场致命的算法错配：</p>
<p><strong>拿最不可再生的资源——健康与时间，去交换最可被替代的东西——工作产出。</strong></p>
<p>工作可以是使命、是热爱、是实现价值的路径，但它不该是生命的全部，更不该是人生的终点。</p>
<h2 data-id="heading-2">🍚 人生本可以很简单：不过一日三餐，一夜一床</h2>
<p>在代码世界里，我们追逐无限优化；而在真实的生活里，人的需求其实简单得令人清醒：</p>
<ul>
<li>每天不过三顿饭，未必需要珍馐美馔</li>
<li>每夜不过一张床，未必需要广厦万间</li>
<li>身边有爱的人，彼此温暖，未必需要完美无瑕</li>
</ul>
<p>我们被卷进一场没有终点的竞赛，却忘了生活原本的面貌，可以朴素而丰盈。</p>
<h2 data-id="heading-3">⚖️ 重新定义“热爱”：岗位之外，还有人间</h2>
<p>真正值得热爱的，是清晨照进窗棂的阳光，是孩子扑向你时的笑声，是父母电话里琐碎的叮咛，是爱人手心熟悉的温度，是与老友相聚时的畅怀，也是独自一人时内心的安宁。</p>
<p>工作可以是你表达热爱的一种方式，但绝不应成为热爱的全部对象。</p>
<h2 data-id="heading-4">❗公司仍在调度，但餐桌永远空了一个座位</h2>
<p>高广辉走了，工作群的消息依旧闪烁。这个残酷的画面提醒我们：公司不会为任何一个节点哀悼，它只会冷静地重新调度。</p>
<p>但他的家庭呢？那张永远空出一个位置的餐桌，那张再也不会有人躺卧的床，那些再也得不到回应的呼唤——这些，是任何技术都无法重构的损失。</p>
<h2 data-id="heading-5">📝最后，想说</h2>
<p>那位HR的话依然刺耳，但我想用另一段话作为回应：</p>
<p><strong>“如果我能在深爱的家人身旁离开，我不会遗憾。也不希望我的墓碑上，只刻着我在公司的工号。”</strong></p>
<p>因为生命的价值，从来不是由在岗位上燃烧的程度决定的，而是由我们在爱中给予和获得的温暖衡量的。</p>
<p>而这温暖——从不计入KPI，却是每个人活过一场最真实的明证。</p>
<p><strong>我们或许无法立刻改变系统，但我们可以先清醒地活着。</strong></p>
<p>在资本冰冷的逻辑与畸形的工作文化之外，别忘了：你的人生，始终该由你自己定义。<br/>
简单一点，真实一点，温暖一点。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc2c07cea4494873bac169192092849e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5L-u5bexeGo=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770046345&amp;x-signature=D5g5H5%2BJzeEEpGAyD7ab1PxEC5k%3D" alt="" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[曾经最坚持手写代码的顶级黑客，被AI彻底收编了]]></title>    <link>https://juejin.cn/post/7599511763986563126</link>    <guid>https://juejin.cn/post/7599511763986563126</guid>    <pubDate>2026-01-26T11:06:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599511763986563126" data-draft-id="7599483794657148969" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="曾经最坚持手写代码的顶级黑客，被AI彻底收编了"/> <meta itemprop="keywords" content="AI编程,人工智能"/> <meta itemprop="datePublished" content="2026-01-26T11:06:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="童欧巴"/> <meta itemprop="url" content="https://juejin.cn/user/3491704662669469"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            曾经最坚持手写代码的顶级黑客，被AI彻底收编了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3491704662669469/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    童欧巴
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T11:06:00.000Z" title="Mon Jan 26 2026 11:06:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="" data-highlight-key="github-gist">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#fff;color:#333}.hljs-comment,.hljs-meta{color:#969896}.hljs-emphasis,.hljs-quote,.hljs-strong,.hljs-template-variable,.hljs-variable{color:#df5000}.hljs-keyword,.hljs-selector-tag,.hljs-type{color:#d73a49}.hljs-attribute,.hljs-bullet,.hljs-literal,.hljs-symbol{color:#0086b3}.hljs-name,.hljs-section{color:#63a35c}.hljs-tag{color:#333}.hljs-attr,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-id,.hljs-selector-pseudo,.hljs-title{color:#6f42c1}.hljs-addition{color:#55a532;background-color:#eaffea}.hljs-deletion{color:#bd2c00;background-color:#ffecec}.hljs-link{text-decoration:underline}.hljs-number{color:#005cc5}.hljs-string{color:#032f62}</style><p>最近读了一篇博客，看完后我盯着屏幕发了很久的呆。</p>
<p>作者是 Redis 之父 Salvatore Sanfilippo，网名 Antirez。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f97987a0fd045ef97f6d2e4df9ed958~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56ul5qyn5be0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770046740&amp;x-signature=JyLt1U0zcDq%2BT7PSi75KLECGOds%3D" alt="" loading="lazy"/></p>
<p>如果你不写代码，可能没听过这个名字，但他创造的 Redis 是整个互联网的基建。</p>
<p>你刷的每一条热搜，抢的每一个红包，点的每一个赞，背后几乎都有它的影子。</p>
<p>在我们程序员眼里，Antirez 除了是一位技术大神，更是一位纯粹且带着浪漫主义色彩的黑客。</p>
<p>2020 年，他在 Redis 的巅峰期突然宣布辞职。</p>
<p>理由酷得不行，他不想做一个每天开会协调，审查代码的管理者。</p>
<p>他想回去当一个写小说的，自由自在的艺术家。</p>
<p>但这几年，这位曾为了找回人性而逃离的顶级匠人，却因为 AI 重新杀回了代码世界。</p>
<p>他发现 AI 帮他接手了那些最消磨人的重复性劳动。</p>
<p>让他能再次像个诗人一样，直接把脑子里的灵感变成现实。</p>
<p>就是这样一位曾经最坚持手写代码的大佬，现在却平静地告诉大家。</p>
<p>除了图个乐呵，自己手写代码已经没啥意义了。</p>
<p>如果你也曾为未来感到焦虑，请务必读读这位顶级黑客的自述。</p>
<p>我将原文进行了翻译和润色，耐心读完，这也许会改变你对 AI 的认知。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4916ace9f6ee40a9945e559e3c6e2f98~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56ul5qyn5be0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770046740&amp;x-signature=HxCOV8gMb7KqbNPsukzKvUTI3X8%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">1</h2>
<p>我这辈子就爱写代码，一行一行地敲。</p>
<p>可以说，我职业生涯的全部努力，就是为了把软件写得精美精简。</p>
<p><strong>让代码透着一股人味儿，这才是它最核心的特质。</strong></p>
<p>同时，我也希望社会能多关注那些底层的人。</p>
<p>说实话，我根本不在乎 AI 公司能不能挣大钱，我甚至不在乎现有的经济体系会不会被掀翻。</p>
<p>真的，如果财富能大规模重新分配，我做梦都能笑醒。</p>
<p>但是，我不能为了情怀就蒙蔽了双眼。</p>
<p><strong>事实就是事实，AI 已经彻底改变了编程。</strong></p>
<p>2020 年的时候，我辞职去写小说，写 AI，写一个社会在面对自动化浪潮时的各种纠结。</p>
<p>2024 年底，我开了个 YouTube 频道，专门聊 AI 怎么写代码，聊它的社会影响。</p>
<p>虽然我预判得很早，但我以前总觉得，编程被彻底重塑怎么也得再等几年。</p>
<h2 data-id="heading-1">2</h2>
<p>现在我不这么想了。</p>
<p>最近这些顶尖的 AI 模型，只要你把需求点说到位。</p>
<p>它们基本能独立搞定大型任务或中型项目，完全不用人一直盯着。</p>
<p>这活儿干得好不好，取决于你写的代码类型。</p>
<p>越是逻辑解耦，越好用文字描述的就越好，比如系统级开发就很适合。</p>
<p>也取决于，你能不能把脑子里的逻辑清晰地传达给 AI。</p>
<p>但总的来说，现在形势已经很清楚了。</p>
<p><strong>对于大多数项目，除了为了图个乐呵，自己手写代码已经没啥意义了。</strong></p>
<p>就拿上周来说，我光靠写提示词，偶尔盯一眼，给点方向，几个小时就搞定了下面这四件事。</p>
<p>这要是搁以前，得干好几周。</p>
<ul>
<li>
<p>我给我的 linenoise 库加了 UTF-8 支持，还搞了个测试框架，用模拟终端来检测每个字符单元格的显示情况。这事儿我早就想干了，但以前总觉得为了个业余项目花这么多精力不划算。可现在，你只要动动嘴皮子把想法说出来，代码就直接成型了，这感觉完全不同。</p>
</li>
<li>
<p>我修了 Redis 测试里几个顽固的随机报错，这种活儿最恶心，全是些时序，TCP 死锁之类的事情。Claude Code 就在那儿不停地跑复现，翻看进程状态找原因，最后直接把 Bug 给修了。</p>
</li>
<li>
<p>昨天我想要一个纯 C 语言的库来跑类 BERT 模型的推理，Claude Code 五分钟就写完了。跑起来跟 PyTorch 一样稳，速度也就慢了 15%。整整 700 行代码，顺带还写了个 Python 工具来转换模型。</p>
</li>
<li>
<p>前几周我改了 Redis Streams 的底层逻辑，我手头有一份设计文档，我试着把它丢给 Claude Code，好家伙，它不到 20 分钟就把我干的活重做了一遍。甚至比我还快，主要是我看代码，点授权点得太慢了。</p>
</li>
</ul>
<h2 data-id="heading-2">3</h2>
<p>这就是现实，避无可避。</p>
<p>写代码这事儿，大部分时候已经不是刚需了。</p>
<p><strong>现在更有意思的是去琢磨，要做什么，和怎么做。</strong></p>
<p>而在怎么做这一点上，AI 也是个顶尖的拍档。</p>
<p>AI 公司能不能回本，股市会不会崩，长远看都不叫事儿。</p>
<p>某个独角兽公司的 CEO 说话是否靠谱，也无所谓。</p>
<p>编程这行，反正已经永远变样了。</p>
<p>你要问我，我写的代码被喂给了 AI，我心里膈应吗？</p>
<p>我觉得挺好的。</p>
<p><strong>我这辈子都在折腾代码，系统和知识的平权，AI 不过是这种理想的延续。</strong></p>
<p>它能帮我们写出更快更好的软件，让小团队也有底气跟大厂叫板，就像 90 年代的开源运动一样。</p>
<p>不过，这么关键的技术不能只攥在几家公司手里。</p>
<p>虽然现在闭源模型厉害点，但开源社区，尤其是中国的模型追得非常紧。</p>
<p>到目前为止，这种民主化做得还行，但我担心这种局面能不能长久。</p>
<p>不过话说回来，大规模神经网络确实能出奇迹，而且这里面并没有什么深不可测的魔法。</p>
<p>不然没法解释，为什么那几家巨头的模型水平能咬得这么死。</p>
<h2 data-id="heading-3">4</h2>
<p>作为一个程序员，我现在比以前更想搞开源了。</p>
<p>我想把那些因为没时间，而放弃了的项目捡起来。</p>
<p>我想把 AI 塞进我的 Redis 工作流，改进向量集合的实现，完善别的数据结构。</p>
<p>但，我确实为那些可能丢掉饭碗的伙计们感到焦虑。</p>
<p>未来究竟会如何，还未可知。</p>
<p>公司是会因为效率高了而招更多人去做大蛋糕，还是会为了省钱把程序员全裁了，只留几个会写提示词的？</p>
<p>我怕在很多领域，人类会变得完全多余，那社会该怎么办？</p>
<p>创新这玩意儿，是开弓没有回头箭的。</p>
<p>但我还是挺期待 AI 带来的好的一面，比如科学上的新进展，能帮人类少受点苦。</p>
<h2 data-id="heading-4">尾声</h2>
<p>行了，说回编程。</p>
<p>朋友，我就一个建议。</p>
<p><strong>不管你觉得理想的世界应该是啥样，你都没法通过拒绝现实去改变它。</strong></p>
<p><strong>死撑着不用 AI，对你的职业生涯一点好处都没有。</strong></p>
<p>动动脑子，认真试一下这些新工具。</p>
<p>多花几周去沉浸式体验，<strong>别试个五分钟就忙着给自己原有的偏见找补</strong>。</p>
<p>你要想办法让自己，<strong>一个人活成一支队伍</strong>。</p>
<p>如果现在觉得不好用，过几个月再试试。</p>
<p>你可能觉得，自己辛辛苦苦学了这么久编程，结果现在机器全代劳了。</p>
<p>但你想想，当年你熬夜写代码，看着项目跑通时，你心里那团火到底是因为什么？</p>
<p><strong>是因为，创造。</strong></p>
<p>现在，如果你能玩转 AI，你能构建出更多，更牛的东西。</p>
<p>那种乐趣，一点都没变。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OoderAgent V0.6.5 Nexus 重磅发布：开启超级智能体开发框架新纪元]]></title>    <link>https://juejin.cn/post/7599496293174853651</link>    <guid>https://juejin.cn/post/7599496293174853651</guid>    <pubDate>2026-01-26T16:00:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599496293174853651" data-draft-id="7599483794657951785" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OoderAgent V0.6.5 Nexus 重磅发布：开启超级智能体开发框架新纪元"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-26T16:00:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="OneCodeCN"/> <meta itemprop="url" content="https://juejin.cn/user/1427583415622366"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OoderAgent V0.6.5 Nexus 重磅发布：开启超级智能体开发框架新纪元
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1427583415622366/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    OneCodeCN
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T16:00:45.000Z" title="Mon Jan 26 2026 16:00:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读29分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言：</h2>
<pre><code class="hljs">  v0.6.5 使用了一个特别的代号，Nexus（枢纽）她不再是一次简单的技术升级。而是一次重生。cong 从0.6.2到0.6.5我们在AI的驱动先快速的迭代，从从基础架构到核心升级，再到技能统一提升，直到0.6.5 一次质的跃迁。本次版本以“构建个人超级终端、赋能全场景智能开发”为核心，重构技术架构、强化能力体系、拓展生态边界，为开发者提供一套从设备协同到AI能力编排的全链路智能体开发解决方案，标志着SuperAgent向“去中心化超级智能体底座”迈出关键一步。
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11bd9efb4a774d59a1b9021c4e8c92a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770048055&amp;x-signature=KdRJ0kY9y4de%2BogEtCW364qZATo%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/da4755ebdbe445a2b844190421c09f84~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770048055&amp;x-signature=8yhtmC87aQoZKQCQbgGFLoamxOU%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h2 data-id="heading-1">一、Nexus版本核心定位</h2>
<p>“Nexus”意为连接点、核心枢纽，恰如其分地诠释了本版本的核心价值——作为超级智能体开发框架，它既是个人设备、AI能力、数据资源的连接中心，也是开发者快速构建、部署、迭代智能体应用的创新底座。无论是个人开发者打造专属智能工具，还是企业级团队搭建跨端协同智能系统，SuperAgent v0.6.5 都能提供灵活、高效、安全的技术支撑。</p>
<h2 data-id="heading-2">二、产品设计</h2>
<p>核心生态能力：① P2P设备自动发现，支持PC、手机、智能设备群跨端无缝协作；② 多语言SDK接入（Java、Python、JavaScript），适配各类开发场景；③ 第三方服务集成接口，可快速对接支付、地图、办公软件等外部服务；④ 支持私有化部署，满足企业级数据合规需求；⑤ 深度适配 <strong>ooder-agent-rad</strong> 可视化RAD工具，实现AI辅助设计与可视化开发的无缝衔接。</p>
<p><strong>生态配套工具推荐</strong>：ooder-agent-rad 是基于 SuperAgent 架构打造的 AIAgent 可视化编辑器，支持拖拽式界面设计、AI2UI 可视化操作与实时编辑部署。开发者可搭配 trae-solo 等 AI-IDE，通过本地 skills 桥接，实现从需求描述到界面生成的全流程智能化开发，大幅降低前端应用构建门槛。</p>
<h3 data-id="heading-3">２.1. SuperAgent v0.6.5 产品闭环图</h3>
<p>​</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b6e4dbd9b2344e6b83319cea79d50155~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770048055&amp;x-signature=NGz5n48GAbra8itIQ4UGOSC4qUg%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<ol>
<li><strong>开发者端</strong>：超级用户（开发者）通过技能开发、模板创建、测试验证和版本管理，完成技能的开发周期。</li>
<li><strong>工具链</strong>：提供AI-IDE、技能SDK、测试工具和部署工具，支持开发者的整个开发流程。</li>
<li><strong>能力中心（交换枢纽）</strong>：作为整个生态的核心交换枢纽，负责技能注册、模板管理、能力交换、权限控制和监控分析，实现技能的有效管理和交换。</li>
<li><strong>分发渠道</strong>：包括个人技能市场、企业应用商店、设备预装和API服务，将技能分发给不同类型的用户。</li>
<li><strong>用户端</strong>：最终用户通过技能发现、获取、使用和反馈评价，完成技能的使用周期，并将反馈传递给开发者，形成完整的闭环。</li>
</ol>
<p>产品闭环的核心价值：</p>
<ul>
<li><strong>完整的生态系统</strong>：从技能开发到最终使用，形成完整的闭环生态，确保技能的高质量和持续改进。</li>
<li><strong>能力中心作为交换枢纽</strong>：能力中心在整个闭环中起到关键的交换枢纽作用，连接开发者和用户，实现技能的有效管理和分发。</li>
<li><strong>开发者赋能</strong>：通过AI-IDE等工具，降低技能开发门槛，赋能开发者快速创建高质量的技能。</li>
<li><strong>用户价值最大化</strong>：通过多样化的分发渠道和个性化的技能推荐，确保用户能够发现和获取最适合自己的技能。</li>
<li><strong>持续改进机制</strong>：通过用户反馈和监控分析，不断优化技能和系统，提升整体生态的质量和价值。</li>
</ul>
<h3 data-id="heading-4">２.2个人应用为中心架构图（v0.6.5）</h3>
<p>​</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/650540430f4b40a18e9c524c2e2e118b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770048055&amp;x-signature=vM3Ky7pXbJznOFQwRow5THhNerU%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<ol>
<li><strong>个人设备层</strong>：多终端协同，包括个人PC、智能手机、智能平板和其他智能设备，用户可在任一设备发起技能请求。</li>
<li><strong>本地执行层</strong>：优先处理，采用本地优先执行原则，将用户数据和计算优先保留在本地，包括本地技能库、本地计算单元、本地存储和本地AI模型，确保隐私保护和响应速度。</li>
<li><strong>P2P网络层</strong>：设备互联，基于P2P网络自组织理论，实现设备间的智能协同，包括P2P发现服务、技能分布式发现、设备状态同步和技能共享机制，形成去中心化的设备网络。</li>
<li><strong>核心服务层</strong>：能力管理，负责个人技能的全生命周期管理，包括个人技能管理、AI模型调度、技能流编排和数据安全管理，为个人用户提供个性化的AI能力。</li>
<li><strong>远程资源层</strong>：扩展能力，当本地资源不足时，通过安全的远程连接访问扩展能力，包括云端技能库、云端AI模型、第三方服务和分布式存储，实现能力的无缝扩展。</li>
</ol>
<p>v0.6.5 版本特性：</p>
<ul>
<li><strong>本地优先执行</strong>：将计算和数据优先保留在本地设备，仅在必要时使用远程资源，确保用户隐私和系统响应速度。</li>
<li><strong>P2P设备协同</strong>：实现设备间的智能发现和协同，用户可在任一设备访问和执行技能，形成个人设备生态。</li>
<li><strong>个人技能自主管理</strong>：用户完全控制自己的AI技能，可自主添加、删除、更新技能，实现个性化AI体验。</li>
<li><strong>智能模型调度</strong>：根据任务复杂度和设备能力，智能选择本地或云端AI模型，平衡性能和资源消耗。</li>
<li><strong>技能分布式发现</strong>：通过P2P网络实现技能的分布式发现和共享，拓展个人能力边界。</li>
</ul>
<p>​</p>
<h2 data-id="heading-5">三，增强企业能力中心</h2>
<h3 data-id="heading-6">３.１设计目标</h3>
<p>Ooder技能（AIBridge）中心的技术目标包括：</p>
<ul>
<li><strong>标准化技能定义</strong>：建立统一的技能接口和生命周期管理机制，确保技能的可移植性和可重用性。</li>
<li><strong>模块化应用构建</strong>：通过技能的组合和编排，构建模块化、可扩展的业务应用。</li>
<li><strong>系统扩展性增强</strong>：实现技能的插拔式架构，支持系统功能的动态扩展和升级。</li>
<li><strong>开发效率提升</strong>：利用模板系统和自动化工具，减少重复开发工作，加速应用交付。</li>
<li><strong>跨系统能力调用</strong>：通过 Skills Remote Bridge 方案，实现跨系统、跨平台的技能调用。</li>
</ul>
<h3 data-id="heading-7">３.1 定位</h3>
<p>Ooder技能（AIBridge）中心是 Ooder 框架的核心组件，作为企业级应用开发的能力管理系统，提供标准化的技能定义、管理和执行机制。</p>
<p>Ooder技能（AIBridge）中心的核心技术价值在于：</p>
<ul>
<li><strong>能力抽象与复用</strong>：将业务能力抽象为可重用的技能组件，提高代码复用率。</li>
<li><strong>接口标准化</strong>：定义统一的技能接口和生命周期管理，确保技能的互操作性。</li>
<li><strong>远程能力调用</strong>：通过 Skills Remote Bridge 实现跨系统、跨平台的技能调用。</li>
<li><strong>流程编排</strong>：支持技能的组合和编排，构建复杂的业务流程。</li>
</ul>
<h3 data-id="heading-8">３.３技术架构</h3>
<p>​</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8c3072432f1e4d8abf4acf5ac42b3dda~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770048055&amp;x-signature=8Y63C1BJVpy5VSvQYDyOw087h7s%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<ol>
<li><strong>接入层</strong>：负责外部请求的接入和路由，API Gateway 接收请求并路由到负载均衡，负载均衡将请求分发到各个服务。</li>
<li><strong>服务层</strong>：负责业务逻辑的实现，包括技能管理、技能执行、模板管理和技能调度服务。</li>
<li><strong>核心层</strong>：负责核心功能的实现，分为接口组件（技能接口、模板接口）、执行组件（SkillScheduler、SkillExecutor、SkillContext）和功能组件（Skills Remote Bridge、SkillFlow 执行引擎、表单引擎）。</li>
<li><strong>基础设施层</strong>：负责底层基础设施的提供，包括数据库（存储数据）、缓存（提高性能）和消息队列（异步通信）。</li>
</ol>
<p>​</p>
<p>​</p>
<h3 data-id="heading-9">３.４ SuperAgent Nexus企业级业务架构图</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b0f9df6a1af4ba28fe8cc9e3de0e344~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770048055&amp;x-signature=Rpgb90rYaXflF%2FEZoorlhQcwYmE%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>​</p>
<ol>
<li><strong>用户中心层</strong>：多终端入口，包括个人PC、智能手机、平板电脑和智能设备群。</li>
<li><strong>接入层</strong>：安全网关与设备互联，包括Auth中心、API网关、SDK接入和P2P发现。</li>
<li><strong>核心层</strong>：智能体能力中枢，包含四大核心模块：Skill能力管理中心、LLM调度中心、DataServer数据中心和Skillflow调度中心。</li>
<li><strong>执行层</strong>：任务落地与技能调度，包括MCPAgent服务流入口、RouteAgent桥接转发、EndAgent执行单元和本地技能库。</li>
<li><strong>资源层</strong>：本地/云端算力支撑，包括本地存储、本地计算、云端资源和第三方服务。</li>
</ol>
<h3 data-id="heading-10">３.５ 核心链路</h3>
<p>Ooder技能（AIBridge）中心的核心链路遵循自顶向下的调用链，从任务初始化开始，逐级向下调用更具体的技能，最终完成任务执行。</p>
<h4 data-id="heading-11">３.５.1 执行流程</h4>
<ol>
<li><strong>任务初始化</strong>：接收用户输入的任务请求，包括目标类型、参数等</li>
<li><strong>模板识别</strong>：调用模板识别技能，确定使用哪种模板和执行策略</li>
<li><strong>参数提取</strong>：从用户输入和系统配置中提取模板所需的参数</li>
<li><strong>技能调度</strong>：根据任务类型，调度相应的一级技能</li>
<li><strong>子任务分解</strong>：一级技能将任务分解为多个子任务，调用相应的二级技能</li>
<li><strong>具体执行</strong>：二级技能调用三级技能完成具体的技术实现</li>
<li><strong>结果生成</strong>：根据模板和参数，生成最终的执行结果</li>
<li><strong>后处理</strong>：对生成的结果进行格式化、验证等后处理操作</li>
<li><strong>结果返回</strong>：将执行结果返回给用户或集成到系统中</li>
</ol>
<h4 data-id="heading-12">３.５.2 技能调度流程</h4>
<ol>
<li>应用层发送任务请求</li>
<li><code>SkillScheduler</code> 分析任务类型和需求</li>
<li>选择合适的技能组合</li>
<li>按顺序调度技能执行</li>
<li>汇总执行结果</li>
</ol>
<h4 data-id="heading-13">３.５.3 技能执行流程</h4>
<ol>
<li><code>SkillExecutor</code> 为技能创建执行环境</li>
<li>注入 <code>SkillContext</code> 和相关资源</li>
<li>执行技能的 <code>execute</code> 方法</li>
<li>捕获和处理执行异常</li>
<li>收集执行结果和日志</li>
<li>清理执行环境</li>
</ol>
<p>​</p>
<h3 data-id="heading-14">３.６ 核心功能</h3>
<p>Ooder技能（AIBridge）中心的核心功能包括：</p>
<ul>
<li><strong>技能管理</strong>：技能的注册、查询、更新、删除等生命周期管理。</li>
<li><strong>技能执行</strong>：技能的同步和异步执行，支持参数传递和结果返回。</li>
<li><strong>模板系统</strong>：支持多种模板类型（FTL、JSON 等），用于技能的生成和配置。</li>
<li><strong>Skills Remote Bridge</strong>：实现跨系统、跨平台的技能调用。</li>
<li><strong>SkillFlow 增强</strong>：支持技能的组合和编排，构建复杂的业务流程。</li>
<li><strong>表单增强</strong>：提供表单的快速构建和管理能力。</li>
<li><strong>插件机制</strong>：支持第三方插件的集成和扩展，增强系统功能。</li>
</ul>
<p>Ooder技能（AIBridge）中心是 Ooder 框架的核心组件，作为企业级应用开发的能力管理系统，提供标准化的技能定义、管理和执行机制。</p>
<p>Ooder技能（AIBridge）中心的核心技术价值在于：</p>
<ul>
<li><strong>能力抽象与复用</strong>：将业务能力抽象为可重用的技能组件，提高代码复用率。</li>
<li><strong>接口标准化</strong>：定义统一的技能接口和生命周期管理，确保技能的互操作性。</li>
<li><strong>远程能力调用</strong>：通过 Skills Remote Bridge 实现跨系统、跨平台的技能调用。</li>
<li><strong>流程编排</strong>：支持技能的组合和编排，构建复杂的业务流程。</li>
</ul>
<h3 data-id="heading-15">3.６.1 Skills Remote Bridge</h3>
<p>Skills Remote Bridge 是 Ooder技能（AIBridge）中心的核心功能，实现跨系统、跨平台的技能调用。主要包括：</p>
<ul>
<li><strong>远程技能注册</strong>：将远程系统的技能注册到本地技能中心，建立技能映射关系。</li>
<li><strong>远程技能调用</strong>：通过标准化的接口调用远程系统的技能，处理网络通信、参数转换等细节。</li>
<li><strong>技能结果同步</strong>：将远程技能的执行结果同步到本地，确保业务流程的连续性。</li>
<li><strong>错误处理与重试</strong>：处理远程调用过程中的错误，支持自动重试机制。</li>
<li><strong>性能优化</strong>：通过连接池、缓存等技术，优化远程调用的性能。</li>
</ul>
<p>Skills Remote Bridge 的实现基于标准的网络协议和序列化机制，支持多种远程调用方式，如 HTTP、RPC 等。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/844fb385069744868f2c301cb6f8ade9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770048055&amp;x-signature=U8EIIwWu0SdhNCaZC5mkPJ8k5lg%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>​</p>
<ol>
<li>本地系统发送技能调用请求</li>
<li>Skills Remote Bridge 处理请求并转发到远程系统</li>
<li>远程系统执行技能</li>
<li>获取执行结果</li>
<li>远程系统返回执行结果给 Skills Remote Bridge</li>
<li>Skills Remote Bridge 处理结果并返回给本地系统</li>
<li>如有错误，Skills Remote Bridge 触发错误检测</li>
<li>重试机制重新发送请求</li>
</ol>
<p><strong>３.６.２ SkillFlow 增强</strong></p>
<p>killFlow 增强是 Ooder技能（AIBridge）中心的重要功能，支持技能的组合和编排，构建复杂的业务流程。主要包括：</p>
<ul>
<li><strong>可视化流程设计</strong>：提供图形化界面，方便用户设计和管理技能流。</li>
<li><strong>流程模板管理</strong>：支持流程模板的创建、修改、删除和复用。</li>
<li><strong>流程执行引擎</strong>：负责技能流的执行和调度，支持同步和异步执行模式。</li>
<li><strong>流程监控与分析</strong>：监控技能流的执行状态和性能，提供实时的执行信息和统计数据。</li>
<li><strong>异常处理机制</strong>：处理流程执行过程中的异常，支持异常捕获、重试和补偿。</li>
</ul>
<p>SkillFlow 增强的实现基于状态机和事件驱动架构，支持复杂业务流程的可视化定义和自动化执行。</p>
<p>​</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d94acf52892426eb6406f475b7d6648~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770048055&amp;x-signature=3cP6X1UwQb4Z3aIKVZ9%2BuEGW3hA%3D" alt="开始节点启动流程 执行技能节点1 决策节点根据条件判断，条件满足则执行技能节点2 决策节点条件不满足则执行技能节点3 技能节点2执行完成后到达结束节点 技能节点3执行完成后到达结束节点" loading="lazy"/></p>
<p>​</p>
<h3 data-id="heading-16"><strong>3.６.３</strong> 表单增强</h3>
<p>表单增强是 Ooder技能（AIBridge）中心的重要功能，提供表单的快速构建和管理能力。主要包括：</p>
<ul>
<li><strong>表单模板管理</strong>：支持表单模板的创建、修改、删除和复用。</li>
<li><strong>动态表单生成</strong>：根据配置自动生成表单，支持多种表单控件和布局。</li>
<li><strong>表单验证</strong>：提供丰富的表单验证规则，确保数据的合法性。</li>
<li><strong>表单数据处理</strong>：处理表单提交的数据，支持数据转换、存储和关联。</li>
<li><strong>表单与技能集成</strong>：将表单与技能集成，实现表单操作触发技能执行。</li>
</ul>
<p>表单增强的实现基于模板系统和组件化架构，支持快速构建高质量的表单界面。</p>
<p>​</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb5f1d1db85e4310bb873770cda88135~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770048055&amp;x-signature=uPrMuZgKAj9EE9zdpnUYnEfCHvo%3D" alt="选择合适的表单模板 根据模板动态生成表单 对用户输入进行表单验证，验证通过则进入数据处理 验证失败则返回重新生成表单 处理表单提交的数据 将表单与技能集成，触发技能执行 获取技能执行结果 根据技能执行结果更新表单" loading="lazy"/></p>
<h3 data-id="heading-17">3.６.４ 技能管理</h3>
<p>技能管理是 Ooder技能（AIBridge）中心的基础功能，负责技能的全生命周期管理。主要包括：</p>
<ul>
<li><strong>技能注册</strong>：将技能注册到技能中心，包括技能名称、描述、版本、接口定义等信息。</li>
<li><strong>技能查询</strong>：支持按名称、类型、标签等条件查询技能。</li>
<li><strong>技能更新</strong>：更新技能的信息和实现。</li>
<li><strong>技能删除</strong>：从技能中心移除技能。</li>
<li><strong>技能版本管理</strong>：支持技能的多版本管理，确保系统的稳定性和兼容性。</li>
</ul>
<p>技能管理服务提供 RESTful API 接口，方便开发者和系统集成。</p>
<h3 data-id="heading-18">3.６.５ 模板系统</h3>
<p>模板系统是 Ooder技能（AIBridge）中心的重要组成部分，负责技能的生成和配置。主要包括：</p>
<ul>
<li><strong>模板类型支持</strong>：支持多种模板类型，如 FTL（Freemarker）、JSON 等。</li>
<li><strong>模板管理</strong>：支持模板的注册、查询、更新和删除等生命周期管理。</li>
<li><strong>模板加载</strong>：支持多种模板加载方式，如本地文件、远程服务器、数据库等。</li>
<li><strong>模板渲染</strong>：根据模板和数据生成技能配置和代码。</li>
</ul>
<p>模板系统的实现基于 <code>SkillTemplateManager</code> 和 <code>TemplateLoader</code> 接口，支持模板的高效管理和加载。</p>
<p>​</p>
<h2 data-id="heading-19">四、A2UI一张画布</h2>
<p>　　Ooder 全栈开发框架的目标是简化个人应用开发流程，实现个人数字化转型。Ooder RAD（Rapid Application Development）可视化设计器作为 Ooder 框架的核心组件，在 v0.6.5 版本中，通过可视化界面设计、拖拽式操作和自动化代码生成，结合个人应用为中心的设计理念，为个人开发者提供快速、高效、低代码的开发体验。</p>
<p>​</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1de98d21d1b64dcab6ad37c614413e4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770048055&amp;x-signature=NrMx%2F71WCf0PtySd1azgC4KX9EU%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h3 data-id="heading-20">４.1 定位</h3>
<p>Ooder RAD 可视化设计器 v0.6.5 是 Ooder 框架的核心组件，作为个人应用开发的快速开发工具，提供可视化界面设计、拖拽式操作和自动化代码生成能力，围绕个人应用为中心的设计理念，实现个人数字化转型。</p>
<h4 data-id="heading-21">核心技术价值</h4>
<ul>
<li><strong>个人应用为中心</strong>：围绕个人用户需求，提供个性化的应用开发体验，支持个人数字化转型。</li>
<li><strong>开发效率提升</strong>：通过可视化设计和自动化代码生成，显著减少手动编码工作，加速应用开发和交付。</li>
<li><strong>技术门槛降低</strong>：提供低代码/无代码开发模式，让非技术人员也能参与应用开发，扩大开发人员范围。</li>
<li><strong>界面一致性</strong>：提供统一的界面设计规范和组件库，确保应用界面的一致性和专业性。</li>
<li><strong>组件复用</strong>：通过组件化开发和模板系统，提高代码复用率，减少重复开发工作。</li>
<li><strong>本地优先执行</strong>：采用本地优先执行原则，将数据和计算优先保留在本地设备，确保数据隐私和响应速度。</li>
<li><strong>P2P设备协同</strong>：支持个人设备间的智能发现和协同，实现跨设备的应用体验。</li>
<li><strong>前后端一体化</strong>：与 Ooder 技能（AIBridge）中心无缝集成，实现前后端能力的统一管理和调用。</li>
</ul>
<h3 data-id="heading-22">４.２ 核心功能</h3>
<ul>
<li><strong>个人应用为中心</strong>：围绕个人用户需求，提供个性化的应用开发体验。</li>
<li><strong>可视化界面设计</strong>：提供拖拽式界面设计工具，支持多种布局和组件。</li>
<li><strong>组件库管理</strong>：提供丰富的可重用组件库，支持自定义组件的开发和管理。</li>
<li><strong>自动化代码生成</strong>：根据可视化设计自动生成前端代码，支持多种前端框架。</li>
<li><strong>模板系统</strong>：提供多种应用模板，支持快速创建应用。</li>
<li><strong>实时预览</strong>：提供实时预览功能，让开发者即时查看设计效果。</li>
<li><strong>本地优先执行</strong>：采用本地优先执行原则，将数据和计算优先保留在本地设备。</li>
<li><strong>P2P设备协同</strong>：支持个人设备间的智能发现和协同，实现跨设备的应用体验。</li>
<li><strong>版本控制</strong>：支持应用版本的管理和回滚。</li>
<li><strong>个人团队协作</strong>：支持小型团队的协同开发和设计。</li>
<li><strong>与能力中心集成</strong>：与 Ooder 技能（AIBridge）中心无缝集成，实现前后端能力的统一管理和调用。</li>
</ul>
<h3 data-id="heading-23">４.3. 核心功能</h3>
<p>４.3.1 个人应用为中心设计</p>
<p>个人应用为中心设计是 Ooder RAD 可视化设计器 v0.6.5 的核心功能，围绕个人用户需求，提供个性化的应用开发体验。主要包括：</p>
<ul>
<li><strong>个性化模板</strong>：提供基于个人场景的应用模板，如个人助手、健康管理、学习工具等。</li>
<li><strong>个人数据管理</strong>：支持个人数据的本地存储和管理，确保数据隐私。</li>
<li><strong>个人设备适配</strong>：支持多种个人设备的界面适配，确保跨设备的一致性体验。</li>
<li><strong>个人技能集成</strong>：与个人技能库集成，支持个性化技能的调用和管理。</li>
<li><strong>个人偏好设置</strong>：支持个性化的设计器设置，如主题、布局、组件库等。</li>
</ul>
<p>个人应用为中心设计的实现基于个人用户画像和行为分析，提供智能化的个性化推荐。</p>
<p>​</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ee70eb56b37496a9ea8782481d4deb3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770048055&amp;x-signature=Y0T0fw4MlunojiwtoyFNmte3apE%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<ol>
<li>打开 RAD 可视化设计器</li>
<li>选择合适的应用模板创建项目</li>
<li>通过拖拽方式添加和排列组件，设计应用界面</li>
<li>调整组件的样式和属性</li>
<li>为组件绑定事件和交互逻辑</li>
<li>实时预览设计效果</li>
<li>自动生成前端代码</li>
<li>部署应用并上线</li>
<li>根据用户反馈持续优化设计流程</li>
</ol>
<p>４.３.2 组件库管理</p>
<p>组件库管理是 Ooder RAD 可视化设计器的重要功能，提供丰富的可重用组件库，支持自定义组件的开发和管理。主要包括：</p>
<ul>
<li><strong>基础组件</strong>：提供按钮、输入框、下拉框、复选框等基础 UI 组件。</li>
<li><strong>布局组件</strong>：提供容器、网格、卡片、导航栏等布局组件。</li>
<li><strong>高级组件</strong>：提供表格、表单、图表、地图等高级功能组件。</li>
<li><strong>业务组件</strong>：提供基于行业场景的业务组件，如审批流程、数据看板等。</li>
<li><strong>自定义组件</strong>：支持开发者创建和管理自定义组件，扩展组件库。</li>
<li><strong>组件分类</strong>：支持组件的分类管理，方便开发者查找和使用。</li>
</ul>
<p>组件库管理的实现基于组件化开发理念，支持组件的版本管理和依赖管理。</p>
<p>​</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d8456a960d69469ca8ec2bc200eaafc1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770048055&amp;x-signature=%2FlVrkmYCkwpM3%2FFHAd7dAncHeTc%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<ol>
<li>组件库包含基础组件、高级组件、业务组件和自定义组件</li>
<li>组件库支持组件的分类管理</li>
<li>开发者在应用设计过程中使用组件库中的组件</li>
<li>根据使用反馈对组件进行优化</li>
<li>更新组件库中的组件，形成迭代循环</li>
</ol>
<h3 data-id="heading-24">４.3.3 自动化代码生成</h3>
<p>自动化代码生成是 Ooder RAD 可视化设计器的核心功能，根据可视化设计自动生成前端代码，支持多种前端框架。主要包括：</p>
<ul>
<li><strong>多框架支持</strong>：支持生成 Vue、React、Angular 等多种前端框架的代码。</li>
<li><strong>代码质量保证</strong>：生成的代码符合行业标准和最佳实践，确保代码的可维护性和性能。</li>
<li><strong>自定义模板</strong>：支持自定义代码生成模板，满足不同项目的需求。</li>
<li><strong>代码预览</strong>：提供生成代码的预览功能，让开发者了解生成的代码结构。</li>
<li><strong>代码导出</strong>：支持将生成的代码导出为项目文件，方便开发者进行进一步的修改和部署。</li>
</ul>
<p>自动化代码生成的实现基于模板引擎和代码生成器，支持代码的增量生成和更新。</p>
<p>​</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e33e18ff0574d44b0838ec23bd4cfd5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770048055&amp;x-signature=gXEQCbwPCllZvZRbezZNecHXWKM%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<ol>
<li>解析可视化设计的结构和组件</li>
<li>分析组件的属性和事件</li>
<li>根据选择的前端框架确定代码生成策略</li>
<li>选择合适的代码生成模板</li>
<li>生成前端代码</li>
<li>对生成的代码进行优化和格式化</li>
<li>预览生成的代码</li>
<li>导出代码为项目文件</li>
<li>构建项目并部署应用</li>
<li>根据使用反馈优化代码生成模板</li>
<li>更新代码生成模板，形成持续优化循环</li>
</ol>
<h3 data-id="heading-25">４.3.4 模板系统</h3>
<p>模板系统是 Ooder RAD 可视化设计器的重要组成部分，提供多种应用模板，支持快速创建应用。主要包括：</p>
<ul>
<li><strong>应用模板</strong>：提供完整的应用模板，如管理后台、电商网站、移动应用等。</li>
<li><strong>页面模板</strong>：提供常用的页面模板，如登录页、首页、详情页、列表页等。</li>
<li><strong>组件模板</strong>：提供常用的组件组合模板，如表单、表格、导航等。</li>
<li><strong>模板管理</strong>：支持模板的创建、修改、删除和复用。</li>
<li><strong>模板分享</strong>：支持模板的分享和导入，促进团队协作和知识共享。</li>
</ul>
<p>模板系统的实现基于模板引擎和版本控制系统，支持模板的版本管理和依赖管理。</p>
<h3 data-id="heading-26">４.3.5 实时预览</h3>
<p>实时预览是 Ooder RAD 可视化设计器的重要功能，提供实时预览功能，让开发者即时查看设计效果。主要包括：</p>
<ul>
<li><strong>实时同步</strong>：设计变更实时反映到预览界面，无需手动刷新。</li>
<li><strong>多设备预览</strong>：支持在不同设备尺寸下预览应用效果，确保响应式设计的正确性。</li>
<li><strong>交互预览</strong>：支持预览应用的交互效果，如点击、悬停、表单提交等。</li>
<li><strong>数据模拟</strong>：支持模拟数据，让开发者在没有后端服务的情况下也能预览应用效果。</li>
</ul>
<p>实时预览的实现基于浏览器的实时通信技术和前端框架的热更新机制。</p>
<h3 data-id="heading-27">４.3.6 本地优先执行</h3>
<p>本地优先执行是 Ooder RAD 可视化设计器 v0.6.5 的核心功能，采用本地优先执行原则，将数据和计算优先保留在本地设备。主要包括：</p>
<ul>
<li><strong>本地数据存储</strong>：优先使用本地文件系统和本地数据库存储应用数据，确保数据隐私和离线访问能力。</li>
<li><strong>本地计算执行</strong>：将应用的计算逻辑优先在本地设备执行，减少网络依赖和响应延迟。</li>
<li><strong>本地缓存优化</strong>：实现智能本地缓存策略，缓存常用数据和计算结果，提高应用性能。</li>
<li><strong>离线模式支持</strong>：支持应用在离线状态下正常运行，当网络恢复时自动同步数据。</li>
<li><strong>数据隐私保护</strong>：通过本地存储和加密技术，确保用户数据的安全性和隐私性。</li>
</ul>
<p>本地优先执行的实现基于现代前端框架的离线能力和本地存储技术，如 IndexedDB、Service Worker 等。</p>
<p>​</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40e410523667488895b9b9297a8f35ff~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770048055&amp;x-signature=VbwrMtyodwU%2BaQMOFlGiwSoO8xQ%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<ol>
<li>应用启动时检查网络状态</li>
<li>无论网络状态如何，都优先使用本地执行引擎</li>
<li>读取数据时，优先使用本地数据</li>
<li>如果本地数据不存在，则从云端获取并同步到本地</li>
<li>执行计算逻辑，优先在本地执行</li>
<li>更新数据时，优先存储到本地</li>
<li>当网络可用时，将本地数据同步到云端</li>
</ol>
<h3 data-id="heading-28">４.3.7 P2P设备协同</h3>
<p>P2P设备协同是 Ooder RAD 可视化设计器 v0.6.5 的核心功能，支持个人设备间的智能发现和协同，实现跨设备的应用体验。主要包括：</p>
<ul>
<li><strong>设备自动发现</strong>：支持个人设备间的自动发现和识别，无需手动配置。</li>
<li><strong>设备状态同步</strong>：实现设备间的状态同步，确保应用在不同设备上的一致性体验。</li>
<li><strong>任务分发与协同</strong>：支持将复杂任务分发到多个设备执行，实现设备间的协同工作。</li>
<li><strong>数据安全传输</strong>：采用加密技术确保设备间数据传输的安全性。</li>
<li><strong>设备能力感知</strong>：自动感知设备的硬件能力，根据设备能力分配适合的任务。</li>
</ul>
<p>P2P设备协同的实现基于 WebRTC、蓝牙等点对点通信技术，支持设备间的直接通信和数据传输。</p>
<p>​</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d61c726fed2a4b088c694a2c5cb4c19b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770048055&amp;x-signature=ZkMNOHEDAATI%2BvOXVIQOAnv5sKA%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<ol>
<li>主设备在设备网络中发现其他设备</li>
<li>主设备将任务分发给从设备</li>
<li>从设备执行分配的任务</li>
<li>从设备将执行结果返回给主设备</li>
<li>主设备汇总所有任务结果</li>
<li>主设备与从设备保持状态同步，确保应用体验的一致性</li>
</ol>
<p>​</p>
<h3 data-id="heading-29">４.3.8 与能力中心集成</h3>
<p>与能力中心集成是 Ooder RAD 可视化设计器的重要功能，与 Ooder 技能（AIBridge）中心无缝集成，实现前后端能力的统一管理和调用。主要包括：</p>
<ul>
<li><strong>技能可视化配置</strong>：通过可视化界面配置和调用 Ooder 技能（AIBridge）中心的技能。</li>
<li><strong>前后端一体化</strong>：实现前端界面与后端技能的无缝对接，简化前后端集成。</li>
<li><strong>技能流编排</strong>：通过可视化界面编排技能流，实现复杂业务流程的自动化。</li>
<li><strong>数据绑定</strong>：支持将前端组件与后端技能的数据输出进行绑定，实现数据的自动同步。</li>
</ul>
<p>与能力中心集成的实现基于 Ooder 技能（AIBridge）中心的 API 和 SDK，支持技能的可视化配置和调用。</p>
<p>​</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/64f4535a88964f26ae19179bd4dad7c9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770048055&amp;x-signature=agiTMQ%2FK6xD4ckTHhaeJk1%2Fw6Vk%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<ol>
<li>在 RAD 设计器中通过可视化界面配置技能调用</li>
<li>发送技能调用请求到能力中心</li>
<li>能力中心执行相应的技能</li>
<li>技能执行完成后返回数据响应</li>
<li>将返回的数据绑定到前端组件</li>
<li>在应用界面中展示数据</li>
</ol>
<h2 data-id="heading-30">４.4. RAD技术架构</h2>
<h3 data-id="heading-31">4.41.设计</h3>
<p>Ooder RAD 可视化设计器 v0.6.5 采用分层设计架构，主要分为以下几层：</p>
<ul>
<li><strong>个人设备层</strong>：负责个人设备的接入和管理，包括PC、智能手机、平板等多种设备。</li>
<li><strong>接入层</strong>：负责用户界面的渲染和交互，包括设计器界面、预览界面等。</li>
<li><strong>核心层</strong>：负责核心功能的实现，包括拖拽引擎、组件管理、代码生成、本地执行引擎等。</li>
<li><strong>服务层</strong>：负责业务逻辑的实现，包括项目管理、模板管理、资源管理、P2P协同服务等。</li>
<li><strong>集成层</strong>：负责与外部系统的集成，包括与 Ooder 技能（AIBridge）中心的集成、与版本控制系统的集成等。</li>
<li><strong>基础设施层</strong>：负责底层基础设施的提供，包括本地文件系统、本地数据库、云端存储等。</li>
</ul>
<h3 data-id="heading-32">4.4.2 核心链路</h3>
<p>Ooder RAD 可视化设计器 v0.6.5 的核心链路遵循从设计到生成的流程，从用户的可视化设计开始，经过组件分析、模板选择、代码生成等步骤，最终生成可部署的应用代码。</p>
<h4 data-id="heading-33">设计流程</h4>
<ol>
<li><strong>项目创建</strong>：用户选择模板创建新项目</li>
<li><strong>界面设计</strong>：用户通过拖拽方式设计应用界面</li>
<li><strong>组件配置</strong>：用户配置组件的属性和样式</li>
<li><strong>事件绑定</strong>：用户为组件绑定事件和交互逻辑</li>
<li><strong>数据绑定</strong>：用户绑定后端数据和技能调用</li>
<li><strong>实时预览</strong>：用户实时预览设计效果</li>
<li><strong>代码生成</strong>：系统自动生成前端代码</li>
<li><strong>项目导出</strong>：用户导出项目代码进行部署</li>
</ol>
<h4 data-id="heading-34">组件管理流程</h4>
<ol>
<li><strong>组件注册</strong>：组件开发者注册新组件到组件库</li>
<li><strong>组件分类</strong>：系统对组件进行分类管理</li>
<li><strong>组件使用</strong>：用户在设计过程中使用组件</li>
<li><strong>组件更新</strong>：组件开发者更新和优化组件</li>
<li><strong>组件版本管理</strong>：系统管理组件的版本和依赖</li>
</ol>
<p>​</p>
<h4 data-id="heading-35">核心层与接入层交互</h4>
<p>​</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5bc79a9f102b47bf87507e86951bad31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770048055&amp;x-signature=fN0vf4bMUksXA9LXLJUz%2B8asUf8%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>​</p>
<h4 data-id="heading-36">服务层与核心层交互</h4>
<p>​</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ff53396bb6b40259a7018d20e037c78~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770048055&amp;x-signature=9esgEsnDfCpWp5XYpGkYdXvEHJY%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h4 data-id="heading-37">集成层与服务层交互</h4>
<p>​</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/092a316911ae48d79c43054385efb703~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770048055&amp;x-signature=OZTaSVqmSWdLKN4orodKowqp3eI%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<h4 data-id="heading-38">基础设施层与服务层交互</h4>
<p>​</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5239847a3d5f47938e6601f25b611e26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgT25lQ29kZUNO:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770048055&amp;x-signature=%2F7SLG2Ot1yAy8q4d23cZ4dFFXHM%3D" alt="请在此添加图片描述" loading="lazy"/></p>
<p>架构图说明：</p>
<ol>
<li><strong>个人设备层</strong>：负责个人设备的接入和管理，包括PC、智能手机、平板等多种设备，支持跨设备访问和协同。</li>
<li><strong>接入层</strong>：负责用户界面的渲染和交互，包括设计器界面、预览界面和代码预览。</li>
<li><strong>核心层</strong>：负责核心功能的实现，包括拖拽引擎、组件管理、代码生成器、模板引擎、实时预览服务和本地执行引擎。</li>
<li><strong>服务层</strong>：负责业务逻辑的实现，包括项目管理服务、模板管理服务、资源管理服务、版本控制服务和P2P协同服务。</li>
<li><strong>集成层</strong>：负责与外部系统的集成，包括能力中心集成、版本控制系统集成和云服务集成。</li>
<li><strong>基础设施层</strong>：负责底层基础设施的提供，包括本地文件系统、本地数据库、云端存储、本地缓存和 CDN。</li>
</ol>
<h3 data-id="heading-39">4.4.4 组件</h3>
<p>Ooder RAD 可视化设计器 v0.6.5 的主要组件包括：</p>
<ul>
<li><strong>拖拽引擎</strong>：负责处理用户的拖拽操作，实现组件的添加、移动和调整。</li>
<li><strong>组件管理</strong>：负责组件的注册、分类、版本管理和依赖管理。</li>
<li><strong>代码生成器</strong>：负责根据可视化设计自动生成前端代码，支持多种前端框架。</li>
<li><strong>模板引擎</strong>：负责管理和渲染应用模板、页面模板和组件模板。</li>
<li><strong>实时预览服务</strong>：负责实时预览设计效果，支持多设备预览和交互预览。</li>
<li><strong>本地执行引擎</strong>：负责应用的本地执行，包括本地数据存储、本地计算和离线模式支持。</li>
<li><strong>项目管理服务</strong>：负责项目的创建、保存、更新和删除。</li>
<li><strong>模板管理服务</strong>：负责模板的创建、保存、更新和删除。</li>
<li><strong>资源管理服务</strong>：负责管理项目的资源文件，如图片、字体、样式等。</li>
<li><strong>版本控制服务</strong>：负责项目和组件的版本管理和回滚。</li>
<li><strong>P2P协同服务</strong>：负责设备间的智能发现和协同，实现跨设备的应用体验。</li>
<li><strong>能力中心集成</strong>：负责与 Ooder 技能（AIBridge）中心的集成，实现前后端能力的统一管理和调用。</li>
</ul>
<h2 data-id="heading-40">五、典型开发场景演示</h2>
<h3 data-id="heading-41">场景1：AI-IDE智能应用开发（个人开发者场景）</h3>
<p>基于SuperAgent Nexus，开发者可快速搭建AI辅助开发工具，实现“需求描述-架构设计-代码生成-部署测试”全流程自动化：</p>
<ol>
<li>开发者在PC端通过自然语言输入应用需求（如“开发一个本地文件分类工具”）；</li>
<li>LLM调度中心生成应用架构设计，Skillflow自动串联“需求解析-代码生成-本地部署-测试验证”技能流；</li>
</ol>
<p>A2UI技能生成前端界面代码，也可直接调用 ooder-agent-rad 完成可视化界面拖拽设计，后端技能生成文件处理逻辑，本地部署技能将应用部署至PC端；</p>
<ol>
<li>开发者通过手机端实时查看部署进度，测试技能自动完成功能校验，生成测试报告。</li>
</ol>
<h3 data-id="heading-42">场景2：跨端自动化协作（企业办公场景）</h3>
<p>开发者可基于框架搭建企业级智能协作助手，实现多设备、多角色的任务协同：</p>
<p>通过Skillflow编排“会议记录生成-任务分配-进度追踪-结果同步”工作流，会议结束后自动将录音转文字（本地技能），分配任务至成员手机端，实时同步进度至PC端办公软件，最终生成协作报告存储至数据中心。</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI 的逐步进化：从被动的“思考者”到主动的“行动者”]]></title>    <link>https://juejin.cn/post/7599506068047249408</link>    <guid>https://juejin.cn/post/7599506068047249408</guid>    <pubDate>2026-01-26T14:21:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599506068047249408" data-draft-id="7599506068047200256" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI 的逐步进化：从被动的“思考者”到主动的“行动者”"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-01-26T14:21:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="叶子的技术碎碎念"/> <meta itemprop="url" content="https://juejin.cn/user/2831954919569245"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI 的逐步进化：从被动的“思考者”到主动的“行动者”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2831954919569245/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    叶子的技术碎碎念
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T14:21:56.000Z" title="Mon Jan 26 2026 14:21:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>如今大模型已经火热了两三年，发展得也越来越快，已经不仅仅停留在聊天机器人和文本生成工具上。虽然你输入问题，它给出答案。这种交互模式已经很有用了，但也仅此而已，现在的AI的使用方式跟GPT3.5刚出来的时候已经完全不一样了，无论是dify、coze这些平台，还是Codex、Claude Code等开发者工具，都在以不一样的方式来改变我们的生活。</p>
<p>最近，来自UIUC、Meta、亚马逊、谷歌DeepMind、UCSD和耶鲁大学的研究人员对目前的智能体推理系统进行了系统化的总结、形式化定义和框架构建，这篇论文就是 <a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2601.12538" target="_blank" title="https://arxiv.org/pdf/2601.12538" ref="nofollow noopener noreferrer">Agentic Reasoning for Large Language Models</a>。核心想法很简单：</p>
<p>"Rather than passively generating sequences, LLMs are reframed as autonomous reasoning agents that plan, act, and learn through continual interaction with their environment. This refraining unifies reasoning with acting, positioning reasoning as the organizing principle for perception, planning, decision, and verification."</p>
<p>AI不再只是处理输入然后输出结果，而是可以主动规划、执行任务、从反馈中学习。下面简单总结下这篇论文的主要内容：</p>
<h2 data-id="heading-0">一：从静态计算到动态交互</h2>
<p>传统LLM的工作方式是扩展测试时计算（scaling test-time computation）：输入问题，模型内部计算，输出答案。整个过程是一次性的。</p>
<p>智能体推理不同。它强调扩展测试时互动（scaling test-time interaction）。AI被放在一个环境中，通过多轮交互来完成任务。它可以尝试、观察结果、调整策略，然后再尝试。</p>
<p>两者的区别：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f106360741d04710977ca2726843e9d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-25a2Q55qE5oqA5pyv56KO56KO5b-1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770042116&amp;x-signature=He0jwc3e9%2BJ%2BRfOxaPB6iRuFQPs%3D" alt="" loading="lazy"/></p>
<p>这个变化意味着AI的能力不再取决于它记住了多少知识，而是取决于它能否在实际环境中找到信息、使用工具、根据反馈调整方法。</p>
<h2 data-id="heading-1">二：AI可以从错误中学习</h2>
<p>更有意思的是自主演进智能体推理（Self-Evolving Agentic Reasoning）。AI可以通过经验改进自己的表现。</p>
<p>这依赖两个机制：</p>
<p><strong>反馈</strong>：AI完成任务后会评估自己的推理过程。比如Reflexion框架让AI检查自己的行动序列是否有效。发现问题后，它会在下次任务中避免同样的错误。</p>
<p><strong>记忆</strong>：AI会记录每次交互的结果。成功和失败的经验都会被保存下来，用于改进未来的决策。</p>
<p>这让AI可以在使用过程中持续改进，而不需要每次都重新训练模型。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4228a516f77e45e881c96d988630f8d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-25a2Q55qE5oqA5pyv56KO56KO5b-1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770042116&amp;x-signature=GRj2Pw9y4Jv9oNNRzCSAsg0lNWo%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">三：多个AI协同工作</h2>
<p>集体多智能体推理（Collective Multi-Agent Reasoning）让多个AI分工合作。一个AI团队可能包括：</p>
<ul>
<li><strong>管理者</strong>：分解任务</li>
<li><strong>工作者</strong>：执行具体操作，比如调用工具或编写代码</li>
<li><strong>验证者</strong>：检查结果是否正确</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96284d5912c24b20bed9d896c8064404~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-25a2Q55qE5oqA5pyv56KO56KO5b-1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770042116&amp;x-signature=iCMmWkBkYePapdetLxnIeoTI9P8%3D" alt="" loading="lazy"/></p>
<p>这种分工的好处是每个AI专注于自己擅长的部分。管理者规划路线，工作者执行任务，验证者把关质量。它们之间会互相反馈，逐步优化最终结果。</p>
<h2 data-id="heading-3">四：AI可以创造工具</h2>
<p>以前AI只能使用人类提供的工具和API。现在AI可以自己编写代码来创建新工具。</p>
<p>当遇到现有工具无法解决的问题时，AI会写代码、测试、调试，直到创建出能用的工具。比如ToolMaker框架甚至可以把整个GitHub仓库转换成AI可调用的工具集。</p>
<p>这意味着AI不再受限于预设的功能。它可以根据需要扩展自己的能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a64c16c48aa14b749a3797bb004b50a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Y-25a2Q55qE5oqA5pyv56KO56KO5b-1:q75.awebp?rk3s=f64ab15b&amp;x-expires=1770042116&amp;x-signature=U%2F%2B9fukPZbCOCYJSjWjkfi3j794%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-4">结论</h2>
<p>智能体推理代表了AI发展的一个新方向。AI从被动响应转向主动解决问题，从静态知识库转向动态学习系统。</p>
<p>这项研究提出的四个方向——动态交互、从错误中学习、多智能体协作、创造工具——都指向同一个趋势：AI正在变得更加自主。</p>
<p>这些能力还在早期阶段，但已经显示出实用价值。接下来值得关注的就是这些技术如何在实际应用中落地。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python `__xxattr__` 四大实战模式详解：从代理到 ORM 的魔法之旅]]></title>    <link>https://juejin.cn/post/7599531732337557538</link>    <guid>https://juejin.cn/post/7599531732337557538</guid>    <pubDate>2026-01-26T14:30:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599531732337557538" data-draft-id="7599531732337541154" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python `__xxattr__` 四大实战模式详解：从代理到 ORM 的魔法之旅"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-01-26T14:30:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="哈里谢顿"/> <meta itemprop="url" content="https://juejin.cn/user/3678304397695056"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python `__xxattr__` 四大实战模式详解：从代理到 ORM 的魔法之旅
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3678304397695056/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    哈里谢顿
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T14:30:44.000Z" title="Mon Jan 26 2026 14:30:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>关键词：Python、<strong>getattr</strong>、<strong>setattr</strong>、代理模式、延迟加载、属性验证、ORM<br/>
预计阅读：25 min，附完整可运行代码示例</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">0. 前言：为什么你一定要掌握 <code>__xxattr__</code></h2>
<p>在 Python 里，点语法（<code>obj.x</code>）看似平淡无奇，背后却藏着一套可插拔的“钩子”——<br/>
<code>__getattr__</code> / <code>__setattr__</code> / <code>__delattr__</code>。<br/>
它们就像“魔法插槽”，能让你在“属性被触碰”的瞬间植入任意逻辑：查日志、做校验、走网络、懒加载……<br/>
本文用“四大模式”带你把官方文档里干巴巴的定义变成能跑、能改、能上线的产品级代码。</p>
<hr/>
<h2 data-id="heading-1">1. 代理模式（Proxy）：把“转发”玩出花</h2>
<h3 data-id="heading-2">1.1 场景</h3>
<ul>
<li>包装第三方库，隐藏其怪异接口</li>
<li>给所有方法统一加日志、缓存、权限</li>
<li>实现“远程代理”：本地对象 ≈ 远端服务</li>
</ul>
<h3 data-id="heading-3">1.2 最小可运行模板</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Proxy</span>:
    <span class="hljs-string">"""通用代理：只暴露被代理对象的公共属性（非 _ 开头）"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, target</span>):
        <span class="hljs-comment"># 必须用 super 绕过自身的 __setattr__</span>
        <span class="hljs-built_in">super</span>().__setattr__(<span class="hljs-string">'_target'</span>, target)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getattr__</span>(<span class="hljs-params">self, name</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f'[GET ] <span class="hljs-subst">{name}</span>'</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getattr</span>(self._target, name)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__setattr__</span>(<span class="hljs-params">self, name, value</span>):
        <span class="hljs-keyword">if</span> name.startswith(<span class="hljs-string">'_'</span>):
            <span class="hljs-built_in">super</span>().__setattr__(name, value)
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f'[SET ] <span class="hljs-subst">{name}</span> = <span class="hljs-subst">{value}</span>'</span>)
            <span class="hljs-built_in">setattr</span>(self._target, name, value)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__delattr__</span>(<span class="hljs-params">self, name</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f'[DEL ] <span class="hljs-subst">{name}</span>'</span>)
        <span class="hljs-built_in">delattr</span>(self._target, name)
</code></pre>
<h3 data-id="heading-4">1.3 使用演示</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Spam</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, x</span>):      self.x = x
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">bar</span>(<span class="hljs-params">self, y</span>):           <span class="hljs-built_in">print</span>(<span class="hljs-string">'Spam.bar:'</span>, self.x, y)

s = Spam(<span class="hljs-number">2</span>)
p = Proxy(s)

p.x          <span class="hljs-comment"># [GET ] x  → 2</span>
p.x = <span class="hljs-number">37</span>     <span class="hljs-comment"># [SET ] x = 37</span>
p.bar(<span class="hljs-number">3</span>)     <span class="hljs-comment"># [GET ] bar → Spam.bar: 37 3</span>
<span class="hljs-keyword">del</span> p.x      <span class="hljs-comment"># [DEL ] x</span>
</code></pre>
<blockquote>
<p>代理模式在 Python Cookbook 中被官方推荐为“继承的轻量级替代方案”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-5">2. 属性验证 &amp; 转换：把“赋值”做成管道</h2>
<h3 data-id="heading-6">2.1 需求</h3>
<ul>
<li>类型不对就抛错，而不是运行时崩</li>
<li>自动把字符串转数字、大小写归一化</li>
<li>支持“只读”“不可删除”等语义</li>
</ul>
<h3 data-id="heading-7">2.2 实现：描述符 + <code>__setattr__</code> 双保险</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Schema</span>:
    age     = <span class="hljs-built_in">int</span>
    name    = <span class="hljs-built_in">str</span>
    score   = <span class="hljs-built_in">float</span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Validated</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, **kw</span>):
        <span class="hljs-comment"># 真实数据放在 __dict__ 本身，避免递归</span>
        self.__dict__[<span class="hljs-string">'_data'</span>] = {}
        <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> kw.items():
            <span class="hljs-built_in">setattr</span>(self, k, v)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__setattr__</span>(<span class="hljs-params">self, name, value</span>):
        typ = <span class="hljs-built_in">getattr</span>(Schema, name, <span class="hljs-literal">None</span>)
        <span class="hljs-keyword">if</span> typ <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
            <span class="hljs-keyword">raise</span> AttributeError(<span class="hljs-string">f'未知字段 <span class="hljs-subst">{name}</span>'</span>)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">isinstance</span>(value, typ):
            <span class="hljs-keyword">try</span>:
                value = typ(value)
            <span class="hljs-keyword">except</span> (ValueError, TypeError):
                <span class="hljs-keyword">raise</span> TypeError(<span class="hljs-string">f'<span class="hljs-subst">{name}</span> 必须是 <span class="hljs-subst">{typ.__name__}</span>'</span>)
        self._data[name] = value

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getattr__</span>(<span class="hljs-params">self, name</span>):
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">return</span> self._data[name]
        <span class="hljs-keyword">except</span> KeyError:
            <span class="hljs-keyword">raise</span> AttributeError(name)

u = Validated(age=<span class="hljs-string">'18'</span>, name=<span class="hljs-string">'bob'</span>, score=<span class="hljs-string">'99.5'</span>)
<span class="hljs-built_in">print</span>(u.age, u.score)      <span class="hljs-comment"># 18 99.5</span>
u.age = <span class="hljs-string">'20'</span>               <span class="hljs-comment"># 自动转 int</span>
</code></pre>
<blockquote>
<p>该技巧在 attrs/cattrs 等库中大量使用，可节省 70% 的样板代码。</p>
</blockquote>
<hr/>
<h2 data-id="heading-8">3. 延迟加载（Lazy Loading）：让“昂贵”对象按需出生</h2>
<h3 data-id="heading-9">3.1 典型昂贵资源</h3>
<ul>
<li>大模型文件 / 千万级数据库连接</li>
<li>远程网络客户端（gRPC、REST）</li>
<li>重量级 GUI 组件</li>
</ul>
<h3 data-id="heading-10">3.2 装饰器版（类属性）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">lazy_property</span>(<span class="hljs-params">fn</span>):
    <span class="hljs-string">"""类级别延迟加载，结果缓存到实例"""</span>
    attr_name = <span class="hljs-string">'_lazy_'</span> + fn.__name__
<span class="hljs-meta">    @property</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_lazy</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> <span class="hljs-built_in">hasattr</span>(self, attr_name):
            <span class="hljs-built_in">setattr</span>(self, attr_name, fn(self))
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">getattr</span>(self, attr_name)
    <span class="hljs-keyword">return</span> _lazy

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Config</span>:
<span class="hljs-meta">    @lazy_property</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">mysql_pool</span>(<span class="hljs-params">self</span>):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">'&gt;&gt;&gt; 真正创建 MySQL 连接池 …'</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-string">'MySQLPool(...)'</span>
</code></pre>
<h3 data-id="heading-11">3.3 <code>__getattr__</code> 版（动态模块导入）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LazyModule</span>:
    <span class="hljs-string">"""访问时才 import，适用于可选依赖"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getattr__</span>(<span class="hljs-params">self, item</span>):
        <span class="hljs-keyword">if</span> item == <span class="hljs-string">'pd'</span>:
            <span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
            self.pd = pd
            <span class="hljs-keyword">return</span> pd
        <span class="hljs-keyword">raise</span> AttributeError(item)

lm = LazyModule()
lm.pd.DataFrame()   <span class="hljs-comment"># 此处才首次 import pandas</span>
</code></pre>
<blockquote>
<p>延迟加载能把大型 CLI 工具的启动时间缩短 50% 以上。</p>
</blockquote>
<hr/>
<h2 data-id="heading-12">4. ORM 框架实现：把“行”变成“对象”</h2>
<h3 data-id="heading-13">4.1 核心思想</h3>
<p>表 → 类，行 → 实例，字段 → 属性。<br/>
利用 <code>__getattr__</code> / <code>__setattr__</code> 把对属性的访问翻译成 SQL。</p>
<h3 data-id="heading-14">4.2 最小 ORM（仅依赖 sqlite3）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> sqlite3, threading

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Field</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, typ</span>): self.typ = typ

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ModelMeta</span>(<span class="hljs-title class_ inherited__">type</span>):
    <span class="hljs-string">"""元类：扫描属性，收集字段"""</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__new__</span>(<span class="hljs-params">mcls, name, bases, ns</span>):
        <span class="hljs-keyword">if</span> name == <span class="hljs-string">'Model'</span>:               <span class="hljs-comment"># 基类本身不做处理</span>
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>().__new__(mcls, name, bases, ns)
        fields = {k: v <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> ns.items() <span class="hljs-keyword">if</span> <span class="hljs-built_in">isinstance</span>(v, Field)}
        ns[<span class="hljs-string">'_fields'</span>] = fields
        ns[<span class="hljs-string">'_table'</span>] = name.lower()
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>().__new__(mcls, name, bases, ns)

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Model</span>(metaclass=ModelMeta):
    db = sqlite3.connect(<span class="hljs-string">'demo.db'</span>, check_same_thread=<span class="hljs-literal">False</span>)
    db_lock = threading.Lock()

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, **kw</span>):
        <span class="hljs-comment"># 数据保存在 _row，避免与字段名冲突</span>
        self._row = {}
        <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">in</span> kw.items():
            <span class="hljs-built_in">setattr</span>(self, k, v)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__setattr__</span>(<span class="hljs-params">self, name, value</span>):
        <span class="hljs-keyword">if</span> name <span class="hljs-keyword">in</span> self._fields:
            self._row[name] = value
        <span class="hljs-keyword">else</span>:
            <span class="hljs-built_in">super</span>().__setattr__(name, value)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__getattr__</span>(<span class="hljs-params">self, name</span>):
        <span class="hljs-keyword">try</span>:
            <span class="hljs-keyword">return</span> self._row[name]
        <span class="hljs-keyword">except</span> KeyError:
            <span class="hljs-keyword">raise</span> AttributeError(name)

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">save</span>(<span class="hljs-params">self</span>):
        cols = <span class="hljs-string">', '</span>.join(self._row.keys())
        placeholders = <span class="hljs-string">', '</span>.join([<span class="hljs-string">'?'</span>] * <span class="hljs-built_in">len</span>(self._row))
        sql = <span class="hljs-string">f"INSERT INTO <span class="hljs-subst">{self._table}</span> (<span class="hljs-subst">{cols}</span>) VALUES (<span class="hljs-subst">{placeholders}</span>)"</span>
        <span class="hljs-keyword">with</span> self.db_lock:
            self.db.execute(sql, <span class="hljs-built_in">tuple</span>(self._row.values()))
            self.db.commit()

<span class="hljs-comment"># 定义模型</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span>(<span class="hljs-title class_ inherited__">Model</span>):
    <span class="hljs-built_in">id</span>   = Field(<span class="hljs-built_in">int</span>)
    name = Field(<span class="hljs-built_in">str</span>)

<span class="hljs-comment"># 使用</span>
u = User(<span class="hljs-built_in">id</span>=<span class="hljs-number">1</span>, name=<span class="hljs-string">'kimi'</span>)
u.save()          <span class="hljs-comment"># 真实写入 SQLite</span>
</code></pre>
<blockquote>
<p>大型库如 Django ORM、SQLAlchemy 内部同样依赖 <code>__setattr__</code> 做“脏数据跟踪”。</p>
</blockquote>
<hr/>
<h2 data-id="heading-15">5. 性能陷阱 &amp; 调试锦囊</h2>

























<table><thead><tr><th>问题</th><th>现象</th><th>解决</th></tr></thead><tbody><tr><td>无限递归</td><td><code>RecursionError</code></td><td><code>__setattr__</code> 里用 <code>super()</code> 或直接改 <code>__dict__</code></td></tr><tr><td>性能下降</td><td>属性访问慢 3×</td><td>缓存计算结果、用 <code>__slots__</code> 减少字典开销</td></tr><tr><td>调试困难</td><td>断点进不去</td><td>在钩子内加 <code>print</code> / <code>logging</code>，或临时关闭自定义方法</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-16">6. 一张图总结（Mermaid）</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
    A[__getattr__] --&gt; B[代理模式]
    A --&gt; C[延迟加载]
    D[__setattr__] --&gt; E[属性验证]
    D --&gt; F[ORM 脏跟踪]
    G[__delattr__] --&gt; H[保护只读属性]
</code></pre>
<hr/>
<h2 data-id="heading-17">7. 结语</h2>
<p><code>__xxattr__</code> 不是炫技，而是“把本来要写的 100 个 <code>if</code> / <code>try</code> 藏到语言运行时”。<br/>
掌握这四大模式，你就能：</p>
<ul>
<li>写出“自带文档”的类（代理）</li>
<li>让错误在“赋值瞬间”而不是“运行半小时后”爆掉（验证）</li>
<li>把启动时间从 3 s 降到 300 ms（懒加载）</li>
<li>用 200 行代码写个能跑业务的“迷你 Django”（ORM）</li>
</ul>
<p>下次当你敲下 <code>obj.x = y</code> 时，别忘了：背后有一整块魔法世界，等你去点亮。</p>
<hr/>
<blockquote>
<p>参考资料<br/>
: 《Python 实现类属性的延迟加载装饰器》<br/>
: 《Python 性能优化：懒加载与其他高级技巧》<br/>
: 《Python 使用 attrs 和 cattrs 实现面向对象编程》<br/>
: 《Python3 Cookbook 8.15 属性的代理访问》<br/>
: 《浅谈 Python 的元编程》</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[新的一年，多回家看看]]></title>    <link>https://juejin.cn/post/7599506068047347712</link>    <guid>https://juejin.cn/post/7599506068047347712</guid>    <pubDate>2026-01-26T14:48:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599506068047347712" data-draft-id="7599506068047331328" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="新的一年，多回家看看"/> <meta itemprop="keywords" content="前端,设计,API"/> <meta itemprop="datePublished" content="2026-01-26T14:48:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="祯民"/> <meta itemprop="url" content="https://juejin.cn/user/2714061017452557"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            新的一年，多回家看看
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2714061017452557/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    祯民
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T14:48:00.000Z" title="Mon Jan 26 2026 14:48:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>一年有12个月，365天。在外工作的人，每年能回去两三次就不容易了。算下来，从离家开始，和父母亲人见面的次数，其实数得过来。</p>
<p>外公走的时候，像一棵树慢慢落了叶。从还能说笑，到躺在床上，再到变成山上一座坟，前后不过几个月。那时我年轻，也离家远，感情是木的。哭了一场，日子也就糊里糊涂过去了。</p>
<p>后来看到阿里云offer里那条探亲假，心里动了一下，但也没多想——折算成钱，不过多个几千块而已。</p>
<p>直到我真的用起它来。</p>
<p>这一年，我回了二十多次家。厨房的窗，阳台的光，饭桌的位置，都还是老样子。可外婆不一样了。她耳朵背了，常常听错话；眼神有时空空的，望着门外。有一次她喃喃自语，我才知道她心里熬着多苦的念头。</p>
<p>而我呢？工作以后，眼里只有目标、成长、效率。我把日子过成了一张清单，却忘了情感需要养护，人需要彼此看见。</p>
<p>如果没有这二十多次推开家门，我大概还在自己的轨道上赶路，看不见至亲的时光正在加速流逝。这些零碎的归来，对很多人来说，已是好几年的分量。</p>
<p>昨晚陪外婆在阳台站了一会儿。风凉凉的，她稀疏的白发被轻轻吹起。我忽然想起毕业那年，自己暗暗想过：等有能力了，一定要把家人护在身后。</p>
<p>可后来，“有能力”变成了一个越来越远的目标，当初想护着的人，却在我奔赴目标的路上悄悄老了。</p>
<p>如今我才懂，那份offer里最重的，不是那几千块钱，而是它把“常回家看看”这句话，变成了我日程表里一行真切的安排。这二十几趟归途，像一根细细的线，把我从漂浮的半空，一次次拉回这片扎实的土地上。</p>
<p>让我不至于在某天忽然醒过来时，发现自己已经站在了告别的那一头，手里什么也没握住，只剩满腔来不及。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[使用 && 整合事件，简化代码]]></title>    <link>https://juejin.cn/post/7599483314160730131</link>    <guid>https://juejin.cn/post/7599483314160730131</guid>    <pubDate>2026-01-26T13:32:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599483314160730131" data-draft-id="7598587406708129833" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="使用 &amp;&amp; 整合事件，简化代码"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-26T13:32:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="剪刀石头布啊"/> <meta itemprop="url" content="https://juejin.cn/user/1855631360014798"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            使用 &amp;&amp; 整合事件，简化代码
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1855631360014798/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    剪刀石头布啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T13:32:28.000Z" title="Mon Jan 26 2026 13:32:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>js 中 &amp;&amp; 和 || 使用好了，有时候能够将我们的代码写的更舒服，甚至逻辑更加清晰，合理的利用他们，能让我们的代码看起来含金量更高一些</p>
<p>ps：当然不一定是真的含金量高很多，如果对于用习惯的来说，确实逻辑更紧密了，个人减少了很多代码和多余判断😄</p>
<p>&amp;&amp; 是返回符合条件的最后一项或不符合的第一项 || 是返回符合条件的第一项或不符合的最后一项</p>
<p>这里就使用 &amp;&amp; 举个案例， || 相信遇到合适场景，自己就知道咋回事了</p>
<h2 data-id="heading-1">案例</h2>
<p>我有一个弹窗，点击确定后，将选中内容后回调给外部，否则提示请选择数据</p>
<p>让ai帮我写这一块代码，是这样的，简单粗暴易懂</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//pageInfo 和 onOk 已经定义好了</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">onComplete</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> { dataSource, key } = pageInfo;
  <span class="hljs-keyword">if</span> (dataSource &amp;&amp; dataSource.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp; key) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Modal</span>.<span class="hljs-title function_">info</span>({
      <span class="hljs-attr">title</span>: <span class="hljs-string">'信息'</span>,
      <span class="hljs-attr">content</span>: <span class="hljs-string">'请选择一条数据'</span>,
    });
  }
  <span class="hljs-keyword">const</span> record = dataSource.<span class="hljs-title function_">find</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">key</span> === key);
  <span class="hljs-keyword">if</span> (!record) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Modal</span>.<span class="hljs-title function_">info</span>({
      <span class="hljs-attr">title</span>: <span class="hljs-string">'信息'</span>,
      <span class="hljs-attr">content</span>: <span class="hljs-string">'请选择一条数据'</span>,
    });
  }
  onOk &amp;&amp; <span class="hljs-title function_">onOk</span>(record);
}
</code></pre>
<p>下面我是这么写的，不想多写提示了，合理利用 &amp;&amp; 会返回符合条件最后一项特性来实现，看起来似乎好了一点点</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//pageInfo 和 onOk 已经定义好了</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">onComplete</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-keyword">const</span> { dataSource, key } = pageInfo;
  <span class="hljs-keyword">const</span> hasSelectedData =
    dataSource &amp;&amp;
    dataSource.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> &amp;&amp;
    key &amp;&amp;
    dataSource.<span class="hljs-title function_">find</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">key</span> === key);  
  <span class="hljs-keyword">if</span> (!hasSelectedData) {
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Modal</span>.<span class="hljs-title function_">info</span>({
      <span class="hljs-attr">title</span>: <span class="hljs-string">"信息"</span>,
      <span class="hljs-attr">content</span>: <span class="hljs-string">"请选择一条数据"</span>,
    });
  }
  onOk &amp;&amp; <span class="hljs-title function_">onOk</span>(ifs.<span class="hljs-title function_">pop</span>());
};
</code></pre>
<h2 data-id="heading-2">最后</h2>
<p>普通的代码蕴含着我们对于代码的一些追求，你觉得什么样的代码好呢，反正我的ai感觉我的代码是屎，给我改了😄</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[script标签有哪些常用属性，作用分别是啥]]></title>    <link>https://juejin.cn/post/7599483794657574953</link>    <guid>https://juejin.cn/post/7599483794657574953</guid>    <pubDate>2026-01-26T13:32:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599483794657574953" data-draft-id="7597693638922993727" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="script标签有哪些常用属性，作用分别是啥"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-01-26T13:32:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="剪刀石头布啊"/> <meta itemprop="url" content="https://juejin.cn/user/1855631360014798"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            script标签有哪些常用属性，作用分别是啥
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1855631360014798/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    剪刀石头布啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T13:32:40.000Z" title="Mon Jan 26 2026 13:32:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>前端开发中，离不开的就是script脚本的执行，html中嵌入script标签，我们的js脚本才能正常执行，正是因为有了它，前端的页面变得更加灵活了(不是纯静态页面了)</p>
<h2 data-id="heading-1">简介</h2>
<p>常用属性：</p>
<p><strong>src</strong>：脚本引用资源地址，可以是远端，也可以是本地路径的资源</p>
<pre><code class="hljs language-js" lang="js">&lt;script src=<span class="hljs-string">"https://example.com/script.js"</span>&gt;&lt;/script&gt;

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"./common.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span>
</code></pre>
<p><strong>type</strong>: script类型，HTML5 默认为 text/javascript，也基本上很少主动设置了，为了兼容性可以设置</p>
<p>crossorigin：跨域属性 "anonymous"(匿名)、"use-credentials"(使用身份令牌验证)</p>
<pre><code class="hljs language-js" lang="js">&lt;script src=<span class="hljs-string">"https://example.com/script.js"</span> crossorigin=<span class="hljs-string">"anonymous"</span>&gt;&lt;/script&gt;
</code></pre>
<p><strong>async</strong>: 异步(延迟)执行脚本</p>
<ul>
<li>
<p>脚本下载时不阻塞 HTML 解析</p>
</li>
<li>
<p>下载完成后立即执行</p>
</li>
<li>
<p><strong>执行顺序不保证</strong></p>
</li>
</ul>
<p><strong>defer</strong>:  异步(延迟)执行脚本</p>
<ul>
<li>
<p>脚本下载时不阻塞 HTML 解析</p>
</li>
<li>
<p>HTML 解析完成后才执行</p>
</li>
<li>
<p><strong>按顺序执行多个 defer 脚本</strong></p>
</li>
</ul>
<p><strong>integrity</strong>：子资源完整性验证，防止恶意更改文件来执行潜在攻击</p>
<p>例如：script可能来自cdn提速，但是为了避免被人篡改过，于是使用算法加密，提前设定好脚本加密后的结果，浏览器下载后会将资源加密后进行对比，一致时执行，可以减少被攻击的可能</p>
<pre><code class="hljs language-js" lang="js">常用算法有 <span class="hljs-string">`sha256`</span>、<span class="hljs-string">`sha384`</span>、<span class="hljs-string">`sha512`</span>（不推荐 md5/sha1，安全性低）。

&lt;script 
    src=<span class="hljs-string">"https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"</span> 
    integrity=<span class="hljs-string">"sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="</span> 
    crossorigin=<span class="hljs-string">"anonymous"</span>
    /&gt;
    
</code></pre>
<p>生成sha256哈希值</p>
<pre><code class="hljs language-js" lang="js">cat script.<span class="hljs-property">js</span> | openssl dgst -sha256 -binary | base64 # 生成sha384哈希值
</code></pre>
<h2 data-id="heading-2">最后</h2>
<p>实际常用的就这么多，且前几个最常用(老代码中比较常见)</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[写一个简易的数字转中文功能]]></title>    <link>https://juejin.cn/post/7599511763987136566</link>    <guid>https://juejin.cn/post/7599511763987136566</guid>    <pubDate>2026-01-26T13:33:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599511763987136566" data-draft-id="7553638089333637183" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="写一个简易的数字转中文功能"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-26T13:33:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="剪刀石头布啊"/> <meta itemprop="url" content="https://juejin.cn/user/1855631360014798"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            写一个简易的数字转中文功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1855631360014798/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    剪刀石头布啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T13:33:36.000Z" title="Mon Jan 26 2026 13:33:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>今天我们写一个一个简易的数字转中文的效果，虽然是功能看起来很简单，但是要是没有写过这类功能的话，那么可能会无从下手，下面就简单讲一下写这类逻辑的过程</p>
<h2 data-id="heading-1">思路</h2>
<p>实现简易思路：</p>
<ol>
<li>大单位是以万、亿、兆等为单位的，4位小数一组，因此需要对数字进行四位一组分组操作，在后面追加单位即可</li>
<li>除了大单位，中间的小单位则是个十百千，基本都是一致，因此使用同一种统一处理方案，其中个位没有单位</li>
<li>除了单位还有每一位数字的翻译工作，即：<code>0~9</code> =&gt; <code>零~九</code></li>
<li>淡出处理中文语法中特有的情况，例如：开头不显示一十而是十，零中间作为间隔只能有一个，连续的零没有大单位，以及各位为零的处理等</li>
<li>入参处理(这里简单处理一下)</li>
</ol>
<h2 data-id="heading-2">代码实现</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//数字转中文(要支持小数，可以在扩展，小数就比较简单了)</span>
<span class="hljs-comment">//入参为数字，因此不考虑开头为零的情</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">convertChineseNumber</span> = (<span class="hljs-params">number</span>) =&gt; {
  <span class="hljs-keyword">if</span> (<span class="hljs-built_in">isNaN</span>(number)) <span class="hljs-keyword">return</span> <span class="hljs-string">"NAN"</span>;

  <span class="hljs-keyword">const</span> units = [<span class="hljs-string">""</span>, <span class="hljs-string">"万"</span>, <span class="hljs-string">"亿"</span>, <span class="hljs-string">"兆"</span>, <span class="hljs-string">"京"</span>, <span class="hljs-string">"垓"</span>];
  <span class="hljs-keyword">const</span> baseUnits = [<span class="hljs-string">""</span>, <span class="hljs-string">"十"</span>, <span class="hljs-string">"百"</span>, <span class="hljs-string">"千"</span>];
  <span class="hljs-keyword">const</span> cNumbers = [<span class="hljs-string">"零"</span>, <span class="hljs-string">"一"</span>, <span class="hljs-string">"二"</span>, <span class="hljs-string">"三"</span>, <span class="hljs-string">"四"</span>, <span class="hljs-string">"五"</span>, <span class="hljs-string">"六"</span>, <span class="hljs-string">"七"</span>, <span class="hljs-string">"八"</span>, <span class="hljs-string">"九"</span>];
  
  <span class="hljs-comment">//分割四位一组，反转数组，从后往前加单位</span>
  <span class="hljs-keyword">const</span> numGroup = <span class="hljs-title class_">String</span>(number)
    .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\B(?=(\d{4})+$)/g</span>, <span class="hljs-string">" "</span>)  <span class="hljs-comment">//使用前瞻运算符来处理四位一体</span>
    .<span class="hljs-title function_">split</span>(<span class="hljs-string">" "</span>)
    .<span class="hljs-title function_">reverse</span>();
  <span class="hljs-keyword">let</span> result = <span class="hljs-string">""</span>;
  <span class="hljs-comment">//遍历从后往前加单位</span>
  numGroup.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">numStrings, idx</span>) =&gt;</span> {
    <span class="hljs-comment">//处理全零的情况，不应该带单位，由于需要间隔0的情况，保留一个零</span>
    <span class="hljs-keyword">if</span> (numStrings === <span class="hljs-string">"0000"</span>) {
      result = <span class="hljs-string">'零'</span> + result
      <span class="hljs-keyword">return</span>;
    }
    <span class="hljs-comment">//有数的先添加大单位</span>
    result = units[idx] + result;
    <span class="hljs-comment">//分割四位一组的小数字，仍然是反转，从后往前加单位</span>
    numStrings
      .<span class="hljs-title function_">split</span>(<span class="hljs-string">""</span>)
      .<span class="hljs-title function_">reverse</span>()
      .<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">item, idx</span>) =&gt;</span> {
        <span class="hljs-comment">//处理每个后面的单位，其中个位没有单位，0也没有单位</span>
        <span class="hljs-keyword">if</span> (idx !== <span class="hljs-number">0</span> &amp;&amp; item !== <span class="hljs-string">"0"</span>) {
          result = baseUnits[idx] + result;
        }
        <span class="hljs-comment">//数字翻译</span>
        result = cNumbers[<span class="hljs-title class_">Number</span>(item)] + result;
      });
  });
  <span class="hljs-comment">//处理结果中可能存在的中文读写问题，例如不会存在连续的零，开头不会一十</span>
  <span class="hljs-comment">//零后面不应该有单位，非零整数结尾不会读零</span>
  <span class="hljs-keyword">return</span> result
    .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/零+/g</span>, <span class="hljs-string">"零"</span>)
    .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/^(一十)/</span>, <span class="hljs-string">"十"</span>)
    .<span class="hljs-title function_">replace</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-string">`零([<span class="hljs-subst">${units.join(<span class="hljs-string">""</span>)}</span>]{1})`</span>, <span class="hljs-string">"g"</span>), <span class="hljs-string">"$1"</span>) <span class="hljs-comment">//小单位处理了大单位也要处理</span>
    .<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/(.+)零$/</span>, <span class="hljs-string">"$1"</span>)
};
</code></pre>
<h2 data-id="heading-3">测试案例</h2>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//我们试验几个案例</span>
<span class="hljs-keyword">const</span> numbers = [
  <span class="hljs-title function_">convertChineseNumber</span>(<span class="hljs-number">0</span>),
  <span class="hljs-title function_">convertChineseNumber</span>(<span class="hljs-number">1234567899</span>),
  <span class="hljs-title function_">convertChineseNumber</span>(<span class="hljs-number">101234567899</span>),
  <span class="hljs-title function_">convertChineseNumber</span>(<span class="hljs-number">100234567899</span>),
  <span class="hljs-title function_">convertChineseNumber</span>(<span class="hljs-number">101034567899</span>),
  <span class="hljs-title function_">convertChineseNumber</span>(<span class="hljs-number">101030067899</span>),
  <span class="hljs-title function_">convertChineseNumber</span>(<span class="hljs-number">101030067890</span>),
  <span class="hljs-title function_">convertChineseNumber</span>(<span class="hljs-number">101030007899</span>),
  <span class="hljs-title function_">convertChineseNumber</span>(<span class="hljs-number">100000007899</span>),
  <span class="hljs-title function_">convertChineseNumber</span>(<span class="hljs-number">100070007899</span>),
  <span class="hljs-title function_">convertChineseNumber</span>(<span class="hljs-number">100007007899</span>),
];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(numbers);

<span class="hljs-comment">//目前来看返回结果是对的，如果感觉哪里不对，可以在填填补补就行了</span>
[
  <span class="hljs-string">'零'</span>,
  <span class="hljs-string">'十二亿三千四百五十六万七千八百九十九'</span>,
  <span class="hljs-string">'一千零一十二亿三千四百五十六万七千八百九十九'</span>,
  <span class="hljs-string">'一千零二亿三千四百五十六万七千八百九十九'</span>,
  <span class="hljs-string">'一千零一十亿三千四百五十六万七千八百九十九'</span>,
  <span class="hljs-string">'一千零一十亿三千零六万七千八百九十九'</span>,
  <span class="hljs-string">'一千零一十亿三千零六万七千八百九十'</span>,
  <span class="hljs-string">'一千零一十亿三千万七千八百九十九'</span>,
  <span class="hljs-string">'一千亿零七千八百九十九'</span>,
  <span class="hljs-string">'一千亿七千万七千八百九十九'</span>,
  <span class="hljs-string">'一千亿零七百万七千八百九十九'</span>
]
</code></pre>
<h2 data-id="heading-4">最后</h2>
<p>上面的整体思路还是可以得，实际还是有所欠缺的，例如：不支持小数，对于大数字的单位支持也不够多，甚至一些读法的场景可能考虑还不够完善</p>
<p>需要完善的话，实际按照上面思路补充一下就行了</p>
<p>本篇就介绍到这里了</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手写 Promise.all]]></title>    <link>https://juejin.cn/post/7599483314160746515</link>    <guid>https://juejin.cn/post/7599483314160746515</guid>    <pubDate>2026-01-26T13:34:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599483314160746515" data-draft-id="7568319637000781824" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手写 Promise.all"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-01-26T13:34:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="剪刀石头布啊"/> <meta itemprop="url" content="https://juejin.cn/user/1855631360014798"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手写 Promise.all
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1855631360014798/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    剪刀石头布啊
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T13:34:15.000Z" title="Mon Jan 26 2026 13:34:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>Promise 是 JavaScript 中非常重要的一个功能，他可以让我们异步的去处理一些事情，尤其是对于一些比较耗时的操作，其非常重要，当然一些不耗时的操作，有事就没必要使用它了，毕竟会带来额外的性能开销</p>
<h2 data-id="heading-1">Promise.all</h2>
<p>Promise.all 是 js 中个一个静态方法，尤其是写业务对接后端的时候，会经常见到，不管是写后端异步签名，还是前端接口请求，其主要用来聚合一组成功的结果</p>
<p>相比于 promise 其他系列，这个算是比较简单了(当然 race 更简单就不介绍了)</p>
<p>下面简单陈述 Promise.all 手写的几个关键单</p>
<ol>
<li>all 是一个静态方法，因此不能像写对象的原型链 prototype一样写</li>
<li>promise 状态从 pending 变更为 fulfilled 或者 rejected 只能发生一次，因此无需考虑多次回调 reject 的问题</li>
<li>遍历 promises 数组的时候，遍历的是所有可迭代对象，因此 for...of 非常适合</li>
</ol>
<p><strong>tips</strong>: 可以通过 promise 函数回调赋值的方式减少嵌套层级</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">//声明一个静态方法</span>
<span class="hljs-title class_">Promise</span>.<span class="hljs-property">myAll</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params">promises</span>) {
    <span class="hljs-keyword">let</span> resolve, reject;
    <span class="hljs-comment">//构造一个新的promise,赋值可以减少嵌套层级</span>
    <span class="hljs-keyword">const</span> completePromise = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">res, rej</span>) =&gt;</span> {
        resolve = res;
        reject = rej;
    })
    <span class="hljs-keyword">const</span> results = [];
    <span class="hljs-keyword">const</span> length = promises.<span class="hljs-property">length</span>;
    <span class="hljs-keyword">let</span> completedCount = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">let</span> idx = <span class="hljs-number">0</span>
    <span class="hljs-comment">//tips: promise 状态从 pending 变更为 fulfilled 或者 rejected 只能发生一次</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> item <span class="hljs-keyword">of</span> promises) {
        <span class="hljs-comment">//使用一个临时变量接收 idx 避免补货到外部同一个索引</span>
        <span class="hljs-keyword">const</span> currentIndex = idx;
        <span class="hljs-comment">//item可能不是promise，所以用Promise.resolve包一下</span>
        <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(item).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> {
            results[currentIndex] = value;
            completedCount++;
            <span class="hljs-comment">//全部成功标记成功</span>
            <span class="hljs-keyword">if</span> (completedCount === length) {
                <span class="hljs-title function_">resolve</span>(results);
            }
        }).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
            <span class="hljs-comment">//有一个返回err就行了，promise状态只会变更一次</span>
            <span class="hljs-title function_">reject</span>(err);
        })
        idx++;
    }
    <span class="hljs-keyword">return</span> completePromise;
}
</code></pre>
<p>下面测试一下结果，非常正确</p>
<pre><code class="hljs language-js" lang="js">
<span class="hljs-keyword">const</span> <span class="hljs-title function_">test</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-keyword">const</span> p1 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-title function_">resolve</span>(<span class="hljs-number">1</span>)
        }, <span class="hljs-number">1000</span>)
    });
    <span class="hljs-keyword">const</span> p2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-title function_">resolve</span>(<span class="hljs-number">2</span>)
        }, <span class="hljs-number">2000</span>)
    });
    <span class="hljs-keyword">const</span> p3 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
            <span class="hljs-comment">// reject('error 3')</span>
            <span class="hljs-title function_">resolve</span>(<span class="hljs-number">3</span>)
        }, <span class="hljs-number">1500</span>)
    });
    <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">myAll</span>([p1, p2, p3]).<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'res'</span>, res)
    }).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'err'</span>, err)
    })
}

<span class="hljs-title function_">test</span>();
</code></pre>
<p>这篇文章就讲到这里了，由于内容相对简单，就不多介绍了</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[那个猝死的程序员，在抢救时被拉进了工作群]]></title>    <link>https://juejin.cn/post/7599450177058160650</link>    <guid>https://juejin.cn/post/7599450177058160650</guid>    <pubDate>2026-01-26T11:40:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599450177058160650" data-draft-id="7599543345980407835" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="那个猝死的程序员，在抢救时被拉进了工作群"/> <meta itemprop="keywords" content="程序员"/> <meta itemprop="datePublished" content="2026-01-26T11:40:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序员一点"/> <meta itemprop="url" content="https://juejin.cn/user/3802528978305192"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            那个猝死的程序员，在抢救时被拉进了工作群
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3802528978305192/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序员一点
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T11:40:36.000Z" title="Mon Jan 26 2026 11:40:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>生命无法重启，健康才是最高优先级</p>
</blockquote>
<p>2025年11月29日，周六，32岁的程序员高广辉在家中对妻子说“有点不舒服，要到客厅处理一下工作”后晕倒。在送医抢救过程中，他的手机屏幕依然亮着——<strong>他被拉入了一个新的微信技术群</strong>，群里同事正在@他处理工作。</p>
<p>当天13:00，高广辉被宣告临床死亡。死亡8小时后，他的微信再次收到消息：“周一一早有急任务，今天验货不过，要把这个改下”。</p>
<p><img src="https://foruda.gitee.com/images/1769427463353492230/29124b8c_10826153.png" alt="" title="20260126193540.png" loading="lazy"/></p>
<h2 data-id="heading-0">一个程序员的最后一周</h2>
<p>在高广辉生命的最后一周，工作日最早到家时间是<strong>21:38</strong>，最晚是<strong>22:47</strong>。他的浏览器记录显示，在猝死当天，这位部门经理至少<strong>5次访问了公司OA系统</strong>——尽管那天是周六。</p>
<p>妻子回忆，高广辉生前常说“好累好累，好想被炒掉”。调到一个新部门后，他的工作量翻了三倍，却因公司裁员而无人分担。他从“几分钟回复消息”变成“上午发消息，下午才回复”。</p>
<p><strong>“今天没做完的工作，明天可以继续，但透支的生命无法重启。”</strong> 这是高广辉妻子在他去世后发布的视频中的一句话。这话戳中了许多程序员的痛点。</p>
<h2 data-id="heading-1">我们都在透支什么？</h2>
<p>高广辉的工位上摆放着三块屏幕，桌下备有拖鞋和行军床。这种场景对程序员来说再熟悉不过。</p>
<p>他的薪酬结构是“低底薪、高绩效”，底薪仅3000余元，必须靠拼命加班才能拿到可观的月薪。公司推崇的“无边界协作”文化，使得工作和生活的界限变得模糊。</p>
<p><strong>我们是否也陷入了这种“自愿加班”的循环？</strong> 为了项目上线，为了绩效考核，为了不被替代，我们不断压缩睡眠时间，牺牲健康与家庭。</p>
<p>高广辉曾在他的GitHub项目中贴出“反996”标签，希望自己的代码能帮助同行们“不要被上头任务压得喘不过气”。讽刺的是，他最终却被过度工作压垮。</p>
<h2 data-id="heading-2">生命的优先级高于代码</h2>
<p>作为程序员，我们都明白<strong>优先级</strong>的重要性。但当工作不断抢占生命的高优先级位置时，系统终会崩溃。</p>
<p>高广辉的案例之所以引发广泛共鸣，是因为它反映了程序员群体普遍面临的困境：<strong>弹性工作制变成24小时待命</strong>，企业微信消息深夜不断，周末被隐形加班占据。</p>
<p>他的病历“既往史”一栏写着：“程序员经常熬夜”。这何尝不是许多程序员的共同“病史”？</p>
<h2 data-id="heading-3">重新定义成功与奋斗</h2>
<p>高广辉的遗物中有一本书：《恭喜你当上主管了》。他努力向上，28岁晋升部门经理，却最终付出了生命的代价。</p>
<p><strong>如果“成功”需要以健康、家庭和生命为代价，它还是成功吗？</strong></p>
<p>真正的技术成长不应该建立在身体透支的基础上。高效的代码不是靠熬夜熬出来的，而是源于清晰的思路和良好的状态。</p>
<h2 data-id="heading-4">从今天起，请珍爱自己</h2>
<p>高广辉的妻子说，如果时光可以倒流，一定会坚持让他辞掉工作。但生命没有如果。</p>
<p>在此，我想对每一位程序员同行说：</p>
<ol>
<li>
<p><strong>你的健康是第一位的需求</strong>：没有任何项目值得你用健康去交换。设定工作边界，学会说“不”。</p>
</li>
<li>
<p><strong>离线休息权是你应得的权利</strong>：下班后，你有权不回复工作消息。有电话呼进来了，你可以不接的。</p>
</li>
<li>
<p><strong>警惕“低底薪、高绩效”的陷阱</strong>：这种薪酬结构本质上是在鼓励透支生命。评估工作是否值得时，请算上健康成本。程序员本身就应该是固定工资，又不是销售，哪有什么底薪+绩效的说法。</p>
</li>
<li>
<p><strong>定期体检，重视身体信号</strong>：高广辉在2024年6月的体检还显示正常，但身体已经发出警报。</p>
</li>
<li>
<p><strong>重新定义你的成长路径</strong>：技术的提升不应该以健康为代价。可持续的职业发展才是真正的成长。</p>
</li>
</ol>
<h2 data-id="heading-5">生命无法重启，请好好生活</h2>
<p>在程序的世界的里，我们可以容忍失败，重启重来。但生命只有一次，<strong>没有Ctrl+Z</strong>。</p>
<p>高广辉的故事令人心痛，但也应成为我们反思的契机。每一位程序员都值得被温柔以待，包括我们自己。请你千万千万不要把这个新闻当成故事来看待了，如果你也一直在高压下工作，那么真请善待一下自己，真的真的真的。</p>
<p><strong>今天没做完的工作，明天可以继续，但透支的生命无法重启。</strong> 请好好生活，因为你的代码世界需要健康的你来书写。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（65）如何在微服务架构中使用Hibernate？]]></title>    <link>https://juejin.cn/post/7599528186587070474</link>    <guid>https://juejin.cn/post/7599528186587070474</guid>    <pubDate>2026-01-26T11:50:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599528186587070474" data-draft-id="7599543345980456987" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（65）如何在微服务架构中使用Hibernate？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-26T11:50:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（65）如何在微服务架构中使用Hibernate？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T11:50:39.000Z" title="Mon Jan 26 2026 11:50:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在微服务架构中使用Hibernate涉及多个步骤，包括配置项目依赖、设置数据源、配置Hibernate、定义实体类、创建DAO层、创建服务层、以及编写应用逻辑。每个微服务通常独立部署和运行，其数据库和ORM配置也独立于其他微服务。下面是详细的实现步骤和代码示例。</p>
<h3 data-id="heading-0">1. 项目依赖</h3>
<p>首先，在微服务的构建文件中添加必要的依赖项。例如，如果你使用的是Maven来构建项目，可以在<code>pom.xml</code>中添加以下依赖项：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Hibernate Core --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.hibernate<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hibernate-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.4.32.Final<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- JPA API --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.persistence<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javax.persistence-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- HikariCP for Connection Pooling --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.zaxxer<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>HikariCP<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- MySQL Connector --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.26<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Spring Data JPA if using Spring Boot --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-1">2. 配置数据源</h3>
<p>在微服务中配置数据源和Hibernate属性。假设我们使用Spring Boot来简化配置：</p>
<h4 data-id="heading-2"><code>application.properties</code></h4>
<pre><code class="hljs language-properties" lang="properties">spring.datasource.url=jdbc:mysql://localhost:3306/mydatabase
spring.datasource.username=root
spring.datasource.password=rootpassword
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQLDialect
</code></pre>
<h3 data-id="heading-3">3. 配置Hibernate的SessionFactory</h3>
<p>Spring Boot会自动配置<code>SessionFactory</code>，如果你使用其他框架，可能需要手动配置。</p>
<h3 data-id="heading-4">4. 定义实体类</h3>
<p>定义一个简单的实体类，例如<code>User</code>。</p>
<h4 data-id="heading-5"><code>User.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> javax.persistence.Entity;
<span class="hljs-keyword">import</span> javax.persistence.GeneratedValue;
<span class="hljs-keyword">import</span> javax.persistence.GenerationType;
<span class="hljs-keyword">import</span> javax.persistence.Id;
<span class="hljs-keyword">import</span> javax.persistence.Table;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String password;

    <span class="hljs-comment">// Getters and Setters</span>
    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> username;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUsername</span><span class="hljs-params">(String username)</span> {
        <span class="hljs-built_in">this</span>.username = username;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> password;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPassword</span><span class="hljs-params">(String password)</span> {
        <span class="hljs-built_in">this</span>.password = password;
    }
}
</code></pre>
<h3 data-id="heading-6">5. 创建DAO层</h3>
<p>创建一个数据访问对象（DAO）接口和实现类，用于访问数据库。如果使用Spring Data JPA，可以简化为一个接口。</p>
<h4 data-id="heading-7"><code>UserRepository.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaRepository</span>&lt;User, Long&gt; {
    User <span class="hljs-title function_">findByUsername</span><span class="hljs-params">(String username)</span>;
}
</code></pre>
<h3 data-id="heading-8">6. 创建服务层</h3>
<p>创建一个服务类，用于处理业务逻辑。</p>
<h4 data-id="heading-9"><code>UserService.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserRepository userRepository;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserService</span><span class="hljs-params">(UserRepository userRepository)</span> {
        <span class="hljs-built_in">this</span>.userRepository = userRepository;
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">createUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-keyword">return</span> userRepository.save(user);
    }

    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">return</span> userRepository.findById(id).orElse(<span class="hljs-literal">null</span>);
    }

    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getAllUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> userRepository.findAll();
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">updateUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-keyword">return</span> userRepository.save(user);
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(Long id)</span> {
        userRepository.deleteById(id);
    }
}
</code></pre>
<h3 data-id="heading-10">7. 编写控制器</h3>
<p>利用上述服务类来编写RESTful API控制器。</p>
<h4 data-id="heading-11"><code>UserController.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.http.ResponseEntity;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserService userService;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserController</span><span class="hljs-params">(UserService userService)</span> {
        <span class="hljs-built_in">this</span>.userService = userService;
    }

    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;User&gt; <span class="hljs-title function_">createUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">createdUser</span> <span class="hljs-operator">=</span> userService.createUser(user);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(createdUser);
    }

    <span class="hljs-meta">@GetMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;User&gt; <span class="hljs-title function_">getUserById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.getUserById(id);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(user);
    }

    <span class="hljs-meta">@GetMapping</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;List&lt;User&gt;&gt; <span class="hljs-title function_">getAllUsers</span><span class="hljs-params">()</span> {
        List&lt;User&gt; users = userService.getAllUsers();
        <span class="hljs-keyword">return</span> ResponseEntity.ok(users);
    }

    <span class="hljs-meta">@PutMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;User&gt; <span class="hljs-title function_">updateUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id, <span class="hljs-meta">@RequestBody</span> User user)</span> {
        user.setId(id);
        <span class="hljs-type">User</span> <span class="hljs-variable">updatedUser</span> <span class="hljs-operator">=</span> userService.updateUser(user);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(updatedUser);
    }

    <span class="hljs-meta">@DeleteMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Void&gt; <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        userService.deleteUser(id);
        <span class="hljs-keyword">return</span> ResponseEntity.noContent().build();
    }
}
</code></pre>
<h3 data-id="heading-12">总结</h3>
<p>通过上述步骤，我们在微服务架构中使用了Hibernate，配置了数据源，定义了实体类，创建了DAO层和服务层，并编写了RESTful API控制器。这使得每个微服务可以独立地进行数据库操作，实现了完整的CRUD功能。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Hibernate（66）如何在分布式系统中使用Hibernate？]]></title>    <link>https://juejin.cn/post/7599528186587086858</link>    <guid>https://juejin.cn/post/7599528186587086858</guid>    <pubDate>2026-01-26T11:51:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599528186587086858" data-draft-id="7599478406238388233" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Hibernate（66）如何在分布式系统中使用Hibernate？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-01-26T11:51:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Hibernate（66）如何在分布式系统中使用Hibernate？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T11:51:26.000Z" title="Mon Jan 26 2026 11:51:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在分布式系统中使用Hibernate需要考虑多个方面，包括数据源配置、数据一致性、事务管理、以及各服务之间的通信和协调。分布式系统的关键特点是多个独立的服务（或微服务）各自处理自己的数据存储和业务逻辑。以下是详细的实现步骤和代码示例。</p>
<h3 data-id="heading-0">1. 项目依赖</h3>
<p>首先，在每个服务的构建文件中添加必要的依赖项。例如，如果你使用的是Maven来构建项目，可以在<code>pom.xml</code>中添加以下依赖项：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- Hibernate Core --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.hibernate<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>hibernate-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.4.32.Final<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- JPA API --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>javax.persistence<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>javax.persistence-api<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- HikariCP for Connection Pooling --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.zaxxer<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>HikariCP<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>4.0.3<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- MySQL Connector --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>mysql<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mysql-connector-java<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>8.0.26<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Spring Data JPA if using Spring Boot --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
</code></pre>
<h3 data-id="heading-1">2. 配置数据源</h3>
<p>在每个微服务中配置数据源和Hibernate属性。假设我们使用Spring Boot来简化配置：</p>
<h4 data-id="heading-2"><code>application.properties</code></h4>
<pre><code class="hljs language-properties" lang="properties">spring.datasource.url=jdbc:mysql://localhost:3306/mydatabase
spring.datasource.username=root
spring.datasource.password=rootpassword
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver

spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.MySQLDialect
</code></pre>
<h3 data-id="heading-3">3. 配置Hibernate的SessionFactory</h3>
<p>Spring Boot会自动配置<code>SessionFactory</code>，如果你使用其他框架，可能需要手动配置。</p>
<h3 data-id="heading-4">4. 定义实体类</h3>
<p>定义一个简单的实体类，例如<code>User</code>。</p>
<h4 data-id="heading-5"><code>User.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> javax.persistence.Entity;
<span class="hljs-keyword">import</span> javax.persistence.GeneratedValue;
<span class="hljs-keyword">import</span> javax.persistence.GenerationType;
<span class="hljs-keyword">import</span> javax.persistence.Id;
<span class="hljs-keyword">import</span> javax.persistence.Table;

<span class="hljs-meta">@Entity</span>
<span class="hljs-meta">@Table(name = "users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
    <span class="hljs-meta">@Id</span>
    <span class="hljs-meta">@GeneratedValue(strategy = GenerationType.IDENTITY)</span>
    <span class="hljs-keyword">private</span> Long id;

    <span class="hljs-keyword">private</span> String username;
    <span class="hljs-keyword">private</span> String password;

    <span class="hljs-comment">// Getters and Setters</span>
    <span class="hljs-keyword">public</span> Long <span class="hljs-title function_">getId</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> id;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setId</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-built_in">this</span>.id = id;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getUsername</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> username;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUsername</span><span class="hljs-params">(String username)</span> {
        <span class="hljs-built_in">this</span>.username = username;
    }

    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getPassword</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> password;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPassword</span><span class="hljs-params">(String password)</span> {
        <span class="hljs-built_in">this</span>.password = password;
    }
}
</code></pre>
<h3 data-id="heading-6">5. 创建DAO层</h3>
<p>创建一个数据访问对象（DAO）接口和实现类，用于访问数据库。如果使用Spring Data JPA，可以简化为一个接口。</p>
<h4 data-id="heading-7"><code>UserRepository.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;

<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserRepository</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">JpaRepository</span>&lt;User, Long&gt; {
    User <span class="hljs-title function_">findByUsername</span><span class="hljs-params">(String username)</span>;
}
</code></pre>
<h3 data-id="heading-8">6. 创建服务层</h3>
<p>创建一个服务类，用于处理业务逻辑。</p>
<h4 data-id="heading-9"><code>UserService.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.stereotype.Service;
<span class="hljs-keyword">import</span> org.springframework.transaction.annotation.Transactional;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserRepository userRepository;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserService</span><span class="hljs-params">(UserRepository userRepository)</span> {
        <span class="hljs-built_in">this</span>.userRepository = userRepository;
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">createUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-keyword">return</span> userRepository.save(user);
    }

    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserById</span><span class="hljs-params">(Long id)</span> {
        <span class="hljs-keyword">return</span> userRepository.findById(id).orElse(<span class="hljs-literal">null</span>);
    }

    <span class="hljs-keyword">public</span> List&lt;User&gt; <span class="hljs-title function_">getAllUsers</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> userRepository.findAll();
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">updateUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-keyword">return</span> userRepository.save(user);
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(Long id)</span> {
        userRepository.deleteById(id);
    }
}
</code></pre>
<h3 data-id="heading-10">7. 编写控制器</h3>
<p>利用上述服务类来编写RESTful API控制器。</p>
<h4 data-id="heading-11"><code>UserController.java</code></h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.http.ResponseEntity;
<span class="hljs-keyword">import</span> org.springframework.web.bind.annotation.*;

<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@RestController</span>
<span class="hljs-meta">@RequestMapping("/users")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserService userService;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserController</span><span class="hljs-params">(UserService userService)</span> {
        <span class="hljs-built_in">this</span>.userService = userService;
    }

    <span class="hljs-meta">@PostMapping</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;User&gt; <span class="hljs-title function_">createUser</span><span class="hljs-params">(<span class="hljs-meta">@RequestBody</span> User user)</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">createdUser</span> <span class="hljs-operator">=</span> userService.createUser(user);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(createdUser);
    }

    <span class="hljs-meta">@GetMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;User&gt; <span class="hljs-title function_">getUserById</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.getUserById(id);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(user);
    }

    <span class="hljs-meta">@GetMapping</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;List&lt;User&gt;&gt; <span class="hljs-title function_">getAllUsers</span><span class="hljs-params">()</span> {
        List&lt;User&gt; users = userService.getAllUsers();
        <span class="hljs-keyword">return</span> ResponseEntity.ok(users);
    }

    <span class="hljs-meta">@PutMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;User&gt; <span class="hljs-title function_">updateUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id, <span class="hljs-meta">@RequestBody</span> User user)</span> {
        user.setId(id);
        <span class="hljs-type">User</span> <span class="hljs-variable">updatedUser</span> <span class="hljs-operator">=</span> userService.updateUser(user);
        <span class="hljs-keyword">return</span> ResponseEntity.ok(updatedUser);
    }

    <span class="hljs-meta">@DeleteMapping("/{id}")</span>
    <span class="hljs-keyword">public</span> ResponseEntity&lt;Void&gt; <span class="hljs-title function_">deleteUser</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable</span> Long id)</span> {
        userService.deleteUser(id);
        <span class="hljs-keyword">return</span> ResponseEntity.noContent().build();
    }
}
</code></pre>
<h3 data-id="heading-12">8. 分布式事务管理</h3>
<p>在分布式系统中，事务管理是一个重要问题。你可以使用分布式事务管理框架，例如Spring Cloud Sleuth、Spring Cloud Stream以及外部的事务协调器（如JTA或XA事务）。</p>
<h4 data-id="heading-13">使用Spring Cloud Sleuth和Spring Cloud Stream进行分布式跟踪</h4>
<p>在<code>pom.xml</code>中添加相关依赖：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-sleuth<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-stream-kafka<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>在<code>application.properties</code>中配置Kafka：</p>
<pre><code class="hljs language-properties" lang="properties">spring.cloud.stream.bindings.output.destination=mytopic
spring.cloud.stream.kafka.binder.brokers=localhost:9092
</code></pre>
<p>然后在服务层添加Kafka消息发送：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Autowired;
<span class="hljs-keyword">import</span> org.springframework.cloud.stream.annotation.EnableBinding;
<span class="hljs-keyword">import</span> org.springframework.cloud.stream.messaging.Source;
<span class="hljs-keyword">import</span> org.springframework.messaging.support.MessageBuilder;

<span class="hljs-meta">@EnableBinding(Source.class)</span>
<span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> {

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> Source source;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> UserRepository userRepository;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">UserService</span><span class="hljs-params">(UserRepository userRepository)</span> {
        <span class="hljs-built_in">this</span>.userRepository = userRepository;
    }

    <span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">createUser</span><span class="hljs-params">(User user)</span> {
        <span class="hljs-type">User</span> <span class="hljs-variable">savedUser</span> <span class="hljs-operator">=</span> userRepository.save(user);
        source.output().send(MessageBuilder.withPayload(savedUser).build());
        <span class="hljs-keyword">return</span> savedUser;
    }

    <span class="hljs-comment">// other methods...</span>
}
</code></pre>
<h3 data-id="heading-14">总结</h3>
<p>通过上述步骤，我们在分布式系统中使用了Hibernate，配置了数据源，定义了实体类，创建了DAO层和服务层，并编写了RESTful API控制器。此外，我们还使用Spring Cloud Sleuth和Spring Cloud Stream来实现分布式事务管理和分布式跟踪。这使得每个微服务可以独立地进行数据库操作，实现了完整的CRUD功能，并且能够管理分布式事务。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Flutter-使用Gal展示和保存图片资源]]></title>    <link>https://juejin.cn/post/7599502282601824319</link>    <guid>https://juejin.cn/post/7599502282601824319</guid>    <pubDate>2026-01-26T11:51:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7599502282601824319" data-draft-id="7596926832912056383" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Flutter-使用Gal展示和保存图片资源 "/> <meta itemprop="keywords" content="前端,Flutter,Android"/> <meta itemprop="datePublished" content="2026-01-26T11:51:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="鹏多多"/> <meta itemprop="url" content="https://juejin.cn/user/747323639737191"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Flutter-使用Gal展示和保存图片资源 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/747323639737191/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    鹏多多
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-01-26T11:51:48.000Z" title="Mon Jan 26 2026 11:51:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-01-26
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:2;font-weight:400;font-size:15px;overflow-x:hidden;color:#333;letter-spacing:1.2px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1:first-child,.markdown-body h2:first-child,.markdown-body h3:first-child,.markdown-body h4:first-child,.markdown-body h5:first-child,.markdown-body h6:first-child{margin-top:-1.5rem;margin-bottom:1rem}.markdown-body h1:before,.markdown-body h2:before,.markdown-body h3:before,.markdown-body h4:before,.markdown-body h5:before,.markdown-body h6:before{content:"#";display:inline-block;color:#3eaf7c;padding-right:.23em}.markdown-body h1{position:relative;font-size:2.5rem;margin-bottom:5px}.markdown-body h1:before{font-size:2.5rem}.markdown-body h2{padding-bottom:.5rem;font-size:2.2rem;border-bottom:1px solid #ececec}.markdown-body h3{font-size:1.5rem;padding-bottom:0}.markdown-body h4{font-size:1.25rem}.markdown-body h5{font-size:1rem}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body strong{color:#3eaf7c}.markdown-body img{max-width:100%;border-radius:2px;display:block;margin:auto}.markdown-body hr{border:none;border-top:1px solid #3eaf7c;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;overflow-x:auto;padding:.2rem .5rem;margin:0;color:#3eaf7c;font-size:.85em;background-color:rgba(27,31,35,.05);border-radius:3px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;border:.5rem solid #3eaf7c}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{font-weight:500;text-decoration:none;color:#3eaf7c;margin:0 5px}.markdown-body a:active,.markdown-body a:hover{text-decoration:none;border-bottom:1.5px solid #3eaf7c}.markdown-body a[href^=http]:after{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTQiIGhlaWdodD0iMTQiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04MzIgMTI4SDY0MHY2NGgxNDYuNzUyTDUyMS4zNzYgNDU3LjM3Nmw0NS4yNDggNDUuMjQ4TDgzMiAyMzcuMjQ4VjM4NGg2NFYxMjh6IiBmaWxsPSIjM2VhZjdjIi8+PHBhdGggZD0iTTc2OCA4MzJIMTkyVjI1NmgzNTJ2LTY0SDE2MGEzMiAzMiAwIDAwLTMyIDMydjY0MGEzMiAzMiAwIDAwMzIgMzJoNjQwYTMyIDMyIDAgMDAzMi0zMlY0ODBoLTY0djM1MnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");margin-left:2px}.markdown-body a[href^="#"]:before{content:"#"}.markdown-body table{display:inline-block!important;font-size:13px;width:auto;max-width:100%;overflow:auto;border:1px solid #3eaf7c;border-collapse:collapse}.markdown-body thead{background:#3eaf7c;color:#fff;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(153,255,188,.1)}.markdown-body td,.markdown-body th{padding:4px 8px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#7b7878;padding:1px 23px;border-left:.5rem solid;border-color:#42b983;background-color:rgba(66,184,131,.1);position:relative;margin:14px 8px 0}.markdown-body blockquote:before{display:inline-block;position:absolute;content:url("data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjUiIGhlaWdodD0iMjUiIHZpZXdCb3g9IjAgMCAyNyAyNyIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxLjg2MiAxLjg2MikiIGZpbGwtcnVsZT0ibm9uemVybyIgZmlsbD0ibm9uZSI+PGNpcmNsZSBzdHJva2U9IiNGRkYiIHN0cm9rZS13aWR0aD0iMS43MjQiIGZpbGw9IiM0MkI5ODMiIGN4PSIxMS42MzgiIGN5PSIxMS42MzgiIHI9IjExLjYzOCIvPjxwYXRoIGQ9Ik0xNC45NzggNi4yN0E1LjAwNiA1LjAwNiAwIDAwNi42NyA5LjQ2OGE0LjkwMSA0LjkwMSAwIDAwMS43NzMgNC4zNjJjLjMyMy4yNTguNTE0LjY0Ny41MjIgMS4wNnYxLjA2YTIuNjg1IDIuNjg1IDAgMDA1LjM3IDB2LTEuMDA4Yy4wMDItLjM5OC4xNzMtLjc3Ny40Ny0xLjA0MmE1LjAyMyA1LjAyMyAwIDAwLjE3My03LjYzem0tMy4zMzcgMTAuOTY3YTEuMzA0IDEuMzA0IDAgMDEtMS4yODYtMS4yODd2LS4yNzhoMi41NzJ2LjI2MWMwIC43MTMtLjU3MyAxLjI5NC0xLjI4NiAxLjMwNHptMi4yNi00LjQxNWMtLjQ0LjM4My0uNzUuODkzLS44ODcgMS40NmgtMi43NDZhMi44NjggMi44NjggMCAwMC0uOTM4LTEuNTNoLS4wMThhMy40NzYgMy40NzYgMCAwMS0xLjI2OS0zLjE0NSAzLjYxNSAzLjYxNSAwIDAxNy4xOTYuNCAzLjY1IDMuNjUgMCAwMS0xLjMzOCAyLjgxNXoiIGZpbGw9IiNGRkYiLz48L2c+PC9zdmc+");width:25px;height:25px;left:-16px;top:12px}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body details{outline:none;border:none;border-left:4px solid #3eaf7c;padding-left:10px;margin-left:4px}.markdown-body details summary{cursor:pointer;border:none;outline:none;background:#fff;margin:0 -17px}.markdown-body details summary::-webkit-details-marker{color:#3eaf7c}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body ol li::marker{color:#3eaf7c}.markdown-body ul li{list-style:none;padding-left:10px}.markdown-body ul li::marker{content:"•";color:#3eaf7c}.markdown-body ul li.task-list-item:before{content:"";margin-right:0}.markdown-body input[type=checkbox]{vertical-align:text-bottom;box-shadow:inset 0 0 0 10px #fff}.markdown-body input[type=checkbox]:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik04NzcuMDU2IDE0Ni45NDR2NzMwLjExMkgxNDYuOTQ0VjE0Ni45NDRoNzMwLjExMnptMC0xMDQuMjc3SDE0Ni45NDRjLTU3LjYyOCAwLTEwNC4yNzcgNDYuNjQ5LTEwNC4yNzcgMTA0LjI3N3Y3MzAuMTEyYzAgNTcuNjI4IDQ2LjY0OSAxMDQuMjc3IDEwNC4yNzcgMTA0LjI3N2g3MzAuMTEyYzU3LjYyOCAwIDEwNC4yNzctNDYuNjQ5IDEwNC4yNzctMTA0LjI3N1YxNDYuOTQ0YzAtNTcuNjI4LTQ2LjY0OS0xMDQuMjc3LTEwNC4yNzctMTA0LjI3N3oiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}.markdown-body input[type=checkbox]:checked:before{content:url("data:image/svg+xml;base64,PHN2ZyBjbGFzcz0iaWNvbiIgdmlld0JveD0iMCAwIDEwMjQgMTAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTUiIGhlaWdodD0iMTUiPjxkZWZzPjxzdHlsZS8+PC9kZWZzPjxwYXRoIGQ9Ik05MTAuMjA4IDBIMTEzLjc2QTExNC4xMTIgMTE0LjExMiAwIDAwLS4wMzIgMTEzLjc5MlY5MTAuMjRjMCA2Mi41OTIgNTEuMiAxMTMuNzkyIDExMy43OTIgMTEzLjc5Mmg3OTYuNDQ4YzYyLjU5MiAwIDExMy43OTItNTEuMiAxMTMuNzkyLTExMy43OTJWMTEzLjc5MkMxMDI0IDUxLjIgOTcyLjggMCA5MTAuMjA4IDB6bS01MTIgNzk2LjQ0OEwxMTMuNzYgNTEybDc5LjY0OC03OS42NDggMjA0LjggMjA0LjhMODMwLjU2IDIwNC44bDc5LjY0OCA3OS42NDgtNTEyIDUxMnoiIGZpbGw9IiMzZWFmN2MiLz48L3N2Zz4=");position:relative;top:-2px;right:2px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="agate">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#333;color:#fff}.hljs-name,.hljs-strong{font-weight:700}.hljs-code,.hljs-emphasis{font-style:italic}.hljs-tag{color:#62c8f3}.hljs-selector-class,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#ade5fc}.hljs-bullet,.hljs-string{color:#a2fca2}.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-quote,.hljs-section,.hljs-title,.hljs-type{color:#ffa}.hljs-bullet,.hljs-number,.hljs-symbol{color:#d36363}.hljs-keyword,.hljs-literal,.hljs-selector-tag{color:#fcc28c}.hljs-code,.hljs-comment,.hljs-deletion{color:#888}.hljs-link,.hljs-regexp{color:#c6b4f0}.hljs-meta{color:#fc9b9b}.hljs-deletion{background-color:#fc9b9b;color:#333}.hljs-addition{background-color:#a2fca2;color:#333}.hljs a{color:inherit}.hljs a:focus,.hljs a:hover{color:inherit;text-decoration:underline}</style><p>Gal 是 Flutter 生态中一款轻量、高性能的图片管理与预览插件，专为简化 Flutter 应用中图片选择、预览、保存等核心场景设计。它封装了原生平台的图片处理能力，提供统一的 API 接口，让开发者无需关注 iOS/Android 底层差异，快速实现专业级的图片交互体验。</p>
<h2 data-id="heading-0">1. Gal 插件核心功能</h2>
<p>Gal 插件的核心价值在于<strong>跨平台一致性</strong>和<strong>易用性</strong>，主要覆盖以下场景：</p>
<ol>
<li><strong>图片预览</strong>：支持单张/多张图片的沉浸式预览，包含缩放、滑动切换、手势返回等交互；</li>
<li><strong>相册操作</strong>：读取设备相册、筛选图片/视频、获取图片元信息（尺寸、路径、创建时间）；</li>
<li><strong>图片保存</strong>：将网络图片/本地图片保存到系统相册，自动处理权限申请；</li>
<li><strong>权限管理</strong>：封装相册读写权限的申请与状态检测，适配 iOS/Android 权限机制差异；</li>
<li><strong>性能优化</strong>：内置图片懒加载、内存缓存策略，避免大图集加载时的卡顿问题。</li>
</ol>
<h2 data-id="heading-1">2. 核心 API 与属性详解</h2>
<h3 data-id="heading-2">2.1. 基础配置</h3>
<p>使用 Gal 前需先完成初始化，并配置权限相关参数（pubspec.yaml 配置）：</p>
<p><strong>使用最新版本：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">dependencies:</span>
  <span class="hljs-attr">gal:</span> <span class="hljs-string">^2.1.0</span> <span class="hljs-comment"># 建议使用最新稳定版</span>
</code></pre>
<p><strong>Android：</strong></p>
<pre><code class="hljs language-ini" lang="ini">
<span class="hljs-comment"># Android 权限配置（android/app/src/main/AndroidManifest.xml）</span>
&lt;uses-permission android:<span class="hljs-attr">name</span>=<span class="hljs-string">"android.permission.READ_EXTERNAL_STORAGE"</span>/&gt;
&lt;uses-permission android:<span class="hljs-attr">name</span>=<span class="hljs-string">"android.permission.WRITE_EXTERNAL_STORAGE"</span> android:maxSdkVersion=<span class="hljs-string">"32"</span>/&gt;
&lt;uses-permission android:<span class="hljs-attr">name</span>=<span class="hljs-string">"android.permission.MANAGE_EXTERNAL_STORAGE"</span>/&gt;
</code></pre>
<p><strong>iOS：</strong></p>
<pre><code class="hljs language-vbnet" lang="vbnet"># iOS 权限配置（ios/Runner/Info.plist）
&lt;<span class="hljs-keyword">key</span>&gt;NSPhotoLibraryUsageDescription&lt;/<span class="hljs-keyword">key</span>&gt;
&lt;<span class="hljs-type">string</span>&gt;需要访问相册以选择/保存图片&lt;/<span class="hljs-type">string</span>&gt;
&lt;<span class="hljs-keyword">key</span>&gt;NSPhotoLibraryAddUsageDescription&lt;/<span class="hljs-keyword">key</span>&gt;
&lt;<span class="hljs-type">string</span>&gt;需要写入权限以保存图片到相册&lt;/<span class="hljs-type">string</span>&gt;
</code></pre>
<h3 data-id="heading-3">2.2. 核心 API 列表</h3>









































<table><thead><tr><th>API 方法</th><th>功能描述</th><th>参数说明</th><th>返回值</th></tr></thead><tbody><tr><td><code>Gal.requestPermission()</code></td><td>申请相册读写权限</td><td><code>type</code>: 权限类型（<code>PermissionType.read</code>/<code>write</code>）</td><td><code>Future&lt;bool&gt;</code>: 是否授权成功</td></tr><tr><td><code>Gal.getPhotos()</code></td><td>获取相册图片列表</td><td><code>limit</code>: 加载数量（默认全部）<br/><code>albumId</code>: 指定相册 ID（可选）</td><td><code>Future&lt;List&lt;GalPhoto&gt;&gt;</code>: 图片信息列表</td></tr><tr><td><code>Gal.preview()</code></td><td>预览图片</td><td><code>photos</code>: 图片列表<br/><code>initialIndex</code>: 初始预览索引<br/><code>backgroundColor</code>: 预览背景色</td><td><code>Future&lt;void&gt;</code></td></tr><tr><td><code>Gal.saveImage()</code></td><td>保存图片到相册</td><td><code>path</code>: 图片本地路径/网络 URL<br/><code>albumName</code>: 自定义相册名称（可选）</td><td><code>Future&lt;bool&gt;</code>: 是否保存成功</td></tr><tr><td><code>Gal.getAlbums()</code></td><td>获取设备相册列表</td><td>-</td><td><code>Future&lt;List&lt;GalAlbum&gt;&gt;</code>: 相册信息列表</td></tr></tbody></table>
<h3 data-id="heading-4">2.3. 关键数据模型</h3>
<h4 data-id="heading-5">GalPhoto（图片信息模型）</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">class</span> <span class="hljs-title class_">GalPhoto</span> {
  <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> id; <span class="hljs-comment">// 图片唯一标识</span>
  <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> path; <span class="hljs-comment">// 本地路径</span>
  <span class="hljs-keyword">final</span> <span class="hljs-type">String</span>? url; <span class="hljs-comment">// 网络图片 URL（可选）</span>
  <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> width; <span class="hljs-comment">// 图片宽度</span>
  <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> height; <span class="hljs-comment">// 图片高度</span>
  <span class="hljs-keyword">final</span> DateTime createTime; <span class="hljs-comment">// 创建时间</span>
  <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> mimeType; <span class="hljs-comment">// 图片类型（image/jpeg 等）</span>
}
</code></pre>
<h4 data-id="heading-6">GalAlbum（相册信息模型）</h4>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">class</span> <span class="hljs-title class_">GalAlbum</span> {
  <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> id; <span class="hljs-comment">// 相册唯一标识</span>
  <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> name; <span class="hljs-comment">// 相册名称</span>
  <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> count; <span class="hljs-comment">// 相册内图片数量</span>
  <span class="hljs-keyword">final</span> <span class="hljs-type">String</span>? coverPath; <span class="hljs-comment">// 相册封面路径</span>
}
</code></pre>
<h2 data-id="heading-7">3. 图片选择与预览功能Demo</h2>
<p>以下是一个完整的 Demo，实现「获取相册图片 → 列表展示 → 点击预览 → 保存图片」的核心流程。</p>
<h3 data-id="heading-8">3.1 完整代码</h3>
<pre><code class="hljs language-php" lang="php">import <span class="hljs-string">'package:flutter/material.dart'</span>;
import <span class="hljs-string">'package:gal/gal.dart'</span>;
import <span class="hljs-string">'package:permission_handler/permission_handler.dart'</span>;

<span class="hljs-keyword">void</span> <span class="hljs-title function_ invoke__">main</span>() =&gt; <span class="hljs-title function_ invoke__">runApp</span>(<span class="hljs-keyword">const</span> <span class="hljs-title function_ invoke__">GalDemoApp</span>());

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GalDemoApp</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatelessWidget</span> </span>{
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">GalDemoApp</span>({super.key});

  @override
  Widget <span class="hljs-title function_ invoke__">build</span>(BuildContext context) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">MaterialApp</span>(
      <span class="hljs-attr">title</span>: <span class="hljs-string">'Gal 插件 Demo'</span>,
      <span class="hljs-attr">theme</span>: <span class="hljs-title function_ invoke__">ThemeData</span>(<span class="hljs-attr">primarySwatch</span>: Colors.blue),
      <span class="hljs-attr">home</span>: <span class="hljs-keyword">const</span> <span class="hljs-title function_ invoke__">GalDemoPage</span>(),
    );
  }
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GalDemoPage</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StatefulWidget</span> </span>{
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">GalDemoPage</span>({super.key});

  @override
  State&lt;GalDemoPage&gt; <span class="hljs-title function_ invoke__">createState</span>() =&gt; <span class="hljs-title function_ invoke__">_GalDemoPageState</span>();
}

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">_GalDemoPageState</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">State</span>&lt;<span class="hljs-title">GalDemoPage</span>&gt; </span>{
  List&lt;GalPhoto&gt; _photos = [];
  <span class="hljs-keyword">bool</span> _isLoading = <span class="hljs-literal">false</span>;

  <span class="hljs-comment">// 申请相册权限</span>
  Future&lt;<span class="hljs-keyword">bool</span>&gt; <span class="hljs-title function_ invoke__">_requestPermission</span>() async {
    <span class="hljs-keyword">final</span> status = await Permission.photos.<span class="hljs-title function_ invoke__">request</span>();
    <span class="hljs-keyword">return</span> status.isGranted;
  }

  <span class="hljs-comment">// 加载相册图片</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; <span class="hljs-title function_ invoke__">_loadPhotos</span>() async {
    <span class="hljs-title function_ invoke__">setState</span>(() =&gt; _isLoading = <span class="hljs-literal">true</span>);
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> hasPermission = await <span class="hljs-title function_ invoke__">_requestPermission</span>();
      <span class="hljs-keyword">if</span> (!hasPermission) {
        <span class="hljs-keyword">if</span> (mounted) {
          ScaffoldMessenger.<span class="hljs-title function_ invoke__">of</span>(context).<span class="hljs-title function_ invoke__">showSnackBar</span>(
            <span class="hljs-keyword">const</span> <span class="hljs-title function_ invoke__">SnackBar</span>(<span class="hljs-attr">content</span>: <span class="hljs-title function_ invoke__">Text</span>(<span class="hljs-string">'请授予相册访问权限'</span>)),
          );
        }
        <span class="hljs-keyword">return</span>;
      }

      <span class="hljs-comment">// 获取相册图片（限制加载20张，避免性能问题）</span>
      <span class="hljs-keyword">final</span> photos = await Gal.<span class="hljs-title function_ invoke__">getPhotos</span>(<span class="hljs-attr">limit</span>: <span class="hljs-number">20</span>);
      <span class="hljs-title function_ invoke__">setState</span>(() =&gt; _photos = photos);
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">if</span> (mounted) {
        ScaffoldMessenger.<span class="hljs-title function_ invoke__">of</span>(context).<span class="hljs-title function_ invoke__">showSnackBar</span>(
          <span class="hljs-title function_ invoke__">SnackBar</span>(<span class="hljs-attr">content</span>: <span class="hljs-title function_ invoke__">Text</span>(<span class="hljs-string">'加载图片失败：$e'</span>)),
        );
      }
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-title function_ invoke__">setState</span>(() =&gt; _isLoading = <span class="hljs-literal">false</span>);
    }
  }

  <span class="hljs-comment">// 预览图片</span>
  <span class="hljs-keyword">void</span> <span class="hljs-title function_ invoke__">_previewPhoto</span>(<span class="hljs-keyword">int</span> index) async {
    await Gal.<span class="hljs-title function_ invoke__">preview</span>(
      <span class="hljs-attr">photos</span>: _photos,
      <span class="hljs-attr">initialIndex</span>: index,
      <span class="hljs-attr">backgroundColor</span>: Colors.black,
    );
  }

  <span class="hljs-comment">// 保存示例图片到相册</span>
  Future&lt;<span class="hljs-keyword">void</span>&gt; <span class="hljs-title function_ invoke__">_saveSampleImage</span>() async {
    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">sampleImageUrl</span> = <span class="hljs-string">'https://picsum.photos/800/600'</span>;
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">final</span> success = await Gal.<span class="hljs-title function_ invoke__">saveImage</span>(
        sampleImageUrl,
        <span class="hljs-attr">albumName</span>: <span class="hljs-string">'Gal Demo'</span>, // 自定义相册名称
      );
      <span class="hljs-keyword">if</span> (success) {
        <span class="hljs-keyword">if</span> (mounted) {
          ScaffoldMessenger.<span class="hljs-title function_ invoke__">of</span>(context).<span class="hljs-title function_ invoke__">showSnackBar</span>(
            <span class="hljs-keyword">const</span> <span class="hljs-title function_ invoke__">SnackBar</span>(<span class="hljs-attr">content</span>: <span class="hljs-title function_ invoke__">Text</span>(<span class="hljs-string">'图片保存成功'</span>)),
          );
          <span class="hljs-comment">// 保存后重新加载图片列表</span>
          <span class="hljs-title function_ invoke__">_loadPhotos</span>();
        }
      }
    } <span class="hljs-keyword">catch</span> (e) {
      <span class="hljs-keyword">if</span> (mounted) {
        ScaffoldMessenger.<span class="hljs-title function_ invoke__">of</span>(context).<span class="hljs-title function_ invoke__">showSnackBar</span>(
          <span class="hljs-title function_ invoke__">SnackBar</span>(<span class="hljs-attr">content</span>: <span class="hljs-title function_ invoke__">Text</span>(<span class="hljs-string">'保存失败：$e'</span>)),
        );
      }
    }
  }

  @override
  <span class="hljs-keyword">void</span> <span class="hljs-title function_ invoke__">initState</span>() {
    super.<span class="hljs-title function_ invoke__">initState</span>();
    <span class="hljs-comment">// 页面初始化时加载图片</span>
    <span class="hljs-title function_ invoke__">_loadPhotos</span>();
  }

  @override
  Widget <span class="hljs-title function_ invoke__">build</span>(BuildContext context) {
    <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">Scaffold</span>(
      <span class="hljs-attr">appBar</span>: <span class="hljs-title function_ invoke__">AppBar</span>(
        <span class="hljs-attr">title</span>: <span class="hljs-keyword">const</span> <span class="hljs-title function_ invoke__">Text</span>(<span class="hljs-string">'Gal 图片管理 Demo'</span>),
        <span class="hljs-attr">actions</span>: [
          <span class="hljs-title function_ invoke__">IconButton</span>(
            <span class="hljs-attr">icon</span>: <span class="hljs-keyword">const</span> <span class="hljs-title function_ invoke__">Icon</span>(Icons.save),
            <span class="hljs-attr">onPressed</span>: _saveSampleImage,
            <span class="hljs-attr">tooltip</span>: <span class="hljs-string">'保存示例图片'</span>,
          ),
        ],
      ),
      <span class="hljs-attr">body</span>: <span class="hljs-title function_ invoke__">_buildBody</span>(),
    );
  }

  Widget <span class="hljs-title function_ invoke__">_buildBody</span>() {
    <span class="hljs-keyword">if</span> (_isLoading) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">Center</span>(child: <span class="hljs-title function_ invoke__">CircularProgressIndicator</span>());
    }
    <span class="hljs-keyword">if</span> (_photos.isEmpty) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">Center</span>(child: <span class="hljs-title function_ invoke__">Text</span>(<span class="hljs-string">'暂无图片，请检查权限或相册内容'</span>));
    }
    <span class="hljs-comment">// 网格展示图片</span>
    <span class="hljs-keyword">return</span> GridView.<span class="hljs-title function_ invoke__">builder</span>(
      <span class="hljs-attr">padding</span>: <span class="hljs-keyword">const</span> EdgeInsets.<span class="hljs-title function_ invoke__">all</span>(<span class="hljs-number">8</span>),
      <span class="hljs-attr">gridDelegate</span>: <span class="hljs-keyword">const</span> <span class="hljs-title function_ invoke__">SliverGridDelegateWithFixedCrossAxisCount</span>(
        <span class="hljs-attr">crossAxisCount</span>: <span class="hljs-number">3</span>, // 每行<span class="hljs-number">3</span>列
        <span class="hljs-attr">crossAxisSpacing</span>: <span class="hljs-number">4</span>,
        <span class="hljs-attr">mainAxisSpacing</span>: <span class="hljs-number">4</span>,
        <span class="hljs-attr">childAspectRatio</span>: <span class="hljs-number">1</span>, // 宽高比<span class="hljs-number">1</span>:<span class="hljs-number">1</span>
      ),
      <span class="hljs-attr">itemCount</span>: _photos.length,
      <span class="hljs-attr">itemBuilder</span>: (context, index) {
        <span class="hljs-keyword">final</span> photo = _photos[index];
        <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">GestureDetector</span>(
          <span class="hljs-attr">onTap</span>: () =&gt; <span class="hljs-title function_ invoke__">_previewPhoto</span>(index),
          child: Image.<span class="hljs-title function_ invoke__">file</span>(
            <span class="hljs-title function_ invoke__">File</span>(photo.path),
            <span class="hljs-attr">fit</span>: BoxFit.cover,
            <span class="hljs-attr">errorBuilder</span>: (context, error, stackTrace) {
              <span class="hljs-keyword">return</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">Icon</span>(Icons.broken_image, color: Colors.grey);
            },
          ),
        );
      },
    );
  }
}
</code></pre>
<h3 data-id="heading-9">3.2. 代码说明</h3>
<ol>
<li><strong>权限处理</strong>：结合 <code>permission_handler</code> 插件申请相册权限，这是使用 Gal 的前提；</li>
<li><strong>图片加载</strong>：通过 <code>Gal.getPhotos()</code> 获取相册图片，限制加载数量避免卡顿；</li>
<li><strong>图片展示</strong>：使用 <code>GridView</code> 展示图片列表，点击图片调用 <code>Gal.preview()</code> 实现沉浸式预览；</li>
<li><strong>图片保存</strong>：调用 <code>Gal.saveImage()</code> 将网络图片保存到自定义相册，保存成功后刷新列表。</li>
</ol>
<h3 data-id="heading-10">3.3. 运行效果</h3>
<ol>
<li>首次打开应用会弹出权限申请弹窗，授权后加载相册前20张图片；</li>
<li>图片以网格形式展示，点击任意图片进入全屏预览模式，支持滑动切换、双指缩放；</li>
<li>点击右上角「保存」按钮，可将示例网络图片保存到「Gal Demo」相册，保存后列表自动刷新。</li>
</ol>
<h2 data-id="heading-11">4. 注意事项</h2>
<ol>
<li>
<p><strong>权限适配</strong>：</p>
<ol>
<li>Android 13+ 需单独申请 <code>READ_MEDIA_IMAGES</code> 权限，Android 10 需配置 <code>android:requestLegacyExternalStorage="true"</code>；</li>
<li>iOS 14+ 支持精确相册权限（仅允许选择部分图片），Gal 已适配该特性。</li>
</ol>
</li>
<li>
<p><strong>性能优化</strong>：</p>
<ol>
<li>加载大量图片时，务必设置 <code>limit</code> 参数分页加载，避免一次性加载全部图片导致内存溢出；</li>
<li>预览图片时，建议使用 <code>CachedNetworkImage</code> 缓存网络图片。</li>
</ol>
</li>
<li>
<p><strong>异常处理</strong>：</p>
<ol>
<li>所有 Gal API 均为异步操作，需添加 <code>try/catch</code> 捕获权限拒绝、文件不存在等异常；</li>
<li>保存网络图片时，需先判断网络状态，避免无网络时保存失败。</li>
</ol>
</li>
</ol>
<h2 data-id="heading-12">5. 总结</h2>
<ol>
<li>Gal 插件是 Flutter 中高效的图片管理工具，核心覆盖「权限申请、图片读取、预览、保存」四大核心场景，API 设计简洁且跨平台一致；</li>
<li>使用 Gal 的关键步骤：配置权限 → 申请权限 → 调用核心 API → 异常处理；</li>
<li>实战中需注意性能优化（分页加载、缓存）和平台适配（不同系统的权限/路径差异），确保体验一致性。</li>
</ol>
<p>通过 Gal 插件，开发者可以摆脱原生图片处理的繁琐逻辑，快速实现媲美原生应用的图片交互体验，是 Flutter 图片类应用的优选插件。</p>
<p>源码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fnatsuk4ze%2Fgal%2Fblob%2Fmain%2Fexample%2Flib%2Fmain.dart" target="_blank" title="https://github.com/natsuk4ze/gal/blob/main/example/lib/main.dart" ref="nofollow noopener noreferrer">传送门</a></p>
<hr/>
<blockquote>
<p>本次分享就到这儿啦，我是鹏多多，深耕前端的技术创作者，如果您看了觉得有帮助，欢迎评论，关注，点赞，转发，我们下次见~</p>
</blockquote>
<p>PS：在本页按F12，在console中输入document.getElementsByClassName('panel-btn')[0].click();有惊喜哦~</p>
<p><code>往期文章</code></p>
<ul>
<li><a href="https://juejin.cn/post/7583910637958807571" target="_blank" title="https://juejin.cn/post/7583910637958807571">flutter使用package_info_plus库获取应用信息的教程</a></li>
<li><a href="https://juejin.cn/post/7588680081327259690" target="_blank" title="https://juejin.cn/post/7588680081327259690">Flutter下拉刷新上拉加载侧拉刷新插件：easy_refresh全面使用指南</a></li>
<li><a href="https://juejin.cn/post/7583226204036513833" target="_blank" title="https://juejin.cn/post/7583226204036513833">flutter-使用EventBus实现组件间数据通信</a></li>
<li><a href="https://juejin.cn/post/7582808491582619684" target="_blank" title="https://juejin.cn/post/7582808491582619684">Flutter输入框TextField的属性与实战用法全面解析+示例</a></li>
<li><a href="https://juejin.cn/post/7581693431740448831" target="_blank" title="https://juejin.cn/post/7581693431740448831">Flutter自定义日历table_calendar完全指南+案例</a></li>
<li><a href="https://juejin.cn/post/7580389111921786943" target="_blank" title="https://juejin.cn/post/7580389111921786943">flutter-屏幕自适应插件flutter_screenutil教程全指南</a></li>
<li><a href="https://juejin.cn/post/7579101504289882166" target="_blank" title="https://juejin.cn/post/7579101504289882166">flutter-使用url_launcher打开链接/应用/短信/邮件和评分跳转等</a></li>
<li><a href="https://juejin.cn/post/7570923924365230143" target="_blank" title="https://juejin.cn/post/7570923924365230143">flutter图片选择库multi_image_picker_plus和image_picker的对比和使用解析</a></li>
<li><a href="https://juejin.cn/post/7568136081302978623" target="_blank" title="https://juejin.cn/post/7568136081302978623">解锁flutter弹窗新姿势：dialog-flutter_smart_dialog插件解读+案例</a></li>
<li><a href="https://juejin.cn/post/7559089440901545999" target="_blank" title="https://juejin.cn/post/7559089440901545999">flutter-切换状态显示不同组件10种实现方案全解析</a></li>
<li><a href="https://juejin.cn/post/7555079970491318308" target="_blank" title="https://juejin.cn/post/7555079970491318308">flutter-详解控制组件显示的两种方式Offstage与Visibility</a></li>
<li><a href="https://juejin.cn/post/7535358416182788122" target="_blank" title="https://juejin.cn/post/7535358416182788122">flutter-使用AnimatedDefaultTextStyle实现文本动画</a></li>
<li><a href="https://juejin.cn/post/7537339432291434496" target="_blank" title="https://juejin.cn/post/7537339432291434496">flutter-使用SafeArea组件处理各机型的安全距离</a></li>
<li><a href="https://juejin.cn/spost/7537593417099149321" target="_blank" title="https://juejin.cn/spost/7537593417099149321">flutter-实现渐变色边框背景以及渐变色文字</a></li>
<li><a href="https://juejin.cn/post/7543474419240370185" target="_blank" title="https://juejin.cn/post/7543474419240370185">flutter-使用confetti制作炫酷纸屑爆炸粒子动画</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>