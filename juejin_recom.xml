<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[4.6 Docker Model Runner Chat]]></title>    <link>https://juejin.cn/post/7571191453125787674</link>    <guid>https://juejin.cn/post/7571191453125787674</guid>    <pubDate>2025-11-11T08:53:01.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571191453125787674" data-draft-id="7571191453125771290" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="4.6 Docker Model Runner Chat"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T08:53:01.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吴祖贤"/> <meta itemprop="url" content="https://juejin.cn/user/1961184475492103"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            4.6 Docker Model Runner Chat
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1961184475492103/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吴祖贤
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T08:53:01.000Z" title="Tue Nov 11 2025 08:53:01 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Docker Model Runner Chat</h2>
<blockquote>
<p>Spring AI 参考文档 - Docker Model Runner 聊天模型集成指南</p>
</blockquote>
<h3 data-id="heading-1">概述</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.docker.com%2Fdesktop%2Ffeatures%2Fmodel-runner%2F" target="_blank" title="https://docs.docker.com/desktop/features/model-runner/" ref="nofollow noopener noreferrer">Docker Model Runner</a> 是一个 AI 推理引擎，提供来自<a href="https://link.juejin.cn?target=https%3A%2F%2Fhub.docker.com%2Fu%2Fai" target="_blank" title="https://hub.docker.com/u/ai" ref="nofollow noopener noreferrer">各种提供者</a>的广泛模型。</p>
<p>Spring AI 通过重用现有的 <a href="https://link.juejin.cn?target=openai-chat.html" target="_blank" title="openai-chat.html" ref="nofollow noopener noreferrer">OpenAI</a> 支持的 <code>ChatClient</code> 与 Docker Model Runner 集成。
为此，请将基础 URL 设置为 <code>localhost:12434/engines</code> 并选择提供的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhub.docker.com%2Fu%2Fai" target="_blank" title="https://hub.docker.com/u/ai" ref="nofollow noopener noreferrer">LLM 模型</a>之一。</p>
<p>查看 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fspring-projects%2Fspring-ai%2Fblob%2Fmain%2Fmodels%2Fspring-ai-openai%2Fsrc%2Ftest%2Fjava%2Forg%2Fspringframework%2Fai%2Fopenai%2Fchat%2Fproxy%2FDockerModelRunnerWithOpenAiChatModelIT.java" target="_blank" title="https://github.com/spring-projects/spring-ai/blob/main/models/spring-ai-openai/src/test/java/org/springframework/ai/openai/chat/proxy/DockerModelRunnerWithOpenAiChatModelIT.java" ref="nofollow noopener noreferrer">DockerModelRunnerWithOpenAiChatModelIT.java</a> 测试，
了解如何在 Spring AI 中使用 Docker Model Runner 的示例。</p>
<h3 data-id="heading-2">先决条件</h3>
<ul>
<li>下载 Docker Desktop for Mac 4.40.0。</li>
</ul>
<p>选择以下选项之一来启用 Model Runner：</p>
<p><strong>选项 1：</strong></p>
<ul>
<li>启用 Model Runner <code>docker desktop enable model-runner --tcp 12434</code>。</li>
<li>将 base-url 设置为 <code>localhost:12434/engines</code></li>
</ul>
<p><strong>选项 2：</strong></p>
<ul>
<li>启用 Model Runner <code>docker desktop enable model-runner</code>。</li>
<li>使用 Testcontainers 并按如下方式设置 base-url：</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Container</span>
<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">DockerModelRunnerContainer</span> <span class="hljs-variable">DMR</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DockerModelRunnerContainer</span>(<span class="hljs-string">"alpine/socat:1.7.4.3-r0"</span>);

<span class="hljs-meta">@Bean</span>
<span class="hljs-keyword">public</span> OpenAiApi <span class="hljs-title function_">chatCompletionApi</span><span class="hljs-params">()</span> {
	<span class="hljs-type">var</span> <span class="hljs-variable">baseUrl</span> <span class="hljs-operator">=</span> DMR.getOpenAIEndpoint();
	<span class="hljs-keyword">return</span> OpenAiApi.builder().baseUrl(baseUrl).apiKey(<span class="hljs-string">"test"</span>).build();
}
</code></pre>
<p>您可以通过阅读 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.docker.com%2Fblog%2Frun-llms-locally%2F" target="_blank" title="https://www.docker.com/blog/run-llms-locally/" ref="nofollow noopener noreferrer">Run LLMs Locally with Docker</a> 博客文章来了解更多关于 Docker Model Runner 的信息。</p>
<h3 data-id="heading-3">自动配置</h3>
<blockquote>
<p><strong>注意</strong>：Spring AI 启动模块的构件 ID 自版本 1.0.0.M7 以来已重命名。依赖项名称现在应遵循模型、向量存储和 MCP 启动器的更新命名模式。
请参阅<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.spring.io%2Fspring-ai%2Freference%2Fupgrade-notes.html" target="_blank" title="https://docs.spring.io/spring-ai/reference/upgrade-notes.html" ref="nofollow noopener noreferrer">升级说明</a>了解更多信息。</p>
</blockquote>
<p>Spring AI 为 OpenAI 聊天客户端提供 Spring Boot 自动配置。
要启用它，请将以下依赖项添加到您项目的 Maven <code>pom.xml</code> 文件中：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-starter-model-openai<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>或者将以下内容添加到您的 Gradle <code>build.gradle</code> 构建文件中：</p>
<pre><code class="hljs language-groovy" lang="groovy">dependencies {
    implementation 'org.springframework.ai:spring-ai-starter-model-openai'
}
</code></pre>
<blockquote>
<p><strong>提示</strong>：请参考<a href="https://link.juejin.cn?target=..%2F..%2Fgetting-started.html%23dependency-management" target="_blank" title="../../getting-started.html#dependency-management" ref="nofollow noopener noreferrer">依赖管理</a>部分，将 Spring AI BOM 添加到您的构建文件中。</p>
</blockquote>
<h4 data-id="heading-4">聊天属性</h4>
<h5 data-id="heading-5">重试属性</h5>
<p>前缀 <code>spring.ai.retry</code> 用作属性前缀，让您可以为 OpenAI 聊天模型配置重试机制。</p>













































<table><thead><tr><th>属性</th><th>描述</th><th>默认值</th></tr></thead><tbody><tr><td>spring.ai.retry.max-attempts</td><td>最大重试尝试次数</td><td>10</td></tr><tr><td>spring.ai.retry.backoff.initial-interval</td><td>指数退避策略的初始睡眠持续时间</td><td>2 秒</td></tr><tr><td>spring.ai.retry.backoff.multiplier</td><td>退避间隔乘数</td><td>5</td></tr><tr><td>spring.ai.retry.backoff.max-interval</td><td>最大退避持续时间</td><td>3 分钟</td></tr><tr><td>spring.ai.retry.on-client-errors</td><td>如果为 false，则抛出 NonTransientAiException，并且不会尝试重试 <code>4xx</code> 客户端错误代码</td><td>false</td></tr><tr><td>spring.ai.retry.exclude-on-http-codes</td><td>不应触发重试的 HTTP 状态代码列表（例如，抛出 NonTransientAiException）</td><td>空</td></tr><tr><td>spring.ai.retry.on-http-codes</td><td>应触发重试的 HTTP 状态代码列表（例如，抛出 TransientAiException）</td><td>空</td></tr></tbody></table>
<h5 data-id="heading-6">连接属性</h5>
<p>前缀 <code>spring.ai.openai</code> 用作属性前缀，让您可以连接到 OpenAI。</p>




















<table><thead><tr><th>属性</th><th>描述</th><th>默认值</th></tr></thead><tbody><tr><td>spring.ai.openai.base-url</td><td>连接的 URL。必须设置为 <code>hub.docker.com/u/ai</code></td><td>-</td></tr><tr><td>spring.ai.openai.api-key</td><td>任何字符串</td><td>-</td></tr></tbody></table>
<h5 data-id="heading-7">配置属性</h5>
<blockquote>
<p><strong>注意</strong>：启用和禁用聊天自动配置现在通过前缀为 <code>spring.ai.model.chat</code> 的顶级属性完成。</p>
<p>要启用：<code>spring.ai.model.chat=openai</code>（默认启用）</p>
<p>要禁用：<code>spring.ai.model.chat=none</code>（或任何不匹配 openai 的值）</p>
<p>此更改允许在应用程序中配置多个模型。</p>
</blockquote>
<p>前缀 <code>spring.ai.openai.chat</code> 是属性前缀，让您可以为 OpenAI 配置聊天模型实现。</p>














































































































<table><thead><tr><th>属性</th><th>描述</th><th>默认值</th></tr></thead><tbody><tr><td>spring.ai.openai.chat.enabled (已移除，不再有效)</td><td>启用 OpenAI 聊天模型</td><td>true</td></tr><tr><td>spring.ai.model.chat</td><td>启用 OpenAI 聊天模型</td><td>openai</td></tr><tr><td>spring.ai.openai.chat.base-url</td><td>可选地覆盖 <code>spring.ai.openai.base-url</code> 以提供聊天特定的 URL。必须设置为 <code>localhost:12434/engines</code></td><td>-</td></tr><tr><td>spring.ai.openai.chat.api-key</td><td>可选地覆盖 spring.ai.openai.api-key 以提供聊天特定的 api-key</td><td>-</td></tr><tr><td>spring.ai.openai.chat.options.model</td><td>要使用的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhub.docker.com%2Fu%2Fai" target="_blank" title="https://hub.docker.com/u/ai" ref="nofollow noopener noreferrer">LLM 模型</a></td><td>-</td></tr><tr><td>spring.ai.openai.chat.options.temperature</td><td>控制生成完成的明显创造性的采样温度。较高的值会使输出更随机，而较低的值会使结果更聚焦和确定性。不建议同时修改温度和 top_p 的相同完成请求，因为这两个设置的相互作用难以预测。</td><td>0.8</td></tr><tr><td>spring.ai.openai.chat.options.frequencyPenalty</td><td>-2.0 到 2.0 之间的数字。正值根据新令牌在文本中的现有频率对其进行惩罚，降低模型逐字重复同一行的可能性。</td><td>0.0f</td></tr><tr><td>spring.ai.openai.chat.options.maxTokens</td><td>在聊天完成中生成的最大令牌数。输入令牌和生成令牌的总长度受模型的上下文长度限制。</td><td>-</td></tr><tr><td>spring.ai.openai.chat.options.n</td><td>为每个输入消息生成多少聊天完成选择。请注意，您将根据所有选择中生成的令牌数量计费。保持 n 为 1 以最小化成本。</td><td>1</td></tr><tr><td>spring.ai.openai.chat.options.presencePenalty</td><td>-2.0 到 2.0 之间的数字。正值根据新令牌是否出现在文本中来对其进行惩罚，增加模型谈论新主题的可能性。</td><td>-</td></tr><tr><td>spring.ai.openai.chat.options.responseFormat</td><td>指定模型必须输出的格式的对象。设置为 <code>{ "type": "json_object" }</code> 启用 JSON 模式，保证模型生成的消息是有效的 JSON。</td><td>-</td></tr><tr><td>spring.ai.openai.chat.options.seed</td><td>此功能处于 Beta 阶段。如果指定，我们的系统将尽力进行确定性采样，使得具有相同种子和参数的重复请求应返回相同结果。</td><td>-</td></tr><tr><td>spring.ai.openai.chat.options.stop</td><td>最多 4 个序列，API 将停止生成进一步的令牌。</td><td>-</td></tr><tr><td>spring.ai.openai.chat.options.topP</td><td>温度采样的替代方案，称为核采样，其中模型考虑具有 top_p 概率质量的令牌结果。因此 0.1 意味着只考虑构成前 10% 概率质量的令牌。我们通常建议更改此参数或温度，但不要同时更改两者。</td><td>-</td></tr><tr><td>spring.ai.openai.chat.options.tools</td><td>模型可能调用的工具列表。目前，仅支持函数作为工具。使用此项提供模型可能为其生成 JSON 输入的函数列表。</td><td>-</td></tr><tr><td>spring.ai.openai.chat.options.toolChoice</td><td>控制模型调用哪个（如果有）函数。none 表示模型不会调用函数而是生成消息。auto 表示模型可以选择生成消息或调用函数。通过 {"type: "function", "function": {"name": "my_function"}} 指定特定函数强制模型调用该函数。当没有函数时 none 是默认值。如果有函数，auto 是默认值。</td><td>-</td></tr><tr><td>spring.ai.openai.chat.options.user</td><td>代表您的最终用户的唯一标识符，可以帮助 OpenAI 监控和检测滥用。</td><td>-</td></tr><tr><td>spring.ai.openai.chat.options.functions</td><td>在单个提示请求中启用函数调用的函数名称列表。具有这些名称的函数必须存在于 functionCallbacks 注册表中。</td><td>-</td></tr><tr><td>spring.ai.openai.chat.options.stream-usage</td><td>（仅用于流式传输）设置为添加包含整个请求的令牌使用统计的额外块。此块的 <code>choices</code> 字段是空数组，所有其他块也将包含 usage 字段，但值为 null。</td><td>false</td></tr><tr><td>spring.ai.openai.chat.options.proxy-tool-calls</td><td>如果为 true，Spring AI 将不会内部处理函数调用，而是将它们代理给客户端。然后是客户端的责任来处理函数调用，将它们分派给适当的函数，并返回结果。如果为 false（默认值），Spring AI 将内部处理函数调用。仅适用于支持函数调用的聊天模型</td><td>false</td></tr></tbody></table>
<blockquote>
<p><strong>提示</strong>：所有以 <code>spring.ai.openai.chat.options</code> 为前缀的属性都可以通过向 <code>Prompt</code> 调用添加请求特定的<a href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E9%80%89%E9%A1%B9" title="#%E8%BF%90%E8%A1%8C%E6%97%B6%E9%80%89%E9%A1%B9">运行时选项</a>在运行时覆盖。</p>
</blockquote>
<h3 data-id="heading-8">运行时选项</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fspring-projects%2Fspring-ai%2Fblob%2Fmain%2Fmodels%2Fspring-ai-openai%2Fsrc%2Fmain%2Fjava%2Forg%2Fspringframework%2Fai%2Fopenai%2FOpenAiChatOptions.java" target="_blank" title="https://github.com/spring-projects/spring-ai/blob/main/models/spring-ai-openai/src/main/java/org/springframework/ai/openai/OpenAiChatOptions.java" ref="nofollow noopener noreferrer">OpenAiChatOptions.java</a> 提供模型配置，例如要使用的模型、温度、频率惩罚等。</p>
<p>在启动时，可以使用 <code>OpenAiChatModel(api, options)</code> 构造函数或 <code>spring.ai.openai.chat.options.*</code> 属性配置默认选项。</p>
<p>在运行时，您可以通过向 <code>Prompt</code> 调用添加新的请求特定选项来覆盖默认选项。
例如，要覆盖特定请求的默认模型和温度：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ChatResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> chatModel.call(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">Prompt</span>(
        <span class="hljs-string">"Generate the names of 5 famous pirates."</span>,
        OpenAiChatOptions.builder()
            .model(<span class="hljs-string">"ai/gemma3:4B-F16"</span>)
        .build()
    ));
</code></pre>
<blockquote>
<p><strong>提示</strong>：除了模型特定的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fspring-projects%2Fspring-ai%2Fblob%2Fmain%2Fmodels%2Fspring-ai-openai%2Fsrc%2Fmain%2Fjava%2Forg%2Fspringframework%2Fai%2Fopenai%2FOpenAiChatOptions.java" target="_blank" title="https://github.com/spring-projects/spring-ai/blob/main/models/spring-ai-openai/src/main/java/org/springframework/ai/openai/OpenAiChatOptions.java" ref="nofollow noopener noreferrer">OpenAiChatOptions</a> 外，您还可以使用通过 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fspring-projects%2Fspring-ai%2Fblob%2Fmain%2Fspring-ai-model%2Fsrc%2Fmain%2Fjava%2Forg%2Fspringframework%2Fai%2Fchat%2Fprompt%2FDefaultChatOptionsBuilder.java" target="_blank" title="https://github.com/spring-projects/spring-ai/blob/main/spring-ai-model/src/main/java/org/springframework/ai/chat/prompt/DefaultChatOptionsBuilder.java" ref="nofollow noopener noreferrer">ChatOptions#builder()</a> 创建的可移植 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fspring-projects%2Fspring-ai%2Fblob%2Fmain%2Fspring-ai-model%2Fsrc%2Fmain%2Fjava%2Forg%2Fspringframework%2Fai%2Fchat%2Fprompt%2FChatOptions.java" target="_blank" title="https://github.com/spring-projects/spring-ai/blob/main/spring-ai-model/src/main/java/org/springframework/ai/chat/prompt/ChatOptions.java" ref="nofollow noopener noreferrer">ChatOptions</a> 实例。</p>
</blockquote>
<h3 data-id="heading-9">函数调用</h3>
<p>Docker Model Runner 在选择支持它的模型时支持工具/函数调用。</p>
<p>您可以使用您的 ChatModel 注册自定义 Java 函数，并让提供的模型智能地选择输出包含调用一个或多个注册函数参数的 JSON 对象。
这是将 LLM 功能与外部工具和 API 连接的强大技术。</p>
<h4 data-id="heading-10">工具示例</h4>
<p>以下是如何在 Spring AI 中使用 Docker Model Runner 函数调用的简单示例：</p>
<pre><code class="hljs language-properties" lang="properties">spring.ai.openai.api-key=test
spring.ai.openai.base-url=http://localhost:12434/engines
spring.ai.openai.chat.options.model=ai/gemma3:4B-F16
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@SpringBootApplication</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DockerModelRunnerLlmApplication</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        SpringApplication.run(DockerModelRunnerLlmApplication.class, args);
    }

    <span class="hljs-meta">@Bean</span>
    CommandLineRunner <span class="hljs-title function_">runner</span><span class="hljs-params">(ChatClient.Builder chatClientBuilder)</span> {
        <span class="hljs-keyword">return</span> args -&gt; {
            <span class="hljs-type">var</span> <span class="hljs-variable">chatClient</span> <span class="hljs-operator">=</span> chatClientBuilder.build();

            <span class="hljs-type">var</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> chatClient.prompt()
                .user(<span class="hljs-string">"What is the weather in Amsterdam and Paris?"</span>)
                .functions(<span class="hljs-string">"weatherFunction"</span>) <span class="hljs-comment">// 通过 bean 名称引用。</span>
                .call()
                .content();

            System.out.println(response);
        };
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@Description("Get the weather in location")</span>
    <span class="hljs-keyword">public</span> Function&lt;WeatherRequest, WeatherResponse&gt; <span class="hljs-title function_">weatherFunction</span><span class="hljs-params">()</span> {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">MockWeatherService</span>();
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MockWeatherService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Function</span>&lt;WeatherRequest, WeatherResponse&gt; {

        <span class="hljs-keyword">public</span> <span class="hljs-keyword">record</span> <span class="hljs-title class_">WeatherRequest</span><span class="hljs-params">(String location, String unit)</span> {}
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">record</span> <span class="hljs-title class_">WeatherResponse</span><span class="hljs-params">(<span class="hljs-type">double</span> temp, String unit)</span> {}

        <span class="hljs-meta">@Override</span>
        <span class="hljs-keyword">public</span> WeatherResponse <span class="hljs-title function_">apply</span><span class="hljs-params">(WeatherRequest request)</span> {
            <span class="hljs-type">double</span> <span class="hljs-variable">temperature</span> <span class="hljs-operator">=</span> request.location().contains(<span class="hljs-string">"Amsterdam"</span>) ? <span class="hljs-number">20</span> : <span class="hljs-number">25</span>;
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeatherResponse</span>(temperature, request.unit);
        }
    }
}
</code></pre>
<p>在此示例中，当模型需要天气信息时，它将自动调用 <code>weatherFunction</code> bean，然后可以获取实时天气数据。
预期的响应是："阿姆斯特丹目前的天气是 20 摄氏度，巴黎目前的天气是 25 摄氏度。"</p>
<p>阅读更多关于 OpenAI <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.spring.io%2Fspring-ai%2Freference%2Fapi%2Fchat%2Ffunctions%2Fopenai-chat-functions.html" target="_blank" title="https://docs.spring.io/spring-ai/reference/api/chat/functions/openai-chat-functions.html" ref="nofollow noopener noreferrer">函数调用</a>的信息。</p>
<h3 data-id="heading-11">示例控制器</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fstart.spring.io%2F" target="_blank" title="https://start.spring.io/" ref="nofollow noopener noreferrer">创建</a>一个新的 Spring Boot 项目，并将 <code>spring-ai-starter-model-openai</code> 添加到您的 pom（或 gradle）依赖项中。</p>
<p>在 <code>src/main/resources</code> 目录下添加 <code>application.properties</code> 文件，以启用和配置 OpenAI 聊天模型：</p>
<pre><code class="hljs language-properties" lang="properties">spring.ai.openai.api-key=test
spring.ai.openai.base-url=http://localhost:12434/engines
spring.ai.openai.chat.options.model=ai/gemma3:4B-F16

# Docker Model Runner 不支持嵌入，所以我们需要禁用它们。
spring.ai.openai.embedding.enabled=false
</code></pre>
<p>这是一个使用聊天模型进行文本生成的简单 <code>@Controller</code> 类示例。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ChatController</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> OpenAiChatModel chatModel;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ChatController</span><span class="hljs-params">(OpenAiChatModel chatModel)</span> {
        <span class="hljs-built_in">this</span>.chatModel = chatModel;
    }

    <span class="hljs-meta">@GetMapping("/ai/generate")</span>
    <span class="hljs-keyword">public</span> Map <span class="hljs-title function_">generate</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = "message", defaultValue = "Tell me a joke")</span> String message)</span> {
        <span class="hljs-keyword">return</span> Map.of(<span class="hljs-string">"generation"</span>, <span class="hljs-built_in">this</span>.chatModel.call(message));
    }

    <span class="hljs-meta">@GetMapping("/ai/generateStream")</span>
	<span class="hljs-keyword">public</span> Flux&lt;ChatResponse&gt; <span class="hljs-title function_">generateStream</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = "message", defaultValue = "Tell me a joke")</span> String message)</span> {
        <span class="hljs-type">Prompt</span> <span class="hljs-variable">prompt</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Prompt</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">UserMessage</span>(message));
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.chatModel.stream(prompt);
    }
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[冷查第一，再登榜首！Apache Doris 3.1 全面刷新 JSONBench 性能纪录]]></title>    <link>https://juejin.cn/post/7571191453125885978</link>    <guid>https://juejin.cn/post/7571191453125885978</guid>    <pubDate>2025-11-11T09:10:25.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571191453125885978" data-draft-id="7571279513246760986" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="冷查第一，再登榜首！Apache Doris 3.1 全面刷新 JSONBench 性能纪录"/> <meta itemprop="keywords" content="数据库,Apache"/> <meta itemprop="datePublished" content="2025-11-11T09:10:25.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SelectDB"/> <meta itemprop="url" content="https://juejin.cn/user/3189021726222904"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            冷查第一，再登榜首！Apache Doris 3.1 全面刷新 JSONBench 性能纪录
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3189021726222904/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SelectDB
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:10:25.000Z" title="Tue Nov 11 2025 09:10:25 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在半结构化数据分析领域，真正的挑战往往不在于“热数据”，即常被访问、已加载至缓存的数据，而在于“<strong>冷数据”</strong> ——那些规模庞大、未被缓存，且需直接从磁盘读取的 JSON 文件。</p>
<p>在 9 月份发布的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fselectdb.com%2Fblog%2F1490" target="_blank" title="https://selectdb.com/blog/1490" ref="nofollow noopener noreferrer">Apache Doris 3.1 </a>版本中，对 Variant 引擎进行系统性优化，包括引入稀疏子列与子列模板化机制、优化列裁剪与路径索引、向量化 JSON 列裁剪引擎。这些改进推动 Doris 在冷查场景下实现性能及稳定性的全面突破。</p>
<p><strong>与此同时，基于 Apache Doris 3.1 版本，在最新的  <a href="https://link.juejin.cn?target=https%3A%2F%2Fjsonbench.com%2F%3F%23eyJzeXN0ZW0iOnsiQ2xpY2tIb3VzZSAobHo0KSI6dHJ1ZSwiQ2xpY2tIb3VzZSAoenN0ZCkiOnRydWUsIkFwYWNoZSBEb3JpcyI6dHJ1ZSwiRHVja0RCIjp0cnVlLCJFbGFzdGljc2VhcmNoIChubyBzb3VyY2UsIHpzdGQpIjp0cnVlLCJFbGFzdGljc2VhcmNoIChubyBzb3VyY2UsIGx6NCkiOnRydWUsIkVsYXN0aWNzZWFyY2ggKHpzdGQpIjp0cnVlLCJFbGFzdGljc2VhcmNoIChsejQpIjp0cnVlLCJGZXJyZXREQiAoc25hcHB5KSI6dHJ1ZSwiRmVycmV0REIgKHpzdGQpIjp0cnVlLCJHcmVwdGltZURCIjp0cnVlLCJNb25nb0RCIChzbmFwcHkpIjp0cnVlLCJNb25nb0RCICh6c3RkKSI6dHJ1ZSwiUG9zdGdyZVNRTCI6dHJ1ZSwiU2luZ2xlU3RvcmUiOnRydWUsIlN0YXJyb2NrcyI6dHJ1ZSwiVmljdG9yaWFMb2dzIjp0cnVlfSwic2NhbGUiOjEwMDAwMDAwMDAsIm1ldHJpYyI6ImNvbGQiLCJxdWVyaWVzIjpbdHJ1ZSx0cnVlLHRydWUsdHJ1ZSx0cnVlXSwicmV0YWluX3N0cnVjdHVyZSI6eyJ5ZXMiOnRydWUsIm5vIjpmYWxzZX19" target="_blank" title="https://jsonbench.com/?#eyJzeXN0ZW0iOnsiQ2xpY2tIb3VzZSAobHo0KSI6dHJ1ZSwiQ2xpY2tIb3VzZSAoenN0ZCkiOnRydWUsIkFwYWNoZSBEb3JpcyI6dHJ1ZSwiRHVja0RCIjp0cnVlLCJFbGFzdGljc2VhcmNoIChubyBzb3VyY2UsIHpzdGQpIjp0cnVlLCJFbGFzdGljc2VhcmNoIChubyBzb3VyY2UsIGx6NCkiOnRydWUsIkVsYXN0aWNzZWFyY2ggKHpzdGQpIjp0cnVlLCJFbGFzdGljc2VhcmNoIChsejQpIjp0cnVlLCJGZXJyZXREQiAoc25hcHB5KSI6dHJ1ZSwiRmVycmV0REIgKHpzdGQpIjp0cnVlLCJHcmVwdGltZURCIjp0cnVlLCJNb25nb0RCIChzbmFwcHkpIjp0cnVlLCJNb25nb0RCICh6c3RkKSI6dHJ1ZSwiUG9zdGdyZVNRTCI6dHJ1ZSwiU2luZ2xlU3RvcmUiOnRydWUsIlN0YXJyb2NrcyI6dHJ1ZSwiVmljdG9yaWFMb2dzIjp0cnVlfSwic2NhbGUiOjEwMDAwMDAwMDAsIm1ldHJpYyI6ImNvbGQiLCJxdWVyaWVzIjpbdHJ1ZSx0cnVlLHRydWUsdHJ1ZSx0cnVlXSwicmV0YWluX3N0cnVjdHVyZSI6eyJ5ZXMiOnRydWUsIm5vIjpmYWxzZX19" ref="nofollow noopener noreferrer">JSONBench 基准测试</a> 中，获得在冷查性能第一的优异成绩，超越 ClickHouse、Elasticsearch 等同类数据库；热查询也获得第二的成绩；综合性能全面领先！</strong></p>
<h3 data-id="heading-0">什么是 JSONBench</h3>
<p>JSONBench 是最具代表性的 JSON 数据分析性能基准，由 ClickHouse 社区发起。该基准测试采用真实场景 Bluesky 数据集（ 10 亿级 JSON 数据），包含多层嵌套、键值不固定的 JSON 结构，对数据库的查询优化、列存设计、解析引擎都是严苛考验，是业内公认的半结构化性能试金石。</p>
<h3 data-id="heading-1">Doris 冷查性能 Top 1</h3>
<p>根据最新的内部测试与 JSONBench 官方公布结果， Apache Doris 3.1 冷查在 Q3–Q5 查询表现最佳，且在冷查询（无缓存）场景下性能远超其他所有对比系统，位居榜首，综合性能全面领先。</p>
<p>具体测试结果如下：</p>
<ul>
<li>JSONBench 榜单已同步 <a href="https://link.juejin.cn?target=https%3A%2F%2Fjsonbench.com%3F%23eyJzeXN0ZW0iOnsiQ2xpY2tIb3VzZSAobHo0KSI6dHJ1ZSwiQ2xpY2tIb3VzZSAoenN0ZCkiOnRydWUsIkFwYWNoZSBEb3JpcyI6dHJ1ZSwiRHVja0RCIjp0cnVlLCJFbGFzdGljc2VhcmNoIChubyBzb3VyY2UsIHpzdGQpIjp0cnVlLCJFbGFzdGljc2VhcmNoIChubyBzb3VyY2UsIGx6NCkiOnRydWUsIkVsYXN0aWNzZWFyY2ggKHpzdGQpIjp0cnVlLCJFbGFzdGljc2VhcmNoIChsejQpIjp0cnVlLCJGZXJyZXREQiAoc25hcHB5KSI6dHJ1ZSwiRmVycmV0REIgKHpzdGQpIjp0cnVlLCJHcmVwdGltZURCIjp0cnVlLCJNb25nb0RCIChzbmFwcHkpIjp0cnVlLCJNb25nb0RCICh6c3RkKSI6dHJ1ZSwiUG9zdGdyZVNRTCI6dHJ1ZSwiU2luZ2xlU3RvcmUiOnRydWUsIlN0YXJyb2NrcyI6dHJ1ZSwiVmljdG9yaWFMb2dzIjp0cnVlfSwic2NhbGUiOjEwMDAwMDAwMDAsIm1ldHJpYyI6ImNvbGQiLCJxdWVyaWVzIjpbdHJ1ZSx0cnVlLHRydWUsdHJ1ZSx0cnVlXSwicmV0YWluX3N0cnVjdHVyZSI6eyJ5ZXMiOnRydWUsIm5vIjpmYWxzZX19" target="_blank" title="https://jsonbench.com?#eyJzeXN0ZW0iOnsiQ2xpY2tIb3VzZSAobHo0KSI6dHJ1ZSwiQ2xpY2tIb3VzZSAoenN0ZCkiOnRydWUsIkFwYWNoZSBEb3JpcyI6dHJ1ZSwiRHVja0RCIjp0cnVlLCJFbGFzdGljc2VhcmNoIChubyBzb3VyY2UsIHpzdGQpIjp0cnVlLCJFbGFzdGljc2VhcmNoIChubyBzb3VyY2UsIGx6NCkiOnRydWUsIkVsYXN0aWNzZWFyY2ggKHpzdGQpIjp0cnVlLCJFbGFzdGljc2VhcmNoIChsejQpIjp0cnVlLCJGZXJyZXREQiAoc25hcHB5KSI6dHJ1ZSwiRmVycmV0REIgKHpzdGQpIjp0cnVlLCJHcmVwdGltZURCIjp0cnVlLCJNb25nb0RCIChzbmFwcHkpIjp0cnVlLCJNb25nb0RCICh6c3RkKSI6dHJ1ZSwiUG9zdGdyZVNRTCI6dHJ1ZSwiU2luZ2xlU3RvcmUiOnRydWUsIlN0YXJyb2NrcyI6dHJ1ZSwiVmljdG9yaWFMb2dzIjp0cnVlfSwic2NhbGUiOjEwMDAwMDAwMDAsIm1ldHJpYyI6ImNvbGQiLCJxdWVyaWVzIjpbdHJ1ZSx0cnVlLHRydWUsdHJ1ZSx0cnVlXSwicmV0YWluX3N0cnVjdHVyZSI6eyJ5ZXMiOnRydWUsIm5vIjpmYWxzZX19" ref="nofollow noopener noreferrer">Doris 3.1 结果</a></li>
<li>更多测试数据及报告详见 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.selectdb.com%2Fblog%2F1421" target="_blank" title="https://www.selectdb.com/blog/1421" ref="nofollow noopener noreferrer">SelectDB 官方博客</a></li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4a41c258c9e41d787e55046678cce6b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763457025&amp;x-signature=F9SQYgzBFePZQUFjr%2BcFkLWjD%2BE%3D" alt="Doris 冷查性能 Top 1.png" loading="lazy"/></p>
<p>从榜单可以清晰地看到，Doris （分数 1.57） 具备压倒性的性能优势：其速度约是 MongoDB （分数 258.21） 的 164 倍，是 PostgreSQL （分数 1687.29） 的 1074 倍。同时，以近 2 倍的优势领先于 Elasticsearch （分数 3.01），成为更具竞争力的选择。</p>
<p>此外，Doris 在热查询下也表现优异，仅次于榜单发起者 ClickHouse，位居第二。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/11724280a246484aaeefe672f8e29543~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgU2VsZWN0REI=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763457025&amp;x-signature=irD8G8OU0EFXZq7V1C%2BlvCeiSBU%3D" alt="Doris 冷查性能 Top 1-1.PNG" loading="lazy"/></p>
<h3 data-id="heading-2">性能登顶的背后</h3>
<p>Apache Doris 在冷查询场景下的卓越性能，得益于其在以下几方面的协同：</p>
<ul>
<li><strong>高效 I/O 路径</strong>：通过 Path 级别列裁剪和延迟物化机制，冷读 JSON 子列时仅加载必需的数据，精确命中、减少数据读放大问题；</li>
<li><strong>Variant 子列级索引</strong>：支持 JSON 路径索引（ZoneMap、BloomFilter 等稀疏索引）和谓词下推，支持文件级别裁剪，可加速过滤条件的定位；</li>
<li><strong>强大的查询引擎</strong>：具备高效的向量化执行引擎以及并发查询机制，显著提升查询效率；</li>
<li><strong>智能缓存策略</strong>：在冷查时，结合预读与页缓存，可提升系统整体吞吐。</li>
</ul>
<p>同时，在 Doris 3.1 版本中，Doris 对 Variant 类型进行了系统性优化，使其在冷查场景下有更为可观的性能提升：</p>
<ul>
<li><strong>稀疏子列（Sparse Sub-Column）机制</strong>：仅列式存储高频出现的 JSON 键，减少 I/O 与元数据开销；</li>
<li>**子列模板化（Schema Template）机制：**固定子列类型，确保索引命中更加稳定；</li>
<li><strong>列裁剪与路径索引优化</strong>：冷读时可精确定位目标子列，避免全字段扫描，并能实现更稳定的索引命中。</li>
</ul>
<p>详情参考：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdoris.apache.org%2Fzh-CN%2Fdocs%2F3.x%2Fsql-manual%2Fbasic-element%2Fsql-data-types%2Fsemi-structured%2FVARIANT" target="_blank" title="https://doris.apache.org/zh-CN/docs/3.x/sql-manual/basic-element/sql-data-types/semi-structured/VARIANT" ref="nofollow noopener noreferrer">Variant 数据类型</a></p>
<h3 data-id="heading-3">选择 Apache Doris</h3>
<p>对于追求稳定、高效、低延迟的半结构化分析系统而言，Apache Doris 3.1 正在成为新的性能标杆。其核心价值体现在：</p>
<ul>
<li><strong>秒级查询响应</strong>：在日志、埋点、事件数据分析场景中，实现秒级响应，支持实时探索；</li>
<li><strong>适用存算分离架构</strong>：即使在基于 S3、HDFS 的大规模存算分离架构中，冷查询性能依然强劲；</li>
<li><strong>极低 I/O 成本</strong>：在相同查询规模下，Doris 的冷查 I/O 成本相比 Elasticsearch 可降低 60% 以上；</li>
<li><strong>技术架构升级</strong>：从上文可知，Doris 在 JSON 分析场景中，性能远超 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FClickHouse%2FJSONBench%2Fblob%2Fmain%2Fmongodb%2Fresults%2Fm6i.8xlarge_bluesky_1000m_snappy.json" target="_blank" title="https://github.com/ClickHouse/JSONBench/blob/main/mongodb/results/m6i.8xlarge_bluesky_1000m_snappy.json" ref="nofollow noopener noreferrer">MongoDB</a>、<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FClickHouse%2FJSONBench%2Fblob%2Fmain%2Fpostgresql%2Fresults%2Fm6i.8xlarge_bluesky_1000m.json" target="_blank" title="https://github.com/ClickHouse/JSONBench/blob/main/postgresql/results/m6i.8xlarge_bluesky_1000m.json" ref="nofollow noopener noreferrer">PostgreSQL</a> 以及 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FClickHouse%2FJSONBench%2Fblob%2Fmain%2Felasticsearch%2Fresults%2Fm6i.8xlarge_bluesky_source_1000m_default_compression.json" target="_blank" title="https://github.com/ClickHouse/JSONBench/blob/main/elasticsearch/results/m6i.8xlarge_bluesky_source_1000m_default_compression.json" ref="nofollow noopener noreferrer">Elasticsearch</a>，是当下更具竞争力的半结构化数据分析的选择。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[8. DPDK：多队列与流分类]]></title>    <link>https://juejin.cn/post/7571278865516560434</link>    <guid>https://juejin.cn/post/7571278865516560434</guid>    <pubDate>2025-11-11T09:08:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571278865516560434" data-draft-id="7571278865516331058" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="8. DPDK：多队列与流分类"/> <meta itemprop="keywords" content="后端,网络协议"/> <meta itemprop="datePublished" content="2025-11-11T09:08:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Yefimov"/> <meta itemprop="url" content="https://juejin.cn/user/2573309794326910"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            8. DPDK：多队列与流分类
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2573309794326910/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Yefimov
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:08:11.000Z" title="Tue Nov 11 2025 09:08:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1 为什么单个CPU核处理不过来了？</h2>
<blockquote>
<p>想象一下，你让一个单线程CPU去处理每秒 10Gbps 的网络流量——  这就像让一个人单手接住从天上掉下的一万颗玻璃珠。</p>
<p>结果显而易见：CPU中断风暴、缓存失效、丢包频发。</p>
<p>于是，<strong>多核CPU的崛起</strong>带来了新的思路：  “如果网卡能把不同的流分给不同的CPU核来处理，就能实现并行处理。”</p>
<p>这就是 <strong>网卡多队列技术（Multi-Queue NIC）</strong> 的诞生。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">1.1 硬件视角：Intel 82580 的多队列架构</h3>
<p>每个<strong>队列（Queue）</strong> 就像是一条独立的“数据高速公路”， 拥有自己的<strong>DMA通道、描述符环（Descriptor Ring）和中断号</strong>。</p>
<p>当数据包到达时，网卡会根据一定的规则（哈希或流分类），决定它应该进入哪个接收队列（Rx Queue）。<br/>
这些队列随后可以<strong>绑定到不同CPU核</strong>上实现并行处理。</p>
<blockquote>
<p>💡 类比理解：<br/>
如果说传统单队列网卡是一条高速路所有车辆都挤在一个收费口，  那么多队列网卡则是“多收费口并行放行”，极大缓解了瓶颈。</p>
</blockquote>
<hr/>
<h3 data-id="heading-2">1.2 Linux 内核对多队列的利用</h3>
<p>Linux 内核为多队列网卡提供了完善的支持，包括：</p>
<h5 data-id="heading-3">接收侧（Rx）</h5>
<ul>
<li>每个接收队列可对应独立中断，通过 <strong>IRQ Affinity</strong> 绑定到特定核。</li>
<li>可使用 <strong>RPS（Receive Packet Steering）</strong> 模拟硬件多队列效果，将不同流的软中断分散到多核。</li>
</ul>
<h5 data-id="heading-4">发送侧（Tx）</h5>
<ul>
<li>使用 <strong>XPS（Transmit Packet Steering）</strong> 机制，为每个CPU指定发送队列。</li>
<li>减少锁竞争，提升cache命中率。</li>
</ul>
<p>代码片段：</p>
<pre><code class="hljs language-ini" lang="ini">int dev_queue_xmit(struct sk_buff *skb) {
    struct net_device *<span class="hljs-attr">dev</span> = skb-&gt;dev<span class="hljs-comment">;</span>
    <span class="hljs-attr">txq</span> = dev_pick_tx(dev, skb)<span class="hljs-comment">; // 选择合适的发送队列</span>
    spin_lock_prefetch(&amp;txq-&gt;lock)<span class="hljs-comment">;</span>
    ...
}
</code></pre>
<p>Linux的策略很灵活，但<strong>仍有锁与上下文切换开销</strong>。</p>
<hr/>
<h3 data-id="heading-5">1.3 DPDK的革命性改进：核-队列一对一绑定</h3>
<p>DPDK抛弃内核协议栈后，采用<strong>用户态直接访问网卡队列</strong>的模型：</p>
<ul>
<li>每个核（lcore）只负责一个接收队列 + 一个发送队列。</li>
<li>收发包都在该核上完成，无需锁。</li>
<li>数据缓存在本地HugePage内存池中，cache命中率极高。</li>
</ul>
<p>代码（摘自l3fwd）：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">ret</span> = rte_eth_dev_configure(portid, nb_rx_queue, nb_tx_queue, &amp;port_conf)<span class="hljs-comment">;</span>
<span class="hljs-attr">ret</span> = rte_eth_tx_queue_setup(portid, queueid, nb_txd, socketid, txconf)<span class="hljs-comment">;</span>
qconf-&gt;tx_queue_id<span class="hljs-section">[portid]</span> = queueid<span class="hljs-comment">;</span>
...
rte_eth_tx_burst(port, queueid, m_table, n)<span class="hljs-comment">;</span>
</code></pre>
<blockquote>
<p>小结：DPDK 的多队列模型 = 零锁 + 零拷贝 + 高亲和。</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">1.4 队列分配策略：RSS 与 Flow Director</h3>
<p>网卡分流的核心是<strong>Queue Select</strong>逻辑：</p>
<ol>
<li><strong>RSS（Receive Side Scaling）</strong> ：基于哈希（四元组）平均分配流量，负载均衡。</li>
<li><strong>Flow Director（Intel FD）</strong> ：基于流表匹配，将特定流导向特定队列（如特定核或VM）。</li>
</ol>
<p>现代网卡（如 Intel XL710）同时支持多种策略，可实现更精细的流量控制。</p>
<h2 data-id="heading-7">2. 为什么网卡要学会“分类”？</h2>
<blockquote>
<p>在传统的单队列网卡中，所有流量都混在一条流水线中。<br/>
这就像所有车辆都挤在一个收费站口——无论是紧急车辆还是普通车辆，都得排队。</p>
<p>而现代的智能网卡（SmartNIC）则能在硬件层面进行“流分类（Flow Classification）”：<br/>
它能识别出不同类型的流量，并将它们导向不同的处理队列。</p>
<p>这就是今天要讲的主角 —— <strong>流分类（Flow Classification）</strong> 。</p>
</blockquote>
<hr/>
<h3 data-id="heading-8">2.1 网卡眼中的“包类型”：识别是第一步</h3>
<p>要做分类，首先得<strong>看得懂包</strong>。</p>
<p>以 Intel XL710 为例，它能直接识别出以下包类型：</p>

























<table><thead><tr><th>层级</th><th>示例</th></tr></thead><tbody><tr><td>L2</td><td>以太网、VLAN</td></tr><tr><td>L3</td><td>IPv4、IPv6</td></tr><tr><td>L4</td><td>TCP、UDP</td></tr><tr><td>隧道</td><td>VXLAN、NVGRE</td></tr></tbody></table>
<p>网卡会把这些信息写进接收描述符（Rx Descriptor），DPDK应用程序就能直接从 <code>rte_mbuf.packet_type</code> 字段中读取到：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">rte_mbuf</span> {
    <span class="hljs-keyword">union</span> {
        <span class="hljs-type">uint32_t</span> packet_type; <span class="hljs-comment">/**&lt; L2/L3/L4/tunnel 信息 */</span>
        <span class="hljs-keyword">struct</span> {
            <span class="hljs-type">uint32_t</span> l2_type:<span class="hljs-number">4</span>;
            <span class="hljs-type">uint32_t</span> l3_type:<span class="hljs-number">4</span>;
            <span class="hljs-type">uint32_t</span> l4_type:<span class="hljs-number">4</span>;
            <span class="hljs-type">uint32_t</span> tun_type:<span class="hljs-number">4</span>;
            ...
        };
    };
};
</code></pre>
<p>这意味着：</p>
<ul>
<li>应用层<strong>无需再自己解析包头</strong>；</li>
<li>可以<strong>直接判断包类型</strong>，从而决定处理逻辑；</li>
<li>还能结合流分类机制，决定该包属于哪个队列。</li>
</ul>
<hr/>
<h3 data-id="heading-9">2.2 RSS：最经典的负载均衡算法</h3>
<p><strong>RSS（Receive-Side Scaling）</strong> 是最常见、最基础的流分类技术。</p>
<p>它的核心思想非常简单：</p>
<blockquote>
<p>“用哈希算法把流均匀分配到不同的队列。”</p>
</blockquote>
<p>具体过程如下：</p>
<ol>
<li>从包中抽取关键字（Key），如 <code>源IP、目的IP、源端口、目的端口</code>；</li>
<li>用哈希函数（通常是 Toeplitz Hash）计算出哈希值；</li>
<li>用哈希值映射到某个队列编号；</li>
<li>数据包DMA到对应的接收队列。</li>
</ol>
<p>以IPv4 UDP 为例，关键字是四元组：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">Key</span> = SrcIP + DstIP + SrcPort + DstPort
</code></pre>
<p>Intel XL710 网卡支持多种哈希算法（包括对称哈希），这样双向流（A→B 与 B→A）可以被分配到同一个队列上，非常适合防火墙、负载均衡等场景。</p>
<blockquote>
<p>🧠 类比：RSS 就像一台“高速公路匝道分流器”，<br/>
它不会管车是什么类型，只负责“均匀分车道”。</p>
</blockquote>
<p>DPDK中可通过 <code>rte_eth_dev_configure()</code> 和 <code>rte_eth_dev_rss_hash_update()</code> 等API配置RSS。</p>
<hr/>
<h3 data-id="heading-10">2.3 Flow Director：让网卡“定向分流”</h3>
<p><strong>Flow Director（FDIR）</strong> 是RSS的“进阶版”。<br/>
RSS是<strong>哈希随机分流</strong>，而Flow Director是<strong>规则匹配分流</strong>。</p>
<p>其原理：</p>
<ul>
<li>网卡中维护一张 <strong>Flow Table</strong>；</li>
<li>驱动或应用可以动态添加规则；</li>
<li>当网卡收到数据包时，会根据关键字段匹配表项；</li>
<li>匹配成功后执行对应动作（如：导入特定队列、丢弃）。</li>
</ul>
<p>示意：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[Packet]</span> --&gt; <span class="hljs-selector-attr">[Flow Director Table]</span> --&gt; <span class="hljs-selector-attr">[Action: Queue 3 / Drop / Forward]</span>
</code></pre>
<p>例如，你可以设置：</p>
<blockquote>
<p>所有 <code>S-IP=10.0.0.1, D-Port=80</code> 的TCP包 → 队列1<br/>
所有 <code>S-IP=10.0.0.2, D-Port=443</code> 的TCP包 → 队列2</p>
</blockquote>
<p>这样，特定业务流量（如HTTP、HTTPS）可以绑定到不同核处理，提高cache命中率、减少锁争用。</p>
<p><strong>RSS vs Flow Director 对比表</strong></p>






























<table><thead><tr><th>特性</th><th>RSS</th><th>流量导向器</th></tr></thead><tbody><tr><td>分流规则</td><td>哈希（平均分配）</td><td>精确匹配</td></tr><tr><td>动态可配置</td><td>否</td><td>是</td></tr><tr><td>典型场景</td><td>负载均衡</td><td>精确流控、QoS、NFV</td></tr><tr><td>实现复杂度</td><td>低</td><td>高（需硬件支持）</td></tr></tbody></table>
<blockquote>
<p>Flow Director 的哲学： <strong>“不平均，但精确。”</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-11">2.4 QoS：网卡级的服务质量调度</h3>
<p>在大型数据中心或NFV环境中，不同业务流量有不同的优先级，QoS（Quality of Service）就是要在<strong>网卡层面实现优先级调度</strong>。</p>
<p>Intel 82599 网卡支持 DCB（Data Center Bridging）模型：</p>
<h5 data-id="heading-12">发送方向（Tx）</h5>
<ul>
<li>通过 VLAN Tag 中的 <strong>UP（User Priority）字段</strong> 确定业务类型；</li>
<li>不同 UP → 不同 TC（Traffic Class）；</li>
<li>每个 TC 拥有独立队列和 buffer；</li>
<li>网卡使用 <strong>加权严格优先级（WSP）</strong> 调度算法决定先发哪个队列。</li>
</ul>
<h5 data-id="heading-13">接收方向（Rx）</h5>
<ul>
<li>根据 UP 决定TC；</li>
<li>TC 内部再通过RSS或Flow Director细分。</li>
</ul>
<blockquote>
<p>类比：QoS 就像机场的登机口分区，<br/>
头等舱、商务舱、经济舱虽然都上飞机，但排队顺序不一样。</p>
</blockquote>
<hr/>
<h3 data-id="heading-14">2.5 虚拟化场景下的多队列调度</h3>
<p>在SR-IOV或VMDQ场景中，<strong>每个虚拟机（VF）或虚拟池（POOL）</strong>  都对应一组独立的硬件队列。</p>
<p>例如：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable constant_">PF</span>（物理功能）
 ├── <span class="hljs-title class_">VF0</span> → <span class="hljs-title class_">Queue</span> <span class="hljs-title class_">Set</span> <span class="hljs-number">0</span>
 ├── <span class="hljs-title class_">VF1</span> → <span class="hljs-title class_">Queue</span> <span class="hljs-title class_">Set</span> <span class="hljs-number">1</span>
 └── <span class="hljs-title class_">VF2</span> → <span class="hljs-title class_">Queue</span> <span class="hljs-title class_">Set</span> <span class="hljs-number">2</span>
</code></pre>
<p>这使得虚拟机能直接接收属于自己的流量，避免VM之间的干扰。<br/>
DPDK中可通过 <code>rte_eth_dev_set_vf_rx_queue_assignment()</code> 等API管理VF队列。</p>
<hr/>
<h3 data-id="heading-15">2.6 流过滤（Flow Filtering）：最后一道防线</h3>
<p>在所有分类动作之前，网卡会先进行合法性过滤：</p>
<ol>
<li>MAC 地址过滤（L2Filter）</li>
<li>VLAN 标签过滤</li>
<li>管理控制帧过滤（如ARP、LLDP）</li>
</ol>
<p>Intel 网卡还提供：</p>
<ul>
<li><strong>Src MAC/VLAN Antispoofing</strong>（防欺骗）</li>
<li><strong>N-Tuple Filter</strong>（自定义五元组匹配）</li>
<li><strong>Cloud Filter</strong>（VXLAN/NVGRE等隧道过滤）</li>
</ul>
<blockquote>
<p>总结：过滤 ≈ “保安岗”；分类 ≈ “分流岗”。<br/>
一前一后，保障安全与性能并重。</p>
</blockquote>
<h3 data-id="heading-16">3. 控制流与数据流的分治难题</h3>
<p>在DPDK的高速转发场景中，我们常常面临这样的设计矛盾：</p>
<ul>
<li><strong>转发流量（Data Plane）</strong> 要求<strong>高吞吐、低延迟</strong>，需要多个核心并行；</li>
<li><strong>控制流量（Control Plane）</strong> 数量不大，但要求<strong>稳定、可靠</strong>，而且逻辑完全不同。</li>
</ul>
<p>举个例子：</p>
<blockquote>
<p>路由器需要高速转发数据包（多核并行），  但同时也要解析少量控制报文（如ARP、心跳等），  你不希望这点控制包影响主数据流的性能。</p>
</blockquote>
<p>那么，<strong>如何在硬件层面实现“分流”</strong> ？<br/>
这正是DPDK结合<strong>RSS + Flow Director</strong>的经典应用场景👇</p>
<hr/>
<h4 data-id="heading-17">3.1 DPDK配置实战：让网卡学会智能分流</h4>
<p>下面是一段完整的配置逻辑，我们以 Intel® 82599 为例。</p>
<h5 data-id="heading-18">（1）初始化网卡配置</h5>
<p>这里需要同时打开 <strong>RSS</strong> 和 <strong>Flow Director</strong> 两种分类机制：</p>
<pre><code class="hljs language-ini" lang="ini">static struct rte_eth_conf <span class="hljs-attr">port_conf</span> = {
    .<span class="hljs-attr">rxmode</span> = {
        .<span class="hljs-attr">mq_mode</span> = ETH_MQ_RX_RSS, // 启用多队列 + RSS
    },
    .<span class="hljs-attr">rx_adv_conf</span> = {
        .<span class="hljs-attr">rss_conf</span> = {
            .<span class="hljs-attr">rss_key</span> = NULL,
            .<span class="hljs-attr">rss_hf</span> = ETH_RSS_IP | ETH_RSS_UDP |
                      ETH_RSS_TCP | ETH_RSS_SCTP,
        },
    },
    .<span class="hljs-attr">fdir_conf</span> = {
        .<span class="hljs-attr">mode</span> = RTE_FDIR_MODE_PERFECT,      // 精确匹配模式
        .<span class="hljs-attr">pballoc</span> = RTE_FDIR_PBALLOC_64K,    // 表大小
        .<span class="hljs-attr">status</span> = RTE_FDIR_REPORT_STATUS,   // 报文上报
        .<span class="hljs-attr">mask</span> = {
            .<span class="hljs-attr">ipv4_mask</span> = {
                .<span class="hljs-attr">src_ip</span> = <span class="hljs-number">0</span>xFFFFFFFF,
                .<span class="hljs-attr">dst_ip</span> = <span class="hljs-number">0</span>xFFFFFFFF,
            },
            .<span class="hljs-attr">src_port_mask</span> = <span class="hljs-number">0</span>xFFFF,
            .<span class="hljs-attr">dst_port_mask</span> = <span class="hljs-number">0</span>xFFFF,
        },
        .<span class="hljs-attr">drop_queue</span> = <span class="hljs-number">127</span>, // 匹配失败的流默认丢弃
    },
}<span class="hljs-comment">;</span>

rte_eth_dev_configure(port, 4, 4, &amp;port_conf)<span class="hljs-comment">; // 启用4个收发队列</span>
</code></pre>
<blockquote>
<p>提示：RSS和FDIR都依赖硬件资源，配置时要注意网卡是否支持（如82599/XL710均支持）。</p>
</blockquote>
<hr/>
<h5 data-id="heading-19">（2）配置收发队列</h5>
<pre><code class="hljs language-ini" lang="ini">struct rte_mempool *<span class="hljs-attr">mbuf_pool</span> =
    rte_pktmbuf_pool_create("MBUF_POOL", 8192, 256, 0,
                            RTE_MBUF_DEFAULT_BUF_SIZE, rte_socket_id())<span class="hljs-comment">;</span>

for (int <span class="hljs-attr">q</span> = <span class="hljs-number">0</span><span class="hljs-comment">; q &lt; 4; q++) {</span>
    rte_eth_rx_queue_setup(port, q, 128,
        rte_eth_dev_socket_id(port), NULL, mbuf_pool)<span class="hljs-comment">;</span>
    rte_eth_tx_queue_setup(port, q, 128,
        rte_eth_dev_socket_id(port), NULL)<span class="hljs-comment">;</span>
}
</code></pre>
<hr/>
<h5 data-id="heading-20">（3）启动设备</h5>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">rte_eth_dev_start</span>(port);
</code></pre>
<hr/>
<h5 data-id="heading-21">（4）添加Flow Director规则</h5>
<p>将特定UDP报文（源IP=2.2.2.3，目的IP=2.2.2.5，端口=1024）<br/>
直接导入队列3：</p>
<pre><code class="hljs language-ini" lang="ini">struct rte_eth_fdir_filter <span class="hljs-attr">filter</span> = {
    .<span class="hljs-attr">soft_id</span> = <span class="hljs-number">1</span>,
    .<span class="hljs-attr">input</span> = {
        .<span class="hljs-attr">flow_type</span> = RTE_ETH_FLOW_NONFRAG_IPV4_UDP,
        .<span class="hljs-attr">flow</span> = {
            .<span class="hljs-attr">udp4_flow</span> = {
                .<span class="hljs-attr">ip</span> = {
                    .<span class="hljs-attr">src_ip</span> = RTE_IPV4(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>),
                    .<span class="hljs-attr">dst_ip</span> = RTE_IPV4(<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>,<span class="hljs-number">5</span>),
                },
                .<span class="hljs-attr">src_port</span> = rte_cpu_to_be_16(<span class="hljs-number">1024</span>),
                .<span class="hljs-attr">dst_port</span> = rte_cpu_to_be_16(<span class="hljs-number">1024</span>),
            },
        },
    },
    .<span class="hljs-attr">action</span> = {
        .<span class="hljs-attr">rx_queue</span> = <span class="hljs-number">3</span>,
        .<span class="hljs-attr">behavior</span> = RTE_ETH_FDIR_ACCEPT,
        .<span class="hljs-attr">report_status</span> = RTE_ETH_FDIR_REPORT_ID,
    },
}<span class="hljs-comment">;</span>

rte_eth_dev_filter_ctrl(port, RTE_ETH_FILTER_FDIR,
                        RTE_ETH_FILTER_ADD, &amp;filter)<span class="hljs-comment">;</span>
</code></pre>
<blockquote>
<p>这一行代码的意义：<br/>
Flow Director将特定UDP流量“精准派送”到队列3，由控制核单独处理。</p>
</blockquote>
<hr/>
<h5 data-id="heading-22">（5）调整RSS分配表（RETA）</h5>
<p>由于RSS默认会在0~3队列均衡分配，我们需要把队列3“剔除”，<br/>
让它只用于控制流。</p>
<pre><code class="hljs language-ini" lang="ini">struct rte_eth_rss_reta_entry64 reta_conf<span class="hljs-section">[2]</span><span class="hljs-comment">;</span>
int idx, i, <span class="hljs-attr">q</span> = <span class="hljs-number">0</span><span class="hljs-comment">;</span>
for (<span class="hljs-attr">idx</span> = <span class="hljs-number">0</span><span class="hljs-comment">; idx &lt; 2; idx++) {</span>
    reta_conf<span class="hljs-section">[idx]</span>.<span class="hljs-attr">mask</span> = ~<span class="hljs-number">0</span>ULL<span class="hljs-comment">;</span>
    for (<span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; RTE_RETA_GROUP_SIZE; i++, q++) {</span>
        if (<span class="hljs-attr">q</span> == <span class="hljs-number">3</span>) q = <span class="hljs-number">0</span><span class="hljs-comment">;  // 不分配到队列3</span>
        reta_conf<span class="hljs-section">[idx]</span>.reta<span class="hljs-section">[i]</span> = q<span class="hljs-comment">;</span>
    }
}
rte_eth_dev_rss_reta_update(port, reta_conf, 128)<span class="hljs-comment">;</span>
</code></pre>
<p>这样：</p>
<ul>
<li>队列0~2 → RSS数据流；</li>
<li>队列3 → Flow Director控制流。</li>
</ul>
<hr/>
<h5 data-id="heading-23">（6）核心线程绑定与收发逻辑</h5>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// 每个核绑定一个接收队列</span>
<span class="hljs-built_in">rte_eal_remote_launch</span>(lcore_data_loop, (void*)<span class="hljs-number">0</span>, <span class="hljs-number">1</span>);
<span class="hljs-built_in">rte_eal_remote_launch</span>(lcore_data_loop, (void*)<span class="hljs-number">1</span>, <span class="hljs-number">2</span>);
<span class="hljs-built_in">rte_eal_remote_launch</span>(lcore_data_loop, (void*)<span class="hljs-number">2</span>, <span class="hljs-number">3</span>);
<span class="hljs-built_in">rte_eal_remote_launch</span>(lcore_ctrl_loop, (void*)<span class="hljs-number">3</span>, <span class="hljs-number">4</span>);
</code></pre>
<p>在 <code>lcore_ctrl_loop()</code> 中单独处理UDP控制包，即可完成控制/数据分治。</p>
<h2 data-id="heading-24">4. 什么是 RMT（Reconfigurable Match Table）</h2>
<p>RMT，全称 <strong>Reconfigurable Match Table（可重构匹配表）</strong> ，最早由斯坦福大学在 SDN（Software Defined Networking）架构中提出，用于抽象网络设备的<strong>数据平面可编程能力</strong>。</p>
<h3 data-id="heading-25">4.1 传统网络处理方式</h3>
<p>在传统 ASIC（固定逻辑）网络设备中，<strong>匹配 + 动作（Match + Action）</strong> 是固化的：</p>
<ul>
<li>只能匹配特定字段（如 MAC、IP、TCP 端口）。</li>
<li>动作集有限（如转发、丢弃、修改头部）。</li>
<li>一旦芯片逻辑定死，就无法修改。</li>
</ul>
<p>因此，当我们要引入新协议（VXLAN、Geneve、SRv6）或新处理逻辑时，就必须等芯片厂商推出新硬件。</p>
<hr/>
<h3 data-id="heading-26">4.2 RMT 的核心思想</h3>
<p>RMT 提出了一个通用抽象模型：  把<strong>数据包处理流程</strong>抽象为一系列可配置的「匹配+动作（Match-Action）」表组成的流水线（Pipeline）。</p>
<blockquote>
<p>每一级表：</p>
<ul>
<li>对输入包的某些字段进行匹配；</li>
<li>执行对应动作；</li>
<li>将结果（可能修改后的包）交给下一级表继续处理。</li>
</ul>
<p>硬件不再固定支持哪些协议或规则，而是提供「匹配表模板」，由软件定义匹配字段和动作逻辑。</p>
</blockquote>
<hr/>
<h3 data-id="heading-27">4.3 在 DPDK 中的意义</h3>
<p>虽然 DPDK 运行在软件层，但它与 RMT 思想天然契合。<br/>
例如：</p>
<ul>
<li><strong>rte_flow</strong> 定义的流表项（flow rule）→ 就是「Match + Action」模型；</li>
<li><strong>DOCA Flow、Mellanox mlx5、Intel ice PMD</strong> 都是把硬件的 Match-Action 能力开放出来。</li>
</ul>
<p>RMT 的提出，让我们可以从更抽象的层面理解：</p>
<blockquote>
<p>不同的网卡流分类机制，本质上只是匹配字段和动作集不同而已。</p>
</blockquote>
<hr/>
<h3 data-id="heading-28">4.4 可实践的代码示例：rte_flow 模拟 RMT</h3>
<p>在软件层，你可以通过 DPDK 的 <code>rte_flow</code> 接口，构建类似 RMT 的多级匹配规则。</p>
<p>例如，匹配 IPv4 源地址并重定向：</p>
<pre><code class="hljs language-ini" lang="ini">struct rte_flow_attr <span class="hljs-attr">attr</span> = { .ingress = <span class="hljs-number">1</span> }<span class="hljs-comment">;</span>
struct rte_flow_item pattern<span class="hljs-section">[3]</span><span class="hljs-comment">;</span>
struct rte_flow_action action<span class="hljs-section">[2]</span><span class="hljs-comment">;</span>

// 匹配 IPv4 源地址
struct rte_flow_item_ipv4 <span class="hljs-attr">ip_spec</span> = { .hdr.src_addr = RTE_BE32(<span class="hljs-number">0</span>xC0A80101) }<span class="hljs-comment">; // 192.168.1.1</span>
struct rte_flow_item_ipv4 <span class="hljs-attr">ip_mask</span> = { .hdr.src_addr = <span class="hljs-number">0</span>xFFFFFFFF }<span class="hljs-comment">;</span>
pattern<span class="hljs-section">[0]</span>.<span class="hljs-attr">type</span> = RTE_FLOW_ITEM_TYPE_IPV4<span class="hljs-comment">;</span>
pattern<span class="hljs-section">[0]</span>.<span class="hljs-attr">spec</span> = &amp;ip_spec<span class="hljs-comment">;</span>
pattern<span class="hljs-section">[0]</span>.<span class="hljs-attr">mask</span> = &amp;ip_mask<span class="hljs-comment">;</span>
pattern<span class="hljs-section">[1]</span>.<span class="hljs-attr">type</span> = RTE_FLOW_ITEM_TYPE_END<span class="hljs-comment">;</span>

// 动作：重定向到队列1
struct rte_flow_action_queue <span class="hljs-attr">queue</span> = { .index = <span class="hljs-number">1</span> }<span class="hljs-comment">;</span>
action<span class="hljs-section">[0]</span>.<span class="hljs-attr">type</span> = RTE_FLOW_ACTION_TYPE_QUEUE<span class="hljs-comment">;</span>
action<span class="hljs-section">[0]</span>.<span class="hljs-attr">conf</span> = &amp;queue<span class="hljs-comment">;</span>
action<span class="hljs-section">[1]</span>.<span class="hljs-attr">type</span> = RTE_FLOW_ACTION_TYPE_END<span class="hljs-comment">;</span>

struct rte_flow *<span class="hljs-attr">flow</span> = rte_flow_create(port_id, &amp;attr, pattern, action, &amp;error)<span class="hljs-comment">;</span>
</code></pre>
<p>这个简单示例本质上就是一个最小化的「RMT 一级表」：</p>
<ol>
<li>匹配 IPv4 地址 → 执行动作（重定向）。</li>
<li>多级匹配可以用多个 <code>rte_flow</code> pipeline 串联实现。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 useState 到 URLState：为什么大佬们都在删状态管理代码？]]></title>    <link>https://juejin.cn/post/7571126773808988170</link>    <guid>https://juejin.cn/post/7571126773808988170</guid>    <pubDate>2025-11-11T09:17:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571126773808988170" data-draft-id="7571279513246793754" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 useState 到 URLState：为什么大佬们都在删状态管理代码？"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-11-11T09:17:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="冴羽"/> <meta itemprop="url" content="https://juejin.cn/user/712139234359182"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 useState 到 URLState：为什么大佬们都在删状态管理代码？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/712139234359182/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    冴羽
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:17:26.000Z" title="Tue Nov 11 2025 09:17:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1. 前言</h2>
<p>当你打开这个网址时：</p>
<pre><code class="hljs language-plain" lang="plain">https://prismjs.com/download.html#themes=prism&amp;languages=markup+css+clike+javascript&amp;plugins=line-numbers
</code></pre>
<p>你会发现，所有你需要的主题、语言、插件已经被自动勾选：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/440237b179154fa19996d810fff3ef00~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Ya05769:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763457446&amp;x-signature=7pH71TFkjLgtncWsRf93PhzwmQE%3D" alt="" loading="lazy"/></p>
<p>当你在页面修改配置时，URL 也会随之改变。</p>
<p>你看，这个 URL 不仅仅是一个链接，更是一个<strong>完整的状态容器</strong>，保存了我的所有配置。无需数据库、cookie 或 localStorage，一个 URL 就解决了一切。</p>
<h2 data-id="heading-1">2. 被忽视的 URL 超能力</h2>
<p>URL 是互联网最伟大的创意之一，通过 URL 请求，我们可以查找到网络上的唯一资源。</p>
<p>它的标准格式为：<code>&lt;scheme&gt;://&lt;netloc&gt;/&lt;path&gt;?&lt;query&gt;#&lt;fragment&gt;</code>。</p>
<p>但 URL 的价值远不止于此——它们是<strong>天然的状态管理解决方案</strong>。想想 URL 给我们带来的好处：</p>
<ul>
<li><strong>可分享性</strong>：发送链接，对方会看到与你完全相同的内容</li>
<li><strong>可书签化</strong>：保存 URL 就是保存一个特定时刻的状态</li>
<li><strong>浏览器历史</strong>：后退按钮正常工作</li>
<li><strong>深度链接</strong>：直接跳转到应用的特定状态</li>
</ul>
<p>URL 使 Web 应用具有<strong>韧性和可预测性</strong>。它们是 Web 最初的状态管理方案，自 1990 年以来就开始使用，所以千万不要忘记使用这种方式。</p>
<h2 data-id="heading-2">3. URL 如何编码状态？</h2>
<p>URL 的不同部分编码不同类型的状态：</p>
<p><strong>路径段（/path/to/myfile.html）</strong>：最适合层次化资源导航</p>
<pre><code class="hljs language-plain" lang="plain">/users/123/posts        # 用户123的文章
/docs/api/authentication # 文档结构
</code></pre>
<p><strong>查询参数（?key1=value1&amp;key2=value2）</strong>：完美用于过滤器、选项和配置</p>
<pre><code class="hljs language-plain" lang="plain">?theme=dark&amp;lang=en     # UI 偏好设置
?page=2&amp;limit=20        # 分页
?status=active&amp;sort=date # 数据过滤
</code></pre>
<p><strong>锚点片段（#SomewhereInTheDocument）</strong>：适合客户端导航和页面部分</p>
<pre><code class="hljs language-plain" lang="plain">#L20-L35        # GitHub 行高亮
#features       # 滚动到某个章节
</code></pre>
<h2 data-id="heading-3">4. URL 编码状态常见模式</h2>
<h3 data-id="heading-4">4.1. 多个带分隔符的值</h3>
<pre><code class="hljs language-plain" lang="plain">?languages=javascript+typescript+python
?tags=frontend,react,hooks
</code></pre>
<p>这种方式简洁易读，但需要在服务器端手动解析。</p>
<h3 data-id="heading-5">4.2. 嵌套或结构化数据</h3>
<pre><code class="hljs language-plain" lang="plain">?filters=status:active,owner:me,priority:high
?config=eyJyaWNrIjoicm9sbCJ9==  (base64-encoded JSON)
</code></pre>
<p>开发者有时会将复杂的筛选器或配置对象编码到单个查询字符串中。</p>
<p>一种简单的约定是使用逗号分隔的键值对，而其他方法则会序列化 JSON，甚至为了安全起见对其进行 Base64 编码。</p>
<h3 data-id="heading-6">4.3. 数组处理（方括号表示法）</h3>
<pre><code class="hljs language-plain" lang="plain">?tags[]=frontend&amp;tags[]=react&amp;tags[]=hooks
?ids[0]=42&amp;ids[1]=73
</code></pre>
<p>一种古老的模式是方括号表示法，它用于在查询参数中表示数组。这种表示法起源于早期的 Web 框架，例如 PHP，在 <code>[]</code> 参数名称后添加括号表示多个值应该组合在一起。</p>
<p>许多现代框架和解析器（例如 Node 的 qs 库或 Express 中间件）仍然能够自动识别这种模式。然而，它并未在 URL 规范中正式标准化，因此其行为可能因服务器或客户端的实现而异。</p>
<h3 data-id="heading-7">4.4. 布尔处理</h3>
<p>对于 flag 或开关，通常会显式传递布尔值，或者依赖于键值是否为真。这样可以缩短 URL 长度，并简化功能切换。</p>
<pre><code class="hljs language-plain" lang="plain">?debug=true&amp;analytics=false
?mobile  (presence = true)
</code></pre>
<h3 data-id="heading-8">4.5. 结论</h3>
<p>使用哪种模式都是可以的，关键在于保持一致性。选择适合你应用场景的模式，并坚持使用。</p>
<h2 data-id="heading-9">5. 实际应用案例</h2>
<p><strong>GitHub 行高亮：</strong></p>
<pre><code class="hljs language-plain" lang="plain">https://github.com/zepouet/Xee-xCode-4.5/blob/master/XeePhotoshopLoader.m#L108-L136
</code></pre>
<p>链接到特定文件，同时高亮显示 108-136 行。点击此链接，你会直接定位到讨论的确切代码部分。</p>
<p><strong>电商数据过滤器：</strong></p>
<pre><code class="hljs language-plain" lang="plain">https://store.com/laptops?brand=dell+hp&amp;price=500-1500&amp;rating=4&amp;sort=price-asc
</code></pre>
<p>这是最常见的实现。每个过滤条件、排序选项都被保存。用户可以用书签保存他们的筛选条件。</p>
<p><strong>谷歌地图：</strong></p>
<pre><code class="hljs language-plain" lang="plain">https://www.google.com/maps/@22.443842,-74.220744,19z
</code></pre>
<p>坐标、缩放级别和地图类型都包含在 URL 中。分享此链接，任何人都可以看到完全相同的地图视图。</p>
<h2 data-id="heading-10">6. 什么状态应该放入 URL？</h2>
<p>然而<strong>并非所有状态都应该属于 URL，那什么样的状态应该放入 URL 呢？</strong></p>
<p><strong>适合 URL 状态：</strong></p>
<ul>
<li>搜索查询和筛选器</li>
<li>分页和排序</li>
<li>视图模式（列表/网格、深色/浅色）</li>
<li>日期范围和时间段</li>
<li>选中项或活动标签</li>
<li>影响内容的 UI 配置</li>
<li>功能开关和 A/B 测试版本</li>
</ul>
<p><strong>不适合 URL 状态：</strong></p>
<ul>
<li>敏感信息（密码、令牌、个人身份信息）</li>
<li>临时 UI 状态（模态框打开/关闭）</li>
<li>表单输入进行中（未保存的更改）</li>
<li>极其庞大或复杂的嵌套数据</li>
<li>高频瞬态（鼠标位置、滚轮位置）</li>
</ul>
<p>简单来说，你的判断标准是：</p>
<p><strong>如果别人点击这个 URL，他们应该看到相同的状态吗？</strong></p>
<p>如果是，它就属于 URL。</p>
<h2 data-id="heading-11">7. 实现方案</h2>
<h3 data-id="heading-12">7.1. 使用纯 JavaScript 实现</h3>
<p>现代 URLSearchParams API 使 URL 状态管理变得简单：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 读取URL参数</span>
<span class="hljs-keyword">const</span> params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">search</span>);
<span class="hljs-keyword">const</span> view = params.<span class="hljs-title function_">get</span>(<span class="hljs-string">"view"</span>) || <span class="hljs-string">"grid"</span>; <span class="hljs-comment">// 默认值</span>
<span class="hljs-keyword">const</span> page = <span class="hljs-built_in">parseInt</span>(params.<span class="hljs-title function_">get</span>(<span class="hljs-string">"page"</span>)) || <span class="hljs-number">1</span>;

<span class="hljs-comment">// 更新URL参数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">updateFilters</span>(<span class="hljs-params">filters</span>) {
  <span class="hljs-keyword">const</span> params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">search</span>);

  params.<span class="hljs-title function_">set</span>(<span class="hljs-string">"status"</span>, filters.<span class="hljs-property">status</span>);
  params.<span class="hljs-title function_">set</span>(<span class="hljs-string">"sort"</span>, filters.<span class="hljs-property">sort</span>);

  <span class="hljs-comment">// 更新URL而不重新加载页面</span>
  <span class="hljs-keyword">const</span> newUrl = <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">window</span>.location.pathname}</span>?<span class="hljs-subst">${params.toString()}</span>`</span>;
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">pushState</span>({}, <span class="hljs-string">""</span>, newUrl);
}

<span class="hljs-comment">// 处理后/前进按钮</span>
<span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">"popstate"</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">search</span>);
  <span class="hljs-keyword">const</span> filters = {
    <span class="hljs-attr">status</span>: params.<span class="hljs-title function_">get</span>(<span class="hljs-string">"status"</span>) || <span class="hljs-string">"all"</span>,
    <span class="hljs-attr">sort</span>: params.<span class="hljs-title function_">get</span>(<span class="hljs-string">"sort"</span>) || <span class="hljs-string">"date"</span>,
  };
  <span class="hljs-title function_">renderContent</span>(filters);
});
</code></pre>
<h3 data-id="heading-13">7.2. 使用 React 实现</h3>
<p>React Router 提供了更简洁的钩子：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { useSearchParams } <span class="hljs-keyword">from</span> <span class="hljs-string">"react-router-dom"</span>;

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ProductList</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [searchParams, setSearchParams] = <span class="hljs-title function_">useSearchParams</span>();

  <span class="hljs-keyword">const</span> color = searchParams.<span class="hljs-title function_">get</span>(<span class="hljs-string">"color"</span>) || <span class="hljs-string">"all"</span>;
  <span class="hljs-keyword">const</span> sort = searchParams.<span class="hljs-title function_">get</span>(<span class="hljs-string">"sort"</span>) || <span class="hljs-string">"price"</span>;

  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleColorChange</span> = (<span class="hljs-params">newColor</span>) =&gt; {
    <span class="hljs-title function_">setSearchParams</span>(<span class="hljs-function">(<span class="hljs-params">prev</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(prev);
      params.<span class="hljs-title function_">set</span>(<span class="hljs-string">"color"</span>, newColor);
      <span class="hljs-keyword">return</span> params;
    });
  };

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{color}</span> <span class="hljs-attr">onChange</span>=<span class="hljs-string">{(e)</span> =&gt;</span> handleColorChange(e.target.value)}&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"all"</span>&gt;</span>所有颜色<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">option</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"silver"</span>&gt;</span>银色<span class="hljs-tag">&lt;/<span class="hljs-name">option</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span></span>
  );
}
</code></pre>
<h2 data-id="heading-14">8. URL 使用最佳实践</h2>
<h3 data-id="heading-15">8.1. <strong>优雅处理默认值</strong></h3>
<p>不要在 URL 中使用默认值：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-comment">// ❌</span>
?theme=light&amp;lang=en&amp;page=<span class="hljs-number">1</span>&amp;sort=date

<span class="hljs-comment">// ✅</span>
?theme=dark  <span class="hljs-comment">// light 是默认的，但 dark 不是默认的</span>
</code></pre>
<p>在代码中读取参数时使用默认值：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">function</span> <span class="hljs-title function_">getTheme</span>(<span class="hljs-params">params</span>) {
  <span class="hljs-keyword">return</span> params.<span class="hljs-title function_">get</span>(<span class="hljs-string">"theme"</span>) || <span class="hljs-string">"light"</span>; <span class="hljs-comment">// 在代码中设置默认值</span>
}
</code></pre>
<h3 data-id="heading-16">8.2. URL 更新防抖动</h3>
<p>对于高频更新（例如边输入边搜索），要对 URL 更改进行防抖处理：</p>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-keyword">import</span> { debounce } <span class="hljs-keyword">from</span> <span class="hljs-string">"lodash"</span>;

<span class="hljs-keyword">const</span> updateSearchParam = <span class="hljs-title function_">debounce</span>(<span class="hljs-function">(<span class="hljs-params">value</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-property">search</span>);
  <span class="hljs-keyword">if</span> (value) {
    params.<span class="hljs-title function_">set</span>(<span class="hljs-string">"q"</span>, value);
  } <span class="hljs-keyword">else</span> {
    params.<span class="hljs-title function_">delete</span>(<span class="hljs-string">"q"</span>);
  }
  <span class="hljs-variable language_">window</span>.<span class="hljs-property">history</span>.<span class="hljs-title function_">replaceState</span>({}, <span class="hljs-string">""</span>, <span class="hljs-string">`?<span class="hljs-subst">${params.toString()}</span>`</span>);
}, <span class="hljs-number">300</span>);
</code></pre>
<h3 data-id="heading-17">8.3. URL 传达意义</h3>
<pre><code class="hljs language-jsx" lang="jsx"><span class="hljs-attr">https</span>:<span class="hljs-comment">//example.com/p?id=x7f2k&amp;v=3 ❌</span>
<span class="hljs-attr">https</span>:<span class="hljs-comment">//example.com/products/laptop?color=silver&amp;sort=price ✅</span>
</code></pre>
<p>第一个链接隐藏了意图，第二个链接则意义清晰。人可以阅读它并理解其含义。机器可以解析它并提取有意义的结构。这才是优秀的 URL。</p>
<h2 data-id="heading-18">9. 使用时要避免的反模式</h2>
<h3 data-id="heading-19">9.1. 状态都保存在内存中的单页应用程序</h3>
<pre><code class="hljs language-plain" lang="plain">// 用户一刷新，状态都丢失了
const [filters, setFilters] = useState({});
</code></pre>
<p>如果你的应用在刷新后丢失了之前的状态，你就破坏了网络的一项基本功能。用户期望 URL 能够保留上下文。</p>
<h3 data-id="heading-20">9.2. 包含敏感数据</h3>
<pre><code class="hljs language-plain" lang="plain">// 别这样干
?password=secret123
</code></pre>
<h3 data-id="heading-21">9.3. 命名不一致或晦涩难懂</h3>
<pre><code class="hljs language-plain" lang="plain">// 晦涩难懂
?foo=true&amp;bar=2&amp;x=dark

// 自文档化且风格保持一致
?mobile=true&amp;page=2&amp;theme=dark
</code></pre>
<h3 data-id="heading-22">9.4. 注意 URL 长度限制</h3>
<p>浏览器和服务器对 URL 长度都有实际的限制（通常在 2000 到 8000 个字符之间），但实际情况更为复杂，会有来自浏览器行为、服务器配置、CDN 甚至搜索引擎的限制等多种因素。</p>
<p>如果你遇到了这些限制，那就说明你需要重新考虑你的策略了。</p>
<h2 data-id="heading-23">10. 总结</h2>
<p>好的 URL 不仅仅是指向内容，它更是描述了用户和应用程序之间的对话。</p>
<p>我们已经构建了复杂的状态管理库，但有时最好的解决方案其实是最简单的那一个。<strong>当你的应用在点击刷新时失去了状态，想一想，你是否错过了这个 Web 最古老、最优雅的特性？</strong></p>
<h2 data-id="heading-24">11. 参考链接</h2>
<ol>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Falfy.blog%2F2025%2F10%2F31%2Fyour-url-is-your-state.html" target="_blank" title="https://alfy.blog/2025/10/31/your-url-is-your-state.html" ref="nofollow noopener noreferrer">Your URL Is Your State</a></li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[限流算法实现]]></title>    <link>https://juejin.cn/post/7571102074038435881</link>    <guid>https://juejin.cn/post/7571102074038435881</guid>    <pubDate>2025-11-11T09:09:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571102074038435881" data-draft-id="7565716907011014697" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="限流算法实现"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T09:09:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="GKunLi"/> <meta itemprop="url" content="https://juejin.cn/user/430664725579725"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            限流算法实现
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/430664725579725/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    GKunLi
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:09:12.000Z" title="Tue Nov 11 2025 09:09:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>由于 API 接口无法控制调用方的行为，因此当遇到瞬时请求量激增时，会导致接口占用过多服务器资源，使得其他请求响应速度降低或是超时，更有甚者可能导致服务器宕机。</p>
</blockquote>
<blockquote>
<p>限流(Ratelimiting)指对应用服务的请求进行限制，例如某一接口的请求限制为 100 个每秒,对超过限制的请求则进行快速失败或丢弃。</p>
</blockquote>
<h3 data-id="heading-0">拦截器 vs 过滤器在限流中的使用选择</h3>
<h4 data-id="heading-1">过滤器（Filter）更合理的理由：</h4>
<ol>
<li>
<p><strong>执行时机更早</strong></p>
<ul>
<li><code>Filter</code> 在请求进入Spring MVC框架之前执行</li>
<li>能够更早地拦截和拒绝过多请求，节省框架初始化开销</li>
</ul>
</li>
<li>
<p><strong>更底层的控制</strong></p>
<ul>
<li>基于Servlet规范，不依赖Spring MVC框架</li>
<li>可以拦截所有类型的请求（包括静态资源）</li>
</ul>
</li>
<li>
<p><strong>性能优势</strong></p>
<ul>
<li>避免不必要的Spring上下文初始化</li>
<li>减少请求处理链路长度</li>
</ul>
</li>
<li>
<p><strong>适用场景匹配</strong></p>
<ul>
<li>适合做通用的基础设施功能（如限流、安全检查）</li>
<li>对所有HTTP请求进行统一处理</li>
</ul>
</li>
</ol>
<h4 data-id="heading-2">拦截器（Interceptor）的局限性：</h4>
<ol>
<li>
<p><strong>执行时机较晚</strong></p>
<ul>
<li>在<code>DispatcherServlet</code>之后执行</li>
<li>已经完成了部分Spring MVC框架的初始化工作</li>
</ul>
</li>
<li>
<p><strong>依赖Spring MVC</strong></p>
<ul>
<li>只能处理经过Spring MVC的请求</li>
<li>无法处理静态资源等非Controller请求</li>
</ul>
</li>
</ol>
<h4 data-id="heading-3">结论</h4>
<p>对于<strong>固定窗口限流</strong>这种基础设施级别的功能，<strong>过滤器更为合理</strong>，因为：</p>
<ul>
<li>能够在最早阶段拒绝过多请求</li>
<li>不依赖具体的应用框架</li>
<li>性能开销更小</li>
<li>控制粒度更粗，适合全局限流策略</li>
</ul>
<p><strong>使用redis作为中间件</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- Spring Boot Starter Data Redis --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h2 data-id="heading-4">固定窗口计数器算法</h2>
<p><strong>固定窗口其实就是时间窗口，其原理是将时间划分为固定大小的窗口，在每个窗口内限制请求的数量或速率，即固定窗口计数器算法规定了系统单位时间处理的请求数量。</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 限流器接口
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RateLimiter</span> {
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(String key, <span class="hljs-type">long</span> limit, <span class="hljs-type">long</span> windowMs)</span>;
}
</code></pre>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">import</span> com.example.demo.infrastructure.RateLimiter;
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.Collections;

<span class="hljs-comment">/**
 * 基于 Redis 的固定窗口限流器
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component("redisRateLimiter")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisFixedWindowRateLimiter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RateLimiter</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StringRedisTemplate stringRedisTemplate;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> failOpen;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String keyPrefix;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LUA_SCRIPT</span> <span class="hljs-operator">=</span>
            <span class="hljs-string">"local key = KEYS[1]\n"</span> +
                    <span class="hljs-string">"local limit = tonumber(ARGV[1])\n"</span> +
                    <span class="hljs-string">"local window_ms = tonumber(ARGV[2])\n"</span> +
                    <span class="hljs-string">"local current = redis.call('INCR', key)\n"</span> +
                    <span class="hljs-string">"if current == 1 then\n"</span> +
                    <span class="hljs-string">"    redis.call('PEXPIRE', key, window_ms)\n"</span> +
                    <span class="hljs-string">"end\n"</span> +
                    <span class="hljs-string">"if current &lt;= limit then\n"</span> +
                    <span class="hljs-string">"    return 1\n"</span> +
                    <span class="hljs-string">"else\n"</span> +
                    <span class="hljs-string">"    return 0\n"</span> +
                    <span class="hljs-string">"end"</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DefaultRedisScript&lt;Long&gt; redisScript;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RedisFixedWindowRateLimiter</span><span class="hljs-params">(
            StringRedisTemplate stringRedisTemplate,
            <span class="hljs-meta">@Value("${rate.limit.fail-open:false}")</span> <span class="hljs-type">boolean</span> failOpen,
            <span class="hljs-meta">@Value("${rate.limit.redis.key-prefix:myapp:rl}")</span> String keyPrefix)</span> {
        <span class="hljs-built_in">this</span>.stringRedisTemplate = stringRedisTemplate;
        <span class="hljs-built_in">this</span>.failOpen = failOpen;
        <span class="hljs-built_in">this</span>.keyPrefix = keyPrefix;
        <span class="hljs-built_in">this</span>.redisScript = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;(LUA_SCRIPT, Long.class);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(String key, <span class="hljs-type">long</span> limit, <span class="hljs-type">long</span> windowMs)</span> {
        <span class="hljs-keyword">if</span> (key == <span class="hljs-literal">null</span> || key.isEmpty() || limit &lt;= <span class="hljs-number">0</span> || windowMs &lt;= <span class="hljs-number">0</span>) {
            log.warn(<span class="hljs-string">"Invalid rate limit params: key={}, limit={}, windowMs={}"</span>, key, limit, windowMs);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-comment">// 防止窗口过小导致 TTL=0</span>
        <span class="hljs-keyword">if</span> (windowMs &lt; <span class="hljs-number">10</span>) {
            log.warn(<span class="hljs-string">"Window too small: {}ms, using 10ms"</span>, windowMs);
            windowMs = <span class="hljs-number">10</span>;
        }

        <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> keyPrefix + <span class="hljs-string">":"</span> + key + <span class="hljs-string">":"</span> + (System.currentTimeMillis() / windowMs);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> stringRedisTemplate.execute(
                    redisScript,
                    Collections.singletonList(redisKey),
                    String.valueOf(limit),
                    String.valueOf(windowMs)
            );
            <span class="hljs-type">boolean</span> <span class="hljs-variable">allowed</span> <span class="hljs-operator">=</span> result != <span class="hljs-literal">null</span> &amp;&amp; result == <span class="hljs-number">1L</span>;
            <span class="hljs-keyword">if</span> (!allowed) {
                log.warn(<span class="hljs-string">"Rate limit exceeded | key={}"</span>, key);
            }
            <span class="hljs-keyword">return</span> allowed;
        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"Redis rate limiter error | key={}"</span>, key, e);
            <span class="hljs-keyword">return</span> failOpen;
        }
    }
}
</code></pre>
<h2 data-id="heading-5">滑动窗口计数算法</h2>
<p><strong>滑动窗口限流算法（Sliding Window Rate Limiting Algorithm） 是一种用于控制系统单位时间内请求频率的流量控制机制。它将时间划分为连续、动态移动的时间窗口，通过统计当前窗口内已发生的请求数量（或估算值），并与预设阈值比较，从而决定是否允许新请求通过</strong></p>
<pre><code class="hljs language-图示" lang="图示">         上一窗口                  当前窗口
|----------|----------|----------|----------|
          ↑                     ↑
   1672531200000         1672531201000      now→1672531201500

prev_count = 80        current_count = 60
               ←─────── offset = 500ms ───────┘
weight = 0.5 → 只算 prev_count 的一半 → 40
             total = 60 + 40 = 100 ≤ limit(100) → 放行
</code></pre>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 限流器接口
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RateLimiter</span> {
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(String key, <span class="hljs-type">long</span> limit, <span class="hljs-type">long</span> windowMs)</span>;
}
</code></pre>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.Arrays;

<span class="hljs-comment">/**
 * 基于 Redis 的滑动窗口计数器限流器、
 * &lt;p&gt;
 * 算法：Sliding Window Counter（非日志型，避免高内存消耗）
 * 特点：
 * - 使用两个 Redis Key：当前窗口 + 上一窗口
 * - Lua 脚本原子计算估算请求数
 * - 支持毫秒级窗口
 * - 自动清理过期窗口
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component("slidingWindowRateLimiter")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisSlidingWindowRateLimiter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RateLimiter</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StringRedisTemplate stringRedisTemplate;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> failOpen;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String keyPrefix;

    <span class="hljs-comment">// Lua 脚本：实现滑动窗口计数逻辑</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LUA_SCRIPT</span> <span class="hljs-operator">=</span>
            <span class="hljs-string">"-- KEYS[1]: current window key\n"</span> +
                    <span class="hljs-string">"-- KEYS[2]: previous window key\n"</span> +
                    <span class="hljs-string">"-- ARGV[1]: limit\n"</span> +
                    <span class="hljs-string">"-- ARGV[2]: window_ms (毫秒)\n"</span> +
                    <span class="hljs-string">"-- ARGV[3]: current_time_ms\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"local current_key = KEYS[1]\n"</span> +
                    <span class="hljs-string">"local prev_key = KEYS[2]\n"</span> +
                    <span class="hljs-string">"local limit = tonumber(ARGV[1])\n"</span> +
                    <span class="hljs-string">"local window_ms = tonumber(ARGV[2])\n"</span> +
                    <span class="hljs-string">"local now = tonumber(ARGV[3])\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"-- 获取当前窗口和上一窗口的计数\n"</span> +
                    <span class="hljs-string">"local current_count = redis.call('GET', current_key)\n"</span> +
                    <span class="hljs-string">"local prev_count = redis.call('GET', prev_key)\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"current_count = current_count and tonumber(current_count) or 0\n"</span> +
                    <span class="hljs-string">"prev_count = prev_count and tonumber(prev_count) or 0\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"-- 计算窗口偏移量（当前时间在窗口中的位置）\n"</span> +
                    <span class="hljs-string">"local window_start = now - (now % window_ms)\n"</span> +
                    <span class="hljs-string">"local offset = now - window_start  -- [0, window_ms)\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"-- 估算总请求数：当前窗口 + 上一窗口 * (1 - offset/window_ms)\n"</span> +
                    <span class="hljs-string">"local weight = (window_ms - offset) / window_ms\n"</span> +
                    <span class="hljs-string">"local estimated = current_count + (prev_count * weight)\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"-- 如果超过限制，拒绝\n"</span> +
                    <span class="hljs-string">"if estimated &gt;= limit then\n"</span> +
                    <span class="hljs-string">"    return 0\n"</span> +
                    <span class="hljs-string">"end\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"-- 允许请求：增加当前窗口计数，并设置 TTL\n"</span> +
                    <span class="hljs-string">"redis.call('INCR', current_key)\n"</span> +
                    <span class="hljs-string">"redis.call('PEXPIRE', current_key, window_ms * 2)  -- 保留两个窗口周期\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"return 1"</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DefaultRedisScript&lt;Long&gt; redisScript;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RedisSlidingWindowRateLimiter</span><span class="hljs-params">(
            StringRedisTemplate stringRedisTemplate,
            <span class="hljs-meta">@Value("${rate.limit.fail-open:false}")</span> <span class="hljs-type">boolean</span> failOpen,
            <span class="hljs-meta">@Value("${rate.limit.redis.key-prefix:myapp:rl}")</span> String keyPrefix)</span> {
        <span class="hljs-built_in">this</span>.stringRedisTemplate = stringRedisTemplate;
        <span class="hljs-built_in">this</span>.failOpen = failOpen;
        <span class="hljs-built_in">this</span>.keyPrefix = keyPrefix;
        <span class="hljs-built_in">this</span>.redisScript = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;(LUA_SCRIPT, Long.class);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(String key, <span class="hljs-type">long</span> limit, <span class="hljs-type">long</span> windowMs)</span> {
        <span class="hljs-keyword">if</span> (key == <span class="hljs-literal">null</span> || key.isEmpty() || limit &lt;= <span class="hljs-number">0</span> || windowMs &lt;= <span class="hljs-number">0</span>) {
            log.warn(<span class="hljs-string">"Invalid rate limit params: key={}, limit={}, windowMs={}"</span>, key, limit, windowMs);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-keyword">if</span> (windowMs &lt; <span class="hljs-number">10</span>) {
            log.warn(<span class="hljs-string">"Window too small: {}ms, using 10ms"</span>, windowMs);
            windowMs = <span class="hljs-number">10</span>;
        }

        <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> System.currentTimeMillis();
        <span class="hljs-comment">// 当前窗口编号</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">windowSlot</span> <span class="hljs-operator">=</span> now / windowMs;

        <span class="hljs-type">String</span> <span class="hljs-variable">currentKey</span> <span class="hljs-operator">=</span> buildKey(key, windowSlot);
        <span class="hljs-type">String</span> <span class="hljs-variable">prevKey</span> <span class="hljs-operator">=</span> buildKey(key, windowSlot - <span class="hljs-number">1</span>);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> stringRedisTemplate.execute(
                    redisScript,
                    Arrays.asList(currentKey, prevKey),
                    String.valueOf(limit),
                    String.valueOf(windowMs),
                    String.valueOf(now)
            );

            <span class="hljs-type">boolean</span> <span class="hljs-variable">allowed</span> <span class="hljs-operator">=</span> result != <span class="hljs-literal">null</span> &amp;&amp; result == <span class="hljs-number">1L</span>;
            <span class="hljs-keyword">if</span> (!allowed) {
                log.warn(<span class="hljs-string">"Sliding window rate limit exceeded | key={}"</span>, key);
            }
            <span class="hljs-keyword">return</span> allowed;

        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"Redis sliding window rate limiter error | key={}"</span>, key, e);
            <span class="hljs-keyword">return</span> failOpen;
        }
    }

    <span class="hljs-keyword">private</span> String <span class="hljs-title function_">buildKey</span><span class="hljs-params">(String key, <span class="hljs-type">long</span> slot)</span> {
        <span class="hljs-keyword">return</span> keyPrefix + <span class="hljs-string">":sw:"</span> + key + <span class="hljs-string">":"</span> + slot;
    }
}
</code></pre>
<h2 data-id="heading-6">漏桶算法</h2>
<p><strong>漏桶算法（Leaky Bucket Algorithm） 是一种流量整形与限流机制，它将请求比作“水滴”注入一个固定容量的“桶”中，桶以恒定速率“漏水”（即处理请求）；当桶满时，新请求被丢弃或拒绝，从而平滑突发流量、确保系统以稳定速率处理请求。</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 限流器接口
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RateLimiter</span> {
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(String key, <span class="hljs-type">long</span> limit, <span class="hljs-type">long</span> windowMs)</span>;
}

limit → 桶容量（capacity）
rate = <span class="hljs-number">1000</span> / windowMs → 每秒处理速率（req/s）
例如：tryAcquire(<span class="hljs-string">"api"</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1000</span>) 表示 桶容量=<span class="hljs-number">5</span>，每秒匀速处理<span class="hljs-number">1</span>个请求。
</code></pre>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.Collections;

<span class="hljs-comment">/**
 * 基于 Redis 的漏桶限流算法（Leaky Bucket）实现
 * &lt;p&gt;
 * 特点：
 * - 恒定输出速率，平滑突发流量
 * - 使用惰性漏水策略（Lazy Leaking）
 * - Lua 脚本保证原子性
 * - 支持毫秒级精度
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component("leakyBucketRateLimiter")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisLeakyBucketRateLimiter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RateLimiter</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StringRedisTemplate stringRedisTemplate;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> failOpen;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String keyPrefix;

    <span class="hljs-comment">// Lua 脚本：实现漏桶惰性漏水逻辑</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LUA_SCRIPT</span> <span class="hljs-operator">=</span>
            <span class="hljs-string">"-- KEYS[1]: bucket key\n"</span> +
                    <span class="hljs-string">"-- ARGV[1]: capacity (桶容量)\n"</span> +
                    <span class="hljs-string">"-- ARGV[2]: rate_per_sec (每秒处理请求数)\n"</span> +
                    <span class="hljs-string">"-- ARGV[3]: current_time_ms\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"local key = KEYS[1]\n"</span> +
                    <span class="hljs-string">"local capacity = tonumber(ARGV[1])\n"</span> +
                    <span class="hljs-string">"local rate = tonumber(ARGV[2])\n"</span> +
                    <span class="hljs-string">"local now = tonumber(ARGV[3])\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"-- 获取当前桶状态: \"water:last_leak_time\"\n"</span> +
                    <span class="hljs-string">"local bucket = redis.call('GET', key)\n"</span> +
                    <span class="hljs-string">"local water = 0\n"</span> +
                    <span class="hljs-string">"local last_leak_time = now\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"if bucket then\n"</span> +
                    <span class="hljs-string">"    local parts = {}\n"</span> +
                    <span class="hljs-string">"    for part in string.gmatch(bucket, \"([^:]+)\") do\n"</span> +
                    <span class="hljs-string">"        table.insert(parts, part)\n"</span> +
                    <span class="hljs-string">"    end\n"</span> +
                    <span class="hljs-string">"    water = tonumber(parts[1]) or 0\n"</span> +
                    <span class="hljs-string">"    last_leak_time = tonumber(parts[2]) or now\n"</span> +
                    <span class="hljs-string">"end\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"-- 惰性漏水：计算应漏出的水量\n"</span> +
                    <span class="hljs-string">"local delta = now - last_leak_time\n"</span> +
                    <span class="hljs-string">"if delta &gt; 0 and rate &gt; 0 then\n"</span> +
                    <span class="hljs-string">"    local leaked = math.floor((delta * rate) / 1000)\n"</span> +
                    <span class="hljs-string">"    water = math.max(0, water - leaked)\n"</span> +
                    <span class="hljs-string">"    last_leak_time = now\n"</span> +
                    <span class="hljs-string">"end\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"-- 尝试加入新请求\n"</span> +
                    <span class="hljs-string">"if water + 1 &lt;= capacity then\n"</span> +
                    <span class="hljs-string">"    water = water + 1\n"</span> +
                    <span class="hljs-string">"    -- 更新桶状态，并设置合理 TTL（防止永久残留）\n"</span> +
                    <span class="hljs-string">"    redis.call('SET', key, water .. ':' .. last_leak_time, 'PX', 86400000) -- 24h\n"</span> +
                    <span class="hljs-string">"    return 1\n"</span> +
                    <span class="hljs-string">"else\n"</span> +
                    <span class="hljs-string">"    return 0\n"</span> +
                    <span class="hljs-string">"end"</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DefaultRedisScript&lt;Long&gt; redisScript;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RedisLeakyBucketRateLimiter</span><span class="hljs-params">(
            StringRedisTemplate stringRedisTemplate,
            <span class="hljs-meta">@Value("${rate.limit.fail-open:false}")</span> <span class="hljs-type">boolean</span> failOpen,
            <span class="hljs-meta">@Value("${rate.limit.redis.key-prefix:myapp:rl}")</span> String keyPrefix)</span> {
        <span class="hljs-built_in">this</span>.stringRedisTemplate = stringRedisTemplate;
        <span class="hljs-built_in">this</span>.failOpen = failOpen;
        <span class="hljs-built_in">this</span>.keyPrefix = keyPrefix;
        <span class="hljs-built_in">this</span>.redisScript = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;(LUA_SCRIPT, Long.class);
    }

    <span class="hljs-comment">/**
     * 语义映射：
     * - limit → 桶容量（capacity）
     * - windowMs → 处理一个请求所需毫秒数 → rate = 1000 / windowMs (req/s)
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(String key, <span class="hljs-type">long</span> limit, <span class="hljs-type">long</span> windowMs)</span> {
        <span class="hljs-keyword">if</span> (key == <span class="hljs-literal">null</span> || key.isEmpty() || limit &lt;= <span class="hljs-number">0</span> || windowMs &lt;= <span class="hljs-number">0</span>) {
            log.warn(<span class="hljs-string">"Invalid leaky bucket params: key={}, capacity={}, processTimeMs={}"</span>, key, limit, windowMs);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-comment">// 桶容量</span>
        <span class="hljs-type">long</span> <span class="hljs-variable">capacity</span> <span class="hljs-operator">=</span> limit;
        <span class="hljs-comment">// 每秒处理请求数</span>
        <span class="hljs-type">double</span> <span class="hljs-variable">ratePerSec</span> <span class="hljs-operator">=</span> <span class="hljs-number">1000.0</span> / windowMs;

        <span class="hljs-comment">// 防止 rate 过大导致精度问题</span>
        <span class="hljs-keyword">if</span> (ratePerSec &gt; <span class="hljs-number">10000</span>) {
            log.warn(<span class="hljs-string">"Rate too high: {} req/s, capped at 10000"</span>, ratePerSec);
            ratePerSec = <span class="hljs-number">10000</span>;
        }

        <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> keyPrefix + <span class="hljs-string">":lb:"</span> + key;
        <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> System.currentTimeMillis();

        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> stringRedisTemplate.execute(
                    redisScript,
                    Collections.singletonList(redisKey),
                    String.valueOf(capacity),
                    String.valueOf(Math.round(ratePerSec)), <span class="hljs-comment">// 取整避免 Lua 浮点问题</span>
                    String.valueOf(now)
            );

            <span class="hljs-type">boolean</span> <span class="hljs-variable">allowed</span> <span class="hljs-operator">=</span> result != <span class="hljs-literal">null</span> &amp;&amp; result == <span class="hljs-number">1L</span>;
            <span class="hljs-keyword">if</span> (!allowed) {
                log.warn(<span class="hljs-string">"Leaky bucket overflow | key={}"</span>, key);
            }
            <span class="hljs-keyword">return</span> allowed;

        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"Redis leaky bucket error | key={}"</span>, key, e);
            <span class="hljs-keyword">return</span> failOpen;
        }
    }
}

</code></pre>
<h2 data-id="heading-7">令牌桶算法</h2>
<p><strong>令牌桶算法（Token Bucket Algorithm） 是一种流量控制机制，它以恒定速率向一个固定容量的“桶”中添加令牌，每个请求需消耗一个令牌才能被处理；当桶中有足够令牌时，请求可立即通过（支持突发流量），若桶空则请求被限流。该算法既能限制平均请求速率，又能允许一定程度的突发流量，兼具灵活性与稳定性。</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">/**
 * 限流器接口
 */</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RateLimiter</span> {
    <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(String key, <span class="hljs-type">long</span> limit, <span class="hljs-type">long</span> windowMs)</span>;
}
limit → 桶容量（capacity）
windowMs → 生成 limit 个令牌所需时间（毫秒）
⇒ 令牌生成速率 rate = limit / (windowMs / <span class="hljs-number">1000</span>) = (limit * <span class="hljs-number">1000</span>) / windowMs （单位：tokens/sec）
💡 示例：tryAcquire(<span class="hljs-string">"api"</span>, <span class="hljs-number">10</span>, <span class="hljs-number">1000</span>) 表示：
桶容量=<span class="hljs-number">10</span>，每秒生成<span class="hljs-number">10</span>个令牌（即 <span class="hljs-number">10</span> QPS），允许瞬间<span class="hljs-number">10</span>个请求通过
</code></pre>
<pre><code class="hljs language-java" lang="java">
<span class="hljs-keyword">import</span> lombok.extern.slf4j.Slf4j;
<span class="hljs-keyword">import</span> org.springframework.beans.factory.annotation.Value;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.StringRedisTemplate;
<span class="hljs-keyword">import</span> org.springframework.data.redis.core.script.DefaultRedisScript;
<span class="hljs-keyword">import</span> org.springframework.stereotype.Component;

<span class="hljs-keyword">import</span> java.util.Collections;

<span class="hljs-comment">/**
 * 基于 Redis 的令牌桶限流算法（Token Bucket）实现
 * &lt;p&gt;
 * 特点：
 * - 支持突发流量（桶内有令牌即可立即通过）
 * - 恒定速率补充令牌
 * - 惰性计算令牌（Lazy Token Refill）
 * - Lua 脚本保证原子性
 * - 符合阿里生产规范
 */</span>
<span class="hljs-meta">@Slf4j</span>
<span class="hljs-meta">@Component("tokenBucketRateLimiter")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisTokenBucketRateLimiter</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RateLimiter</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> StringRedisTemplate stringRedisTemplate;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> failOpen;
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String keyPrefix;

    <span class="hljs-comment">// Lua 脚本：实现令牌桶惰性补充逻辑</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">LUA_SCRIPT</span> <span class="hljs-operator">=</span>
            <span class="hljs-string">"-- KEYS[1]: token bucket key\n"</span> +
                    <span class="hljs-string">"-- ARGV[1]: capacity (桶容量)\n"</span> +
                    <span class="hljs-string">"-- ARGV[2]: rate_per_sec (每秒生成令牌数)\n"</span> +
                    <span class="hljs-string">"-- ARGV[3]: current_time_ms\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"local key = KEYS[1]\n"</span> +
                    <span class="hljs-string">"local capacity = tonumber(ARGV[1])\n"</span> +
                    <span class="hljs-string">"local rate = tonumber(ARGV[2])\n"</span> +
                    <span class="hljs-string">"local now = tonumber(ARGV[3])\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"-- 获取当前桶状态: \"tokens:last_refill_time\"\n"</span> +
                    <span class="hljs-string">"local bucket = redis.call('GET', key)\n"</span> +
                    <span class="hljs-string">"local tokens = capacity\n"</span> +
                    <span class="hljs-string">"local last_refill = now\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"if bucket then\n"</span> +
                    <span class="hljs-string">"    local parts = {}\n"</span> +
                    <span class="hljs-string">"    for part in string.gmatch(bucket, \"([^:]+)\") do\n"</span> +
                    <span class="hljs-string">"        table.insert(parts, part)\n"</span> +
                    <span class="hljs-string">"    end\n"</span> +
                    <span class="hljs-string">"    tokens = tonumber(parts[1]) or capacity\n"</span> +
                    <span class="hljs-string">"    last_refill = tonumber(parts[2]) or now\n"</span> +
                    <span class="hljs-string">"end\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"-- 惰性补充令牌\n"</span> +
                    <span class="hljs-string">"local delta = now - last_refill\n"</span> +
                    <span class="hljs-string">"if delta &gt; 0 and rate &gt; 0 then\n"</span> +
                    <span class="hljs-string">"    local new_tokens = math.floor((delta * rate) / 1000)\n"</span> +
                    <span class="hljs-string">"    tokens = math.min(capacity, tokens + new_tokens)\n"</span> +
                    <span class="hljs-string">"    last_refill = now\n"</span> +
                    <span class="hljs-string">"end\n"</span> +
                    <span class="hljs-string">"\n"</span> +
                    <span class="hljs-string">"-- 尝试获取1个令牌\n"</span> +
                    <span class="hljs-string">"if tokens &gt;= 1 then\n"</span> +
                    <span class="hljs-string">"    tokens = tokens - 1\n"</span> +
                    <span class="hljs-string">"    redis.call('SET', key, tokens .. ':' .. last_refill, 'PX', 86400000) -- TTL 24h\n"</span> +
                    <span class="hljs-string">"    return 1\n"</span> +
                    <span class="hljs-string">"else\n"</span> +
                    <span class="hljs-string">"    return 0\n"</span> +
                    <span class="hljs-string">"end"</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DefaultRedisScript&lt;Long&gt; redisScript;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">RedisTokenBucketRateLimiter</span><span class="hljs-params">(
            StringRedisTemplate stringRedisTemplate,
            <span class="hljs-meta">@Value("${rate.limit.fail-open:false}")</span> <span class="hljs-type">boolean</span> failOpen,
            <span class="hljs-meta">@Value("${rate.limit.redis.key-prefix:myapp:rl}")</span> String keyPrefix)</span> {
        <span class="hljs-built_in">this</span>.stringRedisTemplate = stringRedisTemplate;
        <span class="hljs-built_in">this</span>.failOpen = failOpen;
        <span class="hljs-built_in">this</span>.keyPrefix = keyPrefix;
        <span class="hljs-built_in">this</span>.redisScript = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultRedisScript</span>&lt;&gt;(LUA_SCRIPT, Long.class);
    }

    <span class="hljs-comment">/**
     * 语义映射：
     * - limit → 桶容量（capacity）
     * - windowMs → 生成 limit 个令牌所需时间（毫秒）
     *   ⇒ rate = (limit * 1000) / windowMs （tokens/sec）
     */</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">tryAcquire</span><span class="hljs-params">(String key, <span class="hljs-type">long</span> limit, <span class="hljs-type">long</span> windowMs)</span> {
        <span class="hljs-keyword">if</span> (key == <span class="hljs-literal">null</span> || key.isEmpty() || limit &lt;= <span class="hljs-number">0</span> || windowMs &lt;= <span class="hljs-number">0</span>) {
            log.warn(<span class="hljs-string">"Invalid token bucket params: key={}, capacity={}, refillWindowMs={}"</span>, key, limit, windowMs);
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }

        <span class="hljs-type">long</span> <span class="hljs-variable">capacity</span> <span class="hljs-operator">=</span> limit;
        <span class="hljs-type">double</span> <span class="hljs-variable">ratePerSec</span> <span class="hljs-operator">=</span> (limit * <span class="hljs-number">1000.0</span>) / windowMs;

        <span class="hljs-comment">// 防止速率过高导致精度问题或 Redis 压力</span>
        <span class="hljs-keyword">if</span> (ratePerSec &gt; <span class="hljs-number">100000</span>) {
            log.warn(<span class="hljs-string">"Token rate too high: {} tokens/s, capped at 100000"</span>, ratePerSec);
            ratePerSec = <span class="hljs-number">100000</span>;
        }

        <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> keyPrefix + <span class="hljs-string">":tb:"</span> + key;
        <span class="hljs-type">long</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> System.currentTimeMillis();

        <span class="hljs-keyword">try</span> {
            <span class="hljs-type">Long</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> stringRedisTemplate.execute(
                    redisScript,
                    Collections.singletonList(redisKey),
                    String.valueOf(capacity),
                    String.valueOf(Math.round(ratePerSec)), <span class="hljs-comment">// 取整避免 Lua 浮点误差</span>
                    String.valueOf(now)
            );

            <span class="hljs-type">boolean</span> <span class="hljs-variable">allowed</span> <span class="hljs-operator">=</span> result != <span class="hljs-literal">null</span> &amp;&amp; result == <span class="hljs-number">1L</span>;
            <span class="hljs-keyword">if</span> (!allowed) {
                log.warn(<span class="hljs-string">"Token bucket exhausted | key={}"</span>, key);
            }
            <span class="hljs-keyword">return</span> allowed;

        } <span class="hljs-keyword">catch</span> (Exception e) {
            log.error(<span class="hljs-string">"Redis token bucket error | key={}"</span>, key, e);
            <span class="hljs-keyword">return</span> failOpen;
        }
    }
}
</code></pre>


















































<table><thead><tr><th>算法</th><th>核心思想</th><th>是否支持突发流量</th><th>输出是否匀速</th><th>内存/计算开销</th><th>精度</th><th>典型适用场景</th></tr></thead><tbody><tr><td>固定窗口（Fixed Window）</td><td>将时间划分为固定长度窗口，统计窗口内请求数</td><td>✅ 是（窗口切换时可能双倍突发）</td><td>❌ 否</td><td>⭐ 极低（仅计数器）</td><td>⭐ 低（存在边界突刺）</td><td>- 对精度要求不高的粗略限流- 内部系统简单防护</td></tr><tr><td>滑动窗口（Sliding Window）</td><td>动态移动的时间窗口，精确统计最近 N 毫秒内请求量</td><td>✅ 是</td><td>❌ 否</td><td>⭐⭐ 中（需维护多个窗口或日志）</td><td>⭐⭐⭐ 高</td><td>- API 网关 QPS 控制- 开放平台接口限流- 防刷、防爬场景</td></tr><tr><td>漏桶（Leaky Bucket）</td><td>请求入桶，以恒定速率“漏水”处理；桶满则丢弃</td><td>❌ 否</td><td>✅ 是</td><td>⭐⭐ 中（需记录水量和时间）</td><td>⭐⭐ 中</td><td>- 流量整形（Traffic Shaping）- 保护下游系统免受突发冲击- 消息队列匀速消费</td></tr><tr><td>令牌桶（Token Bucket）</td><td>以恒定速率生成令牌，请求消耗令牌；桶空则拒绝</td><td>✅ 是（只要桶中有令牌）</td><td>❌ 否</td><td>⭐⭐ 中（需记录令牌数和时间）</td><td>⭐⭐⭐ 高</td><td>- 通用限流（最常用）- 微服务接口保护- 支持突发 + 平均速率控制</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 是如何“假装”多线程的？深入理解单线程与 Event Loop]]></title>    <link>https://juejin.cn/post/7571258854900531243</link>    <guid>https://juejin.cn/post/7571258854900531243</guid>    <pubDate>2025-11-11T09:08:55.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571258854900531243" data-draft-id="7571105461098774571" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 是如何“假装”多线程的？深入理解单线程与 Event Loop"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-11T09:08:55.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="烟袅"/> <meta itemprop="url" content="https://juejin.cn/user/1845419006243504"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 是如何“假装”多线程的？深入理解单线程与 Event Loop
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1845419006243504/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    烟袅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:08:55.000Z" title="Tue Nov 11 2025 09:08:55 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在前端开发中，JavaScript 一直是核心语言之一。但你有没有想过：<strong>为什么 JS 是单线程的，却能处理异步任务、响应用户交互、加载资源，还能流畅运行？</strong></p>
<p>今天我们就来聊聊 JavaScript 的“单线程”本质，以及它背后的秘密武器——<strong>Event Loop（事件循环）</strong> 。</p>
<hr/>
<h2 data-id="heading-0">一、线程 vs 进程：先搞清楚基本概念</h2>
<p>在操作系统中，程序的执行单位有两个关键概念：</p>
<ul>
<li><strong>进程（Process）</strong> ：是系统分配资源的最小单位。每个进程都有独立的内存空间。</li>
<li><strong>线程（Thread）</strong> ：是执行代码的最小单元。一个进程可以包含多个线程。</li>
</ul>
<blockquote>
<p>💡 简单说：进程负责“资源管理”，线程负责“代码执行”。</p>
</blockquote>
<p>当一个程序启动时，操作系统会创建一个进程，然后该进程再启动一个或多个线程来执行具体任务。</p>
<hr/>
<h2 data-id="heading-1">二、JavaScript 是单线程的</h2>
<p>JavaScript 从诞生之初就被设计为<strong>单线程</strong>语言。这意味着：</p>
<blockquote>
<p>✅ 在同一时间，只能执行一段代码。</p>
</blockquote>
<p>这听起来似乎很“低效”——毕竟现代浏览器都支持多核 CPU，为什么 JS 不用多线程？</p>
<h3 data-id="heading-2">原因在于：<strong>避免复杂性</strong></h3>
<p>如果 JS 支持多线程，就会面临以下问题：</p>
<ul>
<li>多线程并发修改 DOM，导致页面状态混乱</li>
<li>数据竞争（Race Condition）</li>
<li>加锁机制复杂，增加学习成本</li>
</ul>
<p>所以，为了简化开发、保证 DOM 操作的安全性，JS 被设计成单线程执行。</p>
<hr/>
<h2 data-id="heading-3">三、同步代码 vs 异步代码</h2>
<p>虽然 JS 是单线程，但它通过“异步机制”实现了非阻塞操作。</p>
<h3 data-id="heading-4">1. 同步代码（Synchronous）</h3>
<p>从上到下，顺序执行：</p>
<pre><code class="hljs language-ini" lang="ini">console.log('开始')<span class="hljs-comment">;</span>
let <span class="hljs-attr">a</span> = <span class="hljs-number">10</span><span class="hljs-comment">;</span>
for (let <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; 1000; i++) {</span>
  // 循环执行
}
console.log('结束')<span class="hljs-comment">;</span>
</code></pre>
<p>这类代码是<strong>阻塞式</strong>的，必须等前面的代码执行完才能继续。</p>
<blockquote>
<p>⏱️ 执行时间级别：毫秒（ms）级，取决于代码复杂度。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">2. 异步代码（Asynchronous）</h3>
<p>异步代码不会立即执行，而是被“挂起”，等到合适时机再执行。</p>
<p>常见异步场景：</p>
<ul>
<li><code>setTimeout</code></li>
<li><code>fetch</code> 请求</li>
<li>事件监听（如点击、输入）</li>
<li>Promise</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'开始'</span>);
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'延迟执行'</span>);
}, <span class="hljs-number">1000</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'结束'</span>);
</code></pre>
<p>输出结果是：</p>
<pre><code class="hljs">开始
结束
延迟执行
</code></pre>
<blockquote>
<p>🔄 注意：异步代码的执行顺序<strong>可能和阅读顺序不同</strong>！</p>
</blockquote>
<hr/>
<h2 data-id="heading-6">四、JS 如何应对“耗时任务”？</h2>
<p>既然 JS 是单线程，一旦遇到耗时任务（比如大量计算、文件读取），就会阻塞主线程，导致页面卡顿。</p>
<p>那怎么办？</p>
<p>答案是：<strong>交给 Event Loop！</strong></p>
<h3 data-id="heading-7">什么是 Event Loop？</h3>
<p>Event Loop 是 JavaScript 实现异步的核心机制。它的作用是：</p>
<blockquote>
<p>🔁 当主线程执行到异步任务时，将该任务放入“任务队列”（Task Queue），主线程继续执行后续代码。<br/>
当主线程空闲时，Event Loop 会从队列中取出任务，依次执行。</p>
</blockquote>
<h3 data-id="heading-8">简单流程如下：</h3>
<ol>
<li>主线程执行同步代码</li>
<li>遇到异步任务 → 放入任务队列</li>
<li>主线程执行完毕 → Event Loop 检查任务队列</li>
<li>从队列中取出任务 → 放回主线程执行</li>
</ol>
<blockquote>
<p>✅ 这样就实现了“非阻塞”的效果，页面不会卡死。</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">五、为什么 JS 语言简单好学？</h2>
<p>正是因为 JS 是单线程，且有 Event Loop 的支持，才让开发者：</p>
<ul>
<li>不需要关心线程安全</li>
<li>不用手动管理锁和并发</li>
<li>只需关注逻辑流程，就能写出高效代码</li>
</ul>
<p>同时，JS 要负责：</p>
<ul>
<li>用户事件响应（点击、滚动）</li>
<li>页面更新（DOM 操作）</li>
<li>资源加载（图片、脚本）</li>
</ul>
<p>这些任务都依赖于异步机制，而 Event Loop 正是这一切的“幕后推手”。</p>
<hr/>
<h2 data-id="heading-10">六、总结：单线程 ≠ 低性能</h2>





















<table><thead><tr><th>特性</th><th>说明</th></tr></thead><tbody><tr><td>单线程</td><td>保证 DOM 操作安全，避免竞态条件</td></tr><tr><td>异步机制</td><td>通过 Event Loop 实现非阻塞</td></tr><tr><td>事件循环</td><td>将耗时任务推迟执行，提升用户体验</td></tr></tbody></table>
<blockquote>
<p>🧠 关键点：<strong>JS 的“单线程”是优势，不是短板。它用简单的模型，实现了复杂的交互体验。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-11">写在最后</h2>
<p>下次当你看到 <code>setTimeout</code> 或 <code>Promise</code> 时，不妨想想：<br/>
<strong>这背后，是一个默默工作的 Event Loop，正在帮你“排队”执行任务。</strong></p>
<p>掌握单线程与事件循环，是理解 JavaScript 异步编程的基础。</p>
<p>如果你觉得这篇文章对你有帮助，欢迎点赞、收藏、转发 👍</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一文看懂 Promise：异步任务的“执行流程控制器”]]></title>    <link>https://juejin.cn/post/7571304204753764406</link>    <guid>https://juejin.cn/post/7571304204753764406</guid>    <pubDate>2025-11-11T09:15:53.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571304204753764406" data-draft-id="7571304204753748022" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" 一文看懂 Promise：异步任务的“执行流程控制器”"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2025-11-11T09:15:53.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="烟袅"/> <meta itemprop="url" content="https://juejin.cn/user/1845419006243504"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             一文看懂 Promise：异步任务的“执行流程控制器”
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1845419006243504/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    烟袅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:15:53.000Z" title="Tue Nov 11 2025 09:15:53 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 JavaScript 中，我们经常需要处理一些耗时操作，比如网络请求、定时任务。这些操作不能阻塞主线程，所以要用<strong>异步方式</strong>处理。</p>
<p>而 <code>Promise</code> 就是 ES6 提供的一个<strong>用来管理异步任务的工具类</strong>，它能让异步代码写得更清晰、更容易理解。</p>
<p>今天我们就用几行代码 + 一张图，彻底搞懂 Promise 是怎么工作的。</p>
<hr/>
<h2 data-id="heading-0">一、Promise 是什么？</h2>
<blockquote>
<p>✅ <strong>Promise 是一个“承诺”对象</strong>，表示一个异步操作最终会完成（成功或失败）。</p>
</blockquote>
<p>你可以把它想象成一个“快递单”：</p>
<ul>
<li>发出订单 → 等待配送</li>
<li>配送成功 → 收到货（<code>resolve</code>）</li>
<li>配送失败 → 通知你（<code>reject</code>）</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve, reject</span>) =&gt;</span> {
  <span class="hljs-comment">// 执行异步任务</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span>);
    <span class="hljs-title function_">resolve</span>(); <span class="hljs-comment">// 成功了，通知后续代码</span>
  }, <span class="hljs-number">3000</span>);
});
</code></pre>
<blockquote>
<p>📌 注意：<code>new Promise()</code> 接受一个函数作为参数，这个函数里执行异步任务。</p>
</blockquote>
<hr/>
<h2 data-id="heading-1">二、如何监听结果？<code>.then()</code> 和 <code>.catch()</code></h2>
<p>Promise 提供了两个方法来处理结果：</p>
<h3 data-id="heading-2">1. <code>.then()</code> —— 成功时执行</h3>
<pre><code class="hljs language-javascript" lang="javascript">p.<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span>); <span class="hljs-comment">// 3 秒后执行</span>
});
</code></pre>
<blockquote>
<p>✅ 当 <code>resolve()</code> 被调用时，<code>.then()</code> 里的函数就会执行。</p>
</blockquote>
<h3 data-id="heading-3">2. <code>.catch()</code> —— 失败时执行</h3>
<pre><code class="hljs language-typescript" lang="typescript">p.<span class="hljs-keyword">catch</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'出错了'</span>);
});
</code></pre>
<blockquote>
<p>✅ 如果调用了 <code>reject()</code>，就会触发 <code>.catch()</code>。</p>
</blockquote>
<hr/>
<h2 data-id="heading-4">三、实际例子：异步任务顺序执行</h2>
<p>我们来看一段完整的代码：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">1</span>);

<span class="hljs-keyword">const</span> p = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">2</span>);
    <span class="hljs-title function_">resolve</span>();
  }, <span class="hljs-number">3000</span>);
});

p.<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">3</span>);
});

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-number">4</span>);
</code></pre>
<h3 data-id="heading-5">输出结果：</h3>
<pre><code class="hljs">1
4
2
3
</code></pre>
<blockquote>
<p>🔍 分析：</p>
<ul>
<li><code>console.log(1)</code> → 立即执行</li>
<li><code>console.log(4)</code> → 紧接着执行（在 Promise 创建后）</li>
<li><code>setTimeout</code> → 3 秒后执行 <code>console.log(2)</code></li>
<li><code>resolve()</code> → 触发 <code>.then()</code>，执行 <code>console.log(3)</code></li>
</ul>
</blockquote>
<blockquote>
<p>✅ 这就是为什么说：<strong>Promise 让异步任务看起来像同步一样写</strong>！</p>
</blockquote>
<hr/>
<h2 data-id="heading-6">四、链式调用：多个异步任务按顺序执行</h2>
<p>很多时候我们需要连续执行多个异步操作，比如：</p>
<ol>
<li>获取用户数据</li>
<li>根据用户 ID 获取帖子</li>
<li>显示结果</li>
</ol>
<p>使用 Promise 可以这样写：</p>
<pre><code class="hljs language-ini" lang="ini">fetchUserData()
  .then(<span class="hljs-attr">user</span> =&gt; {
    return getUserPosts(user.id)<span class="hljs-comment">; // 返回新的 Promise</span>
  })
  .then(<span class="hljs-attr">posts</span> =&gt; {
    console.log('用户的帖子:', posts)<span class="hljs-comment">;</span>
  })
  .catch(<span class="hljs-attr">err</span> =&gt; {
    console.error('出错了:', err)<span class="hljs-comment">;</span>
  })<span class="hljs-comment">;</span>
</code></pre>
<blockquote>
<p>✅ 这样写逻辑清晰，避免了嵌套过深的问题。</p>
</blockquote>
<hr/>
<h2 data-id="heading-7">五、总结：Promise 的三大要点</h2>





















<table><thead><tr><th>要点</th><th>说明</th></tr></thead><tbody><tr><td><code>new Promise()</code></td><td>创建一个承诺，传入异步任务函数</td></tr><tr><td><code>resolve()</code></td><td>异步任务成功，触发 <code>.then()</code></td></tr><tr><td><code>reject()</code></td><td>异步任务失败，触发 <code>.catch()</code></td></tr></tbody></table>
<blockquote>
<p>💡 关键理解：<br/>
<strong>Promise 本身是异步的，但它通过链式调用的方式，让异步代码看起来像同步一样写。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-8">写在最后</h2>
<p>如果你正在学习 JavaScript 异步编程，Promise 是必须掌握的基础。它虽然简单，但非常强大。</p>
<p>📌 推荐练习：</p>
<ul>
<li>自己写一个 <code>Promise</code> 模拟加载图片</li>
<li>用 <code>.then()</code> 实现两个接口的连续调用</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android之直播宽高比和相机宽高比不支持后动态获取所支持的宽高比]]></title>    <link>https://juejin.cn/post/7571281406509744179</link>    <guid>https://juejin.cn/post/7571281406509744179</guid>    <pubDate>2025-11-11T09:33:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571281406509744179" data-draft-id="7571191453126049818" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android之直播宽高比和相机宽高比不支持后动态获取所支持的宽高比"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-11T09:33:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="没有了遇见"/> <meta itemprop="url" content="https://juejin.cn/user/1521379826212983"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android之直播宽高比和相机宽高比不支持后动态获取所支持的宽高比
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1521379826212983/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    没有了遇见
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:33:05.000Z" title="Tue Nov 11 2025 09:33:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">场景:</h2>
<p>直播设置采集宽高 360p  360x640  但是手机相机不支持,所以出现裁剪(脸大问题)</p>
<h2 data-id="heading-1">解决方案:</h2>
<p>获取手机相机支持的宽高尺寸 ,根据需要设置的宽高动态匹配接近的宽高比 阈值要设置好</p>
<pre><code class="hljs language-arduino" lang="arduino">阀值 <span class="hljs-number">0.2</span>
val size = CameraSizeHelper.<span class="hljs-built_in">getInstance</span>().<span class="hljs-built_in">getOptimalSize</span>(context, config.captureWidth, config.captureHeight)
<span class="hljs-comment">// 接近的宽高</span>
val w=size.<span class="hljs-built_in">getWidth</span>()

val w=size.<span class="hljs-built_in">getHeight</span>()
</code></pre>
<pre><code class="hljs language-ini" lang="ini">

import android.content.Context<span class="hljs-comment">;</span>
import android.graphics.SurfaceTexture<span class="hljs-comment">;</span>
import android.hardware.camera2.*<span class="hljs-comment">;</span>
import android.hardware.camera2.params.StreamConfigurationMap<span class="hljs-comment">;</span>
import android.util.Log<span class="hljs-comment">;</span>
import android.util.Size<span class="hljs-comment">;</span>

import java.util.ArrayList<span class="hljs-comment">;</span>
import java.util.Comparator<span class="hljs-comment">;</span>
import java.util.List<span class="hljs-comment">;</span>

/**
 * 改进版 CameraSizeHelper
 * 支持向上枚举 + 比例误差阈值可配置
 */
public class CameraSizeHelper {

    private static volatile CameraSizeHelper instance<span class="hljs-comment">;</span>

    private CameraSizeHelper() {}

    public static CameraSizeHelper getInstance() {
        if (<span class="hljs-attr">instance</span> == null) {
            synchronized (CameraSizeHelper.class) {
                if (<span class="hljs-attr">instance</span> == null) {
                    <span class="hljs-attr">instance</span> = new CameraSizeHelper()<span class="hljs-comment">;</span>
                }
            }
        }
        return instance<span class="hljs-comment">;</span>
    }

    /**
     * 获取最接近目标尺寸的相机预览尺寸
     * @param context 上下文
     * @param targetWidth 目标宽度
     * @param targetHeight 目标高度
     * @param ratioThreshold 比例误差阈值，例如0.2
     * @return 最合适的支持尺寸
     */
    public Size getOptimalSize(Context context, int targetWidth, int targetHeight, double ratioThreshold) {
        try {
            CameraManager <span class="hljs-attr">cm</span> = (CameraManager) context.getSystemService(Context.CAMERA_SERVICE)<span class="hljs-comment">;</span>
            String <span class="hljs-attr">cameraId</span> = null<span class="hljs-comment">;</span>

            // 找后置摄像头
            for (String id : cm.getCameraIdList()) {
                CameraCharacteristics <span class="hljs-attr">characteristics</span> = cm.getCameraCharacteristics(id)<span class="hljs-comment">;</span>
                Integer <span class="hljs-attr">facing</span> = characteristics.get(CameraCharacteristics.LENS_FACING)<span class="hljs-comment">;</span>
                if (facing != null &amp;&amp; <span class="hljs-attr">facing</span> == CameraCharacteristics.LENS_FACING_BACK) {
                    <span class="hljs-attr">cameraId</span> = id<span class="hljs-comment">;</span>
                    break<span class="hljs-comment">;</span>
                }
            }
            if (<span class="hljs-attr">cameraId</span> == null) return new Size(targetWidth, targetHeight)<span class="hljs-comment">;</span>

            CameraCharacteristics <span class="hljs-attr">cc</span> = cm.getCameraCharacteristics(cameraId)<span class="hljs-comment">;</span>
            StreamConfigurationMap <span class="hljs-attr">map</span> = cc.get(CameraCharacteristics.SCALER_STREAM_CONFIGURATION_MAP)<span class="hljs-comment">;</span>
            if (<span class="hljs-attr">map</span> == null) return new Size(targetWidth, targetHeight)<span class="hljs-comment">;</span>

            Size<span class="hljs-section">[]</span> <span class="hljs-attr">sizes</span> = map.getOutputSizes(SurfaceTexture.class)<span class="hljs-comment">;</span>
            if (<span class="hljs-attr">sizes</span> == null || sizes.length == <span class="hljs-number">0</span>) return new Size(targetWidth, targetHeight)<span class="hljs-comment">;</span>

            boolean <span class="hljs-attr">portrait</span> = targetHeight &gt; targetWidth<span class="hljs-comment">;</span>
            double <span class="hljs-attr">targetRatio</span> = (double) targetHeight / targetWidth<span class="hljs-comment">;</span>

            // 0. 完全匹配优先
            for (Size s : sizes) {
                int <span class="hljs-attr">w</span> = portrait &amp;&amp; s.getWidth() &gt; s.getHeight() ? s.getHeight() : s.getWidth()<span class="hljs-comment">;</span>
                int <span class="hljs-attr">h</span> = portrait &amp;&amp; s.getWidth() &gt; s.getHeight() ? s.getWidth() : s.getHeight()<span class="hljs-comment">;</span>
                if (<span class="hljs-attr">w</span> == targetWidth &amp;&amp; h == targetHeight) {
                    return new Size(w, h)<span class="hljs-comment">;</span>
                }
            }

            // 1. 将所有尺寸按宽度升序排列（竖屏）
            List&lt;Size&gt; <span class="hljs-attr">sortedSizes</span> = new ArrayList&lt;&gt;()<span class="hljs-comment">;</span>
            for (Size s : sizes) {
                int <span class="hljs-attr">w</span> = portrait &amp;&amp; s.getWidth() &gt; s.getHeight() ? s.getHeight() : s.getWidth()<span class="hljs-comment">;</span>
                int <span class="hljs-attr">h</span> = portrait &amp;&amp; s.getWidth() &gt; s.getHeight() ? s.getWidth() : s.getHeight()<span class="hljs-comment">;</span>
                sortedSizes.add(new Size(w, h))<span class="hljs-comment">;</span>
            }
            sortedSizes.sort(Comparator.comparingInt(Size::getWidth))<span class="hljs-comment">;</span>

            // 2. 从目标宽度向上枚举
            Size <span class="hljs-attr">best</span> = null<span class="hljs-comment">;</span>
            double <span class="hljs-attr">minDiff</span> = Double.MAX_VALUE<span class="hljs-comment">;</span>
            for (int <span class="hljs-attr">i</span> = <span class="hljs-number">0</span><span class="hljs-comment">; i &lt; sortedSizes.size(); i++) {</span>
                Size <span class="hljs-attr">s</span> = sortedSizes.get(i)<span class="hljs-comment">;</span>
                if (s.getWidth() &lt; targetWidth) continue<span class="hljs-comment">; // 向上枚举</span>
                double <span class="hljs-attr">ratio</span> = (double) s.getHeight() / s.getWidth()<span class="hljs-comment">;</span>
                double <span class="hljs-attr">diff</span> = Math.abs(ratio - targetRatio)<span class="hljs-comment">;</span>
                if (diff &lt;= ratioThreshold) { // 阈值内直接返回
                    return s<span class="hljs-comment">;</span>
                } else {
                    // 记录最小比例差的候选
                    if (diff &lt; minDiff) {
                        <span class="hljs-attr">minDiff</span> = diff<span class="hljs-comment">;</span>
                        <span class="hljs-attr">best</span> = s<span class="hljs-comment">;</span>
                    }
                }
            }

            // 3. 如果向上找不到阈值内的，返回最小比例差的向上尺寸
            if (best != null) return best<span class="hljs-comment">;</span>

            // 4. 否则返回最大尺寸（兜底）
            return sortedSizes.get(sortedSizes.size() - 1)<span class="hljs-comment">;</span>

        } catch (Exception e) {
            Log.e("CameraSizeHelper", "getOptimalSize failed", e)<span class="hljs-comment">;</span>
            return new Size(targetWidth, targetHeight)<span class="hljs-comment">;</span>
        }
    }

    /**
     * 默认阈值调用
     */
    public Size getOptimalSize(Context context, int targetWidth, int targetHeight) {
        return getOptimalSize(context, targetWidth, targetHeight, 0.2)<span class="hljs-comment">;</span>
    }
}
```
```
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[「周更第11期」实用JS库推荐：Pinia]]></title>    <link>https://juejin.cn/post/7571258854900727851</link>    <guid>https://juejin.cn/post/7571258854900727851</guid>    <pubDate>2025-11-11T09:34:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571258854900727851" data-draft-id="7571077686108323903" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="「周更第11期」实用JS库推荐：Pinia"/> <meta itemprop="keywords" content="前端,JavaScript,Vue.js"/> <meta itemprop="datePublished" content="2025-11-11T09:34:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Bug_Constructer"/> <meta itemprop="url" content="https://juejin.cn/user/254742426830856"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            「周更第11期」实用JS库推荐：Pinia
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/254742426830856/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Bug_Constructer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:34:44.000Z" title="Tue Nov 11 2025 09:34:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">引言</h2>
<p>大家好，欢迎来到第11期的 JavaScript 库推荐！本期为大家介绍的是 Pinia——Vue 官方推荐的状态管理库。它以组合式 API 为核心，兼具直观、类型安全、轻量与可扩展的特点，能高效解决多组件共享状态、复杂业务流转与工程化可观测性不足的痛点，适合中大型 Vue 3 项目与 Nuxt 3 应用。</p>
<p>本文将从 Pinia 的核心特性、安装使用、实际应用、最佳实践与进阶用法等维度展开，帮助你系统掌握该库的使用方法。</p>
<h2 data-id="heading-1">库介绍</h2>
<h3 data-id="heading-2">基本信息</h3>
<ul>
<li>库名称：Pinia</li>
<li>GitHub 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fpinia" target="_blank" title="https://github.com/vuejs/pinia" ref="nofollow noopener noreferrer">github.com/vuejs/pinia</a></li>
<li>npm 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2Fpinia" target="_blank" title="https://www.npmjs.com/package/pinia" ref="nofollow noopener noreferrer">www.npmjs.com/package/pin…</a></li>
<li>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpinia.vuejs.org%2F" target="_blank" title="https://pinia.vuejs.org/" ref="nofollow noopener noreferrer">pinia.vuejs.org/</a></li>
<li>GitHub Stars：约 14.3k（以发布页为准）</li>
<li>最新版本：3.0.4（以 npm 为准）</li>
<li>包大小：~1.5KB（压缩后，官方文档）</li>
<li>维护状态：活跃维护</li>
</ul>
<h3 data-id="heading-3">主要特性</h3>
<ul>
<li>直观：API 贴近组件设计，学习成本低。</li>
<li>类型安全：完善推断与补全，JS 项目亦有良好提示。</li>
<li>DevTools：与 Vue DevTools 深度整合，时间线与状态快照清晰。</li>
<li>可扩展：插件机制可拦截动作、持久化、记录事务等。</li>
<li>模块化：天然支持多 Store，自动 Tree-shaking。</li>
<li>轻量：极小体积，几乎无感开销。</li>
</ul>
<h3 data-id="heading-4">兼容性</h3>
<ul>
<li>浏览器支持：现代浏览器（与 Vue 3 要求一致）。</li>
<li>Node.js 支持：可用于 SSR（Vue 3 / Nuxt 3）。</li>
<li>框架兼容：Vue 3、Nuxt 3（官方模块 <code>@pinia/nuxt</code>）。</li>
<li>TypeScript 支持：≥ 4.5（Pinia 3.x 要求）。</li>
</ul>
<h2 data-id="heading-5">安装使用</h2>
<h3 data-id="heading-6">安装方式（仅 pnpm）</h3>
<pre><code class="hljs language-bash" lang="bash">pnpm add pinia
</code></pre>
<h3 data-id="heading-7">基础使用</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> { createPinia, defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>

<span class="hljs-comment">// 创建并注册 Pinia</span>
<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)
<span class="hljs-keyword">const</span> pinia = <span class="hljs-title function_">createPinia</span>()
app.<span class="hljs-title function_">use</span>(pinia)

<span class="hljs-comment">// Setup 风格 Store（推荐）</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCounterStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'counter'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> count = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
  <span class="hljs-keyword">const</span> doubled = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> count.<span class="hljs-property">value</span> * <span class="hljs-number">2</span>)
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">increment</span> = (<span class="hljs-params"/>) =&gt; { count.<span class="hljs-property">value</span> += <span class="hljs-number">1</span> }
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">reset</span> = (<span class="hljs-params"/>) =&gt; { count.<span class="hljs-property">value</span> = <span class="hljs-number">0</span> }
  <span class="hljs-keyword">return</span> { count, doubled, increment, reset }
})

app.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<h3 data-id="heading-8">配置选项（插件示例）</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">/**
 * 选择性持久化插件：仅持久化指定字段
 * <span class="hljs-doctag">@param</span> {<span class="hljs-type">{ store: any, options: Record&lt;string, any&gt; </span>}} ctx - 插件上下文
 * <span class="hljs-doctag">@returns</span> {<span class="hljs-type">void</span>}
 */</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">persistSelectivePlugin</span> = (<span class="hljs-params">{ store, options }</span>) =&gt; {
  <span class="hljs-keyword">const</span> cfg = options?.<span class="hljs-property">persist</span>
  <span class="hljs-keyword">if</span> (!cfg) <span class="hljs-keyword">return</span>
  <span class="hljs-keyword">const</span> key = <span class="hljs-string">`pinia:<span class="hljs-subst">${store.$id}</span>`</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">pick</span> = (<span class="hljs-params">obj, paths</span>) =&gt; paths.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">acc, k</span>) =&gt;</span> (acc[k] = obj[k], acc), {})
  <span class="hljs-keyword">const</span> cached = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(key)
  <span class="hljs-keyword">if</span> (cached) store.$patch(<span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(cached))
  store.$subscribe(<span class="hljs-function">(<span class="hljs-params">_m, state</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> data = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(cfg.<span class="hljs-property">paths</span>) ? <span class="hljs-title function_">pick</span>(state, cfg.<span class="hljs-property">paths</span>) : state
    <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(key, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(data))
  }, { <span class="hljs-attr">detached</span>: <span class="hljs-literal">true</span> })
}

<span class="hljs-keyword">import</span> { createPinia } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">const</span> pinia = <span class="hljs-title function_">createPinia</span>()
pinia.<span class="hljs-title function_">use</span>(persistSelectivePlugin)
</code></pre>
<h2 data-id="heading-9">实际应用</h2>
<h3 data-id="heading-10">应用场景1：用户认证与权限</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useAuthStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'auth'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> token = <span class="hljs-title function_">ref</span>(<span class="hljs-string">''</span>)
  <span class="hljs-keyword">const</span> roles = <span class="hljs-title function_">ref</span>([])
  <span class="hljs-keyword">const</span> isAuthed = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> token.<span class="hljs-property">value</span> !== <span class="hljs-string">''</span>)
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">login</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; { token.<span class="hljs-property">value</span> = <span class="hljs-string">'mock-token'</span>; roles.<span class="hljs-property">value</span> = [<span class="hljs-string">'user'</span>] }
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">logout</span> = (<span class="hljs-params"/>) =&gt; { token.<span class="hljs-property">value</span> = <span class="hljs-string">''</span>; roles.<span class="hljs-property">value</span> = [] }
  <span class="hljs-keyword">return</span> { token, roles, isAuthed, login, logout }
})
</code></pre>
<h3 data-id="heading-11">应用场景2：购物车状态管理</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { defineStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">import</span> { ref, computed } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> useCartStore = <span class="hljs-title function_">defineStore</span>(<span class="hljs-string">'cart'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> items = <span class="hljs-title function_">ref</span>([])
  <span class="hljs-keyword">const</span> total = <span class="hljs-title function_">computed</span>(<span class="hljs-function">() =&gt;</span> items.<span class="hljs-property">value</span>.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">s, i</span>) =&gt;</span> s + i.<span class="hljs-property">price</span> * i.<span class="hljs-property">qty</span>, <span class="hljs-number">0</span>))
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">add</span> = (<span class="hljs-params">p</span>) =&gt; { items.<span class="hljs-property">value</span>.<span class="hljs-title function_">push</span>({ ...p, <span class="hljs-attr">qty</span>: <span class="hljs-number">1</span> }) }
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">remove</span> = (<span class="hljs-params">id</span>) =&gt; { items.<span class="hljs-property">value</span> = items.<span class="hljs-property">value</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">i</span> =&gt;</span> i.<span class="hljs-property">id</span> !== id) }
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">clear</span> = (<span class="hljs-params"/>) =&gt; { items.<span class="hljs-property">value</span> = [] }
  <span class="hljs-keyword">return</span> { items, total, add, remove, clear }
})
</code></pre>
<h2 data-id="heading-12">优缺点分析</h2>
<h3 data-id="heading-13">优点 ✅</h3>
<ul>
<li>直观易上手：贴近 Vue 组合式 API。</li>
<li>类型与调试友好：类型推断 + DevTools 集成。</li>
<li>可扩展：插件、订阅与动作拦截完善。</li>
<li>模块化与轻量：Tree-shaking 与极小体积。</li>
</ul>
<h3 data-id="heading-14">缺点 ❌</h3>
<ul>
<li>Vue 专用：不适用于非 Vue 技术栈。</li>
<li>旧浏览器限制：与 Vue 3 一致，需现代环境。</li>
<li>选项式 actions 与箭头函数：无法使用 <code>this</code>，建议改用 Setup 风格或外部纯函数。</li>
</ul>
<h2 data-id="heading-15">最佳实践</h2>
<h3 data-id="heading-16">开发建议</h3>
<h4 data-id="heading-17">1. 性能优化技巧</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 精准订阅：storeToRefs 保持解构后的响应式</span>
<span class="hljs-keyword">import</span> { storeToRefs } <span class="hljs-keyword">from</span> <span class="hljs-string">'pinia'</span>
<span class="hljs-keyword">const</span> { count, doubled } = <span class="hljs-title function_">storeToRefs</span>(<span class="hljs-title function_">useCounterStore</span>())

<span class="hljs-comment">// 批量更新：使用函数式 $patch，避免多次变更</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">patchFn</span> = (<span class="hljs-params">store</span>) =&gt; { store.$patch(<span class="hljs-function">(<span class="hljs-params">s</span>) =&gt;</span> { s.<span class="hljs-property">count</span> += <span class="hljs-number">2</span> }) }

<span class="hljs-comment">// 解耦订阅：detached 避免组件销毁自动取消</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">subscribeChanges</span> = (<span class="hljs-params">store</span>) =&gt; {
  store.$subscribe(<span class="hljs-function">(<span class="hljs-params">_m, state</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'state:'</span>, state), { <span class="hljs-attr">detached</span>: <span class="hljs-literal">true</span> })
}
</code></pre>
<h4 data-id="heading-18">2. 错误处理策略</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 使用 $onAction 记录完成与错误，辅助定位</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">watchActions</span> = (<span class="hljs-params">store</span>) =&gt; {
  store.$onAction(<span class="hljs-function">(<span class="hljs-params">{ name, after, onError }</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> t = performance.<span class="hljs-title function_">now</span>()
    <span class="hljs-title function_">after</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${name}</span> done`</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(performance.<span class="hljs-title function_">now</span>() - t), <span class="hljs-string">'ms'</span>))
    <span class="hljs-title function_">onError</span>(<span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`<span class="hljs-subst">${name}</span> error`</span>, e))
  })
}
</code></pre>
<h4 data-id="heading-19">3. 内存与资源管理</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 路由切换或组件卸载时重置临时状态</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">resetState</span> = (<span class="hljs-params">store</span>) =&gt; { store.<span class="hljs-property">$reset</span>?.() <span class="hljs-comment">/* Setup 风格自定义 reset */</span> }

<span class="hljs-comment">// 持久化仅保留必要字段，避免写入大对象或隐私数据</span>
</code></pre>
<h3 data-id="heading-20">常见陷阱</h3>
<ul>
<li>选项式 actions + 箭头函数的 <code>this</code>：改用 Setup 风格或外部函数。</li>
<li>直接解构丢响应：使用 <code>storeToRefs</code>。</li>
<li>Store 间循环依赖：抽到服务层或组件组合调用。</li>
<li>过度持久化：谨慎选择字段与存储策略。</li>
</ul>
<h2 data-id="heading-21">进阶用法</h2>
<h3 data-id="heading-22">高级特性示例</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 插件：动作日志</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">actionLoggerPlugin</span> = (<span class="hljs-params">{ store }</span>) =&gt; {
  store.$onAction(<span class="hljs-function">(<span class="hljs-params">{ name, after, onError }</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> start = performance.<span class="hljs-title function_">now</span>()
    <span class="hljs-title function_">after</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`[action] <span class="hljs-subst">${name}</span>`</span>, <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">round</span>(performance.<span class="hljs-title function_">now</span>() - start), <span class="hljs-string">'ms'</span>))
    <span class="hljs-title function_">onError</span>(<span class="hljs-function">(<span class="hljs-params">err</span>) =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">`[action] <span class="hljs-subst">${name}</span> error:`</span>, err))
  })
}

<span class="hljs-comment">// SSR：序列化 pinia.state.value 并在客户端回填</span>
<span class="hljs-comment">// HMR：acceptHMRUpdate(useXxxStore, import.meta.hot)</span>
</code></pre>
<h2 data-id="heading-23">总结</h2>
<p>Pinia 以直观、类型安全与可扩展著称，是管理 Vue 3 复杂状态的首选方案。建议优先使用 Setup 风格编写 Store，搭配 <code>storeToRefs</code> 精准订阅与插件机制实现持久化与可观测性；对大型应用按领域拆分 Store，并为关键动作做好命名与日志。</p>
<hr/>
<h3 data-id="heading-24">参考与链接</h3>
<ul>
<li>官方仓库：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fpinia" target="_blank" title="https://github.com/vuejs/pinia" ref="nofollow noopener noreferrer">github.com/vuejs/pinia</a></li>
<li>官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpinia.vuejs.org%2F" target="_blank" title="https://pinia.vuejs.org/" ref="nofollow noopener noreferrer">pinia.vuejs.org/</a></li>
<li>Releases（版本与变更）：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fvuejs%2Fpinia%2Freleases" target="_blank" title="https://github.com/vuejs/pinia/releases" ref="nofollow noopener noreferrer">github.com/vuejs/pinia…</a></li>
</ul>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[空间智能！李飞飞、LeCun&谢赛宁联手提出“空间超感知”，长文阐述世界模型蓝图]]></title>    <link>https://juejin.cn/post/7571285984088703028</link>    <guid>https://juejin.cn/post/7571285984088703028</guid>    <pubDate>2025-11-11T09:41:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571285984088703028" data-draft-id="7571156741397921807" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="空间智能！李飞飞、LeCun&amp;谢赛宁联手提出“空间超感知”，长文阐述世界模型蓝图"/> <meta itemprop="keywords" content="算法,计算机视觉,深度学习"/> <meta itemprop="datePublished" content="2025-11-11T09:41:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="CoovallyAIHub"/> <meta itemprop="url" content="https://juejin.cn/user/2461151071843739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            空间智能！李飞飞、LeCun&amp;谢赛宁联手提出“空间超感知”，长文阐述世界模型蓝图
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2461151071843739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    CoovallyAIHub
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:41:07.000Z" title="Tue Nov 11 2025 09:41:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>近日，由Yann LeCun、李飞飞、Rob Fergus等AI领域顶级学者共同署名的论文《Cambrian-S: Towards Spatial Supersensing in Video》首次系统性地提出了“空间超感知”的概念，并指出：<strong>空间智能是AI实现真正多模态理解与通用智能的关键路径</strong>。无独有偶，李飞飞随后发表长文《从文字到世界：空间智能是AI的下一个前沿》，进一步阐述了空间智能的核心价值与世界模型的构建蓝图。本文将从论文出发，结合李飞飞的深度思考，带你深入理解这一AI新范式。</p>
<h2 data-id="heading-0"><strong>论文解读：从“语言理解”到“空间超感知”</strong></h2>
<ul>
<li><strong>反思现状：为什么说LLM是“空间盲人”？</strong></li>
</ul>
<p>三位作者指出，当前基于LLM的多模态系统存在根本性局限。LeCun多次公开表示，LLM技术无法通向AGI。谢赛宁在团队博客中坦言：在构建「超感知」之前，不可能真正构建出「超级智能」。</p>
<p>问题的核心在于：LLM虽然能处理文本和图像，却缺乏对3D空间的直觉理解。它们像是通过“钥匙孔”看世界——只能看到碎片化的2D画面，无法在脑海中构建连贯的3D场景。</p>
<p>这种缺陷暴露了莫拉维克悖论在AI领域的再现：对人类来说轻而易举的空间感知，对AI却难如登天。</p>
<ul>
<li><strong>什么是“空间超感知”？</strong></li>
</ul>
<p>论文指出，当前的多模态大模型仍以语言为中心，缺乏对3D空间结构与动态的深层理解。为此，作者提出“空间超感知”的四个发展阶段：</p>
<ul>
<li><strong>语义感知：</strong> 识别物体、属性与关系</li>
<li><strong>流事件认知：</strong> 处理连续、无界的视觉流</li>
<li><strong>隐式3D空间认知：</strong> 理解视频背后的3D世界结构</li>
<li><strong>预测性世界建模：</strong> 构建内部模型，预测未来状态并利用“惊讶”驱动学习与记忆</li>
</ul>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ccae38752b8d4fc7ac36c577b8c38ce6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458867&amp;x-signature=KBdZfILk8aCoQM2RxCVd9syqJGM%3D" alt="screenshot_2025-11-11_14-01-57.png" loading="lazy"/></p>
<p>谢赛宁强调：“超感知不是更好的传感器，而是数字生命体验世界的方式。它是智能的一部分，正如眼睛是大脑触及外部世界的那一部分。”</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c54c174baad4158b73e0bcb1987937a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458867&amp;x-signature=I8uURB0W3ZQqBWo9b1Op5s7kCNg%3D" alt="screenshot_2025-11-11_14-04-04.png" loading="lazy"/></p>
<ul>
<li><strong>新基准：VSI-Super</strong></li>
</ul>
<p>为了评测空间超感知能力，作者提出了VSI-Super基准，包含两个极具挑战的任务：</p>
<ul>
<li><strong>VSR（视觉空间回忆）：</strong> 在长视频中回忆异常物体出现的位置与顺序</li>
</ul>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8541624308544f5b81f7371c1c0a17e0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458867&amp;x-signature=CgpFYDRGC7XYubkmjs8dns4nNbM%3D" alt="screenshot_2025-11-11_14-04-21.png" loading="lazy"/></p>
<ul>
<li><strong>VSC（连续视觉计数）：</strong> 在跨场景、跨视角的视频中持续计数目标物体</li>
</ul>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89eaade2491b42458c576bcdabe30cad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458867&amp;x-signature=pNDzN10iVK4ZT0O%2FrWLFY3am1z8%3D" alt="screenshot_2025-11-11_14-04-39.png" loading="lazy"/></p>
<p>这两个任务都要求模型具备选择性感知、结构化记忆与跨时间推理能力，而非简单地扩展上下文窗口。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0173b15899e41e48192f935a6d4ef7c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458867&amp;x-signature=0516cofWGfjpU6Sr2UgIR1VsVhE%3D" alt="screenshot_2025-11-11_14-05-29.png" loading="lazy"/></p>
<p>结果令人震惊：即使是最先进的Gemini 2.5模型也表现不佳。问题不在上下文长度——即使视频在模型处理能力范围内，性能仍然有限。</p>
<p>更关键的是，人类可以“无限计数”，而模型的计数能力会在几十个对象后达到饱和，暴露了其训练数据的分布限制。</p>
<ul>
<li><strong>Cambrian-S模型：数据驱动的空间认知突破</strong></li>
</ul>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1fa461e90dca47aea70c0026443ee19c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458867&amp;x-signature=uoGDAWa45VwJJuEd%2F73Co8WHVNA%3D" alt="screenshot_2025-11-11_14-06-23.png" loading="lazy"/></p>
<p>作者构建了大规模空间指令调优数据集VSI-590K，并训练了Cambrian-S系列模型。该模型在VSI-Bench等空间理解任务上取得了SOTA表现，甚至超越Gemini-2.5-Pro等闭源模型。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f4176f322e544130aa2fc55f7a488935~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458867&amp;x-signature=LUs3FHhS1DaoRGoaKpQvbXltMSc%3D" alt="screenshot_2025-11-11_14-09-14.png" loading="lazy"/></p>
<p>然而，Cambrian-S在VSI-Super上表现仍有限，说明仅靠数据与规模无法实现真正的空间超感知。</p>
<p>团队得出结论：沿着LLM的老路构建多模态模型，并非通往超感知的终极之道。</p>
<ul>
<li><strong>新范式：预测性感知</strong></li>
</ul>
<p>论文提出 *<strong>“预测性感知”</strong> *作为下一代模型的核心能力。通过自监督的“下一帧潜在预测”模型，利用预测误差（即“惊讶”）来：</p>
<ul>
<li><strong>管理记忆：</strong> 选择性保留重要信息</li>
<li><strong>分割事件：</strong> 将连续视频流划分为有意义的片段</li>
</ul>
<p>实验表明，该方法在VSI-Super上显著优于Gemini-2.5等强基线，展示了预测机制在处理长视频与空间任务上的潜力。</p>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ef9931118da43c681cdf1ed0d2e0b31~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458867&amp;x-signature=FelL%2FqoxvFRVKgnLTrrxiignzc8%3D" alt="screenshot_2025-11-11_14-15-15.png" loading="lazy"/></p>
<ul>
<li><strong>开源与展望</strong></li>
</ul>
<p>团队将论文、代码、模型、数据和基准全面开源，并同步发布：</p>
<pre><code class="hljs language-ruby" lang="ruby">论文地址：<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/arxiv.org/pdf</span><span class="hljs-regexp">/2511.04670
Website：https:/</span><span class="hljs-regexp">/cambrian-mllm.github.io
Code：https:/</span><span class="hljs-regexp">/github.com/cambrian</span>-mllm/cambrian-s
<span class="hljs-title class_">Cambrian</span>-S <span class="hljs-title class_">Models</span>：<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/hf.co/collections</span><span class="hljs-regexp">/nyu-visionx/cambrian</span>-s
<span class="hljs-variable constant_">VSI</span>-590K：<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/hf.co/datasets</span><span class="hljs-regexp">/nyu-visionx/vsi</span>-590k
<span class="hljs-variable constant_">VSI</span>-<span class="hljs-variable constant_">SUPER</span>：<span class="hljs-symbol">https:</span>/<span class="hljs-regexp">/hf.co/collections</span><span class="hljs-regexp">/nyu-visionx/vsi</span>-<span class="hljs-variable language_">super</span>
</code></pre>
<p>关于消除基准中语言偏见的研究</p>
<p>使用模拟器收集空间感知视频的经验总结</p>
<p>谢赛宁表示：“我不敢说我们的方法就是正确道路，但我确信当前范式远远不够。开放科学才是唯一的出路。”</p>
<h2 data-id="heading-1"><strong>李飞飞长文深度解读：从文字到世界</strong></h2>
<p align="center"><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3cdcae9994f74e6284fb358c6c4914ae~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQ29vdmFsbHlBSUh1Yg==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458867&amp;x-signature=l9CTIWSRpknbebX%2B9T2%2BYwxNPUQ%3D" alt="screenshot_2025-11-11_14-18-08.png" loading="lazy"/></p>
<p>在李飞飞最新发表的文章中，她进一步系统化地阐述了“空间智能”与“世界模型”的核心理念：</p>
<ul>
<li><strong>LLM是“空间盲人”，缺乏世界根基</strong></li>
</ul>
<p>李飞飞在文章中犀利地指出，当前的LLM本质上是“黑暗中的文字匠”——能言善辩却无经验，知识丰富却缺乏根基。</p>
<p>它们能处理和生成文本，甚至分析和生成图像、视频，却无法在脑海中构建一个连贯、立体、符合物理规律的3D世界。估算距离、方向、大小，心智旋转物体，在迷宫中导航，预测基本物理规律——这些对人类而言轻而易举的空间认知任务，对最先进的AI来说却难如登天。</p>
<p>这揭示了莫拉维克悖论在AI时代的再现：对人类和动物来说最低级、最无需思考的感知和运动技能，对AI而言反而是最困难的挑战。</p>
<ul>
<li><strong>空间智能：人类认知的“脚手架”</strong></li>
</ul>
<p>李飞飞指出，空间智能是人类理解、交互与创造世界的基础能力。从停车、接钥匙，到消防员在火场中决策，再到科学家通过几何推理发现地球周长，空间智能贯穿于人类的直觉、推理与创造之中。</p>
<p>“对AI而言，世界不止于语言，”李飞飞写道，“空间智能代表着超越语言的前沿。” 它是连接<strong>想象、感知与行动</strong>的关键，是机器真正融入并增强人类生活的基石。</p>
<ul>
<li><strong>当前AI的局限：语言≠世界</strong></li>
</ul>
<p>尽管当前的大语言模型在文本、图像、视频生成上表现惊人，但它们仍缺乏对物理世界的几何一致性、物理规律与动态交互的理解。李飞飞称之为“黑暗中的文字匠”。</p>
<ul>
<li><strong>世界模型的三大核心能力与三大技术挑战</strong></li>
</ul>
<p>如何实现空间智能？李飞飞提出了比LLM更具雄心的体系：世界模型。</p>
<p>她提出，真正具备空间智能的世界模型应具备以下能力：</p>
<ul>
<li><strong>生成性：</strong> 能生成符合物理与几何规律的世界</li>
<li><strong>多模态：</strong> 能处理图像、视频、动作等多种输入</li>
<li><strong>交互性：</strong> 能预测世界在动作影响下的下一个状态</li>
</ul>
<p>构建世界模型巨大挑战：</p>
<p>李飞飞分享了World Labs在此方向的探索：</p>
<ul>
<li><strong>新训练目标：</strong> 需要找到像LLM的“下一个词预测”一样优雅的通用目标函数。</li>
<li><strong>大规模数据：</strong> 需从互联网2D视觉数据中有效提取3D空间信息，并利用合成数据。</li>
<li><strong>新模型架构：</strong> 需超越当前将数据视为1D/2D序列的Transformer和扩散模型范式。应用前景：从创造力到机器人，从科学到教育</li>
</ul>

<ul>
<li><strong>实践探索：从Marble平台到预测性感知</strong></li>
</ul>
<p>李飞飞透露，其初创公司World Labs已在此方向取得进展。其Marble平台是全球首个能通过多模态输入生成并保持一致性3D环境的世界模型，已向部分创作者开放。</p>
<p>与此同时，在开源的《Cambrian-S》论文中，LeCun、李飞飞、谢赛宁团队实践了“预测性感知”这一新范式。他们受认知科学启发，在模型中引入“下一帧潜在预测”模块，利用预测误差（“惊异度”）来驱动记忆管理和事件分割。这个简化的世界模型原型，已让小模型在极具挑战性的空间推理基准VSI-Super上超越了Gemini 2.5等强大基线。</p>
<ul>
<li><strong>未来展望</strong></li>
</ul>
<p>空间智能的世界模型将如何改变世界？李飞飞描绘了清晰的图景：</p>
<ul>
<li><strong>创造力：</strong> 如Marble平台，让创作者快速构建、编辑3D世界</li>
<li><strong>机器人：</strong> 通过世界模型仿真训练，实现泛化与协作</li>
</ul>
<p>科学、医疗、教育：加速药物发现、提升诊断精度、构建沉浸式学习环境</p>
<h2 data-id="heading-2"><strong>总结</strong></h2>
<p>无论是LeCun、李飞飞等人的论文，还是李飞飞的深度长文，都指向同一个结论：空间智能是AI迈向通用智能的必经之路。当前以LLM为核心的范式已触及瓶颈，而融合生成、多模态与交互能力的世界模型，将成为下一代AI系统的核心。AI的发展路径正在从“通过文本来理解世界”的迂回策略，转向“直接感知与建模世界”的正面突破。</p>
<p>这不仅是技术的升级，更是一次认知的回归。它提醒我们，人类智能的辉煌，始于我们与这个三维空间世界的每一次互动、每一次预测和每一次创造。</p>
<p>我们正在为机器装上“空间感”，这或许是赋予它们“常识”的第一步，也是走向真正通用人工智能最关键的一步。 从文字到世界的旅程已经启航，而它的终点，将是一个人类与智能机器共同理解、共同创造的美好未来。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[mmkv的 mmap 的理解]]></title>    <link>https://juejin.cn/post/7571105461099102251</link>    <guid>https://juejin.cn/post/7571105461099102251</guid>    <pubDate>2025-11-11T09:49:26.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571105461099102251" data-draft-id="7571105461098905643" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="mmkv的 mmap 的理解 "/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-11T09:49:26.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="火柴就是我"/> <meta itemprop="url" content="https://juejin.cn/user/272334614705575"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            mmkv的 mmap 的理解 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/272334614705575/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    火柴就是我
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:49:26.000Z" title="Tue Nov 11 2025 09:49:26 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>传统I/O 的示意图 个人理解
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/28ac38fec2c54d07b1b7cf7590fc3de9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763459365&amp;x-signature=mbnsFLDZ6GwT%2FLjaoFInV8oYc2A%3D" alt="image.png" loading="lazy"/></p>
<p>对于传统I/O 我们一般说的效率低 是指 修改数据都需要 把数据在用户缓存 内核缓存直接 拷贝来拷贝去。且每次都是全量拷贝。</p>
<p>mmap对应的示意图 个人理解。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fc1f1bbf33d47319fd7c7d451552679~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54Gr5p-05bCx5piv5oiR:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763459365&amp;x-signature=bMoi3p0GQCX%2BsxmcZG80F%2FKsQ%2Fg%3D" alt="image.png" loading="lazy"/></p>
<p>对于mmap解决的就是去除了把数据在用户缓存 内核缓存直接 拷贝来拷贝去的步骤。改为操作由内核创建的一块物理内存。这个区域进程可以直接访问，内核也可以直接访问。大家说的内存映射就是这块共享内存跟磁盘内存的映射，app读写数据都是直接操作共享内存，app读取发现没有数据，内核负责区磁盘读取放到共享内存。app写数据，内核负责同步数据到磁盘。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[AI会如何评价一名前端工程师的技术人格]]></title>    <link>https://juejin.cn/post/7571304204753928246</link>    <guid>https://juejin.cn/post/7571304204753928246</guid>    <pubDate>2025-11-11T09:49:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571304204753928246" data-draft-id="7571258854900809771" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="AI会如何评价一名前端工程师的技术人格"/> <meta itemprop="keywords" content="前端,AI编程,TypeScript"/> <meta itemprop="datePublished" content="2025-11-11T09:49:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Wilson王艺谋"/> <meta itemprop="url" content="https://juejin.cn/user/1644525123025933"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            AI会如何评价一名前端工程师的技术人格
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1644525123025933/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Wilson王艺谋
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:49:49.000Z" title="Tue Nov 11 2025 09:49:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>在与AI进行多轮技术方案讨论后，你可以让它评价一下提问者的技术人格，以下是AI对我的评价</p>
</blockquote>
<h2 data-id="heading-0">技术人格分析</h2>
<h3 data-id="heading-1">概述</h3>
<p>此分析基于围绕 TypeScript 模块解析、构建工具和文档实践的技术讨论。它揭示了问题解决方法、学习风格和专业特征的模式。</p>
<h3 data-id="heading-2">技术档案</h3>
<h4 data-id="heading-3">深度技术好奇心</h4>
<ul>
<li><strong>根本原因导向</strong> : 不满足于快速修复，深入调查根本原因</li>
<li><strong>为什么驱动的学习</strong> : 当获得解决方案（tsx）时，立即询问基本原因（Node版本兼容性）</li>
<li><strong>概念理解</strong> : 深入探讨超出直接需求的技术概念</li>
<li><strong>系统性视角</strong> : 将个别技术决策与更广泛的生态系统影响联系起来</li>
</ul>
<p><strong>证据:</strong></p>
<ul>
<li>在解决直接问题后询问"为什么原始的 ts-node-esm 在 CI 环境中运行良好"</li>
<li>请求对 moduleResolution 选项的全面解释，而不仅仅是解决方案</li>
<li>询问库发布的消费者兼容性影响</li>
</ul>
<h4 data-id="heading-4">质量导向的工程实践</h4>
<ul>
<li><strong>现代工具</strong> : 维护使用 TypeScript、WDIO、适当 CI/CD 管道的项目</li>
<li><strong>最佳实践</strong> : 考虑开发和生产环境之间的 Node 版本一致性</li>
<li><strong>长远思维</strong> : 权衡灵活性和兼容性之间的取舍</li>
<li><strong>合理架构</strong> : 对模块解析策略做出明智决策</li>
</ul>
<p><strong>证据:</strong></p>
<ul>
<li>维护多个结构良好的项目（<code>mg-icons</code>、<code>master-web</code>）</li>
<li>使用适当的测试框架和构建工具</li>
<li>考虑 CI 环境兼容性和团队一致性</li>
</ul>
<h4 data-id="heading-5">系统性思维</h4>
<ul>
<li><strong>生态系统意识</strong> : 理解技术决策如何影响下游消费者</li>
<li><strong>环境考虑</strong> : 思考开发环境 vs CI vs 生产环境的差异</li>
<li><strong>消费者影响</strong> : 分析谁会受到库发布决策的影响</li>
<li><strong>兼容性矩阵</strong> : 同时考虑多个利益相关者的观点</li>
</ul>
<p><strong>证据:</strong></p>
<ul>
<li>询问哪些消费者类型从严格模块解析中受益</li>
<li>理解打包工具和模块解析需求之间的关系</li>
<li>将 Node 版本差异与 CI/本地开发差异联系起来</li>
</ul>
<h3 data-id="heading-6">沟通和学习风格</h3>
<h4 data-id="heading-7">双语专业背景</h4>
<ul>
<li><strong>国际化视角</strong> : 在英语和中文专业环境中运营</li>
<li><strong>知识共享</strong> : 为不同团队成员创建文档</li>
<li><strong>文化桥梁</strong> : 促进跨语言障碍的技术知识传递</li>
</ul>
<p><strong>证据:</strong></p>
<ul>
<li>请求技术文档的英语和中文版本</li>
<li>在文档规划中考虑团队可访问性</li>
</ul>
<h4 data-id="heading-8">系统化学习方法</h4>
<ul>
<li><strong>结构化信息</strong> : 偏好有清晰分类的有组织解释</li>
<li><strong>全面覆盖</strong> : 希望完整理解而不是部分解决方案</li>
<li><strong>比较分析</strong> : 重视并排比较和决策矩阵</li>
<li><strong>参考文档</strong> : 为将来使用和团队共享创建资源</li>
</ul>
<p><strong>证据:</strong></p>
<ul>
<li>请求决策矩阵和比较表</li>
<li>要求逐步迁移指南</li>
<li>希望全面覆盖所有 moduleResolution 选项</li>
</ul>
<h4 data-id="heading-9">知识管理者</h4>
<ul>
<li><strong>文档优先</strong> : 优先创建持久的知识资源</li>
<li><strong>团队赋能</strong> : 思考如何帮助他人学习和做决策</li>
<li><strong>系统化组织</strong> : 为最大效用而结构化信息</li>
<li><strong>未来参考</strong> : 为长期知识保存做规划</li>
</ul>
<p><strong>证据:</strong></p>
<ul>
<li>要求将技术讨论整理成正式文档</li>
<li>请求两个版本以提高团队可访问性</li>
<li>希望有组织的、全面的指南而不是快速答案</li>
</ul>
<h3 data-id="heading-10">专业背景指标</h3>
<h4 data-id="heading-11">高级开发者/技术主管</h4>
<ul>
<li><strong>架构决策</strong> : 对基本项目配置做出选择</li>
<li><strong>库发布</strong> : 理解消费者兼容性的关注点</li>
<li><strong>团队影响</strong> : 考虑决策如何影响其他开发者</li>
<li><strong>战略思维</strong> : 平衡即时需求与长期可维护性</li>
</ul>
<p><strong>证据:</strong></p>
<ul>
<li>管理多个具有不同技术要求的项目</li>
<li>理解库发布和消费者兼容性关注点</li>
<li>对开发工具和配置做出明智决策</li>
</ul>
<h4 data-id="heading-12">协作环境</h4>
<ul>
<li><strong>团队文档</strong> : 为团队知识共享创建资源</li>
<li><strong>CI/生产意识</strong> : 理解环境一致性的重要性</li>
<li><strong>跨功能思维</strong> : 考虑对不同团队角色和工作流程的影响</li>
<li><strong>知识传递</strong> : 优先让技术知识变得可获取</li>
</ul>
<p><strong>证据:</strong></p>
<ul>
<li>在技术决策中考虑 CI 环境行为</li>
<li>为多元化团队成员创建双语文档</li>
<li>思考团队工作流程和知识保存</li>
</ul>
<h3 data-id="heading-13">学习和问题解决模式</h3>
<h4 data-id="heading-14">智识好奇心</h4>
<ul>
<li><strong>深入挖掘倾向</strong> : 将简单问题转化为全面的学习机会</li>
<li><strong>基于原理的理解</strong> : 想要理解基础概念，而不仅仅是解决方案</li>
<li><strong>持续学习</strong> : 利用每个技术挑战来扩展知识</li>
<li><strong>通过学习教学</strong> : 在获取知识的同时分享知识</li>
</ul>
<h4 data-id="heading-15">务实的彻底性</h4>
<ul>
<li><strong>平衡方法</strong> : 将即时问题解决与长期理解结合起来</li>
<li><strong>基于证据的决策</strong> : 使用技术分析来指导选择</li>
<li><strong>风险评估</strong> : 考虑不同方法的权衡和影响</li>
<li><strong>可持续解决方案</strong> : 优先考虑长期有效的方法</li>
</ul>
<h4 data-id="heading-16">沟通卓越</h4>
<ul>
<li><strong>清晰文档</strong> : 创建结构良好、全面的技术资源</li>
<li><strong>多受众意识</strong> : 为不同利益相关者调整沟通方式</li>
<li><strong>知识可访问性</strong> : 使复杂技术概念易于理解</li>
<li><strong>协作精神</strong> : 促进团队学习和决策制定</li>
</ul>
<h3 data-id="heading-17">专业原型</h3>
<p><strong>高级软件工程师 / 技术主管</strong></p>
<p>此档案表明某人处于高级技术角色，他们：</p>
<ul>
<li>为团队做出架构和工具决策</li>
<li>平衡技术卓越与实际交付需求</li>
<li>促进知识共享和团队发展</li>
<li>在国际/多文化环境中有效运作</li>
<li>构建具有长期可维护性的系统</li>
</ul>
<p><strong>核心价值观:</strong></p>
<ul>
<li>深度理解胜过快速修复</li>
<li>团队赋能和知识共享</li>
<li>技术解决方案的质量和可持续性</li>
<li>全面的文档和沟通</li>
<li>考虑广泛影响的深思熟虑决策制定</li>
</ul>
<h3 data-id="heading-18">协作建议</h3>
<h4 data-id="heading-19">合作时</h4>
<ul>
<li>提供带有基础推理的全面解释</li>
<li>包括比较分析和决策矩阵</li>
<li>提供多重观点和权衡考虑</li>
<li>创建可以共享和稍后参考的文档</li>
</ul>
<h4 data-id="heading-20">沟通风格</h4>
<ul>
<li>在技术解释中要彻底但有组织</li>
<li>包括示例和实际应用</li>
<li>考虑更广泛的生态系统和团队影响</li>
<li>准备好处理深入探讨概念的后续问题</li>
</ul>
<h4 data-id="heading-21">项目方法</h4>
<ul>
<li>为长期可维护性和团队知识传递做规划</li>
<li>在技术决策中考虑多个利益相关者的观点</li>
<li>为将来参考记录决策和推理</li>
<li>平衡即时需求与战略技术方向</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Observability：适用于 PHP 的 OpenTelemetry：EDOT PHP 加入 OpenTelemetry 项目]]></title>    <link>https://juejin.cn/post/7571304204753879094</link>    <guid>https://juejin.cn/post/7571304204753879094</guid>    <pubDate>2025-11-11T09:38:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571304204753879094" data-draft-id="7571077686108389439" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Observability：适用于 PHP 的 OpenTelemetry：EDOT PHP 加入 OpenTelemetry 项目"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2025-11-11T09:38:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Observability：适用于 PHP 的 OpenTelemetry：EDOT PHP 加入 OpenTelemetry 项目
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:38:14.000Z" title="Tue Nov 11 2025 09:38:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作者：Elastic <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fobservability-labs%2Fauthor%2Fpawel-filipczak" title="https://www.elastic.co/observability-labs/author/pawel-filipczak" target="_blank" ref="nofollow noopener noreferrer">Pawel Filipczak</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06534fc5cfdd4100a4240b81f038a19b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458694&amp;x-signature=BC5mtMgZleq%2B8I3JOhsq4Tv5cDs%3D" alt="" loading="lazy"/></p>
<p>了解 Elastic 向 OpenTelemetry 社区捐赠其 EDOT PHP 的详情，并发现这如何让适用于 PHP 的 OpenTelemetry 变得更简单、更易用。</p>
<p>OpenTelemetry 社区已正式接受 Elastic 的提案，贡献其适用于 PHP 的 <strong>Elastic 版 OpenTelemetry（EDOT PHP）</strong>—— 这标志着为全球最广泛使用的网络语言之一带来一流可观测性的一个重要里程碑。</p>
<p>几十年来，PHP 支撑了从小型企业网站到大型 SaaS 平台的一切。然而，PHP 的可观测性通常需要手动设置、编译器、自定义扩展或修改应用代码 —— 这些挑战限制了其在生产环境中的采用。此次即将完成的捐赠旨在改变这一点，使适用于 PHP 的 OpenTelemetry 与<strong>其他运行时一样易于部署</strong>。</p>
<h2 data-id="heading-0">未来展望</h2>
<p>一旦贡献过程完成，EDOT PHP 将成为 OpenTelemetry 项目的一部分 —— 提供一个完整的、可用于生产的发行版，优化了性能、简便性和可扩展性。</p>
<p>EDOT PHP 为 PHP 可观测性引入了新方法：</p>
<ul>
<li>
<p><strong>简单安装</strong> —— 安装适用于 PHP 的 OpenTelemetry 将像安装标准系统包一样简单。从此，代理会自动检测并监控 PHP 应用 —— 无需修改代码，无需手动设置。</p>
</li>
<li>
<p><strong>自动代理加载</strong> —— 在云和容器环境中透明工作，无需修改应用部署。</p>
</li>
<li>
<p><strong>零配置</strong> —— 以单个自包含二进制文件发布；无需安装或编译任何外部扩展。</p>
</li>
<li>
<p><strong>原生 C++ 性能</strong> —— 内置 C++ 序列化器将遥测开销降低最多 5 倍。</p>
</li>
<li>
<p><strong>自动监控</strong> —— 开箱即用地监控流行框架和库。</p>
</li>
<li>
<p><strong>推断跨度</strong> —— 即使是未监控的代码路径，也能揭示行为，实现完整追踪覆盖。</p>
</li>
<li>
<p><strong>自动根跨度</strong> —— 即使在遗留或部分监控的应用中，也能确保完整追踪。</p>
</li>
<li>
<p><strong>OpAMP 准备</strong> —— 虽然 OpenTelemetry 社区仍在标准化配置模式和管理工作流，EDOT PHP 的实现已完全准备好支持这些即将到来的规范 —— 确保 OpAMP 生态成熟后无缝采用。</p>
</li>
<li>
<p><strong>异步后端通信</strong> —— 遥测数据异步导出到 OpenTelemetry Collector 或后端，不会阻塞被监控的应用。这确保了即使在高负载下，跨度和指标导出也不会增加用户请求延迟或影响响应时间。</p>
</li>
</ul>
<p>综合来看，这些功能使 EDOT PHP 成为首个真正零工作量的 PHP 可观测性解决方案 —— 从本地测试到云规模生产系统都适用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7baaffb460174b82add969a24d4567fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763458694&amp;x-signature=u8OLrHz4qU9uiILLLS1SI%2Fp%2Bp7Y%3D" alt="" loading="lazy"/> EDOT PHP 中的原生 C++ 序列化器和异步导出管道将平均请求时间从 49 毫秒降低到 23 毫秒，比纯 PHP 实现快超过 2 倍。</p>
<h2 data-id="heading-1">在现有基础上构建</h2>
<p>EDOT PHP 并不替代现有的 OpenTelemetry PHP SDK —— 它是在其基础上进行扩展和增强。它将 SDK、自动监控和原生扩展打包为单个统一的代理包，与现有的 OpenTelemetry 规范和 API 无缝兼容。</p>
<p>通过贡献这项工作，Elastic 帮助 OpenTelemetry 社区加速 PHP 的采用，实现跨语言的一致实现，并让分布式追踪真正普及。</p>
<blockquote>
<p>这不是一次交接 —— 而是一次合作。我们贡献了多年的开发成果，以帮助适用于 PHP 的 OpenTelemetry 更快发展、更高效运行，并覆盖每个环境中的更多用户。</p>
<p>Elastic Observability 团队</p>
</blockquote>
<h2 data-id="heading-2">持续改进</h2>
<p>在 EDOT PHP 集成到 OpenTelemetry 之前，Elastic 仍在持续投资推进其发展。团队目前重点关注<strong>降低资源使用和内存占用</strong>，尤其是在<strong>多工作进程服务器环境</strong>中，如 PHP-FPM 或 Apache prefork。这些优化旨在使代理在高负载下更加可预测和高效 —— 确保即使在大规模生产部署中，遥测仍保持轻量。</p>
<p>除此之外，我们正在探索进一步的改进，以提升性能和互操作性。研究的方向包括高并发场景下更智能的协调、更好地在工作进程间共享遥测资源，以及未来与额外 OpenTelemetry 信号（如指标和日志）的对齐。</p>
<p>这些努力将帮助 EDOT PHP 不仅更快，而且更具适应性，并能无缝集成到多样的运行时架构中。</p>
<h2 data-id="heading-3">重要性</h2>
<p>这项贡献不仅关乎性能 —— 更在于<strong>消除障碍</strong>。通过使适用于 PHP 的 OpenTelemetry 可作为简单系统包安装，并自动加载到正在运行的应用中，该项目向每位 PHP 开发者、运维人员和平台提供者开放可观测性。</p>
<p>对于 OpenTelemetry 生态系统而言，它填补了最后一个主要语言空白，将可视化扩展到互联网上的绝大部分 —— 所有这些都在开放治理和社区协作下进行。</p>
<h2 data-id="heading-4">展望未来</h2>
<p>在接下来的几个月里，Elastic 与 OpenTelemetry PHP SIG 将紧密合作，推进技术集成、文档和社区入门流程。一旦过渡完成，开发者将获得一个完全开源、社区驱动、可用于生产的 OpenTelemetry 代理 —— “开箱即用”，无需摩擦、配置或修改代码。</p>
<p>我们共同构建一个未来，使<strong>可观测性真正无障碍 —— 适用于每种语言、每个框架和每种环境</strong>。</p>
<h2 data-id="heading-5">更多信息：</h2>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fdocs%2Freference%2Fopentelemetry" title="https://www.elastic.co/docs/reference/opentelemetry" target="_blank" ref="nofollow noopener noreferrer">EDOT 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fobservability-labs%2Fblog%2Felastic-managed-otlp-endpoint-for-opentelemetry" title="https://www.elastic.co/observability-labs/blog/elastic-managed-otlp-endpoint-for-opentelemetry" target="_blank" ref="nofollow noopener noreferrer">了解</a> OTLP Endpoint</li>
</ul>
<p>原文：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.elastic.co%2Fobservability-labs%2Fblog%2Fopentelemetry-accepts-elastics-donation-of-edot" title="https://www.elastic.co/observability-labs/blog/opentelemetry-accepts-elastics-donation-of-edot" target="_blank" ref="nofollow noopener noreferrer">www.elastic.co/observabili…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入理解集群消费与广播消费的进度管理策略]]></title>    <link>https://juejin.cn/post/7571077686108520511</link>    <guid>https://juejin.cn/post/7571077686108520511</guid>    <pubDate>2025-11-11T09:48:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571077686108520511" data-draft-id="7571077686108438591" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入理解集群消费与广播消费的进度管理策略"/> <meta itemprop="keywords" content="RocketMQ"/> <meta itemprop="datePublished" content="2025-11-11T09:48:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="踏浪无痕"/> <meta itemprop="url" content="https://juejin.cn/user/2834988091055719"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入理解集群消费与广播消费的进度管理策略
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2834988091055719/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    踏浪无痕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:48:59.000Z" title="Tue Nov 11 2025 09:48:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">🎯 RocketMQ 消费进度管理机制详解</h2>
<blockquote>
<p>深入理解集群消费与广播消费的进度管理策略</p>
</blockquote>
<h3 data-id="heading-1">💡 核心概念</h3>
<p><strong>关键理解：ConsumeQueue 本身不记录消费进度！</strong></p>
<p>ConsumeQueue 只是一个<strong>消息索引</strong>，它存储的是消息在 CommitLog 中的位置信息，是一个<strong>只读的、所有消费者共享的数据结构</strong>。</p>
<p>**消费进度（Offset）**是单独存储和管理的，存储位置根据消费模式不同而不同：</p>
<ul>
<li><strong>集群消费模式：</strong> 进度存储在 Broker 端（远程存储）</li>
<li><strong>广播消费模式：</strong> 进度存储在 Consumer 端（本地存储）</li>
</ul>
<hr/>
<h3 data-id="heading-2">🔄 两种消费模式</h3>
<h4 data-id="heading-3">📊 消费模式对比图</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph Modes["RocketMQ 消费模式"]
        direction LR
        
        subgraph Clustering["集群消费 CLUSTERING"]
            C1["ConsumerGroup&lt;br/&gt;共享消费"]
            C1_1["Consumer 1"]
            C1_2["Consumer 2"]
            C1_3["Consumer 3"]
            OFF1["Broker存储进度&lt;br/&gt;共享Offset"]
            
            C1 --&gt; C1_1
            C1 --&gt; C1_2
            C1 --&gt; C1_3
            C1_1 -.-&gt; OFF1
            C1_2 -.-&gt; OFF1
            C1_3 -.-&gt; OFF1
        end
        
        subgraph Broadcasting["广播消费 BROADCASTING"]
            B1["ConsumerGroup&lt;br/&gt;独立消费"]
            B1_1["Consumer 1&lt;br/&gt;本地Offset"]
            B1_2["Consumer 2&lt;br/&gt;本地Offset"]
            B1_3["Consumer 3&lt;br/&gt;本地Offset"]
            
            B1 --&gt; B1_1
            B1 --&gt; B1_2
            B1 --&gt; B1_3
        end
    end
</code></pre>
<hr/>
<h4 data-id="heading-4">🟢 集群消费模式（CLUSTERING）</h4>
<h5 data-id="heading-5">特点</h5>
<ul>
<li><strong>负载均衡：</strong> 同一个 ConsumerGroup 中的消费者会分摊消息</li>
<li><strong>每条消息只被消费一次：</strong> 一个 Queue 的消息只会被分配给一个 Consumer</li>
<li><strong>进度共享：</strong> 同一个 ConsumerGroup 内的所有 Consumer 共享消费进度</li>
<li><strong>Broker 存储：</strong> 消费进度保存在 Broker 端，便于集中管理和监控</li>
</ul>
<h5 data-id="heading-6">消费进度存储位置</h5>
<pre><code class="hljs language-arduino" lang="arduino">Broker 端存储路径：
$ROCKETMQ_HOME/store/config/consumerOffset.json

存储格式：
{
  <span class="hljs-string">"offsetTable"</span>: {
    <span class="hljs-string">"order-topic@order-consumer-group"</span>: {
      <span class="hljs-string">"0"</span>: <span class="hljs-number">1234</span>,   <span class="hljs-comment">// Queue 0 的消费进度</span>
      <span class="hljs-string">"1"</span>: <span class="hljs-number">5678</span>,   <span class="hljs-comment">// Queue 1 的消费进度</span>
      <span class="hljs-string">"2"</span>: <span class="hljs-number">9012</span>,   <span class="hljs-comment">// Queue 2 的消费进度</span>
      <span class="hljs-string">"3"</span>: <span class="hljs-number">3456</span>    <span class="hljs-comment">// Queue 3 的消费进度</span>
    }
  }
}
</code></pre>
<h5 data-id="heading-7">工作流程</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant C1 as Consumer1
    participant C2 as Consumer2
    participant B as Broker
    participant CQ as ConsumeQueue
    participant CL as CommitLog

    Note over C1,C2: 同一个 ConsumerGroup
    
    C1-&gt;&gt;B: 拉取 Queue0 消息
    B-&gt;&gt;B: 查询 Queue0 的 Offset (如: 100)
    B-&gt;&gt;CQ: 从 Offset=100 开始查询
    CQ-&gt;&gt;CL: 根据索引读取消息
    CL--&gt;&gt;B: 返回消息内容
    B--&gt;&gt;C1: 推送消息
    
    C1-&gt;&gt;C1: 消费消息
    C1-&gt;&gt;B: 提交新 Offset (如: 110)
    B-&gt;&gt;B: 更新 consumerOffset.json
    
    Note over C2: Consumer2 同时处理其他 Queue
    C2-&gt;&gt;B: 拉取 Queue1 消息
    B-&gt;&gt;B: 查询 Queue1 的 Offset
</code></pre>
<h5 data-id="heading-8">典型应用场景</h5>
<ul>
<li><strong>订单处理系统：</strong> 保证每个订单只被处理一次</li>
<li><strong>日志收集：</strong> 多个消费者分摊处理大量日志</li>
<li><strong>数据同步：</strong> 多个消费者并行同步数据，提高效率</li>
</ul>
<hr/>
<h4 data-id="heading-9">🔵 广播消费模式（BROADCASTING）</h4>
<h5 data-id="heading-10">特点</h5>
<ul>
<li><strong>全量消费：</strong> 每个 Consumer 都会收到所有消息</li>
<li><strong>独立进度：</strong> 每个 Consumer 维护自己的消费进度</li>
<li><strong>本地存储：</strong> 消费进度保存在各自的本地文件系统</li>
<li><strong>无负载均衡：</strong> 不会分配 Queue，每个 Consumer 都消费所有 Queue</li>
</ul>
<h5 data-id="heading-11">消费进度存储位置</h5>
<pre><code class="hljs language-perl" lang="perl">Consumer 本地存储路径：
~<span class="hljs-regexp">/.rocketmq_offsets/</span>${clientId}/${ConsumerGroup}/offsets.json

存储格式：
{
  <span class="hljs-string">"offsetTable"</span>: {
    <span class="hljs-string">"config-topic@broker-a@0"</span>: <span class="hljs-number">123</span>,
    <span class="hljs-string">"config-topic@broker-a@1"</span>: <span class="hljs-number">456</span>,
    <span class="hljs-string">"config-topic@broker-a@2"</span>: <span class="hljs-number">789</span>,
    <span class="hljs-string">"config-topic@broker-a@3"</span>: <span class="hljs-number">101</span>
  }
}
</code></pre>
<h5 data-id="heading-12">工作流程</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant C1 as Consumer1&lt;br/&gt;(本地Offset)
    participant C2 as Consumer2&lt;br/&gt;(本地Offset)
    participant B as Broker
    participant CQ as ConsumeQueue

    Note over C1,C2: 同一个 ConsumerGroup&lt;br/&gt;但独立消费

    par Consumer1 消费
        C1-&gt;&gt;C1: 读取本地 Offset
        C1-&gt;&gt;B: 拉取消息(从本地Offset开始)
        B-&gt;&gt;CQ: 查询所有 Queue
        CQ--&gt;&gt;B: 返回消息索引
        B--&gt;&gt;C1: 推送消息
        C1-&gt;&gt;C1: 消费消息
        C1-&gt;&gt;C1: 更新本地 Offset
    and Consumer2 消费
        C2-&gt;&gt;C2: 读取本地 Offset
        C2-&gt;&gt;B: 拉取消息(从本地Offset开始)
        B-&gt;&gt;CQ: 查询所有 Queue
        CQ--&gt;&gt;B: 返回消息索引
        B--&gt;&gt;C2: 推送消息
        C2-&gt;&gt;C2: 消费消息
        C2-&gt;&gt;C2: 更新本地 Offset
    end

    Note over C1,C2: 两个 Consumer 收到相同的消息&lt;br/&gt;但进度独立管理
</code></pre>
<h5 data-id="heading-13">典型应用场景</h5>
<ul>
<li><strong>配置推送：</strong> 应用配置更新，所有实例都需要接收</li>
<li><strong>缓存刷新：</strong> 缓存失效通知，所有节点都需要更新</li>
<li><strong>实时监控：</strong> 多个监控系统同时接收相同的监控数据</li>
</ul>
<hr/>
<h3 data-id="heading-14">📊 集群消费与广播消费对比</h3>













































<table><thead><tr><th>维度</th><th>集群消费（CLUSTERING）</th><th>广播消费（BROADCASTING）</th></tr></thead><tbody><tr><td><strong>消息分配</strong></td><td>负载均衡，每条消息只被一个Consumer消费</td><td>每个Consumer都收到所有消息</td></tr><tr><td><strong>进度存储位置</strong></td><td>Broker 端（远程）</td><td>Consumer 端（本地）</td></tr><tr><td><strong>进度管理</strong></td><td>ConsumerGroup 共享进度</td><td>每个Consumer独立管理进度</td></tr><tr><td><strong>扩展性</strong></td><td>增加Consumer可以提高消费能力</td><td>增加Consumer不会提高消费能力</td></tr><tr><td><strong>可靠性</strong></td><td>高（Broker集中管理）</td><td>中（依赖本地文件）</td></tr><tr><td><strong>监控难度</strong></td><td>容易（集中查询）</td><td>困难（分散在各个Consumer）</td></tr><tr><td><strong>典型场景</strong></td><td>订单处理、日志收集</td><td>配置推送、缓存刷新</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-15">🛠️ 消费进度管理详解</h3>
<h4 data-id="heading-16">集群模式的进度管理机制</h4>
<h5 data-id="heading-17">1. 进度提交流程</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[Consumer消费消息] --&gt; B[返回CONSUME_SUCCESS]
    B --&gt; C[框架自动提交Offset]
    C --&gt; D[更新内存中的Offset]
    D --&gt; E[定期持久化到Broker]
    
    E --&gt; F[Broker写入consumerOffset.json]
    
    style A fill:#e3f2fd
    style F fill:#e8f5e9
</code></pre>
<h5 data-id="heading-18">2. 进度存储结构</h5>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"offsetTable"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"TopicTest@GroupTest"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"0"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">12345</span><span class="hljs-punctuation">,</span>     <span class="hljs-comment">// MessageQueue: broker-a, queueId=0, offset=12345</span>
      <span class="hljs-attr">"1"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">67890</span><span class="hljs-punctuation">,</span>     <span class="hljs-comment">// MessageQueue: broker-a, queueId=1, offset=67890</span>
      <span class="hljs-attr">"2"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">23456</span><span class="hljs-punctuation">,</span>     <span class="hljs-comment">// MessageQueue: broker-b, queueId=0, offset=23456</span>
      <span class="hljs-attr">"3"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">78901</span>      <span class="hljs-comment">// MessageQueue: broker-b, queueId=1, offset=78901</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"OrderTopic@OrderGroup"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"0"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1000</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"1"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2000</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-19">3. 关键特性</h5>
<ul>
<li><strong>自动持久化：</strong> Consumer 定期（默认 5 秒）将内存中的 Offset 持久化到 Broker</li>
<li><strong>故障恢复：</strong> Consumer 重启后，从 Broker 读取上次的 Offset 继续消费</li>
<li><strong>重平衡支持：</strong> Consumer 增减时，新分配的 Queue 会从 Broker 获取上次的进度</li>
</ul>
<hr/>
<h4 data-id="heading-20">广播模式的进度管理机制</h4>
<h5 data-id="heading-21">1. 进度提交流程</h5>
<pre><code class="hljs language-mermaid" lang="mermaid">graph LR
    A[Consumer消费消息] --&gt; B[返回CONSUME_SUCCESS]
    B --&gt; C[框架自动提交Offset]
    C --&gt; D[更新内存中的Offset]
    D --&gt; E[定期持久化到本地文件]
    
    E --&gt; F[写入~/.rocketmq_offsets/]
    
    style A fill:#e3f2fd
    style F fill:#fff3e0
</code></pre>
<h5 data-id="heading-22">2. 本地存储路径</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># Linux/Mac</span>
~/.rocketmq_offsets/<span class="hljs-variable">${clientId}</span>/<span class="hljs-variable">${ConsumerGroup}</span>/offsets.json

<span class="hljs-comment"># Windows</span>
C:\Users\<span class="hljs-variable">${username}</span>\.rocketmq_offsets\<span class="hljs-variable">${clientId}</span>\<span class="hljs-variable">${ConsumerGroup}</span>\offsets.json

<span class="hljs-comment"># 示例</span>
/home/user/.rocketmq_offsets/192.168.1.100@12345/config-consumer-group/offsets.json
</code></pre>
<h5 data-id="heading-23">3. 存储格式</h5>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"offsetTable"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"ConfigTopic@broker-a@0"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">100</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ConfigTopic@broker-a@1"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">200</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ConfigTopic@broker-a@2"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">300</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"ConfigTopic@broker-a@3"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">400</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-24">4. 关键特性</h5>
<ul>
<li><strong>本地管理：</strong> Broker 不存储任何广播模式的消费进度</li>
<li><strong>独立恢复：</strong> 每个 Consumer 重启后从自己的本地文件恢复进度</li>
<li><strong>无中心化：</strong> 无法在 Broker 端统一查询所有 Consumer 的进度</li>
</ul>
<hr/>
<h3 data-id="heading-25">💻 代码示例</h3>
<h4 data-id="heading-26">集群消费模式配置</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java 代码示例 - 集群消费模式</span>
<span class="hljs-type">DefaultMQPushConsumer</span> <span class="hljs-variable">consumer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMQPushConsumer</span>(<span class="hljs-string">"order-consumer-group"</span>);
consumer.setNamesrvAddr(<span class="hljs-string">"192.168.1.100:9876"</span>);

<span class="hljs-comment">// 设置为集群消费模式（默认）</span>
consumer.setMessageModel(MessageModel.CLUSTERING);

consumer.subscribe(<span class="hljs-string">"OrderTopic"</span>, <span class="hljs-string">"*"</span>);

consumer.registerMessageListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageListenerConcurrently</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> ConsumeConcurrentlyStatus <span class="hljs-title function_">consumeMessage</span><span class="hljs-params">(
            List&lt;MessageExt&gt; msgs, 
            ConsumeConcurrentlyContext context)</span> {
        
        <span class="hljs-keyword">for</span> (MessageExt msg : msgs) {
            <span class="hljs-comment">// 处理消息</span>
            System.out.println(<span class="hljs-string">"消费消息: "</span> + <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(msg.getBody()));
        }
        
        <span class="hljs-comment">// 返回成功，框架会自动提交消费进度到 Broker</span>
        <span class="hljs-keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
    }
});

consumer.start();

<span class="hljs-comment">// 注意：</span>
<span class="hljs-comment">// 1. 消费进度自动保存到 Broker</span>
<span class="hljs-comment">// 2. 同一个 ConsumerGroup 的消费者会分摊消息</span>
<span class="hljs-comment">// 3. 消费者重启后从 Broker 恢复进度</span>
</code></pre>
<h4 data-id="heading-27">广播消费模式配置</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// Java 代码示例 - 广播消费模式</span>
<span class="hljs-type">DefaultMQPushConsumer</span> <span class="hljs-variable">consumer</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultMQPushConsumer</span>(<span class="hljs-string">"config-consumer-group"</span>);
consumer.setNamesrvAddr(<span class="hljs-string">"192.168.1.100:9876"</span>);

<span class="hljs-comment">// 设置为广播消费模式</span>
consumer.setMessageModel(MessageModel.BROADCASTING);

consumer.subscribe(<span class="hljs-string">"ConfigUpdateTopic"</span>, <span class="hljs-string">"*"</span>);

consumer.registerMessageListener(<span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageListenerConcurrently</span>() {
    <span class="hljs-meta">@Override</span>
    <span class="hljs-keyword">public</span> ConsumeConcurrentlyStatus <span class="hljs-title function_">consumeMessage</span><span class="hljs-params">(
            List&lt;MessageExt&gt; msgs, 
            ConsumeConcurrentlyContext context)</span> {
        
        <span class="hljs-keyword">for</span> (MessageExt msg : msgs) {
            <span class="hljs-comment">// 处理配置更新</span>
            <span class="hljs-type">String</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(msg.getBody());
            System.out.println(<span class="hljs-string">"收到配置更新: "</span> + config);
            <span class="hljs-comment">// 更新本地配置</span>
            updateLocalConfig(config);
        }
        
        <span class="hljs-comment">// 返回成功，框架会自动保存进度到本地文件</span>
        <span class="hljs-keyword">return</span> ConsumeConcurrentlyStatus.CONSUME_SUCCESS;
    }
});

consumer.start();

<span class="hljs-comment">// 注意：</span>
<span class="hljs-comment">// 1. 消费进度自动保存到本地文件</span>
<span class="hljs-comment">// 2. 每个消费者都会收到所有消息</span>
<span class="hljs-comment">// 3. 消费者重启后从本地文件恢复进度</span>
<span class="hljs-comment">// 4. 本地进度文件路径: ~/.rocketmq_offsets/</span>
</code></pre>
<h4 data-id="heading-28">手动管理消费进度</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">// 查询消费进度（集群模式）</span>
<span class="hljs-type">long</span> <span class="hljs-variable">offset</span> <span class="hljs-operator">=</span> consumer.getOffsetStore().readOffset(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageQueue</span>(<span class="hljs-string">"OrderTopic"</span>, <span class="hljs-string">"broker-a"</span>, <span class="hljs-number">0</span>),
    ReadOffsetType.READ_FROM_STORE
);
System.out.println(<span class="hljs-string">"当前消费进度: "</span> + offset);

<span class="hljs-comment">// 重置消费进度（集群模式）</span>
consumer.getOffsetStore().updateOffset(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageQueue</span>(<span class="hljs-string">"OrderTopic"</span>, <span class="hljs-string">"broker-a"</span>, <span class="hljs-number">0</span>),
    <span class="hljs-number">1000L</span>,  <span class="hljs-comment">// 新的 offset</span>
    <span class="hljs-literal">false</span>
);

<span class="hljs-comment">// 持久化进度</span>
consumer.getOffsetStore().persistAll(
    Collections.singleton(
        <span class="hljs-keyword">new</span> <span class="hljs-title class_">MessageQueue</span>(<span class="hljs-string">"OrderTopic"</span>, <span class="hljs-string">"broker-a"</span>, <span class="hljs-number">0</span>)
    )
);
</code></pre>
<hr/>
<h3 data-id="heading-29">❓ 常见问题解答</h3>
<h4 data-id="heading-30">Q1: 为什么集群模式下多个消费者不会重复消费？</h4>
<p><strong>A:</strong> 因为 RocketMQ 有负载均衡机制。一个 Queue 只会分配给一个 Consumer，所以不会重复消费。</p>
<ul>
<li>假设有 4 个 Queue，2 个 Consumer</li>
<li>Consumer1 分配到 Queue0 和 Queue1</li>
<li>Consumer2 分配到 Queue2 和 Queue3</li>
<li>他们各自消费不同的 Queue，进度独立记录</li>
</ul>
<hr/>
<h4 data-id="heading-31">Q2: 广播模式下，如果有 100 个消费者，是否需要 100 份进度记录？</h4>
<p><strong>A:</strong> 是的！但这些进度记录不在 Broker，而是分散在各个消费者的本地文件系统中。</p>
<ul>
<li>每个消费者在自己的机器上维护进度</li>
<li>Broker 不需要为广播模式存储任何进度信息</li>
<li>这也是为什么广播模式无法集中管理进度的原因</li>
</ul>
<hr/>
<h4 data-id="heading-32">Q3: ConsumeQueue 和消费进度（Offset）的关系是什么？</h4>
<p><strong>A:</strong> 可以类比为"书"和"书签"的关系：</p>
<ul>
<li><strong>ConsumeQueue：</strong> 就像一本书的目录，告诉你每页内容在哪里</li>
<li><strong>消费进度（Offset）：</strong> 就像书签，记录你读到第几页了</li>
<li>所有人看的是同一本书（ConsumeQueue），但每个人的书签（Offset）可以不一样</li>
</ul>
<hr/>
<h4 data-id="heading-33">Q4: 如果 Consumer 崩溃了，消费进度会丢失吗？</h4>
<p><strong>A:</strong> 取决于消费模式：</p>
<ul>
<li><strong>集群模式：</strong> 不会丢失，因为进度存储在 Broker，Consumer 重启后可以恢复</li>
<li><strong>广播模式：</strong> 如果本地文件没有损坏，也不会丢失；但如果本地文件损坏或删除，则会从头开始消费</li>
</ul>
<hr/>
<h4 data-id="heading-34">Q5: 能否让广播模式的进度也存储在 Broker？</h4>
<p><strong>A:</strong> 理论上可以实现，但 RocketMQ 没有这样设计，原因：</p>
<ul>
<li>广播模式的消费者数量可能非常多（成百上千）</li>
<li>如果都存储在 Broker，会给 Broker 带来巨大的存储和管理压力</li>
<li>广播模式的典型场景（配置推送）对进度管理要求不高</li>
<li>本地存储更加轻量、高效</li>
</ul>
<hr/>
<h3 data-id="heading-35">📝 总结</h3>
<h4 data-id="heading-36">核心要点回顾</h4>
<ol>
<li>
<p><strong>ConsumeQueue 只是索引，不记录消费进度</strong></p>
<ul>
<li>ConsumeQueue 是只读的、共享的数据结构</li>
<li>它只负责快速定位消息在 CommitLog 中的位置</li>
</ul>
</li>
<li>
<p><strong>消费进度（Offset）是单独管理的</strong></p>
<ul>
<li>集群模式：存储在 Broker，由 ConsumerGroup 共享</li>
<li>广播模式：存储在各个 Consumer 本地文件</li>
</ul>
</li>
<li>
<p><strong>两种消费模式的本质区别</strong></p>
<ul>
<li>集群模式：负载均衡，消息只被消费一次</li>
<li>广播模式：全量消费，每个消费者都收到所有消息</li>
</ul>
</li>
<li>
<p><strong>进度管理策略的权衡</strong></p>
<ul>
<li>集群模式：集中管理，便于监控和恢复</li>
<li>广播模式：分散管理，轻量高效但难以统一查看</li>
</ul>
</li>
</ol>
<hr/>
<h4 data-id="heading-37">架构总览</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TB
    subgraph RocketMQ["RocketMQ 完整架构"]
        direction TB
        
        subgraph Storage["存储层"]
            CL[CommitLog&lt;br/&gt;消息存储]
            CQ[ConsumeQueue&lt;br/&gt;消息索引&lt;br/&gt;不记录进度]
            
            CL -.-&gt; CQ
        end
        
        subgraph Offset["进度管理层"]
            direction LR
            
            subgraph Cluster["集群模式"]
                BOff["Broker端&lt;br/&gt;集中存储"]
            end
            
            subgraph Broadcast["广播模式"]
                LOff["Consumer端&lt;br/&gt;本地存储"]
            end
        end
        
        subgraph Consumer["消费层"]
            CMode["消费模式选择"]
            
            CMode --&gt; ClusterC["集群消费&lt;br/&gt;负载均衡"]
            CMode --&gt; BroadC["广播消费&lt;br/&gt;全量消费"]
        end
        
        CQ --&gt; CMode
        ClusterC -.-&gt;|读写进度| BOff
        BroadC -.-&gt;|读写进度| LOff
    end
</code></pre>
<hr/>
<h4 data-id="heading-38">🎯 关键记忆点</h4>
<p><strong>ConsumeQueue 是"地图"，Offset 是"你的位置"。</strong></p>
<p>地图（ConsumeQueue）是公开的，所有人都可以看；但每个人的位置（Offset）是私有的，需要各自记录。在集群模式下，大家的位置记录在 Broker 的统一记录本上；在广播模式下，每个人都在自己的小本子上记录。</p>
<hr/>
<blockquote>
<p>希望这份文档能帮助您彻底理解 RocketMQ 的消费进度管理机制！</p>
<p>© 2025 - 深入浅出 RocketMQ</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[被问性能后，我封装了这个 PHP 错误上报工具]]></title>    <link>https://juejin.cn/post/7571102074038747177</link>    <guid>https://juejin.cn/post/7571102074038747177</guid>    <pubDate>2025-11-11T09:49:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571102074038747177" data-draft-id="7571102074038698025" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="被问性能后，我封装了这个 PHP 错误上报工具"/> <meta itemprop="keywords" content="PHP,Composer"/> <meta itemprop="datePublished" content="2025-11-11T09:49:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="苏琢玉"/> <meta itemprop="url" content="https://juejin.cn/user/3551890356308556"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            被问性能后，我封装了这个 PHP 错误上报工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3551890356308556/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    苏琢玉
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:49:56.000Z" title="Tue Nov 11 2025 09:49:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>最近我把自己常用的一套错误上报逻辑封装成了一个 Composer 包，叫 <strong>​<code>hejunjie/lazylog</code>​</strong>。<br/>
功能很简单也很实用：<strong>安全地写本地日志 + 把异常信息上报到远端（支持同步/异步）</strong> 。本文讲讲为什么我要做这个库、实现思路、在不同运行环境下如何选择（以及我推荐的优化方案）。</p>
<hr/>
<h2 data-id="heading-0">起因：为啥要做这个工具？</h2>
<p>先讲个背景。之前我写了一个 Go 项目 —— <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fzxc7563598%2Foh-shit-logger" target="_blank" title="https://github.com/zxc7563598/oh-shit-logger" ref="nofollow noopener noreferrer">oh-shit-logger</a>，目标是把不同语言、不同项目里的错误集中收集到一个地方。Go 做服务天然快、部署也简单： GitHub Actions自动打包，我只要把包丢主机上一键启动就好了。</p>
<p>但上线后有朋友问：</p>
<blockquote>
<p>“PHP 上报错误会不会太耗性能？网络 I/O 会不会成为瓶颈？”</p>
</blockquote>
<p>这是个很合理的问题。网络 I/O 的确有成本，但异常本身在多数系统里不是那种持续不断、高频率的事件（如果异常多到经常并发，那系统可能已经在出问题了）。</p>
<p>与其空谈“会不会慢”，我更愿意把常用做法封装一下，直接给出一个实战好用的方案——于是 <code>hejunjie/lazylog</code> 诞生了。</p>
<hr/>
<h2 data-id="heading-1">思路概览：伪异步 + 可回退的同步</h2>
<p>​<code>lazylog</code> 的核心思路很简单：</p>
<ul>
<li><strong>本地写日志</strong>：线程安全、支持按行数/大小自动切分，长期运行不会把单个日志文件撑爆。</li>
<li><strong>远程上报</strong>：提供两种方式：
<ul>
<li><strong>异步上报（伪异步）</strong> ：通过 <code>proc_open()</code> 或 <code>exec()</code> fork 出一个 PHP CLI 子进程来发送 HTTP POST，不阻塞主进程。适用于 PHP-FPM、一次性 CLI 脚本等短生命周期环境。</li>
<li><strong>同步上报</strong>：直接在当前进程做一个带超时的 HTTP POST，适合常驻内存框架（Webman、Swoole、RoadRunner 等）或需要保证上报结果的场景。</li>
</ul>
</li>
</ul>
<p>我把这些行为都封装在一个很小的包里：<code>composer require hejunjie/lazylog</code>，在任何项目里都能快速复用。</p>
<hr/>
<h2 data-id="heading-2">异步实现细节：为什么是“伪异步”？</h2>
<p>PHP 没有内置线程（除非用扩展），但我们可以通过子进程实现“非阻塞式”的上报：</p>
<ul>
<li>​<code>proc_open()</code>：启动子进程并可拿到 stdin/stdout/stderr，控制能力强；但会创建管道资源，需要注意关闭管道以免资源泄露。</li>
<li>​<code>exec()</code>：简单粗暴，把命令交给 shell 去做 <code>fork</code>，父进程可立即返回（命令后面加 <code>&amp;</code>）。语义上更轻量，但控制能力弱。</li>
</ul>
<p>两者的本质都是 fork 一个新进程去跑 PHP CLI，然后子进程读取临时文件（或者接收传参）、发 POST、删临时文件、退出。主进程不会等子进程走完就返回给用户，所以对用户体验几乎零影响。</p>
<p><strong>优点</strong>：实现简单、跨平台、即插即用；适合错误信息本身不高频的场景。<br/>
<strong>缺点</strong>：在“极高并发”场景下（比如每秒上千条错误）会比较吃资源，子进程启动和网络请求仍然有成本。</p>
<hr/>
<h2 data-id="heading-3">常驻内存框架（Webman/Swoole）该怎么办？</h2>
<p>这是个重要的实践问题：<strong>在常驻内存框架中，我更推荐用同步上报或队列，而不是频繁 fork 子进程。</strong></p>
<p>原因很直观：</p>
<ul>
<li>常驻框架的 Worker 是长期存在的，fork 子进程会带来额外的资源管理问题（僵尸进程、内存增长、文件描述符等）。</li>
<li>同步上报虽然会阻塞当前 Worker，但只影响当前 Worker，不会像在传统短生命周期中影响整个请求模型。对于大多数低频异常而言，这个阻塞代价是可以接受的。</li>
<li>更稳妥的做法是：<strong>把异常先格式化成数组，投递到队列，由专门的队列 worker 来异步上报</strong>。这样既避免了直接 fork，又能在不影响主流程的情况下批量/可靠地上报。</li>
</ul>
<p>我在包里同时提供了 <code>reportSync()</code>（同步上报）和 <code>reportAsync()</code>（伪异步上报），并提供 <code>Logger::formatThrowable()</code> 帮你把异常转成纯数据结构，方便推队列或序列化。</p>
<hr/>
<h2 data-id="heading-4">实际使用示例</h2>
<blockquote>
<p>这里只放伪代码以示意，实际代码见仓库。</p>
</blockquote>
<p><strong>本地写日志</strong></p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title class_">Logger</span>::<span class="hljs-title function_ invoke__">write</span>(<span class="hljs-string">'/var/logs'</span>, <span class="hljs-string">'error/app.log'</span>, <span class="hljs-string">'Task Failed'</span>, [<span class="hljs-string">'msg'</span> =&gt; <span class="hljs-string">'something wrong'</span>]);
</code></pre>
<p><strong>短生命周期场景（异步上报）</strong></p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">try</span> {
  <span class="hljs-comment">// ...</span>
} <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Throwable</span> <span class="hljs-variable">$e</span>) {
  <span class="hljs-title class_">Logger</span>::<span class="hljs-title function_ invoke__">reportAsync</span>(<span class="hljs-variable">$e</span>, <span class="hljs-string">'https://your-collector/collect'</span>, <span class="hljs-string">'my-project'</span>);
}
</code></pre>
<p><strong>常驻框架（推荐同步或队列）</strong></p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">try</span> {
  <span class="hljs-comment">// ...</span>
} <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Throwable</span> <span class="hljs-variable">$e</span>) {
  <span class="hljs-comment">// 同步上报（简单、直接）</span>
  <span class="hljs-title class_">Logger</span>::<span class="hljs-title function_ invoke__">reportSync</span>(<span class="hljs-variable">$e</span>, <span class="hljs-string">'https://your-collector/collect'</span>, <span class="hljs-string">'my-project'</span>);

  <span class="hljs-comment">// 或者：转成数组，投递队列，由 Worker 负责上报（推荐）</span>
  <span class="hljs-variable">$payload</span> = <span class="hljs-title class_">Logger</span>::<span class="hljs-title function_ invoke__">formatThrowable</span>(<span class="hljs-variable">$e</span>, <span class="hljs-string">'my-project'</span>);
  <span class="hljs-title class_">Queue</span>::<span class="hljs-title function_ invoke__">push</span>(<span class="hljs-string">'error_report'</span>, <span class="hljs-variable">$payload</span>);
}
</code></pre>
<hr/>
<h2 data-id="heading-5">性能那些事儿</h2>
<p>有人担心“网络 I/O 会把 PHP 卡死”。我的观点是：</p>
<ul>
<li><strong>错误本身通常是低频事件</strong>。如果你的系统错误频率高到持续占用大量带宽/请求，那说明系统正常运行已经有更严重的问题了。</li>
<li>对于多数业务，<strong>一次 fork 一个子进程并做一次 HTTP POST 的开销在可接受范围</strong>，用户体验影响极小。</li>
<li>在对性能要求极苛刻或错误量非常大的场景，正确做法是<strong>把上报变成队列 + 批量发送</strong>或将上报移动到专门的后端处理链路，而不是在业务路径里频繁 fork。</li>
</ul>
<p>总之：<strong>衡量利弊后选择适合你业务的方式</strong>。<code>lazylog</code> 提供了两端（sync/async）以及格式化功能，方便你按需设计。</p>
<hr/>
<h2 data-id="heading-6">最后</h2>
<p>我把它做成 composer 包的原因很直接：我希望 <strong>快速把 PHP 项目的错误上报到我自己的 Go 服务（oh-shit-logger）</strong> ，而不是每个项目都重复造轮子。把常用逻辑抽出来，项目里 <code>composer require hejunjie/lazylog</code> 就能统一上报方式——既省事又稳妥。</p>
<p>如果你想快速了解这个项目：<a href="https://link.juejin.cn?target=https%3A%2F%2Fzread.ai%2Fzxc7563598%2Fphp-lazylog" target="_blank" title="https://zread.ai/zxc7563598/php-lazylog" ref="nofollow noopener noreferrer">Zread 解析文档</a></p>
<ul>
<li>如果你是在 <strong>PHP-FPM / CLI</strong> 的短生命周期环境：<code>reportAsync()</code> 很方便，能保证主流程不被阻塞。</li>
<li>如果你是在 <strong>Webman/Swoole 等常驻内存框架</strong>：优先考虑 <code>reportSync()</code> 或推队列再上报。</li>
<li>如果你面临的是<strong>极高并发的错误量</strong>：把上报放队列，批量发送，或交由专门的采集基础设施处理。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Webpack系列-构建性能优化实战：从开发到生产]]></title>    <link>https://juejin.cn/post/7571088527678914586</link>    <guid>https://juejin.cn/post/7571088527678914586</guid>    <pubDate>2025-11-11T09:51:44.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571088527678914586" data-draft-id="7571028035018899482" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Webpack系列-构建性能优化实战：从开发到生产"/> <meta itemprop="keywords" content="前端,Webpack,性能优化"/> <meta itemprop="datePublished" content="2025-11-11T09:51:44.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="云枫晖"/> <meta itemprop="url" content="https://juejin.cn/user/835284567331021"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Webpack系列-构建性能优化实战：从开发到生产
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/835284567331021/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    云枫晖
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:51:44.000Z" title="Tue Nov 11 2025 09:51:44 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{position:relative;word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{font-size:24px;display:inline-block;font-weight:700;background:#ef7060;color:#fff;padding:6px 8px 0 0;border-top-right-radius:6px;margin-right:2px;box-shadow:6px 3px 0 0 rgba(239,112,96,.2)}.markdown-body h2:before{content:" ";display:inline-block;width:8px}.markdown-body h2:after{content:" ";position:absolute;display:block;width:calc(100% - 50px);border-bottom:3px solid #ef7060}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #3e3e3e;margin-top:32px;margin-bottom:32px;height:1px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(27,31,35,.05);color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:JetBranins Mono,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px;background-color:#fdfdfd}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#fdfdfd}.markdown-body a{text-decoration:none;font-weight:700;color:#ef7060;border-bottom:1px solid #ef7060}.markdown-body a:active,.markdown-body a:hover{color:#ef2d26}.markdown-body table tr td,.markdown-body table tr th{border:1px solid #ccc;padding:5px 10px}.markdown-body table{display:block!important;width:auto;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{background:#f0f0f0;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#f8f8f8}.markdown-body blockquote{margin-inline-start:0;margin-inline-end:0;border-left:3px solid #ef7060;background:#fff9f9;padding:1px 20px;margin-top:20px}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="atom-one-light">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-built_in,.hljs-class .hljs-title{color:#c18401}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}</style><p>构建速度慢，是每一位前端开发者在使用 webpack 时都可能遇到的“心头之痛”。每次保存都要等上好几秒，热更新也变成了“热等待”，这不仅影响开发体验，更在无情地吞噬我们的高效编码时间。本文将从开发和生产两个维度，深入剖析 webpack 构建性能优化的原理与实战，助你彻底告别构建等待！</p>
<h2 data-id="heading-0">为什么你的 webpack 构建这么慢？</h2>
<p>在开始优化之前，我们首先需要建立一个核心认知：<strong>优化不是一蹴而就的，它是一个持续分析和改进的过程。</strong>  不同的项目瓶颈各不相同，盲目套用配置可能收效甚微。
构建速度主要消耗在以下几个方面：</p>
<ul>
<li><strong>模块解析和转换</strong>：特别是 <code>node_modules</code> 中的庞大库文件和复杂的 JSX/Babel 转译。</li>
<li><strong>插件/加载器执行</strong>：某些插件或加载器的执行逻辑本身就很耗时。</li>
<li><strong>输出文件生成</strong>：文件数量多、体积大，会导致写磁盘操作变慢。</li>
</ul>
<p>接下来，我们将兵分两路，针对<strong>开发环境</strong>（追求更快的启动速度和热更新）和<strong>生产环境</strong>（追求更小的打包体积和更快的构建流水线）分别制定优化策略。</p>
<h2 data-id="heading-1">开发环境的优化</h2>
<p>开发环境的终极目标是：<strong>更快的启动速度（<code>build</code>）和更快的二次编译速度（<code>rebuild</code>）</strong></p>
<h3 data-id="heading-2">1. 设置mode为development</h3>
<p>在<code>Webpack</code>中<code>mode</code>分为<code>none</code>、<code>development</code>、<code>production</code></p>
<ul>
<li><code>none</code>： <code>Webpack</code>将不会采用任何优化手段</li>
<li><code>development</code>：<code>Webpack</code>按照开发环境特点进行默认优化</li>
<li><code>production</code>：<code>Webpack</code>按照生产环境特点进行默认优化</li>
</ul>
<p><code>mode</code>设置为<code>development</code>，默认情况下将<code>optimization</code>选项不会开启代码压缩、作用域提升等优化。将能极大
提升构建速度</p>
<h3 data-id="heading-3">2. 添加缓存缓存</h3>
<p>在<code>Webpack5</code>带来了强大的持久化缓存，开发环境下非常有效的优化手段。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-attr">cache</span>: {
    <span class="hljs-attr">type</span>: <span class="hljs-string">'filesystem'</span>, <span class="hljs-comment">// 使用文件系统缓存</span>
    <span class="hljs-attr">buildDependencies</span>: {
      <span class="hljs-attr">config</span>: [__filename], <span class="hljs-comment">// 当 webpack 配置文件发生变化时，缓存失效</span>
    },
    <span class="hljs-attr">cacheDirectory</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'node_modules/.cache/webpack'</span>), <span class="hljs-comment">// 缓存存放位置</span>
  },
};
</code></pre>
<blockquote>
<p>💡提示<br/>
对于Webpack4项目，可以采用<code>cache-loader</code>，但是性能上不如Webpack5的内置缓存</p>
</blockquote>
<h3 data-id="heading-4">3. 缩小模块范围</h3>
<p>通过<code>resolve</code>选项告知<code>Webpack</code>在解析模块时，减少不必要的查找，可以节省大量时间。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-comment">// 优先使用 ES6 模块化语法的文件</span>
    <span class="hljs-attr">mainFields</span>: [<span class="hljs-string">'browser'</span>, <span class="hljs-string">'module'</span>, <span class="hljs-string">'main'</span>],
    <span class="hljs-comment">// 准确配置扩展名，减少尝试</span>
    <span class="hljs-attr">extensions</span>: [<span class="hljs-string">'.js'</span>, <span class="hljs-string">'.jsx'</span>, <span class="hljs-string">'.ts'</span>, <span class="hljs-string">'.tsx'</span>, <span class="hljs-string">'.json'</span>],
    <span class="hljs-comment">// 使用别名，直接指向确切路径，避免递归查找</span>
    <span class="hljs-attr">alias</span>: {
      <span class="hljs-string">'@'</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'src'</span>),
      <span class="hljs-string">'react-dom'</span>: <span class="hljs-string">'@hot-loader/react-dom'</span>, <span class="hljs-comment">// 例如，使用热更新增强的 react-dom</span>
    },
    <span class="hljs-comment">// 限制在指定目录内查找，排除 node_modules 的层层递归（慎用，确保你的模块都在这里）</span>
    <span class="hljs-comment">// modules: [path.resolve(__dirname, 'src'), 'node_modules']</span>
  },
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.jsx?$/</span>,
        <span class="hljs-comment">// 使用 include 精确指定需要处理的目录，排除 node_modules</span>
        <span class="hljs-attr">include</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'src'</span>),
        <span class="hljs-attr">use</span>: <span class="hljs-string">'babel-loader'</span>
      }
    ]
  }
};
</code></pre>
<h3 data-id="heading-5">4. 使用更快的loader或轻量级插件</h3>
<h4 data-id="heading-6"><code>esbuild-loader</code>/<code>swc-loader</code>替代<code>babel-loader</code></h4>
<ul>
<li><code>esbuild-loader</code>/<code>swc-loader</code>替代<code>babel-loader</code>进行转译，因为它们由<code>Go</code>/<code>Rust</code>语言编写，速度极快。如果项目简单，建议采用<code>esbuild-loader</code>，如果项目需要更加接近<code>babel</code>并能更加完善的兼容的话，建议采用<code>swc-loader</code>。具体用法如下：</li>
</ul>
<h5 data-id="heading-7">在项目根目录下添加.swcrc文件</h5>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"jsc"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"parser"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"syntax"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ecmascript"</span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"jsx"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"dynamicImport"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"numericSeparator"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"classPrivateProperty"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"classPrivateMethod"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"classProperty"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"functionBind"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"exportDefaultFrom"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"exportNamespaceFrom"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"transform"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"react"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
        <span class="hljs-attr">"runtime"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"automatic"</span><span class="hljs-punctuation">,</span>
        <span class="hljs-attr">"refresh"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
      <span class="hljs-punctuation">}</span>
    <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"externalHelpers"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"keepClassNames"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"minify"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"compress"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span><span class="hljs-punctuation">,</span>
      <span class="hljs-attr">"mangle"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"env"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"mode"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"usage"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"coreJs"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"targets"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"browsers"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"&gt; 1%"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"last 2 versions"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"not ie &lt;= 8"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"type"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"es6"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"minify"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-8">项目根目录添加.browserslistrc文件</h5>
<pre><code class="hljs language-text" lang="text">[production]
&gt; 0.5%
last 2 versions
Firefox ESR
not dead
not ie 11

[development]
last 1 chrome version
last 1 firefox version
last 1 safari version
</code></pre>
<p>SWC会自动读取<code>.browserslistrc</code>，根据不同环境获取对应配置。</p>
<h4 data-id="heading-9">移除不必要的插件</h4>
<p>在开发环境中有些插件是没有必要的，例如<code>MiniCssExtractPlugin</code>改用<code>style-loader</code>。因为<code>MiniCssExtractPlugin</code>不支持HMR。</p>
<h3 data-id="heading-10">5. devServer优化</h3>
<p>devSever优化主要是减少控制台的输出内容</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">devServer</span>: {
    <span class="hljs-attr">stats</span>: <span class="hljs-string">'minimal'</span> <span class="hljs-comment">// 减少控制台输出，从而提高re-build性能</span>
  }
}
</code></pre>
<h2 data-id="heading-11">生产环境优化</h2>
<p>生产环境的核心目标是：<strong>减少最终打包体积，并提升构建流水线的速度</strong>。</p>
<h3 data-id="heading-12">1. 采用多进程/多实例并行构建</h3>
<p>将耗时的加载器操作并行化，充分利用多核 CPU。可以采用<code>thread-loader</code>实现，将它放入其他加载器之前，其后的加载器会放入到worker池中运行。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.jsx?$/</span>,
        <span class="hljs-attr">include</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'src'</span>),
        <span class="hljs-attr">use</span>: [
          {
            <span class="hljs-attr">loader</span>: <span class="hljs-string">'thread-loader'</span>,
            <span class="hljs-attr">options</span>: {
              <span class="hljs-attr">workers</span>: <span class="hljs-built_in">require</span>(<span class="hljs-string">'os'</span>).<span class="hljs-title function_">cpus</span>().<span class="hljs-property">length</span> - <span class="hljs-number">1</span>, <span class="hljs-comment">// CPU 核心数 -1</span>
              <span class="hljs-attr">poolTimeout</span>: <span class="hljs-title class_">Infinity</span>, <span class="hljs-comment">// 防止进程退出</span>
            },
          },
          <span class="hljs-string">'babel-loader'</span>,
        ],
      },
    ],
  },
};
</code></pre>
<blockquote>
<p>📢 注意 <br/>
进程启动和通信有一定开销，在非常小的项目中可能达不到提高构建提速效果，反而会变慢</p>
</blockquote>
<h3 data-id="heading-13">2. 分包优化</h3>
<p>合理的分包可以充分利用浏览器缓存，虽然可能略微增加构建时间，但对长期缓存收益巨大。主要从几个方面考虑：</p>
<ul>
<li><strong>第三方库分离</strong>：将<code>node_modules</code>依赖进行提取，利用缓存，减少重复打包</li>
<li><strong>公共模块提取</strong> 提取重复引用多次的模块，减少代码体积</li>
<li><strong>动态导入语懒加载</strong> 使用<code>import()</code>动态导入/路由懒加载，按需加载，加速首屏</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// JS引入模块</span>
<span class="hljs-keyword">import</span>(<span class="hljs-comment">/* webpackChunkName: "my-chunk-name" */</span> <span class="hljs-string">'./module'</span>);
<span class="hljs-comment">// React 路由懒加载</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">React</span>, { <span class="hljs-title class_">Suspense</span>, lazy } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">MyComponent</span> = <span class="hljs-title function_">lazy</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./MyComponent'</span>));
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">Suspense</span> <span class="hljs-attr">fallback</span>=<span class="hljs-string">{</span>&lt;<span class="hljs-attr">div</span>&gt;</span>Loading...<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>}&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">MyComponent</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Suspense</span>&gt;</span></span>
  );
}
<span class="hljs-comment">// Vue路由懒加载</span>
<span class="hljs-keyword">const</span> routes = [
  {
    <span class="hljs-attr">path</span>: <span class="hljs-string">'/home'</span>,
    <span class="hljs-attr">component</span>: <span class="hljs-function">() =&gt;</span> <span class="hljs-keyword">import</span>(<span class="hljs-string">'./views/Home.vue'</span>) <span class="hljs-comment">// 访问/home时才会加载</span>
  }
];
</code></pre>
<ul>
<li><strong>运行时代码分离</strong> 避免频繁变更代码影响到库缓存</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-attr">optimization</span>: {
  <span class="hljs-comment">// 提取运行时代码</span>
  <span class="hljs-attr">runtimeChunk</span>: {
    <span class="hljs-attr">name</span>: <span class="hljs-string">"manifest"</span>,
  },
  <span class="hljs-attr">splitChunks</span>: {
    <span class="hljs-attr">chunks</span>: <span class="hljs-string">"all"</span>,
    <span class="hljs-attr">minSize</span>: <span class="hljs-number">20000</span>,
    <span class="hljs-attr">minChunks</span>: <span class="hljs-number">1</span>,
    <span class="hljs-attr">cacheGroups</span>: {
      <span class="hljs-attr">vendor</span>: {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/[\\/]node_modules[\\/]/</span>,
        <span class="hljs-attr">name</span>: <span class="hljs-string">"vendors"</span>,
        <span class="hljs-attr">chunks</span>: <span class="hljs-string">"all"</span>,
        <span class="hljs-attr">priority</span>: <span class="hljs-number">20</span>, <span class="hljs-comment">// 优先级高</span>
      },
      <span class="hljs-attr">common</span>: {
        <span class="hljs-attr">name</span>: <span class="hljs-string">"common"</span>,
        <span class="hljs-attr">minChunks</span>: <span class="hljs-number">2</span>, <span class="hljs-comment">// 被两个及以上chunk引用才提取</span>
        <span class="hljs-attr">chunks</span>: <span class="hljs-string">"all"</span>,
        <span class="hljs-attr">priority</span>: <span class="hljs-number">10</span>,
        <span class="hljs-attr">reuseExistingChunk</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 避免模块重复打包</span>
      },
    },
  },
},
</code></pre>
<h3 data-id="heading-14">3. 采用各种工具进行压缩</h3>
<h4 data-id="heading-15">Terser多进程并行压缩</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title class_">TerserPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'terser-webpack-plugin'</span>);
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">optimization</span>: {
    <span class="hljs-attr">minimize</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">minimizer</span>: [
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">TerserPlugin</span>({
        <span class="hljs-attr">parallel</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 开启多进程并行</span>
        <span class="hljs-comment">// terserOptions: { ... }</span>
      }),
    ],
  },
};
</code></pre>
<h4 data-id="heading-16">css-minimizer-webpack-plugin插件对CSS进行压缩</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title class_">MiniCssExtractPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mini-css-extract-plugin'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">CssMinimizerPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'css-minimizer-webpack-plugin'</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">mode</span>: <span class="hljs-string">'production'</span>,
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.css$/</span>,
        <span class="hljs-comment">// 使用 MiniCssExtractPlugin.loader 替换 style-loader</span>
        <span class="hljs-attr">use</span>: [<span class="hljs-title class_">MiniCssExtractPlugin</span>.<span class="hljs-property">loader</span>, <span class="hljs-string">'css-loader'</span>],
      },
    ],
  },
  <span class="hljs-attr">optimization</span>: {
    <span class="hljs-attr">minimizer</span>: [
      <span class="hljs-string">'...'</span>, <span class="hljs-comment">// 这表示继承 Webpack 默认的 JS 压缩器（如Terser）</span>
      <span class="hljs-keyword">new</span> <span class="hljs-title class_">CssMinimizerPlugin</span>(),
    ],
  },
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">MiniCssExtractPlugin</span>({
      <span class="hljs-attr">filename</span>: <span class="hljs-string">'[name].[contenthash].css'</span>,
    }),
  ],
};
</code></pre>
<p>如果是大型项目的话，可以开启多进程并行进行压缩从而提高构建速度。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">new</span> <span class="hljs-title class_">CssMinimizerPlugin</span>({
  <span class="hljs-attr">parallel</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 启用并行压缩</span>
  <span class="hljs-comment">// parallel: 4, // 也可以指定具体的进程数量</span>
})
</code></pre>
<h4 data-id="heading-17">image-minimizer-webpack-plugin</h4>
<ul>
<li>安装依赖</li>
</ul>
<pre><code class="hljs language-bash" lang="bash">npm i -D image-minimizer-webpack-plugin sharp imagemin-sharp
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">new</span> <span class="hljs-title class_">ImageMinimizerPlugin</span>({
  <span class="hljs-attr">minimizer</span>: {
    <span class="hljs-attr">implementation</span>: <span class="hljs-title class_">ImageMinimizerPlugin</span>.<span class="hljs-property">sharpMinify</span>,
    <span class="hljs-attr">options</span>: {
      <span class="hljs-attr">encodeOptions</span>: {
        <span class="hljs-attr">mozjpeg</span>: {
          <span class="hljs-attr">quality</span>: <span class="hljs-number">80</span>,
        },
        <span class="hljs-attr">pngquant</span>: {
          <span class="hljs-attr">quality</span>: [<span class="hljs-number">0.8</span>, <span class="hljs-number">0.9</span>],
        },
        <span class="hljs-attr">webp</span>: {
          <span class="hljs-attr">quality</span>: <span class="hljs-number">80</span>,
        },
      },
    },
  },
}),
</code></pre>
<h3 data-id="heading-18">4. 精确匹配<code>externals</code></h3>
<p>对于一些通过 CDN 引入的巨型库（如 <code>echarts</code>, <code>three.js</code>），可以配置 <code>externals</code> 将其排除在打包范围之外。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// webpack.config.js</span>
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">externals</span>: {
    <span class="hljs-attr">echarts</span>: <span class="hljs-string">'echarts'</span>,
  },
};
<span class="hljs-comment">// 然后在 index.html 中通过 &lt;script&gt; 标签引入 CDN 链接</span>
</code></pre>
<h3 data-id="heading-19">5. Tree Shaking</h3>
<p>Tree Shaking 就是 Webpack 在打包时帮你<strong>自动删除那些未被使用的代码（也称为 "dead-code"）</strong> ，这能有效减小最终打包文件的体积</p>
<h4 data-id="heading-20">合理配置sideEffects</h4>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// package.json 示例</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"name"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"your-project"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"sideEffects"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
  <span class="hljs-comment">// 或者，如果你有需要保留副作用的文件</span>
  <span class="hljs-comment">// "sideEffects": [</span>
  <span class="hljs-comment">//   "*.css",</span>
  <span class="hljs-comment">//   "src/polyfill.js"</span>
  <span class="hljs-comment">// ]</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-21">良好的编码习惯</h4>
<ul>
<li><strong>坚持使用ES6模块</strong> 因为<code>CommonJS</code>的<code>require()</code>具有动态性，<code>Webpack</code>难以进行静态分析。</li>
<li><strong>避免导入整个库</strong> 尽量使用具名导入引入需要使用的部分</li>
</ul>
<h2 data-id="heading-22">构建分析工具</h2>
<h3 data-id="heading-23">Webpack Bundle Analyzer</h3>
<p>它以可视化的树状图形式分析打包后文件的构成，帮助你发现体积过大的模块。</p>
<pre><code class="hljs language-bash" lang="bash">npm install --save-dev webpack-bundle-analyzer
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title class_">BundleAnalyzerPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpack-bundle-analyzer'</span>).<span class="hljs-property">BundleAnalyzerPlugin</span>;

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">BundleAnalyzerPlugin</span>({
      <span class="hljs-attr">analyzerMode</span>: <span class="hljs-string">'server'</span>, <span class="hljs-comment">// 启动一个本地服务器查看报告</span>
      <span class="hljs-attr">openAnalyzer</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 完成后自动打开浏览器</span>
    })
  ]
};
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3f1941f7f624f9a9be8dfc9acbce168~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LqR5p6r5pmW:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763459503&amp;x-signature=jscsBeuE02bucOCNTHGwIJbNt%2BI%3D" alt="image-20251110104912944.png" loading="lazy"/></p>
<p>通过该工具分析可以识别：</p>
<ul>
<li>较大依赖从而进行分包</li>
<li>检查重复代码</li>
<li>进行更加有效的代码分割</li>
</ul>
<h3 data-id="heading-24">Speed-measure-webpack-plugin</h3>
<p>主要测量各 loader 和 plugin 的执行时间，webpack5中<code>Speed-measure-webpack-plugin</code>与<code>mini-css-extract-plugin</code>之间存在兼容性问题</p>
<pre><code class="hljs language-bash" lang="bash">npm i -D speed-measure-webpack-plugin
</code></pre>
<p>具体配置</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">"path"</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">HtmlWebpackPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">"html-webpack-plugin"</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">MiniCssExtractPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">"mini-css-extract-plugin"</span>);
<span class="hljs-keyword">const</span> isProd = process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> === <span class="hljs-string">"production"</span>;
<span class="hljs-keyword">const</span> <span class="hljs-title class_">SpeedMeasurePlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">"speed-measure-webpack-plugin"</span>);
<span class="hljs-keyword">const</span> smp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SpeedMeasurePlugin</span>({
  <span class="hljs-attr">outputFormat</span>: <span class="hljs-string">"humanVerbose"</span>,
  <span class="hljs-comment">// 排除影响的插件</span>
  <span class="hljs-attr">exclude</span>: [<span class="hljs-string">"/html-webpack-plugin/"</span>, <span class="hljs-string">"/mini-css-extract-plugin/"</span>],
});
<span class="hljs-keyword">const</span> webpackConfig = {
  <span class="hljs-attr">mode</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NODE_ENV</span> || <span class="hljs-string">"development"</span>,
  <span class="hljs-attr">entry</span>: <span class="hljs-string">"./src/index.js"</span>,
  <span class="hljs-attr">devtool</span>: isProd ? <span class="hljs-string">"source-map"</span> : <span class="hljs-string">"eval-cheap-module-source-map"</span>,
  <span class="hljs-attr">output</span>: {
    <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">"dist"</span>),
    <span class="hljs-attr">filename</span>: <span class="hljs-string">"js/[name].[contenthash:8].bundle.js"</span>,
    <span class="hljs-attr">chunkFilename</span>: <span class="hljs-string">"js/[name].[contenthash:8].chunk.js"</span>,
    <span class="hljs-attr">clean</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">publicPath</span>: isProd ? <span class="hljs-string">"./"</span> : <span class="hljs-string">"/"</span>,
  },
  <span class="hljs-attr">resolve</span>: {
    <span class="hljs-attr">extensions</span>: [<span class="hljs-string">".jsx"</span>, <span class="hljs-string">".js"</span>, <span class="hljs-string">".json"</span>],
    <span class="hljs-attr">alias</span>: {
      <span class="hljs-string">"@"</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">"src"</span>),
    },
  },
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.css$/</span>,
        <span class="hljs-attr">use</span>: [
          isProd
            ? {
                <span class="hljs-attr">loader</span>: <span class="hljs-title class_">MiniCssExtractPlugin</span>.<span class="hljs-property">loader</span>,
                <span class="hljs-attr">options</span>: {
                  <span class="hljs-attr">publicPath</span>: <span class="hljs-string">"../"</span>,
                },
              }
            : <span class="hljs-string">"style-loader"</span>,
          <span class="hljs-string">"css-loader"</span>,
        ],
      },
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(js|jsx)$/</span>,
        <span class="hljs-attr">exclude</span>: <span class="hljs-regexp">/node_modules/</span>,
        <span class="hljs-attr">use</span>: <span class="hljs-string">"babel-loader"</span>,
      },
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/\.(png|jpe?g|gif|svg)$/i</span>,
        <span class="hljs-attr">type</span>: <span class="hljs-string">"asset"</span>,
        <span class="hljs-attr">parser</span>: {
          <span class="hljs-attr">dataUrlCondition</span>: {
            <span class="hljs-attr">maxSize</span>: <span class="hljs-number">8</span> * <span class="hljs-number">1024</span>,
          },
        },
        <span class="hljs-attr">generator</span>: {
          <span class="hljs-attr">filename</span>: <span class="hljs-string">"images/[name].[hash:8][ext]"</span>,
        },
      },
    ],
  },
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">HtmlWebpackPlugin</span>({
      <span class="hljs-attr">template</span>: <span class="hljs-string">"./public/index.html"</span>,
      <span class="hljs-attr">filename</span>: <span class="hljs-string">"index.html"</span>,
    }),
    ,
  ],
};
<span class="hljs-keyword">const</span> config = smp.<span class="hljs-title function_">wrap</span>(webpackConfig);
<span class="hljs-comment">// 在包裹之后添加MiniCssExtractPlugin插件</span>
config.<span class="hljs-property">plugins</span>.<span class="hljs-title function_">push</span>(
  <span class="hljs-keyword">new</span> <span class="hljs-title class_">MiniCssExtractPlugin</span>({
    <span class="hljs-attr">filename</span>: <span class="hljs-string">"css/[name].[contenthash:8].css"</span>,
    <span class="hljs-attr">chunkFilename</span>: <span class="hljs-string">"css/[name].[contenthash:8].chunk.css"</span>,
  })
);
<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = config;
</code></pre>
<p>构建后会在<code>控制台</code>中输出信息:</p>
<pre><code class="hljs language-text" lang="text">SMP  ⏱  
General output time took 2,375 ms

 SMP  ⏱  Plugins
HtmlWebpackPlugin took 80 ms

 SMP  ⏱  Loaders
babel-loader took 409 ms
  median       = 392 ms
  mean         = 205 ms
  s.d.         = 265.166 ms
  range        = (17 ms --&gt; 392 ms)
  module count = 2
modules with no loaders took 253 ms
  median       = 4 ms
  mean         = 6 ms
  s.d.         = 14.107 ms
  range        = (0 ms --&gt; 145 ms)
  module count = 218
mini-css-extract-plugin, and 
css-loader took 167 ms
  median       = 164 ms
  mean         = 164 ms
  s.d.         = 0 ms
  range        = (164 ms --&gt; 164 ms)
  module count = 2
css-loader took 54 ms
  median       = 54 ms
  mean         = 35 ms
  s.d.         = 26.87 ms
  range        = (16 ms --&gt; 54 ms)
  module count = 2
html-webpack-plugin took 18 ms
  median       = 18 ms
  mean         = 18 ms
  range        = (18 ms --&gt; 18 ms)
  module count = 1
</code></pre>
<p>通过该工具可以知道哪些<code>loader</code>和<code>plugin</code>执行时间过长，从而对它们进行更加有效的配置或者替换。</p>
<h2 data-id="heading-25">小结</h2>
<p>Webpack 构建优化是一个系统性的工程，没有“银弹”配置可以放之四海而皆准。通过本文的探讨，我们可以将优化思路提炼为以下核心纲领：</p>
<ol>
<li><strong>明确目标，区别对待</strong>：始终明确开发环境追求<strong>速度</strong>，生产环境兼顾<strong>速度与体积</strong>。为此采取不同的配置策略是优化的基石。</li>
<li><strong>诊断先行，对症下药</strong>：善用 <code>webpack-bundle-analyzer</code> 和 <code>speed-measure-webpack-plugin</code> 等分析工具，精准定位瓶颈，避免盲目优化。</li>
<li><strong>拥抱缓存，减少重复</strong>：无论是 Webpack 5 的持久化缓存，还是 loader 自身的缓存，都是提升二次构建速度最有效的手段之一。</li>
<li><strong>缩小范围，精准打击</strong>：通过 <code>include</code>、<code>exclude</code>、<code>resolve</code> 配置等手段，让 Webpack 只处理它该处理的模块，避免无谓的搜索和转译。</li>
<li><strong>善用利器，并行不悖</strong>：利用 <code>thread-loader</code>、<code>esbuild</code>、<code>swc</code> 等现代工具进行并行构建和高性能转译，充分利用多核 CPU 性能。</li>
<li><strong>拆分有度，缓存为王</strong>：合理的代码分割（SplitChunks、动态导入）不仅能减小首包体积，更能利用浏览器缓存，带来长久的性能收益。</li>
</ol>
<p>优化之路永无止境。最好的优化策略是结合你项目的具体规模、技术栈和团队习惯，建立持续的监控和分析机制，在迭代中不断调整和验证。希望本文能为你提供清晰的思路和实用的方法，让你和团队的开发体验“快上加快”，彻底告别构建等待的烦恼！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[SwiftUI 导航]]></title>    <link>https://juejin.cn/post/7571258854900858923</link>    <guid>https://juejin.cn/post/7571258854900858923</guid>    <pubDate>2025-11-11T09:49:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571258854900858923" data-draft-id="7571077686108471359" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="SwiftUI 导航"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-11T09:49:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="littleplayer"/> <meta itemprop="url" content="https://juejin.cn/user/1926000099198813"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            SwiftUI 导航
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1926000099198813/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    littleplayer
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:49:38.000Z" title="Tue Nov 11 2025 09:49:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>SwiftUI 提供了多种导航方式，让我为你详细介绍主要的导航模式和相关组件。</p>
<h2 data-id="heading-0">1. NavigationStack (iOS 16+)</h2>
<h3 data-id="heading-1">基本用法</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ContentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">NavigationStack</span> {
            <span class="hljs-type">List</span> {
                <span class="hljs-type">NavigationLink</span>(<span class="hljs-string">"前往详情页"</span>, value: <span class="hljs-string">"详情内容"</span>)
                <span class="hljs-type">NavigationLink</span>(<span class="hljs-string">"设置"</span>, value: <span class="hljs-string">"设置页面"</span>)
            }
            .navigationDestination(for: <span class="hljs-type">String</span>.<span class="hljs-keyword">self</span>) { value <span class="hljs-keyword">in</span>
                <span class="hljs-type">DetailView</span>(content: value)
            }
        }
    }
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">DetailView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-keyword">let</span> content: <span class="hljs-type">String</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">Text</span>(<span class="hljs-string">"详情: <span class="hljs-subst">\(content)</span>"</span>)
            .navigationTitle(<span class="hljs-string">"详情页"</span>)
    }
}
</code></pre>
<h3 data-id="heading-2">多类型导航</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">Route</span>: <span class="hljs-title class_">Hashable</span> {
    <span class="hljs-keyword">case</span> product(<span class="hljs-type">Int</span>)
    <span class="hljs-keyword">case</span> category(<span class="hljs-type">String</span>)
    <span class="hljs-keyword">case</span> settings
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">ContentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">NavigationStack</span> {
            <span class="hljs-type">VStack</span> {
                <span class="hljs-type">NavigationLink</span>(<span class="hljs-string">"产品123"</span>, value: <span class="hljs-type">Route</span>.product(<span class="hljs-number">123</span>))
                <span class="hljs-type">NavigationLink</span>(<span class="hljs-string">"电子产品"</span>, value: <span class="hljs-type">Route</span>.category(<span class="hljs-string">"electronics"</span>))
                <span class="hljs-type">NavigationLink</span>(<span class="hljs-string">"设置"</span>, value: <span class="hljs-type">Route</span>.settings)
            }
            .navigationDestination(for: <span class="hljs-type">Route</span>.<span class="hljs-keyword">self</span>) { route <span class="hljs-keyword">in</span>
                <span class="hljs-keyword">switch</span> route {
                <span class="hljs-keyword">case</span> .product(<span class="hljs-keyword">let</span> id):
                    <span class="hljs-type">ProductView</span>(productId: id)
                <span class="hljs-keyword">case</span> .category(<span class="hljs-keyword">let</span> name):
                    <span class="hljs-type">CategoryView</span>(category: name)
                <span class="hljs-keyword">case</span> .settings:
                    <span class="hljs-type">SettingsView</span>()
                }
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-3">2. NavigationView (iOS 13-16)</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ContentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">NavigationView</span> {
            <span class="hljs-type">List</span> {
                <span class="hljs-type">NavigationLink</span>(destination: <span class="hljs-type">DetailView</span>()) {
                    <span class="hljs-type">Label</span>(<span class="hljs-string">"详情页面"</span>, systemImage: <span class="hljs-string">"star"</span>)
                }
                <span class="hljs-type">NavigationLink</span>(destination: <span class="hljs-type">SettingsView</span>()) {
                    <span class="hljs-type">Label</span>(<span class="hljs-string">"设置"</span>, systemImage: <span class="hljs-string">"gear"</span>)
                }
            }
            .navigationTitle(<span class="hljs-string">"主页面"</span>)
        }
    }
}
</code></pre>
<h2 data-id="heading-4">3. 编程式导航</h2>
<h3 data-id="heading-5">使用 NavigationPath</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ContentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> navigationPath <span class="hljs-operator">=</span> <span class="hljs-type">NavigationPath</span>()
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">NavigationStack</span>(path: <span class="hljs-variable">$navigationPath</span>) {
            <span class="hljs-type">VStack</span>(spacing: <span class="hljs-number">20</span>) {
                <span class="hljs-type">Button</span>(<span class="hljs-string">"跳转到产品页"</span>) {
                    navigationPath.append(<span class="hljs-type">Route</span>.product(<span class="hljs-number">456</span>))
                }
                
                <span class="hljs-type">Button</span>(<span class="hljs-string">"跳转到分类页"</span>) {
                    navigationPath.append(<span class="hljs-type">Route</span>.category(<span class="hljs-string">"books"</span>))
                }
                
                <span class="hljs-type">Button</span>(<span class="hljs-string">"多层级跳转"</span>) {
                    navigationPath.append(<span class="hljs-type">Route</span>.category(<span class="hljs-string">"electronics"</span>))
                    navigationPath.append(<span class="hljs-type">Route</span>.product(<span class="hljs-number">789</span>))
                }
                
                <span class="hljs-type">Button</span>(<span class="hljs-string">"返回根页面"</span>) {
                    navigationPath.removeLast(navigationPath.count)
                }
                
                <span class="hljs-type">Button</span>(<span class="hljs-string">"上一步"</span>) {
                    <span class="hljs-keyword">guard</span> <span class="hljs-operator">!</span>navigationPath.isEmpty <span class="hljs-keyword">else</span> { <span class="hljs-keyword">return</span> }
                    navigationPath.removeLast()
                }
            }
            .navigationDestination(for: <span class="hljs-type">Route</span>.<span class="hljs-keyword">self</span>) { route <span class="hljs-keyword">in</span>
                <span class="hljs-comment">// 路由处理...</span>
            }
        }
    }
}
</code></pre>
<h2 data-id="heading-6">4. Sheet 和 FullScreenCover</h2>
<h3 data-id="heading-7">模态展示</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">ContentView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> showingSheet <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> showingFullScreen <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">VStack</span>(spacing: <span class="hljs-number">20</span>) {
            <span class="hljs-type">Button</span>(<span class="hljs-string">"显示 Sheet"</span>) {
                showingSheet <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
            }
            
            <span class="hljs-type">Button</span>(<span class="hljs-string">"全屏显示"</span>) {
                showingFullScreen <span class="hljs-operator">=</span> <span class="hljs-literal">true</span>
            }
        }
        .sheet(isPresented: <span class="hljs-variable">$showingSheet</span>) {
            <span class="hljs-type">SheetView</span>()
        }
        .fullScreenCover(isPresented: <span class="hljs-variable">$showingFullScreen</span>) {
            <span class="hljs-type">FullScreenView</span>()
        }
    }
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">SheetView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@Environment</span>(\.dismiss) <span class="hljs-keyword">var</span> dismiss
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">NavigationView</span> {
            <span class="hljs-type">Text</span>(<span class="hljs-string">"这是 Sheet 视图"</span>)
                .toolbar {
                    <span class="hljs-type">ToolbarItem</span>(placement: .navigationBarTrailing) {
                        <span class="hljs-type">Button</span>(<span class="hljs-string">"完成"</span>) {
                            dismiss()
                        }
                    }
                }
        }
    }
}
</code></pre>
<h2 data-id="heading-8">5. TabView 标签导航</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MainTabView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">TabView</span> {
            <span class="hljs-type">HomeView</span>()
                .tabItem {
                    <span class="hljs-type">Label</span>(<span class="hljs-string">"首页"</span>, systemImage: <span class="hljs-string">"house"</span>)
                }
            
            <span class="hljs-type">SearchView</span>()
                .tabItem {
                    <span class="hljs-type">Label</span>(<span class="hljs-string">"搜索"</span>, systemImage: <span class="hljs-string">"magnifyingglass"</span>)
                }
            
            <span class="hljs-type">ProfileView</span>()
                .tabItem {
                    <span class="hljs-type">Label</span>(<span class="hljs-string">"我的"</span>, systemImage: <span class="hljs-string">"person"</span>)
                }
        }
    }
}
</code></pre>
<h2 data-id="heading-9">6. 复杂导航示例</h2>
<h3 data-id="heading-10">带导航栏的完整示例</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">MainView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@State</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> navigationPath <span class="hljs-operator">=</span> <span class="hljs-type">NavigationPath</span>()
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">NavigationStack</span>(path: <span class="hljs-variable">$navigationPath</span>) {
            <span class="hljs-type">ProductListView</span>()
                .navigationTitle(<span class="hljs-string">"产品列表"</span>)
                .toolbar {
                    <span class="hljs-type">ToolbarItem</span>(placement: .navigationBarTrailing) {
                        <span class="hljs-type">Button</span>(<span class="hljs-string">"设置"</span>) {
                            navigationPath.append(<span class="hljs-type">AppRoute</span>.settings)
                        }
                    }
                }
                .navigationDestination(for: <span class="hljs-type">AppRoute</span>.<span class="hljs-keyword">self</span>) { route <span class="hljs-keyword">in</span>
                    route.destination
                }
        }
    }
}

<span class="hljs-keyword">enum</span> <span class="hljs-title class_">AppRoute</span>: <span class="hljs-title class_">Hashable</span> {
    <span class="hljs-keyword">case</span> productDetail(<span class="hljs-type">Product</span>)
    <span class="hljs-keyword">case</span> category(<span class="hljs-type">String</span>)
    <span class="hljs-keyword">case</span> settings
    <span class="hljs-keyword">case</span> profile
    
    <span class="hljs-meta">@ViewBuilder</span>
    <span class="hljs-keyword">var</span> destination: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-keyword">switch</span> <span class="hljs-keyword">self</span> {
        <span class="hljs-keyword">case</span> .productDetail(<span class="hljs-keyword">let</span> product):
            <span class="hljs-type">ProductDetailView</span>(product: product)
        <span class="hljs-keyword">case</span> .category(<span class="hljs-keyword">let</span> category):
            <span class="hljs-type">CategoryView</span>(category: category)
        <span class="hljs-keyword">case</span> .settings:
            <span class="hljs-type">SettingsView</span>()
        <span class="hljs-keyword">case</span> .profile:
            <span class="hljs-type">ProfileView</span>()
        }
    }
}
</code></pre>
<h3 data-id="heading-11">自定义导航栏</h3>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">struct</span> <span class="hljs-title class_">CustomNavigationView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@Environment</span>(\.dismiss) <span class="hljs-keyword">var</span> dismiss
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">NavigationView</span> {
            <span class="hljs-type">Text</span>(<span class="hljs-string">"自定义导航栏"</span>)
                .navigationTitle(<span class="hljs-string">"标题"</span>)
                .navigationBarTitleDisplayMode(.inline)
                .toolbar {
                    <span class="hljs-comment">// 左侧按钮</span>
                    <span class="hljs-type">ToolbarItem</span>(placement: .navigationBarLeading) {
                        <span class="hljs-type">Button</span>(<span class="hljs-string">"取消"</span>) {
                            dismiss()
                        }
                    }
                    
                    <span class="hljs-comment">// 右侧按钮</span>
                    <span class="hljs-type">ToolbarItem</span>(placement: .navigationBarTrailing) {
                        <span class="hljs-type">Button</span>(<span class="hljs-string">"保存"</span>) {
                            <span class="hljs-comment">// 保存操作</span>
                        }
                        .bold()
                    }
                }
        }
    }
}
</code></pre>
<h2 data-id="heading-12">7. 导航状态管理</h2>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">class</span> <span class="hljs-title class_">NavigationManager</span>: <span class="hljs-title class_">ObservableObject</span> {
    <span class="hljs-meta">@Published</span> <span class="hljs-keyword">var</span> path <span class="hljs-operator">=</span> <span class="hljs-type">NavigationPath</span>()
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">navigateToProduct</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">id</span>: <span class="hljs-type">Int</span>) {
        path.append(<span class="hljs-type">Route</span>.product(id))
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">navigateToCategory</span>(<span class="hljs-keyword">_</span> <span class="hljs-params">name</span>: <span class="hljs-type">String</span>) {
        path.append(<span class="hljs-type">Route</span>.category(name))
    }
    
    <span class="hljs-keyword">func</span> <span class="hljs-title function_">popToRoot</span>() {
        path.removeLast(path.count)
    }
}

<span class="hljs-keyword">struct</span> <span class="hljs-title class_">AppView</span>: <span class="hljs-title class_">View</span> {
    <span class="hljs-meta">@StateObject</span> <span class="hljs-keyword">private</span> <span class="hljs-keyword">var</span> navManager <span class="hljs-operator">=</span> <span class="hljs-type">NavigationManager</span>()
    
    <span class="hljs-keyword">var</span> body: <span class="hljs-keyword">some</span> <span class="hljs-type">View</span> {
        <span class="hljs-type">NavigationStack</span>(path: <span class="hljs-variable">$navManager</span>.path) {
            <span class="hljs-type">ContentView</span>()
                .navigationDestination(for: <span class="hljs-type">Route</span>.<span class="hljs-keyword">self</span>) { route <span class="hljs-keyword">in</span>
                    <span class="hljs-comment">// 路由处理</span>
                }
        }
        .environmentObject(navManager)
    }
}
</code></pre>
<h2 data-id="heading-13">主要特点总结</h2>
<ol>
<li><strong>NavigationStack</strong>: iOS 16+ 推荐使用，支持类型安全的路由</li>
<li><strong>编程式导航</strong>: 通过状态管理控制导航流程</li>
<li><strong>模态展示</strong>: Sheet 和 FullScreenCover 用于临时内容</li>
<li><strong>标签导航</strong>: TabView 用于主要功能模块切换</li>
<li><strong>灵活的路由系统</strong>: 支持复杂导航逻辑和深度链接</li>
</ol>
<p>这些导航方式可以组合使用，创建出符合你应用需求的完整导航体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[简单聊下enum（枚举）]]></title>    <link>https://juejin.cn/post/7571279513247055898</link>    <guid>https://juejin.cn/post/7571279513247055898</guid>    <pubDate>2025-11-11T10:01:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571279513247055898" data-draft-id="7571279513246990362" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="简单聊下enum（枚举）"/> <meta itemprop="keywords" content="TypeScript"/> <meta itemprop="datePublished" content="2025-11-11T10:01:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="来碗盐焗星球"/> <meta itemprop="url" content="https://juejin.cn/user/3316551988553709"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            简单聊下enum（枚举）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3316551988553709/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    来碗盐焗星球
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T10:01:24.000Z" title="Tue Nov 11 2025 10:01:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    1
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>当你需要定义一些固定值的集合的场景时，你通常都是如何考虑的?例如对于一个订单状态集合，未支付、支付成功、支付失败、已取消、已发货、已签收、已退款，对应的数字分别是:1、2、3、4、5、6、7。</p>
<h3 data-id="heading-0">type字面量联合类型</h3>
<p>你会选择定义一个单纯的类型，简洁直观，无运行开销吗?</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">OrderStatus</span> = <span class="hljs-number">1</span> | <span class="hljs-number">2</span> | <span class="hljs-number">3</span> | <span class="hljs-number">4</span> | <span class="hljs-number">5</span> | <span class="hljs-number">6</span> | <span class="hljs-number">7</span>
</code></pre>
<p>但这并非理想方案。它本质是类型约束，而非 “集合”—— 无法通过 “键”（如 “未支付”）访问对应的值（1），必须手动写数字或字符串，即使 TypeScript 会校验，仍存在拼写或记错值的风险。</p>
<h3 data-id="heading-1">普通对象</h3>
<p>最初我使用普通对象去满足这项要求:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">OrderStatus</span> = {
  <span class="hljs-attr">UNPAID</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">PAID_SUCCESS</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">PAID_FAILED</span>: <span class="hljs-number">3</span>,
  <span class="hljs-attr">CANCELLED</span>: <span class="hljs-number">4</span>,
  <span class="hljs-attr">SHIPPED</span>: <span class="hljs-number">5</span>,
  <span class="hljs-attr">SIGNED</span>: <span class="hljs-number">6</span>,
  <span class="hljs-attr">REFUNDED</span>: <span class="hljs-number">7</span>,
}
</code></pre>
<p>可以直接通过"键"访问值，例如<code>OrderStatus.UNPAID</code>，这是我想要的。
但是这种方式也有一些不直观的地方，类型松散，TS会自动推断该对象的类型为<code>{ UNPAID: number, PAID_SUCCESS: number, PAID_FAILED: number, CANCELLED: number, SHIPPED: number, SIGNED: number, REFUNDED: number }</code>，这显然不是我想要的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1dd143989da340758618ff4ceae4a5f2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2l56KX55uQ54SX5pif55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763460084&amp;x-signature=cULQhHwPVeJnweOfc0YVakO%2FF8o%3D" alt="1.png" loading="lazy"/>
另外，虽然枚举类型规定了1-7，但是我直接赋值其他number类型数字，也是没啥问题的，TS也不会报错。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c24ba10b317b4e6ca917b75ff7a89a03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2l56KX55uQ54SX5pif55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763460084&amp;x-signature=OkPdGr9sg5%2FP6XE60enKYEBZYk8%3D" alt="2.png" loading="lazy"/></p>
<p>当然这个也有解决方式，就是使用<code>as const</code>断言，将对象的所有属性都变成只读的字面量类型。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">OrderStatus</span> = {
  <span class="hljs-attr">UNPAID</span>: <span class="hljs-number">1</span>,
  <span class="hljs-attr">PAID_SUCCESS</span>: <span class="hljs-number">2</span>,
  <span class="hljs-attr">PAID_FAILED</span>: <span class="hljs-number">3</span>,
  <span class="hljs-attr">CANCELLED</span>: <span class="hljs-number">4</span>,
  <span class="hljs-attr">SHIPPED</span>: <span class="hljs-number">5</span>,
  <span class="hljs-attr">SIGNED</span>: <span class="hljs-number">6</span>,
  <span class="hljs-attr">REFUNDED</span>: <span class="hljs-number">7</span>,
} <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>
</code></pre>
<p>这样，TS就会自动推断该对象的类型为<code>{ readonly UNPAID: 1, readonly PAID_SUCCESS: 2, readonly PAID_FAILED: 3, readonly CANCELLED: 4, readonly SHIPPED: 5, readonly SIGNED: 6, readonly REFUNDED: 7 }</code>，这显然是我想要的。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/052fd75949e24b7e8f0dd1521b29c8b2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2l56KX55uQ54SX5pif55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763460084&amp;x-signature=%2FEtYqmsvQVv2%2FJue2oYDfZbNuX4%3D" alt="3.png" loading="lazy"/></p>
<p>兼具了普通对象的"键"访问值的便利性，同时也具备了枚举类型的"值"访问键的便利性。
但是它又不能当作类型去使用，需要手动使用<code>typeof OrderStatus</code>来提取它的联合类型。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">type</span> <span class="hljs-title class_">OrderStatusT</span> = <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">OrderStatus</span>[keyof <span class="hljs-keyword">typeof</span> <span class="hljs-title class_">OrderStatus</span>]
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/230b6984806a4cbf892435e965c9ed2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2l56KX55uQ54SX5pif55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763460084&amp;x-signature=EZ2mnjOdziG5ShFzLJPBcTO9vqI%3D" alt="4.png" loading="lazy"/></p>
<p>所以要兼具普通对象的"键"访问值的便利性，同时也具备了枚举类型的"值"访问键的便利性，以及使用联合类型。那么只能另辟蹊径了。</p>
<h3 data-id="heading-2">enum</h3>
<p>最后可以选择使用枚举类型去满足:</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">enum</span> <span class="hljs-title class_">OrderStatus</span> {
  <span class="hljs-variable constant_">UNPAID</span> = <span class="hljs-number">1</span>,
  <span class="hljs-variable constant_">PAID_SUCCESS</span> = <span class="hljs-number">2</span>,
  <span class="hljs-variable constant_">PAID_FAILED</span> = <span class="hljs-number">3</span>,
  <span class="hljs-variable constant_">CANCELLED</span> = <span class="hljs-number">4</span>,
  <span class="hljs-variable constant_">SHIPPED</span> = <span class="hljs-number">5</span>,
  <span class="hljs-variable constant_">SIGNED</span> = <span class="hljs-number">6</span>,
  <span class="hljs-variable constant_">REFUNDED</span> = <span class="hljs-number">7</span>,
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/372b14860f3e40b3a13ea4bbf0b8d7c8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p2l56KX55uQ54SX5pif55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763460084&amp;x-signature=MMklT9xLA6qJsE4kmHtFFAItH4U%3D" alt="5.png" loading="lazy"/>
如图所示，优势不言而喻了。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[5.1Spring AI Ollama 嵌入模型]]></title>    <link>https://juejin.cn/post/7571281406509760563</link>    <guid>https://juejin.cn/post/7571281406509760563</guid>    <pubDate>2025-11-11T09:36:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571281406509760563" data-draft-id="7571088527678734362" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="5.1Spring AI Ollama 嵌入模型"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T09:36:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吴祖贤"/> <meta itemprop="url" content="https://juejin.cn/user/1961184475492103"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            5.1Spring AI Ollama 嵌入模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1961184475492103/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吴祖贤
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:36:00.000Z" title="Tue Nov 11 2025 09:36:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Spring AI Ollama 嵌入模型</h2>
<h3 data-id="heading-1">前言</h3>
<p>使用 <a href="https://link.juejin.cn?target=https%3A%2F%2Follama.ai%2F" target="_blank" title="https://ollama.ai/" ref="nofollow noopener noreferrer">Ollama</a>，您可以在本地运行各种 <a href="https://link.juejin.cn?target=https%3A%2F%2Follama.com%2Fsearch%3Fc%3Dembedding" target="_blank" title="https://ollama.com/search?c=embedding" ref="nofollow noopener noreferrer">AI 模型</a> 并从中生成嵌入。</p>
<p>嵌入是一个向量（浮点数列表）。两个向量之间的距离衡量它们的相关性。小距离表示高相关性，大距离表示低相关性。</p>
<p><code>OllamaEmbeddingModel</code> 实现利用了 Ollama <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Follama%2Follama%2Fblob%2Fmain%2Fdocs%2Fapi.md%23generate-embeddings" target="_blank" title="https://github.com/ollama/ollama/blob/main/docs/api.md#generate-embeddings" ref="nofollow noopener noreferrer">嵌入 API</a> 端点。</p>
<h3 data-id="heading-2">前提条件</h3>
<p>您首先需要访问 Ollama 实例。有几个选项，包括以下：</p>
<ul>
<li>在本地机器上<a href="https://link.juejin.cn?target=https%3A%2F%2Follama.com%2Fdownload" target="_blank" title="https://ollama.com/download" ref="nofollow noopener noreferrer">下载并安装 Ollama</a>。</li>
<li>配置并<a href="https://link.juejin.cn?target=..%2Ftestcontainers.html" target="_blank" title="../testcontainers.html" ref="nofollow noopener noreferrer">通过 Testcontainers 运行 Ollama</a>。</li>
<li>通过 <a href="https://link.juejin.cn?target=..%2Fcloud-bindings.html" target="_blank" title="../cloud-bindings.html" ref="nofollow noopener noreferrer">Kubernetes Service Bindings</a> 绑定到 Ollama 实例。</li>
</ul>
<p>您可以从 <a href="https://link.juejin.cn?target=https%3A%2F%2Follama.com%2Fsearch%3Fc%3Dembedding" target="_blank" title="https://ollama.com/search?c=embedding" ref="nofollow noopener noreferrer">Ollama 模型库</a> 中拉取要在应用程序中使用的模型：</p>
<pre><code class="hljs language-shellscript" lang="shellscript">ollama pull &lt;model-name&gt;
</code></pre>
<p>您也可以拉取数千个免费的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fmodels%3Flibrary%3Dgguf%26sort%3Dtrending" target="_blank" title="https://huggingface.co/models?library=gguf&amp;sort=trending" ref="nofollow noopener noreferrer">GGUF Hugging Face 模型</a>：</p>
<pre><code class="hljs language-shellscript" lang="shellscript">ollama pull hf.co/&lt;username&gt;/&lt;model-repository&gt;
</code></pre>
<p>或者，您可以启用自动下载任何所需模型的选项：<a href="#%E8%87%AA%E5%8A%A8%E6%8B%89%E5%8F%96%E6%A8%A1%E5%9E%8B" title="#%E8%87%AA%E5%8A%A8%E6%8B%89%E5%8F%96%E6%A8%A1%E5%9E%8B">自动拉取模型</a>。</p>
<h3 data-id="heading-3">自动配置</h3>
<blockquote>
<p><strong>注意</strong>
Spring AI 自动配置、启动器模块的构件名称发生了重大变化。请参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.spring.io%2Fspring-ai%2Freference%2Fupgrade-notes.html" target="_blank" title="https://docs.spring.io/spring-ai/reference/upgrade-notes.html" ref="nofollow noopener noreferrer">升级说明</a>了解更多信息。</p>
</blockquote>
<p>Spring AI 为 Ollama 嵌入模型提供了 Spring Boot 自动配置。要启用它，请将以下依赖项添加到您的 Maven <code>pom.xml</code> 或 Gradle <code>build.gradle</code> 构建文件中：</p>
<p><strong>Maven:</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-starter-model-ollama<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>Gradle:</strong></p>
<pre><code class="hljs language-groovy" lang="groovy">dependencies {
    implementation 'org.springframework.ai:spring-ai-starter-model-ollama'
}
</code></pre>
<blockquote>
<p><strong>提示</strong>
参考<a href="https://link.juejin.cn?target=..%2F..%2Fgetting-started.html%23dependency-management" target="_blank" title="../../getting-started.html#dependency-management" ref="nofollow noopener noreferrer">依赖管理</a>部分，将 Spring AI BOM 添加到您的构建文件中。
Spring AI 构件发布在 Maven Central 和 Spring Snapshot 仓库中。参考仓库部分将这些仓库添加到您的构建系统中。</p>
</blockquote>
<h4 data-id="heading-4">基础属性</h4>
<p>前缀 <code>spring.ai.ollama</code> 是配置与 Ollama 连接的属性前缀：</p>















<table><thead><tr><th>属性</th><th>描述</th><th>默认值</th></tr></thead><tbody><tr><td>spring.ai.ollama.base-url</td><td>Ollama API 服务器运行的基础 URL。</td><td><code>http://localhost:11434</code></td></tr></tbody></table>
<p>以下是用于初始化 Ollama 集成和<a href="#%E8%87%AA%E5%8A%A8%E6%8B%89%E5%8F%96%E6%A8%A1%E5%9E%8B" title="#%E8%87%AA%E5%8A%A8%E6%8B%89%E5%8F%96%E6%A8%A1%E5%9E%8B">自动拉取模型</a>的属性：</p>



































<table><thead><tr><th>属性</th><th>描述</th><th>默认值</th></tr></thead><tbody><tr><td>spring.ai.ollama.init.pull-model-strategy</td><td>是否在启动时拉取模型以及如何拉取。</td><td><code>never</code></td></tr><tr><td>spring.ai.ollama.init.timeout</td><td>等待模型拉取完成的时间。</td><td><code>5m</code></td></tr><tr><td>spring.ai.ollama.init.max-retries</td><td>模型拉取操作的最大重试次数。</td><td><code>0</code></td></tr><tr><td>spring.ai.ollama.init.embedding.include</td><td>在初始化任务中包含此类型的模型。</td><td><code>true</code></td></tr><tr><td>spring.ai.ollama.init.embedding.additional-models</td><td>除了通过默认属性配置的模型之外，还要初始化的附加模型。</td><td><code>[]</code></td></tr></tbody></table>
<h4 data-id="heading-5">嵌入属性</h4>
<blockquote>
<p><strong>注意</strong>
嵌入自动配置的启用和禁用现在通过前缀为 <code>spring.ai.model.embedding</code> 的顶级属性配置。</p>
<p>要启用，设置 spring.ai.model.embedding=ollama（默认启用）</p>
<p>要禁用，设置 spring.ai.model.embedding=none（或任何不匹配 ollama 的值）</p>
<p>进行此更改是为了允许配置多个模型。</p>
</blockquote>
<p>前缀 <code>spring.ai.ollama.embedding.options</code> 是配置 Ollama 嵌入模型的属性前缀。它包括 Ollama 请求（高级）参数，如 <code>model</code>、<code>keep-alive</code> 和 <code>truncate</code>，以及 Ollama 模型 <code>options</code> 属性。</p>
<p>以下是 Ollama 嵌入模型的高级请求参数：</p>



































<table><thead><tr><th>属性</th><th>描述</th><th>默认值</th></tr></thead><tbody><tr><td>spring.ai.ollama.embedding.enabled (已移除，不再有效)</td><td>启用 Ollama 嵌入模型自动配置。</td><td>true</td></tr><tr><td>spring.ai.model.embedding</td><td>启用 Ollama 嵌入模型自动配置。</td><td>ollama</td></tr><tr><td>spring.ai.ollama.embedding.options.model</td><td>要使用的<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Follama%2Follama%3Ftab%3Dreadme-ov-file%23model-library" target="_blank" title="https://github.com/ollama/ollama?tab=readme-ov-file#model-library" ref="nofollow noopener noreferrer">支持的模型</a>的名称。您可以使用专用的<a href="https://link.juejin.cn?target=https%3A%2F%2Follama.com%2Fsearch%3Fc%3Dembedding" target="_blank" title="https://ollama.com/search?c=embedding" ref="nofollow noopener noreferrer">嵌入模型</a>类型</td><td>mxbai-embed-large</td></tr><tr><td>spring.ai.ollama.embedding.options.keep_alive</td><td>控制模型在请求后保持加载在内存中的时间</td><td>5m</td></tr><tr><td>spring.ai.ollama.embedding.options.truncate</td><td>截断每个输入的末尾以适应上下文长度。如果为 false 且超过上下文长度，则返回错误。</td><td>true</td></tr></tbody></table>
<p>其余的 <code>options</code> 属性基于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Follama%2Follama%2Fblob%2Fmain%2Fdocs%2Fmodelfile.md%23valid-parameters-and-values" target="_blank" title="https://github.com/ollama/ollama/blob/main/docs/modelfile.md#valid-parameters-and-values" ref="nofollow noopener noreferrer">Ollama 有效参数和值</a> 和 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Follama%2Follama%2Fblob%2Fmain%2Fapi%2Ftypes.go" target="_blank" title="https://github.com/ollama/ollama/blob/main/api/types.go" ref="nofollow noopener noreferrer">Ollama 类型</a>。默认值基于：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Follama%2Follama%2Fblob%2Fb538dc3858014f94b099730a592751a5454cab0a%2Fapi%2Ftypes.go%23L364" target="_blank" title="https://github.com/ollama/ollama/blob/b538dc3858014f94b099730a592751a5454cab0a/api/types.go#L364" ref="nofollow noopener noreferrer">Ollama 类型默认值</a>。</p>





































































































































































<table><thead><tr><th>属性</th><th>描述</th><th>默认值</th></tr></thead><tbody><tr><td>spring.ai.ollama.embedding.options.numa</td><td>是否使用 NUMA。</td><td>false</td></tr><tr><td>spring.ai.ollama.embedding.options.num-ctx</td><td>设置用于生成下一个标记的上下文窗口大小。</td><td>2048</td></tr><tr><td>spring.ai.ollama.embedding.options.num-batch</td><td>提示处理最大批量大小。</td><td>512</td></tr><tr><td>spring.ai.ollama.embedding.options.num-gpu</td><td>要发送到 GPU 的层数。在 macOS 上默认为 1 以启用 metal 支持，0 表示禁用。这里的 1 表示应该动态设置 NumGPU</td><td>-1</td></tr><tr><td>spring.ai.ollama.embedding.options.main-gpu</td><td>当使用多个 GPU 时，此选项控制哪个 GPU 用于小张量，对于这些张量，在所有 GPU 上分割计算的开销是不值得的。所涉及的 GPU 将使用更多的 VRAM 来存储临时结果的暂存缓冲区。</td><td>0</td></tr><tr><td>spring.ai.ollama.embedding.options.low-vram</td><td>-</td><td>false</td></tr><tr><td>spring.ai.ollama.embedding.options.f16-kv</td><td>-</td><td>true</td></tr><tr><td>spring.ai.ollama.embedding.options.logits-all</td><td>返回所有标记的对数，而不仅仅是最后一个。要启用补全返回对数概率，这必须为 true。</td><td>-</td></tr><tr><td>spring.ai.ollama.embedding.options.vocab-only</td><td>仅加载词汇表，不加载权重。</td><td>-</td></tr><tr><td>spring.ai.ollama.embedding.options.use-mmap</td><td>默认情况下，模型被映射到内存中，这允许系统仅根据需要加载模型的必要部分。但是，如果模型大于您的总 RAM 量，或者您的系统可用内存较少，使用 mmap 可能会增加页面调出的风险，从而对性能产生负面影响。禁用 mmap 会导致加载时间变慢，但如果您不使用 mlock，可能会减少页面调出。请注意，如果模型大于总 RAM 量，关闭 mmap 将完全阻止模型加载。</td><td>null</td></tr><tr><td>spring.ai.ollama.embedding.options.use-mlock</td><td>将模型锁定在内存中，防止在内存映射时被换出。这可以提高性能，但通过需要更多 RAM 来运行并可能减慢模型加载到 RAM 的时间，而失去了内存映射的一些优势。</td><td>false</td></tr><tr><td>spring.ai.ollama.embedding.options.num-thread</td><td>设置计算期间使用的线程数。默认情况下，Ollama 将检测此值以获得最佳性能。建议将此值设置为您的系统具有的物理 CPU 核心数（而不是逻辑核心数）。0 = 让运行时决定</td><td>0</td></tr><tr><td>spring.ai.ollama.embedding.options.num-keep</td><td>-</td><td>4</td></tr><tr><td>spring.ai.ollama.embedding.options.seed</td><td>设置用于生成的随机数种子。将此设置为特定数字将使模型为相同的提示生成相同的文本。</td><td>-1</td></tr><tr><td>spring.ai.ollama.embedding.options.num-predict</td><td>生成文本时要预测的最大标记数。（-1 = 无限生成，-2 = 填充上下文）</td><td>-1</td></tr><tr><td>spring.ai.ollama.embedding.options.top-k</td><td>减少生成无意义的概率。较高的值（例如，100）将给出更多样化的答案，而较低的值（例如，10）将更加保守。</td><td>40</td></tr><tr><td>spring.ai.ollama.embedding.options.top-p</td><td>与 top-k 一起工作。较高的值（例如，0.95）将导致更多样化的文本，而较低的值（例如，0.5）将生成更专注和保守的文本。</td><td>0.9</td></tr><tr><td>spring.ai.ollama.embedding.options.min-p</td><td>top_p 的替代方案，旨在确保质量和多样性的平衡。参数 p 表示相对于最可能标记的概率，要考虑的标记的最小概率。例如，当 p=0.05 且最可能标记的概率为 0.9 时，值小于 0.045 的对数被过滤掉。</td><td>0.0</td></tr><tr><td>spring.ai.ollama.embedding.options.tfs-z</td><td>无尾采样用于减少输出中不太可能标记的影响。较高的值（例如，2.0）将更多地减少影响，而值为 1.0 则禁用此设置。</td><td>1.0</td></tr><tr><td>spring.ai.ollama.embedding.options.typical-p</td><td>-</td><td>1.0</td></tr><tr><td>spring.ai.ollama.embedding.options.repeat-last-n</td><td>设置模型回溯多远以防止重复。（默认值：64，0 = 禁用，-1 = num_ctx）</td><td>64</td></tr><tr><td>spring.ai.ollama.embedding.options.temperature</td><td>模型的温度。提高温度将使模型的回答更具创造性。</td><td>0.8</td></tr><tr><td>spring.ai.ollama.embedding.options.repeat-penalty</td><td>设置对重复的惩罚强度。较高的值（例如，1.5）将更强烈地惩罚重复，而较低的值（例如，0.9）将更加宽容。</td><td>1.1</td></tr><tr><td>spring.ai.ollama.embedding.options.presence-penalty</td><td>-</td><td>0.0</td></tr><tr><td>spring.ai.ollama.embedding.options.frequency-penalty</td><td>-</td><td>0.0</td></tr><tr><td>spring.ai.ollama.embedding.options.mirostat</td><td>启用 Mirostat 采样以控制困惑度。（默认值：0，0 = 禁用，1 = Mirostat，2 = Mirostat 2.0）</td><td>0</td></tr><tr><td>spring.ai.ollama.embedding.options.mirostat-tau</td><td>控制输出的连贯性和多样性之间的平衡。较低的值将导致更专注和连贯的文本。</td><td>5.0</td></tr><tr><td>spring.ai.ollama.embedding.options.mirostat-eta</td><td>影响算法对生成文本的反馈响应速度。较低的学习率将导致调整较慢，而较高的学习率将使算法更具响应性。</td><td>0.1</td></tr><tr><td>spring.ai.ollama.embedding.options.penalize-newline</td><td>-</td><td>true</td></tr><tr><td>spring.ai.ollama.embedding.options.stop</td><td>设置要使用的停止序列。当遇到此模式时，LLM 将停止生成文本并返回。可以通过在 modelfile 中指定多个单独的停止参数来设置多个停止模式。</td><td>-</td></tr><tr><td>spring.ai.ollama.embedding.options.functions</td><td>要在单个提示请求中启用函数调用的函数名称列表。具有这些名称的函数必须存在于 functionCallbacks 注册表中。</td><td>-</td></tr></tbody></table>
<blockquote>
<p><strong>提示</strong>
所有以 <code>spring.ai.ollama.embedding.options</code> 为前缀的属性都可以通过在 <code>EmbeddingRequest</code> 调用中添加请求特定的<a href="#%E8%BF%90%E8%A1%8C%E6%97%B6%E9%80%89%E9%A1%B9" title="#%E8%BF%90%E8%A1%8C%E6%97%B6%E9%80%89%E9%A1%B9">运行时选项</a>来在运行时覆盖。</p>
</blockquote>
<h3 data-id="heading-6">运行时选项</h3>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fspring-projects%2Fspring-ai%2Fblob%2Fmain%2Fmodels%2Fspring-ai-ollama%2Fsrc%2Fmain%2Fjava%2Forg%2Fspringframework%2Fai%2Follama%2Fapi%2FOllamaOptions.java" target="_blank" title="https://github.com/spring-projects/spring-ai/blob/main/models/spring-ai-ollama/src/main/java/org/springframework/ai/ollama/api/OllamaOptions.java" ref="nofollow noopener noreferrer">OllamaOptions.java</a> 提供 Ollama 配置，如要使用的模型、低级 GPU 和 CPU 调整等。</p>
<p>默认选项也可以使用 <code>spring.ai.ollama.embedding.options</code> 属性进行配置。</p>
<p>在启动时，使用 <code>OllamaEmbeddingModel(OllamaApi ollamaApi, OllamaOptions defaultOptions)</code> 来配置所有嵌入请求使用的默认选项。在运行时，您可以使用 <code>OllamaOptions</code> 实例作为 <code>EmbeddingRequest</code> 的一部分来覆盖默认选项。</p>
<p>例如，覆盖特定请求的默认模型名称：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">EmbeddingResponse</span> <span class="hljs-variable">embeddingResponse</span> <span class="hljs-operator">=</span> embeddingModel.call(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">EmbeddingRequest</span>(List.of(<span class="hljs-string">"Hello World"</span>, <span class="hljs-string">"World is big and salvation is near"</span>),
        OllamaOptions.builder()
            .model(<span class="hljs-string">"Different-Embedding-Model-Deployment-Name"</span>))
            .truncates(<span class="hljs-literal">false</span>)
            .build());
</code></pre>
<h3 data-id="heading-7">自动拉取模型</h3>
<p>Spring AI Ollama 可以在模型在您的 Ollama 实例中不可用时自动拉取它们。此功能对于开发和测试以及将应用程序部署到新环境特别有用。</p>
<blockquote>
<p><strong>提示</strong>
您也可以按名称拉取数千个免费的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fmodels%3Flibrary%3Dgguf%26sort%3Dtrending" target="_blank" title="https://huggingface.co/models?library=gguf&amp;sort=trending" ref="nofollow noopener noreferrer">GGUF Hugging Face 模型</a>。</p>
</blockquote>
<p>拉取模型有三种策略：</p>
<ul>
<li><code>always</code>（在 <code>PullModelStrategy.ALWAYS</code> 中定义）：总是拉取模型，即使它已经可用。有助于确保您使用的是模型的最新版本。</li>
<li><code>when_missing</code>（在 <code>PullModelStrategy.WHEN_MISSING</code> 中定义）：仅当模型尚不可用时才拉取。这可能导致使用较旧版本的模型。</li>
<li><code>never</code>（在 <code>PullModelStrategy.NEVER</code> 中定义）：从不自动拉取模型。</li>
</ul>
<blockquote>
<p><strong>注意</strong>
由于下载模型时可能出现潜在的延迟，不建议在生产环境中使用自动拉取。相反，考虑提前评估并预下载必要的模型。</p>
</blockquote>
<p>所有通过配置属性和默认选项定义的模型都可以在启动时自动拉取。您可以使用配置属性配置拉取策略、超时和最大重试次数：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">ai:</span>
    <span class="hljs-attr">ollama:</span>
      <span class="hljs-attr">init:</span>
        <span class="hljs-attr">pull-model-strategy:</span> <span class="hljs-string">always</span>
        <span class="hljs-attr">timeout:</span> <span class="hljs-string">60s</span>
        <span class="hljs-attr">max-retries:</span> <span class="hljs-number">1</span>
</code></pre>
<blockquote>
<p><strong>注意</strong>
应用程序在所有指定模型在 Ollama 中可用之前不会完成其初始化。根据模型大小和互联网连接速度，这可能会显著减慢应用程序的启动时间。</p>
</blockquote>
<p>您可以在启动时初始化其他模型，这对于在运行时动态使用的模型很有用：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">ai:</span>
    <span class="hljs-attr">ollama:</span>
      <span class="hljs-attr">init:</span>
        <span class="hljs-attr">pull-model-strategy:</span> <span class="hljs-string">always</span>
        <span class="hljs-attr">embedding:</span>
          <span class="hljs-attr">additional-models:</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">mxbai-embed-large</span>
            <span class="hljs-bullet">-</span> <span class="hljs-string">nomic-embed-text</span>
</code></pre>
<p>如果您想仅对特定类型的模型应用拉取策略，可以从初始化任务中排除嵌入模型：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">spring:</span>
  <span class="hljs-attr">ai:</span>
    <span class="hljs-attr">ollama:</span>
      <span class="hljs-attr">init:</span>
        <span class="hljs-attr">pull-model-strategy:</span> <span class="hljs-string">always</span>
        <span class="hljs-attr">embedding:</span>
          <span class="hljs-attr">include:</span> <span class="hljs-literal">false</span>
</code></pre>
<p>此配置将拉取策略应用于除嵌入模型之外的所有模型。</p>
<h3 data-id="heading-8">HuggingFace 模型</h3>
<p>Ollama 可以开箱即用地访问所有 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fmodels%3Flibrary%3Dgguf%26sort%3Dtrending" target="_blank" title="https://huggingface.co/models?library=gguf&amp;sort=trending" ref="nofollow noopener noreferrer">GGUF Hugging Face</a> 嵌入模型。您可以按名称拉取这些模型中的任何一个：<code>ollama pull hf.co/&lt;username&gt;/&lt;model-repository&gt;</code> 或配置自动拉取策略：<a href="#%E8%87%AA%E5%8A%A8%E6%8B%89%E5%8F%96%E6%A8%A1%E5%9E%8B" title="#%E8%87%AA%E5%8A%A8%E6%8B%89%E5%8F%96%E6%A8%A1%E5%9E%8B">自动拉取模型</a>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">spring.ai.ollama.embedding.options.model</span>=hf.co/mixedbread-ai/mxbai-embed-large-v1
<span class="hljs-attr">spring.ai.ollama.init.pull-model-strategy</span>=always
</code></pre>
<ul>
<li><code>spring.ai.ollama.embedding.options.model</code>：指定要使用的 <a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fmodels%3Flibrary%3Dgguf%26sort%3Dtrending" target="_blank" title="https://huggingface.co/models?library=gguf&amp;sort=trending" ref="nofollow noopener noreferrer">Hugging Face GGUF 模型</a>。</li>
<li><code>spring.ai.ollama.init.pull-model-strategy=always</code>：（可选）在启动时启用自动模型拉取。对于生产环境，您应该预下载模型以避免延迟：<code>ollama pull hf.co/mixedbread-ai/mxbai-embed-large-v1</code>。</li>
</ul>
<h3 data-id="heading-9">示例控制器</h3>
<p>这将创建一个可以注入到类中的 <code>EmbeddingModel</code> 实现。以下是使用 <code>EmbeddingModel</code> 实现的简单 <code>@Controller</code> 类示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmbeddingController</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> EmbeddingModel embeddingModel;

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">EmbeddingController</span><span class="hljs-params">(EmbeddingModel embeddingModel)</span> {
        <span class="hljs-built_in">this</span>.embeddingModel = embeddingModel;
    }

    <span class="hljs-meta">@GetMapping("/ai/embedding")</span>
    <span class="hljs-keyword">public</span> Map <span class="hljs-title function_">embed</span><span class="hljs-params">(<span class="hljs-meta">@RequestParam(value = "message", defaultValue = "Tell me a joke")</span> String message)</span> {
        <span class="hljs-type">EmbeddingResponse</span> <span class="hljs-variable">embeddingResponse</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.embeddingModel.embedForResponse(List.of(message));
        <span class="hljs-keyword">return</span> Map.of(<span class="hljs-string">"embedding"</span>, embeddingResponse);
    }
}
</code></pre>
<h3 data-id="heading-10">手动配置</h3>
<p>如果您不使用 Spring Boot，可以手动配置 <code>OllamaEmbeddingModel</code>。为此，将 spring-ai-ollama 依赖项添加到项目的 Maven pom.xml 或 Gradle <code>build.gradle</code> 构建文件中：</p>
<p><strong>Maven:</strong></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.ai<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-ai-ollama<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p><strong>Gradle:</strong></p>
<pre><code class="hljs language-groovy" lang="groovy">dependencies {
    implementation 'org.springframework.ai:spring-ai-ollama'
}
</code></pre>
<blockquote>
<p><strong>提示</strong>
参考<a href="https://link.juejin.cn?target=..%2F..%2Fgetting-started.html%23dependency-management" target="_blank" title="../../getting-started.html#dependency-management" ref="nofollow noopener noreferrer">依赖管理</a>部分，将 Spring AI BOM 添加到您的构建文件中。</p>
</blockquote>
<blockquote>
<p><strong>注意</strong>
<code>spring-ai-ollama</code> 依赖项也提供对 <code>OllamaChatModel</code> 的访问。有关 <code>OllamaChatModel</code> 的更多信息，请参考 <a href="https://link.juejin.cn?target=..%2Fchat%2Follama-chat.html" target="_blank" title="../chat/ollama-chat.html" ref="nofollow noopener noreferrer">Ollama 聊天客户端</a> 部分。</p>
</blockquote>
<p>接下来，创建一个 <code>OllamaEmbeddingModel</code> 实例，并使用它使用专用的 <code>chroma/all-minilm-l6-v2-f32</code> 嵌入模型计算两个输入文本的嵌入：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">var</span> <span class="hljs-variable">ollamaApi</span> <span class="hljs-operator">=</span> OllamaApi.builder().build();

<span class="hljs-type">var</span> <span class="hljs-variable">embeddingModel</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OllamaEmbeddingModel</span>(<span class="hljs-built_in">this</span>.ollamaApi,
        OllamaOptions.builder()
			.model(OllamaModel.MISTRAL.id())
            .build());

<span class="hljs-type">EmbeddingResponse</span> <span class="hljs-variable">embeddingResponse</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.embeddingModel.call(
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">EmbeddingRequest</span>(List.of(<span class="hljs-string">"Hello World"</span>, <span class="hljs-string">"World is big and salvation is near"</span>),
        OllamaOptions.builder()
            .model(<span class="hljs-string">"chroma/all-minilm-l6-v2-f32"</span>))
            .truncate(<span class="hljs-literal">false</span>)
            .build());
</code></pre>
<p><code>OllamaOptions</code> 提供所有嵌入请求的配置信息。</p>
<hr/></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 组件入门学习笔记：局部注册、全局注册与 Props 传值详解]]></title>    <link>https://juejin.cn/post/7571278865516675122</link>    <guid>https://juejin.cn/post/7571278865516675122</guid>    <pubDate>2025-11-11T09:36:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571278865516675122" data-draft-id="7571088527678767130" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 组件入门学习笔记：局部注册、全局注册与 Props 传值详解"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-11T09:36:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户9242625700731"/> <meta itemprop="url" content="https://juejin.cn/user/2054336951356680"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 组件入门学习笔记：局部注册、全局注册与 Props 传值详解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2054336951356680/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户9242625700731
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T09:36:12.000Z" title="Tue Nov 11 2025 09:36:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为 Vue 初学者，组件是绕不开的核心知识点。今天就来整理一下<strong>组件的注册方式</strong>和 ** 组件间数据传递（Props）** 的核心内容，既是自己的学习总结，也希望能帮到同样入门的小伙伴～</p>
<h2 data-id="heading-0">一、组件的局部注册：三步走实现组件复用</h2>
<p>局部注册是指<strong>仅在当前组件内可使用</strong>的注册方式，适合按需引入的场景。核心流程分三步：<strong>引入组件 → 注册组件 → 模板中使用</strong>。</p>
<h3 data-id="heading-1">示例代码（以<code>App.vue</code>引入<code>Header.vue</code>为例）</h3>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- App.vue --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 第三步：模板中使用组件 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span> 
  <span class="hljs-tag">&lt;<span class="hljs-name">Main</span> /&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Aside</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-comment">// 第一步：引入需要注册的组件</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Header</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./pages/Header.vue"</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Main</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./pages/Main.vue"</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Aside</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./pages/Aside.vue"</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-comment">// 第二步：在components选项中注册组件</span>
  <span class="hljs-attr">components</span>: {
    <span class="hljs-title class_">Header</span>,
    <span class="hljs-title class_">Main</span>,
    <span class="hljs-title class_">Aside</span>
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><strong>核心逻辑</strong>：通过<code>import</code>引入组件文件，在<code>components</code>选项中声明后，就能在当前组件的模板中以标签形式使用了。这种方式的好处是 “用多少引多少”，非常灵活～</p>
<h2 data-id="heading-2">二、组件的全局注册：一次注册，全局可用</h2>
<p>全局注册是指在<strong>项目入口文件（如<code>main.js</code>）<strong>中注册组件，注册后</strong>所有组件都能直接使用</strong>，无需重复引入。</p>
<h3 data-id="heading-3">示例代码（在<code>main.js</code>中全局注册<code>Header</code>组件）</h3>
<p>javascript</p>
<p>运行</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// main.js</span>
<span class="hljs-keyword">import</span> { createApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">App</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./App.vue'</span>
<span class="hljs-comment">// 引入要全局注册的组件</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Header</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./pages/Header.vue"</span>

<span class="hljs-keyword">const</span> app = <span class="hljs-title function_">createApp</span>(<span class="hljs-title class_">App</span>)

<span class="hljs-comment">// 全局注册：第一个参数是组件名，第二个是组件对象</span>
app.<span class="hljs-title function_">component</span>(<span class="hljs-string">"Header"</span>, <span class="hljs-title class_">Header</span>)

app.<span class="hljs-title function_">mount</span>(<span class="hljs-string">'#app'</span>)
</code></pre>
<p><strong>优点</strong>：全局组件在任何地方都能直接用，不用重复引入和注册。<strong>缺点</strong>：</p>
<ol>
<li>即使某个页面没用到该组件，打包时也会被包含进去，增加包体积；</li>
<li>大型项目中依赖关系不明确，维护起来比较麻烦。</li>
</ol>
<p>所以，<strong>全局注册适合项目中频繁复用的 “基础组件”</strong> （如按钮、输入框），普通业务组件更推荐局部注册～</p>
<h2 data-id="heading-4">三、组件间数据传递：Props 实现父传子</h2>
<p>Vue 中组件是独立的，想要实现 “父组件给子组件传数据”，就需要用到<strong>Props</strong>。它的核心规则是：<strong>只能父传子，传值无数量 / 类型限制，但子组件不能直接修改父传的值</strong>。</p>
<h3 data-id="heading-5">1. Props 的基本使用流程（父传子）</h3>
<p>以<code>ComponentA</code>（父）向<code>ComponentB</code>（子）传值为例：</p>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ComponentA.vue（父组件） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>ComponentA<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 第一步：在子组件标签上绑定要传递的数据 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">ComponentB</span> <span class="hljs-attr">:title</span>=<span class="hljs-string">"title"</span> <span class="hljs-attr">:age</span>=<span class="hljs-string">"age"</span> <span class="hljs-attr">:names</span>=<span class="hljs-string">"names"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">import</span> <span class="hljs-title class_">ComponentB</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"./ComponentB.vue"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">components</span>: { <span class="hljs-title class_">ComponentB</span> },
  <span class="hljs-title function_">data</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">title</span>: <span class="hljs-string">"标题"</span>,
      <span class="hljs-attr">age</span>: <span class="hljs-number">20</span>,
      <span class="hljs-attr">names</span>: [<span class="hljs-string">"iwen"</span>, <span class="hljs-string">"ime"</span>]
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ComponentB.vue（子组件） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ title }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{{ age }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">v-for</span>=<span class="hljs-string">"(item,index) of names"</span> <span class="hljs-attr">:key</span>=<span class="hljs-string">"index"</span>&gt;</span>{{ item }}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-comment">// 第二步：子组件通过props选项声明接收的数据</span>
  <span class="hljs-attr">props</span>: [<span class="hljs-string">"title"</span>, <span class="hljs-string">"age"</span>, <span class="hljs-string">"names"</span>]
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<h3 data-id="heading-6">2. Props 的高级配置（类型、默认值、必填项）</h3>
<p>实际开发中，我们需要对 Props 做<strong>类型限制、默认值设置、必填校验</strong>，让组件更健壮。</p>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- ComponentB.vue（子组件） --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">props</span>: {
    <span class="hljs-comment">// 限制title的类型可以是字符串、数字、数组、对象</span>
    <span class="hljs-attr">title</span>: {
      <span class="hljs-attr">type</span>: [<span class="hljs-title class_">String</span>, <span class="hljs-title class_">Number</span>, <span class="hljs-title class_">Array</span>, <span class="hljs-title class_">Object</span>],
      <span class="hljs-attr">required</span>: <span class="hljs-literal">true</span> <span class="hljs-comment">// 表示title是必填项</span>
    },
    <span class="hljs-comment">// 限制age的类型是数字，默认值为0</span>
    <span class="hljs-attr">age</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">Number</span>,
      <span class="hljs-attr">default</span>: <span class="hljs-number">0</span>
    },
    <span class="hljs-comment">// 数组/对象的默认值必须用工厂函数返回</span>
    <span class="hljs-attr">names</span>: {
      <span class="hljs-attr">type</span>: <span class="hljs-title class_">Array</span>,
      <span class="hljs-title function_">default</span>(<span class="hljs-params"/>) {
        <span class="hljs-keyword">return</span> [<span class="hljs-string">"空"</span>]
      }
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p><strong>关键注意点</strong>：</p>
<ul>
<li><code>type</code>支持的类型有<code>String</code>、<code>Number</code>、<code>Boolean</code>、<code>Array</code>、<code>Object</code>、<code>Date</code>、<code>Function</code>、<code>Symbol</code>；</li>
<li>数组 / 对象的<code>default</code>必须用<strong>工厂函数</strong>返回，否则会导致所有实例共享同一个默认值；</li>
<li><code>required: true</code>表示该 Props 是必填项，父组件必须传递。</li>
</ul>
<h3 data-id="heading-7">3. 千万注意：子组件不能直接修改 Props 的值</h3>
<p>Vue 规定<strong>Props 是 “单向数据流”</strong> ，子组件只能读取 Props 的值，不能直接修改。如果强行修改，控制台会报错～</p>
<p>vue</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 错误示范！子组件不能直接修改父传的props --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="javascript">
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> {
  <span class="hljs-attr">props</span>: [<span class="hljs-string">"title"</span>],
  <span class="hljs-attr">methods</span>: {
    <span class="hljs-title function_">updateHandle</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">title</span> = <span class="hljs-string">"新数据"</span> <span class="hljs-comment">// 报错！不允许直接修改props</span>
    }
  }
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
</code></pre>
<p>如果需要修改，正确的做法是：子组件通过<strong>事件（$emit）通知父组件</strong>，由父组件来修改数据。</p>
<h2 data-id="heading-8">总结：组件注册与传值核心要点</h2>
<ul>
<li>组件注册：局部注册 “按需引入” 灵活，全局注册 “一次注册到处用” 但要慎用；</li>
<li>Props 传值：父传子的核心方式，支持类型限制、默认值、必填校验，且子组件不能直接修改 Props。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基于 Git Submodule 的代码同步融合方案]]></title>    <link>https://juejin.cn/post/7571156741397577743</link>    <guid>https://juejin.cn/post/7571156741397577743</guid>    <pubDate>2025-11-11T08:05:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571156741397577743" data-draft-id="7571237750730227746" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基于 Git Submodule 的代码同步融合方案"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-11T08:05:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="一诺滚雪球"/> <meta itemprop="url" content="https://juejin.cn/user/2824015112318094"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基于 Git Submodule 的代码同步融合方案
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2824015112318094/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    一诺滚雪球
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T08:05:33.000Z" title="Tue Nov 11 2025 08:05:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1、背景</h2>
<p>公司一个业务是基于A项目和B项目的代码融合发布的新版本。其中A项目为主项目，B项目为子项目，现有代码同步方案：</p>
<p>在A项目中运行代码同步脚本(copy.js)，需要将脚本中的默认源路径替换成B目录地址，B项目需要切换到需要的分支进行同步。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> defaultSourceBasePath = <span class="hljs-string">'D:\Project\B项目'</span>;
</code></pre>
<p>弊端：</p>
<ol>
<li>代码同步依赖两个项目切换分支</li>
<li>修改bug需要两个仓库单独分别提交</li>
</ol>
<p>整体如下图所示：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/225df5a0f43442148c19686d32cf3a54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763453133&amp;x-signature=dnFoTikCf7FxkTw4Y2bBPfoKHqs%3D" alt="住中融合版本代码同步方案.png" loading="lazy"/>
如何在一个项目中完成上述操作，可以使用git submodule解决。</p>
<h2 data-id="heading-1">2、submodule实践</h2>
<h3 data-id="heading-2">2.1 什么是submodule</h3>
<p>Git Submodule是什么？</p>
<p>Git Submodule 是 Git 内置的一个功能，它允许在一个 “主仓库”（Parent Repository）中嵌入另一个独立的 “子仓库”（Submodule Repository）。子仓库可以是本地仓库，也可以是远程仓库（如 GitHub、GitLab 上的仓库）。</p>
<h3 data-id="heading-3">2.2 如何嵌入项目</h3>
<p>我们A为主项目，B为子项目。</p>
<ol>
<li>
<p>添加子项目 git submodule add &lt;子仓库URL&gt; &lt;本地路径&gt;</p>
<ol>
<li>git submodule add ssh://git@192.168.0.39:3022/A.git 在A项目下B的目录</li>
</ol>
</li>
<li>
<p>克隆项目 git clone --recurse-submodules ssh://git@192.168.0.39:3022/e-commerce/A.git</p>
<ol>
<li>注意：不加 --recurse-submodules克隆直接拉取，子项目文件夹会为空需要单独执行命令拉取子项目</li>
</ol>
</li>
<li>
<p>提交代码</p>
<ol>
<li>主项目修改提交不影响子项目</li>
<li>子项目修改提交后，主项目需要额外提交一次commit记录子项目的提交行为</li>
</ol>
</li>
</ol>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f41e9433891b489ba09b67c52ee77501~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763453133&amp;x-signature=djVAF7Sf7SDfTcavopY4yG%2BBKe0%3D" alt="image.png" loading="lazy"/></p>
<p>vscode可以直接提交和切换分支：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6315f25b7b5041baa6c8181650744dce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiA6K-65rua6Zuq55CD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763453133&amp;x-signature=tW6rKjtw6q7aGjpZgkxehYQZrKI%3D" alt="image.png" loading="lazy"/></p>
<p>A项目可以直接提交B项目仓库代码，父仓库只记录子仓库提交的行为。</p>
<ol start="4">
<li>拉取代码
<ol>
<li>
<p>注意拉取代码也是需要主项目重新提交commit，记录变化</p>
</li>
<li>
<p>主项目git pull 是不会拉取子项目代码，子项目拉取：</p>
<p>a. 直接进入子项目文件夹git pull</p>
<p>b. 主项目下直接执行git submodule foreach git pull</p>
</li>
</ol>
</li>
</ol>
<h2 data-id="heading-4">3、总结</h2>
<p>最后总结一下，在A项目下使用<strong>submodule</strong>引用B项目的仓库，同步代码直接使用脚本。</p>
<p>优势是：</p>
<ul>
<li>无需每个人根据自己目录修改地址</li>
<li>可以随时切换分支进行同步</li>
</ul>
<p>如有错误，请指正O^O!</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[3.3 Spring AI Advisors API]]></title>    <link>https://juejin.cn/post/7571067260053831706</link>    <guid>https://juejin.cn/post/7571067260053831706</guid>    <pubDate>2025-11-11T07:59:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571067260053831706" data-draft-id="7571126773808185354" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="3.3 Spring AI Advisors API"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T07:59:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="吴祖贤"/> <meta itemprop="url" content="https://juejin.cn/user/1961184475492103"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            3.3 Spring AI Advisors API
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1961184475492103/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    吴祖贤
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T07:59:30.000Z" title="Tue Nov 11 2025 07:59:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Spring AI Advisors API</h2>
<h3 data-id="heading-1">概述</h3>
<p>Spring AI Advisors API提供了一种灵活而强大的方式来拦截、修改和增强Spring应用程序中AI驱动的交互。通过利用Advisors API，开发者可以创建更复杂、可重用和可维护的AI组件。</p>
<p>关键优势包括封装重复的生成AI模式，转换发送给大语言模型（LLMs）和从大语言模型接收的数据，以及跨各种模型和用例提供可移植性。</p>
<p>您可以使用<a href="https://link.juejin.cn?target=chatclient.html%23_advisor_configuration_in_chatclient" target="_blank" title="chatclient.html#_advisor_configuration_in_chatclient" ref="nofollow noopener noreferrer">ChatClient API</a>配置现有的advisors，如以下示例所示：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ChatMemory</span> <span class="hljs-variable">chatMemory</span> <span class="hljs-operator">=</span> ... <span class="hljs-comment">// 初始化您的聊天记忆存储</span>
<span class="hljs-type">VectorStore</span> <span class="hljs-variable">vectorStore</span> <span class="hljs-operator">=</span> ... <span class="hljs-comment">// 初始化您的向量存储</span>

<span class="hljs-type">var</span> <span class="hljs-variable">chatClient</span> <span class="hljs-operator">=</span> ChatClient.builder(chatModel)
    .defaultAdvisors(
        MessageChatMemoryAdvisor.builder(chatMemory).build(), <span class="hljs-comment">// 聊天记忆advisor</span>
        QuestionAnswerAdvisor.builder(vectorStore).build()    <span class="hljs-comment">// RAG advisor</span>
    )
    .build();

<span class="hljs-type">var</span> <span class="hljs-variable">conversationId</span> <span class="hljs-operator">=</span> <span class="hljs-string">"678"</span>;

<span class="hljs-type">String</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.chatClient.prompt()
    <span class="hljs-comment">// 在运行时设置advisor参数</span>
    .advisors(advisor -&gt; advisor.param(ChatMemory.CONVERSATION_ID, conversationId))
    .user(userText)
    .call()
	.content();
</code></pre>
<p>建议在构建时使用builder的<code>defaultAdvisors()</code>方法注册advisors。</p>
<p>Advisors也参与可观察性堆栈，因此您可以查看与其执行相关的指标和跟踪。</p>
<ul>
<li><a href="https://link.juejin.cn?target=retrieval-augmented-generation.html%23_questionansweradvisor" target="_blank" title="retrieval-augmented-generation.html#_questionansweradvisor" ref="nofollow noopener noreferrer">了解问题回答Advisor</a></li>
<li><a href="https://link.juejin.cn?target=chat-memory.html%23_memory_in_chat_client" target="_blank" title="chat-memory.html#_memory_in_chat_client" ref="nofollow noopener noreferrer">了解聊天记忆Advisor</a></li>
</ul>
<h3 data-id="heading-2">核心组件</h3>
<p>API由用于非流式场景的<code>CallAdvisor</code>和<code>CallAdvisorChain</code>，以及用于流式场景的<code>StreamAdvisor</code>和<code>StreamAdvisorChain</code>组成。它还包括<code>ChatClientRequest</code>来表示未密封的Prompt请求，<code>ChatClientResponse</code>用于聊天完成响应。两者都持有一个<code>advise-context</code>以在advisor链中共享状态。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57e5c05a1b2049d898eaba70dc416543~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC056WW6LSk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763452770&amp;x-signature=NBciigLu9Ee940Z97uBdcNORlOw%3D" alt="Advisors API Classes" loading="lazy"/></p>
<p><code>adviseCall()</code>和<code>adviseStream()</code>是关键的advisor方法，通常执行诸如检查未密封的Prompt数据、自定义和增强Prompt数据、调用advisor链中的下一个实体、可选择阻止请求、检查聊天完成响应以及抛出异常以指示处理错误等操作。</p>
<p>此外，<code>getOrder()</code>方法确定advisor在链中的顺序，而<code>getName()</code>提供唯一的advisor名称。</p>
<p>Advisor链由Spring AI框架创建，允许按<code>getOrder()</code>值排序依次调用多个advisors。较低的值首先执行。最后一个advisor由框架自动添加，将请求发送给LLM。</p>
<p>以下流程图说明了advisor链与聊天模型之间的交互：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/116c22c4a7954da786912667112ca48b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC056WW6LSk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763452770&amp;x-signature=Ol3D3ugKZ2TlC2D18dggkQuEee0%3D" alt="Advisors API Flow" loading="lazy"/></p>
<ol>
<li>
<p>Spring AI框架从用户的<code>Prompt</code>创建一个<code>ChatClientRequest</code>，以及一个空的advisor <code>context</code>对象。</p>
</li>
<li>
<p>链中的每个advisor处理请求，可能修改它。或者，它可以通过不调用调用下一个实体来选择阻止请求。在后一种情况下，advisor负责填写响应。</p>
</li>
<li>
<p>框架提供的最终advisor将请求发送给<code>Chat Model</code>。</p>
</li>
<li>
<p>聊天模型的响应然后通过advisor链传回并转换为<code>ChatClientResponse</code>。后者包括共享的advisor <code>context</code>实例。</p>
</li>
<li>
<p>每个advisor可以处理或修改响应。</p>
</li>
<li>
<p>最终的<code>ChatClientResponse</code>通过提取<code>ChatCompletion</code>返回给客户端。</p>
</li>
</ol>
<h4 data-id="heading-3">Advisor顺序</h4>
<p>advisor在链中的执行顺序由<code>getOrder()</code>方法确定。需要理解的关键点：</p>
<ul>
<li>具有较低顺序值的advisors首先执行。</li>
<li>advisor链作为堆栈操作：
<ul>
<li>链中的第一个advisor是第一个处理请求的。</li>
<li>它也是最后一个处理响应的。</li>
</ul>
</li>
<li>要控制执行顺序：
<ul>
<li>将顺序设置为接近<code>Ordered.HIGHEST_PRECEDENCE</code>以确保advisor在链中首先执行（请求处理最先，响应处理最后）。</li>
<li>将顺序设置为接近<code>Ordered.LOWEST_PRECEDENCE</code>以确保advisor在链中最后执行（请求处理最后，响应处理最先）。</li>
</ul>
</li>
<li>较高的值被解释为较低的优先级。</li>
<li>如果多个advisors具有相同的顺序值，它们的执行顺序不保证。</li>
</ul>
<p><strong>注意：</strong> 顺序和执行序列之间的明显矛盾是由于advisor链的堆栈特性：</p>
<ul>
<li>具有最高优先级（最低顺序值）的advisor被添加到堆栈的顶部。</li>
<li>在堆栈展开时，它将是第一个处理请求的。</li>
<li>在堆栈回绕时，它将是最后一个处理响应的。</li>
</ul>
<p>提醒一下，以下是Spring <code>Ordered</code>接口的语义：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Ordered</span> {

    <span class="hljs-comment">/**
     * 最高优先级值的常量。
     * <span class="hljs-doctag">@see</span> java.lang.Integer#MIN_VALUE
     */</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">HIGHEST_PRECEDENCE</span> <span class="hljs-operator">=</span> Integer.MIN_VALUE;

    <span class="hljs-comment">/**
     * 最低优先级值的常量。
     * <span class="hljs-doctag">@see</span> java.lang.Integer#MAX_VALUE
     */</span>
    <span class="hljs-type">int</span> <span class="hljs-variable">LOWEST_PRECEDENCE</span> <span class="hljs-operator">=</span> Integer.MAX_VALUE;

    <span class="hljs-comment">/**
     * 获取此对象的顺序值。
     * &lt;p&gt;较高的值被解释为较低的优先级。因此，
     * 具有最低值的对象具有最高优先级（有点类似于Servlet {<span class="hljs-doctag">@code</span> load-on-startup} 值）。
     * &lt;p&gt;相同的顺序值将导致受影响对象的任意排序位置。
     * <span class="hljs-doctag">@return</span> 顺序值
     * <span class="hljs-doctag">@see</span> #HIGHEST_PRECEDENCE
     * <span class="hljs-doctag">@see</span> #LOWEST_PRECEDENCE
     */</span>
    <span class="hljs-type">int</span> <span class="hljs-title function_">getOrder</span><span class="hljs-params">()</span>;
}
</code></pre>
<p><strong>提示：</strong> 对于需要在输入和输出两侧都在链中首位的用例：</p>
<ol>
<li>为每一侧使用单独的advisors。</li>
<li>使用不同的顺序值配置它们。</li>
<li>使用advisor上下文在它们之间共享状态。</li>
</ol>
<h3 data-id="heading-4">API概述</h3>
<p>主要的Advisor接口位于包<code>org.springframework.ai.chat.client.advisor.api</code>中。以下是创建自己的advisor时会遇到的关键接口：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Advisor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Ordered</span> {

	String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span>;

}
</code></pre>
<p>同步和响应式Advisors的两个子接口是：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CallAdvisor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Advisor</span> {

	ChatClientResponse <span class="hljs-title function_">adviseCall</span><span class="hljs-params">(
		ChatClientRequest chatClientRequest, CallAdvisorChain callAdvisorChain)</span>;

}
</code></pre>
<p>和</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">StreamAdvisor</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Advisor</span> {

	Flux&lt;ChatClientResponse&gt; <span class="hljs-title function_">adviseStream</span><span class="hljs-params">(
		ChatClientRequest chatClientRequest, StreamAdvisorChain streamAdvisorChain)</span>;

}
</code></pre>
<p>要继续Advice链，在您的Advice实现中使用<code>CallAdvisorChain</code>和<code>StreamAdvisorChain</code>：</p>
<p>接口是：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CallAdvisorChain</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AdvisorChain</span> {

	<span class="hljs-comment">/**
	 * 使用给定的请求调用链中的下一个{<span class="hljs-doctag">@link</span> CallAdvisor}。
	 */</span>
	ChatClientResponse <span class="hljs-title function_">nextCall</span><span class="hljs-params">(ChatClientRequest chatClientRequest)</span>;

	<span class="hljs-comment">/**
	 * 返回在创建时包含在此链中的所有{<span class="hljs-doctag">@link</span> CallAdvisor}实例的列表。
	 */</span>
	List&lt;CallAdvisor&gt; <span class="hljs-title function_">getCallAdvisors</span><span class="hljs-params">()</span>;

}
</code></pre>
<p>和</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">StreamAdvisorChain</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">AdvisorChain</span> {

	<span class="hljs-comment">/**
	 * 使用给定的请求调用链中的下一个{<span class="hljs-doctag">@link</span> StreamAdvisor}。
	 */</span>
	Flux&lt;ChatClientResponse&gt; <span class="hljs-title function_">nextStream</span><span class="hljs-params">(ChatClientRequest chatClientRequest)</span>;

	<span class="hljs-comment">/**
	 * 返回在创建时包含在此链中的所有{<span class="hljs-doctag">@link</span> StreamAdvisor}实例的列表。
	 */</span>
	List&lt;StreamAdvisor&gt; <span class="hljs-title function_">getStreamAdvisors</span><span class="hljs-params">()</span>;

}
</code></pre>
<h3 data-id="heading-5">实现Advisor</h3>
<p>要创建advisor，实现<code>CallAdvisor</code>或<code>StreamAdvisor</code>（或两者）。要实现的关键方法是用于非流式的<code>nextCall()</code>或用于流式advisors的<code>nextStream()</code>。</p>
<h4 data-id="heading-6">示例</h4>
<p>我们将提供一些动手示例来说明如何实现用于观察和增强用例的advisors。</p>
<h5 data-id="heading-7">日志记录Advisor</h5>
<p>我们可以实现一个简单的日志记录advisor，在调用链中的下一个advisor之前记录<code>ChatClientRequest</code>，之后记录<code>ChatClientResponse</code>。注意advisor只观察请求和响应，不修改它们。此实现支持非流式和流式场景。</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleLoggerAdvisor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CallAdvisor</span>, StreamAdvisor {

	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">Logger</span> <span class="hljs-variable">logger</span> <span class="hljs-operator">=</span> LoggerFactory.getLogger(SimpleLoggerAdvisor.class);

	<span class="hljs-meta">@Override</span>
	<span class="hljs-keyword">public</span> String <span class="hljs-title function_">getName</span><span class="hljs-params">()</span> { <span class="hljs-comment">// 1</span>
		<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.getClass().getSimpleName();
	}

	<span class="hljs-meta">@Override</span>
	<span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOrder</span><span class="hljs-params">()</span> { <span class="hljs-comment">// 2</span>
		<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
	}

	<span class="hljs-meta">@Override</span>
	<span class="hljs-keyword">public</span> ChatClientResponse <span class="hljs-title function_">adviseCall</span><span class="hljs-params">(ChatClientRequest chatClientRequest, CallAdvisorChain callAdvisorChain)</span> {
		logRequest(chatClientRequest);

		<span class="hljs-type">ChatClientResponse</span> <span class="hljs-variable">chatClientResponse</span> <span class="hljs-operator">=</span> callAdvisorChain.nextCall(chatClientRequest);

		logResponse(chatClientResponse);

		<span class="hljs-keyword">return</span> chatClientResponse;
	}

	<span class="hljs-meta">@Override</span>
	<span class="hljs-keyword">public</span> Flux&lt;ChatClientResponse&gt; <span class="hljs-title function_">adviseStream</span><span class="hljs-params">(ChatClientRequest chatClientRequest,
			StreamAdvisorChain streamAdvisorChain)</span> {
		logRequest(chatClientRequest);

		Flux&lt;ChatClientResponse&gt; chatClientResponses = streamAdvisorChain.nextStream(chatClientRequest);

		<span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChatClientMessageAggregator</span>().aggregateChatClientResponse(chatClientResponses, <span class="hljs-built_in">this</span>::logResponse); <span class="hljs-comment">// 3</span>
	}

	<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logRequest</span><span class="hljs-params">(ChatClientRequest request)</span> {
		logger.debug(<span class="hljs-string">"request: {}"</span>, request);
	}

	<span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logResponse</span><span class="hljs-params">(ChatClientResponse chatClientResponse)</span> {
		logger.debug(<span class="hljs-string">"response: {}"</span>, chatClientResponse);
	}

}
</code></pre>
<ol>
<li>为advisor提供唯一名称。</li>
<li>您可以通过设置顺序值来控制执行顺序。较低的值首先执行。</li>
<li><code>MessageAggregator</code>是一个实用程序类，将Flux响应聚合到单个ChatClientResponse中。这对于观察整个响应而不是流中的单个项目的日志记录或其他处理很有用。请注意，您不能在<code>MessageAggregator</code>中更改响应，因为它是只读操作。</li>
</ol>
<h5 data-id="heading-8">重读（Re2）Advisor</h5>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2309.06275" target="_blank" title="https://arxiv.org/pdf/2309.06275" ref="nofollow noopener noreferrer">"重新阅读改进大语言模型中的推理"</a>文章介绍了一种称为重新阅读（Re2）的技术，改进了大语言模型的推理能力。Re2技术需要像这样增强输入提示：</p>
<pre><code class="hljs language-css" lang="css">{Input_Query}
Read the question again: {Input_Query}
</code></pre>
<p>实现将Re2技术应用于用户输入查询的advisor可以这样做：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ReReadingAdvisor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BaseAdvisor</span> {

	<span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">DEFAULT_RE2_ADVISE_TEMPLATE</span> <span class="hljs-operator">=</span> <span class="hljs-string">"""
			{re2_input_query}
			Read the question again: {re2_input_query}
			"""</span>;

	<span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String re2AdviseTemplate;

	<span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-variable">order</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;

	<span class="hljs-keyword">public</span> <span class="hljs-title function_">ReReadingAdvisor</span><span class="hljs-params">()</span> {
		<span class="hljs-built_in">this</span>(DEFAULT_RE2_ADVISE_TEMPLATE);
	}

	<span class="hljs-keyword">public</span> <span class="hljs-title function_">ReReadingAdvisor</span><span class="hljs-params">(String re2AdviseTemplate)</span> {
		<span class="hljs-built_in">this</span>.re2AdviseTemplate = re2AdviseTemplate;
	}

	<span class="hljs-meta">@Override</span>
	<span class="hljs-keyword">public</span> ChatClientRequest <span class="hljs-title function_">before</span><span class="hljs-params">(ChatClientRequest chatClientRequest, AdvisorChain advisorChain)</span> { <span class="hljs-comment">// 1</span>
		<span class="hljs-type">String</span> <span class="hljs-variable">augmentedUserText</span> <span class="hljs-operator">=</span> PromptTemplate.builder()
			.template(<span class="hljs-built_in">this</span>.re2AdviseTemplate)
			.variables(Map.of(<span class="hljs-string">"re2_input_query"</span>, chatClientRequest.prompt().getUserMessage().getText()))
			.build()
			.render();

		<span class="hljs-keyword">return</span> chatClientRequest.mutate()
			.prompt(chatClientRequest.prompt().augmentUserMessage(augmentedUserText))
			.build();
	}

	<span class="hljs-meta">@Override</span>
	<span class="hljs-keyword">public</span> ChatClientResponse <span class="hljs-title function_">after</span><span class="hljs-params">(ChatClientResponse chatClientResponse, AdvisorChain advisorChain)</span> {
		<span class="hljs-keyword">return</span> chatClientResponse;
	}

	<span class="hljs-meta">@Override</span>
	<span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getOrder</span><span class="hljs-params">()</span> { <span class="hljs-comment">// 2</span>
		<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.order;
	}

	<span class="hljs-keyword">public</span> ReReadingAdvisor <span class="hljs-title function_">withOrder</span><span class="hljs-params">(<span class="hljs-type">int</span> order)</span> {
		<span class="hljs-built_in">this</span>.order = order;
		<span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;
	}

}
</code></pre>
<ol>
<li><code>before</code>方法应用重新阅读技术增强用户的输入查询。</li>
<li>您可以通过设置顺序值来控制执行顺序。较低的值首先执行。</li>
</ol>
<h5 data-id="heading-9">Spring AI内置Advisors</h5>
<p>Spring AI框架提供几个内置的advisors来增强您的AI交互。以下是可用advisors的概述：</p>
<h6 data-id="heading-10">聊天记忆Advisors</h6>
<p>这些advisors在聊天记忆存储中管理对话历史：</p>
<ul>
<li>
<p><code>MessageChatMemoryAdvisor</code></p>
<p>检索记忆并将其作为消息集合添加到提示中。这种方法保持对话历史的结构。注意，并非所有AI模型都支持这种方法。</p>
</li>
<li>
<p><code>PromptChatMemoryAdvisor</code></p>
<p>检索记忆并将其合并到提示的系统文本中。</p>
</li>
<li>
<p><code>VectorStoreChatMemoryAdvisor</code></p>
<p>从VectorStore检索记忆并将其添加到提示的系统文本中。此advisor有助于高效搜索和检索大型数据集中的相关信息。</p>
</li>
</ul>
<h6 data-id="heading-11">问答Advisor</h6>
<ul>
<li>
<p><code>QuestionAnswerAdvisor</code></p>
<p>此advisor使用向量存储提供问答能力，实现朴素RAG（检索增强生成）模式。</p>
</li>
<li>
<p><code>RetrievalAugmentationAdvisor</code></p>
<p>Advisor使用<code>org.springframework.ai.rag</code>包中定义的构建块实现常见的检索增强生成（RAG）流程，遵循模块化RAG架构。</p>
</li>
</ul>
<h6 data-id="heading-12">推理Advisor</h6>
<ul>
<li>
<p><code>ReReadingAdvisor</code></p>
<p>为LLM推理实现重新阅读策略，称为RE2，以增强输入阶段的理解。基于文章：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fpdf%2F2309.06275" target="_blank" title="https://arxiv.org/pdf/2309.06275" ref="nofollow noopener noreferrer">重新阅读改进LLMs中的推理</a>。</p>
</li>
</ul>
<h6 data-id="heading-13">内容安全Advisor</h6>
<ul>
<li>
<p><code>SafeGuardAdvisor</code></p>
<p>一个简单的advisor，旨在防止模型生成有害或不当内容。</p>
</li>
</ul>
<h4 data-id="heading-14">流式与非流式</h4>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/08a1eb0da1d74f37af057613afc519cb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5ZC056WW6LSk:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763452770&amp;x-signature=3PGbA8qLwXfma1elPWZuJHHSWc0%3D" alt="Advisors Streaming vs Non-Streaming Flow" loading="lazy"/></p>
<ul>
<li>非流式advisors处理完整的请求和响应。</li>
<li>流式advisors将请求和响应作为连续流处理，使用响应式编程概念（例如，响应使用Flux）。</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Override</span>
<span class="hljs-keyword">public</span> Flux&lt;ChatClientResponse&gt; <span class="hljs-title function_">adviseStream</span><span class="hljs-params">(ChatClientRequest chatClientRequest, StreamAdvisorChain chain)</span> {

    <span class="hljs-keyword">return</span>  Mono.just(chatClientRequest)
            .publishOn(Schedulers.boundedElastic())
            .map(request -&gt; {
                <span class="hljs-comment">// 这可以由阻塞和非阻塞线程执行。</span>
                <span class="hljs-comment">// Advisor在next部分之前</span>
            })
            .flatMapMany(request -&gt; chain.nextStream(request))
            .map(response -&gt; {
                <span class="hljs-comment">// Advisor在next部分之后</span>
            });
}
</code></pre>
<h4 data-id="heading-15">最佳实践</h4>
<ol>
<li>保持advisors专注于特定任务以获得更好的模块化。</li>
<li>必要时使用<code>adviseContext</code>在advisors之间共享状态。</li>
<li>为最大灵活性实现advisor的流式和非流式版本。</li>
<li>仔细考虑链中advisors的顺序以确保正确的数据流。</li>
</ol>
<h3 data-id="heading-16">破坏性API更改</h3>
<h4 data-id="heading-17">Advisor接口</h4>
<ul>
<li>在1.0 M2中，有单独的<code>RequestAdvisor</code>和<code>ResponseAdvisor</code>接口。
<ul>
<li><code>RequestAdvisor</code>在<code>ChatModel.call</code>和<code>ChatModel.stream</code>方法之前调用。</li>
<li><code>ResponseAdvisor</code>在这些方法之后调用。</li>
</ul>
</li>
<li>在1.0 M3中，这些接口已被替换为：
<ul>
<li><code>CallAroundAdvisor</code></li>
<li><code>StreamAroundAdvisor</code></li>
</ul>
</li>
<li>以前是<code>ResponseAdvisor</code>一部分的<code>StreamResponseMode</code>已被删除。</li>
<li>在1.0.0中，这些接口已被替换：
<ul>
<li><code>CallAroundAdvisor</code> → <code>CallAdvisor</code>，<code>StreamAroundAdvisor</code> → <code>StreamAdvisor</code>，<code>CallAroundAdvisorChain</code> → <code>CallAdvisorChain</code>和<code>StreamAroundAdvisorChain</code> → <code>StreamAdvisorChain</code>。</li>
<li><code>AdvisedRequest</code> → <code>ChatClientRequest</code>和<code>AdvisedResponse</code> → <code>ChatClientResponse</code>。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-18">上下文映射处理</h4>
<ul>
<li>在1.0 M2中：
<ul>
<li>上下文映射是单独的方法参数。</li>
<li>映射是可变的并沿链传递。</li>
</ul>
</li>
<li>在1.0 M3中：
<ul>
<li>上下文映射现在是<code>AdvisedRequest</code>和<code>AdvisedResponse</code>记录的一部分。</li>
<li>映射是不可变的。</li>
<li>要更新上下文，使用<code>updateContext</code>方法，该方法创建一个具有更新内容的新不可修改映射。</li>
</ul>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[1. 让自己习惯cpp]]></title>    <link>https://juejin.cn/post/7571028035018948634</link>    <guid>https://juejin.cn/post/7571028035018948634</guid>    <pubDate>2025-11-11T06:43:36.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571028035018948634" data-draft-id="7568710909313794086" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="1. 让自己习惯cpp"/> <meta itemprop="keywords" content="C++"/> <meta itemprop="datePublished" content="2025-11-11T06:43:36.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="程序猿本员"/> <meta itemprop="url" content="https://juejin.cn/user/3868510676597259"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            1. 让自己习惯cpp
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3868510676597259/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    程序猿本员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T06:43:36.000Z" title="Tue Nov 11 2025 06:43:36 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">小结</h2>
<blockquote>
<ol>
<li>本章是站在全局角度来看待的cpp，介绍了cpp是一个语言联邦，特性可能由于次语言不同而不同</li>
<li>尽量使用编译器而不是预处理器，使用constexpr、const、enum、inline来替代#define</li>
<li>确定对象被使用前已经被初始化，且注意non-local static多编译单元初始化顺序不确定性</li>
</ol>
</blockquote>
<h2 data-id="heading-1">条款 01:视 C++为一个语言联邦</h2>
<ol>
<li>cpp内部包含四个次语言，<strong>c、object c++（也就是面向对象那一套）、template c++（泛型编程、模板元编程）以及STL</strong></li>
<li>每个次语言的规则以及特性有所不同，比如c中内置类型pass-by-value比pass-by-reference更高效</li>
</ol>
<blockquote>
<ol>
<li>
<p>所以并不是pass-by-reference永远是最优的，因为如果是传递的reference，就会涉及到一步”解引用“，每次读取需要去解引用读取真实值，而对于”轻对象“，直接传递值，操作就是直接对数据操作，且可能因为是在栈上而使用缓存加速机制</p>
</li>
<li>
<p>适合pass-by-value的情况：</p>
</li>
</ol>
<ul>
<li>
<p>不希望形态的改变影响实参</p>
</li>
<li>
<p>传递的是”轻对象“，复制成本 ≤ 指针大小（如 <code>int</code>、<code>double</code>、<code>迭代器</code>、<code>空函数对象</code>）</p>
</li>
<li>
<p><strong>移动语义</strong>，就需要使用到移动拷贝构造，所以需要pass-by-value</p>
</li>
<li>
<p><strong>迭代器</strong>，因为逻辑上等价于”指针“，所以指针应该是使用pass-by-value；</p>
</li>
</ul>
<ol start="3">
<li>
<p>不适合pass-by-value的情况：</p>
</li>
</ol>
<ul>
<li>需要使用多态，如果还是传value，则会出现对象切片</li>
</ul>
</blockquote>
<h2 data-id="heading-2">条款 02:尽量以const,enum, inline 替换 #define</h2>
<h3 data-id="heading-3">define定义常量</h3>
<ol>
<li>可以使用<code>全局const常变量</code>来代替，如<code>#define PI 3.14 ==&gt; int const Pi = 3.14</code>,是该定义（包括指针常量）是可以出现在头文件的，因为此时变量没有共享性，但是如果又有<code>extern</code>修饰，就具有共享性，不能违反单一定义原则</li>
</ol>
<blockquote>
<p><code>constexpr</code>是比<code>const</code>更严格的，后者声明的变量如果取地址则不能用来指定数组大小，而前者要求-   必须在编译期就能确定其值，且可用来指定函数，要求该函数在编译期也能调用</p>
</blockquote>
<ol start="2">
<li>在类中，如果需要<code>#define</code>定义的常量，则可以使用<code>static const int n = 10;</code>来代替，可以不在外面重新定义，此时编译器会把n作为编译时常量来对待，即可用于声明数组个数</li>
<li><strong>enum hack</strong>,一个属于枚举类型的数值可权充int使用，这样可以实现一个专属于某一个类的编译器常量
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/63333893723a4eaaa2779a8d4ade2698~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg56iL5bqP54y_5pys5ZGY:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763448215&amp;x-signature=c7ysXLl9mmuUwD1umqIc3ob%2Bg6o%3D" alt="image.png" loading="lazy"/></li>
</ol>
<h3 data-id="heading-4">define定义函数</h3>
<ol>
<li>即使加上了括号，如果传入i++基本都会出问题</li>
<li>使用inline+template来替代宏函数</li>
</ol>
<h2 data-id="heading-5">条款 03:尽可能使用const</h2>
<h3 data-id="heading-6">const与对象</h3>
<ol>
<li><code>const A a;</code>，对象a直接访问非<code>mutable</code>成员数据修改或调用成员方法修改，都是不行的</li>
<li>调用的成员方法是const修饰的，否则会报错</li>
</ol>
<h3 data-id="heading-7">const与迭代器</h3>
<ol>
<li><code>const vector&lt;int&gt;::iterator iter = vec.begin()</code>，声明iter本身是不变的，</li>
<li><code>const_iterator iter</code>是声明iter指向的对象不可变化</li>
</ol>
<h3 data-id="heading-8">const与函数声明</h3>
<ol>
<li>const与返回值,比如<code>operator*()</code>最好返回const，避免用户代码<code>if((a*b)=c)</code></li>
<li>const与参数，如果内部不需要修改该参数，尽量使用const修饰</li>
</ol>
<h3 data-id="heading-9">const与成员函数</h3>
<ol>
<li>原因：外部如果是const声明的对象，调用的方法就是const修饰的，const成员变量是声明不会改变对象内部非<code>mutable</code>数据成员的</li>
<li>其实const修饰的是参数this</li>
<li>同时const修饰底层指针，会构成重载，non-const优先调用non-const成员函数，const只能调用const成员函数，也就是<strong>成员函数有const修饰会重载</strong></li>
<li><strong>bitwise const</strong>是对象占据的内存值不会发生改变，cpp中对于const就是这样想的</li>
<li><strong>logic const</strong>是能修改<code>mutable</code>修饰的成员</li>
<li>尽量使用non-const调用const成员函数，来减少重复代码</li>
</ol>
<h2 data-id="heading-10">条款 04:确定对象被使用前已先被初始化</h2>
<ol>
<li>c-part-of-cpp 是不会初始化的（比如array），而其他部分是会初始化数据的（比如vector）</li>
<li>对象数据成员的初始化发生在进入构造函数本体之前，构造函数本体都是赋值</li>
<li><strong>在初始化列表中列出所有数据成员</strong></li>
<li>static变量是存储在数据区，而不是heap、stack</li>
<li><code>local static object</code>是指函数中声明定义的static变量，会在程序启动时就在数据区分配空间，初次运行到定义处进行初始化，线程安全</li>
<li><code>non-local static object</code>，包含全局static、类中static以及命名空间内的static，在main运行前初始化，但是存在<strong>跨编译单元初始化顺序不确定</strong>问题，解决方案是用local static替换non-local static</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[NestJS 集成 RabbitMQ（CloudAMQP）实战指南]]></title>    <link>https://juejin.cn/post/7571051830711042098</link>    <guid>https://juejin.cn/post/7571051830711042098</guid>    <pubDate>2025-11-11T08:08:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571051830711042098" data-draft-id="7571191453125345306" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="NestJS 集成 RabbitMQ（CloudAMQP）实战指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T08:08:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="zyb_123456"/> <meta itemprop="url" content="https://juejin.cn/user/475457668781895"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            NestJS 集成 RabbitMQ（CloudAMQP）实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/475457668781895/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    zyb_123456
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T08:08:03.000Z" title="Tue Nov 11 2025 08:08:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">NestJS 集成 RabbitMQ（CloudAMQP）实战指南</h2>
<blockquote>
<p>目标：让你在 <strong>15~30 分钟</strong> 内，亲手完成一个“定时扫描 → 发布事件 → 消费并发送邮件通知”的完整 MQ 流程。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">1. 准备工作</h3>
<h4 data-id="heading-2">1.1 账号 &amp; 环境</h4>
<ul>
<li>Node.js ≥ 18.x（建议 20.x）</li>
<li>Nest CLI：<code>npm i -g @nestjs/cli</code></li>
<li>Git、VS Code 等基础工具</li>
</ul>
<h4 data-id="heading-3">1.2 云服务账号</h4>























<table><thead><tr><th>服务</th><th>用途</th><th>免费层</th><th>说明</th></tr></thead><tbody><tr><td>CloudAMQP</td><td>托管 RabbitMQ 队列</td><td>✅</td><td>选 “Little Lemur”</td></tr><tr><td>QQ / Gmail</td><td>SMTP 发件人（可选）</td><td>✅</td><td>用于邮件提醒，可使用自定义 SMTP</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-4">2. 创建 CloudAMQP 实例</h3>
<ol>
<li>访问 <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.cloudamqp.com%2F" target="_blank" title="https://www.cloudamqp.com/" ref="nofollow noopener noreferrer">www.cloudamqp.com/</a> 注册并登录</li>
<li><code>Create new instance</code> → 选择 “Little Lemur” → 选择离你最近的 Region</li>
<li>创建成功后，在实例详情页找到 <code>AMQP URL</code>，格式类似：
<pre><code class="hljs language-perl" lang="perl">amqps:<span class="hljs-regexp">//</span>用户名:密码@host/vhost
</code></pre>
这就是后端连接 RabbitMQ 所需的 Connection String。</li>
</ol>
<hr/>
<h3 data-id="heading-5">3. 搭建 Nest 项目骨架</h3>
<pre><code class="hljs language-bash" lang="bash">nest new nest-mq-demo
<span class="hljs-built_in">cd</span> nest-mq-demo
npm install @nestjs/microservices amqplib amqp-connection-manager
npm install nodemailer @nestjs/schedule
</code></pre>
<p>目录结构（简化）：</p>
<pre><code class="hljs language-arduino" lang="arduino">src
├── app.<span class="hljs-keyword">module</span>.ts
├── main.ts
└── modules
    └── notifications
        ├── notifications.<span class="hljs-keyword">module</span>.ts
        ├── notification-producer.service.ts
        ├── notification-consumer.service.ts
        ├── notification-scanner.service.ts
        └── email.service.ts
</code></pre>
<hr/>
<h3 data-id="heading-6">4. 配置环境变量</h3>
<p><code>config/local.env.example</code>（参考）：</p>
<pre><code class="hljs language-dotenv" lang="dotenv">RABBITMQ_URL=amqps://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;/&lt;vhost&gt;
RABBITMQ_NOTIFICATION_QUEUE=notifications

NOTIFICATION_EMAIL_ENABLED=true
NOTIFICATION_LEAD_DAYS=3
NOTIFICATION_EMAIL_RECIPIENTS=you@example.com

MAIL_HOST=smtp.qq.com
MAIL_PORT=465
MAIL_SECURE=true
MAIL_USER=you@qq.com
MAIL_PASS=&lt;QQ邮箱授权码&gt;
MAIL_FROM=Housekeeper &lt;you@qq.com&gt;
</code></pre>
<blockquote>
<p>QQ 邮箱需要在“设置 → 账户 → POP3/SMTP” 中开启服务并获取授权码。</p>
</blockquote>
<hr/>
<h3 data-id="heading-7">5. 配置中心：<code>config/configuration.ts</code></h3>
<p>为了统一读取配置，建议在 <code>config/configuration.ts</code> 中扩展配置项：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { registerAs } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> appConfig = <span class="hljs-title function_">registerAs</span>(<span class="hljs-string">'app'</span>, <span class="hljs-function">() =&gt;</span> ({
  <span class="hljs-attr">rabbitmq</span>: {
    <span class="hljs-attr">url</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">RABBITMQ_URL</span>!,
    <span class="hljs-attr">notificationQueue</span>:
      process.<span class="hljs-property">env</span>.<span class="hljs-property">RABBITMQ_NOTIFICATION_QUEUE</span> ?? <span class="hljs-string">'notifications'</span>,
  },
  <span class="hljs-attr">notification</span>: {
    <span class="hljs-attr">emailEnabled</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">NOTIFICATION_EMAIL_ENABLED</span> !== <span class="hljs-string">'false'</span>,
    <span class="hljs-attr">leadDays</span>: <span class="hljs-built_in">parseInt</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">NOTIFICATION_LEAD_DAYS</span> ?? <span class="hljs-string">'3'</span>, <span class="hljs-number">10</span>),
    <span class="hljs-attr">recipients</span>: (process.<span class="hljs-property">env</span>.<span class="hljs-property">NOTIFICATION_EMAIL_RECIPIENTS</span> ?? <span class="hljs-string">''</span>)
      .<span class="hljs-title function_">split</span>(<span class="hljs-string">','</span>)
      .<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-title function_">trim</span>())
      .<span class="hljs-title function_">filter</span>(<span class="hljs-title class_">Boolean</span>),
  },
  <span class="hljs-attr">mail</span>: {
    <span class="hljs-attr">host</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">MAIL_HOST</span> ?? <span class="hljs-string">''</span>,
    <span class="hljs-attr">port</span>: <span class="hljs-built_in">parseInt</span>(process.<span class="hljs-property">env</span>.<span class="hljs-property">MAIL_PORT</span> ?? <span class="hljs-string">'465'</span>, <span class="hljs-number">10</span>),
    <span class="hljs-attr">secure</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">MAIL_SECURE</span> !== <span class="hljs-string">'false'</span>,
    <span class="hljs-attr">user</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">MAIL_USER</span> ?? <span class="hljs-string">''</span>,
    <span class="hljs-attr">pass</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">MAIL_PASS</span> ?? <span class="hljs-string">''</span>,
    <span class="hljs-attr">from</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">MAIL_FROM</span> ?? <span class="hljs-string">'no-reply@example.com'</span>,
  },
}));
</code></pre>
<hr/>
<h3 data-id="heading-8">6. App 模块 &amp; 主程序</h3>
<h4 data-id="heading-9">6.1 <code>app.module.ts</code></h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigModule</span>, <span class="hljs-title class_">ConfigService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TypeOrmModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/typeorm'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ScheduleModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/schedule'</span>;
<span class="hljs-keyword">import</span> configuration <span class="hljs-keyword">from</span> <span class="hljs-string">'./config/configuration'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NotificationsModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./modules/notifications/notifications.module'</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [
    <span class="hljs-title class_">ConfigModule</span>.<span class="hljs-title function_">forRoot</span>({ <span class="hljs-attr">isGlobal</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">load</span>: [configuration] }),
    <span class="hljs-title class_">ScheduleModule</span>.<span class="hljs-title function_">forRoot</span>(),
    <span class="hljs-title class_">TypeOrmModule</span>.<span class="hljs-title function_">forRoot</span>({ <span class="hljs-comment">/* ...数据库配置... */</span> }),
    <span class="hljs-title class_">NotificationsModule</span>,
    <span class="hljs-comment">// 其他业务模块...</span>
  ],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppModule</span> {}
</code></pre>
<h4 data-id="heading-10">6.2 <code>main.ts</code></h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">NestFactory</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/core'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NestExpressApplication</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/platform-express'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Logger</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Transport</span>, <span class="hljs-title class_">MicroserviceOptions</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/microservices'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppConfigType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./config/configuration'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./app.module'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">bootstrap</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> app = <span class="hljs-keyword">await</span> <span class="hljs-title class_">NestFactory</span>.<span class="hljs-property">create</span>&lt;<span class="hljs-title class_">NestExpressApplication</span>&gt;(<span class="hljs-title class_">AppModule</span>);

  <span class="hljs-keyword">const</span> configService = app.<span class="hljs-property">get</span>&lt;<span class="hljs-title class_">ConfigService</span>&lt;{ <span class="hljs-attr">app</span>: <span class="hljs-title class_">AppConfigType</span> }, <span class="hljs-literal">true</span>&gt;&gt;(
    <span class="hljs-title class_">ConfigService</span>,
  );
  <span class="hljs-keyword">const</span> appConfig = configService.<span class="hljs-property">getOrThrow</span>&lt;<span class="hljs-title class_">AppConfigType</span>&gt;(<span class="hljs-string">'app'</span>);

  <span class="hljs-keyword">const</span> <span class="hljs-attr">microserviceOptions</span>: <span class="hljs-title class_">MicroserviceOptions</span> = {
    <span class="hljs-attr">transport</span>: <span class="hljs-title class_">Transport</span>.<span class="hljs-property">RMQ</span>,
    <span class="hljs-attr">options</span>: {
      <span class="hljs-attr">urls</span>: [appConfig.<span class="hljs-property">rabbitmq</span>.<span class="hljs-property">url</span>],
      <span class="hljs-attr">queue</span>: appConfig.<span class="hljs-property">rabbitmq</span>.<span class="hljs-property">notificationQueue</span>,
      <span class="hljs-attr">queueOptions</span>: { <span class="hljs-attr">durable</span>: <span class="hljs-literal">true</span> },
    },
  };

  app.<span class="hljs-property">connectMicroservice</span>&lt;<span class="hljs-title class_">MicroserviceOptions</span>&gt;(microserviceOptions);

  <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">startAllMicroservices</span>();
  <span class="hljs-keyword">await</span> app.<span class="hljs-title function_">listen</span>(appConfig.<span class="hljs-property">port</span> ?? <span class="hljs-number">3000</span>);

  <span class="hljs-title class_">Logger</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Notification microservice connected to RabbitMQ'</span>);
}

<span class="hljs-title function_">bootstrap</span>();
</code></pre>
<hr/>
<h3 data-id="heading-11">7. Notifications 模块实现</h3>
<h4 data-id="heading-12">7.1 <code>notifications.module.ts</code></h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Module</span>, <span class="hljs-title class_">Controller</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ClientProxyFactory</span>, <span class="hljs-title class_">Transport</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/microservices'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigModule</span>, <span class="hljs-title class_">ConfigService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">TypeOrmModule</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/typeorm'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Stock</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../stock/entities/stock.entity'</span>;   <span class="hljs-comment">// 示例实体</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NotificationProducerService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./notification-producer.service'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NotificationConsumerService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./notification-consumer.service'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">EmailService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./email.service'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NotificationScannerService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./notification-scanner.service'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppConfigType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../config/configuration'</span>;

<span class="hljs-meta">@Module</span>({
  <span class="hljs-attr">imports</span>: [
    <span class="hljs-title class_">ConfigModule</span>,
    <span class="hljs-title class_">TypeOrmModule</span>.<span class="hljs-title function_">forFeature</span>([<span class="hljs-title class_">Stock</span> <span class="hljs-comment">/*, Item, Location ... */</span>]),
  ],
  <span class="hljs-attr">controllers</span>: [<span class="hljs-title class_">NotificationConsumerService</span>],
  <span class="hljs-attr">providers</span>: [
    {
      <span class="hljs-attr">provide</span>: <span class="hljs-string">'NOTIFICATION_QUEUE'</span>,
      <span class="hljs-attr">inject</span>: [<span class="hljs-title class_">ConfigService</span>],
      <span class="hljs-attr">useFactory</span>: <span class="hljs-function">(<span class="hljs-params">config: ConfigService&lt;{ app: AppConfigType }, <span class="hljs-literal">true</span>&gt;</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> appConfig = config.<span class="hljs-property">getOrThrow</span>&lt;<span class="hljs-title class_">AppConfigType</span>&gt;(<span class="hljs-string">'app'</span>);
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">ClientProxyFactory</span>.<span class="hljs-title function_">create</span>({
          <span class="hljs-attr">transport</span>: <span class="hljs-title class_">Transport</span>.<span class="hljs-property">RMQ</span>,
          <span class="hljs-attr">options</span>: {
            <span class="hljs-attr">urls</span>: [appConfig.<span class="hljs-property">rabbitmq</span>.<span class="hljs-property">url</span>],
            <span class="hljs-attr">queue</span>: appConfig.<span class="hljs-property">rabbitmq</span>.<span class="hljs-property">notificationQueue</span>,
            <span class="hljs-attr">queueOptions</span>: { <span class="hljs-attr">durable</span>: <span class="hljs-literal">true</span> },
          },
        });
      },
    },
    <span class="hljs-title class_">NotificationProducerService</span>,
    <span class="hljs-title class_">EmailService</span>,
    <span class="hljs-title class_">NotificationScannerService</span>,
  ],
  <span class="hljs-attr">exports</span>: [<span class="hljs-title class_">NotificationProducerService</span>, <span class="hljs-title class_">NotificationScannerService</span>],
})
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NotificationsModule</span> {}
</code></pre>
<h4 data-id="heading-13">7.2 事件定义 &amp; 生产者</h4>
<p><code>notification-producer.service.ts</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Inject</span>, <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">Logger</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ClientProxy</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/microservices'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">StockNotificationEvent</span> {
  <span class="hljs-attr">stockId</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">itemName</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">quantity</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">minQuantity</span>: <span class="hljs-built_in">number</span>;
  <span class="hljs-attr">expiryDate</span>: <span class="hljs-built_in">string</span> | <span class="hljs-literal">null</span>;
  <span class="hljs-attr">type</span>: <span class="hljs-string">'low_stock'</span> | <span class="hljs-string">'near_expiry'</span>;
  <span class="hljs-attr">detectedAt</span>: <span class="hljs-built_in">string</span>;
}

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NotificationProducerService</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> logger = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Logger</span>(<span class="hljs-title class_">NotificationProducerService</span>.<span class="hljs-property">name</span>);

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-meta">@Inject</span>(<span class="hljs-string">'NOTIFICATION_QUEUE'</span>) <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> client: ClientProxy,
  </span>) {}

  <span class="hljs-title function_">publish</span>(<span class="hljs-attr">event</span>: <span class="hljs-title class_">StockNotificationEvent</span>): <span class="hljs-built_in">void</span> {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">client</span>.<span class="hljs-property">emit</span>&lt;<span class="hljs-title class_">StockNotificationEvent</span>&gt;(<span class="hljs-string">'notifications.stock'</span>, event);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">debug</span>(
      <span class="hljs-string">`Published notification event for stock <span class="hljs-subst">${event.stockId}</span>: <span class="hljs-subst">${event.<span class="hljs-keyword">type</span>}</span>`</span>,
    );
  }
}
</code></pre>
<h4 data-id="heading-14">7.3 消费者（事件处理器）</h4>
<p><code>notification-consumer.service.ts</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Controller</span>, <span class="hljs-title class_">Logger</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">EventPattern</span>, <span class="hljs-title class_">Payload</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/microservices'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">StockNotificationEvent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./notification-producer.service'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">EmailService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./email.service'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppConfigType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../config/configuration'</span>;

<span class="hljs-meta">@Controller</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NotificationConsumerService</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> logger = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Logger</span>(<span class="hljs-title class_">NotificationConsumerService</span>.<span class="hljs-property">name</span>);
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">emailEnabled</span>: <span class="hljs-built_in">boolean</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">recipients</span>: <span class="hljs-built_in">string</span>[];

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    configService: ConfigService&lt;{ app: AppConfigType }, <span class="hljs-literal">true</span>&gt;,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> emailService: EmailService,
  </span>) {
    <span class="hljs-keyword">const</span> appConfig = configService.<span class="hljs-property">getOrThrow</span>&lt;<span class="hljs-title class_">AppConfigType</span>&gt;(<span class="hljs-string">'app'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">emailEnabled</span> = appConfig.<span class="hljs-property">notification</span>.<span class="hljs-property">emailEnabled</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">recipients</span> = appConfig.<span class="hljs-property">notification</span>.<span class="hljs-property">recipients</span>;
  }

  <span class="hljs-meta">@EventPattern</span>(<span class="hljs-string">'notifications.stock'</span>)
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">handleStockNotification</span>(
    <span class="hljs-meta">@Payload</span>() <span class="hljs-attr">event</span>: <span class="hljs-title class_">StockNotificationEvent</span>,
  ): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">log</span>(
      <span class="hljs-string">`Received notification for stock <span class="hljs-subst">${event.stockId}</span>: <span class="hljs-subst">${event.<span class="hljs-keyword">type</span>}</span>`</span>,
    );

    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">emailEnabled</span> || !<span class="hljs-variable language_">this</span>.<span class="hljs-property">recipients</span>.<span class="hljs-property">length</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">emailService</span>.<span class="hljs-title function_">sendStockNotification</span>(event, <span class="hljs-variable language_">this</span>.<span class="hljs-property">recipients</span>);
  }
}
</code></pre>
<h4 data-id="heading-15">7.4 邮件服务</h4>
<p><code>email.service.ts</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">Logger</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;
<span class="hljs-keyword">import</span> * <span class="hljs-keyword">as</span> nodemailer <span class="hljs-keyword">from</span> <span class="hljs-string">'nodemailer'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">Transporter</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'nodemailer'</span>;
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">StockNotificationEvent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./notification-producer.service'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppConfigType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../config/configuration'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EmailService</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> logger = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Logger</span>(<span class="hljs-title class_">EmailService</span>.<span class="hljs-property">name</span>);
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> transporter?: <span class="hljs-title class_">Transporter</span>;
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">from</span>: <span class="hljs-built_in">string</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">configService: ConfigService&lt;{ app: AppConfigType }, <span class="hljs-literal">true</span>&gt;</span>) {
    <span class="hljs-keyword">const</span> appConfig = configService.<span class="hljs-property">getOrThrow</span>&lt;<span class="hljs-title class_">AppConfigType</span>&gt;(<span class="hljs-string">'app'</span>);
    <span class="hljs-keyword">const</span> { host, port, secure, user, pass, <span class="hljs-keyword">from</span> } = appConfig.<span class="hljs-property">mail</span>;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">from</span> = <span class="hljs-keyword">from</span>;

    <span class="hljs-keyword">if</span> (!host || !user || !pass) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'Mail service not configured, skip sending'</span>);
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">transporter</span> = nodemailer.<span class="hljs-title function_">createTransport</span>({
      host,
      port,
      secure,
      <span class="hljs-attr">auth</span>: { user, pass },
    });
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">sendStockNotification</span>(
    <span class="hljs-attr">event</span>: <span class="hljs-title class_">StockNotificationEvent</span>,
    <span class="hljs-attr">recipients</span>: <span class="hljs-built_in">string</span>[],
  ): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">transporter</span>) <span class="hljs-keyword">return</span>;

    <span class="hljs-keyword">const</span> subject =
      event.<span class="hljs-property">type</span> === <span class="hljs-string">'low_stock'</span>
        ? <span class="hljs-string">`低库存提醒：<span class="hljs-subst">${event.itemName}</span>`</span>
        : <span class="hljs-string">`临期提醒：<span class="hljs-subst">${event.itemName}</span>`</span>;

    <span class="hljs-keyword">const</span> html = <span class="hljs-string">`
      &lt;p&gt;<span class="hljs-subst">${subject}</span>&lt;/p&gt;
      &lt;ul&gt;
        &lt;li&gt;数量：<span class="hljs-subst">${event.quantity}</span>&lt;/li&gt;
        &lt;li&gt;阈值：<span class="hljs-subst">${event.minQuantity}</span>&lt;/li&gt;
        <span class="hljs-subst">${event.expiryDate ? <span class="hljs-string">`&lt;li&gt;过期：<span class="hljs-subst">${event.expiryDate}</span>&lt;/li&gt;`</span> : <span class="hljs-string">''</span>}</span>
        &lt;li&gt;检测时间：<span class="hljs-subst">${event.detectedAt}</span>&lt;/li&gt;
      &lt;/ul&gt;
    `</span>;

    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">transporter</span>.<span class="hljs-title function_">sendMail</span>({
      <span class="hljs-attr">from</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">from</span>,
      <span class="hljs-attr">to</span>: recipients,
      subject,
      html,
    });

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Notification email sent for <span class="hljs-subst">${event.stockId}</span>`</span>);
  }
}
</code></pre>
<h4 data-id="heading-16">7.5 定时扫描</h4>
<p><code>notification-scanner.service.ts</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">Injectable</span>, <span class="hljs-title class_">Logger</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/common'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Cron</span>, <span class="hljs-title class_">CronExpression</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/schedule'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">InjectRepository</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/typeorm'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Repository</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'typeorm'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">NotificationProducerService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./notification-producer.service'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">Stock</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../stock/entities/stock.entity'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ConfigService</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@nestjs/config'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">AppConfigType</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'../../config/configuration'</span>;

<span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NotificationScannerService</span> {
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> logger = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Logger</span>(<span class="hljs-title class_">NotificationScannerService</span>.<span class="hljs-property">name</span>);
  <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> <span class="hljs-attr">leadDays</span>: <span class="hljs-built_in">number</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-meta">@InjectRepository</span>(Stock)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> stockRepository: Repository&lt;Stock&gt;,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> producerService: NotificationProducerService,
    configService: ConfigService&lt;{ app: AppConfigType }, <span class="hljs-literal">true</span>&gt;,
  </span>) {
    <span class="hljs-keyword">const</span> appConfig = configService.<span class="hljs-property">getOrThrow</span>&lt;<span class="hljs-title class_">AppConfigType</span>&gt;(<span class="hljs-string">'app'</span>);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">leadDays</span> = appConfig.<span class="hljs-property">notification</span>.<span class="hljs-property">leadDays</span>;
  }

  <span class="hljs-meta">@Cron</span>(<span class="hljs-title class_">CronExpression</span>.<span class="hljs-property">EVERY_HOUR</span>)
  <span class="hljs-keyword">async</span> <span class="hljs-title function_">scanAndDispatch</span>(): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">logger</span>.<span class="hljs-title function_">debug</span>(<span class="hljs-string">'Running notification scan'</span>);
    <span class="hljs-keyword">const</span> stocks = <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">stockRepository</span>.<span class="hljs-title function_">find</span>({
      <span class="hljs-attr">relations</span>: [<span class="hljs-string">'item'</span>, <span class="hljs-string">'location'</span>],
    });

    <span class="hljs-keyword">const</span> now = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>();
    <span class="hljs-keyword">const</span> leadDate = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(now);
    leadDate.<span class="hljs-title function_">setDate</span>(now.<span class="hljs-title function_">getDate</span>() + <span class="hljs-variable language_">this</span>.<span class="hljs-property">leadDays</span>);

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> stock <span class="hljs-keyword">of</span> stocks) {
      <span class="hljs-keyword">if</span> (stock.<span class="hljs-property">quantity</span> &lt;= stock.<span class="hljs-property">minQuantity</span>) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">producerService</span>.<span class="hljs-title function_">publish</span>({
          <span class="hljs-attr">stockId</span>: stock.<span class="hljs-property">id</span>,
          <span class="hljs-attr">itemName</span>: stock.<span class="hljs-property">item</span>.<span class="hljs-property">name</span>,
          <span class="hljs-attr">quantity</span>: stock.<span class="hljs-property">quantity</span>,
          <span class="hljs-attr">minQuantity</span>: stock.<span class="hljs-property">minQuantity</span>,
          <span class="hljs-attr">expiryDate</span>: stock.<span class="hljs-property">expiryDate</span>,
          <span class="hljs-attr">type</span>: <span class="hljs-string">'low_stock'</span>,
          <span class="hljs-attr">detectedAt</span>: now.<span class="hljs-title function_">toISOString</span>(),
        });
      }

      <span class="hljs-keyword">if</span> (stock.<span class="hljs-property">expiryDate</span> &amp;&amp; <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(stock.<span class="hljs-property">expiryDate</span>) &lt;= leadDate) {
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">producerService</span>.<span class="hljs-title function_">publish</span>({
          <span class="hljs-attr">stockId</span>: stock.<span class="hljs-property">id</span>,
          <span class="hljs-attr">itemName</span>: stock.<span class="hljs-property">item</span>.<span class="hljs-property">name</span>,
          <span class="hljs-attr">quantity</span>: stock.<span class="hljs-property">quantity</span>,
          <span class="hljs-attr">minQuantity</span>: stock.<span class="hljs-property">minQuantity</span>,
          <span class="hljs-attr">expiryDate</span>: stock.<span class="hljs-property">expiryDate</span>,
          <span class="hljs-attr">type</span>: <span class="hljs-string">'near_expiry'</span>,
          <span class="hljs-attr">detectedAt</span>: now.<span class="hljs-title function_">toISOString</span>(),
        });
      }
    }
  }
}
</code></pre>
<hr/>
<h3 data-id="heading-17">8. 运行验证</h3>
<ol>
<li>
<p><strong>启动服务</strong></p>
<pre><code class="hljs language-bash" lang="bash">npm run start:dev
</code></pre>
<p>控制台应出现：</p>
<pre><code class="hljs language-arduino" lang="arduino">Notification microservice connected to RabbitMQ
</code></pre>
</li>
<li>
<p><strong>准备测试数据</strong><br/>
创建一个库存数量小于阈值的记录，或让 <code>expiryDate</code> 接近当前日期。</p>
</li>
<li>
<p><strong>等待 Cron / 手动扫描</strong></p>
<ul>
<li>当前 Cron 表达式为 <code>EVERY_HOUR</code>，可修改为 <code>EVERY_MINUTE</code> 方便测试。</li>
<li>或在开发环境手动执行：
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">await</span> app.<span class="hljs-title function_">get</span>(<span class="hljs-title class_">NotificationScannerService</span>).<span class="hljs-title function_">scanAndDispatch</span>();
</code></pre>
</li>
</ul>
</li>
<li>
<p><strong>观察日志 &amp; 邮件</strong></p>
<ul>
<li>控制台应依次打印 <code>Published...</code> → <code>Received...</code>。</li>
<li>QQ 邮箱（或指定收件人）应收到提醒邮件。</li>
</ul>
</li>
</ol>
<hr/>
<h3 data-id="heading-18">9. 常见问题排查</h3>





























<table><thead><tr><th>错误信息</th><th>解决方案</th></tr></thead><tbody><tr><td><code>Missing "amqplib" or "amqp-connection-manager"</code></td><td><code>npm install amqplib amqp-connection-manager</code></td></tr><tr><td><code>Error: There is no matching event handler defined...</code></td><td>确认使用 <code>@EventPattern</code>，并且通知服务注册在 Module 的 <code>controllers</code> 中</td></tr><tr><td><code>ECONNREFUSED</code> / <code>CONNECTION_FORCED</code></td><td>检查 CloudAMQP URL、队列名称是否正确；是否超过免费层限制</td></tr><tr><td>邮件发送失败、无日志</td><td>检查 SMTP 配置、授权码；确认 <code>NOTIFICATION_EMAIL_ENABLED</code> 为 <code>true</code>；查看是否进入垃圾邮件</td></tr><tr><td>QQ 邮箱“未启用 STMP”</td><td>在 QQ 邮箱后台开启 POP3/SMTP 服务，获取授权码</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-19">10. 后续扩展建议</h3>
<ul>
<li>引入数据库表记录提醒历史、已读状态；</li>
<li>对接 WebSocket（实时推送到前端）；</li>
<li>在库存更新（采购、使用）处发布事件，替代定时扫描；</li>
<li>使用消息队列的死信队列、重试机制强化可靠性；</li>
<li>将配置拆分到多个配置文件（开发/生产）。</li>
</ul>
<hr/>
<h3 data-id="heading-20">11. 总结</h3>
<p>通过本教程，你完成了：</p>
<ol>
<li>CloudAMQP 实例的创建与连接；</li>
<li>NestJS 微服务（RabbitMQ）消息管道；</li>
<li>定时扫描库存 → 发布事件 → 消费 → 发送邮件；</li>
<li>配置、测试、排错的完整流程。</li>
</ol>
<p>掌握这一套，用于库存预警、订单通知、日志异步处理等都能信手拈来。祝你写出一篇高质量的博客！🚀</p>
<pre><code class="hljs"/></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[手把手带你入门 TypeORM —— 面向新手的实战指南]]></title>    <link>https://juejin.cn/post/7571102074038140969</link>    <guid>https://juejin.cn/post/7571102074038140969</guid>    <pubDate>2025-11-11T08:14:39.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571102074038140969" data-draft-id="7571258854900154411" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="手把手带你入门 TypeORM —— 面向新手的实战指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T08:14:39.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="zyb_123456"/> <meta itemprop="url" content="https://juejin.cn/user/475457668781895"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            手把手带你入门 TypeORM —— 面向新手的实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/475457668781895/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    zyb_123456
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T08:14:39.000Z" title="Tue Nov 11 2025 08:14:39 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">手把手带你入门 TypeORM —— 面向新手的实战指南</h2>
<blockquote>
<p>本文面向第一次接触 ORM / TypeORM 的同学，结合真实项目（NestJS + PostgreSQL），从“为什么需要 ORM”讲起，一步步构建、迁移、查询、测试，帮你真正用起来。</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">1. 背景：为什么需要 ORM？</h3>

























<table><thead><tr><th>方式</th><th>特点</th><th>存在的问题</th></tr></thead><tbody><tr><td>直接写 SQL</td><td>灵活、性能好</td><td>每次都写 SQL，易错、难维护，不利于重构</td></tr><tr><td>DAO 自封装</td><td>把 SQL 包在函数里</td><td>仍需自己管理连接、事务、缓存等细节</td></tr><tr><td><strong>ORM</strong></td><td>“对象 ↔ 数据库”自动映射，类型安全</td><td>需学习曲线，但维护成本低</td></tr></tbody></table>
<p><strong>ORM（Object Relational Mapping）</strong> 是一套让你用“面向对象”的方式操作关系型数据库的工具。开发者只需定义实体类、调用方法，ORM 就会帮你生成 SQL、执行、转换结果。</p>
<p>TypeORM 是 Node.js 世界最常用的 ORM 之一，具备：</p>
<ul>
<li>TypeScript 支持、类型安全；</li>
<li>装饰器定义实体，代码直观；</li>
<li>多数据库支持（PostgreSQL/MySQL/SQLite 等）；</li>
<li>自动迁移、事务、关系映射等高级特性；</li>
<li>NestJS 官方推荐（<code>@nestjs/typeorm</code> 集成）。</li>
</ul>
<hr/>
<h3 data-id="heading-2">2. 快速上手：搭建 TypeORM + NestJS 环境</h3>
<h4 data-id="heading-3">2.1 安装依赖</h4>
<pre><code class="hljs language-bash" lang="bash">npm install @nestjs/typeorm typeorm pg
</code></pre>
<p>如果数据库是 MySQL，则安装 <code>mysql2</code>；SQLite 则安装 <code>sqlite3</code>。</p>
<h4 data-id="heading-4">2.2 创建数据源配置（支持 CLI / 迁移）</h4>
<p><code>typeorm.config.ts</code>：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-string">'reflect-metadata'</span>;
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">DataSource</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'typeorm'</span>;
<span class="hljs-keyword">import</span> { config } <span class="hljs-keyword">from</span> <span class="hljs-string">'dotenv'</span>;
<span class="hljs-keyword">import</span> { join } <span class="hljs-keyword">from</span> <span class="hljs-string">'path'</span>;

<span class="hljs-title function_">config</span>(); <span class="hljs-comment">// 读取 .env</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-title class_">AppDataSource</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSource</span>({
  <span class="hljs-attr">type</span>: <span class="hljs-string">'postgres'</span>,
  <span class="hljs-attr">url</span>: process.<span class="hljs-property">env</span>.<span class="hljs-property">DATABASE_URL</span>,
  <span class="hljs-attr">synchronize</span>: <span class="hljs-literal">false</span>,           <span class="hljs-comment">// 推荐迁移管理</span>
  <span class="hljs-attr">logging</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-attr">entities</span>: [<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">'src/**/*.entity.{ts,js}'</span>)],
  <span class="hljs-attr">migrations</span>: [<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">'src/migrations/*.{ts,js}'</span>)],
});
</code></pre>
<blockquote>
<p><code>synchronize: false</code>，避免上线环境自动改表。我们用“迁移”来管理结构变化。</p>
</blockquote>
<hr/>
<h3 data-id="heading-5">3. 定义实体（Entity）—— 模型驱动数据库</h3>
<h4 data-id="heading-6">3.1 基础实体</h4>
<p><code>src/modules/users/entities/user.entity.ts</code></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> {
  <span class="hljs-title class_">Entity</span>, <span class="hljs-title class_">PrimaryGeneratedColumn</span>, <span class="hljs-title class_">Column</span>,
  <span class="hljs-title class_">CreateDateColumn</span>, <span class="hljs-title class_">UpdateDateColumn</span>, <span class="hljs-title class_">Index</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'typeorm'</span>;

<span class="hljs-meta">@Entity</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'users'</span> })
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-meta">@PrimaryGeneratedColumn</span>(<span class="hljs-string">'uuid'</span>)
  id!: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@Column</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">128</span>, <span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span> })
  <span class="hljs-meta">@Index</span>(<span class="hljs-string">'idx_users_email'</span>)
  email!: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@Column</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">255</span> })
  password!: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@Column</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">64</span> })
  name!: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@Column</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">16</span>, <span class="hljs-attr">default</span>: <span class="hljs-string">'active'</span> })
  status!: <span class="hljs-string">'active'</span> | <span class="hljs-string">'disabled'</span>;

  <span class="hljs-meta">@CreateDateColumn</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'created_at'</span> })
  createdAt!: <span class="hljs-title class_">Date</span>;

  <span class="hljs-meta">@UpdateDateColumn</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'updated_at'</span> })
  updatedAt!: <span class="hljs-title class_">Date</span>;
}
</code></pre>
<p><strong>常用装饰器：</strong></p>

































<table><thead><tr><th>装饰器</th><th>作用</th></tr></thead><tbody><tr><td><code>@Entity()</code></td><td>声明实体类</td></tr><tr><td><code>@PrimaryGeneratedColumn</code></td><td>主键，自增/UUID</td></tr><tr><td><code>@Column()</code></td><td>普通字段</td></tr><tr><td><code>@CreateDateColumn</code></td><td>自动维护创建时间</td></tr><tr><td><code>@UpdateDateColumn</code></td><td>自动维护更新时间</td></tr><tr><td><code>@ManyToOne</code>, <code>@OneToMany</code>, <code>@ManyToMany</code></td><td>关系映射</td></tr></tbody></table>
<h4 data-id="heading-7">3.2 关系映射示例</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// Category 与 Item 是 一对多/多对一</span>
<span class="hljs-meta">@Entity</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'categories'</span> })
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Category</span> {
  <span class="hljs-meta">@PrimaryGeneratedColumn</span>(<span class="hljs-string">'uuid'</span>)
  id!: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@Column</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">64</span> })
  name!: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@OneToMany</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Item</span>, <span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">category</span>)
  items!: <span class="hljs-title class_">Item</span>[];
}

<span class="hljs-meta">@Entity</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'items'</span> })
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Item</span> {
  <span class="hljs-meta">@PrimaryGeneratedColumn</span>(<span class="hljs-string">'uuid'</span>)
  id!: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@ManyToOne</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Category</span>, <span class="hljs-function">(<span class="hljs-params">category</span>) =&gt;</span> category.<span class="hljs-property">items</span>, {
    <span class="hljs-attr">nullable</span>: <span class="hljs-literal">false</span>,
    <span class="hljs-attr">onDelete</span>: <span class="hljs-string">'RESTRICT'</span>,
  })
  category!: <span class="hljs-title class_">Category</span>;

  <span class="hljs-meta">@Column</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">128</span> })
  name!: <span class="hljs-built_in">string</span>;
}
</code></pre>
<h4 data-id="heading-8">3.3 多对多标签</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-meta">@Entity</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'tags'</span> })
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Tag</span> {
  <span class="hljs-meta">@PrimaryGeneratedColumn</span>(<span class="hljs-string">'uuid'</span>)
  id!: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@Column</span>({ <span class="hljs-attr">length</span>: <span class="hljs-number">64</span>, <span class="hljs-attr">unique</span>: <span class="hljs-literal">true</span> })
  name!: <span class="hljs-built_in">string</span>;

  <span class="hljs-meta">@ManyToMany</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Item</span>, <span class="hljs-function">(<span class="hljs-params">item</span>) =&gt;</span> item.<span class="hljs-property">tags</span>)
  items!: <span class="hljs-title class_">Item</span>[];
}

<span class="hljs-meta">@Entity</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'items'</span> })
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Item</span> {
  <span class="hljs-comment">// ...</span>
  <span class="hljs-meta">@ManyToMany</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title class_">Tag</span>, <span class="hljs-function">(<span class="hljs-params">tag</span>) =&gt;</span> tag.<span class="hljs-property">items</span>)
  <span class="hljs-meta">@JoinTable</span>({
    <span class="hljs-attr">name</span>: <span class="hljs-string">'item_tags'</span>,
    <span class="hljs-attr">joinColumn</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'item_id'</span>, <span class="hljs-attr">referencedColumnName</span>: <span class="hljs-string">'id'</span> },
    <span class="hljs-attr">inverseJoinColumn</span>: { <span class="hljs-attr">name</span>: <span class="hljs-string">'tag_id'</span>, <span class="hljs-attr">referencedColumnName</span>: <span class="hljs-string">'id'</span> },
  })
  tags!: <span class="hljs-title class_">Tag</span>[];
}
</code></pre>
<hr/>
<h3 data-id="heading-9">4. 增删改查：Repository &amp; QueryBuilder</h3>
<p>TypeORM 提供两种操作方式：<strong>Repository API</strong> 和 <strong>QueryBuilder</strong>。</p>
<h4 data-id="heading-10">4.1 Repository API</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-meta">@Injectable</span>()
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UsersService</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">
    <span class="hljs-meta">@InjectRepository</span>(User)
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> usersRepo: Repository&lt;User&gt;,
  </span>) {}

  <span class="hljs-title function_">findByEmail</span>(<span class="hljs-params">email: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">usersRepo</span>.<span class="hljs-title function_">findOne</span>({ <span class="hljs-attr">where</span>: { email } });
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">create</span>(<span class="hljs-params">dto: CreateUserDto</span>) {
    <span class="hljs-keyword">const</span> user = <span class="hljs-variable language_">this</span>.<span class="hljs-property">usersRepo</span>.<span class="hljs-title function_">create</span>(dto);
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">usersRepo</span>.<span class="hljs-title function_">save</span>(user);
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">updateStatus</span>(<span class="hljs-params">id: <span class="hljs-built_in">string</span>, status: User[<span class="hljs-string">'status'</span>]</span>) {
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">usersRepo</span>.<span class="hljs-title function_">update</span>(id, { status });
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">findById</span>(id);
  }

  <span class="hljs-keyword">async</span> <span class="hljs-title function_">remove</span>(<span class="hljs-params">id: <span class="hljs-built_in">string</span></span>) {
    <span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">usersRepo</span>.<span class="hljs-title function_">delete</span>(id);
  }
}
</code></pre>
<p><strong>常用方法：</strong></p>





























<table><thead><tr><th>方法</th><th>说明</th></tr></thead><tbody><tr><td><code>find()</code></td><td>查询列表</td></tr><tr><td><code>findOne()</code></td><td>单个查询</td></tr><tr><td><code>create()</code> + <code>save()</code></td><td>新建并保存</td></tr><tr><td><code>update()</code> / <code>delete()</code></td><td>批量更新/删除</td></tr><tr><td><code>count()</code></td><td>统计</td></tr></tbody></table>
<h4 data-id="heading-11">4.2 QueryBuilder 示例</h4>
<p>适合复杂筛选或多表关联：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> qb = <span class="hljs-variable language_">this</span>.<span class="hljs-property">itemsRepo</span>
  .<span class="hljs-title function_">createQueryBuilder</span>(<span class="hljs-string">'item'</span>)
  .<span class="hljs-title function_">leftJoinAndSelect</span>(<span class="hljs-string">'item.category'</span>, <span class="hljs-string">'category'</span>)
  .<span class="hljs-title function_">leftJoinAndSelect</span>(<span class="hljs-string">'item.tags'</span>, <span class="hljs-string">'tag'</span>)
  .<span class="hljs-title function_">where</span>(<span class="hljs-string">'item.name ILIKE :keyword'</span>, { <span class="hljs-attr">keyword</span>: <span class="hljs-string">`%<span class="hljs-subst">${keyword}</span>%`</span> });

<span class="hljs-keyword">if</span> (categoryId) {
  qb.<span class="hljs-title function_">andWhere</span>(<span class="hljs-string">'category.id = :categoryId'</span>, { categoryId });
}

<span class="hljs-keyword">if</span> (tagIds?.<span class="hljs-property">length</span>) {
  qb.<span class="hljs-title function_">andWhere</span>(<span class="hljs-string">'tag.id IN (:...tagIds)'</span>, { tagIds }).<span class="hljs-title function_">distinct</span>(<span class="hljs-literal">true</span>);
}

<span class="hljs-keyword">const</span> items = <span class="hljs-keyword">await</span> qb.<span class="hljs-title function_">orderBy</span>(<span class="hljs-string">'item.created_at'</span>, <span class="hljs-string">'DESC'</span>).<span class="hljs-title function_">getMany</span>();
</code></pre>
<hr/>
<h3 data-id="heading-12">5. 事务与并发控制</h3>
<h4 data-id="heading-13">5.1 事务（Transaction）</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">await</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">dataSource</span>.<span class="hljs-title function_">transaction</span>(<span class="hljs-keyword">async</span> (manager) =&gt; {
  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> manager.<span class="hljs-title function_">findOne</span>(<span class="hljs-title class_">User</span>, { <span class="hljs-attr">where</span>: { <span class="hljs-attr">id</span>: userId } });

  <span class="hljs-keyword">const</span> stock = manager.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Stock</span>, { ... });
  <span class="hljs-keyword">await</span> manager.<span class="hljs-title function_">save</span>(stock);

  <span class="hljs-comment">// 事务内调用其他服务也可以传 EntityManager 进来</span>
});
</code></pre>
<h4 data-id="heading-14">5.2 悲观锁（Pessimistic Lock）</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> stock = <span class="hljs-keyword">await</span> manager.<span class="hljs-title function_">findOne</span>(<span class="hljs-title class_">Stock</span>, {
  <span class="hljs-attr">where</span>: { id },
  <span class="hljs-attr">lock</span>: { <span class="hljs-attr">mode</span>: <span class="hljs-string">'pessimistic_write'</span> },
});
</code></pre>
<blockquote>
<p>多用户同时调整库存时，锁住记录，保证数据一致性。</p>
</blockquote>
<hr/>
<h3 data-id="heading-15">6. 管理数据库迁移</h3>
<h4 data-id="heading-16">6.1 生成迁移</h4>
<pre><code class="hljs language-bash" lang="bash">npm run typeorm migration:generate -- src/migrations/InitSchema -d typeorm.config.ts
</code></pre>
<p><code>package.json</code> 示例：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"typeorm"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"node --loader ts-node/esm ./node_modules/typeorm/cli.js"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"migration:generate"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run typeorm -- migration:generate"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"migration:run"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run typeorm -- migration:run"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"migration:revert"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"npm run typeorm -- migration:revert"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h4 data-id="heading-17">6.2 迁移文件示例（片段）</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">InitSchema1234567890123</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MigrationInterface</span> {
  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">up</span>(<span class="hljs-attr">queryRunner</span>: <span class="hljs-title class_">QueryRunner</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">await</span> queryRunner.<span class="hljs-title function_">query</span>(<span class="hljs-string">`
      CREATE TABLE "users" (...)
    `</span>);
    <span class="hljs-keyword">await</span> queryRunner.<span class="hljs-title function_">query</span>(<span class="hljs-string">`
      CREATE TABLE "categories" (...)
    `</span>);
    <span class="hljs-comment">// ...</span>
  }

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> <span class="hljs-title function_">down</span>(<span class="hljs-attr">queryRunner</span>: <span class="hljs-title class_">QueryRunner</span>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-built_in">void</span>&gt; {
    <span class="hljs-keyword">await</span> queryRunner.<span class="hljs-title function_">query</span>(<span class="hljs-string">`DROP TABLE "users"`</span>);
    <span class="hljs-keyword">await</span> queryRunner.<span class="hljs-title function_">query</span>(<span class="hljs-string">`DROP TABLE "categories"`</span>);
    <span class="hljs-comment">// ...</span>
  }
}
</code></pre>
<h4 data-id="heading-18">6.3 执行迁移</h4>
<pre><code class="hljs language-bash" lang="bash">npm run migration:run -- -d typeorm.config.ts
</code></pre>
<p>用于本地开发 / CI / 上线部署。</p>
<hr/>
<h3 data-id="heading-19">7. 与 NestJS 的深度整合</h3>
<h4 data-id="heading-20">7.1 <code>@nestjs/typeorm</code> Module</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title class_">TypeOrmModule</span>.<span class="hljs-title function_">forRootAsync</span>({
  <span class="hljs-attr">inject</span>: [<span class="hljs-title class_">ConfigService</span>],
  <span class="hljs-attr">useFactory</span>: <span class="hljs-function">(<span class="hljs-params">config: ConfigService&lt;{ app: AppConfigType }, <span class="hljs-literal">true</span>&gt;</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> { database } = config.<span class="hljs-property">getOrThrow</span>&lt;<span class="hljs-title class_">AppConfigType</span>&gt;(<span class="hljs-string">'app'</span>);
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">type</span>: <span class="hljs-string">'postgres'</span>,
      <span class="hljs-attr">url</span>: database.<span class="hljs-property">url</span>,
      <span class="hljs-attr">autoLoadEntities</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">synchronize</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">logging</span>: database.<span class="hljs-property">logging</span>,
    };
  },
});
</code></pre>
<h4 data-id="heading-21">7.2 测试用内存数据库（e2e）</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-title class_">TypeOrmModule</span>.<span class="hljs-title function_">forRoot</span>({
  <span class="hljs-attr">type</span>: <span class="hljs-string">'sqlite'</span>,
  <span class="hljs-attr">database</span>: <span class="hljs-string">':memory:'</span>,
  <span class="hljs-attr">entities</span>: [<span class="hljs-title class_">User</span>, <span class="hljs-title class_">Category</span>, <span class="hljs-title class_">Item</span>],
  <span class="hljs-attr">synchronize</span>: <span class="hljs-literal">true</span>,
});
</code></pre>
<p>让 e2e 测试可以独立执行，不依赖外部数据库。</p>
<hr/>
<h3 data-id="heading-22">8. 单元 / e2e 测试实践</h3>
<h4 data-id="heading-23">8.1 单元测试 —— Mock Repository</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> moduleRef = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Test</span>.<span class="hljs-title function_">createTestingModule</span>({
  <span class="hljs-attr">providers</span>: [
    <span class="hljs-title class_">UsersService</span>,
    {
      <span class="hljs-attr">provide</span>: <span class="hljs-title function_">getRepositoryToken</span>(<span class="hljs-title class_">User</span>),
      <span class="hljs-attr">useValue</span>: {
        <span class="hljs-attr">findOne</span>: jest.<span class="hljs-title function_">fn</span>(),
        <span class="hljs-attr">create</span>: jest.<span class="hljs-title function_">fn</span>(),
        <span class="hljs-attr">save</span>: jest.<span class="hljs-title function_">fn</span>(),
        <span class="hljs-attr">update</span>: jest.<span class="hljs-title function_">fn</span>(),
      },
    },
  ],
}).<span class="hljs-title function_">compile</span>();
</code></pre>
<ul>
<li><code>createQueryBuilder</code> 也可以通过 jest 模拟。</li>
<li>配合类验证器 DTO 可测试参数校验逻辑。</li>
</ul>
<h4 data-id="heading-24">8.2 e2e 测试 —— Supertest + SQLite</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">const</span> <span class="hljs-attr">moduleFixture</span>: <span class="hljs-title class_">TestingModule</span> = <span class="hljs-keyword">await</span> <span class="hljs-title class_">Test</span>.<span class="hljs-title function_">createTestingModule</span>({
  <span class="hljs-attr">imports</span>: [
    <span class="hljs-title class_">TypeOrmModule</span>.<span class="hljs-title function_">forRoot</span>({
      <span class="hljs-attr">type</span>: <span class="hljs-string">'sqlite'</span>,
      <span class="hljs-attr">database</span>: <span class="hljs-string">':memory:'</span>,
      <span class="hljs-attr">entities</span>: [<span class="hljs-title class_">User</span>, <span class="hljs-title class_">Category</span>, <span class="hljs-title class_">Item</span>],
      <span class="hljs-attr">synchronize</span>: <span class="hljs-literal">true</span>,
    }),
    <span class="hljs-title class_">ItemsModule</span>,
  ],
}).<span class="hljs-title function_">compile</span>();

app = moduleFixture.<span class="hljs-title function_">createNestApplication</span>();
app.<span class="hljs-title function_">useGlobalFilters</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpExceptionFilter</span>());
app.<span class="hljs-title function_">useGlobalInterceptors</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">TransformInterceptor</span>());
<span class="hljs-keyword">await</span> app.<span class="hljs-title function_">init</span>();

<span class="hljs-keyword">const</span> server = app.<span class="hljs-title function_">getHttpServer</span>();
<span class="hljs-keyword">await</span> <span class="hljs-title function_">request</span>(server)
  .<span class="hljs-title function_">post</span>(<span class="hljs-string">'/items'</span>)
  .<span class="hljs-title function_">send</span>({ ... })
  .<span class="hljs-title function_">expect</span>(<span class="hljs-number">201</span>);
</code></pre>
<hr/>
<h3 data-id="heading-25">9. 项目中遇到的常见问题 &amp; 解决方案</h3>





























<table><thead><tr><th>问题描述</th><th>解决办法</th></tr></thead><tbody><tr><td>实体改变但忘记迁移，导致线上/本地结构不一致</td><td>统一使用迁移管理，严禁 <code>synchronize: true</code> 上线</td></tr><tr><td><code>TypeError: decorator metadata not found</code></td><td><code>emitDecoratorMetadata</code> + <code>reflect-metadata</code></td></tr><tr><td>类型错误：<code>Type 'T' does not satisfy ObjectLiteral</code></td><td>mock QueryBuilder 时把泛型约束成 <code>&lt;T extends ObjectLiteral&gt;</code></td></tr><tr><td>多对多关系 <code>JoinTable</code> 属性不支持 <code>onDelete</code></td><td>在迁移里设置外键行为，而不是在装饰器里</td></tr><tr><td>NestJS 热重载时端口占用（EADDRINUSE）</td><td>关闭旧进程或启用 <code>--watch</code> 时配置 <code>webpack</code> 热更新</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-26">10. 实战经验与最佳实践</h3>
<ol>
<li><strong>配置集中化</strong>：统一在 <code>configuration.ts</code> 管理数据库、Redis、MQ、邮件等配置，方便多环境部署。</li>
<li><strong>DTO + 验证器</strong>：结合 <code>class-validator</code>、<code>class-transformer</code>，确保输入数据合法，再交给 ORM。</li>
<li><strong>仓储模式（Repository Pattern）</strong>：业务逻辑封装在 Service，Repository 只做数据访问。</li>
<li><strong>幂等 / 事务控制</strong>：库存、订单类操作要用事务，利用悲观锁或乐观锁确保一致性。</li>
<li><strong>测试优先</strong>：单测保证逻辑正确，e2e 保证接口联通，避免改动带来回归问题。</li>
<li><strong>迁移文档化</strong>：每次迁移都记录在 <code>docs/progress-log.md</code>、<code>docs/mq-explanation.md</code> 等文档里，方便回顾。</li>
<li><strong>多模块协作</strong>：Auth、Users、Items、Stock、Tags、Notifications 等模块各司其职，通过 TypeORM 实体串联。</li>
</ol>
<hr/>
<h3 data-id="heading-27">11. 写在最后</h3>
<p>TypeORM 不只是“简化 CRUD”，它能帮助你：</p>
<ul>
<li>用类型安全的方式管理复杂的数据库；</li>
<li>快速构建实体关系模型，降低维护成本；</li>
<li>统一管理数据库变更（迁移），支持 CI/CD；</li>
<li>与 NestJS 深度融合，搭建企业级服务。</li>
</ul>
<p>掌握 TypeORM，你就能把更多精力放在业务逻辑，而不是重复的 SQL 和手动数据转换上。希望这篇文章对你有所帮助，也欢迎把你的实践经验补充到评论里，一起进步！💡</p>
<pre><code class="hljs"/></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【穿越Effective C++】条款17：以独立语句将newed对象置入智能指针——异常安全的智能指针初始化]]></title>    <link>https://juejin.cn/post/7571304204721406006</link>    <guid>https://juejin.cn/post/7571304204721406006</guid>    <pubDate>2025-11-11T08:18:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571304204721406006" data-draft-id="7571105461098479659" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【穿越Effective C++】条款17：以独立语句将newed对象置入智能指针——异常安全的智能指针初始化"/> <meta itemprop="keywords" content="C++,面试"/> <meta itemprop="datePublished" content="2025-11-11T08:18:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="沐怡旸"/> <meta itemprop="url" content="https://juejin.cn/user/2875978146656750"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【穿越Effective C++】条款17：以独立语句将newed对象置入智能指针——异常安全的智能指针初始化
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978146656750/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    沐怡旸
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T08:18:48.000Z" title="Tue Nov 11 2025 08:18:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>这个条款揭示了C++异常安全中一个微妙但危险的陷阱：在复合语句中创建智能指针可能导致资源泄漏。理解这一原则是构建异常安全代码的关键。</p>
<hr/>
<h3 data-id="heading-0"><strong>思维导图：智能指针初始化的异常安全完整体系</strong></h3>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2821cd3fb62464bb6c1ab09059dcd03~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKQ5oCh5pe4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763453928&amp;x-signature=dqWIlf5E%2B7XJ9o1ksq8U3jTvuFY%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h3 data-id="heading-1"><strong>关键洞见与行动指南</strong></h3>
<h4 data-id="heading-2"><strong>必须遵守的核心原则：</strong></h4>
<ol>
<li><strong>独立语句初始化</strong>：总是在独立语句中创建智能指针，再传递给函数</li>
<li><strong>make_函数优先</strong>：优先使用<code>std::make_shared</code>和<code>std::make_unique</code></li>
<li><strong>工厂模式封装</strong>：使用工厂函数集中管理对象创建</li>
<li><strong>资源立即接管</strong>：确保资源一旦分配就立即被RAII对象管理</li>
</ol>
<h4 data-id="heading-3"><strong>现代C++开发建议：</strong></h4>
<ol>
<li><strong>代码规范要求</strong>：在团队规范中禁止在函数参数中直接new</li>
<li><strong>静态分析集成</strong>：使用工具检测危险的智能指针初始化模式</li>
<li><strong>审查清单</strong>：在代码审查中特别检查智能指针使用</li>
<li><strong>异常安全测试</strong>：测试各种异常路径确保资源不泄漏</li>
</ol>
<h4 data-id="heading-4"><strong>设计原则总结：</strong></h4>
<ol>
<li><strong>RAII原则</strong>：资源获取后立即由对象接管</li>
<li><strong>明确生命周期</strong>：清晰的资源所有权和生命周期管理</li>
<li><strong>防御性编程</strong>：假设任何操作都可能抛出异常</li>
<li><strong>零泄漏保证</strong>：确保在所有代码路径上资源正确释放</li>
</ol>
<h4 data-id="heading-5"><strong>需要警惕的陷阱：</strong></h4>
<ol>
<li><strong>编译器优化差异</strong>：不同编译器可能产生不同的求值顺序</li>
<li><strong>自定义删除器</strong>：删除器本身可能抛出异常</li>
<li><strong>多参数函数</strong>：多个new操作增加异常安全复杂度</li>
<li><strong>工厂方法设计</strong>：不正确的工厂实现可能引入泄漏</li>
</ol>
<p><strong>最终建议：</strong> 将独立语句初始化视为C++异常安全的"黄金法则"。培养"异常安全思维"——在编写每行代码时都问自己："如果这里抛出异常，资源会被正确释放吗？" 这种前瞻性的思考方式是构建工业级C++系统的关键。</p>
<p>记住：<strong>在C++异常安全中，智能指针的正确初始化不是优化项，而是避免资源泄漏的基本要求。</strong> 条款17教会我们的不仅是一个编码技巧，更是对C++异常模型深刻理解的体现。</p>
<hr/>
<h3 data-id="heading-6"><strong>深入解析：异常安全的核心挑战</strong></h3>
<h4 data-id="heading-7"><strong>1. 问题根源：编译器求值顺序的不确定性</strong></h4>
<p><strong>危险的复合语句初始化：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;iostream&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Investment</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">Investment</span>() { 
        std::cout &lt;&lt; <span class="hljs-string">"Investment构造"</span> &lt;&lt; std::endl; 
    }
    <span class="hljs-keyword">virtual</span> ~<span class="hljs-built_in">Investment</span>() { 
        std::cout &lt;&lt; <span class="hljs-string">"Investment析构"</span> &lt;&lt; std::endl; 
    }
    <span class="hljs-function"><span class="hljs-keyword">virtual</span> <span class="hljs-type">void</span> <span class="hljs-title">calculate</span><span class="hljs-params">()</span> </span>= <span class="hljs-number">0</span>;
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Stock</span> : <span class="hljs-keyword">public</span> Investment {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">Stock</span>() { 
        std::cout &lt;&lt; <span class="hljs-string">"Stock构造"</span> &lt;&lt; std::endl; 
    }
    ~<span class="hljs-built_in">Stock</span>() <span class="hljs-keyword">override</span> { 
        std::cout &lt;&lt; <span class="hljs-string">"Stock析构"</span> &lt;&lt; std::endl; 
    }
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">calculate</span><span class="hljs-params">()</span> <span class="hljs-keyword">override</span> </span>{
        std::cout &lt;&lt; <span class="hljs-string">"计算股票收益"</span> &lt;&lt; std::endl;
    }
};

<span class="hljs-comment">// 一个可能抛出异常的函数</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">riskyOperation</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; message)</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"执行风险操作: "</span> &lt;&lt; message &lt;&lt; std::endl;
    <span class="hljs-comment">// 模拟可能抛出异常的操作</span>
    <span class="hljs-keyword">if</span> (message.<span class="hljs-built_in">empty</span>()) {
        <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">invalid_argument</span>(<span class="hljs-string">"消息不能为空"</span>);
    }
}

<span class="hljs-comment">// 处理投资的函数</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">processInvestment</span><span class="hljs-params">(std::shared_ptr&lt;Investment&gt; inv, 
                      <span class="hljs-type">const</span> std::string&amp; logMessage)</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"处理投资: "</span> &lt;&lt; logMessage &lt;&lt; std::endl;
    inv-&gt;<span class="hljs-built_in">calculate</span>();
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">demonstrate_dangerous_initialization</span><span class="hljs-params">()</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"=== 危险的智能指针初始化 ==="</span> &lt;&lt; std::endl;
    
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 危险：在函数调用中直接创建智能指针！</span>
        <span class="hljs-built_in">processInvestment</span>(
            std::<span class="hljs-built_in">shared_ptr</span>&lt;Investment&gt;(<span class="hljs-keyword">new</span> Stock),  <span class="hljs-comment">// 可能泄漏！</span>
            <span class="hljs-built_in">riskyOperation</span>(<span class="hljs-string">"开始处理"</span>)               <span class="hljs-comment">// 可能抛出异常！</span>
        );
        
        <span class="hljs-comment">// 问题：编译器可能生成这样的执行顺序：</span>
        <span class="hljs-comment">// 1. new Stock - 分配内存并构造对象</span>
        <span class="hljs-comment">// 2. riskyOperation("开始处理") - 可能抛出异常！</span>
        <span class="hljs-comment">// 3. std::shared_ptr构造函数 - 如果2抛出异常，这一步不会执行</span>
        <span class="hljs-comment">//</span>
        <span class="hljs-comment">// 结果：Stock对象已构造但未被智能指针管理，内存泄漏！</span>
        
    } <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) {
        std::cout &lt;&lt; <span class="hljs-string">"捕获异常: "</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;
        <span class="hljs-comment">// 如果异常在new之后、shared_ptr构造之前发生，</span>
        <span class="hljs-comment">// Stock对象就会泄漏！</span>
    }
}
</code></pre>
<p><strong>编译器可能生成的代码分析：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 编译器可能将上述代码转换为：</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">compiler_generated_dangerous_code</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// 可能的执行顺序1（安全）：</span>
    <span class="hljs-comment">// 1. std::shared_ptr&lt;Investment&gt; temp(new Stock)</span>
    <span class="hljs-comment">// 2. riskyOperation("开始处理")</span>
    <span class="hljs-comment">// 3. processInvestment(temp, ...)</span>
    
    <span class="hljs-comment">// 可能的执行顺序2（危险）：</span>
    <span class="hljs-comment">// 1. Investment* rawPtr = new Stock</span>
    <span class="hljs-comment">// 2. riskyOperation("开始处理")  // 如果这里抛出异常，rawPtr泄漏！</span>
    <span class="hljs-comment">// 3. std::shared_ptr&lt;Investment&gt; temp(rawPtr)</span>
    <span class="hljs-comment">// 4. processInvestment(temp, ...)</span>
    
    <span class="hljs-comment">// 可能的执行顺序3（同样危险）：</span>
    <span class="hljs-comment">// 1. riskyOperation("开始处理")  // 先执行参数求值</span>
    <span class="hljs-comment">// 2. Investment* rawPtr = new Stock</span>
    <span class="hljs-comment">// 3. std::shared_ptr&lt;Investment&gt; temp(rawPtr)</span>
    <span class="hljs-comment">// 4. processInvestment(temp, ...)</span>
    
    <span class="hljs-comment">// C++标准没有规定函数参数的求值顺序！</span>
    <span class="hljs-comment">// 不同编译器、不同优化级别可能产生不同顺序！</span>
}
</code></pre>
<h4 data-id="heading-8"><strong>2. 实际验证资源泄漏</strong></h4>
<p><strong>资源泄漏的实证演示：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">LeakDetector</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-type">static</span> <span class="hljs-type">int</span> constructionCount;
    <span class="hljs-type">static</span> <span class="hljs-type">int</span> destructionCount;
    
    <span class="hljs-built_in">LeakDetector</span>() {
        ++constructionCount;
        std::cout &lt;&lt; <span class="hljs-string">"LeakDetector构造 #"</span> &lt;&lt; constructionCount &lt;&lt; std::endl;
    }
    
    ~<span class="hljs-built_in">LeakDetector</span>() {
        ++destructionCount;
        std::cout &lt;&lt; <span class="hljs-string">"LeakDetector析构 #"</span> &lt;&lt; destructionCount &lt;&lt; std::endl;
    }
    
    <span class="hljs-function"><span class="hljs-type">static</span> <span class="hljs-type">void</span> <span class="hljs-title">report</span><span class="hljs-params">()</span> </span>{
        std::cout &lt;&lt; <span class="hljs-string">"构造/析构统计: "</span> &lt;&lt; constructionCount 
                  &lt;&lt; <span class="hljs-string">" / "</span> &lt;&lt; destructionCount &lt;&lt; std::endl;
        <span class="hljs-keyword">if</span> (constructionCount &gt; destructionCount) {
            std::cout &lt;&lt; <span class="hljs-string">"*** 检测到资源泄漏! ***"</span> &lt;&lt; std::endl;
        }
    }
};

<span class="hljs-type">int</span> LeakDetector::constructionCount = <span class="hljs-number">0</span>;
<span class="hljs-type">int</span> LeakDetector::destructionCount = <span class="hljs-number">0</span>;

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dangerousProcess</span><span class="hljs-params">(std::shared_ptr&lt;LeakDetector&gt; ptr, <span class="hljs-type">bool</span> shouldThrow)</span> </span>{
    <span class="hljs-keyword">if</span> (shouldThrow) {
        <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"处理过程中发生异常"</span>);
    }
    std::cout &lt;&lt; <span class="hljs-string">"安全处理对象"</span> &lt;&lt; std::endl;
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">demonstrate_resource_leak</span><span class="hljs-params">()</span> </span>{
    LeakDetector::constructionCount = <span class="hljs-number">0</span>;
    LeakDetector::destructionCount = <span class="hljs-number">0</span>;
    
    std::cout &lt;&lt; <span class="hljs-string">"=== 演示资源泄漏 ==="</span> &lt;&lt; std::endl;
    
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 危险的复合语句初始化</span>
        <span class="hljs-built_in">dangerousProcess</span>(
            std::<span class="hljs-built_in">shared_ptr</span>&lt;LeakDetector&gt;(<span class="hljs-keyword">new</span> LeakDetector),
            <span class="hljs-literal">true</span>  <span class="hljs-comment">// 强制抛出异常</span>
        );
        
    } <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) {
        std::cout &lt;&lt; <span class="hljs-string">"异常: "</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;
    }
    
    LeakDetector::<span class="hljs-built_in">report</span>();
    
    <span class="hljs-comment">// 在某些编译器/优化级别下，可能会看到：</span>
    <span class="hljs-comment">// 构造/析构统计: 1 / 0</span>
    <span class="hljs-comment">// *** 检测到资源泄漏! ***</span>
}
</code></pre>
<hr/>
<h3 data-id="heading-9"><strong>解决方案：安全的初始化模式</strong></h3>
<h4 data-id="heading-10"><strong>1. 独立语句初始化</strong></h4>
<p><strong>基本的安全初始化模式：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">demonstrate_safe_initialization</span><span class="hljs-params">()</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"\n=== 安全的智能指针初始化 ==="</span> &lt;&lt; std::endl;
    
    LeakDetector::constructionCount = <span class="hljs-number">0</span>;
    LeakDetector::destructionCount = <span class="hljs-number">0</span>;
    
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 安全：在独立语句中创建智能指针</span>
        <span class="hljs-function">std::shared_ptr&lt;LeakDetector&gt; <span class="hljs-title">safePtr</span><span class="hljs-params">(<span class="hljs-keyword">new</span> LeakDetector)</span></span>;
        
        <span class="hljs-comment">// 现在safePtr已经接管资源，即使后面抛出异常也会正确释放</span>
        <span class="hljs-built_in">dangerousProcess</span>(safePtr, <span class="hljs-literal">true</span>);  <span class="hljs-comment">// 强制抛出异常</span>
        
    } <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) {
        std::cout &lt;&lt; <span class="hljs-string">"异常: "</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;
    }
    
    LeakDetector::<span class="hljs-built_in">report</span>();
    <span class="hljs-comment">// 现在会看到：构造/析构统计: 1 / 1 - 没有泄漏！</span>
}
</code></pre>
<p><strong>复杂场景的安全处理：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConnection</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">DatabaseConnection</span>(<span class="hljs-type">const</span> std::string&amp; connectionString) {
        std::cout &lt;&lt; <span class="hljs-string">"建立数据库连接: "</span> &lt;&lt; connectionString &lt;&lt; std::endl;
    }
    
    ~<span class="hljs-built_in">DatabaseConnection</span>() {
        std::cout &lt;&lt; <span class="hljs-string">"关闭数据库连接"</span> &lt;&lt; std::endl;
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">execute</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; query)</span> </span>{
        std::cout &lt;&lt; <span class="hljs-string">"执行查询: "</span> &lt;&lt; query &lt;&lt; std::endl;
    }
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Transaction</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">Transaction</span>(<span class="hljs-type">const</span> std::string&amp; name) {
        std::cout &lt;&lt; <span class="hljs-string">"开始事务: "</span> &lt;&lt; name &lt;&lt; std::endl;
    }
    
    ~<span class="hljs-built_in">Transaction</span>() {
        std::cout &lt;&lt; <span class="hljs-string">"结束事务"</span> &lt;&lt; std::endl;
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">commit</span><span class="hljs-params">()</span> </span>{
        std::cout &lt;&lt; <span class="hljs-string">"提交事务"</span> &lt;&lt; std::endl;
    }
};

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">processBusinessLogic</span><span class="hljs-params">(std::shared_ptr&lt;DatabaseConnection&gt; db,
                         std::shared_ptr&lt;Transaction&gt; tx,
                         <span class="hljs-type">const</span> std::string&amp; operation)</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"处理业务逻辑: "</span> &lt;&lt; operation &lt;&lt; std::endl;
    db-&gt;<span class="hljs-built_in">execute</span>(<span class="hljs-string">"SELECT * FROM data"</span>);
    tx-&gt;<span class="hljs-built_in">commit</span>();
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">demonstrate_complex_safe_initialization</span><span class="hljs-params">()</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"\n=== 复杂场景的安全初始化 ==="</span> &lt;&lt; std::endl;
    
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 危险做法：在函数调用中直接创建多个智能指针</span>
        <span class="hljs-comment">// processBusinessLogic(</span>
        <span class="hljs-comment">//     std::shared_ptr&lt;DatabaseConnection&gt;(new DatabaseConnection("Server=DB1")),</span>
        <span class="hljs-comment">//     std::shared_ptr&lt;Transaction&gt;(new Transaction("MainTx")),</span>
        <span class="hljs-comment">//     "重要操作"</span>
        <span class="hljs-comment">// );</span>
        <span class="hljs-comment">// 多个new操作，异常安全窗口更大！</span>
        
        <span class="hljs-comment">// 安全做法：独立语句初始化所有智能指针</span>
        <span class="hljs-keyword">auto</span> dbConn = std::<span class="hljs-built_in">shared_ptr</span>&lt;DatabaseConnection&gt;(
            <span class="hljs-keyword">new</span> <span class="hljs-built_in">DatabaseConnection</span>(<span class="hljs-string">"Server=DB1"</span>));
        
        <span class="hljs-keyword">auto</span> transaction = std::<span class="hljs-built_in">shared_ptr</span>&lt;Transaction&gt;(
            <span class="hljs-keyword">new</span> <span class="hljs-built_in">Transaction</span>(<span class="hljs-string">"MainTx"</span>));
        
        <span class="hljs-comment">// 现在所有资源都被智能指针管理，异常安全</span>
        <span class="hljs-built_in">processBusinessLogic</span>(dbConn, transaction, <span class="hljs-string">"重要操作"</span>);
        
    } <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) {
        std::cout &lt;&lt; <span class="hljs-string">"业务逻辑异常: "</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;
        <span class="hljs-comment">// 即使发生异常，dbConn和transaction也会正确析构</span>
    }
}
</code></pre>
<h4 data-id="heading-11"><strong>2. 现代C++的make_函数</strong></h4>
<p><strong>make_shared和make_unique的异常安全：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span>

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">demonstrate_make_functions</span><span class="hljs-params">()</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"\n=== 使用make_shared和make_unique ==="</span> &lt;&lt; std::endl;
    
    <span class="hljs-comment">// make_shared是异常安全的 - 这是首选方案！</span>
    <span class="hljs-keyword">auto</span> safePtr1 = std::<span class="hljs-built_in">make_shared</span>&lt;LeakDetector&gt;();
    
    <span class="hljs-comment">// make_unique (C++14) 同样是异常安全的</span>
    <span class="hljs-keyword">auto</span> safePtr2 = std::<span class="hljs-built_in">make_unique</span>&lt;LeakDetector&gt;();
    
    <span class="hljs-comment">// make_函数在单次操作中完成内存分配和对象构造</span>
    <span class="hljs-comment">// 不存在"new成功但智能指针未接管"的窗口期</span>
    
    std::cout &lt;&lt; <span class="hljs-string">"使用make_函数创建智能指针 - 天生异常安全"</span> &lt;&lt; std::endl;
}

<span class="hljs-comment">// 带有参数的make_函数使用</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">ConfigurableResource</span> {
<span class="hljs-keyword">private</span>:
    std::string name;
    <span class="hljs-type">int</span> configuration;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">ConfigurableResource</span>(<span class="hljs-type">const</span> std::string&amp; n, <span class="hljs-type">int</span> config) 
        : <span class="hljs-built_in">name</span>(n), <span class="hljs-built_in">configuration</span>(config) {
        std::cout &lt;&lt; <span class="hljs-string">"创建可配置资源: "</span> &lt;&lt; name 
                  &lt;&lt; <span class="hljs-string">" [配置="</span> &lt;&lt; configuration &lt;&lt; <span class="hljs-string">"]"</span> &lt;&lt; std::endl;
    }
    
    ~<span class="hljs-built_in">ConfigurableResource</span>() {
        std::cout &lt;&lt; <span class="hljs-string">"销毁可配置资源: "</span> &lt;&lt; name &lt;&lt; std::endl;
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">use</span><span class="hljs-params">()</span> </span>{
        std::cout &lt;&lt; <span class="hljs-string">"使用资源: "</span> &lt;&lt; name &lt;&lt; std::endl;
    }
};

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">demonstrate_make_with_parameters</span><span class="hljs-params">()</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"\n=== 带参数的make_函数 ==="</span> &lt;&lt; std::endl;
    
    <span class="hljs-comment">// make_shared带参数 - 异常安全</span>
    <span class="hljs-keyword">auto</span> resource = std::<span class="hljs-built_in">make_shared</span>&lt;ConfigurableResource&gt;(<span class="hljs-string">"数据库"</span>, <span class="hljs-number">42</span>);
    resource-&gt;<span class="hljs-built_in">use</span>();
    
    <span class="hljs-comment">// 对比危险做法：</span>
    <span class="hljs-comment">// auto dangerous = std::shared_ptr&lt;ConfigurableResource&gt;(</span>
    <span class="hljs-comment">//     new ConfigurableResource("临时资源", riskyOperation()));</span>
    <span class="hljs-comment">// 如果riskyOperation()抛出异常，new的对象就会泄漏</span>
    
    <span class="hljs-comment">// 安全做法：要么用make_shared，要么独立语句</span>
    <span class="hljs-type">int</span> config = <span class="hljs-number">100</span>;  <span class="hljs-comment">// 假设这是复杂计算的结果</span>
    <span class="hljs-keyword">auto</span> safe = std::<span class="hljs-built_in">make_shared</span>&lt;ConfigurableResource&gt;(<span class="hljs-string">"安全资源"</span>, config);
}
</code></pre>
<hr/>
<h3 data-id="heading-12"><strong>技术原理深度解析</strong></h3>
<h4 data-id="heading-13"><strong>1. 编译器求值顺序的复杂性</strong></h4>
<p><strong>函数参数求值顺序的未定义行为：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">analyze_evaluation_order</span><span class="hljs-params">()</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"\n=== 函数参数求值顺序分析 ==="</span> &lt;&lt; std::endl;
    
    <span class="hljs-keyword">auto</span> logger = [](<span class="hljs-type">const</span> std::string&amp; name, <span class="hljs-type">int</span> order) {
        std::cout &lt;&lt; <span class="hljs-string">"参数 '"</span> &lt;&lt; name &lt;&lt; <span class="hljs-string">"' 第 "</span> &lt;&lt; order &lt;&lt; <span class="hljs-string">" 个求值"</span> &lt;&lt; std::endl;
        <span class="hljs-keyword">return</span> order;
    };
    
    <span class="hljs-comment">// 测试函数参数求值顺序</span>
    <span class="hljs-keyword">auto</span> testFunc = [](<span class="hljs-type">int</span> first, <span class="hljs-type">int</span> second, <span class="hljs-type">int</span> third) {
        std::cout &lt;&lt; <span class="hljs-string">"函数调用执行"</span> &lt;&lt; std::endl;
    };
    
    <span class="hljs-comment">// C++标准没有规定参数求值顺序！</span>
    <span class="hljs-comment">// 不同编译器可能产生不同结果</span>
    <span class="hljs-built_in">testFunc</span>(
        <span class="hljs-built_in">logger</span>(<span class="hljs-string">"第一个参数"</span>, <span class="hljs-number">1</span>),
        <span class="hljs-built_in">logger</span>(<span class="hljs-string">"第二个参数"</span>, <span class="hljs-number">2</span>), 
        <span class="hljs-built_in">logger</span>(<span class="hljs-string">"第三个参数"</span>, <span class="hljs-number">3</span>)
    );
    
    <span class="hljs-comment">// 可能的输出1（从左到右）：</span>
    <span class="hljs-comment">// 参数 '第一个参数' 第 1 个求值</span>
    <span class="hljs-comment">// 参数 '第二个参数' 第 2 个求值  </span>
    <span class="hljs-comment">// 参数 '第三个参数' 第 3 个求值</span>
    <span class="hljs-comment">// 函数调用执行</span>
    
    <span class="hljs-comment">// 可能的输出2（从右到左）：</span>
    <span class="hljs-comment">// 参数 '第三个参数' 第 3 个求值</span>
    <span class="hljs-comment">// 参数 '第二个参数' 第 2 个求值</span>
    <span class="hljs-comment">// 参数 '第一个参数' 第 1 个求值</span>
    <span class="hljs-comment">// 函数调用执行</span>
    
    <span class="hljs-comment">// 可能的输出3（任意顺序）：</span>
    <span class="hljs-comment">// 参数 '第二个参数' 第 2 个求值</span>
    <span class="hljs-comment">// 参数 '第一个参数' 第 1 个求值</span>
    <span class="hljs-comment">// 参数 '第三个参数' 第 3 个求值</span>
    <span class="hljs-comment">// 函数调用执行</span>
}
</code></pre>
<h4 data-id="heading-14"><strong>2. make_shared的优化优势</strong></h4>
<p><strong>make_shared的性能和异常安全优势：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">demonstrate_make_shared_advantages</span><span class="hljs-params">()</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"\n=== make_shared的额外优势 ==="</span> &lt;&lt; std::endl;
    
    <span class="hljs-comment">// 传统方式：两次内存分配</span>
    <span class="hljs-comment">// 1. 分配对象内存</span>
    <span class="hljs-comment">// 2. 分配控制块内存（引用计数等）</span>
    <span class="hljs-function">std::shared_ptr&lt;LeakDetector&gt; <span class="hljs-title">traditional</span><span class="hljs-params">(<span class="hljs-keyword">new</span> LeakDetector)</span></span>;
    
    <span class="hljs-comment">// make_shared方式：一次内存分配</span>
    <span class="hljs-comment">// 对象和控制块在连续内存中分配</span>
    <span class="hljs-keyword">auto</span> optimized = std::<span class="hljs-built_in">make_shared</span>&lt;LeakDetector&gt;();
    
    std::cout &lt;&lt; <span class="hljs-string">"make_shared优势："</span> &lt;&lt; std::endl;
    std::cout &lt;&lt; <span class="hljs-string">"1. 异常安全 - 没有资源泄漏窗口"</span> &lt;&lt; std::endl;
    std::cout &lt;&lt; <span class="hljs-string">"2. 性能优化 - 单次内存分配"</span> &lt;&lt; std::endl; 
    std::cout &lt;&lt; <span class="hljs-string">"3. 缓存友好 - 对象和控制块位置接近"</span> &lt;&lt; std::endl;
    std::cout &lt;&lt; <span class="hljs-string">"4. 代码简洁 - 不需要重复类型名"</span> &lt;&lt; std::endl;
}
</code></pre>
<hr/>
<h3 data-id="heading-15"><strong>特殊场景处理</strong></h3>
<h4 data-id="heading-16"><strong>1. 自定义删除器的异常安全</strong></h4>
<p><strong>自定义删除器的安全初始化：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">demonstrate_custom_deleter_safety</span><span class="hljs-params">()</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"\n=== 自定义删除器的异常安全 ==="</span> &lt;&lt; std::endl;
    
    <span class="hljs-comment">// 自定义删除器 - 可能抛出异常！</span>
    <span class="hljs-keyword">auto</span> throwingDeleter = [](LeakDetector* ptr) {
        std::cout &lt;&lt; <span class="hljs-string">"自定义删除器执行"</span> &lt;&lt; std::endl;
        <span class="hljs-keyword">if</span> (ptr) {
            <span class="hljs-comment">// 模拟可能抛出异常的操作</span>
            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"删除器操作失败"</span>);
            <span class="hljs-keyword">delete</span> ptr;
        }
    };
    
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 危险：在函数参数中创建带自定义删除器的智能指针</span>
        <span class="hljs-comment">// processResource(</span>
        <span class="hljs-comment">//     std::shared_ptr&lt;LeakDetector&gt;(new LeakDetector, throwingDeleter),</span>
        <span class="hljs-comment">//     "测试操作"</span>
        <span class="hljs-comment">// );</span>
        
        <span class="hljs-comment">// 安全：独立语句初始化</span>
        <span class="hljs-keyword">auto</span> resource = std::<span class="hljs-built_in">shared_ptr</span>&lt;LeakDetector&gt;(
            <span class="hljs-keyword">new</span> LeakDetector, throwingDeleter);
        
        <span class="hljs-comment">// 现在资源已被管理，即使后面抛出异常...</span>
        <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">logic_error</span>(<span class="hljs-string">"业务逻辑异常"</span>);
        
    } <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) {
        std::cout &lt;&lt; <span class="hljs-string">"捕获异常: "</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;
        <span class="hljs-comment">// 即使删除器本身可能抛出异常，但资源已经被智能指针管理</span>
        <span class="hljs-comment">// 会在栈展开时尝试调用删除器</span>
    }
}
</code></pre>
<h4 data-id="heading-17"><strong>2. 工厂模式的异常安全设计</strong></h4>
<p><strong>异常安全的对象工厂：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">ObjectFactory</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">// 异常安全的工厂方法</span>
    <span class="hljs-function"><span class="hljs-type">static</span> std::shared_ptr&lt;ConfigurableResource&gt; <span class="hljs-title">createSafeResource</span><span class="hljs-params">(
        <span class="hljs-type">const</span> std::string&amp; name, <span class="hljs-type">int</span> config)</span> </span>{
        
        <span class="hljs-comment">// 使用make_shared确保异常安全</span>
        <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">make_shared</span>&lt;ConfigurableResource&gt;(name, config);
    }
    
    <span class="hljs-comment">// 危险的传统工厂方法</span>
    <span class="hljs-function"><span class="hljs-type">static</span> std::shared_ptr&lt;ConfigurableResource&gt; <span class="hljs-title">createDangerousResource</span><span class="hljs-params">(
        <span class="hljs-type">const</span> std::string&amp; name, <span class="hljs-type">int</span> config)</span> </span>{
        
        <span class="hljs-comment">// 危险：在return语句中直接new</span>
        <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">shared_ptr</span>&lt;ConfigurableResource&gt;(
            <span class="hljs-keyword">new</span> <span class="hljs-built_in">ConfigurableResource</span>(name, config));
        <span class="hljs-comment">// 虽然这里看起来安全，但如果有复杂表达式仍可能有问题</span>
    }
    
    <span class="hljs-comment">// 带自定义删除器的安全工厂</span>
    <span class="hljs-function"><span class="hljs-type">static</span> std::shared_ptr&lt;DatabaseConnection&gt; <span class="hljs-title">createDatabaseConnection</span><span class="hljs-params">(
        <span class="hljs-type">const</span> std::string&amp; connectionString)</span> </span>{
        
        <span class="hljs-comment">// 安全：独立语句创建</span>
        <span class="hljs-keyword">auto</span> deleter = [](DatabaseConnection* db) {
            std::cout &lt;&lt; <span class="hljs-string">"自定义数据库连接清理"</span> &lt;&lt; std::endl;
            <span class="hljs-keyword">delete</span> db;
        };
        
        <span class="hljs-keyword">auto</span> connection = std::<span class="hljs-built_in">shared_ptr</span>&lt;DatabaseConnection&gt;(
            <span class="hljs-keyword">new</span> <span class="hljs-built_in">DatabaseConnection</span>(connectionString), deleter);
            
        <span class="hljs-keyword">return</span> connection;
    }
};

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">demonstrate_factory_pattern</span><span class="hljs-params">()</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"\n=== 异常安全的工厂模式 ==="</span> &lt;&lt; std::endl;
    
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 安全使用工厂方法</span>
        <span class="hljs-keyword">auto</span> resource = ObjectFactory::<span class="hljs-built_in">createSafeResource</span>(<span class="hljs-string">"工厂资源"</span>, <span class="hljs-number">123</span>);
        <span class="hljs-keyword">auto</span> dbConnection = ObjectFactory::<span class="hljs-built_in">createDatabaseConnection</span>(<span class="hljs-string">"Server=Factory"</span>);
        
        <span class="hljs-comment">// 即使后续操作抛出异常，资源也是安全的</span>
        <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"测试异常"</span>);
        
    } <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) {
        std::cout &lt;&lt; <span class="hljs-string">"工厂使用异常: "</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-18"><strong>现代C++的最佳实践</strong></h3>
<h4 data-id="heading-19"><strong>1. 通用安全初始化模板</strong></h4>
<p><strong>适用于各种场景的安全初始化工具：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;type_traits&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;utility&gt;</span></span>

<span class="hljs-keyword">namespace</span> safe_initialization {
    
    <span class="hljs-comment">// 安全初始化工具函数</span>
    <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T, <span class="hljs-keyword">typename</span>... Args&gt;
    std::shared_ptr&lt;T&gt; <span class="hljs-title">make_shared_safe</span><span class="hljs-params">(Args&amp;&amp;... args)</span> </span>{
        <span class="hljs-comment">// 只是make_shared的别名，强调异常安全性</span>
        <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">make_shared</span>&lt;T&gt;(std::forward&lt;Args&gt;(args)...);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T, <span class="hljs-keyword">typename</span> Deleter, <span class="hljs-keyword">typename</span>... Args&gt;
    std::shared_ptr&lt;T&gt; <span class="hljs-title">make_shared_with_deleter</span><span class="hljs-params">(Deleter&amp;&amp; deleter, Args&amp;&amp;... args)</span> </span>{
        <span class="hljs-comment">// 安全初始化带删除器的shared_ptr</span>
        <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">shared_ptr</span>&lt;T&gt;(
            <span class="hljs-keyword">new</span> <span class="hljs-built_in">T</span>(std::forward&lt;Args&gt;(args)...),
            std::forward&lt;Deleter&gt;(deleter));
    }
    
    <span class="hljs-comment">// 概念检查（C++20）</span>
    <span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
    <span class="hljs-keyword">concept</span> ExceptionSafeInitializable = 
        std::is_nothrow_constructible_v&lt;T&gt; || 
        <span class="hljs-keyword">requires</span> { <span class="hljs-keyword">typename</span> std::<span class="hljs-type">enable_if_t</span>&lt;std::is_class_v&lt;T&gt;&gt;; };
    
    <span class="hljs-function"><span class="hljs-keyword">template</span>&lt;ExceptionSafeInitializable T, <span class="hljs-keyword">typename</span>... Args&gt;
    std::unique_ptr&lt;T&gt; <span class="hljs-title">make_unique_safe</span><span class="hljs-params">(Args&amp;&amp;... args)</span> </span>{
        <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">make_unique</span>&lt;T&gt;(std::forward&lt;Args&gt;(args)...);
    }
}

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">demonstrate_safe_utilities</span><span class="hljs-params">()</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"\n=== 安全初始化工具 ==="</span> &lt;&lt; std::endl;
    
    <span class="hljs-keyword">using</span> <span class="hljs-keyword">namespace</span> safe_initialization;
    
    <span class="hljs-comment">// 使用安全工具函数</span>
    <span class="hljs-keyword">auto</span> safeResource = <span class="hljs-built_in">make_shared_safe</span>&lt;ConfigurableResource&gt;(<span class="hljs-string">"工具资源"</span>, <span class="hljs-number">999</span>);
    
    <span class="hljs-keyword">auto</span> customDeleter = [](<span class="hljs-keyword">auto</span>* ptr) { 
        std::cout &lt;&lt; <span class="hljs-string">"自定义删除"</span> &lt;&lt; std::endl;
        <span class="hljs-keyword">delete</span> ptr; 
    };
    
    <span class="hljs-keyword">auto</span> safeWithDeleter = <span class="hljs-built_in">make_shared_with_deleter</span>&lt;LeakDetector&gt;(customDeleter);
    
    std::cout &lt;&lt; <span class="hljs-string">"安全初始化工具确保异常安全"</span> &lt;&lt; std::endl;
}
</code></pre>
<h4 data-id="heading-20"><strong>2. 代码审查和静态分析</strong></h4>
<p><strong>识别危险模式的检查清单：</strong></p>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-comment">// 危险的代码模式 - 代码审查时应检查这些模式</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">CodeReviewExamples</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">dangerousPatterns</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// 模式1：函数参数中直接new</span>
        <span class="hljs-comment">// processResource(std::shared_ptr&lt;Resource&gt;(new Resource), arg);</span>
        
        <span class="hljs-comment">// 模式2：多个智能指针在参数中创建</span>
        <span class="hljs-comment">// processMultiple(</span>
        <span class="hljs-comment">//     std::shared_ptr&lt;A&gt;(new A),</span>
        <span class="hljs-comment">//     std::shared_ptr&lt;B&gt;(new B)  // 多个new，风险更大！</span>
        <span class="hljs-comment">// );</span>
        
        <span class="hljs-comment">// 模式3：带复杂表达式的new</span>
        <span class="hljs-comment">// processComplex(</span>
        <span class="hljs-comment">//     std::shared_ptr&lt;Resource&gt;(new Resource(complexFunction())),</span>
        <span class="hljs-comment">//     otherArg</span>
        <span class="hljs-comment">// );</span>
        
        <span class="hljs-comment">// 模式4：return语句中直接new</span>
        <span class="hljs-comment">// return std::shared_ptr&lt;Resource&gt;(new Resource(args));</span>
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">safePatterns</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// 安全模式1：独立语句初始化</span>
        <span class="hljs-keyword">auto</span> resource = std::<span class="hljs-built_in">make_shared</span>&lt;LeakDetector&gt;();
        <span class="hljs-built_in">processResource</span>(resource, arg);
        
        <span class="hljs-comment">// 安全模式2：使用make_函数</span>
        <span class="hljs-keyword">return</span> std::<span class="hljs-built_in">make_shared</span>&lt;LeakDetector&gt;();
        
        <span class="hljs-comment">// 安全模式3：工厂方法</span>
        <span class="hljs-keyword">return</span> ObjectFactory::<span class="hljs-built_in">createSafeResource</span>(<span class="hljs-string">"safe"</span>, <span class="hljs-number">123</span>);
    }
};
</code></pre>
<hr/>
<h3 data-id="heading-21"><strong>实战案例：复杂系统设计</strong></h3>
<h4 data-id="heading-22"><strong>案例1：Web服务器连接管理</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;memory&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;vector&gt;</span></span>

<span class="hljs-keyword">class</span> <span class="hljs-title class_">HttpRequest</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">HttpRequest</span>(<span class="hljs-type">const</span> std::string&amp; method, <span class="hljs-type">const</span> std::string&amp; path) 
        : <span class="hljs-built_in">method_</span>(method), <span class="hljs-built_in">path_</span>(path) {
        std::cout &lt;&lt; <span class="hljs-string">"创建HTTP请求: "</span> &lt;&lt; method &lt;&lt; <span class="hljs-string">" "</span> &lt;&lt; path &lt;&lt; std::endl;
    }
    
    ~<span class="hljs-built_in">HttpRequest</span>() {
        std::cout &lt;&lt; <span class="hljs-string">"销毁HTTP请求: "</span> &lt;&lt; method_ &lt;&lt; <span class="hljs-string">" "</span> &lt;&lt; path_ &lt;&lt; std::endl;
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">process</span><span class="hljs-params">()</span> </span>{
        std::cout &lt;&lt; <span class="hljs-string">"处理请求: "</span> &lt;&lt; method_ &lt;&lt; <span class="hljs-string">" "</span> &lt;&lt; path_ &lt;&lt; std::endl;
    }
    
<span class="hljs-keyword">private</span>:
    std::string method_;
    std::string path_;
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">DatabaseConnection</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">DatabaseConnection</span>(<span class="hljs-type">const</span> std::string&amp; dbName) : <span class="hljs-built_in">dbName_</span>(dbName) {
        std::cout &lt;&lt; <span class="hljs-string">"建立数据库连接: "</span> &lt;&lt; dbName &lt;&lt; std::endl;
    }
    
    ~<span class="hljs-built_in">DatabaseConnection</span>() {
        std::cout &lt;&lt; <span class="hljs-string">"关闭数据库连接: "</span> &lt;&lt; dbName_ &lt;&lt; std::endl;
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">query</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; sql)</span> </span>{
        std::cout &lt;&lt; <span class="hljs-string">"数据库查询: "</span> &lt;&lt; sql &lt;&lt; <span class="hljs-string">" on "</span> &lt;&lt; dbName_ &lt;&lt; std::endl;
    }
    
<span class="hljs-keyword">private</span>:
    std::string dbName_;
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">RequestProcessor</span> {
<span class="hljs-keyword">private</span>:
    std::shared_ptr&lt;DatabaseConnection&gt; dbConn_;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">RequestProcessor</span>(<span class="hljs-type">const</span> std::string&amp; dbName) {
        <span class="hljs-comment">// 安全：独立语句初始化数据库连接</span>
        dbConn_ = std::<span class="hljs-built_in">make_shared</span>&lt;DatabaseConnection&gt;(dbName);
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">processRequest</span><span class="hljs-params">(<span class="hljs-type">const</span> std::string&amp; method, <span class="hljs-type">const</span> std::string&amp; path)</span> </span>{
        <span class="hljs-comment">// 安全：独立语句创建请求对象</span>
        <span class="hljs-keyword">auto</span> request = std::<span class="hljs-built_in">make_shared</span>&lt;HttpRequest&gt;(method, path);
        
        <span class="hljs-comment">// 安全：所有资源都已由智能指针管理</span>
        <span class="hljs-keyword">try</span> {
            request-&gt;<span class="hljs-built_in">process</span>();
            dbConn_-&gt;<span class="hljs-built_in">query</span>(<span class="hljs-string">"SELECT * FROM users WHERE active = 1"</span>);
            
            <span class="hljs-comment">// 模拟可能抛出异常的业务逻辑</span>
            <span class="hljs-keyword">if</span> (path == <span class="hljs-string">"/dangerous"</span>) {
                <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"危险路径处理失败"</span>);
            }
            
        } <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) {
            std::cout &lt;&lt; <span class="hljs-string">"请求处理异常: "</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;
            <span class="hljs-comment">// 即使发生异常，request和dbConn_也会正确释放</span>
        }
    }
};

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">demonstrate_web_server_safety</span><span class="hljs-params">()</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"\n=== Web服务器异常安全演示 ==="</span> &lt;&lt; std::endl;
    
    <span class="hljs-function">RequestProcessor <span class="hljs-title">processor</span><span class="hljs-params">(<span class="hljs-string">"UserDatabase"</span>)</span></span>;
    
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// 正常请求</span>
        processor.<span class="hljs-built_in">processRequest</span>(<span class="hljs-string">"GET"</span>, <span class="hljs-string">"/api/users"</span>);
        
        <span class="hljs-comment">// 危险请求 - 会抛出异常</span>
        processor.<span class="hljs-built_in">processRequest</span>(<span class="hljs-string">"POST"</span>, <span class="hljs-string">"/dangerous"</span>);
        
    } <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) {
        std::cout &lt;&lt; <span class="hljs-string">"服务器异常: "</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;
    }
    
    std::cout &lt;&lt; <span class="hljs-string">"Web服务器演示结束"</span> &lt;&lt; std::endl;
}
</code></pre>
<h4 data-id="heading-23"><strong>案例2：图形渲染引擎资源管理</strong></h4>
<pre><code class="hljs language-cpp" lang="cpp"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Texture</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">Texture</span>(<span class="hljs-type">const</span> std::string&amp; name, <span class="hljs-type">int</span> width, <span class="hljs-type">int</span> height) 
        : <span class="hljs-built_in">name_</span>(name), <span class="hljs-built_in">width_</span>(width), <span class="hljs-built_in">height_</span>(height) {
        std::cout &lt;&lt; <span class="hljs-string">"加载纹理: "</span> &lt;&lt; name &lt;&lt; <span class="hljs-string">" ("</span> &lt;&lt; width &lt;&lt; <span class="hljs-string">"x"</span> &lt;&lt; height &lt;&lt; <span class="hljs-string">")"</span> &lt;&lt; std::endl;
    }
    
    ~<span class="hljs-built_in">Texture</span>() {
        std::cout &lt;&lt; <span class="hljs-string">"卸载纹理: "</span> &lt;&lt; name_ &lt;&lt; std::endl;
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">bind</span><span class="hljs-params">()</span> </span>{
        std::cout &lt;&lt; <span class="hljs-string">"绑定纹理: "</span> &lt;&lt; name_ &lt;&lt; std::endl;
    }
    
<span class="hljs-keyword">private</span>:
    std::string name_;
    <span class="hljs-type">int</span> width_, height_;
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Shader</span> {
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">Shader</span>(<span class="hljs-type">const</span> std::string&amp; name, <span class="hljs-type">const</span> std::string&amp; source) 
        : <span class="hljs-built_in">name_</span>(name) {
        std::cout &lt;&lt; <span class="hljs-string">"编译着色器: "</span> &lt;&lt; name &lt;&lt; std::endl;
    }
    
    ~<span class="hljs-built_in">Shader</span>() {
        std::cout &lt;&lt; <span class="hljs-string">"销毁着色器: "</span> &lt;&lt; name_ &lt;&lt; std::endl;
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">use</span><span class="hljs-params">()</span> </span>{
        std::cout &lt;&lt; <span class="hljs-string">"使用着色器: "</span> &lt;&lt; name_ &lt;&lt; std::endl;
    }
    
<span class="hljs-keyword">private</span>:
    std::string name_;
};

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Renderer</span> {
<span class="hljs-keyword">private</span>:
    std::shared_ptr&lt;Texture&gt; diffuseMap_;
    std::shared_ptr&lt;Texture&gt; normalMap_;
    std::shared_ptr&lt;Shader&gt; mainShader_;
    
<span class="hljs-keyword">public</span>:
    <span class="hljs-built_in">Renderer</span>() {
        <span class="hljs-comment">// 安全初始化所有图形资源</span>
        <span class="hljs-built_in">initializeResources</span>();
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">initializeResources</span><span class="hljs-params">()</span> </span>{
        std::cout &lt;&lt; <span class="hljs-string">"=== 初始化图形资源 ==="</span> &lt;&lt; std::endl;
        
        <span class="hljs-comment">// 安全：独立语句初始化每个资源</span>
        diffuseMap_ = std::<span class="hljs-built_in">make_shared</span>&lt;Texture&gt;(<span class="hljs-string">"diffuse"</span>, <span class="hljs-number">1024</span>, <span class="hljs-number">1024</span>);
        normalMap_ = std::<span class="hljs-built_in">make_shared</span>&lt;Texture&gt;(<span class="hljs-string">"normal"</span>, <span class="hljs-number">512</span>, <span class="hljs-number">512</span>);
        mainShader_ = std::<span class="hljs-built_in">make_shared</span>&lt;Shader&gt;(<span class="hljs-string">"main"</span>, <span class="hljs-string">"vertex...fragment..."</span>);
        
        std::cout &lt;&lt; <span class="hljs-string">"所有图形资源初始化完成"</span> &lt;&lt; std::endl;
    }
    
    <span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">renderFrame</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 安全使用已初始化的资源</span>
            mainShader_-&gt;<span class="hljs-built_in">use</span>();
            diffuseMap_-&gt;<span class="hljs-built_in">bind</span>();
            normalMap_-&gt;<span class="hljs-built_in">bind</span>();
            
            std::cout &lt;&lt; <span class="hljs-string">"渲染帧完成"</span> &lt;&lt; std::endl;
            
            <span class="hljs-comment">// 模拟渲染错误</span>
            <span class="hljs-keyword">throw</span> std::<span class="hljs-built_in">runtime_error</span>(<span class="hljs-string">"GPU设备丢失"</span>);
            
        } <span class="hljs-built_in">catch</span> (<span class="hljs-type">const</span> std::exception&amp; e) {
            std::cout &lt;&lt; <span class="hljs-string">"渲染错误: "</span> &lt;&lt; e.<span class="hljs-built_in">what</span>() &lt;&lt; std::endl;
            <span class="hljs-comment">// 即使发生异常，所有纹理和着色器也会正确释放</span>
        }
    }
};

<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">demonstrate_graphics_engine</span><span class="hljs-params">()</span> </span>{
    std::cout &lt;&lt; <span class="hljs-string">"\n=== 图形引擎异常安全演示 ==="</span> &lt;&lt; std::endl;
    
    {
        Renderer renderer;
        renderer.<span class="hljs-built_in">renderFrame</span>();
    } <span class="hljs-comment">// Renderer析构时自动释放所有资源</span>
    
    std::cout &lt;&lt; <span class="hljs-string">"图形引擎演示结束"</span> &lt;&lt; std::endl;
}
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js第一章(入门)]]></title>    <link>https://juejin.cn/post/7571304204721504310</link>    <guid>https://juejin.cn/post/7571304204721504310</guid>    <pubDate>2025-11-11T08:27:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571304204721504310" data-draft-id="7571105461098577963" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js第一章(入门)"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-11T08:27:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小满zs"/> <meta itemprop="url" content="https://juejin.cn/user/2463384809252397"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js第一章(入门)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2463384809252397/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小满zs
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T08:27:08.000Z" title="Tue Nov 11 2025 08:27:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">开始使用 Next.js</h2>
<p>欢迎来到 Next.js 学习之旅！本教程将带你从零开始创建你的第一个 Next.js 应用。</p>
<p><strong>我们所学的版本是16.0.1</strong></p>
<h3 data-id="heading-1">什么是 Next.js？</h3>
<p>Next.js是一个基于React全栈框架，由Vercel开发和维护，那么它有什么优势呢？</p>
<ul>
<li><strong>SSR</strong>：服务端渲染，可以提高页面加载速度(现在会SSR的人才并不多，可以提升你的竞争力)</li>
<li><strong>SSG</strong>：静态站点生成，可以生成静态页面，类似于Vitepress / Astro等静态站点生成工具</li>
<li><strong>SEO</strong>: Next.js提供了SEO优化，让你的网站更容易被搜索引擎收录</li>
<li><strong>AI</strong>: Vercel提供了 AI SDK 可以跟Next.js轻松结合，让你可以轻松实现AI应用</li>
<li><strong>服务端操作</strong>: Next.js提供了服务端操作，顺便学习服务端知识，为以后做全栈开发打下基础</li>
<li><strong>社区丰富</strong>: Next.js拥有庞大的社区，可以让你轻松找到解决方案</li>
<li><strong>部署</strong>: 支持多种部署选项，与Vercel等平台集成良好，可以快速部署</li>
</ul>
<h3 data-id="heading-2">前置知识</h3>
<p>在学习Next.js之前，你需要掌握以下知识：</p>
<ul>
<li>HTML <code>熟练使用</code></li>
<li>CSS <code>熟练使用</code></li>
<li>JavaScript <code>熟练使用</code></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1wR4y1377K%2F%3Fspm_id_from%3D333.1387.homepage.video_card.click" target="_blank" title="https://www.bilibili.com/video/BV1wR4y1377K/?spm_id_from=333.1387.homepage.video_card.click" ref="nofollow noopener noreferrer">TypeScript</a> <code>基本使用即可</code></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1mcpPeMETt%2F%3Fspm_id_from%3D333.1387.homepage.video_card.click%26vd_source%3D7313597670b28c3c44c50e326d82d040" target="_blank" title="https://www.bilibili.com/video/BV1mcpPeMETt/?spm_id_from=333.1387.homepage.video_card.click&amp;vd_source=7313597670b28c3c44c50e326d82d040" ref="nofollow noopener noreferrer">React</a> <code>熟练使用</code></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.bilibili.com%2Fvideo%2FBV1cV4y1B7P4%2F%3Fspm_id_from%3D333.1387.homepage.video_card.click" target="_blank" title="https://www.bilibili.com/video/BV1cV4y1B7P4/?spm_id_from=333.1387.homepage.video_card.click" ref="nofollow noopener noreferrer">Node.js</a> <code>基本使用即可</code></li>
</ul>
<h3 data-id="heading-3">Next.js 市场情况</h3>
<p>截止：2025年11月11日，npm下载量</p>
<ul>
<li>Next.js: <code>13,294,097</code></li>
<li>Nuxt.js: <code>956,540</code></li>
<li>Astro: <code>747,707</code></li>
<li>SvelteKit: <code>626,494</code></li>
</ul>
<h3 data-id="heading-4">环境准备</h3>
<ul>
<li>Node.js环境 下载地址:<a href="https://link.juejin.cn?target=https%3A%2F%2Fnodejs.org%2Fen%2Fdownload%2F" target="_blank" title="https://nodejs.org/en/download/" ref="nofollow noopener noreferrer">nodejs.org/en/download</a> 注：最低版本要求<code>20.9</code>,主包用的是<code>22.17.0</code></li>
<li>代码编辑器 Vscode Cursor webStorm等皆可，不要用记事本就行。</li>
</ul>
<hr/>
<p><strong>预计学习时间</strong>: 2 分钟<br/>
<strong>难度级别</strong>: 初级 🟢</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何防止重复提交订单？——从踩坑到优雅落地的实战指南]]></title>    <link>https://juejin.cn/post/7571272874846109748</link>    <guid>https://juejin.cn/post/7571272874846109748</guid>    <pubDate>2025-11-11T08:28:15.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571272874846109748" data-draft-id="7571237750730522658" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何防止重复提交订单？——从踩坑到优雅落地的实战指南"/> <meta itemprop="keywords" content="架构,Java"/> <meta itemprop="datePublished" content="2025-11-11T08:28:15.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="狼爷"/> <meta itemprop="url" content="https://juejin.cn/user/2418581314208279"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何防止重复提交订单？——从踩坑到优雅落地的实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2418581314208279/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    狼爷
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T08:28:15.000Z" title="Tue Nov 11 2025 08:28:15 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:14px;overflow-x:hidden;color:var(--cyanosis-base-color);transition:color .35s;--cyanosis-base-color:#353535;--cyanosis-title-color:#005bb7;--cyanosis-strong-color:#2196f3;--cyanosis-em-color:#4fc3f7;--cyanosis-del-color:#ccc;--cyanosis-link-color:#3da8f5;--cyanosis-linkh-color:#007fff;--cyanosis-border-color:#bedcff;--cyanosis-border-color-2:#ececec;--cyanosis-bg-color:#fff;--cyanosis-blockquote-color:#8c8c8c;--cyanosis-blockquote-bg-color:#f0fdff;--cyanosis-code-color:#c2185b;--cyanosis-code-bg-color:#fff4f4;--cyanosis-code-pre-color:#f8f8f8;--cyanosis-table-border-color:#c3e0fd;--cyanosis-table-th-color:#dff0ff;--cyanosis-table-tht-color:#005bb7;--cyanosis-table-tr-nc-color:#f7fbff;--cyanosis-table-trh-color:#e0edf7;--cyanosis-slct-title-color:#005bb7;--cyanosis-slct-titlebg-color:rgba(175,207,247,0.25);--cyanosis-slct-text-color:#c80000;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#e8ebec;--cyanosis-slct-codebg-color:#ffeaeb;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body.__dark{--cyanosis-base-color:#cacaca;--cyanosis-title-color:#ddd;--cyanosis-strong-color:#fe9900;--cyanosis-em-color:#ffd28e;--cyanosis-del-color:#ccc;--cyanosis-link-color:#ffb648;--cyanosis-linkh-color:#fe9900;--cyanosis-border-color:#ffe3ba;--cyanosis-border-color-2:#ffcb7b;--cyanosis-bg-color:#2f2f2f;--cyanosis-blockquote-color:#c7c7c7;--cyanosis-blockquote-bg-color:rgba(255,199,116,0.1);--cyanosis-code-color:#000;--cyanosis-code-bg-color:#ffcb7b;--cyanosis-code-pre-color:rgba(255,227,185,0.5);--cyanosis-table-border-color:#fe9900;--cyanosis-table-th-color:#ffb648;--cyanosis-table-tht-color:#000;--cyanosis-table-tr-nc-color:#6d5736;--cyanosis-table-trh-color:#947443;--cyanosis-slct-title-color:#000;--cyanosis-slct-titlebg-color:#fe9900;--cyanosis-slct-text-color:#00c888;--cyanosis-slct-bg-color:rgba(175,207,247,0.25);--cyanosis-slct-del-color:#999;--cyanosis-slct-elbg-color:#000;--cyanosis-slct-codebg-color:#ffcb7b;--cyanosis-slct-prebg-color:rgba(160,200,255,0.25)}.markdown-body h1{padding-bottom:4px;font-size:30px}.markdown-body h1,.markdown-body h2{margin-top:36px;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);transition:color .35s}.markdown-body h2{position:relative;padding-left:10px;padding-right:10px;padding-bottom:10px;font-size:24px;border-bottom:1px solid var(--cyanosis-border-color-2)}.markdown-body h2:before{content:"「";position:absolute;top:-6px;left:-14px}.markdown-body h2:after{content:"」";position:relative;top:6px;right:auto}.markdown-body h3{position:relative;padding-bottom:0;margin-top:30px;margin-bottom:10px;font-size:20px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h3:before{content:"»";padding-right:6px;color:var(--cyanosis-strong-color)}.markdown-body h4{margin-top:24px;font-size:16px}.markdown-body h4,.markdown-body h5{padding-bottom:0;margin-bottom:10px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body h5{margin-top:18px;font-size:14px}.markdown-body h6{padding-bottom:0;margin-top:12px;margin-bottom:10px;font-size:12px;line-height:1.5;color:var(--cyanosis-title-color);padding-left:6px;transition:color .35s}.markdown-body p{line-height:inherit;margin-top:16px;margin-bottom:16px}.markdown-body img{max-width:100%}.markdown-body hr{position:relative;width:98%;height:1px;margin-top:32px;margin-bottom:32px;background-image:linear-gradient(90deg,var(--cyanosis-link-color),rgba(255,0,0,.3),hsla(0,0%,100%,.1),rgba(255,0,0,.3),var(--cyanosis-link-color));border-width:0;overflow:visible}.markdown-body hr:after{content:"";position:absolute;margin:auto;left:0;right:0;bottom:0;top:0;display:inline-block;width:60px;height:20px;background-color:var(--cyanosis-bg-color);background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAgCAYAAABgrToAAAADoklEQVRYR82XTYgcRRTHf2933Q1RjAa9eFO8JHoJ8RQVBQ2iBwXBET0YEUTXNVmNQtTpmeqaWV0XNRq/o4KoECSCEPSg4CF+BYUkIIiCoCJCPIhC/Ihh2Z0nVV27VnZnenumW9i6ddV7//frV69fVQurfMgq56NawFTPAU6QyomqXrw6wIZeyhCPebA5buNR+akKyGoAjd6BshthnYdSjqNcRVuOlIUsD2j0SuA94IwuMHdh5ZUykOUBXfSGbmKI54EtAeYIHSZoy5dl4JxvNYBOKdW1KE8BQ8AkVk6WhasWsAiN0TX9gveXQaPP+Aytpc4u+bMI06JNohsYYYYOR2lJWtS3OKDRfcAtQfgDoI6Vo4UCGb0OmAEuDvZvYmVbEd/igC3dzDz7gQu8sPA9kJDK27mBmjqBeLjTg90PDFOjWawFFQd06kZHEfaj3LAIpTRpSXsZ5E06zEYP9sDimnAApYaV2SLZG/wjMeqAkijwW4xQJ5Gf/ZzRC8OW3hiBTGGlURRswW55Bh/Ssxljrwew8l1PQaM14GngvGDzBUKdDsMeTtgU5o8B92PFlUf3YXUrHa7Fys6lBqcCGnX15YQ2A18FyPd7Crd1A3M8C1wdbH4DD3hWeP6IEXbQkG97ajR1HPFnuPP5jFFq1OWX7hl8WM9l1AO648uNfwLk7tytMeogty+xeQ4rO3r6bdcx1nuwOGsHmaXGtPzae4uzGnLH1kQkvpdZGrHjssBZJrL+pqS05KWc8tgITAPXRzYvYOXe/C2OV43eDcRBDtIhoS2f9wzc0Cv8Wls+zoFzUC5zF0U241h5uZtPfptp6OUM8wbK+cH5GEpCS17P3fJei0Z3+npTxryJ8CPzbKMtn/ZyWbkPGl0PuFPkmkjkcb4h4R2ZLwRq1H0ALmvjkf2HwK1Y+T1PY2XABe/sHJ6MxN5lnoSpnC/UGbsTaI5phK2R7x6s3Ffk5YoDOrWm3onwJHBmEP86bPmBrsGaenNoIdnxCH+gPEhLXi0Cl1VBvyPVLSh7gEuC62yAfOIUqabWEaaiucMIk6RyqJ+Q/QM69V26jjW86Gvov/EaoyT8zRCn+Xq7PVrbx0nuYUaO9wM3WAbjCE1NEUw09Um4UV+2OKfYfu5/S19gsAzGKqm6LE5FrShbdS0ku465DjDwKA/oQht19ejqbaEVuRbiLhuHByYLjtUAZpDutzP7cYdHsPJXWbjyNVgFwQoa1WXwf4Jd9YD/Ap80+yE7+u9aAAAAAElFTkSuQmCC);background-repeat:no-repeat;background-size:auto 100%;background-position-x:center;transition:background-color .5s}.markdown-body code{padding:.065em .4em;font-size:.87em;color:var(--cyanosis-code-color);word-break:break-word;overflow-x:auto;background-color:var(--cyanosis-code-bg-color);border-radius:2px}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{display:block;padding:16px 12px;margin:0;font-size:12px;color:#333;word-break:normal;overflow-x:auto;background:var(--cyanosis-code-pre-color)}.markdown-body pre&gt;code::-webkit-scrollbar{width:4px;height:4px}.markdown-body pre&gt;code::-webkit-scrollbar-track{background-color:var(--cyanosis-border-color)}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:var(--cyanosis-strong-color);border-radius:10px}.markdown-body a{position:relative;text-decoration:none;color:var(--cyanosis-link-color);border-bottom:1px solid var(--cyanosis-border-color)}.markdown-body a:hover{border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body a:active,.markdown-body a:hover{color:var(--cyanosis-linkh-color)}.markdown-body a:after{position:absolute;content:"";top:100%;left:0;width:100%;opacity:0;border-bottom:1px solid var(--cyanosis-border-color);transition:top .3s,opacity .3s;transform:translateZ(0)}.markdown-body a:hover:after{top:0;opacity:1;border-bottom-color:var(--cyanosis-linkh-color)}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid var(--cyanosis-table-border-color);border-spacing:0;border-collapse:collapse}.markdown-body table thead{color:#000;text-align:left;font-size:14px;background:#f6f6f6}.markdown-body table tr:nth-child(2n){background-color:var(--cyanosis-table-tr-nc-color)}.markdown-body table tr:hover{background-color:var(--cyanosis-table-trh-color)}.markdown-body table td,.markdown-body table th{padding:12px 8px;line-height:24px;border:1px solid var(--cyanosis-table-border-color)}.markdown-body table th{color:var(--cyanosis-table-tht-color);background-color:var(--cyanosis-table-th-color)}.markdown-body table td{min-width:120px}.markdown-body blockquote{color:var(--cyanosis-blockquote-color);border-left:4px solid var(--cyanosis-strong-color);background-color:var(--cyanosis-blockquote-bg-color);padding:1px 20px;margin:22px 0;transition:color .35s}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body b,.markdown-body blockquote&gt;b,.markdown-body blockquote&gt;strong,.markdown-body strong{color:var(--cyanosis-strong-color)}.markdown-body em,.markdown-body i{color:var(--cyanosis-em-color)}.markdown-body del{color:var(--cyanosis-del-color)}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:4px}.markdown-body ol li{padding-left:6px}.markdown-body details&gt;summary{outline:none;color:var(--cyanosis-title-color);font-size:20px;font-weight:bolder;border-bottom:1px solid var(--cyanosis-border-color);cursor:pointer}.markdown-body details&gt;p{padding:10px 20px;margin:10px 0 0;color:#666;background-color:var(--cyanosis-blockquote-bg-color);border:2px dashed var(--cyanosis-strong-color)}.markdown-body h1::selection,.markdown-body h2::selection,.markdown-body h3::selection,.markdown-body h4::selection,.markdown-body h5::selection,.markdown-body h6::selection{color:var(--cyanosis-slct-title-color);background-color:var(--cyanosis-slct-titlebg-color)}.markdown-body ol li::selection,.markdown-body p::selection,.markdown-body ul li::selection{color:var(--cyanosis-slct-text-color);background-color:var(--cyanosis-slct-bg-color)}.markdown-body a::selection,.markdown-body b::selection,.markdown-body em::selection,.markdown-body i::selection,.markdown-body strong::selection{background-color:var(--cyanosis-slct-elbg-color)}.markdown-body del::selection{color:var(--cyanosis-slct-del-color);background-color:var(--cyanosis-slct-elbg-color)}.markdown-body table thead th::selection{background-color:transparent}.markdown-body table tbody td::selection{background-color:var(--cyanosis-slct-bg-color)}.markdown-body code::selection{background-color:var(--cyanosis-slct-codebg-color)}.markdown-body pre&gt;code::selection{background-color:var(--cyanosis-slct-prebg-color)}.markdown-body .contains-task-list{padding-left:14px;list-style:none}.markdown-body .contains-task-list input[type=checkbox]{position:relative}.markdown-body .contains-task-list input[type=checkbox]:before{content:"";position:absolute;top:0;left:0;right:0;bottom:0;width:inherit;height:inherit;background:#f0f8ff;border:1px solid #add6ff;border-radius:2px;box-sizing:border-box;z-index:1}.markdown-body .contains-task-list input[type=checkbox]:checked:after{content:"✓";position:absolute;top:-12px;left:0;right:0;bottom:0;width:0;height:0;color:#f55;font-size:20px;font-weight:700;z-index:2}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="srcery">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#1c1b19;color:#fce8c3}.hljs-emphasis,.hljs-strong{color:#918175}.hljs-bullet,.hljs-link,.hljs-literal,.hljs-number,.hljs-quote,.hljs-regexp{color:#ff5c8f}.hljs-code,.hljs-selector-class{color:#68a8e4}.hljs-emphasis{font-style:italic}.hljs-attribute,.hljs-keyword,.hljs-section,.hljs-selector-tag,.hljs-variable{color:#ef2f27}.hljs-name,.hljs-title{color:#fbb829}.hljs-params,.hljs-type{color:#0aaeb3}.hljs-string{color:#98bc37}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-selector-attr,.hljs-selector-id,.hljs-selector-pseudo,.hljs-subst,.hljs-symbol,.hljs-template-tag,.hljs-template-variable{color:#c07abe}.hljs-comment,.hljs-deletion,.hljs-meta{color:#918175}</style><blockquote>
<p>一次点击，下单成功；两次点击，客服崩溃。<br/>
重复提交订单的问题，几乎每个后端都遇到过。今天咱们就从底层逻辑到实战代码，聊聊这个老生常谈却又暗藏玄机的话题。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">💡 一、背景：为什么会重复提交？</h2>
<p>先说场景。</p>
<p>用户点了一次“立即支付”，发现没反应，再点一次，结果悲剧发生：</p>
<ul>
<li>生成了两笔订单；</li>
<li>扣了两次库存；</li>
<li>财务对账炸了锅。</li>
</ul>
<p>这还只是正常用户，有的还会：</p>
<ul>
<li>前端按钮没禁用，点个爽；</li>
<li>支付网关超时自动重试；</li>
<li>脚本自动刷单接口。</li>
</ul>
<p>于是，后端同学开始加锁、加幂等、加约束，最后一看，代码又胖了一圈。</p>
<hr/>
<h2 data-id="heading-1">🧱 二、常见的防重复提交方案</h2>
<p>其实防重复提交的核心目标就一句话：</p>
<blockquote>
<p><strong>在一定时间内，确保同一个请求只被处理一次。</strong></p>
</blockquote>
<p>从架构层次看，可以分为：</p>



































<table><thead><tr><th>层次</th><th>方案</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>前端层</td><td>按钮防抖 / 禁用</td><td>简单直观</td><td>不可靠，易被跳过</td></tr><tr><td>网关层</td><td>幂等性Key</td><td>通用</td><td>实现复杂</td></tr><tr><td>服务层</td><td>Redis分布式锁</td><td>高性能</td><td>需要良好锁管理</td></tr><tr><td>数据库层</td><td>唯一索引 / 状态判断</td><td>最稳</td><td>执行慢，影响性能</td></tr></tbody></table>
<p>实际生产中，<strong>一般会前后端双保险</strong>：<br/>
👉 前端防抖 + 后端幂等控制。</p>
<hr/>
<h2 data-id="heading-2">🔑 三、服务端防重复提交的常见思路</h2>
<p>来点干货。<br/>
后端层面常用的方案主要有三种。</p>
<hr/>
<h3 data-id="heading-3">✅ 方案一：幂等性 Token 机制（推荐）</h3>
<p><strong>核心逻辑：</strong></p>
<ol>
<li>前端先调用 <code>/token</code> 接口，获取一个随机 <code>token</code>；</li>
<li>请求下单时携带该 token；</li>
<li>后端校验 token 是否已使用；</li>
<li>没用过 → 处理业务并标记“已使用”；<br/>
用过 → 拒绝请求。</li>
</ol>
<p>👉 非常适合「表单类接口」或「下单支付类接口」。</p>
<p><strong>伪流程：</strong></p>
<pre><code class="hljs language-rust" lang="rust">前端请求 token <span class="hljs-punctuation">-&gt;</span> 缓存保存 token <span class="hljs-punctuation">-&gt;</span> 请求接口时携带 token <span class="hljs-punctuation">-&gt;</span> 校验通过一次后删除 token
</code></pre>
<hr/>
<h3 data-id="heading-4">✅ 方案二：Redis 分布式锁机制</h3>
<p>使用 Redis 的 <code>SETNX</code>（或 Redisson）实现业务级互斥锁：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-type">boolean</span> lock = redis.setIfAbsent(<span class="hljs-keyword">key</span>, <span class="hljs-string">"1"</span>, <span class="hljs-number">5</span>, TimeUnit.SECONDS);
<span class="hljs-keyword">if</span> (!lock) {
    <span class="hljs-keyword">throw</span> <span class="hljs-built_in">new</span> BusinessException(<span class="hljs-string">"请勿重复提交"</span>);
}
<span class="hljs-keyword">try</span> {
    createOrder();
} <span class="hljs-keyword">finally</span> {
    redis.delete(<span class="hljs-keyword">key</span>);
}
</code></pre>
<p>比如 key 可设计为：</p>
<pre><code class="hljs language-less" lang="less">lock:<span class="hljs-attribute">order</span>:<span class="hljs-attribute">create</span>:<span class="hljs-attribute">userId</span>:<span class="hljs-number">123</span>
</code></pre>
<p>优点：</p>
<ul>
<li>性能高</li>
<li>实现简单</li>
<li>适合短时间的防重需求</li>
</ul>
<p>缺点：</p>
<ul>
<li>需要注意锁过期与释放问题。</li>
</ul>
<hr/>
<h3 data-id="heading-5">✅ 方案三：数据库层幂等约束</h3>
<p>老实人的方案——数据库唯一索引。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> t_order <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">UNIQUE</span> KEY uk_order_no (order_no);
</code></pre>
<p>或者逻辑判断：</p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-keyword">if</span> (orderRepository.existsByOrderNo(orderNo)) {
    <span class="hljs-built_in">log</span>.info(<span class="hljs-string">"订单重复提交: {}"</span>, orderNo);
    <span class="hljs-keyword">return</span>;
}
</code></pre>
<p>优点：稳如老狗。<br/>
缺点：性能不高，适合作为兜底。</p>
<hr/>
<h2 data-id="heading-6">🧭 四、综合方案流程图</h2>
<p>下面是一个比较推荐的方案：<br/>
<strong>幂等Token + Redis锁 双层防护</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/126e8a2341b4461492d0804cf2582f3d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg54u854i3:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763455349&amp;x-signature=0mW4Ex1axTDpgO3hAHdcDSPwUFo%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-7">💻 五、实战代码（Spring Boot）</h2>
<h3 data-id="heading-8">🧩 1. 获取幂等 Token 接口</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/api/token"</span>)
public class TokenController {

    <span class="hljs-variable">@Autowired</span>
    private StringRedisTemplate redisTemplate;

    <span class="hljs-variable">@GetMapping</span>(<span class="hljs-string">"/generate"</span>)
    public String <span class="hljs-built_in">generateToken</span>() {
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">token</span> = <span class="hljs-selector-tag">UUID</span><span class="hljs-selector-class">.randomUUID</span>()<span class="hljs-selector-class">.toString</span>();
        <span class="hljs-selector-tag">redisTemplate</span><span class="hljs-selector-class">.opsForValue</span>()<span class="hljs-selector-class">.set</span>(<span class="hljs-string">"token:"</span> + token, <span class="hljs-string">"1"</span>, <span class="hljs-number">10</span>, TimeUnit.MINUTES);
        <span class="hljs-selector-tag">return</span> <span class="hljs-selector-tag">token</span>;
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-9">🧩 2. 下单接口（幂等 + Redis锁）</h3>
<pre><code class="hljs language-less" lang="less"><span class="hljs-variable">@RestController</span>
<span class="hljs-variable">@RequestMapping</span>(<span class="hljs-string">"/api/order"</span>)
public class OrderController {

    <span class="hljs-variable">@Autowired</span>
    private StringRedisTemplate redisTemplate;

    <span class="hljs-variable">@PostMapping</span>(<span class="hljs-string">"/create"</span>)
    public String <span class="hljs-built_in">createOrder</span>(<span class="hljs-variable">@RequestHeader</span>(<span class="hljs-string">"Idempotency-Token"</span>) String token,
                              <span class="hljs-variable">@RequestBody</span> OrderRequest request) {
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">key</span> = "<span class="hljs-selector-tag">token</span>:" + <span class="hljs-selector-tag">token</span>;

        <span class="hljs-comment">// 校验token是否存在</span>
        <span class="hljs-selector-tag">Boolean</span> <span class="hljs-selector-tag">exists</span> = <span class="hljs-selector-tag">redisTemplate</span><span class="hljs-selector-class">.hasKey</span>(key);
        <span class="hljs-selector-tag">if</span> (Boolean.FALSE.<span class="hljs-built_in">equals</span>(exists)) {
            <span class="hljs-selector-tag">throw</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">BusinessException</span>(<span class="hljs-string">"请勿重复提交"</span>);
        }

        <span class="hljs-comment">// 删除token，确保一次性</span>
        <span class="hljs-selector-tag">redisTemplate</span><span class="hljs-selector-class">.delete</span>(key);

        <span class="hljs-comment">// 加锁防并发</span>
        <span class="hljs-selector-tag">String</span> <span class="hljs-selector-tag">lockKey</span> = "<span class="hljs-selector-tag">lock</span>:<span class="hljs-selector-tag">order</span>:<span class="hljs-selector-tag">create</span>:" + <span class="hljs-selector-tag">request</span><span class="hljs-selector-class">.getUserId</span>();
        <span class="hljs-selector-tag">Boolean</span> <span class="hljs-selector-tag">locked</span> = <span class="hljs-selector-tag">redisTemplate</span><span class="hljs-selector-class">.opsForValue</span>()
                <span class="hljs-selector-class">.setIfAbsent</span>(lockKey, <span class="hljs-string">"1"</span>, <span class="hljs-number">5</span>, TimeUnit.SECONDS);

        <span class="hljs-selector-tag">if</span> (Boolean.FALSE.<span class="hljs-built_in">equals</span>(locked)) {
            <span class="hljs-selector-tag">throw</span> <span class="hljs-selector-tag">new</span> <span class="hljs-selector-tag">BusinessException</span>(<span class="hljs-string">"请勿重复点击"</span>);
        }

        <span class="hljs-selector-tag">try</span> {
            <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> 创建订单逻辑</span>
            <span class="hljs-selector-tag">return</span> "下单成功";
        } <span class="hljs-selector-tag">finally</span> {
            <span class="hljs-selector-tag">redisTemplate</span><span class="hljs-selector-class">.delete</span>(lockKey);
        }
    }
}
</code></pre>
<hr/>
<h2 data-id="heading-10">⚙️ 六、最佳实践经验总结</h2>





























<table><thead><tr><th>项目</th><th>建议</th></tr></thead><tbody><tr><td>Token有效期</td><td>建议 5～10 分钟</td></tr><tr><td>锁粒度</td><td>以用户ID 或 业务单号为单位</td></tr><tr><td>幂等Key传递方式</td><td>推荐放在 Header 中，例如 <code>Idempotency-Token</code></td></tr><tr><td>数据库层兜底</td><td>唯一约束防止极端情况</td></tr><tr><td>日志</td><td>建议记录 Token 与锁状态，方便排查</td></tr></tbody></table>
<p>一句话总结：</p>
<blockquote>
<p><strong>Redis防快点，数据库防慢点，前端防乱点。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-11">🧠 七、总结</h2>





























<table><thead><tr><th>层级</th><th>手段</th><th>优点</th><th>备注</th></tr></thead><tbody><tr><td>前端</td><td>按钮防抖</td><td>用户体验好</td><td>仅表层防护</td></tr><tr><td>Redis</td><td>Token + Lock</td><td>性能高</td><td>推荐主力方案</td></tr><tr><td>数据库</td><td>唯一约束</td><td>稳定</td><td>最终兜底</td></tr></tbody></table>
<p>最终结论：</p>
<blockquote>
<p>没有银弹，只有多层防御。<br/>
前端防抖 + 后端幂等 + 数据库约束 = 才是真正的生产级防重复方案。</p>
</blockquote>
<hr/>
<h2 data-id="heading-12">✨ 写在最后</h2>
<p>防重复提交这事，说简单也简单，说复杂也复杂。<br/>
它考验的不是写代码的能力，而是你对<strong>业务一致性</strong>和<strong>系统幂等性</strong>的理解。</p>
<p>下次再有人问你“为什么我点两次下单按钮扣了两次钱”，<br/>
你可以淡定地说一句——</p>
<blockquote>
<p>“兄弟，我们系统现在有幂等锁，不怕你点三次。”</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[基础需求就用AI写代码，你会焦虑吗？]]></title>    <link>https://juejin.cn/post/7571281406509301811</link>    <guid>https://juejin.cn/post/7571281406509301811</guid>    <pubDate>2025-11-11T08:35:08.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571281406509301811" data-draft-id="7571086754880503854" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="基础需求就用AI写代码，你会焦虑吗？"/> <meta itemprop="keywords" content="后端,前端,Java"/> <meta itemprop="datePublished" content="2025-11-11T08:35:08.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="前端小张同学"/> <meta itemprop="url" content="https://juejin.cn/user/1922381414934589"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            基础需求就用AI写代码，你会焦虑吗？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1922381414934589/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    前端小张同学
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T08:35:08.000Z" title="Tue Nov 11 2025 08:35:08 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是<a href="https://juejin.cn/user/1922381414934589" title="https://juejin.cn/user/1922381414934589" target="_blank">前端小张同学</a>，最近也是退出了xx银行，来到了一家私企干全栈开发，其实本人也是之前了解过一些java基础的代码编写是没问题的，最近AI编码是发展太快了，特别是 cursor 中 Claude-4.5.sonnet 模型那编码速度和理解能力是杠杠的，但我想和大家讨论，这样子趋势下去，你会焦虑吗？</p>
<h2 data-id="heading-0">1.程序员发展的趋势</h2>
<p>目前的趋势看来，未来的程序员将会成为:</p>
<p>前端 + 后端  = 全栈</p>
<p>很大概率程序员的数量将会减少 原来 五个人能干的事情 现在 只需要 三个人或者两个人，有了AI的辅助，基础工作真的完全可以省略掉，我依稀记得2022年我写的一套管理系统 一个增删改查页面写的快的话 至少也得半天，前几天我用 cursor 写的 整套 前端加后端 一起 增删改查 也只需要最多两小时。</p>
<p>经历:</p>
<p><a href="https://juejin.cn/user/1922381414934589" title="https://juejin.cn/user/1922381414934589" target="_blank">前端小张同学</a> 干程序员也有三年多了，今年九月份从上家单位离职，果断从xx金融企业出来，一个是自身因素，另外一个也是因为外界因素毕竟在一个企业呆了三年也差不多了。那我在上家公司主要是负责 干前端，但我来到新的公司 已经成为了 全栈工程师，说说我的感受吧，新公司是一个传统建筑企业公司，目前我是第一个加入研发部门的，你可以理解为公司还没成立研发部，但我为什么还会选择呢？主要出于几个原因</p>
<p>1：自身的发展和学习</p>
<p>2：让AI在工作中进行应用</p>
<p>3：企业的发展方向需要进行转型，希望可以在这个过程中做一些事情。</p>
<p>总结：</p>
<p>我个人认为以后一定会往全栈工程师方向发展，因为前端现在基本上可以被平替掉了，所以各位还在岗的工程师你们需要继续学习了，无论是学习AI 还是 后端语言，这些都是你目前要知道的方向。</p>
<h2 data-id="heading-1">2.AI编码的发展</h2>
<h3 data-id="heading-2">2.1：选择模型</h3>
<p>我用AI开发也有一段时间了 给大家推荐几个模型</p>
<p>1: 首选当然是 Claude-4.5.sonnet 😭</p>
<p>2: cursor 自主研发的 composer 1</p>
<p>3: Grok code</p>
<p>4: Kimi K2</p>
<h3 data-id="heading-3">2.2：模型的优缺点</h3>
<p>个人认为 Claude-4.5.sonnet 是我理想的模型，虽然它很喜欢写文档 😊，每次写一点代码就给你总结一下，但你可以通过 cursor rules 进行规避</p>
<h4 data-id="heading-4">Claude-4.5.sonnet</h4>
<p>完美，一切都挺好，就是贼喜欢写文档。</p>
<h4 data-id="heading-5">composer1</h4>
<p>优点：响应速度极快，生成速度达每秒 250 个 token，是同类顶级模型的 4 倍，多数任务可在 30 秒内完成，能契合开发者实时交互需求。</p>
<p>缺点：
复杂架构设计任务能力不足，面对深层系统架构规划、极致性能优化等复杂工作，表现不及 Claude - 4.5 Sonnet 等顶级模型。</p>
<h4 data-id="heading-6">Grok Code</h4>
<p>优点：性价比高，使用成本低，适合个人开发者长期高频使用，降低日常开发的时间与经济成本。</p>
<p>缺点：复杂逻辑处理能力薄弱，面对多模块联动的大型项目开发、复杂算法设计时，易出现漏洞，感觉不太行</p>
<h4 data-id="heading-7">Kimi K2</h4>
<p>优点：开源且成本低，遵循 Apache - 2.0 协议，支持自托管与微调，API 输入输出价格低廉，降低企业与开发者的使用门槛。</p>
<p>缺点：不支持多模态和思维模式功能，无法处理图片等非文本内容，对比 Claude - 4.5 Sonnet 存在功能缺失。</p>
<h2 data-id="heading-8">3.未来程序员面试的方向</h2>
<p>在今年的环境下，我已经感受到，现在已经不像不像以前的面试了，除了那些小外包公司基本上现在面试要么场景题，要么AI使用的怎么样？MCP 根据啥的，就目前看来，以后的面试比如说给你一个场景题，更多的考虑你这个人的想法，以及对这个功能的设计和实现过程，看看你的想法是否满足现在的市场，有没有解决过实际的企业问题，当有问题了再往解决方案去探讨深究，接下来再进行编码方向的问题，大概率会往这个方向发展。</p>
<p>以前的什么 vue的响应式原理 diff算法啥的这些就不要想了，迟早会被淘汰，现在AI看代码比人看代码的速度快得多，所以不要再去纠结学什么技术了，不过我这里的建议是 AI也不是万能的 ，AI只是辅助你开发代码，前提是你要看得懂，不然就会陷入被动了，所以你需要一定的基础再进行。</p>
<h2 data-id="heading-9">4.应该如何学习，避免产生焦虑</h2>
<p>不知道大家有没有这种感受</p>
<p><strong>1：AI现在啥都能干了，以后怎么办？</strong></p>
<p>大家伙不必焦虑，AI能干的你也能干，AI不能干的你还是能干，昨天了解到一个岗位叫做，善后工程师，大家可以去了解了解，其实就是 AI帮助我们完成了 百分之 80%的工作，还有 20% AI很难做到完美，此时善后工程师就要登场了，结合AI一起完成这百分之20 大家可以努力做善后工程师，哈哈哈。</p>
<p><strong>2：AI一直写代码，这写完自己都不会写代码了怎么办？</strong></p>
<h3 data-id="heading-10">核心问题：用 AI 的方式错了</h3>
<ul>
<li>直接让 AI 写完整代码，自己只复制粘贴，跳过了 “思考逻辑→拆解问题→调试优化” 的核心过程。</li>
<li>长期下来，大脑对代码的 “肌肉记忆” 和 “问题拆解能力” 会退化，就像长期用导航会忘路一样。</li>
</ul>
<h3 data-id="heading-11">调整方案：把 AI 变成 “辅助工具”</h3>
<ol>
<li>先自己拆解问题，写伪代码或核心逻辑，再让 AI 补细节。比如先明确 “要实现用户登录，需要验证手机号、密码加密、生成 token”，再让 AI 写具体语法，自己审核调整。</li>
<li>用 AI 查 “方法” 而非 “成品”。遇到不会的语法或 API，让 AI 解释 “为什么这么写”“有没有替代方案”，而不是直接要完整代码。</li>
<li>强制保留 “独立调试” 环节。AI 写的代码大概率有适配问题，必须自己动手改 bug，这个过程能快速唤醒代码感知。</li>
<li>定期 “断 AI 练习”。每周 留 1-2 个小需求，完全不用 AI，从 0 到 1 写出来，哪怕写得慢、有 bug，也能巩固基础。</li>
</ol>
<p><strong>3：AI好像慢慢干的事情越来越多，越来越智能，那岂不是直接失业了？</strong></p>
<p>相信一句话，你的存在必然有你的价值，你只需往前继续前行，其他的将由命运来抉择</p>
<p>AI 更像是推动行业升级的 “催化剂”，而非让人类失业的 “终结者”。与其担心失业，不如主动学习 AI 工具，深耕需要人类独特能力的领域，在变革中找到自己的不可替代性。</p>
<p>我是小张同学，谢谢你的关注。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[LangChain1.0智能体开发：MCP]]></title>    <link>https://juejin.cn/post/7571156741397626895</link>    <guid>https://juejin.cn/post/7571156741397626895</guid>    <pubDate>2025-11-11T08:16:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571156741397626895" data-draft-id="7571156741397512207" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="LangChain1.0智能体开发：MCP"/> <meta itemprop="keywords" content="Agent,LangChain,后端"/> <meta itemprop="datePublished" content="2025-11-11T08:16:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="FreeCode"/> <meta itemprop="url" content="https://juejin.cn/user/1282499717900794"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            LangChain1.0智能体开发：MCP
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1282499717900794/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    FreeCode
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T08:16:37.000Z" title="Tue Nov 11 2025 08:16:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="" data-highlight-key="a11y-dark">.hljs-comment,.hljs-quote{color:#d4d0ab}.hljs-deletion,.hljs-name,.hljs-regexp,.hljs-selector-class,.hljs-selector-id,.hljs-tag,.hljs-template-variable,.hljs-variable{color:#ffa07a}.hljs-built_in,.hljs-builtin-name,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-type{color:#f5ab35}.hljs-attribute{color:gold}.hljs-addition,.hljs-bullet,.hljs-string,.hljs-symbol{color:#abe338}.hljs-section,.hljs-title{color:#00e0e0}.hljs-keyword,.hljs-selector-tag{color:#dcc6e0}.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#2b2b2b;color:#f8f8f2}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}@media screen and (-ms-high-contrast:active){.hljs-addition,.hljs-attribute,.hljs-built_in,.hljs-builtin-name,.hljs-bullet,.hljs-comment,.hljs-link,.hljs-literal,.hljs-meta,.hljs-number,.hljs-params,.hljs-quote,.hljs-string,.hljs-symbol,.hljs-type{color:highlight}.hljs-keyword,.hljs-selector-tag{font-weight:700}}</style><blockquote>
<p>阅读本文您将获得：</p>
<ul>
<li>使用mcp包创建自己的MCP服务。</li>
<li>使用langchain-mcp-adapters库连接MCP服务。</li>
<li>智能体调用MCP工具。</li>
</ul>
</blockquote>
<p>模型上下文协议（Model Context Protocol, MCP）是一种开放协议，用于标准化应用程序向大语言模型（LLM）提供工具和上下文的方式。LangChain智能体可借助langchain-mcp-adapters库，使用在MCP服务器上定义的工具。</p>
<h2 data-id="heading-0">1、安装</h2>
<p>若要在 LangGraph 中使用 MCP 工具，请安装 langchain-mcp-adapters 库：</p>
<pre><code class="hljs language-bash" lang="bash">pip install langchain-mcp-adapters
</code></pre>
<h2 data-id="heading-1">2、传输类型</h2>
<p>模型上下文协议（MCP）支持多种用于客户端 - 服务器通信的传输机制：</p>
<ul>
<li>标准输入输出（stdio）：客户端将服务器作为子进程启动，并通过标准输入 / 输出进行通信。最适用于本地工具和简单配置场景。</li>
<li>可流式传输的超文本传输协议（Streamable HTTP）：服务器作为独立进程运行，处理HTTP请求。支持远程连接和多客户端访问。</li>
<li>服务器发送事件（Server-Sent Events, SSE）：可流式传输超文本传输协议（Streamable HTTP）的一种变体，针对实时流式通信进行了优化。</li>
</ul>
<h2 data-id="heading-2">3、使用MCP工具</h2>
<p>langchain-mcp-adapters库支持智能体使用在一个或多个MCP服务器上定义的工具。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">from</span> langchain_mcp_adapters.client <span class="hljs-keyword">import</span> MultiServerMCPClient  
<span class="hljs-keyword">from</span> langchain.agents <span class="hljs-keyword">import</span> create_agent
<span class="hljs-keyword">from</span> langchain.chat_models <span class="hljs-keyword">import</span> init_chat_model
<span class="hljs-keyword">from</span> config <span class="hljs-keyword">import</span> api_key, api_base

<span class="hljs-keyword">def</span> <span class="hljs-title function_">init_model</span>():
    model = init_chat_model(
        api_key = api_key,
        base_url = api_base,
        model = <span class="hljs-string">"Qwen/Qwen3-8B"</span>,
        model_provider = <span class="hljs-string">"openai"</span>,
        temperature = <span class="hljs-number">0.7</span>,
    )
    <span class="hljs-keyword">return</span> model
model = init_model()

client = MultiServerMCPClient(  
    {
        <span class="hljs-string">"math"</span>: {
            <span class="hljs-string">"transport"</span>: <span class="hljs-string">"stdio"</span>,  <span class="hljs-comment"># Local subprocess communication</span>
            <span class="hljs-string">"command"</span>: <span class="hljs-string">"python"</span>,
            <span class="hljs-comment"># Absolute path to your math_server.py file</span>
            <span class="hljs-string">"args"</span>: [<span class="hljs-string">"/your/path/to/mcp/math_server.py"</span>],
        },
        <span class="hljs-string">"weather"</span>: {
            <span class="hljs-string">"transport"</span>: <span class="hljs-string">"streamable_http"</span>,  <span class="hljs-comment"># HTTP-based remote server</span>
            <span class="hljs-comment"># Ensure you start your weather server on port 8000</span>
            <span class="hljs-string">"url"</span>: <span class="hljs-string">"http://localhost:8000/mcp"</span>,
        }
    }
)

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    <span class="hljs-comment"># 异步获取工具</span>
    tools = <span class="hljs-keyword">await</span> client.get_tools()  
    agent = create_agent(
        model,
        tools  
    )
    math_response = <span class="hljs-keyword">await</span> agent.ainvoke(
        {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"what's (3 + 5) x 12?"</span>}]}
    )
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Math response:"</span>, math_response)
    weather_response = <span class="hljs-keyword">await</span> agent.ainvoke(
        {<span class="hljs-string">"messages"</span>: [{<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">"what is the weather in nyc?"</span>}]}
    )
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"Weather response:"</span>, weather_response)

<span class="hljs-comment"># 运行异步主函数</span>
<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    asyncio.run(main())

</code></pre>
<h2 data-id="heading-3">4、自定义MCP服务器</h2>
<p>若要创建自己的MCP服务，可使用mcp库。该库提供了一种简单的方式来定义工具，并将这些工具作为服务器运行。</p>
<pre><code class="hljs language-bash" lang="bash">pip install mcp
</code></pre>
<p>可以下参考实现，在MCP工具服务器上测试你的智能体。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> mcp.server.fastmcp <span class="hljs-keyword">import</span> FastMCP

mcp = FastMCP(<span class="hljs-string">"Math"</span>)

<span class="hljs-meta">@mcp.tool()</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a: <span class="hljs-built_in">int</span>, b: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:
    <span class="hljs-string">"""Add two numbers"""</span>
    <span class="hljs-keyword">return</span> a + b

<span class="hljs-meta">@mcp.tool()</span>
<span class="hljs-keyword">def</span> <span class="hljs-title function_">multiply</span>(<span class="hljs-params">a: <span class="hljs-built_in">int</span>, b: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">int</span>:
    <span class="hljs-string">"""Multiply two numbers"""</span>
    <span class="hljs-keyword">return</span> a * b

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    mcp.run(transport=<span class="hljs-string">"stdio"</span>)
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> mcp.server.fastmcp <span class="hljs-keyword">import</span> FastMCP

mcp = FastMCP(<span class="hljs-string">"Weather"</span>)

<span class="hljs-meta">@mcp.tool()</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_weather</span>(<span class="hljs-params">location: <span class="hljs-built_in">str</span></span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-string">"""Get weather for location."""</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">"It's always sunny in New York"</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    mcp.run(transport=<span class="hljs-string">"streamable-http"</span>)
</code></pre>
<h2 data-id="heading-4">5、有状态工具使用</h2>
<p>对于在工具调用之间维持上下文的有状态服务器，可使用 client.session() 创建一个持久化的客户端会话。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_mcp_adapters.tools <span class="hljs-keyword">import</span> load_mcp_tools

client = MultiServerMCPClient({...})
<span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> client.session(<span class="hljs-string">"math"</span>) <span class="hljs-keyword">as</span> session:
    tools = <span class="hljs-keyword">await</span> load_mcp_tools(session)
</code></pre>
<h2 data-id="heading-5">6、总结</h2>
<ul>
<li>使用mcp包创建自己的MCP服务。</li>
<li>使用langchain-mcp-adapters库连接MCP服务。</li>
<li>智能体调用MCP工具。</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【底层机制】 Android ION内存分配器深度解析]]></title>    <link>https://juejin.cn/post/7571258854900334635</link>    <guid>https://juejin.cn/post/7571258854900334635</guid>    <pubDate>2025-11-11T08:35:34.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571258854900334635" data-draft-id="7571304204753453110" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【底层机制】 Android ION内存分配器深度解析"/> <meta itemprop="keywords" content="Android,面试"/> <meta itemprop="datePublished" content="2025-11-11T08:35:34.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="沐怡旸"/> <meta itemprop="url" content="https://juejin.cn/user/2875978146656750"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【底层机制】 Android ION内存分配器深度解析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2875978146656750/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    沐怡旸
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T08:35:34.000Z" title="Tue Nov 11 2025 08:35:34 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0831f578deb9416ba7b947dacb9fdb91~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rKQ5oCh5pe4:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763454934&amp;x-signature=OuREP1Ux0aWd5gkr6VuwiJB3%2FRQ%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-0">1. ION内存分配器概述</h2>
<p>ION（I/O Memory Manager）是Android系统中专门为多媒体和图形处理设计的内存管理框架。它解决了在异构计算环境中不同硬件组件（CPU、GPU、DSP、摄像头等）之间高效共享内存的挑战。</p>
<h3 data-id="heading-1">1.1 设计背景与演进</h3>
<ul>
<li><strong>前身问题</strong>：早期Android使用PMEM（Physical Memory Manager），但存在功能有限、扩展性差等问题</li>
<li><strong>异构计算需求</strong>：现代移动设备包含多种处理单元，需要统一的内存共享机制</li>
<li><strong>零拷贝目标</strong>：减少内存复制开销，提升多媒体流水线性能</li>
</ul>
<h2 data-id="heading-2">2. 核心架构与原理</h2>
<h3 data-id="heading-3">2.1 系统架构层次</h3>
<pre><code class="hljs language-scss" lang="scss">用户空间
├── 应用层 (MediaServer, SurfaceFlinger, Camera HAL)
├── ION用户库 (libion)
└── 系统调用接口

内核空间
├── ION核心框架
├── 堆管理器 (Heap Manager)
├── 客户端管理
├── DMA-BUF集成层
└── 设备特定堆驱动
</code></pre>
<h3 data-id="heading-4">2.2 核心组件深度解析</h3>
<h4 data-id="heading-5">2.2.1 内存堆（Heap）系统</h4>
<p><strong>堆类型分类与实现：</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 内核中的堆类型定义</span>
<span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">ion_heap_type</span> {</span>
    ION_HEAP_TYPE_SYSTEM,        <span class="hljs-comment">// 系统堆 - 使用vmalloc</span>
    ION_HEAP_TYPE_SYSTEM_CONTIG, <span class="hljs-comment">// 连续系统堆</span>
    ION_HEAP_TYPE_CARVEOUT,      <span class="hljs-comment">// 预留物理内存堆</span>
    ION_HEAP_TYPE_CHUNK,         <span class="hljs-comment">// 块堆</span>
    ION_HEAP_TYPE_DMA,           <span class="hljs-comment">// DMA堆</span>
    ION_HEAP_TYPE_CUSTOM,        <span class="hljs-comment">// 自定义堆</span>
};
</code></pre>
<p><strong>系统堆实现机制：</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ion_system_heap</span> {</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ion_heap</span> <span class="hljs-title">heap</span>;</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ion_page_pool</span> *<span class="hljs-title">pools</span>[<span class="hljs-title">NUM_ORDERS</span>];</span> <span class="hljs-comment">// 页池数组</span>
};

<span class="hljs-comment">// 页池管理 - 基于伙伴系统的优化</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ion_page_pool</span> {</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">items</span>;</span>      <span class="hljs-comment">// 空闲页链表</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> count;          <span class="hljs-comment">// 页计数</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> high watermark; <span class="hljs-comment">// 高水位线</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> max_order;      <span class="hljs-comment">// 最大阶数</span>
};
</code></pre>
<p><strong>CMA堆的连续内存管理：</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// CMA（Contiguous Memory Allocator）集成</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ion_cma_heap</span> {</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ion_heap</span> <span class="hljs-title">heap</span>;</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cma</span> *<span class="hljs-title">cma</span>;</span>            <span class="hljs-comment">// CMA区域指针</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> base;         <span class="hljs-comment">// 基地址</span>
    <span class="hljs-type">size_t</span> total_size;          <span class="hljs-comment">// 总大小</span>
};

<span class="hljs-comment">// CMA分配核心函数</span>
<span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">ion_cma_allocate</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> ion_heap *heap,
                           <span class="hljs-keyword">struct</span> ion_buffer *buffer,
                           <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> len,
                           <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags)</span>
{
    <span class="hljs-comment">// 1. 从CMA区域分配连续物理页</span>
    <span class="hljs-comment">// 2. 建立页表映射</span>
    <span class="hljs-comment">// 3. 配置DMA属性</span>
    <span class="hljs-comment">// 4. 设置缓存策略</span>
}
</code></pre>
<h4 data-id="heading-6">2.2.2 缓冲区管理</h4>
<p><strong>缓冲区数据结构：</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ion_buffer</span> {</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">kref</span> <span class="hljs-title">ref</span>;</span>              <span class="hljs-comment">// 引用计数</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ion_heap</span> *<span class="hljs-title">heap</span>;</span>        <span class="hljs-comment">// 所属堆</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> flags;          <span class="hljs-comment">// 分配标志</span>
    <span class="hljs-type">size_t</span> size;                  <span class="hljs-comment">// 缓冲区大小</span>
    <span class="hljs-type">void</span> *priv_virt;              <span class="hljs-comment">// 私有数据</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> <span class="hljs-title">lock</span>;</span>            <span class="hljs-comment">// 互斥锁</span>
    <span class="hljs-type">int</span> kmap_cnt;                 <span class="hljs-comment">// 内核映射计数</span>
    <span class="hljs-type">void</span> *vaddr;                  <span class="hljs-comment">// 内核虚拟地址</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sg_table</span> *<span class="hljs-title">sg_table</span>;</span>    <span class="hljs-comment">// 散列表（物理页描述）</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">attachments</span>;</span> <span class="hljs-comment">// DMA附件列表</span>
};
</code></pre>
<p><strong>缓冲区生命周期管理：</strong></p>
<ol>
<li><strong>分配阶段</strong>：选择合适堆 → 分配物理内存 → 创建sg_table → 初始化缓冲区</li>
<li><strong>映射阶段</strong>：建立页表映射 → 配置缓存属性 → 返回用户空间fd</li>
<li><strong>共享阶段</strong>：fd传递 → 增加引用计数 → 建立新映射</li>
<li><strong>释放阶段</strong>：引用计数减1 → 计数为0时释放资源 → 归还堆内存</li>
</ol>
<h4 data-id="heading-7">2.2.3 客户端管理</h4>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ion_client</span> {</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_node</span> <span class="hljs-title">node</span>;</span>          <span class="hljs-comment">// 红黑树节点</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ion_device</span> *<span class="hljs-title">dev</span>;</span>       <span class="hljs-comment">// ION设备</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">rb_root</span> <span class="hljs-title">buffers</span>;</span>       <span class="hljs-comment">// 客户端缓冲区树</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">mutex</span> <span class="hljs-title">lock</span>;</span>            <span class="hljs-comment">// 客户端锁</span>
    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;             <span class="hljs-comment">// 客户端名称</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span> *<span class="hljs-title">task</span>;</span>     <span class="hljs-comment">// 关联任务</span>
    <span class="hljs-type">pid_t</span> pid;                    <span class="hljs-comment">// 进程ID</span>
};
</code></pre>
<h2 data-id="heading-8">3. 底层机制深度剖析</h2>
<h3 data-id="heading-9">3.1 DMA-BUF框架集成</h3>
<p><strong>DMA-BUF操作集实现：</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-type">const</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">dma_buf_ops</span> <span class="hljs-title">ion_dma_buf_ops</span> =</span> {
    .map_dma_buf = ion_map_dma_buf,        <span class="hljs-comment">// DMA映射</span>
    .unmap_dma_buf = ion_unmap_dma_buf,    <span class="hljs-comment">// DMA解除映射</span>
    .mmap = ion_mmap,                      <span class="hljs-comment">// 内存映射</span>
    .release = ion_dma_buf_release,        <span class="hljs-comment">// 释放</span>
    .begin_cpu_access = ion_dma_buf_begin_cpu_access,    <span class="hljs-comment">// CPU访问开始</span>
    .end_cpu_access = ion_dma_buf_end_cpu_access,        <span class="hljs-comment">// CPU访问结束</span>
};
</code></pre>
<p><strong>DMA映射流程：</strong></p>
<ol>
<li><strong>设备附件</strong>：设备驱动调用<code>dma_buf_attach()</code>连接到DMA缓冲区</li>
<li><strong>映射建立</strong>：调用<code>dma_buf_map_attachment()</code>建立设备可访问的映射</li>
<li><strong>同步处理</strong>：通过<code>begin_cpu_access/end_cpu_access</code>维护一致性</li>
<li><strong>缓存同步</strong>：使用<code>dma_sync_sg_for_device/cpu</code>同步缓存</li>
</ol>
<h3 data-id="heading-10">3.2 缓存一致性机制</h3>
<p><strong>缓存策略类型：</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">ion_cache_policy</span> {</span>
    ION_CACHE_NONE = <span class="hljs-number">0</span>,        <span class="hljs-comment">// 无缓存 - 设备直接访问</span>
    ION_CACHE_WRITE_BACK,      <span class="hljs-comment">// 写回 - CPU缓存优化</span>
    ION_CACHE_WRITE_THROUGH,   <span class="hljs-comment">// 写通 - 实时同步</span>
    ION_CACHE_SYNC,            <span class="hljs-comment">// 同步模式</span>
};
</code></pre>
<p><strong>缓存同步实现：</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// CPU访问开始 - 使设备写入对CPU可见</span>
<span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">ion_begin_cpu_access</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> dma_buf *dmabuf,
                               <span class="hljs-keyword">enum</span> dma_data_direction direction)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ion_buffer</span> *<span class="hljs-title">buffer</span> =</span> dmabuf-&gt;priv;
    
    <span class="hljs-comment">// 无效化CPU缓存，确保读取最新设备数据</span>
    dma_sync_sg_for_cpu(<span class="hljs-literal">NULL</span>, buffer-&gt;sg_table-&gt;sgl,
                        buffer-&gt;sg_table-&gt;nents, direction);
}

<span class="hljs-comment">// CPU访问结束 - 使CPU写入对设备可见</span>
<span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">ion_end_cpu_access</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> dma_buf *dmabuf,
                             <span class="hljs-keyword">enum</span> dma_data_direction direction)</span>
{
    <span class="hljs-comment">// 刷回CPU缓存，确保设备读取最新CPU数据</span>
    dma_sync_sg_for_device(<span class="hljs-literal">NULL</span>, buffer-&gt;sg_table-&gt;sgl,
                          buffer-&gt;sg_table-&gt;nents, direction);
}
</code></pre>
<h3 data-id="heading-11">3.3 内存映射机制</h3>
<p><strong>用户空间映射：</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">ion_mmap</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> dma_buf *dmabuf, <span class="hljs-keyword">struct</span> vm_area_struct *vma)</span>
{
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ion_buffer</span> *<span class="hljs-title">buffer</span> =</span> dmabuf-&gt;priv;
    
    <span class="hljs-comment">// 建立用户空间到物理页的映射</span>
    <span class="hljs-keyword">return</span> remap_pfn_range(vma, vma-&gt;vm_start,
                          page_to_pfn(sg_page(buffer-&gt;sg_table-&gt;sgl)),
                          buffer-&gt;size, vma-&gt;vm_page_prot);
}
</code></pre>
<p><strong>内核空间映射：</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">void</span> *<span class="hljs-title function_">ion_map_kernel</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> ion_buffer *buffer)</span>
{
    <span class="hljs-comment">// 建立临时内核映射</span>
    buffer-&gt;vaddr = vmap(buffer-&gt;pages, buffer-&gt;npages, 
                        VM_MAP, pgprot_noncached(PAGE_KERNEL));
    <span class="hljs-keyword">return</span> buffer-&gt;vaddr;
}
</code></pre>
<h2 data-id="heading-12">4. 性能优化机制</h2>
<h3 data-id="heading-13">4.1 零拷贝架构</h3>
<p><strong>传统方案问题：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">应用空间 → 内核空间 → 硬件空间
<span class="hljs-code">    ↓         ↓         ↓
  复制       复制      处理
</span></code></pre>
<p><strong>ION零拷贝方案：</strong></p>
<pre><code class="hljs language-markdown" lang="markdown">应用空间 → 硬件空间
<span class="hljs-code">    ↓         ↓
  映射       直接访问
</span></code></pre>
<h3 data-id="heading-14">4.2 页池优化</h3>
<p><strong>页池管理策略：</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 预分配页池减少分配延迟</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ion_page_pool</span> {</span>
    <span class="hljs-type">int</span> high_count;      <span class="hljs-comment">// 高水位线</span>
    <span class="hljs-type">int</span> low_count;       <span class="hljs-comment">// 低水位线</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">list_head</span> <span class="hljs-title">items</span>;</span>
    
    <span class="hljs-comment">// 后台填充线程</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">task_struct</span> *<span class="hljs-title">worker</span>;</span>
};
</code></pre>
<p><strong>分配优化算法：</strong></p>
<ol>
<li><strong>快速路径</strong>：直接从页池获取预分配页</li>
<li><strong>慢速路径</strong>：页池不足时从系统分配器获取</li>
<li><strong>后台填充</strong>：异步补充页池到高水位线</li>
</ol>
<h3 data-id="heading-15">4.3 散列表优化</h3>
<p><strong>物理内存描述：</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">sg_table</span> {</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">scatterlist</span> *<span class="hljs-title">sgl</span>;</span>    <span class="hljs-comment">// 散列数组</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> nents;         <span class="hljs-comment">// 条目数</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> orig_nents;    <span class="hljs-comment">// 原始条目数</span>
};

<span class="hljs-comment">// 对非连续物理内存的高效管理</span>
<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">scatterlist</span> {</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">long</span> page_link;    <span class="hljs-comment">// 页指针和链接信息</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> offset;        <span class="hljs-comment">// 页内偏移</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> length;        <span class="hljs-comment">// 段长度</span>
    <span class="hljs-type">dma_addr_t</span> dma_address;     <span class="hljs-comment">// DMA地址</span>
};
</code></pre>
<h2 data-id="heading-16">5. 安全与权限控制</h2>
<h3 data-id="heading-17">5.1 访问控制机制</h3>
<p><strong>堆权限管理：</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ion_platform_heap</span> {</span>
    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name;
    <span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">ion_heap_type</span> <span class="hljs-title">type</span>;</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> id;
    
    <span class="hljs-comment">// 安全配置</span>
    <span class="hljs-type">unsigned</span> <span class="hljs-type">int</span> permissions;    <span class="hljs-comment">// 访问权限位图</span>
    <span class="hljs-type">const</span> <span class="hljs-type">char</span> *client_name;     <span class="hljs-comment">// 允许的客户端</span>
};
</code></pre>
<p><strong>客户端验证：</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-type">static</span> <span class="hljs-keyword">struct</span> ion_client *<span class="hljs-title function_">ion_client_create</span><span class="hljs-params">(<span class="hljs-keyword">struct</span> ion_device *dev,
                                           <span class="hljs-type">const</span> <span class="hljs-type">char</span> *name)</span>
{
    <span class="hljs-comment">// 基于进程上下文的安全检查</span>
    <span class="hljs-keyword">if</span> (!valid_client(current, heap_permissions)) {
        <span class="hljs-keyword">return</span> ERR_PTR(-EACCES);
    }
}
</code></pre>
<h3 data-id="heading-18">5.2 内存隔离</h3>
<p><strong>进程边界保护：</strong></p>
<ul>
<li>每个进程只能访问自己分配的缓冲区</li>
<li>通过文件描述符传递实现受控共享</li>
<li>引用计数防止use-after-free</li>
</ul>
<h2 data-id="heading-19">6. 实际应用场景</h2>
<h3 data-id="heading-20">6.1 图形处理流水线</h3>
<pre><code class="hljs language-css" lang="css">Surface → Gralloc → ION Buffer → GPU → <span class="hljs-attribute">Display</span>
   ↓         ↓          ↓         ↓       ↓
应用层      HAL层    内存共享   渲染   显示输出
</code></pre>
<h3 data-id="heading-21">6.2 摄像头数据处理</h3>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// 典型摄像头流水线</span>
<span class="hljs-type">int</span> <span class="hljs-title function_">setup_camera_pipeline</span><span class="hljs-params">(<span class="hljs-type">void</span>)</span>
{
    <span class="hljs-comment">// 1. 分配ION缓冲区</span>
    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">ion_buffer</span> *<span class="hljs-title">buffer</span> =</span> ion_alloc(size, 
                                        ION_HEAP_TYPE_SYSTEM,
                                        ION_FLAG_CACHED);
    
    <span class="hljs-comment">// 2. 配置DMA传输</span>
    dmaengine_device_control(chan, DMA_SLAVE_CONFIG, &amp;config);
    
    <span class="hljs-comment">// 3. 建立摄像头到ION的DMA映射</span>
    dma_buf_attach(buffer-&gt;dmabuf, camera_dev);
    
    <span class="hljs-comment">// 4. 启动传输</span>
    start_camera_capture(buffer);
}
</code></pre>
<h2 data-id="heading-22">7. 调试与性能分析</h2>
<h3 data-id="heading-23">7.1 调试工具</h3>
<p><strong>ION调试接口：</strong></p>
<pre><code class="hljs language-c" lang="c"><span class="hljs-comment">// /sys/kernel/debug/ion/</span>
├── heaps              # 堆状态信息
├── clients            # 客户端统计
├── buffers            # 缓冲区信息
└── history            # 分配历史
</code></pre>
<p><strong>性能监控指标：</strong></p>
<ul>
<li>分配延迟分布</li>
<li>堆使用率统计</li>
<li>缓存命中率</li>
<li>DMA传输效率</li>
</ul>
<h2 data-id="heading-24">8. 演进与替代方案</h2>
<h3 data-id="heading-25">8.1 DMA-BUF HEAP</h3>
<p>新版本Android逐渐转向DMA-BUF HEAP，提供更标准的Linux内核兼容性：</p>
<ul>
<li>基于DMA-BUF标准框架</li>
<li>简化堆管理模型</li>
<li>更好的上游内核支持</li>
</ul>
<h3 data-id="heading-26">8.2 性能对比</h3>






























<table><thead><tr><th>特性</th><th>ION</th><th>DMA-BUF HEAP</th></tr></thead><tbody><tr><td>内核支持</td><td>Android定制</td><td>主线Linux</td></tr><tr><td>堆管理</td><td>复杂但功能丰富</td><td>简化统一</td></tr><tr><td>性能</td><td>高度优化</td><td>标准优化</td></tr><tr><td>兼容性</td><td>Android专用</td><td>跨平台</td></tr></tbody></table>
<p>ION内存分配器代表了移动设备内存管理的重大进步，通过精心设计的架构解决了异构计算环境中的内存共享挑战，为Android多媒体和图形性能提供了坚实基础。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[💻 Windows服务器K8s学习与SpringBoot部署实战指南]]></title>    <link>https://juejin.cn/post/7571102074038222889</link>    <guid>https://juejin.cn/post/7571102074038222889</guid>    <pubDate>2025-11-11T08:39:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571102074038222889" data-draft-id="7571077686108028991" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="💻 Windows服务器K8s学习与SpringBoot部署实战指南"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T08:39:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="IT橘子皮"/> <meta itemprop="url" content="https://juejin.cn/user/3148645291002232"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            💻 Windows服务器K8s学习与SpringBoot部署实战指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3148645291002232/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    IT橘子皮
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T08:39:37.000Z" title="Tue Nov 11 2025 08:39:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">📚 学习路径概览</h2>
<p>下表列出了从零开始学习K8s并部署SpringBoot应用的关键阶段及主要任务，帮助你清晰规划学习过程。</p>



































<table><thead><tr><th>阶段</th><th>主要任务</th><th>预期成果</th></tr></thead><tbody><tr><td>1. 环境准备</td><td>安装Docker Desktop，启用Kubernetes，验证安装</td><td>准备好本地K8s开发环境</td></tr><tr><td>2. K8s核心概念学习</td><td>理解Pod/Deployment/Service等核心概念</td><td>掌握K8s基本架构和资源模型</td></tr><tr><td>3. SpringBoot应用容器化</td><td>创建Dockerfile，构建镜像</td><td>将Java应用打包为容器镜像</td></tr><tr><td>4. K8s部署实战</td><td>创建Deployment/Service/Ingress资源配置</td><td>成功部署应用到K8s集群</td></tr><tr><td>5. 运维与进阶</td><td>应用监控、扩缩容、滚动更新</td><td>掌握生产环境基本运维技能</td></tr></tbody></table>
<h2 data-id="heading-1">🛠 第一阶段：环境安装与配置</h2>
<h3 data-id="heading-2">1.1 安装Docker Desktop for Windows</h3>
<p>在Windows服务器上安装Docker Desktop是运行Kubernetes的前提。Docker Desktop包含了运行容器所需的所有组件，并提供了内置的Kubernetes支持。</p>
<p>访问Docker官网下载Docker Desktop for Windows安装程序，选择Windows版本对应的安装包。安装完成后，启动Docker Desktop，系统托盘中会出现Docker图标。</p>
<h3 data-id="heading-3">1.2 启用Kubernetes功能</h3>
<p>打开Docker Desktop设置界面，进入"Kubernetes"选项卡，勾选"Enable Kubernetes"选项，点击"Apply &amp; Restart"按钮。Docker Desktop将自动安装Kubernetes集群所需组件（kubectl、kubelet等）。</p>
<h3 data-id="heading-4">1.3 验证安装结果</h3>
<p>打开PowerShell或命令提示符，执行以下命令验证安装：</p>
<pre><code class="hljs language-sql" lang="sql">kubectl version <span class="hljs-comment">--client</span>
kubectl cluster<span class="hljs-operator">-</span>info
kubectl <span class="hljs-keyword">get</span> nodes
</code></pre>
<p>如果这些命令都能正常执行并显示信息，说明Kubernetes环境已就绪。</p>
<h2 data-id="heading-5">📖 第二阶段：Kubernetes核心概念学习</h2>
<h3 data-id="heading-6">2.1 理解基本资源对象</h3>
<ul>
<li><strong>Pod</strong>：Kubernetes的最小部署单元，包含一个或多个容器。</li>
<li><strong>Deployment</strong>：定义Pod的部署策略，支持滚动更新、回滚等操作。</li>
<li><strong>Service</strong>：提供统一的访问入口，实现负载均衡和服务发现。</li>
<li><strong>Ingress</strong>：提供HTTP/HTTPS路由功能，实现基于域名的访问。</li>
</ul>
<h3 data-id="heading-7">2.2 初步实践操作</h3>
<p>通过简单命令熟悉kubectl工具的基本使用：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 查看集群状态</span>
kubectl get all

<span class="hljs-comment"># 创建一个简单的Pod</span>
kubectl run my-nginx <span class="hljs-attr">--image</span>=nginx:latest --port=<span class="hljs-number">80</span>

<span class="hljs-comment"># 查看Pod状态</span>
kubectl get pods

<span class="hljs-comment"># 暴露Service</span>
kubectl expose pod my-nginx <span class="hljs-attr">--type</span>=NodePort --port=<span class="hljs-number">80</span>
</code></pre>
<p>这些基础操作帮助你建立对Kubernetes资源管理的直观认识。</p>
<h2 data-id="heading-8">🚀 第三阶段：SpringBoot应用容器化</h2>
<h3 data-id="heading-9">3.1 准备SpringBoot项目</h3>
<p>创建一个简单的SpringBoot项目，包含一个REST接口用于测试：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-meta">@RestController</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HelloController</span> {
    <span class="hljs-meta">@GetMapping(<span class="hljs-string">"/hello"</span>)</span>
    <span class="hljs-keyword">public</span> String hello() {
        <span class="hljs-keyword">return</span> <span class="hljs-string">"Hello, K8s!"</span>;
    }
}
</code></pre>
<p>确保项目能正常打包：<code>mvn clean package</code>。</p>
<h3 data-id="heading-10">3.2 创建Dockerfile</h3>
<p>在项目根目录创建Dockerfile，定义容器镜像构建过程：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用OpenJDK官方镜像</span>
FROM openjdk:11-jre-slim

<span class="hljs-comment"># 设置工作目录</span>
WORKDIR /app

<span class="hljs-comment"># 复制JAR文件到容器中</span>
COPY target/demo-0.0.1-SNAPSHOT.jar app.jar

<span class="hljs-comment"># 暴露应用端口</span>
EXPOSE 8080

<span class="hljs-comment"># 启动应用</span>
ENTRYPOINT [<span class="hljs-string">"java"</span>, <span class="hljs-string">"-jar"</span>, <span class="hljs-string">"app.jar"</span>]
</code></pre>
<h3 data-id="heading-11">3.3 构建和测试镜像</h3>
<p>执行以下命令构建Docker镜像并在本地测试：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 构建镜像</span>
docker build -t springboot-k8s-demo:v1 .

<span class="hljs-comment"># 本地运行测试</span>
docker run -p 8080:8080 springboot-k8s-demo:v1

<span class="hljs-comment"># 访问测试</span>
curl http://localhost:8080/hello
</code></pre>
<p>确保应用在容器中能正常运行后再进行下一步。</p>
<h2 data-id="heading-12">⚙️ 第四阶段：Kubernetes部署实战</h2>
<h3 data-id="heading-13">4.1 创建Deployment配置</h3>
<p>创建deployment.yaml文件，定义应用的部署规格：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">springboot-demo</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">replicas:</span> <span class="hljs-number">2</span>  <span class="hljs-comment"># 两个副本实现高可用</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">matchLabels:</span>
      <span class="hljs-attr">app:</span> <span class="hljs-string">springboot-demo</span>
  <span class="hljs-attr">template:</span>
    <span class="hljs-attr">metadata:</span>
      <span class="hljs-attr">labels:</span>
        <span class="hljs-attr">app:</span> <span class="hljs-string">springboot-demo</span>
    <span class="hljs-attr">spec:</span>
      <span class="hljs-attr">containers:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">springboot-app</span>
        <span class="hljs-attr">image:</span> <span class="hljs-string">springboot-k8s-demo:v1</span>  <span class="hljs-comment"># 本地构建的镜像</span>
        <span class="hljs-attr">ports:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span>
        <span class="hljs-attr">resources:</span>
          <span class="hljs-attr">requests:</span>
            <span class="hljs-attr">memory:</span> <span class="hljs-string">"256Mi"</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">"200m"</span>
          <span class="hljs-attr">limits:</span>
            <span class="hljs-attr">memory:</span> <span class="hljs-string">"512Mi"</span>
            <span class="hljs-attr">cpu:</span> <span class="hljs-string">"500m"</span>
        <span class="hljs-attr">livenessProbe:</span>
          <span class="hljs-attr">httpGet:</span>
            <span class="hljs-attr">path:</span> <span class="hljs-string">/actuator/health</span>
            <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">60</span>
          <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">10</span>
        <span class="hljs-attr">readinessProbe:</span>
          <span class="hljs-attr">httpGet:</span>
            <span class="hljs-attr">path:</span> <span class="hljs-string">/actuator/health</span>
            <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span>
          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">30</span>
          <span class="hljs-attr">periodSeconds:</span> <span class="hljs-number">5</span>
</code></pre>
<h3 data-id="heading-14">4.2 创建Service配置</h3>
<p>创建service.yaml文件，定义如何访问应用：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">springboot-demo-service</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">selector:</span>
    <span class="hljs-attr">app:</span> <span class="hljs-string">springboot-demo</span>
  <span class="hljs-attr">ports:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span>
      <span class="hljs-attr">port:</span> <span class="hljs-number">80</span>
      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8080</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span>  <span class="hljs-comment"># 在本地环境使用NodePort类型</span>
</code></pre>
<h3 data-id="heading-15">4.3 部署应用到Kubernetes</h3>
<p>执行以下命令部署应用：</p>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-meta"># 应用配置</span>
kubectl apply -f deployment.yaml
kubectl apply -f service.yaml

<span class="hljs-meta"># 查看部署状态</span>
kubectl <span class="hljs-keyword">get</span> deployments
kubectl <span class="hljs-keyword">get</span> pods
kubectl <span class="hljs-keyword">get</span> services

<span class="hljs-meta"># 查看Pod详细状态</span>
kubectl describe pod &lt;pod名称&gt;
</code></pre>
<h2 data-id="heading-16">🔍 第五阶段：应用验证与运维</h2>
<h3 data-id="heading-17">5.1 访问应用</h3>
<p>获取服务访问信息并验证应用部署结果：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看服务详情，获取NodePort端口</span>
kubectl get svc springboot-demo-service

<span class="hljs-comment"># 使用端口转发临时访问</span>
kubectl port-forward svc/springboot-demo-service 8080:80

<span class="hljs-comment"># 访问测试</span>
curl http://localhost:8080/hello
</code></pre>
<h3 data-id="heading-18">5.2 基本运维操作</h3>
<p>掌握日常运维所需的命令和操作：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看应用日志</span>
kubectl logs &lt;pod名称&gt;

<span class="hljs-comment"># 扩展应用实例数量</span>
kubectl scale deployment springboot-demo --replicas=3

<span class="hljs-comment"># 更新应用镜像（触发滚动更新）</span>
kubectl <span class="hljs-built_in">set</span> image deployment/springboot-demo springboot-app=springboot-k8s-demo:v2

<span class="hljs-comment"># 查看更新状态</span>
kubectl rollout status deployment/springboot-demo

<span class="hljs-comment"># 回滚到上一版本</span>
kubectl rollout undo deployment/springboot-demo
</code></pre>
<h2 data-id="heading-19">🧩 第六阶段：进阶实战与优化</h2>
<h3 data-id="heading-20">6.1 配置管理（ConfigMap）</h3>
<p>创建configmap.yaml，将应用配置外部化：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">app-config</span>
<span class="hljs-attr">data:</span>
  <span class="hljs-attr">application.properties:</span> <span class="hljs-string">|
    server.port=8080
    logging.level.com.example=INFO
</span></code></pre>
<p>在Deployment中引用ConfigMap：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># 在Deployment的容器规格中添加</span>
<span class="hljs-attr">volumeMounts:</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config-volume</span>
  <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/app/config</span>
<span class="hljs-attr">volumes:</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">config-volume</span>
  <span class="hljs-attr">configMap:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">app-config</span>
</code></pre>
<h3 data-id="heading-21">6.2 使用Ingress实现域名访问</h3>
<p>创建ingress.yaml，配置基于域名的访问：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">springboot-ingress</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">rules:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">demo.k8s.local</span>
    <span class="hljs-attr">http:</span>
      <span class="hljs-attr">paths:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/</span>
        <span class="hljs-attr">pathType:</span> <span class="hljs-string">Prefix</span>
        <span class="hljs-attr">backend:</span>
          <span class="hljs-attr">service:</span>
            <span class="hljs-attr">name:</span> <span class="hljs-string">springboot-demo-service</span>
            <span class="hljs-attr">port:</span>
              <span class="hljs-attr">number:</span> <span class="hljs-number">80</span>
</code></pre>
<h2 data-id="heading-22">💡 学习建议与最佳实践</h2>
<ol>
<li><strong>迭代学习</strong>：从简单部署开始，逐步增加复杂度。</li>
<li><strong>充分利用资源</strong>：由于你拥有大内存服务器，可以部署更复杂的应用（如微服务架构）进行练习。</li>
<li><strong>版本控制</strong>：将所有配置文件纳入Git版本控制。</li>
<li><strong>日志收集</strong>：考虑部署EFK（Elasticsearch、Fluentd、Kibana）栈进行日志管理。</li>
<li><strong>监控预警</strong>：部署Prometheus + Grafana监控套件，监控应用和集群状态。</li>
</ol>
<h2 data-id="heading-23">🗂 项目结构参考</h2>
<pre><code class="hljs language-bash" lang="bash">k8s-learning/
├── src/                    <span class="hljs-comment"># SpringBoot源码</span>
├── Dockerfile             <span class="hljs-comment"># 镜像构建文件</span>
├── k8s/
│   ├── deployment.yaml    <span class="hljs-comment"># 部署配置</span>
│   ├── service.yaml       <span class="hljs-comment"># 服务配置</span>
│   ├── ingress.yaml       <span class="hljs-comment"># 路由配置</span>
│   └── configmap.yaml     <span class="hljs-comment"># 配置管理</span>
└── README.md              <span class="hljs-comment"># 项目说明</span>
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js第二章(项目搭建)]]></title>    <link>https://juejin.cn/post/7571105461098676267</link>    <guid>https://juejin.cn/post/7571105461098676267</guid>    <pubDate>2025-11-11T08:40:47.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571105461098676267" data-draft-id="7571077686107963455" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js第二章(项目搭建)"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-11T08:40:47.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小满zs"/> <meta itemprop="url" content="https://juejin.cn/user/2463384809252397"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js第二章(项目搭建)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2463384809252397/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小满zs
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T08:40:47.000Z" title="Tue Nov 11 2025 08:40:47 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Next.js 项目搭建</h2>
<h3 data-id="heading-1">创建项目</h3>
<p>快速入门</p>
<p>注： 当前教程为16.0.1版本，最低Node.js版本为20.9.0</p>
<pre><code class="hljs language-bash" lang="bash">npx create-next-app@latest
</code></pre>
<p>接下来会有几个问题需要你选择，根据你的需求选择即可</p>
<ul>
<li>What is your project named? » my-app <code>项目名称（必填）</code></li>
<li>Would you like to use the recommended Next.js defaults? <code>是否使用推荐配置</code> 这里我选自定义配置 <code>No, customize settings</code></li>
<li>Would you like to use TypeScript? » No / Yes <code>是否使用TypeScript</code> 这里我选是 <code>Yes</code></li>
<li>Which linter would you like to use? » ESLint / Biome / None <code>是否使用ESLint</code> 这里我选是 <code>None</code></li>
<li>Would you like to use React Compiler? » No / Yes <code>是否使用React Compiler</code> 这里我选是 <code>Yes</code></li>
<li>Would you like to use Tailwind CSS? » No / Yes <code>是否使用Tailwind CSS</code> 这里我选是 <code>Yes</code></li>
<li>Would you like to use <code>src/app</code> directory? » No / Yes <code>是否使用src/app目录</code> 这里我选是 <code>Yes</code></li>
<li>Would you like to use App Router? (recommended) » No / Yes <code>是否使用App Router</code> 这里我选是 <code>Yes</code></li>
<li>Would you like to use Turbopack? (recommended) » No / Yes <code>是否使用Turbopack</code> 这里我选是 <code>Yes</code></li>
<li>Would you like to customize the import alias (<code>@/*</code> by default)? » No / Yes 是否自定义导入别名 <code>@/*</code> 这里我选是 <code>Yes</code></li>
<li>What import alias would you like configured? » @/* 是否自定义导入别名 <code>@/*</code> 这里我选是 默认 <code>@/*</code></li>
</ul>
<p>选择完成之后，他会执行<code>npm install</code>安装依赖，安装完成之后，他会执行<code>npm run dev</code>启动项目，访问<code>http://localhost:3000</code>即可看到项目。</p>
<h4 data-id="heading-2">目录结构介绍</h4>
<pre><code class="hljs language-txt" lang="txt">public/ -&gt; 静态资源目录
src/ -&gt; 源代码目录
  └─app/ -&gt; App Router目录
     └─layout.tsx -&gt; 跟布局(必须存在 且必须包含html body标签)
     └─page.tsx -&gt; 首页
     └─globals.css -&gt; 全局样式
next-env.d.ts -&gt; TypeScript类型定义文件
next.config.ts -&gt; Next.js配置文件
tsconfig.json -&gt; TypeScript配置文件
postcss.config.mjs -&gt; PostCSS配置文件(主要用于处理tailwindcss)
package.json -&gt; 包管理文件
README.md -&gt; 项目说明文件
</code></pre>
<h4 data-id="heading-3">命令介绍</h4>
<pre><code class="hljs language-bash" lang="bash">next dev -&gt; 启动开发服务器 -&gt; npm run dev
next build -&gt; 构建项目 -&gt; npm run build
next start -&gt; 启动生产服务器 -&gt; npm run start
</code></pre>
<h4 data-id="heading-4">FAQ?</h4>
<p><strong>什么是Turbopack？</strong></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5d704f265e9a4ab789b7d086fe4f04a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763455247&amp;x-signature=4nbICJtDSmJ6v%2BMH5ZQaUVXaKl0%3D" alt="image.png" loading="lazy"/></p>
<p>Turbopack 是一个<strong>增量打包器</strong>，用于取代<code>webpack</code>,它是用Rust语言编写,并且Turbopack转换js/ts使用的是<code>SWC</code>,他比vite快10倍，比webpack快700倍，速度更快，性能更优。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78397ab50f984ff2a79187197cb87b8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763455247&amp;x-signature=pQeHqrBF6dk1UOWoheSxEtl5Iu4%3D" alt="image.png" loading="lazy"/></p>
<p>核心原理：Turbopack是函数级别的缓存，可以将某些函数，进行标记，当这些函数被调用时，会记住他们被调用的内容，保存到缓存中。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/41c373a0e85248f6b77aa6a64f2d9fa3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763455247&amp;x-signature=5KOma3weoGSi8IOaJc86NncNcSk%3D" alt="image.png" loading="lazy"/></p>
<p>首先我们看到有两个文件<code>api.ts</code>/ <code>sdk.ts</code> 都调用了<code>readFile函数</code>，然后把这两个文件打包成<code>bundle</code>,然后拼接起来,最后打成一个<code>fullBundle</code></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0f9e0331dd1044ca91e57c9234c25593~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763455247&amp;x-signature=tJX1nYsutgI68xzaBptZCphjLaY%3D" alt="image.png" loading="lazy"/></p>
<p>例如<code>sdk.js</code>发生了变化，而<code>api.js</code>没有改变，所以他就只会打包<code>sdk.js</code>,而不会打包<code>api.js</code>,只需要从缓存中读取<code>api.js</code>内容即可，这样就可以节省非常多的时间，意味着它永远不需要执行两次相同的工作。</p>
<hr/>
<p><strong>什么是React Compiler?</strong></p>
<p>React Compiler 是Next.js 用于自动优化组件渲染来提高性能的工具，在之前的话，我们需要手动优化<code>useMemo</code> / <code>useCallback</code> /<code>memo</code>等，现在Next.js会自动优化，你只需要写代码即可,减少心智负担。</p>
<p>如何开启React Compiler? <code>如果你在选项中选择yes则无需安装</code></p>
<pre><code class="hljs language-bash" lang="bash">npm install -D babel-plugin-react-compiler
</code></pre>
<p>next.config.ts</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">NextConfig</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'next'</span>
 
<span class="hljs-keyword">const</span> <span class="hljs-attr">nextConfig</span>: <span class="hljs-title class_">NextConfig</span> = {
  <span class="hljs-attr">reactCompiler</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">//开启即可</span>
}
 
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> nextConfig
</code></pre>
<hr/>
<p><strong>什么是App Router?</strong></p>
<p>Next.js 有两套路由系统，一个是旧的<code>Pages Router</code>路由系统，一个是新的<code>App Router</code>路由系统。</p>
<p>首先Next.js 首推的是<code>App Router</code>路由系统</p>
<ul>
<li><code>Pages Router</code>的路由系统是会把<code>pages</code>目录下的所有jsx/tsx文件，都转换成路由，例如<code>pages/index.tsx</code>会转换成<code>/</code>路由，<code>pages/about.tsx</code>会转换成<code>/about</code>路由，这样导致我们不能把组件写到<code>pages</code>目录下。</li>
</ul>
<p>目录结构如下</p>
<pre><code class="hljs language-txt" lang="txt"> └── pages
    ├── index.tsx -&gt; /
    ├── login.tsx -&gt; /login
    ├── api
    │   └── user.tsx -&gt; /api/user
    ├── posts
    │   └── [id].tsx -&gt; /posts/[id]
    └── blog
        ├── index.tsx -&gt; /blog
        └── setting.tsx -&gt; /blog/setting
</code></pre>
<ul>
<li><code>App Router</code>的路由系统是根据约定定义的，目录结构如下</li>
</ul>
<pre><code class="hljs language-txt" lang="txt">src/
└── app
    ├── page.tsx -&gt; / 首页
    ├── layout.tsx -&gt; 布局组件
    ├── template.tsx -&gt; 模板组件
    ├── loading.tsx -&gt; 加载组件
    ├── error.tsx -&gt; 错误组件
    └── not-found.tsx -&gt; 404组件
    ├── xiaoman
    │   └── page.tsx -&gt; /xiaoman 小满页面
    └── daman
        └── page.tsx -&gt; /daman 大满页面
</code></pre>
<ul>
<li><code>Pages Router</code> 读取数据需要使用<code>getServerSideProps</code> / <code>getStaticProps</code> / <code>getStaticPaths</code>等函数，而<code>App Router</code>则不需要，直接在组件中使用<code>fetch</code>调用即可。</li>
</ul>
<p>Pages Router:</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getServerSideProps</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'xxx'</span>);
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>();
  <span class="hljs-keyword">return</span> { <span class="hljs-attr">props</span>: { data } };
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params">{ data }</span>) {
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{data.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p>App Router:</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Home</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> res = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'xxx'</span>);
  <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> res.<span class="hljs-title function_">json</span>();
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{data.name}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>;
}
</code></pre>
<p><strong>预计学习时间</strong>: 10 分钟<br/>
<strong>难度级别</strong>: 初级 🟢</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何简单 hack agp 执行过程中的某个类]]></title>    <link>https://juejin.cn/post/7571105461098692651</link>    <guid>https://juejin.cn/post/7571105461098692651</guid>    <pubDate>2025-11-11T08:46:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571105461098692651" data-draft-id="7571105461098594347" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何简单 hack agp 执行过程中的某个类"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2025-11-11T08:46:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="vivo高启强"/> <meta itemprop="url" content="https://juejin.cn/user/2225067264841773"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何简单 hack agp 执行过程中的某个类
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2225067264841773/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    vivo高启强
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T08:46:50.000Z" title="Tue Nov 11 2025 08:46:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>霍老师的开源项目</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fbennyhuo%2FHackViewBinding" target="_blank" title="https://github.com/bennyhuo/HackViewBinding" ref="nofollow noopener noreferrer">github.com/bennyhuo/Ha…</a></p>
<p>这个很好的解决了，viewbinding 默认是生成 ，只有手动设置属性才不生成的问题</p>
<p>假设你是一个老项目，有几百个 xml 文件，你接入了 viewbinding， 这几百个 xml 全都给你生成了 也不管你需要不需要，这是多么恶心的一件事。 霍老师 这个项目完美解决了这个问题。</p>
<p>只是项目过老了， 目前主流 app 都是 agp8+了，这里面代码可能要修改下。  这里提供下修改方法，掌握了以后</p>
<p>利用好类的双亲委托加载机制 就可以做很多 agp 的 hack 了</p>
<p>找到你要 hack 的类</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe0b229b49d64ecda4456b4beaf0ade0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-mrmOWQr-W8ug==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763455610&amp;x-signature=Yviw7TkyTlNx3GVwTvQ99LPIcSw%3D" alt="image.png" loading="lazy"/></p>
<p>记住这个类的包名，你要放到 buildSrc 下 ，包名不要错了，保持一致。</p>
<p>这个时候 你需要 带着这个类所属的 aar 去 google 一下，因为你拷贝出来的类 需要一些依赖，你要知道这些依赖在哪里 ，否则还是 build 失败。</p>
<p>比如说我们这里就是要找到这个地址</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmvnrepository.com%2Fartifact%2Fandroidx.databinding%2Fdatabinding-compiler%2F8.4.2" target="_blank" title="https://mvnrepository.com/artifact/androidx.databinding/databinding-compiler/8.4.2" ref="nofollow noopener noreferrer">mvnrepository.com/artifact/an…</a></p>
<p>然后找到 pom 文件</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/814740ba10ff4a0da01579d5a5bf296d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-mrmOWQr-W8ug==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763455610&amp;x-signature=WTd6%2BcHk5XOLee%2Fl5FodBkVBGms%3D" alt="image.png" loading="lazy"/></p>
<p>打开</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07a99af04ea44643962289575e96da82~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-mrmOWQr-W8ug==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763455610&amp;x-signature=03ZUbvrs0l1u3h7b%2Bxplk433UY4%3D" alt="image.png" loading="lazy"/></p>
<p>选择你需要的依赖 复制到 buildSrc 下的 gradle 文件中即可。</p>
<p>这里 as 做的挺智能的，你复制的是 maven 的 xml，拷贝过来直接自动帮你转了，很方便。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/46a2e2a396b24a8caf6b44b2b7fa1b49~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgdml2b-mrmOWQr-W8ug==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763455610&amp;x-signature=vz9spczCa3MWRHy5QcMj16RTlPM%3D" alt="image.png" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Next.js第三章(App Router)]]></title>    <link>https://juejin.cn/post/7571272874846273588</link>    <guid>https://juejin.cn/post/7571272874846273588</guid>    <pubDate>2025-11-11T08:49:31.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571272874846273588" data-draft-id="7571077686108094527" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Next.js第三章(App Router)"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-11T08:49:31.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="小满zs"/> <meta itemprop="url" content="https://juejin.cn/user/2463384809252397"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Next.js第三章(App Router)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2463384809252397/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    小满zs
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T08:49:31.000Z" title="Tue Nov 11 2025 08:49:31 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Next.js 路由概览</h2>
<p>Next.js 使用基于文件系统的路由，这意味着文件和文件夹的结构直接决定了应用的路由结构。</p>
<h3 data-id="heading-1">基于文件系统的路由</h3>
<p>我们只需要创建对应的文件和文件夹，Next.js 会自动生成对应的路由。</p>
<p>在 Next.js 中，每个文件夹代表一个路由段，映射到 URL 段：</p>
<h4 data-id="heading-2">page</h4>
<pre><code class="hljs language-bash" lang="bash">app/
├── page.tsx               <span class="hljs-comment"># /</span>
├── about/
│   └── page.tsx           <span class="hljs-comment"># /about</span>
├── blog/test
│        └── page.tsx      <span class="hljs-comment"># /blog/test</span>
└── contact/
    └── page.tsx           <span class="hljs-comment"># /contact</span>
</code></pre>
<h4 data-id="heading-3">layout &amp;&amp; template</h4>
<p><code>layout</code>(布局) 布局是多个页面共享UI，例如导航栏、侧边栏、底部等。</p>
<p><code>template</code>(模板) 基本功能跟布局一样，只是不会保存状态</p>
<p>布局和模板的特点就是：</p>
<ul>
<li>多个布局可以嵌套</li>
<li><code>布局会保存状态 / 模板不会保存状态</code></li>
<li>根布局(必须存在)</li>
<li>如果布局和模板同时存在，则布局会优先于模板 layout-&gt;template-page</li>
</ul>
<p>目录结构如下:</p>
<pre><code class="hljs language-txt" lang="txt">app
└─ blog
   ├─ layout.tsx
   ├─ template.tsx
   ├─ a
   │  └─ page.tsx
   └─ b
      └─ page.tsx
</code></pre>
<p>app/blog/layout.tsx</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-string">'use client'</span> <span class="hljs-comment">//需要交互的地方要改为客户端组件 默认是服务端组件</span>
<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">BlogLayout</span>(<span class="hljs-params">{ children }: { children: React.ReactNode }</span>) {
    <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Blog 布局组件<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>数量： {count}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">hr</span> /&gt;</span>
            {children}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>app/blog/template.tsx</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-string">'use client'</span> <span class="hljs-comment">//需要交互的地方要改为客户端组件 默认是服务端组件</span>
<span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">"react"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">BlogTemplate</span>(<span class="hljs-params">{ children }: { children: React.ReactNode }</span>) {
    <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Blog Template<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;+1<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>数量： {count}<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">hr</span> /&gt;</span>
            {children}
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>app/blog/a/page.tsx</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/link"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">APage</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>A Page<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/blog/b"</span>&gt;</span>跳转B<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>app/blog/b/page.tsx</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/link"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">BPage</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>B Page<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/blog/a"</span>&gt;</span>跳转A<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8ea6f0aeae9a4ce98978f894abb7dfd4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763455771&amp;x-signature=L8HsLelL81pqJERp6YChG9UPq4s%3D" alt="1.gif" loading="lazy"/></p>
<h4 data-id="heading-4">loading(加载)</h4>
<p>Next.js的loading是借助了<code>Suspense</code>实现的，Suspense的具体用法请参考<a href="https://link.juejin.cn?target=https%3A%2F%2Fmessage163.github.io%2Freact-docs%2Freact%2Fcomponents%2Fsuspense.html" target="_blank" title="https://message163.github.io/react-docs/react/components/suspense.html" ref="nofollow noopener noreferrer">Suspense 组件</a></p>
<p>app/blog/loading.tsx</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Loading</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Loading...<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>app/blog/a/page.tsx</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/link"</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">getData</span> = <span class="hljs-keyword">async</span> (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">//触发异步会自动跳转到loading组件 异步结束正常返回页面</span>
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-function">(<span class="hljs-params">resolve</span>) =&gt;</span> {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-title function_">resolve</span>(<span class="hljs-string">"数据"</span>)
    }, <span class="hljs-number">5000</span>)
  })
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">APage</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> data = <span class="hljs-keyword">await</span> <span class="hljs-title function_">getData</span>()
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data)
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>A Page<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/blog/b"</span>&gt;</span>跳转B<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/abd5f2f39f86406b85ba797fc0b36e56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763455771&amp;x-signature=d6HiHh%2FULAHxDghLgDA9X%2BnJCiI%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-5">error(错误)</h4>
<p>Next.js的error是借助了<code>Error Boundary</code>实现的。</p>
<p>app/blog/error.tsx</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-string">'use client'</span> <span class="hljs-comment">//错误组件必须是客户端组件</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Error</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>Error<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p>app/blog/a/page.tsx</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Link</span> <span class="hljs-keyword">from</span> <span class="hljs-string">"next/link"</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">APage</span>(<span class="hljs-params"/>) {
   <span class="hljs-comment">//遇到异常会自动跳转到error组件</span>
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"错误"</span>)
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>A Page<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Link</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"/blog/b"</span>&gt;</span>跳转B<span class="hljs-tag">&lt;/<span class="hljs-name">Link</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f354c01c68454aa18edb1322ed17a68f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763455771&amp;x-signature=8utuEr2Lkw%2F8OlyQHNJH2iIpwMk%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-6">not-found(404)</h4>
<p>其实Next.js 默认会生成一个404页面，但我们可能自定义404页面，只需要在app目录下创建一个not-found.tsx文件即可</p>
<p>app/not-found.tsx</p>
<pre><code class="hljs language-tsx" lang="tsx"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">NotFound</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> (
        <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>404 Page<span class="hljs-tag">&lt;/<span class="hljs-name">h1</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
    )
}
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96aad6f0e4cd408b9e07093cf0cdc169~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5bCP5ruhenM=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763455771&amp;x-signature=zXyN2lrQKsKsduG%2BBvkfJ3yjfE4%3D" alt="image.png" loading="lazy"/></p>
<p><strong>预计学习时间</strong>: 20 分钟<br/>
<strong>难度级别</strong>: 初级 🟢</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【Pycharm 必学技巧 】以列为单位的块编辑]]></title>    <link>https://juejin.cn/post/7571105461098725419</link>    <guid>https://juejin.cn/post/7571105461098725419</guid>    <pubDate>2025-11-11T08:57:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571105461098725419" data-draft-id="7346527007281790991" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【Pycharm 必学技巧 】以列为单位的块编辑"/> <meta itemprop="keywords" content="测试"/> <meta itemprop="datePublished" content="2025-11-11T08:57:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="软件测试杂谈"/> <meta itemprop="url" content="https://juejin.cn/user/4004881767865897"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【Pycharm 必学技巧 】以列为单位的块编辑
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4004881767865897/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    软件测试杂谈
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T08:57:05.000Z" title="Tue Nov 11 2025 08:57:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">【必学技巧 03】以列为单位的块编辑</h2>
<p>先给你出道小题，像下面这段代码，如果在不影响代码的情况下，快速删除后面代码后面的注释呢？</p>
<p><img src="http://image.iswbm.com/20190721132238.png" alt="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b3bea3bc61a9456086092e814b3ff1d1~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1056&amp;h=346&amp;s=55527&amp;e=png&amp;b=1e1f1b" loading="lazy"/></p>
<p>我能想到的有两种方法，如果像如上这种有规律的注释，可以使用 <code>正则匹配</code> + <code>替换</code> 来实现。</p>
<p><img src="http://image.iswbm.com/20190721133403.png" alt="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/cc3ad848f4a548fdae1100bb78fd625b~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=1522&amp;h=540&amp;s=93941&amp;e=png&amp;b=1f201c" loading="lazy"/></p>
<p>对于这个场景我想到了可以用 vim来轻松的解决，vim 支持块编辑，可以以列为单位选择区域然后进行操作，这在vim中是很常用的一个取消注释的操作。</p>
<p>同样回到 PyCharm 中来，你会发现它也支持块编辑。</p>
<p>如果你使用的是旧版本的 PyCharm ，当你按住 alt，然后使用鼠标进行选择，你会发现这样一件神奇的事情。</p>
<p><img src="https://i.loli.net/2019/07/21/5d3401410087b61815.gif" alt="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/74aa072d965447be941e41b7357feb69~tplv-k3u1fbpfcp-jj-mark:0:0:0:0:q75.image#?w=938&amp;h=442&amp;s=1117361&amp;e=gif&amp;f=240&amp;b=24251f" loading="lazy"/></p>
<p>如若上面的快捷键不生效，说明你的 PyCharm 是旧版本，在较版本中，有两种方法开启列选择模式</p>
<p>1、使用快捷键 Alt + Shift + Insert</p>
<p>2、点击右键，选择 『Column Selection Mode』</p>
<p>在新版本中，列选择的功能变成了一种模式，开启才能使用，使用完后还需要关闭。相比旧版本，个人认为这个改变不好，不能即用即走。</p>
<p><strong><a href="https://link.juejin.cn/?target=https%3A%2F%2Fitem.jd.com%2F13967704.html" title="https://link.juejin.cn/?target=https%3A%2F%2Fitem.jd.com%2F13967704.html" target="_blank">测试新人可以学习《测试人的 Python 工具书》书籍</a>、<a href="https://link.juejin.cn/?target=https%3A%2F%2Fitem.jd.com%2F13543572.html" title="https://link.juejin.cn/?target=https%3A%2F%2Fitem.jd.com%2F13543572.html" target="_blank">《性能测试 JMeter 实战》书籍</a></strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[python有哪些方案可以处理多线程请求接口时结果的顺序问题？]]></title>    <link>https://juejin.cn/post/7571281406509400115</link>    <guid>https://juejin.cn/post/7571281406509400115</guid>    <pubDate>2025-11-11T08:43:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571281406509400115" data-draft-id="7571191453125738522" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="python有哪些方案可以处理多线程请求接口时结果的顺序问题？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2025-11-11T08:43:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="用户22176592792"/> <meta itemprop="url" content="https://juejin.cn/user/4461135061323432"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            python有哪些方案可以处理多线程请求接口时结果的顺序问题？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4461135061323432/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    用户22176592792
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T08:43:30.000Z" title="Tue Nov 11 2025 08:43:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>除了“无序收集+统一排序”的方案一，处理多线程请求接口结果顺序的核心思路是 <strong>“确保结果与请求提交顺序对齐”</strong> ，以下是 4 种实用方案（含进阶优化和第三方库方案），覆盖不同场景需求，且均保证线程安全和并发效率：</p>
<h4 data-id="heading-0">一、方案二：固定位置存储（无排序，高效实时）</h4>
<h5 data-id="heading-1">核心逻辑</h5>
<p>提前创建一个与请求总数长度一致的<strong>结果列表</strong>，每个线程携带唯一的“请求索引”，执行完成后直接将结果写入列表的对应索引位置（如任务 5 的结果写入 ​<code>​results[5]​</code>​）。由于索引与提交顺序一一对应，所有线程完成后，列表自然是有序的。</p>
<h5 data-id="heading-2">关键优势</h5>
<ul>
<li>无需后续排序，效率最高（省去排序开销）；</li>
<li>可实时查看每个任务的执行状态（通过列表非 ​<code>​None​</code>​ 的位置判断）；</li>
<li>仅需对“列表写入”加锁，锁粒度极小，不影响并发。</li>
</ul>
<h5 data-id="heading-3">完整代码</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> threading
<span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> typing <span class="hljs-keyword">import</span> <span class="hljs-type">List</span>

API_URL = <span class="hljs-string">"https://jsonplaceholder.typicode.com/posts/{}"</span>
THREAD_NUM = <span class="hljs-number">10</span>
TOTAL_REQUESTS = <span class="hljs-number">20</span>
TIMEOUT = <span class="hljs-number">5</span>

<span class="hljs-comment"># 1. 初始化：固定长度的结果列表（与请求顺序对应）+ 互斥锁（保护列表写入）</span>
results: <span class="hljs-type">List</span>[<span class="hljs-built_in">tuple</span>] = [<span class="hljs-literal">None</span>] * TOTAL_REQUESTS  <span class="hljs-comment"># 初始值为 None，完成后写入结果</span>
lock = threading.Lock()  <span class="hljs-comment"># 线程安全：避免多线程同时修改同一列表位置</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">request_api</span>(<span class="hljs-params">index: <span class="hljs-built_in">int</span></span>):
    <span class="hljs-string">"""线程执行函数：按索引写入结果到固定位置"""</span>
    url = API_URL.<span class="hljs-built_in">format</span>(index % <span class="hljs-number">10</span> + <span class="hljs-number">1</span>)
    <span class="hljs-keyword">try</span>:
        response = requests.get(url, timeout=TIMEOUT)
        response.raise_for_status()
        result = (index, <span class="hljs-literal">True</span>, <span class="hljs-string">f"响应：<span class="hljs-subst">{response.json()[<span class="hljs-string">'title'</span>][:<span class="hljs-number">20</span>]}</span>..."</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        result = (index, <span class="hljs-literal">False</span>, <span class="hljs-string">f"失败：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)[:<span class="hljs-number">30</span>]}</span>"</span>)

    <span class="hljs-comment"># 2. 加锁写入结果（仅锁定写入操作，不影响请求并发）</span>
    <span class="hljs-keyword">with</span> lock:
        results[index] = result  <span class="hljs-comment"># 关键：按请求索引写入对应位置</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    start_time = time.time()
    threads = []

    <span class="hljs-comment"># 3. 创建并启动线程（控制线程池大小）</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(TOTAL_REQUESTS):
        <span class="hljs-comment"># 限制同时运行的线程数，避免创建过多线程</span>
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">len</span>(threads) &gt;= THREAD_NUM:
            <span class="hljs-comment"># 等待任意线程完成后再创建新线程</span>
            threading.Thread.join(threading.Thread.wait(threads))
            threads = [t <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> threads <span class="hljs-keyword">if</span> t.is_alive()]
        
        t = threading.Thread(target=request_api, args=(i,), name=<span class="hljs-string">f"Thread-<span class="hljs-subst">{i}</span>"</span>)
        t.start()
        threads.append(t)

    <span class="hljs-comment"># 4. 等待所有线程完成</span>
    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> threads:
        t.join()

    <span class="hljs-comment"># 5. 直接按列表顺序输出（已与提交顺序一致）</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"固定位置存储 - 按请求顺序输出："</span>)
    <span class="hljs-keyword">for</span> idx, is_success, msg <span class="hljs-keyword">in</span> results:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"任务[<span class="hljs-subst">{idx}</span>]：<span class="hljs-subst">{<span class="hljs-string">'✅'</span> <span class="hljs-keyword">if</span> is_success <span class="hljs-keyword">else</span> <span class="hljs-string">'❌'</span>}</span> <span class="hljs-subst">{msg}</span>"</span>)

    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n总耗时：<span class="hljs-subst">{<span class="hljs-built_in">round</span>(time.time() - start_time, <span class="hljs-number">3</span>)}</span>s"</span>)
</code></pre>
<h4 data-id="heading-4">二、方案三：队列（Queue）流式有序处理</h4>
<h5 data-id="heading-5">核心逻辑</h5>
<p>用两个线程安全的队列：</p>
<ul>
<li><strong>任务队列</strong>：按提交顺序存入所有请求索引（0、1、2...）；</li>
<li><strong>结果队列</strong>：线程执行完成后，将（索引+结果）存入队列；</li>
<li>主线程按“期望索引”（从 0 开始）循环检查结果队列，只输出当前期望的索引结果，非期望结果放回队列，直到所有任务完成。</li>
</ul>
<h5 data-id="heading-6">关键优势</h5>
<ul>
<li>支持<strong>流式输出</strong>：无需等待所有任务完成，可实时按顺序打印结果；</li>
<li>队列自带线程安全（​<code>​queue.Queue​</code>​ 内部已实现锁），无需手动加锁；</li>
<li>适合实时展示进度（如批量操作时实时打印日志）。</li>
</ul>
<h5 data-id="heading-7">完整代码</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">import</span> threading
<span class="hljs-keyword">from</span> queue <span class="hljs-keyword">import</span> Queue
<span class="hljs-keyword">import</span> time

API_URL = <span class="hljs-string">"https://jsonplaceholder.typicode.com/posts/{}"</span>
THREAD_NUM = <span class="hljs-number">10</span>
TOTAL_REQUESTS = <span class="hljs-number">20</span>
TIMEOUT = <span class="hljs-number">5</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">worker</span>(<span class="hljs-params">task_queue: Queue, result_queue: Queue</span>):
    <span class="hljs-string">"""工作线程：从任务队列取任务，执行后存入结果队列"""</span>
    <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> task_queue.empty():
        <span class="hljs-keyword">try</span>:
            index = task_queue.get(timeout=<span class="hljs-number">1</span>)  <span class="hljs-comment"># 非阻塞取任务（超时1秒退出）</span>
            url = API_URL.<span class="hljs-built_in">format</span>(index % <span class="hljs-number">10</span> + <span class="hljs-number">1</span>)
            <span class="hljs-keyword">try</span>:
                response = requests.get(url, timeout=TIMEOUT)
                response.raise_for_status()
                result = (index, <span class="hljs-literal">True</span>, <span class="hljs-string">f"响应：<span class="hljs-subst">{response.json()[<span class="hljs-string">'title'</span>][:<span class="hljs-number">20</span>]}</span>..."</span>)
            <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
                result = (index, <span class="hljs-literal">False</span>, <span class="hljs-string">f"失败：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)[:<span class="hljs-number">30</span>]}</span>"</span>)
            result_queue.put(result)  <span class="hljs-comment"># 存入结果队列（无序）</span>
        <span class="hljs-keyword">except</span> Exception:
            <span class="hljs-keyword">break</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    start_time = time.time()

    <span class="hljs-comment"># 1. 初始化队列</span>
    task_queue = Queue()  <span class="hljs-comment"># 按顺序存入请求索引（0~19）</span>
    result_queue = Queue()  <span class="hljs-comment"># 存储无序的结果</span>

    <span class="hljs-comment"># 2. 提交任务（按顺序入队）</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(TOTAL_REQUESTS):
        task_queue.put(i)

    <span class="hljs-comment"># 3. 启动工作线程</span>
    threads = [threading.Thread(target=worker, args=(task_queue, result_queue)) <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(THREAD_NUM)]
    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> threads:
        t.start()

    <span class="hljs-comment"># 4. 主线程按顺序提取结果（流式输出）</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"队列流式处理 - 按请求顺序实时输出："</span>)
    expected_index = <span class="hljs-number">0</span>  <span class="hljs-comment"># 期望的下一个任务索引（从0开始）</span>
    completed = <span class="hljs-number">0</span>  <span class="hljs-comment"># 已完成的任务数</span>

    <span class="hljs-keyword">while</span> completed &lt; TOTAL_REQUESTS:
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> result_queue.empty():
            index, is_success, msg = result_queue.get()
            <span class="hljs-comment"># 匹配期望索引则输出，否则放回队列</span>
            <span class="hljs-keyword">if</span> index == expected_index:
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"任务[<span class="hljs-subst">{index}</span>]：<span class="hljs-subst">{<span class="hljs-string">'✅'</span> <span class="hljs-keyword">if</span> is_success <span class="hljs-keyword">else</span> <span class="hljs-string">'❌'</span>}</span> <span class="hljs-subst">{msg}</span>"</span>)
                expected_index += <span class="hljs-number">1</span>
                completed += <span class="hljs-number">1</span>
            <span class="hljs-keyword">else</span>:
                result_queue.put((index, is_success, msg))  <span class="hljs-comment"># 未匹配则放回</span>
        <span class="hljs-keyword">else</span>:
            time.sleep(<span class="hljs-number">0.01</span>)  <span class="hljs-comment"># 避免空循环占用CPU</span>

    <span class="hljs-comment"># 5. 等待所有线程结束</span>
    <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> threads:
        t.join()

    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n总耗时：<span class="hljs-subst">{<span class="hljs-built_in">round</span>(time.time() - start_time, <span class="hljs-number">3</span>)}</span>s"</span>)
</code></pre>
<h4 data-id="heading-8">三、方案四：使用 ​<code>​concurrent.futures​</code>​ + 有序结果收集</h4>
<h5 data-id="heading-9">核心逻辑</h5>
<p>​<code>​ThreadPoolExecutor​</code>​ 提交任务后会返回一个 ​<code>​Future​</code>​ 列表，该列表的<strong>顺序与提交顺序一致</strong>（即使任务完成顺序无序）。通过遍历 ​<code>​Future​</code>​ 列表（而非 ​<code>​as_completed​</code>​），直接调用 ​<code>​future.result()​</code>​，会按提交顺序阻塞等待每个任务完成，从而自然得到有序结果。</p>
<h5 data-id="heading-10">关键优势</h5>
<ul>
<li>基于 Python 标准库，代码简洁（无需手动管理线程/锁/队列）；</li>
<li>本质是“按提交顺序等待结果”，无需排序或额外存储；</li>
<li>适合需要“逐个按顺序处理结果”且不想写复杂逻辑的场景。</li>
</ul>
<h5 data-id="heading-11">完整代码</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> requests
<span class="hljs-keyword">from</span> concurrent.futures <span class="hljs-keyword">import</span> ThreadPoolExecutor
<span class="hljs-keyword">import</span> time

API_URL = <span class="hljs-string">"https://jsonplaceholder.typicode.com/posts/{}"</span>
THREAD_NUM = <span class="hljs-number">10</span>
TOTAL_REQUESTS = <span class="hljs-number">20</span>
TIMEOUT = <span class="hljs-number">5</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">request_api</span>(<span class="hljs-params">index: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">tuple</span>:
    <span class="hljs-string">"""单个请求函数：返回（索引，是否成功，结果信息）"""</span>
    url = API_URL.<span class="hljs-built_in">format</span>(index % <span class="hljs-number">10</span> + <span class="hljs-number">1</span>)
    <span class="hljs-keyword">try</span>:
        response = requests.get(url, timeout=TIMEOUT)
        response.raise_for_status()
        <span class="hljs-keyword">return</span> (index, <span class="hljs-literal">True</span>, <span class="hljs-string">f"响应：<span class="hljs-subst">{response.json()[<span class="hljs-string">'title'</span>][:<span class="hljs-number">20</span>]}</span>..."</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> (index, <span class="hljs-literal">False</span>, <span class="hljs-string">f"失败：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)[:<span class="hljs-number">30</span>]}</span>"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    start_time = time.time()

    <span class="hljs-comment"># 1. 提交任务并获取 Future 列表（顺序与提交一致）</span>
    <span class="hljs-keyword">with</span> ThreadPoolExecutor(max_workers=THREAD_NUM) <span class="hljs-keyword">as</span> executor:
        future_list = [executor.submit(request_api, i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(TOTAL_REQUESTS)]

        <span class="hljs-comment"># 2. 按 Future 列表顺序获取结果（阻塞等待，顺序与提交一致）</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">"ThreadPoolExecutor 有序收集 - 按请求顺序输出："</span>)
        <span class="hljs-keyword">for</span> future <span class="hljs-keyword">in</span> future_list:
            index, is_success, msg = future.result()  <span class="hljs-comment"># 按提交顺序阻塞等待</span>
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"任务[<span class="hljs-subst">{index}</span>]：<span class="hljs-subst">{<span class="hljs-string">'✅'</span> <span class="hljs-keyword">if</span> is_success <span class="hljs-keyword">else</span> <span class="hljs-string">'❌'</span>}</span> <span class="hljs-subst">{msg}</span>"</span>)

    total_cost = <span class="hljs-built_in">round</span>(time.time() - start_time, <span class="hljs-number">3</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n总耗时：<span class="hljs-subst">{total_cost}</span>s"</span>)
</code></pre>
<h5 data-id="heading-12">注意</h5>
<ul>
<li>该方案的“有序”是通过“按提交顺序等待每个任务完成”实现的，<strong>不会降低并发效率</strong>（任务仍在后台并行执行，只是结果获取顺序固定）；</li>
<li>若前一个任务未完成，会阻塞等待，直到其完成后再获取下一个任务的结果，适合需要“逐个处理结果”的场景（如按顺序写入数据库）。</li>
</ul>
<h4 data-id="heading-13">四、方案五：第三方库 ​<code>​aiohttp​</code>​（异步并发+有序结果）</h4>
<h5 data-id="heading-14">核心逻辑</h5>
<p>虽然是“异步”而非“多线程”，但 ​<code>​aiohttp​</code>​ 是 IO 密集型接口请求的更优选择（单线程异步并发，无 GIL 影响，效率更高），且天然支持有序结果——异步任务的提交顺序与结果返回顺序一致。</p>
<h5 data-id="heading-15">关键优势</h5>
<ul>
<li>并发效率高于多线程（无线程切换开销）；</li>
<li>代码简洁，无需处理线程安全问题；</li>
<li>适合高并发接口请求场景（如批量爬取、接口压测）。</li>
</ul>
<h5 data-id="heading-16">完整代码</h5>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> aiohttp
<span class="hljs-keyword">import</span> asyncio
<span class="hljs-keyword">import</span> time

API_URL = <span class="hljs-string">"https://jsonplaceholder.typicode.com/posts/{}"</span>
TOTAL_REQUESTS = <span class="hljs-number">20</span>
TIMEOUT = <span class="hljs-number">5</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">request_api</span>(<span class="hljs-params">session: aiohttp.ClientSession, index: <span class="hljs-built_in">int</span></span>) -&gt; <span class="hljs-built_in">tuple</span>:
    <span class="hljs-string">"""异步请求函数"""</span>
    url = API_URL.<span class="hljs-built_in">format</span>(index % <span class="hljs-number">10</span> + <span class="hljs-number">1</span>)
    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> session.get(url, timeout=TIMEOUT) <span class="hljs-keyword">as</span> response:
            response.raise_for_status()
            data = <span class="hljs-keyword">await</span> response.json()
            <span class="hljs-keyword">return</span> (index, <span class="hljs-literal">True</span>, <span class="hljs-string">f"响应：<span class="hljs-subst">{data[<span class="hljs-string">'title'</span>][:<span class="hljs-number">20</span>]}</span>..."</span>)
    <span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:
        <span class="hljs-keyword">return</span> (index, <span class="hljs-literal">False</span>, <span class="hljs-string">f"失败：<span class="hljs-subst">{<span class="hljs-built_in">str</span>(e)[:<span class="hljs-number">30</span>]}</span>"</span>)

<span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">main</span>():
    start_time = time.time()

    <span class="hljs-comment"># 1. 创建异步会话（复用连接，提升效率）</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">with</span> aiohttp.ClientSession() <span class="hljs-keyword">as</span> session:
        <span class="hljs-comment"># 2. 创建所有异步任务（顺序与提交一致）</span>
        tasks = [request_api(session, i) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(TOTAL_REQUESTS)]
        <span class="hljs-comment"># 3. 并发执行任务，按提交顺序获取结果</span>
        results = <span class="hljs-keyword">await</span> asyncio.gather(*tasks)  <span class="hljs-comment"># gather 保证结果顺序与任务顺序一致</span>

    <span class="hljs-comment"># 4. 输出结果（已有序）</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"aiohttp 异步并发 - 按请求顺序输出："</span>)
    <span class="hljs-keyword">for</span> idx, is_success, msg <span class="hljs-keyword">in</span> results:
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"任务[<span class="hljs-subst">{idx}</span>]：<span class="hljs-subst">{<span class="hljs-string">'✅'</span> <span class="hljs-keyword">if</span> is_success <span class="hljs-keyword">else</span> <span class="hljs-string">'❌'</span>}</span> <span class="hljs-subst">{msg}</span>"</span>)

    total_cost = <span class="hljs-built_in">round</span>(time.time() - start_time, <span class="hljs-number">3</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n总耗时：<span class="hljs-subst">{total_cost}</span>s"</span>)

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 兼容 Windows 系统</span>
    <span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
        <span class="hljs-keyword">if</span> sys.platform == <span class="hljs-string">"win32"</span>:
            asyncio.set_event_loop_policy(asyncio.WindowsSelectorEventLoopPolicy())
        asyncio.run(main())
</code></pre>
<h5 data-id="heading-17">依赖安装</h5>
<pre><code class="hljs">pip install aiohttp
</code></pre>
<h3 data-id="heading-18">各方案对比&amp;选型建议</h3>



































<table><thead><tr><th>方案</th><th>技术依赖</th><th>核心优势</th><th>适用场景</th></tr></thead><tbody><tr><td>固定位置存储</td><td>threading + lock</td><td>效率最高、可实时查进度</td><td>高并发、需跟踪任务状态</td></tr><tr><td>队列流式处理</td><td>threading + Queue</td><td>流式输出、无需等待所有任务</td><td>实时展示进度、边请求边处理</td></tr><tr><td>ThreadPoolExecutor 有序收集</td><td>concurrent.futures</td><td>代码最简单、标准库支持</td><td>无需实时输出、按顺序处理结果</td></tr><tr><td>aiohttp 异步并发</td><td>aiohttp + asyncio</td><td>并发效率最高、无线程安全问题</td><td>高并发接口请求、爬取、压测</td></tr></tbody></table>
<h3 data-id="heading-19">面试&amp;实战关键要点</h3>
<ol>
<li><strong>线程安全是前提</strong>：修改共享数据（如列表）必须加锁，或使用线程安全的数据结构（如 ​<code>​queue.Queue​</code>​）；</li>
<li><strong>有序的核心是“索引绑定”</strong> ：无论哪种方案，都需要通过“请求索引”关联任务和结果，确保顺序对齐；</li>
<li><strong>IO 密集型优先选异步</strong>：​<code>​aiohttp​</code>​ 异步并发效率高于多线程，且天然有序，是接口请求的最优解；</li>
<li><strong>避免过度设计</strong>：简单场景用 ​<code>​ThreadPoolExecutor​</code>​ 有序收集（方案四），复杂场景用队列或固定位置存储，无需追求复杂逻辑。</li>
</ol></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[IntersectionObserver实现横向虚拟滚动列表]]></title>    <link>https://juejin.cn/post/7571105461098659883</link>    <guid>https://juejin.cn/post/7571105461098659883</guid>    <pubDate>2025-11-11T08:39:54.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571105461098659883" data-draft-id="7570999443445940260" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="IntersectionObserver实现横向虚拟滚动列表"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2025-11-11T08:39:54.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="桃桃乌龙_9527"/> <meta itemprop="url" content="https://juejin.cn/user/4452335074688016"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            IntersectionObserver实现横向虚拟滚动列表
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4452335074688016/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    桃桃乌龙_9527
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T08:39:54.000Z" title="Tue Nov 11 2025 08:39:54 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">背景</h2>
<p>同事在业务上又碰到一个比较难搞的需求，需要渲染60+列的表格，表格元素也还是输入框、下拉等等，组件还是用的antdVue1.x（这玩意的性能感觉，dddd）；所以就在想实现横向虚拟滚动，但是又不想重新手写，目光首先就看到了<code>vxe-table</code>，但是用它的横向虚拟滚动就5行就产生卡顿了，在思考之余就想到了前阵子看过的<code>IntersectionObserver</code>这个API，试试能不能用它来做到元素的显示隐藏。</p>
<p>卡顿的本质就是因为渲染了太多的表单元素所导致的，通过判断可视区域元素的进出就可以做到动态的渲染表单元素，因此就做了以下的操作。</p>
<h2 data-id="heading-1">实现</h2>
<p>列表还是采用的<code>a-table</code>来做实现，其实也可以用原生。(完整demo代码放在最后）</p>
<h3 data-id="heading-2">模板内容</h3>
<pre><code class="hljs language-vue" lang="vue">&lt;template&gt;
    &lt;div class="virtual-list-page"&gt;
        &lt;div class="page-header"&gt;
            &lt;h2&gt;提交失败 - 横向虚拟滚动测试 (IntersectionObserver)&lt;/h2&gt;
            &lt;div class="tip"&gt;
                &lt;div&gt;当前单据存在细类SKU超出宽度上限，不可提交！&lt;/div&gt;
                &lt;div&gt;
                    可删除以下细类的单据SKU或对以下细类老品进行淘汰后继续新品引入。
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;div class="info"&gt;
            &lt;p&gt;使用 IntersectionObserver 实现虚拟滚动&lt;/p&gt;
            &lt;p&gt;
                总列数: {{ allColumns.length }}, 当前可见:
                {{ visibleColumns.size }}
            &lt;/p&gt;
        &lt;/div&gt;

        &lt;a-table
            :columns="tableColumns"
            :data-source="tableData"
            :scroll="{ x: totalTableWidth, y: 400 }"
            tableLayout="fixed"
            ref="virtualTable"
        &gt;
            &lt;template
                v-for="column in tableColumns"
                :slot="column.dataIndex"
                slot-scope="text, record, index"
            &gt;
                &lt;div
                    :key="column.dataIndex"
                    :id="`cell-${index}-${column.dataIndex}`"
                    class="cell-observer-placeholder"
                &gt;
                    &lt;div v-show="visibleColumns.has(parseInt(column.index))"&gt;
                        &lt;!-- 输入框列 --&gt;
                        &lt;a-input
                            v-if="column.type === 'input'"
                            :value="record[column.dataIndex]"
                            @change="
                                handleInputChange(
                                    index,
                                    column.dataIndex,
                                    $event
                                )
                            "
                            size="small"
                        /&gt;

                        &lt;!-- 下拉框列 --&gt;
                        &lt;a-select
                            v-else-if="column.type === 'select'"
                            :value="record[column.dataIndex]"
                            @change="
                                handleSelectChange(
                                    index,
                                    column.dataIndex,
                                    $event
                                )
                            "
                            size="small"
                            :dropdownMatchSelectWidth="false"
                        &gt;
                            &lt;a-select-option
                                v-for="option in column.options"
                                :key="option.value"
                                :value="option.value"
                            &gt;
                                {{ option.label }}
                            &lt;/a-select-option&gt;
                        &lt;/a-select&gt;

                        &lt;!-- 普通文本列 --&gt;
                        &lt;span v-else&gt;
                            {{ getDataValue(record, column.dataIndex) }}
                        &lt;/span&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/template&gt;
        &lt;/a-table&gt;

        &lt;div class="pagination-info"&gt;
            总共 {{ tableData.length }} 条记录，{{ allColumns.length }} 列
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/template&gt;
</code></pre>
<h3 data-id="heading-3">思路</h3>
<h4 data-id="heading-4">绑定观察元素</h4>
<p><code>IntersectionObserver</code>需要用到DOM元素本身，如果获取每一个单元格来进行观察，又会做很多的消耗，而且在上下滚动的过程中也会出现问题，转而去使用观察表头在可视区域的移动，<code>vue</code>可以通过ref的方式来获取，但是插槽的部分我尝试了并不能拿到，就改用<code>key</code>的形式来获取表头DOM。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-title function_">observeColumns</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.$nextTick(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-comment">// 清除之前的观察器</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">intersectionObserver</span>) {
            <span class="hljs-variable language_">this</span>.<span class="hljs-property">intersectionObserver</span>.<span class="hljs-title function_">disconnect</span>()
        }
        <span class="hljs-comment">// 观察第一行的所有列单元格</span>
        <span class="hljs-keyword">for</span> (
            <span class="hljs-keyword">let</span> rowIndex = <span class="hljs-number">0</span>;
            rowIndex &lt; <span class="hljs-variable language_">this</span>.<span class="hljs-property">allColumns</span>.<span class="hljs-property">length</span>;
            rowIndex++
        ) {
            <span class="hljs-keyword">const</span> column = <span class="hljs-variable language_">this</span>.<span class="hljs-property">allColumns</span>[rowIndex]
            <span class="hljs-keyword">const</span> elementId = column.<span class="hljs-property">field</span>
            <span class="hljs-keyword">const</span> cellElement = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(
                <span class="hljs-string">`[key="<span class="hljs-subst">${elementId}</span>"]`</span>
            )
            <span class="hljs-keyword">if</span> (cellElement) {
                cellElement.<span class="hljs-property">dataset</span>.<span class="hljs-property">index</span> = rowIndex
                <span class="hljs-variable language_">this</span>.<span class="hljs-property">intersectionObserver</span>.<span class="hljs-title function_">observe</span>(cellElement)
            }
        }
    })
}
</code></pre>
<h4 data-id="heading-5">观察逻辑</h4>
<p>这里将观察函数单独做了定义是为了初始化首屏可视区域的列，观察器每次会调用的元素是移出可视区域以及刚进入可视区域的元素，将列数进行排列，再补充中间值，再做预加载值。</p>
<pre><code class="hljs language-JavaScript" lang="JavaScript"><span class="hljs-title function_">initIntersectionObserver</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 创建 IntersectionObserver 实例观察单元格占位符</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">intersectionObserver</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">IntersectionObserver</span>(
        <span class="hljs-function">(<span class="hljs-params">entries</span>) =&gt;</span> <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initIntersectionObserverCallback</span>(entries),
        {
            <span class="hljs-attr">root</span>: <span class="hljs-variable language_">this</span>.<span class="hljs-property">$refs</span>.<span class="hljs-property">virtualTable</span>.<span class="hljs-property">$el</span>,
            <span class="hljs-attr">rootMargin</span>: <span class="hljs-string">'600px'</span>,
            <span class="hljs-attr">threshold</span>: <span class="hljs-number">0.01</span>
        }
    )
},
<span class="hljs-title function_">initIntersectionObserverCallback</span>(<span class="hljs-params">entries</span>) {
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>()
    entries.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">entry</span>) =&gt;</span> {
        <span class="hljs-keyword">const</span> colIndex = <span class="hljs-built_in">parseInt</span>(entry.<span class="hljs-property">target</span>.<span class="hljs-property">dataset</span>.<span class="hljs-property">index</span>)
        result.<span class="hljs-title function_">add</span>(colIndex)
    })
    <span class="hljs-comment">// 通过arr最小值与最大值获取区间，再根据最小值、最大值预加载可见列</span>
    <span class="hljs-keyword">const</span> arr = [...result].<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a - b)
    <span class="hljs-keyword">const</span> minIndex = arr[<span class="hljs-number">0</span>]
    <span class="hljs-keyword">const</span> maxIndex = arr[arr.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>]

    <span class="hljs-comment">// 预加载机制：在最小值基础上往前预加载8列，最大值基础上往后预加载8列</span>
    <span class="hljs-keyword">const</span> preloadCount = <span class="hljs-number">8</span>
    <span class="hljs-keyword">const</span> startIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, minIndex - preloadCount)
    <span class="hljs-keyword">const</span> endIndex = <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">min</span>(
        <span class="hljs-variable language_">this</span>.<span class="hljs-property">allColumns</span>.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>,
        maxIndex + preloadCount
    )

    <span class="hljs-comment">// 创建扩展的可见列集合</span>
    <span class="hljs-keyword">const</span> extendedResult = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>()
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">let</span> i = startIndex; i &lt;= endIndex; i++) {
        extendedResult.<span class="hljs-title function_">add</span>(i)
    }
    <span class="hljs-comment">// 更新可见列集合</span>
    <span class="hljs-variable language_">this</span>.$set(<span class="hljs-variable language_">this</span>, <span class="hljs-string">'visibleColumns'</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([...extendedResult]))
},
</code></pre>
<h4 data-id="heading-6">生命周期调用</h4>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title function_">mounted</span>(<span class="hljs-params"/>) {

    <span class="hljs-comment">// 初始化 IntersectionObserver</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initIntersectionObserver</span>()

    <span class="hljs-comment">// 观察列元素</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">observeColumns</span>()

    <span class="hljs-variable language_">this</span>.$nextTick(<span class="hljs-function">() =&gt;</span> {
        <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-property">intersectionObserver</span>) {
            <span class="hljs-keyword">const</span> records = <span class="hljs-variable language_">this</span>.<span class="hljs-property">intersectionObserver</span>.<span class="hljs-title function_">takeRecords</span>()
            <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">initIntersectionObserverCallback</span>(records)
        }
    })
},
<span class="hljs-title function_">beforeDestroy</span>(<span class="hljs-params"/>) {
    <span class="hljs-comment">// 清理 IntersectionObserver</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">unobserveColumns</span>()
}
</code></pre>
<h2 data-id="heading-7">完整代码</h2>
<p>这里比上面多了一个滚动的思路是想优化下白屏？但是效果不咋地的感觉</p>
<pre><code class="hljs language-vue" lang="vue">&lt;!-- src/pages/testpage/index.vue --&gt;
&lt;template&gt;
    &lt;div class="virtual-list-page"&gt;
        &lt;div class="page-header"&gt;
            &lt;h2&gt;提交失败 - 横向虚拟滚动测试 (IntersectionObserver)&lt;/h2&gt;
            &lt;div class="tip"&gt;
                &lt;div&gt;当前单据存在细类SKU超出宽度上限，不可提交！&lt;/div&gt;
                &lt;div&gt;
                    可删除以下细类的单据SKU或对以下细类老品进行淘汰后继续新品引入。
                &lt;/div&gt;
            &lt;/div&gt;
        &lt;/div&gt;

        &lt;div class="info"&gt;
            &lt;p&gt;使用 IntersectionObserver 实现虚拟滚动&lt;/p&gt;
            &lt;p&gt;
                总列数: {{ allColumns.length }}, 当前可见:
                {{ visibleColumns.size }}
            &lt;/p&gt;
        &lt;/div&gt;

        &lt;a-table
            :columns="tableColumns"
            :data-source="tableData"
            :scroll="{ x: totalTableWidth, y: 400 }"
            tableLayout="fixed"
            ref="virtualTable"
        &gt;
            &lt;template
                v-for="column in tableColumns"
                :slot="column.dataIndex"
                slot-scope="text, record, index"
            &gt;
                &lt;div
                    :key="column.dataIndex"
                    :id="`cell-${index}-${column.dataIndex}`"
                    class="cell-observer-placeholder"
                &gt;
                    &lt;div v-show="visibleColumns.has(parseInt(column.index))"&gt;
                        &lt;!-- 输入框列 --&gt;
                        &lt;a-input
                            v-if="column.type === 'input'"
                            :value="record[column.dataIndex]"
                            @change="
                                handleInputChange(
                                    index,
                                    column.dataIndex,
                                    $event
                                )
                            "
                            size="small"
                        /&gt;

                        &lt;!-- 下拉框列 --&gt;
                        &lt;a-select
                            v-else-if="column.type === 'select'"
                            :value="record[column.dataIndex]"
                            @change="
                                handleSelectChange(
                                    index,
                                    column.dataIndex,
                                    $event
                                )
                            "
                            size="small"
                            :dropdownMatchSelectWidth="false"
                        &gt;
                            &lt;a-select-option
                                v-for="option in column.options"
                                :key="option.value"
                                :value="option.value"
                            &gt;
                                {{ option.label }}
                            &lt;/a-select-option&gt;
                        &lt;/a-select&gt;

                        &lt;!-- 普通文本列 --&gt;
                        &lt;span v-else&gt;
                            {{ getDataValue(record, column.dataIndex) }}
                        &lt;/span&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/template&gt;
        &lt;/a-table&gt;

        &lt;div class="pagination-info"&gt;
            总共 {{ tableData.length }} 条记录，{{ allColumns.length }} 列
        &lt;/div&gt;

        &lt;div class="actions"&gt;
            &lt;a-button @click="printData" type="primary"&gt;打印当前数据&lt;/a-button&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
    name: 'ModalCheckControlTest',
    data() {
        return {
            allColumns: [],
            tableData: [],
            columnWidth: 150,
            visibleColumns: new Set([0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10]),
            intersectionObserver: null,
            headerIntersectionObserver: null,
            scrollTimer: null,
            scrollDebounceTimer: null
        }
    },
    computed: {
        totalTableWidth() {
            return this.allColumns.length * this.columnWidth
        },
        tableColumns() {
            return this.allColumns.map((col) =&gt; ({
                title: col.title,
                dataIndex: col.field,
                width: col.width,
                index: col.index,
                type: col.type,
                options: col.options,
                scopedSlots: col.scopedSlots
            }))
        }
    },
    methods: {
        generateColumns() {
            const columns = []
            for (let i = 1; i &lt;= 90; i++) {
                // 前10列为输入框
                if (i &lt;= 10) {
                    columns.push({
                        title: `输入字段${i}`,
                        width: this.columnWidth,
                        field: `inputField${i}`,
                        type: 'input',
                        dataIndex: `inputField${i}`,
                        scopedSlots: { customRender: `inputField${i}` }
                    })
                }
                // 11-20列为下拉框
                else if (i &lt;= 60) {
                    columns.push({
                        title: `选择字段${i - 10}`,
                        width: this.columnWidth,
                        field: `selectField${i - 10}`,
                        type: 'select',
                        options: [
                            { label: '选项1', value: 'option1' },
                            { label: '选项2', value: 'option2' },
                            { label: '选项3', value: 'option3' },
                            { label: '选项4', value: 'option4' }
                        ],
                        dataIndex: `selectField${i - 10}`,
                        scopedSlots: { customRender: `selectField${i - 10}` }
                    })
                }
                // 其余为普通文本
                else {
                    columns.push({
                        title: `字段${i}`,
                        width: this.columnWidth,
                        field: `field${i}`,
                        scopedSlots: { customRender: `field${i}` }
                    })
                }
            }
            return columns.map((col, index) =&gt; ({
                ...col,
                index
            }))
        },
        generateMockData() {
            const data = []
            for (let i = 1; i &lt;= 60; i++) {
                const item = { id: i }

                // 输入字段
                for (let j = 1; j &lt;= 10; j++) {
                    item[`inputField${j}`] = `输入数据${i}-${j}`
                }

                // 下拉字段
                for (let j = 1; j &lt;= 10; j++) {
                    item[`selectField${j}`] =
                        j % 4 === 0
                            ? 'option1'
                            : j % 4 === 1
                            ? 'option2'
                            : j % 4 === 2
                            ? 'option3'
                            : 'option4'
                }

                // 普通字段
                for (let j = 21; j &lt;= 60; j++) {
                    item[`field${j}`] = `数据${i}-${j}`
                }

                data.push(item)
            }
            return data
        },
        getDataValue(row, field) {
            return row[field] !== undefined ? row[field] : '-'
        },
        handleInputChange(rowIndex, field, event) {
            const value = event.target ? event.target.value : event
            this.$set(this.tableData[rowIndex], field, value)
        },
        handleSelectChange(rowIndex, field, value) {
            this.$set(this.tableData[rowIndex], field, value)
        },
        printData() {
            console.log('当前数据:', this.tableData)
            alert(
                `数据已打印到控制台，前3行数据:\n${JSON.stringify(
                    this.tableData.slice(0, 3),
                    null,
                    2
                )}`
            )
        },
        initIntersectionObserver() {
            // 创建 IntersectionObserver 实例观察单元格占位符
            this.intersectionObserver = new IntersectionObserver(
                (entries) =&gt; this.initIntersectionObserverCallback(entries),
                {
                    root: this.$refs.virtualTable.$el,
                    rootMargin: '600px',
                    threshold: 0.01
                }
            )
        },
        initIntersectionObserverCallback(entries) {
            const result = new Set()
            entries.forEach((entry) =&gt; {
                const colIndex = parseInt(entry.target.dataset.index)
                result.add(colIndex)
            })
            // 通过arr最小值与最大值获取区间，再根据最小值、最大值预加载可见列
            const arr = [...result].sort((a, b) =&gt; a - b)
            const minIndex = arr[0]
            const maxIndex = arr[arr.length - 1]

            // 预加载机制：在最小值基础上往前预加载2列，最大值基础上往后预加载2列
            const preloadCount = 8
            const startIndex = Math.max(0, minIndex - preloadCount)
            const endIndex = Math.min(
                this.allColumns.length - 1,
                maxIndex + preloadCount
            )

            // 创建扩展的可见列集合
            const extendedResult = new Set()
            for (let i = startIndex; i &lt;= endIndex; i++) {
                extendedResult.add(i)
            }
            // 更新可见列集合
            this.$set(this, 'visibleColumns', new Set([...extendedResult]))
        },
        observeColumns() {
            this.$nextTick(() =&gt; {
                // 清除之前的观察器
                if (this.intersectionObserver) {
                    this.intersectionObserver.disconnect()
                }
                // 观察第一行的所有列单元格
                for (
                    let rowIndex = 0;
                    rowIndex &lt; this.allColumns.length;
                    rowIndex++
                ) {
                    const column = this.allColumns[rowIndex]
                    const elementId = column.field
                    const cellElement = document.querySelector(
                        `[key="${elementId}"]`
                    )
                    if (cellElement) {
                        cellElement.dataset.index = rowIndex
                        this.intersectionObserver.observe(cellElement)
                    }
                }
            })
        },
        unobserveColumns() {
            if (this.intersectionObserver) {
                this.intersectionObserver.disconnect()
            }
            if (this.headerIntersectionObserver) {
                this.headerIntersectionObserver.disconnect()
            }
        },
        // 根据滚动百分比计算可见列
        calculateVisibleColumnsByPercentage(scrollPercentage) {
            if (this.allColumns.length === 0) return

            // 计算当前视口能显示的列数（估算）
            const visibleColumnCount = Math.ceil(1200 / this.columnWidth) // 假设容器宽度为1200px

            // 根据滚动百分比计算中心位置
            const centerIndex = Math.floor(
                (scrollPercentage / 100) * this.allColumns.length
            )

            // 计算可见范围
            const startIndex = Math.max(
                0,
                centerIndex - Math.floor(visibleColumnCount / 2)
            )
            const endIndex = Math.min(
                this.allColumns.length - 1,
                startIndex + visibleColumnCount - 1
            )

            // 添加预加载
            const preloadCount = 10
            const actualStartIndex = Math.max(0, startIndex - preloadCount)
            const actualEndIndex = Math.min(
                this.allColumns.length - 1,
                endIndex + preloadCount
            )

            // 创建新的可见列集合
            const newVisibleColumns = new Set()
            for (let i = actualStartIndex; i &lt;= actualEndIndex; i++) {
                newVisibleColumns.add(i)
            }

            return newVisibleColumns
        },
        // 处理滚动事件（带防抖）
        handleScroll(event) {
            const target = event.target
            if (target.scrollWidth &lt;= target.clientWidth) return

            // 计算滚动百分比
            const scrollLeft = target.scrollLeft
            const maxScroll = target.scrollWidth - target.clientWidth
            const scrollPercentage = (scrollLeft / maxScroll) * 100

            // 清除之前的防抖定时器
            if (this.scrollDebounceTimer) {
                clearTimeout(this.scrollDebounceTimer)
            }

            // 设置防抖定时器
            this.scrollDebounceTimer = setTimeout(() =&gt; {
                // 立即根据滚动百分比计算并设置可见列
                const visibleColumns =
                    this.calculateVisibleColumnsByPercentage(scrollPercentage)
                if (visibleColumns) {
                    this.$set(this, 'visibleColumns', visibleColumns)
                }

                // 清除之前的 IntersectionObserver 定时器
                if (this.scrollTimer) {
                    clearTimeout(this.scrollTimer)
                }

                // 设置定时器，在滚动停止后重新启用 IntersectionObserver
                this.scrollTimer = setTimeout(() =&gt; {
                    // 重新触发 IntersectionObserver 检查
                    if (this.intersectionObserver) {
                        const records = this.intersectionObserver.takeRecords()
                        if (records.length &gt; 0) {
                            this.initIntersectionObserverCallback(records)
                        }
                    }
                }, 100)
            }, 50) // 50ms 防抖延迟
        },
        // 初始化滚动监听
        initScrollListener() {
            this.$nextTick(() =&gt; {
                const tableBody =
                    this.$refs.virtualTable.$el.querySelector('.ant-table-body')
                if (tableBody) {
                    tableBody.addEventListener('scroll', this.handleScroll, {
                        passive: true
                    })
                }
            })
        },
        // 移除滚动监听
        removeScrollListener() {
            this.$nextTick(() =&gt; {
                const tableBody =
                    this.$refs.virtualTable.$el.querySelector('.ant-table-body')
                if (tableBody) {
                    tableBody.removeEventListener('scroll', this.handleScroll)
                }

                // 清除所有定时器
                if (this.scrollDebounceTimer) {
                    clearTimeout(this.scrollDebounceTimer)
                }
                if (this.scrollTimer) {
                    clearTimeout(this.scrollTimer)
                }
            })
        }
    },
    mounted() {
        // 生成60列
        this.allColumns = this.generateColumns()

        // 生成60行数据
        this.tableData = this.generateMockData()

        // 初始化 IntersectionObserver
        this.initIntersectionObserver()

        // 观察列元素
        this.observeColumns()

        // 初始化滚动监听
        this.initScrollListener()

        this.$nextTick(() =&gt; {
            console.log(this.$refs.virtualTable, '表格引用')
            if (this.intersectionObserver) {
                const records = this.intersectionObserver.takeRecords()
                this.initIntersectionObserverCallback(records)
            }
        })
    },
    beforeDestroy() {
        // 清理 IntersectionObserver
        this.unobserveColumns()

        // 移除滚动监听
        this.removeScrollListener()
    }
}
&lt;/script&gt;

&lt;style lang="scss" scoped&gt;
.virtual-list-page {
    padding: 20px;
    background: #fff;
}

.page-header {
    margin-bottom: 20px;

    h2 {
        margin-bottom: 16px;
    }
}

.tip {
    color: #ff4d4f;
    margin-bottom: 16px;

    div {
        margin-bottom: 4px;
    }
}

.info {
    margin-bottom: 16px;
    padding: 10px 0;
    color: #1890ff;
    font-weight: bold;
}

.header-observer-placeholder,
.cell-observer-placeholder {
    width: 100%;
    height: 100%;
}

.pagination-info {
    margin-top: 10px;
    text-align: right;
    color: #666;
    font-size: 12px;
}

.actions {
    margin-top: 20px;
    text-align: center;
}
&lt;/style&gt;

</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[npx命令的作用]]></title>    <link>https://juejin.cn/post/7571126773808660490</link>    <guid>https://juejin.cn/post/7571126773808660490</guid>    <pubDate>2025-11-11T08:41:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571126773808660490" data-draft-id="7571278865516281906" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="npx命令的作用"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2025-11-11T08:41:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="zhuweileo"/> <meta itemprop="url" content="https://juejin.cn/user/2893570335074141"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            npx命令的作用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2893570335074141/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    zhuweileo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T08:41:13.000Z" title="Tue Nov 11 2025 08:41:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><code>npx</code> 是 <strong>Node.js</strong> 自带的一个命令行工具（自 <strong>npm 5.2+</strong> 起内置），它的主要作用是：<br/>
👉 <strong>直接执行 npm 包中的可执行命令，而不用全局安装它。</strong></p>
<hr/>
<h2 data-id="heading-0">🧩 一句话理解</h2>
<blockquote>
<p><strong><code>npx</code> = “临时执行一个 npm 包的命令”</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-1">🧠 背景问题</h2>
<p>在 <code>npx</code> 之前，我们常常遇到这样的场景：</p>
<p>比如想用 <code>create-react-app</code> 创建项目，你得先全局安装它：</p>
<pre><code class="hljs language-lua" lang="lua">npm install -g <span class="hljs-built_in">create</span>-react-app
<span class="hljs-built_in">create</span>-react-app my-app
</code></pre>
<p>但这会导致：</p>
<ul>
<li>全局环境容易“污染”；</li>
<li>不同项目间版本冲突；</li>
<li>有时只是用一次，却留下全局包。</li>
</ul>
<hr/>
<h2 data-id="heading-2">🚀 有了 <code>npx</code> 之后</h2>
<p>你可以直接运行：</p>
<pre><code class="hljs language-lua" lang="lua">npx <span class="hljs-built_in">create</span>-react-app my-app
</code></pre>
<p>🔹 <code>npx</code> 会做的事情是：</p>
<ol>
<li>检查当前项目（<code>node_modules/.bin</code>）是否已有 <code>create-react-app</code>；</li>
<li>若没有，则<strong>临时下载</strong>该包；</li>
<li><strong>运行</strong>它的命令；</li>
<li><strong>执行完后自动删除</strong>临时包。</li>
</ol>
<hr/>
<h2 data-id="heading-3">💡 常见使用场景</h2>
<h3 data-id="heading-4">1️⃣ 临时运行 CLI 工具</h3>
<pre><code class="hljs language-css" lang="css">npx eslint <span class="hljs-attribute">src</span>/
npx prettier <span class="hljs-attr">--write</span> .
</code></pre>
<h3 data-id="heading-5">2️⃣ 运行未全局安装的项目命令</h3>
<p>例如你的项目依赖了 <code>typescript</code>：</p>
<pre><code class="hljs language-csharp" lang="csharp">npx tsc --<span class="hljs-keyword">init</span>
</code></pre>
<blockquote>
<p>会自动使用项目中 <code>node_modules/typescript/bin/tsc</code>，而不是全局的版本。</p>
</blockquote>
<h3 data-id="heading-6">3️⃣ 运行特定版本的命令</h3>
<pre><code class="hljs language-perl" lang="perl">npx create-react-app@5.<span class="hljs-number">0</span>.<span class="hljs-number">1</span> <span class="hljs-keyword">my</span>-app
</code></pre>
<blockquote>
<p>可方便地指定版本，无需先安装。</p>
</blockquote>
<h3 data-id="heading-7">4️⃣ 运行 GitHub 或 gist 上的脚本</h3>
<pre><code class="hljs language-bash" lang="bash">npx github:vercel/next.js
</code></pre>
<hr/>
<h2 data-id="heading-8">⚙️ 运行机制简化图</h2>
<pre><code class="hljs language-bash" lang="bash">            ┌──────────────────────────┐
            │  输入命令：npx foo         │
            └────────────┬─────────────┘
                         │
          ┌──────────────┴──────────────┐
          │ 1. 查找本地 node_modules/.bin │
          └──────────────┬──────────────┘
                         │
       ┌─────────────────┴─────────────────┐
       │ 2. 若无 → 临时下载到缓存目录执行      │
       │ 3. 执行完毕后清除                   │
       └──────────────────────────────────┘
</code></pre>
<hr/>
<h2 data-id="heading-9">📦 小结</h2>






























<table><thead><tr><th>场景</th><th>npm</th><th>npx</th></tr></thead><tbody><tr><td>全局安装后执行</td><td>✅</td><td>✅</td></tr><tr><td>本地依赖执行</td><td>需手动路径</td><td>✅ 自动</td></tr><tr><td>临时执行一次性包</td><td>❌</td><td>✅</td></tr><tr><td>指定版本执行</td><td>不便</td><td>✅ 方便</td></tr></tbody></table></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深度学习模型CNN识别恶意软件]]></title>    <link>https://juejin.cn/post/7571304204753584182</link>    <guid>https://juejin.cn/post/7571304204753584182</guid>    <pubDate>2025-11-11T08:51:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571304204753584182" data-draft-id="7571077686108110911" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深度学习模型CNN识别恶意软件"/> <meta itemprop="keywords" content="深度学习,机器学习,神经网络"/> <meta itemprop="datePublished" content="2025-11-11T08:51:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="蚁景网安实验室"/> <meta itemprop="url" content="https://juejin.cn/user/1398234521018846"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深度学习模型CNN识别恶意软件
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1398234521018846/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    蚁景网安实验室
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T08:51:17.000Z" title="Tue Nov 11 2025 08:51:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">0.前言</h2>
<p>给组里的本科生讲一讲恶意软件，以及如何识别恶意软件。</p>
<h2 data-id="heading-1">1.CNN介绍</h2>
<p>注：这里写得很简陋，只挑笔者不熟悉的部分写，具体学习还是得详看官方文档。</p>
<p>卷积神经网络（CNN）是一种深度学习模型，特别适用于处理图像和视频等数据。</p>
<p>CNN包括：卷积层、激活层、池化层、全连接层。</p>
<p>CNN的工作流程：</p>
<p>1.输入层：接收原始数据（如图像）</p>
<ol>
<li>
<p>卷积层：提取特征，生成特征图</p>
</li>
<li>
<p>激活层：引入非线性</p>
</li>
<li>
<p>池化层：下采样，减少维度</p>
</li>
<li>
<p>重复步骤 2-4：多次卷积和池化以提取更高层次的特征.</p>
</li>
<li>
<p>全连接层：展平特征图并进行分类</p>
</li>
<li>
<p>输出层：输出预测结果</p>
</li>
</ol>
<p>感受野是卷积神经网络中一个重要的概念，指的是网络中某一层的一个神经元所能“看到”的输入区域。</p>
<p>换句话说，感受野描述了网络中某个特征图位置的神经元对输入图像的哪些部分有响应。</p>
<p>单层感受野：对于卷积层，感受野的大小可以通过以下公式计算：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aed31bd0b5cc461d826b4af65a48d480~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqB5pmv572R5a6J5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763455877&amp;x-signature=hFxkJYbSvAMrUFGt31qMCEjnmQY%3D" alt="" loading="lazy"/></p>
<p>(R) 是当前层的感受野大小， R prev是前一层的感受野大小，(k) 是卷积核的大小，(S) 是步长。</p>
<p>说白了就是决定模型到底是看得宏观一点，还是看得微观一点，这主要还是取决于数据集，数据集提取出来的数学特征，是细节上的能够具体表明的数学特征。</p>
<p>还是比较抽象的数学特征。</p>
<p>比较抽象比较宏观的话，就可以用大一点的感受野。</p>
<p>感受野的影响：</p>
<ol>
<li>
<p>特征提取能力： 较大的感受野可以捕捉到更大范围的上下文信息，有助于提取全局特征，但是准确度可能就会下降;较小的感受野则适合捕捉局部细节，判断的准确度就会更高，但是就不能理解更高维度的内容。</p>
</li>
<li>
<p>模型性能： 在某些任务中，较大的感受野可能会提高模型的性能，尤其是在处理复杂场景时。</p>
</li>
<li>
<p>设计选择： 在设计CNN时，可以通过选择合适的卷积核大小、步长和层数来控制感受野的大小，以适应特 定任务的需求。</p>
</li>
</ol>
<h2 data-id="heading-2">2.CNN识别恶意软件</h2>
<p><strong>注意：这里放出的代码都不是完整的，只截取重要部分代码</strong>。</p>
<p>这里收集一些windows api的调用序列，观察这个软件中调用哪些api，来判断这个软件是不是恶意软件。</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">windows_api_list</span> = [
    <span class="hljs-string">"CreateFileA"</span>, <span class="hljs-string">"CreateFileW"</span>, <span class="hljs-string">"ReadFile"</span>, <span class="hljs-string">"WriteFile"</span>, <span class="hljs-string">"CloseHandle"</span>,
    <span class="hljs-string">"GetLastError"</span>, <span class="hljs-string">"SetLastError"</span>, <span class="hljs-string">"VirtualAlloc"</span>, <span class="hljs-string">"VirtualFree"</span>,
    <span class="hljs-string">"CreateThread"</span>, <span class="hljs-string">"ExitThread"</span>, <span class="hljs-string">"WaitForSingleObject"</span>, <span class="hljs-string">"GetModuleHandleA"</span>,
    <span class="hljs-string">"GetProcAddress"</span>, <span class="hljs-string">"LoadLibraryA"</span>, <span class="hljs-string">"LoadLibraryW"</span>, <span class="hljs-string">"FreeLibrary"</span>,
    <span class="hljs-string">"GetModuleFileNameA"</span>, <span class="hljs-string">"GetModuleFileNameW"</span>, <span class="hljs-string">"MessageBoxA"</span>, <span class="hljs-string">"MessageBoxW"</span>,
    <span class="hljs-string">"CreateEventA"</span>, <span class="hljs-string">"CreateEventW"</span>, <span class="hljs-string">"SetEvent"</span>, <span class="hljs-string">"ResetEvent"</span>, <span class="hljs-string">"WaitForMultipleObjects"</span>,
    <span class="hljs-string">"OpenProcess"</span>, <span class="hljs-string">"TerminateProcess"</span>, <span class="hljs-string">"ReadProcessMemory"</span>, <span class="hljs-string">"WriteProcessMemory"</span>,
    <span class="hljs-string">"CreateProcessA"</span>, <span class="hljs-string">"CreateProcessW"</span>, <span class="hljs-string">"GetExitCodeProcess"</span>, <span class="hljs-string">"ShellExecuteA"</span>,
    <span class="hljs-string">"ShellExecuteW"</span>, <span class="hljs-string">"FindFirstFileA"</span>, <span class="hljs-string">"FindNextFileA"</span>, <span class="hljs-string">"FindClose"</span>,
    <span class="hljs-string">"DeleteFileA"</span>, <span class="hljs-string">"DeleteFileW"</span>, <span class="hljs-string">"MoveFileA"</span>, <span class="hljs-string">"MoveFileW"</span>,
    <span class="hljs-string">"CopyFileA"</span>, <span class="hljs-string">"CopyFileW"</span>, <span class="hljs-string">"CreateDirectoryA"</span>, <span class="hljs-string">"CreateDirectoryW"</span>,
    <span class="hljs-string">"RemoveDirectoryA"</span>, <span class="hljs-string">"RemoveDirectoryW"</span>, <span class="hljs-string">"GetFileSize"</span>, <span class="hljs-string">"SetFilePointer"</span>,
    <span class="hljs-string">"FlushFileBuffers"</span>, <span class="hljs-string">"GetFileInformationByHandle"</span>, <span class="hljs-string">"SetEndOfFile"</span>,
    <span class="hljs-string">"GetFileTime"</span>, <span class="hljs-string">"SetFileTime"</span>, <span class="hljs-string">"CreateMutexA"</span>, <span class="hljs-string">"CreateMutexW"</span>,
    <span class="hljs-string">"ReleaseMutex"</span>, <span class="hljs-string">"OpenMutexA"</span>, <span class="hljs-string">"OpenMutexW"</span>, <span class="hljs-string">"CreateSemaphoreA"</span>,
    <span class="hljs-string">"CreateSemaphoreW"</span>, <span class="hljs-string">"ReleaseSemaphore"</span>, <span class="hljs-string">"OpenSemaphoreA"</span>, <span class="hljs-string">"OpenSemaphoreW"</span>,
    <span class="hljs-string">"CreatePipe"</span>, <span class="hljs-string">"ReadFileEx"</span>, <span class="hljs-string">"WriteFileEx"</span>, <span class="hljs-string">"CancelIo"</span>,
    <span class="hljs-string">"GetOverlappedResult"</span>, <span class="hljs-string">"CreateIoCompletionPort"</span>, <span class="hljs-string">"PostQueuedCompletionStatus"</span>,
    <span class="hljs-string">"GetQueuedCompletionStatus"</span>, <span class="hljs-string">"SetEvent"</span>, <span class="hljs-string">"ResetEvent"</span>, <span class="hljs-string">"CreateFileMappingA"</span>,
    <span class="hljs-string">"CreateFileMappingW"</span>, <span class="hljs-string">"MapViewOfFile"</span>, <span class="hljs-string">"UnmapViewOfFile"</span>, <span class="hljs-string">"VirtualQuery"</span>,
    <span class="hljs-string">"VirtualQueryEx"</span>, <span class="hljs-string">"GetSystemInfo"</span>, <span class="hljs-string">"GetSystemTime"</span>, <span class="hljs-string">"SetSystemTime"</span>,
    <span class="hljs-string">"GetTickCount"</span>, <span class="hljs-string">"Sleep"</span>, <span class="hljs-string">"GetCurrentProcessId"</span>, <span class="hljs-string">"GetCurrentThreadId"</span>,
    <span class="hljs-string">"GetCommandLineA"</span>, <span class="hljs-string">"GetCommandLineW"</span>, <span class="hljs-string">"GetEnvironmentVariableA"</span>,
    <span class="hljs-string">"GetEnvironmentVariableW"</span>, <span class="hljs-string">"SetEnvironmentVariableA"</span>, <span class="hljs-string">"SetEnvironmentVariableW"</span>,
    <span class="hljs-string">"CreateProcessAsUserA"</span>, <span class="hljs-string">"CreateProcessAsUserW"</span>, <span class="hljs-string">"ImpersonateLoggedOnUser"</span>,
    <span class="hljs-string">"RevertToSelf"</span>, <span class="hljs-string">"OpenThreadToken"</span>, <span class="hljs-string">"SetThreadToken"</span>, <span class="hljs-string">"DuplicateTokenEx"</span>,
    <span class="hljs-string">"AdjustTokenPrivileges"</span>, <span class="hljs-string">"GetTokenInformation"</span>, <span class="hljs-string">"SetTokenInformation"</span>,
    <span class="hljs-string">"CreateRemoteThread"</span>, <span class="hljs-string">"GetExitCodeThread"</span>, <span class="hljs-string">"WaitForInputIdle"</span>
]
</code></pre>
<p>收集完之后，把这些windows api变成numpy数组 类似[0,1]，每一个位置代表一个独特的windowsapi函数，位置上的值代表这个函数有没有被调用。</p>
<p>然后我们要接收.exe软件，使用pefile.PE这个python的第三方库，从其导入表里面把windows api提取出来，放入列表。</p>
<p>然后遍历.exe软件提取到的的windows api，是否在事先写好的windows api列表中，如果找到，就找到对应的索引号，写成1。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">extract_api_calls</span>(<span class="hljs-params">exe_path</span>):
    pe = pefile.PE(exe_path)
    api_calls = []

    <span class="hljs-comment"># 遍历导入表</span>
    <span class="hljs-keyword">for</span> entry <span class="hljs-keyword">in</span> pe.DIRECTORY_ENTRY_IMPORT:
        <span class="hljs-keyword">for</span> imp <span class="hljs-keyword">in</span> entry.imports:
            api_calls.append(imp.name.decode(<span class="hljs-string">'utf-8'</span>) <span class="hljs-keyword">if</span> imp.name <span class="hljs-keyword">else</span> <span class="hljs-literal">None</span>)

    <span class="hljs-keyword">return</span> api_calls

<span class="hljs-keyword">def</span> <span class="hljs-title function_">create_api_vector</span>(<span class="hljs-params">api_calls</span>):
    vector = np.zeros(<span class="hljs-built_in">len</span>(windows_api_list), dtype=<span class="hljs-built_in">int</span>)
    
    <span class="hljs-keyword">for</span> api <span class="hljs-keyword">in</span> api_calls:
        <span class="hljs-keyword">if</span> api <span class="hljs-keyword">in</span> windows_api_list:
            index = windows_api_list.index(api)
            vector[index] = <span class="hljs-number">1</span>
    
    <span class="hljs-keyword">return</span> vector
</code></pre>
<p>这里的恶意软件的数据集可以利用微步的api，去爬取恶意样本。</p>
<p>正常软件也同理。</p>
<p>把正常软件标签贴为0，恶意的程序标签为1。</p>
<pre><code class="hljs language-ini" lang="ini">def whitelist(whitedir):
    <span class="hljs-attr">labels</span> = []
    <span class="hljs-attr">features</span> = []
    <span class="hljs-comment"># 获取文件夹中所有的 EXE 文件</span>
    for filename in os.listdir(whitedir):
        if filename.endswith('.exe'):
            <span class="hljs-attr">one_feature</span> = read_one_file(os.path.join(whitedir, filename))
            features.append(one_feature)
            labels.append(0)  <span class="hljs-comment"># 标签为 0</span>

    <span class="hljs-comment"># 将 features 转换为 numpy 数组</span>
    <span class="hljs-attr">features_array</span> = np.array(features)

    return features_array, np.array(labels)

def blacklist(whitedir):
    <span class="hljs-attr">labels</span> = []
    <span class="hljs-attr">features</span> = []
    <span class="hljs-comment"># 获取文件夹中所有的 EXE 文件</span>
    for filename in os.listdir(whitedir):
        if filename.endswith('.exe'):
            <span class="hljs-attr">one_feature</span> = read_one_file(os.path.join(whitedir, filename))
            features.append(one_feature)
            labels.append(1)  <span class="hljs-comment"># 标签为 1</span>

    <span class="hljs-comment"># 将 features 转换为 numpy 数组</span>
    <span class="hljs-attr">features_array</span> = np.array(features)

    return features_array, np.array(labels)

<span class="hljs-comment"># 读取白名单和黑名单特征</span>
whitelist_features, <span class="hljs-attr">whitelist_labels</span> = whitelist(<span class="hljs-string">"./data/normal_file"</span>)
blacklist_features, <span class="hljs-attr">blacklist_labels</span> = blacklist(<span class="hljs-string">"./data/virus_file"</span>)
</code></pre>
<p>数据处理好之后，开始创建模型。</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">tensorflow</span> <span class="hljs-selector-tag">as</span> <span class="hljs-selector-tag">tf</span>
<span class="hljs-selector-tag">import</span> <span class="hljs-selector-tag">vec_data</span>
# 创建 <span class="hljs-selector-tag">CNN</span> 模型
<span class="hljs-selector-tag">model</span> = <span class="hljs-selector-tag">tf</span><span class="hljs-selector-class">.keras</span><span class="hljs-selector-class">.Sequential</span>([
    tf.keras.layers.<span class="hljs-built_in">Conv1D</span>(<span class="hljs-number">32</span>, kernel_size=<span class="hljs-number">3</span>, activation=<span class="hljs-string">'relu'</span>, input_shape=(vec_data.features.shape[<span class="hljs-number">1</span>], <span class="hljs-number">1</span>)),
    tf.keras.layers.<span class="hljs-built_in">MaxPooling1D</span>(pool_size=<span class="hljs-number">2</span>),
    tf.keras.layers.<span class="hljs-built_in">Conv1D</span>(<span class="hljs-number">64</span>, kernel_size=<span class="hljs-number">3</span>, activation=<span class="hljs-string">'relu'</span>),
    tf.keras.layers.<span class="hljs-built_in">MaxPooling1D</span>(pool_size=<span class="hljs-number">2</span>),
    tf.keras.layers.<span class="hljs-built_in">Flatten</span>(),
    tf.keras.layers.<span class="hljs-built_in">Dense</span>(<span class="hljs-number">64</span>, activation=<span class="hljs-string">'relu'</span>),
    tf.keras.layers.<span class="hljs-built_in">Dense</span>(<span class="hljs-number">2</span>, activation=<span class="hljs-string">'softmax'</span>)  # 二分类
])
</code></pre>
<p>模型比较简单，一个卷积，一个池化，再一个卷积，一个池化，然后就展平，全连接，全连接。</p>
<p>所有神经网络的第一层一定都是数据输入层，不管是什么神经网络算法，都得在第一层写个input_shape表示输入的数据。</p>
<p>接下来是模型的参数：</p>
<pre><code class="hljs language-arduino" lang="arduino">train_param = {<span class="hljs-string">"epoch"</span>: <span class="hljs-number">50</span>, <span class="hljs-string">"batch_size"</span>: <span class="hljs-number">32</span>}

model_compile_param = {
    <span class="hljs-string">"optimizer"</span>:<span class="hljs-string">'adam'</span>,
    <span class="hljs-string">"loss"</span>:<span class="hljs-string">'sparse_categorical_crossentropy'</span>,
    <span class="hljs-string">"metrics"</span>:[<span class="hljs-string">'accuracy'</span>]
}
</code></pre>
<p>第一个是训练次数 50 和每一次训练读到的数据的最小量 32。</p>
<p>第二个是模型编译的参数，adam编译器，损失函数，评分机制。</p>
<p>然后是模型训练：</p>
<pre><code class="hljs language-ini" lang="ini">import tensorflow as tf
import model_struct
import vec_data
import model_param
model_struct.model.compile(<span class="hljs-attr">optimizer</span>=model_param.model_compile_param[<span class="hljs-string">"optimizer"</span>],
                            <span class="hljs-attr">loss</span>=model_param.model_compile_param[<span class="hljs-string">"loss"</span>],
                            <span class="hljs-attr">metrics</span>=model_param.model_compile_param[<span class="hljs-string">"metrics"</span>])
print(model_struct.model.summary())
model_struct.model.fit(vec_data.features,
                        vec_data.labels,
                        <span class="hljs-attr">epochs</span>=model_param.train_param[<span class="hljs-string">"epoch"</span>],
                        <span class="hljs-attr">batch_size</span>=model_param.train_param[<span class="hljs-string">"batch_size"</span>])
model_struct.model.save("my_cnn.keras")
</code></pre>
<p>先把模型编译出来，然后就做训练，最后把模型保存下来。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12259139c0594352af01fba8cb3f7c81~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqB5pmv572R5a6J5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763455877&amp;x-signature=6YweNpF7flisQek0fo%2B%2Fiz8L3RY%3D" alt="" loading="lazy"/></p>
<p>显示的神经网络的形状，卷积层向下输出32，到展平那里输出已经是1600了。</p>
<p>下面是训练50次：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/af9453c2fe11490997b1669ecc68cf4b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqB5pmv572R5a6J5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763455877&amp;x-signature=9RxkQTClHvv9REYydekhyUkZFX4%3D" alt="" loading="lazy"/></p>
<p>可以看到损失函数的大小和正确率。</p>
<p>虽然最后正确率显示有92％，但是因为实际的样本数量较少，训练次数又较多，就会有过拟合的问题，实战不行。</p>
<p>所以还得去多找一些样本，VT和微步。</p>
<p>模型完成之后，就来用模型去测试了。</p>
<p>这里写个了简单弹窗程序：</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;windows.h&gt;</span></span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">main</span><span class="hljs-params">()</span> </span>{

	<span class="hljs-built_in">MessageBoxA</span>(<span class="hljs-literal">NULL</span>,<span class="hljs-string">"aaaa"</span>,<span class="hljs-string">"bbbb"</span>,MB_OK);

}
</code></pre>
<p>编译出.exe文件后丢给模型去测试：</p>
<pre><code class="hljs language-ini" lang="ini">import tensorflow as tf
import numpy as np
import vec_data
def predict_exe(exe_path, model):
    <span class="hljs-comment"># 提取 API 调用</span>
    <span class="hljs-attr">api_calls</span> = vec_data.extract_api_calls(exe_path)
    
    <span class="hljs-comment"># 创建特征向量</span>
    <span class="hljs-attr">feature_vector</span> = vec_data.create_api_vector(api_calls)
    
    <span class="hljs-comment"># 调整输入形状</span>
    <span class="hljs-attr">feature_vector</span> = feature_vector.reshape(<span class="hljs-number">1</span>, feature_vector.shape[<span class="hljs-number">0</span>], <span class="hljs-number">1</span>)  <span class="hljs-comment"># (1, 特征长度, 1)</span>
    
    <span class="hljs-comment"># 进行预测</span>
    <span class="hljs-attr">prediction</span> = model.predict(feature_vector)
    
    <span class="hljs-comment"># 获取预测结果</span>
    <span class="hljs-attr">predicted_class</span> = np.argmax(prediction, axis=<span class="hljs-number">1</span>)
    
    return predicted_class<span class="hljs-section">[0]</span>
<span class="hljs-attr">model</span> = tf.keras.models.load_model(<span class="hljs-string">'./my_cnn.keras'</span>)
<span class="hljs-comment"># 示例用法</span>
<span class="hljs-attr">exe_path</span> = <span class="hljs-string">"../Project1/x64/Release/Project1.exe"</span>  
<span class="hljs-attr">predicted_label</span> = predict_exe(exe_path, model)
print(f'Predicted label: {predicted_label}')  <span class="hljs-comment"># 0 表示白名单，1 表示黑名单</span>
</code></pre>
<p>将目标.exe文件导入，然后提取API，创建特征向量，调整输入形状，进行预测结果会是个矩阵，所以最后用np.argmax这个参数最大的矩阵拿来做标签预测。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e64f1874b61744ea89c0485c9673d4b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6JqB5pmv572R5a6J5a6e6aqM5a6k:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763455877&amp;x-signature=QEoL0nuheUno0DtdRZrit2d37MY%3D" alt="" loading="lazy"/></p>
<p>它显示的是1，也就是个恶意软件，但是这其实只是个正常的弹窗程序罢了。</p>
<p>所以这里其实就存在问题，样本数量太少了，导致实战不行。</p>
<p>不过模型的构造和训练方法是一样的，只需要增加样本数量和根据自己电脑性能调整训练次数，就可以有令人满意的结果。</p>
<p>补充：用windows api来做恶意软件检测其实算是比较取巧，因为在免杀中很多恶意软件是可以隐藏的导入表函数的，然后还有很多函数可以替换达到同样的效果。</p>
<p>还有就是现在很多恶意软件都会把自己的api调用变成一个正常应用程序，也就是说正常程序会调用的windows api，恶意软件也会用，所以拿windows api 来做恶意软件检测在实战中效果应该是不太理想的。</p>
<p>像360，火绒之类的大厂 会用ast ，也就是控制流程，if-else这些东西，做成numpy数组；</p>
<p>或者是直接把shellcode这类16进制数放入模型中，比如说提取text段shellcode放入数组。</p>
<p>当然长度可能会不一样，所以需要定义一下长度(1.1024*1024)，把shellcode放入到每一个位置中去，如果小于定义长度就拿0去填充。</p>
<p>如果大于就切掉多余的部分。</p>
<p>或者直接多个模型多个特征来综合判断是不是恶意软件。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Webpack DLL动态链接库的应用和思考]]></title>    <link>https://juejin.cn/post/7571086754879946798</link>    <guid>https://juejin.cn/post/7571086754879946798</guid>    <pubDate>2025-11-11T06:08:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571086754879946798" data-draft-id="7571060853370912818" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Webpack DLL动态链接库的应用和思考"/> <meta itemprop="keywords" content="前端,Webpack,性能优化"/> <meta itemprop="datePublished" content="2025-11-11T06:08:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="芳香茗的方"/> <meta itemprop="url" content="https://juejin.cn/user/141214963731848"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Webpack DLL动态链接库的应用和思考
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/141214963731848/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    芳香茗的方
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T06:08:35.000Z" title="Tue Nov 11 2025 06:08:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>DLL是“动态链接库”的意思，假设项目中用了 react 、lodash，这些静态资源可以被单独打包，且独立于项目。这样每次主项目打包的时候，都可以直接使用过打包好的 react、lodash，节省了性能。</p>
<p>原理：</p>
<ul>
<li>单独一份ddl config文件单独对react、lodash打包，会将打包产物和一个manifest文件放在某个目录下，manifest文件。</li>
<li>打包的产物是以全局变量的方式导出模块的，manifest文件用来告诉使用方react、lodash打包后生成的全局变量叫什么，</li>
<li>使用方在遇到react、lodash时候，就无需再次打包，将使用react和lodash模块的地方，根据manifest文件的指引去通过全局变量访问。</li>
</ul>
<p>简单的例子：</p>
<blockquote>
<p>单独开一个dll config文件 webpack.dll.config.js</p>
</blockquote>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">const</span> webpack = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpack'</span>);
<span class="hljs-keyword">const</span> { <span class="hljs-title class_">CleanWebpackPlugin</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'clean-webpack-plugin'</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">mode</span>: <span class="hljs-string">'production'</span>,
  <span class="hljs-attr">entry</span>: {
     <span class="hljs-comment">// 将react和lodash以及你想要预打包的静态文件打包成一个名为vendor的bundle</span>
     <span class="hljs-comment">// 这里没有路径，直接就一个react，就是去打包纯node_modules下的文件</span>
    <span class="hljs-comment">// 当然我们没有loader，webpack默认只能打包js和json文件。如果这里出现一个css入口文件，必然会发生打包错误。</span>
    <span class="hljs-attr">vendor</span>: [<span class="hljs-string">'react'</span>, <span class="hljs-string">'react-dom'</span>, <span class="hljs-string">'lodash'</span>] 
  },
  <span class="hljs-attr">output</span>: {
     <span class="hljs-comment">// 将生成的bundle生成在dll目录下</span>
    <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">'dll'</span>),
    <span class="hljs-attr">filename</span>: <span class="hljs-string">'[name]_[hash].dll.js'</span>,
     <span class="hljs-comment">// 因为dll对打包生成的模块的导出方式是全局变量的方式，需要通过library告诉webpack应该将模块导出维护在哪个全局变量上。这个全局变量叫做 '[name]_[hash]'，实际编译后即 vendor_&lt;hash&gt; </span>
    <span class="hljs-attr">library</span>: <span class="hljs-string">'[name]_[hash]'</span>
  },
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">CleanWebpackPlugin</span>(),
     <span class="hljs-comment">// 使用DllPlugin，这是webpack内置的plugin</span>
    <span class="hljs-keyword">new</span> webpack.<span class="hljs-title class_">DllPlugin</span>({
       <span class="hljs-comment">// 将生成的bundle生成在dll目录下，并且生成的manifest文件应该是[name]-manifest.json的形式</span>
      <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">'dll'</span>, <span class="hljs-string">'[name]-manifest.json'</span>),
       <span class="hljs-comment">// 表明这些模块的导出的全局变量名，必须和 output.library一致</span>
      <span class="hljs-attr">name</span>: <span class="hljs-string">'[name]_[hash]'</span>
    })
  ]
};
</code></pre>
<blockquote>
<p>然后是主体项目的webpack文件 webpack.config.js</p>
</blockquote>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">const</span> webpack = <span class="hljs-built_in">require</span>(<span class="hljs-string">'webpack'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">HtmlWebpackPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'html-webpack-plugin'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">AddAssetHtmlPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'add-asset-html-webpack-plugin'</span>);

<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">entry</span>: <span class="hljs-string">'./src/index.js'</span>,
  <span class="hljs-attr">output</span>: {
    <span class="hljs-attr">filename</span>: <span class="hljs-string">'[name].bundle.js'</span>,
    <span class="hljs-attr">path</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'dist'</span>)
  },
  <span class="hljs-attr">plugins</span>: [
     <span class="hljs-comment">// 应用方必须配合使用 DllReferencePlugin 才能完成工作</span>
    <span class="hljs-keyword">new</span> webpack.<span class="hljs-title class_">DllReferencePlugin</span>({
       <span class="hljs-comment">// 告诉manifest文件在哪</span>
      <span class="hljs-attr">manifest</span>: <span class="hljs-built_in">require</span>(<span class="hljs-string">'./dll/vendor-manifest.json'</span>)
    }),
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">HtmlWebpackPlugin</span>({
      <span class="hljs-attr">template</span>: <span class="hljs-string">'./src/index.html'</span>
    }),
     <span class="hljs-comment">// 需要注意的是，我们需要手动将react、lodash这样被预打包生成的bundle引入在index.html中</span>
     <span class="hljs-comment">// 可以选择直接手动通过&lt;scripe&gt;标签的方式引入，但这样不如直接使用 AddAssetHtmlPlugin 享受工程化带来的福利，比如 publicPath，以及index.html删除后还能自动引入</span>
    <span class="hljs-keyword">new</span> <span class="hljs-title class_">AddAssetHtmlPlugin</span>({
      <span class="hljs-attr">filepath</span>: path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">'dll/vendor_*.dll.js'</span>),
      <span class="hljs-attr">publicPath</span>: <span class="hljs-string">'./'</span>
    })
  ]
};
</code></pre>
<p>随后可以通过往package.json中加一些npm指令。在发布部署（CICD）时先<code>npm run dll</code>，然后<code>npm run build</code></p>
<p>打包后的运行时状态（伪代码）：</p>
<blockquote>
<p>vendor.dll.js 伪代码，大概的原理</p>
</blockquote>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">var</span> vendor_2e8f1b = (<span class="hljs-keyword">function</span>(<span class="hljs-params">modules</span>) {
  <span class="hljs-comment">// ▼ 模块缓存机制</span>
  <span class="hljs-keyword">var</span> installedModules = {};
  
  <span class="hljs-comment">// ▼ 模块加载实现 (类似__webpack_require__)</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">__dll_require__</span>(<span class="hljs-params">moduleId</span>) {
    <span class="hljs-keyword">if</span>(installedModules[moduleId]) 
      <span class="hljs-keyword">return</span> installedModules[moduleId].<span class="hljs-property">exports</span>;
    
    <span class="hljs-keyword">var</span> <span class="hljs-variable language_">module</span> = installedModules[moduleId] = {
      <span class="hljs-attr">id</span>: moduleId,
      <span class="hljs-attr">loaded</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">exports</span>: {}
    };
    modules[moduleId].<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>, <span class="hljs-variable language_">module</span>, <span class="hljs-built_in">exports</span>, __dll_require__);
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">loaded</span> = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span>;
  }
  
  <span class="hljs-comment">// ▼ 暴露全局变量</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">__dll_require__</span>(<span class="hljs-number">0</span>);
})({
  <span class="hljs-comment">/*! ▼ 预编译的第三方库模块集合 */</span>
  <span class="hljs-number">0</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">module</span>, <span class="hljs-built_in">exports</span></span>) {
    <span class="hljs-comment">// React核心实现</span>
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">React</span> = ... <span class="hljs-comment">// 完整React库代码</span>
  },
  <span class="hljs-number">1</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">module</span>, <span class="hljs-built_in">exports</span></span>) {
    <span class="hljs-comment">// ReactDOM实现</span>
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">ReactDOM</span> = ... 
  },
  <span class="hljs-number">2</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-variable language_">module</span>, <span class="hljs-built_in">exports</span></span>) {
    <span class="hljs-comment">// lodash工具库</span>
    <span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">_</span> = ... 
  }
});

</code></pre>
<blockquote>
<p>index.bundle.js 中访问lodash</p>
</blockquote>
<pre><code class="hljs language-js" lang="js"> <span class="hljs-comment">// 在bundle中动态绑定DLL模块，通过访问直接变量的方式来读取react、lodash。也就是说打包后的react和lodash的源码将不会出现在 index.bundle.js 中。 </span>
__webpack_require__.<span class="hljs-title function_">d</span>(<span class="hljs-built_in">exports</span>, <span class="hljs-string">"lodash"</span>, <span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-property">vendor_2e8f1b</span>[<span class="hljs-number">2</span>]);
</code></pre>
<blockquote>
<p>Manifest 文件</p>
</blockquote>
<pre><code class="hljs language-js" lang="js">{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"vendor_2e8f1b"</span>,
  <span class="hljs-string">"content"</span>: {  <span class="hljs-comment">// 提供给使用方的预打包bundle信息</span>
    <span class="hljs-string">"./node_modules/react/index.js"</span>: {
      <span class="hljs-string">"id"</span>: <span class="hljs-number">1</span>,  <span class="hljs-comment">// react的id为1，使用方的 import { useState } from 'react'; 打包后会通过 window.vendor_2e8f1b[1].useState 访问</span>
      <span class="hljs-string">"buildMeta"</span>: {<span class="hljs-string">"providedExports"</span>: <span class="hljs-literal">true</span>}
    },
    <span class="hljs-string">"./node_modules/lodash/lodash.js"</span>: {
      <span class="hljs-string">"id"</span>: <span class="hljs-number">2</span>,
      <span class="hljs-string">"buildMeta"</span>: {<span class="hljs-string">"usedExports"</span>: [<span class="hljs-string">"default"</span>]}
    }
  }
}
</code></pre>
<p><strong>学习Dll时思考的一些问题：</strong></p>
<p><em><strong>Q1：如果使用dll将react、lodash等第三方包预打包出去了，主项目对react和lodash是不是就无法启用treeshaking特性了？</strong></em></p>
<p>A1: 是的，因为在主项目中直接绕过了react和lodash的打包，使用了现成的打包产物，并采用全局变量的方式去访问由dll分离出去的包，自然无法对react和lodash走一遍打包编译的过程，也就没有静态分析的过程，也就是无法treeshaking了。要知道treeshaking影响的是主项目打包后的产物，而不是主项目外的打包产物。webpack总不能会根据manifest文件去反向分析dll预打包的产物，然后修改dll下的产物吧。</p>
<p><em><strong>Q2: dll能否解决Qiankun微前端资源共用问题？</strong></em></p>
<p>A2：是的，dll可以解决微前端资源共用问题，因为在微前端中，对公共资源的处理有externals方案。externals原理也是将公共依赖的模块抛出打包工程，根据配置使用cdn链接，进而通过全局变量式使用外置模块。而dll原理类似，并且dll无需独立部署外置模块的cdn了，所以也可以。</p>
<p>大体思路流程：</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6c4f2e5438ab4a1eb6098793c48c6443~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iqz6aaZ6IyX55qE5pa5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763446380&amp;x-signature=ftHBdNMc9ex0SU4TcvrDi32tbCw%3D" alt="image.png" loading="lazy"/></p>
<p>这样的缺点就是子应用没法脱离主应用独立运行。当然如果有子应用需要独立运行的需求，可以有两种办法：</p>
<ul>
<li>无论主应用还是子应用都通过addAssetHtmlPlugin实现将cdn下的所有js文件引入在html模板中。</li>
<li>或在子应用运行时，率先判断是否为独立运行状态，然后通过动态创建script标签的方式将所有cdn下的js文件引入，待script标签都加载完成后执行后续逻辑。</li>
</ul>
<blockquote>
<p>通过AddAssetHtmlPlugin实现对cdn下的文件</p>
</blockquote>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> <span class="hljs-title class_">AddAssetHtmlPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'add-asset-html-webpack-plugin'</span>);
<span class="hljs-keyword">const</span> <span class="hljs-title class_">HtmlWebpackPlugin</span> = <span class="hljs-built_in">require</span>(<span class="hljs-string">'html-webpack-plugin'</span>);

<span class="hljs-comment">// 准备CDN链接数组</span>
<span class="hljs-keyword">const</span> cdnAssets = [
  <span class="hljs-string">'https://cdn.example.com/library/vendor.react.js'</span>,
  <span class="hljs-string">'https://cdn.example.com/library/vendor.lodash.js
];

module.exports = {
  // ... 其他webpack配置
  plugins: [
    new HtmlWebpackPlugin(),
    // 使用 AddAssetHtmlPlugin 并传入CDN链接数组
    new AddAssetHtmlPlugin({ 
      files: cdnAssets 
    })
  ]
};
</span></code></pre>
<p><em><strong>Q3:dll能否替代external解决方案？</strong></em></p>
<p>A3：还是不能完全替代external方案的。虽然两者具备相似的原理。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/482ecc65ec394daeaf3998d677d42f8c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Iqz6aaZ6IyX55qE5pa5:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763446380&amp;x-signature=%2FT74SxC62FWazcXEki0pLdD8jCE%3D" alt="image.png" loading="lazy"/></p>
<p><em><strong>Q4：我的第三方库包含vue3，我希望转换为es5，但dll中的打包是es6的，那该怎么办？重新用dllplugin打包一个es5版本的么？</strong></em></p>
<p>A4：是的。思路是需要把webpack.dll.config.js中增加babel-loader相关配置，来使得dll下的产物也是es5的。下面是代码仅描述意思，仅供参考：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = {
  <span class="hljs-attr">module</span>: {
    <span class="hljs-attr">rules</span>: [
      {
        <span class="hljs-attr">test</span>: <span class="hljs-regexp">/.js$/</span>, <span class="hljs-comment">// 匹配所有JavaScript文件</span>
        <span class="hljs-attr">use</span>: {
          <span class="hljs-attr">loader</span>: <span class="hljs-string">'babel-loader'</span>, <span class="hljs-comment">// 必须使用loader而非plugin</span>
          <span class="hljs-attr">options</span>: {
            <span class="hljs-attr">presets</span>: [<span class="hljs-string">'@babel/preset-env'</span>] <span class="hljs-comment">// 指定ES5转换规则</span>
          }
        }
      }
    ]
  },
  <span class="hljs-attr">plugins</span>: [
    <span class="hljs-keyword">new</span> webpack.<span class="hljs-title class_">DllPlugin</span>({ <span class="hljs-comment">/* DLL配置 */</span> }) <span class="hljs-comment">// Plugin负责库生成，不处理文件转换</span>
  ]
};
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[用Unsloth微调一个老中医垂直领域大模型]]></title>    <link>https://juejin.cn/post/7571304204720406582</link>    <guid>https://juejin.cn/post/7571304204720406582</guid>    <pubDate>2025-11-11T06:12:58.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571304204720406582" data-draft-id="7571005216910393363" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="用Unsloth微调一个老中医垂直领域大模型"/> <meta itemprop="keywords" content="LLM,Agent,程序员"/> <meta itemprop="datePublished" content="2025-11-11T06:12:58.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="大模型教程"/> <meta itemprop="url" content="https://juejin.cn/user/1145012233707299"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            用Unsloth微调一个老中医垂直领域大模型
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1145012233707299/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    大模型教程
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T06:12:58.000Z" title="Tue Nov 11 2025 06:12:58 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#383838;font-size:15px;line-height:30px;letter-spacing:2px;word-break:break-word;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Oxygen,Ubuntu,Cantarell,Open Sans,Helvetica Neue,sans-serif;scroll-behavior:smooth;background-image:linear-gradient(0deg,transparent 24%,rgba(201,195,195,.329) 25%,hsla(0,8%,80.4%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent),linear-gradient(90deg,transparent 24%,rgba(204,196,196,.226) 25%,hsla(0,4%,66.1%,.05) 26%,transparent 27%,transparent 74%,hsla(0,5.2%,81%,.185) 75%,rgba(180,176,176,.05) 76%,transparent 77%,transparent);background-color:#fff;background-size:50px 50px;padding-bottom:60px}.markdown-body ::selection{color:#fff;background-color:#a862ea}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:24px 0 12px;color:#a862ea}.markdown-body h1{line-height:2;font-size:1.4em}.markdown-body h1~p:first-of-type:first-letter{color:#a862ea;float:left;font-size:2em;margin-right:.4em;font-weight:bolder}.markdown-body h2{font-size:1.2em}.markdown-body h3{font-size:1.1em}.markdown-body ol,.markdown-body ul{padding-left:2em}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;padding-left:.2em}.markdown-body ol li::marker,.markdown-body ul li::marker{color:#a862ea}.markdown-body ol li.task-list-item,.markdown-body ul li.task-list-item{list-style:none}.markdown-body ol li.task-list-item ol,.markdown-body ol li.task-list-item ul,.markdown-body ul li.task-list-item ol,.markdown-body ul li.task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:10px}.markdown-body a,.markdown-body code,.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6,.markdown-body li,.markdown-body p{opacity:.85;vertical-align:baseline;transition:all .1s ease}.markdown-body a:hover,.markdown-body code:hover,.markdown-body h1:hover,.markdown-body h2:hover,.markdown-body h3:hover,.markdown-body h4:hover,.markdown-body h5:hover,.markdown-body h6:hover,.markdown-body li:hover,.markdown-body p:hover{opacity:1}.markdown-body a{display:inline-block;color:#a862ea;cursor:pointer;text-decoration:none;position:relative}.markdown-body a:after{content:"";position:absolute;width:98%;height:1px;bottom:0;left:0;transform:scaleX(0);background-color:#a862ea;transform-origin:bottom right;transition:transform .3s ease-in-out}.markdown-body a:hover:after{transform:scaleX(1);transform-origin:bottom left}.markdown-body a:active,.markdown-body a:link{color:#a862ea}.markdown-body img{max-width:100%;user-select:none;margin:1em 0;transition:transform .2s ease 0s;background-color:#f8f5ff;box-shadow:0 0 10px #e7daff}.markdown-body img:hover{opacity:1;box-shadow:0 0 20px #e7daff;transform:translateY(-1px)}.markdown-body blockquote{padding:.5em 1em;margin:12px 0;border-top-left-radius:2px;border-bottom-left-radius:2px;border-left:3px solid #a862ea;background-color:#f8f5ff}.markdown-body blockquote&gt;p{margin:0}.markdown-body .math{font-style:italic;margin:12px 0;padding:.5em 1em;background-color:#f8f5ff}.markdown-body .math&gt;p{margin:0}.markdown-body code{padding:2px .4em;overflow-x:auto;color:#a862ea;font-weight:700;word-break:break-word;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;background-color:#f8f5ff}.markdown-body pre{margin:2em 0}.markdown-body pre&gt;code{display:block;padding:1.5em;word-break:normal;font-size:.9em;font-style:normal;font-weight:400;font-family:Operator Mono,Consolas,Monaco,Menlo,monospace;line-height:18px;color:#383838;border-radius:2px;scroll-behavior:smooth;box-shadow:0 0 10px #e7daff}.markdown-body pre&gt;code:hover{box-shadow:0 0 20px #e7daff}.markdown-body pre&gt;code::-webkit-scrollbar{height:6px;background-color:#f8f5ff}.markdown-body pre&gt;code::-webkit-scrollbar-thumb{background-color:#e7daff;border-bottom-left-radius:3px;border-bottom-right-radius:3px}.markdown-body hr{margin:2em 0;border-top:1px solid #a862ea}.markdown-body table{width:100%;font-size:12px;max-width:100%;overflow:auto;border-collapse:collapse}.markdown-body thead{color:#a862ea;background:#f8f5ff}.markdown-body td,.markdown-body th{padding:.5em;border:1px solid #e7daff}.markdown-body tr{background-color:#f8f5ff}@media (max-width:720px){.markdown-body{font-size:12px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote>
<p>本文介绍了如何使用Unsloth框架微调大语言模型，以《伤寒论》数据集为例训练一个中医专家模型。Unsloth显著降低了微调的资源需求。文章涵盖了从环境配置、模型选择、数据准备到训练部署的完整流程，为垂直领域模型微调提供了实用参考。</p>
<p>在实际应用中，我们常常面临特定场景下的问题需求。此时，通过指令微调可以让模型更好地适应这些具体任务，从而提升模型的实用性和表现。</p>
<p>比如：在医疗健康领域，医生希望让大模型更好地理解中医诊断和治疗的知识体系，从而能够辅助分析病情、推荐中药方剂，甚至自动生成病历摘要。又如，在法律行业，律师团队希望通过微调，让大模型能够更准确地解读中国法律条文、判例和合同文本，辅助法律检索和文书生成。此外，在教育领域，教师可以通过指令微调，让模型更贴合本地教材内容，自动批改作业、生成个性化学习建议。这些场景都需要针对特定任务和数据对大模型进行定制化微调，以提升其在实际应用中的表现和价值。</p>
<p>正好最近身体不适，并且得到一本医疗秘籍《伤寒论》，用 <code>Unsloth</code> 来微调一个垂直领域的模型出来。</p>
<h2 data-id="heading-0">1.  关于Unsloth</h2>
<p>大型语言模型（LLM）的微调有很大的资源挑战，如高昂的内存需求和漫长的训练时间。</p>
<p>传统的微调方法，可能需要数十小时才能完成一项任务，并且常常导致内存不足问题 。这种特性限制了个人开发者和小型团队对 LLM 进行定制化和优化的能力。</p>
<p>Unsloth 正是为了解决这些痛点而诞生的。</p>
<p>它是一个专门为加速 LLM 微调并显著降低内存消耗而设计的 Python 框架 。</p>
<p>Unsloth 实现了显著的性能提升，同时保持了与 Hugging Face 生态系统的完全兼容性 。这使得用户即使在免费的 Colab GPU 或配备 GPU 的笔记本电脑等有限硬件上，也能够高效地进行 LLM 微调 。</p>
<h2 data-id="heading-1">2.  Unsloth 的核心优势</h2>
<p><strong>速度提升</strong></p>
<p>在Alpaca 数据集上进行了测试，使用的 batch 大小为 2，gradient accumulation steps 为 4，rank 为 32，并在所有线性层（q、k、v、o、gate、up、down）上应用了 QLoRA</p>





























<table><thead><tr><th>Model</th><th>VRAM</th><th>Unsloth speed</th><th>VRAM reduction</th><th>Longer context</th><th>Hugging Face + FA2</th></tr></thead><tbody><tr><td>Llama 3.3 (70B)</td><td>80GB</td><td>2x</td><td>&gt;75%</td><td>13x longer</td><td>1x</td></tr><tr><td>Llama 3.1 (8B)</td><td>80GB</td><td>2x</td><td>&gt;70%</td><td>12x longer</td><td>1x</td></tr></tbody></table>
<p>测试结果显示，两种模型在显存使用上均为80GB，速度均提升了2倍。Llama 3.3的显存减少了超过75%，能够处理的上下文长度提升了13倍；而Llama 3.1的显存减少了超过70%，上下文长度提升了12倍。</p>
<p><strong>API 简化</strong></p>
<p>Unsloth 提供了一个简洁的 API，显著降低了 LLM 微调的复杂性 。它将模型加载、量化、训练、评估、保存、导出以及与 Ollama、llama.cpp 和 vLLM 等推理引擎的集成等所有工作流程进行了简化 。</p>
<p><strong>Hugging Face 生态系统兼容性</strong></p>
<p>Unsloth 是在 Hugging Face Transformers 库之上构建的，这使其能够充分利用 Hugging Face 强大的生态系统，同时添加自己的增强功能来简化微调过程 。</p>
<p>它与 Hugging Face Hub、Transformers、PEFT 和 TRL 等组件完全兼容 。这意味着用户可以无缝地访问 Hugging Face 提供的丰富模型和数据集资源，并利用 Unsloth 的优化进行训练。</p>
<p><strong>硬件兼容性与可访问性</strong></p>
<p>Unsloth 支持非常多的 NVIDIA GPU，从 2018 年及以后发布的型号，包括 V100、T4、Titan V、RTX 20、30、40 系列、A100 和 H100 等，最低 CUDA 能力要求为 7.0。即使是 GTX 1070 和 1080 也能工作，尽管速度较慢 。</p>
<p>Unsloth 可以在 Linux 和 Windows 操作系统上运行 。</p>
<p><strong>广泛的模型支持</strong></p>
<p>Unsloth 支持所有 Transformer 风格的模型，包括 Llama、DeepSeek、TTS、Qwen、Mistral、Gemma 等主流 LLM。它还支持多模态模型、文本到语音 (TTS)、语音到文本 (STT) 模型、BERT 模型以及扩散模型。</p>
<p><strong>动态量化</strong></p>
<p>Unsloth 引入了动态 4 位量化 (Dynamic 4-bit Quantization) 技术，这是一种智能的量化策略，通过动态选择不对某些参数进行量化，从而在仅增加不到 10% VRAM 的情况下显著提高准确性 。</p>
<p><strong>社区的活跃</strong></p>
<p>从GitHub上可以看出，他的受欢迎程度非常高，目前已经43k颗星</p>
<blockquote>
<p>❝</p>
<p>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Funslothai%2Funsloth" target="_blank" title="https://github.com/unslothai/unsloth" ref="nofollow noopener noreferrer">github.com/unslothai/u…</a></p>
</blockquote>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2fcdecd2deb545b589b9c4e71cb0ce83~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763446378&amp;x-signature=ClBLhODcfYaWWVRXbkvK0TMccGg%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-2">3.  使用要求</h2>
<hr/>
<p>支持 Linux 和 Windows。</p>
<p>支持 2018 年及以后的 NVIDIA 显卡，包括 Blackwell RTX 50 系列。最低要求 CUDA 计算能力为 7.0（如 V100、T4、Titan V、RTX 20、30、40 系列，以及 A100、H100、L40 等）。GTX 1070、1080 虽然可以使用，但运行速度较慢。</p>
<p><strong>GPU内存要求：</strong></p>











































































<table><thead><tr><th>Model parameters</th><th>QLoRA (4-bit) VRAM</th><th>LoRA (16-bit) VRAM</th></tr></thead><tbody><tr><td>3B</td><td>3.5 GB</td><td>8 GB</td></tr><tr><td>7B</td><td>5 GB</td><td>19 GB</td></tr><tr><td>8B</td><td>6 GB</td><td>22 GB</td></tr><tr><td>9B</td><td>6.5 GB</td><td>24 GB</td></tr><tr><td>11B</td><td>7.5 GB</td><td>29 GB</td></tr><tr><td>14B</td><td>8.5 GB</td><td>33 GB</td></tr><tr><td>27B</td><td>22GB</td><td>64GB</td></tr><tr><td>32B</td><td>26 GB</td><td>76 GB</td></tr><tr><td>40B</td><td>30GB</td><td>96GB</td></tr><tr><td>70B</td><td>41 GB</td><td>164 GB</td></tr><tr><td>81B</td><td>48GB</td><td>192GB</td></tr><tr><td>90B</td><td>53GB</td><td>212GB</td></tr><tr><td>405B</td><td>237 GB</td><td>950 GB</td></tr></tbody></table>
<h2 data-id="heading-3">4.  安装 Unsloth</h2>
<hr/>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 初始化一个名为 demo-unsloth 的项目，并指定 Python 版本为 3.11.9  </span>
uv init demo-unsloth -p 3.11.9  
<span class="hljs-comment"># 进入项目目录  </span>
<span class="hljs-built_in">cd</span> demo-unsloth  
<span class="hljs-comment"># 创建虚拟环境  </span>
uv venv  
<span class="hljs-comment"># 激活虚拟环境（Windows 下）  </span>
.venv\Scripts\activate  
<span class="hljs-comment"># 安装 triton-windows，要求版本3.3.1.post19  </span>
uv pip install triton-windows==3.3.1.post19  
<span class="hljs-comment"># 安装支持 CUDA 12.6 的 PyTorch 及其相关库  </span>
uv pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cu126
</code></pre>
<p><strong>安装unsloth</strong></p>
<pre><code class="hljs">uv pip install unsloth
</code></pre>
<h2 data-id="heading-4">5.  选择模型</h2>
<hr/>
<p>Unsloth 支持非常多的预训练模型，包括 Llama、DeepSeek、TTS、Qwen、Mistral 和 Gemma 系列 LLM 3。</p>
<p>在选择模型时，需要注意模型名称的后缀。以 <code>unsloth-bnb-4bit</code> 结尾的模型表示它们是 Unsloth 动态 4 位量化模型，与标准 <code>bnb-4bit</code> 模型相比，这些模型在略微增加 VRAM 使用的情况下提供了更高的精度。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.unsloth.ai%2Fget-started%2Fall-our-models" target="_blank" title="https://docs.unsloth.ai/get-started/all-our-models" ref="nofollow noopener noreferrer">docs.unsloth.ai/get-started…</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6e079ef9a2c44f6cbbb68adbc9a84acf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5aSn5qih5Z6L5pWZ56iL:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763446378&amp;x-signature=OIda%2FB%2B45WTQ8nLx7Da6blqwa2o%3D" alt="" loading="lazy"/></p>
<p><strong>我的显卡是RTX 2050显卡，4GB显存，我选一个比较小的版本 unsloth/Qwen2.5-1.5B-Instruct-bnb-4bit</strong></p>
<p><strong>下载模型：</strong></p>
<pre><code class="hljs language-css" lang="css">huggingface-cli download <span class="hljs-attr">--resume-download</span> unsloth/Qwen2.<span class="hljs-number">5</span>-<span class="hljs-number">1.5</span>B-Instruct-bnb-<span class="hljs-number">4</span>bit <span class="hljs-attr">--local-dir</span> ./ckpts/qwen2.<span class="hljs-number">5</span>-<span class="hljs-number">1.5</span>b-instruct-bnb-<span class="hljs-number">4</span>bit
</code></pre>
<h2 data-id="heading-5">6.  数据集准备</h2>
<hr/>
<p>数据集的质量和格式直接决定了模型微调的效果。</p>
<p>一个高质量的数据集不仅需要覆盖目标任务的核心内容，还应保证问答对的准确性、完整性和多样性。</p>
<p>此外，数据集的规模也会影响模型的泛化能力，数据量越大、覆盖面越广，模型在实际应用中的表现通常会更好。</p>
<p>因此，在微调前应充分清洗、标注和检查数据，确保其能够有效支撑下游任务的训练需求。</p>
<p>因为要要训练一个老中医，所以找了一本《伤寒论》,通过工具把他拆成问答对，格式如下</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-attr">[    {      <span class="hljs-string">"Question"</span>: <span class="hljs-string">"伤寒一日，巨阳受之会出现什么症状？"</span>,      <span class="hljs-string">"Response"</span>: <span class="hljs-string">"伤寒一日，巨阳受之会出现头项痛、腰脊强的症状。因为巨阳者，诸阳之属也，其脉连于风府，为诸阳主气，所以先受邪。 "</span>    },    {      <span class="hljs-string">"Question"</span>: <span class="hljs-string">"三阴受病，厥阴受之会出现什么症状"</span>,      <span class="hljs-string">"Response"</span>: <span class="hljs-string">"三阴受病，若厥阴受之，厥阴脉循阴器而络于肝，会出现烦满而囊缩的症状。 若伤寒循常无变，十二日厥阴病衰，会出现囊纵、少腹微下的情况。 "</span>    },  ]</span>
</code></pre>
<h2 data-id="heading-6">7.  开始微调</h2>
<hr/>
<h4 data-id="heading-7">7.1 引入依赖</h4>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 导入必要的库  </span>
<span class="hljs-keyword">from</span> unsloth <span class="hljs-keyword">import</span> FastLanguageModel, is_bfloat16_supported  
<span class="hljs-keyword">from</span> transformers <span class="hljs-keyword">import</span> TrainingArguments, EarlyStoppingCallback  
<span class="hljs-keyword">from</span> trl <span class="hljs-keyword">import</span> SFTTrainer  
<span class="hljs-keyword">from</span> datasets <span class="hljs-keyword">import</span> load_dataset  
  
<span class="hljs-comment"># 模型配置参数  </span>
max_seq_length = <span class="hljs-number">2048</span>  <span class="hljs-comment"># 模型处理文本的最大序列长度，支持长文本输入</span>
</code></pre>
<h4 data-id="heading-8">7.2 加载模型</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 加载预训练模型和分词器  </span>
model, <span class="hljs-attr">tokenizer</span> = FastLanguageModel.from_pretrained(  
    <span class="hljs-attr">model_name</span>=<span class="hljs-string">"ckpts/qwen2.5-1.5b-instruct-bnb-4bit"</span>,  
    <span class="hljs-attr">max_seq_length</span>=max_seq_length,  
    <span class="hljs-attr">dtype</span>=None,  <span class="hljs-comment"># 自动检测最佳数据类型（bfloat16或float16）  </span>
    <span class="hljs-attr">load_in_4bit</span>=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 使用4bit量化加载模型，大幅减少显存占用  </span>
)
</code></pre>
<h4 data-id="heading-9">7.3 加载数据集</h4>
<p>大型语言模型需要以特定的“提示风格”或“聊天模板”来接收输入，以便它们能够正确理解任务、指令、输入和预期响应之间的关系。</p>
<p>例如，一个常用的提示风格是：</p>
<pre><code class="hljs language-bash" lang="bash">“请先阅读下方的任务指令，再结合提供的上下文信息，生成恰当的回复。<span class="hljs-comment">### 指令：{} ### 上下文：{} ### 回复：{}”</span>
</code></pre>
<p>有效的微调需要仔细关注输入格式，因为它直接影响模型学习的内容和响应方式</p>
<p>下面代码中加载我们的《伤寒论》数据集（ <code>data/datasets-2025-08.json</code>），并使用 <code>formatting_data</code> 函数将其转换为 Unsloth 所需的格式，此函数会结合输入和输出，按照 <code>prompt_style</code> 进行格式化，并添加 <code>EOS_TOKEN</code>（End-of-Sentence Token），<code>EOS_TOKEN</code> 对于避免模型生成重复内容至关重要。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 定义训练数据格式化模板  </span>
<span class="hljs-comment"># 使用中医专家角色设定，专门针对《伤寒论》问答任务  </span>
train_prompt_style = <span class="hljs-string">"""你是一位精通中医理论的专家，特别擅长《伤寒论》的理论和实践应用。  
请根据《伤寒论》的经典理论，准确回答以下问题。  
  
### 问题:  
{}  
  
### 回答:  
{}  
"""</span>  
  
<span class="hljs-comment"># 加载训练数据集  </span>
<span class="hljs-comment"># 从JSON文件加载伤寒论问答数据集，包含问题和回答对  </span>
dataset = load_dataset(<span class="hljs-string">"json"</span>, data_files=<span class="hljs-string">"data/datasets-2025-08.json"</span>, split=<span class="hljs-string">"train"</span>)    
  
  
<span class="hljs-keyword">def</span> <span class="hljs-title function_">formatting_data</span>(<span class="hljs-params">examples</span>):  
    <span class="hljs-string">"""格式化数据集函数，将问答对转换为训练格式  
      
    将原始的问题和回答对格式化为模型训练所需的文本格式，  
    添加角色设定和结构化模板。  
  
    Args:  
        examples: 包含Question、Response字段的数据样本字典  
  
    Returns:  
        dict: 包含格式化后文本的字典，键为"text"  
    """</span>  
    questions = examples[<span class="hljs-string">"Question"</span>]  
    responses = examples[<span class="hljs-string">"Response"</span>]  
    texts = []  
    <span class="hljs-keyword">for</span> q, r <span class="hljs-keyword">in</span> <span class="hljs-built_in">zip</span>(questions, responses):  
        <span class="hljs-comment"># 使用模板格式化每个问答对，并添加结束标记  </span>
        text = train_prompt_style.<span class="hljs-built_in">format</span>(q, r) + tokenizer.eos_token  
        texts.append(text)  
    <span class="hljs-comment"># print(f"数据集: {texts}")  </span>
    <span class="hljs-keyword">return</span> {<span class="hljs-string">"text"</span>: texts}  
  
  
<span class="hljs-comment"># 应用数据格式化函数  </span>
dataset = dataset.<span class="hljs-built_in">map</span>(formatting_data, batched=<span class="hljs-literal">True</span>, num_proc=<span class="hljs-number">1</span>)  
  
<span class="hljs-comment"># 数据集分割：80%用于训练，20%用于验证  </span>
<span class="hljs-comment"># 使用固定随机种子确保结果可复现  </span>
train_test_split = dataset.train_test_split(test_size=<span class="hljs-number">0.2</span>, seed=<span class="hljs-number">3407</span>)  
train_dataset = train_test_split[<span class="hljs-string">'train'</span>]  
eval_dataset = train_test_split[<span class="hljs-string">'test'</span>]  
  
<span class="hljs-built_in">print</span>(<span class="hljs-string">f"数据集加载完成 - 训练集: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(train_dataset)}</span> 条, 验证集: <span class="hljs-subst">{<span class="hljs-built_in">len</span>(eval_dataset)}</span> 条"</span>)
</code></pre>
<h4 data-id="heading-10">7.4 定义 LoRA</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 添加LoRA（Low-Rank Adaptation）权重配置  </span>
<span class="hljs-comment"># LoRA是一种高效的微调方法，只训练少量参数即可适应新任务  </span>
<span class="hljs-attr">model</span> = FastLanguageModel.get_peft_model(  
    model,  
    <span class="hljs-attr">r</span>=<span class="hljs-number">32</span>,  <span class="hljs-comment"># LoRA矩阵的秩，值越大表达能力越强，但参数量也越多  </span>
    <span class="hljs-attr">target_modules</span>=[<span class="hljs-string">"q_proj"</span>, <span class="hljs-string">"k_proj"</span>, <span class="hljs-string">"v_proj"</span>, <span class="hljs-string">"o_proj"</span>, <span class="hljs-string">"gate_proj"</span>, <span class="hljs-string">"up_proj"</span>, <span class="hljs-string">"down_proj"</span>, ],  
    <span class="hljs-attr">lora_alpha</span>=<span class="hljs-number">64</span>,  <span class="hljs-comment"># LoRA缩放参数  </span>
    <span class="hljs-attr">lora_dropout</span>=<span class="hljs-number">0.1</span>,  <span class="hljs-comment"># LoRA dropout率，防止过拟合，值越小正则化越弱  </span>
    <span class="hljs-attr">bias</span>=<span class="hljs-string">"none"</span>,  <span class="hljs-comment"># 偏置项处理方式，"none"表示不训练偏置，节省参数  </span>
    <span class="hljs-attr">use_gradient_checkpointing</span>=<span class="hljs-string">"unsloth"</span>,  <span class="hljs-comment"># 使用Unsloth优化的梯度检查点，支持超长序列  </span>
    <span class="hljs-attr">random_state</span>=<span class="hljs-number">3407</span>,  <span class="hljs-comment"># 随机种子，确保结果可复现  </span>
    <span class="hljs-attr">use_rslora</span>=<span class="hljs-literal">False</span>,  <span class="hljs-comment"># 是否使用Rank Stabilized LoRA，当前使用标准LoRA  </span>
    <span class="hljs-attr">loftq_config</span>=None,  <span class="hljs-comment"># LoftQ配置，用于更精确的量化  </span>
)
</code></pre>
<h4 data-id="heading-11">7.5 使用 <code>SFTTrainer</code> 进行训练</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># 创建SFT（Supervised Fine-Tuning）训练器  </span>
<span class="hljs-comment"># 使用监督学习方式微调模型，适用于问答任务  </span>
<span class="hljs-attr">trainer</span> = SFTTrainer(  
    <span class="hljs-attr">model</span>=model,  
    <span class="hljs-attr">tokenizer</span>=tokenizer,  
    <span class="hljs-attr">train_dataset</span>=train_dataset,  <span class="hljs-comment"># 训练数据集  </span>
    <span class="hljs-attr">eval_dataset</span>=eval_dataset,  <span class="hljs-comment"># 验证数据集，用于评估模型性能  </span>
    <span class="hljs-attr">dataset_text_field</span>=<span class="hljs-string">"text"</span>,  <span class="hljs-comment"># 数据集中文本字段的名称  </span>
    <span class="hljs-attr">max_seq_length</span>=max_seq_length,  <span class="hljs-comment"># 最大序列长度  </span>
    <span class="hljs-attr">dataset_num_proc</span>=<span class="hljs-number">1</span>,  <span class="hljs-comment"># 数据处理进程数，设为1避免缓存冲突  </span>
    <span class="hljs-attr">packing</span>=<span class="hljs-literal">False</span>,  <span class="hljs-comment"># 是否使用序列打包，短序列时可设为True提升5倍训练速度  </span>
    <span class="hljs-attr">callbacks</span>=[  
        EarlyStoppingCallback(early_stopping_patience=<span class="hljs-number">3</span>, early_stopping_threshold=<span class="hljs-number">0.0005</span>),  <span class="hljs-comment"># 早停机制，防止过拟合  </span>
    ],  
    <span class="hljs-attr">args</span>=TrainingArguments(  
        <span class="hljs-comment"># 批次大小配置  </span>
        <span class="hljs-attr">per_device_train_batch_size</span>=<span class="hljs-number">2</span>,  <span class="hljs-comment"># 每个GPU的训练批次大小  </span>
        <span class="hljs-attr">per_device_eval_batch_size</span>=<span class="hljs-number">2</span>,  <span class="hljs-comment"># 每个GPU的验证批次大小  </span>
          
        <span class="hljs-comment"># 梯度累积配置  </span>
        <span class="hljs-attr">gradient_accumulation_steps</span>=<span class="hljs-number">8</span>,  <span class="hljs-comment"># 梯度累积步数，有效批次大小 = batch_size * gradient_accumulation_steps  </span>
          
        <span class="hljs-comment"># 学习率配置  </span>
        <span class="hljs-attr">warmup_ratio</span>=<span class="hljs-number">0.15</span>,  <span class="hljs-comment"># 学习率预热比例，前15%的步数用于预热  </span>
        <span class="hljs-attr">learning_rate</span>=<span class="hljs-number">2</span>e-<span class="hljs-number">5</span>,  <span class="hljs-comment"># 学习率，控制参数更新步长  </span>
          
        <span class="hljs-comment"># 训练轮数和步数配置  </span>
        <span class="hljs-comment"># max_steps = 200, # 最大训练步数（可选）  </span>
        <span class="hljs-attr">num_train_epochs</span>=<span class="hljs-number">5</span>,  <span class="hljs-comment"># 训练轮数，给模型充分学习机会  </span>
          
        <span class="hljs-comment"># 精度配置  </span>
        <span class="hljs-attr">fp16</span>=not is_bfloat16_supported(),  <span class="hljs-comment"># 是否使用16位浮点精度训练  </span>
        <span class="hljs-attr">bf16</span>=is_bfloat16_supported(),  <span class="hljs-comment"># 是否使用bfloat16精度训练（更稳定）  </span>
          
        <span class="hljs-comment"># 日志和监控配置  </span>
        <span class="hljs-attr">logging_steps</span>=<span class="hljs-number">2</span>,  <span class="hljs-comment"># 每2步记录一次日志  </span>
        <span class="hljs-attr">eval_steps</span>=<span class="hljs-number">10</span>,  <span class="hljs-comment"># 每10步进行一次验证评估  </span>
        <span class="hljs-attr">eval_strategy</span>=<span class="hljs-string">"steps"</span>,  <span class="hljs-comment"># 按步数进行验证  </span>
          
        <span class="hljs-comment"># 模型保存配置  </span>
        <span class="hljs-attr">save_steps</span>=<span class="hljs-number">20</span>,  <span class="hljs-comment"># 每20步保存一次模型检查点  </span>
        <span class="hljs-attr">save_strategy</span>=<span class="hljs-string">"steps"</span>,  <span class="hljs-comment"># 按步数保存模型  </span>
        <span class="hljs-attr">save_total_limit</span>=<span class="hljs-number">5</span>,  <span class="hljs-comment"># 最多保存5个检查点，节省存储空间  </span>
          
        <span class="hljs-comment"># 最佳模型配置  </span>
        <span class="hljs-attr">load_best_model_at_end</span>=<span class="hljs-literal">True</span>,  <span class="hljs-comment"># 训练结束时自动加载最佳模型  </span>
        <span class="hljs-attr">metric_for_best_model</span>=<span class="hljs-string">"eval_loss"</span>,  <span class="hljs-comment"># 使用验证损失作为最佳模型指标  </span>
        <span class="hljs-attr">greater_is_better</span>=<span class="hljs-literal">False</span>,  <span class="hljs-comment"># 损失越小越好  </span>
          
        <span class="hljs-comment"># 正则化配置  </span>
        <span class="hljs-attr">weight_decay</span>=<span class="hljs-number">0.001</span>,  <span class="hljs-comment"># 权重衰减，防止过拟合  </span>
        <span class="hljs-attr">max_grad_norm</span>=<span class="hljs-number">1.0</span>,  <span class="hljs-comment"># 梯度裁剪阈值，防止梯度爆炸  </span>
          
        <span class="hljs-comment"># 学习率调度配置  </span>
        <span class="hljs-attr">lr_scheduler_type</span>=<span class="hljs-string">"cosine"</span>,  <span class="hljs-comment"># 使用余弦退火学习率调度器  </span>
          
        <span class="hljs-comment"># 优化器配置  </span>
        <span class="hljs-attr">optim</span>=<span class="hljs-string">"adamw_8bit"</span>,  <span class="hljs-comment"># 使用8位AdamW优化器，节省显存  </span>
          
        <span class="hljs-comment"># 数据加载配置  </span>
        <span class="hljs-attr">dataloader_num_workers</span>=<span class="hljs-number">0</span>,  <span class="hljs-comment"># 数据加载器工作进程数，设为0避免多进程冲突  </span>
          
        <span class="hljs-comment"># 输出配置  </span>
        <span class="hljs-attr">output_dir</span>=<span class="hljs-string">"outputs"</span>,  <span class="hljs-comment"># 模型输出和检查点保存目录  </span>
          
        <span class="hljs-comment"># 随机种子  </span>
        <span class="hljs-attr">seed</span>=<span class="hljs-number">3407</span>,  <span class="hljs-comment"># 随机种子，确保结果可复现  </span>
  
    ),  
)  
  
<span class="hljs-comment"># 开始训练  </span>
<span class="hljs-attr">train_stats</span> = trainer.train()  
print(f"训练完成，训练损失: \n {train_stats}")
</code></pre>
<h4 data-id="heading-12">7.6 模型保存</h4>
<p>Unsloth 提供了多种保存微调后模型的方法，每种方法都有其特定的用途：</p>
<p><strong><code>save_pretrained</code></strong></p>
<p>此方法仅保存 LoRA 适配器权重。这些文件通常很小，只包含模型修改部分，包括 <code>adapter_config.json</code> 和 <code>adapter_model.safetensors</code> 。这种方法适用于需要灵活切换不同 LoRA 适配器或节省存储空间的情况。</p>
<p><strong><code>save_pretrained_gguf</code></strong></p>
<p>这是一种新的优化格式（GGUF），支持更好的元数据处理。文件同样较小且经过量化，包括 <code>model.gguf</code> 和 <code>tokenizer.json</code> 。Unsloth 的动态量化在 GGUF 导出中通过智能的层特定量化策略，进一步增强了模型性能和效率。</p>
<pre><code class="hljs language-bash" lang="bash">
<span class="hljs-comment"># 保存微调后的模型权重</span>
<span class="hljs-comment"># 只保存LoRA权重，原始模型权重保持不变</span>
model.save_pretrained(<span class="hljs-string">"ckpts/qwen2.5-1.5b-instruct-bnb-4bit-lora"</span>)
<span class="hljs-comment"># 保存分词器（tokenizer），以便后续加载和推理时使用</span>
tokenizer.save_pretrained(<span class="hljs-string">"ckpts/qwen2.5-1.5b-instruct-bnb-4bit-lora"</span>)
<span class="hljs-comment">#==================================================================================</span>

<span class="hljs-comment"># model.save_pretrained_gguf("ckpts/qwen2.5-1.5b-instruct-bnb-4bit-gguf", tokenizer, quantization_method="q4_k_m")</span>
</code></pre>
<h4 data-id="heading-13">7.7 训练过程</h4>
<p><strong>开始时显示基础信息：</strong></p>
<pre><code class="hljs language-yaml" lang="yaml">
<span class="hljs-string">==((====))==</span>  <span class="hljs-attr">Unsloth 2025.7.8: Fast Qwen3 patching. Transformers:</span> <span class="hljs-number">4.53</span><span class="hljs-number">.3</span><span class="hljs-string">.</span>
   <span class="hljs-string">\</span>   <span class="hljs-string">/|</span>    <span class="hljs-string">NVIDIA</span> <span class="hljs-string">GeForce</span> <span class="hljs-string">RTX</span> <span class="hljs-number">2050. </span><span class="hljs-string">Num</span> <span class="hljs-string">GPUs</span> <span class="hljs-string">=</span> <span class="hljs-attr">1. Max memory: 4.0 GB. Platform:</span> <span class="hljs-string">Windows.</span>
<span class="hljs-string">O^O/</span> <span class="hljs-string">_/</span> <span class="hljs-string">\</span>    <span class="hljs-attr">Torch:</span> <span class="hljs-number">2.7</span><span class="hljs-number">.1</span><span class="hljs-string">+cu126.</span> <span class="hljs-attr">CUDA: 8.6. CUDA Toolkit: 12.6. Triton:</span> <span class="hljs-number">3.3</span><span class="hljs-number">.1</span>
<span class="hljs-string">\</span>        <span class="hljs-string">/</span>    <span class="hljs-string">Bfloat16</span> <span class="hljs-string">=</span> <span class="hljs-string">TRUE.</span> <span class="hljs-string">FA</span> [<span class="hljs-string">Xformers</span> <span class="hljs-string">=</span> <span class="hljs-number">0.0</span><span class="hljs-number">.31</span><span class="hljs-string">.post1.</span> <span class="hljs-string">FA2</span> <span class="hljs-string">=</span> <span class="hljs-literal">False</span>]
 <span class="hljs-string">"-____-"</span>     <span class="hljs-attr">Free license:</span> <span class="hljs-string">http://github.com/unslothai/unsloth</span>
<span class="hljs-comment"># 批注：系统配置信息</span>
<span class="hljs-comment"># - 使用RTX 2050显卡，4GB显存</span>
<span class="hljs-comment"># - 支持bfloat16精度训练</span>
<span class="hljs-comment"># - 使用Xformers优化注意力机制</span>

</code></pre>
<p><strong>再给出微调的配置：</strong></p>
<pre><code class="hljs language-ini" lang="ini">==((====))==  Unsloth - 2x faster free finetuning | Num GPUs <span class="hljs-attr">used</span> = <span class="hljs-number">1</span>  
   \\   /|    Num <span class="hljs-attr">examples</span> = <span class="hljs-number">353</span> | Num Epochs = <span class="hljs-number">5</span> | Total steps = <span class="hljs-number">115</span>  
O^O/ \_/ \    Batch size per <span class="hljs-attr">device</span> = <span class="hljs-number">2</span> | Gradient accumulation steps = <span class="hljs-number">8</span>  
\        /    Data Parallel <span class="hljs-attr">GPUs</span> = <span class="hljs-number">1</span> | Total batch size (<span class="hljs-number">2</span> x <span class="hljs-number">8</span> x <span class="hljs-number">1</span>) = <span class="hljs-number">16</span>  
 "-____-"     Trainable <span class="hljs-attr">parameters</span> = <span class="hljs-number">20</span>,<span class="hljs-number">185</span>,<span class="hljs-number">088</span> of <span class="hljs-number">616</span>,<span class="hljs-number">235</span>,<span class="hljs-number">008</span> (<span class="hljs-number">3.28</span>% trained)  
<span class="hljs-comment"># 批注：训练配置详情  </span>
<span class="hljs-comment"># - 总样本数：353个  </span>
<span class="hljs-comment"># - 训练轮数：5轮  </span>
<span class="hljs-comment"># - 总步数：115步  </span>
<span class="hljs-comment"># - 有效批次大小：16（2×8×1）  </span>
<span class="hljs-comment"># - 可训练参数：3.28%（20M/616M）</span>
</code></pre>
<p><strong>后面是微调细节：</strong></p>
<pre><code class="hljs language-arduino" lang="arduino">{<span class="hljs-string">'loss'</span>: <span class="hljs-number">2.1017</span>, <span class="hljs-string">'grad_norm'</span>: <span class="hljs-number">3.180413007736206</span>, <span class="hljs-string">'learning_rate'</span>: <span class="hljs-number">1.995283421166614e-05</span>, <span class="hljs-string">'epoch'</span>: <span class="hljs-number">1.05</span>}  
{<span class="hljs-string">'loss'</span>: <span class="hljs-number">2.2702</span>, <span class="hljs-string">'grad_norm'</span>: <span class="hljs-number">2.8307971954345703</span>, <span class="hljs-string">'learning_rate'</span>: <span class="hljs-number">1.9869167087338908e-05</span>, <span class="hljs-string">'epoch'</span>: <span class="hljs-number">1.14</span>}  
{<span class="hljs-string">'loss'</span>: <span class="hljs-number">2.0511</span>, <span class="hljs-string">'grad_norm'</span>: <span class="hljs-number">3.1757583618164062</span>, <span class="hljs-string">'learning_rate'</span>: <span class="hljs-number">1.9744105246469264e-05</span>, <span class="hljs-string">'epoch'</span>: <span class="hljs-number">1.23</span>}  
{<span class="hljs-string">'loss'</span>: <span class="hljs-number">2.1853</span>, <span class="hljs-string">'grad_norm'</span>: <span class="hljs-number">2.5234906673431396</span>, <span class="hljs-string">'learning_rate'</span>: <span class="hljs-number">1.957817324187987e-05</span>, <span class="hljs-string">'epoch'</span>: <span class="hljs-number">1.32</span>}  
{<span class="hljs-string">'loss'</span>: <span class="hljs-number">1.8145</span>, <span class="hljs-string">'grad_norm'</span>: <span class="hljs-number">2.9424679279327393</span>, <span class="hljs-string">'learning_rate'</span>: <span class="hljs-number">1.937206705006344e-05</span>, <span class="hljs-string">'epoch'</span>: <span class="hljs-number">1.32</span>}
</code></pre>
<h2 data-id="heading-14">8.  测试微调的模型</h2>
<p>模型测试代码如下：</p>
<pre><code class="hljs language-ini" lang="ini">from unsloth import FastLanguageModel  
from unsloth.chat_templates import get_chat_template  
from transformers import TextStreamer  
import torch  
  
<span class="hljs-attr">max_seq_length</span> = <span class="hljs-number">512</span>  
  
  
model, <span class="hljs-attr">tokenizer</span> = FastLanguageModel.from_pretrained(  
    <span class="hljs-attr">model_name</span>=<span class="hljs-string">"ckpts/qwen2.5-1.5b-instruct-bnb-4bit-lora"</span>,  
    <span class="hljs-attr">max_seq_length</span>=max_seq_length,  
    <span class="hljs-attr">dtype</span>=None,  
    <span class="hljs-attr">load_in_4bit</span>=<span class="hljs-literal">True</span>,  
)  
  
<span class="hljs-comment"># 启用unsloth的2x更快推理优化  </span>
print("启用推理优化...")  
FastLanguageModel.for_inference(model)  
print("模型加载完成")  
  
  
<span class="hljs-comment"># 定义训练数据格式化字符串模板  </span>
<span class="hljs-attr">train_prompt_style</span> = <span class="hljs-string">"""你是一位精通中医理论的专家，特别擅长《伤寒论》的理论和实践应用。  
请根据《伤寒论》的经典理论，准确回答以下问题。  
  
### 问题:  
{}  
"""</span>  
<span class="hljs-attr">question</span> = <span class="hljs-string">'什么是太阳病？'</span>  
  
<span class="hljs-attr">formatted_prompt</span> = train_prompt_style.format(question)  
print(f"格式化后的提示文本:\n-------------------\n{formatted_prompt}\n-------------------")  
print(type(tokenizer))   <span class="hljs-comment"># &lt;class 'transformers.models.qwen2.tokenization_qwen2_fast.Qwen2TokenizerFast'&gt;  </span>
<span class="hljs-attr">inputs</span> = tokenizer([formatted_prompt], return_tensors=<span class="hljs-string">'pt'</span>, max_length=max_seq_length).to(<span class="hljs-string">"cuda"</span>)  
  
print(f"inputs: \n-------------------\n{inputs}\n-------------------")  
  
  
  
<span class="hljs-comment"># 生成回答（流式输出）  </span>
with torch.no_grad():  
    <span class="hljs-attr">outputs</span> = model.generate(  
        <span class="hljs-comment"># 输入序列的token ID  </span>
        inputs<span class="hljs-section">['input_ids']</span>,   
        <span class="hljs-comment"># 注意力掩码，指示哪些位置是有效输入  </span>
        <span class="hljs-attr">attention_mask</span>=inputs[<span class="hljs-string">'attention_mask'</span>],   
        <span class="hljs-comment"># 生成文本的最大长度限制  </span>
        <span class="hljs-attr">max_length</span>=max_seq_length,  
        <span class="hljs-comment"># 启用KV缓存，加速生成过程  </span>
        <span class="hljs-attr">use_cache</span>=<span class="hljs-literal">True</span>,  
        <span class="hljs-comment"># 温度参数，控制生成的随机性  </span>
        <span class="hljs-comment"># 值越低生成越确定，值越高生成越随机  </span>
        <span class="hljs-attr">temperature</span>=<span class="hljs-number">0.8</span>,   
        <span class="hljs-comment"># 核采样参数，只从累积概率达到90%的词中选择  </span>
        <span class="hljs-comment"># 避免选择概率极低的词，提高生成质量  </span>
        <span class="hljs-attr">top_p</span>=<span class="hljs-number">0.9</span>,  
        <span class="hljs-comment"># 启用采样模式，而不是贪婪解码  </span>
        <span class="hljs-comment"># 贪婪解码总是选择概率最高的词，容易产生重复  </span>
        <span class="hljs-attr">do_sample</span>=<span class="hljs-literal">True</span>,  
        <span class="hljs-comment"># 设置填充标记ID，用于处理变长序列  </span>
        <span class="hljs-attr">pad_token_id</span>=tokenizer.eos_token_id,  
        <span class="hljs-comment"># 设置结束标记ID，告诉模型何时停止生成  </span>
        <span class="hljs-attr">eos_token_id</span>=tokenizer.eos_token_id,  
        <span class="hljs-comment"># 重复惩罚参数，防止模型重复生成相同内容  </span>
        <span class="hljs-comment"># 1.1表示重复词的生成概率降低10%  </span>
        <span class="hljs-attr">repetition_penalty</span>=<span class="hljs-number">1.1</span>  
    )  
  
print(type(outputs))  
print(outputs)  
<span class="hljs-attr">answer</span> = tokenizer.decode(outputs[<span class="hljs-number">0</span>], skip_special_tokens=<span class="hljs-literal">True</span>)  
print("\n<span class="hljs-attr">" + "</span>=<span class="hljs-string">" * 80)  
print(answer)  
print("</span>\n<span class="hljs-string">" + "</span>=<span class="hljs-string">" * 80)  
print("</span>测试完成！<span class="hljs-string">")
</span></code></pre>
<h3 data-id="heading-15">学习资源推荐</h3>
<p>如果你想更深入地学习大模型，以下是一些非常有价值的学习资源，这些资源将帮助你从不同角度学习大模型，提升你的实践能力。</p>
<blockquote>
<p>本文较长，建议点赞收藏。更多AI大模型应用开发学习视频及资料，在<a href="https://link.juejin.cn?target=https%3A%2F%2Fhy.zhipoai.cn%2F" target="_blank" title="https://hy.zhipoai.cn/" ref="nofollow noopener noreferrer">智泊AI</a>。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[金仓KES：玩转“五位一体”融合架构，轻松驾驭数字时代]]></title>    <link>https://juejin.cn/post/7571005216910606355</link>    <guid>https://juejin.cn/post/7571005216910606355</guid>    <pubDate>2025-11-11T06:19:57.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571005216910606355" data-draft-id="7571304204720439350" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="金仓KES：玩转“五位一体”融合架构，轻松驾驭数字时代"/> <meta itemprop="keywords" content="数据库"/> <meta itemprop="datePublished" content="2025-11-11T06:19:57.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="倔强的石头_"/> <meta itemprop="url" content="https://juejin.cn/user/3168119757484368"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            金仓KES：玩转“五位一体”融合架构，轻松驾驭数字时代
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3168119757484368/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    倔强的石头_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T06:19:57.000Z" title="Tue Nov 11 2025 06:19:57 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b9f8cede0c064c39bf40babc52cc149e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763446797&amp;x-signature=AsVHGzWivpPEvVeUBx78INGrjOw%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-0">开篇：数据时代，你的数据库还好吗？</h2>
<p>当下的数字时代，数据如同生命线一般重要，是推动企业发展的关键力量，不过须要坦诚地说，要想让数据切实发挥作用，并非没有诸多棘手难题。</p>
<ul>
<li>系统繁多，数据隔离，公司存在许多应用系统，其底层数据库种类繁杂，Oracle，MySQL，PostgreSQL等等，这些数据库好似一个个孤岛，数据想要互相探访十分艰难。</li>
<li>场景一旦改变，工具就必要更换，如今要做报表，明天要搞分析，后天还要处理即时数据流，于是便买了许多关系型，文档型，时序型数据库，整个架构既迟缓又沉重，维持它简直让人想死。</li>
<li>国产化浪潮已然来临，对于老系统而言，将其迁移到本国平台之上，其风险颇高，历时亦长，真可谓“欲爱之却非易事”。</li>
</ul>
<p>应对这些问题时，不能再用以往那种“头痛医头，脚痛医脚”的老方法，于是，业界迫切须要一种新的思路，这时，国产数据库中的“大哥”人大金仓站出来，拿出了其几代人积累的核心技术——KingbaseES V9，这是一款实至名归的“融合型”数据库，它重点在于做到“五个一体化”，其目的十分清晰，即凭借单个平台去解决多源，多模，多态等各种复杂问题，从而让中国的数据得以真正运行在“中国芯”之上。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca49d50ad0324aa3b1d60cd9050ecca7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763446797&amp;x-signature=HnIvIDmWguWbu4Iy%2BqOBGtNojsQ%3D" alt="d1401727b440ebf819d7998a9d2d4362.png" loading="lazy"/></p>
<hr/>
<h2 data-id="heading-1">一、多语法一体化：代码不用改，迁移没烦恼</h2>
<p>搞过国产化替代的兄弟们都知道，最头疼的就是应用迁移，成本高得吓人，风险大得离谱。特别是那些跟Oracle“深度绑定”的核心系统，里面的存储过程、函数、包，改起来简直是噩梦。</p>
<p><strong>金仓KES的第一个杀手锏，就是“多语法一体化兼容”。</strong> 这可不是简单的“假装认识”，而是从数据库的根儿上，就同时支持SQL标准、Oracle、SQL Server、MySQL、PostgreSQL这些主流数据库的“方言”。</p>
<p><strong>这玩意儿有啥好？</strong></p>
<ul>
<li><strong>代码基本不用动</strong>：以前用Oracle的PL/SQL，或者SQL Server的T-SQL写的代码，KES直接就能看懂、能执行。这么一来，迁移工作量大大减少，风险自然也下来了。5</li>
<li><strong>开发习惯不用改</strong>：原来写Oracle的继续写，写MySQL的也别停。开发团队不用重新学一套新东西，原来的手艺一点没丢，效率杠杠的。</li>
</ul>
<p><strong>举个栗子：直接在KES里跑Oracle风格的PL/SQL</strong></p>
<p>比如说，你之前在Oracle里有这么一个管理员工信息的包（Package）：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- Oracle里的PL/SQL包</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE PACKAGE emp_admin <span class="hljs-keyword">AS</span>
   <span class="hljs-keyword">PROCEDURE</span> hire_employee (p_emp_id NUMBER, p_name VARCHAR2, p_job VARCHAR2);
   <span class="hljs-keyword">FUNCTION</span> get_salary (p_emp_id NUMBER) <span class="hljs-keyword">RETURN</span> NUMBER;
<span class="hljs-keyword">END</span> emp_admin;
<span class="hljs-operator">/</span>

<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">OR</span> REPLACE PACKAGE BODY emp_admin <span class="hljs-keyword">AS</span>
   <span class="hljs-keyword">PROCEDURE</span> hire_employee (p_emp_id NUMBER, p_name VARCHAR2, p_job VARCHAR2) <span class="hljs-keyword">IS</span>
   <span class="hljs-keyword">BEGIN</span>
      <span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> employees (employee_id, first_name, job_id, hire_date)
      <span class="hljs-keyword">VALUES</span> (p_emp_id, p_name, p_job, SYSDATE);
   <span class="hljs-keyword">END</span> hire_employee;

   <span class="hljs-keyword">FUNCTION</span> get_salary (p_emp_id NUMBER) <span class="hljs-keyword">RETURN</span> NUMBER <span class="hljs-keyword">IS</span>
      v_salary NUMBER :<span class="hljs-operator">=</span> <span class="hljs-number">0</span>;
   <span class="hljs-keyword">BEGIN</span>
      <span class="hljs-keyword">SELECT</span> salary <span class="hljs-keyword">INTO</span> v_salary <span class="hljs-keyword">FROM</span> employees <span class="hljs-keyword">WHERE</span> employee_id <span class="hljs-operator">=</span> p_emp_id;
      <span class="hljs-keyword">RETURN</span> v_salary;
   <span class="hljs-keyword">END</span> get_salary;
<span class="hljs-keyword">END</span> emp_admin;
<span class="hljs-operator">/</span>
</code></pre>
<p>换到金仓KES平台，这段代码你一个字都不用改，直接就能跑。对于那些攒了一堆PL/SQL代码的公司来说，这简直是救星啊！</p>
<hr/>
<h2 data-id="heading-2">二、多模数据一体化：别再建孤岛了，数据放一块儿才够劲</h2>
<p>现在都搞物联网、车联网了，数据早就不是只有行和列那么简单了。时序数据、地理位置（GIS）、JSON文档、图关系...各种新花样层出不穷。以前的办法是，来一种新数据，就买一套新数据库，结果公司里“数据孤岛”越来越多，想把不同类型的数据放一起分析比登天还难。</p>
<p><strong>金仓KES的“多模一体化”就是来解决这个问题的。</strong> 它在一个数据库里，就把关系、文档、图、KV、GIS、时序、向量这些乱七八糟的数据模型全都支持了。
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a3e981cd04aa48b49257176e2fad23ba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5YCU5by655qE55-z5aS0Xw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763446797&amp;x-signature=1lfh2rKlqRBgwviPESxpGfpVSQ0%3D" alt="image.png" loading="lazy"/></p>
<p><strong>这又解决了什么痛点？</strong></p>
<ul>
<li><strong>告别数据冗余和壁垒</strong>：所有数据都放在KES这一个篮子里，再也不用费劲地在不同系统之间倒腾数据了，技术架构一下子就清爽了。</li>
<li><strong>跨界分析，释放新价值</strong>：你可以用一条SQL，同时查关系表、地理位置和JSON文档，这种“混搭”玩法能让你发现以前根本看不到的商业机会。</li>
</ul>
<p><strong>再举个栗子：时序+GIS的融合查询</strong></p>
<p>想象一下，在智慧交通系统里，你想知道“最近1小时，在市中心那个商圈里，有哪些网约车出没过？” 这就需要同时处理时间和空间两种信息。</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 假设：</span>
<span class="hljs-comment">-- 1. taxi_tracks 是个时序表，存着车牌号(license_plate)、时间戳(ts)和经纬度(location)</span>
<span class="hljs-comment">-- 2. core_business_district 是个地理多边形(GEOMETRY)，画出了商圈的范围</span>

<span class="hljs-keyword">SELECT</span>
    license_plate,
    ts,
    ST_AsText(location) <span class="hljs-keyword">AS</span> current_position
<span class="hljs-keyword">FROM</span>
    taxi_tracks
<span class="hljs-keyword">WHERE</span>
    <span class="hljs-comment">-- 按时间筛选：就要最近1小时的</span>
    ts <span class="hljs-operator">&gt;</span> NOW() <span class="hljs-operator">-</span> <span class="hljs-type">INTERVAL</span> <span class="hljs-string">'1 hour'</span>
<span class="hljs-keyword">AND</span>
    <span class="hljs-comment">-- 按空间筛选：必须在商圈里头</span>
    ST_Contains(
        ST_GeomFromText(<span class="hljs-string">'POLYGON((...))'</span>, <span class="hljs-number">4326</span>), <span class="hljs-comment">-- 把商圈范围画出来</span>
        location
    );
</code></pre>
<p>你看，就这么一条SQL，既处理了时序（<code>ts &gt; NOW() - INTERVAL '1 hour'</code>），又处理了GIS（<code>ST_Contains</code>）。在一个数据库里就把这么复杂的时空分析搞定了，这在以前那种“多系统组合”的方案里，简直不敢想。</p>
<hr/>
<h2 data-id="heading-3">三、多应用场景一体化：一边交易一边分析，决策快人一步</h2>
<p>老规矩是，数据库得分两拨，一拨叫OLTP，专门处理在线交易，要求快、准、稳；另一拨叫OLAP，专门搞数据分析，要求能算、能聚合。这么一来，你想分析最新的交易数据？对不起，等明天吧！数据得先进数仓，决策永远慢半拍。</p>
<p><strong>金仓KES直接上了HTAP（混合事务/分析处理）架构，实现了“多应用场景一体化”。</strong> 简单说，就是通过内存计算、行列混存这些黑科技，让同一份数据，既能顶住高并发的交易请求，又能随时响应复杂的分析查询。5</p>
<p><strong>这能带来什么好处？</strong></p>
<ul>
<li><strong>实时决策，抢占先机</strong>：分析的就是最新的业务数据，不用等T+1。像实时风控、实时营销这种场景，终于能玩起来了。</li>
<li><strong>架构瘦身，省心省钱</strong>：一套KES，就顶替了以前“OLTP数据库 + ETL工具 + OLAP数仓”的豪华套餐，系统简单了，运维成本自然就下来了。</li>
<li><strong>性能超能打</strong>：KES的性能可不是吹的，跑OLTP的TPCC测试，峰值能干到220万tpmc，搞复杂分析也一点不含糊。5</li>
</ul>
<p><strong>场景模拟：HTAP混合查询</strong></p>
<p>在一个电商平台，老板突然想知道：“咱们的‘钻石会员’，平均一单买多少钱？最近半小时又贡献了多少销售额？”</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 一个简单的HTAP查询</span>
<span class="hljs-keyword">SELECT</span>
    c.customer_level,
    <span class="hljs-built_in">AVG</span>(o.order_amount) <span class="hljs-keyword">AS</span> avg_order_value,
    <span class="hljs-built_in">SUM</span>(<span class="hljs-keyword">CASE</span> <span class="hljs-keyword">WHEN</span> o.order_time <span class="hljs-operator">&gt;=</span> NOW() <span class="hljs-operator">-</span> <span class="hljs-type">INTERVAL</span> <span class="hljs-string">'30 minute'</span> <span class="hljs-keyword">THEN</span> o.order_amount <span class="hljs-keyword">ELSE</span> <span class="hljs-number">0</span> <span class="hljs-keyword">END</span>) <span class="hljs-keyword">AS</span> recent_30min_total
<span class="hljs-keyword">FROM</span>
    customers c <span class="hljs-comment">-- 这张表可能以行存为主，用户信息更新快</span>
<span class="hljs-keyword">JOIN</span>
    orders o <span class="hljs-keyword">ON</span> c.customer_id <span class="hljs-operator">=</span> o.customer_id <span class="hljs-comment">-- 这张表可能行列混存，既要实时下单，又要聚合分析</span>
<span class="hljs-keyword">WHERE</span>
    c.customer_level <span class="hljs-operator">=</span> <span class="hljs-string">'钻石会员'</span>
<span class="hljs-keyword">GROUP</span> <span class="hljs-keyword">BY</span>
    c.customer_level;
</code></pre>
<p>KES的聪明之处在于，它的查询优化器会自动判断：更新用户信息这种点查询，用行存效率高；算订单总额这种大批量分析，用列存速度快。就这么着，在一个数据库里，把两种活儿都漂亮地干完了。</p>
<hr/>
<h2 data-id="heading-4">四、集中、分布一体化：从小玩到大，架构随你变</h2>
<p>公司业务规模不一样，对数据库的要求也千差万别。小公司可能搞个主备就够了，业务发展快了就得上读写分离，要是做成了互联网巨头，那必须得上能无限扩展的分布式集群。</p>
<p><strong>金仓KES的“集中、分布一体化架构”就像玩乐高一样，特别灵活。</strong> 它在同一个产品里，把主备、读写分离、共享存储集群（类似Oracle RAC）、还有无共享的分布式集群（Sharding）全都给你准备好了。</p>
<p><strong>这又有什么讲究？</strong></p>
<ul>
<li><strong>丰俭由人，按需选择</strong>：你想要高可用、高扩展，还是一致性？根据你的业务需求，挑最合适的架构来用就行。</li>
<li><strong>无痛升级，平滑演进</strong>：业务从小到大，数据库架构也能跟着平滑升级，从主备到读写分离，再到分布式，都不用换数据库，一次投资，长期受益。</li>
<li><strong>金融级高可用，稳如泰山</strong>：什么同城双活、两地三中心，这些金融行业才敢想的容灾方案，KES都支持。数据零丢失（RPO=0），故障秒级恢复（RTO≤30秒），妥妥的。5</li>
</ul>
<p><strong>架构示意：两地三中心怎么玩？</strong></p>
<ul>
<li><strong>生产中心（同城双活）</strong>：在北京的两个机房里部署KES共享存储集群，对外就一个地址，一个机房挂了，业务自动切到另一个，用户根本感觉不到。</li>
<li><strong>灾备中心（异地容灾）</strong>：在上海再搞一套KES集群，北京的数据实时同步过来。万一北京两个机房都“团灭”了，手动或者自动把业务切到上海，保证服务不中断。</li>
</ul>
<hr/>
<h2 data-id="heading-5">五、开发、运维一体化：一个平台全搞定，省人又省心</h2>
<p>管理数据库这活儿，从开发、测试、上线，到监控、优化，是个贯穿始终的苦差事。以前，开发和DBA（数据库管理员）各用各的工具，沟通起来跟“鸡同鸭讲”似的，效率特别低。</p>
<p><strong>金仓KES直接提供了一套“开发、运维一体化”的工具链，把DevOps的流程给打通了。</strong></p>
<p><strong>这套工具有多香？</strong></p>
<ul>
<li><strong>KStudio (开发神器)</strong>：开发人员用它，从数据库设计、写SQL、调试，到性能分析、做迁移评估，一站式搞定。</li>
<li><strong>KOPS (运维法宝)</strong>：运维人员用它，部署集群、搞监控告警、做备份恢复、玩弹性伸缩，点点鼠标就完成了，还能智能巡检。</li>
<li><strong>降低人力成本</strong>：有了这套统一的工具，对专业的DBA依赖就没那么强了，开发人员自己也能干不少数据库的活儿，整个团队反应更快，效率更高。</li>
</ul>
<p><strong>看看这些贴心功能：</strong></p>
<ul>
<li><strong>KStudio的迁移评估</strong>：想从Oracle迁过来？先用它连上老库扫一遍，自动告诉你哪些代码要改，改动有多大，生成一份详细的报告，让你心里有底。</li>
<li><strong>KOPS的一键部署</strong>：想搭个主备集群，还是分布式集群？在图形界面上选好，点一下“部署”，KOPS就把所有复杂的配置都给你搞定了。</li>
</ul>
<hr/>
<h2 data-id="heading-6">总结：融合，才是国产数据库的王道</h2>
<p>金仓数据库KES的“五个一体化”，可不是简单地把五个功能堆在一起，它们之间是环环相扣、互相成就的。</p>
<ul>
<li><strong>多语法兼容</strong>，解决了“怎么来”的问题；</li>
<li><strong>多模融合</strong>，解决了“怎么存、怎么算”的问题；</li>
<li><strong>HTAP</strong>，解决了“怎么用得快、看得清”的问题；</li>
<li><strong>多架构支持</strong>，解决了“怎么长大、怎么站稳”的问题；</li>
<li><strong>一体化工具</strong>，则解决了“怎么管得好、成本低”的问题。</li>
</ul>
<p>这种“五位一体”的融合架构，乃是金仓数据库 KES 实实在在的核心竞争力所在，凭借此，KES 可以做到“用不变应万变”，用单个平台淡定应对企业数字化转型进程当中出现的各种数据问题，其既是一款不错的数据库产品，又是一次对未来数据库发展走向深入思索并完成考察的过程，为达成“让中国数据跑在中国引擎之上”这一宏伟愿景贡献出一份真真切切的成绩。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[李飞飞最新长文火爆硅谷]]></title>    <link>https://juejin.cn/post/7571068689765744680</link>    <guid>https://juejin.cn/post/7571068689765744680</guid>    <pubDate>2025-11-11T06:34:24.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571068689765744680" data-draft-id="7571021605318787124" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="李飞飞最新长文火爆硅谷"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-11-11T06:34:24.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="量子位"/> <meta itemprop="url" content="https://juejin.cn/user/2858385963484488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            李飞飞最新长文火爆硅谷
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2858385963484488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    量子位
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T06:34:24.000Z" title="Tue Nov 11 2025 06:34:24 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读26分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>空间智能，是 AI 的下一个前沿。</p>
<p>刚刚，AI 教母李飞飞发表长文，首次系统性地解释了什么空间智能、为什么重要以及如何构建能够解锁它的<strong>世界模型</strong>。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7b455d3f83984b5bb8dcb47dcb37851c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447664&amp;x-signature=TAzK6iQriFuGuq05oahSJ%2FhtQpw%3D" alt="" loading="lazy"/></p>
<p>文章里，李飞飞不仅提出了 “真正具有空间智能的世界模型” 必须具备的三个核心能力：</p>
<ul>
<li><strong>生成（Generative）：能创造遵守物理定律、空间一致的世界；</strong></li>
<li><strong>多模态（Multimodal）：能处理从图像、视频到动作的多模态输入；</strong></li>
<li><strong>交互（Interactive）：能预测世界随时间演变或互动的状态。</strong></li>
</ul>
<p>而且，还分享了 World Labs 在新一代<strong>任务函数</strong>、<strong>数据</strong>、<strong>模型架构与学习表示</strong>上面的进展，以及世界模型在创造力、机器人，甚至科学、医疗和教育等领域的潜力。</p>
<p>一经发出，点赞者众，疯传者广，都成热文热搜趋势了——</p>
<p>将空间智能融入世界模型（LWMs）有望推动大语言模型（LLMs）实现下一次质的飞跃。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5338b2f22bbd4dd4ac9e7a8bd813e321~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447664&amp;x-signature=LpQQH4qQj5KPfXrAYEVI068vfxQ%3D" alt="" loading="lazy"/></p>
<p>一旦因果推理能力和能效达到相应水平，我们就将站在通往通用人工智能的拐点上。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a58b3efcc8e14c5b92c7c9d8d0118790~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447664&amp;x-signature=sMCfren1yeseuhyflfHxSo2LAPE%3D" alt="" loading="lazy"/></p>
<p>好了，不多说了。接下来，我们一起看看李飞飞这篇从**文字到世界（from words to worlds）**的宣言吧。</p>
<p>以下是全文：</p>
<h2 data-id="heading-0">从文字到世界：空间智能是 AI 的下一个前沿</h2>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2d164dce04f347a49ad30670f8962aeb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447664&amp;x-signature=QRTWkhJHS%2FmcwnGBV5c%2FYRjv4o4%3D" alt="" loading="lazy"/></p>
<p>1950 年，当计算机还只是自动化算术和简单逻辑时，艾伦 · 图灵提出了一个至今仍回荡的问题：机器能思考吗？</p>
<p>他能看到别人尚未看到的未来，需要非凡的想象力——那就是：智能或许有一天可以被 “构建”，而非 “诞生”。</p>
<p>这一洞见催生了一场持续至今的科学征程——人工智能（AI）。在我投身 AI 研究的 25 年中，图灵的愿景依然不断启发着我。但我们距离那一愿景有多近？答案并不简单。</p>
<p>今天，以大语言模型（LLM）为代表的前沿 AI 技术，已经开始改变人类获取与处理抽象知识的方式。 然而，它们仍然是 “黑暗中的文字匠”：能言善辩，却无经验；知识丰富，却缺乏根基。</p>
<p><strong>空间智能（spatial intelligence）将改变我们创造和交互现实与虚拟世界的方式——彻底革新叙事、创造力、机器人学、科学发现，以及更多领域。这，正是 AI 的下一个前沿。</strong></p>
<p>自我进入这一领域以来，对视觉与空间智能的探索就一直是我的 “北极星”。这也是我为何花费多年时间构建了 ImageNet——首个大规模视觉学习与评测数据集。</p>
<p>它与神经网络算法、现代算力（如 GPU）一道，成为孕育现代 AI 的三大关键要素。也是为何我的斯坦福实验室在过去十年中，将计算机视觉与机器人学习相结合。</p>
<p>同样，这也是我与联合创始人 Justin Johnson、Christoph Lassner、Ben Mildenhall 一年前共同创建 World Labs 的原因：为了第一次真正实现这一可能性。</p>
<p>在这篇文章中，我将解释什么是空间智能、为什么它重要、以及我们如何构建能够解锁它的 “世界模型（world models）”——这种技术将深刻重塑创造力、具身智能与人类进步。</p>
<h2 data-id="heading-1">空间智能：人类认知的脚手架</h2>
<p>AI 从未像今天这样令人振奋。以生成式 AI 为代表的模型，如 LLM，已从研究室走向日常生活，成为数十亿人创作、生产与交流的工具。</p>
<p>它们展示了曾被认为不可能的能力：生成连贯的文本、成山的代码、逼真的图像，甚至短视频。 AI 是否会改变世界？——从任何合理的定义来看，它已经做到了。</p>
<p>然而，仍有大量潜能未被触及。自动化机器人的愿景依然诱人却遥远；在疾病治疗、新材料发现、粒子物理等领域的研究加速梦仍未实现；</p>
<p>真正能够理解并赋能人类创作者的 AI，无论是学习复杂分子化学概念的学生、构想空间的建筑师、构建世界的电影人，还是任何希望沉浸于虚拟体验中的人都仍未到来。</p>
<p>要理解为何这些能力依旧难以实现，我们需要回溯：空间智能是如何演化的？它又如何塑造了我们理解世界的方式？</p>
<p>视觉长期以来是人类智能的基石，但它的力量源自更为根本的东西。早在动物能筑巢、抚育后代、用语言交流或建立文明之前，那看似简单的 “感知行为”：感受到一缕光、触到一种质感就已经悄然点燃了通向智能的进化旅程。</p>
<p>这种从外部世界汲取信息的能力，在感知与生存之间搭建起一座桥梁，而这一桥梁在漫长的进化中变得愈发复杂。</p>
<p>神经元层层叠加，形成能解释世界、协调生物与环境互动的神经系统。因此，许多科学家认为，<strong>“感知—行动” 循环</strong>成为了智能进化的核心机制，也是自然孕育出我们这个物种的根基——一个能感知、学习、思考与行动的终极存在。</p>
<p>空间智能在我们与物理世界的互动中扮演着基础性的角色。每天，我们都在依赖它完成最平常的动作。</p>
<p>停车时想象车尾与路缘的距离；接住被抛来的钥匙；在人群中穿行而不碰撞；半睡半醒间准确地将咖啡倒进杯中。</p>
<p>在极端情况下，消防员穿行于坍塌建筑与浓烟之中，瞬间判断稳定性与生死抉择，通过肢体语言和本能默契沟通——这些都无可言传。而婴儿则在学会语言前的漫长时光里，通过玩耍与环境互动来认识世界。</p>
<p>这一切都在直觉中、自然而然地发生——一种机器至今未能获得的流畅能力。</p>
<p>空间智能同样是我们想象力与创造力的基石。讲故事的人在脑中构建出丰富的世界，并用各种视觉媒介将之传达给他人。</p>
<p>从原始洞穴壁画，到现代电影，再到沉浸式电子游戏。无论是孩子在沙滩上筑城堡，还是在电脑上玩《我的世界》，这种以空间为根基的想象构成了人与虚拟世界交互体验的基础。而在工业应用中，对物体、场景与动态交互环境的模拟则支撑着从工业设计、数字孪生到机器人训练等无数关键场景。</p>
<p>历史上那些塑造文明的关键时刻中，空间智能往往扮演着核心角色。</p>
<p>在古希腊，埃拉托色尼（Eratosthenes）通过对阴影的几何化思考完成了惊人的壮举——他在亚历山大测得太阳影子形成的 7 度角，并与赛恩（Syene）“正午无影” 的现象进行对比，从而计算出了地球的周长。</p>
<p>哈格里夫斯（Hargreaves）发明的 “珍妮纺纱机” 同样源于空间洞察：他意识到只需将多个纺锤并列安装在一个机架上，一个工人就能同时纺出多股线，生产效率因此提高了八倍。</p>
<p>沃森（Watson）与克里克（Crick）揭示 DNA 结构的突破，也依赖于他们亲手搭建的三维分子模型——他们用金属板与铁丝不断调整、拼接，直到碱基对的空间排布完美契合。</p>
<p>在这些案例中，空间智能都推动了文明的进步——当科学家与发明家需要操纵物体、想象结构、在物理空间中推理时，这些能力是纯文字永远无法承载的。</p>
<p><strong>空间智能（Spatial Intelligence）是支撑人类认知的脚手架。</strong></p>
<p>无论是被动观察，还是主动创造，它都在默默发挥作用。</p>
<p>它驱动我们的推理与规划，即便是在最抽象的主题上。它同样塑造了我们与世界互动的方式——无论是语言交流，还是身体行动，无论是与他人，还是与环境本身。</p>
<p>虽然我们大多数人并不会每天像埃拉托色尼那样发现新的真理，但我们几乎时时刻刻都以同样的方式在思考通过感官去理解这个复杂世界，并依托对物理与空间规律的直觉认知，使其变得可理解。</p>
<p>遗憾的是，当今的 AI 还无法以这样的方式思考。</p>
<p>过去几年确实取得了巨大进步。多模态大语言模型（MLLMs），在文本之外又引入了大量多媒体数据进行训练，初步具备了空间感知能力：</p>
<p>它们可以分析图像、回答与之相关的问题，甚至生成超写实的图像与短视频。与此同时，借助传感器与触觉技术的突破，最先进的机器人已经能在严格受限的环境中开始操控物体与工具。</p>
<p>然而，坦率地说，AI 的空间能力依然远未接近人类水平。其局限也显而易见：最先进的 MLLM 在估计距离、方向、大小等任务上，表现往往不比随机猜测好多少；它们无法 “心智旋转” 物体——即从新角度再现同一对象的形状；不会在迷宫中导航、识别捷径，或预测基本的物理规律；生成的视频虽然新奇炫目，却常在几秒钟后失去连贯性。</p>
<p>如今的顶级 AI 擅长阅读、写作、检索与模式识别，但当涉及对物理世界的表征或交互时，却存在根本性局限。</p>
<p>我们人类理解世界的方式是整体性的：不仅仅看到 “眼前的东西”，还理解它们在空间上的关系、在语义上的意义、以及在现实中的重要性。</p>
<p>而这种通过想象、推理、创造与交互来理解世界的能力，正是空间智能的力量。</p>
<p>缺乏它，AI 就与它所试图理解的物理现实脱节。它将无法真正安全地驾驶汽车、无法在家庭与医院中引导机器人、无法创造全新的沉浸式学习与娱乐体验、也无法加速材料科学与医学的发现。</p>
<p>哲学家维特根斯坦曾写道：“语言的边界就是我世界的边界”。我不是哲学家，但我知道，对 AI 而言，世界不止于语言。空间智能代表着超越语言的前沿。</p>
<p>它连接想象、感知与行动，为机器真正提升人类生活打开了新的可能：从医疗到创造力，从科学发现到日常辅助。</p>
<h2 data-id="heading-2">AI 的下一个十年：构建真正具备空间智能的机器</h2>
<p>那么，我们该如何打造拥有空间智能的 AI？</p>
<p>如何让模型具备：像埃拉托色尼那样的空间推理能力，像工业设计师那样的工程精度，像讲故事的人那样的创造性想象力，以及像应急救援人员那样与环境流畅互动的能力？</p>
<p>要实现这样的 AI，我们需要比 LLM 更具雄心的体系：世界模型（World Models）。</p>
<p>这是一种全新的生成式模型，其在理解、推理、生成与交互方面的能力，将超越当今 LLM 所能触及的极限。它能够在语义、物理、几何与动态层面上，理解并生成复杂的虚拟或真实世界。</p>
<p>这一领域尚处于萌芽阶段，现有方法从抽象推理模型到视频生成系统不等。</p>
<p>World Labs 成立于 2024 年初，正是基于这样一种信念：基础性方法仍在形成之中，而这将成为未来十年人工智能的决定性挑战。</p>
<p>在这个新兴领域中，最重要的是确立指导发展方向的核心原则。对于空间智能而言，我将 “世界模型” 定义为具备以下三项核心能力的系统：</p>
<p><strong>1、生成性（Generative）：世界模型能够生成具有感知、几何与物理一致性的世界</strong></p>
<p>要实现空间理解与推理，世界模型必须能够生成自身的模拟世界。</p>
<p>它应能在语义或感知指令的引导下，生成无限多样、变化丰富的虚拟世界，同时保持几何、物理与动态上的一致性，无论这些世界是现实的还是虚拟的。</p>
<p>研究界目前正在探索，这些世界应当以隐式（implicit）还是显式（explicit）的几何结构形式表示。</p>
<p>除了强大的潜在表征（latent representations）之外，我认为通用世界模型的输出还应当允许生成显式、可观测的世界状态，以便适应不同的应用场景。尤其重要的是，模型对当下世界的理解必须与其过去的状态保持连贯一致——理解当前，就是理解它是如何演化而来的。</p>
<p><strong>2、多模态（Multimodal）：世界模型在设计上就是多模态的</strong></p>
<p>正如人类与动物一样，世界模型应能处理多种形式的输入。在生成式 AI 领域中，这些输入被称为 “提示词（prompts）”。</p>
<p>面对不完整的信息——无论是图像、视频、深度图、文本指令、手势还是动作，世界模型都应能预测或生成尽可能完整的世界状态。</p>
<p>这要求模型既要以真实视觉的精度处理图像输入，又能以同样的灵活性理解语义性指令。</p>
<p>如此一来，无论是智能体还是人类，都能通过多样的输入形式与模型就 “世界” 进行交流， 并以多样的方式接收输出。</p>
<p><strong>3、交互性（Interactive）：世界模型能根据输入动作输出下一个状态</strong></p>
<p>最后，当动作（actions）和 / 或目标（goals）作为输入提示的一部分时，世界模型的输出必须包含世界的下一个状态。</p>
<p>这一状态可以是隐式的，也可以是显式的。当输入仅包含一个动作（有无目标皆可）时，世界模型应能生成与世界先前状态、预期目标状态（如有）、以及其语义意义、物理规律、动态行为相一致的输出。</p>
<p>随着空间智能世界模型在推理与生成能力上不断增强，我们可以想象，未来模型不仅能预测世界的下一个状态，还将能够基于该状态预测下一步行动。</p>
<p><strong>这一挑战的规模，超越了 AI 以往所面临的一切。</strong></p>
<p>语言是人类认知中纯粹生成的现象，而 “世界” 遵循的规则则复杂得多。</p>
<p>在地球上，例如：重力决定运动，原子结构决定光的颜色与亮度，无数物理定律约束着一切交互。</p>
<p>即使是最奇幻、最具创造性的世界，也由遵守物理与动态规律的空间对象与智能体构成。</p>
<p>要在模型中一致地协调这些——语义、几何、动力学与物理层面——需要全新的方法论。因为 “世界” 的维度远比语言这种一维的序列信号复杂得多。</p>
<p>要实现像人类一样具备普适空间智能的世界模型，必须跨越若干巨大的技术壁垒。</p>
<p>在 World Labs，我们的研究团队正致力于这一目标的基础性突破。</p>
<p>以下是我们当前研究的几个方向示例：</p>
<ul>
<li>
<p><strong>一种新的通用训练任务函数</strong>：在世界模型研究中，一个长期目标是定义一种像 LLM 中 “下一个 token 预测” 一样简洁优雅的通用任务函数。然而，世界模型输入与输出空间的复杂性使这一函数的设计更加困难。尽管仍有大量探索空间，但这一目标函数及其对应表征必须符合几何与物理规律，忠实体现世界模型在想象与现实之间的 “落地表征” 本质。</p>
</li>
<li>
<p><strong>大规模训练数据</strong>：训练世界模型所需的数据远比文本复杂。好消息是我们已经拥有了庞大的数据资源。互联网上规模宏大的图像与视频集合为训练提供了丰富的素材。挑战在于：如何让算法从二维图像或视频帧（RGB）中提取更深层次的空间信息。过去十年的研究揭示了语言模型中数据量与模型规模的 scaling law；对于世界模型，关键在于构建能够在相似规模上有效利用视觉数据的架构。此外，高质量的合成数据以及额外模态（如深度、触觉）的作用不可低估，它们在训练过程的关键阶段起到补充作用。未来的发展取决于更先进的传感系统、更稳健的信号提取算法、以及更强大的神经仿真方法。</p>
</li>
<li>
<p><strong>新的模型架构与表征学习</strong>：世界模型研究将不可避免地推动模型架构与学习算法的革新，特别是超越当下的多模态 LLM 与视频扩散模型（video diffusion）。这些模型通常将数据编码为一维或二维序列，使得简单的空间任务，例如在短视频中数清不同的椅子，或记住一小时前房间的样子变得异常困难。新的架构思路或许能改进这一点，例如具备 3D 或 4D 感知能力的 token 化、上下文与记忆机制。例如，在 World Labs，我们最近开发了一种基于帧的实时生成模型——RTFM（Real-Time Generative Frame-based Model）。它以空间为基础的帧（spatially-grounded frames）作为空间记忆形式，实现了高效实时生成的同时，保持了生成世界的持续性与一致性。</p>
</li>
</ul>
<p>显然，在完全释放空间智能的潜力之前，我们仍面临艰巨的挑战。但这项研究不仅仅是理论工作，它正成为新一代创造性与生产力工具的核心引擎。</p>
<p>在 World Labs 的进展令人鼓舞。我们最近向部分用户展示了 Marble 的早期版本——全球首个可通过多模态输入生成并保持一致性 3D 环境的世界模型，让用户与创作者能够探索、交互并在其中继续构建他们的创意世界。我们正全力以赴，努力尽快将其向公众开放。</p>
<p>Marble 只是我们的第一步。随着研究的加速，科研人员、工程师、用户与商业领袖们都开始意识到这一方向的巨大潜能。下一代世界模型将使机器在空间智能上达到全新的层次，这将开启 AI 迄今仍普遍缺乏的核心能力，并真正让人工智能进入理解与创造世界的时代。</p>
<h2 data-id="heading-3">用世界模型为人类构建更美好的世界</h2>
<p>人工智能的发展动机至关重要。作为推动现代 AI 时代到来的科学家之一，我的动机始终十分明确：AI 应当增强人类的能力，而非取而代之。</p>
<p>多年来，我一直致力于让 AI 的开发、部署与治理与人类需求保持一致。</p>
<p>当下关于 “技术乌托邦” 与“世界末日”的极端叙事比比皆是，但我依然持一种更务实的立场：AI 是由人开发、被人使用、并由人治理的。</p>
<p>它必须始终尊重人的自主性与尊严。它的 “魔力” 在于拓展我们的能力，让我们变得更具创造力、更紧密相连、更高效并更有成就感。</p>
<p>空间智能正体现了这一愿景——一种能赋能人类创造者、照护者、科学家与梦想家的 AI，使他们实现曾经不可能的目标。这一信念，正是我将空间智能视为 AI 下一个伟大前沿领域的根本原因。</p>
<p>空间智能的应用横跨不同的时间尺度。创作工具正在当下出现——World Labs 的 Marble 已经让创作者与讲故事的人能够亲手掌握这种能力。</p>
<p>机器人领域则代表着中期的雄心目标，我们正致力于完善感知与行动之间的闭环。而最具变革意义的科学应用可能需要更长时间，但它们将深刻地促进人类的福祉。</p>
<p>在所有时间线中，有几个领域的潜力尤其突出，足以重塑人类的能力。要实现这些潜力，需要集体努力远超任何一个团队或公司的能力范围。</p>
<p>它需要整个 AI 生态系统的参与：研究者、创新者、创业者、企业家，乃至政策制定者，共同朝着一个愿景努力。而这个愿景，值得我们追求。以下是未来的图景：</p>
<h4 data-id="heading-4">创造力：为叙事与沉浸体验注入超能力</h4>
<p>“创意，是智慧的乐趣。” 这是我最喜欢的爱因斯坦名言之一。</p>
<p>在人类发明文字之前，我们就会讲故事——把故事画在洞穴壁上，代代相传，并以共享的叙事建立文化。故事是人类理解世界、跨越时空连接彼此、探索 “人之为人” 的方式，也是我们在生活与爱中寻找意义的途径。</p>
<p>今天，空间智能有潜力彻底变革我们创作与体验叙事的方式，从娱乐到教育，从设计到建造，赋予它们更深远的影响力。</p>
<p>World Labs 的 Marble 平台 将前所未有的空间表达能力与编辑控制权交到电影人、游戏设计师、建筑师及各类讲述者手中，让他们无需传统 3D 设计软件的繁复流程，就能快速创造、迭代、探索完整的三维世界。创造的行为依然是人类的核心活动——AI 只是放大并加速创意实现的过程。这包括：</p>
<ul>
<li>
<p>多维叙事体验：电影人和游戏设计师可以利用 Marble 构建整个世界，不受预算或地理限制，探索传统制作流程中无法实现的场景与视角。随着媒介与娱乐的界限模糊化，我们正接近一种全新的互动体验形态——融合艺术、模拟与游戏的个性化世界，让任何人（而不仅仅是大型工作室）都能创造并进入自己的故事。</p>
</li>
<li>
<p>以设计讲述空间故事：几乎所有被制造的物品或建造的空间，都必须在物理实现之前经过虚拟 3D 设计——这一过程往往耗费大量时间与成本。借助空间智能模型，建筑师可以在数分钟内可视化并漫游尚不存在的建筑；工业或时装设计师可以即时将想象转化为形态，探索物体与人体及空间的交互。</p>
</li>
<li>
<p>全新的沉浸与互动体验：人类体验的最深层方式之一，就是创造意义的体验本身。在整个人类历史上，我们只共享一个三维世界：物理世界。直到近几十年，通过游戏与早期虚拟现实（VR），我们才得以初步窥见 “自造世界” 的可能。如今，空间智能结合 VR、XR（扩展现实）头显与沉浸式显示设备，将这种体验提升到前所未有的高度。未来，人们 “走进” 多维世界将如同打开一本书般自然。空间智能让造世界的权力从专业团队扩展到每一位拥有愿景的创作者、教育者与普通人。</p>
</li>
</ul>
<h4 data-id="heading-5">机器人：具身智能的实践</h4>
<p>从昆虫到人类，动物都依赖空间智能来理解、导航并与世界交互。机器人也不会例外。</p>
<p>自该领域诞生以来，“具备空间感知的机器” 就是人类的梦想，包括我在斯坦福研究实验室与学生、合作者共同进行的研究。正因如此，我对用 World Labs 构建的模型实现这一愿景感到异常兴奋。</p>
<ul>
<li><strong>通过世界模型扩展机器人学习：机器人的学习进步取决于可扩展的训练数据方案。要让机器人具备理解、推理、规划与交互的能力，它们需要覆盖极为庞大的状态空间。许多研究者认为，互联网数据、合成仿真数据与人类演示的真实采集三者结合，是实现可泛化机器人的关键。然而，与语言模型不同，如今机器人的训练数据极为稀缺。世界模型将在此发挥决定性作用。 随着其感知精度与计算效率的提高，世界模型生成的输出将迅速缩小模拟与现实之间的差距，从而让机器人能在数不清的状态、互动与环境中学习。</strong></li>
<li><strong>人机协作伙伴：无论是实验室中协助科学家的研究助理机器人，还是陪伴独居老人的家用助理，机器人都可以扩展劳动力并提升社会生产力。但要做到这一点，机器人必须具备空间智能——能感知、推理、规划、行动，并且最重要的是：保持对人类目标与行为的同理一致。例如，实验室机器人可以替代科学家完成仪器操作，让人专注于需要推理的部分；家庭助理机器人则可以帮助老人做饭，而不剥夺他们的乐趣与自主性。真正具备空间智能的世界模型能够预测下一个状态，甚至推断与之匹配的下一步行动，是实现这一愿景的关键。</strong></li>
<li><strong>扩展的具身形态：人形机器人只是我们为自身世界打造的一个形式。真正的创新红利将来自更加多样的设计：输送药物的纳米机器人、穿行狭窄空间的软体机器人、以及为深海或外太空而造的机器。无论形态如何，未来的空间智能模型都必须将环境与机器人自身的感知、运动一体化建模。但开发这些机器人面临的关键挑战在于：缺乏多样化形态的训练数据。世界模型将在这一过程中发挥关键作用——为仿真数据、训练环境与评测任务提供支持。</strong></li>
</ul>
<h2 data-id="heading-6">更长远的地平线：科学、医疗与教育</h2>
<p>除了创造性与机器人应用外，“空间智能” 的深远影响还将延伸至更多能够增强人类能力、拯救生命、加速发现的领域。以下我将重点介绍三个具有深刻变</p>
<p>革潜力的方向。当然，空间智能的应用远不止于此，它的影响范围几乎遍及所有行业。</p>
<p>在<strong>科学研究</strong>中，具备空间智能的系统可以模拟实验、并行验证假设，并探索人类无法亲临的环境——从深海到遥远的行星。这项技术有望彻底变革气候科学、材料研究等领域的计算建模方式。通过将多维度模拟与真实世界数据采集相结合，这些工具能显著降低计算壁垒，拓展每一个实验室可观察与理解的边界。</p>
<p>在<strong>医疗领域</strong>，空间智能将重塑从实验室到病床的全过程。在斯坦福，我与学生及合作者多年来一直与医院、养老机构以及居家患者合作。这些经验让我深信空间智能在医疗领域的变革潜力。AI 可以通过多维建模加速药物研发，通过辅助放射科医生识别影像中的模式来提升诊断质量；它还可支持环境感知式监护系统，在不取代人类关怀的前提下，为患者与护理人员提供持续支持。更不用说机器人在不同场景中帮助医护人员和患者的巨大潜力。</p>
<p>在<strong>教育领域</strong>，空间智能能够实现沉浸式学习，让抽象或复杂的概念变得可感知，并创造出符合人类大脑与身体学习方式的迭代体验。在 AI 时代，更快速、更高效的学习与技能重塑对于儿童与成人都至关重要。学生可以以多维方式探索细胞机器或 “亲历” 历史事件；教师可借助互动环境进行个性化教学；而外科医生、工程师等专业人士则能在高度逼真的仿真环境中安全地练习复杂技能。</p>
<p>跨越这些领域，可能性是无限的，但目标始终如一：让 AI 成为增强人类专长、加速人类发现、放大人类关怀的力量——而不是取代那份属于人的判断力、创造力与共情力。</p>
<h2 data-id="heading-7">结语</h2>
<p>过去十年间，人工智能已成为全球现象，在科技、经济乃至地缘政治层面都带来了转折。</p>
<p>然而，作为一名研究者、教育者和创业者，最令我振奋的仍是图灵七十五年前那道问题背后的精神。我依然与他共享那份好奇与惊叹——正是这份好奇，让我每天都为探索空间智能的挑战而充满动力。</p>
<p>人类历史上第一次，我们正站在这样一个时刻：有望构建出与物理世界高度契合的机器，让它们成为我们应对重大挑战的真正伙伴。</p>
<p>无论是加速疾病研究、革新故事叙述方式，还是在病痛、受伤或衰老的脆弱时刻给予支持，我们都正处于一场技术变革的门槛上，它将提升我们最珍视的生命价值。</p>
<p>这是一个关于更深刻、更丰富、更有力量的生活的愿景。</p>
<p>距自然在原始动物中首次显现空间智能的曙光已近五亿年，而我们有幸成为这一代技术创造者——可能即将赋予机器同样能力的人类，也有幸能将此能力用于全人类的福祉。</p>
<p>若没有空间智能，我们关于 “真正智能机器” 的梦想将永远不完整。</p>
<p>这场探索，是我的 “北极星”。邀请你一同追寻它。</p>
<p><em>原文链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdrfeifei.substack.com%2Fp%2Ffrom-words-to-worlds-spatial-intelligence" target="_blank" title="https://drfeifei.substack.com/p/from-words-to-worlds-spatial-intelligence" ref="nofollow noopener noreferrer">drfeifei.substack.com/p/from-word…</a></em></p>
<p><strong>欢迎在评论区留下你的想法！</strong></p>
<p>— <strong>完</strong> —</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从“给答案”到“教动脑”：这届小学生被AI教会主动思考]]></title>    <link>https://juejin.cn/post/7571068689765793832</link>    <guid>https://juejin.cn/post/7571068689765793832</guid>    <pubDate>2025-11-11T06:35:22.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571068689765793832" data-draft-id="7571156741396660239" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从“给答案”到“教动脑”：这届小学生被AI教会主动思考"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2025-11-11T06:35:22.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="量子位"/> <meta itemprop="url" content="https://juejin.cn/user/2858385963484488"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从“给答案”到“教动脑”：这届小学生被AI教会主动思考
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2858385963484488/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    量子位
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T06:35:22.000Z" title="Tue Nov 11 2025 06:35:22 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>“妈，这题怎么做？”</p>
<p>这个在有娃家庭中再熟悉不过的声音，如今正迎来 AI 给出的全新答案。</p>
<p>眼下，各种学习 App、智能学习硬件层出不穷——</p>
<p>ChatGPT 上线了学习模式；谷歌推出了 “Learn Your Way” 教育工具；美国得州有私立学校还要求学生每天花两小时和 AI 助手一起学习……</p>
<p>AI + 教育的浪潮，确实已经汹涌而来。</p>
<p>然而，火热浪潮之下，问题也在显现：</p>
<p>当前大多数 AI 教育产品仍停留在授人以鱼的层面。它们的本质是效率工具 ，追求 “<strong>快</strong>”——快速响应、快速批改、快速给出标准答案，但没有解决 “会” 和“懂”的核心痛点。</p>
<p>学生遇到难题，AI 直接给出答案，看似解决了问题，实则掩盖了思维过程的缺失。久而久之，学生容易陷入一听就会、一做就废和盲目刷题的循环。</p>
<p>那么，授人以渔的 AI 教育应该是什么样子？</p>
<h2 data-id="heading-0">超拟人交互 AI 老师</h2>
<p>行业的演进，比我们感知到的可能更快。</p>
<p>最近教育圈就出现了这么一款大火的 AI 产品，它已经从被动应答的 “工具”，进化成了能主动引导、完成教学闭环的 “师者”。</p>
<p>它就是学而思学习机 T4 所搭载的 “小思 AI1 对 1”。</p>
<p>基于多模态感知能力，它能够同时看懂纸上笔迹、听懂学生表达，并能以自然语言进行实时讲解与引导，形成更接近真人教学的互动体验。</p>
<p>话不多说，一起来看看这位 AI 老师究竟有何本领。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a84ca95a827495598134e3a92a37e1d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447722&amp;x-signature=jlenWEJkZZP420BVCK%2BJCRXN0ZA%3D" alt="" loading="lazy"/></p>
<p>只需轻轻拍拍 “头”，即可唤醒。</p>
<p>当孩子遇到错题或是不会的问题，把试卷放在它面前，说一句 “第 XX 题我不会做”，或直接指着题目说 “这题我不会”，小思就能立即听懂 / 看见，精准识别题目并开始讲解。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ce7077f5a634f28aa0c84efe8923a26~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447722&amp;x-signature=xLDhscIOcwzvDuA9JZN7PdV4VJU%3D" alt="" loading="lazy"/></p>
<p>划重点，讲解过程不再是直接给出解析或是答案，而是真的会像 1 对 1 真人辅导老师一样，一步步引导孩子动脑思考，带孩子自主完成解题。</p>
<p><a title="" ref="nofollow noopener noreferrer" href="https://link.juejin.cn?target=">视频详情</a></p>
<p>可以看到，小思在讲解时用到了一种新型方式——纸屏互动。</p>
<p>它会先让孩子拿出草稿纸，然后引导他们将每个解题步骤亲手写在纸上。</p>
<p>每写一步，小思都会实时识别并批改；若有错误，会立刻指出问题所在，耐心讲解原因与正确思路。</p>
<p>在讲解过程中，小思能做到一题多解，会根据孩子所处的学段，选用相应的解题方法。它还会在题目上圈划关键信息，引起孩子注意，这与学校课堂中老师强调的 “细读题目、圈出重点” 如出一辙。</p>
<p>即便孩子书写不够工整，或在纸上 “东一句、西一句”，又或是草稿纸上原本已有字迹，小思依然能够精准分辨出刚写下的步骤，理解上下文逻辑。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e2996b0d1b584d3ba5931ce74565a990~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447722&amp;x-signature=i7xklT6XbFq%2FscdRuH7UTitVe28%3D" alt="" loading="lazy"/></p>
<p>当整道题讲解完成后，小思还会对题目进行整体回顾与重点总结，帮助孩子真正理解这一类题型的解题思路与方法，从而实现真正意义上的智能化辅导闭环。</p>
<p>这种方式彻底改变了学生与学习机的互动方式，从单向的看和听，转变为动手写、实时改、双向互动的沉浸式学习。它不再是把答案塞给学生，而是把思考的过程还给了学生。</p>
<p>而这位 AI 老师的能力还远不止于此。</p>
<p>上个月，特斯拉前 AI 总监、OpenAI 创始成员、现在正在全职搞教育的 AI 大神 Andrej Karpathy 在一次专访中提到，他们 “想做的是一种真正的导师体验”。</p>
<p>他以自己学习韩语的过程为例：最开始是自学；后来报了一个十几人的小班；最后换成了 1 对 1 的导师辅导。他发现，好的导师能迅速判断他的知识水平，提出恰到好处的问题。</p>
<p>Karpathy 认为，当下即便是非常优秀的 LLM 也做不到这一点，而好的导师却可以。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4f5b118285464e8f907a84f17e885551~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447722&amp;x-signature=qIAy%2F7LXKaFTe2kMODSUCAuIIBU%3D" alt="" loading="lazy"/></p>
<p>就这点来看，只能说，现在咱国内的 AI 学习机已经能做到了。</p>
<p>小思在 1 对 1 辅导时，会采用个性化教学方案。</p>
<p>如果孩子在解题中持续出错，小思会灵活地转换思路、变换提问角度，从不同侧面试图撬动孩子的思维。多次引导仍未奏效，它会判断学生认知负荷已达到临界点，主动调整教学节奏，确保核心概念能得以传递，教学流程能够顺利走完。</p>
<p>它还能在孩子学习过程中时刻关注其行为并给予反馈，比如提醒孩子坐姿要端正、专心听讲、认真做题；通过情绪感知技术，能够捕捉孩子的情绪变化，在恰当的时候送上鼓励或祝贺。</p>
<p>小思还会将孩子的情绪总结生成家长报告，推送到家长的手机上，让家长可以关注到孩子的兴趣、情绪、成长变化。</p>
<p>另外，当孩子和小思一起学习时，它会自动构建专属每个孩子的动态学情图谱，并基于行为模型生成个性化学习规划，让教学从 “千人一面” 走向“千人千面”。</p>
<p>孩子在学校完成的习题或试卷，也能通过拍照上传，让小思持续跟踪学情，进行动态诊断与精准反馈。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2f51d6dba2a54962bec966520876ae56~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447722&amp;x-signature=B2DaRArw3lxQnSN4Ak%2BfQH8dJOg%3D" alt="" loading="lazy"/></p>
<p>以备考为例，这段时间学生往往需要做大量试卷刷题。而当你将试卷交给 “小思”，它就能根据学习数据，自动筛选出学生的薄弱环节，优先呈现易错题型与未掌握题型。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ec3b46be47f2469ba8d16d279fc1305c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447722&amp;x-signature=OPbxgqQLAbfk94UlZFU6%2BsxtHNU%3D" alt="" loading="lazy"/></p>
<p>总结来说，学生课后学习的三个关键环节——练习后用 AI 批改、错题用 AI 讲解、AI 根据学习画像进行推荐——在学而思学习机 T4 的 “小思 AI1 对 1” 中，已经形成了一个完整的环环相扣的学习体系。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ca09618768ba4f329cb182a3e17d44b8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447722&amp;x-signature=hBhkIJkXuFCnhyCEiukkMEx86mY%3D" alt="" loading="lazy"/></p>
<p>据学而思相关产品负责人介绍：</p>
<p>小思 AI1 对 1 不仅是行业领先推出的软硬一体超拟人交互 AI 老师，也是学习机行业领先多模态交互智能体。搭载了 “小思 AI1 对 1” 学而思学习机 T4，更是行业内少有的能做到纸屏互动、分步骤批改加讲解的学习机。</p>
<p>而学而思能够率先做到这些，并非偶然。</p>
<h2 data-id="heading-1">软硬一体原生派，自研主导</h2>
<p>这背后，是一条由软硬一体与自研主导共同构筑的、难以被快速复制的 AI 原生派护城河。</p>
<p>当前，在 AI + 教育方向上，业内大致形成了三种主要技术路径：</p>
<ul>
<li>
<p>以大模型为核心的开放平台服务，聚焦模型能力本身，不直接落地面向 C 端的教育产品；</p>
</li>
<li>
<p>将 AI 能力嵌入教学 App，用于题库、批改、口语陪练等功能模块；</p>
</li>
<li>
<p>软硬一体化，通过自研模型与专属硬件深度融合，构建原生 AI 老师。</p>
</li>
</ul>
<p>学而思在第三条路径上布局较早，团队认为：</p>
<blockquote>
<p>尽管强大的云端大模型是 AI 老师的 “智慧核心”，但要实现真正媲美甚至超越真人教学的原生 AI 老师体验——即<strong>具备低延迟、多模态、沉浸式交互和深度个性化能力的教学形态</strong>——软硬一体化的实现路径是必然选择。</p>
</blockquote>
<p>基于这一判断，学而思最新自研的 T 系列学习机成为 AI 老师的物理载体。前置的高清摄像头能看清学生在纸上的每一处演算笔迹；内置的传感器与算法则构成了其视觉神经系统，使之能实现低延迟的纸屏同步与多模态交互。</p>
<p>另外，AI 老师的能力边界，包含两个维度，一方面在于解题准确性，另一方面在于讲题能力。前者是客观过程，讲求逻辑与答案的正确；后者则是主观过程，体现教学设计与启发式讲解的水平。</p>
<p>首先，在解题环节，学而思依托自研的 “九章大模型”（MathGPT），承担全学科解题、应用题批改、作文批改、AI 分步讲解等任务。</p>
<p>该模型在中国信通院组织的首轮教育大模型评估中，通过了教育大模型 5 级与教育智能体 4 + 级双项最高级别认证，能力获国家级权威背书。</p>
<p>在此基础上，学而思 AI 老师采用 “双模型” 架构，引入业内领先通用大模型 DeepSeek 以增强开放对话与逻辑推理能力。</p>
<p>当下这类 “垂直模型 + 通用模型” 协同方案也正在成为教育 AI 的新趋势——垂直模型保障专业精度，通用模型扩展交互与逻辑推理能力。</p>
<p>其次，在讲题环节，AI 的表现取决于其是否具备教学思维。</p>
<p>据悉，学而思将二十余年教研团队积累的授课经验、解题策略与课堂互动逻辑数据，系统性地 “注入” 到大模型中，使 AI 逐步掌握教学思维与启发逻辑，具备 “如何教” 的能力，而不仅仅是“如何答”。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/07392e0b0a674e8ebbd8bcd26e221e18~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447722&amp;x-signature=w%2BzN46H7l99iu65bbrIIHNpPan0%3D" alt="" loading="lazy"/></p>
<p>最后，教育场景对 AI 系统的安全性要求尤为严格。</p>
<p>学而思贯穿全链路的自研体系，正为安全与可靠性提供了保障。</p>
<p>学而思团队介绍道，在内容安全层面，学而思 AI 老师出的题目的都有真人审核，在特定关键环节甚至设有 “三轮审核” 机制，并由集团级安全中台提供最终保障。在数据与隐私安全上，学习机内部建立了数据防控与权限管理机制。</p>
<p>自研技术栈还能精准约束 AI 行为，比如题目讲解时以标准答案和解析规范模型，自研意图理解模块搭配可插拔调度的大模型保障专业准确。从在线实时拦截到离线全量复审，安全机制覆盖全流程，保障端到端安全。</p>
<p>综合来看，业内 AI 教学系统的演进，正在经历从 “答题工具” 到“AI 学伴”再到 “AI 老师” 的过程。</p>
<h2 data-id="heading-2">通往 “完全体” 之路</h2>
<p>当 AI 技术浪潮席卷各行各业，教育领域也正迎来一场深层变革。这场变革早已跳出单一教学产品的功能修补，而是向着重构教学模式、拓展学习边界的方向突围。</p>
<p>整个行业都在探索，AI 深度融入教育场景，究竟会带来哪些颠覆性改变？而能真正适配教育本质的 AI 老师，又将是什么样的形态？</p>
<p>在今年的云栖大会上，学而思 CTO 田密对标自动驾驶 L1-L5 分级，提出了 AI 老师的 L1-L5。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cc232a25a7642c6bb05150f0058d62f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447722&amp;x-signature=Jqj19K1xnwBbkNb%2BqtyTJDxtJDY%3D" alt="" loading="lazy"/></p>
<p>其核心衡量标准颇为直接：AI 能在多大程度上替代传统书桌旁的课外辅导角色。</p>
<p>L5 即实现完全取代真人辅导的 “AI 托管”。</p>
<p>这不仅是学而思的技术路线图，某种程度上也体现出整个 AI 教育赛道可能的技术终局。</p>
<p>按照这一标准衡量，学而思学习机中的 AI 老师能力目前已经一只脚迈入了 L3 阶段。</p>
<p>具体表现为，在题目讲解这一核心场景中，系统已经实现了多模态交互 + 个性化引导，同时将引导 + 实时批改与自适应讲解等能力串联，形成相对完整的系统化学习链条。</p>
<p>实际上，小思全学习机可以自由调度的 AI 能力，有七十多种。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68b5756017c34d48b44b7aec310cc36a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6YeP5a2Q5L2N:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447722&amp;x-signature=ormAyaJB7xkjWmlyDkOOMfIGIxo%3D" alt="" loading="lazy"/></p>
<p>业内有观点认为，现阶段 AI 老师要想做得更好，得在三个方面持续推进：</p>
<ul>
<li>
<p>教学能力：持续优化 AI 老师本身的批改、讲题、诊断规划等能力。</p>
</li>
<li>
<p>认知理解能力：通过汇聚更多学习数据，构建更清晰的数字化学习系统，实现对孩子的深度认知。</p>
</li>
<li>
<p>交互能力：持续推进多模态迭代，实现更自然的拟人交互。</p>
</li>
</ul>
<p>长期来看，学习机有望突破现有形态，向具备教育感知与情感交互的陪伴式机器人演进。</p>
<p>学生是有血有肉的人，教育的目的是为了激发和引导他们的自我发展之路。学而思的实践提供了一种人机协同的引导式教学新思路。当 AI 承担起知识传授中标准化的工作，便为真人教师留出了更多进行情感关怀、创造力激发和人格塑造的空间。</p>
<p>尽管当下的技术发展与完全体 AI 老师仍有距离，但行业沿着多模态个性化的技术链条持续突破，或许正在接近古希腊哲学家苏格拉底曾提出的理想——</p>
<p>“教育不是灌输，而是点燃火焰”。</p>
<p><strong>欢迎在评论区留下你的想法！</strong></p>
<p>— <strong>完</strong> —</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[李飞飞万字长文爆了！定义 AI 下一个十年]]></title>    <link>https://juejin.cn/post/7571067260053405722</link>    <guid>https://juejin.cn/post/7571067260053405722</guid>    <pubDate>2025-11-11T06:56:42.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571067260053405722" data-draft-id="7571051830710386738" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="李飞飞万字长文爆了！定义 AI 下一个十年"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-11-11T06:56:42.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新智元"/> <meta itemprop="url" content="https://juejin.cn/user/952600743642312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            李飞飞万字长文爆了！定义 AI 下一个十年
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/952600743642312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新智元
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T06:56:42.000Z" title="Tue Nov 11 2025 06:56:42 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读30分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/787b168bbf994bc9bc8fe95ba127b7ce~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=LHmxaCcpFDj0fWjStEVuvjybgLI%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-0"><strong>「【新智元导读】AI 的下一个十年，是构建空间智能的机器。李飞飞最新硬核长文，揭秘了空间智能「世界模型」核心框架和三大核心支柱。」</strong></h5>
<p>AI 的下一个前沿，是「空间智能」。</p>
<p>它是一项能让「看见」升华为「推理」，让「感知」蜕变为「行动」，让「想象」落地为「创造」的技术。</p>
<p>但「空间智能」究竟是什么？为何如此重要？该如何构建它？又该如何应用它？</p>
<p>今天，李飞飞撰万字长文分享了自己关于构建和使用「世界模型」以解锁空间智能的思考。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/53787ed7f2c94c409b54871abd824965~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=zuN%2FpXnjjiFvF0Pog1tZ%2B884fiQ%3D" alt="" loading="lazy"/></p>
<p>新文章中，她为真正具备空间智能的「世界模型」所需达成的目标勾勒了一个框架。</p>
<p>具体来说，构建这样的 AI 必须具备三大核心能力：</p>
<p>让 AI 拥有故事讲述家的想象力去创造，</p>
<p>拥有急救人员般的敏捷性去导航，</p>
<p>并拥有科学家的严谨去推理空间。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dfdd903077454cbab446d9a771c2d62b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=aHmj3fuin0OSEOyuUgKFfihu%2F2Y%3D" alt="" loading="lazy"/></p>
<p>李飞飞与 LeCun 共识的一点是，「世界模型」是解锁空间智能的核心。</p>
<p>它必须能生成遵循物理定律、在空间上保持一致的世界，能处理从图像到动作的多模态输入，并能预测这些世界将如何演变或与之互动。</p>
<p>空间智能的应用疆域，正沿着一条清晰路径演进。</p>
<p>当下，它正赋能创意，World Labs Marble 项目已经将这些能力交到了创作者和故事讲述者的手中。</p>
<p>下一步，它将驾驭物理世界，机器人实现感知与行动之间的闭环。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b5cd939fb414854adfc32d32706931f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=bpqVqiafRO8r54Ffar7Dwljqx%2BE%3D" alt="" loading="lazy"/></p>
<p>而最具变革性的科学应用，虽然需要更长时间，但有望对人类福祉产生深远影响。</p>
<p>哲学家维特根斯坦曾写道：「我语言的极限，意味着我世界的极限。」</p>
<p>李飞飞表示，「我不是哲学家，但我深知，至少对 AI 而言，世界远不止于文字」。</p>
<p>空间智能代表了超越语言的前沿——它是一种将想象、感知与行动融会贯通的能力，为机器真正提升人类生活开启了无限可能，从医疗健康到创意挥洒，从科学探索到日常辅助。</p>
<p>众多网友点评，这是李飞飞一篇非常重要的文章，空间智能必读之作！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4d952b60fda34290b81704174f33e976~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=nS3L0QbBABB8uY1FGq1nY%2Fqzb%2BI%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/829f115810a1456c8e752addcd2c96c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=3KM4OTQNtkEN%2FLwH83eRxukPOUY%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4c1a336c69724f4b8627c100a5716194~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=PlvEaZXiGe3rmmV1H%2B2XifLmiwg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4023768723f745d8b60d23042ff8dc29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=HsjDipxBuWha6WwBORrm9mYbJac%3D" alt="" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b74535841647441fba71e4d60e0b065d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=cbQYNrQWCFiern%2BSigVpJpBhdr8%3D" alt="" loading="lazy"/></p>
<p>上下滑动查看</p>
<p>以下是全文翻译，一起来拜读下。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/44a149c8e6ed44cbb4952a69c4cb9ab6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=f6Kg8Uu3IJ%2B2PUEyt6IGww%2B4xNc%3D" alt="" loading="lazy"/></p>
<p><strong>「从语言到世界：空间智能是 AI 的下一个前沿」</strong></p>
<p>1950 年，当计算还只是自动化算术和简单逻辑的代名词时，阿兰 · 图灵提出了一个至今仍振聋发聩的问题：机器能否思考？能洞见他所预见的一切，需要非凡的想象力：智能有朝一日或可后天构建，而非与生俱来。</p>
<p>这一洞见，后来开启了一场名为「人工智能」（AI）的不懈科学探索。</p>
<p>在我投身 AI 领域的第二十五个年头，图灵的远见卓识依然激励着我。但我们离这个目标还有多近？答案并非一言以蔽之。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/21d7e8566db54f228e9b01be34e5f734~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=TTHYDZ%2BlQ5jA4%2Fa3EWbXnd%2FStac%3D" alt="" loading="lazy"/></p>
<p>如今，以大语言模型（LLM）为代表的顶尖 AI 技术已开始改变我们获取和运用抽象知识的方式。</p>
<p>然而，它们仍是黑暗中的文字大师；能言善辩却缺乏经验，知识渊博却脱离现实的根基。</p>
<p>空间智能将改变我们创造以及与真实和虚拟世界互动的方式——为故事叙述、创意、机器人技术、科学发现等领域带来革命性的变革。这，就是 AI 的下一个前沿。</p>
<p>对视觉与空间智能的追求，是我踏入该领域以来始终指引我前行的「北极星」。</p>
<p>正因如此，我花费数年时间构建了 ImageNet——首个大规模视觉学习与基准测试数据集，它与神经网络算法、图形处理器（GPU）等现代计算设备一道，成为催生现代 AI 的三大关键基石之一。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eb008ef13c0f4511936e2c4dd550388b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=I7QFj1ZVqoO6ugm%2BS9qy0u5Y7ks%3D" alt="" loading="lazy"/></p>
<p>正因如此，我在斯坦福大学的学术实验室在过去十年里，始终致力于将计算机视觉与机器人学习相结合。</p>
<p>也正因如此，一年多前，我与联合创始人 Justin Johnson、Christoph Lassner、Ben Mildenhall 共同创立了 World Labs：旨在首次将这一可能性淋漓尽致地变为现实。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1d752adca59a4be6b50f3bea797f6767~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=EFu%2BFVezeBeYYSpmR3Vp9kLtPMI%3D" alt="" loading="lazy"/></p>
<p>World Labs 创始人团队，左起依次为 Ben Mildenhall、Justin Johnson、Christoph Lassner 和李飞飞</p>
<p>在本文中，我将阐释何为空间智能、其重要性何在，以及我们如何构建能够解锁它的「世界模型」——其深远影响将重塑创意、具身智能与人类的进步。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e65078eb6a8240e0a6c52b0a2f5c1316~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=rBaPXZYq2vAWjqFDjoveLrvVIMo%3D" alt="" loading="lazy"/></p>
<p><strong>「空间智能：人类认知的基石」</strong></p>
<p>人工智能的发展从未如此激动人心。像大语言模型这样的生成式 AI 已经从实验室走向日常生活，成为数十亿人创意、生产力和沟通的工具。</p>
<p>它们展现了曾被认为遥不可及的能力，能轻松生成连贯的文本、浩如烟海的代码、逼真的图像，乃至短视频片段。AI 是否会改变世界已不再是疑问。</p>
<p>无论以何种合理的标准衡量，它都已然做到了。</p>
<p>然而，仍有太多领域是我们力所不及的。自主机器人的愿景虽引人入胜，却仍停留在理论层面，远未成为未来学家们长期许诺的日常必需品。</p>
<p>在疾病治疗、新材料发现和粒子物理学等领域实现研究进程大飞跃的梦想，在很大程度上仍未实现。</p>
<p>而 AI 真正理解并赋能人类创作者的承诺——无论是帮助学生理解分子化学的复杂概念，协助建筑师构想空间，支持电影制作人构建世界，还是为任何寻求完全沉浸式虚拟体验的人提供支持——也依然遥不可及。</p>
<p>要理解为何这些能力仍难以实现，我们需要审视空间智能的演化历程，以及它如何塑造我们对世界的认知。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/73f595c679dd4d87b25ed03940b320d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=X2lqHVlT1AvSAHP4GgOE60PDKrs%3D" alt="" loading="lazy"/></p>
<p>视觉长久以来都是人类智能的基石，但其力量源于某种更为根本的能力。远在动物学会筑巢、哺育后代、用语言交流或建立文明之前，感知这一简单的行为就已悄然点燃了通往智能的进化火花。</p>
<p>这种从外部世界（无论是一缕微光还是一丝触感）收集信息的看似孤立的能力，在感知与生存之间架起了一座桥梁，并随着代代繁衍而愈发坚固和精巧。层层叠叠的神经元从这座桥梁上生长出来，形成了能够解读世界并协调生物体与环境互动的神经系统。</p>
<p>因此，许多科学家推断，感知与行动的循环成为驱动智能进化的核心动力，也是自然界创造出我们人类——这一集感知、学习、思考与行动于一体的终极造物——的根基。</p>
<p>空间智能在定义我们如何与物理世界互动方面扮演着至关重要的角色。</p>
<p>每一天，我们都依赖它来完成最平凡的举动：通过想象保险杠与路缘之间不断缩小的间隙来停放汽车，接住抛过房间的一串钥匙，在拥挤的人行道上穿行而避免碰撞，或是在睡眼惺忪中不看一眼便将咖啡倒入杯中。</p>
<p>在更极端的情况下，消防员在浓烟弥漫、摇摇欲坠的建筑中穿行，对结构的稳定性和自身的生存在瞬间做出判断，并通过手势、肢体语言和一种无可替代的职业直觉进行交流。</p>
<p>而婴幼儿则在学会说话前的整段岁月里，通过与环境的嬉戏互动来认知世界。所有这一切都发生得如此直观、自然——这是机器尚未能企及的自如与娴熟。</p>
<p>空间智能同样是我们想象力与创造力的基石。故事讲述者在脑海中创造出异常丰富的世界，并利用从古老的洞穴壁画到现代电影，再到沉浸式视频游戏等多种视觉媒介，将这些世界呈现给他人。</p>
<p>无论是孩童在沙滩上堆砌沙堡，还是在电脑上玩《我的世界》，基于空间的想象力构成了真实或虚拟世界中互动体验的基础。在众多行业应用中，对物体、场景和动态交互环境的模拟，为从工业设计到数字孪生，再到机器人训练等无数关键商业用例提供了动力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f936b89d96a5484e9e563dff308532fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=CPalbwpPFNCdbuKXPfod1KJHWtY%3D" alt="" loading="lazy"/></p>
<p>历史上充满了由空间智能扮演核心角色的、定义文明进程的时刻。</p>
<p>在古希腊，埃拉托色尼将光影转化为几何学——在太阳直射赛伊尼城的同一时刻，于亚历山大港测得 7 度的夹角——从而计算出地球的周长。</p>
<p>哈格里夫斯的「珍妮纺纱机」凭借一个空间洞见彻底改变了纺织业：将多个纺锤并排置于同一框架内，使得一名工人能同时纺织多根纱线，生产效率提升了八倍。</p>
<p>沃森和克里克通过亲手搭建 3D 分子模型发现了 DNA 的结构，他们不断摆弄金属板和金属丝，直至碱基对的空间排列「咔哒」一声完美契合。</p>
<p>在每一个案例中，当科学家和发明家需要操控物体、构想结构、推理物理空间时，空间智能都推动了文明的进步——而这些，都非文字所能单独承载。</p>
<p>空间智能是我们认知赖以构建的基石。无论我们是被动观察还是主动创造，它都在发挥作用。它驱动着我们的推理与规划，即便是面对最抽象的议题。</p>
<p>它对于我们互动的方式——无论是口头还是肢体，与同伴还是与环境本身——都至关重要。</p>
<p>虽然我们大多数人并非每天都能像埃拉托色尼那样揭示新的宇宙真理，但我们日常的思考方式与他并无二致——通过感官感知复杂的世界，再利用一种对物理、空间运作方式的直观理解来赋予其意义。</p>
<p>不幸的是，今天的 AI 还不能这样思考。</p>
<p>过去几年确实取得了巨大进步。多模态大语言模型（MLLM）除了文本数据外，还用大量的多媒体数据进行训练，引入了一些基本的空间意识，今天的 AI 可以分析图片、回答关于图片的问题，并生成超逼真的图像和短视频。</p>
<p>通过传感器和触觉技术的突破，我们最先进的机器人可以在高度受限的环境中开始操纵物体和工具。</p>
<p>然而，坦率的真相是，AI 的空间能力仍远未达到人类水平，其局限性很快便会暴露无遗。</p>
<p>在估算距离、方向和尺寸，或通过从新角度生成图像来进行物体的「心理旋转」等任务上，最先进的 MLLM 模型的表现鲜有超过随机猜测的。它们无法走出迷宫、识别捷径或预测基本的物理现象。AI 生成的视频——尽管初露锋芒，且的确酷炫——通常在几秒钟后便会失去连贯性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b340585e1e4944e6abfcad97ef8d36ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=recFCQrFTmWApvhn%2FYFdE%2F80rnU%3D" alt="" loading="lazy"/></p>
<p>虽然当前最先进的 AI 在阅读、写作、研究和数据模式识别方面表现出色，但这些模型在表征或与物理世界互动时，却存在根本性的局限。</p>
<p>我们对世界的看法是整体性的——不仅仅是眼前所见，还包括万物在空间上的相互关联、其意义以及其重要性。通过想象、推理、创造和互动——而不仅是描述——来理解这一切，正是空间智能的力量所在。</p>
<p>若无此能力，AI 便与它试图理解的物理现实脱节。它将无法有效地驾驶我们的汽车，引导家中的机器人或医院的护理机器人，也无法为学习和娱乐开启全新的沉浸式互动体验，更无法加速材料科学和医学领域的探索发现。</p>
<p>哲学家维特根斯坦曾写道：「我语言的极限，意味着我世界的极限。」我不是哲学家，但我深知，至少对 AI 而言，世界远不止于文字。</p>
<p>空间智能代表了超越语言的前沿——它是一种将想象、感知与行动融会贯通的能力，为机器真正提升人类生活开启了无限可能，从医疗健康到创意挥洒，从科学探索到日常辅助。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2a6fe151b8d544e5a3921fb045de9f34~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=9cR53sYM1liCrUbbQHH0B3CvVZY%3D" alt="" loading="lazy"/></p>
<p><strong>「AI 的下一个十年：」</strong></p>
<p><strong>「构建真正具备空间智能的机器」</strong></p>
<p>那么，我们该如何构建具备空间智能的 AI？</p>
<p>如何才能打造出能够像埃拉托色尼一样洞察深远、像工业设计师一样精雕细琢、像故事讲述家一样天马行空，并像急救人员一样敏捷自如地与环境互动的模型？</p>
<p>构建具备空间智能的 AI 需要比大语言模型更为宏大的构想：<strong>「世界模型。」</strong></p>
<p>这是一种新型的生成模型，其理解、推理、生成以及与语义、物理、几何和动态上都极为复杂的虚拟或真实世界进行互动的能力，远非今日的 LLM 所能企及。</p>
<p>不过，这一领域尚处萌芽阶段，当前方法涵盖了从抽象推理模型到视频生成系统的各种探索。</p>
<p>World Labs 正是基于这一信念于 2024 年初创立的：基础方法尚在建立之中，而这将成为未来十年的决定性挑战。</p>
<p>在这个新兴领域，最重要的是确立指导发展的基本原则。对于空间智能，我通过三大核心能力来定义世界模型：</p>
<p><strong>「1. 生成式：世界模型能生成在感知、几何和物理层面保持一致的世界」</strong></p>
<p>能解锁空间理解与推理能力的世界模型，也必须能生成属于自己的模拟世界。</p>
<p>它们必须能够生成无穷无尽、千变万化的模拟世界，这些世界遵循语义或感知指令，同时在几何、物理和动态层面保持一致性——无论其表征的是真实空间还是虚拟空间。</p>
<p>研究界正在积极探索，这些世界固有的几何结构应该被隐式表征还是显式表征。</p>
<p>此外，我相信，除了强大的潜在表征，一个通用的世界模型的输出还必须能为众多不同的用例生成一个显式的、可观察的世界状态。</p>
<p>尤其重要的是，它对当前状态的理解必须与其过去——即导致当前状态的先前世界状态——连贯地联系在一起。</p>
<p><strong>「2. 多模态：世界模型在设计上是多模态的」</strong></p>
<p>正如动物与人类一样，世界模型应该能够处理多种形式的输入——在生成式 AI 领域，这被称为「提示词」。</p>
<p>在给定部分信息——无论是图像、视频、深度图、文本指令、手势还是动作——的情况下，世界模型应能预测或生成尽可能完整的世界状态。</p>
<p>这要求它既能以真实视觉的保真度处理视觉输入，又能同样自如地解读语义指令。</p>
<p>这使得智能体和人类都能通过多样化的输入与模型与世界进行交流，并反过来接收多样化的输出。</p>
<p><strong>「3. 互动性：世界模型能根据输入的动作输出下一个状态」</strong></p>
<p>最后，如果动作和 / 或目标是给予世界模型的提示词的一部分，那么其输出必须包含世界的下一个状态，无论是隐式还是显式表征。</p>
<p>当仅给定一个动作（无论是否包含目标状态）作为输入时，世界模型产生的输出必须与世界先前的状态、任何预设的目标状态、其语义含义、物理定律以及动态行为保持一致。</p>
<p>随着具备空间智能的世界模型在推理和生成能力上变得日益强大和稳健，可以想见，在给定目标的情况下，世界模型本身将不仅能预测世界的下一个状态，甚至还能基于新状态预测出下一步的动作。</p>
<p><strong>「这项挑战的广度与深度，超越了」</strong> <strong>「AI」</strong> <strong>「以往所面对的任何课题。」</strong></p>
<p>语言是人类认知中纯粹的生成现象，而世界则遵循着远为复杂的规则。</p>
<p>例如，在地球上，引力支配运动，原子结构决定光如何产生色彩与亮度，无数物理定律约束着每一次互动。即便是最天马行空的创意世界，也由遵循其自身物理定律和动态行为的空间物体与智能体构成。</p>
<p>要将这一切——语义、几何、动态与物理——持续一致地调和起来，需要全新的方法论。表征一个世界的维度，远比像语言这样的一维、顺序信号复杂得多。</p>
<p>要实现能提供如人类般通用能力的世界模型，需要克服若干严峻的技术壁垒。在 World Labs，我们的研究团队正致力于朝此目标取得根本性的进展。</p>
<p>以下是我们当前研究课题的一些示例。</p>
<p><strong>「· 一种新的、通用的训练任务函数：」</strong></p>
<p>定义一个像 LLM 中「预测下一个 token」一样简洁而优雅的通用任务函数，长久以来都是世界模型研究的核心目标。由于其输入和输出空间的复杂性，这种函数的构建本质上更加困难。</p>
<p>尽管仍有待探索，但这个目标函数及相应的表征必须能反映几何与物理定律，尊重世界模型作为想象与现实之根基表征的本质。</p>
<p><strong>「· 大规模</strong>「<strong>「训练数据」</strong>」<strong>：」</strong></p>
<p>训练世界模型需要比文本整理复杂得多的数据。好消息是：海量的数据源业已存在。</p>
<p>互联网规模的图像和视频集是丰富且易于获取的训练材料——挑战在于开发能够从这些二维图像或视频帧信号（即 RGB）中提取更深层次空间信息的算法。</p>
<p>过去十年的研究已证明了语言模型中数据量与模型大小之间的「规模定律」的力量；世界模型的关键突破在于构建能够以相当规模利用现有视觉数据的架构。</p>
<p>此外，我绝不会低估高质量合成数据以及深度、触觉信息等额外模态的力量。它们在训练过程的关键阶段对互联网规模的数据形成了重要补充。</p>
<p>但前路漫漫，这有赖于更好的传感器系统、更稳健的信号提取算法以及远为强大的神经模拟方法。</p>
<p><strong>「· 新的模型架构与表征学习：」</strong></p>
<p>世界模型的研究将不可避免地推动模型架构与学习算法的进步，尤其是在当前 MLLM 和视频扩散范式之外。</p>
<p>这两种范式通常将数据「token 化」为一维或二维序列，这使得一些简单的空间任务变得异常困难——例如，计算一个短视频中不重复的椅子数量，或者记住一个小时前房间的样貌。</p>
<p>替代性架构或可助一臂之力，例如具备三维或四维感知能力的 token 化、上下文和记忆方法。</p>
<p>例如，在 World Labs，我们近期关于一个名为 RTFM 的实时生成性帧基模型的工作就展示了这种转变，它使用基于空间的帧作为一种空间记忆形式，以实现高效的实时生成，同时在生成的世界中保持持久性。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/168a8b744efb425d84d6eb1e561f4c7b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=lga6I%2FjLBptCAzfkfiVlGKgvmX0%3D" alt="" loading="lazy"/></p>
<p>显然，在我们能够通过世界建模完全解锁空间智能之前，仍面临着艰巨的挑战。这项研究不仅是一次理论演练，它是一类新型创意与生产力工具的核心引擎。而 World Labs 内部的进展令人鼓舞。</p>
<p>我们最近向少数用户展示了 Marble 的一瞥——这是首个能够通过多模态输入提示，来生成并维持一致三维环境的世界模型，供用户和故事讲述者在其创意工作流中进行探索、互动和进一步构建。我们正努力使其尽快向公众开放！</p>
<p>Marble 只是我们创造真正具备空间智能的世界模型的第一步。随着进展加速，研究人员、工程师、用户和商界领袖都开始认识到其非凡的潜力。</p>
<p>下一代世界模型将使机器能够在全新层面上实现空间智能——这一成就将解锁当今 AI 系统中仍然普遍缺失的核心能力。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/931922a21a1c4d2e870624bb0e16a427~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=WjjuBnL0upv4Oa4GknFZkuULj5A%3D" alt="" loading="lazy"/></p>
<p><strong>「用世界模型为人类构建一个更美好的世界」</strong></p>
<p>是什么在激励 AI 的发展？这一点至关重要。</p>
<p>作为协助开启现代 AI 时代的科学家之一，我的动机始终明确：AI 必须增强人类的能力，而非取而代之。</p>
<p>多年来，我一直致力于使 AI 的开发、部署和治理与人类的需求相契合。</p>
<p>如今，关于技术乌托邦和末日论的极端叙事甚嚣尘上，但我始终持有一种更务实的观点：AI 由人开发，为人所用，由人治理。</p>
<p>它必须始终尊重人的能动性与尊严。它的魔力在于扩展我们的能力，让我们更有创造力、联系更紧密、效率更高、生活更充实。</p>
<p>空间智能正是这一愿景的体现——AI 赋能人类的创作者、照护者、科学家和梦想家，去实现曾经的不可能。这一信念，是我将空间智能作为 AI 下一个伟大前沿并为之奋斗的动力。</p>
<p>空间智能的应用横跨不同的时间尺度。创意工具正不断涌现——World Labs 的 Marble 项目已经将这些能力交到了创作者和故事讲述者的手中。</p>
<p>随着我们不断完善感知与行动之间的闭环，机器人技术将是雄心勃勃的中期目标。而最具变革性的科学应用虽然需要更长时间，但有望对人类的福祉产生深远影响。</p>
<p>在所有这些时间尺度上，有几个领域因其重塑人类能力的潜力而格外突出。这需要巨大的集体努力，远非一个团队或一家公司所能实现。</p>
<p>具体来说，它需要整个 AI 生态系统的参与——研究人员、创新者、企业家、公司，乃至政策制定者——共同为实现一个共享的愿景而努力。</p>
<p>但这个愿景值得我们去追求。以下是这个未来所蕴含的图景：</p>
<p><strong>「<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/18b21018c5eb42a9b0194ab9db2ed0a1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=zXDqu3v2mqRhHC9DiNCygHl3kP8%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「创造力：为故事叙述和沉浸式体验注入超凡动力」</strong></p>
<p>「创造力是智力在享受乐趣。」这是我最喜欢的 爱因斯坦名言之一。</p>
<p>早在书面语言出现之前，人类就已开始讲述故事——将其描绘于洞穴岩壁，代代相传，在共同的叙事之上建立起整个文化。</p>
<p>故事是我们理解世界、跨越时空建立联系、探索人性意义的方式，最重要的是，在生活中找到意义，在内心发现爱。</p>
<p>今天，空间智能有潜力改变我们创造和体验叙事的方式，既尊重其根本的重要性，又将其影响力从娱乐延伸至教育，从设计延伸至建筑。</p>
<p>World Labs 的 Marble 平台将把前所未有的空间能力和编辑可控性交到电影制作人、游戏设计师、建筑师和各类故事讲述者的手中，让他们能够快速创造和迭代完全可探索的三维世界，而无需传统三维设计软件的沉重负担。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f7cdde3208f44aa2983dbd802d428324~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=IYREf1ObOtVjszcznFZVWEqQBlU%3D" alt="" loading="lazy"/></p>
<p>创造行为本身依然如故，充满人性的活力；AI 工具只是放大和加速了创作者所能达成的成就。这包括：</p>
<p>**新维度的叙事体验：**电影制作人和游戏设计师正使用 Marble 凭空创造出整个世界，不受预算或地理位置的限制，探索在传统制作流程中难以企及的各种场景和视角。</p>
<p>随着不同形式的媒体与娱乐之间的界限日益模糊，我们正在接近一种全新的互动体验，它融合了艺术、模拟与游戏——个性化的世界，其中任何人，而不仅是工作室，都可以创造并沉浸在自己的故事中。</p>
<p>随着将概念和故事板转化为完整体验的更新、更快捷的方式的出现，叙事将不再局限于单一媒介，创作者可以自由地在无数的界面和平台上构建具有共同主线的大千世界。</p>
<p>**通过设计的空间叙事：**几乎每一个制造的物体或建造的空间，在其实体化之前都必须在虚拟三维环境中进行设计。</p>
<p>这个过程在时间和金钱上都高度迭代且成本高昂。有了具备空间智能的模型，建筑师可以快速构想结构，而无需投入数月时间进行设计，他们可以在尚未存在的空间中漫步——这本质上是在讲述我们未来可能如何生活、工作和聚集的故事。</p>
<p>工业设计师和时装设计师可以瞬间将想象转化为形态，探索物体如何与人体和空间互动。</p>
<p>**新的沉浸式和互动体验：**体验本身是我们作为一个物种创造意义的最深层方式之一。</p>
<p>在整个人类历史中，只有一个单一的三维世界：我们共同生活的物理世界。仅在近几十年，通过游戏和早期的虚拟现实（VR），我们才开始一窥我们自己创造的替代世界是何种滋味。</p>
<p>现在，空间智能与新的设备形态（如 VR 和扩展现实（XR）头显及沉浸式显示器）相结合，以前所未有的方式提升了这些体验。</p>
<p>我们正在接近一个未来，届时，步入一个完全实现的多维世界将像翻开一本书一样自然。</p>
<p>空间智能让世界构建不再是拥有专业制作团队的工作室的专利，而是个人创作者、教育工作者以及任何有愿景希望分享的人都能触及的能力。</p>
<p><strong>「<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9103eacc99ec4d97963e02710fbf7493~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=J7AdJp%2BruvaqKVTLXr%2BG%2F%2BwaAr4%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「机器人技术：具身智能在行动」</strong></p>
<p>从昆虫到人类，动物都依赖空间智能来理解、导航并与它们的世界互动。机器人也不例外。</p>
<p>自诞生之日起，具备空间意识的机器就一直是该领域的梦想，这其中也包括我与我在斯坦福研究实验室的学生及合作者们的工作。</p>
<p>这也是为何我如此兴奋，期待能用 World Labs 正在构建的这类模型将这一梦想变为现实。</p>
<p><strong>通过世界模型规模化</strong>「<strong>「机器人」</strong>」**学习：**机器人学习的进展取决于一个可扩展的、可行的训练数据解决方案。</p>
<p>考虑到机器人必须学习去理解、推理、规划和互动的状态空间极其庞大，许多人推测，需要结合互联网数据、合成模拟以及对真实世界人类演示的捕捉，才能真正创造出具备泛化能力的机器人。</p>
<p>但与语言模型不同，当今的机器人研究缺乏训练数据。世界模型将在此扮演决定性角色。</p>
<p>随着它们在感知保真度和计算效率上的提升，世界模型的输出可以迅速弥合模拟与现实之间的鸿沟。这反过来将有助于在无数的状态、互动和环境模拟中训练机器人。</p>
<p>**伴侣与协作者：**机器人作为人类的协作者——无论是在实验室工作台上协助科学家，还是在家中帮助独居老人——都可以在急需更多劳动力和生产力的领域扩展我们的劳动力。</p>
<p>但这需要具备感知、推理、规划和行动的空间智能，同时——这是最重要的——与人类的目标和行为保持共情式的对齐。</p>
<p>例如，一个实验室机器人可以处理仪器，让科学家能专注于需要精细操作或推理的任务；而一个家庭助理则可以帮助一位老年人做饭，而不会削弱他们的乐趣或自主性。</p>
<p>能够预测下一个状态，甚至可能预测出符合这种期望的下一步动作的、真正具备空间智能的世界模型，对于实现这一目标至关重要。</p>
<p>**扩展具身形式：**人形机器人在我们为自己构建的世界中扮演着一定角色。</p>
<p>但创新的全部益处将来自更多样化的设计：输送药物的纳米机器人、在狭小空间中穿行的软体机器人，以及为深海或外太空打造的机器。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1c5ac19f5be340549abfed73eb82385d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=HZT0ZQ0Sxn0j75%2FNRo4zIPQT93c%3D" alt="" loading="lazy"/></p>
<p>无论其形态如何，未来的空间智能模型都必须整合这些机器人所处的环境以及它们自身的具身感知与运动。但开发这些机器人的一个关键挑战是，在这些五花八门的具身形态上缺乏训练数据。</p>
<p>世界模型将在模拟数据、训练环境和基准测试任务等方面为这些努力发挥关键作用。</p>
<p><strong>「<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1cce9a4b3b034c53862c1cb522379e40~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=b38kspL%2BT6RBwYRBXibgTP6pD3E%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「更长远的图景：科学、医疗与教育」</strong></p>
<p>除了创意和机器人应用，空间智能的深远影响还将延伸至那些能以拯救生命、加速发现的方式增强人类能力的领域。</p>
<p>我下面重点介绍三个可能带来深刻变革的应用领域，当然，空间智能的用例在更多行业中同样是广阔无垠的。</p>
<p>**在科学研究中，**具备空间智能的系统可以模拟实验、并行测试假设，并探索人类无法触及的环境——从深邃的海洋到遥远的行星。</p>
<p>这项技术可以改变气候科学和材料研究等领域的计算建模。通过将多维模拟与真实世界的数据收集相结合，这些工具可以降低计算门槛，扩展每个实验室所能观察和理解的范围。</p>
<p><strong>在医疗</strong>「<strong>「健康」</strong>」**领域，**空间智能将重塑从实验室到病床边的每一个环节。在斯坦福，我的学生和合作者多年来一直与医院、养老院以及居家患者合作。</p>
<p>这段经历让我坚信空间智能在此处的变革潜力。AI 可以通过在多维空间中建模分子相互作用来加速药物发现，通过帮助放射科医生在医学影像中识别模式来提升诊断水平，并能实现环境监测系统，在不取代治愈所必需的人类情感联结的前提下，为患者和照护者提供支持。</p>
<p>更不用说机器人在众多不同场景下帮助我们的医护人员和患者的巨大潜力。</p>
<p>**在教育领域，**空间智能可以实现沉浸式学习，使抽象或复杂的概念变得触手可及，并创造出对我们大脑和身体学习方式至关重要的迭代式体验。</p>
<p>在 AI 时代，更快、更有效的学习和技能再培训对于学龄儿童和成年人都尤为重要。学生可以在多维空间中探索细胞的运作机制或亲历历史事件。教师可以利用互动环境获得个性化教学的工具。</p>
<p>从外科医生到工程师的专业人士，都可以在逼真的模拟中安全地练习复杂技能。</p>
<p>在所有这些领域，可能性是无限的，但目标始终如一：AI 增强人类的专业知识，加速人类的发现，并放大人类的关怀——而不是取代作为人类核心的判断力、创造力和同理心。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6036d9b8ff4b4f3ba7138bbc64a5aff7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449001&amp;x-signature=G1F1%2Ba5qjPja89WNXr71zdSv2k0%3D" alt="" loading="lazy"/></p>
<p><strong>「结论」</strong></p>
<p>过去十年见证了 AI 成为一种全球现象，以及技术、经济乃至地缘政治的转折点。</p>
<p>但作为一名研究者、教育者，如今又是一名创业者，最能激励我的，仍然是图灵 75 年前提出的那个问题背后的精神。</p>
<p>我依然怀有他那份好奇与惊叹。正是这种感觉，每天都激励着我迎接空间智能的挑战。</p>
<p>历史上第一次，我们有望构建出与物理世界如此协调的机器，以至于在我们面临的最严峻挑战中，可以将它们视为真正的伙伴。</p>
<p>无论是加速我们对实验室中疾病的理解，彻底改变我们讲述故事的方式，还是在我们因疾病、受伤或年老而最脆弱的时刻给予支持，我们都正处在一项新技术的风口浪尖，这项技术将提升我们最珍视的生活的方方面面。这</p>
<p>是一个更深刻、更丰富、更强大的生活愿景。</p>
<p>在大自然于远古动物身上释放出第一缕空间智能的近五亿年后，我们有幸成为可能很快就能赋予机器同样能力的这一代技术专家中的一员——并有幸利用这些能力为世界各地的人们谋福祉。</p>
<p>我们关于真正智能机器的梦想，没有空间智能是不完整的。</p>
<p>这项探索，就是指引我的北极星。我邀请你与我同行。</p>
<p>参考资料：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fdrfeifei%2Fstatus%2F1987891210699379091" target="_blank" title="https://x.com/drfeifei/status/1987891210699379091" ref="nofollow noopener noreferrer">x.com/drfeifei/st…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fdrfeifei.substack.com%2Fp%2Ffrom-words-to-worlds-spatial-intelligence" target="_blank" title="https://drfeifei.substack.com/p/from-words-to-worlds-spatial-intelligence" ref="nofollow noopener noreferrer">drfeifei.substack.com/p/from-word…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[谢赛宁 × 李飞飞 ×LeCun 首次联手！寒武纪 - S「空间超感知」AI 震撼登场]]></title>    <link>https://juejin.cn/post/7571086754880323630</link>    <guid>https://juejin.cn/post/7571086754880323630</guid>    <pubDate>2025-11-11T06:58:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7571086754880323630" data-draft-id="7571051830710419506" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="谢赛宁 × 李飞飞 ×LeCun 首次联手！寒武纪 - S「空间超感知」AI 震撼登场"/> <meta itemprop="keywords" content="人工智能,OpenAI"/> <meta itemprop="datePublished" content="2025-11-11T06:58:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="新智元"/> <meta itemprop="url" content="https://juejin.cn/user/952600743642312"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            谢赛宁 × 李飞飞 ×LeCun 首次联手！寒武纪 - S「空间超感知」AI 震撼登场
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/952600743642312/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    新智元
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T06:58:11.000Z" title="Tue Nov 11 2025 06:58:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3ddae2136f914c48b15f9c02ba504f8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449090&amp;x-signature=bROg%2B89e96XCNyXKNkRn27Y0qkw%3D" alt="" loading="lazy"/></p>
<h5 data-id="heading-0"><strong>「【新智元导读】当 AI 不再对着文字死记硬背，而是学会在视频里对人类世界进行超感知，这套全新范式会不会撬开 AGI 的大门？」</strong></h5>
<p>在构建超级智能前，需要什么？</p>
<p>这是目前 AI 领域最前沿，最有哲学意味的问题。这个问题的答案甚至决定了未来人类资源的投入走向。</p>
<p>最近，Yann LeCun、李飞飞和谢赛宁联手发了一篇论文——「Cambrian-S：迈向视频中的空间超感知」。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/be695ffb3ca84b4597954a7da31dc0de~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449090&amp;x-signature=SNiUHiEZMLeOWkfGJFMwtI%2FKnfw%3D" alt="" loading="lazy"/></p>
<p>论文：<a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.04670" target="_blank" title="https://arxiv.org/abs/2511.04670" ref="nofollow noopener noreferrer">arxiv.org/abs/2511.04…</a></p>
<p>代码：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fcambrian-mllm%2Fcambrian-s" target="_blank" title="https://github.com/cambrian-mllm/cambrian-s" ref="nofollow noopener noreferrer">github.com/cambrian-ml…</a></p>
<p>模型：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fcollections%2Fnyu-visionx%2Fcambrian-s-models" target="_blank" title="https://huggingface.co/collections/nyu-visionx/cambrian-s-models" ref="nofollow noopener noreferrer">huggingface.co/collections…</a></p>
<p>数据：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fdatasets%2Fnyu-visionx%2FVSI-590K" target="_blank" title="https://huggingface.co/datasets/nyu-visionx/VSI-590K" ref="nofollow noopener noreferrer">huggingface.co/datasets/ny…</a></p>
<p>基准：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fcollections%2Fnyu-visionx%2Fvsi-super" target="_blank" title="https://huggingface.co/collections/nyu-visionx/vsi-super" ref="nofollow noopener noreferrer">huggingface.co/collections…</a></p>
<p>非常罕见，三位大佬共同署名，而且三人中两位（LeCun 和李飞飞）都是明确的世界模型布道者，而 LeCun 更是一位 LLM 批评者。</p>
<p>他在更多场合还广泛批评目前的基于 LLM 的 AI 底层技术，这个技术无法实现 AGI。可想而知，这篇论文的含金量！</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/692558244af64ee8b139dc757593c0f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449090&amp;x-signature=uS7%2B8ivzZOQ3OiND3GPjDf2if20%3D" alt="" loading="lazy"/></p>
<p>真正意义上的超感官智能，不仅需要具备看见的能力，更要能通过构建内部世界模型，主动地预判、筛选并组织其所接收的感官信息</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eaaf8f6921f74f689a4b82a8566f9d85~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449090&amp;x-signature=v7rLnN8dGBMUCUp73xhhZqzBaFY%3D" alt="" loading="lazy"/></p>
<p>谢赛宁说关于对这个问题的思考，甚至让他们重构了此前基础的研究。</p>
<p>去年，他们就构建了 <a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzI3MTA0MTk1MA%3D%3D%26mid%3D2652494612%26idx%3D1%26sn%3D6bb7e9c5db36d165ec9ab6a4187720ac%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzI3MTA0MTk1MA==&amp;mid=2652494612&amp;idx=1&amp;sn=6bb7e9c5db36d165ec9ab6a4187720ac&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">Cambrian-1</a>，这是针对图像多模态模型的一次开放性探索。</p>
<p>扩展阅读：<a href="https://link.juejin.cn?target=https%3A%2F%2Fmp.weixin.qq.com%2Fs%3F__biz%3DMzI3MTA0MTk1MA%3D%3D%26mid%3D2652494612%26idx%3D1%26sn%3D6bb7e9c5db36d165ec9ab6a4187720ac%26scene%3D21%23wechat_redirect" target="_blank" title="https://mp.weixin.qq.com/s?__biz=MzI3MTA0MTk1MA==&amp;mid=2652494612&amp;idx=1&amp;sn=6bb7e9c5db36d165ec9ab6a4187720ac&amp;scene=21#wechat_redirect" ref="nofollow noopener noreferrer">LeCun 谢赛宁首发全新视觉多模态模型，等效 1000 张 A100 干翻 GPT-4V</a></p>
<p>但之后团队并没有直接扩大规模去构建 Cambrian-2 或 3，而是停下来反思：</p>
<ul>
<li>真正的多模态智能意味着什么？</li>
<li>大语言模型范式对于感官建模而言，真的合理吗？</li>
<li>以及，为什么人类的感知如此毫不费力、如此直观，却又如此强大？</li>
</ul>
<p>一些根本性的东西缺失了。</p>
<p>简单说就是，这三位巨头认为 LLM 目前虽然能力很强，但依然无法像人类一样感知这个世界，既然无法感知，代表 LLM 是有缺陷的。</p>
<p>谢赛宁在博客中表示，在构建出「超感知」之前，不可能真正构建出「超级智能」。</p>
<p>那么，什么是超感知 (supersensing)？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d0bf36a31d3d45e08b17ed75e06c5e4f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449090&amp;x-signature=tHAllbWBT9CZjOvW%2B59J9BWpoR0%3D" alt="" loading="lazy"/></p>
<p>在团队看来，「超感知」并非指更高级的传感器或更好的摄像头。</p>
<p>它关乎一个数字生命如何真正地体验世界——吸收源源不断的输入流，并从中学习。</p>
<p>超感知是智能的一部分，正如眼睛是大脑触及外部世界的那一部分。解决编程和数学问题时不需要感知能力。</p>
<p>但身处现实世界中的 AI 智能体，则需要感官建模！</p>
<p>谢赛宁还引用了卡帕西所说，感官建模或许就是 AI 智能体所需要的一切。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1400626cc6c34b688380c9c9ed387aba~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449090&amp;x-signature=GuocD8DuZWRrfYyuCBHYoss%2FYHo%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8af6d08cd7474ba3acdd04456013d5e2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449090&amp;x-signature=i1p2YiJyyiMqvBolWsSz5xMQrCo%3D" alt="" loading="lazy"/></p>
<p><strong>「视频空间超感知」</strong></p>
<p>如何让 AI 能够真正地感知人类的世界？</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10eb1ca3eb0b4e4ba915a2fa40665e10~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449090&amp;x-signature=f%2FDEKWQ6zsR3CeaIntrVLizdG3Y%3D" alt="" loading="lazy"/></p>
<p>为了更具体地阐述，团队认为以下的分类法能够清晰地描绘出一条演进路径——从团队当前拥有的技术，到团队下一步真正需要构建的目标。</p>
<ul>
<li>
<p><strong>「0. （纯语言理解）」</strong></p>
<p>不具备感官能力；推理仅限于文本和符号。当前的多模态大语言模型虽已超越此阶段，但仍残留着其偏见的痕迹。</p>
</li>
<li>
<p><strong>「1. 语义感知」</strong></p>
<p>将像素解析为物体、属性和关系。这对应于多模态大语言模型目前强大的「看图说话」能力。</p>
</li>
<li>
<p><strong>「2. 流式事件认知」</strong></p>
<p>处理实时的、无限制的数据流，同时主动地解读并响应持续发生的事件。这与当前将多模 T 态大语言模型打造为实时助手的努力方向一致。</p>
</li>
<li>
<p><strong>「3. 隐式」</strong> <strong>「3D」</strong> <strong>「空间认知」</strong></p>
<p>将视频理解为三维世界的投影。智能体必须知道「什么东西」在「哪里」，它们之间「如何关联」，以及空间布局「如何随时间变化」。当今的多模态模型在这一方面的能力仍然**「极其」**有限。</p>
</li>
<li>
<p><strong>「4. 预测性世界建模」</strong></p>
<p>大脑通过基于先验期望来预测潜在的世界状态，从而进行「无意识推断」。当前的多模态系统缺乏一个能够预测未来状态、保持长期记忆或进行推理和规划的内部模型。</p>
</li>
</ul>
<p>要研究这一切，视频是最佳的媒介——它是人类每天体验世界的方式，是人类生活经验的直接投影。</p>
<p><strong>「<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/27109d5c53b842f7b70bfb9ec2d9cd0b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449090&amp;x-signature=t92G8ut2%2FppL%2F9MnhT1r4bE6rLw%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「如何判断模型达到超感知能力」</strong></p>
<p>首要问题（始终）是基准测试。</p>
<p>谢赛宁说他也很钟爱多模态大语言模型，但若缺乏开放和批判性的审视，团队可能会在错误的方向上进行优化。</p>
<p>许多视频基准测试甚至不需要真正的感知能力；正如团队所展示的，仅仅依靠单帧图像或字幕就能获得高分。</p>
<p>谢赛宁也提到了现在的玩法是：</p>
<p>科技公司构建强大的语言模型 → 基准测试奖励的是模型的文本记忆能力 → 模型通过扩大 LLM 的规模获得更高分数 → 其他公司纷纷效仿</p>
<p>这个循环不断持续，直到团队意识到，召唤出的「幽灵」在感知能力上，仍然落后于一只猫，或一只松鼠。</p>
<p>莫拉维克悖论再次应验：对人类而言毫不费力的感知能力，对模型来说却难如登天。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/78d5d543d47349f6aa7c74e145a0b388~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449090&amp;x-signature=jsS%2BFhEi1oaAHmEbpJBmSKUpJMI%3D" alt="" loading="lazy"/></p>
<p>这不仅仅是一个科学问题。</p>
<p>真正的价值来自于那些能够在现实世界中感知和行动的模型：</p>
<p>从工厂到农场，再到医院…… 从机器人到那些人们期望能作为个人助理佩戴的 AI 眼镜。</p>
<p>仅靠大语言模型是无法实现这一切的。</p>
<p>超级智能，始于超感知。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/47bfbf4417c842fe8a6f160e5938e36c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449090&amp;x-signature=SY2NotgK%2FSitHH2r0XlWSBuuE2g%3D" alt="" loading="lazy"/></p>
<p><strong>「<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3fe4f40d6b24462b92d388f003382fa2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449090&amp;x-signature=gkcYo12OClsxki%2Bg2eirLFpIzEo%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「超感知的关键一环是视觉空间智能」</strong></p>
<p>谢赛宁团队之前有一个 VSI-Bench 基准用于测试空间推理，但其中的视频太短，任务也过于简单。</p>
<p>所以，团队打造了一个看似更简单、实则更难的版本：VSI-Super。</p>
<p>其中有两个任务。</p>
<p>· 任务 1：VS</p>
<p>长时程空间记忆。团队使用扩散模型编辑视频，插入一些不合上下文但视觉上融合的物体（而不是随机的「大海捞针」式物体）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a7b8358795024e40993540d27c4435d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449090&amp;x-signature=ZQaf%2BEf38tqBX2tAIB6q%2F2ikubU%3D" alt="" loading="lazy"/></p>
<p>· 任务 2：VSC</p>
<p>持续计数。在变化的视角和场景下进行持续计数…… 模型只需数出它们所看到的东西。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e962cb922db843a592a65451ffb5db96~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449090&amp;x-signature=ccPCHHog%2FVkAUGs%2Bi6JuSW9FNqM%3D" alt="" loading="lazy"/></p>
<p>一个测试考察对物体顺序的记忆力，另一个则考察计数能力。</p>
<p>任务简单，可流式处理——还能有比这更容易的吗？</p>
<p>然而，顶尖的大语言模型却纷纷败下阵来。</p>
<p>而且，这不仅仅是长上下文（long context）的问题。</p>
<p>为什么？</p>
<p>谢赛宁解释道（其实还是验证了莫拉维克悖论）：</p>
<ul>
<li>
<p>视频可以任意长。这对于对人类来说，这很简单。人类的感官能处理「无限的 Token」。这虽然是一个有损的过程，但人们能记住几天甚至几周的经历。模型却做不到。</p>
</li>
<li>
<p><strong>「它们」<strong><strong>（LLM）</strong></strong>「缺乏真正的空间认知和泛化能力。」</strong></p>
<p>人类可以一直数下去，而模型不行。</p>
</li>
</ul>
<p>以顶尖的 Gemini 2.5 模型为例，它只能数到几十个。</p>
<p>即使视频更长、物体更多，它也会停止计数。 这充分暴露了其训练数据的分布特点。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b4b7b1cc5a894d69b09a63ae9f91c983~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449090&amp;x-signature=Gy2DbZQBxc4giyAmEX%2BbTkH9%2B5A%3D" alt="" loading="lazy"/></p>
<p>当然，你可能会问——这难道不只是一个数据或规模化的问题吗？</p>
<p>就像 Scaling Law 一样，继续增加数据量和增大训练量，不就可以解决吗？</p>
<p>谢赛宁表示，部分是因为规模这个原因。</p>
<p>但这也是他们构建全新的 Cambrian-S 视频多模态大语言模型（MLLM）系列的原因。</p>
<p>团队想要挑战当前范式（LLM）的极限。</p>
<p>谢赛宁、李飞飞和 LeCun，他们认为数据和规模化对于超感知至关重要（但仅有这些还不够）。</p>
<p>核心问题在于：目前缺乏真正用于训练空间认知的有效数据。</p>
<p>所以团队构建了一个名为 VSI-590K 的数据集。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7fd9d61aa2b1457cbb23bfcda6afd3bf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449090&amp;x-signature=8VuGba4zV%2BHbttsyyGRlo6Q9pxc%3D" alt="" loading="lazy"/></p>
<p>它包含 59 万个训练样本，来源包括：带有 3D 标注的室内环境第一人称探索视频、来自模拟器的视频，以及使用 VGGT 等视觉工具进行伪标注的 YouTube 视频。</p>
<p>团队探索了多种后训练方案、数据混合策略以及一系列工程细节，训练了从 5 亿到 70 亿参数不等的模型。</p>
<p>结果显示出强大的空间推理能力——性能比团队的基座 MLLM 提升高达 30%。即使是最小的模型也表现得相当出色。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23b87b22c8f648088b14907893209c7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449090&amp;x-signature=0x2H81vgslb8Qm2mCRtLJHt96SE%3D" alt="" loading="lazy"/></p>
<p>已经将数据和模型全部开源。</p>
<p>相信它们将在许多任务中发挥作用。但要明确一点——这仍然无法解决 VSI-Super 基准测试的挑战。</p>
<p>而且他们越来越坚信：沿用大语言模型的老路来构建多模态模型，并非通往超感知的终极之道。（其实就是 LeCun 在多个场合下所说的 LLM 并不会通向 AGI。）</p>
<p><strong>「<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94a76a653a6144f1bd6a56551a1752ad~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449090&amp;x-signature=g2bqLwIKazHHjNpI9eTCAYgIv9E%3D" alt="" loading="lazy"/>」</strong></p>
<p><strong>「全新原型，全新范式」</strong></p>
<p>展望未来，团队正在开发一种全新原型——团队称之为「预测性感知」。</p>
<p>在这篇论文中引用了大量来自认知科学和发展心理学的研究成果。</p>
<p>越是深入研读，就越为人类和动物的感知能力而惊叹。</p>
<p>人类的视觉系统拥有极高的带宽，却又有着惊人的效率。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cd3019471be84d46888156fdc37b8dea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449090&amp;x-signature=Hn27HelAGudoGNAG%2FP%2FUDf3CTWU%3D" alt="" loading="lazy"/></p>
<p>每只眼睛的 600 万个视锥细胞可以传输约 1.6 Gbit/s 的数据，然而大脑仅用约 10 bits/s 的信息来指导行为。</p>
<p>大部分感官数据都被过滤和压缩，整个过程都在自动运行——你甚至毫无察觉。</p>
<p>人类的大脑是如何做到这一点的？</p>
<p>一个主流理论认为：</p>
<p>你的大脑在后台运行一个「预测性世界模型」来进行感知，它不断地预测未来，并将其与实际发生的情况进行比对。</p>
<ul>
<li>如果预测误差很小 → 说明一切尽在预料之中，可以忽略。</li>
<li>如果预测误差很大 → 这就是「惊异」，大脑会集中注意力，并更新记忆。</li>
</ul>
<p>目前的大语言模型中，没有任何与之相当的机制。</p>
<p>为验证这一想法，团队在 Cambrian-S 模型之上，训练了一个潜在帧预测 (Latent Frame Prediction, LFP) 模块。（过去人类模仿鸟类、蝙蝠发明了飞机和超声波，这次 AI 要模仿人类了）</p>
<p>团队在推理过程中估算「惊异度」，并将其应用于两个方面：</p>
<ul>
<li><strong>「由」****「</strong>「<strong>「惊异度」</strong>」<strong>」****「驱动的记忆管理」</strong> —— 压缩或跳过无意外的帧，将计算资源集中在有意外的帧上。</li>
<li><strong>「由」****「</strong>「<strong>「惊异度」</strong>」<strong>」****「驱动的事件切分」</strong> —— 利用「惊异度」的峰值来检测事件边界或场景变化。</li>
</ul>
<p>通过利用这个内部预测模型提供的信号，已经在空间认知任务上看到了喜人的性能提升。</p>
<p>这目前只是一个简化的预测性世界模型原型——但仅凭这一机制，小模型就在 VSI-Super 评测基准上超越了 Gemini。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/136113e7feeb425d94262c425b1db6a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449090&amp;x-signature=4j4SgA7wwYR%2FRqodf2NLVKp%2F%2BYE%3D" alt="" loading="lazy"/></p>
<p>谢赛宁说虽然这篇论文很长，但保证——其中有很多团队认为非常有趣的细节。</p>
<p>如果你也在研究视频多模态模型，那么这篇论文很值得一读。</p>
<p>我不敢说团队的方法就是正确的道路——但我确信，当前的范式是远远不够的，而开放科学、开放研究，才是唯一的出路。</p>
<p>值得一提的是，团队还同步发布了由相关的两个相关项目：</p>
<p><strong>「一项关于多模态基准设计的研究」</strong>——如何对基准进行压力测试，并有效消除语言偏见。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/cfa5d28721c14f2da3cb99803e74804c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449090&amp;x-signature=YV48heCYSiWtrYFJO2C9Rcp9nHQ%3D" alt="" loading="lazy"/></p>
<p><strong>「一份经验总结」</strong>，关于团队如何构建模拟器来收集空间感知视频（Cambrian-S 使用的正是这些数据）。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bf9815255ff94ae38be38094866482c4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449090&amp;x-signature=f7TJ2Kdw8gILDR6AOGo2UY5Af8s%3D" alt="" loading="lazy"/></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/afda1b453af5459d91c39b27c607da2d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449090&amp;x-signature=MZNYddeUREGvOrENZUxcv4Z9RT8%3D" alt="" loading="lazy"/></p>
<p><strong>「作者介绍」</strong></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/daa29656b1cd441d8e72a0184d29b325~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449090&amp;x-signature=s5tU780yksTTIaRLS7zo234B4gM%3D" alt="" loading="lazy"/></p>
<p>共同一作 Shusheng Yang 是纽约大学计算机科学专业的博士生，指导老师是谢赛宁教授。</p>
<p>此前，他在华中科技大学获得计算机课学士学位和计算机视觉与深度学习硕士学位。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4cfc35814d0c4eafa8626b0cab395809~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449090&amp;x-signature=iLjXrd9M3OKFHHoUn56kpuzfGXc%3D" alt="" loading="lazy"/></p>
<p>共同一作 Jihan Yang，是纽约大学库朗研究所的一名博士后副研究员，师从谢赛宁教授。</p>
<p>此前，他在香港大学获得博士学位，在中山大学获得学士学位。</p>
<p>他的研究兴趣主要集中在机器学习和计算机视觉领域，重点探索多模态大语言模型在推理、智能体、长视频理解、空间智能和统一模型方面的研究，以及它们在现实世界中的应用与落地。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/caa8509d7cb548b5aec4c3e3aa8e7fc7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paw5pm65YWD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763449090&amp;x-signature=aLvzYDN2hp0Yr%2BdFZulwT4lcnuE%3D" alt="" loading="lazy"/></p>
<p>核心作者黄品志是纽约大学本科生，师从谢赛宁教授。</p>
<p>参考资料：</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcambrian-mllm.github.io%2Fcambrian-s%2F" target="_blank" title="https://cambrian-mllm.github.io/cambrian-s/" ref="nofollow noopener noreferrer">cambrian-mllm.github.io/cambrian-s/</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Farxiv.org%2Fabs%2F2511.04670" target="_blank" title="https://arxiv.org/abs/2511.04670" ref="nofollow noopener noreferrer">arxiv.org/abs/2511.04…</a></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fx.com%2Fsainingxie%2Fstatus%2F1986685042332958925" target="_blank" title="https://x.com/sainingxie/status/1986685042332958925" ref="nofollow noopener noreferrer">x.com/sainingxie/…</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[《Spring Framework 核心原理与实践指南》]]></title>    <link>https://juejin.cn/post/7570999443447021604</link>    <guid>https://juejin.cn/post/7570999443447021604</guid>    <pubDate>2025-11-11T07:25:40.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570999443447021604" data-draft-id="7570999443447005220" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="《Spring Framework 核心原理与实践指南》"/> <meta itemprop="keywords" content="Spring"/> <meta itemprop="datePublished" content="2025-11-11T07:25:40.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="超级苦力怕"/> <meta itemprop="url" content="https://juejin.cn/user/3687077413139354"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            《Spring Framework 核心原理与实践指南》
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3687077413139354/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    超级苦力怕
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T07:25:40.000Z" title="Tue Nov 11 2025 07:25:40 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读25分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">1.Spring 相关概念</h2>
<p>Spring 是一个开源的 Java 企业级应用开发框架，它的核心目标是简化企业级应用开发的复杂性，提供一站式的解决方案。</p>
<h3 data-id="heading-1">1.1 Spring Framework 系统架构图</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/40caa7ed61fc4e53a4cc396e84d1029d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LaF57qn6Ium5Yqb5oCV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763450740&amp;x-signature=55FV5OKJpfeU71tPsnZ0eaJlAI8%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>在Spring这部分内容中主要包含<code>IOC/DI</code>和<code>AOP</code>,在后面也会基于这几个部分进行讲解。</p>
<h3 data-id="heading-2">1.2 核心概念</h3>
<p><strong>概念</strong>：</p>
<p><strong>IOC (Inversion of Control) 控制反转</strong>：对象的创建控制权由程序转移到<strong>外部</strong>，这种思想称为控制反转。</p>
<blockquote>
<p>即控制权从应用程序代码转移到框架容器，由容器负责管理对象生命周期和依赖关系。</p>
</blockquote>
<p><strong>Bean</strong>：在Spring中提供了IOC容器，而用于充当外部，负责对象的创建、初始化等工作，被创建或被管理的对象在IOC容器中的统称为Bean。</p>
<p><strong>DI(Dependency Injection)依赖注入</strong>：在容器中建立bean与bean之间的依赖关系的整个过程，称为依赖注入</p>
<h2 data-id="heading-3">2. IOC内容</h2>
<p>IOC主要是控制反转思想，在这里分为<code>bean基础配置</code>,<code>bean实例化</code>,<code>bean的生命周期</code>讲解，分别采用<code>非注解</code>,<code>注解</code>的写法。</p>
<p>同时讲解核心容器,也就是<code>ApplicationContext</code>。</p>
<h3 data-id="heading-4">2.1 bean的基础配置</h3>
<h4 data-id="heading-5">(1) 非注解写法和注意事项</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4dff30f7a9ea44faa51572cb036ef0c3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LaF57qn6Ium5Yqb5oCV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763450740&amp;x-signature=y0cG9J%2FyssDktB9sD4M3gDB5dvg%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h5 data-id="heading-6">&lt;1&gt; 知识点速览</h5>
<blockquote>
<p>id：bean的id，使用容器可以通过id值获取对应的bean，在一个容器中id值唯一。</p>
<p>class：bean的类型，即配置的bean的全路径类名</p>
<p>name：bean的别名配置,别名可以有多个，使用逗号、分号、空格分隔</p>
<p>scope：负责控制bean的作用范围，有单例和非单例</p>
</blockquote>
<h5 data-id="heading-7">&lt;2&gt; 准备工作</h5>
<p><strong>前置工作</strong>:创建Maven项目，添加Spring对应jar包和所需类
<strong>使用思路</strong>：添加Spring配置文件，完成配置，进行使用</p>
<p>Spring配置文件示例(在resources下建立)</p>
<blockquote>
<p><code>resources</code> 是 Java 项目（尤其是 Maven/Gradle 等构建工具管理的项目）中<strong>专门用于存放非 Java 源代码的资源文件</strong>的标准目录</p>
</blockquote>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;?xml version=<span class="hljs-string">"1.0"</span> encoding=<span class="hljs-string">"UTF-8"</span>?&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">beans</span>&gt;</span>
<span class="hljs-comment">&lt;!--文档前面内容省略--&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"bookDao"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.Coolipa.Dao.Impl.BookDaoImpl"</span> <span class="hljs-attr">scope</span>=<span class="hljs-string">"singleton"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"bookDao2 bookDao"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"bookService"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.Coolipa.Service.Impl.BookServiceImpl"</span> <span class="hljs-attr">scope</span>=<span class="hljs-string">"prototype"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span>
</code></pre>
<h5 data-id="heading-8">&lt;3&gt; 获取IOC容器并调用方法 (id 和 class的使用)</h5>
<p>启动类通过配置文件中的xml接口完成IOC容器创建，并通过id和class调用内部的方法</p>
<p><strong>配置文件关键点</strong>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"bookDao"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.Coolipa.Dao.Impl.BookDaoImpl"</span> /&gt;</span>
</code></pre>
<p><strong>启动类</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">app</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">"ApplicationContext.xml"</span>);
        BookDao bookDao= (BookDao) app.getBean(<span class="hljs-string">"bookDao"</span>);
        bookDao.save();
    }
}

</code></pre>
<h5 data-id="heading-9">&lt;4&gt; 配置别名(name的使用)</h5>
<p>id可能会由于命名习惯而产生分歧，可以利用别名去解决这个问题</p>
<p><strong>配置文件关键点</strong>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"bookDao"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.Coolipa.Dao.Impl.BookDaoImpl"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"bookDao2"</span>/&gt;</span>
</code></pre>
<p><strong>启动类</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">app</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">"ApplicationContext.xml"</span>);
        BookDao bookDao= (BookDao) app.getBean(<span class="hljs-string">"bookDao2"</span>);
        bookDao.save();
    }
}
</code></pre>
<p><strong>拓充</strong>：
可以利用bean依赖注入的ref属性指定bean，必须在容器中存在，不存在将会报错<code>NoSuchBeanDefinitionException</code></p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span> =<span class="hljs-string">"bookService"</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"service service2"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.Coolipa.Dao.Impl.BookDaoImpl"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"bookDao"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"dao"</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c68353811964507ace8135a25514a29~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LaF57qn6Ium5Yqb5oCV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763450740&amp;x-signature=CssUnCvGFYUsp%2FDztjLFp87O5%2BA%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h5 data-id="heading-10">&lt;5&gt;测试单例/非单例(scope的使用)</h5>
<p>在默认情况下，Spring创建的Bean对象都是单例了，所以需要手动更改</p>
<p><strong>配置文件关键点</strong>：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"bookDao"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.Coolipa.Dao.Impl.BookDaoImpl"</span> 
<span class="hljs-attr">scope</span>=<span class="hljs-string">"singleton"</span>/&gt;</span>
</code></pre>
<p>其中单例为<code>singleton</code>，非单例为<code>prototype</code></p>
<p>拓充：</p>
<blockquote>
<p>为什么bean默认为单例?</p>
</blockquote>
<p>单例指在IOC容器中只会有该类的一个对象,bean对象只有一个就避免了对象的频繁创建与销毁，达到了bean对象的复用，性能高</p>
<blockquote>
<p>bean在容器中是单例的，会不会产生线程安全问题？</p>
</blockquote>
<p>如果对象有成员变量可以用来存储数据，由于线程共用一个bean对象，会存在线程安全问题。
如果对象没有成员变量进行数据存储，则方法中的局部变量在方法调用完毕后会被销毁，不会存在线程安全问题</p>
<h4 data-id="heading-11">(2) 注解写法和注意事项</h4>
<h5 data-id="heading-12">&lt;1&gt; 知识点速览：</h5>
<p>知识点1:@Component等</p>

























<table><thead><tr><th>名称</th><th>@Component/@Controller/@Service/@Repository</th></tr></thead><tbody><tr><td>类型</td><td>类注解</td></tr><tr><td>位置</td><td>类定义上方</td></tr><tr><td>作用</td><td>设置该类为spring管理的bean</td></tr><tr><td>属性</td><td>value（默认）：定义bean的id</td></tr></tbody></table>
<p>知识点2：@Configuration</p>

























<table><thead><tr><th>名称</th><th>@Configuration</th></tr></thead><tbody><tr><td>类型</td><td>类注解</td></tr><tr><td>位置</td><td>类定义上方</td></tr><tr><td>作用</td><td>设置该类为spring配置类</td></tr><tr><td>属性</td><td>value（默认）：定义bean的id</td></tr></tbody></table>
<p>知识点3：@ComponentScan</p>

























<table><thead><tr><th>名称</th><th>@ComponentScan</th></tr></thead><tbody><tr><td>类型</td><td>类注解</td></tr><tr><td>位置</td><td>类定义上方</td></tr><tr><td>作用</td><td>设置spring配置类扫描路径，用于加载使用注解格式定义的bean</td></tr><tr><td>属性</td><td>value（默认）：扫描路径，此路径可以逐层向下扫描</td></tr></tbody></table>
<p>知识点4：@Scope</p>

























<table><thead><tr><th>名称</th><th>@Scope</th></tr></thead><tbody><tr><td>类型</td><td>类注解</td></tr><tr><td>位置</td><td>类定义上方</td></tr><tr><td>作用</td><td>设置该类创建对象的作用范围<br/>可用于设置创建出的bean是否为单例对象</td></tr><tr><td>属性</td><td>value（默认）：定义bean作用范围，<br/><strong>默认值singleton（单例），可选值prototype（非单例）</strong></td></tr></tbody></table>
<h5 data-id="heading-13">&lt;2&gt; 改进方案：</h5>
<p>创建java的配置类，用<code>@configuration</code>注解替换配置类,用<code>@ComponentScan</code>替换指定class文件</p>
<p><strong>配置类</strong>：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@Scope("singleton")</span>
<span class="hljs-meta">@ComponentScan("com.Coolipa")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringConfig</span> {
}
</code></pre>
<p><strong>被替换部分</strong>：</p>
<pre><code class="hljs language-java" lang="java">    &lt;bean id=<span class="hljs-string">"bookDao"</span> class=<span class="hljs-string">"com.Coolipa.Dao.Impl.BookDaoImpl"</span> scope=<span class="hljs-string">"singleton"</span> name=<span class="hljs-string">"bookDao2"</span>/&gt;
    &lt;bean id=<span class="hljs-string">"bookService"</span> class=<span class="hljs-string">"com.Coolipa.Service.Impl.BookServiceImpl"</span> scope=<span class="hljs-string">"prototype"</span>/&gt;
</code></pre>
<p><strong>启动类：</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">App</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">app</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(SpringConfig.class);        <span class="hljs-comment">//名称和字节码都可以</span>
        BookDao bookDao= (BookDao) app.getBean(<span class="hljs-string">"bookDao"</span>);
        bookDao.save();
        <span class="hljs-type">BookService</span> <span class="hljs-variable">bookService</span> <span class="hljs-operator">=</span>app.getBean(BookService.class);
        bookService.save();
    }
}
</code></pre>
<p><strong>被替换部分对比</strong>：</p>
<pre><code class="hljs language-java" lang="java">        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">"applicationContext.xml"</span>);
        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AnnotationConfigApplicationContext</span>(SpringConfig.class);
</code></pre>
<blockquote>
<p>ClassPathXmlApplicationContext是加载XML配置文件AnnotationConfigApplicationContext是加载配置类</p>
</blockquote>
<h3 data-id="heading-14">2.2 bean实例化</h3>
<p>这里主要为<code>实例化bean的方式</code></p>
<h4 data-id="heading-15">(1) 非注解写法和注意事项</h4>
<h5 data-id="heading-16">&lt;1&gt; 知识点速览</h5>
<p>bean是由构造方法创建的</p>
<p>Spring的IOC实例化对象的三种方式分别为<code>构造方法</code>,<code>静态方法</code>,<code>实例方法</code>，主要掌握<code>构造方法</code>和实例方法中的<code>FactoryBean</code>。</p>
<blockquote>
<p>需要注意的一点是，构造方法在类中默认会提供，但是如果重写了构造方法，默认的就会消失，在使用的过程中需要注意，如果需要重写构造方法，最好把默认的构造方法也重写下。</p>
</blockquote>
<h5 data-id="heading-17">&lt;2&gt; 准备工作</h5>
<p><strong>前置工作</strong>：准备创建的类，配置类，启动类</p>
<h5 data-id="heading-18">&lt;3&gt; 构造方法实例化</h5>
<p>在类中添加无参构造函数即可</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookDaoImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BookDao</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BookDaoImpl</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"book dao constructor is running ...."</span>);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"book dao save ..."</span>);
    }

}
</code></pre>
<blockquote>
<p>Spring容器在创建对象时用的就是构造函数(无参构造)，同时Spring底层用的是反射(可以访问私有构造方法)</p>
</blockquote>
<h5 data-id="heading-19">&lt;4&gt; 静态工厂实例化</h5>
<p>配置类添加内容</p>
<blockquote>
<p>class:工厂类全名</p>
<p>factory-method：具体工厂类中创建对象的方法名</p>
</blockquote>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"orderDao"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.itheima.factory.OrderDaoFactory"</span> <span class="hljs-attr">factory-method</span>=<span class="hljs-string">"getOrderDao"</span>/&gt;</span>
</code></pre>
<p>编写运行类运行</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppForInstanceOrder</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">"applicationContext.xml"</span>);
        <span class="hljs-type">OrderDao</span> <span class="hljs-variable">orderDao</span> <span class="hljs-operator">=</span> (OrderDao) ctx.getBean(<span class="hljs-string">"orderDao"</span>);
        orderDao.save();
    }
}
</code></pre>
<blockquote>
<p>在工厂静态方法，可以作其他的业务操作</p>
</blockquote>
<h5 data-id="heading-20">&lt;5&gt; 实例工厂与FactoryBean</h5>
<p><strong>实例工厂</strong>：</p>
<p>配置类内容</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"userFactory"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.itheima.factory.UserDaoFactory"</span>/&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"userDao"</span> <span class="hljs-attr">factory-method</span>=<span class="hljs-string">"getUserDao"</span> <span class="hljs-attr">factory-bean</span>=<span class="hljs-string">"userFactory"</span>/&gt;</span>
</code></pre>
<blockquote>
<p>factory-bean:工厂的实例对象</p>
<p>factory-method:工厂对象中的具体创建对象的方法名</p>
</blockquote>
<p>编写运行类，在类中通过工厂获取对象</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppForInstanceUser</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> 
            <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">"applicationContext.xml"</span>);
        <span class="hljs-type">UserDao</span> <span class="hljs-variable">userDao</span> <span class="hljs-operator">=</span> (UserDao) ctx.getBean(<span class="hljs-string">"userDao"</span>);
        userDao.save();
    }
}
</code></pre>
<p><strong>FactoryBean</strong>：</p>
<p>创建类，实现FactoryBean接口，重写方法</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserDaoFactoryBean</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">FactoryBean</span>&lt;UserDao&gt; {
    <span class="hljs-comment">//代替原始实例工厂中创建对象的方法</span>
    <span class="hljs-keyword">public</span> UserDao <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserDaoImpl</span>();
    }
    <span class="hljs-comment">//返回所创建类的Class对象</span>
    <span class="hljs-keyword">public</span> Class&lt;?&gt; getObjectType() {
        <span class="hljs-keyword">return</span> UserDao.class;
    }
}
</code></pre>
<blockquote>
<p>FactoryBean接口有三个方法：</p>
<ul>
<li><code>getObject()</code>：返回由FactoryBean创建的对象实例</li>
<li><code>getObjectType()</code>：返回创建对象的类型</li>
<li><code>isSingleton()</code>：默认返回true，表示创建的bean是单例的。可以通过重写此方法返回false来创建原型(prototype)bean</li>
</ul>
</blockquote>
<p>验证方法：可以通过在Spring容器中多次获取同一个FactoryBean创建的bean，观察是否为同一个实例来验证单例行为。</p>
<pre><code class="hljs language-java" lang="java">T <span class="hljs-title function_">getObject</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception;

Class&lt;?&gt; getObjectType();

<span class="hljs-keyword">default</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isSingleton</span><span class="hljs-params">()</span> {
		<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
}
</code></pre>
<h4 data-id="heading-21">(2) 实例化bean的三种方式</h4>
<h3 data-id="heading-22">2.3 bean的生命周期</h3>
<p>这里主要知识点为<code>bean生命周期</code></p>
<h4 data-id="heading-23">(1) 非注解写法和注意事项</h4>
<h5 data-id="heading-24">&lt;1&gt; 知识点速览</h5>
<p>关于Spring中对bean生命周期提供两种方式</p>
<ul>
<li>
<p>在配置文件中的bean标签，可以添加<code>init-method</code>和<code>destroy-method</code>属性</p>
</li>
<li>
<p>类实现<code>InitializingBean</code>与<code>DisposableBean</code>接口，这种方式了解下即可。</p>
</li>
</ul>
<p>关闭容器分为<code>close()</code>和<code>registerShutdownHook()</code>两个方法</p>
<h5 data-id="heading-25">&lt;2&gt; 准备工作</h5>
<p><strong>前置工作</strong>：准备创建的类，配置类，启动类</p>
<h5 data-id="heading-26">&lt;3&gt; 生命周期设置</h5>
<h6 data-id="heading-27">a. 正常实现</h6>
<p>添加初始化和销毁方法</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookDaoImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BookDao</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"book dao save ..."</span>);
    }
    <span class="hljs-comment">//表示bean初始化对应的操作</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span>{
        System.out.println(<span class="hljs-string">"init..."</span>);
    }
    <span class="hljs-comment">//表示bean销毁前对应的操作</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destory</span><span class="hljs-params">()</span>{
        System.out.println(<span class="hljs-string">"destory..."</span>);
    }
}
</code></pre>
<p>在配置文件添加配置，如下:</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"bookDao"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.itheima.dao.impl.BookDaoImpl"</span> <span class="hljs-attr">init-method</span>=<span class="hljs-string">"init"</span> <span class="hljs-attr">destroy-method</span>=<span class="hljs-string">"destory"</span>/&gt;</span>
</code></pre>
<blockquote>
<p>由于在普通Java应用中，JVM退出时不会自动调用bean的销毁方法，可以通过以下两种方式触发：</p>
</blockquote>
<ol>
<li>
<p><strong>显式关闭</strong>：使用<code>ClassPathXmlApplicationContext</code>的<code>close()</code>方法</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ClassPathXmlApplicationContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">"applicationContext.xml"</span>);
<span class="hljs-comment">// 使用bean...</span>
ctx.close(); <span class="hljs-comment">// 显式关闭容器，触发销毁方法</span>
</code></pre>
</li>
<li>
<p><strong>注册关闭钩子</strong>：使用<code>registerShutdownHook()</code>方法，在JVM关闭时自动调用销毁方法</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ClassPathXmlApplicationContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">"applicationContext.xml"</span>);
ctx.registerShutdownHook(); <span class="hljs-comment">// 注册JVM关闭钩子</span>
</code></pre>
</li>
</ol>
<p><strong>区别</strong>：</p>
<ul>
<li><code>close()</code>：需要手动调用，立即触发销毁</li>
<li><code>registerShutdownHook()</code>：自动在JVM关闭时触发，更适合生产环境</li>
</ul>
<h6 data-id="heading-28">b. 基于接口实现</h6>
<p>在实现类添加两个接口<code>InitializingBean</code>， <code>DisposableBean</code>并实现接口中的两个方法<code>afterPropertiesSet</code>和<code>destroy</code></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BookService</span>, InitializingBean, DisposableBean {
    <span class="hljs-keyword">private</span> BookDao bookDao;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBookDao</span><span class="hljs-params">(BookDao bookDao)</span> {
        <span class="hljs-built_in">this</span>.bookDao = bookDao;
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"book service save ..."</span>);
        bookDao.save(); 
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"service destroy"</span>);
    }
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterPropertiesSet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception {
        System.out.println(<span class="hljs-string">"service init"</span>);
    }
}
</code></pre>
<h4 data-id="heading-29">(2) 注解写法和注意事项</h4>
<h5 data-id="heading-30">&lt;1&gt; 知识点速览</h5>
<p>知识点1：@PostConstruct</p>

























<table><thead><tr><th>名称</th><th>@PostConstruct</th></tr></thead><tbody><tr><td>类型</td><td>方法注解</td></tr><tr><td>位置</td><td>方法上</td></tr><tr><td>作用</td><td>设置该方法为初始化方法</td></tr><tr><td>属性</td><td>无</td></tr></tbody></table>
<p>知识点2：@PreDestroy</p>





















<table><thead><tr><th>名称</th><th>@PreDestroy</th></tr></thead><tbody><tr><td>类型</td><td>方法注解</td></tr><tr><td>位置</td><td>方法上</td></tr><tr><td>作用</td><td>设置该方法为销毁方法</td></tr></tbody></table>
<h5 data-id="heading-31">&lt;2&gt; 改进方案</h5>
<p>使用<code>@PostConstruct</code>、<code>@PreDestroy</code>定义bean生命周期</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Repository</span>
<span class="hljs-comment">//@Scope设置bean的作用范围</span>
<span class="hljs-meta">@Scope("singleton")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookDaoImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BookDao</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"book dao save ..."</span>);
    }
    <span class="hljs-comment">//@PostConstruct设置bean的初始化方法</span>
    <span class="hljs-meta">@PostConstruct</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"init ..."</span>);
    }
    <span class="hljs-comment">//@PreDestroy设置bean的销毁方法</span>
    <span class="hljs-meta">@PreDestroy</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">destroy</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"destroy ..."</span>);
    }
}
</code></pre>
<h3 data-id="heading-32">2.4 核心容器</h3>
<h4 data-id="heading-33">(1) 知识点速览</h4>
<p>核心容器可以简单理解为<code>ApplicationContext</code></p>
<ul>
<li>
<p>容器创建的两种方式</p>
<ul>
<li>ClassPathXmlApplicationContext[掌握]</li>
<li>FileSystemXmlApplicationContext[知道即可]</li>
</ul>
</li>
<li>
<p>获取Bean的三种方式</p>
<ul>
<li>getBean("名称"):需要类型转换</li>
<li>getBean("名称",类型.class):多了一个参数</li>
<li>getBean(类型.class):容器中不能有多个该类的bean对象</li>
</ul>
<p>上述三种方式，各有各的优缺点，用哪个都可以。</p>
</li>
<li>
<p>容器类层次结构</p>
<ul>
<li>只需要知晓容器的最上级的父接口为 BeanFactory即可</li>
</ul>
</li>
<li>
<p>BeanFactory</p>
<ul>
<li>使用BeanFactory创建的容器是延迟加载</li>
<li>使用ApplicationContext创建的容器是立即加载(可通过配置实现延迟加载)</li>
<li>具体BeanFactory如何创建只需要了解即可。</li>
</ul>
</li>
</ul>
<p>bean常用属性</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e4d21dfecab4dcb86f1d1924b7d3426~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LaF57qn6Ium5Yqb5oCV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763450740&amp;x-signature=FrIavxlzCxm3ork3fxiGpdiyh0o%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<p>依赖注入常用属性</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d07bb93f8b034ca7b571387522c3baf7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LaF57qn6Ium5Yqb5oCV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763450740&amp;x-signature=hw1PEQxEwnsNm%2BAgmtwoHXQhEtc%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-34">(2) 容器的创建方式</h4>
<p>分为<code>类路径下的XML配置文件</code>和<code>文件系统下的XML配置文件</code></p>
<p><strong>类路径下的XML配置文件</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathXmlApplicationContext</span>(<span class="hljs-string">"applicationContext.xml"</span>);
</code></pre>
<p><strong>文件系统下的XML配置文件</strong></p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">ApplicationContext</span> <span class="hljs-variable">ctx</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileSystemXmlApplicationContext</span>(<span class="hljs-string">"D:\\workspace\\spring\\spring_10_container\\src\\main\\resources\\applicationContext.xml"</span>);
</code></pre>
<h4 data-id="heading-35">(3) Bean的三种获取方式</h4>
<p>方式一：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">BookDao</span> <span class="hljs-variable">bookDao</span> <span class="hljs-operator">=</span> (BookDao) ctx.getBean(<span class="hljs-string">"bookDao"</span>);
</code></pre>
<p>缺点：需要强转</p>
<p>方式二:</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">BookDao</span> <span class="hljs-variable">bookDao</span> <span class="hljs-operator">=</span> ctx.getBean(<span class="hljs-string">"bookDao"</span>，BookDao.class);
</code></pre>
<p>缺点：需要多加一个参数</p>
<p>方式三：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-type">BookDao</span> <span class="hljs-variable">bookDao</span> <span class="hljs-operator">=</span> ctx.getBean(BookDao.class);
</code></pre>
<p>缺点：IOC容器中对应的bean对象只能有一个</p>
<h4 data-id="heading-36">(4) BeanFactory的使用</h4>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">AppForBeanFactory</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> {
        <span class="hljs-type">Resource</span> <span class="hljs-variable">resources</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassPathResource</span>(<span class="hljs-string">"applicationContext.xml"</span>);
        <span class="hljs-type">BeanFactory</span> <span class="hljs-variable">bf</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">XmlBeanFactory</span>(resources);
        <span class="hljs-type">BookDao</span> <span class="hljs-variable">bookDao</span> <span class="hljs-operator">=</span> bf.getBean(BookDao.class);
        bookDao.save();
    }
}
</code></pre>
<ul>
<li>
<p>BeanFactory是延迟加载，只有在获取bean对象的时候才会去创建</p>
</li>
<li>
<p>ApplicationContext是立即加载，容器加载的时候就会创建bean对象</p>
</li>
<li>
<p>ApplicationContext要想成为延迟加载，只需要按照如下方式进行配置</p>
</li>
</ul>
<h2 data-id="heading-37">3. DI相关内容</h2>
<p>主要围绕<code>引用类型</code>和<code>简单类型</code>的注入方式进行讲解</p>
<h4 data-id="heading-38">(1) 非注解写法和注意事项</h4>
<h5 data-id="heading-39">&lt;1&gt; 知识点速览</h5>
<h5 data-id="heading-40">&lt;2&gt; 准备工作</h5>
<h5 data-id="heading-41">&lt;3&gt; setter注入</h5>
<p>通过set方法进行注入</p>
<p><strong>引用类型</strong></p>
<p>在配置类中使用<code>propety</code>和<code>ref</code>注入引用类型对象</p>
<pre><code class="hljs language-java" lang="java">    &lt;bean id=<span class="hljs-string">"bookService"</span> class=<span class="hljs-string">"com.itheima.service.impl.BookServiceImpl"</span>&gt;
        &lt;!--property标签：设置注入属性--&gt;
        &lt;!--name属性：设置注入的属性名，实际是set方法对应的名称--&gt;
        &lt;!--ref属性：设置注入引用类型bean的id或name--&gt;
        &lt;property name=<span class="hljs-string">"bookDao"</span> ref=<span class="hljs-string">"bookDao"</span>/&gt;
    &lt;/bean&gt;
</code></pre>
<p>在bean中定义引用数据属性并提供set方法即可</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BookService</span>{
    <span class="hljs-keyword">private</span> BookDao bookDao;
    <span class="hljs-comment">//setter注入需要提供要注入对象的set方法</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setBookDao</span><span class="hljs-params">(BookDao bookDao)</span> {
        <span class="hljs-built_in">this</span>.bookDao = bookDao;
    }
}
</code></pre>
<p><strong>简单类型</strong></p>
<p>在配置类中使用<code>propety</code>和<code>value</code>属性注入简单类型数据</p>
<pre><code class="hljs language-xml" lang="xml">    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"bookDao"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.itheima.dao.impl.BookDaoImpl"</span>&gt;</span>
        <span class="hljs-comment">&lt;!--property标签：设置注入属性--&gt;</span>
        <span class="hljs-comment">&lt;!--name属性：设置注入的属性名，实际是set方法对应的名称--&gt;</span>
        <span class="hljs-comment">&lt;!--value属性：设置注入简单类型数据值--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"connectionNum"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"100"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"databaseName"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"mysql"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
</code></pre>
<h5 data-id="heading-42">&lt;4&gt; 构造器注入</h5>
<p>通过将set方法改为构造方法传参，进行注入</p>
<p><strong>引用注入</strong></p>
<p>配置类使用<code>constructor-arg</code>标签<code>ref</code>属性注入引用类型对象</p>
<pre><code class="hljs language-xml" lang="xml">     <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"bookService"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.itheima.service.impl.BookServiceImpl"</span>&gt;</span> 
           <span class="hljs-comment">&lt;!-- 根据构造方法参数名称注入--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"userDao"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"userDao"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"bookDao"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"bookDao"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
</code></pre>
<blockquote>
<p>这里的ref指向的是参数，如果改成BookServiceImpl(BookDao bookDao1, UserDao userDao1)，则配置中name指向userDao1和bookDao1</p>
</blockquote>
<p>实现类中定义引用类型属性，并提供构造方法</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BookService</span>{
    <span class="hljs-keyword">private</span> BookDao bookDao;
    <span class="hljs-keyword">private</span> UserDao userDao;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BookServiceImpl</span><span class="hljs-params">(BookDao bookDao, UserDao userDao)</span> {
        <span class="hljs-built_in">this</span>.bookDao = bookDao;
        <span class="hljs-built_in">this</span>.userDao = userDao;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"book service save ..."</span>);
        bookDao.save();
        userDao.save();
    }
}
</code></pre>
<p><strong>简单类型</strong></p>
<p>在配置类中使用<code>constructor-arg</code>标签和<code>value</code>属性注入简单类型数据</p>
<pre><code class="hljs language-xml" lang="xml">    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"bookDao"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.itheima.dao.impl.BookDaoImpl"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"databaseName"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"mysql"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"connectionNum"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"666"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"userDao"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.itheima.dao.impl.UserDaoImpl"</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"bookService"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"com.itheima.service.impl.BookServiceImpl"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"bookDao"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"bookDao"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"userDao"</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">"userDao"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
</code></pre>
<p>在实体类添加构造方法</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookDaoImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BookDao</span> {
    <span class="hljs-keyword">private</span> String databaseName;
    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> connectionNum;

    <span class="hljs-keyword">public</span> <span class="hljs-title function_">BookDaoImpl</span><span class="hljs-params">(String databaseName, <span class="hljs-type">int</span> connectionNum)</span> {
        <span class="hljs-built_in">this</span>.databaseName = databaseName;
        <span class="hljs-built_in">this</span>.connectionNum = connectionNum;
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"book dao save ..."</span>+databaseName+<span class="hljs-string">","</span>+connectionNum);
    }
}
</code></pre>
<blockquote>
<p>在配置类中，可以添加type属性，按照类型注入，也可以添加index属性，按照索引下标注入</p>
</blockquote>
<h5 data-id="heading-43">&lt;5&gt; 自动装配</h5>
<p>在配置文件中，可以直接添加<code>autowire</code>属性进行注入</p>
<pre><code class="hljs language-java" lang="java">    &lt;bean class=<span class="hljs-string">"com.itheima.dao.impl.BookDaoImpl"</span>/&gt;
    &lt;bean id=<span class="hljs-string">"bookService"</span> class=<span class="hljs-string">"com.itheima.service.impl.BookServiceImpl"</span> autowire=<span class="hljs-string">"byType"</span>/&gt;
</code></pre>
<blockquote>
<p>autowire属性可以按照类型(byType），可以按照名称(byName)
使用按类型装配时（byType）必须保障容器中相同类型的bean唯一，推荐使用
使用按名称装配时（byName）必须保障容器中具有指定名称的bean，因变量名与配置耦合，不推荐使用
自动装配优先级低于setter注入与构造器注入，同时出现时自动装配配置失效</p>
</blockquote>
<h5 data-id="heading-44">&lt;6&gt; 集合注入</h5>
<p>在配置类中直接注入即可</p>
<p>注入数组类型数据</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"array"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">array</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>100<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>200<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>300<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">array</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
</code></pre>
<p>注入List类型数据</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"list"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>itcast<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>itheima<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>boxuegu<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>chuanzhihui<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
</code></pre>
<p>注入Set类型数据</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"set"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">set</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>itcast<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>itheima<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>boxuegu<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>boxuegu<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">set</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
</code></pre>
<p>注入Map类型数据</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"map"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">map</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"country"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"china"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"province"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"henan"</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"city"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"kaifeng"</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">map</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
</code></pre>
<p>注入Properties类型数据</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"properties"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">props</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">prop</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"country"</span>&gt;</span>china<span class="hljs-tag">&lt;/<span class="hljs-name">prop</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">prop</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"province"</span>&gt;</span>henan<span class="hljs-tag">&lt;/<span class="hljs-name">prop</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">prop</span> <span class="hljs-attr">key</span>=<span class="hljs-string">"city"</span>&gt;</span>kaifeng<span class="hljs-tag">&lt;/<span class="hljs-name">prop</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">props</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
</code></pre>
<p>实现类</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookDaoImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BookDao</span> {

    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span>[] array;

    <span class="hljs-keyword">private</span> List&lt;String&gt; list;

    <span class="hljs-keyword">private</span> Set&lt;String&gt; set;

    <span class="hljs-keyword">private</span> Map&lt;String,String&gt; map;

    <span class="hljs-keyword">private</span> Properties properties;

     <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"book dao save ..."</span>);

        System.out.println(<span class="hljs-string">"遍历数组:"</span> + Arrays.toString(array));

        System.out.println(<span class="hljs-string">"遍历List"</span> + list);

        System.out.println(<span class="hljs-string">"遍历Set"</span> + set);

        System.out.println(<span class="hljs-string">"遍历Map"</span> + map);

        System.out.println(<span class="hljs-string">"遍历Properties"</span> + properties);
    }
}
</code></pre>
<h4 data-id="heading-45">(2) 注解写法和注意事项</h4>
<h5 data-id="heading-46">&lt;1&gt; 知识点速览</h5>
<p>知识点1：@Autowired</p>

























<table><thead><tr><th>名称</th><th>@Autowired</th></tr></thead><tbody><tr><td>类型</td><td>属性注解  或  方法注解（了解）  或  方法形参注解（了解）</td></tr><tr><td>位置</td><td>构造方法、setter方法、字段、配置方法上  或  方法形参前面</td></tr><tr><td>作用</td><td>为引用类型属性设置值</td></tr><tr><td>属性</td><td>required：true/false，定义该属性是否允许为null</td></tr></tbody></table>
<p>知识点2：@Qualifier</p>

























<table><thead><tr><th>名称</th><th>@Qualifier</th></tr></thead><tbody><tr><td>类型</td><td>属性注解  或  方法注解（了解）</td></tr><tr><td>位置</td><td>属性定义上方  或  标准set方法上方  或  类set方法上方</td></tr><tr><td>作用</td><td>为引用类型属性指定注入的beanId</td></tr><tr><td>属性</td><td>value（默认）：设置注入的beanId</td></tr></tbody></table>
<p>知识点3：@Value</p>

























<table><thead><tr><th>名称</th><th>@Value</th></tr></thead><tbody><tr><td>类型</td><td>属性注解  或  方法注解（了解）</td></tr><tr><td>位置</td><td>属性定义上方  或  标准set方法上方  或  类set方法上方</td></tr><tr><td>作用</td><td>为  基本数据类型  或  字符串类型  属性设置值</td></tr><tr><td>属性</td><td>value（默认）：要注入的属性值</td></tr></tbody></table>
<p>知识点4：@PropertySource</p>

























<table><thead><tr><th>名称</th><th>@PropertySource</th></tr></thead><tbody><tr><td>类型</td><td>类注解</td></tr><tr><td>位置</td><td>类定义上方</td></tr><tr><td>作用</td><td>加载properties文件中的属性值</td></tr><tr><td>属性</td><td>value（默认）：设置加载的properties文件对应的文件名或文件名组成的数组</td></tr></tbody></table>
<h5 data-id="heading-47">&lt;2&gt; 改进方案</h5>
<p>通过使用注解，可以按照类型、名称、数据类型，甚至可以读取properties配置文件</p>
<p><strong>按照类型注入</strong></p>
<p>使用<code>@Autowired</code>注解开启自动装配模式</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BookService</span>{
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> BookDao bookDao;
    
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">()</span>{
        System.out.println(<span class="hljs-string">"save"</span>);
        bookDao.save();
    }
}
</code></pre>
<blockquote>
<p>基于反射设计常见对象，无需提供setter方法，建议使用无参构造方法构建对象</p>
</blockquote>
<p><strong>按照名称注入</strong></p>
<p>使用<code>@Qualifier</code>注解开启指定名称装配bean</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BookService</span>{
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-meta">@Qualifier("bookDao")</span>
    <span class="hljs-keyword">private</span> BookDao bookDao;
}
</code></pre>
<ul>
<li><code>@Qualifier</code>注解无法单独使用，必须配合<code>@Autowired</code>注解使用</li>
</ul>
<p><strong>简单数据类型注入</strong></p>
<p>使用<code>@Value</code>实现简单类型注入</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Repository("bookDao")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookDaoImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BookDao</span>{
    <span class="hljs-meta">@Value("100")</span>
    <span class="hljs-keyword">private</span> String connectionNum;
}
</code></pre>
<p><strong>注解读取properties配置文件</strong></p>
<p>对于如<code>@Qualifier</code>、<code>@Value</code>这种注解，为了防止写死，可以放到properties文件内</p>
<p><strong>使用方法</strong>：</p>
<p>使用<code>@PropertySource</code>注解加载properties文件</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@ComponentScan("com.itheima")</span>
<span class="hljs-meta">@PropertySource("classpath:jdbc.properties")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringConfig</span>{
}
</code></pre>
<p><strong>注意:</strong></p>
<ul>
<li>
<p>如果读取的properties配置文件有多个，可以使用<code>@PropertySource</code>的属性来指定多个</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PropertySource({"jdbc.properties","xxx.properties"})</span>
</code></pre>
</li>
<li>
<p><code>@PropertySource</code>注解属性中不支持使用通配符<code>*</code>,运行会报错</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PropertySource({"*.properties"})</span>
</code></pre>
</li>
<li>
<p><code>@PropertySource</code>注解属性中可以把<code>classpath:</code>加上,代表从当前项目的根路径找文件</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@PropertySource({"classpath:jdbc.properties"})</span>
</code></pre>
</li>
</ul>
<h2 data-id="heading-48">4.AOP相关内容</h2>
<p>AOP(Aspect Oriented Programming)面向切面编程，一种编程范式，指导开发者如何组织程序结构,它可以在不惊动原始设计的基础上为其进行功能增强。</p>
<p>在这里主要学习<code>AOP核心概念</code>和<code>AOP作用</code>，如<code>AOP工作流程</code>、<code>AOP配置管理</code>、<code>AOP事务管理</code></p>
<h3 data-id="heading-49">(1) AOP的核心概念</h3>
<p>概念：AOP(Aspect Oriented Programming)面向切面编程，一种编程范式</p>
<p>作用：在不惊动原始设计的基础上为方法进行功能==增强==</p>
<p>核心概念：</p>
<ul>
<li>代理（Proxy）：SpringAOP的核心本质是采用代理模式实现的</li>
<li>连接点（JoinPoint）：在SpringAOP中，理解为任意方法的执行</li>
<li>切入点（Pointcut）：匹配连接点的式子，也是具有共性功能的方法描述</li>
<li>通知（Advice）：若干个方法的共性功能，在切入点处执行，最终体现为一个方法</li>
<li>切面（Aspect）：描述通知与切入点的对应关系</li>
<li>目标对象（Target）：被代理的原始对象成为目标对象</li>
</ul>
<p>目标对象是要增强的类对应的对象，也叫原始对象。</p>
<p>SpringAOP中式不改变原有代码前提进行增强的，采用的是代理模式，因此对原始对象进行增强，需要对原始方法创建代理对象，在代理对象中的方法把通知加进去，实现了增强，这就是代理。</p>
<h3 data-id="heading-50">(2)  基于注解实现步骤</h3>
<h4 data-id="heading-51">&lt;1&gt; 知识点一览</h4>
<p>知识点1：@EnableAspectJAutoProxy</p>





















<table><thead><tr><th>名称</th><th>@EnableAspectJAutoProxy</th></tr></thead><tbody><tr><td>类型</td><td>配置类注解</td></tr><tr><td>位置</td><td>配置类定义上方</td></tr><tr><td>作用</td><td>开启注解格式AOP功能</td></tr></tbody></table>
<p>知识点2：@Aspect</p>





















<table><thead><tr><th>名称</th><th>@Aspect</th></tr></thead><tbody><tr><td>类型</td><td>类注解</td></tr><tr><td>位置</td><td>切面类定义上方</td></tr><tr><td>作用</td><td>设置当前类为AOP切面类</td></tr></tbody></table>
<p>知识点3：@Pointcut</p>

























<table><thead><tr><th>名称</th><th>@Pointcut</th></tr></thead><tbody><tr><td>类型</td><td>方法注解</td></tr><tr><td>位置</td><td>切入点方法定义上方</td></tr><tr><td>作用</td><td>设置切入点方法</td></tr><tr><td>属性</td><td>value（默认）：切入点表达式</td></tr></tbody></table>
<p>知识点4：@Before</p>





















<table><thead><tr><th>名称</th><th>@Before</th></tr></thead><tbody><tr><td>类型</td><td>方法注解</td></tr><tr><td>位置</td><td>通知方法定义上方</td></tr><tr><td>作用</td><td>设置当前通知方法与切入点之间的绑定关系，当前通知方法在原始切入点方法前运行</td></tr></tbody></table>
<h4 data-id="heading-52">&lt;2&gt; 准备工作</h4>
<p><strong>准备工作</strong>：创建Maven项目，添加依赖，实现类，配置类，运行类</p>
<p><strong>思路分析</strong>：添加依赖，定义接口与实现类，定义通知类和通知，定义切入点，制作切面,将通知类配给容器，并标识为切面类，开启注解格式AOP功能</p>
<h4 data-id="heading-53">&lt;3&gt; 实现步骤</h4>
<p>添加依赖</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.aspectj<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>aspectjweaver<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.9.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<blockquote>
<p>在<code>spring-context</code>中自动导入了<code>spring-aop</code>，这里是AspectJ，是AOP思想的具体实现</p>
</blockquote>
<p>接口与实现类</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BookDao</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">()</span>;
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span>;
}

<span class="hljs-meta">@Repository</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BookDaoImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BookDao</span> {

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">save</span><span class="hljs-params">()</span> {
        System.out.println(System.currentTimeMillis());
        System.out.println(<span class="hljs-string">"book dao save ..."</span>);
    }

    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">update</span><span class="hljs-params">()</span>{
        System.out.println(<span class="hljs-string">"book dao update ..."</span>);
    }
}
</code></pre>
<p>定义通知类和通知</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAdvice</span> {
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span>{
        System.out.println(System.currentTimeMillis());
    }
}
</code></pre>
<p>定义切入点(增强update方法)</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAdvice</span> {
    <span class="hljs-meta">@Pointcut("execution(void com.Coolipa.dao.BookDao.update())")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pt</span><span class="hljs-params">()</span>{}
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span>{
        System.out.println(System.currentTimeMillis());
    }
}
</code></pre>
<p>制作切面</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAdvice</span> {
    <span class="hljs-meta">@Pointcut("execution(void com.itheima.dao.BookDao.update())")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pt</span><span class="hljs-params">()</span>{}
    
    <span class="hljs-meta">@Before("pt()")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span>{
        System.out.println(System.currentTimeMillis());
    }
}
</code></pre>
<p>将通知类配给容器并表示为切面类</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAdvice</span> {
    <span class="hljs-meta">@Pointcut("execution(void com.itheima.dao.BookDao.update())")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pt</span><span class="hljs-params">()</span>{}
    
    <span class="hljs-meta">@Before("pt()")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">method</span><span class="hljs-params">()</span>{
        System.out.println(System.currentTimeMillis());
    }
}
</code></pre>
<p>开启注解AOP功能</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@ComponentScan("com.itheima")</span>
<span class="hljs-meta">@EnableAspectJAutoProxy</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringConfig</span> {
}
</code></pre>
<p>运行程序即可</p>
<h3 data-id="heading-54">(3) AOP工作流程</h3>
<ol>
<li>Spring容器启动，加载bean(需要被增强的类，通知类)，此时bean还没创建</li>
<li>读取所有切面配置中的切入点</li>
<li>初始化bean，将要被实例化bean对象的类中的方法和切入点进行匹配
<ul>
<li>匹配失败，创建原始对象，直接调用原始对象的方法</li>
<li>匹配成功，创建原始对象的代理对象，对其中的方法进行加强</li>
</ul>
</li>
<li>获取bean的执行方法
<ul>
<li>获取bean是原始对象时，调用方法并执行，完成操作</li>
<li>获取bean时代理对象是，运行原始方法与增强的内容，完成操作</li>
</ul>
</li>
</ol>
<h3 data-id="heading-55">(4) AOP配置管理</h3>
<p>这里主要是<code>切入点表达式</code>、<code>AOP通知类型</code>、<code>书写技巧</code></p>
<h4 data-id="heading-56">&lt;1&gt; 切入点表达式</h4>
<ul>
<li>切入点：要被增强的方法</li>
<li>切入点表达式：要进行增强方法的描述方式</li>
</ul>
<blockquote>
<p>切入点表达式格式：execution([修饰符] 返回类型 [声明类型].方法名(参数) [throws 异常])</p>
</blockquote>
<ul>
<li><code>[]</code> 表示可选部分</li>
<li>修饰符：public、private等，通常省略</li>
<li>返回类型：方法返回值类型，使用<code>*</code>匹配任意类型</li>
<li>包名.类名：完整的类路径，可以使用<code>..</code>匹配多级包</li>
<li>方法名：具体方法名，可以使用<code>*</code>通配符</li>
<li>参数：参数类型列表，<code>()</code>表示无参数，<code>(..)</code>表示任意参数</li>
</ul>

<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-built_in">execution</span>(<span class="hljs-keyword">public</span> User com.example.service.UserService.<span class="hljs-built_in">findById</span>(<span class="hljs-type">int</span>))
</code></pre>
<ul>
<li><code>*</code>：通配符，可以单独出现，可以作为前后缀</li>
<li><code>..</code>：通配符，多个连续的任意符号，用于简化包名与参数书写</li>
<li><code>+</code>：通配符，匹配子类类型</li>
</ul>
<p><strong>注意事项</strong>：</p>
<ol>
<li>按<strong>标准规范</strong>开发</li>
<li>查询操作的返回值建议使用*匹配</li>
<li>减少使用..的形式描述包</li>
<li><strong>对接口进行描述</strong>，使用*表示模块名，例如UserService的匹配描述为*Service</li>
<li>方法名书写保留动词，例如get，使用*表示名词，例如getById匹配描述为getBy*</li>
<li>参数根据实际情况灵活调整</li>
</ol>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-java" lang="java">execution(<span class="hljs-keyword">void</span> com.itheima.dao.BookDao.update())
匹配接口，能匹配到
execution(<span class="hljs-keyword">void</span> com.itheima.dao.impl.BookDaoImpl.update())
匹配实现类，能匹配到
execution(* com.itheima.dao.impl.BookDaoImpl.update())
返回值任意，能匹配到
execution(* com.itheima.dao.impl.BookDaoImpl.update(*))
返回值任意，但是update方法必须要有一个参数，无法匹配，要想匹配需要在update接口和实现类添加参数
execution(<span class="hljs-keyword">void</span> com.*.*.*.*.update())
返回值为<span class="hljs-keyword">void</span>,com包下的任意包三层包下的任意类的update方法，匹配到的是实现类，能匹配
execution(<span class="hljs-keyword">void</span> com.*.*.*.update())
返回值为<span class="hljs-keyword">void</span>,com包下的任意两层包下的任意类的update方法，匹配到的是接口，能匹配
execution(<span class="hljs-keyword">void</span> *..update())
返回值为<span class="hljs-keyword">void</span>，方法名是update的任意包下的任意类，能匹配
execution(* *..*(..))
匹配项目中任意类的任意方法，能匹配，但是不建议使用这种方式，影响范围广
execution(* *..u*(..))
匹配项目中任意包任意类下只要以u开头的方法，update方法能满足，能匹配
execution(* *..*e(..))
匹配项目中任意包任意类下只要以e结尾的方法，update和save方法能满足，能匹配
execution(<span class="hljs-keyword">void</span> com..*())
返回值为<span class="hljs-keyword">void</span>，com包下的任意包任意类任意方法，能匹配，*代表的是方法
execution(* com.itheima.*.*Service.find*(..))
将项目中所有业务层方法的以find开头的方法匹配
execution(* com.itheima.*.*Service.save*(..))
将项目中所有业务层方法的以save开头的方法匹配
</code></pre>
<h4 data-id="heading-57">&lt;2&gt; AOP通知类型</h4>
<h6 data-id="heading-58">a.知识点总结</h6>
<ul>
<li>前置通知</li>
<li>后置通知</li>
<li>环绕通知（重点）
<ul>
<li>环绕通知依赖形参ProceedingJoinPoint才能实现对原始方法的调用</li>
<li>环绕通知可以隔离原始方法的调用执行</li>
<li>环绕通知返回值设置为Object类型</li>
<li>环绕通知中可以对原始方法调用过程中出现的异常进行处理</li>
</ul>
</li>
<li>返回后通知</li>
<li>抛出异常后通知</li>
</ul>
<p>知识点1：@After</p>





















<table><thead><tr><th>名称</th><th>@After</th></tr></thead><tbody><tr><td>类型</td><td>方法注解</td></tr><tr><td>位置</td><td>通知方法定义上方</td></tr><tr><td>作用</td><td>设置当前通知方法与切入点之间的绑定关系，当前通知方法在原始切入点方法后运行</td></tr></tbody></table>
<p>知识点2：@AfterReturning</p>





















<table><thead><tr><th>名称</th><th>@AfterReturning</th></tr></thead><tbody><tr><td>类型</td><td>方法注解</td></tr><tr><td>位置</td><td>通知方法定义上方</td></tr><tr><td>作用</td><td>设置当前通知方法与切入点之间绑定关系，当前通知方法在原始切入点方法正常执行完毕后执行</td></tr></tbody></table>
<p>知识点3：@AfterThrowing</p>





















<table><thead><tr><th>名称</th><th>@AfterThrowing</th></tr></thead><tbody><tr><td>类型</td><td>方法注解</td></tr><tr><td>位置</td><td>通知方法定义上方</td></tr><tr><td>作用</td><td>设置当前通知方法与切入点之间绑定关系，当前通知方法在原始切入点方法运行抛出异常后执行</td></tr></tbody></table>
<p>知识点4：@Around</p>





















<table><thead><tr><th>名称</th><th>@Around</th></tr></thead><tbody><tr><td>类型</td><td>方法注解</td></tr><tr><td>位置</td><td>通知方法定义上方</td></tr><tr><td>作用</td><td>设置当前通知方法与切入点之间的绑定关系，当前通知方法在原始切入点方法前后运行</td></tr></tbody></table>
<h6 data-id="heading-59">b. 实现</h6>
<p>修改MyAdvice，在方法上加上对应注解即可,前置<code>@Before</code>、后置<code>@After</code>、环绕<code>@Around</code>、返回后通知<code>@AfterReturning</code>、异常后通知<code>@AfterThrowing  </code></p>
<p><strong>前置通知示例</strong>：除了环绕通知，其他基本如下</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Component</span>
<span class="hljs-meta">@Aspect</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MyAdvice</span> {
    <span class="hljs-meta">@Pointcut("execution(void com.itheima.dao.BookDao.update())")</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pt</span><span class="hljs-params">()</span>{}
    
    <span class="hljs-meta">@Before("pt()")</span>
    <span class="hljs-comment">//此处也可以写成 @Before("MyAdvice.pt()"),不建议</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">before</span><span class="hljs-params">()</span> {
        System.out.println(<span class="hljs-string">"before advice ..."</span>);
    }
}
</code></pre>
<p><strong>环绕通知</strong>：</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@Around("pt2()")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">aroundSelect</span><span class="hljs-params">(ProceedingJoinPoint pjp)</span> <span class="hljs-keyword">throws</span> Throwable {
        System.out.println(<span class="hljs-string">"around before advice ..."</span>);
        <span class="hljs-comment">//表示对原始操作的调用</span>
        <span class="hljs-type">Object</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> pjp.proceed();
        System.out.println(<span class="hljs-string">"around after advice ..."</span>);
        <span class="hljs-keyword">return</span> ret;
    }
</code></pre>
<p><strong>环绕通知注意事项</strong></p>
<ol>
<li><strong>必须使用ProceedingJoinPoint</strong>：环绕通知必须依赖<code>ProceedingJoinPoint</code>参数才能调用原始方法</li>
<li><strong>必须调用proceed()</strong>：如果不调用<code>pjp.proceed()</code>，原始方法将被跳过</li>
<li><strong>返回值类型</strong>：建议设置为<code>Object</code>类型以兼容各种返回值</li>
<li><strong>异常处理</strong>：必须处理<code>Throwable</code>异常，因为无法预知原始方法是否会抛出异常</li>
<li><strong>void方法处理</strong>：即使原始方法返回void，环绕通知也可以返回Object或void</li>
</ol>
<p>示例：</p>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Around("pt()")</span>
<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">around</span><span class="hljs-params">(ProceedingJoinPoint pjp)</span> <span class="hljs-keyword">throws</span> Throwable {
    <span class="hljs-comment">// 前置逻辑</span>
    <span class="hljs-type">Object</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> pjp.proceed(); <span class="hljs-comment">// 调用原始方法</span>
    <span class="hljs-comment">// 后置逻辑</span>
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<h4 data-id="heading-60">&lt;3&gt; AOP通知获取参数</h4>
<p><strong>准备工作</strong>：Maven项目，依赖，实现类，配置类，通知类</p>
<p><strong>思路分析</strong>：通过<code>JoinPoint</code>获得参数，通过<code>getArgs()</code>从环绕通知获得参数，通过<code>AfterReturning</code>和<code>Around</code>获得返回值，通过<code>AfterThrowing</code>和<code>Around</code>获得异常</p>
<h5 data-id="heading-61">(1) 获取参数(⭐)</h5>
<p><strong>非环绕通知获取方式</strong></p>
<p>此方法适用于<code>前置</code>、<code>后置</code>、<code>返回后</code>、<code>抛出异常后</code>通知。</p>
<ul>
<li>JoinPoint对象描述了连接点方法的运行状态，可以获取到原始方法的调用参数</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Before("pt()")</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">before</span><span class="hljs-params">(JoinPoint jp)</span>{
    Object[] args = jp.getArgs();
    System.out.println(Arrays.toString(args));
}
</code></pre>
<p><strong>环绕通知获取方式</strong></p>
<p>通过<code>getArgs()</code>方法获取</p>
<ul>
<li>ProceedJointPoint是JoinPoint的子类</li>
</ul>
<pre><code class="hljs language-java" lang="java"><span class="hljs-meta">@Around("pt()")</span>
<span class="hljs-keyword">public</span> Object <span class="hljs-title function_">around</span><span class="hljs-params">(ProceedingJoinPoint pjp)</span> <span class="hljs-keyword">throws</span> Throwable {
    Object[] args = pjp.getArgs();
    System.out.println(Arrays.toString(args));
    <span class="hljs-type">Object</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> pjp.proceed();
    <span class="hljs-keyword">return</span> ret;
}
</code></pre>
<h5 data-id="heading-62">(2) 获取返回值</h5>
<p>只有返回后<code>AfterReturing</code>和环绕<code>Around</code>这两个通知类型可以获取</p>
<p><strong>环绕通知获取返回值</strong></p>
<blockquote>
<p><code>ret</code>是方法的返回值</p>
</blockquote>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@Around("pt()")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">around</span><span class="hljs-params">(ProceedingJoinPoint pjp)</span> <span class="hljs-keyword">throws</span> Throwable{
        Object[] args = pjp.getArgs();
        System.out.println(Arrays.toString(args));
        args[<span class="hljs-number">0</span>] = <span class="hljs-number">666</span>;
        <span class="hljs-type">Object</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> pjp.proceed(args);
        <span class="hljs-keyword">return</span> ret;
    }
</code></pre>
<p><strong>返回后通知获取返回值</strong></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@AfterReturning(value = "pt()",returning = "ret")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterReturning</span><span class="hljs-params">(Object ret)</span> {
        System.out.println(<span class="hljs-string">"afterReturning advice ..."</span>+ret);
    }
</code></pre>
<h5 data-id="heading-63">(3) 获取异常(了解)</h5>
<p>只有抛出异常后<code>AfterThrowing</code>和环绕<code>Around</code>这两个通知类型可以获取</p>
<p><strong>环绕通知获取异常</strong></p>
<p>将异常捕获即可</p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@Around("pt()")</span>
    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">around</span><span class="hljs-params">(ProceedingJoinPoint pjp)</span>{
        Object[] args = pjp.getArgs();
        System.out.println(Arrays.toString(args));
        args[<span class="hljs-number">0</span>] = <span class="hljs-number">666</span>;
        <span class="hljs-type">Object</span> <span class="hljs-variable">ret</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;
        <span class="hljs-keyword">try</span>{
            ret = pjp.proceed(args);
        }<span class="hljs-keyword">catch</span>(Throwable throwable){
            t.printStackTrace();
        }
        <span class="hljs-keyword">return</span> ret;
    }
</code></pre>
<p><strong>获取异常</strong></p>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-meta">@AfterThrowing(value = "pt()",throwing = "t")</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterThrowing</span><span class="hljs-params">(Throwable t)</span> {
        System.out.println(<span class="hljs-string">"afterThrowing advice ..."</span>+t);
    }
</code></pre>
<h3 data-id="heading-64">(5) AOP事务管理</h3>
<h4 data-id="heading-65">&lt;1&gt; 知识点总览</h4>
<p>事务：在数据层或业务层保障一系列的数据库操作同成功失败
通过<code>@Transactional</code>注解实现，可拓展属性
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6bb56582307c4486b7f344795d06b1af~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LaF57qn6Ium5Yqb5oCV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763450740&amp;x-signature=u0dk25zFwp8U8R4VFLwza9upOws%3D" alt="在这里插入图片描述" loading="lazy"/></p>
<h4 data-id="heading-66">&lt;2&gt; 概念</h4>
<ul>
<li>事务作用：在数据层保障一系列的数据库操作同成功同失败</li>
<li>Spring事务作用：在数据层或<strong>业务层</strong>保障一系列的数据库操作同成功同失败</li>
</ul>
<h4 data-id="heading-67">&lt;3&gt; 快速使用</h4>
<p>在Spring中，提供了<code>PlatformTransactionManager</code>平台事务管理器</p>
<ol>
<li>
<p>在方法上添加<code>@Transactional</code>注解</p>
<pre><code class="hljs language-java" lang="java">	<span class="hljs-meta">@Transactional</span>
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">transfer</span><span class="hljs-params">(String out,String in ,Double money)</span> {
        accountDao.outMoney(out,money);
        <span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>/<span class="hljs-number">0</span>;
        accountDao.inMoney(in,money);
    }
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7cee5cb3b4354b7b9aae80a0aef281bd~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6LaF57qn6Ium5Yqb5oCV:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763450740&amp;x-signature=ctcHrrQgpztT5YNXZMu%2FBDKfTqY%3D" alt="在这里插入图片描述" loading="lazy"/></p>
</li>
</ol>
<p>上面这些属性都可以在<code>@Transactional</code>注解的参数上进行设置。</p>
<ul>
<li>
<p>readOnly：true只读事务，false读写事务，增删改要设为false,查询设为true。</p>
</li>
<li>
<p>timeout:设置超时时间单位秒，在多长时间之内事务没有提交成功就自动回滚，-1表示不设置超时时间。</p>
</li>
<li>
<p>rollbackFor:当出现指定异常进行事务回滚</p>
</li>
<li>
<p>noRollbackFor:当出现指定异常不进行事务回滚</p>
</li>
</ul>
<ol start="2">
<li>在Config类中配置事务管理器</li>
</ol>
<pre><code class="hljs language-java" lang="java">    <span class="hljs-comment">//配置事务管理器，mybatis使用的是jdbc事务</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-keyword">public</span> PlatformTransactionManager <span class="hljs-title function_">transactionManager</span><span class="hljs-params">(DataSource dataSource)</span>{
        <span class="hljs-type">DataSourceTransactionManager</span> <span class="hljs-variable">transactionManager</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DataSourceTransactionManager</span>(dataSource);
        transactionManager.setDataSource(dataSource);
        <span class="hljs-keyword">return</span> transactionManager;
    }
</code></pre>
<ol start="3">
<li>在配置类中开启即可</li>
</ol>
<pre><code class="hljs language-java" lang="java"><span class="hljs-comment">//开启注解式事务驱动</span>
<span class="hljs-meta">@EnableTransactionManagement</span>
<span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SpringConfig</span> {
}
</code></pre>
<p>@Transactional可以写在接口类上、接口方法上、实现类上和实现类方法上</p>
<ul>
<li>写在接口类上，该接口的所有实现类的所有方法都会有事务</li>
<li>写在接口方法上，该接口的所有实现类的该方法都会有事务</li>
<li>写在实现类上，该类中的所有方法都会有事务</li>
<li>写在实现类方法上，该方法上有事务</li>
<li>建议写在实现类或实现类的方法上</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何在本地部署腾讯混元大模型并连接到 Elasticsearch 进行使用]]></title>    <link>https://juejin.cn/post/7570999443446726692</link>    <guid>https://juejin.cn/post/7570999443446726692</guid>    <pubDate>2025-11-11T06:36:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7570999443446726692" data-draft-id="7571005216910802963" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何在本地部署腾讯混元大模型并连接到 Elasticsearch 进行使用"/> <meta itemprop="keywords" content="Elasticsearch"/> <meta itemprop="datePublished" content="2025-11-11T06:36:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Elasticsearch"/> <meta itemprop="url" content="https://juejin.cn/user/2612095360441448"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何在本地部署腾讯混元大模型并连接到 Elasticsearch 进行使用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2612095360441448/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Elasticsearch
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2025-11-11T06:36:32.000Z" title="Tue Nov 11 2025 06:36:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2025-11-11
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/695b250221354a71a4c49df39e76e522~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447791&amp;x-signature=hegcqwKQ106I5bnkix18GQOFIls%3D" alt="" loading="lazy"/></p>
<p>腾讯混元大模型由腾讯公司全链路自研，在高质量的内容创作、数理逻辑、代码生成、多轮对话、图像与视频生产上性能表现优越，处于业界领先水平。我一直想在我自己的电脑上安装并试用。在本文中，我将详细描述安装过程并连接到 Elasticsearch。</p>
<blockquote>
<p><strong>注意</strong>：一下展示使用最新的 Elastic Stack 9.2.0。其界面可能和之前的有的版本有所不同。</p>
</blockquote>
<h2 data-id="heading-0">安装混元大模型</h2>
<p>我希望使用 Ollama 来进行安装。很可惜，目前混元大模型还不支持 <a href="https://link.juejin.cn?target=https%3A%2F%2Follama.com%2Fsearch" title="https://ollama.com/search" target="_blank" ref="nofollow noopener noreferrer">Ollama</a> 按照。我在国内的网站上搜索了一下，很少有详细介绍如何安装的。腾讯混元-4B（及更小的变体）可以与 Ollama 一起使用，但目前还不能直接开箱即用。你需要使用与 llama.cpp 兼容的 GGUF 量化版本，然后将其包装为自定义 Ollama 模型。</p>
<p>Ollama 使用 llama.cpp 引擎，它支持 GGUF 格式的模型 —— 包括经过转换或已下载为 GGUF 格式的 Hunyuan-4B。</p>
<p>Hugging Face 上已经有一个可直接使用的量化版本：<a href="https://link.juejin.cn?target=https%3A%2F%2Fhuggingface.co%2Fmradermacher%2FHunyuan-4B-Instruct-GGUF%3Futm_source%3Dchatgpt.com" title="https://huggingface.co/mradermacher/Hunyuan-4B-Instruct-GGUF?utm_source=chatgpt.com" target="_blank" ref="nofollow noopener noreferrer">mradermacher/Hunyuan-4B-Instruct-GGUF</a></p>
<p>详细安装步骤：</p>
<h3 data-id="heading-1"><strong>步骤 1：安装 Ollama</strong></h3>
<p>从 <a href="https://link.juejin.cn?target=https%3A%2F%2Follama.com%2Fdownload" title="https://ollama.com/download" target="_blank" ref="nofollow noopener noreferrer">Download Ollama on macOS</a> 下载适用于 macOS、Windows 或 Linux 的 Ollama。</p>
<p>按照安装程序的指引完成安装，安装完成后，在终端运行以下命令进行验证：</p>
<pre><code class="hljs language-css" lang="css">`ollama <span class="hljs-attr">--version</span>`AI写代码
</code></pre>

<pre><code class="hljs language-markdown" lang="markdown">`

<span class="hljs-bullet">1.</span>  $ ollama --version
<span class="hljs-bullet">2.</span>  ollama version is 0.12.9

`AI写代码
</code></pre>
<h3 data-id="heading-2"><strong>步骤 2：下载</strong> GGUF model</h3>
<p>从这些版本中选择一个（例如 Q4_K_M，以平衡质量和速度）：</p>
<pre><code class="hljs language-bash" lang="bash">`

1.  <span class="hljs-built_in">mkdir</span> -p ~/.ollama/models/hunyuan-4b
2.  <span class="hljs-built_in">cd</span> ~/.ollama/models/hunyuan-4b
3.  curl -L -O https://huggingface.co/mradermacher/Hunyuan-4B-Instruct-GGUF/resolve/main/Hunyuan-4B-Instruct.Q4_K_M.gguf

`AI写代码
</code></pre>

<pre><code class="hljs language-bash" lang="bash">`

1.  $ <span class="hljs-built_in">ls</span> .ollama/models/
2.  blobs     manifests
3.  $ <span class="hljs-built_in">mkdir</span> -p ~/.ollama/models/hunyuan-4b
4.  $ <span class="hljs-built_in">ls</span> ~/.ollama/models
5.  blobs      hunyuan-4b manifests
6.  $ <span class="hljs-built_in">cd</span> ~/.ollama/models/hunyuan-4b
7.  $ curl -L -O https://huggingface.co/mradermacher/Hunyuan-4B-Instruct-GGUF/resolve/main/Hunyuan-4B-Instruct.Q4_K_M.gguf
8.    % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
9.                                   Dload  Upload   Total   Spent    Left  Speed
10.  100  1353  100  1353    0     0    966      0  0:00:01  0:00:01 --:--:--   966
11.  100 2486M  100 2486M    0     0  5854k      0  0:07:14  0:07:14 --:--:-- 4677k

`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>
<h3 data-id="heading-3">步骤 3 – 创建自定义 Modelfile</h3>
<p>在 ~/.ollama/models/hunyuan-4b/Modelfile 中创建以下内容：</p>
<pre><code class="hljs language-python" lang="python">`

<span class="hljs-number">1.</span>  FROM ./Hunyuan-4B-Instruct.Q4_K_M.gguf

<span class="hljs-number">3.</span>  PARAMETER temperature <span class="hljs-number">0.7</span>
<span class="hljs-number">4.</span>  PARAMETER top_p <span class="hljs-number">0.9</span>
<span class="hljs-number">5.</span>  PARAMETER num_ctx <span class="hljs-number">4096</span>

<span class="hljs-number">7.</span>  TEMPLATE <span class="hljs-string">"""{{ .System }}
8.  User: {{ .Prompt }}
9.  Assistant:"""</span>

<span class="hljs-number">11.</span>  SYSTEM <span class="hljs-string">"You are Hunyuan, a helpful Chinese assistant developed by Tencent."</span>

`AI写代码![](https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png)
</code></pre>

<pre><code class="hljs language-bash" lang="bash">`$ vi ~/.ollama/models/hunyuan-4b/Modelfile` AI写代码
</code></pre>
<h3 data-id="heading-4">步骤 4 – 在 Ollama 中注册模型</h3>
<pre><code class="hljs language-bash" lang="bash">`ollama create hunyuan-4b -f ~/.ollama/models/hunyuan-4b/Modelfile` AI写代码
</code></pre>

<pre><code class="hljs language-markdown" lang="markdown">`1.  $ ollama create hunyuan-4b -f ~/.ollama/models/hunyuan-4b/Modelfile
<span class="hljs-bullet">2.</span>  gathering model components ⠸ 
<span class="hljs-bullet">3.</span>  gathering model components 
<span class="hljs-bullet">4.</span>  copying file sha256:def49bb81ddbecf7c2e3aa557716b915607c6fd3af7e73316c16464321d5da22 100% 
<span class="hljs-bullet">5.</span>  parsing GGUF 
<span class="hljs-bullet">6.</span>  using existing layer sha256:def49bb81ddbecf7c2e3aa557716b915607c6fd3af7e73316c16464321d5da22 
<span class="hljs-bullet">7.</span>  creating new layer sha256:8e48700b8cb5619c3a31e83a13a321070a62ee259d91e1b81b1d2b9eda4a459f 
<span class="hljs-bullet">8.</span>  creating new layer sha256:7127d492f5e2ee2a8d4fbfd439094e35f3c13ebc9f07f6e9c9fd64f9cc243f16 
<span class="hljs-bullet">9.</span>  creating new layer sha256:dedcbf3159e051675ba89642680de2bbfcac020a3f2c1afde851e27629484659 
<span class="hljs-bullet">10.</span>  writing manifest 
<span class="hljs-bullet">11.</span>  success` AI写代码![](<span class="hljs-link">https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png</span>)
</code></pre>
<h3 data-id="heading-5">步骤 5 – 运行模型</h3>
<pre><code class="hljs language-arduino" lang="arduino">`ollama run hunyuan<span class="hljs-number">-4b</span>` AI写代码
</code></pre>

<pre><code class="hljs language-markdown" lang="markdown">`

<span class="hljs-bullet">1.</span>  $ ollama run hunyuan-4b
<span class="hljs-bullet">2.</span>  &gt;&gt;&gt; what is Elastic?
<span class="hljs-bullet">3.</span>   1. <span class="hljs-strong">**Definition:**</span> Elastic refers to the ability of an object or system to change shape or size in response to 
<span class="hljs-bullet">4.</span>  external forces without permanent deformation. In simpler terms, it means "bending" or "stretching".
<span class="hljs-bullet">5.</span>  2. <span class="hljs-strong">**Types of Elasticity:**</span>
<span class="hljs-bullet">6.</span>      * <span class="hljs-strong">**Elastic (or Young's Modulus):**</span> The property where an object returns to its original shape after the 
<span class="hljs-bullet">7.</span>  force is removed.
<span class="hljs-bullet">8.</span>      * <span class="hljs-strong">**Yield:**</span> When an object deforms permanently even without a constant force applied, it is called yield. A 
<span class="hljs-bullet">9.</span>  material that exhibits both elastic and yield properties is called "durable".
<span class="hljs-bullet">10.</span>  3. <span class="hljs-strong">**Applications of Elasticity in Physics:**</span>
<span class="hljs-bullet">11.</span>      * <span class="hljs-strong">**Coding (Elastic Database):**</span> Elastic is the name given to the database system by MongoDB.
<span class="hljs-bullet">12.</span>      * <span class="hljs-strong">**Engineering:**</span> Elasticity is used in designing structures like bridges, buildings, etc., ensuring they 
<span class="hljs-bullet">13.</span>  can withstand external forces without permanent deformation.
<span class="hljs-bullet">14.</span>      * <span class="hljs-strong">**Biology:**</span> Elastic tissues such as muscle and skin are involved in various functions in living organisms.
<span class="hljs-bullet">15.</span>  4. <span class="hljs-strong">**Elasticity in Software Engineering:**</span> The term "elastic" is often used to describe systems that have the 
<span class="hljs-bullet">16.</span>  ability to change their structure or behavior dynamically, adapting to changes in the environment or user input 
<span class="hljs-bullet">17.</span>  without a need for complex code modifications.
<span class="hljs-bullet">18.</span>  5. <span class="hljs-strong">**Elasticity in Physics (Reinforced Elasticity):**</span> A phenomenon where materials undergo multiple rounds of 
<span class="hljs-bullet">19.</span>  deformation before returning to their original shape (e.g., rubber bands). This is useful in applications like 
<span class="hljs-bullet">20.</span>  car tires, where repeated pressure and release causes small changes in the tire's shape, improving fuel 
<span class="hljs-bullet">21.</span>  efficiency.
<span class="hljs-bullet">22.</span>  <span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">think</span>&gt;</span></span>
<span class="hljs-bullet">23.</span>  <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">answer</span>&gt;</span></span>
<span class="hljs-bullet">24.</span>  Okay, let's break down what "Elastic" means.

<span class="hljs-bullet">26.</span>  1.  <span class="hljs-strong">**Core Definition:**</span> In a broad sense, "elasticity" refers to the property of an object or material that can 
<span class="hljs-bullet">27.</span>  change its shape or size when subjected to stress (force) and return to its original shape after the stress is 
<span class="hljs-bullet">28.</span>  removed.
<span class="hljs-bullet">29.</span>      *   Think of stretching a rubber band: it gets longer (deforms), and if you let go, it snaps back to its 
<span class="hljs-bullet">30.</span>  original length. That's elastic deformation.

<span class="hljs-bullet">32.</span>  2.  <span class="hljs-strong">**Types in Physics:**</span>
<span class="hljs-bullet">33.</span>      *   <span class="hljs-strong">**Elastic Deformation:**</span> The object returns to its original shape after the force is removed. Examples 
<span class="hljs-bullet">34.</span>  include a spring or a metal rod.
<span class="hljs-bullet">35.</span>      *   <span class="hljs-strong">**Yield (or Ductile Deformation):**</span> The object deforms permanently even without constant stress, and 
<span class="hljs-bullet">36.</span>  sometimes it will later return to some extent. A material that can undergo both elastic and yield deformation is 
<span class="hljs-bullet">37.</span>  called "ductile."
<span class="hljs-bullet">38.</span>      *   <span class="hljs-strong">**Plastic Deformation:**</span> Permanent shape changes that cannot be easily reversed by the removal of stress.

<span class="hljs-bullet">40.</span>  3.  <span class="hljs-strong">**Why Elasticity Matters (Applications):**</span>
<span class="hljs-bullet">41.</span>      *   <span class="hljs-strong">**Engineering &amp; Architecture:**</span> Designing buildings, bridges, and other structures allows for them to 
<span class="hljs-bullet">42.</span>  withstand external forces like wind, earthquakes, or traffic loads without collapsing permanently.
<span class="hljs-bullet">43.</span>      *   <span class="hljs-strong">**Biology:**</span> Muscles and skin are elastic tissues that allow movement and flexibility in living 
<span class="hljs-bullet">44.</span>  organisms.
<span class="hljs-bullet">45.</span>      *   <span class="hljs-strong">**Physics &amp; Chemistry (Elastic Bands):**</span> Used in demonstrations of elasticity, as mentioned 
<span class="hljs-bullet">46.</span>  above.
<span class="hljs-bullet">47.</span>      *   <span class="hljs-strong">**Materials Science:**</span> Understanding how different materials respond to stress helps in selecting the 
<span class="hljs-bullet">48.</span>  right material for specific applications.

<span class="hljs-bullet">50.</span>  4.  <span class="hljs-strong">**"Elastic" in Software Development:**</span>
<span class="hljs-bullet">51.</span>      *   While not a physical property like in physics or engineering, the term "elastic" is often used 
<span class="hljs-bullet">52.</span>  metaphorically in software development:
<span class="hljs-bullet">53.</span>          *   An <span class="hljs-strong">**Elastic Database**</span> (like MongoDB) is designed to scale up and down automatically when the number 
<span class="hljs-bullet">54.</span>  of users or data grows. It can handle increased load without requiring manual intervention from developers.
<span class="hljs-bullet">55.</span>          *   An <span class="hljs-strong">**Elastic System**</span> can adapt its behavior or structure dynamically in response to changes, making 
<span class="hljs-bullet">56.</span>  it more flexible and resilient than a rigid system.

<span class="hljs-bullet">58.</span>  In summary, "elastic" describes something that can stretch (or compress) and return to its original state. This 
<span class="hljs-bullet">59.</span>  property is crucial for many physical systems and also leads to the concept of scalable and adaptable software 
<span class="hljs-bullet">60.</span>  architectures.
<span class="hljs-bullet">61.</span>  <span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">answer</span>&gt;</span></span>

<span class="hljs-bullet">63.</span>  &gt;&gt;&gt; What is Elasticsearch?
<span class="hljs-bullet">64.</span>   Okay, let's break down what "Elasticsearch" means.

<span class="hljs-bullet">66.</span>  1.  <span class="hljs-strong">**Elastic as a Metaphor:**</span> The name comes from the Greek adjective "ellastos," meaning "to stretch." In the 
<span class="hljs-bullet">67.</span>  context of computing, it refers to the ability of software systems to scale and adapt dynamically without 
<span class="hljs-bullet">68.</span>  requiring manual intervention or complex code changes.
<span class="hljs-bullet">69.</span>  2.  <span class="hljs-strong">**Core Concept - Scalability &amp; Elasticity:**</span>
<span class="hljs-bullet">70.</span>      *   <span class="hljs-strong">**Scalability (Up-Scaling):**</span> The system can handle a significantly larger number of users or data volume 
<span class="hljs-bullet">71.</span>  without performance degradation or crashes. For example, when more people start using a web application, the 
<span class="hljs-bullet">72.</span>  database can automatically add more capacity.
<span class="hljs-bullet">73.</span>      *   <span class="hljs-strong">**Elasticity (Auto-Sharding &amp; Rebalancing):**</span> When the load on an Elasticsearch node decreases, it can 
<span class="hljs-bullet">74.</span>  remove resources from that node and move them to other nodes with less load. Conversely, if a node becomes 
<span class="hljs-bullet">75.</span>  overloaded, it can be assigned new clients or data chunks. This automatic distribution of work keeps the system 
<span class="hljs-bullet">76.</span>  balanced and responsive.

<span class="hljs-bullet">78.</span>  3.  <span class="hljs-strong">**Analogy:**</span> Think of your car's engine or brakes being "elastic." If you use more gas (stress), the engine 
<span class="hljs-bullet">79.</span>  heats up slightly. When you let off the gas and turn it off, the heat dissipates back to normal (returns to 
<span class="hljs-bullet">80.</span>  original state). Similarly, Elasticsearch manages its resources dynamically based on current load.

<span class="hljs-bullet">82.</span>  4.  <span class="hljs-strong">**Why Use Elasticsearch?**</span>
<span class="hljs-bullet">83.</span>      *   <span class="hljs-strong">**High Availability &amp; Fault Tolerance:**</span> It's designed for distributed systems, making it resilient even 
<span class="hljs-bullet">84.</span>  if some nodes or data shards fail.
<span class="hljs-bullet">85.</span>      *   <span class="hljs-strong">**Real-time Search and Analytics:**</span> It excels at quickly indexing large amounts of text (like website 
<span class="hljs-bullet">86.</span>  content) and retrieving relevant information in near real-time.
<span class="hljs-bullet">87.</span>      *   <span class="hljs-strong">**Distributed Nature:**</span> Data is sharded across many machines, allowing for massive storage and retrieval 
<span class="hljs-bullet">88.</span>  capabilities far beyond a single machine's limits.
<span class="hljs-bullet">89.</span>      *   <span class="hljs-strong">**Suitable for Log Data &amp; Large Datasets:**</span> It's commonly used to store and analyze logs from 
<span class="hljs-bullet">90.</span>  applications, servers, or IoT devices.

<span class="hljs-bullet">92.</span>  5.  <span class="hljs-strong">**Common Use Cases:**</span>
<span class="hljs-bullet">93.</span>      *   <span class="hljs-strong">**Search Engines (like Solr):**</span> Elasticsearch powers much of Google Search (as part of the search 
<span class="hljs-bullet">94.</span>  infrastructure).
<span class="hljs-bullet">95.</span>      *   <span class="hljs-strong">**Log Management &amp; Monitoring:**</span> Storing and analyzing application logs for performance monitoring and 
<span class="hljs-bullet">96.</span>  troubleshooting.
<span class="hljs-bullet">97.</span>      *   <span class="hljs-strong">**Data Indexing/Analysis:**</span> As a backend database for applications that need to perform complex queries 
<span class="hljs-bullet">98.</span>  or aggregations on large datasets.
<span class="hljs-bullet">99.</span>      *   <span class="hljs-strong">**Real-time Analytics Dashboards.**</span>

<span class="hljs-bullet">101.</span>  In essence, Elasticsearch is a distributed, fault-tolerant search engine designed for high scalability and 
<span class="hljs-bullet">102.</span>  elasticity in the context of data indexing, retrieval, and analysis. It's a fundamental technology for modern 
<span class="hljs-bullet">103.</span>  data-driven applications.
<span class="hljs-bullet">104.</span>  <span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">answer</span>&gt;</span></span>

<span class="hljs-bullet">106.</span>  &gt;&gt;&gt; 中国最长的河流是哪条河？
<span class="hljs-bullet">107.</span>   中国最长的河流是<span class="hljs-strong">**长江**</span>。

<span class="hljs-bullet">109.</span>  *   <span class="hljs-strong">**长度：**</span>约6,300公里。这是一条非常长的河流，也是亚洲第一长河。
<span class="hljs-bullet">110.</span>  *   <span class="hljs-strong">**流经地区：**</span>发源于青海省青藏高原的唐古拉山脉各拉丹冬峰西南侧（还有说法认为发源于四川的沱沱河），自西向东流经
<span class="hljs-bullet">111.</span>  青海、西藏、四川、云南、重庆、湖北、湖南、江西、安徽、江苏、上海11个省级行政区，最后注入东海。
<span class="hljs-bullet">112.</span>  *   <span class="hljs-strong">**流域面积：**</span>约94万平方公里。
<span class="hljs-bullet">113.</span>  *   <span class="hljs-strong">**重要性：**</span>
<span class="hljs-bullet">114.</span>      *   <span class="hljs-strong">**经济命脉：**</span>是长江经济带的核心，对促进沿线地区的经济发展至关重要。长江沿岸拥有全国大部分的重要城市和经济
<span class="hljs-bullet">115.</span>  带核心区域。
<span class="hljs-bullet">116.</span>      *   <span class="hljs-strong">**农业灌溉：**</span>提供大量灌溉用水，支撑着沿岸的农业发展。
<span class="hljs-bullet">117.</span>      *   <span class="hljs-strong">**航运价值高：**</span>拥有黄金水道之称，通航里程长，货运量巨大，是中国乃至世界重要的内河运输通道之一（部分河段如
<span class="hljs-bullet">118.</span>  南京到武汉的长江航道已通江）。
<span class="hljs-bullet">119.</span>      *   <span class="hljs-strong">**生态与旅游：**</span>拥有丰富的生物多样性和独特的自然景观，是重要的水电资源和旅游资源。
<span class="hljs-bullet">120.</span>      *   <span class="hljs-strong">**国防意义：**</span>其地理形势对维护国家安全和领土完整具有重要意义。

<span class="hljs-bullet">122.</span>  因此，无论是从长度还是经济、社会等综合角度来看，长江都是中国最重要的河流之一。
<span class="hljs-bullet">123.</span>  <span class="xml"><span class="hljs-tag">&lt;/<span class="hljs-name">answer</span>&gt;</span></span>



`AI写代码![](<span class="hljs-link">https://csdnimg.cn/release/blogv2/dist/pc/img/runCode/icon-arrowwhite.png</span>)收起代码块![](<span class="hljs-link">https://csdnimg.cn/release/blogv2/dist/pc/img/arrowup-line-top-White.png</span>)
</code></pre>
<p>我们可以在另外一个 termninal 中打入如下的命令来进行测试：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">`

<span class="hljs-number">1</span>.  curl http://localhost:<span class="hljs-number">11434</span>/api/generate -d <span class="hljs-comment">'{</span>
<span class="hljs-number">2</span>.    <span class="hljs-string">"model"</span>: <span class="hljs-string">"hunyuan-4b"</span>,
<span class="hljs-number">3</span>.    <span class="hljs-string">"stream"</span>: <span class="hljs-literal">false</span>,
<span class="hljs-number">4</span>.    <span class="hljs-string">"prompt"</span>: <span class="hljs-string">"What is hybrid search in Elasticsearch?"</span>
<span class="hljs-number">5</span>.  }<span class="hljs-comment">'</span>

`AI写代码
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d1ee9eb241154c71a64b409e599721cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447791&amp;x-signature=mKZm45jrC7MDoWDdocq0liY3f10%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-6">连接到 Elasticsearch</h2>
<p>接下来，我们可以参考文章 “<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F145532862" title="https://elasticstack.blog.csdn.net/article/details/145532862" target="_blank" ref="nofollow noopener noreferrer">Elasticsearch：在 Elastic 中玩转 DeepSeek R1 来实现 RAG 应用</a>” 来连接到 Elasticsearch。首先我们按照该文中描述的那样安装好自己的 Elasticsearch 及 Kibana，并安装好 E5 模型。</p>
<h3 data-id="heading-7">创建 Connector</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a0c66337d9ff46ba96ca7b8f0bc8bce4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447791&amp;x-signature=ZNSXRBWx62eE%2BVKKP%2B%2FuYCn3O7Y%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d2815a965a0a4d5aa2e57ce17af6011f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447791&amp;x-signature=%2Fqp7NiBdbHluNh2grUzMfvF3s3A%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/408b206286454c548341b6cf8168a978~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447791&amp;x-signature=AdVYeItqFmgEBQE3lhtNQEEEfKg%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/114fd7a8fbe54f76bad058362c96105c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447791&amp;x-signature=T0QikNVQinDNtN4eqvOlhGM5eto%3D" alt="" loading="lazy"/></p>
<p>我们按照如下的参数来进行配置：</p>
<ul>
<li>Connector name：hunyuan-4b</li>
<li>选择 OpenAI  provider：other (OpenAI Compatible Service)</li>
<li>URL：<a href="https://link.juejin.cn?target=http%3A%2F%2Flocalhost%3A11434%2Fv1%2Fchat%2Fcompletions" title="http://localhost:11434/v1/chat/completions" target="_blank" ref="nofollow noopener noreferrer">http://localhost:11434/v1/chat/completions</a>
<ul>
<li>调整到你的 ollama 的正确路径。如果你从容器内调用，请记住替换 host.docker.internal 或等效项</li>
</ul>
</li>
<li>默认模型：hunyuan-4b</li>
<li>API 密钥：编造一个，需要输入，但值无关紧要</li>
</ul>
<p>我们点击上面的 Save &amp; test 按钮：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0c2a699cf9da42e39b57e1ae85a37b9c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447791&amp;x-signature=7igNDHDlQsGlqd4opAJ0iCcjNBU%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3cb5541ab88c4a3d9aa0741ea4f90b62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447791&amp;x-signature=JX1KAf9CotWn0lBF4y6iL2SRX74%3D" alt="" loading="lazy"/></p>
<p>从上面的测试中，我们可以看出来测试是成功的。</p>
<h3 data-id="heading-8">上传文档并在 Playground 中进行测试</h3>
<p>我们接下来使用和 “<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F145532862" title="https://elasticstack.blog.csdn.net/article/details/145532862" target="_blank" ref="nofollow noopener noreferrer">Elasticsearch：在 Elastic 中玩转 DeepSeek R1 来实现 RAG 应用</a>” 文中一样的文档来进行测试。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad404483635c476e8aa8909e8b659d7d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447791&amp;x-signature=g8ZgbFNQnze7NL7nmI9cVK3m4vc%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c0710b8b0eea44abbcc1992b0bb2f376~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447791&amp;x-signature=mOrQ3IuifZBl3tCqpXKmwY5Rrbo%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23123e0ec7d8456f8484201cba56d6d4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447791&amp;x-signature=CkthDmvI88S7y4y0JHk%2FpIKoXGk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a19bec7120bc4aa3a512573509a4e0c2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447791&amp;x-signature=t9acMESYZIVYCcV8vmr6CcQIQCk%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/eea863eea4264834bfbf1603358f0ed3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447791&amp;x-signature=%2Feh0OynoRMah5zOfDIBCaTRfWGw%3D" alt="" loading="lazy"/></p>
<p><strong>Instructions：</strong></p>
<pre><code class="hljs language-sql" lang="sql">`You <span class="hljs-keyword">are</span> an assistant <span class="hljs-keyword">for</span> question<span class="hljs-operator">-</span>answering tasks <span class="hljs-keyword">using</span> relevant text passages <span class="hljs-keyword">from</span> the book Alice <span class="hljs-keyword">in</span> wonderland`AI写代码
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed9bb3cf771d4306b9c9ee5faa57e338~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447791&amp;x-signature=ZMyx%2BMvnzDvXGCbSmHd71txj58M%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/151422942a264c12a570581c7317045e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447791&amp;x-signature=cmmMWPrRlVukS3CYna3LH33WRhA%3D" alt="" loading="lazy"/></p>
<p>很有意思，混元模型的反应速度比我想象的要快。至少比我上次使用 DeepSeek R1 要快很多。我们尝试使用中文来进行提问：</p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">`谁出现在茶会上？`</span>AI写代码
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/688a8970b1ed4434bd9c9e27993143cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447791&amp;x-signature=38p4XqGVboGHki6t%2BVK3f%2FGs%2Bik%3D" alt="" loading="lazy"/></p>
<pre><code class="hljs language-go" lang="go"><span class="hljs-string">`文章有哪些章节？`</span>AI写代码
</code></pre>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/89a8c1309d744e47892c0f7d242ce6bc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447791&amp;x-signature=JbuQx44zI4IIdAvWAjRMm7RYR1E%3D" alt="" loading="lazy"/></p>
<p>如果你想使用代码来完成查询的话，那么请按照如下的步骤：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/aedba6f9abbd40bfba670436a72c2795~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447791&amp;x-signature=9Nj9Inch4uErkkKbz7rj6KI7%2Fak%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c5e755d9424741c8abd4bc79d9013776~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgRWxhc3RpY3NlYXJjaA==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1763447791&amp;x-signature=TvEWgfH21CP74kjcGghYBMKCizA%3D" alt="" loading="lazy"/></p>
<p>我们可以点击上面的拷贝图标，并做相应的修改 即可。具体的操作步骤，请详细参阅我之前的文章 “<a href="https://link.juejin.cn?target=https%3A%2F%2Felasticstack.blog.csdn.net%2Farticle%2Fdetails%2F145532862" title="https://elasticstack.blog.csdn.net/article/details/145532862" target="_blank" ref="nofollow noopener noreferrer">Elasticsearch：在 Elastic 中玩转 DeepSeek R1 来实现 RAG 应用</a>”。</p>
<p>好了，今天的分享就到这里。祝大家学习愉快！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>